=== Content from git.kernel.org_3134bc11_20250114_192454.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7decd1f5904a489d3ccdcf131972f94645681689)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7decd1f5904a489d3ccdcf131972f94645681689)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7decd1f5904a489d3ccdcf131972f94645681689)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7decd1f5904a489d3ccdcf131972f94645681689)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-10-15 10:38:47 +0200 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-17 12:06:55 +0200 |
| commit | [7decd1f5904a489d3ccdcf131972f94645681689](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7decd1f5904a489d3ccdcf131972f94645681689) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7decd1f5904a489d3ccdcf131972f94645681689)) | |
| tree | [f728d64da651be9d275b5cdb80f75e46088d3bb2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7decd1f5904a489d3ccdcf131972f94645681689) | |
| parent | [88806efc034a9830f483963326b99930ad519af1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88806efc034a9830f483963326b99930ad519af1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7decd1f5904a489d3ccdcf131972f94645681689&id2=88806efc034a9830f483963326b99930ad519af1)) | |
| download | [linux-7decd1f5904a489d3ccdcf131972f94645681689.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7decd1f5904a489d3ccdcf131972f94645681689.tar.gz) | |

mptcp: pm: fix UaF read in mptcp\_pm\_nl\_rm\_addr\_or\_subflowSyzkaller reported this splat:
==================================================================
BUG: KASAN: slab-use-after-free in mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
Read of size 4 at addr ffff8880569ac858 by task syz.1.2799/14662
CPU: 0 UID: 0 PID: 14662 Comm: syz.1.2799 Not tainted 6.12.0-rc2-syzkaller-00307-g36c254515dc6 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x116/0x1f0 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0xc3/0x620 mm/kasan/report.c:488
kasan\_report+0xd9/0x110 mm/kasan/report.c:601
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf7fe4579
Code: b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
RSP: 002b:00000000f574556c EFLAGS: 00000296 ORIG\_RAX: 0000000000000172
RAX: ffffffffffffffda RBX: 000000000000000b RCX: 0000000020000140
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
Allocated by task 5387:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0xaa/0xb0 mm/kasan/common.c:394
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
subflow\_create\_ctx+0x87/0x2a0 net/mptcp/subflow.c:1803
subflow\_ulp\_init+0xc3/0x4d0 net/mptcp/subflow.c:1956
\_\_tcp\_set\_ulp net/ipv4/tcp\_ulp.c:146 [inline]
tcp\_set\_ulp+0x326/0x7f0 net/ipv4/tcp\_ulp.c:167
mptcp\_subflow\_create\_socket+0x4ae/0x10a0 net/mptcp/subflow.c:1764
\_\_mptcp\_subflow\_connect+0x3cc/0x1490 net/mptcp/subflow.c:1592
mptcp\_pm\_create\_subflow\_or\_signal\_addr+0xbda/0x23a0 net/mptcp/pm\_netlink.c:642
mptcp\_pm\_nl\_fully\_established net/mptcp/pm\_netlink.c:650 [inline]
mptcp\_pm\_nl\_work+0x3a1/0x4f0 net/mptcp/pm\_netlink.c:943
mptcp\_worker+0x15a/0x1240 net/mptcp/protocol.c:2777
process\_one\_work+0x958/0x1b30 kernel/workqueue.c:3229
process\_scheduled\_works kernel/workqueue.c:3310 [inline]
worker\_thread+0x6c8/0xf00 kernel/workqueue.c:3391
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Freed by task 113:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
kasan\_save\_free\_info+0x3b/0x60 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x51/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x14f/0x4b0 mm/slub.c:4727
kvfree+0x47/0x50 mm/util.c:701
kvfree\_rcu\_list+0xf5/0x2c0 kernel/rcu/tree.c:3423
kvfree\_rcu\_drain\_ready kernel/rcu/tree.c:3563 [inline]
kfree\_rcu\_monitor+0x503/0x8b0 kernel/rcu/tree.c:3632
kfree\_rcu\_shrink\_scan+0x245/0x3a0 kernel/rcu/tree.c:3966
do\_shrink\_slab+0x44f/0x11c0 mm/shrinker.c:435
shrink\_slab+0x32b/0x12a0 mm/shrinker.c:662
shrink\_one+0x47e/0x7b0 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x2452/0x39d0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat+0xc19/0x18f0 mm/vmscan.c:6957
kswapd+0x5ea/0xbf0 mm/vmscan.c:7226
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Last potentially related work creation:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
\_\_kasan\_record\_aux\_stack+0xba/0xd0 mm/kasan/generic.c:541
kvfree\_call\_rcu+0x74/0xbe0 kernel/rcu/tree.c:3810
subflow\_ulp\_release+0x2ae/0x350 net/mptcp/subflow.c:2009
tcp\_cleanup\_ulp+0x7c/0x130 net/ipv4/tcp\_ulp.c:124
tcp\_v4\_destroy\_sock+0x1c5/0x6a0 net/ipv4/tcp\_ipv4.c:2541
inet\_csk\_destroy\_sock+0x1a3/0x440 net/ipv4/inet\_connection\_sock.c:1293
tcp\_done+0x252/0x350 net/ipv4/tcp.c:4870
tcp\_rcv\_state\_process+0x379b/0x4f30 net/ipv4/tcp\_input.c:6933
tcp\_v4\_do\_rcv+0x1ad/0xa90 net/ipv4/tcp\_ipv4.c:1938
sk\_backlog\_rcv include/net/sock.h:1115 [inline]
\_\_release\_sock+0x31b/0x400 net/core/sock.c:3072
\_\_tcp\_close+0x4f3/0xff0 net/ipv4/tcp.c:3142
\_\_mptcp\_close\_ssk+0x331/0x14d0 net/mptcp/protocol.c:2489
mptcp\_close\_ssk net/mptcp/protocol.c:2543 [inline]
mptcp\_close\_ssk+0x150/0x220 net/mptcp/protocol.c:2526
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0x2be/0xcc0 net/mptcp/pm\_netlink.c:878
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
The buggy address belongs to the object at ffff8880569ac800
which belongs to the cache kmalloc-512 of size 512
The buggy address is located 88 bytes inside of
freed 512-byte region [ffff8880569ac800, ffff8880569aca00)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x569ac
head: order:2 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
raw: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
head: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000002 ffffea00015a6b01 ffffffffffffffff 0000000000000000
head: 0000000000000004 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 10238, tgid 10238 (kworker/u32:6), ts 597403252405, free\_ts 597177952947
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x2d1/0x350 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x101e/0x3070 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x223/0x25a0 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x2c9/0x610 mm/mempolicy.c:2265
alloc\_slab\_page mm/slub.c:2412 [inline]
allocate\_slab mm/slub.c:2578 [inline]
new\_slab+0x2ba/0x3f0 mm/slub.c:2631
\_\_\_slab\_alloc+0xd1d/0x16f0 mm/slub.c:3818
\_\_slab\_alloc.constprop.0+0x56/0xb0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_kmalloc\_cache\_noprof+0x2c5/0x310 mm/slub.c:4290
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
mld\_add\_delrec net/ipv6/mcast.c:743 [inline]
igmp6\_leave\_group net/ipv6/mcast.c:2625 [inline]
igmp6\_group\_dropped+0x4ab/0xe40 net/ipv6/mcast.c:723
\_\_ipv6\_dev\_mc\_dec+0x281/0x360 net/ipv6/mcast.c:979
addrconf\_leave\_solict net/ipv6/addrconf.c:2253 [inline]
\_\_ipv6\_ifa\_notify+0x3f6/0xc30 net/ipv6/addrconf.c:6283
addrconf\_ifdown.isra.0+0xef9/0x1a20 net/ipv6/addrconf.c:3982
addrconf\_notify+0x220/0x19c0 net/ipv6/addrconf.c:3781
notifier\_call\_chain+0xb9/0x410 kernel/notifier.c:93
call\_netdevice\_notifiers\_info+0xbe/0x140 net/core/dev.c:1996
call\_netdevice\_notifiers\_extack net/core/dev.c:2034 [inline]
call\_netdevice\_notifiers net/core/dev.c:2048 [inline]
dev\_close\_many+0x333/0x6a0 net/core/dev.c:1589
page last free pid 13136 tgid 13136 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_page+0x5f4/0xdc0 mm/page\_alloc.c:2638
stack\_depot\_save\_flags+0x2da/0x900 lib/stackdepot.c:666
kasan\_save\_stack+0x42/0x60 mm/kasan/common.c:48
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:319 [inline]
\_\_kasan\_slab\_alloc+0x89/0x90 mm/kasan/common.c:345
kasan\_slab\_alloc include/linux/kasan.h:247 [inline]
slab\_post\_alloc\_hook mm/slub.c:4085 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_noprof+0x121/0x2f0 mm/slub.c:4141
skb\_clone+0x190/0x3f0 net/core/skbuff.c:2084
do\_one\_broadcast net/netlink/af\_netlink.c:1462 [inline]
netlink\_broadcast\_filtered+0xb11/0xef0 net/netlink/af\_netlink.c:1540
netlink\_broadcast+0x39/0x50 net/netlink/af\_netlink.c:1564
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:331 [inline]
kobject\_uevent\_net\_broadcast lib/kobject\_uevent.c:410 [inline]
kobject\_uevent\_env+0xacd/0x1670 lib/kobject\_uevent.c:608
device\_del+0x623/0x9f0 drivers/base/core.c:3882
snd\_card\_disconnect.part.0+0x58a/0x7c0 sound/core/init.c:546
snd\_card\_disconnect+0x1f/0x30 sound/core/init.c:495
snd\_usx2y\_disconnect+0xe9/0x1f0 sound/usb/usx2y/usbusx2y.c:417
usb\_unbind\_interface+0x1e8/0x970 drivers/usb/core/driver.c:461
device\_remove drivers/base/dd.c:569 [inline]
device\_remove+0x122/0x170 drivers/base/dd.c:561
That's because 'subflow' is used just after 'mptcp\_close\_ssk(subflow)',
which will initiate the release of its memory. Even if it is very likely
the release and the re-utilisation will be done later on, it is of
course better to avoid any issues and read the content of 'subflow'
before closing it.
Fixes: 1c1f72137598 ("mptcp: pm: only decrement add\_addr\_accepted for MPJ req")
Cc: stable@vger.kernel.org
Reported-by: syzbot+3c8b7a8e7df6a2a226ca@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/670d7337.050a0220.4cbc0.004f.GAE@google.com
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64@kernel.org](https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64%40kernel.org)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7decd1f5904a489d3ccdcf131972f94645681689)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=7decd1f5904a489d3ccdcf131972f94645681689) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 1a78998fe1f495..db586a5b3866f6 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=88806efc034a9830f483963326b99930ad519af1)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=7decd1f5904a489d3ccdcf131972f94645681689)@@ -873,12 +873,12 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, i, rm\_id, id, remote\_id, msk->mpc\_endpoint\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how);+ removed |= subflow->request\_join;  /\* the following takes care of updating the subflows counter \*/ mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:31 +0000



=== Content from git.kernel.org_3adef574_20250114_192455.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-10-15 10:38:47 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:17 +0200 |
| commit | [a8c36ea4ef9a350816f6556c5c5b63810f84b538](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)) | |
| tree | [4e6736399d776db20938a2bf7e0951d1987bb2f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538) | |
| parent | [6fadf21e22aeb9adaf80da647ef3365acc4f0ee5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fadf21e22aeb9adaf80da647ef3365acc4f0ee5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538&id2=6fadf21e22aeb9adaf80da647ef3365acc4f0ee5)) | |
| download | [linux-a8c36ea4ef9a350816f6556c5c5b63810f84b538.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8c36ea4ef9a350816f6556c5c5b63810f84b538.tar.gz) | |

mptcp: pm: fix UaF read in mptcp\_pm\_nl\_rm\_addr\_or\_subflowcommit 7decd1f5904a489d3ccdcf131972f94645681689 upstream.
Syzkaller reported this splat:
==================================================================
BUG: KASAN: slab-use-after-free in mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
Read of size 4 at addr ffff8880569ac858 by task syz.1.2799/14662
CPU: 0 UID: 0 PID: 14662 Comm: syz.1.2799 Not tainted 6.12.0-rc2-syzkaller-00307-g36c254515dc6 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x116/0x1f0 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0xc3/0x620 mm/kasan/report.c:488
kasan\_report+0xd9/0x110 mm/kasan/report.c:601
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf7fe4579
Code: b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
RSP: 002b:00000000f574556c EFLAGS: 00000296 ORIG\_RAX: 0000000000000172
RAX: ffffffffffffffda RBX: 000000000000000b RCX: 0000000020000140
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
Allocated by task 5387:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0xaa/0xb0 mm/kasan/common.c:394
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
subflow\_create\_ctx+0x87/0x2a0 net/mptcp/subflow.c:1803
subflow\_ulp\_init+0xc3/0x4d0 net/mptcp/subflow.c:1956
\_\_tcp\_set\_ulp net/ipv4/tcp\_ulp.c:146 [inline]
tcp\_set\_ulp+0x326/0x7f0 net/ipv4/tcp\_ulp.c:167
mptcp\_subflow\_create\_socket+0x4ae/0x10a0 net/mptcp/subflow.c:1764
\_\_mptcp\_subflow\_connect+0x3cc/0x1490 net/mptcp/subflow.c:1592
mptcp\_pm\_create\_subflow\_or\_signal\_addr+0xbda/0x23a0 net/mptcp/pm\_netlink.c:642
mptcp\_pm\_nl\_fully\_established net/mptcp/pm\_netlink.c:650 [inline]
mptcp\_pm\_nl\_work+0x3a1/0x4f0 net/mptcp/pm\_netlink.c:943
mptcp\_worker+0x15a/0x1240 net/mptcp/protocol.c:2777
process\_one\_work+0x958/0x1b30 kernel/workqueue.c:3229
process\_scheduled\_works kernel/workqueue.c:3310 [inline]
worker\_thread+0x6c8/0xf00 kernel/workqueue.c:3391
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Freed by task 113:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
kasan\_save\_free\_info+0x3b/0x60 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x51/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x14f/0x4b0 mm/slub.c:4727
kvfree+0x47/0x50 mm/util.c:701
kvfree\_rcu\_list+0xf5/0x2c0 kernel/rcu/tree.c:3423
kvfree\_rcu\_drain\_ready kernel/rcu/tree.c:3563 [inline]
kfree\_rcu\_monitor+0x503/0x8b0 kernel/rcu/tree.c:3632
kfree\_rcu\_shrink\_scan+0x245/0x3a0 kernel/rcu/tree.c:3966
do\_shrink\_slab+0x44f/0x11c0 mm/shrinker.c:435
shrink\_slab+0x32b/0x12a0 mm/shrinker.c:662
shrink\_one+0x47e/0x7b0 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x2452/0x39d0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat+0xc19/0x18f0 mm/vmscan.c:6957
kswapd+0x5ea/0xbf0 mm/vmscan.c:7226
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Last potentially related work creation:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
\_\_kasan\_record\_aux\_stack+0xba/0xd0 mm/kasan/generic.c:541
kvfree\_call\_rcu+0x74/0xbe0 kernel/rcu/tree.c:3810
subflow\_ulp\_release+0x2ae/0x350 net/mptcp/subflow.c:2009
tcp\_cleanup\_ulp+0x7c/0x130 net/ipv4/tcp\_ulp.c:124
tcp\_v4\_destroy\_sock+0x1c5/0x6a0 net/ipv4/tcp\_ipv4.c:2541
inet\_csk\_destroy\_sock+0x1a3/0x440 net/ipv4/inet\_connection\_sock.c:1293
tcp\_done+0x252/0x350 net/ipv4/tcp.c:4870
tcp\_rcv\_state\_process+0x379b/0x4f30 net/ipv4/tcp\_input.c:6933
tcp\_v4\_do\_rcv+0x1ad/0xa90 net/ipv4/tcp\_ipv4.c:1938
sk\_backlog\_rcv include/net/sock.h:1115 [inline]
\_\_release\_sock+0x31b/0x400 net/core/sock.c:3072
\_\_tcp\_close+0x4f3/0xff0 net/ipv4/tcp.c:3142
\_\_mptcp\_close\_ssk+0x331/0x14d0 net/mptcp/protocol.c:2489
mptcp\_close\_ssk net/mptcp/protocol.c:2543 [inline]
mptcp\_close\_ssk+0x150/0x220 net/mptcp/protocol.c:2526
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0x2be/0xcc0 net/mptcp/pm\_netlink.c:878
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
The buggy address belongs to the object at ffff8880569ac800
which belongs to the cache kmalloc-512 of size 512
The buggy address is located 88 bytes inside of
freed 512-byte region [ffff8880569ac800, ffff8880569aca00)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x569ac
head: order:2 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
raw: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
head: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000002 ffffea00015a6b01 ffffffffffffffff 0000000000000000
head: 0000000000000004 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 10238, tgid 10238 (kworker/u32:6), ts 597403252405, free\_ts 597177952947
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x2d1/0x350 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x101e/0x3070 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x223/0x25a0 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x2c9/0x610 mm/mempolicy.c:2265
alloc\_slab\_page mm/slub.c:2412 [inline]
allocate\_slab mm/slub.c:2578 [inline]
new\_slab+0x2ba/0x3f0 mm/slub.c:2631
\_\_\_slab\_alloc+0xd1d/0x16f0 mm/slub.c:3818
\_\_slab\_alloc.constprop.0+0x56/0xb0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_kmalloc\_cache\_noprof+0x2c5/0x310 mm/slub.c:4290
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
mld\_add\_delrec net/ipv6/mcast.c:743 [inline]
igmp6\_leave\_group net/ipv6/mcast.c:2625 [inline]
igmp6\_group\_dropped+0x4ab/0xe40 net/ipv6/mcast.c:723
\_\_ipv6\_dev\_mc\_dec+0x281/0x360 net/ipv6/mcast.c:979
addrconf\_leave\_solict net/ipv6/addrconf.c:2253 [inline]
\_\_ipv6\_ifa\_notify+0x3f6/0xc30 net/ipv6/addrconf.c:6283
addrconf\_ifdown.isra.0+0xef9/0x1a20 net/ipv6/addrconf.c:3982
addrconf\_notify+0x220/0x19c0 net/ipv6/addrconf.c:3781
notifier\_call\_chain+0xb9/0x410 kernel/notifier.c:93
call\_netdevice\_notifiers\_info+0xbe/0x140 net/core/dev.c:1996
call\_netdevice\_notifiers\_extack net/core/dev.c:2034 [inline]
call\_netdevice\_notifiers net/core/dev.c:2048 [inline]
dev\_close\_many+0x333/0x6a0 net/core/dev.c:1589
page last free pid 13136 tgid 13136 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_page+0x5f4/0xdc0 mm/page\_alloc.c:2638
stack\_depot\_save\_flags+0x2da/0x900 lib/stackdepot.c:666
kasan\_save\_stack+0x42/0x60 mm/kasan/common.c:48
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:319 [inline]
\_\_kasan\_slab\_alloc+0x89/0x90 mm/kasan/common.c:345
kasan\_slab\_alloc include/linux/kasan.h:247 [inline]
slab\_post\_alloc\_hook mm/slub.c:4085 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_noprof+0x121/0x2f0 mm/slub.c:4141
skb\_clone+0x190/0x3f0 net/core/skbuff.c:2084
do\_one\_broadcast net/netlink/af\_netlink.c:1462 [inline]
netlink\_broadcast\_filtered+0xb11/0xef0 net/netlink/af\_netlink.c:1540
netlink\_broadcast+0x39/0x50 net/netlink/af\_netlink.c:1564
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:331 [inline]
kobject\_uevent\_net\_broadcast lib/kobject\_uevent.c:410 [inline]
kobject\_uevent\_env+0xacd/0x1670 lib/kobject\_uevent.c:608
device\_del+0x623/0x9f0 drivers/base/core.c:3882
snd\_card\_disconnect.part.0+0x58a/0x7c0 sound/core/init.c:546
snd\_card\_disconnect+0x1f/0x30 sound/core/init.c:495
snd\_usx2y\_disconnect+0xe9/0x1f0 sound/usb/usx2y/usbusx2y.c:417
usb\_unbind\_interface+0x1e8/0x970 drivers/usb/core/driver.c:461
device\_remove drivers/base/dd.c:569 [inline]
device\_remove+0x122/0x170 drivers/base/dd.c:561
That's because 'subflow' is used just after 'mptcp\_close\_ssk(subflow)',
which will initiate the release of its memory. Even if it is very likely
the release and the re-utilisation will be done later on, it is of
course better to avoid any issues and read the content of 'subflow'
before closing it.
Fixes: 1c1f72137598 ("mptcp: pm: only decrement add\_addr\_accepted for MPJ req")
Cc: stable@vger.kernel.org
Reported-by: syzbot+3c8b7a8e7df6a2a226ca@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/670d7337.050a0220.4cbc0.004f.GAE@google.com
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64@kernel.org](https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64%40kernel.org)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 6c586b2b377bbe..071840d671ab27 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=6fadf21e22aeb9adaf80da647ef3365acc4f0ee5)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=a8c36ea4ef9a350816f6556c5c5b63810f84b538)@@ -869,12 +869,12 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, i, rm\_id, id, remote\_id, msk->mpc\_endpoint\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how);+ removed |= subflow->request\_join;  /\* the following takes care of updating the subflows counter \*/ mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:32 +0000



=== Content from git.kernel.org_ef1ac217_20250114_192456.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-10-15 10:38:47 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:39 +0200 |
| commit | [da3343bc0839b180fd9af9c27fa456d8231409f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da3343bc0839b180fd9af9c27fa456d8231409f9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)) | |
| tree | [3da380a6bc68917ad76f70ea0851de31af1d7a28](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da3343bc0839b180fd9af9c27fa456d8231409f9) | |
| parent | [5014a7c916df33c8ca9a69c3bcde2c5c37f3a562](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5014a7c916df33c8ca9a69c3bcde2c5c37f3a562) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da3343bc0839b180fd9af9c27fa456d8231409f9&id2=5014a7c916df33c8ca9a69c3bcde2c5c37f3a562)) | |
| download | [linux-da3343bc0839b180fd9af9c27fa456d8231409f9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da3343bc0839b180fd9af9c27fa456d8231409f9.tar.gz) | |

mptcp: pm: fix UaF read in mptcp\_pm\_nl\_rm\_addr\_or\_subflowcommit 7decd1f5904a489d3ccdcf131972f94645681689 upstream.
Syzkaller reported this splat:
==================================================================
BUG: KASAN: slab-use-after-free in mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
Read of size 4 at addr ffff8880569ac858 by task syz.1.2799/14662
CPU: 0 UID: 0 PID: 14662 Comm: syz.1.2799 Not tainted 6.12.0-rc2-syzkaller-00307-g36c254515dc6 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x116/0x1f0 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0xc3/0x620 mm/kasan/report.c:488
kasan\_report+0xd9/0x110 mm/kasan/report.c:601
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf7fe4579
Code: b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
RSP: 002b:00000000f574556c EFLAGS: 00000296 ORIG\_RAX: 0000000000000172
RAX: ffffffffffffffda RBX: 000000000000000b RCX: 0000000020000140
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
Allocated by task 5387:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0xaa/0xb0 mm/kasan/common.c:394
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
subflow\_create\_ctx+0x87/0x2a0 net/mptcp/subflow.c:1803
subflow\_ulp\_init+0xc3/0x4d0 net/mptcp/subflow.c:1956
\_\_tcp\_set\_ulp net/ipv4/tcp\_ulp.c:146 [inline]
tcp\_set\_ulp+0x326/0x7f0 net/ipv4/tcp\_ulp.c:167
mptcp\_subflow\_create\_socket+0x4ae/0x10a0 net/mptcp/subflow.c:1764
\_\_mptcp\_subflow\_connect+0x3cc/0x1490 net/mptcp/subflow.c:1592
mptcp\_pm\_create\_subflow\_or\_signal\_addr+0xbda/0x23a0 net/mptcp/pm\_netlink.c:642
mptcp\_pm\_nl\_fully\_established net/mptcp/pm\_netlink.c:650 [inline]
mptcp\_pm\_nl\_work+0x3a1/0x4f0 net/mptcp/pm\_netlink.c:943
mptcp\_worker+0x15a/0x1240 net/mptcp/protocol.c:2777
process\_one\_work+0x958/0x1b30 kernel/workqueue.c:3229
process\_scheduled\_works kernel/workqueue.c:3310 [inline]
worker\_thread+0x6c8/0xf00 kernel/workqueue.c:3391
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Freed by task 113:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
kasan\_save\_free\_info+0x3b/0x60 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x51/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x14f/0x4b0 mm/slub.c:4727
kvfree+0x47/0x50 mm/util.c:701
kvfree\_rcu\_list+0xf5/0x2c0 kernel/rcu/tree.c:3423
kvfree\_rcu\_drain\_ready kernel/rcu/tree.c:3563 [inline]
kfree\_rcu\_monitor+0x503/0x8b0 kernel/rcu/tree.c:3632
kfree\_rcu\_shrink\_scan+0x245/0x3a0 kernel/rcu/tree.c:3966
do\_shrink\_slab+0x44f/0x11c0 mm/shrinker.c:435
shrink\_slab+0x32b/0x12a0 mm/shrinker.c:662
shrink\_one+0x47e/0x7b0 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x2452/0x39d0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat+0xc19/0x18f0 mm/vmscan.c:6957
kswapd+0x5ea/0xbf0 mm/vmscan.c:7226
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Last potentially related work creation:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
\_\_kasan\_record\_aux\_stack+0xba/0xd0 mm/kasan/generic.c:541
kvfree\_call\_rcu+0x74/0xbe0 kernel/rcu/tree.c:3810
subflow\_ulp\_release+0x2ae/0x350 net/mptcp/subflow.c:2009
tcp\_cleanup\_ulp+0x7c/0x130 net/ipv4/tcp\_ulp.c:124
tcp\_v4\_destroy\_sock+0x1c5/0x6a0 net/ipv4/tcp\_ipv4.c:2541
inet\_csk\_destroy\_sock+0x1a3/0x440 net/ipv4/inet\_connection\_sock.c:1293
tcp\_done+0x252/0x350 net/ipv4/tcp.c:4870
tcp\_rcv\_state\_process+0x379b/0x4f30 net/ipv4/tcp\_input.c:6933
tcp\_v4\_do\_rcv+0x1ad/0xa90 net/ipv4/tcp\_ipv4.c:1938
sk\_backlog\_rcv include/net/sock.h:1115 [inline]
\_\_release\_sock+0x31b/0x400 net/core/sock.c:3072
\_\_tcp\_close+0x4f3/0xff0 net/ipv4/tcp.c:3142
\_\_mptcp\_close\_ssk+0x331/0x14d0 net/mptcp/protocol.c:2489
mptcp\_close\_ssk net/mptcp/protocol.c:2543 [inline]
mptcp\_close\_ssk+0x150/0x220 net/mptcp/protocol.c:2526
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0x2be/0xcc0 net/mptcp/pm\_netlink.c:878
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
The buggy address belongs to the object at ffff8880569ac800
which belongs to the cache kmalloc-512 of size 512
The buggy address is located 88 bytes inside of
freed 512-byte region [ffff8880569ac800, ffff8880569aca00)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x569ac
head: order:2 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
raw: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
head: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000002 ffffea00015a6b01 ffffffffffffffff 0000000000000000
head: 0000000000000004 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 10238, tgid 10238 (kworker/u32:6), ts 597403252405, free\_ts 597177952947
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x2d1/0x350 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x101e/0x3070 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x223/0x25a0 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x2c9/0x610 mm/mempolicy.c:2265
alloc\_slab\_page mm/slub.c:2412 [inline]
allocate\_slab mm/slub.c:2578 [inline]
new\_slab+0x2ba/0x3f0 mm/slub.c:2631
\_\_\_slab\_alloc+0xd1d/0x16f0 mm/slub.c:3818
\_\_slab\_alloc.constprop.0+0x56/0xb0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_kmalloc\_cache\_noprof+0x2c5/0x310 mm/slub.c:4290
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
mld\_add\_delrec net/ipv6/mcast.c:743 [inline]
igmp6\_leave\_group net/ipv6/mcast.c:2625 [inline]
igmp6\_group\_dropped+0x4ab/0xe40 net/ipv6/mcast.c:723
\_\_ipv6\_dev\_mc\_dec+0x281/0x360 net/ipv6/mcast.c:979
addrconf\_leave\_solict net/ipv6/addrconf.c:2253 [inline]
\_\_ipv6\_ifa\_notify+0x3f6/0xc30 net/ipv6/addrconf.c:6283
addrconf\_ifdown.isra.0+0xef9/0x1a20 net/ipv6/addrconf.c:3982
addrconf\_notify+0x220/0x19c0 net/ipv6/addrconf.c:3781
notifier\_call\_chain+0xb9/0x410 kernel/notifier.c:93
call\_netdevice\_notifiers\_info+0xbe/0x140 net/core/dev.c:1996
call\_netdevice\_notifiers\_extack net/core/dev.c:2034 [inline]
call\_netdevice\_notifiers net/core/dev.c:2048 [inline]
dev\_close\_many+0x333/0x6a0 net/core/dev.c:1589
page last free pid 13136 tgid 13136 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_page+0x5f4/0xdc0 mm/page\_alloc.c:2638
stack\_depot\_save\_flags+0x2da/0x900 lib/stackdepot.c:666
kasan\_save\_stack+0x42/0x60 mm/kasan/common.c:48
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:319 [inline]
\_\_kasan\_slab\_alloc+0x89/0x90 mm/kasan/common.c:345
kasan\_slab\_alloc include/linux/kasan.h:247 [inline]
slab\_post\_alloc\_hook mm/slub.c:4085 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_noprof+0x121/0x2f0 mm/slub.c:4141
skb\_clone+0x190/0x3f0 net/core/skbuff.c:2084
do\_one\_broadcast net/netlink/af\_netlink.c:1462 [inline]
netlink\_broadcast\_filtered+0xb11/0xef0 net/netlink/af\_netlink.c:1540
netlink\_broadcast+0x39/0x50 net/netlink/af\_netlink.c:1564
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:331 [inline]
kobject\_uevent\_net\_broadcast lib/kobject\_uevent.c:410 [inline]
kobject\_uevent\_env+0xacd/0x1670 lib/kobject\_uevent.c:608
device\_del+0x623/0x9f0 drivers/base/core.c:3882
snd\_card\_disconnect.part.0+0x58a/0x7c0 sound/core/init.c:546
snd\_card\_disconnect+0x1f/0x30 sound/core/init.c:495
snd\_usx2y\_disconnect+0xe9/0x1f0 sound/usb/usx2y/usbusx2y.c:417
usb\_unbind\_interface+0x1e8/0x970 drivers/usb/core/driver.c:461
device\_remove drivers/base/dd.c:569 [inline]
device\_remove+0x122/0x170 drivers/base/dd.c:561
That's because 'subflow' is used just after 'mptcp\_close\_ssk(subflow)',
which will initiate the release of its memory. Even if it is very likely
the release and the re-utilisation will be done later on, it is of
course better to avoid any issues and read the content of 'subflow'
before closing it.
Fixes: 1c1f72137598 ("mptcp: pm: only decrement add\_addr\_accepted for MPJ req")
Cc: stable@vger.kernel.org
Reported-by: syzbot+3c8b7a8e7df6a2a226ca@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/670d7337.050a0220.4cbc0.004f.GAE@google.com
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64@kernel.org](https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64%40kernel.org)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da3343bc0839b180fd9af9c27fa456d8231409f9)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=da3343bc0839b180fd9af9c27fa456d8231409f9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 34fab06af74479..5e2d8e18ce3ed2 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=5014a7c916df33c8ca9a69c3bcde2c5c37f3a562)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=da3343bc0839b180fd9af9c27fa456d8231409f9)@@ -877,12 +877,12 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, i, rm\_id, id, remote\_id, msk->mpc\_endpoint\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how);+ removed |= subflow->request\_join;  /\* the following takes care of updating the subflows counter \*/ mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:33 +0000



=== Content from git.kernel.org_605addff_20250114_192453.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b2e478abab0b3a33515433a6af563aebba773c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b2e478abab0b3a33515433a6af563aebba773c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b2e478abab0b3a33515433a6af563aebba773c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b2e478abab0b3a33515433a6af563aebba773c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-10-15 10:38:47 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:18 +0200 |
| commit | [7b2e478abab0b3a33515433a6af563aebba773c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b2e478abab0b3a33515433a6af563aebba773c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b2e478abab0b3a33515433a6af563aebba773c1)) | |
| tree | [fc8a79e48681493239640e528e749edf25162260](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b2e478abab0b3a33515433a6af563aebba773c1) | |
| parent | [3c088dba8a4ed4e631c7e941fb31ef2b247d906a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c088dba8a4ed4e631c7e941fb31ef2b247d906a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b2e478abab0b3a33515433a6af563aebba773c1&id2=3c088dba8a4ed4e631c7e941fb31ef2b247d906a)) | |
| download | [linux-7b2e478abab0b3a33515433a6af563aebba773c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b2e478abab0b3a33515433a6af563aebba773c1.tar.gz) | |

mptcp: pm: fix UaF read in mptcp\_pm\_nl\_rm\_addr\_or\_subflowcommit 7decd1f5904a489d3ccdcf131972f94645681689 upstream.
Syzkaller reported this splat:
==================================================================
BUG: KASAN: slab-use-after-free in mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
Read of size 4 at addr ffff8880569ac858 by task syz.1.2799/14662
CPU: 0 UID: 0 PID: 14662 Comm: syz.1.2799 Not tainted 6.12.0-rc2-syzkaller-00307-g36c254515dc6 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x116/0x1f0 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0xc3/0x620 mm/kasan/report.c:488
kasan\_report+0xd9/0x110 mm/kasan/report.c:601
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf7fe4579
Code: b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
RSP: 002b:00000000f574556c EFLAGS: 00000296 ORIG\_RAX: 0000000000000172
RAX: ffffffffffffffda RBX: 000000000000000b RCX: 0000000020000140
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
Allocated by task 5387:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0xaa/0xb0 mm/kasan/common.c:394
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
subflow\_create\_ctx+0x87/0x2a0 net/mptcp/subflow.c:1803
subflow\_ulp\_init+0xc3/0x4d0 net/mptcp/subflow.c:1956
\_\_tcp\_set\_ulp net/ipv4/tcp\_ulp.c:146 [inline]
tcp\_set\_ulp+0x326/0x7f0 net/ipv4/tcp\_ulp.c:167
mptcp\_subflow\_create\_socket+0x4ae/0x10a0 net/mptcp/subflow.c:1764
\_\_mptcp\_subflow\_connect+0x3cc/0x1490 net/mptcp/subflow.c:1592
mptcp\_pm\_create\_subflow\_or\_signal\_addr+0xbda/0x23a0 net/mptcp/pm\_netlink.c:642
mptcp\_pm\_nl\_fully\_established net/mptcp/pm\_netlink.c:650 [inline]
mptcp\_pm\_nl\_work+0x3a1/0x4f0 net/mptcp/pm\_netlink.c:943
mptcp\_worker+0x15a/0x1240 net/mptcp/protocol.c:2777
process\_one\_work+0x958/0x1b30 kernel/workqueue.c:3229
process\_scheduled\_works kernel/workqueue.c:3310 [inline]
worker\_thread+0x6c8/0xf00 kernel/workqueue.c:3391
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Freed by task 113:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
kasan\_save\_free\_info+0x3b/0x60 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x51/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x14f/0x4b0 mm/slub.c:4727
kvfree+0x47/0x50 mm/util.c:701
kvfree\_rcu\_list+0xf5/0x2c0 kernel/rcu/tree.c:3423
kvfree\_rcu\_drain\_ready kernel/rcu/tree.c:3563 [inline]
kfree\_rcu\_monitor+0x503/0x8b0 kernel/rcu/tree.c:3632
kfree\_rcu\_shrink\_scan+0x245/0x3a0 kernel/rcu/tree.c:3966
do\_shrink\_slab+0x44f/0x11c0 mm/shrinker.c:435
shrink\_slab+0x32b/0x12a0 mm/shrinker.c:662
shrink\_one+0x47e/0x7b0 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x2452/0x39d0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat+0xc19/0x18f0 mm/vmscan.c:6957
kswapd+0x5ea/0xbf0 mm/vmscan.c:7226
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Last potentially related work creation:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
\_\_kasan\_record\_aux\_stack+0xba/0xd0 mm/kasan/generic.c:541
kvfree\_call\_rcu+0x74/0xbe0 kernel/rcu/tree.c:3810
subflow\_ulp\_release+0x2ae/0x350 net/mptcp/subflow.c:2009
tcp\_cleanup\_ulp+0x7c/0x130 net/ipv4/tcp\_ulp.c:124
tcp\_v4\_destroy\_sock+0x1c5/0x6a0 net/ipv4/tcp\_ipv4.c:2541
inet\_csk\_destroy\_sock+0x1a3/0x440 net/ipv4/inet\_connection\_sock.c:1293
tcp\_done+0x252/0x350 net/ipv4/tcp.c:4870
tcp\_rcv\_state\_process+0x379b/0x4f30 net/ipv4/tcp\_input.c:6933
tcp\_v4\_do\_rcv+0x1ad/0xa90 net/ipv4/tcp\_ipv4.c:1938
sk\_backlog\_rcv include/net/sock.h:1115 [inline]
\_\_release\_sock+0x31b/0x400 net/core/sock.c:3072
\_\_tcp\_close+0x4f3/0xff0 net/ipv4/tcp.c:3142
\_\_mptcp\_close\_ssk+0x331/0x14d0 net/mptcp/protocol.c:2489
mptcp\_close\_ssk net/mptcp/protocol.c:2543 [inline]
mptcp\_close\_ssk+0x150/0x220 net/mptcp/protocol.c:2526
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0x2be/0xcc0 net/mptcp/pm\_netlink.c:878
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
The buggy address belongs to the object at ffff8880569ac800
which belongs to the cache kmalloc-512 of size 512
The buggy address is located 88 bytes inside of
freed 512-byte region [ffff8880569ac800, ffff8880569aca00)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x569ac
head: order:2 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
raw: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
head: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000002 ffffea00015a6b01 ffffffffffffffff 0000000000000000
head: 0000000000000004 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 10238, tgid 10238 (kworker/u32:6), ts 597403252405, free\_ts 597177952947
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x2d1/0x350 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x101e/0x3070 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x223/0x25a0 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x2c9/0x610 mm/mempolicy.c:2265
alloc\_slab\_page mm/slub.c:2412 [inline]
allocate\_slab mm/slub.c:2578 [inline]
new\_slab+0x2ba/0x3f0 mm/slub.c:2631
\_\_\_slab\_alloc+0xd1d/0x16f0 mm/slub.c:3818
\_\_slab\_alloc.constprop.0+0x56/0xb0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_kmalloc\_cache\_noprof+0x2c5/0x310 mm/slub.c:4290
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
mld\_add\_delrec net/ipv6/mcast.c:743 [inline]
igmp6\_leave\_group net/ipv6/mcast.c:2625 [inline]
igmp6\_group\_dropped+0x4ab/0xe40 net/ipv6/mcast.c:723
\_\_ipv6\_dev\_mc\_dec+0x281/0x360 net/ipv6/mcast.c:979
addrconf\_leave\_solict net/ipv6/addrconf.c:2253 [inline]
\_\_ipv6\_ifa\_notify+0x3f6/0xc30 net/ipv6/addrconf.c:6283
addrconf\_ifdown.isra.0+0xef9/0x1a20 net/ipv6/addrconf.c:3982
addrconf\_notify+0x220/0x19c0 net/ipv6/addrconf.c:3781
notifier\_call\_chain+0xb9/0x410 kernel/notifier.c:93
call\_netdevice\_notifiers\_info+0xbe/0x140 net/core/dev.c:1996
call\_netdevice\_notifiers\_extack net/core/dev.c:2034 [inline]
call\_netdevice\_notifiers net/core/dev.c:2048 [inline]
dev\_close\_many+0x333/0x6a0 net/core/dev.c:1589
page last free pid 13136 tgid 13136 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_page+0x5f4/0xdc0 mm/page\_alloc.c:2638
stack\_depot\_save\_flags+0x2da/0x900 lib/stackdepot.c:666
kasan\_save\_stack+0x42/0x60 mm/kasan/common.c:48
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:319 [inline]
\_\_kasan\_slab\_alloc+0x89/0x90 mm/kasan/common.c:345
kasan\_slab\_alloc include/linux/kasan.h:247 [inline]
slab\_post\_alloc\_hook mm/slub.c:4085 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_noprof+0x121/0x2f0 mm/slub.c:4141
skb\_clone+0x190/0x3f0 net/core/skbuff.c:2084
do\_one\_broadcast net/netlink/af\_netlink.c:1462 [inline]
netlink\_broadcast\_filtered+0xb11/0xef0 net/netlink/af\_netlink.c:1540
netlink\_broadcast+0x39/0x50 net/netlink/af\_netlink.c:1564
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:331 [inline]
kobject\_uevent\_net\_broadcast lib/kobject\_uevent.c:410 [inline]
kobject\_uevent\_env+0xacd/0x1670 lib/kobject\_uevent.c:608
device\_del+0x623/0x9f0 drivers/base/core.c:3882
snd\_card\_disconnect.part.0+0x58a/0x7c0 sound/core/init.c:546
snd\_card\_disconnect+0x1f/0x30 sound/core/init.c:495
snd\_usx2y\_disconnect+0xe9/0x1f0 sound/usb/usx2y/usbusx2y.c:417
usb\_unbind\_interface+0x1e8/0x970 drivers/usb/core/driver.c:461
device\_remove drivers/base/dd.c:569 [inline]
device\_remove+0x122/0x170 drivers/base/dd.c:561
That's because 'subflow' is used just after 'mptcp\_close\_ssk(subflow)',
which will initiate the release of its memory. Even if it is very likely
the release and the re-utilisation will be done later on, it is of
course better to avoid any issues and read the content of 'subflow'
before closing it.
Fixes: 1c1f72137598 ("mptcp: pm: only decrement add\_addr\_accepted for MPJ req")
Cc: stable@vger.kernel.org
Reported-by: syzbot+3c8b7a8e7df6a2a226ca@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/670d7337.050a0220.4cbc0.004f.GAE@google.com
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64@kernel.org](https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64%40kernel.org)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b2e478abab0b3a33515433a6af563aebba773c1)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=7b2e478abab0b3a33515433a6af563aebba773c1) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 131af6be4b678a..54b49fc6efd9e0 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=3c088dba8a4ed4e631c7e941fb31ef2b247d906a)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=7b2e478abab0b3a33515433a6af563aebba773c1)@@ -877,12 +877,12 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, i, rm\_id, id, remote\_id, msk->mpc\_endpoint\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how);+ removed |= subflow->request\_join;  /\* the following takes care of updating the subflows counter \*/ mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:30 +0000



=== Content from git.kernel.org_2963c0f9_20250114_192452.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35301636439138b821f1f6169bd00d348ebd388a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35301636439138b821f1f6169bd00d348ebd388a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35301636439138b821f1f6169bd00d348ebd388a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35301636439138b821f1f6169bd00d348ebd388a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-10-19 11:30:51 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:47 +0200 |
| commit | [35301636439138b821f1f6169bd00d348ebd388a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35301636439138b821f1f6169bd00d348ebd388a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35301636439138b821f1f6169bd00d348ebd388a)) | |
| tree | [43f851da7b7037fb8a7f7f4f17840708f54f1ae7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35301636439138b821f1f6169bd00d348ebd388a) | |
| parent | [2b1281f9fd01f78a06477b343d3244d4e6ba092e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b1281f9fd01f78a06477b343d3244d4e6ba092e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35301636439138b821f1f6169bd00d348ebd388a&id2=2b1281f9fd01f78a06477b343d3244d4e6ba092e)) | |
| download | [linux-35301636439138b821f1f6169bd00d348ebd388a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35301636439138b821f1f6169bd00d348ebd388a.tar.gz) | |

mptcp: pm: fix UaF read in mptcp\_pm\_nl\_rm\_addr\_or\_subflowcommit 7decd1f5904a489d3ccdcf131972f94645681689 upstream.
Syzkaller reported this splat:
==================================================================
BUG: KASAN: slab-use-after-free in mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
Read of size 4 at addr ffff8880569ac858 by task syz.1.2799/14662
CPU: 0 UID: 0 PID: 14662 Comm: syz.1.2799 Not tainted 6.12.0-rc2-syzkaller-00307-g36c254515dc6 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x116/0x1f0 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0xc3/0x620 mm/kasan/report.c:488
kasan\_report+0xd9/0x110 mm/kasan/report.c:601
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0xb44/0xcc0 net/mptcp/pm\_netlink.c:881
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf7fe4579
Code: b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
RSP: 002b:00000000f574556c EFLAGS: 00000296 ORIG\_RAX: 0000000000000172
RAX: ffffffffffffffda RBX: 000000000000000b RCX: 0000000020000140
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
Allocated by task 5387:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0xaa/0xb0 mm/kasan/common.c:394
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
subflow\_create\_ctx+0x87/0x2a0 net/mptcp/subflow.c:1803
subflow\_ulp\_init+0xc3/0x4d0 net/mptcp/subflow.c:1956
\_\_tcp\_set\_ulp net/ipv4/tcp\_ulp.c:146 [inline]
tcp\_set\_ulp+0x326/0x7f0 net/ipv4/tcp\_ulp.c:167
mptcp\_subflow\_create\_socket+0x4ae/0x10a0 net/mptcp/subflow.c:1764
\_\_mptcp\_subflow\_connect+0x3cc/0x1490 net/mptcp/subflow.c:1592
mptcp\_pm\_create\_subflow\_or\_signal\_addr+0xbda/0x23a0 net/mptcp/pm\_netlink.c:642
mptcp\_pm\_nl\_fully\_established net/mptcp/pm\_netlink.c:650 [inline]
mptcp\_pm\_nl\_work+0x3a1/0x4f0 net/mptcp/pm\_netlink.c:943
mptcp\_worker+0x15a/0x1240 net/mptcp/protocol.c:2777
process\_one\_work+0x958/0x1b30 kernel/workqueue.c:3229
process\_scheduled\_works kernel/workqueue.c:3310 [inline]
worker\_thread+0x6c8/0xf00 kernel/workqueue.c:3391
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Freed by task 113:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
kasan\_save\_free\_info+0x3b/0x60 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x51/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x14f/0x4b0 mm/slub.c:4727
kvfree+0x47/0x50 mm/util.c:701
kvfree\_rcu\_list+0xf5/0x2c0 kernel/rcu/tree.c:3423
kvfree\_rcu\_drain\_ready kernel/rcu/tree.c:3563 [inline]
kfree\_rcu\_monitor+0x503/0x8b0 kernel/rcu/tree.c:3632
kfree\_rcu\_shrink\_scan+0x245/0x3a0 kernel/rcu/tree.c:3966
do\_shrink\_slab+0x44f/0x11c0 mm/shrinker.c:435
shrink\_slab+0x32b/0x12a0 mm/shrinker.c:662
shrink\_one+0x47e/0x7b0 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x2452/0x39d0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat+0xc19/0x18f0 mm/vmscan.c:6957
kswapd+0x5ea/0xbf0 mm/vmscan.c:7226
kthread+0x2c1/0x3a0 kernel/kthread.c:389
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Last potentially related work creation:
kasan\_save\_stack+0x33/0x60 mm/kasan/common.c:47
\_\_kasan\_record\_aux\_stack+0xba/0xd0 mm/kasan/generic.c:541
kvfree\_call\_rcu+0x74/0xbe0 kernel/rcu/tree.c:3810
subflow\_ulp\_release+0x2ae/0x350 net/mptcp/subflow.c:2009
tcp\_cleanup\_ulp+0x7c/0x130 net/ipv4/tcp\_ulp.c:124
tcp\_v4\_destroy\_sock+0x1c5/0x6a0 net/ipv4/tcp\_ipv4.c:2541
inet\_csk\_destroy\_sock+0x1a3/0x440 net/ipv4/inet\_connection\_sock.c:1293
tcp\_done+0x252/0x350 net/ipv4/tcp.c:4870
tcp\_rcv\_state\_process+0x379b/0x4f30 net/ipv4/tcp\_input.c:6933
tcp\_v4\_do\_rcv+0x1ad/0xa90 net/ipv4/tcp\_ipv4.c:1938
sk\_backlog\_rcv include/net/sock.h:1115 [inline]
\_\_release\_sock+0x31b/0x400 net/core/sock.c:3072
\_\_tcp\_close+0x4f3/0xff0 net/ipv4/tcp.c:3142
\_\_mptcp\_close\_ssk+0x331/0x14d0 net/mptcp/protocol.c:2489
mptcp\_close\_ssk net/mptcp/protocol.c:2543 [inline]
mptcp\_close\_ssk+0x150/0x220 net/mptcp/protocol.c:2526
mptcp\_pm\_nl\_rm\_addr\_or\_subflow+0x2be/0xcc0 net/mptcp/pm\_netlink.c:878
mptcp\_pm\_nl\_rm\_subflow\_received net/mptcp/pm\_netlink.c:914 [inline]
mptcp\_nl\_remove\_id\_zero\_address+0x305/0x4a0 net/mptcp/pm\_netlink.c:1572
mptcp\_pm\_nl\_del\_addr\_doit+0x5c9/0x770 net/mptcp/pm\_netlink.c:1603
genl\_family\_rcv\_msg\_doit+0x202/0x2f0 net/netlink/genetlink.c:1115
genl\_family\_rcv\_msg net/netlink/genetlink.c:1195 [inline]
genl\_rcv\_msg+0x565/0x800 net/netlink/genetlink.c:1210
netlink\_rcv\_skb+0x165/0x410 net/netlink/af\_netlink.c:2551
genl\_rcv+0x28/0x40 net/netlink/genetlink.c:1219
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1331 [inline]
netlink\_unicast+0x53c/0x7f0 net/netlink/af\_netlink.c:1357
netlink\_sendmsg+0x8b8/0xd70 net/netlink/af\_netlink.c:1901
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg net/socket.c:744 [inline]
\_\_\_\_sys\_sendmsg+0x9ae/0xb40 net/socket.c:2607
\_\_\_sys\_sendmsg+0x135/0x1e0 net/socket.c:2661
\_\_sys\_sendmsg+0x117/0x1f0 net/socket.c:2690
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0x73/0x120 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x32/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
The buggy address belongs to the object at ffff8880569ac800
which belongs to the cache kmalloc-512 of size 512
The buggy address is located 88 bytes inside of
freed 512-byte region [ffff8880569ac800, ffff8880569aca00)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x569ac
head: order:2 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
raw: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42c80 dead000000000100 dead000000000122
head: 0000000000000000 0000000080100010 00000001f5000000 0000000000000000
head: 04fff00000000002 ffffea00015a6b01 ffffffffffffffff 0000000000000000
head: 0000000000000004 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 10238, tgid 10238 (kworker/u32:6), ts 597403252405, free\_ts 597177952947
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x2d1/0x350 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x101e/0x3070 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x223/0x25a0 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x2c9/0x610 mm/mempolicy.c:2265
alloc\_slab\_page mm/slub.c:2412 [inline]
allocate\_slab mm/slub.c:2578 [inline]
new\_slab+0x2ba/0x3f0 mm/slub.c:2631
\_\_\_slab\_alloc+0xd1d/0x16f0 mm/slub.c:3818
\_\_slab\_alloc.constprop.0+0x56/0xb0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_kmalloc\_cache\_noprof+0x2c5/0x310 mm/slub.c:4290
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
mld\_add\_delrec net/ipv6/mcast.c:743 [inline]
igmp6\_leave\_group net/ipv6/mcast.c:2625 [inline]
igmp6\_group\_dropped+0x4ab/0xe40 net/ipv6/mcast.c:723
\_\_ipv6\_dev\_mc\_dec+0x281/0x360 net/ipv6/mcast.c:979
addrconf\_leave\_solict net/ipv6/addrconf.c:2253 [inline]
\_\_ipv6\_ifa\_notify+0x3f6/0xc30 net/ipv6/addrconf.c:6283
addrconf\_ifdown.isra.0+0xef9/0x1a20 net/ipv6/addrconf.c:3982
addrconf\_notify+0x220/0x19c0 net/ipv6/addrconf.c:3781
notifier\_call\_chain+0xb9/0x410 kernel/notifier.c:93
call\_netdevice\_notifiers\_info+0xbe/0x140 net/core/dev.c:1996
call\_netdevice\_notifiers\_extack net/core/dev.c:2034 [inline]
call\_netdevice\_notifiers net/core/dev.c:2048 [inline]
dev\_close\_many+0x333/0x6a0 net/core/dev.c:1589
page last free pid 13136 tgid 13136 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_page+0x5f4/0xdc0 mm/page\_alloc.c:2638
stack\_depot\_save\_flags+0x2da/0x900 lib/stackdepot.c:666
kasan\_save\_stack+0x42/0x60 mm/kasan/common.c:48
kasan\_save\_track+0x14/0x30 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:319 [inline]
\_\_kasan\_slab\_alloc+0x89/0x90 mm/kasan/common.c:345
kasan\_slab\_alloc include/linux/kasan.h:247 [inline]
slab\_post\_alloc\_hook mm/slub.c:4085 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_noprof+0x121/0x2f0 mm/slub.c:4141
skb\_clone+0x190/0x3f0 net/core/skbuff.c:2084
do\_one\_broadcast net/netlink/af\_netlink.c:1462 [inline]
netlink\_broadcast\_filtered+0xb11/0xef0 net/netlink/af\_netlink.c:1540
netlink\_broadcast+0x39/0x50 net/netlink/af\_netlink.c:1564
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:331 [inline]
kobject\_uevent\_net\_broadcast lib/kobject\_uevent.c:410 [inline]
kobject\_uevent\_env+0xacd/0x1670 lib/kobject\_uevent.c:608
device\_del+0x623/0x9f0 drivers/base/core.c:3882
snd\_card\_disconnect.part.0+0x58a/0x7c0 sound/core/init.c:546
snd\_card\_disconnect+0x1f/0x30 sound/core/init.c:495
snd\_usx2y\_disconnect+0xe9/0x1f0 sound/usb/usx2y/usbusx2y.c:417
usb\_unbind\_interface+0x1e8/0x970 drivers/usb/core/driver.c:461
device\_remove drivers/base/dd.c:569 [inline]
device\_remove+0x122/0x170 drivers/base/dd.c:561
That's because 'subflow' is used just after 'mptcp\_close\_ssk(subflow)',
which will initiate the release of its memory. Even if it is very likely
the release and the re-utilisation will be done later on, it is of
course better to avoid any issues and read the content of 'subflow'
before closing it.
Fixes: 1c1f72137598 ("mptcp: pm: only decrement add\_addr\_accepted for MPJ req")
Cc: stable@vger.kernel.org
Reported-by: syzbot+3c8b7a8e7df6a2a226ca@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/670d7337.050a0220.4cbc0.004f.GAE@google.com
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64@kernel.org](https://patch.msgid.link/20241015-net-mptcp-uaf-pm-rm-v1-1-c4ee5d987a64%40kernel.org)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[ Conflicts in pm\_netlink.c, because commit a88c9e496937 ("mptcp: do not
block subflows creation on errors") is linked to a new feature, not
available in this version. This commit modifies the context. Resolving
the conflicts is easy, simply moving the lines the same way it was
done in the original patch, ignoring the comment that is not in this
version. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35301636439138b821f1f6169bd00d348ebd388a)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=35301636439138b821f1f6169bd00d348ebd388a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex e524171291bc77..133c5f2b3ba641 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=2b1281f9fd01f78a06477b343d3244d4e6ba092e)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=35301636439138b821f1f6169bd00d348ebd388a)@@ -793,10 +793,10 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, i, rm\_list->ids[i], subflow->local\_id, subflow->remote\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how);+ removed |= subflow->request\_join; mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed |= subflow->request\_join; msk->pm.subflows--; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:29 +0000


