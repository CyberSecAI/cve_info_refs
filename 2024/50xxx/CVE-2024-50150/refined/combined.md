=== Content from git.kernel.org_1b8fe88f_20250114_183259.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:20 +0100 |
| commit | [2b0b33e8a58388fa9078f0fbe9af1900e6b08879](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)) | |
| tree | [8686fd1153b071ac97b4be7788532178e6abc874](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879) | |
| parent | [8e81ce7d0166a2249deb6d5e42f28a8b8c9ea72f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e81ce7d0166a2249deb6d5e42f28a8b8c9ea72f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879&id2=8e81ce7d0166a2249deb6d5e42f28a8b8c9ea72f)) | |
| download | [linux-2b0b33e8a58388fa9078f0fbe9af1900e6b08879.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b0b33e8a58388fa9078f0fbe9af1900e6b08879.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex d396836244ff2a..ae6835a7923925 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=8e81ce7d0166a2249deb6d5e42f28a8b8c9ea72f)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=2b0b33e8a58388fa9078f0fbe9af1900e6b08879)@@ -465,6 +465,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -514,6 +515,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (is\_port) BLOCKING\_INIT\_NOTIFIER\_HEAD(&alt->nh); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:36 +0000



=== Content from git.kernel.org_32fe5a99_20250114_183302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-16 10:22:52 +0200 |
| commit | [befab3a278c59db0cc88c8799638064f6d3fd6f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)) | |
| tree | [69488b78d65150c3ad64f7b3a2422923854032be](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8) | |
| parent | [92682f3460071733f16cebd7cf8e33e776bc9aaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92682f3460071733f16cebd7cf8e33e776bc9aaf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8&id2=92682f3460071733f16cebd7cf8e33e776bc9aaf)) | |
| download | [linux-befab3a278c59db0cc88c8799638064f6d3fd6f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-befab3a278c59db0cc88c8799638064f6d3fd6f8.tar.gz) | |

usb: typec: altmode should keep reference to parentThe altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=befab3a278c59db0cc88c8799638064f6d3fd6f8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex 9262fcd4144f85..d61b4c74648df6 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=92682f3460071733f16cebd7cf8e33e776bc9aaf)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=befab3a278c59db0cc88c8799638064f6d3fd6f8)@@ -519,6 +519,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -568,6 +569,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:40 +0000



=== Content from git.kernel.org_7787e412_20250114_183258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:24 +0100 |
| commit | [1ded6b12499e6dee9b0e1ceac633be36538f6fc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)) | |
| tree | [35f1fcec05b0e2adc5505e39a8af8fd5f9b31b77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2) | |
| parent | [b209c3a0bc3ac172265c7fa8309e5d00654f2510](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2&id2=b209c3a0bc3ac172265c7fa8309e5d00654f2510)) | |
| download | [linux-1ded6b12499e6dee9b0e1ceac633be36538f6fc2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ded6b12499e6dee9b0e1ceac633be36538f6fc2.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex f92fc2acfcba04..79cad8d61dacdd 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=1ded6b12499e6dee9b0e1ceac633be36538f6fc2)@@ -502,6 +502,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -551,6 +552,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:35 +0000



=== Content from git.kernel.org_1c89628d_20250114_183300.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=68a7c7fe322546be1464174c8d85874b8161deda)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=68a7c7fe322546be1464174c8d85874b8161deda)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68a7c7fe322546be1464174c8d85874b8161deda)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68a7c7fe322546be1464174c8d85874b8161deda)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:30 +0100 |
| commit | [68a7c7fe322546be1464174c8d85874b8161deda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68a7c7fe322546be1464174c8d85874b8161deda) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=68a7c7fe322546be1464174c8d85874b8161deda)) | |
| tree | [f1749e26fffd9cb9dd9c76a8e8cb61d59dc73b75](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=68a7c7fe322546be1464174c8d85874b8161deda) | |
| parent | [fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68a7c7fe322546be1464174c8d85874b8161deda&id2=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)) | |
| download | [linux-68a7c7fe322546be1464174c8d85874b8161deda.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-68a7c7fe322546be1464174c8d85874b8161deda.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68a7c7fe322546be1464174c8d85874b8161deda)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=68a7c7fe322546be1464174c8d85874b8161deda) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex 9262fcd4144f85..d61b4c74648df6 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=68a7c7fe322546be1464174c8d85874b8161deda)@@ -519,6 +519,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -568,6 +569,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:37 +0000



=== Content from git.kernel.org_5be8b630_20250114_183259.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:50 +0100 |
| commit | [2c15c4133d00f5da632fce60ed013fc31aa9aa58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)) | |
| tree | [6a513252f1f5c62420b44467da9d6b0fc89bde36](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58) | |
| parent | [6f0516ef1290da24b85461ed08a0938af7415e49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f0516ef1290da24b85461ed08a0938af7415e49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58&id2=6f0516ef1290da24b85461ed08a0938af7415e49)) | |
| download | [linux-2c15c4133d00f5da632fce60ed013fc31aa9aa58.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c15c4133d00f5da632fce60ed013fc31aa9aa58.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex 371e010e0e859f..c30740165b3640 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=6f0516ef1290da24b85461ed08a0938af7415e49)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=2c15c4133d00f5da632fce60ed013fc31aa9aa58)@@ -471,6 +471,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -520,6 +521,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (is\_port) BLOCKING\_INIT\_NOTIFIER\_HEAD(&alt->nh); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:36 +0000



=== Content from git.kernel.org_3f9604bd_20250114_183301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:21:58 +0100 |
| commit | [6af43ec3bf40f8b428d9134ffa7a291aecd60da8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)) | |
| tree | [8610572b7c833c6bb0ed418c9b4281a8c4df5bdb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8) | |
| parent | [ed31aba8ce93472d9e16f5cff844ae7c94e9601d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8&id2=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)) | |
| download | [linux-6af43ec3bf40f8b428d9134ffa7a291aecd60da8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6af43ec3bf40f8b428d9134ffa7a291aecd60da8.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex 7fa95e7012446a..dec83edb09de2d 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=6af43ec3bf40f8b428d9134ffa7a291aecd60da8)@@ -430,6 +430,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -479,6 +480,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:38 +0000



=== Content from git.kernel.org_e06fd4e7_20250114_183301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=87474406056891e4fdea0794e1f632b21b3dfa27)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87474406056891e4fdea0794e1f632b21b3dfa27)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87474406056891e4fdea0794e1f632b21b3dfa27)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87474406056891e4fdea0794e1f632b21b3dfa27)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:34 +0100 |
| commit | [87474406056891e4fdea0794e1f632b21b3dfa27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87474406056891e4fdea0794e1f632b21b3dfa27) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=87474406056891e4fdea0794e1f632b21b3dfa27)) | |
| tree | [9b8b26a93cd9cf888ca24c4c7b8b66b101ceed3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87474406056891e4fdea0794e1f632b21b3dfa27) | |
| parent | [e07d05b7f5ad9a503d9cab0afde2ab867bb65470](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87474406056891e4fdea0794e1f632b21b3dfa27&id2=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)) | |
| download | [linux-87474406056891e4fdea0794e1f632b21b3dfa27.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-87474406056891e4fdea0794e1f632b21b3dfa27.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87474406056891e4fdea0794e1f632b21b3dfa27)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=87474406056891e4fdea0794e1f632b21b3dfa27) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex 173d86d120dafd..af75911899f53a 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=87474406056891e4fdea0794e1f632b21b3dfa27)@@ -501,6 +501,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -550,6 +551,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:38 +0000



=== Content from git.kernel.org_6ede803a_20250114_183302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-10-04 09:37:38 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:00 +0100 |
| commit | [bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)) | |
| tree | [05ffca88707332978339eeeb6865df96fc1aa419](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d) | |
| parent | [2ef632bfb888d1a14f81c1703817951e0bec5531](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef632bfb888d1a14f81c1703817951e0bec5531) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d&id2=2ef632bfb888d1a14f81c1703817951e0bec5531)) | |
| download | [linux-bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d.tar.gz) | |

usb: typec: altmode should keep reference to parent[ Upstream commit befab3a278c59db0cc88c8799638064f6d3fd6f8 ]
The altmode device release refers to its parent device, but without keeping
a reference to it.
When registering the altmode, get a reference to the parent and put it in
the release function.
Before this fix, when using CONFIG\_DEBUG\_KOBJECT\_RELEASE, we see issues
like this:
[ 43.572860] kobject: 'port0.0' (ffff8880057ba008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.573532] kobject: 'port0.1' (ffff8880057bd008): kobject\_release, parent 0000000000000000 (delayed 1000)
[ 43.574407] kobject: 'port0' (ffff8880057b9008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 43.575059] kobject: 'port1.0' (ffff8880057ca008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.575908] kobject: 'port1.1' (ffff8880057c9008): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.576908] kobject: 'typec' (ffff8880062dbc00): kobject\_release, parent 0000000000000000 (delayed 4000)
[ 43.577769] kobject: 'port1' (ffff8880057bf008): kobject\_release, parent 0000000000000000 (delayed 3000)
[ 46.612867] ==================================================================
[ 46.613402] BUG: KASAN: slab-use-after-free in typec\_altmode\_release+0x38/0x129
[ 46.614003] Read of size 8 at addr ffff8880057b9118 by task kworker/2:1/48
[ 46.614538]
[ 46.614668] CPU: 2 UID: 0 PID: 48 Comm: kworker/2:1 Not tainted 6.12.0-rc1-00138-gedbae730ad31 #535
[ 46.615391] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 46.616042] Workqueue: events kobject\_delayed\_cleanup
[ 46.616446] Call Trace:
[ 46.616648] <TASK>
[ 46.616820] dump\_stack\_lvl+0x5b/0x7c
[ 46.617112] ? typec\_altmode\_release+0x38/0x129
[ 46.617470] print\_report+0x14c/0x49e
[ 46.617769] ? rcu\_read\_unlock\_sched+0x56/0x69
[ 46.618117] ? \_\_virt\_addr\_valid+0x19a/0x1ab
[ 46.618456] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 46.618807] ? typec\_altmode\_release+0x38/0x129
[ 46.619161] kasan\_report+0x8d/0xb4
[ 46.619447] ? typec\_altmode\_release+0x38/0x129
[ 46.619809] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620185] typec\_altmode\_release+0x38/0x129
[ 46.620537] ? process\_scheduled\_works+0x3cb/0x85f
[ 46.620907] device\_release+0xaf/0xf2
[ 46.621206] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.621584] process\_scheduled\_works+0x4f6/0x85f
[ 46.621955] ? \_\_pfx\_process\_scheduled\_works+0x10/0x10
[ 46.622353] ? hlock\_class+0x31/0x9a
[ 46.622647] ? lock\_acquired+0x361/0x3c3
[ 46.622956] ? move\_linked\_works+0x46/0x7d
[ 46.623277] worker\_thread+0x1ce/0x291
[ 46.623582] ? \_\_kthread\_parkme+0xc8/0xdf
[ 46.623900] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 46.624236] kthread+0x17e/0x190
[ 46.624501] ? kthread+0xfb/0x190
[ 46.624756] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625015] ret\_from\_fork+0x20/0x40
[ 46.625268] ? \_\_pfx\_kthread+0x10/0x10
[ 46.625532] ret\_from\_fork\_asm+0x1a/0x30
[ 46.625805] </TASK>
[ 46.625953]
[ 46.626056] Allocated by task 678:
[ 46.626287] kasan\_save\_stack+0x24/0x44
[ 46.626555] kasan\_save\_track+0x14/0x2d
[ 46.626811] \_\_kasan\_kmalloc+0x3f/0x4d
[ 46.627049] \_\_kmalloc\_noprof+0x1bf/0x1f0
[ 46.627362] typec\_register\_port+0x23/0x491
[ 46.627698] cros\_typec\_probe+0x634/0xbb6
[ 46.628026] platform\_probe+0x47/0x8c
[ 46.628311] really\_probe+0x20a/0x47d
[ 46.628605] device\_driver\_attach+0x39/0x72
[ 46.628940] bind\_store+0x87/0xd7
[ 46.629213] kernfs\_fop\_write\_iter+0x1aa/0x218
[ 46.629574] vfs\_write+0x1d6/0x29b
[ 46.629856] ksys\_write+0xcd/0x13b
[ 46.630128] do\_syscall\_64+0xd4/0x139
[ 46.630420] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 46.630820]
[ 46.630946] Freed by task 48:
[ 46.631182] kasan\_save\_stack+0x24/0x44
[ 46.631493] kasan\_save\_track+0x14/0x2d
[ 46.631799] kasan\_save\_free\_info+0x3f/0x4d
[ 46.632144] \_\_kasan\_slab\_free+0x37/0x45
[ 46.632474] kfree+0x1d4/0x252
[ 46.632725] device\_release+0xaf/0xf2
[ 46.633017] kobject\_delayed\_cleanup+0x13b/0x17a
[ 46.633388] process\_scheduled\_works+0x4f6/0x85f
[ 46.633764] worker\_thread+0x1ce/0x291
[ 46.634065] kthread+0x17e/0x190
[ 46.634324] ret\_from\_fork+0x20/0x40
[ 46.634621] ret\_from\_fork\_asm+0x1a/0x30
Fixes: 8a37d87d72f0 ("usb: typec: Bus type for alternate modes")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Link: [https://lore.kernel.org/r/20241004123738.2964524-1-cascardo@igalia.com](https://lore.kernel.org/r/20241004123738.2964524-1-cascardo%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)

| -rw-r--r-- | [drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/class.c?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/usb/typec/class.c b/drivers/usb/typec/class.cindex ce83f558fe4474..3d44e181dbb501 100644--- a/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=2ef632bfb888d1a14f81c1703817951e0bec5531)+++ b/[drivers/usb/typec/class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/class.c?id=bee1b68cb8bcee4fd3a8bde3a4886e0b1375dc4d)@@ -503,6 +503,7 @@ static void typec\_altmode\_release(struct device \*dev) typec\_altmode\_put\_partner(alt);  altmode\_id\_remove(alt->adev.dev.parent, alt->id);+ put\_device(alt->adev.dev.parent); kfree(alt); } @@ -552,6 +553,8 @@ typec\_register\_altmode(struct device \*parent, alt->adev.dev.type = &typec\_altmode\_dev\_type; dev\_set\_name(&alt->adev.dev, "%s.%u", dev\_name(parent), id); + get\_device(alt->adev.dev.parent);+ /\* Link partners and plugs with the ports \*/ if (!is\_port) typec\_altmode\_set\_partner(alt); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:31:39 +0000


