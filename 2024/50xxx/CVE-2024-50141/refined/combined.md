=== Content from git.kernel.org_6c9a5ba6_20250114_191553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=088984c8d54c0053fc4ae606981291d741c5924b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=088984c8d54c0053fc4ae606981291d741c5924b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=088984c8d54c0053fc4ae606981291d741c5924b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=088984c8d54c0053fc4ae606981291d741c5924b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koba Ko <kobak@nvidia.com> | 2024-10-13 04:50:10 +0800 |
| --- | --- | --- |
| committer | Rafael J. Wysocki <rafael.j.wysocki@intel.com> | 2024-10-21 13:46:50 +0200 |
| commit | [088984c8d54c0053fc4ae606981291d741c5924b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=088984c8d54c0053fc4ae606981291d741c5924b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=088984c8d54c0053fc4ae606981291d741c5924b)) | |
| tree | [dbcaef49bd00adc70bbab723e62a294aa27bb6c3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=088984c8d54c0053fc4ae606981291d741c5924b) | |
| parent | [42f7652d3eb527d03665b09edac47f85fb600924](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42f7652d3eb527d03665b09edac47f85fb600924) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=088984c8d54c0053fc4ae606981291d741c5924b&id2=42f7652d3eb527d03665b09edac47f85fb600924)) | |
| download | [linux-088984c8d54c0053fc4ae606981291d741c5924b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-088984c8d54c0053fc4ae606981291d741c5924b.tar.gz) | |

ACPI: PRM: Find EFI\_MEMORY\_RUNTIME block for PRM handler and contextPRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.
The issue arises because the PRMT is finding a block of type
EFI\_CONVENTIONAL\_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.
[Firmware Bug]: Unable to handle paging request in EFI runtime service
WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
\_\_efi\_queue\_work+0x11c/0x170
Call trace:
Let PRMT find a block with EFI\_MEMORY\_RUNTIME for PRM handler and PRM
context.
If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.
However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.
By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.
The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI\_MEMORY\_RUNTIME attribute.
Link: <https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf> # [1]
Fixes: cefc7ca46235 ("ACPI: PRM: implement OperationRegion handler for the PlatformRtMechanism subtype")
Cc: All applicable <stable@vger.kernel.org>
Signed-off-by: Koba Ko <kobak@nvidia.com>
Reviewed-by: Matthew R. Ochs <mochs@nvidia.com>
Reviewed-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
Link: [https://patch.msgid.link/20241012205010.4165798-1-kobak@nvidia.com](https://patch.msgid.link/20241012205010.4165798-1-kobak%40nvidia.com)
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=088984c8d54c0053fc4ae606981291d741c5924b)

| -rw-r--r-- | [drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/prmt.c?id=088984c8d54c0053fc4ae606981291d741c5924b) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/drivers/acpi/prmt.c b/drivers/acpi/prmt.cindex 1cfaa5957ac4d8..d59307a76ca31e 100644--- a/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=42f7652d3eb527d03665b09edac47f85fb600924)+++ b/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=088984c8d54c0053fc4ae606981291d741c5924b)@@ -72,17 +72,21 @@ struct prm\_module\_info { struct prm\_handler\_info handlers[] \_\_counted\_by(handler\_count); }; -static u64 efi\_pa\_va\_lookup(u64 pa)+static u64 efi\_pa\_va\_lookup(efi\_guid\_t \*guid, u64 pa) { efi\_memory\_desc\_t \*md; u64 pa\_offset = pa & ~PAGE\_MASK; u64 page = pa & PAGE\_MASK;  for\_each\_efi\_memory\_desc(md) {- if (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)+ if ((md->attribute & EFI\_MEMORY\_RUNTIME) &&+ (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)) { return pa\_offset + md->virt\_addr + page - md->phys\_addr;+ } } + pr\_warn("Failed to find VA for GUID: %pUL, PA: 0x%llx", guid, pa);+ return 0; } @@ -148,9 +152,15 @@ acpi\_parse\_prmt(union acpi\_subtable\_headers \*header, const unsigned long end) th = &tm->handlers[cur\_handler];  guid\_copy(&th->guid, (guid\_t \*)handler\_info->handler\_guid);- th->handler\_addr = (void \*)efi\_pa\_va\_lookup(handler\_info->handler\_address);- th->static\_data\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->static\_data\_buffer\_address);- th->acpi\_param\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->acpi\_param\_buffer\_address);+ th->handler\_addr =+ (void \*)efi\_pa\_va\_lookup(&th->guid, handler\_info->handler\_address);++ th->static\_data\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->static\_data\_buffer\_address);++ th->acpi\_param\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->acpi\_param\_buffer\_address);+ } while (++cur\_handler < tm->handler\_count && (handler\_info = get\_next\_handler(handler\_info)));  return 0;@@ -277,6 +287,13 @@ static acpi\_status acpi\_platformrt\_space\_handler(u32 function, if (!handler || !module) goto invalid\_guid; + if (!handler->handler\_addr ||+ !handler->static\_data\_buffer\_addr ||+ !handler->acpi\_param\_buffer\_addr) {+ buffer->prm\_status = PRM\_HANDLER\_ERROR;+ return AE\_OK;+ }+ ACPI\_COPY\_NAMESEG(context.signature, "PRMC"); context.revision = 0x0; context.reserved = 0x0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:14:30 +0000



=== Content from git.kernel.org_cf1a5100_20250114_191556.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8df52929530839e878e6912e33348b54101e3250)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8df52929530839e878e6912e33348b54101e3250)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8df52929530839e878e6912e33348b54101e3250)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df52929530839e878e6912e33348b54101e3250)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koba Ko <kobak@nvidia.com> | 2024-10-13 04:50:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:51 +0100 |
| commit | [8df52929530839e878e6912e33348b54101e3250](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8df52929530839e878e6912e33348b54101e3250) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8df52929530839e878e6912e33348b54101e3250)) | |
| tree | [69888e4a03b0a15a93c1a5ab787f526a216ea0fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8df52929530839e878e6912e33348b54101e3250) | |
| parent | [6ef99e50be2feca3eddc158f6d2758fe0a492d27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ef99e50be2feca3eddc158f6d2758fe0a492d27) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df52929530839e878e6912e33348b54101e3250&id2=6ef99e50be2feca3eddc158f6d2758fe0a492d27)) | |
| download | [linux-8df52929530839e878e6912e33348b54101e3250.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8df52929530839e878e6912e33348b54101e3250.tar.gz) | |

ACPI: PRM: Find EFI\_MEMORY\_RUNTIME block for PRM handler and context[ Upstream commit 088984c8d54c0053fc4ae606981291d741c5924b ]
PRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.
The issue arises because the PRMT is finding a block of type
EFI\_CONVENTIONAL\_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.
[Firmware Bug]: Unable to handle paging request in EFI runtime service
WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
\_\_efi\_queue\_work+0x11c/0x170
Call trace:
Let PRMT find a block with EFI\_MEMORY\_RUNTIME for PRM handler and PRM
context.
If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.
However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.
By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.
The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI\_MEMORY\_RUNTIME attribute.
Link: <https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf> # [1]
Fixes: cefc7ca46235 ("ACPI: PRM: implement OperationRegion handler for the PlatformRtMechanism subtype")
Cc: All applicable <stable@vger.kernel.org>
Signed-off-by: Koba Ko <kobak@nvidia.com>
Reviewed-by: Matthew R. Ochs <mochs@nvidia.com>
Reviewed-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
Link: [https://patch.msgid.link/20241012205010.4165798-1-kobak@nvidia.com](https://patch.msgid.link/20241012205010.4165798-1-kobak%40nvidia.com)
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df52929530839e878e6912e33348b54101e3250)

| -rw-r--r-- | [drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/prmt.c?id=8df52929530839e878e6912e33348b54101e3250) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/drivers/acpi/prmt.c b/drivers/acpi/prmt.cindex 6da424f1f133f2..63ead3f1d29479 100644--- a/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=6ef99e50be2feca3eddc158f6d2758fe0a492d27)+++ b/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=8df52929530839e878e6912e33348b54101e3250)@@ -72,17 +72,21 @@ struct prm\_module\_info { struct prm\_handler\_info handlers[]; }; -static u64 efi\_pa\_va\_lookup(u64 pa)+static u64 efi\_pa\_va\_lookup(efi\_guid\_t \*guid, u64 pa) { efi\_memory\_desc\_t \*md; u64 pa\_offset = pa & ~PAGE\_MASK; u64 page = pa & PAGE\_MASK;  for\_each\_efi\_memory\_desc(md) {- if (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)+ if ((md->attribute & EFI\_MEMORY\_RUNTIME) &&+ (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)) { return pa\_offset + md->virt\_addr + page - md->phys\_addr;+ } } + pr\_warn("Failed to find VA for GUID: %pUL, PA: 0x%llx", guid, pa);+ return 0; } @@ -136,9 +140,15 @@ acpi\_parse\_prmt(union acpi\_subtable\_headers \*header, const unsigned long end) th = &tm->handlers[cur\_handler];  guid\_copy(&th->guid, (guid\_t \*)handler\_info->handler\_guid);- th->handler\_addr = (void \*)efi\_pa\_va\_lookup(handler\_info->handler\_address);- th->static\_data\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->static\_data\_buffer\_address);- th->acpi\_param\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->acpi\_param\_buffer\_address);+ th->handler\_addr =+ (void \*)efi\_pa\_va\_lookup(&th->guid, handler\_info->handler\_address);++ th->static\_data\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->static\_data\_buffer\_address);++ th->acpi\_param\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->acpi\_param\_buffer\_address);+ } while (++cur\_handler < tm->handler\_count && (handler\_info = get\_next\_handler(handler\_info)));  return 0;@@ -232,6 +242,13 @@ static acpi\_status acpi\_platformrt\_space\_handler(u32 function, if (!handler || !module) goto invalid\_guid; + if (!handler->handler\_addr ||+ !handler->static\_data\_buffer\_addr ||+ !handler->acpi\_param\_buffer\_addr) {+ buffer->prm\_status = PRM\_HANDLER\_ERROR;+ return AE\_OK;+ }+ ACPI\_COPY\_NAMESEG(context.signature, "PRMC"); context.revision = 0x0; context.reserved = 0x0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:14:33 +0000



=== Content from git.kernel.org_7910b90d_20250114_191554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koba Ko <kobak@nvidia.com> | 2024-10-13 04:50:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:40 +0100 |
| commit | [20e9fafb8bb6f545667d7916b0e81e68c0748810](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)) | |
| tree | [19b86b80844a6097e54e33a3d5cb39b03936cf8f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810) | |
| parent | [d8e5c7ad0f4365a376ea61967e310e03b858b9d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8e5c7ad0f4365a376ea61967e310e03b858b9d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810&id2=d8e5c7ad0f4365a376ea61967e310e03b858b9d3)) | |
| download | [linux-20e9fafb8bb6f545667d7916b0e81e68c0748810.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20e9fafb8bb6f545667d7916b0e81e68c0748810.tar.gz) | |

ACPI: PRM: Find EFI\_MEMORY\_RUNTIME block for PRM handler and contextcommit 088984c8d54c0053fc4ae606981291d741c5924b upstream.
PRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.
The issue arises because the PRMT is finding a block of type
EFI\_CONVENTIONAL\_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.
[Firmware Bug]: Unable to handle paging request in EFI runtime service
WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
\_\_efi\_queue\_work+0x11c/0x170
Call trace:
Let PRMT find a block with EFI\_MEMORY\_RUNTIME for PRM handler and PRM
context.
If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.
However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.
By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.
The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI\_MEMORY\_RUNTIME attribute.
Link: <https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf> # [1]
Fixes: cefc7ca46235 ("ACPI: PRM: implement OperationRegion handler for the PlatformRtMechanism subtype")
Cc: All applicable <stable@vger.kernel.org>
Signed-off-by: Koba Ko <kobak@nvidia.com>
Reviewed-by: Matthew R. Ochs <mochs@nvidia.com>
Reviewed-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
Link: [https://patch.msgid.link/20241012205010.4165798-1-kobak@nvidia.com](https://patch.msgid.link/20241012205010.4165798-1-kobak%40nvidia.com)
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)

| -rw-r--r-- | [drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/prmt.c?id=20e9fafb8bb6f545667d7916b0e81e68c0748810) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/drivers/acpi/prmt.c b/drivers/acpi/prmt.cindex c78453c74ef5aa..6c057deacfa74d 100644--- a/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=d8e5c7ad0f4365a376ea61967e310e03b858b9d3)+++ b/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=20e9fafb8bb6f545667d7916b0e81e68c0748810)@@ -72,17 +72,21 @@ struct prm\_module\_info { struct prm\_handler\_info handlers[] \_\_counted\_by(handler\_count); }; -static u64 efi\_pa\_va\_lookup(u64 pa)+static u64 efi\_pa\_va\_lookup(efi\_guid\_t \*guid, u64 pa) { efi\_memory\_desc\_t \*md; u64 pa\_offset = pa & ~PAGE\_MASK; u64 page = pa & PAGE\_MASK;  for\_each\_efi\_memory\_desc(md) {- if (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)+ if ((md->attribute & EFI\_MEMORY\_RUNTIME) &&+ (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)) { return pa\_offset + md->virt\_addr + page - md->phys\_addr;+ } } + pr\_warn("Failed to find VA for GUID: %pUL, PA: 0x%llx", guid, pa);+ return 0; } @@ -148,9 +152,15 @@ acpi\_parse\_prmt(union acpi\_subtable\_headers \*header, const unsigned long end) th = &tm->handlers[cur\_handler];  guid\_copy(&th->guid, (guid\_t \*)handler\_info->handler\_guid);- th->handler\_addr = (void \*)efi\_pa\_va\_lookup(handler\_info->handler\_address);- th->static\_data\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->static\_data\_buffer\_address);- th->acpi\_param\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->acpi\_param\_buffer\_address);+ th->handler\_addr =+ (void \*)efi\_pa\_va\_lookup(&th->guid, handler\_info->handler\_address);++ th->static\_data\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->static\_data\_buffer\_address);++ th->acpi\_param\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->acpi\_param\_buffer\_address);+ } while (++cur\_handler < tm->handler\_count && (handler\_info = get\_next\_handler(handler\_info)));  return 0;@@ -253,6 +263,13 @@ static acpi\_status acpi\_platformrt\_space\_handler(u32 function, if (!handler || !module) goto invalid\_guid; + if (!handler->handler\_addr ||+ !handler->static\_data\_buffer\_addr ||+ !handler->acpi\_param\_buffer\_addr) {+ buffer->prm\_status = PRM\_HANDLER\_ERROR;+ return AE\_OK;+ }+ ACPI\_COPY\_NAMESEG(context.signature, "PRMC"); context.revision = 0x0; context.reserved = 0x0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:14:31 +0000



=== Content from git.kernel.org_4080223f_20250114_191554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=795b080d9aa127215a5baf088a22fa09341a0126)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=795b080d9aa127215a5baf088a22fa09341a0126)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=795b080d9aa127215a5baf088a22fa09341a0126)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=795b080d9aa127215a5baf088a22fa09341a0126)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koba Ko <kobak@nvidia.com> | 2024-10-13 04:50:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:32 +0100 |
| commit | [795b080d9aa127215a5baf088a22fa09341a0126](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=795b080d9aa127215a5baf088a22fa09341a0126) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=795b080d9aa127215a5baf088a22fa09341a0126)) | |
| tree | [fe224f3df168f88eb1d6336e302badb0119c3d27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=795b080d9aa127215a5baf088a22fa09341a0126) | |
| parent | [bdaab141edb6fcd052ee0cd0942f129f35d258c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdaab141edb6fcd052ee0cd0942f129f35d258c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=795b080d9aa127215a5baf088a22fa09341a0126&id2=bdaab141edb6fcd052ee0cd0942f129f35d258c6)) | |
| download | [linux-795b080d9aa127215a5baf088a22fa09341a0126.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-795b080d9aa127215a5baf088a22fa09341a0126.tar.gz) | |

ACPI: PRM: Find EFI\_MEMORY\_RUNTIME block for PRM handler and contextcommit 088984c8d54c0053fc4ae606981291d741c5924b upstream.
PRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.
The issue arises because the PRMT is finding a block of type
EFI\_CONVENTIONAL\_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.
[Firmware Bug]: Unable to handle paging request in EFI runtime service
WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
\_\_efi\_queue\_work+0x11c/0x170
Call trace:
Let PRMT find a block with EFI\_MEMORY\_RUNTIME for PRM handler and PRM
context.
If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.
However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.
By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.
The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI\_MEMORY\_RUNTIME attribute.
Link: <https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf> # [1]
Fixes: cefc7ca46235 ("ACPI: PRM: implement OperationRegion handler for the PlatformRtMechanism subtype")
Cc: All applicable <stable@vger.kernel.org>
Signed-off-by: Koba Ko <kobak@nvidia.com>
Reviewed-by: Matthew R. Ochs <mochs@nvidia.com>
Reviewed-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
Link: [https://patch.msgid.link/20241012205010.4165798-1-kobak@nvidia.com](https://patch.msgid.link/20241012205010.4165798-1-kobak%40nvidia.com)
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=795b080d9aa127215a5baf088a22fa09341a0126)

| -rw-r--r-- | [drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/prmt.c?id=795b080d9aa127215a5baf088a22fa09341a0126) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/drivers/acpi/prmt.c b/drivers/acpi/prmt.cindex 7020584096bfaa..44899234462b66 100644--- a/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=bdaab141edb6fcd052ee0cd0942f129f35d258c6)+++ b/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=795b080d9aa127215a5baf088a22fa09341a0126)@@ -72,17 +72,21 @@ struct prm\_module\_info { struct prm\_handler\_info handlers[]; }; -static u64 efi\_pa\_va\_lookup(u64 pa)+static u64 efi\_pa\_va\_lookup(efi\_guid\_t \*guid, u64 pa) { efi\_memory\_desc\_t \*md; u64 pa\_offset = pa & ~PAGE\_MASK; u64 page = pa & PAGE\_MASK;  for\_each\_efi\_memory\_desc(md) {- if (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)+ if ((md->attribute & EFI\_MEMORY\_RUNTIME) &&+ (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)) { return pa\_offset + md->virt\_addr + page - md->phys\_addr;+ } } + pr\_warn("Failed to find VA for GUID: %pUL, PA: 0x%llx", guid, pa);+ return 0; } @@ -148,9 +152,15 @@ acpi\_parse\_prmt(union acpi\_subtable\_headers \*header, const unsigned long end) th = &tm->handlers[cur\_handler];  guid\_copy(&th->guid, (guid\_t \*)handler\_info->handler\_guid);- th->handler\_addr = (void \*)efi\_pa\_va\_lookup(handler\_info->handler\_address);- th->static\_data\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->static\_data\_buffer\_address);- th->acpi\_param\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->acpi\_param\_buffer\_address);+ th->handler\_addr =+ (void \*)efi\_pa\_va\_lookup(&th->guid, handler\_info->handler\_address);++ th->static\_data\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->static\_data\_buffer\_address);++ th->acpi\_param\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->acpi\_param\_buffer\_address);+ } while (++cur\_handler < tm->handler\_count && (handler\_info = get\_next\_handler(handler\_info)));  return 0;@@ -253,6 +263,13 @@ static acpi\_status acpi\_platformrt\_space\_handler(u32 function, if (!handler || !module) goto invalid\_guid; + if (!handler->handler\_addr ||+ !handler->static\_data\_buffer\_addr ||+ !handler->acpi\_param\_buffer\_addr) {+ buffer->prm\_status = PRM\_HANDLER\_ERROR;+ return AE\_OK;+ }+ ACPI\_COPY\_NAMESEG(context.signature, "PRMC"); context.revision = 0x0; context.reserved = 0x0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:14:31 +0000



=== Content from git.kernel.org_5f49001c_20250114_191555.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ce081ad842510f0e70fa6065a401660eac876d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ce081ad842510f0e70fa6065a401660eac876d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ce081ad842510f0e70fa6065a401660eac876d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce081ad842510f0e70fa6065a401660eac876d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koba Ko <kobak@nvidia.com> | 2024-10-13 04:50:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:06 +0100 |
| commit | [8ce081ad842510f0e70fa6065a401660eac876d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ce081ad842510f0e70fa6065a401660eac876d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ce081ad842510f0e70fa6065a401660eac876d4)) | |
| tree | [c8661ddcc0525d809fb415460387af0e21f57437](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ce081ad842510f0e70fa6065a401660eac876d4) | |
| parent | [e7f56a30c505889dbfe4285d8eb3c6f19ce5e8e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7f56a30c505889dbfe4285d8eb3c6f19ce5e8e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce081ad842510f0e70fa6065a401660eac876d4&id2=e7f56a30c505889dbfe4285d8eb3c6f19ce5e8e7)) | |
| download | [linux-8ce081ad842510f0e70fa6065a401660eac876d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ce081ad842510f0e70fa6065a401660eac876d4.tar.gz) | |

ACPI: PRM: Find EFI\_MEMORY\_RUNTIME block for PRM handler and contextcommit 088984c8d54c0053fc4ae606981291d741c5924b upstream.
PRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.
The issue arises because the PRMT is finding a block of type
EFI\_CONVENTIONAL\_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.
[Firmware Bug]: Unable to handle paging request in EFI runtime service
WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
\_\_efi\_queue\_work+0x11c/0x170
Call trace:
Let PRMT find a block with EFI\_MEMORY\_RUNTIME for PRM handler and PRM
context.
If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.
However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.
By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.
The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI\_MEMORY\_RUNTIME attribute.
Link: <https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf> # [1]
Fixes: cefc7ca46235 ("ACPI: PRM: implement OperationRegion handler for the PlatformRtMechanism subtype")
Cc: All applicable <stable@vger.kernel.org>
Signed-off-by: Koba Ko <kobak@nvidia.com>
Reviewed-by: Matthew R. Ochs <mochs@nvidia.com>
Reviewed-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
Link: [https://patch.msgid.link/20241012205010.4165798-1-kobak@nvidia.com](https://patch.msgid.link/20241012205010.4165798-1-kobak%40nvidia.com)
[ rjw: Subject and changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce081ad842510f0e70fa6065a401660eac876d4)

| -rw-r--r-- | [drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/prmt.c?id=8ce081ad842510f0e70fa6065a401660eac876d4) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/drivers/acpi/prmt.c b/drivers/acpi/prmt.cindex 3d4c4620f9f953..44d2d9084e4b7b 100644--- a/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=e7f56a30c505889dbfe4285d8eb3c6f19ce5e8e7)+++ b/[drivers/acpi/prmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/prmt.c?id=8ce081ad842510f0e70fa6065a401660eac876d4)@@ -72,17 +72,21 @@ struct prm\_module\_info { struct prm\_handler\_info handlers[]; }; -static u64 efi\_pa\_va\_lookup(u64 pa)+static u64 efi\_pa\_va\_lookup(efi\_guid\_t \*guid, u64 pa) { efi\_memory\_desc\_t \*md; u64 pa\_offset = pa & ~PAGE\_MASK; u64 page = pa & PAGE\_MASK;  for\_each\_efi\_memory\_desc(md) {- if (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)+ if ((md->attribute & EFI\_MEMORY\_RUNTIME) &&+ (md->phys\_addr < pa && pa < md->phys\_addr + PAGE\_SIZE \* md->num\_pages)) { return pa\_offset + md->virt\_addr + page - md->phys\_addr;+ } } + pr\_warn("Failed to find VA for GUID: %pUL, PA: 0x%llx", guid, pa);+ return 0; } @@ -148,9 +152,15 @@ acpi\_parse\_prmt(union acpi\_subtable\_headers \*header, const unsigned long end) th = &tm->handlers[cur\_handler];  guid\_copy(&th->guid, (guid\_t \*)handler\_info->handler\_guid);- th->handler\_addr = (void \*)efi\_pa\_va\_lookup(handler\_info->handler\_address);- th->static\_data\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->static\_data\_buffer\_address);- th->acpi\_param\_buffer\_addr = efi\_pa\_va\_lookup(handler\_info->acpi\_param\_buffer\_address);+ th->handler\_addr =+ (void \*)efi\_pa\_va\_lookup(&th->guid, handler\_info->handler\_address);++ th->static\_data\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->static\_data\_buffer\_address);++ th->acpi\_param\_buffer\_addr =+ efi\_pa\_va\_lookup(&th->guid, handler\_info->acpi\_param\_buffer\_address);+ } while (++cur\_handler < tm->handler\_count && (handler\_info = get\_next\_handler(handler\_info)));  return 0;@@ -253,6 +263,13 @@ static acpi\_status acpi\_platformrt\_space\_handler(u32 function, if (!handler || !module) goto invalid\_guid; + if (!handler->handler\_addr ||+ !handler->static\_data\_buffer\_addr ||+ !handler->acpi\_param\_buffer\_addr) {+ buffer->prm\_status = PRM\_HANDLER\_ERROR;+ return AE\_OK;+ }+ ACPI\_COPY\_NAMESEG(context.signature, "PRMC"); context.revision = 0x0; context.reserved = 0x0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:14:32 +0000


