=== Content from git.kernel.org_dea5764e_20250115_081418.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:45 +0200 |
| commit | [b5e900a3612b69423a0e1b0ab67841a1fb4af80f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)) | |
| tree | [7c864d495f46b9e94a9dc7194c457594ed661b18](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f) | |
| parent | [231ced8a175e1274267c3fe3b10f82f82d8cf1b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=231ced8a175e1274267c3fe3b10f82f82d8cf1b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f&id2=231ced8a175e1274267c3fe3b10f82f82d8cf1b1)) | |
| download | [linux-b5e900a3612b69423a0e1b0ab67841a1fb4af80f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b5e900a3612b69423a0e1b0ab67841a1fb4af80f.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex 88f0fe7dcf5451..a319311d1ced10 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=231ced8a175e1274267c3fe3b10f82f82d8cf1b1)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=b5e900a3612b69423a0e1b0ab67841a1fb4af80f)@@ -219,8 +219,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:56 +0000



=== Content from git.kernel.org_ebde1d88_20250115_081420.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e972b08b91ef48488bae9789f03cfedb148667fb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e972b08b91ef48488bae9789f03cfedb148667fb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e972b08b91ef48488bae9789f03cfedb148667fb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e972b08b91ef48488bae9789f03cfedb148667fb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-10-16 07:20:14 -0600 |
| commit | [e972b08b91ef48488bae9789f03cfedb148667fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e972b08b91ef48488bae9789f03cfedb148667fb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e972b08b91ef48488bae9789f03cfedb148667fb)) | |
| tree | [1a78ef89dde357d171fb46e7d4618b8966e42c6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e972b08b91ef48488bae9789f03cfedb148667fb) | |
| parent | [c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e972b08b91ef48488bae9789f03cfedb148667fb&id2=c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95)) | |
| download | [linux-e972b08b91ef48488bae9789f03cfedb148667fb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e972b08b91ef48488bae9789f03cfedb148667fb.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function raceWe're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e972b08b91ef48488bae9789f03cfedb148667fb)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=e972b08b91ef48488bae9789f03cfedb148667fb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex 2cfb297d9a6276..058f92c4f9d57b 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=e972b08b91ef48488bae9789f03cfedb148667fb)@@ -219,8 +219,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:58 +0000



=== Content from git.kernel.org_6fb776af_20250115_081417.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:43 +0200 |
| commit | [455a469758e57a6fe070e3e342db12e4a629e0eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=455a469758e57a6fe070e3e342db12e4a629e0eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)) | |
| tree | [eb750a22afc9ca5bc3991ab800373e499ac287cb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=455a469758e57a6fe070e3e342db12e4a629e0eb) | |
| parent | [0b263c2086ef2d70afd97c14ac2e377b05d9254a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b263c2086ef2d70afd97c14ac2e377b05d9254a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=455a469758e57a6fe070e3e342db12e4a629e0eb&id2=0b263c2086ef2d70afd97c14ac2e377b05d9254a)) | |
| download | [linux-455a469758e57a6fe070e3e342db12e4a629e0eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-455a469758e57a6fe070e3e342db12e4a629e0eb.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=455a469758e57a6fe070e3e342db12e4a629e0eb)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=455a469758e57a6fe070e3e342db12e4a629e0eb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex e83af7bc759194..26dd3e7bd00d3e 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=0b263c2086ef2d70afd97c14ac2e377b05d9254a)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=455a469758e57a6fe070e3e342db12e4a629e0eb)@@ -225,8 +225,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:54 +0000



=== Content from git.kernel.org_1530e5ea_20250115_081417.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c5b123ab289767afe940389dbb963c5c05e594e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c5b123ab289767afe940389dbb963c5c05e594e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c5b123ab289767afe940389dbb963c5c05e594e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c5b123ab289767afe940389dbb963c5c05e594e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:27 +0200 |
| commit | [4c5b123ab289767afe940389dbb963c5c05e594e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c5b123ab289767afe940389dbb963c5c05e594e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c5b123ab289767afe940389dbb963c5c05e594e)) | |
| tree | [20b5b97c11ac77576657e4e47453b14bc563daed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c5b123ab289767afe940389dbb963c5c05e594e) | |
| parent | [c04670dffb3fd43fe3547d585ae40ce3424a41d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c04670dffb3fd43fe3547d585ae40ce3424a41d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c5b123ab289767afe940389dbb963c5c05e594e&id2=c04670dffb3fd43fe3547d585ae40ce3424a41d8)) | |
| download | [linux-4c5b123ab289767afe940389dbb963c5c05e594e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c5b123ab289767afe940389dbb963c5c05e594e.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c5b123ab289767afe940389dbb963c5c05e594e)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=4c5b123ab289767afe940389dbb963c5c05e594e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex dd7310c94713c9..dc510f493ba572 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=c04670dffb3fd43fe3547d585ae40ce3424a41d8)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=4c5b123ab289767afe940389dbb963c5c05e594e)@@ -219,8 +219,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:55 +0000



=== Content from git.kernel.org_6ab18400_20250115_081419.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:48 +0100 |
| commit | [d04b72c9ef2b0689bfc1057d21c4aeed087c329f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)) | |
| tree | [73e698c12e36e01fdeedf19fabbc4f211c875b90](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f) | |
| parent | [9051f851a436bfa2e938416effecc30c2906caf8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9051f851a436bfa2e938416effecc30c2906caf8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f&id2=9051f851a436bfa2e938416effecc30c2906caf8)) | |
| download | [linux-d04b72c9ef2b0689bfc1057d21c4aeed087c329f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d04b72c9ef2b0689bfc1057d21c4aeed087c329f.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex e83af7bc759194..26dd3e7bd00d3e 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=9051f851a436bfa2e938416effecc30c2906caf8)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=d04b72c9ef2b0689bfc1057d21c4aeed087c329f)@@ -225,8 +225,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:57 +0000



=== Content from git.kernel.org_82511dd9_20250115_081415.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:24 +0200 |
| commit | [04f283fc16c8d5db641b6bffd2d8310aa7eccebc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)) | |
| tree | [3e6b1589991db9c1abed67e4e6c30f8391a7604b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc) | |
| parent | [d95fa989716fd8de86c4ddf9ca8b9691910dccb6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d95fa989716fd8de86c4ddf9ca8b9691910dccb6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc&id2=d95fa989716fd8de86c4ddf9ca8b9691910dccb6)) | |
| download | [linux-04f283fc16c8d5db641b6bffd2d8310aa7eccebc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04f283fc16c8d5db641b6bffd2d8310aa7eccebc.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex dd7310c94713c9..dc510f493ba572 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=d95fa989716fd8de86c4ddf9ca8b9691910dccb6)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=04f283fc16c8d5db641b6bffd2d8310aa7eccebc)@@ -219,8 +219,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:52 +0000



=== Content from git.kernel.org_5695b36a_20250115_081416.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-10-15 10:59:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:26 +0200 |
| commit | [3bc6d0f8b70a9101456cf02ab99acb75254e1852](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)) | |
| tree | [3fa68271b73f788605802b4a3b9e5fd3f1b8b344](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852) | |
| parent | [eca3edf87679284a5823c8930a059da0c2ed06ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eca3edf87679284a5823c8930a059da0c2ed06ac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852&id2=eca3edf87679284a5823c8930a059da0c2ed06ac)) | |
| download | [linux-3bc6d0f8b70a9101456cf02ab99acb75254e1852.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3bc6d0f8b70a9101456cf02ab99acb75254e1852.tar.gz) | |

blk-rq-qos: fix crash on rq\_qos\_wait vs. rq\_qos\_wake\_function racecommit e972b08b91ef48488bae9789f03cfedb148667fb upstream.
We're seeing crashes from rq\_qos\_wake\_function that look like this:
BUG: unable to handle page fault for address: ffffafe180a40084
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 100000067 P4D 100000067 PUD 10027c067 PMD 10115d067 PTE 0
Oops: Oops: 0002 [#1] PREEMPT SMP PTI
CPU: 17 UID: 0 PID: 0 Comm: swapper/17 Not tainted 6.12.0-rc3-00013-geca631b8fe80 #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:\_raw\_spin\_lock\_irqsave+0x1d/0x40
Code: 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 9c 41 5c fa 65 ff 05 62 97 30 4c 31 c0 ba 01 00 00 00 <f0> 0f b1 17 75 0a 4c 89 e0 41 5c c3 cc cc cc cc 89 c6 e8 2c 0b 00
RSP: 0018:ffffafe180580ca0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffffafe180a3f7a8 RCX: 0000000000000011
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffffafe180a40084
RBP: 0000000000000000 R08: 00000000001e7240 R09: 0000000000000011
R10: 0000000000000028 R11: 0000000000000888 R12: 0000000000000002
R13: ffffafe180a40084 R14: 0000000000000000 R15: 0000000000000003
FS: 0000000000000000(0000) GS:ffff9aaf1f280000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffafe180a40084 CR3: 000000010e428002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
try\_to\_wake\_up+0x5a/0x6a0
rq\_qos\_wake\_function+0x71/0x80
\_\_wake\_up\_common+0x75/0xa0
\_\_wake\_up+0x36/0x60
scale\_up.part.0+0x50/0x110
wb\_timer\_fn+0x227/0x450
...
So rq\_qos\_wake\_function() calls wake\_up\_process(data->task), which calls
try\_to\_wake\_up(), which faults in raw\_spin\_lock\_irqsave(&p->pi\_lock).
p comes from data->task, and data comes from the waitqueue entry, which
is stored on the waiter's stack in rq\_qos\_wait(). Analyzing the core
dump with drgn, I found that the waiter had already woken up and moved
on to a completely unrelated code path, clobbering what was previously
data->task. Meanwhile, the waker was passing the clobbered garbage in
data->task to wake\_up\_process(), leading to the crash.
What's happening is that in between rq\_qos\_wake\_function() deleting the
waitqueue entry and calling wake\_up\_process(), rq\_qos\_wait() is finding
that it already got a token and returning. The race looks like this:
rq\_qos\_wait() rq\_qos\_wake\_function()
==============================================================
prepare\_to\_wait\_exclusive()
data->got\_token = true;
list\_del\_init(&curr->entry);
if (data.got\_token)
break;
finish\_wait(&rqw->wait, &data.wq);
^- returns immediately because
list\_empty\_careful(&wq\_entry->entry)
is true
... return, go do something else ...
wake\_up\_process(data->task)
(NO LONGER VALID!)-^
Normally, finish\_wait() is supposed to synchronize against the waker.
But, as noted above, it is returning immediately because the waitqueue
entry has already been removed from the waitqueue.
The bug is that rq\_qos\_wake\_function() is accessing the waitqueue entry
AFTER deleting it. Note that autoremove\_wake\_function() wakes the waiter
and THEN deletes the waitqueue entry, which is the proper order.
Fix it by swapping the order. We also need to use
list\_del\_init\_careful() to match the list\_empty\_careful() in
finish\_wait().
Fixes: 38cfb5a45ee0 ("blk-wbt: improve waking of tasks")
Cc: stable@vger.kernel.org
Signed-off-by: Omar Sandoval <osandov@fb.com>
Acked-by: Tejun Heo <tj@kernel.org>
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Link: [https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov@fb.com](https://lore.kernel.org/r/d3bee2463a67b1ee597211823bf7ad3721c26e41.1729014591.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)

| -rw-r--r-- | [block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-rq-qos.c?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/block/blk-rq-qos.c b/block/blk-rq-qos.cindex e83af7bc759194..26dd3e7bd00d3e 100644--- a/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=eca3edf87679284a5823c8930a059da0c2ed06ac)+++ b/[block/blk-rq-qos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-rq-qos.c?id=3bc6d0f8b70a9101456cf02ab99acb75254e1852)@@ -225,8 +225,8 @@ static int rq\_qos\_wake\_function(struct wait\_queue\_entry \*curr,  data->got\_token = true; smp\_wmb();- list\_del\_init(&curr->entry); wake\_up\_process(data->task);+ list\_del\_init\_careful(&curr->entry); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:53 +0000


