=== Content from git.kernel.org_eb71b743_20250115_090529.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aleksandr Mishin <amishin@t-argos.ru> | 2024-10-15 09:01:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:36 +0100 |
| commit | [3c2a3619d565fe16bf59b0a047bab103a2ee4490](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)) | |
| tree | [97c128f4868cc55bfc764643527a2fa0e475d4c2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490) | |
| parent | [d0477572134cd6a1e28e5f6f48c39dca89860207](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0477572134cd6a1e28e5f6f48c39dca89860207) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490&id2=d0477572134cd6a1e28e5f6f48c39dca89860207)) | |
| download | [linux-3c2a3619d565fe16bf59b0a047bab103a2ee4490.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c2a3619d565fe16bf59b0a047bab103a2ee4490.tar.gz) | |

fsl/fman: Fix refcount handling of fman-related devices[ Upstream commit 1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1 ]
In mac\_probe() there are multiple calls to of\_find\_device\_by\_node(),
fman\_bind() and fman\_port\_bind() which takes references to of\_dev->dev.
Not all references taken by these calls are released later on error path
in mac\_probe() and in mac\_remove() which lead to reference leaks.
Add references release.
Fixes: 3933961682a3 ("fsl/fman: Add FMan MAC driver")
Signed-off-by: Aleksandr Mishin <amishin@t-argos.ru>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)

| -rw-r--r-- | [drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/fman/mac.c?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490) | 62 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 15 deletions

| diff --git a/drivers/net/ethernet/freescale/fman/mac.c b/drivers/net/ethernet/freescale/fman/mac.cindex 9b863db0bf0870..11da139082e1bf 100644--- a/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=d0477572134cd6a1e28e5f6f48c39dca89860207)+++ b/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=3c2a3619d565fe16bf59b0a047bab103a2ee4490)@@ -204,7 +204,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } /\* cell-index 0 => FMan id 1 \*/ fman\_id = (u8)(val + 1);@@ -213,40 +213,51 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (!priv->fman) { dev\_err(dev, "fman\_bind(%pOF) failed\n", dev\_node); err = -ENODEV;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } + /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_bind(). Release one of them here. The second one+ \* will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_dev); of\_node\_put(dev\_node);+ dev\_node = NULL;  /\* Get the address of the memory mapped registers \*/ mac\_dev->res = platform\_get\_mem\_or\_io(\_of\_dev, 0); if (!mac\_dev->res) { dev\_err(dev, "could not get registers\n");- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; }  err = devm\_request\_resource(dev, fman\_get\_mem\_region(priv->fman), mac\_dev->res); if (err) { dev\_err\_probe(dev, err, "could not request resource\n");- return err;+ goto \_return\_dev\_put; }  mac\_dev->vaddr = devm\_ioremap(dev, mac\_dev->res->start, resource\_size(mac\_dev->res)); if (!mac\_dev->vaddr) { dev\_err(dev, "devm\_ioremap() failed\n");- return -EIO;+ err = -EIO;+ goto \_return\_dev\_put; } - if (!of\_device\_is\_available(mac\_node))- return -ENODEV;+ if (!of\_device\_is\_available(mac\_node)) {+ err = -ENODEV;+ goto \_return\_dev\_put;+ }  /\* Get the cell-index \*/ err = of\_property\_read\_u32(mac\_node, "cell-index", &val); if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } priv->cell\_index = (u8)val; @@ -260,22 +271,26 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (unlikely(nph < 0)) { dev\_err(dev, "of\_count\_phandle\_with\_args(%pOF, fsl,fman-ports) failed\n", mac\_node);- return nph;+ err = nph;+ goto \_return\_dev\_put; }  if (nph != ARRAY\_SIZE(mac\_dev->port)) { dev\_err(dev, "Not supported number of fman-ports handles of mac node %pOF from device tree\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } - for (i = 0; i < ARRAY\_SIZE(mac\_dev->port); i++) {+ /\* PORT\_NUM determines the size of the port array \*/+ for (i = 0; i < PORT\_NUM; i++) { /\* Find the port node \*/ dev\_node = of\_parse\_phandle(mac\_node, "fsl,fman-ports", i); if (!dev\_node) { dev\_err(dev, "of\_parse\_phandle(%pOF, fsl,fman-ports) failed\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_arr\_put; }  of\_dev = of\_find\_device\_by\_node(dev\_node);@@ -283,7 +298,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "of\_find\_device\_by\_node(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; } mac\_dev->fman\_port\_devs[i] = &of\_dev->dev; @@ -292,9 +307,15 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "dev\_get\_drvdata(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; }+ /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_port\_bind(). Release one of them here. The second+ \* one will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_port\_devs[i]); of\_node\_put(dev\_node);+ dev\_node = NULL; }  /\* Get the PHY connection type \*/@@ -314,7 +335,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  err = init(mac\_dev, mac\_node, &params); if (err < 0)- return err;+ goto \_return\_dev\_arr\_put;  if (!is\_zero\_ether\_addr(mac\_dev->addr)) dev\_info(dev, "FMan MAC address: %pM\n", mac\_dev->addr);@@ -329,6 +350,12 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  return err; +\_return\_dev\_arr\_put:+ /\* mac\_dev is kzalloc'ed \*/+ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+\_return\_dev\_put:+ put\_device(mac\_dev->fman\_dev); \_return\_of\_node\_put: of\_node\_put(dev\_node); return err;@@ -337,6 +364,11 @@ \_return\_of\_node\_put: static void mac\_remove(struct platform\_device \*pdev) { struct mac\_device \*mac\_dev = platform\_get\_drvdata(pdev);+ int i;++ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+ put\_device(mac\_dev->fman\_dev);  platform\_device\_unregister(mac\_dev->priv->eth\_dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:06 +0000



=== Content from git.kernel.org_3c3284f1_20250115_090529.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aleksandr Mishin <amishin@t-argos.ru> | 2024-10-15 09:01:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:29 +0100 |
| commit | [5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)) | |
| tree | [a4ad0899bc017606670906d594af3a0022f5ffd4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b) | |
| parent | [275bebf5be504f41bc7f952a2caf6a172fc5112a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=275bebf5be504f41bc7f952a2caf6a172fc5112a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b&id2=275bebf5be504f41bc7f952a2caf6a172fc5112a)) | |
| download | [linux-5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b.tar.gz) | |

fsl/fman: Fix refcount handling of fman-related devices[ Upstream commit 1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1 ]
In mac\_probe() there are multiple calls to of\_find\_device\_by\_node(),
fman\_bind() and fman\_port\_bind() which takes references to of\_dev->dev.
Not all references taken by these calls are released later on error path
in mac\_probe() and in mac\_remove() which lead to reference leaks.
Add references release.
Fixes: 3933961682a3 ("fsl/fman: Add FMan MAC driver")
Signed-off-by: Aleksandr Mishin <amishin@t-argos.ru>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)

| -rw-r--r-- | [drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/fman/mac.c?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b) | 62 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 15 deletions

| diff --git a/drivers/net/ethernet/freescale/fman/mac.c b/drivers/net/ethernet/freescale/fman/mac.cindex 9b863db0bf0870..11da139082e1bf 100644--- a/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=275bebf5be504f41bc7f952a2caf6a172fc5112a)+++ b/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=5ed4334fc9512f934fe2ae9c4cf7f8142e451b8b)@@ -204,7 +204,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } /\* cell-index 0 => FMan id 1 \*/ fman\_id = (u8)(val + 1);@@ -213,40 +213,51 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (!priv->fman) { dev\_err(dev, "fman\_bind(%pOF) failed\n", dev\_node); err = -ENODEV;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } + /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_bind(). Release one of them here. The second one+ \* will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_dev); of\_node\_put(dev\_node);+ dev\_node = NULL;  /\* Get the address of the memory mapped registers \*/ mac\_dev->res = platform\_get\_mem\_or\_io(\_of\_dev, 0); if (!mac\_dev->res) { dev\_err(dev, "could not get registers\n");- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; }  err = devm\_request\_resource(dev, fman\_get\_mem\_region(priv->fman), mac\_dev->res); if (err) { dev\_err\_probe(dev, err, "could not request resource\n");- return err;+ goto \_return\_dev\_put; }  mac\_dev->vaddr = devm\_ioremap(dev, mac\_dev->res->start, resource\_size(mac\_dev->res)); if (!mac\_dev->vaddr) { dev\_err(dev, "devm\_ioremap() failed\n");- return -EIO;+ err = -EIO;+ goto \_return\_dev\_put; } - if (!of\_device\_is\_available(mac\_node))- return -ENODEV;+ if (!of\_device\_is\_available(mac\_node)) {+ err = -ENODEV;+ goto \_return\_dev\_put;+ }  /\* Get the cell-index \*/ err = of\_property\_read\_u32(mac\_node, "cell-index", &val); if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } priv->cell\_index = (u8)val; @@ -260,22 +271,26 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (unlikely(nph < 0)) { dev\_err(dev, "of\_count\_phandle\_with\_args(%pOF, fsl,fman-ports) failed\n", mac\_node);- return nph;+ err = nph;+ goto \_return\_dev\_put; }  if (nph != ARRAY\_SIZE(mac\_dev->port)) { dev\_err(dev, "Not supported number of fman-ports handles of mac node %pOF from device tree\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } - for (i = 0; i < ARRAY\_SIZE(mac\_dev->port); i++) {+ /\* PORT\_NUM determines the size of the port array \*/+ for (i = 0; i < PORT\_NUM; i++) { /\* Find the port node \*/ dev\_node = of\_parse\_phandle(mac\_node, "fsl,fman-ports", i); if (!dev\_node) { dev\_err(dev, "of\_parse\_phandle(%pOF, fsl,fman-ports) failed\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_arr\_put; }  of\_dev = of\_find\_device\_by\_node(dev\_node);@@ -283,7 +298,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "of\_find\_device\_by\_node(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; } mac\_dev->fman\_port\_devs[i] = &of\_dev->dev; @@ -292,9 +307,15 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "dev\_get\_drvdata(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; }+ /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_port\_bind(). Release one of them here. The second+ \* one will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_port\_devs[i]); of\_node\_put(dev\_node);+ dev\_node = NULL; }  /\* Get the PHY connection type \*/@@ -314,7 +335,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  err = init(mac\_dev, mac\_node, &params); if (err < 0)- return err;+ goto \_return\_dev\_arr\_put;  if (!is\_zero\_ether\_addr(mac\_dev->addr)) dev\_info(dev, "FMan MAC address: %pM\n", mac\_dev->addr);@@ -329,6 +350,12 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  return err; +\_return\_dev\_arr\_put:+ /\* mac\_dev is kzalloc'ed \*/+ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+\_return\_dev\_put:+ put\_device(mac\_dev->fman\_dev); \_return\_of\_node\_put: of\_node\_put(dev\_node); return err;@@ -337,6 +364,11 @@ \_return\_of\_node\_put: static void mac\_remove(struct platform\_device \*pdev) { struct mac\_device \*mac\_dev = platform\_get\_drvdata(pdev);+ int i;++ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+ put\_device(mac\_dev->fman\_dev);  platform\_device\_unregister(mac\_dev->priv->eth\_dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:06 +0000



=== Content from git.kernel.org_b01a65f6_20250115_090528.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aleksandr Mishin <amishin@t-argos.ru> | 2024-10-15 09:01:22 +0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-21 10:50:16 +0200 |
| commit | [1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)) | |
| tree | [a35c290d15e8c4f8ad8ee738d4376acf29f68385](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1) | |
| parent | [efeddd552ec6767e4c8884caa516ac80b65f8823](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efeddd552ec6767e4c8884caa516ac80b65f8823) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1&id2=efeddd552ec6767e4c8884caa516ac80b65f8823)) | |
| download | [linux-1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1.tar.gz) | |

fsl/fman: Fix refcount handling of fman-related devicesIn mac\_probe() there are multiple calls to of\_find\_device\_by\_node(),
fman\_bind() and fman\_port\_bind() which takes references to of\_dev->dev.
Not all references taken by these calls are released later on error path
in mac\_probe() and in mac\_remove() which lead to reference leaks.
Add references release.
Fixes: 3933961682a3 ("fsl/fman: Add FMan MAC driver")
Signed-off-by: Aleksandr Mishin <amishin@t-argos.ru>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)

| -rw-r--r-- | [drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/fman/mac.c?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1) | 62 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 15 deletions

| diff --git a/drivers/net/ethernet/freescale/fman/mac.c b/drivers/net/ethernet/freescale/fman/mac.cindex 9b863db0bf0870..11da139082e1bf 100644--- a/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=efeddd552ec6767e4c8884caa516ac80b65f8823)+++ b/[drivers/net/ethernet/freescale/fman/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/fman/mac.c?id=1dec67e0d9fbb087c2ab17bf1bd17208231c3bb1)@@ -204,7 +204,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } /\* cell-index 0 => FMan id 1 \*/ fman\_id = (u8)(val + 1);@@ -213,40 +213,51 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (!priv->fman) { dev\_err(dev, "fman\_bind(%pOF) failed\n", dev\_node); err = -ENODEV;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_put; } + /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_bind(). Release one of them here. The second one+ \* will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_dev); of\_node\_put(dev\_node);+ dev\_node = NULL;  /\* Get the address of the memory mapped registers \*/ mac\_dev->res = platform\_get\_mem\_or\_io(\_of\_dev, 0); if (!mac\_dev->res) { dev\_err(dev, "could not get registers\n");- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; }  err = devm\_request\_resource(dev, fman\_get\_mem\_region(priv->fman), mac\_dev->res); if (err) { dev\_err\_probe(dev, err, "could not request resource\n");- return err;+ goto \_return\_dev\_put; }  mac\_dev->vaddr = devm\_ioremap(dev, mac\_dev->res->start, resource\_size(mac\_dev->res)); if (!mac\_dev->vaddr) { dev\_err(dev, "devm\_ioremap() failed\n");- return -EIO;+ err = -EIO;+ goto \_return\_dev\_put; } - if (!of\_device\_is\_available(mac\_node))- return -ENODEV;+ if (!of\_device\_is\_available(mac\_node)) {+ err = -ENODEV;+ goto \_return\_dev\_put;+ }  /\* Get the cell-index \*/ err = of\_property\_read\_u32(mac\_node, "cell-index", &val); if (err) { dev\_err(dev, "failed to read cell-index for %pOF\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } priv->cell\_index = (u8)val; @@ -260,22 +271,26 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) if (unlikely(nph < 0)) { dev\_err(dev, "of\_count\_phandle\_with\_args(%pOF, fsl,fman-ports) failed\n", mac\_node);- return nph;+ err = nph;+ goto \_return\_dev\_put; }  if (nph != ARRAY\_SIZE(mac\_dev->port)) { dev\_err(dev, "Not supported number of fman-ports handles of mac node %pOF from device tree\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_put; } - for (i = 0; i < ARRAY\_SIZE(mac\_dev->port); i++) {+ /\* PORT\_NUM determines the size of the port array \*/+ for (i = 0; i < PORT\_NUM; i++) { /\* Find the port node \*/ dev\_node = of\_parse\_phandle(mac\_node, "fsl,fman-ports", i); if (!dev\_node) { dev\_err(dev, "of\_parse\_phandle(%pOF, fsl,fman-ports) failed\n", mac\_node);- return -EINVAL;+ err = -EINVAL;+ goto \_return\_dev\_arr\_put; }  of\_dev = of\_find\_device\_by\_node(dev\_node);@@ -283,7 +298,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "of\_find\_device\_by\_node(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; } mac\_dev->fman\_port\_devs[i] = &of\_dev->dev; @@ -292,9 +307,15 @@ static int mac\_probe(struct platform\_device \*\_of\_dev) dev\_err(dev, "dev\_get\_drvdata(%pOF) failed\n", dev\_node); err = -EINVAL;- goto \_return\_of\_node\_put;+ goto \_return\_dev\_arr\_put; }+ /\* Two references have been taken in of\_find\_device\_by\_node()+ \* and fman\_port\_bind(). Release one of them here. The second+ \* one will be released in mac\_remove().+ \*/+ put\_device(mac\_dev->fman\_port\_devs[i]); of\_node\_put(dev\_node);+ dev\_node = NULL; }  /\* Get the PHY connection type \*/@@ -314,7 +335,7 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  err = init(mac\_dev, mac\_node, &params); if (err < 0)- return err;+ goto \_return\_dev\_arr\_put;  if (!is\_zero\_ether\_addr(mac\_dev->addr)) dev\_info(dev, "FMan MAC address: %pM\n", mac\_dev->addr);@@ -329,6 +350,12 @@ static int mac\_probe(struct platform\_device \*\_of\_dev)  return err; +\_return\_dev\_arr\_put:+ /\* mac\_dev is kzalloc'ed \*/+ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+\_return\_dev\_put:+ put\_device(mac\_dev->fman\_dev); \_return\_of\_node\_put: of\_node\_put(dev\_node); return err;@@ -337,6 +364,11 @@ \_return\_of\_node\_put: static void mac\_remove(struct platform\_device \*pdev) { struct mac\_device \*mac\_dev = platform\_get\_drvdata(pdev);+ int i;++ for (i = 0; i < PORT\_NUM; i++)+ put\_device(mac\_dev->fman\_port\_devs[i]);+ put\_device(mac\_dev->fman\_dev);  platform\_device\_unregister(mac\_dev->priv->eth\_dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:05 +0000


