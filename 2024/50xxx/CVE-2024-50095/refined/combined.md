=== Content from git.kernel.org_8bb1508f_20250115_082759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:30 +0200 |
| commit | [713adaf0ecfc49405f6e5d9e409d984f628de818](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=713adaf0ecfc49405f6e5d9e409d984f628de818) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)) | |
| tree | [7bdc32f45d00754ca3d4eb4dd555d9c06bef223b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=713adaf0ecfc49405f6e5d9e409d984f628de818) | |
| parent | [24318116c485e96f9512ff69020629462dfed787](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24318116c485e96f9512ff69020629462dfed787) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713adaf0ecfc49405f6e5d9e409d984f628de818&id2=24318116c485e96f9512ff69020629462dfed787)) | |
| download | [linux-713adaf0ecfc49405f6e5d9e409d984f628de818.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-713adaf0ecfc49405f6e5d9e409d984f628de818.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agent[ Upstream commit 2a777679b8ccd09a9a65ea0716ef10365179caac ]
Current timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713adaf0ecfc49405f6e5d9e409d984f628de818)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=713adaf0ecfc49405f6e5d9e409d984f628de818) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 9355e521d9f4d7..521c3d050be2d8 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=24318116c485e96f9512ff69020629462dfed787)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=713adaf0ecfc49405f6e5d9e409d984f628de818)@@ -2631,14 +2631,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2656,13 +2658,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2670,11 +2675,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:37 +0000



=== Content from git.kernel.org_0436c489_20250115_082758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:35 +0200 |
| commit | [3e799fa463508abe7a738ce5d0f62a8dfd05262a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)) | |
| tree | [9a42c6dbbb08332c118246d494dd718b806cd966](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a) | |
| parent | [c8aaabeb5963efb36a04ceebd13ab2150ef0520c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8aaabeb5963efb36a04ceebd13ab2150ef0520c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a&id2=c8aaabeb5963efb36a04ceebd13ab2150ef0520c)) | |
| download | [linux-3e799fa463508abe7a738ce5d0f62a8dfd05262a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e799fa463508abe7a738ce5d0f62a8dfd05262a.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agent[ Upstream commit 2a777679b8ccd09a9a65ea0716ef10365179caac ]
Current timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 7439e47ff951d4..70708fea12962c 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=c8aaabeb5963efb36a04ceebd13ab2150ef0520c)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=3e799fa463508abe7a738ce5d0f62a8dfd05262a)@@ -2616,14 +2616,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2641,13 +2643,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2655,11 +2660,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:36 +0000



=== Content from git.kernel.org_51bfedb2_20250115_082800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a195a42dd25ca4f12489687065d00be64939409f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a195a42dd25ca4f12489687065d00be64939409f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a195a42dd25ca4f12489687065d00be64939409f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a195a42dd25ca4f12489687065d00be64939409f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:16 +0200 |
| commit | [a195a42dd25ca4f12489687065d00be64939409f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a195a42dd25ca4f12489687065d00be64939409f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a195a42dd25ca4f12489687065d00be64939409f)) | |
| tree | [f6c83e9e6c3590e1abf1e33fec15bc4adff99224](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a195a42dd25ca4f12489687065d00be64939409f) | |
| parent | [6ba8ecf9aa4e0ebf400b6e3e00e580569a623e58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ba8ecf9aa4e0ebf400b6e3e00e580569a623e58) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a195a42dd25ca4f12489687065d00be64939409f&id2=6ba8ecf9aa4e0ebf400b6e3e00e580569a623e58)) | |
| download | [linux-a195a42dd25ca4f12489687065d00be64939409f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a195a42dd25ca4f12489687065d00be64939409f.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agent[ Upstream commit 2a777679b8ccd09a9a65ea0716ef10365179caac ]
Current timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a195a42dd25ca4f12489687065d00be64939409f)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=a195a42dd25ca4f12489687065d00be64939409f) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 674344eb8e2f48..58befbaaf0ad54 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=6ba8ecf9aa4e0ebf400b6e3e00e580569a623e58)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=a195a42dd25ca4f12489687065d00be64939409f)@@ -2616,14 +2616,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2641,13 +2643,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2655,11 +2660,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:38 +0000



=== Content from git.kernel.org_40a6bcae_20250115_082757.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-08-01 13:07:29 +0300 |
| commit | [2a777679b8ccd09a9a65ea0716ef10365179caac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a777679b8ccd09a9a65ea0716ef10365179caac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)) | |
| tree | [167abeebba6ed1c3870f794ef7b828386aeeac2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a777679b8ccd09a9a65ea0716ef10365179caac) | |
| parent | [60dc7fcafea817f3dcff7ece18095ca6260b73bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60dc7fcafea817f3dcff7ece18095ca6260b73bc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a777679b8ccd09a9a65ea0716ef10365179caac&id2=60dc7fcafea817f3dcff7ece18095ca6260b73bc)) | |
| download | [linux-2a777679b8ccd09a9a65ea0716ef10365179caac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a777679b8ccd09a9a65ea0716ef10365179caac.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agentCurrent timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a777679b8ccd09a9a65ea0716ef10365179caac)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=2a777679b8ccd09a9a65ea0716ef10365179caac) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 7439e47ff951d4..70708fea12962c 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=60dc7fcafea817f3dcff7ece18095ca6260b73bc)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=2a777679b8ccd09a9a65ea0716ef10365179caac)@@ -2616,14 +2616,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2641,13 +2643,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2655,11 +2660,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:35 +0000



=== Content from git.kernel.org_accd0950_20250115_082801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:14 +0200 |
| commit | [e80eadb3604a92d2d086e956b8b2692b699d4d0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)) | |
| tree | [49c2b8a11f6c085e95ef4283580f8cdff5bcfcab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a) | |
| parent | [ec5b06acbe9371c7c89fe9dbee46e6030d408c89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec5b06acbe9371c7c89fe9dbee46e6030d408c89) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a&id2=ec5b06acbe9371c7c89fe9dbee46e6030d408c89)) | |
| download | [linux-e80eadb3604a92d2d086e956b8b2692b699d4d0a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e80eadb3604a92d2d086e956b8b2692b699d4d0a.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agent[ Upstream commit 2a777679b8ccd09a9a65ea0716ef10365179caac ]
Current timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 674344eb8e2f48..58befbaaf0ad54 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=ec5b06acbe9371c7c89fe9dbee46e6030d408c89)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=e80eadb3604a92d2d086e956b8b2692b699d4d0a)@@ -2616,14 +2616,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2641,13 +2643,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2655,11 +2660,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:39 +0000



=== Content from git.kernel.org_7e60eb48_20250115_082759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Saravanan Vajravel <saravanan.vajravel@broadcom.com> | 2024-07-22 16:33:25 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:50 +0200 |
| commit | [7022a517bf1ca37ef5a474365bcc5eafd345a13a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)) | |
| tree | [fe9db135ed6d9d83c0d7fc5e41a42a9262da42c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a) | |
| parent | [ee603aae244e15a616da38940e47bf48c3a25913](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee603aae244e15a616da38940e47bf48c3a25913) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a&id2=ee603aae244e15a616da38940e47bf48c3a25913)) | |
| download | [linux-7022a517bf1ca37ef5a474365bcc5eafd345a13a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7022a517bf1ca37ef5a474365bcc5eafd345a13a.tar.gz) | |

RDMA/mad: Improve handling of timed out WRs of mad agent[ Upstream commit 2a777679b8ccd09a9a65ea0716ef10365179caac ]
Current timeout handler of mad agent acquires/releases mad\_agent\_priv
lock for every timed out WRs. This causes heavy locking contention
when higher no. of WRs are to be handled inside timeout handler.
This leads to softlockup with below trace in some use cases where
rdma-cm path is used to establish connection between peer nodes
Trace:
-----
BUG: soft lockup - CPU#4 stuck for 26s! [kworker/u128:3:19767]
CPU: 4 PID: 19767 Comm: kworker/u128:3 Kdump: loaded Tainted: G OE
------- --- 5.14.0-427.13.1.el9\_4.x86\_64 #1
Hardware name: Dell Inc. PowerEdge R740/01YM03, BIOS 2.4.8 11/26/2019
Workqueue: ib\_mad1 timeout\_sends [ib\_core]
RIP: 0010:\_\_do\_softirq+0x78/0x2ac
RSP: 0018:ffffb253449e4f98 EFLAGS: 00000246
RAX: 00000000ffffffff RBX: 0000000000000000 RCX: 000000000000001f
RDX: 000000000000001d RSI: 000000003d1879ab RDI: fff363b66fd3a86b
RBP: ffffb253604cbcd8 R08: 0000009065635f3b R09: 0000000000000000
R10: 0000000000000040 R11: ffffb253449e4ff8 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff8caa1fc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd9ec9db900 CR3: 0000000891934006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<IRQ>
? show\_trace\_log\_lvl+0x1c4/0x2df
? show\_trace\_log\_lvl+0x1c4/0x2df
? \_\_irq\_exit\_rcu+0xa1/0xc0
? watchdog\_timer\_fn+0x1b2/0x210
? \_\_pfx\_watchdog\_timer\_fn+0x10/0x10
? \_\_hrtimer\_run\_queues+0x127/0x2c0
? hrtimer\_interrupt+0xfc/0x210
? \_\_sysvec\_apic\_timer\_interrupt+0x5c/0x110
? sysvec\_apic\_timer\_interrupt+0x37/0x90
? asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
? \_\_do\_softirq+0x78/0x2ac
? \_\_do\_softirq+0x60/0x2ac
\_\_irq\_exit\_rcu+0xa1/0xc0
sysvec\_call\_function\_single+0x72/0x90
</IRQ>
<TASK>
asm\_sysvec\_call\_function\_single+0x16/0x20
RIP: 0010:\_raw\_spin\_unlock\_irq+0x14/0x30
RSP: 0018:ffffb253604cbd88 EFLAGS: 00000247
RAX: 000000000001960d RBX: 0000000000000002 RCX: ffff8cad2a064800
RDX: 000000008020001b RSI: 0000000000000001 RDI: ffff8cad5d39f66c
RBP: ffff8cad5d39f600 R08: 0000000000000001 R09: 0000000000000000
R10: ffff8caa443e0c00 R11: ffffb253604cbcd8 R12: ffff8cacb8682538
R13: 0000000000000005 R14: ffffb253604cbd90 R15: ffff8cad5d39f66c
cm\_process\_send\_error+0x122/0x1d0 [ib\_cm]
timeout\_sends+0x1dd/0x270 [ib\_core]
process\_one\_work+0x1e2/0x3b0
? \_\_pfx\_worker\_thread+0x10/0x10
worker\_thread+0x50/0x3a0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xdd/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x29/0x50
</TASK>
Simplified timeout handler by creating local list of timed out WRs
and invoke send handler post creating the list. The new method acquires/
releases lock once to fetch the list and hence helps to reduce locking
contetiong when processing higher no. of WRs
Signed-off-by: Saravanan Vajravel <saravanan.vajravel@broadcom.com>
Link: [https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel@broadcom.com](https://lore.kernel.org/r/20240722110325.195085-1-saravanan.vajravel%40broadcom.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)

| -rw-r--r-- | [drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/mad.c?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.cindex 674344eb8e2f48..58befbaaf0ad54 100644--- a/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=ee603aae244e15a616da38940e47bf48c3a25913)+++ b/[drivers/infiniband/core/mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/mad.c?id=7022a517bf1ca37ef5a474365bcc5eafd345a13a)@@ -2616,14 +2616,16 @@ static int retry\_send(struct ib\_mad\_send\_wr\_private \*mad\_send\_wr)  static void timeout\_sends(struct work\_struct \*work) {+ struct ib\_mad\_send\_wr\_private \*mad\_send\_wr, \*n; struct ib\_mad\_agent\_private \*mad\_agent\_priv;- struct ib\_mad\_send\_wr\_private \*mad\_send\_wr; struct ib\_mad\_send\_wc mad\_send\_wc;+ struct list\_head local\_list; unsigned long flags, delay;  mad\_agent\_priv = container\_of(work, struct ib\_mad\_agent\_private, timed\_work.work); mad\_send\_wc.vendor\_err = 0;+ INIT\_LIST\_HEAD(&local\_list);  spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); while (!list\_empty(&mad\_agent\_priv->wait\_list)) {@@ -2641,13 +2643,16 @@ static void timeout\_sends(struct work\_struct \*work) break; } - list\_del(&mad\_send\_wr->agent\_list);+ list\_del\_init(&mad\_send\_wr->agent\_list); if (mad\_send\_wr->status == IB\_WC\_SUCCESS && !retry\_send(mad\_send\_wr)) continue; - spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags);+ list\_add\_tail(&mad\_send\_wr->agent\_list, &local\_list);+ }+ spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); + list\_for\_each\_entry\_safe(mad\_send\_wr, n, &local\_list, agent\_list) { if (mad\_send\_wr->status == IB\_WC\_SUCCESS) mad\_send\_wc.status = IB\_WC\_RESP\_TIMEOUT\_ERR; else@@ -2655,11 +2660,8 @@ static void timeout\_sends(struct work\_struct \*work) mad\_send\_wc.send\_buf = &mad\_send\_wr->send\_buf; mad\_agent\_priv->agent.send\_handler(&mad\_agent\_priv->agent, &mad\_send\_wc);- deref\_mad\_agent(mad\_agent\_priv);- spin\_lock\_irqsave(&mad\_agent\_priv->lock, flags); }- spin\_unlock\_irqrestore(&mad\_agent\_priv->lock, flags); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:26:37 +0000


