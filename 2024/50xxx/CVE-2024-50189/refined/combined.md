=== Content from git.kernel.org_ad8abbdb_20250115_102358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Basavaraj Natikar <Basavaraj.Natikar@amd.com> | 2024-10-09 20:17:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:33 +0200 |
| commit | [1c3b4c90479aa0375ec98fe1a802993ff96a5f47](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)) | |
| tree | [f041851510ae0a3270dcadc35d8dae63500fed78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47) | |
| parent | [11381eea8897790868aae7e85bbeb2466a249d4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11381eea8897790868aae7e85bbeb2466a249d4f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47&id2=11381eea8897790868aae7e85bbeb2466a249d4f)) | |
| download | [linux-1c3b4c90479aa0375ec98fe1a802993ff96a5f47.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c3b4c90479aa0375ec98fe1a802993ff96a5f47.tar.gz) | |

HID: amd\_sfh: Switch to device-managed dmam\_alloc\_coherent()commit c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3 upstream.
Using the device-managed version allows to simplify clean-up in probe()
error path.
Additionally, this device-managed ensures proper cleanup, which helps to
resolve memory errors, page faults, btrfs going read-only, and btrfs
disk corruption.
Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Tested-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Tested-by: Richard <hobbes1069@gmail.com>
Tested-by: Skyler <skpu@pm.me>
Reported-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Closes: https://lore.kernel.org/all/3b129b1f-8636-456a-80b4-0f6cce0eef63@hixontech.com/
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219331>
Signed-off-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 11 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_client.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_client.cindex 4b59687ff5d821..3438d392920fad 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=11381eea8897790868aae7e85bbeb2466a249d4f)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=1c3b4c90479aa0375ec98fe1a802993ff96a5f47)@@ -236,9 +236,9 @@ int amd\_sfh\_hid\_client\_init(struct amd\_mp2\_dev \*privdata) cl\_data->in\_data = in\_data;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- in\_data->sensor\_virt\_addr[i] = dma\_alloc\_coherent(dev, sizeof(int) \* 8,- &cl\_data->sensor\_dma\_addr[i],- GFP\_KERNEL);+ in\_data->sensor\_virt\_addr[i] = dmam\_alloc\_coherent(dev, sizeof(int) \* 8,+ &cl\_data->sensor\_dma\_addr[i],+ GFP\_KERNEL); if (!in\_data->sensor\_virt\_addr[i]) { rc = -ENOMEM; goto cleanup;@@ -331,7 +331,6 @@ cleanup: int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) { struct amdtp\_cl\_data \*cl\_data = privdata->cl\_data;- struct amd\_input\_data \*in\_data = cl\_data->in\_data; int i, status;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {@@ -351,12 +350,5 @@ int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) cancel\_delayed\_work\_sync(&cl\_data->work\_buffer); amdtp\_hid\_remove(cl\_data); - for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- if (in\_data->sensor\_virt\_addr[i]) {- dma\_free\_coherent(&privdata->pdev->dev, 8 \* sizeof(int),- in\_data->sensor\_virt\_addr[i],- cl\_data->sensor\_dma\_addr[i]);- }- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:22:35 +0000



=== Content from git.kernel.org_2d52e6b6_20250115_102402.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Basavaraj Natikar <Basavaraj.Natikar@amd.com> | 2024-10-09 20:17:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:54 +0200 |
| commit | [9dfee956f53eea96d93ef1e13ab4ce020f4c58b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)) | |
| tree | [d5feda6c0d2d0748b7e7611a349b69b40517d666](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3) | |
| parent | [57bdca0693959bb6341b4b50aba8576cdde9102e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57bdca0693959bb6341b4b50aba8576cdde9102e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3&id2=57bdca0693959bb6341b4b50aba8576cdde9102e)) | |
| download | [linux-9dfee956f53eea96d93ef1e13ab4ce020f4c58b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9dfee956f53eea96d93ef1e13ab4ce020f4c58b3.tar.gz) | |

HID: amd\_sfh: Switch to device-managed dmam\_alloc\_coherent()commit c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3 upstream.
Using the device-managed version allows to simplify clean-up in probe()
error path.
Additionally, this device-managed ensures proper cleanup, which helps to
resolve memory errors, page faults, btrfs going read-only, and btrfs
disk corruption.
Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Tested-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Tested-by: Richard <hobbes1069@gmail.com>
Tested-by: Skyler <skpu@pm.me>
Reported-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Closes: https://lore.kernel.org/all/3b129b1f-8636-456a-80b4-0f6cce0eef63@hixontech.com/
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219331>
Signed-off-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 11 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_client.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_client.cindex 4b59687ff5d821..3438d392920fad 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=57bdca0693959bb6341b4b50aba8576cdde9102e)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=9dfee956f53eea96d93ef1e13ab4ce020f4c58b3)@@ -236,9 +236,9 @@ int amd\_sfh\_hid\_client\_init(struct amd\_mp2\_dev \*privdata) cl\_data->in\_data = in\_data;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- in\_data->sensor\_virt\_addr[i] = dma\_alloc\_coherent(dev, sizeof(int) \* 8,- &cl\_data->sensor\_dma\_addr[i],- GFP\_KERNEL);+ in\_data->sensor\_virt\_addr[i] = dmam\_alloc\_coherent(dev, sizeof(int) \* 8,+ &cl\_data->sensor\_dma\_addr[i],+ GFP\_KERNEL); if (!in\_data->sensor\_virt\_addr[i]) { rc = -ENOMEM; goto cleanup;@@ -331,7 +331,6 @@ cleanup: int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) { struct amdtp\_cl\_data \*cl\_data = privdata->cl\_data;- struct amd\_input\_data \*in\_data = cl\_data->in\_data; int i, status;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {@@ -351,12 +350,5 @@ int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) cancel\_delayed\_work\_sync(&cl\_data->work\_buffer); amdtp\_hid\_remove(cl\_data); - for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- if (in\_data->sensor\_virt\_addr[i]) {- dma\_free\_coherent(&privdata->pdev->dev, 8 \* sizeof(int),- in\_data->sensor\_virt\_addr[i],- cl\_data->sensor\_dma\_addr[i]);- }- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:22:39 +0000



=== Content from git.kernel.org_4adfafb4_20250115_102403.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Basavaraj Natikar <Basavaraj.Natikar@amd.com> | 2024-10-09 20:17:57 +0530 |
| --- | --- | --- |
| committer | Jiri Kosina <jkosina@suse.com> | 2024-10-09 17:18:57 +0200 |
| commit | [c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)) | |
| tree | [8fb94425a4e96b016c44bb6baf2c074a2525d254](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3) | |
| parent | [7a5ab8071114344f62a8b1e64ed3452a77257d76](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a5ab8071114344f62a8b1e64ed3452a77257d76) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3&id2=7a5ab8071114344f62a8b1e64ed3452a77257d76)) | |
| download | [linux-c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3.tar.gz) | |

HID: amd\_sfh: Switch to device-managed dmam\_alloc\_coherent()Using the device-managed version allows to simplify clean-up in probe()
error path.
Additionally, this device-managed ensures proper cleanup, which helps to
resolve memory errors, page faults, btrfs going read-only, and btrfs
disk corruption.
Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Tested-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Tested-by: Richard <hobbes1069@gmail.com>
Tested-by: Skyler <skpu@pm.me>
Reported-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Closes: https://lore.kernel.org/all/3b129b1f-8636-456a-80b4-0f6cce0eef63@hixontech.com/
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219331>
Signed-off-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 11 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_client.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_client.cindex 4b59687ff5d821..3438d392920fad 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=7a5ab8071114344f62a8b1e64ed3452a77257d76)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3)@@ -236,9 +236,9 @@ int amd\_sfh\_hid\_client\_init(struct amd\_mp2\_dev \*privdata) cl\_data->in\_data = in\_data;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- in\_data->sensor\_virt\_addr[i] = dma\_alloc\_coherent(dev, sizeof(int) \* 8,- &cl\_data->sensor\_dma\_addr[i],- GFP\_KERNEL);+ in\_data->sensor\_virt\_addr[i] = dmam\_alloc\_coherent(dev, sizeof(int) \* 8,+ &cl\_data->sensor\_dma\_addr[i],+ GFP\_KERNEL); if (!in\_data->sensor\_virt\_addr[i]) { rc = -ENOMEM; goto cleanup;@@ -331,7 +331,6 @@ cleanup: int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) { struct amdtp\_cl\_data \*cl\_data = privdata->cl\_data;- struct amd\_input\_data \*in\_data = cl\_data->in\_data; int i, status;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {@@ -351,12 +350,5 @@ int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) cancel\_delayed\_work\_sync(&cl\_data->work\_buffer); amdtp\_hid\_remove(cl\_data); - for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- if (in\_data->sensor\_virt\_addr[i]) {- dma\_free\_coherent(&privdata->pdev->dev, 8 \* sizeof(int),- in\_data->sensor\_virt\_addr[i],- cl\_data->sensor\_dma\_addr[i]);- }- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:22:40 +0000



=== Content from git.kernel.org_04fb1ee8_20250115_102401.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c6ad37e5882073cab84901a31da9cb22f316276)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c6ad37e5882073cab84901a31da9cb22f316276)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c6ad37e5882073cab84901a31da9cb22f316276)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6ad37e5882073cab84901a31da9cb22f316276)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Basavaraj Natikar <Basavaraj.Natikar@amd.com> | 2024-10-09 20:17:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:59 +0200 |
| commit | [8c6ad37e5882073cab84901a31da9cb22f316276](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c6ad37e5882073cab84901a31da9cb22f316276) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c6ad37e5882073cab84901a31da9cb22f316276)) | |
| tree | [96b259d605055e821900c46273282cf8b22fdfe1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c6ad37e5882073cab84901a31da9cb22f316276) | |
| parent | [a77e1d1ae962c02f4f1eda1d11515336ce5728fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a77e1d1ae962c02f4f1eda1d11515336ce5728fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6ad37e5882073cab84901a31da9cb22f316276&id2=a77e1d1ae962c02f4f1eda1d11515336ce5728fb)) | |
| download | [linux-8c6ad37e5882073cab84901a31da9cb22f316276.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c6ad37e5882073cab84901a31da9cb22f316276.tar.gz) | |

HID: amd\_sfh: Switch to device-managed dmam\_alloc\_coherent()commit c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3 upstream.
Using the device-managed version allows to simplify clean-up in probe()
error path.
Additionally, this device-managed ensures proper cleanup, which helps to
resolve memory errors, page faults, btrfs going read-only, and btrfs
disk corruption.
Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Tested-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Tested-by: Richard <hobbes1069@gmail.com>
Tested-by: Skyler <skpu@pm.me>
Reported-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Closes: https://lore.kernel.org/all/3b129b1f-8636-456a-80b4-0f6cce0eef63@hixontech.com/
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219331>
Signed-off-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6ad37e5882073cab84901a31da9cb22f316276)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=8c6ad37e5882073cab84901a31da9cb22f316276) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 11 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_client.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_client.cindex 911a23a9bcd1b4..71cac50a03905e 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=a77e1d1ae962c02f4f1eda1d11515336ce5728fb)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=8c6ad37e5882073cab84901a31da9cb22f316276)@@ -163,9 +163,9 @@ int amd\_sfh\_hid\_client\_init(struct amd\_mp2\_dev \*privdata) cl\_data->in\_data = in\_data;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- in\_data->sensor\_virt\_addr[i] = dma\_alloc\_coherent(dev, sizeof(int) \* 8,- &cl\_data->sensor\_dma\_addr[i],- GFP\_KERNEL);+ in\_data->sensor\_virt\_addr[i] = dmam\_alloc\_coherent(dev, sizeof(int) \* 8,+ &cl\_data->sensor\_dma\_addr[i],+ GFP\_KERNEL); if (!in\_data->sensor\_virt\_addr[i]) { rc = -ENOMEM; goto cleanup;@@ -263,7 +263,6 @@ cleanup: int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) { struct amdtp\_cl\_data \*cl\_data = privdata->cl\_data;- struct amd\_input\_data \*in\_data = cl\_data->in\_data; int i, status;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {@@ -282,12 +281,5 @@ int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) cancel\_delayed\_work\_sync(&cl\_data->work\_buffer); amdtp\_hid\_remove(cl\_data); - for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- if (in\_data->sensor\_virt\_addr[i]) {- dma\_free\_coherent(&privdata->pdev->dev, 8 \* sizeof(int),- in\_data->sensor\_virt\_addr[i],- cl\_data->sensor\_dma\_addr[i]);- }- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:22:37 +0000



=== Content from git.kernel.org_bf30e9c5_20250115_102359.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Basavaraj Natikar <Basavaraj.Natikar@amd.com> | 2024-10-09 20:17:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:25 +0200 |
| commit | [4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)) | |
| tree | [9f4828898452b4b319801e503c64a1c468808494](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93) | |
| parent | [80faf6afeb43b44480e69d2aa283cdc2fe7c83c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80faf6afeb43b44480e69d2aa283cdc2fe7c83c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93&id2=80faf6afeb43b44480e69d2aa283cdc2fe7c83c5)) | |
| download | [linux-4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93.tar.gz) | |

HID: amd\_sfh: Switch to device-managed dmam\_alloc\_coherent()commit c56f9ecb7fb6a3a90079c19eb4c8daf3bbf514b3 upstream.
Using the device-managed version allows to simplify clean-up in probe()
error path.
Additionally, this device-managed ensures proper cleanup, which helps to
resolve memory errors, page faults, btrfs going read-only, and btrfs
disk corruption.
Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Tested-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Tested-by: Richard <hobbes1069@gmail.com>
Tested-by: Skyler <skpu@pm.me>
Reported-by: Chris Hixon <linux-kernel-bugs@hixontech.com>
Closes: https://lore.kernel.org/all/3b129b1f-8636-456a-80b4-0f6cce0eef63@hixontech.com/
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219331>
Signed-off-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 11 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_client.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_client.cindex 4343fef7dd83eb..017b5bbfdcbeac 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=80faf6afeb43b44480e69d2aa283cdc2fe7c83c5)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_client.c?id=4cd9c5a0fcadc39a05c978a01e15e0d1edc4be93)@@ -235,9 +235,9 @@ int amd\_sfh\_hid\_client\_init(struct amd\_mp2\_dev \*privdata) cl\_data->in\_data = in\_data;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- in\_data->sensor\_virt\_addr[i] = dma\_alloc\_coherent(dev, sizeof(int) \* 8,- &cl\_data->sensor\_dma\_addr[i],- GFP\_KERNEL);+ in\_data->sensor\_virt\_addr[i] = dmam\_alloc\_coherent(dev, sizeof(int) \* 8,+ &cl\_data->sensor\_dma\_addr[i],+ GFP\_KERNEL); if (!in\_data->sensor\_virt\_addr[i]) { rc = -ENOMEM; goto cleanup;@@ -334,7 +334,6 @@ cleanup: int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) { struct amdtp\_cl\_data \*cl\_data = privdata->cl\_data;- struct amd\_input\_data \*in\_data = cl\_data->in\_data; int i, status;  for (i = 0; i < cl\_data->num\_hid\_devices; i++) {@@ -354,12 +353,5 @@ int amd\_sfh\_hid\_client\_deinit(struct amd\_mp2\_dev \*privdata) cancel\_delayed\_work\_sync(&cl\_data->work\_buffer); amdtp\_hid\_remove(cl\_data); - for (i = 0; i < cl\_data->num\_hid\_devices; i++) {- if (in\_data->sensor\_virt\_addr[i]) {- dma\_free\_coherent(&privdata->pdev->dev, 8 \* sizeof(int),- in\_data->sensor\_virt\_addr[i],- cl\_data->sensor\_dma\_addr[i]);- }- } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:22:36 +0000


