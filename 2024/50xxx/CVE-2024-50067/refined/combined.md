=== Content from git.kernel.org_bc636e54_20250115_100630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiao Ma <mqaio@linux.alibaba.com> | 2024-10-15 14:01:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:33 +0100 |
| commit | [537ad4a431f6dddbf15d40d19f24bb9ee12b55cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)) | |
| tree | [3ee4485d1acbc57a7fd92f263ba855fe7bbc60d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb) | |
| parent | [fb1d828aaa29ff368d3d373348d44b646fd2eafb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb1d828aaa29ff368d3d373348d44b646fd2eafb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb&id2=fb1d828aaa29ff368d3d373348d44b646fd2eafb)) | |
| download | [linux-537ad4a431f6dddbf15d40d19f24bb9ee12b55cb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-537ad4a431f6dddbf15d40d19f24bb9ee12b55cb.tar.gz) | |

uprobe: avoid out-of-bounds memory access of fetching args[ Upstream commit 373b9338c9722a368925d83bc622c596896b328e ]
Uprobe needs to fetch args into a percpu buffer, and then copy to ring
buffer to avoid non-atomic context problem.
Sometimes user-space strings, arrays can be very large, but the size of
percpu buffer is only page size. And store\_trace\_args() won't check
whether these data exceeds a single page or not, caused out-of-bounds
memory access.
It could be reproduced by following steps:
1. build kernel with CONFIG\_KASAN enabled
2. save follow program as test.c
```
\#include <stdio.h>
\#include <stdlib.h>
\#include <string.h>
// If string length large than MAX\_STRING\_SIZE, the fetch\_store\_strlen()
// will return 0, cause \_\_get\_data\_size() return shorter size, and
// store\_trace\_args() will not trigger out-of-bounds access.
// So make string length less than 4096.
\#define STRLEN 4093
void generate\_string(char \*str, int n)
{
int i;
for (i = 0; i < n; ++i)
{
char c = i % 26 + 'a';
str[i] = c;
}
str[n-1] = '\0';
}
void print\_string(char \*str)
{
printf("%s\n", str);
}
int main()
{
char tmp[STRLEN];
generate\_string(tmp, STRLEN);
print\_string(tmp);
return 0;
}
```
3. compile program
`gcc -o test test.c`
4. get the offset of `print\_string()`
```
objdump -t test | grep -w print\_string
0000000000401199 g F .text 000000000000001b print\_string
```
5. configure uprobe with offset 0x1199
```
off=0x1199
cd /sys/kernel/debug/tracing/
echo "p /root/test:${off} arg1=+0(%di):ustring arg2=\$comm arg3=+0(%di):ustring"
> uprobe\_events
echo 1 > events/uprobes/enable
echo 1 > tracing\_on
```
6. run `test`, and kasan will report error.
==================================================================
BUG: KASAN: use-after-free in strncpy\_from\_user+0x1d6/0x1f0
Write of size 8 at addr ffff88812311c004 by task test/499CPU: 0 UID: 0 PID: 499 Comm: test Not tainted 6.12.0-rc3+ #18
Hardware name: Red Hat KVM, BIOS 1.16.0-4.al8 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x55/0x70
print\_address\_description.constprop.0+0x27/0x310
kasan\_report+0x10f/0x120
? strncpy\_from\_user+0x1d6/0x1f0
strncpy\_from\_user+0x1d6/0x1f0
? rmqueue.constprop.0+0x70d/0x2ad0
process\_fetch\_insn+0xb26/0x1470
? \_\_pfx\_process\_fetch\_insn+0x10/0x10
? \_raw\_spin\_lock+0x85/0xe0
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pte\_offset\_map+0x1f/0x2d0
? unwind\_next\_frame+0xc5f/0x1f80
? arch\_stack\_walk+0x68/0xf0
? is\_bpf\_text\_address+0x23/0x30
? kernel\_text\_address.part.0+0xbb/0xd0
? \_\_kernel\_text\_address+0x66/0xb0
? unwind\_get\_return\_address+0x5e/0xa0
? \_\_pfx\_stack\_trace\_consume\_entry+0x10/0x10
? arch\_stack\_walk+0xa2/0xf0
? \_raw\_spin\_lock\_irqsave+0x8b/0xf0
? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
? depot\_alloc\_stack+0x4c/0x1f0
? \_raw\_spin\_unlock\_irqrestore+0xe/0x30
? stack\_depot\_save\_flags+0x35d/0x4f0
? kasan\_save\_stack+0x34/0x50
? kasan\_save\_stack+0x24/0x50
? mutex\_lock+0x91/0xe0
? \_\_pfx\_mutex\_lock+0x10/0x10
prepare\_uprobe\_buffer.part.0+0x2cd/0x500
uprobe\_dispatcher+0x2c3/0x6a0
? \_\_pfx\_uprobe\_dispatcher+0x10/0x10
? \_\_kasan\_slab\_alloc+0x4d/0x90
handler\_chain+0xdd/0x3e0
handle\_swbp+0x26e/0x3d0
? \_\_pfx\_handle\_swbp+0x10/0x10
? uprobe\_pre\_sstep\_notifier+0x151/0x1b0
irqentry\_exit\_to\_user\_mode+0xe2/0x1b0
asm\_exc\_int3+0x39/0x40
RIP: 0033:0x401199
Code: 01 c2 0f b6 45 fb 88 02 83 45 fc 01 8b 45 fc 3b 45 e4 7c b7 8b 45 e4 48 98 48 8d 50 ff 48 8b 45 e8 48 01 d0 ce
RSP: 002b:00007ffdf00576a8 EFLAGS: 00000206
RAX: 00007ffdf00576b0 RBX: 0000000000000000 RCX: 0000000000000ff2
RDX: 0000000000000ffc RSI: 0000000000000ffd RDI: 00007ffdf00576b0
RBP: 00007ffdf00586b0 R08: 00007feb2f9c0d20 R09: 00007feb2f9c0d20
R10: 0000000000000001 R11: 0000000000000202 R12: 0000000000401040
R13: 00007ffdf0058780 R14: 0000000000000000 R15: 0000000000000000
</TASK>
This commit enforces the buffer's maxlen less than a page-size to avoid
store\_trace\_args() out-of-memory access.
Link: [https://lore.kernel.org/all/20241015060148.1108331-1-mqaio@linux.alibaba.com/](https://lore.kernel.org/all/20241015060148.1108331-1-mqaio%40linux.alibaba.com/)
Fixes: dcad1a204f72 ("tracing/uprobes: Fetch args before reserving a ring buffer")
Signed-off-by: Qiao Ma <mqaio@linux.alibaba.com>
Signed-off-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)

| -rw-r--r-- | [kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_uprobe.c?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/trace/trace\_uprobe.c b/kernel/trace/trace\_uprobe.cindex c98e3b3386badb..2c30d948e733c3 100644--- a/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=fb1d828aaa29ff368d3d373348d44b646fd2eafb)+++ b/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=537ad4a431f6dddbf15d40d19f24bb9ee12b55cb)@@ -858,6 +858,7 @@ struct uprobe\_cpu\_buffer { }; static struct uprobe\_cpu\_buffer \_\_percpu \*uprobe\_cpu\_buffer; static int uprobe\_buffer\_refcnt;+#define MAX\_UCB\_BUFFER\_SIZE PAGE\_SIZE  static int uprobe\_buffer\_init(void) {@@ -962,6 +963,11 @@ static struct uprobe\_cpu\_buffer \*prepare\_uprobe\_buffer(struct trace\_uprobe \*tu, ucb = uprobe\_buffer\_get(); ucb->dsize = tu->tp.size + dsize; + if (WARN\_ON\_ONCE(ucb->dsize > MAX\_UCB\_BUFFER\_SIZE)) {+ ucb->dsize = MAX\_UCB\_BUFFER\_SIZE;+ dsize = MAX\_UCB\_BUFFER\_SIZE - tu->tp.size;+ }+ store\_trace\_args(ucb->buf, &tu->tp, regs, NULL, esize, dsize);  \*ucbp = ucb;@@ -981,9 +987,6 @@ static void \_\_uprobe\_trace\_func(struct trace\_uprobe \*tu,  WARN\_ON(call != trace\_file->event\_call); - if (WARN\_ON\_ONCE(ucb->dsize > PAGE\_SIZE))- return;- if (trace\_trigger\_soft\_disabled(trace\_file)) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:05:08 +0000



=== Content from git.kernel.org_a8095ca8_20250115_100630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=373b9338c9722a368925d83bc622c596896b328e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=373b9338c9722a368925d83bc622c596896b328e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=373b9338c9722a368925d83bc622c596896b328e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=373b9338c9722a368925d83bc622c596896b328e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiao Ma <mqaio@linux.alibaba.com> | 2024-10-15 14:01:48 +0800 |
| --- | --- | --- |
| committer | Masami Hiramatsu (Google) <mhiramat@kernel.org> | 2024-10-21 13:15:28 +0900 |
| commit | [373b9338c9722a368925d83bc622c596896b328e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=373b9338c9722a368925d83bc622c596896b328e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=373b9338c9722a368925d83bc622c596896b328e)) | |
| tree | [54d02bb7fecd80a4fe0f82f31288cfe0b61e7c42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=373b9338c9722a368925d83bc622c596896b328e) | |
| parent | [42f7652d3eb527d03665b09edac47f85fb600924](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42f7652d3eb527d03665b09edac47f85fb600924) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=373b9338c9722a368925d83bc622c596896b328e&id2=42f7652d3eb527d03665b09edac47f85fb600924)) | |
| download | [linux-373b9338c9722a368925d83bc622c596896b328e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-373b9338c9722a368925d83bc622c596896b328e.tar.gz) | |

uprobe: avoid out-of-bounds memory access of fetching argsUprobe needs to fetch args into a percpu buffer, and then copy to ring
buffer to avoid non-atomic context problem.
Sometimes user-space strings, arrays can be very large, but the size of
percpu buffer is only page size. And store\_trace\_args() won't check
whether these data exceeds a single page or not, caused out-of-bounds
memory access.
It could be reproduced by following steps:
1. build kernel with CONFIG\_KASAN enabled
2. save follow program as test.c
```
\#include <stdio.h>
\#include <stdlib.h>
\#include <string.h>
// If string length large than MAX\_STRING\_SIZE, the fetch\_store\_strlen()
// will return 0, cause \_\_get\_data\_size() return shorter size, and
// store\_trace\_args() will not trigger out-of-bounds access.
// So make string length less than 4096.
\#define STRLEN 4093
void generate\_string(char \*str, int n)
{
int i;
for (i = 0; i < n; ++i)
{
char c = i % 26 + 'a';
str[i] = c;
}
str[n-1] = '\0';
}
void print\_string(char \*str)
{
printf("%s\n", str);
}
int main()
{
char tmp[STRLEN];
generate\_string(tmp, STRLEN);
print\_string(tmp);
return 0;
}
```
3. compile program
`gcc -o test test.c`
4. get the offset of `print\_string()`
```
objdump -t test | grep -w print\_string
0000000000401199 g F .text 000000000000001b print\_string
```
5. configure uprobe with offset 0x1199
```
off=0x1199
cd /sys/kernel/debug/tracing/
echo "p /root/test:${off} arg1=+0(%di):ustring arg2=\$comm arg3=+0(%di):ustring"
> uprobe\_events
echo 1 > events/uprobes/enable
echo 1 > tracing\_on
```
6. run `test`, and kasan will report error.
==================================================================
BUG: KASAN: use-after-free in strncpy\_from\_user+0x1d6/0x1f0
Write of size 8 at addr ffff88812311c004 by task test/499CPU: 0 UID: 0 PID: 499 Comm: test Not tainted 6.12.0-rc3+ #18
Hardware name: Red Hat KVM, BIOS 1.16.0-4.al8 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x55/0x70
print\_address\_description.constprop.0+0x27/0x310
kasan\_report+0x10f/0x120
? strncpy\_from\_user+0x1d6/0x1f0
strncpy\_from\_user+0x1d6/0x1f0
? rmqueue.constprop.0+0x70d/0x2ad0
process\_fetch\_insn+0xb26/0x1470
? \_\_pfx\_process\_fetch\_insn+0x10/0x10
? \_raw\_spin\_lock+0x85/0xe0
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pte\_offset\_map+0x1f/0x2d0
? unwind\_next\_frame+0xc5f/0x1f80
? arch\_stack\_walk+0x68/0xf0
? is\_bpf\_text\_address+0x23/0x30
? kernel\_text\_address.part.0+0xbb/0xd0
? \_\_kernel\_text\_address+0x66/0xb0
? unwind\_get\_return\_address+0x5e/0xa0
? \_\_pfx\_stack\_trace\_consume\_entry+0x10/0x10
? arch\_stack\_walk+0xa2/0xf0
? \_raw\_spin\_lock\_irqsave+0x8b/0xf0
? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
? depot\_alloc\_stack+0x4c/0x1f0
? \_raw\_spin\_unlock\_irqrestore+0xe/0x30
? stack\_depot\_save\_flags+0x35d/0x4f0
? kasan\_save\_stack+0x34/0x50
? kasan\_save\_stack+0x24/0x50
? mutex\_lock+0x91/0xe0
? \_\_pfx\_mutex\_lock+0x10/0x10
prepare\_uprobe\_buffer.part.0+0x2cd/0x500
uprobe\_dispatcher+0x2c3/0x6a0
? \_\_pfx\_uprobe\_dispatcher+0x10/0x10
? \_\_kasan\_slab\_alloc+0x4d/0x90
handler\_chain+0xdd/0x3e0
handle\_swbp+0x26e/0x3d0
? \_\_pfx\_handle\_swbp+0x10/0x10
? uprobe\_pre\_sstep\_notifier+0x151/0x1b0
irqentry\_exit\_to\_user\_mode+0xe2/0x1b0
asm\_exc\_int3+0x39/0x40
RIP: 0033:0x401199
Code: 01 c2 0f b6 45 fb 88 02 83 45 fc 01 8b 45 fc 3b 45 e4 7c b7 8b 45 e4 48 98 48 8d 50 ff 48 8b 45 e8 48 01 d0 ce
RSP: 002b:00007ffdf00576a8 EFLAGS: 00000206
RAX: 00007ffdf00576b0 RBX: 0000000000000000 RCX: 0000000000000ff2
RDX: 0000000000000ffc RSI: 0000000000000ffd RDI: 00007ffdf00576b0
RBP: 00007ffdf00586b0 R08: 00007feb2f9c0d20 R09: 00007feb2f9c0d20
R10: 0000000000000001 R11: 0000000000000202 R12: 0000000000401040
R13: 00007ffdf0058780 R14: 0000000000000000 R15: 0000000000000000
</TASK>
This commit enforces the buffer's maxlen less than a page-size to avoid
store\_trace\_args() out-of-memory access.
Link: [https://lore.kernel.org/all/20241015060148.1108331-1-mqaio@linux.alibaba.com/](https://lore.kernel.org/all/20241015060148.1108331-1-mqaio%40linux.alibaba.com/)
Fixes: dcad1a204f72 ("tracing/uprobes: Fetch args before reserving a ring buffer")
Signed-off-by: Qiao Ma <mqaio@linux.alibaba.com>
Signed-off-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=373b9338c9722a368925d83bc622c596896b328e)

| -rw-r--r-- | [kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_uprobe.c?id=373b9338c9722a368925d83bc622c596896b328e) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/trace/trace\_uprobe.c b/kernel/trace/trace\_uprobe.cindex c40531d2cbadde..13f9270ed5ab43 100644--- a/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=42f7652d3eb527d03665b09edac47f85fb600924)+++ b/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=373b9338c9722a368925d83bc622c596896b328e)@@ -875,6 +875,7 @@ struct uprobe\_cpu\_buffer { }; static struct uprobe\_cpu\_buffer \_\_percpu \*uprobe\_cpu\_buffer; static int uprobe\_buffer\_refcnt;+#define MAX\_UCB\_BUFFER\_SIZE PAGE\_SIZE  static int uprobe\_buffer\_init(void) {@@ -979,6 +980,11 @@ static struct uprobe\_cpu\_buffer \*prepare\_uprobe\_buffer(struct trace\_uprobe \*tu, ucb = uprobe\_buffer\_get(); ucb->dsize = tu->tp.size + dsize; + if (WARN\_ON\_ONCE(ucb->dsize > MAX\_UCB\_BUFFER\_SIZE)) {+ ucb->dsize = MAX\_UCB\_BUFFER\_SIZE;+ dsize = MAX\_UCB\_BUFFER\_SIZE - tu->tp.size;+ }+ store\_trace\_args(ucb->buf, &tu->tp, regs, NULL, esize, dsize);  \*ucbp = ucb;@@ -998,9 +1004,6 @@ static void \_\_uprobe\_trace\_func(struct trace\_uprobe \*tu,  WARN\_ON(call != trace\_file->event\_call); - if (WARN\_ON\_ONCE(ucb->dsize > PAGE\_SIZE))- return;- if (trace\_trigger\_soft\_disabled(trace\_file)) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:05:07 +0000



=== Content from git.kernel.org_c96509b4_20250115_100631.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiao Ma <mqaio@linux.alibaba.com> | 2024-10-15 14:01:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:27 +0100 |
| commit | [9e5f93788c9dd4309e75a56860a1ac44a8e117b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)) | |
| tree | [3d47df8de0e2797faad3cc753160585396dbc97b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9) | |
| parent | [f0a7ea54f3dc7ae2dd55e54918b04304dd28d986](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0a7ea54f3dc7ae2dd55e54918b04304dd28d986) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9&id2=f0a7ea54f3dc7ae2dd55e54918b04304dd28d986)) | |
| download | [linux-9e5f93788c9dd4309e75a56860a1ac44a8e117b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e5f93788c9dd4309e75a56860a1ac44a8e117b9.tar.gz) | |

uprobe: avoid out-of-bounds memory access of fetching args[ Upstream commit 373b9338c9722a368925d83bc622c596896b328e ]
Uprobe needs to fetch args into a percpu buffer, and then copy to ring
buffer to avoid non-atomic context problem.
Sometimes user-space strings, arrays can be very large, but the size of
percpu buffer is only page size. And store\_trace\_args() won't check
whether these data exceeds a single page or not, caused out-of-bounds
memory access.
It could be reproduced by following steps:
1. build kernel with CONFIG\_KASAN enabled
2. save follow program as test.c
```
\#include <stdio.h>
\#include <stdlib.h>
\#include <string.h>
// If string length large than MAX\_STRING\_SIZE, the fetch\_store\_strlen()
// will return 0, cause \_\_get\_data\_size() return shorter size, and
// store\_trace\_args() will not trigger out-of-bounds access.
// So make string length less than 4096.
\#define STRLEN 4093
void generate\_string(char \*str, int n)
{
int i;
for (i = 0; i < n; ++i)
{
char c = i % 26 + 'a';
str[i] = c;
}
str[n-1] = '\0';
}
void print\_string(char \*str)
{
printf("%s\n", str);
}
int main()
{
char tmp[STRLEN];
generate\_string(tmp, STRLEN);
print\_string(tmp);
return 0;
}
```
3. compile program
`gcc -o test test.c`
4. get the offset of `print\_string()`
```
objdump -t test | grep -w print\_string
0000000000401199 g F .text 000000000000001b print\_string
```
5. configure uprobe with offset 0x1199
```
off=0x1199
cd /sys/kernel/debug/tracing/
echo "p /root/test:${off} arg1=+0(%di):ustring arg2=\$comm arg3=+0(%di):ustring"
> uprobe\_events
echo 1 > events/uprobes/enable
echo 1 > tracing\_on
```
6. run `test`, and kasan will report error.
==================================================================
BUG: KASAN: use-after-free in strncpy\_from\_user+0x1d6/0x1f0
Write of size 8 at addr ffff88812311c004 by task test/499CPU: 0 UID: 0 PID: 499 Comm: test Not tainted 6.12.0-rc3+ #18
Hardware name: Red Hat KVM, BIOS 1.16.0-4.al8 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x55/0x70
print\_address\_description.constprop.0+0x27/0x310
kasan\_report+0x10f/0x120
? strncpy\_from\_user+0x1d6/0x1f0
strncpy\_from\_user+0x1d6/0x1f0
? rmqueue.constprop.0+0x70d/0x2ad0
process\_fetch\_insn+0xb26/0x1470
? \_\_pfx\_process\_fetch\_insn+0x10/0x10
? \_raw\_spin\_lock+0x85/0xe0
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pte\_offset\_map+0x1f/0x2d0
? unwind\_next\_frame+0xc5f/0x1f80
? arch\_stack\_walk+0x68/0xf0
? is\_bpf\_text\_address+0x23/0x30
? kernel\_text\_address.part.0+0xbb/0xd0
? \_\_kernel\_text\_address+0x66/0xb0
? unwind\_get\_return\_address+0x5e/0xa0
? \_\_pfx\_stack\_trace\_consume\_entry+0x10/0x10
? arch\_stack\_walk+0xa2/0xf0
? \_raw\_spin\_lock\_irqsave+0x8b/0xf0
? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
? depot\_alloc\_stack+0x4c/0x1f0
? \_raw\_spin\_unlock\_irqrestore+0xe/0x30
? stack\_depot\_save\_flags+0x35d/0x4f0
? kasan\_save\_stack+0x34/0x50
? kasan\_save\_stack+0x24/0x50
? mutex\_lock+0x91/0xe0
? \_\_pfx\_mutex\_lock+0x10/0x10
prepare\_uprobe\_buffer.part.0+0x2cd/0x500
uprobe\_dispatcher+0x2c3/0x6a0
? \_\_pfx\_uprobe\_dispatcher+0x10/0x10
? \_\_kasan\_slab\_alloc+0x4d/0x90
handler\_chain+0xdd/0x3e0
handle\_swbp+0x26e/0x3d0
? \_\_pfx\_handle\_swbp+0x10/0x10
? uprobe\_pre\_sstep\_notifier+0x151/0x1b0
irqentry\_exit\_to\_user\_mode+0xe2/0x1b0
asm\_exc\_int3+0x39/0x40
RIP: 0033:0x401199
Code: 01 c2 0f b6 45 fb 88 02 83 45 fc 01 8b 45 fc 3b 45 e4 7c b7 8b 45 e4 48 98 48 8d 50 ff 48 8b 45 e8 48 01 d0 ce
RSP: 002b:00007ffdf00576a8 EFLAGS: 00000206
RAX: 00007ffdf00576b0 RBX: 0000000000000000 RCX: 0000000000000ff2
RDX: 0000000000000ffc RSI: 0000000000000ffd RDI: 00007ffdf00576b0
RBP: 00007ffdf00586b0 R08: 00007feb2f9c0d20 R09: 00007feb2f9c0d20
R10: 0000000000000001 R11: 0000000000000202 R12: 0000000000401040
R13: 00007ffdf0058780 R14: 0000000000000000 R15: 0000000000000000
</TASK>
This commit enforces the buffer's maxlen less than a page-size to avoid
store\_trace\_args() out-of-memory access.
Link: [https://lore.kernel.org/all/20241015060148.1108331-1-mqaio@linux.alibaba.com/](https://lore.kernel.org/all/20241015060148.1108331-1-mqaio%40linux.alibaba.com/)
Fixes: dcad1a204f72 ("tracing/uprobes: Fetch args before reserving a ring buffer")
Signed-off-by: Qiao Ma <mqaio@linux.alibaba.com>
Signed-off-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)

| -rw-r--r-- | [kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_uprobe.c?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/trace/trace\_uprobe.c b/kernel/trace/trace\_uprobe.cindex 0d52588329b290..d72ac9dde53218 100644--- a/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=f0a7ea54f3dc7ae2dd55e54918b04304dd28d986)+++ b/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=9e5f93788c9dd4309e75a56860a1ac44a8e117b9)@@ -858,6 +858,7 @@ struct uprobe\_cpu\_buffer { }; static struct uprobe\_cpu\_buffer \_\_percpu \*uprobe\_cpu\_buffer; static int uprobe\_buffer\_refcnt;+#define MAX\_UCB\_BUFFER\_SIZE PAGE\_SIZE  static int uprobe\_buffer\_init(void) {@@ -962,6 +963,11 @@ static struct uprobe\_cpu\_buffer \*prepare\_uprobe\_buffer(struct trace\_uprobe \*tu, ucb = uprobe\_buffer\_get(); ucb->dsize = tu->tp.size + dsize; + if (WARN\_ON\_ONCE(ucb->dsize > MAX\_UCB\_BUFFER\_SIZE)) {+ ucb->dsize = MAX\_UCB\_BUFFER\_SIZE;+ dsize = MAX\_UCB\_BUFFER\_SIZE - tu->tp.size;+ }+ store\_trace\_args(ucb->buf, &tu->tp, regs, NULL, esize, dsize);  \*ucbp = ucb;@@ -981,9 +987,6 @@ static void \_\_uprobe\_trace\_func(struct trace\_uprobe \*tu,  WARN\_ON(call != trace\_file->event\_call); - if (WARN\_ON\_ONCE(ucb->dsize > PAGE\_SIZE))- return;- if (trace\_trigger\_soft\_disabled(trace\_file)) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:05:08 +0000



=== Content from git.kernel.org_0eefcb09_20250115_100629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiao Ma <mqaio@linux.alibaba.com> | 2024-10-15 14:01:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:07:21 +0100 |
| commit | [0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)) | |
| tree | [51adc8584b8dd5661caabf40c29bbb8086877d77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f) | |
| parent | [02079f092250f031203b7d5674368dbdeebc38a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02079f092250f031203b7d5674368dbdeebc38a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f&id2=02079f092250f031203b7d5674368dbdeebc38a4)) | |
| download | [linux-0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f.tar.gz) | |

uprobe: avoid out-of-bounds memory access of fetching argscommit 373b9338c9722a368925d83bc622c596896b328e upstream.
Uprobe needs to fetch args into a percpu buffer, and then copy to ring
buffer to avoid non-atomic context problem.
Sometimes user-space strings, arrays can be very large, but the size of
percpu buffer is only page size. And store\_trace\_args() won't check
whether these data exceeds a single page or not, caused out-of-bounds
memory access.
It could be reproduced by following steps:
1. build kernel with CONFIG\_KASAN enabled
2. save follow program as test.c
```
\#include <stdio.h>
\#include <stdlib.h>
\#include <string.h>
// If string length large than MAX\_STRING\_SIZE, the fetch\_store\_strlen()
// will return 0, cause \_\_get\_data\_size() return shorter size, and
// store\_trace\_args() will not trigger out-of-bounds access.
// So make string length less than 4096.
\#define STRLEN 4093
void generate\_string(char \*str, int n)
{
int i;
for (i = 0; i < n; ++i)
{
char c = i % 26 + 'a';
str[i] = c;
}
str[n-1] = '\0';
}
void print\_string(char \*str)
{
printf("%s\n", str);
}
int main()
{
char tmp[STRLEN];
generate\_string(tmp, STRLEN);
print\_string(tmp);
return 0;
}
```
3. compile program
`gcc -o test test.c`
4. get the offset of `print\_string()`
```
objdump -t test | grep -w print\_string
0000000000401199 g F .text 000000000000001b print\_string
```
5. configure uprobe with offset 0x1199
```
off=0x1199
cd /sys/kernel/debug/tracing/
echo "p /root/test:${off} arg1=+0(%di):ustring arg2=\$comm arg3=+0(%di):ustring"
> uprobe\_events
echo 1 > events/uprobes/enable
echo 1 > tracing\_on
```
6. run `test`, and kasan will report error.
==================================================================
BUG: KASAN: use-after-free in strncpy\_from\_user+0x1d6/0x1f0
Write of size 8 at addr ffff88812311c004 by task test/499CPU: 0 UID: 0 PID: 499 Comm: test Not tainted 6.12.0-rc3+ #18
Hardware name: Red Hat KVM, BIOS 1.16.0-4.al8 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x55/0x70
print\_address\_description.constprop.0+0x27/0x310
kasan\_report+0x10f/0x120
? strncpy\_from\_user+0x1d6/0x1f0
strncpy\_from\_user+0x1d6/0x1f0
? rmqueue.constprop.0+0x70d/0x2ad0
process\_fetch\_insn+0xb26/0x1470
? \_\_pfx\_process\_fetch\_insn+0x10/0x10
? \_raw\_spin\_lock+0x85/0xe0
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pte\_offset\_map+0x1f/0x2d0
? unwind\_next\_frame+0xc5f/0x1f80
? arch\_stack\_walk+0x68/0xf0
? is\_bpf\_text\_address+0x23/0x30
? kernel\_text\_address.part.0+0xbb/0xd0
? \_\_kernel\_text\_address+0x66/0xb0
? unwind\_get\_return\_address+0x5e/0xa0
? \_\_pfx\_stack\_trace\_consume\_entry+0x10/0x10
? arch\_stack\_walk+0xa2/0xf0
? \_raw\_spin\_lock\_irqsave+0x8b/0xf0
? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
? depot\_alloc\_stack+0x4c/0x1f0
? \_raw\_spin\_unlock\_irqrestore+0xe/0x30
? stack\_depot\_save\_flags+0x35d/0x4f0
? kasan\_save\_stack+0x34/0x50
? kasan\_save\_stack+0x24/0x50
? mutex\_lock+0x91/0xe0
? \_\_pfx\_mutex\_lock+0x10/0x10
prepare\_uprobe\_buffer.part.0+0x2cd/0x500
uprobe\_dispatcher+0x2c3/0x6a0
? \_\_pfx\_uprobe\_dispatcher+0x10/0x10
? \_\_kasan\_slab\_alloc+0x4d/0x90
handler\_chain+0xdd/0x3e0
handle\_swbp+0x26e/0x3d0
? \_\_pfx\_handle\_swbp+0x10/0x10
? uprobe\_pre\_sstep\_notifier+0x151/0x1b0
irqentry\_exit\_to\_user\_mode+0xe2/0x1b0
asm\_exc\_int3+0x39/0x40
RIP: 0033:0x401199
Code: 01 c2 0f b6 45 fb 88 02 83 45 fc 01 8b 45 fc 3b 45 e4 7c b7 8b 45 e4 48 98 48 8d 50 ff 48 8b 45 e8 48 01 d0 ce
RSP: 002b:00007ffdf00576a8 EFLAGS: 00000206
RAX: 00007ffdf00576b0 RBX: 0000000000000000 RCX: 0000000000000ff2
RDX: 0000000000000ffc RSI: 0000000000000ffd RDI: 00007ffdf00576b0
RBP: 00007ffdf00586b0 R08: 00007feb2f9c0d20 R09: 00007feb2f9c0d20
R10: 0000000000000001 R11: 0000000000000202 R12: 0000000000401040
R13: 00007ffdf0058780 R14: 0000000000000000 R15: 0000000000000000
</TASK>
This commit enforces the buffer's maxlen less than a page-size to avoid
store\_trace\_args() out-of-memory access.
Link: [https://lore.kernel.org/all/20241015060148.1108331-1-mqaio@linux.alibaba.com/](https://lore.kernel.org/all/20241015060148.1108331-1-mqaio%40linux.alibaba.com/)
Fixes: dcad1a204f72 ("tracing/uprobes: Fetch args before reserving a ring buffer")
Signed-off-by: Qiao Ma <mqaio@linux.alibaba.com>
Signed-off-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
Signed-off-by: Vamsi Krishna Brahmajosyula <vamsi-krishna.brahmajosyula@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)

| -rw-r--r-- | [kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_uprobe.c?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/trace/trace\_uprobe.c b/kernel/trace/trace\_uprobe.cindex e09eef65d32f62..a6a3ff2a441ed8 100644--- a/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=02079f092250f031203b7d5674368dbdeebc38a4)+++ b/[kernel/trace/trace\_uprobe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_uprobe.c?id=0dc3ad9ad2188da7f090b3dbe4d2fcd9ae8ae64f)@@ -862,6 +862,7 @@ struct uprobe\_cpu\_buffer { }; static struct uprobe\_cpu\_buffer \_\_percpu \*uprobe\_cpu\_buffer; static int uprobe\_buffer\_refcnt;+#define MAX\_UCB\_BUFFER\_SIZE PAGE\_SIZE  static int uprobe\_buffer\_init(void) {@@ -960,6 +961,11 @@ static struct uprobe\_cpu\_buffer \*prepare\_uprobe\_buffer(struct trace\_uprobe \*tu, ucb = uprobe\_buffer\_get(); ucb->dsize = tu->tp.size + dsize; + if (WARN\_ON\_ONCE(ucb->dsize > MAX\_UCB\_BUFFER\_SIZE)) {+ ucb->dsize = MAX\_UCB\_BUFFER\_SIZE;+ dsize = MAX\_UCB\_BUFFER\_SIZE - tu->tp.size;+ }+ store\_trace\_args(ucb->buf, &tu->tp, regs, esize, dsize);  return ucb;@@ -978,9 +984,6 @@ static void \_\_uprobe\_trace\_func(struct trace\_uprobe \*tu,  WARN\_ON(call != trace\_file->event\_call); - if (WARN\_ON\_ONCE(ucb->dsize > PAGE\_SIZE))- return;- if (trace\_trigger\_soft\_disabled(trace\_file)) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:05:06 +0000


