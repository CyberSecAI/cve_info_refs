=== Content from git.kernel.org_e9a91a58_20250114_180437.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-03 18:01:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:35 +0200 |
| commit | [563e6892e21d6ecabdf62103fc4e7b326d212334](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=563e6892e21d6ecabdf62103fc4e7b326d212334) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)) | |
| tree | [5bd044790fcc2cc9b9966e367b267daea29228a2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=563e6892e21d6ecabdf62103fc4e7b326d212334) | |
| parent | [31c62224e91c2af9fce4588db6e2f415b022154b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31c62224e91c2af9fce4588db6e2f415b022154b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563e6892e21d6ecabdf62103fc4e7b326d212334&id2=31c62224e91c2af9fce4588db6e2f415b022154b)) | |
| download | [linux-563e6892e21d6ecabdf62103fc4e7b326d212334.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-563e6892e21d6ecabdf62103fc4e7b326d212334.tar.gz) | |

net: explicitly clear the sk pointer, when pf->create failscommit 631083143315d1b192bd7d915b967b37819e88ea upstream.
We have recently noticed the exact same KASAN splat as in commit
6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket
creation fails"). The problem is that commit did not fully address the
problem, as some pf->create implementations do not use sk\_common\_release
in their error paths.
For example, we can use the same reproducer as in the above commit, but
changing ping to arping. arping uses AF\_PACKET socket and if packet\_create
fails, it will just sk\_free the allocated sk object.
While we could chase all the pf->create implementations and make sure they
NULL the freed sk object on error from the socket, we can't guarantee
future protocols will not make the same mistake.
So it is easier to just explicitly NULL the sk pointer upon return from
pf->create in \_\_sock\_create. We do know that pf->create always releases the
allocated sk object on error, so if the pointer is not NULL, it is
definitely dangling.
Fixes: 6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket creation fails")
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241003170151.69445-1-ignat@cloudflare.com](https://patch.msgid.link/20241003170151.69445-1-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=563e6892e21d6ecabdf62103fc4e7b326d212334)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=563e6892e21d6ecabdf62103fc4e7b326d212334) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/socket.c b/net/socket.cindex 9db33cd4a71b89..bad58f23f30722 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=31c62224e91c2af9fce4588db6e2f415b022154b)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=563e6892e21d6ecabdf62103fc4e7b326d212334)@@ -1569,8 +1569,13 @@ int \_\_sock\_create(struct net \*net, int family, int type, int protocol, rcu\_read\_unlock();  err = pf->create(net, sock, protocol, kern);- if (err < 0)+ if (err < 0) {+ /\* ->create should release the allocated sock->sk object on error+ \* but it may leave the dangling pointer+ \*/+ sock->sk = NULL; goto out\_module\_put;+ }  /\* \* Now to bump the refcnt of the [loadable] module that owns this |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:03:14 +0000



=== Content from git.kernel.org_20bdc960_20250114_180438.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-03 18:01:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:12:00 +0200 |
| commit | [daf462ff3cde6ecf22b98d9ae770232c10d28de2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)) | |
| tree | [583f71e523d737ebf9db8cdca65e38257f0a99bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2) | |
| parent | [24ab54a066d2ef671b03eb909ca2114c0c9ac1e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24ab54a066d2ef671b03eb909ca2114c0c9ac1e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2&id2=24ab54a066d2ef671b03eb909ca2114c0c9ac1e7)) | |
| download | [linux-daf462ff3cde6ecf22b98d9ae770232c10d28de2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-daf462ff3cde6ecf22b98d9ae770232c10d28de2.tar.gz) | |

net: explicitly clear the sk pointer, when pf->create failscommit 631083143315d1b192bd7d915b967b37819e88ea upstream.
We have recently noticed the exact same KASAN splat as in commit
6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket
creation fails"). The problem is that commit did not fully address the
problem, as some pf->create implementations do not use sk\_common\_release
in their error paths.
For example, we can use the same reproducer as in the above commit, but
changing ping to arping. arping uses AF\_PACKET socket and if packet\_create
fails, it will just sk\_free the allocated sk object.
While we could chase all the pf->create implementations and make sure they
NULL the freed sk object on error from the socket, we can't guarantee
future protocols will not make the same mistake.
So it is easier to just explicitly NULL the sk pointer upon return from
pf->create in \_\_sock\_create. We do know that pf->create always releases the
allocated sk object on error, so if the pointer is not NULL, it is
definitely dangling.
Fixes: 6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket creation fails")
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241003170151.69445-1-ignat@cloudflare.com](https://patch.msgid.link/20241003170151.69445-1-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/socket.c b/net/socket.cindex f7cfc703bd213a..bb2a209e3e28dc 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=24ab54a066d2ef671b03eb909ca2114c0c9ac1e7)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=daf462ff3cde6ecf22b98d9ae770232c10d28de2)@@ -1484,8 +1484,13 @@ int \_\_sock\_create(struct net \*net, int family, int type, int protocol, rcu\_read\_unlock();  err = pf->create(net, sock, protocol, kern);- if (err < 0)+ if (err < 0) {+ /\* ->create should release the allocated sock->sk object on error+ \* but it may leave the dangling pointer+ \*/+ sock->sk = NULL; goto out\_module\_put;+ }  /\* \* Now to bump the refcnt of the [loadable] module that owns this |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:03:16 +0000



=== Content from git.kernel.org_bb58fc84_20250114_180438.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-03 18:01:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:59 +0200 |
| commit | [8e1b72fd74bf9da3b099d09857f4e7f114f38e12](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)) | |
| tree | [0f30ea75bc41cedb9d322041667a5e56f3cc898b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12) | |
| parent | [bbc85a9d48ddc171d05566b3460c4228ca452904](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbc85a9d48ddc171d05566b3460c4228ca452904) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12&id2=bbc85a9d48ddc171d05566b3460c4228ca452904)) | |
| download | [linux-8e1b72fd74bf9da3b099d09857f4e7f114f38e12.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e1b72fd74bf9da3b099d09857f4e7f114f38e12.tar.gz) | |

net: explicitly clear the sk pointer, when pf->create failscommit 631083143315d1b192bd7d915b967b37819e88ea upstream.
We have recently noticed the exact same KASAN splat as in commit
6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket
creation fails"). The problem is that commit did not fully address the
problem, as some pf->create implementations do not use sk\_common\_release
in their error paths.
For example, we can use the same reproducer as in the above commit, but
changing ping to arping. arping uses AF\_PACKET socket and if packet\_create
fails, it will just sk\_free the allocated sk object.
While we could chase all the pf->create implementations and make sure they
NULL the freed sk object on error from the socket, we can't guarantee
future protocols will not make the same mistake.
So it is easier to just explicitly NULL the sk pointer upon return from
pf->create in \_\_sock\_create. We do know that pf->create always releases the
allocated sk object on error, so if the pointer is not NULL, it is
definitely dangling.
Fixes: 6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket creation fails")
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241003170151.69445-1-ignat@cloudflare.com](https://patch.msgid.link/20241003170151.69445-1-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/socket.c b/net/socket.cindex 0a2bd22ec105c8..87fc3c6047bc8b 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=bbc85a9d48ddc171d05566b3460c4228ca452904)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=8e1b72fd74bf9da3b099d09857f4e7f114f38e12)@@ -1569,8 +1569,13 @@ int \_\_sock\_create(struct net \*net, int family, int type, int protocol, rcu\_read\_unlock();  err = pf->create(net, sock, protocol, kern);- if (err < 0)+ if (err < 0) {+ /\* ->create should release the allocated sock->sk object on error+ \* but it may leave the dangling pointer+ \*/+ sock->sk = NULL; goto out\_module\_put;+ }  /\* \* Now to bump the refcnt of the [loadable] module that owns this |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:03:15 +0000



=== Content from git.kernel.org_c3f8b462_20250114_180437.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=631083143315d1b192bd7d915b967b37819e88ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=631083143315d1b192bd7d915b967b37819e88ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=631083143315d1b192bd7d915b967b37819e88ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=631083143315d1b192bd7d915b967b37819e88ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-03 18:01:51 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-07 16:21:59 -0700 |
| commit | [631083143315d1b192bd7d915b967b37819e88ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=631083143315d1b192bd7d915b967b37819e88ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=631083143315d1b192bd7d915b967b37819e88ea)) | |
| tree | [4692a7e243fbfe71a2ac95a4951886204c1948ee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=631083143315d1b192bd7d915b967b37819e88ea) | |
| parent | [9234a2549cb6ac038bec36cc7c084218e9575513](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9234a2549cb6ac038bec36cc7c084218e9575513) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=631083143315d1b192bd7d915b967b37819e88ea&id2=9234a2549cb6ac038bec36cc7c084218e9575513)) | |
| download | [linux-631083143315d1b192bd7d915b967b37819e88ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-631083143315d1b192bd7d915b967b37819e88ea.tar.gz) | |

net: explicitly clear the sk pointer, when pf->create failsWe have recently noticed the exact same KASAN splat as in commit
6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket
creation fails"). The problem is that commit did not fully address the
problem, as some pf->create implementations do not use sk\_common\_release
in their error paths.
For example, we can use the same reproducer as in the above commit, but
changing ping to arping. arping uses AF\_PACKET socket and if packet\_create
fails, it will just sk\_free the allocated sk object.
While we could chase all the pf->create implementations and make sure they
NULL the freed sk object on error from the socket, we can't guarantee
future protocols will not make the same mistake.
So it is easier to just explicitly NULL the sk pointer upon return from
pf->create in \_\_sock\_create. We do know that pf->create always releases the
allocated sk object on error, so if the pointer is not NULL, it is
definitely dangling.
Fixes: 6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket creation fails")
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241003170151.69445-1-ignat@cloudflare.com](https://patch.msgid.link/20241003170151.69445-1-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=631083143315d1b192bd7d915b967b37819e88ea)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=631083143315d1b192bd7d915b967b37819e88ea) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/socket.c b/net/socket.cindex 601ad74930efb0..042451f01c6520 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=9234a2549cb6ac038bec36cc7c084218e9575513)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=631083143315d1b192bd7d915b967b37819e88ea)@@ -1574,8 +1574,13 @@ int \_\_sock\_create(struct net \*net, int family, int type, int protocol, rcu\_read\_unlock();  err = pf->create(net, sock, protocol, kern);- if (err < 0)+ if (err < 0) {+ /\* ->create should release the allocated sock->sk object on error+ \* but it may leave the dangling pointer+ \*/+ sock->sk = NULL; goto out\_module\_put;+ }  /\* \* Now to bump the refcnt of the [loadable] module that owns this |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:03:14 +0000



=== Content from git.kernel.org_88741873_20250114_180438.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-03 18:01:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:27 +0200 |
| commit | [b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)) | |
| tree | [178f7e667253cf12a8596a000574e398b28e262d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f) | |
| parent | [cd2b08a6de2bd4fef048068befd6d45200119cf4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd2b08a6de2bd4fef048068befd6d45200119cf4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f&id2=cd2b08a6de2bd4fef048068befd6d45200119cf4)) | |
| download | [linux-b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f.tar.gz) | |

net: explicitly clear the sk pointer, when pf->create failscommit 631083143315d1b192bd7d915b967b37819e88ea upstream.
We have recently noticed the exact same KASAN splat as in commit
6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket
creation fails"). The problem is that commit did not fully address the
problem, as some pf->create implementations do not use sk\_common\_release
in their error paths.
For example, we can use the same reproducer as in the above commit, but
changing ping to arping. arping uses AF\_PACKET socket and if packet\_create
fails, it will just sk\_free the allocated sk object.
While we could chase all the pf->create implementations and make sure they
NULL the freed sk object on error from the socket, we can't guarantee
future protocols will not make the same mistake.
So it is easier to just explicitly NULL the sk pointer upon return from
pf->create in \_\_sock\_create. We do know that pf->create always releases the
allocated sk object on error, so if the pointer is not NULL, it is
definitely dangling.
Fixes: 6cd4a78d962b ("net: do not leave a dangling sk pointer, when socket creation fails")
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Cc: stable@vger.kernel.org
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241003170151.69445-1-ignat@cloudflare.com](https://patch.msgid.link/20241003170151.69445-1-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/socket.c b/net/socket.cindex 639d76f20384e6..bd438b89e698e8 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=cd2b08a6de2bd4fef048068befd6d45200119cf4)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=b7d22a79ff4e962b8af5ffe623abd1d6c179eb9f)@@ -1548,8 +1548,13 @@ int \_\_sock\_create(struct net \*net, int family, int type, int protocol, rcu\_read\_unlock();  err = pf->create(net, sock, protocol, kern);- if (err < 0)+ if (err < 0) {+ /\* ->create should release the allocated sock->sk object on error+ \* but it may leave the dangling pointer+ \*/+ sock->sk = NULL; goto out\_module\_put;+ }  /\* \* Now to bump the refcnt of the [loadable] module that owns this |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:03:15 +0000


