=== Content from git.kernel.org_193928a9_20250114_212851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=49454f09936a9a96edfb047156889879cb4001eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49454f09936a9a96edfb047156889879cb4001eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49454f09936a9a96edfb047156889879cb4001eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49454f09936a9a96edfb047156889879cb4001eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-09-11 10:41:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:17 +0100 |
| commit | [49454f09936a9a96edfb047156889879cb4001eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49454f09936a9a96edfb047156889879cb4001eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=49454f09936a9a96edfb047156889879cb4001eb)) | |
| tree | [997ee3365112065112bf585294a79c71ab7d01bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49454f09936a9a96edfb047156889879cb4001eb) | |
| parent | [0fca5ed4be8e8bfbfb9bd97845af596bab7192d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49454f09936a9a96edfb047156889879cb4001eb&id2=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)) | |
| download | [linux-49454f09936a9a96edfb047156889879cb4001eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-49454f09936a9a96edfb047156889879cb4001eb.tar.gz) | |

bpf: devmap: provide rxq after redirect[ Upstream commit ca9984c5f0ab3690d98b13937b2485a978c8dd73 ]
rxq contains a pointer to the device from where
the redirect happened. Currently, the BPF program
that was executed after a redirect via BPF\_MAP\_TYPE\_DEVMAP\*
does not have it set.
This is particularly bad since accessing ingress\_ifindex, e.g.
SEC("xdp")
int prog(struct xdp\_md \*pkt)
{
return bpf\_redirect\_map(&dev\_redirect\_map, 0, 0);
}
SEC("xdp/devmap")
int prog\_after\_redirect(struct xdp\_md \*pkt)
{
bpf\_printk("ifindex %i", pkt->ingress\_ifindex);
return XDP\_PASS;
}
depends on access to rxq, so a NULL pointer gets dereferenced:
<1>[ 574.475170] BUG: kernel NULL pointer dereference, address: 0000000000000000
<1>[ 574.475188] #PF: supervisor read access in kernel mode
<1>[ 574.475194] #PF: error\_code(0x0000) - not-present page
<6>[ 574.475199] PGD 0 P4D 0
<4>[ 574.475207] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4>[ 574.475217] CPU: 4 UID: 0 PID: 217 Comm: kworker/4:1 Not tainted 6.11.0-rc5-reduced-00859-g780801200300 #23
<4>[ 574.475226] Hardware name: Intel(R) Client Systems NUC13ANHi7/NUC13ANBi7, BIOS ANRPL357.0026.2023.0314.1458 03/14/2023
<4>[ 574.475231] Workqueue: mld mld\_ifc\_work
<4>[ 574.475247] RIP: 0010:bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475257] Code: cc cc cc cc cc cc cc 80 00 00 00 cc cc cc cc cc cc cc cc f3 0f 1e fa 0f 1f 44 00 00 66 90 55 48 89 e5 f3 0f 1e fa 48 8b 57 20 <48> 8b 52 00 8b 92 e0 00 00 00 48 bf f8 a6 d5 c4 5d a0 ff ff be 0b
<4>[ 574.475263] RSP: 0018:ffffa62440280c98 EFLAGS: 00010206
<4>[ 574.475269] RAX: ffffa62440280cd8 RBX: 0000000000000001 RCX: 0000000000000000
<4>[ 574.475274] RDX: 0000000000000000 RSI: ffffa62440549048 RDI: ffffa62440280ce0
<4>[ 574.475278] RBP: ffffa62440280c98 R08: 0000000000000002 R09: 0000000000000001
<4>[ 574.475281] R10: ffffa05dc8b98000 R11: ffffa05f577fca40 R12: ffffa05dcab24000
<4>[ 574.475285] R13: ffffa62440280ce0 R14: ffffa62440549048 R15: ffffa62440549000
<4>[ 574.475289] FS: 0000000000000000(0000) GS:ffffa05f4f700000(0000) knlGS:0000000000000000
<4>[ 574.475294] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4>[ 574.475298] CR2: 0000000000000000 CR3: 000000025522e000 CR4: 0000000000f50ef0
<4>[ 574.475303] PKRU: 55555554
<4>[ 574.475306] Call Trace:
<4>[ 574.475313] <IRQ>
<4>[ 574.475318] ? \_\_die+0x23/0x70
<4>[ 574.475329] ? page\_fault\_oops+0x180/0x4c0
<4>[ 574.475339] ? skb\_pp\_cow\_data+0x34c/0x490
<4>[ 574.475346] ? kmem\_cache\_free+0x257/0x280
<4>[ 574.475357] ? exc\_page\_fault+0x67/0x150
<4>[ 574.475368] ? asm\_exc\_page\_fault+0x26/0x30
<4>[ 574.475381] ? bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475386] bq\_xmit\_all+0x158/0x420
<4>[ 574.475397] \_\_dev\_flush+0x30/0x90
<4>[ 574.475407] veth\_poll+0x216/0x250 [veth]
<4>[ 574.475421] \_\_napi\_poll+0x28/0x1c0
<4>[ 574.475430] net\_rx\_action+0x32d/0x3a0
<4>[ 574.475441] handle\_softirqs+0xcb/0x2c0
<4>[ 574.475451] do\_softirq+0x40/0x60
<4>[ 574.475458] </IRQ>
<4>[ 574.475461] <TASK>
<4>[ 574.475464] \_\_local\_bh\_enable\_ip+0x66/0x70
<4>[ 574.475471] \_\_dev\_queue\_xmit+0x268/0xe40
<4>[ 574.475480] ? selinux\_ip\_postroute+0x213/0x420
<4>[ 574.475491] ? alloc\_skb\_with\_frags+0x4a/0x1d0
<4>[ 574.475502] ip6\_finish\_output2+0x2be/0x640
<4>[ 574.475512] ? nf\_hook\_slow+0x42/0xf0
<4>[ 574.475521] ip6\_finish\_output+0x194/0x300
<4>[ 574.475529] ? \_\_pfx\_ip6\_finish\_output+0x10/0x10
<4>[ 574.475538] mld\_sendpack+0x17c/0x240
<4>[ 574.475548] mld\_ifc\_work+0x192/0x410
<4>[ 574.475557] process\_one\_work+0x15d/0x380
<4>[ 574.475566] worker\_thread+0x29d/0x3a0
<4>[ 574.475573] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475580] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475587] kthread+0xcd/0x100
<4>[ 574.475597] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475606] ret\_from\_fork+0x31/0x50
<4>[ 574.475615] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475623] ret\_from\_fork\_asm+0x1a/0x30
<4>[ 574.475635] </TASK>
<4>[ 574.475637] Modules linked in: veth br\_netfilter bridge stp llc iwlmvm x86\_pkg\_temp\_thermal iwlwifi efivarfs nvme nvme\_core
<4>[ 574.475662] CR2: 0000000000000000
<4>[ 574.475668] ---[ end trace 0000000000000000 ]---
Therefore, provide it to the program by setting rxq properly.
Fixes: cb261b594b41 ("bpf: Run devmap xdp\_prog on flush instead of bulk enqueue")
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Acked-by: Jakub Kicinski <kuba@kernel.org>
Link: [https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258@linutronix.de](https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258%40linutronix.de)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49454f09936a9a96edfb047156889879cb4001eb)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=49454f09936a9a96edfb047156889879cb4001eb) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 69e78dc4bb18e8..96b0345f76c2ce 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=49454f09936a9a96edfb047156889879cb4001eb)@@ -322,9 +322,11 @@ static int dev\_map\_hash\_get\_next\_key(struct bpf\_map \*map, void \*key,  static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, struct xdp\_frame \*\*frames, int n,- struct net\_device \*dev)+ struct net\_device \*tx\_dev,+ struct net\_device \*rx\_dev) {- struct xdp\_txq\_info txq = { .dev = dev };+ struct xdp\_txq\_info txq = { .dev = tx\_dev };+ struct xdp\_rxq\_info rxq = { .dev = rx\_dev }; struct xdp\_buff xdp; int i, nframes = 0; @@ -335,6 +337,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog,  xdp\_convert\_frame\_to\_buff(xdpf, &xdp); xdp.txq = &txq;+ xdp.rxq = &rxq;  act = bpf\_prog\_run\_xdp(xdp\_prog, &xdp); switch (act) {@@ -349,7 +352,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, bpf\_warn\_invalid\_xdp\_action(NULL, xdp\_prog, act); fallthrough; case XDP\_ABORTED:- trace\_xdp\_exception(dev, xdp\_prog, act);+ trace\_xdp\_exception(tx\_dev, xdp\_prog, act); fallthrough; case XDP\_DROP: xdp\_return\_frame\_rx\_napi(xdpf);@@ -377,7 +380,7 @@ static void bq\_xmit\_all(struct xdp\_dev\_bulk\_queue \*bq, u32 flags) }  if (bq->xdp\_prog) {- to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev);+ to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev, bq->dev\_rx); if (!to\_send) goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:27:28 +0000



=== Content from git.kernel.org_46e0a59e_20250114_212852.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-09-11 10:41:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:23 +0100 |
| commit | [9167d1c274a336e4763eeb3f3f9cb763c55df5aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)) | |
| tree | [cb2013b3a779cb52c7752b905f2907f15bed3360](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa) | |
| parent | [7151d64cf34a88a8c27296f8d36bdce982e407a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7151d64cf34a88a8c27296f8d36bdce982e407a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa&id2=7151d64cf34a88a8c27296f8d36bdce982e407a1)) | |
| download | [linux-9167d1c274a336e4763eeb3f3f9cb763c55df5aa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9167d1c274a336e4763eeb3f3f9cb763c55df5aa.tar.gz) | |

bpf: devmap: provide rxq after redirect[ Upstream commit ca9984c5f0ab3690d98b13937b2485a978c8dd73 ]
rxq contains a pointer to the device from where
the redirect happened. Currently, the BPF program
that was executed after a redirect via BPF\_MAP\_TYPE\_DEVMAP\*
does not have it set.
This is particularly bad since accessing ingress\_ifindex, e.g.
SEC("xdp")
int prog(struct xdp\_md \*pkt)
{
return bpf\_redirect\_map(&dev\_redirect\_map, 0, 0);
}
SEC("xdp/devmap")
int prog\_after\_redirect(struct xdp\_md \*pkt)
{
bpf\_printk("ifindex %i", pkt->ingress\_ifindex);
return XDP\_PASS;
}
depends on access to rxq, so a NULL pointer gets dereferenced:
<1>[ 574.475170] BUG: kernel NULL pointer dereference, address: 0000000000000000
<1>[ 574.475188] #PF: supervisor read access in kernel mode
<1>[ 574.475194] #PF: error\_code(0x0000) - not-present page
<6>[ 574.475199] PGD 0 P4D 0
<4>[ 574.475207] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4>[ 574.475217] CPU: 4 UID: 0 PID: 217 Comm: kworker/4:1 Not tainted 6.11.0-rc5-reduced-00859-g780801200300 #23
<4>[ 574.475226] Hardware name: Intel(R) Client Systems NUC13ANHi7/NUC13ANBi7, BIOS ANRPL357.0026.2023.0314.1458 03/14/2023
<4>[ 574.475231] Workqueue: mld mld\_ifc\_work
<4>[ 574.475247] RIP: 0010:bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475257] Code: cc cc cc cc cc cc cc 80 00 00 00 cc cc cc cc cc cc cc cc f3 0f 1e fa 0f 1f 44 00 00 66 90 55 48 89 e5 f3 0f 1e fa 48 8b 57 20 <48> 8b 52 00 8b 92 e0 00 00 00 48 bf f8 a6 d5 c4 5d a0 ff ff be 0b
<4>[ 574.475263] RSP: 0018:ffffa62440280c98 EFLAGS: 00010206
<4>[ 574.475269] RAX: ffffa62440280cd8 RBX: 0000000000000001 RCX: 0000000000000000
<4>[ 574.475274] RDX: 0000000000000000 RSI: ffffa62440549048 RDI: ffffa62440280ce0
<4>[ 574.475278] RBP: ffffa62440280c98 R08: 0000000000000002 R09: 0000000000000001
<4>[ 574.475281] R10: ffffa05dc8b98000 R11: ffffa05f577fca40 R12: ffffa05dcab24000
<4>[ 574.475285] R13: ffffa62440280ce0 R14: ffffa62440549048 R15: ffffa62440549000
<4>[ 574.475289] FS: 0000000000000000(0000) GS:ffffa05f4f700000(0000) knlGS:0000000000000000
<4>[ 574.475294] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4>[ 574.475298] CR2: 0000000000000000 CR3: 000000025522e000 CR4: 0000000000f50ef0
<4>[ 574.475303] PKRU: 55555554
<4>[ 574.475306] Call Trace:
<4>[ 574.475313] <IRQ>
<4>[ 574.475318] ? \_\_die+0x23/0x70
<4>[ 574.475329] ? page\_fault\_oops+0x180/0x4c0
<4>[ 574.475339] ? skb\_pp\_cow\_data+0x34c/0x490
<4>[ 574.475346] ? kmem\_cache\_free+0x257/0x280
<4>[ 574.475357] ? exc\_page\_fault+0x67/0x150
<4>[ 574.475368] ? asm\_exc\_page\_fault+0x26/0x30
<4>[ 574.475381] ? bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475386] bq\_xmit\_all+0x158/0x420
<4>[ 574.475397] \_\_dev\_flush+0x30/0x90
<4>[ 574.475407] veth\_poll+0x216/0x250 [veth]
<4>[ 574.475421] \_\_napi\_poll+0x28/0x1c0
<4>[ 574.475430] net\_rx\_action+0x32d/0x3a0
<4>[ 574.475441] handle\_softirqs+0xcb/0x2c0
<4>[ 574.475451] do\_softirq+0x40/0x60
<4>[ 574.475458] </IRQ>
<4>[ 574.475461] <TASK>
<4>[ 574.475464] \_\_local\_bh\_enable\_ip+0x66/0x70
<4>[ 574.475471] \_\_dev\_queue\_xmit+0x268/0xe40
<4>[ 574.475480] ? selinux\_ip\_postroute+0x213/0x420
<4>[ 574.475491] ? alloc\_skb\_with\_frags+0x4a/0x1d0
<4>[ 574.475502] ip6\_finish\_output2+0x2be/0x640
<4>[ 574.475512] ? nf\_hook\_slow+0x42/0xf0
<4>[ 574.475521] ip6\_finish\_output+0x194/0x300
<4>[ 574.475529] ? \_\_pfx\_ip6\_finish\_output+0x10/0x10
<4>[ 574.475538] mld\_sendpack+0x17c/0x240
<4>[ 574.475548] mld\_ifc\_work+0x192/0x410
<4>[ 574.475557] process\_one\_work+0x15d/0x380
<4>[ 574.475566] worker\_thread+0x29d/0x3a0
<4>[ 574.475573] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475580] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475587] kthread+0xcd/0x100
<4>[ 574.475597] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475606] ret\_from\_fork+0x31/0x50
<4>[ 574.475615] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475623] ret\_from\_fork\_asm+0x1a/0x30
<4>[ 574.475635] </TASK>
<4>[ 574.475637] Modules linked in: veth br\_netfilter bridge stp llc iwlmvm x86\_pkg\_temp\_thermal iwlwifi efivarfs nvme nvme\_core
<4>[ 574.475662] CR2: 0000000000000000
<4>[ 574.475668] ---[ end trace 0000000000000000 ]---
Therefore, provide it to the program by setting rxq properly.
Fixes: cb261b594b41 ("bpf: Run devmap xdp\_prog on flush instead of bulk enqueue")
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Acked-by: Jakub Kicinski <kuba@kernel.org>
Link: [https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258@linutronix.de](https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258%40linutronix.de)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 9e0e3b0a18e406..7878be18e9d264 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=7151d64cf34a88a8c27296f8d36bdce982e407a1)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=9167d1c274a336e4763eeb3f3f9cb763c55df5aa)@@ -333,9 +333,11 @@ static int dev\_map\_hash\_get\_next\_key(struct bpf\_map \*map, void \*key,  static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, struct xdp\_frame \*\*frames, int n,- struct net\_device \*dev)+ struct net\_device \*tx\_dev,+ struct net\_device \*rx\_dev) {- struct xdp\_txq\_info txq = { .dev = dev };+ struct xdp\_txq\_info txq = { .dev = tx\_dev };+ struct xdp\_rxq\_info rxq = { .dev = rx\_dev }; struct xdp\_buff xdp; int i, nframes = 0; @@ -346,6 +348,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog,  xdp\_convert\_frame\_to\_buff(xdpf, &xdp); xdp.txq = &txq;+ xdp.rxq = &rxq;  act = bpf\_prog\_run\_xdp(xdp\_prog, &xdp); switch (act) {@@ -360,7 +363,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, bpf\_warn\_invalid\_xdp\_action(NULL, xdp\_prog, act); fallthrough; case XDP\_ABORTED:- trace\_xdp\_exception(dev, xdp\_prog, act);+ trace\_xdp\_exception(tx\_dev, xdp\_prog, act); fallthrough; case XDP\_DROP: xdp\_return\_frame\_rx\_napi(xdpf);@@ -388,7 +391,7 @@ static void bq\_xmit\_all(struct xdp\_dev\_bulk\_queue \*bq, u32 flags) }  if (bq->xdp\_prog) {- to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev);+ to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev, bq->dev\_rx); if (!to\_send) goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:27:29 +0000



=== Content from git.kernel.org_35f3e85f_20250114_212853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-09-11 10:41:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:55:56 +0100 |
| commit | [a778fbe087c19f4ece5f5fc14173328f070c3803](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a778fbe087c19f4ece5f5fc14173328f070c3803) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)) | |
| tree | [69da829e7d99eaa660ff2d67c2e8ff102620ee2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a778fbe087c19f4ece5f5fc14173328f070c3803) | |
| parent | [314dbee9fe4f5cee36435465de52c988d7caa466](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=314dbee9fe4f5cee36435465de52c988d7caa466) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a778fbe087c19f4ece5f5fc14173328f070c3803&id2=314dbee9fe4f5cee36435465de52c988d7caa466)) | |
| download | [linux-a778fbe087c19f4ece5f5fc14173328f070c3803.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a778fbe087c19f4ece5f5fc14173328f070c3803.tar.gz) | |

bpf: devmap: provide rxq after redirect[ Upstream commit ca9984c5f0ab3690d98b13937b2485a978c8dd73 ]
rxq contains a pointer to the device from where
the redirect happened. Currently, the BPF program
that was executed after a redirect via BPF\_MAP\_TYPE\_DEVMAP\*
does not have it set.
This is particularly bad since accessing ingress\_ifindex, e.g.
SEC("xdp")
int prog(struct xdp\_md \*pkt)
{
return bpf\_redirect\_map(&dev\_redirect\_map, 0, 0);
}
SEC("xdp/devmap")
int prog\_after\_redirect(struct xdp\_md \*pkt)
{
bpf\_printk("ifindex %i", pkt->ingress\_ifindex);
return XDP\_PASS;
}
depends on access to rxq, so a NULL pointer gets dereferenced:
<1>[ 574.475170] BUG: kernel NULL pointer dereference, address: 0000000000000000
<1>[ 574.475188] #PF: supervisor read access in kernel mode
<1>[ 574.475194] #PF: error\_code(0x0000) - not-present page
<6>[ 574.475199] PGD 0 P4D 0
<4>[ 574.475207] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4>[ 574.475217] CPU: 4 UID: 0 PID: 217 Comm: kworker/4:1 Not tainted 6.11.0-rc5-reduced-00859-g780801200300 #23
<4>[ 574.475226] Hardware name: Intel(R) Client Systems NUC13ANHi7/NUC13ANBi7, BIOS ANRPL357.0026.2023.0314.1458 03/14/2023
<4>[ 574.475231] Workqueue: mld mld\_ifc\_work
<4>[ 574.475247] RIP: 0010:bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475257] Code: cc cc cc cc cc cc cc 80 00 00 00 cc cc cc cc cc cc cc cc f3 0f 1e fa 0f 1f 44 00 00 66 90 55 48 89 e5 f3 0f 1e fa 48 8b 57 20 <48> 8b 52 00 8b 92 e0 00 00 00 48 bf f8 a6 d5 c4 5d a0 ff ff be 0b
<4>[ 574.475263] RSP: 0018:ffffa62440280c98 EFLAGS: 00010206
<4>[ 574.475269] RAX: ffffa62440280cd8 RBX: 0000000000000001 RCX: 0000000000000000
<4>[ 574.475274] RDX: 0000000000000000 RSI: ffffa62440549048 RDI: ffffa62440280ce0
<4>[ 574.475278] RBP: ffffa62440280c98 R08: 0000000000000002 R09: 0000000000000001
<4>[ 574.475281] R10: ffffa05dc8b98000 R11: ffffa05f577fca40 R12: ffffa05dcab24000
<4>[ 574.475285] R13: ffffa62440280ce0 R14: ffffa62440549048 R15: ffffa62440549000
<4>[ 574.475289] FS: 0000000000000000(0000) GS:ffffa05f4f700000(0000) knlGS:0000000000000000
<4>[ 574.475294] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4>[ 574.475298] CR2: 0000000000000000 CR3: 000000025522e000 CR4: 0000000000f50ef0
<4>[ 574.475303] PKRU: 55555554
<4>[ 574.475306] Call Trace:
<4>[ 574.475313] <IRQ>
<4>[ 574.475318] ? \_\_die+0x23/0x70
<4>[ 574.475329] ? page\_fault\_oops+0x180/0x4c0
<4>[ 574.475339] ? skb\_pp\_cow\_data+0x34c/0x490
<4>[ 574.475346] ? kmem\_cache\_free+0x257/0x280
<4>[ 574.475357] ? exc\_page\_fault+0x67/0x150
<4>[ 574.475368] ? asm\_exc\_page\_fault+0x26/0x30
<4>[ 574.475381] ? bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475386] bq\_xmit\_all+0x158/0x420
<4>[ 574.475397] \_\_dev\_flush+0x30/0x90
<4>[ 574.475407] veth\_poll+0x216/0x250 [veth]
<4>[ 574.475421] \_\_napi\_poll+0x28/0x1c0
<4>[ 574.475430] net\_rx\_action+0x32d/0x3a0
<4>[ 574.475441] handle\_softirqs+0xcb/0x2c0
<4>[ 574.475451] do\_softirq+0x40/0x60
<4>[ 574.475458] </IRQ>
<4>[ 574.475461] <TASK>
<4>[ 574.475464] \_\_local\_bh\_enable\_ip+0x66/0x70
<4>[ 574.475471] \_\_dev\_queue\_xmit+0x268/0xe40
<4>[ 574.475480] ? selinux\_ip\_postroute+0x213/0x420
<4>[ 574.475491] ? alloc\_skb\_with\_frags+0x4a/0x1d0
<4>[ 574.475502] ip6\_finish\_output2+0x2be/0x640
<4>[ 574.475512] ? nf\_hook\_slow+0x42/0xf0
<4>[ 574.475521] ip6\_finish\_output+0x194/0x300
<4>[ 574.475529] ? \_\_pfx\_ip6\_finish\_output+0x10/0x10
<4>[ 574.475538] mld\_sendpack+0x17c/0x240
<4>[ 574.475548] mld\_ifc\_work+0x192/0x410
<4>[ 574.475557] process\_one\_work+0x15d/0x380
<4>[ 574.475566] worker\_thread+0x29d/0x3a0
<4>[ 574.475573] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475580] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475587] kthread+0xcd/0x100
<4>[ 574.475597] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475606] ret\_from\_fork+0x31/0x50
<4>[ 574.475615] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475623] ret\_from\_fork\_asm+0x1a/0x30
<4>[ 574.475635] </TASK>
<4>[ 574.475637] Modules linked in: veth br\_netfilter bridge stp llc iwlmvm x86\_pkg\_temp\_thermal iwlwifi efivarfs nvme nvme\_core
<4>[ 574.475662] CR2: 0000000000000000
<4>[ 574.475668] ---[ end trace 0000000000000000 ]---
Therefore, provide it to the program by setting rxq properly.
Fixes: cb261b594b41 ("bpf: Run devmap xdp\_prog on flush instead of bulk enqueue")
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Acked-by: Jakub Kicinski <kuba@kernel.org>
Link: [https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258@linutronix.de](https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258%40linutronix.de)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a778fbe087c19f4ece5f5fc14173328f070c3803)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=a778fbe087c19f4ece5f5fc14173328f070c3803) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex e051cbb07dac02..9699c30c3dc43d 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=314dbee9fe4f5cee36435465de52c988d7caa466)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=a778fbe087c19f4ece5f5fc14173328f070c3803)@@ -326,9 +326,11 @@ static int dev\_map\_hash\_get\_next\_key(struct bpf\_map \*map, void \*key,  static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, struct xdp\_frame \*\*frames, int n,- struct net\_device \*dev)+ struct net\_device \*tx\_dev,+ struct net\_device \*rx\_dev) {- struct xdp\_txq\_info txq = { .dev = dev };+ struct xdp\_txq\_info txq = { .dev = tx\_dev };+ struct xdp\_rxq\_info rxq = { .dev = rx\_dev }; struct xdp\_buff xdp; int i, nframes = 0; @@ -339,6 +341,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog,  xdp\_convert\_frame\_to\_buff(xdpf, &xdp); xdp.txq = &txq;+ xdp.rxq = &rxq;  act = bpf\_prog\_run\_xdp(xdp\_prog, &xdp); switch (act) {@@ -353,7 +356,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, bpf\_warn\_invalid\_xdp\_action(NULL, xdp\_prog, act); fallthrough; case XDP\_ABORTED:- trace\_xdp\_exception(dev, xdp\_prog, act);+ trace\_xdp\_exception(tx\_dev, xdp\_prog, act); fallthrough; case XDP\_DROP: xdp\_return\_frame\_rx\_napi(xdpf);@@ -381,7 +384,7 @@ static void bq\_xmit\_all(struct xdp\_dev\_bulk\_queue \*bq, u32 flags) }  if (bq->xdp\_prog) {- to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev);+ to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev, bq->dev\_rx); if (!to\_send) goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:27:30 +0000



=== Content from git.kernel.org_fb719920_20250114_212854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe068afb868660fe683a8391c6c17ecbe2254922)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe068afb868660fe683a8391c6c17ecbe2254922)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe068afb868660fe683a8391c6c17ecbe2254922)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe068afb868660fe683a8391c6c17ecbe2254922)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-09-11 10:41:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:31 +0100 |
| commit | [fe068afb868660fe683a8391c6c17ecbe2254922](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe068afb868660fe683a8391c6c17ecbe2254922) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe068afb868660fe683a8391c6c17ecbe2254922)) | |
| tree | [ead150ca78806e2d5829a13612a791e0d8cced89](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe068afb868660fe683a8391c6c17ecbe2254922) | |
| parent | [4e1e428533845d48828bd3875c0e92e8565b9962](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e1e428533845d48828bd3875c0e92e8565b9962) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe068afb868660fe683a8391c6c17ecbe2254922&id2=4e1e428533845d48828bd3875c0e92e8565b9962)) | |
| download | [linux-fe068afb868660fe683a8391c6c17ecbe2254922.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe068afb868660fe683a8391c6c17ecbe2254922.tar.gz) | |

bpf: devmap: provide rxq after redirect[ Upstream commit ca9984c5f0ab3690d98b13937b2485a978c8dd73 ]
rxq contains a pointer to the device from where
the redirect happened. Currently, the BPF program
that was executed after a redirect via BPF\_MAP\_TYPE\_DEVMAP\*
does not have it set.
This is particularly bad since accessing ingress\_ifindex, e.g.
SEC("xdp")
int prog(struct xdp\_md \*pkt)
{
return bpf\_redirect\_map(&dev\_redirect\_map, 0, 0);
}
SEC("xdp/devmap")
int prog\_after\_redirect(struct xdp\_md \*pkt)
{
bpf\_printk("ifindex %i", pkt->ingress\_ifindex);
return XDP\_PASS;
}
depends on access to rxq, so a NULL pointer gets dereferenced:
<1>[ 574.475170] BUG: kernel NULL pointer dereference, address: 0000000000000000
<1>[ 574.475188] #PF: supervisor read access in kernel mode
<1>[ 574.475194] #PF: error\_code(0x0000) - not-present page
<6>[ 574.475199] PGD 0 P4D 0
<4>[ 574.475207] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4>[ 574.475217] CPU: 4 UID: 0 PID: 217 Comm: kworker/4:1 Not tainted 6.11.0-rc5-reduced-00859-g780801200300 #23
<4>[ 574.475226] Hardware name: Intel(R) Client Systems NUC13ANHi7/NUC13ANBi7, BIOS ANRPL357.0026.2023.0314.1458 03/14/2023
<4>[ 574.475231] Workqueue: mld mld\_ifc\_work
<4>[ 574.475247] RIP: 0010:bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475257] Code: cc cc cc cc cc cc cc 80 00 00 00 cc cc cc cc cc cc cc cc f3 0f 1e fa 0f 1f 44 00 00 66 90 55 48 89 e5 f3 0f 1e fa 48 8b 57 20 <48> 8b 52 00 8b 92 e0 00 00 00 48 bf f8 a6 d5 c4 5d a0 ff ff be 0b
<4>[ 574.475263] RSP: 0018:ffffa62440280c98 EFLAGS: 00010206
<4>[ 574.475269] RAX: ffffa62440280cd8 RBX: 0000000000000001 RCX: 0000000000000000
<4>[ 574.475274] RDX: 0000000000000000 RSI: ffffa62440549048 RDI: ffffa62440280ce0
<4>[ 574.475278] RBP: ffffa62440280c98 R08: 0000000000000002 R09: 0000000000000001
<4>[ 574.475281] R10: ffffa05dc8b98000 R11: ffffa05f577fca40 R12: ffffa05dcab24000
<4>[ 574.475285] R13: ffffa62440280ce0 R14: ffffa62440549048 R15: ffffa62440549000
<4>[ 574.475289] FS: 0000000000000000(0000) GS:ffffa05f4f700000(0000) knlGS:0000000000000000
<4>[ 574.475294] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4>[ 574.475298] CR2: 0000000000000000 CR3: 000000025522e000 CR4: 0000000000f50ef0
<4>[ 574.475303] PKRU: 55555554
<4>[ 574.475306] Call Trace:
<4>[ 574.475313] <IRQ>
<4>[ 574.475318] ? \_\_die+0x23/0x70
<4>[ 574.475329] ? page\_fault\_oops+0x180/0x4c0
<4>[ 574.475339] ? skb\_pp\_cow\_data+0x34c/0x490
<4>[ 574.475346] ? kmem\_cache\_free+0x257/0x280
<4>[ 574.475357] ? exc\_page\_fault+0x67/0x150
<4>[ 574.475368] ? asm\_exc\_page\_fault+0x26/0x30
<4>[ 574.475381] ? bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475386] bq\_xmit\_all+0x158/0x420
<4>[ 574.475397] \_\_dev\_flush+0x30/0x90
<4>[ 574.475407] veth\_poll+0x216/0x250 [veth]
<4>[ 574.475421] \_\_napi\_poll+0x28/0x1c0
<4>[ 574.475430] net\_rx\_action+0x32d/0x3a0
<4>[ 574.475441] handle\_softirqs+0xcb/0x2c0
<4>[ 574.475451] do\_softirq+0x40/0x60
<4>[ 574.475458] </IRQ>
<4>[ 574.475461] <TASK>
<4>[ 574.475464] \_\_local\_bh\_enable\_ip+0x66/0x70
<4>[ 574.475471] \_\_dev\_queue\_xmit+0x268/0xe40
<4>[ 574.475480] ? selinux\_ip\_postroute+0x213/0x420
<4>[ 574.475491] ? alloc\_skb\_with\_frags+0x4a/0x1d0
<4>[ 574.475502] ip6\_finish\_output2+0x2be/0x640
<4>[ 574.475512] ? nf\_hook\_slow+0x42/0xf0
<4>[ 574.475521] ip6\_finish\_output+0x194/0x300
<4>[ 574.475529] ? \_\_pfx\_ip6\_finish\_output+0x10/0x10
<4>[ 574.475538] mld\_sendpack+0x17c/0x240
<4>[ 574.475548] mld\_ifc\_work+0x192/0x410
<4>[ 574.475557] process\_one\_work+0x15d/0x380
<4>[ 574.475566] worker\_thread+0x29d/0x3a0
<4>[ 574.475573] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475580] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475587] kthread+0xcd/0x100
<4>[ 574.475597] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475606] ret\_from\_fork+0x31/0x50
<4>[ 574.475615] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475623] ret\_from\_fork\_asm+0x1a/0x30
<4>[ 574.475635] </TASK>
<4>[ 574.475637] Modules linked in: veth br\_netfilter bridge stp llc iwlmvm x86\_pkg\_temp\_thermal iwlwifi efivarfs nvme nvme\_core
<4>[ 574.475662] CR2: 0000000000000000
<4>[ 574.475668] ---[ end trace 0000000000000000 ]---
Therefore, provide it to the program by setting rxq properly.
Fixes: cb261b594b41 ("bpf: Run devmap xdp\_prog on flush instead of bulk enqueue")
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Acked-by: Jakub Kicinski <kuba@kernel.org>
Link: [https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258@linutronix.de](https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258%40linutronix.de)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe068afb868660fe683a8391c6c17ecbe2254922)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=fe068afb868660fe683a8391c6c17ecbe2254922) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex bbf3ec03aa5914..4118978951bb40 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=4e1e428533845d48828bd3875c0e92e8565b9962)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=fe068afb868660fe683a8391c6c17ecbe2254922)@@ -325,9 +325,11 @@ static int dev\_map\_hash\_get\_next\_key(struct bpf\_map \*map, void \*key,  static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, struct xdp\_frame \*\*frames, int n,- struct net\_device \*dev)+ struct net\_device \*tx\_dev,+ struct net\_device \*rx\_dev) {- struct xdp\_txq\_info txq = { .dev = dev };+ struct xdp\_txq\_info txq = { .dev = tx\_dev };+ struct xdp\_rxq\_info rxq = { .dev = rx\_dev }; struct xdp\_buff xdp; int i, nframes = 0; @@ -338,6 +340,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog,  xdp\_convert\_frame\_to\_buff(xdpf, &xdp); xdp.txq = &txq;+ xdp.rxq = &rxq;  act = bpf\_prog\_run\_xdp(xdp\_prog, &xdp); switch (act) {@@ -352,7 +355,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, bpf\_warn\_invalid\_xdp\_action(act); fallthrough; case XDP\_ABORTED:- trace\_xdp\_exception(dev, xdp\_prog, act);+ trace\_xdp\_exception(tx\_dev, xdp\_prog, act); fallthrough; case XDP\_DROP: xdp\_return\_frame\_rx\_napi(xdpf);@@ -380,7 +383,7 @@ static void bq\_xmit\_all(struct xdp\_dev\_bulk\_queue \*bq, u32 flags) }  if (bq->xdp\_prog) {- to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev);+ to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev, bq->dev\_rx); if (!to\_send) goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:27:32 +0000



=== Content from git.kernel.org_1cab6173_20250114_212854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-09-11 10:41:18 +0200 |
| --- | --- | --- |
| committer | Martin KaFai Lau <martin.lau@kernel.org> | 2024-10-02 13:48:26 -0700 |
| commit | [ca9984c5f0ab3690d98b13937b2485a978c8dd73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)) | |
| tree | [aa61b8f5a9f50e81d95c213a642435335f9c8836](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73) | |
| parent | [3ed6be68913b2d56a35d30c67f83ba3d2f1998fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ed6be68913b2d56a35d30c67f83ba3d2f1998fc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73&id2=3ed6be68913b2d56a35d30c67f83ba3d2f1998fc)) | |
| download | [linux-ca9984c5f0ab3690d98b13937b2485a978c8dd73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca9984c5f0ab3690d98b13937b2485a978c8dd73.tar.gz) | |

bpf: devmap: provide rxq after redirectrxq contains a pointer to the device from where
the redirect happened. Currently, the BPF program
that was executed after a redirect via BPF\_MAP\_TYPE\_DEVMAP\*
does not have it set.
This is particularly bad since accessing ingress\_ifindex, e.g.
SEC("xdp")
int prog(struct xdp\_md \*pkt)
{
return bpf\_redirect\_map(&dev\_redirect\_map, 0, 0);
}
SEC("xdp/devmap")
int prog\_after\_redirect(struct xdp\_md \*pkt)
{
bpf\_printk("ifindex %i", pkt->ingress\_ifindex);
return XDP\_PASS;
}
depends on access to rxq, so a NULL pointer gets dereferenced:
<1>[ 574.475170] BUG: kernel NULL pointer dereference, address: 0000000000000000
<1>[ 574.475188] #PF: supervisor read access in kernel mode
<1>[ 574.475194] #PF: error\_code(0x0000) - not-present page
<6>[ 574.475199] PGD 0 P4D 0
<4>[ 574.475207] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4>[ 574.475217] CPU: 4 UID: 0 PID: 217 Comm: kworker/4:1 Not tainted 6.11.0-rc5-reduced-00859-g780801200300 #23
<4>[ 574.475226] Hardware name: Intel(R) Client Systems NUC13ANHi7/NUC13ANBi7, BIOS ANRPL357.0026.2023.0314.1458 03/14/2023
<4>[ 574.475231] Workqueue: mld mld\_ifc\_work
<4>[ 574.475247] RIP: 0010:bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475257] Code: cc cc cc cc cc cc cc 80 00 00 00 cc cc cc cc cc cc cc cc f3 0f 1e fa 0f 1f 44 00 00 66 90 55 48 89 e5 f3 0f 1e fa 48 8b 57 20 <48> 8b 52 00 8b 92 e0 00 00 00 48 bf f8 a6 d5 c4 5d a0 ff ff be 0b
<4>[ 574.475263] RSP: 0018:ffffa62440280c98 EFLAGS: 00010206
<4>[ 574.475269] RAX: ffffa62440280cd8 RBX: 0000000000000001 RCX: 0000000000000000
<4>[ 574.475274] RDX: 0000000000000000 RSI: ffffa62440549048 RDI: ffffa62440280ce0
<4>[ 574.475278] RBP: ffffa62440280c98 R08: 0000000000000002 R09: 0000000000000001
<4>[ 574.475281] R10: ffffa05dc8b98000 R11: ffffa05f577fca40 R12: ffffa05dcab24000
<4>[ 574.475285] R13: ffffa62440280ce0 R14: ffffa62440549048 R15: ffffa62440549000
<4>[ 574.475289] FS: 0000000000000000(0000) GS:ffffa05f4f700000(0000) knlGS:0000000000000000
<4>[ 574.475294] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4>[ 574.475298] CR2: 0000000000000000 CR3: 000000025522e000 CR4: 0000000000f50ef0
<4>[ 574.475303] PKRU: 55555554
<4>[ 574.475306] Call Trace:
<4>[ 574.475313] <IRQ>
<4>[ 574.475318] ? \_\_die+0x23/0x70
<4>[ 574.475329] ? page\_fault\_oops+0x180/0x4c0
<4>[ 574.475339] ? skb\_pp\_cow\_data+0x34c/0x490
<4>[ 574.475346] ? kmem\_cache\_free+0x257/0x280
<4>[ 574.475357] ? exc\_page\_fault+0x67/0x150
<4>[ 574.475368] ? asm\_exc\_page\_fault+0x26/0x30
<4>[ 574.475381] ? bpf\_prog\_5e13354d9cf5018a\_prog\_after\_redirect+0x17/0x3c
<4>[ 574.475386] bq\_xmit\_all+0x158/0x420
<4>[ 574.475397] \_\_dev\_flush+0x30/0x90
<4>[ 574.475407] veth\_poll+0x216/0x250 [veth]
<4>[ 574.475421] \_\_napi\_poll+0x28/0x1c0
<4>[ 574.475430] net\_rx\_action+0x32d/0x3a0
<4>[ 574.475441] handle\_softirqs+0xcb/0x2c0
<4>[ 574.475451] do\_softirq+0x40/0x60
<4>[ 574.475458] </IRQ>
<4>[ 574.475461] <TASK>
<4>[ 574.475464] \_\_local\_bh\_enable\_ip+0x66/0x70
<4>[ 574.475471] \_\_dev\_queue\_xmit+0x268/0xe40
<4>[ 574.475480] ? selinux\_ip\_postroute+0x213/0x420
<4>[ 574.475491] ? alloc\_skb\_with\_frags+0x4a/0x1d0
<4>[ 574.475502] ip6\_finish\_output2+0x2be/0x640
<4>[ 574.475512] ? nf\_hook\_slow+0x42/0xf0
<4>[ 574.475521] ip6\_finish\_output+0x194/0x300
<4>[ 574.475529] ? \_\_pfx\_ip6\_finish\_output+0x10/0x10
<4>[ 574.475538] mld\_sendpack+0x17c/0x240
<4>[ 574.475548] mld\_ifc\_work+0x192/0x410
<4>[ 574.475557] process\_one\_work+0x15d/0x380
<4>[ 574.475566] worker\_thread+0x29d/0x3a0
<4>[ 574.475573] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475580] ? \_\_pfx\_worker\_thread+0x10/0x10
<4>[ 574.475587] kthread+0xcd/0x100
<4>[ 574.475597] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475606] ret\_from\_fork+0x31/0x50
<4>[ 574.475615] ? \_\_pfx\_kthread+0x10/0x10
<4>[ 574.475623] ret\_from\_fork\_asm+0x1a/0x30
<4>[ 574.475635] </TASK>
<4>[ 574.475637] Modules linked in: veth br\_netfilter bridge stp llc iwlmvm x86\_pkg\_temp\_thermal iwlwifi efivarfs nvme nvme\_core
<4>[ 574.475662] CR2: 0000000000000000
<4>[ 574.475668] ---[ end trace 0000000000000000 ]---
Therefore, provide it to the program by setting rxq properly.
Fixes: cb261b594b41 ("bpf: Run devmap xdp\_prog on flush instead of bulk enqueue")
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Acked-by: Jakub Kicinski <kuba@kernel.org>
Link: [https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258@linutronix.de](https://lore.kernel.org/r/20240911-devel-koalo-fix-ingress-ifindex-v4-1-5c643ae10258%40linutronix.de)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 9e0e3b0a18e406..7878be18e9d264 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=3ed6be68913b2d56a35d30c67f83ba3d2f1998fc)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=ca9984c5f0ab3690d98b13937b2485a978c8dd73)@@ -333,9 +333,11 @@ static int dev\_map\_hash\_get\_next\_key(struct bpf\_map \*map, void \*key,  static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, struct xdp\_frame \*\*frames, int n,- struct net\_device \*dev)+ struct net\_device \*tx\_dev,+ struct net\_device \*rx\_dev) {- struct xdp\_txq\_info txq = { .dev = dev };+ struct xdp\_txq\_info txq = { .dev = tx\_dev };+ struct xdp\_rxq\_info rxq = { .dev = rx\_dev }; struct xdp\_buff xdp; int i, nframes = 0; @@ -346,6 +348,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog,  xdp\_convert\_frame\_to\_buff(xdpf, &xdp); xdp.txq = &txq;+ xdp.rxq = &rxq;  act = bpf\_prog\_run\_xdp(xdp\_prog, &xdp); switch (act) {@@ -360,7 +363,7 @@ static int dev\_map\_bpf\_prog\_run(struct bpf\_prog \*xdp\_prog, bpf\_warn\_invalid\_xdp\_action(NULL, xdp\_prog, act); fallthrough; case XDP\_ABORTED:- trace\_xdp\_exception(dev, xdp\_prog, act);+ trace\_xdp\_exception(tx\_dev, xdp\_prog, act); fallthrough; case XDP\_DROP: xdp\_return\_frame\_rx\_napi(xdpf);@@ -388,7 +391,7 @@ static void bq\_xmit\_all(struct xdp\_dev\_bulk\_queue \*bq, u32 flags) }  if (bq->xdp\_prog) {- to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev);+ to\_send = dev\_map\_bpf\_prog\_run(bq->xdp\_prog, bq->q, cnt, dev, bq->dev\_rx); if (!to\_send) goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:27:31 +0000


