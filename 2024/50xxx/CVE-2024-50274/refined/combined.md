=== Content from git.kernel.org_a32a58b6_20250114_225708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavan Kumar Linga <pavan.kumar.linga@intel.com> | 2024-10-25 11:38:42 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:10 +0100 |
| commit | [fa4d906ad0fb63a980a1d586a061c78ea1a345ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)) | |
| tree | [744816420b2f45f6073852aa922e263efe2bebf2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) | |
| parent | [2002e4e26e22a2962761444ccff09640d39200fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2002e4e26e22a2962761444ccff09640d39200fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba&id2=2002e4e26e22a2962761444ccff09640d39200fb)) | |
| download | [linux-fa4d906ad0fb63a980a1d586a061c78ea1a345ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa4d906ad0fb63a980a1d586a061c78ea1a345ba.tar.gz) | |

idpf: avoid vport access in idpf\_get\_link\_ksettingscommit 81d2fb4c7c18a3b36ba3e00b9d5b753107472d75 upstream.
When the device control plane is removed or the platform
running device control plane is rebooted, a reset is detected
on the driver. On driver reset, it releases the resources and
waits for the reset to complete. If the reset fails, it takes
the error path and releases the vport lock. At this time if the
monitoring tools tries to access link settings, it call traces
for accessing released vport pointer.
To avoid it, move link\_speed\_mbps to netdev\_priv structure
which removes the dependency on vport pointer and the vport lock
in idpf\_get\_link\_ksettings. Also use netif\_carrier\_ok()
to check the link status and adjust the offsetof to use link\_up
instead of link\_speed\_mbps.
Fixes: 02cbfba1add5 ("idpf: add ethtool callbacks")
Cc: stable@vger.kernel.org # 6.7+
Reviewed-by: Tarun K Singh <tarun.k.singh@intel.com>
Signed-off-by: Pavan Kumar Linga <pavan.kumar.linga@intel.com>
Tested-by: Krishneil Singh <krishneil.k.singh@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)

| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf.h?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 8 insertions, 13 deletions

| diff --git a/drivers/net/ethernet/intel/idpf/idpf.h b/drivers/net/ethernet/intel/idpf/idpf.hindex 2c31ad87587a4a..66544faab710aa 100644--- a/[drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf.h?id=2002e4e26e22a2962761444ccff09640d39200fb)+++ b/[drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf.h?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)@@ -141,6 +141,7 @@ enum idpf\_vport\_state { \* @adapter: Adapter back pointer \* @vport: Vport back pointer \* @vport\_id: Vport identifier+ \* @link\_speed\_mbps: Link speed in mbps \* @vport\_idx: Relative vport index \* @state: See enum idpf\_vport\_state \* @netstats: Packet and byte stats@@ -150,6 +151,7 @@ struct idpf\_netdev\_priv { struct idpf\_adapter \*adapter; struct idpf\_vport \*vport; u32 vport\_id;+ u32 link\_speed\_mbps; u16 vport\_idx; enum idpf\_vport\_state state; struct rtnl\_link\_stats64 netstats;@@ -287,7 +289,6 @@ struct idpf\_port\_stats { \* @tx\_itr\_profile: TX profiles for Dynamic Interrupt Moderation \* @port\_stats: per port csum, header split, and other offload stats \* @link\_up: True if link is up- \* @link\_speed\_mbps: Link speed in mbps \* @sw\_marker\_wq: workqueue for marker packets \*/ struct idpf\_vport {@@ -331,7 +332,6 @@ struct idpf\_vport { struct idpf\_port\_stats port\_stats;  bool link\_up;- u32 link\_speed\_mbps;  wait\_queue\_head\_t sw\_marker\_wq; };diff --git a/drivers/net/ethernet/intel/idpf/idpf\_ethtool.c b/drivers/net/ethernet/intel/idpf/idpf\_ethtool.cindex 3806ddd3ce4ab9..59b1a1a099967f 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=2002e4e26e22a2962761444ccff09640d39200fb)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)@@ -1296,24 +1296,19 @@ static void idpf\_set\_msglevel(struct net\_device \*netdev, u32 data) static int idpf\_get\_link\_ksettings(struct net\_device \*netdev, struct ethtool\_link\_ksettings \*cmd) {- struct idpf\_vport \*vport;-- idpf\_vport\_ctrl\_lock(netdev);- vport = idpf\_netdev\_to\_vport(netdev);+ struct idpf\_netdev\_priv \*np = netdev\_priv(netdev);  ethtool\_link\_ksettings\_zero\_link\_mode(cmd, supported); cmd->base.autoneg = AUTONEG\_DISABLE; cmd->base.port = PORT\_NONE;- if (vport->link\_up) {+ if (netif\_carrier\_ok(netdev)) { cmd->base.duplex = DUPLEX\_FULL;- cmd->base.speed = vport->link\_speed\_mbps;+ cmd->base.speed = np->link\_speed\_mbps; } else { cmd->base.duplex = DUPLEX\_UNKNOWN; cmd->base.speed = SPEED\_UNKNOWN; } - idpf\_vport\_ctrl\_unlock(netdev);- return 0; } diff --git a/drivers/net/ethernet/intel/idpf/idpf\_lib.c b/drivers/net/ethernet/intel/idpf/idpf\_lib.cindex 0b6c8fd5bc90f7..a1b0d8d8a380fb 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=2002e4e26e22a2962761444ccff09640d39200fb)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)@@ -1873,7 +1873,7 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, \* mess with. Nothing below should use those variables from new\_vport \* and should instead always refer to them in vport if they need to. \*/- memcpy(new\_vport, vport, offsetof(struct idpf\_vport, link\_speed\_mbps));+ memcpy(new\_vport, vport, offsetof(struct idpf\_vport, link\_up));  /\* Adjust resource parameters prior to reallocating resources \*/ switch (reset\_cause) {@@ -1919,7 +1919,7 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, /\* Same comment as above regarding avoiding copying the wait\_queues and \* mutexes applies here. We do not want to mess with those if possible. \*/- memcpy(vport, new\_vport, offsetof(struct idpf\_vport, link\_speed\_mbps));+ memcpy(vport, new\_vport, offsetof(struct idpf\_vport, link\_up));  if (reset\_cause == IDPF\_SR\_Q\_CHANGE) idpf\_vport\_alloc\_vec\_indexes(vport);diff --git a/drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c b/drivers/net/ethernet/intel/idpf/idpf\_virtchnl.cindex 3c0f97650d72fd..b80fa4d9f5b214 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=2002e4e26e22a2962761444ccff09640d39200fb)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=fa4d906ad0fb63a980a1d586a061c78ea1a345ba)@@ -141,7 +141,7 @@ static void idpf\_handle\_event\_link(struct idpf\_adapter \*adapter, } np = netdev\_priv(vport->netdev); - vport->link\_speed\_mbps = le32\_to\_cpu(v2e->link\_speed);+ np->link\_speed\_mbps = le32\_to\_cpu(v2e->link\_speed);  if (vport->link\_up == v2e->link\_status) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:55:45 +0000



=== Content from git.kernel.org_b7fc03ad_20250114_225708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavan Kumar Linga <pavan.kumar.linga@intel.com> | 2024-10-25 11:38:42 -0700 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2024-11-04 13:09:33 -0800 |
| commit | [81d2fb4c7c18a3b36ba3e00b9d5b753107472d75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)) | |
| tree | [ebcbf34cac6b0ccd0bf9547040a29ba3967c144c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) | |
| parent | [64502dac974a5d9951d16015fa2e16a14e5f2bb2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64502dac974a5d9951d16015fa2e16a14e5f2bb2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75&id2=64502dac974a5d9951d16015fa2e16a14e5f2bb2)) | |
| download | [linux-81d2fb4c7c18a3b36ba3e00b9d5b753107472d75.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81d2fb4c7c18a3b36ba3e00b9d5b753107472d75.tar.gz) | |

idpf: avoid vport access in idpf\_get\_link\_ksettingsWhen the device control plane is removed or the platform
running device control plane is rebooted, a reset is detected
on the driver. On driver reset, it releases the resources and
waits for the reset to complete. If the reset fails, it takes
the error path and releases the vport lock. At this time if the
monitoring tools tries to access link settings, it call traces
for accessing released vport pointer.
To avoid it, move link\_speed\_mbps to netdev\_priv structure
which removes the dependency on vport pointer and the vport lock
in idpf\_get\_link\_ksettings. Also use netif\_carrier\_ok()
to check the link status and adjust the offsetof to use link\_up
instead of link\_speed\_mbps.
Fixes: 02cbfba1add5 ("idpf: add ethtool callbacks")
Cc: stable@vger.kernel.org # 6.7+
Reviewed-by: Tarun K Singh <tarun.k.singh@intel.com>
Signed-off-by: Pavan Kumar Linga <pavan.kumar.linga@intel.com>
Tested-by: Krishneil Singh <krishneil.k.singh@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)

| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf.h?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 8 insertions, 13 deletions

| diff --git a/drivers/net/ethernet/intel/idpf/idpf.h b/drivers/net/ethernet/intel/idpf/idpf.hindex 2c31ad87587a4a..66544faab710aa 100644--- a/[drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf.h?id=64502dac974a5d9951d16015fa2e16a14e5f2bb2)+++ b/[drivers/net/ethernet/intel/idpf/idpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf.h?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)@@ -141,6 +141,7 @@ enum idpf\_vport\_state { \* @adapter: Adapter back pointer \* @vport: Vport back pointer \* @vport\_id: Vport identifier+ \* @link\_speed\_mbps: Link speed in mbps \* @vport\_idx: Relative vport index \* @state: See enum idpf\_vport\_state \* @netstats: Packet and byte stats@@ -150,6 +151,7 @@ struct idpf\_netdev\_priv { struct idpf\_adapter \*adapter; struct idpf\_vport \*vport; u32 vport\_id;+ u32 link\_speed\_mbps; u16 vport\_idx; enum idpf\_vport\_state state; struct rtnl\_link\_stats64 netstats;@@ -287,7 +289,6 @@ struct idpf\_port\_stats { \* @tx\_itr\_profile: TX profiles for Dynamic Interrupt Moderation \* @port\_stats: per port csum, header split, and other offload stats \* @link\_up: True if link is up- \* @link\_speed\_mbps: Link speed in mbps \* @sw\_marker\_wq: workqueue for marker packets \*/ struct idpf\_vport {@@ -331,7 +332,6 @@ struct idpf\_vport { struct idpf\_port\_stats port\_stats;  bool link\_up;- u32 link\_speed\_mbps;  wait\_queue\_head\_t sw\_marker\_wq; };diff --git a/drivers/net/ethernet/intel/idpf/idpf\_ethtool.c b/drivers/net/ethernet/intel/idpf/idpf\_ethtool.cindex 3806ddd3ce4ab9..59b1a1a099967f 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=64502dac974a5d9951d16015fa2e16a14e5f2bb2)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_ethtool.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_ethtool.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)@@ -1296,24 +1296,19 @@ static void idpf\_set\_msglevel(struct net\_device \*netdev, u32 data) static int idpf\_get\_link\_ksettings(struct net\_device \*netdev, struct ethtool\_link\_ksettings \*cmd) {- struct idpf\_vport \*vport;-- idpf\_vport\_ctrl\_lock(netdev);- vport = idpf\_netdev\_to\_vport(netdev);+ struct idpf\_netdev\_priv \*np = netdev\_priv(netdev);  ethtool\_link\_ksettings\_zero\_link\_mode(cmd, supported); cmd->base.autoneg = AUTONEG\_DISABLE; cmd->base.port = PORT\_NONE;- if (vport->link\_up) {+ if (netif\_carrier\_ok(netdev)) { cmd->base.duplex = DUPLEX\_FULL;- cmd->base.speed = vport->link\_speed\_mbps;+ cmd->base.speed = np->link\_speed\_mbps; } else { cmd->base.duplex = DUPLEX\_UNKNOWN; cmd->base.speed = SPEED\_UNKNOWN; } - idpf\_vport\_ctrl\_unlock(netdev);- return 0; } diff --git a/drivers/net/ethernet/intel/idpf/idpf\_lib.c b/drivers/net/ethernet/intel/idpf/idpf\_lib.cindex 4f20343e49a980..c3848e10e7dbef 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=64502dac974a5d9951d16015fa2e16a14e5f2bb2)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)@@ -1860,7 +1860,7 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, \* mess with. Nothing below should use those variables from new\_vport \* and should instead always refer to them in vport if they need to. \*/- memcpy(new\_vport, vport, offsetof(struct idpf\_vport, link\_speed\_mbps));+ memcpy(new\_vport, vport, offsetof(struct idpf\_vport, link\_up));  /\* Adjust resource parameters prior to reallocating resources \*/ switch (reset\_cause) {@@ -1906,7 +1906,7 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, /\* Same comment as above regarding avoiding copying the wait\_queues and \* mutexes applies here. We do not want to mess with those if possible. \*/- memcpy(vport, new\_vport, offsetof(struct idpf\_vport, link\_speed\_mbps));+ memcpy(vport, new\_vport, offsetof(struct idpf\_vport, link\_up));  if (reset\_cause == IDPF\_SR\_Q\_CHANGE) idpf\_vport\_alloc\_vec\_indexes(vport);diff --git a/drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c b/drivers/net/ethernet/intel/idpf/idpf\_virtchnl.cindex 15c00a01f1c0b9..ce217e274506db 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=64502dac974a5d9951d16015fa2e16a14e5f2bb2)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_virtchnl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_virtchnl.c?id=81d2fb4c7c18a3b36ba3e00b9d5b753107472d75)@@ -141,7 +141,7 @@ static void idpf\_handle\_event\_link(struct idpf\_adapter \*adapter, } np = netdev\_priv(vport->netdev); - vport->link\_speed\_mbps = le32\_to\_cpu(v2e->link\_speed);+ np->link\_speed\_mbps = le32\_to\_cpu(v2e->link\_speed);  if (vport->link\_up == v2e->link\_status) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:55:45 +0000


