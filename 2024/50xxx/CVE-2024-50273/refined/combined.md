=== Content from git.kernel.org_9ca8e3b5_20250115_092454.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:40 +0100 |
| commit | [c24fa427fc0ae827b2a3a07f13738cbf82c3f851](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)) | |
| tree | [23c7504b27fe16c1bb8c57654bce269e4357671f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851) | |
| parent | [9b453e8b108a5a93a6e348cf2ba4c9c138314a00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b453e8b108a5a93a6e348cf2ba4c9c138314a00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851&id2=9b453e8b108a5a93a6e348cf2ba4c9c138314a00)) | |
| download | [linux-c24fa427fc0ae827b2a3a07f13738cbf82c3f851.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c24fa427fc0ae827b2a3a07f13738cbf82c3f851.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex ca848b1834747c..83c647d2fffe54 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=9b453e8b108a5a93a6e348cf2ba4c9c138314a00)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=c24fa427fc0ae827b2a3a07f13738cbf82c3f851)@@ -608,7 +608,7 @@ static int insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:31 +0000



=== Content from git.kernel.org_a58137e6_20250115_092452.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:51 +0100 |
| commit | [93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)) | |
| tree | [9d7ef20cc94e162e8164a1d2aeba88b23ffc30fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb) | |
| parent | [bbfcd261cc068fe1cd02a4e871275074a0daa4e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbfcd261cc068fe1cd02a4e871275074a0daa4e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb&id2=bbfcd261cc068fe1cd02a4e871275074a0daa4e2)) | |
| download | [linux-93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex dfdb7d4f8406d6..cc1a2689ac88d7 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=bbfcd261cc068fe1cd02a4e871275074a0daa4e2)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=93c5b8decc0ef39ba84f4211d2db6da0a4aefbeb)@@ -621,7 +621,7 @@ static int insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:29 +0000



=== Content from git.kernel.org_80779500_20250115_092453.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:37 +0100 |
| commit | [bf0b0c6d159767c0d1c21f793950d78486690ee0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)) | |
| tree | [ad5ccbdaf473ba7329e073ccbc2a75a0db90c6a9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0) | |
| parent | [8fc5ea9231af9122d227c9c13f5e578fca48d2e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fc5ea9231af9122d227c9c13f5e578fca48d2e3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0&id2=8fc5ea9231af9122d227c9c13f5e578fca48d2e3)) | |
| download | [linux-bf0b0c6d159767c0d1c21f793950d78486690ee0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bf0b0c6d159767c0d1c21f793950d78486690ee0.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=bf0b0c6d159767c0d1c21f793950d78486690ee0) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex 30883b9a26d84c..e2309bc9e45d23 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=8fc5ea9231af9122d227c9c13f5e578fca48d2e3)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=bf0b0c6d159767c0d1c21f793950d78486690ee0)@@ -620,7 +620,7 @@ static int insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:30 +0000



=== Content from git.kernel.org_18b2f32b_20250115_092456.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:38 +0100 |
| commit | [f04be6d68f715c1473a8422fc0460f57b5e99931](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f04be6d68f715c1473a8422fc0460f57b5e99931) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)) | |
| tree | [105b60ddc5c7e2cc6a4fada4e2b3479faa9aa6fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f04be6d68f715c1473a8422fc0460f57b5e99931) | |
| parent | [701fae8dce72214adcb761a18ca5c091427385e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=701fae8dce72214adcb761a18ca5c091427385e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f04be6d68f715c1473a8422fc0460f57b5e99931&id2=701fae8dce72214adcb761a18ca5c091427385e9)) | |
| download | [linux-f04be6d68f715c1473a8422fc0460f57b5e99931.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f04be6d68f715c1473a8422fc0460f57b5e99931.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f04be6d68f715c1473a8422fc0460f57b5e99931)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=f04be6d68f715c1473a8422fc0460f57b5e99931) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex 9fe4ccca50a060..6f2e48d697dd65 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=701fae8dce72214adcb761a18ca5c091427385e9)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=f04be6d68f715c1473a8422fc0460f57b5e99931)@@ -615,7 +615,7 @@ static bool insert\_delayed\_ref(struct btrfs\_delayed\_ref\_root \*root, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:33 +0000



=== Content from git.kernel.org_8f62e774_20250115_092455.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-11-07 02:07:53 +0100 |
| commit | [c9a75ec45f1111ef530ab186c2a7684d0a0c9245](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)) | |
| tree | [b93f61c7060a42cccc51fa057c460ce6f00eec75](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245) | |
| parent | [cda7163d4e3d99db93aa38f0e825b8433c7a8452](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cda7163d4e3d99db93aa38f0e825b8433c7a8452) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245&id2=cda7163d4e3d99db93aa38f0e825b8433c7a8452)) | |
| download | [linux-c9a75ec45f1111ef530ab186c2a7684d0a0c9245.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9a75ec45f1111ef530ab186c2a7684d0a0c9245.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listAt insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex 115b90d29b1d8e..65d841d7142c07 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=cda7163d4e3d99db93aa38f0e825b8433c7a8452)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=c9a75ec45f1111ef530ab186c2a7684d0a0c9245)@@ -649,7 +649,7 @@ static bool insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:32 +0000



=== Content from git.kernel.org_26c8227a_20250115_092451.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50a3933760b427759afdd23156a7280a19357a92)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50a3933760b427759afdd23156a7280a19357a92)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50a3933760b427759afdd23156a7280a19357a92)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50a3933760b427759afdd23156a7280a19357a92)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:10 +0100 |
| commit | [50a3933760b427759afdd23156a7280a19357a92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50a3933760b427759afdd23156a7280a19357a92) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50a3933760b427759afdd23156a7280a19357a92)) | |
| tree | [8048e3daeaf43c919f1f33c0521585b33b69951b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50a3933760b427759afdd23156a7280a19357a92) | |
| parent | [93aee6c3ef5d16923f5b9cb667cd395320b8676b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93aee6c3ef5d16923f5b9cb667cd395320b8676b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50a3933760b427759afdd23156a7280a19357a92&id2=93aee6c3ef5d16923f5b9cb667cd395320b8676b)) | |
| download | [linux-50a3933760b427759afdd23156a7280a19357a92.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50a3933760b427759afdd23156a7280a19357a92.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50a3933760b427759afdd23156a7280a19357a92)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=50a3933760b427759afdd23156a7280a19357a92) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex 06a9e0542d708b..7a2a4fdc07f1ff 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=93aee6c3ef5d16923f5b9cb667cd395320b8676b)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=50a3933760b427759afdd23156a7280a19357a92)@@ -649,7 +649,7 @@ static bool insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:28 +0000



=== Content from git.kernel.org_dcb3e4df_20250115_092450.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:07 +0100 |
| commit | [2fd0948a483e9cb2d669c7199bc620a21c97673d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)) | |
| tree | [30874fd5d27ba193b45b12bdec29bd855d2244d3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d) | |
| parent | [25ffd294fef81a7f3cd9528adf21560c04d98747](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25ffd294fef81a7f3cd9528adf21560c04d98747) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d&id2=25ffd294fef81a7f3cd9528adf21560c04d98747)) | |
| download | [linux-2fd0948a483e9cb2d669c7199bc620a21c97673d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2fd0948a483e9cb2d669c7199bc620a21c97673d.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=2fd0948a483e9cb2d669c7199bc620a21c97673d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex 09a12115b64086..afb194d45a2ee4 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=25ffd294fef81a7f3cd9528adf21560c04d98747)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=2fd0948a483e9cb2d669c7199bc620a21c97673d)@@ -426,7 +426,7 @@ static int insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:27 +0000



=== Content from git.kernel.org_5ef58e7d_20250115_092448.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-04 12:11:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:17 +0100 |
| commit | [2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)) | |
| tree | [2029346b0c1e68c8aced301cb418ae7262ff1b67](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6) | |
| parent | [ba884534f1e97571db082da9878fdeefdcb2a01c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba884534f1e97571db082da9878fdeefdcb2a01c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6&id2=ba884534f1e97571db082da9878fdeefdcb2a01c)) | |
| download | [linux-2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6.tar.gz) | |

btrfs: reinitialize delayed ref list after deleting it from the listcommit c9a75ec45f1111ef530ab186c2a7684d0a0c9245 upstream.
At insert\_delayed\_ref() if we need to update the action of an existing
ref to BTRFS\_DROP\_DELAYED\_REF, we delete the ref from its ref head's
ref\_add\_list using list\_del(), which leaves the ref's add\_list member
not reinitialized, as list\_del() sets the next and prev members of the
list to LIST\_POISON1 and LIST\_POISON2, respectively.
If later we end up calling drop\_delayed\_ref() against the ref, which can
happen during merging or when destroying delayed refs due to a transaction
abort, we can trigger a crash since at drop\_delayed\_ref() we call
list\_empty() against the ref's add\_list, which returns false since
the list was not reinitialized after the list\_del() and as a consequence
we call list\_del() again at drop\_delayed\_ref(). This results in an
invalid list access since the next and prev members are set to poison
pointers, resulting in a splat if CONFIG\_LIST\_HARDENED and
CONFIG\_DEBUG\_LIST are set or invalid poison pointer dereferences
otherwise.
So fix this by deleting from the list with list\_del\_init() instead.
Fixes: 1d57ee941692 ("btrfs: improve delayed refs iterations")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)

| -rw-r--r-- | [fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/delayed-ref.c?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/delayed-ref.c b/fs/btrfs/delayed-ref.cindex e08e3852c47887..99a78ca28db295 100644--- a/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=ba884534f1e97571db082da9878fdeefdcb2a01c)+++ b/[fs/btrfs/delayed-ref.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/delayed-ref.c?id=2cb1a73d1d44a1c11b0ee5eeced765dd80ec48e6)@@ -622,7 +622,7 @@ static int insert\_delayed\_ref(struct btrfs\_trans\_handle \*trans, &href->ref\_add\_list); else if (ref->action == BTRFS\_DROP\_DELAYED\_REF) { ASSERT(!list\_empty(&exist->add\_list));- list\_del(&exist->add\_list);+ list\_del\_init(&exist->add\_list); } else { ASSERT(0); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:25 +0000


