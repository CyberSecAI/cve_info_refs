=== Content from git.kernel.org_e08252ee_20250114_215708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhao Mengmeng <zhaomengmeng@kylinos.cn> | 2024-10-01 19:54:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:34 +0100 |
| commit | [b22d9a5698abf04341f8fbc30141e0673863c3a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)) | |
| tree | [c2b07305d84f43cdaa05ebc5e531983f77e8aa29](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | |
| parent | [506b1961dbcc49483820ee14f4a2ca2f5459eace](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=506b1961dbcc49483820ee14f4a2ca2f5459eace) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6&id2=506b1961dbcc49483820ee14f4a2ca2f5459eace)) | |
| download | [linux-b22d9a5698abf04341f8fbc30141e0673863c3a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b22d9a5698abf04341f8fbc30141e0673863c3a6.tar.gz) | |

udf: refactor inode\_bmap() to handle error[ Upstream commit c226964ec786f3797ed389a16392ce4357697d24 ]
Refactor inode\_bmap() to handle error since udf\_next\_aext() can return
error now. On situations like ftruncate, udf\_extend\_file() can now
detect errors and bail out early without resorting to checking for
particular offsets and assuming internal behavior of these functions.
Reported-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7a4842f0b1801230a989
Tested-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Signed-off-by: Zhao Mengmeng <zhaomengmeng@kylinos.cn>
Suggested-by: Jan Kara <jack@suse.cz>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241001115425.266556-4-zhaomzhao@126.com](https://patch.msgid.link/20241001115425.266556-4-zhaomzhao%40126.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)

| -rw-r--r-- | [fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/directory.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/inode.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/partition.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/udfdecl.h?id=b22d9a5698abf04341f8fbc30141e0673863c3a6) | 5 | |  |  |  | | --- | --- | --- | |

5 files changed, 44 insertions, 26 deletions

| diff --git a/fs/udf/directory.c b/fs/udf/directory.cindex c6950050e7aeb9..632453aa38934a 100644--- a/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=506b1961dbcc49483820ee14f4a2ca2f5459eace)+++ b/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)@@ -246,6 +246,7 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, { struct udf\_inode\_info \*iinfo = UDF\_I(dir); int err = 0;+ int8\_t etype;  iter->dir = dir; iter->bh[0] = iter->bh[1] = NULL;@@ -265,9 +266,9 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, goto out; } - if (inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,- &iter->eloc, &iter->elen, &iter->loffset) !=- (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,+ &iter->eloc, &iter->elen, &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { if (pos == dir->i\_size) return 0; udf\_err(dir->i\_sb,@@ -463,6 +464,7 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) sector\_t block; uint32\_t old\_elen = iter->elen; int err;+ int8\_t etype;  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB)) return -EINVAL;@@ -477,8 +479,9 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) udf\_fiiter\_update\_elen(iter, old\_elen); return err; }- if (inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,- &iter->loffset) != (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,+ &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { udf\_err(iter->dir->i\_sb, "block %llu not allocated in directory (ino %lu)\n", (unsigned long long)block, iter->dir->i\_ino);diff --git a/fs/udf/inode.c b/fs/udf/inode.cindex 0459a87d4c02a2..80dae442ecd726 100644--- a/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=506b1961dbcc49483820ee14f4a2ca2f5459eace)+++ b/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)@@ -406,7 +406,7 @@ struct udf\_map\_rq {  static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) {- int err;+ int ret; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB))@@ -418,18 +418,24 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) uint32\_t elen; sector\_t offset; struct extent\_position epos = {};+ int8\_t etype;  down\_read(&iinfo->i\_data\_sem);- if (inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset)- == (EXT\_RECORDED\_ALLOCATED >> 30)) {+ ret = inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset,+ &etype);+ if (ret < 0)+ goto out\_read;+ if (ret > 0 && etype == (EXT\_RECORDED\_ALLOCATED >> 30)) { map->pblk = udf\_get\_lb\_pblock(inode->i\_sb, &eloc, offset); map->oflags |= UDF\_BLK\_MAPPED;+ ret = 0; }+out\_read: up\_read(&iinfo->i\_data\_sem); brelse(epos.bh); - return 0;+ return ret; }  down\_write(&iinfo->i\_data\_sem);@@ -440,9 +446,9 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) if (((loff\_t)map->lblk) << inode->i\_blkbits >= iinfo->i\_lenExtents) udf\_discard\_prealloc(inode); udf\_clear\_extent\_cache(inode);- err = inode\_getblk(inode, map);+ ret = inode\_getblk(inode, map); up\_write(&iinfo->i\_data\_sem);- return err;+ return ret; }  static int \_\_udf\_get\_block(struct inode \*inode, sector\_t block,@@ -664,8 +670,10 @@ static int udf\_extend\_file(struct inode \*inode, loff\_t newsize) \*/ udf\_discard\_prealloc(inode); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);- within\_last\_ext = (etype != -1);+ err = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (err < 0)+ goto out;+ within\_last\_ext = (err == 1); /\* We don't expect extents past EOF... \*/ WARN\_ON\_ONCE(within\_last\_ext && elen > ((loff\_t)offset + 1) << inode->i\_blkbits);@@ -2403,13 +2411,15 @@ int8\_t udf\_delete\_aext(struct inode \*inode, struct extent\_position epos) return (elen >> 30); } -int8\_t inode\_bmap(struct inode \*inode, sector\_t block,- struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,- uint32\_t \*elen, sector\_t \*offset)+/\*+ \* Returns 1 on success, -errno on error, 0 on hit EOF.+ \*/+int inode\_bmap(struct inode \*inode, sector\_t block, struct extent\_position \*pos,+ struct kernel\_lb\_addr \*eloc, uint32\_t \*elen, sector\_t \*offset,+ int8\_t \*etype) { unsigned char blocksize\_bits = inode->i\_sb->s\_blocksize\_bits; loff\_t lbcount = 0, bcount = (loff\_t) block << blocksize\_bits;- int8\_t etype; struct udf\_inode\_info \*iinfo; int err = 0; @@ -2421,13 +2431,13 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, } \*elen = 0; do {- err = udf\_next\_aext(inode, pos, eloc, elen, &etype, 1);+ err = udf\_next\_aext(inode, pos, eloc, elen, etype, 1); if (err <= 0) { if (err == 0) { \*offset = (bcount - lbcount) >> blocksize\_bits; iinfo->i\_lenExtents = lbcount; }- return -1;+ return err; } lbcount += \*elen; } while (lbcount <= bcount);@@ -2435,5 +2445,5 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, udf\_update\_extent\_cache(inode, lbcount - \*elen, pos); \*offset = (bcount + \*elen - lbcount) >> blocksize\_bits; - return etype;+ return 1; }diff --git a/fs/udf/partition.c b/fs/udf/partition.cindex af877991edc13a..2b85c9501bed89 100644--- a/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=506b1961dbcc49483820ee14f4a2ca2f5459eace)+++ b/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)@@ -282,9 +282,11 @@ static uint32\_t udf\_try\_read\_meta(struct inode \*inode, uint32\_t block, sector\_t ext\_offset; struct extent\_position epos = {}; uint32\_t phyblock;+ int8\_t etype;+ int err = 0; - if (inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset) !=- (EXT\_RECORDED\_ALLOCATED >> 30))+ err = inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) phyblock = 0xFFFFFFFF; else { map = &UDF\_SB(sb)->s\_partmaps[partition];diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 399958f891d145..4f33a4a4888613 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=506b1961dbcc49483820ee14f4a2ca2f5459eace)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)@@ -214,10 +214,12 @@ int udf\_truncate\_extents(struct inode \*inode) else BUG(); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);+ ret = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (ret < 0)+ return ret; byte\_offset = (offset << sb->s\_blocksize\_bits) + (inode->i\_size & (sb->s\_blocksize - 1));- if (etype == -1) {+ if (ret == 0) { /\* We should extend the file? \*/ WARN\_ON(byte\_offset); return 0;diff --git a/fs/udf/udfdecl.h b/fs/udf/udfdecl.hindex 5067ed68a8b454..d159f20d61e89a 100644--- a/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=506b1961dbcc49483820ee14f4a2ca2f5459eace)+++ b/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=b22d9a5698abf04341f8fbc30141e0673863c3a6)@@ -157,8 +157,9 @@ extern struct buffer\_head \*udf\_bread(struct inode \*inode, udf\_pblk\_t block, extern int udf\_setsize(struct inode \*, loff\_t); extern void udf\_evict\_inode(struct inode \*); extern int udf\_write\_inode(struct inode \*, struct writeback\_control \*wbc);-extern int8\_t inode\_bmap(struct inode \*, sector\_t, struct extent\_position \*,- struct kernel\_lb\_addr \*, uint32\_t \*, sector\_t \*);+extern int inode\_bmap(struct inode \*inode, sector\_t block,+ struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,+ uint32\_t \*elen, sector\_t \*offset, int8\_t \*etype); int udf\_get\_block(struct inode \*, sector\_t, struct buffer\_head \*, int); extern int udf\_setup\_indirect\_aext(struct inode \*inode, udf\_pblk\_t block, struct extent\_position \*epos); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:55:45 +0000



=== Content from git.kernel.org_774a83af_20250114_215705.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=493447dd8336607fce426f7879e581095f6c606e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=493447dd8336607fce426f7879e581095f6c606e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=493447dd8336607fce426f7879e581095f6c606e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=493447dd8336607fce426f7879e581095f6c606e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhao Mengmeng <zhaomengmeng@kylinos.cn> | 2024-10-01 19:54:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:27 +0100 |
| commit | [493447dd8336607fce426f7879e581095f6c606e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=493447dd8336607fce426f7879e581095f6c606e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=493447dd8336607fce426f7879e581095f6c606e)) | |
| tree | [5d81dbc82cc7171765656ba0e94a95817f218a42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=493447dd8336607fce426f7879e581095f6c606e) | |
| parent | [5fc8da4d326d88c12924996b2bec85a194fe27f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fc8da4d326d88c12924996b2bec85a194fe27f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=493447dd8336607fce426f7879e581095f6c606e&id2=5fc8da4d326d88c12924996b2bec85a194fe27f9)) | |
| download | [linux-493447dd8336607fce426f7879e581095f6c606e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-493447dd8336607fce426f7879e581095f6c606e.tar.gz) | |

udf: refactor inode\_bmap() to handle error[ Upstream commit c226964ec786f3797ed389a16392ce4357697d24 ]
Refactor inode\_bmap() to handle error since udf\_next\_aext() can return
error now. On situations like ftruncate, udf\_extend\_file() can now
detect errors and bail out early without resorting to checking for
particular offsets and assuming internal behavior of these functions.
Reported-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7a4842f0b1801230a989
Tested-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Signed-off-by: Zhao Mengmeng <zhaomengmeng@kylinos.cn>
Suggested-by: Jan Kara <jack@suse.cz>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241001115425.266556-4-zhaomzhao@126.com](https://patch.msgid.link/20241001115425.266556-4-zhaomzhao%40126.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=493447dd8336607fce426f7879e581095f6c606e)

| -rw-r--r-- | [fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/directory.c?id=493447dd8336607fce426f7879e581095f6c606e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/inode.c?id=493447dd8336607fce426f7879e581095f6c606e) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/partition.c?id=493447dd8336607fce426f7879e581095f6c606e) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=493447dd8336607fce426f7879e581095f6c606e) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/udfdecl.h?id=493447dd8336607fce426f7879e581095f6c606e) | 5 | |  |  |  | | --- | --- | --- | |

5 files changed, 44 insertions, 26 deletions

| diff --git a/fs/udf/directory.c b/fs/udf/directory.cindex c6950050e7aeb9..632453aa38934a 100644--- a/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=5fc8da4d326d88c12924996b2bec85a194fe27f9)+++ b/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=493447dd8336607fce426f7879e581095f6c606e)@@ -246,6 +246,7 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, { struct udf\_inode\_info \*iinfo = UDF\_I(dir); int err = 0;+ int8\_t etype;  iter->dir = dir; iter->bh[0] = iter->bh[1] = NULL;@@ -265,9 +266,9 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, goto out; } - if (inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,- &iter->eloc, &iter->elen, &iter->loffset) !=- (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,+ &iter->eloc, &iter->elen, &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { if (pos == dir->i\_size) return 0; udf\_err(dir->i\_sb,@@ -463,6 +464,7 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) sector\_t block; uint32\_t old\_elen = iter->elen; int err;+ int8\_t etype;  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB)) return -EINVAL;@@ -477,8 +479,9 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) udf\_fiiter\_update\_elen(iter, old\_elen); return err; }- if (inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,- &iter->loffset) != (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,+ &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { udf\_err(iter->dir->i\_sb, "block %llu not allocated in directory (ino %lu)\n", (unsigned long long)block, iter->dir->i\_ino);diff --git a/fs/udf/inode.c b/fs/udf/inode.cindex f7623b49ec3492..37fa27136fafbd 100644--- a/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=5fc8da4d326d88c12924996b2bec85a194fe27f9)+++ b/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=493447dd8336607fce426f7879e581095f6c606e)@@ -408,7 +408,7 @@ struct udf\_map\_rq {  static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) {- int err;+ int ret; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB))@@ -420,18 +420,24 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) uint32\_t elen; sector\_t offset; struct extent\_position epos = {};+ int8\_t etype;  down\_read(&iinfo->i\_data\_sem);- if (inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset)- == (EXT\_RECORDED\_ALLOCATED >> 30)) {+ ret = inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset,+ &etype);+ if (ret < 0)+ goto out\_read;+ if (ret > 0 && etype == (EXT\_RECORDED\_ALLOCATED >> 30)) { map->pblk = udf\_get\_lb\_pblock(inode->i\_sb, &eloc, offset); map->oflags |= UDF\_BLK\_MAPPED;+ ret = 0; }+out\_read: up\_read(&iinfo->i\_data\_sem); brelse(epos.bh); - return 0;+ return ret; }  down\_write(&iinfo->i\_data\_sem);@@ -442,9 +448,9 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) if (((loff\_t)map->lblk) << inode->i\_blkbits >= iinfo->i\_lenExtents) udf\_discard\_prealloc(inode); udf\_clear\_extent\_cache(inode);- err = inode\_getblk(inode, map);+ ret = inode\_getblk(inode, map); up\_write(&iinfo->i\_data\_sem);- return err;+ return ret; }  static int \_\_udf\_get\_block(struct inode \*inode, sector\_t block,@@ -666,8 +672,10 @@ static int udf\_extend\_file(struct inode \*inode, loff\_t newsize) \*/ udf\_discard\_prealloc(inode); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);- within\_last\_ext = (etype != -1);+ err = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (err < 0)+ goto out;+ within\_last\_ext = (err == 1); /\* We don't expect extents past EOF... \*/ WARN\_ON\_ONCE(within\_last\_ext && elen > ((loff\_t)offset + 1) << inode->i\_blkbits);@@ -2401,13 +2409,15 @@ int8\_t udf\_delete\_aext(struct inode \*inode, struct extent\_position epos) return (elen >> 30); } -int8\_t inode\_bmap(struct inode \*inode, sector\_t block,- struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,- uint32\_t \*elen, sector\_t \*offset)+/\*+ \* Returns 1 on success, -errno on error, 0 on hit EOF.+ \*/+int inode\_bmap(struct inode \*inode, sector\_t block, struct extent\_position \*pos,+ struct kernel\_lb\_addr \*eloc, uint32\_t \*elen, sector\_t \*offset,+ int8\_t \*etype) { unsigned char blocksize\_bits = inode->i\_sb->s\_blocksize\_bits; loff\_t lbcount = 0, bcount = (loff\_t) block << blocksize\_bits;- int8\_t etype; struct udf\_inode\_info \*iinfo; int err = 0; @@ -2419,13 +2429,13 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, } \*elen = 0; do {- err = udf\_next\_aext(inode, pos, eloc, elen, &etype, 1);+ err = udf\_next\_aext(inode, pos, eloc, elen, etype, 1); if (err <= 0) { if (err == 0) { \*offset = (bcount - lbcount) >> blocksize\_bits; iinfo->i\_lenExtents = lbcount; }- return -1;+ return err; } lbcount += \*elen; } while (lbcount <= bcount);@@ -2433,5 +2443,5 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, udf\_update\_extent\_cache(inode, lbcount - \*elen, pos); \*offset = (bcount + \*elen - lbcount) >> blocksize\_bits; - return etype;+ return 1; }diff --git a/fs/udf/partition.c b/fs/udf/partition.cindex af877991edc13a..2b85c9501bed89 100644--- a/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=5fc8da4d326d88c12924996b2bec85a194fe27f9)+++ b/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=493447dd8336607fce426f7879e581095f6c606e)@@ -282,9 +282,11 @@ static uint32\_t udf\_try\_read\_meta(struct inode \*inode, uint32\_t block, sector\_t ext\_offset; struct extent\_position epos = {}; uint32\_t phyblock;+ int8\_t etype;+ int err = 0; - if (inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset) !=- (EXT\_RECORDED\_ALLOCATED >> 30))+ err = inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) phyblock = 0xFFFFFFFF; else { map = &UDF\_SB(sb)->s\_partmaps[partition];diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 399958f891d145..4f33a4a4888613 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=5fc8da4d326d88c12924996b2bec85a194fe27f9)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=493447dd8336607fce426f7879e581095f6c606e)@@ -214,10 +214,12 @@ int udf\_truncate\_extents(struct inode \*inode) else BUG(); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);+ ret = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (ret < 0)+ return ret; byte\_offset = (offset << sb->s\_blocksize\_bits) + (inode->i\_size & (sb->s\_blocksize - 1));- if (etype == -1) {+ if (ret == 0) { /\* We should extend the file? \*/ WARN\_ON(byte\_offset); return 0;diff --git a/fs/udf/udfdecl.h b/fs/udf/udfdecl.hindex 5067ed68a8b454..d159f20d61e89a 100644--- a/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=5fc8da4d326d88c12924996b2bec85a194fe27f9)+++ b/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=493447dd8336607fce426f7879e581095f6c606e)@@ -157,8 +157,9 @@ extern struct buffer\_head \*udf\_bread(struct inode \*inode, udf\_pblk\_t block, extern int udf\_setsize(struct inode \*, loff\_t); extern void udf\_evict\_inode(struct inode \*); extern int udf\_write\_inode(struct inode \*, struct writeback\_control \*wbc);-extern int8\_t inode\_bmap(struct inode \*, sector\_t, struct extent\_position \*,- struct kernel\_lb\_addr \*, uint32\_t \*, sector\_t \*);+extern int inode\_bmap(struct inode \*inode, sector\_t block,+ struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,+ uint32\_t \*elen, sector\_t \*offset, int8\_t \*etype); int udf\_get\_block(struct inode \*, sector\_t, struct buffer\_head \*, int); extern int udf\_setup\_indirect\_aext(struct inode \*inode, udf\_pblk\_t block, struct extent\_position \*epos); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:55:41 +0000



=== Content from git.kernel.org_c86ad557_20250114_215710.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c226964ec786f3797ed389a16392ce4357697d24)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c226964ec786f3797ed389a16392ce4357697d24)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c226964ec786f3797ed389a16392ce4357697d24)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c226964ec786f3797ed389a16392ce4357697d24)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhao Mengmeng <zhaomengmeng@kylinos.cn> | 2024-10-01 19:54:25 +0800 |
| --- | --- | --- |
| committer | Jan Kara <jack@suse.cz> | 2024-10-02 14:32:29 +0200 |
| commit | [c226964ec786f3797ed389a16392ce4357697d24](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c226964ec786f3797ed389a16392ce4357697d24) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c226964ec786f3797ed389a16392ce4357697d24)) | |
| tree | [add167e7ec4e9da31ed4ad4f8419900b815c6d01](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c226964ec786f3797ed389a16392ce4357697d24) | |
| parent | [b405c1e58b73981da0f8df03b00666b22b9397ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b405c1e58b73981da0f8df03b00666b22b9397ae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c226964ec786f3797ed389a16392ce4357697d24&id2=b405c1e58b73981da0f8df03b00666b22b9397ae)) | |
| download | [linux-c226964ec786f3797ed389a16392ce4357697d24.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c226964ec786f3797ed389a16392ce4357697d24.tar.gz) | |

udf: refactor inode\_bmap() to handle errorRefactor inode\_bmap() to handle error since udf\_next\_aext() can return
error now. On situations like ftruncate, udf\_extend\_file() can now
detect errors and bail out early without resorting to checking for
particular offsets and assuming internal behavior of these functions.
Reported-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7a4842f0b1801230a989
Tested-by: syzbot+7a4842f0b1801230a989@syzkaller.appspotmail.com
Signed-off-by: Zhao Mengmeng <zhaomengmeng@kylinos.cn>
Suggested-by: Jan Kara <jack@suse.cz>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241001115425.266556-4-zhaomzhao@126.com](https://patch.msgid.link/20241001115425.266556-4-zhaomzhao%40126.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c226964ec786f3797ed389a16392ce4357697d24)

| -rw-r--r-- | [fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/directory.c?id=c226964ec786f3797ed389a16392ce4357697d24) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/inode.c?id=c226964ec786f3797ed389a16392ce4357697d24) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/partition.c?id=c226964ec786f3797ed389a16392ce4357697d24) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=c226964ec786f3797ed389a16392ce4357697d24) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/udfdecl.h?id=c226964ec786f3797ed389a16392ce4357697d24) | 5 | |  |  |  | | --- | --- | --- | |

5 files changed, 44 insertions, 26 deletions

| diff --git a/fs/udf/directory.c b/fs/udf/directory.cindex c6950050e7aeb9..632453aa38934a 100644--- a/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=b405c1e58b73981da0f8df03b00666b22b9397ae)+++ b/[fs/udf/directory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/directory.c?id=c226964ec786f3797ed389a16392ce4357697d24)@@ -246,6 +246,7 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, { struct udf\_inode\_info \*iinfo = UDF\_I(dir); int err = 0;+ int8\_t etype;  iter->dir = dir; iter->bh[0] = iter->bh[1] = NULL;@@ -265,9 +266,9 @@ int udf\_fiiter\_init(struct udf\_fileident\_iter \*iter, struct inode \*dir, goto out; } - if (inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,- &iter->eloc, &iter->elen, &iter->loffset) !=- (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(dir, iter->pos >> dir->i\_blkbits, &iter->epos,+ &iter->eloc, &iter->elen, &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { if (pos == dir->i\_size) return 0; udf\_err(dir->i\_sb,@@ -463,6 +464,7 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) sector\_t block; uint32\_t old\_elen = iter->elen; int err;+ int8\_t etype;  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB)) return -EINVAL;@@ -477,8 +479,9 @@ int udf\_fiiter\_append\_blk(struct udf\_fileident\_iter \*iter) udf\_fiiter\_update\_elen(iter, old\_elen); return err; }- if (inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,- &iter->loffset) != (EXT\_RECORDED\_ALLOCATED >> 30)) {+ err = inode\_bmap(iter->dir, block, &iter->epos, &iter->eloc, &iter->elen,+ &iter->loffset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) { udf\_err(iter->dir->i\_sb, "block %llu not allocated in directory (ino %lu)\n", (unsigned long long)block, iter->dir->i\_ino);diff --git a/fs/udf/inode.c b/fs/udf/inode.cindex 30f925f891b6fd..75c8cccfebd40b 100644--- a/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=b405c1e58b73981da0f8df03b00666b22b9397ae)+++ b/[fs/udf/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/inode.c?id=c226964ec786f3797ed389a16392ce4357697d24)@@ -404,7 +404,7 @@ struct udf\_map\_rq {  static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) {- int err;+ int ret; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (WARN\_ON\_ONCE(iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB))@@ -416,18 +416,24 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) uint32\_t elen; sector\_t offset; struct extent\_position epos = {};+ int8\_t etype;  down\_read(&iinfo->i\_data\_sem);- if (inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset)- == (EXT\_RECORDED\_ALLOCATED >> 30)) {+ ret = inode\_bmap(inode, map->lblk, &epos, &eloc, &elen, &offset,+ &etype);+ if (ret < 0)+ goto out\_read;+ if (ret > 0 && etype == (EXT\_RECORDED\_ALLOCATED >> 30)) { map->pblk = udf\_get\_lb\_pblock(inode->i\_sb, &eloc, offset); map->oflags |= UDF\_BLK\_MAPPED;+ ret = 0; }+out\_read: up\_read(&iinfo->i\_data\_sem); brelse(epos.bh); - return 0;+ return ret; }  down\_write(&iinfo->i\_data\_sem);@@ -438,9 +444,9 @@ static int udf\_map\_block(struct inode \*inode, struct udf\_map\_rq \*map) if (((loff\_t)map->lblk) << inode->i\_blkbits >= iinfo->i\_lenExtents) udf\_discard\_prealloc(inode); udf\_clear\_extent\_cache(inode);- err = inode\_getblk(inode, map);+ ret = inode\_getblk(inode, map); up\_write(&iinfo->i\_data\_sem);- return err;+ return ret; }  static int \_\_udf\_get\_block(struct inode \*inode, sector\_t block,@@ -662,8 +668,10 @@ static int udf\_extend\_file(struct inode \*inode, loff\_t newsize) \*/ udf\_discard\_prealloc(inode); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);- within\_last\_ext = (etype != -1);+ err = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (err < 0)+ goto out;+ within\_last\_ext = (err == 1); /\* We don't expect extents past EOF... \*/ WARN\_ON\_ONCE(within\_last\_ext && elen > ((loff\_t)offset + 1) << inode->i\_blkbits);@@ -2401,13 +2409,15 @@ int8\_t udf\_delete\_aext(struct inode \*inode, struct extent\_position epos) return (elen >> 30); } -int8\_t inode\_bmap(struct inode \*inode, sector\_t block,- struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,- uint32\_t \*elen, sector\_t \*offset)+/\*+ \* Returns 1 on success, -errno on error, 0 on hit EOF.+ \*/+int inode\_bmap(struct inode \*inode, sector\_t block, struct extent\_position \*pos,+ struct kernel\_lb\_addr \*eloc, uint32\_t \*elen, sector\_t \*offset,+ int8\_t \*etype) { unsigned char blocksize\_bits = inode->i\_sb->s\_blocksize\_bits; loff\_t lbcount = 0, bcount = (loff\_t) block << blocksize\_bits;- int8\_t etype; struct udf\_inode\_info \*iinfo; int err = 0; @@ -2419,13 +2429,13 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, } \*elen = 0; do {- err = udf\_next\_aext(inode, pos, eloc, elen, &etype, 1);+ err = udf\_next\_aext(inode, pos, eloc, elen, etype, 1); if (err <= 0) { if (err == 0) { \*offset = (bcount - lbcount) >> blocksize\_bits; iinfo->i\_lenExtents = lbcount; }- return -1;+ return err; } lbcount += \*elen; } while (lbcount <= bcount);@@ -2433,5 +2443,5 @@ int8\_t inode\_bmap(struct inode \*inode, sector\_t block, udf\_update\_extent\_cache(inode, lbcount - \*elen, pos); \*offset = (bcount + \*elen - lbcount) >> blocksize\_bits; - return etype;+ return 1; }diff --git a/fs/udf/partition.c b/fs/udf/partition.cindex af877991edc13a..2b85c9501bed89 100644--- a/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=b405c1e58b73981da0f8df03b00666b22b9397ae)+++ b/[fs/udf/partition.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/partition.c?id=c226964ec786f3797ed389a16392ce4357697d24)@@ -282,9 +282,11 @@ static uint32\_t udf\_try\_read\_meta(struct inode \*inode, uint32\_t block, sector\_t ext\_offset; struct extent\_position epos = {}; uint32\_t phyblock;+ int8\_t etype;+ int err = 0; - if (inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset) !=- (EXT\_RECORDED\_ALLOCATED >> 30))+ err = inode\_bmap(inode, block, &epos, &eloc, &elen, &ext\_offset, &etype);+ if (err <= 0 || etype != (EXT\_RECORDED\_ALLOCATED >> 30)) phyblock = 0xFFFFFFFF; else { map = &UDF\_SB(sb)->s\_partmaps[partition];diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 399958f891d145..4f33a4a4888613 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=b405c1e58b73981da0f8df03b00666b22b9397ae)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=c226964ec786f3797ed389a16392ce4357697d24)@@ -214,10 +214,12 @@ int udf\_truncate\_extents(struct inode \*inode) else BUG(); - etype = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset);+ ret = inode\_bmap(inode, first\_block, &epos, &eloc, &elen, &offset, &etype);+ if (ret < 0)+ return ret; byte\_offset = (offset << sb->s\_blocksize\_bits) + (inode->i\_size & (sb->s\_blocksize - 1));- if (etype == -1) {+ if (ret == 0) { /\* We should extend the file? \*/ WARN\_ON(byte\_offset); return 0;diff --git a/fs/udf/udfdecl.h b/fs/udf/udfdecl.hindex 5067ed68a8b454..d159f20d61e89a 100644--- a/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=b405c1e58b73981da0f8df03b00666b22b9397ae)+++ b/[fs/udf/udfdecl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/udfdecl.h?id=c226964ec786f3797ed389a16392ce4357697d24)@@ -157,8 +157,9 @@ extern struct buffer\_head \*udf\_bread(struct inode \*inode, udf\_pblk\_t block, extern int udf\_setsize(struct inode \*, loff\_t); extern void udf\_evict\_inode(struct inode \*); extern int udf\_write\_inode(struct inode \*, struct writeback\_control \*wbc);-extern int8\_t inode\_bmap(struct inode \*, sector\_t, struct extent\_position \*,- struct kernel\_lb\_addr \*, uint32\_t \*, sector\_t \*);+extern int inode\_bmap(struct inode \*inode, sector\_t block,+ struct extent\_position \*pos, struct kernel\_lb\_addr \*eloc,+ uint32\_t \*elen, sector\_t \*offset, int8\_t \*etype); int udf\_get\_block(struct inode \*, sector\_t, struct buffer\_head \*, int); extern int udf\_setup\_indirect\_aext(struct inode \*inode, udf\_pblk\_t block, struct extent\_position \*epos); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:55:47 +0000


