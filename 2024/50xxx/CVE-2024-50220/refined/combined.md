=== Content from git.kernel.org_489820d4_20250114_205031.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92b472945dbf8abc020e9259c0088026f7027dfc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92b472945dbf8abc020e9259c0088026f7027dfc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92b472945dbf8abc020e9259c0088026f7027dfc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92b472945dbf8abc020e9259c0088026f7027dfc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-10-15 18:56:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:58 +0100 |
| commit | [92b472945dbf8abc020e9259c0088026f7027dfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92b472945dbf8abc020e9259c0088026f7027dfc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92b472945dbf8abc020e9259c0088026f7027dfc)) | |
| tree | [85a16e8c06328fb57109ca96119e300b885be432](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92b472945dbf8abc020e9259c0088026f7027dfc) | |
| parent | [78b98b6e5686f54846f25b6a182568bdf0d66465](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78b98b6e5686f54846f25b6a182568bdf0d66465) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92b472945dbf8abc020e9259c0088026f7027dfc&id2=78b98b6e5686f54846f25b6a182568bdf0d66465)) | |
| download | [linux-92b472945dbf8abc020e9259c0088026f7027dfc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92b472945dbf8abc020e9259c0088026f7027dfc.tar.gz) | |

fork: do not invoke uffd on fork if error occurs[ Upstream commit f64e67e5d3a45a4a04286c47afade4b518acd47b ]
Patch series "fork: do not expose incomplete mm on fork".
During fork we may place the virtual memory address space into an
inconsistent state before the fork operation is complete.
In addition, we may encounter an error during the fork operation that
indicates that the virtual memory address space is invalidated.
As a result, we should not be exposing it in any way to external machinery
that might interact with the mm or VMAs, machinery that is not designed to
deal with incomplete state.
We specifically update the fork logic to defer khugepaged and ksm to the
end of the operation and only to be invoked if no error arose, and
disallow uffd from observing fork events should an error have occurred.
This patch (of 2):
Currently on fork we expose the virtual address space of a process to
userland unconditionally if uffd is registered in VMAs, regardless of
whether an error arose in the fork.
This is performed in dup\_userfaultfd\_complete() which is invoked
unconditionally, and performs two duties - invoking registered handlers
for the UFFD\_EVENT\_FORK event via dup\_fctx(), and clearing down
userfaultfd\_fork\_ctx objects established in dup\_userfaultfd().
This is problematic, because the virtual address space may not yet be
correctly initialised if an error arose.
The change in commit d24062914837 ("fork: use \_\_mt\_dup() to duplicate
maple tree in dup\_mmap()") makes this more pertinent as we may be in a
state where entries in the maple tree are not yet consistent.
We address this by, on fork error, ensuring that we roll back state that
we would otherwise expect to clean up through the event being handled by
userland and perform the memory freeing duty otherwise performed by
dup\_userfaultfd\_complete().
We do this by implementing a new function, dup\_userfaultfd\_fail(), which
performs the same loop, only decrementing reference counts.
Note that we perform mmgrab() on the parent and child mm's, however
userfaultfd\_ctx\_put() will mmdrop() this once the reference count drops to
zero, so we will avoid memory leaks correctly here.
Link: [https://lkml.kernel.org/r/cover.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/cover.1729014377.git.lorenzo.stoakes%40oracle.com)
Link: [https://lkml.kernel.org/r/d3691d58bb58712b6fb3df2be441d175bd3cdf07.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/d3691d58bb58712b6fb3df2be441d175bd3cdf07.1729014377.git.lorenzo.stoakes%40oracle.com)
Fixes: d24062914837 ("fork: use \_\_mt\_dup() to duplicate maple tree in dup\_mmap()")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@Oracle.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Jan Kara <jack@suse.cz>
Cc: Linus Torvalds <torvalds@linuxfoundation.org>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92b472945dbf8abc020e9259c0088026f7027dfc)

| -rw-r--r-- | [fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/userfaultfd.c?id=92b472945dbf8abc020e9259c0088026f7027dfc) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/userfaultfd_k.h?id=92b472945dbf8abc020e9259c0088026f7027dfc) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=92b472945dbf8abc020e9259c0088026f7027dfc) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 37 insertions, 1 deletions

| diff --git a/fs/userfaultfd.c b/fs/userfaultfd.cindex 27a3e9285fbf68..2f302da629cb4f 100644--- a/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=78b98b6e5686f54846f25b6a182568bdf0d66465)+++ b/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=92b472945dbf8abc020e9259c0088026f7027dfc)@@ -731,6 +731,34 @@ void dup\_userfaultfd\_complete(struct list\_head \*fcs) } } +void dup\_userfaultfd\_fail(struct list\_head \*fcs)+{+ struct userfaultfd\_fork\_ctx \*fctx, \*n;++ /\*+ \* An error has occurred on fork, we will tear memory down, but have+ \* allocated memory for fctx's and raised reference counts for both the+ \* original and child contexts (and on the mm for each as a result).+ \*+ \* These would ordinarily be taken care of by a user handling the event,+ \* but we are no longer doing so, so manually clean up here.+ \*+ \* mm tear down will take care of cleaning up VMA contexts.+ \*/+ list\_for\_each\_entry\_safe(fctx, n, fcs, list) {+ struct userfaultfd\_ctx \*octx = fctx->orig;+ struct userfaultfd\_ctx \*ctx = fctx->new;++ atomic\_dec(&octx->mmap\_changing);+ VM\_BUG\_ON(atomic\_read(&octx->mmap\_changing) < 0);+ userfaultfd\_ctx\_put(octx);+ userfaultfd\_ctx\_put(ctx);++ list\_del(&fctx->list);+ kfree(fctx);+ }+}+ void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*vma, struct vm\_userfaultfd\_ctx \*vm\_ctx) {diff --git a/include/linux/userfaultfd\_k.h b/include/linux/userfaultfd\_k.hindex a12bcf042551ea..f4a45a37229ade 100644--- a/[include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/userfaultfd_k.h?id=78b98b6e5686f54846f25b6a182568bdf0d66465)+++ b/[include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/userfaultfd_k.h?id=92b472945dbf8abc020e9259c0088026f7027dfc)@@ -249,6 +249,7 @@ static inline bool vma\_can\_userfault(struct vm\_area\_struct \*vma,  extern int dup\_userfaultfd(struct vm\_area\_struct \*, struct list\_head \*); extern void dup\_userfaultfd\_complete(struct list\_head \*);+void dup\_userfaultfd\_fail(struct list\_head \*);  extern void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*, struct vm\_userfaultfd\_ctx \*);@@ -332,6 +333,10 @@ static inline void dup\_userfaultfd\_complete(struct list\_head \*l) { } +static inline void dup\_userfaultfd\_fail(struct list\_head \*l)+{+}+ static inline void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*vma, struct vm\_userfaultfd\_ctx \*ctx) {diff --git a/kernel/fork.c b/kernel/fork.cindex dbf3c5d81df3bf..6423ce60b8f97c 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=78b98b6e5686f54846f25b6a182568bdf0d66465)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=92b472945dbf8abc020e9259c0088026f7027dfc)@@ -775,7 +775,10 @@ out: mmap\_write\_unlock(mm); flush\_tlb\_mm(oldmm); mmap\_write\_unlock(oldmm);- dup\_userfaultfd\_complete(&uf);+ if (!retval)+ dup\_userfaultfd\_complete(&uf);+ else+ dup\_userfaultfd\_fail(&uf); fail\_uprobe\_end: uprobe\_end\_dup\_mmap(); return retval; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:49:08 +0000



=== Content from git.kernel.org_c6ba2068_20250114_205032.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-10-15 18:56:05 +0100 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-28 21:40:38 -0700 |
| commit | [f64e67e5d3a45a4a04286c47afade4b518acd47b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)) | |
| tree | [33edcbc52c53268a0d8e7b8297306d2994b2a937](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) | |
| parent | [7c18d4811000945677a8531e89de3e17582e8a36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c18d4811000945677a8531e89de3e17582e8a36) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b&id2=7c18d4811000945677a8531e89de3e17582e8a36)) | |
| download | [linux-f64e67e5d3a45a4a04286c47afade4b518acd47b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f64e67e5d3a45a4a04286c47afade4b518acd47b.tar.gz) | |

fork: do not invoke uffd on fork if error occursPatch series "fork: do not expose incomplete mm on fork".
During fork we may place the virtual memory address space into an
inconsistent state before the fork operation is complete.
In addition, we may encounter an error during the fork operation that
indicates that the virtual memory address space is invalidated.
As a result, we should not be exposing it in any way to external machinery
that might interact with the mm or VMAs, machinery that is not designed to
deal with incomplete state.
We specifically update the fork logic to defer khugepaged and ksm to the
end of the operation and only to be invoked if no error arose, and
disallow uffd from observing fork events should an error have occurred.
This patch (of 2):
Currently on fork we expose the virtual address space of a process to
userland unconditionally if uffd is registered in VMAs, regardless of
whether an error arose in the fork.
This is performed in dup\_userfaultfd\_complete() which is invoked
unconditionally, and performs two duties - invoking registered handlers
for the UFFD\_EVENT\_FORK event via dup\_fctx(), and clearing down
userfaultfd\_fork\_ctx objects established in dup\_userfaultfd().
This is problematic, because the virtual address space may not yet be
correctly initialised if an error arose.
The change in commit d24062914837 ("fork: use \_\_mt\_dup() to duplicate
maple tree in dup\_mmap()") makes this more pertinent as we may be in a
state where entries in the maple tree are not yet consistent.
We address this by, on fork error, ensuring that we roll back state that
we would otherwise expect to clean up through the event being handled by
userland and perform the memory freeing duty otherwise performed by
dup\_userfaultfd\_complete().
We do this by implementing a new function, dup\_userfaultfd\_fail(), which
performs the same loop, only decrementing reference counts.
Note that we perform mmgrab() on the parent and child mm's, however
userfaultfd\_ctx\_put() will mmdrop() this once the reference count drops to
zero, so we will avoid memory leaks correctly here.
Link: [https://lkml.kernel.org/r/cover.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/cover.1729014377.git.lorenzo.stoakes%40oracle.com)
Link: [https://lkml.kernel.org/r/d3691d58bb58712b6fb3df2be441d175bd3cdf07.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/d3691d58bb58712b6fb3df2be441d175bd3cdf07.1729014377.git.lorenzo.stoakes%40oracle.com)
Fixes: d24062914837 ("fork: use \_\_mt\_dup() to duplicate maple tree in dup\_mmap()")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@Oracle.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Jan Kara <jack@suse.cz>
Cc: Linus Torvalds <torvalds@linuxfoundation.org>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)

| -rw-r--r-- | [fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/userfaultfd.c?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/userfaultfd_k.h?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 37 insertions, 1 deletions

| diff --git a/fs/userfaultfd.c b/fs/userfaultfd.cindex 68cdd89c97a3f9..7c0bd0b55f8800 100644--- a/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=7c18d4811000945677a8531e89de3e17582e8a36)+++ b/[fs/userfaultfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/userfaultfd.c?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)@@ -692,6 +692,34 @@ void dup\_userfaultfd\_complete(struct list\_head \*fcs) } } +void dup\_userfaultfd\_fail(struct list\_head \*fcs)+{+ struct userfaultfd\_fork\_ctx \*fctx, \*n;++ /\*+ \* An error has occurred on fork, we will tear memory down, but have+ \* allocated memory for fctx's and raised reference counts for both the+ \* original and child contexts (and on the mm for each as a result).+ \*+ \* These would ordinarily be taken care of by a user handling the event,+ \* but we are no longer doing so, so manually clean up here.+ \*+ \* mm tear down will take care of cleaning up VMA contexts.+ \*/+ list\_for\_each\_entry\_safe(fctx, n, fcs, list) {+ struct userfaultfd\_ctx \*octx = fctx->orig;+ struct userfaultfd\_ctx \*ctx = fctx->new;++ atomic\_dec(&octx->mmap\_changing);+ VM\_BUG\_ON(atomic\_read(&octx->mmap\_changing) < 0);+ userfaultfd\_ctx\_put(octx);+ userfaultfd\_ctx\_put(ctx);++ list\_del(&fctx->list);+ kfree(fctx);+ }+}+ void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*vma, struct vm\_userfaultfd\_ctx \*vm\_ctx) {diff --git a/include/linux/userfaultfd\_k.h b/include/linux/userfaultfd\_k.hindex 9fc6ce15c499a4..cb40f1a1d0811d 100644--- a/[include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/userfaultfd_k.h?id=7c18d4811000945677a8531e89de3e17582e8a36)+++ b/[include/linux/userfaultfd\_k.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/userfaultfd_k.h?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)@@ -249,6 +249,7 @@ static inline bool vma\_can\_userfault(struct vm\_area\_struct \*vma,  extern int dup\_userfaultfd(struct vm\_area\_struct \*, struct list\_head \*); extern void dup\_userfaultfd\_complete(struct list\_head \*);+void dup\_userfaultfd\_fail(struct list\_head \*);  extern void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*, struct vm\_userfaultfd\_ctx \*);@@ -351,6 +352,10 @@ static inline void dup\_userfaultfd\_complete(struct list\_head \*l) { } +static inline void dup\_userfaultfd\_fail(struct list\_head \*l)+{+}+ static inline void mremap\_userfaultfd\_prep(struct vm\_area\_struct \*vma, struct vm\_userfaultfd\_ctx \*ctx) {diff --git a/kernel/fork.c b/kernel/fork.cindex 89ceb4a68af250..597b477dd491f6 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=7c18d4811000945677a8531e89de3e17582e8a36)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)@@ -775,7 +775,10 @@ out: mmap\_write\_unlock(mm); flush\_tlb\_mm(oldmm); mmap\_write\_unlock(oldmm);- dup\_userfaultfd\_complete(&uf);+ if (!retval)+ dup\_userfaultfd\_complete(&uf);+ else+ dup\_userfaultfd\_fail(&uf); fail\_uprobe\_end: uprobe\_end\_dup\_mmap(); return retval; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:49:09 +0000



=== Content from project-zero.issues.chromium.org_53456ee5_20250114_205033.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F373391951&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F373391951&ec=GAZAkwI)
