=== Content from git.kernel.org_923eef59_20250114_210148.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4061e07f040a091f694f461b86a26cf95ae66439)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4061e07f040a091f694f461b86a26cf95ae66439)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4061e07f040a091f694f461b86a26cf95ae66439)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4061e07f040a091f694f461b86a26cf95ae66439)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-08-05 22:12:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:13 +0200 |
| commit | [4061e07f040a091f694f461b86a26cf95ae66439](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4061e07f040a091f694f461b86a26cf95ae66439) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4061e07f040a091f694f461b86a26cf95ae66439)) | |
| tree | [d3f6a5e584d245b5afa1f9673751869b89dc71a1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4061e07f040a091f694f461b86a26cf95ae66439) | |
| parent | [d730f53bf5214a90d15675e3cdcf4f68b5d1f097](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d730f53bf5214a90d15675e3cdcf4f68b5d1f097) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4061e07f040a091f694f461b86a26cf95ae66439&id2=d730f53bf5214a90d15675e3cdcf4f68b5d1f097)) | |
| download | [linux-4061e07f040a091f694f461b86a26cf95ae66439.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4061e07f040a091f694f461b86a26cf95ae66439.tar.gz) | |

ext4: don't set SB\_RDONLY after filesystem errors[ Upstream commit d3476f3dad4ad68ae5f6b008ea6591d1520da5d8 ]
When the filesystem is mounted with errors=remount-ro, we were setting
SB\_RDONLY flag to stop all filesystem modifications. We knew this misses
proper locking (sb->s\_umount) and does not go through proper filesystem
remount procedure but it has been the way this worked since early ext2
days and it was good enough for catastrophic situation damage
mitigation. Recently, syzbot has found a way (see link) to trigger
warnings in filesystem freezing because the code got confused by
SB\_RDONLY changing under its hands. Since these days we set
EXT4\_FLAGS\_SHUTDOWN on the superblock which is enough to stop all
filesystem modifications, modifying SB\_RDONLY shouldn't be needed. So
stop doing that.
Link: [https://lore.kernel.org/all/000000000000b90a8e061e21d12f@google.com](https://lore.kernel.org/all/000000000000b90a8e061e21d12f%40google.com)
Reported-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Christian Brauner <brauner@kernel.org>
Link: [https://patch.msgid.link/20240805201241.27286-1-jack@suse.cz](https://patch.msgid.link/20240805201241.27286-1-jack%40suse.cz)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4061e07f040a091f694f461b86a26cf95ae66439)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=4061e07f040a091f694f461b86a26cf95ae66439) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 3db39758486e92..3bf214d4afef50 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=d730f53bf5214a90d15675e3cdcf4f68b5d1f097)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=4061e07f040a091f694f461b86a26cf95ae66439)@@ -692,11 +692,12 @@ static void ext4\_handle\_error(struct super\_block \*sb, bool force\_ro, int error,  ext4\_msg(sb, KERN\_CRIT, "Remounting filesystem read-only"); /\*- \* Make sure updated value of ->s\_mount\_flags will be visible before- \* ->s\_flags update+ \* EXT4\_FLAGS\_SHUTDOWN was set which stops all filesystem+ \* modifications. We don't set SB\_RDONLY because that requires+ \* sb->s\_umount semaphore and setting it without proper remount+ \* procedure is confusing code such as freeze\_super() leading to+ \* deadlocks and other problems. \*/- smp\_wmb();- sb->s\_flags |= SB\_RDONLY; }  static void flush\_stashed\_error\_work(struct work\_struct \*work) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:00:26 +0000



=== Content from git.kernel.org_26c9e714_20250114_210151.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-08-05 22:12:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:50 +0200 |
| commit | [fbb177bc1d6487cd3e9b50ae0be2781b7297980d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)) | |
| tree | [104733ec8b18577e94f03716dd8d94ad168b17e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d) | |
| parent | [11cd5f6e35784723008d366f809a2d6c8574e70f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11cd5f6e35784723008d366f809a2d6c8574e70f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d&id2=11cd5f6e35784723008d366f809a2d6c8574e70f)) | |
| download | [linux-fbb177bc1d6487cd3e9b50ae0be2781b7297980d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fbb177bc1d6487cd3e9b50ae0be2781b7297980d.tar.gz) | |

ext4: don't set SB\_RDONLY after filesystem errors[ Upstream commit d3476f3dad4ad68ae5f6b008ea6591d1520da5d8 ]
When the filesystem is mounted with errors=remount-ro, we were setting
SB\_RDONLY flag to stop all filesystem modifications. We knew this misses
proper locking (sb->s\_umount) and does not go through proper filesystem
remount procedure but it has been the way this worked since early ext2
days and it was good enough for catastrophic situation damage
mitigation. Recently, syzbot has found a way (see link) to trigger
warnings in filesystem freezing because the code got confused by
SB\_RDONLY changing under its hands. Since these days we set
EXT4\_FLAGS\_SHUTDOWN on the superblock which is enough to stop all
filesystem modifications, modifying SB\_RDONLY shouldn't be needed. So
stop doing that.
Link: [https://lore.kernel.org/all/000000000000b90a8e061e21d12f@google.com](https://lore.kernel.org/all/000000000000b90a8e061e21d12f%40google.com)
Reported-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Christian Brauner <brauner@kernel.org>
Link: [https://patch.msgid.link/20240805201241.27286-1-jack@suse.cz](https://patch.msgid.link/20240805201241.27286-1-jack%40suse.cz)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex b09b7a6b7a154c..93eb26c162422d 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=11cd5f6e35784723008d366f809a2d6c8574e70f)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=fbb177bc1d6487cd3e9b50ae0be2781b7297980d)@@ -674,11 +674,12 @@ static void ext4\_handle\_error(struct super\_block \*sb, bool force\_ro, int error,  ext4\_msg(sb, KERN\_CRIT, "Remounting filesystem read-only"); /\*- \* Make sure updated value of ->s\_mount\_flags will be visible before- \* ->s\_flags update+ \* EXT4\_FLAGS\_SHUTDOWN was set which stops all filesystem+ \* modifications. We don't set SB\_RDONLY because that requires+ \* sb->s\_umount semaphore and setting it without proper remount+ \* procedure is confusing code such as freeze\_super() leading to+ \* deadlocks and other problems. \*/- smp\_wmb();- sb->s\_flags |= SB\_RDONLY; }  static void flush\_stashed\_error\_work(struct work\_struct \*work) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:00:28 +0000



=== Content from git.kernel.org_b176d04f_20250114_210150.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-08-05 22:12:41 +0200 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-08-26 23:53:20 -0400 |
| commit | [d3476f3dad4ad68ae5f6b008ea6591d1520da5d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)) | |
| tree | [08c6ca8556271e0e13aac77f139e070c2073504a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8) | |
| parent | [d1bc560e9a9c78d0b2314692847fc8661e0aeb99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1bc560e9a9c78d0b2314692847fc8661e0aeb99) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8&id2=d1bc560e9a9c78d0b2314692847fc8661e0aeb99)) | |
| download | [linux-d3476f3dad4ad68ae5f6b008ea6591d1520da5d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3476f3dad4ad68ae5f6b008ea6591d1520da5d8.tar.gz) | |

ext4: don't set SB\_RDONLY after filesystem errorsWhen the filesystem is mounted with errors=remount-ro, we were setting
SB\_RDONLY flag to stop all filesystem modifications. We knew this misses
proper locking (sb->s\_umount) and does not go through proper filesystem
remount procedure but it has been the way this worked since early ext2
days and it was good enough for catastrophic situation damage
mitigation. Recently, syzbot has found a way (see link) to trigger
warnings in filesystem freezing because the code got confused by
SB\_RDONLY changing under its hands. Since these days we set
EXT4\_FLAGS\_SHUTDOWN on the superblock which is enough to stop all
filesystem modifications, modifying SB\_RDONLY shouldn't be needed. So
stop doing that.
Link: [https://lore.kernel.org/all/000000000000b90a8e061e21d12f@google.com](https://lore.kernel.org/all/000000000000b90a8e061e21d12f%40google.com)
Reported-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Christian Brauner <brauner@kernel.org>
Link: [https://patch.msgid.link/20240805201241.27286-1-jack@suse.cz](https://patch.msgid.link/20240805201241.27286-1-jack%40suse.cz)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 89d9b34d787ac8..58423e6bf3d078 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=d1bc560e9a9c78d0b2314692847fc8661e0aeb99)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)@@ -735,11 +735,12 @@ static void ext4\_handle\_error(struct super\_block \*sb, bool force\_ro, int error,  ext4\_msg(sb, KERN\_CRIT, "Remounting filesystem read-only"); /\*- \* Make sure updated value of ->s\_mount\_flags will be visible before- \* ->s\_flags update+ \* EXT4\_FLAGS\_SHUTDOWN was set which stops all filesystem+ \* modifications. We don't set SB\_RDONLY because that requires+ \* sb->s\_umount semaphore and setting it without proper remount+ \* procedure is confusing code such as freeze\_super() leading to+ \* deadlocks and other problems. \*/- smp\_wmb();- sb->s\_flags |= SB\_RDONLY; }  static void update\_super\_work(struct work\_struct \*work) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:00:27 +0000



=== Content from git.kernel.org_93a3424c_20250114_210150.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ee77c388469116565e009eaa704a60bc78489e09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee77c388469116565e009eaa704a60bc78489e09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee77c388469116565e009eaa704a60bc78489e09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee77c388469116565e009eaa704a60bc78489e09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-08-05 22:12:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:34 +0200 |
| commit | [ee77c388469116565e009eaa704a60bc78489e09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee77c388469116565e009eaa704a60bc78489e09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ee77c388469116565e009eaa704a60bc78489e09)) | |
| tree | [077f3f79a53d95870125aaf01fc865a41fa8a415](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee77c388469116565e009eaa704a60bc78489e09) | |
| parent | [dedbab6143a73868984dd321d803cb52702a8a61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dedbab6143a73868984dd321d803cb52702a8a61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee77c388469116565e009eaa704a60bc78489e09&id2=dedbab6143a73868984dd321d803cb52702a8a61)) | |
| download | [linux-ee77c388469116565e009eaa704a60bc78489e09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ee77c388469116565e009eaa704a60bc78489e09.tar.gz) | |

ext4: don't set SB\_RDONLY after filesystem errors[ Upstream commit d3476f3dad4ad68ae5f6b008ea6591d1520da5d8 ]
When the filesystem is mounted with errors=remount-ro, we were setting
SB\_RDONLY flag to stop all filesystem modifications. We knew this misses
proper locking (sb->s\_umount) and does not go through proper filesystem
remount procedure but it has been the way this worked since early ext2
days and it was good enough for catastrophic situation damage
mitigation. Recently, syzbot has found a way (see link) to trigger
warnings in filesystem freezing because the code got confused by
SB\_RDONLY changing under its hands. Since these days we set
EXT4\_FLAGS\_SHUTDOWN on the superblock which is enough to stop all
filesystem modifications, modifying SB\_RDONLY shouldn't be needed. So
stop doing that.
Link: [https://lore.kernel.org/all/000000000000b90a8e061e21d12f@google.com](https://lore.kernel.org/all/000000000000b90a8e061e21d12f%40google.com)
Reported-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Christian Brauner <brauner@kernel.org>
Link: [https://patch.msgid.link/20240805201241.27286-1-jack@suse.cz](https://patch.msgid.link/20240805201241.27286-1-jack%40suse.cz)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee77c388469116565e009eaa704a60bc78489e09)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=ee77c388469116565e009eaa704a60bc78489e09) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 687d406f47a92b..cd3328b0315349 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=dedbab6143a73868984dd321d803cb52702a8a61)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=ee77c388469116565e009eaa704a60bc78489e09)@@ -735,11 +735,12 @@ static void ext4\_handle\_error(struct super\_block \*sb, bool force\_ro, int error,  ext4\_msg(sb, KERN\_CRIT, "Remounting filesystem read-only"); /\*- \* Make sure updated value of ->s\_mount\_flags will be visible before- \* ->s\_flags update+ \* EXT4\_FLAGS\_SHUTDOWN was set which stops all filesystem+ \* modifications. We don't set SB\_RDONLY because that requires+ \* sb->s\_umount semaphore and setting it without proper remount+ \* procedure is confusing code such as freeze\_super() leading to+ \* deadlocks and other problems. \*/- smp\_wmb();- sb->s\_flags |= SB\_RDONLY; }  static void update\_super\_work(struct work\_struct \*work) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:00:28 +0000



=== Content from git.kernel.org_7ca6af9e_20250114_210148.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-08-05 22:12:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:15 +0200 |
| commit | [58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)) | |
| tree | [b56ae5a447cc3c30a31d5a5c15c0317284eb7605](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9) | |
| parent | [cadbdd78e0495e345091b47710b356f2665c31ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadbdd78e0495e345091b47710b356f2665c31ac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9&id2=cadbdd78e0495e345091b47710b356f2665c31ac)) | |
| download | [linux-58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9.tar.gz) | |

ext4: don't set SB\_RDONLY after filesystem errors[ Upstream commit d3476f3dad4ad68ae5f6b008ea6591d1520da5d8 ]
When the filesystem is mounted with errors=remount-ro, we were setting
SB\_RDONLY flag to stop all filesystem modifications. We knew this misses
proper locking (sb->s\_umount) and does not go through proper filesystem
remount procedure but it has been the way this worked since early ext2
days and it was good enough for catastrophic situation damage
mitigation. Recently, syzbot has found a way (see link) to trigger
warnings in filesystem freezing because the code got confused by
SB\_RDONLY changing under its hands. Since these days we set
EXT4\_FLAGS\_SHUTDOWN on the superblock which is enough to stop all
filesystem modifications, modifying SB\_RDONLY shouldn't be needed. So
stop doing that.
Link: [https://lore.kernel.org/all/000000000000b90a8e061e21d12f@google.com](https://lore.kernel.org/all/000000000000b90a8e061e21d12f%40google.com)
Reported-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Christian Brauner <brauner@kernel.org>
Link: [https://patch.msgid.link/20240805201241.27286-1-jack@suse.cz](https://patch.msgid.link/20240805201241.27286-1-jack%40suse.cz)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex ed0dc4cc1d28e9..1d14a38017a7f0 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=cadbdd78e0495e345091b47710b356f2665c31ac)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=58c0648e4c773f5b54f0cb63bc8c7c6bf52719a9)@@ -744,11 +744,12 @@ static void ext4\_handle\_error(struct super\_block \*sb, bool force\_ro, int error,  ext4\_msg(sb, KERN\_CRIT, "Remounting filesystem read-only"); /\*- \* Make sure updated value of ->s\_mount\_flags will be visible before- \* ->s\_flags update+ \* EXT4\_FLAGS\_SHUTDOWN was set which stops all filesystem+ \* modifications. We don't set SB\_RDONLY because that requires+ \* sb->s\_umount semaphore and setting it without proper remount+ \* procedure is confusing code such as freeze\_super() leading to+ \* deadlocks and other problems. \*/- smp\_wmb();- sb->s\_flags |= SB\_RDONLY; }  static void update\_super\_work(struct work\_struct \*work) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:46:32 +0000


