=== Content from git.kernel.org_22b0986a_20250114_192441.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Petr Pavlu <petr.pavlu@suse.com> | 2024-10-15 13:24:29 +0200 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-10-15 11:18:51 -0400 |
| commit | [09661f75e75cb6c1d2d8326a70c311d46729235f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09661f75e75cb6c1d2d8326a70c311d46729235f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)) | |
| tree | [3a9827735e637f6deb0fd4acb6762fef633f8b6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09661f75e75cb6c1d2d8326a70c311d46729235f) | |
| parent | [2cf9733891a460a16a209fcc20fbd138605b13b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2cf9733891a460a16a209fcc20fbd138605b13b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09661f75e75cb6c1d2d8326a70c311d46729235f&id2=2cf9733891a460a16a209fcc20fbd138605b13b8)) | |
| download | [linux-09661f75e75cb6c1d2d8326a70c311d46729235f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-09661f75e75cb6c1d2d8326a70c311d46729235f.tar.gz) | |

ring-buffer: Fix reader locking when changing the sub buffer orderThe function ring\_buffer\_subbuf\_order\_set() updates each
ring\_buffer\_per\_cpu and installs new sub buffers that match the requested
page order. This operation may be invoked concurrently with readers that
rely on some of the modified data, such as the head bit (RB\_PAGE\_HEAD), or
the ring\_buffer\_per\_cpu.pages and reader\_page pointers. However, no
exclusive access is acquired by ring\_buffer\_subbuf\_order\_set(). Modifying
the mentioned data while a reader also operates on them can then result in
incorrect memory access and various crashes.
Fix the problem by taking the reader\_lock when updating a specific
ring\_buffer\_per\_cpu in ring\_buffer\_subbuf\_order\_set().
Link: [https://lore.kernel.org/linux-trace-kernel/20240715145141.5528-1-petr.pavlu@suse.com/](https://lore.kernel.org/linux-trace-kernel/20240715145141.5528-1-petr.pavlu%40suse.com/)
Link: [https://lore.kernel.org/linux-trace-kernel/20241010195849.2f77cc3f@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20241010195849.2f77cc3f%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20241011112850.17212b25@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20241011112850.17212b25%40gandalf.local.home/)
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20241015112440.26987-1-petr.pavlu@suse.com](https://lore.kernel.org/20241015112440.26987-1-petr.pavlu%40suse.com)
Fixes: 8e7b58c27b3c ("ring-buffer: Just update the subbuffers when changing their allocation order")
Signed-off-by: Petr Pavlu <petr.pavlu@suse.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09661f75e75cb6c1d2d8326a70c311d46729235f)

| -rw-r--r-- | [kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/ring_buffer.c?id=09661f75e75cb6c1d2d8326a70c311d46729235f) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 18 deletions

| diff --git a/kernel/trace/ring\_buffer.c b/kernel/trace/ring\_buffer.cindex fb04445f92c353..3ea4f7bb1837ce 100644--- a/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=2cf9733891a460a16a209fcc20fbd138605b13b8)+++ b/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=09661f75e75cb6c1d2d8326a70c311d46729235f)@@ -6728,39 +6728,38 @@ int ring\_buffer\_subbuf\_order\_set(struct trace\_buffer \*buffer, int order) }  for\_each\_buffer\_cpu(buffer, cpu) {+ struct buffer\_data\_page \*old\_free\_data\_page;+ struct list\_head old\_pages;+ unsigned long flags;  if (!cpumask\_test\_cpu(cpu, buffer->cpumask)) continue;  cpu\_buffer = buffer->buffers[cpu]; + raw\_spin\_lock\_irqsave(&cpu\_buffer->reader\_lock, flags);+ /\* Clear the head bit to make the link list normal to read \*/ rb\_head\_page\_deactivate(cpu\_buffer); - /\* Now walk the list and free all the old sub buffers \*/- list\_for\_each\_entry\_safe(bpage, tmp, cpu\_buffer->pages, list) {- list\_del\_init(&bpage->list);- free\_buffer\_page(bpage);- }- /\* The above loop stopped an the last page needing to be freed \*/- bpage = list\_entry(cpu\_buffer->pages, struct buffer\_page, list);- free\_buffer\_page(bpage);-- /\* Free the current reader page \*/- free\_buffer\_page(cpu\_buffer->reader\_page);+ /\*+ \* Collect buffers from the cpu\_buffer pages list and the+ \* reader\_page on old\_pages, so they can be freed later when not+ \* under a spinlock. The pages list is a linked list with no+ \* head, adding old\_pages turns it into a regular list with+ \* old\_pages being the head.+ \*/+ list\_add(&old\_pages, cpu\_buffer->pages);+ list\_add(&cpu\_buffer->reader\_page->list, &old\_pages);  /\* One page was allocated for the reader page \*/ cpu\_buffer->reader\_page = list\_entry(cpu\_buffer->new\_pages.next, struct buffer\_page, list); list\_del\_init(&cpu\_buffer->reader\_page->list); - /\* The cpu\_buffer pages are a link list with no head \*/+ /\* Install the new pages, remove the head from the list \*/ cpu\_buffer->pages = cpu\_buffer->new\_pages.next;- cpu\_buffer->new\_pages.next->prev = cpu\_buffer->new\_pages.prev;- cpu\_buffer->new\_pages.prev->next = cpu\_buffer->new\_pages.next;-- /\* Clear the new\_pages list \*/- INIT\_LIST\_HEAD(&cpu\_buffer->new\_pages);+ list\_del\_init(&cpu\_buffer->new\_pages);  cpu\_buffer->head\_page = list\_entry(cpu\_buffer->pages, struct buffer\_page, list);@@ -6769,11 +6768,20 @@ int ring\_buffer\_subbuf\_order\_set(struct trace\_buffer \*buffer, int order) cpu\_buffer->nr\_pages = cpu\_buffer->nr\_pages\_to\_update; cpu\_buffer->nr\_pages\_to\_update = 0; - free\_pages((unsigned long)cpu\_buffer->free\_page, old\_order);+ old\_free\_data\_page = cpu\_buffer->free\_page; cpu\_buffer->free\_page = NULL;  rb\_head\_page\_activate(cpu\_buffer); + raw\_spin\_unlock\_irqrestore(&cpu\_buffer->reader\_lock, flags);++ /\* Free old sub buffers \*/+ list\_for\_each\_entry\_safe(bpage, tmp, &old\_pages, list) {+ list\_del\_init(&bpage->list);+ free\_buffer\_page(bpage);+ }+ free\_pages((unsigned long)old\_free\_data\_page, old\_order);+ rb\_check\_pages(cpu\_buffer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:18 +0000



=== Content from git.kernel.org_af16489a_20250114_192442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a569290525a05162d5dd26d9845591eaf46e5802)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a569290525a05162d5dd26d9845591eaf46e5802)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a569290525a05162d5dd26d9845591eaf46e5802)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a569290525a05162d5dd26d9845591eaf46e5802)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Petr Pavlu <petr.pavlu@suse.com> | 2024-10-15 13:24:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:28 +0100 |
| commit | [a569290525a05162d5dd26d9845591eaf46e5802](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a569290525a05162d5dd26d9845591eaf46e5802) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a569290525a05162d5dd26d9845591eaf46e5802)) | |
| tree | [de05ed7aa6094a822606b7dc91e59065291a124a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a569290525a05162d5dd26d9845591eaf46e5802) | |
| parent | [e6c1d8201ec68a529108041991cd005345022a5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6c1d8201ec68a529108041991cd005345022a5d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a569290525a05162d5dd26d9845591eaf46e5802&id2=e6c1d8201ec68a529108041991cd005345022a5d)) | |
| download | [linux-a569290525a05162d5dd26d9845591eaf46e5802.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a569290525a05162d5dd26d9845591eaf46e5802.tar.gz) | |

ring-buffer: Fix reader locking when changing the sub buffer order[ Upstream commit 09661f75e75cb6c1d2d8326a70c311d46729235f ]
The function ring\_buffer\_subbuf\_order\_set() updates each
ring\_buffer\_per\_cpu and installs new sub buffers that match the requested
page order. This operation may be invoked concurrently with readers that
rely on some of the modified data, such as the head bit (RB\_PAGE\_HEAD), or
the ring\_buffer\_per\_cpu.pages and reader\_page pointers. However, no
exclusive access is acquired by ring\_buffer\_subbuf\_order\_set(). Modifying
the mentioned data while a reader also operates on them can then result in
incorrect memory access and various crashes.
Fix the problem by taking the reader\_lock when updating a specific
ring\_buffer\_per\_cpu in ring\_buffer\_subbuf\_order\_set().
Link: [https://lore.kernel.org/linux-trace-kernel/20240715145141.5528-1-petr.pavlu@suse.com/](https://lore.kernel.org/linux-trace-kernel/20240715145141.5528-1-petr.pavlu%40suse.com/)
Link: [https://lore.kernel.org/linux-trace-kernel/20241010195849.2f77cc3f@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20241010195849.2f77cc3f%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20241011112850.17212b25@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20241011112850.17212b25%40gandalf.local.home/)
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20241015112440.26987-1-petr.pavlu@suse.com](https://lore.kernel.org/20241015112440.26987-1-petr.pavlu%40suse.com)
Fixes: 8e7b58c27b3c ("ring-buffer: Just update the subbuffers when changing their allocation order")
Signed-off-by: Petr Pavlu <petr.pavlu@suse.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a569290525a05162d5dd26d9845591eaf46e5802)

| -rw-r--r-- | [kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/ring_buffer.c?id=a569290525a05162d5dd26d9845591eaf46e5802) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 18 deletions

| diff --git a/kernel/trace/ring\_buffer.c b/kernel/trace/ring\_buffer.cindex cebd879a30cbd1..fb7b092e793137 100644--- a/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=e6c1d8201ec68a529108041991cd005345022a5d)+++ b/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=a569290525a05162d5dd26d9845591eaf46e5802)@@ -6008,39 +6008,38 @@ int ring\_buffer\_subbuf\_order\_set(struct trace\_buffer \*buffer, int order) }  for\_each\_buffer\_cpu(buffer, cpu) {+ struct buffer\_data\_page \*old\_free\_data\_page;+ struct list\_head old\_pages;+ unsigned long flags;  if (!cpumask\_test\_cpu(cpu, buffer->cpumask)) continue;  cpu\_buffer = buffer->buffers[cpu]; + raw\_spin\_lock\_irqsave(&cpu\_buffer->reader\_lock, flags);+ /\* Clear the head bit to make the link list normal to read \*/ rb\_head\_page\_deactivate(cpu\_buffer); - /\* Now walk the list and free all the old sub buffers \*/- list\_for\_each\_entry\_safe(bpage, tmp, cpu\_buffer->pages, list) {- list\_del\_init(&bpage->list);- free\_buffer\_page(bpage);- }- /\* The above loop stopped an the last page needing to be freed \*/- bpage = list\_entry(cpu\_buffer->pages, struct buffer\_page, list);- free\_buffer\_page(bpage);-- /\* Free the current reader page \*/- free\_buffer\_page(cpu\_buffer->reader\_page);+ /\*+ \* Collect buffers from the cpu\_buffer pages list and the+ \* reader\_page on old\_pages, so they can be freed later when not+ \* under a spinlock. The pages list is a linked list with no+ \* head, adding old\_pages turns it into a regular list with+ \* old\_pages being the head.+ \*/+ list\_add(&old\_pages, cpu\_buffer->pages);+ list\_add(&cpu\_buffer->reader\_page->list, &old\_pages);  /\* One page was allocated for the reader page \*/ cpu\_buffer->reader\_page = list\_entry(cpu\_buffer->new\_pages.next, struct buffer\_page, list); list\_del\_init(&cpu\_buffer->reader\_page->list); - /\* The cpu\_buffer pages are a link list with no head \*/+ /\* Install the new pages, remove the head from the list \*/ cpu\_buffer->pages = cpu\_buffer->new\_pages.next;- cpu\_buffer->new\_pages.next->prev = cpu\_buffer->new\_pages.prev;- cpu\_buffer->new\_pages.prev->next = cpu\_buffer->new\_pages.next;-- /\* Clear the new\_pages list \*/- INIT\_LIST\_HEAD(&cpu\_buffer->new\_pages);+ list\_del\_init(&cpu\_buffer->new\_pages);  cpu\_buffer->head\_page = list\_entry(cpu\_buffer->pages, struct buffer\_page, list);@@ -6049,11 +6048,20 @@ int ring\_buffer\_subbuf\_order\_set(struct trace\_buffer \*buffer, int order) cpu\_buffer->nr\_pages = cpu\_buffer->nr\_pages\_to\_update; cpu\_buffer->nr\_pages\_to\_update = 0; - free\_pages((unsigned long)cpu\_buffer->free\_page, old\_order);+ old\_free\_data\_page = cpu\_buffer->free\_page; cpu\_buffer->free\_page = NULL;  rb\_head\_page\_activate(cpu\_buffer); + raw\_spin\_unlock\_irqrestore(&cpu\_buffer->reader\_lock, flags);++ /\* Free old sub buffers \*/+ list\_for\_each\_entry\_safe(bpage, tmp, &old\_pages, list) {+ list\_del\_init(&bpage->list);+ free\_buffer\_page(bpage);+ }+ free\_pages((unsigned long)old\_free\_data\_page, old\_order);+ rb\_check\_pages(cpu\_buffer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:23:19 +0000


