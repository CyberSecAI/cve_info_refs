=== Content from git.kernel.org_0d386681_20250115_090750.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c38add9ac0e4d4f418e6443a688491499021add9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c38add9ac0e4d4f418e6443a688491499021add9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c38add9ac0e4d4f418e6443a688491499021add9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c38add9ac0e4d4f418e6443a688491499021add9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-19 12:29:09 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:30 +0200 |
| commit | [c38add9ac0e4d4f418e6443a688491499021add9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c38add9ac0e4d4f418e6443a688491499021add9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c38add9ac0e4d4f418e6443a688491499021add9)) | |
| tree | [ef504041a1995a51705a7452191b39e02e651df0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c38add9ac0e4d4f418e6443a688491499021add9) | |
| parent | [fde99e972b8f88cebe619241d7aa43d288ef666a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fde99e972b8f88cebe619241d7aa43d288ef666a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c38add9ac0e4d4f418e6443a688491499021add9&id2=fde99e972b8f88cebe619241d7aa43d288ef666a)) | |
| download | [linux-c38add9ac0e4d4f418e6443a688491499021add9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c38add9ac0e4d4f418e6443a688491499021add9.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitcommit 4dabcdf581217e60690467a37c956a5b8dbc6bd9 upstream.
Syzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflict in tcp\_output.c, because commit 65249feb6b3d ("net: add
support for skbs with unreadable frags"), and commit 9b65b17db723
("net: avoid double accounting for pure zerocopy skbs") are not in
this version. These commits are linked to new features and introduce
new conditions which cause the conflicts. Resolving this is easy: we
can ignore the missing new condition, and use tcp\_skb\_can\_collapse()
like in the original patch. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c38add9ac0e4d4f418e6443a688491499021add9)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=c38add9ac0e4d4f418e6443a688491499021add9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 68f1633c477aed..165be30e42c0c4 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=c38add9ac0e4d4f418e6443a688491499021add9)@@ -2305,7 +2305,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) || tcp\_has\_tx\_tstamp(skb))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:27 +0000



=== Content from git.kernel.org_7e79c332_20250115_090746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-18 17:57:36 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:36 +0200 |
| commit | [229dfdc36f31a8d47433438bc0e6e1662c4ab404](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)) | |
| tree | [559874c71d07498ec48fbd8486a28a6e5f4c8f27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404) | |
| parent | [647cd4494cc301f019267b901ab5cf71f3e54d57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=647cd4494cc301f019267b901ab5cf71f3e54d57) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404&id2=647cd4494cc301f019267b901ab5cf71f3e54d57)) | |
| download | [linux-229dfdc36f31a8d47433438bc0e6e1662c4ab404.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-229dfdc36f31a8d47433438bc0e6e1662c4ab404.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitcommit 4dabcdf581217e60690467a37c956a5b8dbc6bd9 upstream.
Syzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflict in tcp\_output.c, because the commit 65249feb6b3d ("net: add
support for skbs with unreadable frags") is not in this version. This
commit is linked to a new feature (Devmem TCP) and introduces a new
condition which causes the conflicts. Resolving this is easy: we can
ignore the missing new condition, and use tcp\_skb\_can\_collapse() like
in the original patch. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 15c49d559db536..328640d9b60762 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=647cd4494cc301f019267b901ab5cf71f3e54d57)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=229dfdc36f31a8d47433438bc0e6e1662c4ab404)@@ -2314,9 +2314,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) ||- tcp\_has\_tx\_tstamp(skb) ||- !skb\_pure\_zcopy\_same(skb, next))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:23 +0000



=== Content from git.kernel.org_bf77ba44_20250115_090747.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:53 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-09 19:43:44 -0700 |
| commit | [4dabcdf581217e60690467a37c956a5b8dbc6bd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)) | |
| tree | [8658190e0aac0c244a412ad6b194c9946b134c41](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9) | |
| parent | [e32d262c89e2b22cb0640223f953b548617ed8a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e32d262c89e2b22cb0640223f953b548617ed8a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9&id2=e32d262c89e2b22cb0640223f953b548617ed8a6)) | |
| download | [linux-4dabcdf581217e60690467a37c956a5b8dbc6bd9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4dabcdf581217e60690467a37c956a5b8dbc6bd9.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitSyzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 4 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 4fd746bd4d54f6..68804fd01dafc4 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=4dabcdf581217e60690467a37c956a5b8dbc6bd9)@@ -2342,10 +2342,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) ||- tcp\_has\_tx\_tstamp(skb) ||- !skb\_pure\_zcopy\_same(skb, next) ||- skb\_frags\_readable(skb) != skb\_frags\_readable(next))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:24 +0000



=== Content from git.kernel.org_f9fcf905_20250115_090750.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:21 +0200 |
| commit | [db04d1848777ae52a7ab93c4591e7c0bf8f55fb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)) | |
| tree | [1bc27fa6e692287c2a14a900e26322c440dbeecb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4) | |
| parent | [05d43455f6bffa6abc7b937ca58be00452e6973f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d43455f6bffa6abc7b937ca58be00452e6973f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4&id2=05d43455f6bffa6abc7b937ca58be00452e6973f)) | |
| download | [linux-db04d1848777ae52a7ab93c4591e7c0bf8f55fb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db04d1848777ae52a7ab93c4591e7c0bf8f55fb4.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitcommit 4dabcdf581217e60690467a37c956a5b8dbc6bd9 upstream.
Syzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflict in tcp\_output.c, because the commit 65249feb6b3d ("net: add
support for skbs with unreadable frags") is not in this version. This
commit is linked to a new feature (Devmem TCP) and introduces a new
condition which causes the conflicts. Resolving this is easy: we can
ignore the missing new condition, and use tcp\_skb\_can\_collapse() like
in the original patch. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 16c48df8df4cc8..8f67eea34779e1 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=05d43455f6bffa6abc7b937ca58be00452e6973f)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=db04d1848777ae52a7ab93c4591e7c0bf8f55fb4)@@ -2342,9 +2342,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) ||- tcp\_has\_tx\_tstamp(skb) ||- !skb\_pure\_zcopy\_same(skb, next))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:27 +0000



=== Content from git.kernel.org_41fc7394_20250115_090748.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-19 11:30:49 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:47 +0200 |
| commit | [9729010a0ac5945c1bf6847dd0778d8a1a4b72ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)) | |
| tree | [374986ede61f09c99e5b491a8aeb173d70876956](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac) | |
| parent | [12c1676d598e3b8dd92a033b623b792cc2ea1ec5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac&id2=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)) | |
| download | [linux-9729010a0ac5945c1bf6847dd0778d8a1a4b72ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9729010a0ac5945c1bf6847dd0778d8a1a4b72ac.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitcommit 4dabcdf581217e60690467a37c956a5b8dbc6bd9 upstream.
Syzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflict in tcp\_output.c, because commit 65249feb6b3d ("net: add
support for skbs with unreadable frags"), and commit 9b65b17db723
("net: avoid double accounting for pure zerocopy skbs") are not in
this version. These commits are linked to new features and introduce
new conditions which cause the conflicts. Resolving this is easy: we
can ignore the missing new condition, and use tcp\_skb\_can\_collapse()
like in the original patch. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 2c9670c8320204..44eedae43eaa47 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=9729010a0ac5945c1bf6847dd0778d8a1a4b72ac)@@ -2308,7 +2308,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) || tcp\_has\_tx\_tstamp(skb))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:25 +0000



=== Content from git.kernel.org_83fc9e7a_20250115_090749.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-18 19:36:58 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:51 +0200 |
| commit | [ba8e65814e519eeb17d086952bce7de93f7a40da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba8e65814e519eeb17d086952bce7de93f7a40da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)) | |
| tree | [3cdb7b2f9910ef724d86c5b980070b2a49694188](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba8e65814e519eeb17d086952bce7de93f7a40da) | |
| parent | [b2a4a2dad31d7e84c4c01ac6fd39e8155afbceb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2a4a2dad31d7e84c4c01ac6fd39e8155afbceb9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba8e65814e519eeb17d086952bce7de93f7a40da&id2=b2a4a2dad31d7e84c4c01ac6fd39e8155afbceb9)) | |
| download | [linux-ba8e65814e519eeb17d086952bce7de93f7a40da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ba8e65814e519eeb17d086952bce7de93f7a40da.tar.gz) | |

tcp: fix mptcp DSS corruption due to large pmtu xmitcommit 4dabcdf581217e60690467a37c956a5b8dbc6bd9 upstream.
Syzkaller was able to trigger a DSS corruption:
TCP: request\_sock\_subflow\_v4: Possible SYN flooding on port [::]:20002. Sending cookies.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 5227 at net/mptcp/protocol.c:695 \_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Modules linked in:
CPU: 0 UID: 0 PID: 5227 Comm: syz-executor350 Not tainted 6.11.0-syzkaller-08829-gaf9c191ac2a0 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
RIP: 0010:\_\_mptcp\_move\_skbs\_from\_subflow+0x20a9/0x21f0 net/mptcp/protocol.c:695
Code: 0f b6 dc 31 ff 89 de e8 b5 dd ea f5 89 d8 48 81 c4 50 01 00 00 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc e8 98 da ea f5 90 <0f> 0b 90 e9 47 ff ff ff e8 8a da ea f5 90 0f 0b 90 e9 99 e0 ff ff
RSP: 0018:ffffc90000006db8 EFLAGS: 00010246
RAX: ffffffff8ba9df18 RBX: 00000000000055f0 RCX: ffff888030023c00
RDX: 0000000000000100 RSI: 00000000000081e5 RDI: 00000000000055f0
RBP: 1ffff110062bf1ae R08: ffffffff8ba9cf12 R09: 1ffff110062bf1b8
R10: dffffc0000000000 R11: ffffed10062bf1b9 R12: 0000000000000000
R13: dffffc0000000000 R14: 00000000700cec61 R15: 00000000000081e5
FS: 000055556679c380(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020287000 CR3: 0000000077892000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
move\_skbs\_to\_msk net/mptcp/protocol.c:811 [inline]
mptcp\_data\_ready+0x29c/0xa90 net/mptcp/protocol.c:854
subflow\_data\_ready+0x34a/0x920 net/mptcp/subflow.c:1490
tcp\_data\_queue+0x20fd/0x76c0 net/ipv4/tcp\_input.c:5283
tcp\_rcv\_established+0xfba/0x2020 net/ipv4/tcp\_input.c:6237
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
tcp\_v4\_rcv+0x2dc0/0x37f0 net/ipv4/tcp\_ipv4.c:2350
ip\_protocol\_deliver\_rcu+0x22e/0x440 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x341/0x5f0 net/ipv4/ip\_input.c:233
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
NF\_HOOK+0x3a4/0x450 include/linux/netfilter.h:314
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5662 [inline]
\_\_netif\_receive\_skb+0x2bf/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6107
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6771
napi\_poll net/core/dev.c:6840 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6962
handle\_softirqs+0x2c5/0x980 kernel/softirq.c:554
do\_softirq+0x11b/0x1e0 kernel/softirq.c:455
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x1bb/0x200 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:919 [inline]
\_\_dev\_queue\_xmit+0x1764/0x3e80 net/core/dev.c:4451
dev\_queue\_xmit include/linux/netdevice.h:3094 [inline]
neigh\_hh\_output include/net/neighbour.h:526 [inline]
neigh\_output include/net/neighbour.h:540 [inline]
ip\_finish\_output2+0xd41/0x1390 net/ipv4/ip\_output.c:236
ip\_local\_out net/ipv4/ip\_output.c:130 [inline]
\_\_ip\_queue\_xmit+0x118c/0x1b80 net/ipv4/ip\_output.c:536
\_\_tcp\_transmit\_skb+0x2544/0x3b30 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_mtu\_probe net/ipv4/tcp\_output.c:2547 [inline]
tcp\_write\_xmit+0x641d/0x6bf0 net/ipv4/tcp\_output.c:2752
\_\_tcp\_push\_pending\_frames+0x9b/0x360 net/ipv4/tcp\_output.c:3015
tcp\_push\_pending\_frames include/net/tcp.h:2107 [inline]
tcp\_data\_snd\_check net/ipv4/tcp\_input.c:5714 [inline]
tcp\_rcv\_established+0x1026/0x2020 net/ipv4/tcp\_input.c:6239
tcp\_v4\_do\_rcv+0x96d/0xc70 net/ipv4/tcp\_ipv4.c:1915
sk\_backlog\_rcv include/net/sock.h:1113 [inline]
\_\_release\_sock+0x214/0x350 net/core/sock.c:3072
release\_sock+0x61/0x1f0 net/core/sock.c:3626
mptcp\_push\_release net/mptcp/protocol.c:1486 [inline]
\_\_mptcp\_push\_pending+0x6b5/0x9f0 net/mptcp/protocol.c:1625
mptcp\_sendmsg+0x10bb/0x1b10 net/mptcp/protocol.c:1903
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2603
\_\_\_sys\_sendmsg net/socket.c:2657 [inline]
\_\_sys\_sendmsg+0x2aa/0x390 net/socket.c:2686
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7fb06e9317f9
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe2cfd4f98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007fb06e97f468 RCX: 00007fb06e9317f9
RDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000005
RBP: 00007fb06e97f446 R08: 0000555500000000 R09: 0000555500000000
R10: 0000555500000000 R11: 0000000000000246 R12: 00007fb06e97f406
R13: 0000000000000001 R14: 00007ffe2cfd4fe0 R15: 0000000000000003
</TASK>
Additionally syzkaller provided a nice reproducer. The repro enables
pmtu on the loopback device, leading to tcp\_mtu\_probe() generating
very large probe packets.
tcp\_can\_coalesce\_send\_queue\_head() currently does not check for
mptcp-level invariants, and allowed the creation of cross-DSS probes,
leading to the mentioned corruption.
Address the issue teaching tcp\_can\_coalesce\_send\_queue\_head() about
mptcp using the tcp\_skb\_can\_collapse(), also reducing the code
duplication.
Fixes: 85712484110d ("tcp: coalesce/collapse must respect MPTCP extensions")
Cc: stable@vger.kernel.org
Reported-by: syzbot+d1bff73460e33101f0e7@syzkaller.appspotmail.com
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/513
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-2-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflict in tcp\_output.c, because the commit 65249feb6b3d ("net: add
support for skbs with unreadable frags") is not in this version. This
commit is linked to a new feature (Devmem TCP) and introduces a new
condition which causes the conflicts. Resolving this is easy: we can
ignore the missing new condition, and use tcp\_skb\_can\_collapse() like
in the original patch. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba8e65814e519eeb17d086952bce7de93f7a40da)

| -rw-r--r-- | [net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_output.c?id=ba8e65814e519eeb17d086952bce7de93f7a40da) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/net/ipv4/tcp\_output.c b/net/ipv4/tcp\_output.cindex 19b5a6179c061e..3f54b76bc28111 100644--- a/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=b2a4a2dad31d7e84c4c01ac6fd39e8155afbceb9)+++ b/[net/ipv4/tcp\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_output.c?id=ba8e65814e519eeb17d086952bce7de93f7a40da)@@ -2312,9 +2312,7 @@ static bool tcp\_can\_coalesce\_send\_queue\_head(struct sock \*sk, int len) if (len <= skb->len) break; - if (unlikely(TCP\_SKB\_CB(skb)->eor) ||- tcp\_has\_tx\_tstamp(skb) ||- !skb\_pure\_zcopy\_same(skb, next))+ if (tcp\_has\_tx\_tstamp(skb) || !tcp\_skb\_can\_collapse(skb, next)) return false;  len -= skb->len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:06:26 +0000


