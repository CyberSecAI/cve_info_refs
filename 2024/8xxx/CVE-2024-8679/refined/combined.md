=== Content from www.wordfence.com_8457d24a_20250114_205212.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Library Management System <= 3.0.0 - Authenticated (Admin+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Library Management System <= 3.0.0 - Authenticated (Admin+) SQL Injection

6.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:N/A:N)

| CVE | [CVE-2024-8679](https://www.cve.org/CVERecord?id=CVE-2024-8679) |
| --- | --- |
| CVSS | 6.8 (Medium) |
| Publicly Published | December 6, 2024 |
| Last Updated | December 7, 2024 |
| Researcher | [Eduardo Bido](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/eduardo-bido) |

### Description

The Library Management System – Manage e-Digital Books Library plugin for WordPress is vulnerable to SQL Injection via the ‘value' parameter of the owt\_lib\_handler AJAX action in all versions up to, and including, 3.0.0 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for authenticated attackers, with Administrator-level access and above, to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/library-management-system/trunk/admin/class-library-management-system-admin.php#L2092)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flibrary-management-system%2Flibrary-management-system-300-authenticated-admin-sql-injection&t=Library%20Management%20System%20%3C%3D%203.0.0%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flibrary-management-system%2Flibrary-management-system-300-authenticated-admin-sql-injection&text=Library%20Management%20System%20%3C%3D%203.0.0%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flibrary-management-system%2Flibrary-management-system-300-authenticated-admin-sql-injection "LinkedIn")
Email

## Vulnerability Details for Library Management System – Manage e-Digital Books Library

#### [Library Management System – Manage e-Digital Books Library](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/library-management-system)

| Software Type | Plugin |
| --- | --- |
| Software Slug | library-management-system [(view on wordpress.org)](https://wordpress.org/plugins/library-management-system) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 3.0.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_19f26c81_20250114_205211.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Flibrary-management-system%2Ftrunk%2Fadmin%2Fclass-library-management-system-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/library-management-system/trunk/admin/class-library-management-system-admin.php?rev=3128428 "Revision 3128428")
* Next Revision →
* [Blame](/browser/library-management-system/trunk/admin/class-library-management-system-admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/library-management-system/trunk/admin/class-library-management-system-admin.php)

---

# [source:](/browser?order=name "Go to repository root") [library-management-system](/browser/library-management-system?order=name "View library-management-system")/[trunk](/browser/library-management-system/trunk?order=name "View trunk")/[admin](/browser/library-management-system/trunk/admin?order=name "View admin")/[class-library-management-system-admin.php](/browser/library-management-system/trunk/admin/class-library-management-system-admin.php?order=name "View class-library-management-system-admin.php")

View diff against:

View revision:

| [Last change](/changeset/3133864/library-management-system/trunk/admin/class-library-management-system-admin.php "View differences") on this file was [3133864](/changeset/3133864/ "View changeset 3133864"), checked in by owthub, [5 months ago](/timeline?from=2024-08-12T02%3A44%3A18Z&precision=second "See timeline at 08/12/2024 02:44:18 AM") |
| --- |
| Add Docs and Settings Link |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 81.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The admin-specific functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* @link       https://onlinewebtutorblog.com/ |
| [7](#L7) | \* @since      3.0.0 |
| [8](#L8) | \* |
| [9](#L9) | \* @package    Library\_Management\_System |
| [10](#L10) | \* @subpackage Library\_Management\_System/admin |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The admin-specific functionality of the plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* Defines the plugin name, version, and two examples hooks for how to |
| [17](#L17) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [18](#L18) | \* |
| [19](#L19) | \* @package    Library\_Management\_System |
| [20](#L20) | \* @subpackage Library\_Management\_System/admin |
| [21](#L21) | \* @author     Online Web Tutor <onlinewebtutorhub@gmail.com> |
| [22](#L22) | \*/ |
| [23](#L23) | class Library\_Management\_System\_Admin { |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* The ID of this plugin. |
| [27](#L27) | \* |
| [28](#L28) | \* @since    3.0.0 |
| [29](#L29) | \* @access   private |
| [30](#L30) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [31](#L31) | \*/ |
| [32](#L32) | private $plugin\_name; |
| [33](#L33) |  |
| [34](#L34) | private $table\_activator; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* The version of this plugin. |
| [38](#L38) | \* |
| [39](#L39) | \* @since    3.0.0 |
| [40](#L40) | \* @access   private |
| [41](#L41) | \* @var      string    $version    The current version of this plugin. |
| [42](#L42) | \*/ |
| [43](#L43) | private $version; |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Initialize the class and set its properties. |
| [47](#L47) | \* |
| [48](#L48) | \* @since    3.0.0 |
| [49](#L49) | \* @param      string    $plugin\_name       The name of this plugin. |
| [50](#L50) | \* @param      string    $version    The version of this plugin. |
| [51](#L51) | \*/ |
| [52](#L52) | public function \_\_construct( $plugin\_name, $version ) { |
| [53](#L53) |  |
| [54](#L54) | $this->plugin\_name = $plugin\_name; |
| [55](#L55) | $this->version = $version; |
| [56](#L56) |  |
| [57](#L57) | require\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . 'includes/class-library-management-system-activator.php'; |
| [58](#L58) | $this->table\_activator = new Library\_Management\_System\_Activator(); |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | /\*\* |
| [62](#L62) | \* Register the stylesheets for the admin area. |
| [63](#L63) | \* |
| [64](#L64) | \* @since    3.0.0 |
| [65](#L65) | \*/ |
| [66](#L66) | public function enqueue\_styles() { |
| [67](#L67) |  |
| [68](#L68) | wp\_enqueue\_style( "owt7-lms-table-css", plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/jquery.dataTables.min.css', array(), $this->version, 'all' ); |
| [69](#L69) |  |
| [70](#L70) | wp\_enqueue\_style( "owt7-lms-table-buttons-css", plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/buttons.dataTables.min.css', array(), $this->version, 'all' ); |
| [71](#L71) |  |
| [72](#L72) | wp\_enqueue\_style( "owt7-lms-toastr-css", plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/toastr.min.css', array(), $this->version, 'all' ); |
| [73](#L73) |  |
| [74](#L74) | wp\_enqueue\_style( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/library-management-system-admin.css', array(), time(), 'all' ); |
| [75](#L75) |  |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* Register the JavaScript for the admin area. |
| [80](#L80) | \* |
| [81](#L81) | \* @since    3.0.0 |
| [82](#L82) | \*/ |
| [83](#L83) | public function enqueue\_scripts() { |
| [84](#L84) |  |
| [85](#L85) | wp\_enqueue\_script( "owt7-lms-validate", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/jquery.validate.min.js', array( 'jquery' ), $this->version, false ); |
| [86](#L86) |  |
| [87](#L87) | wp\_enqueue\_script( "owt7-lms-toastr", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/toastr.min.js', array( 'jquery' ), $this->version, false ); |
| [88](#L88) |  |
| [89](#L89) | wp\_enqueue\_script( "owt7-lms-datatable", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/jquery.dataTables.min.js', array( 'jquery' ), $this->version, false ); |
| [90](#L90) |  |
| [91](#L91) | wp\_enqueue\_script( "owt7-lms-datatable-btns", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/dataTables.buttons.min.js', array( 'jquery' ), $this->version, false ); |
| [92](#L92) |  |
| [93](#L93) | wp\_enqueue\_script( "owt7-lms-datatable-excel-btn", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/jszip.min.js', array( 'jquery' ), $this->version, false ); |
| [94](#L94) |  |
| [95](#L95) | wp\_enqueue\_script( "owt7-lms-datatable-pdf-btn", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/pdfmake.min.js', array( 'jquery' ), $this->version, false ); |
| [96](#L96) |  |
| [97](#L97) | wp\_enqueue\_script( "owt7-lms-datatable-vfs-fonts", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/vfs\_fonts.js', array( 'jquery' ), $this->version, false ); |
| [98](#L98) |  |
| [99](#L99) | wp\_enqueue\_script( "owt7-lms-datatable-btns-plugin", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/buttons.html5.min.js', array( 'jquery' ), $this->version, false ); |
| [100](#L100) |  |
| [101](#L101) | wp\_enqueue\_script( "owt7-lms-datatable-copy-btn", plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/buttons.print.min.js', array( 'jquery' ), $this->version, false ); |
| [102](#L102) |  |
| [103](#L103) | wp\_enqueue\_script( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/library-management-system-admin.js', array( 'jquery' ), time(), false ); |
| [104](#L104) |  |
| [105](#L105) | wp\_localize\_script($this->plugin\_name, "owt7\_library", array( |
| [106](#L106) | "ajaxurl" => admin\_url("admin-ajax.php"), |
| [107](#L107) | "active" => 1, |
| [108](#L108) | "ajax\_nonce" => wp\_create\_nonce('owt7\_library\_actions'), |
| [109](#L109) | "messages" => array( |
| [110](#L110) | "message\_1" => \_\_('Submitted, please wait', 'library-management-system'), |
| [111](#L111) | "message\_2" => \_\_('Submit', 'library-management-system'), |
| [112](#L112) | "message\_3" => \_\_('Success', 'library-management-system'), |
| [113](#L113) | "message\_4" => \_\_('Error', 'library-management-system'), |
| [114](#L114) | "message\_5" => \_\_('Upload Image', 'library-management-system'), |
| [115](#L115) | "message\_6" => \_\_('Select Section', 'library-management-system'), |
| [116](#L116) | "message\_7" => \_\_('Select User', 'library-management-system'), |
| [117](#L117) | "message\_8" => \_\_('Select Book', 'library-management-system'), |
| [118](#L118) | "message\_9" => \_\_('Run Data Importer remove existing data from Categories, Books, Bookcases, Sections, Branched and Users Table and then install new data. Do you want to Run Test Data Importer?', 'library-management-system'), |
| [119](#L119) | "message\_10" => \_\_('Are you sure want to remove LMS Test Data?', 'library-management-system'), |
| [120](#L120) | "message\_11" => \_\_('Are you sure want to pay the fine?', 'library-management-system'), |
| [121](#L121) | "message\_12" => \_\_('Are you sure want to delete?', 'library-management-system'), |
| [122](#L122) | "message\_13" => \_\_('Are you sure want to return this book?', 'library-management-system') |
| [123](#L123) | ) |
| [124](#L124) | )); |
| [125](#L125) |  |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // Register Plugin Menus and Submenus |
| [129](#L129) | public function owt7\_library\_management\_menus() { |
| [130](#L130) | // Main menu |
| [131](#L131) | add\_menu\_page(\_\_('Library Management', 'library-management-system'), \_\_('Library Management', 'library-management-system'), 'manage\_options', 'library\_management\_system', array($this, 'owt7\_library\_management\_dashboard\_page'), 'dashicons-book-alt', 67); |
| [132](#L132) | // Submenus |
| [133](#L133) | add\_submenu\_page('library\_management\_system', \_\_('Dashboard', 'library-management-system'), \_\_('Dashboard', 'library-management-system'), 'manage\_options', 'library\_management\_system', array($this, 'owt7\_library\_management\_dashboard\_page')); |
| [134](#L134) | add\_submenu\_page('library\_management\_system', \_\_('Manage Users', 'library-management-system'), \_\_('Manage Users', 'library-management-system'), 'manage\_options', 'owt7\_library\_users', array($this, 'owt7\_library\_management\_manage\_users\_page')); |
| [135](#L135) | add\_submenu\_page('library\_management\_system', \_\_('Manage Bookcase & Section', 'library-management-system'), \_\_('Manage Bookcase & Section', 'library-management-system'), 'manage\_options', 'owt7\_library\_bookcases', array($this, 'owt7\_library\_management\_manage\_bookcase\_page')); |
| [136](#L136) | add\_submenu\_page('library\_management\_system', \_\_('Manage Books', 'library-management-system'), \_\_('Manage Books', 'library-management-system'), 'manage\_options', 'owt7\_library\_books', array($this, 'owt7\_library\_management\_manage\_books\_page')); |
| [137](#L137) | add\_submenu\_page('library\_management\_system', \_\_('Book Transactions', 'library-management-system'), \_\_('Book Transactions', 'library-management-system'), 'manage\_options', 'owt7\_library\_transactions', array($this, 'owt7\_library\_management\_transactions\_page')); |
| [138](#L138) | add\_submenu\_page('library\_management\_system', \_\_('Settings', 'library-management-system'), \_\_('Settings', 'library-management-system'), 'manage\_options', 'owt7\_library\_settings', array($this, 'owt7\_library\_management\_settings\_page')); |
| [139](#L139) | add\_submenu\_page('library\_management\_system', \_\_('Free Vs Pro LMS', 'library-management-system'), \_\_('Free Vs Pro LMS', 'library-management-system'), 'manage\_options', 'owt7\_library\_free\_vs\_pro', array($this, 'owt7\_library\_management\_free\_vs\_pro\_page')); |
| [140](#L140) | add\_submenu\_page('library\_management\_system', \_\_('Upgrade to Pro', 'library-management-system'), \_\_('Upgrade to Pro', 'library-management-system'), 'manage\_options', 'owt7\_library\_addons', array($this, 'owt7\_library\_management\_addons\_page')); |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | // Add Documentation and Settings link To Plugin |
| [144](#L144) | public function owt7\_add\_plugin\_action\_links($links){ |
| [145](#L145) | $settings\_link = '<a href="admin.php?page=owt7\_library\_settings">Settings</a>'; |
| [146](#L146) | $links[] = $settings\_link; |
| [147](#L147) | $doc\_link = '<a href="'.LIBRARY\_FREE\_VERSION\_DOC\_LINK.'" target="\_blank">Documentation</a>'; |
| [148](#L148) | $links[] = $doc\_link; |
| [149](#L149) | return $links; |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | // Callback: "Dashboard" |
| [153](#L153) | public function owt7\_library\_management\_dashboard\_page() { |
| [154](#L154) |  |
| [155](#L155) | $this->owt7\_library\_include\_template\_file("", "owt7\_library\_dashboard"); |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | // Callback: "Branch and Users" |
| [159](#L159) | public function owt7\_library\_management\_manage\_users\_page() { |
| [160](#L160) |  |
| [161](#L161) | global $wpdb; |
| [162](#L162) |  |
| [163](#L163) | $allowed\_pages = [ |
| [164](#L164) | "user" => [ |
| [165](#L165) | "add", |
| [166](#L166) | "list" |
| [167](#L167) | ], |
| [168](#L168) | "branch" => [ |
| [169](#L169) | "add", |
| [170](#L170) | "list" |
| [171](#L171) | ] |
| [172](#L172) | ]; |
| [173](#L173) |  |
| [174](#L174) | $mod = isset($\_REQUEST['mod']) ? strtolower($\_REQUEST['mod']) : ""; |
| [175](#L175) | $fn = isset($\_REQUEST['fn']) ? strtolower($\_REQUEST['fn']) : ""; |
| [176](#L176) |  |
| [177](#L177) | // Query String Params |
| [178](#L178) | $id = isset($\_REQUEST['id']) ? intval(base64\_decode($\_REQUEST['id'])) : ""; |
| [179](#L179) | $opt = isset($\_REQUEST['opt']) ? strtolower($\_REQUEST['opt']) : ""; |
| [180](#L180) |  |
| [181](#L181) | // Add Media Library Files |
| [182](#L182) | wp\_enqueue\_media(); |
| [183](#L183) |  |
| [184](#L184) | $statuses = [ |
| [185](#L185) | "1" => "active", |
| [186](#L186) | "0" => "inactive" |
| [187](#L187) | ]; |
| [188](#L188) |  |
| [189](#L189) | if(!empty($fn) && in\_array($fn, $allowed\_pages[$mod])){ |
| [190](#L190) |  |
| [191](#L191) | if($mod == "branch"){ // [add, edit, view] |
| [192](#L192) |  |
| [193](#L193) | // All branches |
| [194](#L194) | $branches = $wpdb->get\_results( |
| [195](#L195) | "SELECT branch.\*, (SELECT count(\*) FROM ".$this->table\_activator->owt7\_library\_tbl\_users()." as user WHERE branch.id = user.branch\_id LIMIT 1) as total\_users from " . $this->table\_activator->owt7\_library\_tbl\_branch()." as branch" |
| [196](#L196) | ); |
| [197](#L197) |  |
| [198](#L198) | $branch = array(); |
| [199](#L199) |  |
| [200](#L200) | if(!empty($id)){ |
| [201](#L201) | $branch = $wpdb->get\_row( |
| [202](#L202) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch()." WHERE id = {$id}", |
| [203](#L203) | ARRAY\_A |
| [204](#L204) | ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | if(!empty($branch)){ // [edit, view] |
| [208](#L208) |  |
| [209](#L209) | $this->owt7\_library\_include\_template\_file( |
| [210](#L210) | "users", |
| [211](#L211) | "owt7\_library\_{$fn}\_{$mod}", |
| [212](#L212) | [ |
| [213](#L213) | "branch" => $branch, |
| [214](#L214) | "statuses" => $statuses, |
| [215](#L215) | "action" => $opt |
| [216](#L216) | ] |
| [217](#L217) | ); |
| [218](#L218) | }else{ // [list, add] |
| [219](#L219) |  |
| [220](#L220) | $this->owt7\_library\_include\_template\_file( |
| [221](#L221) | "users", |
| [222](#L222) | "owt7\_library\_{$fn}\_{$mod}", |
| [223](#L223) | [ |
| [224](#L224) | "branches" => $branches, |
| [225](#L225) | "statuses" => $statuses |
| [226](#L226) | ] |
| [227](#L227) | ); |
| [228](#L228) | } |
| [229](#L229) | } elseif($mod == "user"){ // [add, edit, view] |
| [230](#L230) |  |
| [231](#L231) | // All "Active" branches |
| [232](#L232) | $branches = $wpdb->get\_results( |
| [233](#L233) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch(). " WHERE status = 1" |
| [234](#L234) | ); |
| [235](#L235) |  |
| [236](#L236) | $genders = ["male", "female", "other"]; |
| [237](#L237) |  |
| [238](#L238) | $user = array(); |
| [239](#L239) |  |
| [240](#L240) | if(!empty($id)){ |
| [241](#L241) | $user = $wpdb->get\_row( |
| [242](#L242) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_users()." WHERE id = {$id}", |
| [243](#L243) | ARRAY\_A |
| [244](#L244) | ); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | $this->owt7\_library\_include\_template\_file( |
| [248](#L248) | "users", |
| [249](#L249) | "owt7\_library\_{$fn}\_{$mod}", |
| [250](#L250) | [ |
| [251](#L251) | "branches" => $branches, |
| [252](#L252) | "user" => $user, |
| [253](#L253) | "genders" => $genders, |
| [254](#L254) | "statuses" => $statuses, |
| [255](#L255) | "action" => $opt |
| [256](#L256) | ] |
| [257](#L257) | ); |
| [258](#L258) | } |
| [259](#L259) | }else{ // [list] |
| [260](#L260) |  |
| [261](#L261) | // All Users |
| [262](#L262) | $users = $wpdb->get\_results( |
| [263](#L263) | "SELECT user.\*, (SELECT name FROM ".$this->table\_activator->owt7\_library\_tbl\_branch()." as branch WHERE branch.id = user.branch\_id LIMIT 1) as branch\_name from " . $this->table\_activator->owt7\_library\_tbl\_users()." as user" |
| [264](#L264) | ); |
| [265](#L265) |  |
| [266](#L266) | // All "Active" branches |
| [267](#L267) | $branches = $wpdb->get\_results( |
| [268](#L268) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch(). " WHERE status = 1" |
| [269](#L269) | ); |
| [270](#L270) |  |
| [271](#L271) | $this->owt7\_library\_include\_template\_file( |
| [272](#L272) | "users", |
| [273](#L273) | "owt7\_library\_users", [ |
| [274](#L274) | "users" => $users, |
| [275](#L275) | "branches" => $branches, |
| [276](#L276) | ] |
| [277](#L277) | ); |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Callback: "Bookcase and Sections" |
| [282](#L282) | public function owt7\_library\_management\_manage\_bookcase\_page() { |
| [283](#L283) |  |
| [284](#L284) | global $wpdb; |
| [285](#L285) |  |
| [286](#L286) | $allowed\_pages = [ |
| [287](#L287) | "bookcase" => [ |
| [288](#L288) | "add", |
| [289](#L289) | "list" |
| [290](#L290) | ], |
| [291](#L291) | "section" => [ |
| [292](#L292) | "add", |
| [293](#L293) | "list" |
| [294](#L294) | ] |
| [295](#L295) | ]; |
| [296](#L296) |  |
| [297](#L297) | $mod = isset($\_REQUEST['mod']) ? strtolower($\_REQUEST['mod']) : ""; |
| [298](#L298) | $fn = isset($\_REQUEST['fn']) ? strtolower($\_REQUEST['fn']) : ""; |
| [299](#L299) |  |
| [300](#L300) | // Query String Params |
| [301](#L301) | $id = isset($\_REQUEST['id']) ? intval(base64\_decode($\_REQUEST['id'])) : ""; |
| [302](#L302) | $opt = isset($\_REQUEST['opt']) ? strtolower($\_REQUEST['opt']) : ""; |
| [303](#L303) |  |
| [304](#L304) | $statuses = [ |
| [305](#L305) | "1" => "active", |
| [306](#L306) | "0" => "inactive" |
| [307](#L307) | ]; |
| [308](#L308) |  |
| [309](#L309) | if(!empty($fn) && in\_array($fn, $allowed\_pages[$mod])){ |
| [310](#L310) |  |
| [311](#L311) | if($mod == "section"){ // [add, edit, view] |
| [312](#L312) |  |
| [313](#L313) | // All "Active" bookcases |
| [314](#L314) | $bookcases = $wpdb->get\_results( |
| [315](#L315) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase()." WHERE status = 1" |
| [316](#L316) | ); |
| [317](#L317) |  |
| [318](#L318) | $section = array(); |
| [319](#L319) |  |
| [320](#L320) | if(!empty($id)){ |
| [321](#L321) | $section = $wpdb->get\_row( |
| [322](#L322) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()." WHERE id = {$id}", |
| [323](#L323) | ARRAY\_A |
| [324](#L324) | ); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | if(!empty($section)){ // [edit, view] |
| [328](#L328) |  |
| [329](#L329) | $this->owt7\_library\_include\_template\_file( |
| [330](#L330) | "bookcases", |
| [331](#L331) | "owt7\_library\_{$fn}\_{$mod}", |
| [332](#L332) | [ |
| [333](#L333) | "section" => $section, |
| [334](#L334) | "bookcases" => $bookcases, |
| [335](#L335) | "statuses" => $statuses, |
| [336](#L336) | "action" => $opt |
| [337](#L337) | ] |
| [338](#L338) | ); |
| [339](#L339) | }else{ // [list, add] |
| [340](#L340) |  |
| [341](#L341) | $sections = $wpdb->get\_results( |
| [342](#L342) | "SELECT sec.\*, bkcase.name as bookcase\_name from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(). " sec INNER JOIN ". $this->table\_activator->owt7\_library\_tbl\_bookcase() . " bkcase ON sec.bookcase\_id = bkcase.id" |
| [343](#L343) | ); |
| [344](#L344) |  |
| [345](#L345) | $this->owt7\_library\_include\_template\_file( |
| [346](#L346) | "bookcases", |
| [347](#L347) | "owt7\_library\_{$fn}\_{$mod}", |
| [348](#L348) | [ |
| [349](#L349) | "sections" => $sections, |
| [350](#L350) | "bookcases" => $bookcases, |
| [351](#L351) | "statuses" => $statuses |
| [352](#L352) | ] |
| [353](#L353) | ); |
| [354](#L354) | } |
| [355](#L355) | }elseif($mod == "bookcase"){ // [add, edit, view] |
| [356](#L356) |  |
| [357](#L357) | $bookcase = array(); |
| [358](#L358) |  |
| [359](#L359) | if(!empty($id)){ |
| [360](#L360) | $bookcase = $wpdb->get\_row( |
| [361](#L361) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase()." WHERE id = {$id}", |
| [362](#L362) | ARRAY\_A |
| [363](#L363) | ); |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | $this->owt7\_library\_include\_template\_file( |
| [367](#L367) | "bookcases", |
| [368](#L368) | "owt7\_library\_{$fn}\_{$mod}", |
| [369](#L369) | [ |
| [370](#L370) | "bookcase" => $bookcase, |
| [371](#L371) | "statuses" => $statuses, |
| [372](#L372) | "action" => $opt |
| [373](#L373) | ] |
| [374](#L374) | ); |
| [375](#L375) | } |
| [376](#L376) | }else{ |
| [377](#L377) |  |
| [378](#L378) | // All bookcases |
| [379](#L379) | $bookcases = $wpdb->get\_results( |
| [380](#L380) | "SELECT bkcase.\*, (SELECT count(\*) FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()." as section WHERE section.bookcase\_id = bkcase.id limit 1) as total\_sections from " . $this->table\_activator->owt7\_library\_tbl\_bookcase()." as bkcase" |
| [381](#L381) | ); |
| [382](#L382) |  |
| [383](#L383) | $this->owt7\_library\_include\_template\_file( |
| [384](#L384) | "bookcases", |
| [385](#L385) | "owt7\_library\_bookcases", |
| [386](#L386) | [ |
| [387](#L387) | "bookcases" => $bookcases |
| [388](#L388) | ] |
| [389](#L389) | ); |
| [390](#L390) | } |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | // Callback: "Books and Categories" |
| [394](#L394) | public function owt7\_library\_management\_manage\_books\_page(){ |
| [395](#L395) |  |
| [396](#L396) | global $wpdb; |
| [397](#L397) |  |
| [398](#L398) | $allowed\_pages = [ |
| [399](#L399) | "book" => [ |
| [400](#L400) | "add", |
| [401](#L401) | "list" |
| [402](#L402) | ], |
| [403](#L403) | "category" => [ |
| [404](#L404) | "add", |
| [405](#L405) | "list" |
| [406](#L406) | ] |
| [407](#L407) | ]; |
| [408](#L408) |  |
| [409](#L409) | $mod = isset($\_REQUEST['mod']) ? strtolower($\_REQUEST['mod']) : ""; |
| [410](#L410) | $fn = isset($\_REQUEST['fn']) ? strtolower($\_REQUEST['fn']) : ""; |
| [411](#L411) |  |
| [412](#L412) | // Query String Params |
| [413](#L413) | $id = isset($\_REQUEST['id']) ? intval(base64\_decode($\_REQUEST['id'])) : ""; |
| [414](#L414) | $opt = isset($\_REQUEST['opt']) ? strtolower($\_REQUEST['opt']) : ""; |
| [415](#L415) |  |
| [416](#L416) | // Add Media Library Files |
| [417](#L417) | wp\_enqueue\_media(); |
| [418](#L418) |  |
| [419](#L419) | $statuses = [ |
| [420](#L420) | "1" => "active", |
| [421](#L421) | "0" => "inactive" |
| [422](#L422) | ]; |
| [423](#L423) |  |
| [424](#L424) | if(!empty($fn) && in\_array($fn, $allowed\_pages[$mod])){ |
| [425](#L425) |  |
| [426](#L426) | if($mod == "category"){ // [add, edit, view] |
| [427](#L427) |  |
| [428](#L428) | $category = array(); |
| [429](#L429) |  |
| [430](#L430) | if(!empty($id)){ |
| [431](#L431) | $category = $wpdb->get\_row( |
| [432](#L432) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category()." WHERE id = {$id}", |
| [433](#L433) | ARRAY\_A |
| [434](#L434) | ); |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | if(!empty($category)){ // [edit, view] |
| [438](#L438) |  |
| [439](#L439) | $this->owt7\_library\_include\_template\_file( |
| [440](#L440) | "books", |
| [441](#L441) | "owt7\_library\_{$fn}\_{$mod}", |
| [442](#L442) | [ |
| [443](#L443) | "category" => $category, |
| [444](#L444) | "statuses" => $statuses, |
| [445](#L445) | "action" => $opt |
| [446](#L446) | ] |
| [447](#L447) | ); |
| [448](#L448) | }else{ // [list, add] |
| [449](#L449) |  |
| [450](#L450) | // All categories |
| [451](#L451) | $categories = $wpdb->get\_results( |
| [452](#L452) | "SELECT category.\*, (SELECT count(\*) FROM ".$this->table\_activator->owt7\_library\_tbl\_books()." as book WHERE book.category\_id = category.id LIMIT 1) as total\_books from " . $this->table\_activator->owt7\_library\_tbl\_category(). " as category" |
| [453](#L453) | ); |
| [454](#L454) |  |
| [455](#L455) | $this->owt7\_library\_include\_template\_file( |
| [456](#L456) | "books", |
| [457](#L457) | "owt7\_library\_{$fn}\_{$mod}", |
| [458](#L458) | [ |
| [459](#L459) | "categories" => $categories, |
| [460](#L460) | "statuses" => $statuses |
| [461](#L461) | ] |
| [462](#L462) | ); |
| [463](#L463) | } |
| [464](#L464) | } elseif($mod == "book"){ |
| [465](#L465) |  |
| [466](#L466) | $book = array(); |
| [467](#L467) | $sections = array(); |
| [468](#L468) |  |
| [469](#L469) | // All categories |
| [470](#L470) | $categories = $wpdb->get\_results( |
| [471](#L471) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category(). " WHERE status = 1" |
| [472](#L472) | ); |
| [473](#L473) |  |
| [474](#L474) | $bookcases = $wpdb->get\_results( |
| [475](#L475) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase(). " WHERE status = 1" |
| [476](#L476) | ); |
| [477](#L477) |  |
| [478](#L478) | if(!empty($id)){ |
| [479](#L479) | $book = $wpdb->get\_row( |
| [480](#L480) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_books()." WHERE id = {$id}", |
| [481](#L481) | ARRAY\_A |
| [482](#L482) | ); |
| [483](#L483) | if(!empty($book['bookcase\_id'])){ |
| [484](#L484) |  |
| [485](#L485) | $sections = $wpdb->get\_results( |
| [486](#L486) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(). " WHERE bookcase\_id = {$book['bookcase\_id']} AND status = 1" |
| [487](#L487) | ); |
| [488](#L488) | } |
| [489](#L489) | } |
| [490](#L490) |  |
| [491](#L491) | if(!empty($book)){ // [edit, view] |
| [492](#L492) |  |
| [493](#L493) | $this->owt7\_library\_include\_template\_file( |
| [494](#L494) | "books", |
| [495](#L495) | "owt7\_library\_{$fn}\_{$mod}", |
| [496](#L496) | [ |
| [497](#L497) | "book" => $book, |
| [498](#L498) | "statuses" => $statuses, |
| [499](#L499) | "sections" => $sections, |
| [500](#L500) | "bookcases" => $bookcases, |
| [501](#L501) | "action" => $opt, |
| [502](#L502) | "categories" => $categories |
| [503](#L503) | ] |
| [504](#L504) | ); |
| [505](#L505) | }else{ // [add] |
| [506](#L506) |  |
| [507](#L507) | $this->owt7\_library\_include\_template\_file( |
| [508](#L508) | "books", |
| [509](#L509) | "owt7\_library\_{$fn}\_{$mod}", |
| [510](#L510) | [ |
| [511](#L511) | "statuses" => $statuses, |
| [512](#L512) | "bookcases" => $bookcases, |
| [513](#L513) | "categories" => $categories |
| [514](#L514) | ] |
| [515](#L515) | ); |
| [516](#L516) | } |
| [517](#L517) | } |
| [518](#L518) | }else{ |
| [519](#L519) |  |
| [520](#L520) | // All books |
| [521](#L521) | $books = $wpdb->get\_results( |
| [522](#L522) | "SELECT book.id, book.book\_id, book.name, book.stock\_quantity, book.status, book.created\_at, (SELECT category.name FROM ".$this->table\_activator->owt7\_library\_tbl\_category()." as category WHERE category.id = book.category\_id LIMIT 1) as category\_name, (SELECT bkcase.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase()." as bkcase WHERE bkcase.id = book.bookcase\_id LIMIT 1) as bookcase\_name, (SELECT section.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()." as section WHERE section.id = book.bookcase\_section\_id LIMIT 1) as section\_name from " . $this->table\_activator->owt7\_library\_tbl\_books(). " as book" |
| [523](#L523) | ); |
| [524](#L524) |  |
| [525](#L525) | // All categories |
| [526](#L526) | $categories = $wpdb->get\_results( |
| [527](#L527) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category(). " WHERE status = 1" |
| [528](#L528) | ); |
| [529](#L529) |  |
| [530](#L530) | $this->owt7\_library\_include\_template\_file( |
| [531](#L531) | "books", |
| [532](#L532) | "owt7\_library\_books", [ |
| [533](#L533) | "books" => $books, |
| [534](#L534) | "categories" => $categories |
| [535](#L535) | ] |
| [536](#L536) | ); |
| [537](#L537) | } |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | // Callback: "Books Borrow and Return Transactions" |
| [541](#L541) | public function owt7\_library\_management\_transactions\_page(){ |
| [542](#L542) |  |
| [543](#L543) | global $wpdb; |
| [544](#L544) |  |
| [545](#L545) | $allowed\_pages = [ |
| [546](#L546) | "books" => [ |
| [547](#L547) | "books", |
| [548](#L548) | "borrow", |
| [549](#L549) | "return-history", |
| [550](#L550) | "return", |
| [551](#L551) | "history" |
| [552](#L552) | ] |
| [553](#L553) | ]; |
| [554](#L554) |  |
| [555](#L555) | $mod = isset($\_REQUEST['mod']) ? strtolower($\_REQUEST['mod']) : ""; // books |
| [556](#L556) | $fn = isset($\_REQUEST['fn']) ? strtolower($\_REQUEST['fn']) : ""; // [borrow, return-history, return] |
| [557](#L557) |  |
| [558](#L558) | if(!empty($fn) && in\_array($fn, $allowed\_pages[$mod])){ |
| [559](#L559) |  |
| [560](#L560) | $fn = str\_replace("-", "\_", $fn); |
| [561](#L561) |  |
| [562](#L562) | if($mod == "books"){ |
| [563](#L563) |  |
| [564](#L564) | $returns = []; |
| [565](#L565) |  |
| [566](#L566) | $branches = $wpdb->get\_results( |
| [567](#L567) | $wpdb->prepare( |
| [568](#L568) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_branch() . " WHERE status = %d", |
| [569](#L569) | 1 |
| [570](#L570) | ) |
| [571](#L571) | ); |
| [572](#L572) |  |
| [573](#L573) | $categories = $wpdb->get\_results( |
| [574](#L574) | $wpdb->prepare( |
| [575](#L575) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_category() . " WHERE status = %d", |
| [576](#L576) | 1 |
| [577](#L577) | ) |
| [578](#L578) | ); |
| [579](#L579) |  |
| [580](#L580) | // Return History |
| [581](#L581) | if($fn == "return\_history"){ |
| [582](#L582) |  |
| [583](#L583) | $returns = $wpdb->get\_results( |
| [584](#L584) | "SELECT rt.id, rt.borrow\_id, rt.status, rt.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = rt.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = rt.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = rt.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = rt.u\_id LIMIT 1) as user\_name, (SELECT borrow.borrows\_days FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as total\_days, (SELECT borrow.created\_at FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as issued\_on, (SELECT fine.has\_paid FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_late\_fine(). " fine WHERE fine.return\_id = rt.id LIMIT 1) as has\_paid, (SELECT fine.fine\_amount FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_late\_fine(). " fine WHERE fine.return\_id = rt.id LIMIT 1) as fine\_amount, (SELECT fine.extra\_days FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_late\_fine(). " fine WHERE fine.return\_id = rt.id LIMIT 1) as extra\_days FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_return(). " as rt ORDER by rt.id DESC" |
| [585](#L585) | ); |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | $this->owt7\_library\_include\_template\_file( |
| [589](#L589) | "transactions", |
| [590](#L590) | "owt7\_library\_{$mod}\_{$fn}", |
| [591](#L591) | [ |
| [592](#L592) | "branches" => $branches, |
| [593](#L593) | "categories" => $categories, |
| [594](#L594) | "returns" => $returns |
| [595](#L595) | ] |
| [596](#L596) | ); |
| [597](#L597) | }else{ |
| [598](#L598) |  |
| [599](#L599) | $this->owt7\_library\_include\_template\_file( |
| [600](#L600) | "transactions", |
| [601](#L601) | "owt7\_library\_books\_{$mod}\_{$fn}" |
| [602](#L602) | ); |
| [603](#L603) | } |
| [604](#L604) | }else{ |
| [605](#L605) |  |
| [606](#L606) | $borrows = $wpdb->get\_results( |
| [607](#L607) | "SELECT borrow.id, borrow.borrow\_id, borrow.borrows\_days, borrow.return\_date, borrow.status, borrow.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = borrow.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = borrow.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = borrow.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = borrow.u\_id LIMIT 1) as user\_name FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow ORDER by borrow.id DESC" |
| [608](#L608) | ); |
| [609](#L609) |  |
| [610](#L610) | $branches = $wpdb->get\_results( |
| [611](#L611) | $wpdb->prepare( |
| [612](#L612) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_branch() . " WHERE status = %d", |
| [613](#L613) | 1 |
| [614](#L614) | ) |
| [615](#L615) | ); |
| [616](#L616) |  |
| [617](#L617) | $categories = $wpdb->get\_results( |
| [618](#L618) | $wpdb->prepare( |
| [619](#L619) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_category() . " WHERE status = %d", |
| [620](#L620) | 1 |
| [621](#L621) | ) |
| [622](#L622) | ); |
| [623](#L623) |  |
| [624](#L624) | $this->owt7\_library\_include\_template\_file( |
| [625](#L625) | "transactions", |
| [626](#L626) | "owt7\_library\_books\_transactions", |
| [627](#L627) | [ |
| [628](#L628) | "borrows" => $borrows, |
| [629](#L629) | "branches" => $branches, |
| [630](#L630) | "categories" => $categories |
| [631](#L631) | ] |
| [632](#L632) | ); |
| [633](#L633) | } |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | // Callback: "Books Borrow and Return Transactions" |
| [637](#L637) | public function owt7\_library\_management\_settings\_page(){ |
| [638](#L638) |  |
| [639](#L639) | global $wpdb; |
| [640](#L640) | // [late\_fine, country] |
| [641](#L641) | $mod = isset($\_REQUEST['mod']) ? strtolower($\_REQUEST['mod']) : ""; |
| [642](#L642) |  |
| [643](#L643) | if(!empty($mod)){ |
| [644](#L644) |  |
| [645](#L645) | $this->owt7\_library\_include\_template\_file( |
| [646](#L646) | "settings", |
| [647](#L647) | "owt7\_library\_{$mod}\_settings" |
| [648](#L648) | ); |
| [649](#L649) | }else{ |
| [650](#L650) |  |
| [651](#L651) | $this->owt7\_library\_include\_template\_file( |
| [652](#L652) | "settings", |
| [653](#L653) | "owt7\_library\_settings" |
| [654](#L654) | ); |
| [655](#L655) | } |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | // Callback: "Free Vs Pro LMS" |
| [659](#L659) | public function owt7\_library\_management\_free\_vs\_pro\_page(){ |
| [660](#L660) |  |
| [661](#L661) | $this->owt7\_library\_include\_template\_file("lms", "owt7\_library\_free\_vs\_pro"); |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | // Callback: "Addons" |
| [665](#L665) | public function owt7\_library\_management\_addons\_page(){ |
| [666](#L666) |  |
| [667](#L667) | $this->owt7\_library\_include\_template\_file("lms", "owt7\_library\_addons"); |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | // Helper function |
| [671](#L671) | private function owt7\_library\_include\_template\_file($mod, $template, $lib\_params = array()){ |
| [672](#L672) |  |
| [673](#L673) | ob\_start(); |
| [674](#L674) | $params = $lib\_params; |
| [675](#L675) | if(!empty($mod)){ |
| [676](#L676) | include\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . "admin/views/{$mod}/" . $template . ".php"; |
| [677](#L677) | }else{ |
| [678](#L678) | include\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . 'admin/views/' . $template . ".php"; |
| [679](#L679) | } |
| [680](#L680) | $template = ob\_get\_contents(); |
| [681](#L681) | ob\_end\_clean(); |
| [682](#L682) |  |
| [683](#L683) | echo $template; |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | // Generate Unique Identifier |
| [687](#L687) | private function owt7\_library\_generate\_unique\_identifier($prefix = 'LMS', $length = 6) { |
| [688](#L688) | if ($length <= 0) { |
| [689](#L689) | return $prefix; |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | $characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'; |
| [693](#L693) | $charactersLength = strlen($characters); |
| [694](#L694) | $randomString = ''; |
| [695](#L695) | for ($i = 0; $i < $length; $i++) { |
| [696](#L696) | $randomString .= $characters[rand(0, $charactersLength - 1)]; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | return $prefix . $randomString; |
| [700](#L700) | } |
| [701](#L701) |  |
| [702](#L702) | // Send Response in JSON |
| [703](#L703) | private function json($response = array()) |
| [704](#L704) | { |
| [705](#L705) | $data = isset($response[2]) ? $response[2] : array(); |
| [706](#L706) | $ar = array('sts' => $response[0], 'msg' => $response[1], 'arr' => $data); |
| [707](#L707) | print\_r(json\_encode($ar)); |
| [708](#L708) | die; |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | // LMS Free Version Credit |
| [712](#L712) | private function owt7\_library\_free\_version\_credit($table, $type = ""){ |
| [713](#L713) |  |
| [714](#L714) | global $wpdb; |
| [715](#L715) |  |
| [716](#L716) | $data = $wpdb->get\_results( |
| [717](#L717) | "SELECT \* from {$table}" |
| [718](#L718) | ); |
| [719](#L719) |  |
| [720](#L720) | $limited\_credits = ["categories", "bookcases", "branches"]; |
| [721](#L721) |  |
| [722](#L722) | if(!empty($type) && in\_array($type, $limited\_credits)){ |
| [723](#L723) | $credit = base64\_decode(LMS\_FREE\_VERSION\_LIMIT); |
| [724](#L724) | $credit = intval($credit - 10); |
| [725](#L725) | if(count($data) < $credit){ |
| [726](#L726) | return true; |
| [727](#L727) | }else{ |
| [728](#L728) | return false; |
| [729](#L729) | } |
| [730](#L730) | }else{ |
| [731](#L731) | if(count($data) < base64\_decode(LMS\_FREE\_VERSION\_LIMIT)){ |
| [732](#L732) | return true; |
| [733](#L733) | }else{ |
| [734](#L734) | return false; |
| [735](#L735) | } |
| [736](#L736) | } |
| [737](#L737) | } |
| [738](#L738) |  |
| [739](#L739) | // Manage Stock |
| [740](#L740) | private function owt7\_library\_manage\_books\_stock($book\_id, $action){ |
| [741](#L741) | global $wpdb; |
| [742](#L742) | $book\_data = $wpdb->get\_row( |
| [743](#L743) | "SELECT \* FROM " . $this->table\_activator->owt7\_library\_tbl\_books() . " WHERE id = {$book\_id}" |
| [744](#L744) | ); |
| [745](#L745) | if(!empty($book\_data)){ |
| [746](#L746) | $stock\_quantity = $book\_data->stock\_quantity; |
| [747](#L747) | if($action == "plus"){ |
| [748](#L748) | $stock\_quantity = $stock\_quantity + 1; |
| [749](#L749) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_books(), [ |
| [750](#L750) | "stock\_quantity" => $stock\_quantity |
| [751](#L751) | ], [ |
| [752](#L752) | "id" => $book\_id |
| [753](#L753) | ]); |
| [754](#L754) | return true; |
| [755](#L755) | } elseif($action == "minus"){ |
| [756](#L756) | if($stock\_quantity > 0){ |
| [757](#L757) | $stock\_quantity = $stock\_quantity - 1; |
| [758](#L758) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_books(), [ |
| [759](#L759) | "stock\_quantity" => $stock\_quantity |
| [760](#L760) | ], [ |
| [761](#L761) | "id" => $book\_id |
| [762](#L762) | ]); |
| [763](#L763) | return true; |
| [764](#L764) | }else{ |
| [765](#L765) | return false; |
| [766](#L766) | } |
| [767](#L767) | } |
| [768](#L768) | }else{ |
| [769](#L769) | return false; |
| [770](#L770) | } |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // Ajax Handler |
| [774](#L774) | public function owt7\_library\_management\_ajax\_handler(){ |
| [775](#L775) |  |
| [776](#L776) | //ini\_set("display\_errors", 1); |
| [777](#L777) |  |
| [778](#L778) | global $wpdb; |
| [779](#L779) |  |
| [780](#L780) | $param = isset( $\_REQUEST['param'] ) ? trim( $\_REQUEST['param'] ) : ""; |
| [781](#L781) |  |
| [782](#L782) | if ( isset( $\_REQUEST['owt7\_lms\_nonce'] ) && wp\_verify\_nonce( $\_REQUEST['owt7\_lms\_nonce'], 'owt7\_library\_actions' ) ) { |
| [783](#L783) |  |
| [784](#L784) | if ( !empty( $param ) ) { |
| [785](#L785) |  |
| [786](#L786) | if ( $param == "owt7\_lms\_branch\_form" ) { |
| [787](#L787) |  |
| [788](#L788) | // Action Type |
| [789](#L789) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [790](#L790) | // Form Data |
| [791](#L791) | $branch = isset( $\_REQUEST['owt7\_txt\_branch\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_branch\_name'] ) ) : ""; |
| [792](#L792) | $status = isset( $\_REQUEST['owt7\_dd\_branch\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_branch\_status'] ) : 1; |
| [793](#L793) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['edit\_id'] ) ) : "" ; |
| [794](#L794) |  |
| [795](#L795) | if(!empty($action\_type)){ // [add, edit] |
| [796](#L796) |  |
| [797](#L797) | if($action\_type == "add"){ |
| [798](#L798) |  |
| [799](#L799) | if ( !empty( $branch ) ) { |
| [800](#L800) |  |
| [801](#L801) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_branch(), "branches")){ |
| [802](#L802) |  |
| [803](#L803) | $is\_branch\_exists = $wpdb->get\_row( |
| [804](#L804) | $wpdb->prepare( |
| [805](#L805) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch() . " WHERE LOWER(TRIM(name)) = %s", |
| [806](#L806) | strtolower(trim($branch)) |
| [807](#L807) | ) |
| [808](#L808) | ); |
| [809](#L809) |  |
| [810](#L810) | if ( !empty( $is\_branch\_exists ) ) { |
| [811](#L811) |  |
| [812](#L812) | $response = [ |
| [813](#L813) | 0, |
| [814](#L814) | \_\_("Branch name already taken", "library-management-system") |
| [815](#L815) | ]; |
| [816](#L816) | } else { |
| [817](#L817) |  |
| [818](#L818) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_branch(), array( |
| [819](#L819) | "name" => $branch, |
| [820](#L820) | "status" => $status |
| [821](#L821) | )); |
| [822](#L822) |  |
| [823](#L823) | if ( $wpdb->insert\_id > 0 ) { |
| [824](#L824) |  |
| [825](#L825) | $response = [ |
| [826](#L826) | 1, |
| [827](#L827) | \_\_("Successfully, Branch added to LMS", "library-management-system") |
| [828](#L828) | ]; |
| [829](#L829) | } else { |
| [830](#L830) | $response = [ |
| [831](#L831) | 0, |
| [832](#L832) | \_\_("Failed to add Branch", "library-management-system") |
| [833](#L833) | ]; |
| [834](#L834) | } |
| [835](#L835) | } |
| [836](#L836) | }else{ |
| [837](#L837) |  |
| [838](#L838) | $response = [ |
| [839](#L839) | 0, |
| [840](#L840) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [841](#L841) | ]; |
| [842](#L842) | } |
| [843](#L843) | } else { |
| [844](#L844) | $response = [ |
| [845](#L845) | 0, |
| [846](#L846) | \_\_("Branch value required", "library-management-system") |
| [847](#L847) | ]; |
| [848](#L848) | } |
| [849](#L849) | } elseif ($action\_type == "edit"){ |
| [850](#L850) |  |
| [851](#L851) | if ( !empty( $branch ) ) { |
| [852](#L852) |  |
| [853](#L853) | $branch\_have\_same\_id = $wpdb->get\_row( |
| [854](#L854) | $wpdb->prepare( |
| [855](#L855) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch() . " WHERE LOWER(TRIM(name)) = %s AND id <> %d", |
| [856](#L856) | strtolower(trim($branch)), $edit\_id |
| [857](#L857) | ) |
| [858](#L858) | ); |
| [859](#L859) |  |
| [860](#L860) | if ( !empty( $branch\_have\_same\_id ) ) { |
| [861](#L861) |  |
| [862](#L862) | $response = [ |
| [863](#L863) | 0, |
| [864](#L864) | \_\_("Branch name already taken", "library-management-system") |
| [865](#L865) | ]; |
| [866](#L866) | }else{ |
| [867](#L867) |  |
| [868](#L868) | $is\_branch\_exists = $wpdb->get\_row( |
| [869](#L869) | $wpdb->prepare( |
| [870](#L870) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_branch() . " WHERE id = %d", |
| [871](#L871) | $edit\_id |
| [872](#L872) | ) |
| [873](#L873) | ); |
| [874](#L874) |  |
| [875](#L875) | if(!empty($is\_branch\_exists)){ |
| [876](#L876) |  |
| [877](#L877) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_branch(), array( |
| [878](#L878) | "name" => $branch, |
| [879](#L879) | "status" => $status |
| [880](#L880) | ), [ |
| [881](#L881) | "id" => $edit\_id |
| [882](#L882) | ]); |
| [883](#L883) |  |
| [884](#L884) | $response = [ |
| [885](#L885) | 1, |
| [886](#L886) | \_\_("Successfully, Branch data updated", "library-management-system") |
| [887](#L887) | ]; |
| [888](#L888) | }else{ |
| [889](#L889) |  |
| [890](#L890) | $response = [ |
| [891](#L891) | 0, |
| [892](#L892) | \_\_("Branch not found", "library-management-system") |
| [893](#L893) | ]; |
| [894](#L894) | } |
| [895](#L895) | } |
| [896](#L896) | } else { |
| [897](#L897) | $response = [ |
| [898](#L898) | 0, |
| [899](#L899) | \_\_("Branch value required", "library-management-system") |
| [900](#L900) | ]; |
| [901](#L901) | } |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | }else{ |
| [905](#L905) |  |
| [906](#L906) | $response = [ |
| [907](#L907) | 0, |
| [908](#L908) | \_\_("Invalid Operation", "library-management-system") |
| [909](#L909) | ]; |
| [910](#L910) | } |
| [911](#L911) | } elseif ( $param == "owt7\_lms\_user\_form" ) { |
| [912](#L912) |  |
| [913](#L913) | // Action Type |
| [914](#L914) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [915](#L915) | // Form Data |
| [916](#L916) | $userId = isset( $\_REQUEST['owt7\_txt\_u\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_u\_id'] ) ) : "" ; |
| [917](#L917) | $branchId = isset( $\_REQUEST['owt7\_dd\_branch\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_branch\_id'] ) : 1 ; |
| [918](#L918) | $name = isset( $\_REQUEST['owt7\_txt\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_name'] ) ) : "" ; |
| [919](#L919) | $email = isset( $\_REQUEST['owt7\_txt\_email'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_email'] ) ) : "" ; |
| [920](#L920) | $phone = isset( $\_REQUEST['owt7\_txt\_phone'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_phone'] ) ) : "" ; |
| [921](#L921) | $gender = isset( $\_REQUEST['owt7\_dd\_gender'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_dd\_gender'] ) ) : "" ; |
| [922](#L922) | $address = isset( $\_REQUEST['owt7\_txt\_address'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_address'] ) ) : "" ; |
| [923](#L923) | $profileImage = isset( $\_REQUEST['owt7\_profile\_image'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_profile\_image'] ) ) : "" ; |
| [924](#L924) | $status = isset( $\_REQUEST['owt7\_dd\_user\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_user\_status'] ) : 1 ; |
| [925](#L925) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['edit\_id'] ) ) : "" ; |
| [926](#L926) |  |
| [927](#L927) | if(!empty($action\_type)){ // [add, edit, view] |
| [928](#L928) |  |
| [929](#L929) | if($action\_type == "add"){ |
| [930](#L930) |  |
| [931](#L931) | if(!empty($userId) || !empty($branchId) || !empty($name)){ |
| [932](#L932) |  |
| [933](#L933) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_users())){ |
| [934](#L934) |  |
| [935](#L935) | $is\_user\_exists = $wpdb->get\_row( |
| [936](#L936) | $wpdb->prepare( |
| [937](#L937) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_users() . " WHERE LOWER(TRIM(u\_id)) = %s", |
| [938](#L938) | strtolower(trim($userId)) |
| [939](#L939) | ) |
| [940](#L940) | ); |
| [941](#L941) |  |
| [942](#L942) | if ( !empty( $is\_user\_exists ) ) { |
| [943](#L943) |  |
| [944](#L944) | $response = [ |
| [945](#L945) | 0, |
| [946](#L946) | \_\_("User already exists", "library-management-system") |
| [947](#L947) | ]; |
| [948](#L948) | }else{ |
| [949](#L949) |  |
| [950](#L950) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_users(), array( |
| [951](#L951) | "register\_from" => "admin", |
| [952](#L952) | "u\_id" => $userId, |
| [953](#L953) | "name" => $name, |
| [954](#L954) | "email" => $email, |
| [955](#L955) | "gender" => $gender, |
| [956](#L956) | "branch\_id" => $branchId, |
| [957](#L957) | "phone\_no" => $phone, |
| [958](#L958) | "profile\_image" => $profileImage, |
| [959](#L959) | "address\_info" => $address, |
| [960](#L960) | "status" => $status |
| [961](#L961) | )); |
| [962](#L962) |  |
| [963](#L963) | if ( $wpdb->insert\_id > 0 ) { |
| [964](#L964) |  |
| [965](#L965) | $response = [ |
| [966](#L966) | 1, |
| [967](#L967) | \_\_("Successfully, User added to LMS", "library-management-system") |
| [968](#L968) | ]; |
| [969](#L969) | } else { |
| [970](#L970) | $response = [ |
| [971](#L971) | 0, |
| [972](#L972) | \_\_("Failed to add User", "library-management-system") |
| [973](#L973) | ]; |
| [974](#L974) | } |
| [975](#L975) | } |
| [976](#L976) | }else{ |
| [977](#L977) |  |
| [978](#L978) | $response = [ |
| [979](#L979) | 0, |
| [980](#L980) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [981](#L981) | ]; |
| [982](#L982) | } |
| [983](#L983) | }else{ |
| [984](#L984) |  |
| [985](#L985) | $response = [ |
| [986](#L986) | 0, |
| [987](#L987) | \_\_("Required fields are missing", "library-management-system") |
| [988](#L988) | ]; |
| [989](#L989) | } |
| [990](#L990) | } elseif($action\_type == "edit"){ |
| [991](#L991) |  |
| [992](#L992) | if(!empty($userId) || !empty($branchId) || !empty($name)){ |
| [993](#L993) |  |
| [994](#L994) | $user\_have\_same\_id = $wpdb->get\_row( |
| [995](#L995) | $wpdb->prepare( |
| [996](#L996) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_users() . " WHERE LOWER(TRIM(u\_id)) = %s AND id <> %d", |
| [997](#L997) | strtolower(trim($userId)), $edit\_id |
| [998](#L998) | ) |
| [999](#L999) | ); |
| [1000](#L1000) |  |
| [1001](#L1001) | if ( !empty( $user\_have\_same\_id ) ) { |
| [1002](#L1002) |  |
| [1003](#L1003) | $response = [ |
| [1004](#L1004) | 0, |
| [1005](#L1005) | \_\_("User ID already taken", "library-management-system") |
| [1006](#L1006) | ]; |
| [1007](#L1007) | }else{ |
| [1008](#L1008) |  |
| [1009](#L1009) | $is\_user\_exists = $wpdb->get\_row( |
| [1010](#L1010) | $wpdb->prepare( |
| [1011](#L1011) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_users() . " WHERE id = %d", |
| [1012](#L1012) | $edit\_id |
| [1013](#L1013) | ) |
| [1014](#L1014) | ); |
| [1015](#L1015) |  |
| [1016](#L1016) | if(!empty($is\_user\_exists)){ |
| [1017](#L1017) |  |
| [1018](#L1018) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_users(), array( |
| [1019](#L1019) | "u\_id" => $userId, |
| [1020](#L1020) | "name" => $name, |
| [1021](#L1021) | "email" => $email, |
| [1022](#L1022) | "gender" => $gender, |
| [1023](#L1023) | "branch\_id" => $branchId, |
| [1024](#L1024) | "phone\_no" => $phone, |
| [1025](#L1025) | "profile\_image" => $profileImage, |
| [1026](#L1026) | "address\_info" => $address, |
| [1027](#L1027) | "status" => $status |
| [1028](#L1028) | ), [ |
| [1029](#L1029) | "id" => $edit\_id |
| [1030](#L1030) | ]); |
| [1031](#L1031) |  |
| [1032](#L1032) | $response = [ |
| [1033](#L1033) | 1, |
| [1034](#L1034) | \_\_("Successfully, User data updated", "library-management-system") |
| [1035](#L1035) | ]; |
| [1036](#L1036) | }else{ |
| [1037](#L1037) |  |
| [1038](#L1038) | $response = [ |
| [1039](#L1039) | 0, |
| [1040](#L1040) | \_\_("User not found", "library-management-system") |
| [1041](#L1041) | ]; |
| [1042](#L1042) | } |
| [1043](#L1043) | } |
| [1044](#L1044) | }else{ |
| [1045](#L1045) |  |
| [1046](#L1046) | $response = [ |
| [1047](#L1047) | 0, |
| [1048](#L1048) | \_\_("Required fields are missing", "library-management-system") |
| [1049](#L1049) | ]; |
| [1050](#L1050) | } |
| [1051](#L1051) | } |
| [1052](#L1052) | }else{ |
| [1053](#L1053) |  |
| [1054](#L1054) | $response = [ |
| [1055](#L1055) | 0, |
| [1056](#L1056) | \_\_("Invalid Operation", "library-management-system") |
| [1057](#L1057) | ]; |
| [1058](#L1058) | } |
| [1059](#L1059) | } elseif ( $param == "owt7\_lms\_delete\_function" ){ |
| [1060](#L1060) |  |
| [1061](#L1061) | $deleteId = isset( $\_REQUEST['id'] ) ? intval( base64\_decode( $\_REQUEST['id'] ) ) : ""; |
| [1062](#L1062) | $deleteModule = isset( $\_REQUEST['module'] ) ? base64\_decode( $\_REQUEST['module'] ) : ""; |
| [1063](#L1063) | // [user, branch, bookcase, section, category, book, borrow, return] |
| [1064](#L1064) | // Table name |
| [1065](#L1065) | $tableName = ""; |
| [1066](#L1066) | $deleteStatus = false; |
| [1067](#L1067) | $associatedModules = [ |
| [1068](#L1068) | "branch" => "user", |
| [1069](#L1069) | "bookcase" => "section", |
| [1070](#L1070) | "category" => "book" |
| [1071](#L1071) | ]; |
| [1072](#L1072) |  |
| [1073](#L1073) | if($deleteModule == "user"){ |
| [1074](#L1074) | $tableName = $this->table\_activator->owt7\_library\_tbl\_users(); |
| [1075](#L1075) | } elseif($deleteModule == "branch"){ |
| [1076](#L1076) | $tableName = $this->table\_activator->owt7\_library\_tbl\_branch(); |
| [1077](#L1077) | // Check to delete |
| [1078](#L1078) | $has\_data = $wpdb->get\_row("SELECT count(\*) as total\_rows FROM {$this->table\_activator->owt7\_library\_tbl\_users()} WHERE branch\_id = {$deleteId}"); |
| [1079](#L1079) | if(isset($has\_data->total\_rows) && $has\_data->total\_rows > 0){ |
| [1080](#L1080) | $deleteStatus = true; |
| [1081](#L1081) | } |
| [1082](#L1082) | } elseif($deleteModule == "bookcase"){ |
| [1083](#L1083) | $tableName = $this->table\_activator->owt7\_library\_tbl\_bookcase(); |
| [1084](#L1084) | // Check to delete |
| [1085](#L1085) | $has\_data = $wpdb->get\_row("SELECT count(\*) as total\_rows FROM {$this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()} WHERE bookcase\_id = {$deleteId}"); |
| [1086](#L1086) | if(isset($has\_data->total\_rows) && $has\_data->total\_rows){ |
| [1087](#L1087) | $deleteStatus = true; |
| [1088](#L1088) | } |
| [1089](#L1089) | } elseif($deleteModule == "section"){ |
| [1090](#L1090) | $tableName = $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(); |
| [1091](#L1091) | } elseif($deleteModule == "category"){ |
| [1092](#L1092) | $tableName = $this->table\_activator->owt7\_library\_tbl\_category(); |
| [1093](#L1093) | // Check to delete |
| [1094](#L1094) | $has\_data = $wpdb->get\_row("SELECT count(\*) as total\_rows FROM {$this->table\_activator->owt7\_library\_tbl\_books()} WHERE category\_id = {$deleteId}"); |
| [1095](#L1095) | if(isset($has\_data->total\_rows) && $has\_data->total\_rows){ |
| [1096](#L1096) | $deleteStatus = true; |
| [1097](#L1097) | } |
| [1098](#L1098) | } elseif($deleteModule == "book"){ |
| [1099](#L1099) | $tableName = $this->table\_activator->owt7\_library\_tbl\_books(); |
| [1100](#L1100) | } elseif($deleteModule == "book\_borrow"){ |
| [1101](#L1101) | $tableName = $this->table\_activator->owt7\_library\_tbl\_book\_borrow(); |
| [1102](#L1102) | $deleteModule = str\_replace("\_", " ", $deleteModule); |
| [1103](#L1103) | } elseif($deleteModule == "book\_return"){ |
| [1104](#L1104) | $tableName = $this->table\_activator->owt7\_library\_tbl\_book\_return(); |
| [1105](#L1105) | $deleteModule = str\_replace("\_", " ", $deleteModule); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | if(!empty($tableName)){ |
| [1109](#L1109) |  |
| [1110](#L1110) | if(!$deleteStatus){ |
| [1111](#L1111) |  |
| [1112](#L1112) | $is\_data\_exists = $wpdb->get\_row( |
| [1113](#L1113) | $wpdb->prepare( |
| [1114](#L1114) | "SELECT \* from " . $tableName . " WHERE id = %d", |
| [1115](#L1115) | $deleteId |
| [1116](#L1116) | ) |
| [1117](#L1117) | ); |
| [1118](#L1118) |  |
| [1119](#L1119) | if(!empty($is\_data\_exists)){ |
| [1120](#L1120) |  |
| [1121](#L1121) | $wpdb->delete($tableName, [ |
| [1122](#L1122) | "id" => $is\_data\_exists->id |
| [1123](#L1123) | ]); |
| [1124](#L1124) |  |
| [1125](#L1125) | $response = [ |
| [1126](#L1126) | 1, |
| [1127](#L1127) | \_\_("Successfully, " . ucfirst($deleteModule) . " deleted", "library-management-system") |
| [1128](#L1128) | ]; |
| [1129](#L1129) | }else{ |
| [1130](#L1130) |  |
| [1131](#L1131) | $response = [ |
| [1132](#L1132) | 0, |
| [1133](#L1133) | \_\_(ucfirst($deleteModule) . " not found", "library-management-system") |
| [1134](#L1134) | ]; |
| [1135](#L1135) | } |
| [1136](#L1136) | }else{ |
| [1137](#L1137) |  |
| [1138](#L1138) | $response = [ |
| [1139](#L1139) | 0, |
| [1140](#L1140) | \_\_("Failed to delete. There are number of rows of " . ucfirst($associatedModules[$deleteModule]) . " associated with this " . ucfirst($deleteModule) . ". Please delete them first.", "library-management-system") |
| [1141](#L1141) | ]; |
| [1142](#L1142) | } |
| [1143](#L1143) | }else{ |
| [1144](#L1144) |  |
| [1145](#L1145) | $response = [ |
| [1146](#L1146) | 0, |
| [1147](#L1147) | \_\_("Data Module not found", "library-management-system") |
| [1148](#L1148) | ]; |
| [1149](#L1149) | } |
| [1150](#L1150) | } elseif ( $param == "owt7\_lms\_bookcase\_form" ) { |
| [1151](#L1151) |  |
| [1152](#L1152) | // Action Type |
| [1153](#L1153) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [1154](#L1154) | // Form Data |
| [1155](#L1155) | $bookcase = isset( $\_REQUEST['owt7\_txt\_bookcase\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_bookcase\_name'] ) ) : ""; |
| [1156](#L1156) | $status = isset( $\_REQUEST['owt7\_dd\_bookcase\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_bookcase\_status'] ) : 1; |
| [1157](#L1157) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['edit\_id'] ) ) : "" ; |
| [1158](#L1158) |  |
| [1159](#L1159) | if(!empty($action\_type)){ // [add, edit] |
| [1160](#L1160) |  |
| [1161](#L1161) | if($action\_type == "add"){ |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( !empty( $bookcase ) ) { |
| [1164](#L1164) |  |
| [1165](#L1165) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_bookcase(), "bookcases")){ |
| [1166](#L1166) |  |
| [1167](#L1167) | $is\_bookcase\_exists = $wpdb->get\_row( |
| [1168](#L1168) | $wpdb->prepare( |
| [1169](#L1169) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase() . " WHERE LOWER(TRIM(name)) = %s", |
| [1170](#L1170) | strtolower(trim($bookcase)) |
| [1171](#L1171) | ) |
| [1172](#L1172) | ); |
| [1173](#L1173) |  |
| [1174](#L1174) | if ( !empty( $is\_bookcase\_exists ) ) { |
| [1175](#L1175) |  |
| [1176](#L1176) | $response = [ |
| [1177](#L1177) | 0, |
| [1178](#L1178) | \_\_("Bookcase name already taken", "library-management-system") |
| [1179](#L1179) | ]; |
| [1180](#L1180) | } else { |
| [1181](#L1181) |  |
| [1182](#L1182) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_bookcase(), array( |
| [1183](#L1183) | "name" => $bookcase, |
| [1184](#L1184) | "status" => $status |
| [1185](#L1185) | )); |
| [1186](#L1186) |  |
| [1187](#L1187) | if ( $wpdb->insert\_id > 0 ) { |
| [1188](#L1188) |  |
| [1189](#L1189) | $response = [ |
| [1190](#L1190) | 1, |
| [1191](#L1191) | \_\_("Successfully, Bookcase added to LMS", "library-management-system") |
| [1192](#L1192) | ]; |
| [1193](#L1193) | } else { |
| [1194](#L1194) | $response = [ |
| [1195](#L1195) | 0, |
| [1196](#L1196) | \_\_("Failed to add Bookcase", "library-management-system") |
| [1197](#L1197) | ]; |
| [1198](#L1198) | } |
| [1199](#L1199) | } |
| [1200](#L1200) | }else{ |
| [1201](#L1201) | $response = [ |
| [1202](#L1202) | 0, |
| [1203](#L1203) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [1204](#L1204) | ]; |
| [1205](#L1205) | } |
| [1206](#L1206) | } else { |
| [1207](#L1207) | $response = [ |
| [1208](#L1208) | 0, |
| [1209](#L1209) | \_\_("Bookcase value required", "library-management-system") |
| [1210](#L1210) | ]; |
| [1211](#L1211) | } |
| [1212](#L1212) | } elseif ($action\_type == "edit"){ |
| [1213](#L1213) |  |
| [1214](#L1214) | if ( !empty( $bookcase ) ) { |
| [1215](#L1215) |  |
| [1216](#L1216) | $bookcase\_have\_same\_id = $wpdb->get\_row( |
| [1217](#L1217) | $wpdb->prepare( |
| [1218](#L1218) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase() . " WHERE LOWER(TRIM(name)) = %s AND id <> %d", |
| [1219](#L1219) | strtolower(trim($bookcase)), $edit\_id |
| [1220](#L1220) | ) |
| [1221](#L1221) | ); |
| [1222](#L1222) |  |
| [1223](#L1223) | if ( !empty( $bookcase\_have\_same\_id ) ) { |
| [1224](#L1224) |  |
| [1225](#L1225) | $response = [ |
| [1226](#L1226) | 0, |
| [1227](#L1227) | \_\_("Bookcase name already taken", "library-management-system") |
| [1228](#L1228) | ]; |
| [1229](#L1229) | }else{ |
| [1230](#L1230) |  |
| [1231](#L1231) | $is\_bookcase\_exists = $wpdb->get\_row( |
| [1232](#L1232) | $wpdb->prepare( |
| [1233](#L1233) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase() . " WHERE id = %d", |
| [1234](#L1234) | $edit\_id |
| [1235](#L1235) | ) |
| [1236](#L1236) | ); |
| [1237](#L1237) |  |
| [1238](#L1238) | if(!empty($is\_bookcase\_exists)){ |
| [1239](#L1239) |  |
| [1240](#L1240) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_bookcase(), array( |
| [1241](#L1241) | "name" => $bookcase, |
| [1242](#L1242) | "status" => $status |
| [1243](#L1243) | ), [ |
| [1244](#L1244) | "id" => $edit\_id |
| [1245](#L1245) | ]); |
| [1246](#L1246) |  |
| [1247](#L1247) | $response = [ |
| [1248](#L1248) | 1, |
| [1249](#L1249) | \_\_("Successfully, Bookcase data updated", "library-management-system") |
| [1250](#L1250) | ]; |
| [1251](#L1251) | }else{ |
| [1252](#L1252) |  |
| [1253](#L1253) | $response = [ |
| [1254](#L1254) | 0, |
| [1255](#L1255) | \_\_("Bookcase not found", "library-management-system") |
| [1256](#L1256) | ]; |
| [1257](#L1257) | } |
| [1258](#L1258) | } |
| [1259](#L1259) | } else { |
| [1260](#L1260) | $response = [ |
| [1261](#L1261) | 0, |
| [1262](#L1262) | \_\_("Bookcase value required", "library-management-system") |
| [1263](#L1263) | ]; |
| [1264](#L1264) | } |
| [1265](#L1265) | } |
| [1266](#L1266) |  |
| [1267](#L1267) | }else{ |
| [1268](#L1268) |  |
| [1269](#L1269) | $response = [ |
| [1270](#L1270) | 0, |
| [1271](#L1271) | \_\_("Invalid Operation", "library-management-system") |
| [1272](#L1272) | ]; |
| [1273](#L1273) | } |
| [1274](#L1274) | } elseif ( $param == "owt7\_lms\_section\_form" ) { |
| [1275](#L1275) |  |
| [1276](#L1276) | // Action Type |
| [1277](#L1277) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [1278](#L1278) | // Form Data |
| [1279](#L1279) | $bookcase\_id = isset( $\_REQUEST['owt7\_dd\_bookcase\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_bookcase\_id'] ) : ""; |
| [1280](#L1280) | $section = isset( $\_REQUEST['owt7\_txt\_section\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_section\_name'] ) ) : ""; |
| [1281](#L1281) | $status = isset( $\_REQUEST['owt7\_dd\_section\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_section\_status'] ) : 1; |
| [1282](#L1282) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['edit\_id'] ) ) : "" ; |
| [1283](#L1283) |  |
| [1284](#L1284) | if(!empty($action\_type)){ // [add, edit] |
| [1285](#L1285) |  |
| [1286](#L1286) | if($action\_type == "add"){ |
| [1287](#L1287) |  |
| [1288](#L1288) | if ( !empty( $section ) ) { |
| [1289](#L1289) |  |
| [1290](#L1290) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_bookcase\_sections())){ |
| [1291](#L1291) |  |
| [1292](#L1292) | $is\_section\_exists = $wpdb->get\_row( |
| [1293](#L1293) | $wpdb->prepare( |
| [1294](#L1294) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections() . " WHERE LOWER(TRIM(name)) = %s AND bookcase\_id = %d", |
| [1295](#L1295) | strtolower(trim($section)), $bookcase\_id |
| [1296](#L1296) | ) |
| [1297](#L1297) | ); |
| [1298](#L1298) |  |
| [1299](#L1299) | if ( !empty( $is\_section\_exists ) ) { |
| [1300](#L1300) |  |
| [1301](#L1301) | $response = [ |
| [1302](#L1302) | 0, |
| [1303](#L1303) | \_\_("Section name already taken", "library-management-system") |
| [1304](#L1304) | ]; |
| [1305](#L1305) | } else { |
| [1306](#L1306) |  |
| [1307](#L1307) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(), array( |
| [1308](#L1308) | "name" => $section, |
| [1309](#L1309) | "bookcase\_id" => $bookcase\_id, |
| [1310](#L1310) | "status" => $status |
| [1311](#L1311) | )); |
| [1312](#L1312) |  |
| [1313](#L1313) | if ( $wpdb->insert\_id > 0 ) { |
| [1314](#L1314) |  |
| [1315](#L1315) | $response = [ |
| [1316](#L1316) | 1, |
| [1317](#L1317) | \_\_("Successfully, Section added to LMS", "library-management-system") |
| [1318](#L1318) | ]; |
| [1319](#L1319) | } else { |
| [1320](#L1320) | $response = [ |
| [1321](#L1321) | 0, |
| [1322](#L1322) | \_\_("Failed to add Section", "library-management-system") |
| [1323](#L1323) | ]; |
| [1324](#L1324) | } |
| [1325](#L1325) | } |
| [1326](#L1326) | }else{ |
| [1327](#L1327) | $response = [ |
| [1328](#L1328) | 0, |
| [1329](#L1329) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [1330](#L1330) | ]; |
| [1331](#L1331) | } |
| [1332](#L1332) | } else { |
| [1333](#L1333) | $response = [ |
| [1334](#L1334) | 0, |
| [1335](#L1335) | \_\_("Section value required", "library-management-system") |
| [1336](#L1336) | ]; |
| [1337](#L1337) | } |
| [1338](#L1338) | } elseif ($action\_type == "edit"){ |
| [1339](#L1339) |  |
| [1340](#L1340) | if ( !empty( $section ) ) { |
| [1341](#L1341) |  |
| [1342](#L1342) | $section\_have\_same\_id = $wpdb->get\_row( |
| [1343](#L1343) | $wpdb->prepare( |
| [1344](#L1344) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections() . " WHERE LOWER(TRIM(name)) = %s AND bookcase\_id = %d AND id <> %d", |
| [1345](#L1345) | strtolower(trim($section)), $bookcase\_id, $edit\_id |
| [1346](#L1346) | ) |
| [1347](#L1347) | ); |
| [1348](#L1348) |  |
| [1349](#L1349) | if ( !empty( $section\_have\_same\_id ) ) { |
| [1350](#L1350) |  |
| [1351](#L1351) | $response = [ |
| [1352](#L1352) | 0, |
| [1353](#L1353) | \_\_("Section name already taken", "library-management-system") |
| [1354](#L1354) | ]; |
| [1355](#L1355) | }else{ |
| [1356](#L1356) |  |
| [1357](#L1357) | $is\_section\_exists = $wpdb->get\_row( |
| [1358](#L1358) | $wpdb->prepare( |
| [1359](#L1359) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections() . " WHERE id = %d", |
| [1360](#L1360) | $edit\_id |
| [1361](#L1361) | ) |
| [1362](#L1362) | ); |
| [1363](#L1363) |  |
| [1364](#L1364) | if(!empty($is\_section\_exists)){ |
| [1365](#L1365) |  |
| [1366](#L1366) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(), array( |
| [1367](#L1367) | "name" => $section, |
| [1368](#L1368) | "bookcase\_id" => $bookcase\_id, |
| [1369](#L1369) | "status" => $status |
| [1370](#L1370) | ), [ |
| [1371](#L1371) | "id" => $edit\_id |
| [1372](#L1372) | ]); |
| [1373](#L1373) |  |
| [1374](#L1374) | $response = [ |
| [1375](#L1375) | 1, |
| [1376](#L1376) | \_\_("Successfully, Section data updated", "library-management-system") |
| [1377](#L1377) | ]; |
| [1378](#L1378) | }else{ |
| [1379](#L1379) |  |
| [1380](#L1380) | $response = [ |
| [1381](#L1381) | 0, |
| [1382](#L1382) | \_\_("Section not found", "library-management-system") |
| [1383](#L1383) | ]; |
| [1384](#L1384) | } |
| [1385](#L1385) | } |
| [1386](#L1386) | } else { |
| [1387](#L1387) | $response = [ |
| [1388](#L1388) | 0, |
| [1389](#L1389) | \_\_("Section value required", "library-management-system") |
| [1390](#L1390) | ]; |
| [1391](#L1391) | } |
| [1392](#L1392) | } |
| [1393](#L1393) |  |
| [1394](#L1394) | }else{ |
| [1395](#L1395) |  |
| [1396](#L1396) | $response = [ |
| [1397](#L1397) | 0, |
| [1398](#L1398) | \_\_("Invalid Operation", "library-management-system") |
| [1399](#L1399) | ]; |
| [1400](#L1400) | } |
| [1401](#L1401) | } elseif ( $param == "owt7\_lms\_category\_form" ) { |
| [1402](#L1402) |  |
| [1403](#L1403) | // Action Type |
| [1404](#L1404) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [1405](#L1405) | // Form Data |
| [1406](#L1406) | $category = isset( $\_REQUEST['owt7\_txt\_category\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_category\_name'] ) ) : ""; |
| [1407](#L1407) | $status = isset( $\_REQUEST['owt7\_dd\_category\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_category\_status'] ) : 1; |
| [1408](#L1408) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? sanitize\_text\_field( trim( $\_REQUEST['edit\_id'] ) ) : "" ; |
| [1409](#L1409) |  |
| [1410](#L1410) | if(!empty($action\_type)){ // [add, edit] |
| [1411](#L1411) |  |
| [1412](#L1412) | if($action\_type == "add"){ |
| [1413](#L1413) |  |
| [1414](#L1414) | if ( !empty( $category ) ) { |
| [1415](#L1415) |  |
| [1416](#L1416) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_category(), "categories")){ |
| [1417](#L1417) |  |
| [1418](#L1418) | $is\_category\_exists = $wpdb->get\_row( |
| [1419](#L1419) | $wpdb->prepare( |
| [1420](#L1420) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category() . " WHERE LOWER(TRIM(name)) = %s", |
| [1421](#L1421) | strtolower(trim($category)) |
| [1422](#L1422) | ) |
| [1423](#L1423) | ); |
| [1424](#L1424) |  |
| [1425](#L1425) | if ( !empty( $is\_category\_exists ) ) { |
| [1426](#L1426) |  |
| [1427](#L1427) | $response = [ |
| [1428](#L1428) | 0, |
| [1429](#L1429) | \_\_("Category name already taken", "library-management-system") |
| [1430](#L1430) | ]; |
| [1431](#L1431) | } else { |
| [1432](#L1432) |  |
| [1433](#L1433) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_category(), array( |
| [1434](#L1434) | "name" => $category, |
| [1435](#L1435) | "status" => $status |
| [1436](#L1436) | )); |
| [1437](#L1437) |  |
| [1438](#L1438) | if ( $wpdb->insert\_id > 0 ) { |
| [1439](#L1439) |  |
| [1440](#L1440) | $response = [ |
| [1441](#L1441) | 1, |
| [1442](#L1442) | \_\_("Successfully, Category added to LMS", "library-management-system") |
| [1443](#L1443) | ]; |
| [1444](#L1444) | } else { |
| [1445](#L1445) | $response = [ |
| [1446](#L1446) | 0, |
| [1447](#L1447) | \_\_("Failed to add Category", "library-management-system") |
| [1448](#L1448) | ]; |
| [1449](#L1449) | } |
| [1450](#L1450) | } |
| [1451](#L1451) | }else{ |
| [1452](#L1452) | $response = [ |
| [1453](#L1453) | 0, |
| [1454](#L1454) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [1455](#L1455) | ]; |
| [1456](#L1456) | } |
| [1457](#L1457) | } else { |
| [1458](#L1458) | $response = [ |
| [1459](#L1459) | 0, |
| [1460](#L1460) | \_\_("Category value required", "library-management-system") |
| [1461](#L1461) | ]; |
| [1462](#L1462) | } |
| [1463](#L1463) | } elseif ($action\_type == "edit"){ |
| [1464](#L1464) |  |
| [1465](#L1465) | if ( !empty( $category ) ) { |
| [1466](#L1466) |  |
| [1467](#L1467) | $category\_have\_same\_id = $wpdb->get\_row( |
| [1468](#L1468) | $wpdb->prepare( |
| [1469](#L1469) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category() . " WHERE LOWER(TRIM(name)) = %s AND id <> %d", |
| [1470](#L1470) | strtolower(trim($category)), $edit\_id |
| [1471](#L1471) | ) |
| [1472](#L1472) | ); |
| [1473](#L1473) |  |
| [1474](#L1474) | if ( !empty( $category\_have\_same\_id ) ) { |
| [1475](#L1475) |  |
| [1476](#L1476) | $response = [ |
| [1477](#L1477) | 0, |
| [1478](#L1478) | \_\_("Category name already taken", "library-management-system") |
| [1479](#L1479) | ]; |
| [1480](#L1480) | }else{ |
| [1481](#L1481) |  |
| [1482](#L1482) | $is\_category\_exists = $wpdb->get\_row( |
| [1483](#L1483) | $wpdb->prepare( |
| [1484](#L1484) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_category() . " WHERE id = %d", |
| [1485](#L1485) | $edit\_id |
| [1486](#L1486) | ) |
| [1487](#L1487) | ); |
| [1488](#L1488) |  |
| [1489](#L1489) | if(!empty($is\_category\_exists)){ |
| [1490](#L1490) |  |
| [1491](#L1491) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_category(), array( |
| [1492](#L1492) | "name" => $category, |
| [1493](#L1493) | "status" => $status |
| [1494](#L1494) | ), [ |
| [1495](#L1495) | "id" => $edit\_id |
| [1496](#L1496) | ]); |
| [1497](#L1497) |  |
| [1498](#L1498) | $response = [ |
| [1499](#L1499) | 1, |
| [1500](#L1500) | \_\_("Successfully, Category data updated", "library-management-system") |
| [1501](#L1501) | ]; |
| [1502](#L1502) | }else{ |
| [1503](#L1503) |  |
| [1504](#L1504) | $response = [ |
| [1505](#L1505) | 0, |
| [1506](#L1506) | \_\_("Category not found", "library-management-system") |
| [1507](#L1507) | ]; |
| [1508](#L1508) | } |
| [1509](#L1509) | } |
| [1510](#L1510) | } else { |
| [1511](#L1511) | $response = [ |
| [1512](#L1512) | 0, |
| [1513](#L1513) | \_\_("Category value required", "library-management-system") |
| [1514](#L1514) | ]; |
| [1515](#L1515) | } |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | }else{ |
| [1519](#L1519) |  |
| [1520](#L1520) | $response = [ |
| [1521](#L1521) | 0, |
| [1522](#L1522) | \_\_("Invalid Operation", "library-management-system") |
| [1523](#L1523) | ]; |
| [1524](#L1524) | } |
| [1525](#L1525) | } elseif ( $param == "owt7\_lms\_book\_form" ) { |
| [1526](#L1526) |  |
| [1527](#L1527) | // Action Type |
| [1528](#L1528) | $action\_type = isset( $\_REQUEST['action\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['action\_type'] ) ) : "" ; |
| [1529](#L1529) | // Form Data |
| [1530](#L1530) | $book\_id = isset( $\_REQUEST['owt7\_txt\_book\_id'] ) ? $\_REQUEST['owt7\_txt\_book\_id'] : ""; |
| [1531](#L1531) | $category\_id = isset( $\_REQUEST['owt7\_dd\_category\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_category\_id'] ) : ""; |
| [1532](#L1532) | $bookcase\_id = isset( $\_REQUEST['owt7\_dd\_bookcase\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_bookcase\_id'] ) : ""; |
| [1533](#L1533) | $section\_id = isset( $\_REQUEST['owt7\_dd\_section\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_section\_id'] ) : ""; |
| [1534](#L1534) | $status = isset( $\_REQUEST['owt7\_dd\_book\_status'] ) ? absint( $\_REQUEST['owt7\_dd\_book\_status'] ) : 1; |
| [1535](#L1535) | $book\_name = isset( $\_REQUEST['owt7\_txt\_book\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_book\_name'] ) ) : ""; |
| [1536](#L1536) | $author\_name = isset( $\_REQUEST['owt7\_txt\_author\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_author\_name'] ) ) : "" ; |
| [1537](#L1537) | $publication\_name = isset( $\_REQUEST['owt7\_txt\_publication\_name'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_publication\_name'] ) ) : "" ; |
| [1538](#L1538) | $publication\_year = isset( $\_REQUEST['owt7\_txt\_publication\_year'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_publication\_year'] ) ) : "" ; |
| [1539](#L1539) | $publication\_location = isset( $\_REQUEST['owt7\_txt\_publication\_location'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_publication\_location'] ) ) : "" ; |
| [1540](#L1540) | $cost = isset( $\_REQUEST['owt7\_txt\_cost'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_cost'] ) ) : "" ; |
| [1541](#L1541) | $isbn = isset( $\_REQUEST['owt7\_txt\_isbn'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_isbn'] ) ) : "" ; |
| [1542](#L1542) | $book\_url = isset( $\_REQUEST['owt7\_txt\_book\_url'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_book\_url'] ) ) : "" ; |
| [1543](#L1543) | $quantity = isset( $\_REQUEST['owt7\_txt\_quantity'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_quantity'] ) ) : "" ; |
| [1544](#L1544) | $book\_language = isset( $\_REQUEST['owt7\_txt\_book\_language'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_book\_language'] ) ) : "" ; |
| [1545](#L1545) | $total\_pages = isset( $\_REQUEST['owt7\_txt\_total\_pages'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_total\_pages'] ) ) : "" ; |
| [1546](#L1546) | $description = isset( $\_REQUEST['owt7\_txt\_description'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_txt\_description'] ) ) : "" ; |
| [1547](#L1547) | $cover\_image = isset( $\_REQUEST['owt7\_cover\_image'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_cover\_image'] ) ) : "" ; |
| [1548](#L1548) | $edit\_id = isset( $\_REQUEST['edit\_id'] ) ? absint( $\_REQUEST['edit\_id'] ) : ""; |
| [1549](#L1549) |  |
| [1550](#L1550) | if(!empty($action\_type)){ // [add, edit] |
| [1551](#L1551) |  |
| [1552](#L1552) | if($action\_type == "add"){ |
| [1553](#L1553) |  |
| [1554](#L1554) | if ( !empty( $book\_id ) || !empty( $category\_id ) || !empty( $bookcase\_id ) || !empty( $section\_id ) || !empty( $book\_name ) ) { |
| [1555](#L1555) |  |
| [1556](#L1556) | if($this->owt7\_library\_free\_version\_credit($this->table\_activator->owt7\_library\_tbl\_books())){ |
| [1557](#L1557) | $is\_book\_exists = $wpdb->get\_row( |
| [1558](#L1558) | $wpdb->prepare( |
| [1559](#L1559) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_books() . " WHERE LOWER(TRIM(name)) = %s AND book\_id = %s AND category\_id = %d", |
| [1560](#L1560) | strtolower(trim($book\_name)), $book\_id, $category\_id |
| [1561](#L1561) | ) |
| [1562](#L1562) | ); |
| [1563](#L1563) |  |
| [1564](#L1564) | if ( !empty( $is\_book\_exists ) ) { |
| [1565](#L1565) |  |
| [1566](#L1566) | $response = [ |
| [1567](#L1567) | 0, |
| [1568](#L1568) | \_\_("Book name already taken", "library-management-system") |
| [1569](#L1569) | ]; |
| [1570](#L1570) | } else { |
| [1571](#L1571) |  |
| [1572](#L1572) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_books(), array( |
| [1573](#L1573) | "book\_id" => $book\_id, |
| [1574](#L1574) | "bookcase\_id" => $bookcase\_id, |
| [1575](#L1575) | "bookcase\_section\_id" => $section\_id, |
| [1576](#L1576) | "category\_id" => $category\_id, |
| [1577](#L1577) | "author\_name" => $author\_name, |
| [1578](#L1578) | "name" => $book\_name, |
| [1579](#L1579) | "publication\_name" => $publication\_name, |
| [1580](#L1580) | "publication\_year" => $publication\_year, |
| [1581](#L1581) | "publication\_location" => $publication\_location, |
| [1582](#L1582) | "amount" => $cost, |
| [1583](#L1583) | "cover\_image" => $cover\_image, |
| [1584](#L1584) | "isbn" => $isbn, |
| [1585](#L1585) | "book\_url" => $book\_url, |
| [1586](#L1586) | "stock\_quantity" => $quantity, |
| [1587](#L1587) | "book\_language" => $book\_language, |
| [1588](#L1588) | "book\_pages" => $total\_pages, |
| [1589](#L1589) | "description" => $description, |
| [1590](#L1590) | "status" => $status |
| [1591](#L1591) | )); |
| [1592](#L1592) |  |
| [1593](#L1593) | if ( $wpdb->insert\_id > 0 ) { |
| [1594](#L1594) |  |
| [1595](#L1595) | $response = [ |
| [1596](#L1596) | 1, |
| [1597](#L1597) | \_\_("Successfully, Book added to LMS", "library-management-system") |
| [1598](#L1598) | ]; |
| [1599](#L1599) | } else { |
| [1600](#L1600) | $response = [ |
| [1601](#L1601) | 0, |
| [1602](#L1602) | \_\_("Failed to add Book", "library-management-system") |
| [1603](#L1603) | ]; |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) | }else{ |
| [1607](#L1607) | $response = [ |
| [1608](#L1608) | 0, |
| [1609](#L1609) | \_\_("Sorry, No Credits Left.<br/>Upgrade to Pro Version of LMS.", "library-management-system") |
| [1610](#L1610) | ]; |
| [1611](#L1611) | } |
| [1612](#L1612) | } else { |
| [1613](#L1613) | $response = [ |
| [1614](#L1614) | 0, |
| [1615](#L1615) | \_\_("Please fill required values", "library-management-system") |
| [1616](#L1616) | ]; |
| [1617](#L1617) | } |
| [1618](#L1618) | } elseif ($action\_type == "edit"){ |
| [1619](#L1619) |  |
| [1620](#L1620) | if ( !empty( $book\_id ) || !empty( $category\_id ) || !empty( $bookcase\_id ) || !empty( $section\_id ) || !empty( $book\_name ) ) { |
| [1621](#L1621) |  |
| [1622](#L1622) | $book\_have\_same\_data = $wpdb->get\_row( |
| [1623](#L1623) | $wpdb->prepare( |
| [1624](#L1624) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_books() . " WHERE LOWER(TRIM(name)) = %s AND book\_id = %s AND category\_id = %d AND id <> %d", |
| [1625](#L1625) | strtolower(trim($book\_name)), $book\_id, $category\_id, $edit\_id |
| [1626](#L1626) | ) |
| [1627](#L1627) | ); |
| [1628](#L1628) |  |
| [1629](#L1629) | if ( !empty( $book\_have\_same\_data ) ) { |
| [1630](#L1630) |  |
| [1631](#L1631) | $response = [ |
| [1632](#L1632) | 0, |
| [1633](#L1633) | \_\_("Book name already taken", "library-management-system") |
| [1634](#L1634) | ]; |
| [1635](#L1635) | }else{ |
| [1636](#L1636) |  |
| [1637](#L1637) | $is\_book\_exists = $wpdb->get\_row( |
| [1638](#L1638) | $wpdb->prepare( |
| [1639](#L1639) | "SELECT \* from " . $this->table\_activator->owt7\_library\_tbl\_books() . " WHERE id = %d", |
| [1640](#L1640) | $edit\_id |
| [1641](#L1641) | ) |
| [1642](#L1642) | ); |
| [1643](#L1643) |  |
| [1644](#L1644) | if(!empty($is\_book\_exists)){ |
| [1645](#L1645) |  |
| [1646](#L1646) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_books(), array( |
| [1647](#L1647) | "book\_id" => $book\_id, |
| [1648](#L1648) | "bookcase\_id" => $bookcase\_id, |
| [1649](#L1649) | "bookcase\_section\_id" => $section\_id, |
| [1650](#L1650) | "category\_id" => $category\_id, |
| [1651](#L1651) | "author\_name" => $author\_name, |
| [1652](#L1652) | "name" => $book\_name, |
| [1653](#L1653) | "publication\_name" => $publication\_name, |
| [1654](#L1654) | "publication\_year" => $publication\_year, |
| [1655](#L1655) | "publication\_location" => $publication\_location, |
| [1656](#L1656) | "amount" => $cost, |
| [1657](#L1657) | "cover\_image" => $cover\_image, |
| [1658](#L1658) | "isbn" => $isbn, |
| [1659](#L1659) | "book\_url" => $book\_url, |
| [1660](#L1660) | "stock\_quantity" => $quantity, |
| [1661](#L1661) | "book\_language" => $book\_language, |
| [1662](#L1662) | "book\_pages" => $total\_pages, |
| [1663](#L1663) | "description" => $description, |
| [1664](#L1664) | "status" => $status |
| [1665](#L1665) | ), [ |
| [1666](#L1666) | "id" => $edit\_id |
| [1667](#L1667) | ]); |
| [1668](#L1668) |  |
| [1669](#L1669) | $response = [ |
| [1670](#L1670) | 1, |
| [1671](#L1671) | \_\_("Successfully, Book data updated", "library-management-system") |
| [1672](#L1672) | ]; |
| [1673](#L1673) | }else{ |
| [1674](#L1674) |  |
| [1675](#L1675) | $response = [ |
| [1676](#L1676) | 0, |
| [1677](#L1677) | \_\_("Book not found", "library-management-system") |
| [1678](#L1678) | ]; |
| [1679](#L1679) | } |
| [1680](#L1680) | } |
| [1681](#L1681) | } else { |
| [1682](#L1682) | $response = [ |
| [1683](#L1683) | 0, |
| [1684](#L1684) | \_\_("Please fill required values", "library-management-system") |
| [1685](#L1685) | ]; |
| [1686](#L1686) | } |
| [1687](#L1687) | } |
| [1688](#L1688) |  |
| [1689](#L1689) | }else{ |
| [1690](#L1690) |  |
| [1691](#L1691) | $response = [ |
| [1692](#L1692) | 0, |
| [1693](#L1693) | \_\_("Invalid Operation", "library-management-system") |
| [1694](#L1694) | ]; |
| [1695](#L1695) | } |
| [1696](#L1696) | } elseif ( $param == "owt7\_lms\_filter\_section" ){ |
| [1697](#L1697) | // Bookcase ID |
| [1698](#L1698) | $bookcase\_id = isset( $\_REQUEST['bkcase\_id'] ) ? absint( $\_REQUEST['bkcase\_id'] ) : "" ; |
| [1699](#L1699) | $sections = $wpdb->get\_results( |
| [1700](#L1700) | $wpdb->prepare( |
| [1701](#L1701) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections() . " WHERE bookcase\_id = %d AND status = %d", |
| [1702](#L1702) | $bookcase\_id, 1 |
| [1703](#L1703) | ) |
| [1704](#L1704) | ); |
| [1705](#L1705) | if(!empty($sections)){ |
| [1706](#L1706) | $response = [ |
| [1707](#L1707) | 1, |
| [1708](#L1708) | "Sections", |
| [1709](#L1709) | [ |
| [1710](#L1710) | "sections" => $sections |
| [1711](#L1711) | ] |
| [1712](#L1712) | ]; |
| [1713](#L1713) | }else{ |
| [1714](#L1714) | $response = [ |
| [1715](#L1715) | 0, |
| [1716](#L1716) | \_\_("No Section Found", "library-management-system") |
| [1717](#L1717) | ]; |
| [1718](#L1718) | } |
| [1719](#L1719) | } elseif ( $param == "owt7\_lms\_filter\_user" ){ |
| [1720](#L1720) | // Branch ID |
| [1721](#L1721) | $branch\_id = isset( $\_REQUEST['branch\_id'] ) ? absint( $\_REQUEST['branch\_id'] ) : "" ; |
| [1722](#L1722) | $users = $wpdb->get\_results( |
| [1723](#L1723) | $wpdb->prepare( |
| [1724](#L1724) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_users() . " WHERE branch\_id = %d AND status = %d", |
| [1725](#L1725) | $branch\_id, 1 |
| [1726](#L1726) | ) |
| [1727](#L1727) | ); |
| [1728](#L1728) | if(!empty($users)){ |
| [1729](#L1729) | $response = [ |
| [1730](#L1730) | 1, |
| [1731](#L1731) | "Users", |
| [1732](#L1732) | [ |
| [1733](#L1733) | "users" => $users |
| [1734](#L1734) | ] |
| [1735](#L1735) | ]; |
| [1736](#L1736) | }else{ |
| [1737](#L1737) | $response = [ |
| [1738](#L1738) | 0, |
| [1739](#L1739) | \_\_("No User Found", "library-management-system") |
| [1740](#L1740) | ]; |
| [1741](#L1741) | } |
| [1742](#L1742) | } elseif ( $param == "owt7\_lms\_filter\_book" ){ |
| [1743](#L1743) | // Category ID |
| [1744](#L1744) | $category\_id = isset( $\_REQUEST['category\_id'] ) ? absint( $\_REQUEST['category\_id'] ) : "" ; |
| [1745](#L1745) | $books = $wpdb->get\_results( |
| [1746](#L1746) | $wpdb->prepare( |
| [1747](#L1747) | "SELECT id, name from " . $this->table\_activator->owt7\_library\_tbl\_books() . " WHERE category\_id = %d AND status = %d", |
| [1748](#L1748) | $category\_id, 1 |
| [1749](#L1749) | ) |
| [1750](#L1750) | ); |
| [1751](#L1751) | if(!empty($books)){ |
| [1752](#L1752) | $response = [ |
| [1753](#L1753) | 1, |
| [1754](#L1754) | "Books", |
| [1755](#L1755) | [ |
| [1756](#L1756) | "books" => $books |
| [1757](#L1757) | ] |
| [1758](#L1758) | ]; |
| [1759](#L1759) | }else{ |
| [1760](#L1760) | $response = [ |
| [1761](#L1761) | 0, |
| [1762](#L1762) | \_\_("No book found", "library-management-system") |
| [1763](#L1763) | ]; |
| [1764](#L1764) | } |
| [1765](#L1765) | } elseif ( $param == "owt7\_lms\_borrow\_book"){ |
| [1766](#L1766) |  |
| [1767](#L1767) | $branch\_id = isset( $\_REQUEST['owt7\_dd\_branch\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_branch\_id'] ) : ""; |
| [1768](#L1768) | $u\_id = isset( $\_REQUEST['owt7\_dd\_u\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_u\_id'] ) : ""; |
| [1769](#L1769) | $category\_id = isset( $\_REQUEST['owt7\_dd\_category\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_category\_id'] ) : ""; |
| [1770](#L1770) | $book\_id = isset( $\_REQUEST['owt7\_dd\_book\_id'] ) ? absint( $\_REQUEST['owt7\_dd\_book\_id'] ) : ""; |
| [1771](#L1771) | $days\_count = isset( $\_REQUEST['owt7\_dd\_days'] ) ? absint( $\_REQUEST['owt7\_dd\_days'] ) : ""; |
| [1772](#L1772) |  |
| [1773](#L1773) | if(!empty($branch\_id) || !empty($u\_id) || !empty($category\_id) || !empty($book\_id) || !empty($days\_id)){ |
| [1774](#L1774) |  |
| [1775](#L1775) | $has\_book\_borrowed = $wpdb->get\_row( |
| [1776](#L1776) | "SELECT \* FROM " . $this->table\_activator->owt7\_library\_tbl\_book\_borrow() . " WHERE u\_id = {$u\_id} AND book\_id = {$book\_id} AND status = 1" |
| [1777](#L1777) | ); |
| [1778](#L1778) |  |
| [1779](#L1779) | if(!empty($has\_book\_borrowed)){ |
| [1780](#L1780) | $response = [ |
| [1781](#L1781) | 0, |
| [1782](#L1782) | \_\_("Failed, This Book already borrowed by User.", "library-management-system") |
| [1783](#L1783) | ]; |
| [1784](#L1784) | }else{ |
| [1785](#L1785) | $borrowed\_books = $wpdb->get\_row( |
| [1786](#L1786) | "SELECT \* FROM " . $this->table\_activator->owt7\_library\_tbl\_book\_borrow() . " WHERE u\_id = {$u\_id} AND status = 1" |
| [1787](#L1787) | ); |
| [1788](#L1788) | if(!empty($borrowed\_books)){ |
| [1789](#L1789) | $response = [ |
| [1790](#L1790) | 0, |
| [1791](#L1791) | \_\_("Want to Borrow More than 1 Book?<br/>Upgrade to Pro Version", "library-management-system") |
| [1792](#L1792) | ]; |
| [1793](#L1793) | }else{ |
| [1794](#L1794) |  |
| [1795](#L1795) | // Check for Late Fine (If any) |
| [1796](#L1796) | $book\_fine\_details = $wpdb->get\_row( |
| [1797](#L1797) | "SELECT \* FROM " . $this->table\_activator->owt7\_library\_tbl\_book\_late\_fine() . " WHERE u\_id = {$u\_id} and has\_paid = 1 AND status = 1" |
| [1798](#L1798) | ); |
| [1799](#L1799) |  |
| [1800](#L1800) | if(!empty($book\_fine\_details)){ |
| [1801](#L1801) | $response = [ |
| [1802](#L1802) | 0, |
| [1803](#L1803) | \_\_("Failed to Borrow Book.<br/>User has late fine.", "library-management-system") |
| [1804](#L1804) | ]; |
| [1805](#L1805) | }else{ |
| [1806](#L1806) |  |
| [1807](#L1807) | if($this->owt7\_library\_manage\_books\_stock($book\_id, "minus")){ |
| [1808](#L1808) |  |
| [1809](#L1809) | $borrow\_id = $this->owt7\_library\_generate\_unique\_identifier(8); |
| [1810](#L1810) | $currentDate = new DateTime(); |
| [1811](#L1811) | $currentDate->modify("+" .$days\_count. " days"); |
| [1812](#L1812) | $newDate = $currentDate->format('Y-m-d'); |
| [1813](#L1813) |  |
| [1814](#L1814) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_book\_borrow(), [ |
| [1815](#L1815) | "borrow\_id" => $borrow\_id, |
| [1816](#L1816) | "category\_id" => $category\_id, |
| [1817](#L1817) | "book\_id" => $book\_id, |
| [1818](#L1818) | "branch\_id" => $branch\_id, |
| [1819](#L1819) | "u\_id" => $u\_id, |
| [1820](#L1820) | "borrows\_days" => $days\_count, |
| [1821](#L1821) | "return\_date" => $newDate, |
| [1822](#L1822) | "status" => 1 |
| [1823](#L1823) | ]); |
| [1824](#L1824) |  |
| [1825](#L1825) | if ( $wpdb->insert\_id > 0 ) { |
| [1826](#L1826) |  |
| [1827](#L1827) | $response = [ |
| [1828](#L1828) | 1, |
| [1829](#L1829) | \_\_("Successfully, Book borrowed", "library-management-system") |
| [1830](#L1830) | ]; |
| [1831](#L1831) | } else { |
| [1832](#L1832) | $response = [ |
| [1833](#L1833) | 0, |
| [1834](#L1834) | \_\_("Failed to borrow book", "library-management-system") |
| [1835](#L1835) | ]; |
| [1836](#L1836) | } |
| [1837](#L1837) | }else{ |
| [1838](#L1838) | $response = [ |
| [1839](#L1839) | 0, |
| [1840](#L1840) | \_\_("Failed, Book is Out of Stock.", "library-management-system") |
| [1841](#L1841) | ]; |
| [1842](#L1842) | } |
| [1843](#L1843) | } |
| [1844](#L1844) | } |
| [1845](#L1845) | } |
| [1846](#L1846) | }else{ |
| [1847](#L1847) | $response = [ |
| [1848](#L1848) | 0, |
| [1849](#L1849) | \_\_("All fields are required", "library-management-system") |
| [1850](#L1850) | ]; |
| [1851](#L1851) | } |
| [1852](#L1852) | } elseif ( $param == "owt7\_lms\_filter\_borrow\_book"){ |
| [1853](#L1853) |  |
| [1854](#L1854) | $u\_id = isset( $\_REQUEST['u\_id'] ) ? absint( $\_REQUEST['u\_id'] ) : "" ; |
| [1855](#L1855) |  |
| [1856](#L1856) | $borrowed\_books = $wpdb->get\_results( |
| [1857](#L1857) | "SELECT borrow.id, (SELECT book.name FROM " . $this->table\_activator->owt7\_library\_tbl\_books() . " as book WHERE book.id = borrow.book\_id LIMIT 1) as book\_name FROM " . $this->table\_activator->owt7\_library\_tbl\_book\_borrow() . " as borrow WHERE borrow.status = 1 AND borrow.u\_id = " . $u\_id |
| [1858](#L1858) | ); |
| [1859](#L1859) |  |
| [1860](#L1860) | if(!empty($borrowed\_books)){ |
| [1861](#L1861) | $response = [ |
| [1862](#L1862) | 1, |
| [1863](#L1863) | "Books", |
| [1864](#L1864) | [ |
| [1865](#L1865) | "books" => $borrowed\_books |
| [1866](#L1866) | ] |
| [1867](#L1867) | ]; |
| [1868](#L1868) | }else{ |
| [1869](#L1869) | $response = [ |
| [1870](#L1870) | 0, |
| [1871](#L1871) | \_\_("No book found", "library-management-system") |
| [1872](#L1872) | ]; |
| [1873](#L1873) | } |
| [1874](#L1874) | } elseif ( $param == "owt7\_lms\_return\_book"){ |
| [1875](#L1875) |  |
| [1876](#L1876) | $borrow\_ids = isset( $\_REQUEST['owt7\_borrow\_books\_id'] ) ? $\_REQUEST['owt7\_borrow\_books\_id'] : ""; |
| [1877](#L1877) |  |
| [1878](#L1878) | if(!empty($borrow\_ids) && is\_array($borrow\_ids)){ |
| [1879](#L1879) |  |
| [1880](#L1880) | foreach($borrow\_ids as $borrow\_id){ |
| [1881](#L1881) |  |
| [1882](#L1882) | $book\_borrow\_details = $wpdb->get\_row( |
| [1883](#L1883) | "SELECT \* FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_borrow() . " WHERE id = {$borrow\_id} AND status = 1" |
| [1884](#L1884) | ); |
| [1885](#L1885) |  |
| [1886](#L1886) | if(!empty($book\_borrow\_details)){ |
| [1887](#L1887) |  |
| [1888](#L1888) | // Late Fine Calculation |
| [1889](#L1889) | $borrow\_days = intval($book\_borrow\_details->borrows\_days); |
| [1890](#L1890) | $return\_date = date("Y-m-d"); |
| [1891](#L1891) | $borrow\_date = date("Y-m-d", strtotime($book\_borrow\_details->created\_at)); |
| [1892](#L1892) |  |
| [1893](#L1893) | $borrow\_date\_obj = new DateTime($borrow\_date); |
| [1894](#L1894) | $return\_date\_obj = new DateTime($return\_date); |
| [1895](#L1895) |  |
| [1896](#L1896) | // Calculate the difference in days |
| [1897](#L1897) | $date\_diff = $borrow\_date\_obj->diff($return\_date\_obj)->days; |
| [1898](#L1898) | $total\_late\_fine = 0; |
| [1899](#L1899) | $extra\_days = 0; |
| [1900](#L1900) | // Check if the difference in days exceeds the borrow\_days |
| [1901](#L1901) | if ($date\_diff > $borrow\_days) { |
| [1902](#L1902) | $extra\_days = $date\_diff - $borrow\_days; |
| [1903](#L1903) | $per\_day\_late\_fine = get\_option("owt7\_lms\_late\_fine\_currency"); |
| [1904](#L1904) | $total\_late\_fine = $extra\_days \* intval($per\_day\_late\_fine); |
| [1905](#L1905) | } |
| [1906](#L1906) |  |
| [1907](#L1907) | if($this->owt7\_library\_manage\_books\_stock($book\_borrow\_details->book\_id, "plus")){ |
| [1908](#L1908) | // Insert into Return History |
| [1909](#L1909) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_book\_return(), [ |
| [1910](#L1910) | "borrow\_id" => $book\_borrow\_details->borrow\_id, |
| [1911](#L1911) | "category\_id" => $book\_borrow\_details->category\_id, |
| [1912](#L1912) | "book\_id" => $book\_borrow\_details->book\_id, |
| [1913](#L1913) | "branch\_id" => $book\_borrow\_details->branch\_id, |
| [1914](#L1914) | "u\_id" => $book\_borrow\_details->u\_id, |
| [1915](#L1915) | "has\_fine\_status" => $extra\_days > 0 ? 1 : 0, |
| [1916](#L1916) | "status" => 1 |
| [1917](#L1917) | ]); |
| [1918](#L1918) |  |
| [1919](#L1919) | // Manage Late Fine History |
| [1920](#L1920) | if($extra\_days > 0 && $total\_late\_fine > 0){ |
| [1921](#L1921) | $wpdb->insert($this->table\_activator->owt7\_library\_tbl\_book\_late\_fine(), [ |
| [1922](#L1922) | "return\_id" => $wpdb->insert\_id, |
| [1923](#L1923) | "book\_id" => $book\_borrow\_details->book\_id, |
| [1924](#L1924) | "u\_id" => $book\_borrow\_details->u\_id, |
| [1925](#L1925) | "extra\_days" => $extra\_days, |
| [1926](#L1926) | "fine\_amount" => $total\_late\_fine, |
| [1927](#L1927) | "status" => 1, |
| [1928](#L1928) | "has\_paid" => 1 // 1 - Not paid, 2 - Paid |
| [1929](#L1929) | ]); |
| [1930](#L1930) | } |
| [1931](#L1931) |  |
| [1932](#L1932) | // Update Borrow History |
| [1933](#L1933) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_book\_borrow(), [ |
| [1934](#L1934) | "status" => 0 |
| [1935](#L1935) | ], [ |
| [1936](#L1936) | "id" => $borrow\_id |
| [1937](#L1937) | ]); |
| [1938](#L1938) | } |
| [1939](#L1939) | } |
| [1940](#L1940) | } |
| [1941](#L1941) |  |
| [1942](#L1942) | $response = [ |
| [1943](#L1943) | 1, |
| [1944](#L1944) | \_\_("Successfully, Book(s) Returned", "library-management-system") |
| [1945](#L1945) | ]; |
| [1946](#L1946) |  |
| [1947](#L1947) | }else{ |
| [1948](#L1948) | $response = [ |
| [1949](#L1949) | 0, |
| [1950](#L1950) | \_\_("Please Select Book(s) to be Return", "library-management-system") |
| [1951](#L1951) | ]; |
| [1952](#L1952) | } |
| [1953](#L1953) | } elseif ( $param == "owt7\_lms\_data\_filters"){ |
| [1954](#L1954) |  |
| [1955](#L1955) | $filterby = isset( $\_REQUEST['filterby'] ) ? sanitize\_text\_field( trim( $\_REQUEST['filterby'] ) ) : "" ; |
| [1956](#L1956) | $list = isset( $\_REQUEST['list'] ) ? sanitize\_text\_field( trim( $\_REQUEST['list'] ) ) : "" ; |
| [1957](#L1957) | $filterbyId = isset( $\_REQUEST['id'] ) ? absint( $\_REQUEST['id'] ) : 0; |
| [1958](#L1958) |  |
| [1959](#L1959) | if(!empty($filterby)){ |
| [1960](#L1960) |  |
| [1961](#L1961) | $borrows = array(); |
| [1962](#L1962) |  |
| [1963](#L1963) | if($filterby == "category" && intval($filterbyId) > 0){ |
| [1964](#L1964) |  |
| [1965](#L1965) | if(!empty($list) && $list == "borrow\_history"){ |
| [1966](#L1966) |  |
| [1967](#L1967) | $borrows = $wpdb->get\_results( |
| [1968](#L1968) | "SELECT borrow.id, borrow.borrow\_id, borrow.borrows\_days, borrow.return\_date, borrow.status, borrow.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = borrow.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = borrow.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = borrow.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = borrow.u\_id LIMIT 1) as user\_name FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.category\_id = {$filterbyId} ORDER by borrow.id DESC" |
| [1969](#L1969) | ); |
| [1970](#L1970) | } elseif(!empty($list) && $list == "return\_history"){ |
| [1971](#L1971) |  |
| [1972](#L1972) | $returns = $wpdb->get\_results( |
| [1973](#L1973) | "SELECT rt.id, rt.borrow\_id, rt.status, rt.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = rt.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = rt.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = rt.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = rt.u\_id LIMIT 1) as user\_name, (SELECT borrow.borrows\_days FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as total\_days, (SELECT borrow.created\_at FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as issued\_on FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_return(). " as rt WHERE rt.category\_id = {$filterbyId} ORDER by rt.id DESC" |
| [1974](#L1974) | ); |
| [1975](#L1975) | } |
| [1976](#L1976) | } elseif($filterby == "branch" && intval($filterbyId) > 0){ |
| [1977](#L1977) |  |
| [1978](#L1978) | if(!empty($list) && $list == "borrow\_history"){ |
| [1979](#L1979) |  |
| [1980](#L1980) | $borrows = $wpdb->get\_results( |
| [1981](#L1981) | "SELECT borrow.id, borrow.borrow\_id, borrow.borrows\_days, borrow.return\_date, borrow.status, borrow.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = borrow.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = borrow.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = borrow.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = borrow.u\_id LIMIT 1) as user\_name FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.branch\_id = {$filterbyId} ORDER by borrow.id DESC" |
| [1982](#L1982) | ); |
| [1983](#L1983) | } elseif(!empty($list) && $list == "return\_history"){ |
| [1984](#L1984) |  |
| [1985](#L1985) | $returns = $wpdb->get\_results( |
| [1986](#L1986) | "SELECT rt.id, rt.borrow\_id, rt.status, rt.created\_at, (SELECT category.name FROM " .$this->table\_activator->owt7\_library\_tbl\_category(). " category WHERE category.id = rt.category\_id LIMIT 1) as category\_name, (SELECT book.name FROM " .$this->table\_activator->owt7\_library\_tbl\_books(). " book WHERE book.id = rt.book\_id LIMIT 1) as book\_name, (SELECT branch.name FROM " .$this->table\_activator->owt7\_library\_tbl\_branch(). " branch WHERE branch.id = rt.branch\_id LIMIT 1) as branch\_name, (SELECT user.name FROM " .$this->table\_activator->owt7\_library\_tbl\_users(). " user WHERE user.id = rt.u\_id LIMIT 1) as user\_name, (SELECT borrow.borrows\_days FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as total\_days, (SELECT borrow.created\_at FROM " .$this->table\_activator->owt7\_library\_tbl\_book\_borrow(). " borrow WHERE borrow.borrow\_id = rt.borrow\_id LIMIT 1) as issued\_on FROM ".$this->table\_activator->owt7\_library\_tbl\_book\_return(). " as rt WHERE rt.branch\_id = {$filterbyId} ORDER by rt.id DESC" |
| [1987](#L1987) | ); |
| [1988](#L1988) | } |
| [1989](#L1989) | } |
| [1990](#L1990) |  |
| [1991](#L1991) | if(!empty($list) && $list == "borrow\_history"){ |
| [1992](#L1992) |  |
| [1993](#L1993) | if(!empty($borrows)){ |
| [1994](#L1994) | ob\_start(); |
| [1995](#L1995) | // Template Variables |
| [1996](#L1996) | $params['borrows'] = $borrows; |
| [1997](#L1997) | include\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . 'admin/views/transactions/templates/owt7\_library\_borrow\_list.php'; |
| [1998](#L1998) | $template = ob\_get\_contents(); |
| [1999](#L1999) | ob\_end\_clean(); |
| [2000](#L2000) | // Output |
| [2001](#L2001) | $response = [ |
| [2002](#L2002) | 1, |
| [2003](#L2003) | "Book(s) Borrow List", |
| [2004](#L2004) | [ |
| [2005](#L2005) | "template" => $template |
| [2006](#L2006) | ] |
| [2007](#L2007) | ]; |
| [2008](#L2008) | }else{ |
| [2009](#L2009) |  |
| [2010](#L2010) | $response = [ |
| [2011](#L2011) | 0, |
| [2012](#L2012) | \_\_("No data found", "library-management-system") |
| [2013](#L2013) | ]; |
| [2014](#L2014) | } |
| [2015](#L2015) | } elseif(!empty($list) && $list == "return\_history"){ |
| [2016](#L2016) |  |
| [2017](#L2017) | if(!empty($returns)){ |
| [2018](#L2018) | ob\_start(); |
| [2019](#L2019) | // Template Variables |
| [2020](#L2020) | $params['returns'] = $returns; |
| [2021](#L2021) | include\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . 'admin/views/transactions/templates/owt7\_library\_return\_list.php'; |
| [2022](#L2022) | $template = ob\_get\_contents(); |
| [2023](#L2023) | ob\_end\_clean(); |
| [2024](#L2024) | // Output |
| [2025](#L2025) | $response = [ |
| [2026](#L2026) | 1, |
| [2027](#L2027) | "Book(s) Return List", |
| [2028](#L2028) | [ |
| [2029](#L2029) | "template" => $template |
| [2030](#L2030) | ] |
| [2031](#L2031) | ]; |
| [2032](#L2032) | }else{ |
| [2033](#L2033) |  |
| [2034](#L2034) | $response = [ |
| [2035](#L2035) | 0, |
| [2036](#L2036) | \_\_("No data found", "library-management-system") |
| [2037](#L2037) | ]; |
| [2038](#L2038) | } |
| [2039](#L2039) | } |
| [2040](#L2040) | }else{ |
| [2041](#L2041) |  |
| [2042](#L2042) | $response = [ |
| [2043](#L2043) | 0, |
| [2044](#L2044) | \_\_("Invalid LMS operation", "library-management-system") |
| [2045](#L2045) | ]; |
| [2046](#L2046) | } |
| [2047](#L2047) | } elseif ( $param == "owt7\_lms\_data\_settings"){ |
| [2048](#L2048) |  |
| [2049](#L2049) | $type = isset( $\_REQUEST['owt7\_lms\_settings\_type'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_lms\_settings\_type'] ) ) : "" ; |
| [2050](#L2050) |  |
| [2051](#L2051) | if(!empty($type) && $type == "late\_fine"){ |
| [2052](#L2052) |  |
| [2053](#L2053) | $amount = isset( $\_REQUEST['owt7\_lms\_fine\_amount'] ) ? absint( $\_REQUEST['owt7\_lms\_fine\_amount'] ) : 0; |
| [2054](#L2054) | update\_option( 'owt7\_lms\_late\_fine\_currency', intval($amount) ); |
| [2055](#L2055) |  |
| [2056](#L2056) | $response = [ |
| [2057](#L2057) | 1, |
| [2058](#L2058) | \_\_("Successfully, LMS Settings updated", "library-management-system") |
| [2059](#L2059) | ]; |
| [2060](#L2060) | } elseif(!empty($type) && $type == "country\_currency"){ |
| [2061](#L2061) |  |
| [2062](#L2062) | $country = isset( $\_REQUEST['owt7\_lms\_country'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_lms\_country'] ) ) : "" ; |
| [2063](#L2063) | $currency = isset( $\_REQUEST['owt7\_lms\_currency'] ) ? sanitize\_text\_field( trim( $\_REQUEST['owt7\_lms\_currency'] ) ) : "" ; |
| [2064](#L2064) | update\_option( 'owt7\_lms\_country', $country ); |
| [2065](#L2065) | update\_option( 'owt7\_lms\_currency', $currency ); |
| [2066](#L2066) |  |
| [2067](#L2067) | $response = [ |
| [2068](#L2068) | 1, |
| [2069](#L2069) | \_\_("Successfully, LMS Settings updated", "library-management-system") |
| [2070](#L2070) | ]; |
| [2071](#L2071) | } |
| [2072](#L2072) | } elseif ( $param == "owt7\_lms\_data\_option\_filters"){ |
| [2073](#L2073) |  |
| [2074](#L2074) | $filterValue = isset( $\_REQUEST['value'] ) ? sanitize\_text\_field( $\_REQUEST['value'] ) : "all" ; |
| [2075](#L2075) | $filterBy = isset( $\_REQUEST['filterBy'] ) ? sanitize\_text\_field( trim( $\_REQUEST['filterBy'] ) ) : "" ; |
| [2076](#L2076) | $module = isset( $\_REQUEST['module'] ) ? sanitize\_text\_field( trim( $\_REQUEST['module'] ) ) : "" ; |
| [2077](#L2077) |  |
| [2078](#L2078) | if(!empty($module)){ |
| [2079](#L2079) |  |
| [2080](#L2080) | // Books |
| [2081](#L2081) | if($module == "books" && $filterBy == "category"){ |
| [2082](#L2082) |  |
| [2083](#L2083) | if($filterValue == "all"){ |
| [2084](#L2084) |  |
| [2085](#L2085) | // All Books |
| [2086](#L2086) | $books = $wpdb->get\_results( |
| [2087](#L2087) | "SELECT book.id, book.book\_id, book.name, book.stock\_quantity, book.status, book.created\_at, (SELECT category.name FROM ".$this->table\_activator->owt7\_library\_tbl\_category()." as category WHERE category.id = book.category\_id LIMIT 1) as category\_name, (SELECT bkcase.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase()." as bkcase WHERE bkcase.id = book.bookcase\_id LIMIT 1) as bookcase\_name, (SELECT section.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()." as section WHERE section.id = book.bookcase\_section\_id LIMIT 1) as section\_name from " . $this->table\_activator->owt7\_library\_tbl\_books(). " as book" |
| [2088](#L2088) | ); |
| [2089](#L2089) | } elseif ( $filterValue > 0 ){ |
| [2090](#L2090) |  |
| [2091](#L2091) | // Filtered Books |
| [2092](#L2092) | $books = $wpdb->get\_results( |
| [2093](#L2093) | "SELECT book.id, book.book\_id, book.name, book.stock\_quantity, book.status, book.created\_at, (SELECT category.name FROM ".$this->table\_activator->owt7\_library\_tbl\_category()." as category WHERE category.id = book.category\_id LIMIT 1) as category\_name, (SELECT bkcase.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase()." as bkcase WHERE bkcase.id = book.bookcase\_id LIMIT 1) as bookcase\_name, (SELECT section.name FROM ".$this->table\_activator->owt7\_library\_tbl\_bookcase\_sections()." as section WHERE section.id = book.bookcase\_section\_id LIMIT 1) as section\_name from " . $this->table\_activator->owt7\_library\_tbl\_books(). " as book WHERE book.category\_id = {$filterValue}" |
| [2094](#L2094) | ); |
| [2095](#L2095) | } |
| [2096](#L2096) |  |
| [2097](#L2097) | $moduleFolder = "books"; |
| [2098](#L2098) | } elseif($module == "sections" && $filterBy == "bookcase"){ // Bookcases |
| [2099](#L2099) |  |
| [2100](#L2100) | if($filterValue == "all"){ |
| [2101](#L2101) |  |
| [2102](#L2102) | // All Sections |
| [2103](#L2103) | $sections = $wpdb->get\_results( |
| [2104](#L2104) | "SELECT sec.\*, bkcase.name as bookcase\_name from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(). " sec INNER JOIN ". $this->table\_activator->owt7\_library\_tbl\_bookcase() . " bkcase ON sec.bookcase\_id = bkcase.id" |
| [2105](#L2105) | ); |
| [2106](#L2106) | } elseif ( $filterValue > 0 ){ |
| [2107](#L2107) |  |
| [2108](#L2108) | // Filtered Sections |
| [2109](#L2109) | $sections = $wpdb->get\_results( |
| [2110](#L2110) | "SELECT sec.\*, bkcase.name as bookcase\_name from " . $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(). " sec INNER JOIN ". $this->table\_activator->owt7\_library\_tbl\_bookcase() . " bkcase ON sec.bookcase\_id = bkcase.id WHERE sec.bookcase\_id = {$filterValue}" |
| [2111](#L2111) | ); |
| [2112](#L2112) | } |
| [2113](#L2113) |  |
| [2114](#L2114) | $moduleFolder = "bookcases"; |
| [2115](#L2115) | } elseif($module == "users" && $filterBy == "branch"){ // Users |
| [2116](#L2116) |  |
| [2117](#L2117) | if($filterValue == "all"){ |
| [2118](#L2118) |  |
| [2119](#L2119) | // All Users |
| [2120](#L2120) | $users = $wpdb->get\_results( |
| [2121](#L2121) | "SELECT user.\*, (SELECT name FROM ".$this->table\_activator->owt7\_library\_tbl\_branch()." as branch WHERE branch.id = user.branch\_id LIMIT 1) as branch\_name from " . $this->table\_activator->owt7\_library\_tbl\_users()." as user" |
| [2122](#L2122) | ); |
| [2123](#L2123) | } elseif ( $filterValue > 0 ){ |
| [2124](#L2124) |  |
| [2125](#L2125) | // Filtered Users |
| [2126](#L2126) | $users = $wpdb->get\_results( |
| [2127](#L2127) | "SELECT user.\*, (SELECT name FROM ".$this->table\_activator->owt7\_library\_tbl\_branch()." as branch WHERE branch.id = user.branch\_id LIMIT 1) as branch\_name from " . $this->table\_activator->owt7\_library\_tbl\_users()." as user WHERE user.branch\_id = {$filterValue}" |
| [2128](#L2128) | ); |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | $moduleFolder = "users"; |
| [2132](#L2132) | } |
| [2133](#L2133) |  |
| [2134](#L2134) | $params[$module] = ${$module}; |
| [2135](#L2135) |  |
| [2136](#L2136) | ob\_start(); |
| [2137](#L2137) | include\_once LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . "admin/views/{$moduleFolder}/templates/owt7\_library\_{$module}\_list.php"; |
| [2138](#L2138) | $template = ob\_get\_contents(); |
| [2139](#L2139) | ob\_end\_clean(); |
| [2140](#L2140) |  |
| [2141](#L2141) | $response = [ |
| [2142](#L2142) | 1, |
| [2143](#L2143) | ucfirst($module), |
| [2144](#L2144) | [ |
| [2145](#L2145) | "template" => $template |
| [2146](#L2146) | ] |
| [2147](#L2147) | ]; |
| [2148](#L2148) | }else{ |
| [2149](#L2149) |  |
| [2150](#L2150) | $response = [ |
| [2151](#L2151) | 0, |
| [2152](#L2152) | \_\_("Invalid LMS Module", "library-management-system") |
| [2153](#L2153) | ]; |
| [2154](#L2154) | } |
| [2155](#L2155) | } elseif ( $param == "owt7\_lms\_import\_test\_data" ){ |
| [2156](#L2156) |  |
| [2157](#L2157) | // Remove existing data |
| [2158](#L2158) | $truncateTableNames = [ |
| [2159](#L2159) | $this->table\_activator->owt7\_library\_tbl\_category(), |
| [2160](#L2160) | $this->table\_activator->owt7\_library\_tbl\_books(), |
| [2161](#L2161) | $this->table\_activator->owt7\_library\_tbl\_bookcase(), |
| [2162](#L2162) | $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(), |
| [2163](#L2163) | $this->table\_activator->owt7\_library\_tbl\_branch(), |
| [2164](#L2164) | $this->table\_activator->owt7\_library\_tbl\_users() |
| [2165](#L2165) | ]; |
| [2166](#L2166) | foreach($truncateTableNames as $table){ |
| [2167](#L2167) | $wpdb->query("TRUNCATE TABLE {$table}"); |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | $directory = LIBRARY\_MANAGEMENT\_SYSTEM\_PLUGIN\_DIR\_PATH . 'admin/sample-data'; |
| [2171](#L2171) | $files = array\_diff(scandir($directory), array('..', '.')); |
| [2172](#L2172) |  |
| [2173](#L2173) | $import\_status = false; |
| [2174](#L2174) |  |
| [2175](#L2175) | foreach ($files as $file) { |
| [2176](#L2176) |  |
| [2177](#L2177) | $csvFilePath = $directory . "/" . $file; |
| [2178](#L2178) |  |
| [2179](#L2179) | if(file\_exists($csvFilePath)){ |
| [2180](#L2180) |  |
| [2181](#L2181) | if (pathinfo($file, PATHINFO\_EXTENSION) == 'csv') { |
| [2182](#L2182) |  |
| [2183](#L2183) | $file\_name = pathinfo($file, PATHINFO\_FILENAME); |
| [2184](#L2184) | $csvFile = fopen($directory . "/" . $file, 'r'); |
| [2185](#L2185) |  |
| [2186](#L2186) | $data\_columns = fgetcsv($csvFile); |
| [2187](#L2187) |  |
| [2188](#L2188) | $csv\_data = []; |
| [2189](#L2189) | while (($row = fgetcsv($csvFile)) !== false) { |
| [2190](#L2190) | $csv\_data[] = $row; |
| [2191](#L2191) | } |
| [2192](#L2192) |  |
| [2193](#L2193) | fclose($csvFile); |
| [2194](#L2194) |  |
| [2195](#L2195) | if (!empty($csv\_data)) { |
| [2196](#L2196) |  |
| [2197](#L2197) | global $wpdb; |
| [2198](#L2198) | $table\_name = ""; |
| [2199](#L2199) | $credit = base64\_decode(LMS\_FREE\_VERSION\_LIMIT); |
| [2200](#L2200) |  |
| [2201](#L2201) | if($file\_name == "categories"){ |
| [2202](#L2202) | $csv\_data = array\_slice($csv\_data, 0, ($credit - 10)); |
| [2203](#L2203) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_category(); |
| [2204](#L2204) | } elseif($file\_name == "books"){ |
| [2205](#L2205) | $csv\_data = array\_slice($csv\_data, 0, $credit); |
| [2206](#L2206) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_books(); |
| [2207](#L2207) | } elseif($file\_name == "bookcases"){ |
| [2208](#L2208) | $csv\_data = array\_slice($csv\_data, 0, ($credit - 10)); |
| [2209](#L2209) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_bookcase(); |
| [2210](#L2210) | } elseif($file\_name == "sections"){ |
| [2211](#L2211) | $csv\_data = array\_slice($csv\_data, 0, $credit); |
| [2212](#L2212) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(); |
| [2213](#L2213) | } elseif($file\_name == "branches"){ |
| [2214](#L2214) | $csv\_data = array\_slice($csv\_data, 0, ($credit - 10)); |
| [2215](#L2215) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_branch(); |
| [2216](#L2216) | } elseif($file\_name == "users"){ |
| [2217](#L2217) | $csv\_data = array\_slice($csv\_data, 0, $credit); |
| [2218](#L2218) | $table\_name = $this->table\_activator->owt7\_library\_tbl\_users(); |
| [2219](#L2219) | } |
| [2220](#L2220) |  |
| [2221](#L2221) | $eachRow = []; |
| [2222](#L2222) | // Attach column with Data |
| [2223](#L2223) | foreach($csv\_data as $data){ |
| [2224](#L2224) | for($rowCount = 0; $rowCount < count($data\_columns); $rowCount++){ |
| [2225](#L2225) | $eachRow[$data\_columns[$rowCount]] = $data[$rowCount]; |
| [2226](#L2226) | } |
| [2227](#L2227) | $wpdb->insert($table\_name, $eachRow); |
| [2228](#L2228) | } |
| [2229](#L2229) |  |
| [2230](#L2230) | $import\_status = true; |
| [2231](#L2231) | } |
| [2232](#L2232) | } |
| [2233](#L2233) | } |
| [2234](#L2234) | } |
| [2235](#L2235) |  |
| [2236](#L2236) | if($import\_status){ |
| [2237](#L2237) | // Test Data Flag |
| [2238](#L2238) | update\_option("owt7\_lms\_test\_data", 1); |
| [2239](#L2239) |  |
| [2240](#L2240) | $response = [ |
| [2241](#L2241) | 1, |
| [2242](#L2242) | \_\_("Successfully, Test Data Imported to LMS", "library-management-system") |
| [2243](#L2243) | ]; |
| [2244](#L2244) | }else{ |
| [2245](#L2245) | $response = [ |
| [2246](#L2246) | 0, |
| [2247](#L2247) | \_\_("Failed to Import Test data", "library-management-system") |
| [2248](#L2248) | ]; |
| [2249](#L2249) | } |
| [2250](#L2250) | } elseif ( $param == "owt7\_lms\_remove\_test\_data" ){ |
| [2251](#L2251) |  |
| [2252](#L2252) | // Remove existing data |
| [2253](#L2253) | $truncateTableNames = [ |
| [2254](#L2254) | $this->table\_activator->owt7\_library\_tbl\_category(), |
| [2255](#L2255) | $this->table\_activator->owt7\_library\_tbl\_books(), |
| [2256](#L2256) | $this->table\_activator->owt7\_library\_tbl\_bookcase(), |
| [2257](#L2257) | $this->table\_activator->owt7\_library\_tbl\_bookcase\_sections(), |
| [2258](#L2258) | $this->table\_activator->owt7\_library\_tbl\_branch(), |
| [2259](#L2259) | $this->table\_activator->owt7\_library\_tbl\_users() |
| [2260](#L2260) | ]; |
| [2261](#L2261) | foreach($truncateTableNames as $table){ |
| [2262](#L2262) | $wpdb->query("TRUNCATE TABLE {$table}"); |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | delete\_option("owt7\_lms\_test\_data"); |
| [2266](#L2266) |  |
| [2267](#L2267) | $response = [ |
| [2268](#L2268) | 1, |
| [2269](#L2269) | \_\_("Successfully, Test Data Removed", "library-management-system") |
| [2270](#L2270) | ]; |
| [2271](#L2271) | } elseif ( $param == "owt7\_pay\_late\_fine" ){ |
| [2272](#L2272) |  |
| [2273](#L2273) | $return\_id = isset( $\_REQUEST['return\_id'] ) ? absint( base64\_decode($\_REQUEST['return\_id']) ) : 0; |
| [2274](#L2274) |  |
| [2275](#L2275) | $book\_fine\_details = $wpdb->get\_row( |
| [2276](#L2276) | "SELECT \* FROM " . $this->table\_activator->owt7\_library\_tbl\_book\_late\_fine() . " WHERE return\_id = {$return\_id} and has\_paid = 1" |
| [2277](#L2277) | ); |
| [2278](#L2278) |  |
| [2279](#L2279) | if(!empty($book\_fine\_details)){ |
| [2280](#L2280) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_book\_late\_fine(), [ |
| [2281](#L2281) | "has\_paid" => 2, |
| [2282](#L2282) | "status" => 0 |
| [2283](#L2283) | ], [ |
| [2284](#L2284) | "return\_id" => $return\_id |
| [2285](#L2285) | ]); |
| [2286](#L2286) | $wpdb->update($this->table\_activator->owt7\_library\_tbl\_book\_return(), [ |
| [2287](#L2287) | "has\_fine\_status" => 0 |
| [2288](#L2288) | ], [ |
| [2289](#L2289) | "id" => $return\_id |
| [2290](#L2290) | ]); |
| [2291](#L2291) | $response = [ |
| [2292](#L2292) | 1, |
| [2293](#L2293) | \_\_("Successfully, Late Fine Paid.", "library-management-system") |
| [2294](#L2294) | ]; |
| [2295](#L2295) | }else{ |
| [2296](#L2296) | $response = [ |
| [2297](#L2297) | 0, |
| [2298](#L2298) | \_\_("Fine already paid", "library-management-system") |
| [2299](#L2299) | ]; |
| [2300](#L2300) | } |
| [2301](#L2301) | } else{ |
| [2302](#L2302) |  |
| [2303](#L2303) | $response = [ |
| [2304](#L2304) | 0, |
| [2305](#L2305) | \_\_("Invalid LMS Operation", "library-management-system") |
| [2306](#L2306) | ]; |
| [2307](#L2307) | } |
| [2308](#L2308) | }else{ |
| [2309](#L2309) |  |
| [2310](#L2310) | $response = [ |
| [2311](#L2311) | 0, |
| [2312](#L2312) | \_\_("Invalid LMS operation", "library-management-system") |
| [2313](#L2313) | ]; |
| [2314](#L2314) | } |
| [2315](#L2315) | } else { |
| [2316](#L2316) |  |
| [2317](#L2317) | $response = [ |
| [2318](#L2318) | 0, |
| [2319](#L2319) | \_\_("LMS actions blocked due to security reasons", "library-management-system") |
| [2320](#L2320) | ]; |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | wp\_send\_json($this->json($response)); |
| [2324](#L2324) |  |
| [2325](#L2325) | wp\_die(); |
| [2326](#L2326) | } |
| [2327](#L2327) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/library-management-system/trunk/admin/class-library-management-system-admin.php?format=txt)
* [Original Format](/export/3222472/library-management-system/trunk/admin/class-library-management-system-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


