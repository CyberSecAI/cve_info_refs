=== Content from www.debian.org_36593c1f_20250125_054032.html ===


---

[[Date Prev](msg00113.html)][[Date Next](msg00115.html)]
[[Thread Prev](msg00113.html)][[Thread Next](msg00115.html)]
[[Date Index](maillist.html#00114)]
[[Thread Index](threads.html#00114)]

# [SECURITY] [DSA 4188-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4188-1] linux security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Tue, 01 May 2018 17:12:08 +0000
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/E1fDYoy-0003Rh-2i%40seger.debian.org)Â [E1fDYoy-0003Rh-2i@seger.debian.org](msg00114.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4188-1                   security@debian.org
<https://www.debian.org/security/>                     Salvatore Bonaccorso
May 01, 2018                          <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2017-5715 CVE-2017-5753 CVE-2017-17975 CVE-2017-18193
                 CVE-2017-18216 CVE-2017-18218 CVE-2017-18222 CVE-2017-18224
                 CVE-2017-18241 CVE-2017-18257 CVE-2018-1065 CVE-2018-1066
                 CVE-2018-1068 CVE-2018-1092 CVE-2018-1093 CVE-2018-1108
                 CVE-2018-5803 CVE-2018-7480 CVE-2018-7566 CVE-2018-7740
                 CVE-2018-7757 CVE-2018-7995 CVE-2018-8087 CVE-2018-8781
                 CVE-2018-8822 CVE-2018-10323 CVE-2018-1000199

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2017-5715

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 2 (branch
    target injection) and is mitigated for the x86 architecture (amd64
    and i386) by using the "retpoline" compiler feature which allows
    indirect branches to be isolated from speculative execution.

CVE-2017-5753

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 1
    (bounds-check bypass) and is mitigated by identifying vulnerable
    code sections (array bounds checking followed by array access) and
    replacing the array access with the speculation-safe
    array_index_nospec() function.

    More use sites will be added over time.

CVE-2017-17975

    Tuba Yavuz reported a use-after-free flaw in the USBTV007
    audio-video grabber driver. A local user could use this for denial
    of service by triggering failure of audio registration.

CVE-2017-18193

    Yunlei He reported that the f2fs implementation does not properly
    handle extent trees, allowing a local user to cause a denial of
    service via an application with multiple threads.

CVE-2017-18216

    Alex Chen reported that the OCFS2 filesystem failed to hold a
    necessary lock during nodemanager sysfs file operations,
    potentially leading to a null pointer dereference.  A local user
    could use this for denial of service.

CVE-2017-18218

    Jun He reported a user-after-free flaw in the Hisilicon HNS ethernet
    driver. A local user could use this for denial of service.

CVE-2017-18222

    It was reported that the Hisilicon Network Subsystem (HNS) driver
    implementation does not properly handle ethtool private flags. A
    local user could use this for denial of service or possibly have
    other impact.

CVE-2017-18224

    Alex Chen reported that the OCFS2 filesystem omits the use of a
    semaphore and consequently has a race condition for access to the
    extent tree during read operations in DIRECT mode. A local user
    could use this for denial of service.

CVE-2017-18241

    Yunlei He reported that the f2fs implementation does not properly
    initialise its state if the "noflush_merge" mount option is used.
    A local user with access to a filesystem mounted with this option
    could use this to cause a denial of service.

CVE-2017-18257

    It was reported that the f2fs implementation is prone to an infinite
    loop caused by an integer overflow in the __get_data_block()
    function. A local user can use this for denial of service via
    crafted use of the open and fallocate system calls with an
    FS_IOC_FIEMAP ioctl.

CVE-2018-1065

    The syzkaller tool found a NULL pointer dereference flaw in the
    netfilter subsystem when handling certain malformed iptables
    rulesets. A local user with the CAP_NET_RAW or CAP_NET_ADMIN
    capability (in any user namespace) could use this to cause a denial
    of service. Debian disables unprivileged user namespaces by default.

CVE-2018-1066

    Dan Aloni reported to Red Hat that the CIFS client implementation
    would dereference a null pointer if the server sent an invalid
    response during NTLMSSP setup negotiation.  This could be used
    by a malicious server for denial of service.

CVE-2018-1068

    The syzkaller tool found that the 32-bit compatibility layer of
    ebtables did not sufficiently validate offset values. On a 64-bit
    kernel, a local user with the CAP_NET_ADMIN capability (in any user
    namespace) could use this to overwrite kernel memory, possibly
    leading to privilege escalation. Debian disables unprivileged user
    namespaces by default.

CVE-2018-1092

    Wen Xu reported that a crafted ext4 filesystem image would
    trigger a null dereference when mounted.  A local user able
    to mount arbitrary filesystems could use this for denial of
    service.

CVE-2018-1093

    Wen Xu reported that a crafted ext4 filesystem image could trigger
    an out-of-bounds read in the ext4_valid_block_bitmap() function. A
    local user able to mount arbitrary filesystems could use this for
    denial of service.

CVE-2018-1108

    Jann Horn reported that crng_ready() does not properly handle the
    crng_init variable states and the RNG could be treated as
    cryptographically safe too early after system boot.

CVE-2018-5803

    Alexey Kodanev reported that the SCTP protocol did not range-check
    the length of chunks to be created.  A local or remote user could
    use this to cause a denial of service.

CVE-2018-7480

    Hou Tao discovered a double-free flaw in the blkcg_init_queue()
    function in block/blk-cgroup.c. A local user could use this to cause
    a denial of service or have other impact.

CVE-2018-7566

    Fan LongFei reported a race condition in the ALSA (sound)
    sequencer core, between write and ioctl operations.  This could
    lead to an out-of-bounds access or use-after-free.  A local user
    with access to a sequencer device could use this for denial of
    service or possibly for privilege escalation.

CVE-2018-7740

    Nic Losby reported that the hugetlbfs filesystem's mmap operation
    did not properly range-check the file offset.  A local user with
    access to files on a hugetlbfs filesystem could use this to cause
    a denial of service.

CVE-2018-7757

    Jason Yan reported a memory leak in the SAS (Serial-Attached
    SCSI) subsystem.  A local user on a system with SAS devices
    could use this to cause a denial of service.

CVE-2018-7995

    Seunghun Han reported a race condition in the x86 MCE
    (Machine Check Exception) driver.  This is unlikely to have
    any security impact.

CVE-2018-8087

    A memory leak flaw was found in the hwsim_new_radio_nl() function in
    the simulated radio testing tool driver for mac80211, allowing a
    local user to cause a denial of service.

CVE-2018-8781

    Eyal Itkin reported that the udl (DisplayLink) driver's mmap
    operation did not properly range-check the file offset.  A local
    user with access to a udl framebuffer device could exploit this to
    overwrite kernel memory, leading to privilege escalation.

CVE-2018-8822

    Dr Silvio Cesare of InfoSect reported that the ncpfs client
    implementation did not validate reply lengths from the server.  An
    ncpfs server could use this to cause a denial of service or
    remote code execution in the client.

CVE-2018-10323

    Wen Xu reported a NULL pointer dereference flaw in the
    xfs_bmapi_write() function triggered when mounting and operating a
    crafted xfs filesystem image. A local user able to mount arbitrary
    filesystems could use this for denial of service.

CVE-2018-1000199

    Andy Lutomirski discovered that the ptrace subsystem did not
    sufficiently validate hardware breakpoint settings.  Local users
    can use this to cause a denial of service, or possibly for
    privilege escalation, on x86 (amd64 and i386) and possibly other
    architectures.

For the stable distribution (stretch), these problems have been fixed in
version 4.9.88-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to its security
tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAlron7dfFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0Se0xAAmR31jrqeEkJhgh7qvKplrko9N27l7FCCrrqsR0cBjKtIpwBkIdm6UxP2
8HBxqK5oy3sUP/ViHBtTUqFlRbLq4fC2DsuJGGqtBk46yML4QOEV2CXA1gyhfSzG
ux5Z5nNkLDbzD7jPazbTwMusbQrDItojj6K5aoDVoRjjOpRHRViHv81kRU3KJytX
62f/vnEjxX0xkSOqLKXcUNDczLjcP2VxuKFb3si6w7YyCXq6XYhvoDch92QLJZfD
qtDUCKs1sEgWLzhktcYyhck3NGujSfLZuSLGnZowqGqaAvx/lq0sTOliKuPpnG+I
HztPR0iYQCuzsDgHbLlwGyuUnf446VRG+u/AP69qk0HqyWwCXqsTJ0rwMX04fXtR
7dR8Y1jbbXaH0+ai9V6c3zdz4UKH5rZOkpIIYSjCxVHUpE2cU4lFXYiWL/qJRBGV
150TtSgyAPBBBJa6cWgApXrHgriGEkZNscH2nmJfg2OBnDwnLJ4CvwNfij7daR8n
RlGOlvgKYCI1Ob54kKqvvxQhDrhTiBhti8T64wd2MzsrKLIRdlyTpSrsqK8VIJyg
ux1Y01sgA3JqS2XKL52ZTgCJhGkoX68+/se73P+jeRBP/tbNcXB2t2cE6gxIkiTX
eZEUmnS5IeoEcr7cYKm3M9GZvBBrVeTaFra3vSgeGDUr0XL2Yu4=
=uZGQ
-----END PGP SIGNATURE-----

```

---



=== Content from github.com_f0c90e5b_20250125_054031.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F3e4c56d41eef5595035872a2ec5a483f42e8917f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F3e4c56d41eef5595035872a2ec5a483f42e8917f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/3e4c56d41eef5595035872a2ec5a483f42e8917f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ocfs2: ip\_alloc\_sem should be taken in ocfs2\_get\_block()

[Browse files](/torvalds/linux/tree/3e4c56d41eef5595035872a2ec5a483f42e8917f)
Browse the repository at this point in the history

```
ip_alloc_sem should be taken in ocfs2_get_block() when reading file in
DIRECT mode to prevent concurrent access to extent tree with
ocfs2_dio_end_io_write(), which may cause BUGON in the following
situation:

read file 'A'                                  end_io of writing file 'A'
vfs_read
 __vfs_read
  ocfs2_file_read_iter
   generic_file_read_iter
    ocfs2_direct_IO
     __blockdev_direct_IO
      do_blockdev_direct_IO
       do_direct_IO
        get_more_blocks
         ocfs2_get_block
          ocfs2_extent_map_get_blocks
           ocfs2_get_clusters
            ocfs2_get_clusters_nocache()
             ocfs2_search_extent_list
              return the index of record which
              contains the v_cluster, that is
              v_cluster > rec[i]->e_cpos.
                                                ocfs2_dio_end_io
                                                 ocfs2_dio_end_io_write
                                                  down_write(&oi->ip_alloc_sem);
                                                  ocfs2_mark_extent_written
                                                   ocfs2_change_extent_flag
                                                    ocfs2_split_extent
                                                     ...
                                                 --> modify the rec[i]->e_cpos, resulting
                                                     in v_cluster < rec[i]->e_cpos.
             BUG_ON(v_cluster < le32_to_cpu(rec->e_cpos))

[alex.chen@huawei.com: v3]
  Link: [http://lkml.kernel.org/r/59EF3614.6050008@huawei.com](http://lkml.kernel.org/r/59EF3614.6050008%40huawei.com)
Link: [http://lkml.kernel.org/r/59EF3614.6050008@huawei.com](http://lkml.kernel.org/r/59EF3614.6050008%40huawei.com)
Fixes: [c15471f](https://github.com/torvalds/linux/commit/c15471f79506830f80eca0e7fe09b8213953ab5f) ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Alex Chen <alex.chen@huawei.com>
Reviewed-by: Jun Piao <piaojun@huawei.com>
Reviewed-by: Joseph Qi <jiangqi903@gmail.com>
Reviewed-by: Gang He <ghe@suse.com>
Acked-by: Changwei Ge <ge.changwei@h3c.com>
Cc: Mark Fasheh <mfasheh@versity.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
```

* Loading branch information

[![@torvalds](https://avatars.githubusercontent.com/u/1024025?s=40&v=4)](/torvalds)

alex chen
authored and
[torvalds](/torvalds/linux/commits?author=torvalds "View all commits by torvalds")
committed
Nov 16, 2017

1 parent
[28f5a8a](/torvalds/linux/commit/28f5a8a7c033cbf3e32277f4cc9c6afd74f05300)

commit 3e4c56d

Showing
**1 changed file**
with
**18 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

26 changes: 18 additions & 8 deletions

26
[fs/ocfs2/aops.c](#diff-7adf015a48553151c2ea2ea0272dbf077a1ba91080d6aa3b2e0d8103a0f6bd3a "fs/ocfs2/aops.c")

Show comments

[View file](/torvalds/linux/blob/3e4c56d41eef5595035872a2ec5a483f42e8917f/fs/ocfs2/aops.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -134,6 +134,19 @@ static int ocfs2\_symlink\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | return err; |
|  |  | } |
|  |  |  |
|  |  | static int ocfs2\_lock\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | struct buffer\_head \*bh\_result, int create) |
|  |  | { |
|  |  | int ret = 0; |
|  |  | struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode); |
|  |  |  |
|  |  | down\_read(&oi->ip\_alloc\_sem); |
|  |  | ret = ocfs2\_get\_block(inode, iblock, bh\_result, create); |
|  |  | up\_read(&oi->ip\_alloc\_sem); |
|  |  |  |
|  |  | return ret; |
|  |  | } |
|  |  |  |
|  |  | int ocfs2\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | struct buffer\_head \*bh\_result, int create) |
|  |  | { |
| Expand Down  Expand Up | | @@ -2128,7 +2141,7 @@ static void ocfs2\_dio\_free\_write\_ctx(struct inode \*inode, |
|  |  | \* called like this: dio->get\_blocks(dio->inode, fs\_startblk, |
|  |  | \* fs\_count, map\_bh, dio->rw == WRITE); |
|  |  | \*/ |
|  |  | static int ocfs2\_dio\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | static int ocfs2\_dio\_wr\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | struct buffer\_head \*bh\_result, int create) |
|  |  | { |
|  |  | struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); |
| Expand All | | @@ -2154,12 +2167,9 @@ static int ocfs2\_dio\_get\_block(struct inode \*inode, sector\_t iblock, |
|  |  | \* while file size will be changed. |
|  |  | \*/ |
|  |  | if (pos + total\_len <= i\_size\_read(inode)) { |
|  |  | down\_read(&oi->ip\_alloc\_sem); |
|  |  | /\* This is the fast path for re-write. \*/ |
|  |  | ret = ocfs2\_get\_block(inode, iblock, bh\_result, create); |
|  |  |  |
|  |  | up\_read(&oi->ip\_alloc\_sem); |
|  |  |  |
|  |  | /\* This is the fast path for re-write. \*/ |
|  |  | ret = ocfs2\_lock\_get\_block(inode, iblock, bh\_result, create); |
|  |  | if (buffer\_mapped(bh\_result) && |
|  |  | !buffer\_new(bh\_result) && |
|  |  | ret == 0) |
| Expand Down  Expand Up | | @@ -2424,9 +2434,9 @@ static ssize\_t ocfs2\_direct\_IO(struct kiocb \*iocb, struct iov\_iter \*iter) |
|  |  | return 0; |
|  |  |  |
|  |  | if (iov\_iter\_rw(iter) == READ) |
|  |  | get\_block = ocfs2\_get\_block; |
|  |  | get\_block = ocfs2\_lock\_get\_block; |
|  |  | else |
|  |  | get\_block = ocfs2\_dio\_get\_block; |
|  |  | get\_block = ocfs2\_dio\_wr\_get\_block; |
|  |  |  |
|  |  | return \_\_blockdev\_direct\_IO(iocb, inode, inode->i\_sb->s\_bdev, |
|  |  | iter, get\_block, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3e4c56d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F3e4c56d41eef5595035872a2ec5a483f42e8917f) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from git.kernel.org_eb4799a0_20250125_054030.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | alex chen <alex.chen@huawei.com> | 2017-11-15 17:31:44 -0800 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2017-11-15 18:21:01 -0800 |
| commit | [3e4c56d41eef5595035872a2ec5a483f42e8917f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)) | |
| tree | [f050c8e277b91c7bbc9e53986017c67eba1c6e3e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f) | |
| parent | [28f5a8a7c033cbf3e32277f4cc9c6afd74f05300](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=28f5a8a7c033cbf3e32277f4cc9c6afd74f05300) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f&id2=28f5a8a7c033cbf3e32277f4cc9c6afd74f05300)) | |
| download | [linux-3e4c56d41eef5595035872a2ec5a483f42e8917f.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3e4c56d41eef5595035872a2ec5a483f42e8917f.tar.gz) | |

ocfs2: ip\_alloc\_sem should be taken in ocfs2\_get\_block()ip\_alloc\_sem should be taken in ocfs2\_get\_block() when reading file in
DIRECT mode to prevent concurrent access to extent tree with
ocfs2\_dio\_end\_io\_write(), which may cause BUGON in the following
situation:
read file 'A' end\_io of writing file 'A'
vfs\_read
\_\_vfs\_read
ocfs2\_file\_read\_iter
generic\_file\_read\_iter
ocfs2\_direct\_IO
\_\_blockdev\_direct\_IO
do\_blockdev\_direct\_IO
do\_direct\_IO
get\_more\_blocks
ocfs2\_get\_block
ocfs2\_extent\_map\_get\_blocks
ocfs2\_get\_clusters
ocfs2\_get\_clusters\_nocache()
ocfs2\_search\_extent\_list
return the index of record which
contains the v\_cluster, that is
v\_cluster > rec[i]->e\_cpos.
ocfs2\_dio\_end\_io
ocfs2\_dio\_end\_io\_write
down\_write(&oi->ip\_alloc\_sem);
ocfs2\_mark\_extent\_written
ocfs2\_change\_extent\_flag
ocfs2\_split\_extent
...
--> modify the rec[i]->e\_cpos, resulting
in v\_cluster < rec[i]->e\_cpos.
BUG\_ON(v\_cluster < le32\_to\_cpu(rec->e\_cpos))
[alex.chen@huawei.com: v3]
Link: http://lkml.kernel.org/r/59EF3614.6050008@huawei.com
Link: [http://lkml.kernel.org/r/59EF3614.6050008@huawei.com](http://lkml.kernel.org/r/59EF3614.6050008%40huawei.com)
Fixes: c15471f79506 ("ocfs2: fix sparse file & data ordering issue in direct io")
Signed-off-by: Alex Chen <alex.chen@huawei.com>
Reviewed-by: Jun Piao <piaojun@huawei.com>
Reviewed-by: Joseph Qi <jiangqi903@gmail.com>
Reviewed-by: Gang He <ghe@suse.com>
Acked-by: Changwei Ge <ge.changwei@h3c.com>
Cc: Mark Fasheh <mfasheh@versity.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)

| -rw-r--r-- | [fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ocfs2/aops.c?id=3e4c56d41eef5595035872a2ec5a483f42e8917f) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 8 deletions

| diff --git a/fs/ocfs2/aops.c b/fs/ocfs2/aops.cindex 88a31e9340a0fb..d1516327b7875c 100644--- a/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ocfs2/aops.c?id=28f5a8a7c033cbf3e32277f4cc9c6afd74f05300)+++ b/[fs/ocfs2/aops.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ocfs2/aops.c?id=3e4c56d41eef5595035872a2ec5a483f42e8917f)@@ -134,6 +134,19 @@ bail: return err; } +static int ocfs2\_lock\_get\_block(struct inode \*inode, sector\_t iblock,+ struct buffer\_head \*bh\_result, int create)+{+ int ret = 0;+ struct ocfs2\_inode\_info \*oi = OCFS2\_I(inode);++ down\_read(&oi->ip\_alloc\_sem);+ ret = ocfs2\_get\_block(inode, iblock, bh\_result, create);+ up\_read(&oi->ip\_alloc\_sem);++ return ret;+}+ int ocfs2\_get\_block(struct inode \*inode, sector\_t iblock, struct buffer\_head \*bh\_result, int create) {@@ -2128,7 +2141,7 @@ static void ocfs2\_dio\_free\_write\_ctx(struct inode \*inode, \* called like this: dio->get\_blocks(dio->inode, fs\_startblk, \* fs\_count, map\_bh, dio->rw == WRITE); \*/-static int ocfs2\_dio\_get\_block(struct inode \*inode, sector\_t iblock,+static int ocfs2\_dio\_wr\_get\_block(struct inode \*inode, sector\_t iblock, struct buffer\_head \*bh\_result, int create) { struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb);@@ -2154,12 +2167,9 @@ static int ocfs2\_dio\_get\_block(struct inode \*inode, sector\_t iblock, \* while file size will be changed. \*/ if (pos + total\_len <= i\_size\_read(inode)) {- down\_read(&oi->ip\_alloc\_sem);- /\* This is the fast path for re-write. \*/- ret = ocfs2\_get\_block(inode, iblock, bh\_result, create);-- up\_read(&oi->ip\_alloc\_sem); + /\* This is the fast path for re-write. \*/+ ret = ocfs2\_lock\_get\_block(inode, iblock, bh\_result, create); if (buffer\_mapped(bh\_result) && !buffer\_new(bh\_result) && ret == 0)@@ -2424,9 +2434,9 @@ static ssize\_t ocfs2\_direct\_IO(struct kiocb \*iocb, struct iov\_iter \*iter) return 0;  if (iov\_iter\_rw(iter) == READ)- get\_block = ocfs2\_get\_block;+ get\_block = ocfs2\_lock\_get\_block; else- get\_block = ocfs2\_dio\_get\_block;+ get\_block = ocfs2\_dio\_wr\_get\_block;  return \_\_blockdev\_direct\_IO(iocb, inode, inode->i\_sb->s\_bdev, iter, get\_block, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 05:39:07 +0000


