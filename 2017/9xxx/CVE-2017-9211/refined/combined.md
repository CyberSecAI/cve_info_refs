=== Content from git.kernel.org_532b92ee_20250125_114448.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Herbert Xu <herbert@gondor.apana.org.au> | 2017-05-10 03:48:23 +0800 |
| --- | --- | --- |
| committer | Herbert Xu <herbert@gondor.apana.org.au> | 2017-05-18 13:04:05 +0800 |
| commit | [9933e113c2e87a9f46a40fde8dafbf801dca1ab9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)) | |
| tree | [2dfb79292d8b5799355667d5fbacfbff06d1e2e2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9) | |
| parent | [2ea659a9ef488125eb46da6eb571de5eae5c43f6](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2ea659a9ef488125eb46da6eb571de5eae5c43f6) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9&id2=2ea659a9ef488125eb46da6eb571de5eae5c43f6)) | |
| download | [linux-9933e113c2e87a9f46a40fde8dafbf801dca1ab9.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-9933e113c2e87a9f46a40fde8dafbf801dca1ab9.tar.gz) | |

crypto: skcipher - Add missing API setkey checksThe API setkey checks for key sizes and alignment went AWOL during the
skcipher conversion. This patch restores them.
Cc: <stable@vger.kernel.org>
Fixes: 4e6c3df4d729 ("crypto: skcipher - Add low-level skcipher...")
Reported-by: Baozeng <sploving1@gmail.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)

| -rw-r--r-- | [crypto/skcipher.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/crypto/skcipher.c?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9) | 40 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 1 deletions

| diff --git a/crypto/skcipher.c b/crypto/skcipher.cindex 014af741fc6a3d..4faa0fd53b0c12 100644--- a/[crypto/skcipher.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/crypto/skcipher.c?id=2ea659a9ef488125eb46da6eb571de5eae5c43f6)+++ b/[crypto/skcipher.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/crypto/skcipher.c?id=9933e113c2e87a9f46a40fde8dafbf801dca1ab9)@@ -764,6 +764,44 @@ static int crypto\_init\_skcipher\_ops\_ablkcipher(struct crypto\_tfm \*tfm) return 0; } +static int skcipher\_setkey\_unaligned(struct crypto\_skcipher \*tfm,+ const u8 \*key, unsigned int keylen)+{+ unsigned long alignmask = crypto\_skcipher\_alignmask(tfm);+ struct skcipher\_alg \*cipher = crypto\_skcipher\_alg(tfm);+ u8 \*buffer, \*alignbuffer;+ unsigned long absize;+ int ret;++ absize = keylen + alignmask;+ buffer = kmalloc(absize, GFP\_ATOMIC);+ if (!buffer)+ return -ENOMEM;++ alignbuffer = (u8 \*)ALIGN((unsigned long)buffer, alignmask + 1);+ memcpy(alignbuffer, key, keylen);+ ret = cipher->setkey(tfm, alignbuffer, keylen);+ kzfree(buffer);+ return ret;+}++static int skcipher\_setkey(struct crypto\_skcipher \*tfm, const u8 \*key,+ unsigned int keylen)+{+ struct skcipher\_alg \*cipher = crypto\_skcipher\_alg(tfm);+ unsigned long alignmask = crypto\_skcipher\_alignmask(tfm);++ if (keylen < cipher->min\_keysize || keylen > cipher->max\_keysize) {+ crypto\_skcipher\_set\_flags(tfm, CRYPTO\_TFM\_RES\_BAD\_KEY\_LEN);+ return -EINVAL;+ }++ if ((unsigned long)key & alignmask)+ return skcipher\_setkey\_unaligned(tfm, key, keylen);++ return cipher->setkey(tfm, key, keylen);+}+ static void crypto\_skcipher\_exit\_tfm(struct crypto\_tfm \*tfm) { struct crypto\_skcipher \*skcipher = \_\_crypto\_skcipher\_cast(tfm);@@ -784,7 +822,7 @@ static int crypto\_skcipher\_init\_tfm(struct crypto\_tfm \*tfm) tfm->\_\_crt\_alg->cra\_type == &crypto\_givcipher\_type) return crypto\_init\_skcipher\_ops\_ablkcipher(tfm); - skcipher->setkey = alg->setkey;+ skcipher->setkey = skcipher\_setkey; skcipher->encrypt = alg->encrypt; skcipher->decrypt = alg->decrypt; skcipher->ivsize = alg->ivsize; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 10:56:10 +0000



=== Content from github.com_83a20f4a_20250125_114449.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9933e113c2e87a9f46a40fde8dafbf801dca1ab9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9933e113c2e87a9f46a40fde8dafbf801dca1ab9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/9933e113c2e87a9f46a40fde8dafbf801dca1ab9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

crypto: skcipher - Add missing API setkey checks

[Browse files](/torvalds/linux/tree/9933e113c2e87a9f46a40fde8dafbf801dca1ab9)
Browse the repository at this point in the history

```
The API setkey checks for key sizes and alignment went AWOL during the
skcipher conversion.  This patch restores them.

Cc: <stable@vger.kernel.org>
Fixes: [4e6c3df](https://github.com/torvalds/linux/commit/4e6c3df4d729f85997cbf276bfa8ffd8579b8e77) ("crypto: skcipher - Add low-level skcipher...")
Reported-by: Baozeng <sploving1@gmail.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
```

* Loading branch information

[![@herbertx](https://avatars.githubusercontent.com/u/1070153?s=40&v=4)](/herbertx)

[herbertx](/torvalds/linux/commits?author=herbertx "View all commits by herbertx")
committed
May 18, 2017

1 parent
[2ea659a](/torvalds/linux/commit/2ea659a9ef488125eb46da6eb571de5eae5c43f6)

commit 9933e11

Showing
**1 changed file**
with
**39 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

40 changes: 39 additions & 1 deletion

40
[crypto/skcipher.c](#diff-58afa4c246f390ae25da0f3c7919dd4ed336490fa8606e9fb6e0c9aafb51d60d "crypto/skcipher.c")

Show comments

[View file](/torvalds/linux/blob/9933e113c2e87a9f46a40fde8dafbf801dca1ab9/crypto/skcipher.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -764,6 +764,44 @@ static int crypto\_init\_skcipher\_ops\_ablkcipher(struct crypto\_tfm \*tfm) |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | static int skcipher\_setkey\_unaligned(struct crypto\_skcipher \*tfm, |
|  |  | const u8 \*key, unsigned int keylen) |
|  |  | { |
|  |  | unsigned long alignmask = crypto\_skcipher\_alignmask(tfm); |
|  |  | struct skcipher\_alg \*cipher = crypto\_skcipher\_alg(tfm); |
|  |  | u8 \*buffer, \*alignbuffer; |
|  |  | unsigned long absize; |
|  |  | int ret; |
|  |  |  |
|  |  | absize = keylen + alignmask; |
|  |  | buffer = kmalloc(absize, GFP\_ATOMIC); |
|  |  | if (!buffer) |
|  |  | return -ENOMEM; |
|  |  |  |
|  |  | alignbuffer = (u8 \*)ALIGN((unsigned long)buffer, alignmask + 1); |
|  |  | memcpy(alignbuffer, key, keylen); |
|  |  | ret = cipher->setkey(tfm, alignbuffer, keylen); |
|  |  | kzfree(buffer); |
|  |  | return ret; |
|  |  | } |
|  |  |  |
|  |  | static int skcipher\_setkey(struct crypto\_skcipher \*tfm, const u8 \*key, |
|  |  | unsigned int keylen) |
|  |  | { |
|  |  | struct skcipher\_alg \*cipher = crypto\_skcipher\_alg(tfm); |
|  |  | unsigned long alignmask = crypto\_skcipher\_alignmask(tfm); |
|  |  |  |
|  |  | if (keylen < cipher->min\_keysize || keylen > cipher->max\_keysize) { |
|  |  | crypto\_skcipher\_set\_flags(tfm, CRYPTO\_TFM\_RES\_BAD\_KEY\_LEN); |
|  |  | return -EINVAL; |
|  |  | } |
|  |  |  |
|  |  | if ((unsigned long)key & alignmask) |
|  |  | return skcipher\_setkey\_unaligned(tfm, key, keylen); |
|  |  |  |
|  |  | return cipher->setkey(tfm, key, keylen); |
|  |  | } |
|  |  |  |
|  |  | static void crypto\_skcipher\_exit\_tfm(struct crypto\_tfm \*tfm) |
|  |  | { |
|  |  | struct crypto\_skcipher \*skcipher = \_\_crypto\_skcipher\_cast(tfm); |
| Expand All | | @@ -784,7 +822,7 @@ static int crypto\_skcipher\_init\_tfm(struct crypto\_tfm \*tfm) |
|  |  | tfm->\_\_crt\_alg->cra\_type == &crypto\_givcipher\_type) |
|  |  | return crypto\_init\_skcipher\_ops\_ablkcipher(tfm); |
|  |  |  |
|  |  | skcipher->setkey = alg->setkey; |
|  |  | skcipher->setkey = skcipher\_setkey; |
|  |  | skcipher->encrypt = alg->encrypt; |
|  |  | skcipher->decrypt = alg->decrypt; |
|  |  | skcipher->ivsize = alg->ivsize; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9933e11`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9933e113c2e87a9f46a40fde8dafbf801dca1ab9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from patchwork.kernel.org_88230230_20250125_114450.html ===

Toggle navigation

[Patchwork](/)
Linux Crypto

* [Patches](/project/linux-crypto/list/)
* [Bundles](/project/linux-crypto/bundles/)
* [About this project](/project/linux-crypto/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

9718933

[diff](/project/linux-crypto/patch/20170509194823.GA5217%40gondor.apana.org.au/raw/ "Download patch diff")
[mbox](/project/linux-crypto/patch/20170509194823.GA5217%40gondor.apana.org.au/mbox/ "Download patch mbox")
# crypto: al\_alg: alg\_setkey does not check key's size is zero or not, causing a Null-ptr-dereference

| Message ID | 20170509194823.GA5217@gondor.apana.org.au ([mailing list archive](https://lore.kernel.org/r/20170509194823.GA5217%40gondor.apana.org.au)) |
| --- | --- |
| State | Accepted |
| Delegated to: | Herbert Xu |
| Headers | show ``` Return-Path: <linux-crypto-owner@kernel.org> Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org 	[172.30.200.125]) 	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id 	4CB3B60236 for <patchwork-linux-crypto@patchwork.kernel.org>; 	Tue,  9 May 2017 19:48:47 +0000 (UTC) Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1]) 	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 3AB9422701 	for <patchwork-linux-crypto@patchwork.kernel.org>; 	Tue,  9 May 2017 19:48:47 +0000 (UTC) Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486) 	id 2ECC828481; Tue,  9 May 2017 19:48:47 +0000 (UTC) X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on 	pdx-wl-mail.web.codeaurora.org X-Spam-Level:  X-Spam-Status: No, score=-6.9 required=2.0 tests=BAYES_00,RCVD_IN_DNSWL_HI 	autolearn=ham version=3.3.1 Received: from vger.kernel.org (vger.kernel.org [209.132.180.67]) 	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id A712F22701 	for <patchwork-linux-crypto@patchwork.kernel.org>; 	Tue,  9 May 2017 19:48:42 +0000 (UTC) Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand 	id S1752770AbdEITsl (ORCPT 	<rfc822;patchwork-linux-crypto@patchwork.kernel.org>); 	Tue, 9 May 2017 15:48:41 -0400 Received: from [128.1.224.119] ([128.1.224.119]:40944 "EHLO 	deadmen.hmeau.com" 	rhost-flags-FAIL-FAIL-OK-FAIL) by vger.kernel.org with ESMTP 	id S1752667AbdEITsl (ORCPT <rfc822;linux-crypto@vger.kernel.org>); 	Tue, 9 May 2017 15:48:41 -0400 Received: from gondobar.mordor.me.apana.org.au ([192.168.128.4] 	helo=gondobar) 	by deadmen.hmeau.com with esmtp (Exim 4.84_2 #2 (Debian)) 	id 1d8B7V-00059I-1T; Wed, 10 May 2017 03:48:29 +0800 Received: from herbert by gondobar with local (Exim 4.84_2) 	(envelope-from <herbert@gondor.apana.org.au>) 	id 1d8B7P-0001NQ-SJ; Wed, 10 May 2017 03:48:23 +0800 Date: Wed, 10 May 2017 03:48:23 +0800 From: Herbert Xu <herbert@gondor.apana.org.au> To: Dan Carpenter <dan.carpenter@oracle.com> Cc: Baozeng <sploving1@gmail.com>, security@kernel.org, 	Linux Crypto Mailing List <linux-crypto@vger.kernel.org> Subject: Re: crypto: al_alg: alg_setkey does not check key's size is zero or 	not, causing a Null-ptr-dereference Message-ID: <20170509194823.GA5217@gondor.apana.org.au> References: <CAP=GMUGPZaWD6b_E=77keMpVO7f6EfW3rBVWV2KLnNjUiyLf5Q@mail.gmail.com> 	<20170505125928.b6dha2bnbg6y5z6n@mwanda> MIME-Version: 1.0 Content-Type: text/plain; charset=us-ascii Content-Disposition: inline In-Reply-To: <20170505125928.b6dha2bnbg6y5z6n@mwanda> User-Agent: Mutt/1.5.23 (2014-03-12) Sender: linux-crypto-owner@vger.kernel.org Precedence: bulk List-ID: <linux-crypto.vger.kernel.org> X-Mailing-List: linux-crypto@vger.kernel.org X-Virus-Scanned: ClamAV using ClamSMTP  ``` |

## Commit Message

[Herbert Xu](/project/linux-crypto/list/?submitter=130)
May 9, 2017, 7:48 p.m. UTC
```

On Fri, May 05, 2017 at 03:59:28PM +0300, Dan Carpenter wrote:
> Thanks for the Report.  I've fowarded it to Herbert Xu.

Thanks.  This is a bug in the new skcipher interface.

---8<---
Subject: crypto: skcipher - Add missing API setkey checks

The API setkey checks for key sizes and alignment went AWOL during the
skcipher conversion.  This patch restores them.

Cc: <stable@vger.kernel.org>
Fixes: 4e6c3df4d729 ("crypto: skcipher - Add low-level skcipher...")
Reported-by: Baozeng <sploving1@gmail.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

```

9718933

[diff](/project/linux-crypto/patch/20170509194823.GA5217%40gondor.apana.org.au/raw/ "Download patch diff")
[mbox](/project/linux-crypto/patch/20170509194823.GA5217%40gondor.apana.org.au/mbox/ "Download patch mbox")
## Patch

```

diff --git a/crypto/skcipher.c b/crypto/skcipher.c
index 014af74..4faa0fd 100644
--- a/crypto/skcipher.c
+++ b/crypto/skcipher.c
@@ -764,6 +764,44 @@  static int crypto_init_skcipher_ops_ablkcipher(struct crypto_tfm *tfm)
 	return 0;
 }

+static int skcipher_setkey_unaligned(struct crypto_skcipher *tfm,
+				     const u8 *key, unsigned int keylen)
+{
+	unsigned long alignmask = crypto_skcipher_alignmask(tfm);
+	struct skcipher_alg *cipher = crypto_skcipher_alg(tfm);
+	u8 *buffer, *alignbuffer;
+	unsigned long absize;
+	int ret;
+
+	absize = keylen + alignmask;
+	buffer = kmalloc(absize, GFP_ATOMIC);
+	if (!buffer)
+		return -ENOMEM;
+
+	alignbuffer = (u8 *)ALIGN((unsigned long)buffer, alignmask + 1);
+	memcpy(alignbuffer, key, keylen);
+	ret = cipher->setkey(tfm, alignbuffer, keylen);
+	kzfree(buffer);
+	return ret;
+}
+
+static int skcipher_setkey(struct crypto_skcipher *tfm, const u8 *key,
+			   unsigned int keylen)
+{
+	struct skcipher_alg *cipher = crypto_skcipher_alg(tfm);
+	unsigned long alignmask = crypto_skcipher_alignmask(tfm);
+
+	if (keylen < cipher->min_keysize || keylen > cipher->max_keysize) {
+		crypto_skcipher_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);
+		return -EINVAL;
+	}
+
+	if ((unsigned long)key & alignmask)
+		return skcipher_setkey_unaligned(tfm, key, keylen);
+
+	return cipher->setkey(tfm, key, keylen);
+}
+
 static void crypto_skcipher_exit_tfm(struct crypto_tfm *tfm)
 {
 	struct crypto_skcipher *skcipher = __crypto_skcipher_cast(tfm);
@@ -784,7 +822,7 @@  static int crypto_skcipher_init_tfm(struct crypto_tfm *tfm)
 	    tfm->__crt_alg->cra_type == &crypto_givcipher_type)
 		return crypto_init_skcipher_ops_ablkcipher(tfm);

-	skcipher->setkey = alg->setkey;
+	skcipher->setkey = skcipher_setkey;
 	skcipher->encrypt = alg->encrypt;
 	skcipher->decrypt = alg->decrypt;
 	skcipher->ivsize = alg->ivsize;

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/)
patch tracking system | version v2.2.6 | [about patchwork](/about/)


