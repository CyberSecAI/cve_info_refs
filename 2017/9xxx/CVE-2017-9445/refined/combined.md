=== Content from launchpad.net_51167e8f_20250125_081958.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[systemd package](https://launchpad.net/ubuntu/%2Bsource/systemd)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/systemd)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/systemd)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/systemd)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/systemd)

# Out of bounds write in resolved with crafted TCP responses

Bug #1695546 reported by
[Chris Coulson](https://launchpad.net/~chrisccoulson)
on 2017-06-02

[264](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [systemd (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd "Latest release: 257.1-7ubuntu1, uploaded to main on 2025-01-07 17:05:11.304679+00:00 by Nick Rosbrook (enr0n), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | High | [Dimitri John Ledkov](https://launchpad.net/~xnox) | [Ubuntu ubuntu-17.06](https://launchpad.net/ubuntu/%2Bmilestone/ubuntu-17.06) |
|  | [Xenial](https://bugs.launchpad.net/ubuntu/xenial/%2Bsource/systemd) | Fix Released | Undecided | Unassigned |  |
|  | [Yakkety](https://bugs.launchpad.net/ubuntu/yakkety/%2Bsource/systemd) | Fix Released | Undecided | Unassigned |  |
|  | [Zesty](https://bugs.launchpad.net/ubuntu/zesty/%2Bsource/systemd) | Fix Released | Undecided | Unassigned |  |
|  | [Artful](https://bugs.launchpad.net/ubuntu/artful/%2Bsource/systemd) | Fix Released | High | [Dimitri John Ledkov](https://launchpad.net/~xnox) | [Ubuntu ubuntu-17.06](https://launchpad.net/ubuntu/%2Bmilestone/ubuntu-17.06) |

### Bug Description

[Impact]

Certain sizes passed to dns\_packet\_new can cause it to allocate a buffer that's too small. A page-aligned number - sizeof(DnsPacket) + sizeof(iphdr) + sizeof(udphdr) will do this - so, on x86 this will be a page-aligned number - 80. Eg, calling dns\_packet\_new with a size of 4016 will result in an allocation of 4096 bytes, but 108 bytes of this are for the DnsPacket struct.

A malicious DNS server can exploit this by responding with a specially crafted TCP payload to trick systemd-resolved in to allocating a buffer that's too small, and subsequently write arbitrary data beyond the end of it.

To demonstrate this you can run the attached python script. This is a mock DNS server that sends a response where the first two bytes of the TCP payload specify a size of 4016 (note, this size is picked to trigger an out of bounds write on x86 - you'll probably need to pick a different number for x86-64). You'll need to temporarily set your DNS server to 127.0.0.1.

[Testcase]

Launch the attached script on i386, point resolved at the started dns server, execute a dns query via resolved observe that it crashes.

Upgrade systemd package and observe that resolved no longer crashes.

[Regression Potential]

Low, resolved is not used by default in xenial. This is a bug fix to resolved, in case somebody does use resolved in xenial.

See [original description](comments/0)

Tags:

[verification-done](/ubuntu/%2Bsource/systemd/%2Bbugs?field.tag=verification-done)
[verification-done-xenial](/ubuntu/%2Bsource/systemd/%2Bbugs?field.tag=verification-done-xenial)

## CVE References

* [2017-9445](/bugs/cve/2017-9445 "In systemd through 233, certain sizes...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Coulson (chrisccoulson)](https://launchpad.net/~chrisccoulson) wrote on 2017-06-02: |  |  | [#1](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/1) |
| --- | --- | --- | --- |

* [break-tcp.py](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4888093/%2Bfiles/break-tcp.py)
  [Edit](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4888093)
  (498 bytes,
  text/x-python)

[Chris Coulson (chrisccoulson)](https://launchpad.net/~chrisccoulson)
on 2017-06-06

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Coulson (chrisccoulson)](https://launchpad.net/~chrisccoulson) wrote on 2017-06-06: |  |  | [#2](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/2) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/2/%2Bdownload) (4.2 KiB)

The test case results in traces like this.

#0 0xb7758cf9 in \_\_kernel\_vsyscall ()

No symbol table info available.

#1 0xb728b050 in \_\_libc\_signal\_restore\_set (set=0xbf8395e0) at ../sysdeps/unix/sysv/linux/nptl-signals.h:79

No locals.

#2 \_\_GI\_raise (sig=6) at ../sysdeps/unix/sysv/linux/raise.c:55

        set = {\_\_val = {18946, 0, 808464438, 926376493, 808466485, 762454064, 807432237, 808464432, 540028976, 809119792, 540024880, 538976288, 538976288, 1987468064, 173896289, 892811106, 808464440, 926376493, 808476981, 762454064, 807432312, 808464432, 540028976, 809119792, 540024880, 538976288, 538976288, 1685478176, 173895539, 892811106, 808464481, 926376493}}

        pid = <optimised out>

        tid = <optimised out>

        ret = 0

#3 0xb728c577 in \_\_GI\_abort () at abort.c:89

        save\_stage = 2

        act = {\_\_sigaction\_handler = {sa\_handler = 0x30320a5d, sa\_sigaction = 0x30320a5d}, sa\_mask = {\_\_val = {908996910, 892822026, 808465971, 929180976, 808923957, 1914712112, 544222509, 1664102448, 808464481, 979592736, 840970544, 859255606, 538976310, 1815027744, 1764713065, 758528051, 1970170220, 1852255608, 1768697717, 1919117154, 779382905, 841903987, 774975024, 929172022, 808923957, 1647128624, 1630745911, 540028976, 1882027890, 808464416, 0, 4096}}, sa\_flags = -1222154106, sa\_restorer = 0xbf839840}

        sigs = {\_\_val = {32, 0 <repeats 31 times>}}

#4 0xb72c6f4f in \_\_libc\_message (do\_abort=<optimised out>, fmt=<optimised out>) at ../sysdeps/posix/libc\_fatal.c:175

        ap = <optimised out>

        fd = 2

        on\_2 = <optimised out>

        list = <optimised out>

        nlist = <optimised out>

        cp = <optimised out>

        written = <optimised out>

#5 0xb72cdb47 in malloc\_printerr (action=<optimised out>, str=0xb73c2d5c "double free or corruption (out)", ptr=<optimised out>, ar\_ptr=0xb7415780 <main\_arena>) at malloc.c:5046

        buf = "809d68b0"

        cp = <optimised out>

        ar\_ptr = 0xb7415780 <main\_arena>

        ptr = <optimised out>

        str = 0xb73c2d5c "double free or corruption (out)"

        action = <optimised out>

#6 0xb72ce406 in \_int\_free (av=0xb7415780 <main\_arena>, p=0x809d68a8, have\_lock=0) at malloc.c:3902

        size = <optimised out>

        fb = <optimised out>

        nextchunk = <optimised out>

        nextsize = <optimised out>

        nextinuse = <optimised out>

        prevsize = <optimised out>

        bck = <optimised out>

        fwd = <optimised out>

        errstr = <optimised out>

        locked = <optimised out>

        \_\_func\_\_ = "\_int\_free"

#7 0xb75a76fe in source\_free.lto\_priv.128 (s=<optimised out>) at ../src/libsystemd/sd-event/sd-event.c:887

No locals.

#8 0xb7602507 in sd\_event\_source\_unref (s=<optimised out>) at ../src/libsystemd/sd-event/sd-event.c:1402

No locals.

#9 0x800523b6 in dns\_stream\_stop.lto\_priv.71 (s=<optimised out>) at ../src/resolve/resolved-dns-stream.c:35

No locals.

#10 0x8005240b in dns\_stream\_complete (s=<optimised out>, error=<optimised out>) at ../src/resolve/resolved-dns-stream.c:55

No locals.

#11 0x80052689 in on\_stream\_io.lto\_priv.64 (es=0x809d6640, fd=18, revents=1, userdata=0x809d6738) at ../src/resolve/resolved-dns-stream.c:321

        s = 0x80...

[Read more...](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/2)

The test case results in traces like this.
#0 0xb7758cf9 in \_\_kernel\_vsyscall ()
No symbol table info available.
#1 0xb728b050 in \_\_libc\_signal\_restore\_set (set=0xbf8395e0) at ../sysdeps/unix/sysv/linux/nptl-signals.h:79
No locals.
#2 \_\_GI\_raise (sig=6) at ../sysdeps/unix/sysv/linux/raise.c:55
set = {\_\_val = {18946, 0, 808464438, 926376493, 808466485, 762454064, 807432237, 808464432, 540028976, 809119792, 540024880, 538976288, 538976288, 1987468064, 173896289, 892811106, 808464440, 926376493, 808476981, 762454064, 807432312, 808464432, 540028976, 809119792, 540024880, 538976288, 538976288, 1685478176, 173895539, 892811106, 808464481, 926376493}}
pid = <optimised out>
tid = <optimised out>
ret = 0
#3 0xb728c577 in \_\_GI\_abort () at abort.c:89
save\_stage = 2
act = {\_\_sigaction\_handler = {sa\_handler = 0x30320a5d, sa\_sigaction = 0x30320a5d}, sa\_mask = {\_\_val = {908996910, 892822026, 808465971, 929180976, 808923957, 1914712112, 544222509, 1664102448, 808464481, 979592736, 840970544, 859255606, 538976310, 1815027744, 1764713065, 758528051, 1970170220, 1852255608, 1768697717, 1919117154, 779382905, 841903987, 774975024, 929172022, 808923957, 1647128624, 1630745911, 540028976, 1882027890, 808464416, 0, 4096}}, sa\_flags = -1222154106, sa\_restorer = 0xbf839840}
sigs = {\_\_val = {32, 0 <repeats 31 times>}}
#4 0xb72c6f4f in \_\_libc\_message (do\_abort=<optimised out>, fmt=<optimised out>) at ../sysdeps/posix/libc\_fatal.c:175
ap = <optimised out>
fd = 2
on\_2 = <optimised out>
list = <optimised out>
nlist = <optimised out>
cp = <optimised out>
written = <optimised out>
#5 0xb72cdb47 in malloc\_printerr (action=<optimised out>, str=0xb73c2d5c "double free or corruption (out)", ptr=<optimised out>, ar\_ptr=0xb7415780 <main\_arena>) at malloc.c:5046
buf = "809d68b0"
cp = <optimised out>
ar\_ptr = 0xb7415780 <main\_arena>
ptr = <optimised out>
str = 0xb73c2d5c "double free or corruption (out)"
action = <optimised out>
#6 0xb72ce406 in \_int\_free (av=0xb7415780 <main\_arena>, p=0x809d68a8, have\_lock=0) at malloc.c:3902
size = <optimised out>
fb = <optimised out>
nextchunk = <optimised out>
nextsize = <optimised out>
nextinuse = <optimised out>
prevsize = <optimised out>
bck = <optimised out>
fwd = <optimised out>
errstr = <optimised out>
locked = <optimised out>
\_\_func\_\_ = "\_int\_free"
#7 0xb75a76fe in source\_free.lto\_priv.128 (s=<optimised out>) at ../src/libsystemd/sd-event/sd-event.c:887
No locals.
#8 0xb7602507 in sd\_event\_source\_unref (s=<optimised out>) at ../src/libsystemd/sd-event/sd-event.c:1402
No locals.
#9 0x800523b6 in dns\_stream\_stop.lto\_priv.71 (s=<optimised out>) at ../src/resolve/resolved-dns-stream.c:35
No locals.
#10 0x8005240b in dns\_stream\_complete (s=<optimised out>, error=<optimised out>) at ../src/resolve/resolved-dns-stream.c:55
No locals.
#11 0x80052689 in on\_stream\_io.lto\_priv.64 (es=0x809d6640, fd=18, revents=1, userdata=0x809d6738) at ../src/resolve/resolved-dns-stream.c:321
s = 0x809d6738
r = <optimised out>
\_\_PRETTY\_FUNCTION\_\_ = "on\_stream\_io"
#12 0xb7607cbf in source\_dispatch (s=s@entry=0x809d6640) at ../src/libsystemd/sd-event/sd-event.c:2275
r = <optimised out>
\_\_PRETTY\_FUNCTION\_\_ = "source\_dispatch"
\_\_func\_\_ = "source\_dispatch"
#13 0xb7607e89 in sd\_event\_dispatch (e=0x809cf220) at ../src/libsystemd/sd-event/sd-event.c:2626
p = <optimised out>
r = <optimised out>
\_\_PRETTY\_FUNCTION\_\_ = "sd\_event\_dispatch"
#14 0xb760974b in sd\_event\_run (e=0x809cf220, timeout=18446744073709551615) at ../src/libsystemd/sd-event/sd-event.c:2685
r = 1
\_\_PRETTY\_FUNCTION\_\_ = "sd\_event\_run"
#15 0xb760996d in sd\_event\_loop (e=0x809cf220) at ../src/libsystemd/sd-event/sd-event.c:2705
r = <optimised out>
\_\_PRETTY\_FUNCTION\_\_ = "sd\_event\_loop"
#16 0x8003d908 in main (argc=<optimised out>, argv=<optimised out>) at ../src/resolve/resolved.c:106
m = 0x0
user = 0x8006da46 "systemd-resolve"
uid = 102
gid = 104
r = 0
\_\_func\_\_ = "main"
\_\_PRETTY\_FUNCTION\_\_ = "main"

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Coulson (chrisccoulson)](https://launchpad.net/~chrisccoulson) wrote on 2017-06-06: |  |  | [#3](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/3) |
| --- | --- | --- | --- |

This appears to have been introduced by <https://github.com/systemd/systemd/commit/a0166609f782da91710dea9183d1bf138538db37>

This appears to have been introduced by https://github.com/systemd/systemd/commit/a0166609f782da91710dea9183d1bf138538db37

[Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox)
on 2017-06-06

| Changed in systemd (Ubuntu): | |
| --- | --- |
| **assignee**: | nobody → Dimitri John Ledkov (xnox) |
| **importance**: | Undecided → High |
| **milestone**: | none → ubuntu-17.06 |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2017-06-14: |  |  | [#4](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/4) |
| --- | --- | --- | --- |

* [lp1695546.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4895609/%2Bfiles/lp1695546.patch)
  [Edit](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4895609)
  (490 bytes,
  text/plain)

I can reproduce the bug, using the python script, and setting DNS to 127.0.0.1 in /etc/systemd/resolved.conf, in an artful i386 lxd container.

The proposed patch seems to work around the problem. But i'm not sure if that is correct solution, that will work for all alignments on all architectures.

I guess we should be approaching upstream about this next?

I can reproduce the bug, using the python script, and setting DNS to 127.0.0.1 in /etc/systemd/resolved.conf, in an artful i386 lxd container.
The proposed patch seems to work around the problem. But i'm not sure if that is correct solution, that will work for all alignments on all architectures.
I guess we should be approaching upstream about this next?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Coulson (chrisccoulson)](https://launchpad.net/~chrisccoulson) wrote on 2017-06-14: |  |  | [#5](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/5) |
| --- | --- | --- | --- |

I've sent the details of this to Lennart now.

I've sent the details of this to Lennart now.

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2017-06-27: |  |  | [#6](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/6) |
| --- | --- | --- | --- |

This bug was fixed in the package systemd - 232-21ubuntu5

---------------

systemd (232-21ubuntu5) zesty-security; urgency=medium

\* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: [#1695546](/bugs/1695546))

    - debian/patches/test-resolved-packet-add-a-simple-test-for-our-alloc.patch:

      Add a simple allocation test

    - debian/patches/resolved-simplify-alloc-size-calculation.patch: Simply

      allocation size calculation

    - CVE-2017-9445

-- Chris Coulson <email address hidden> Wed, 21 Jun 2017 16:33:22 +0100

This bug was fixed in the package systemd - 232-21ubuntu5
---------------
systemd (232-21ubuntu5) zesty-security; urgency=medium
\* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: #1695546)
- debian/patches/test-resolved-packet-add-a-simple-test-for-our-alloc.patch:
Add a simple allocation test
- debian/patches/resolved-simplify-alloc-size-calculation.patch: Simply
allocation size calculation
- CVE-2017-9445
-- Chris Coulson <chris.coulson@canonical.com> Wed, 21 Jun 2017 16:33:22 +0100

| Changed in systemd (Ubuntu): | |
| --- | --- |
| **status**: | New → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2017-06-27: |  |  | [#7](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/7) |
| --- | --- | --- | --- |

This bug was fixed in the package systemd - 231-9ubuntu5

---------------

systemd (231-9ubuntu5) yakkety-security; urgency=medium

\* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: [#1695546](/bugs/1695546))

    - debian/patches/test-resolved-packet-add-a-simple-test-for-our-alloc.patch:

      Add a simple allocation test

    - debian/patches/resolved-simplify-alloc-size-calculation.patch: Simply

      allocation size calculation

    - CVE-2017-9445

-- Chris Coulson <email address hidden> Wed, 21 Jun 2017 16:35:26 +0100

This bug was fixed in the package systemd - 231-9ubuntu5
---------------
systemd (231-9ubuntu5) yakkety-security; urgency=medium
\* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: #1695546)
- debian/patches/test-resolved-packet-add-a-simple-test-for-our-alloc.patch:
Add a simple allocation test
- debian/patches/resolved-simplify-alloc-size-calculation.patch: Simply
allocation size calculation
- CVE-2017-9445
-- Chris Coulson <chris.coulson@canonical.com> Wed, 21 Jun 2017 16:35:26 +0100

| Changed in systemd (Ubuntu): | |
| --- | --- |
| **status**: | New → Fix Released |

[Steve Beattie (sbeattie)](https://launchpad.net/~sbeattie)
on 2017-07-10

| **information type**: | Private Security → Public Security |
| --- | --- |

[Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox)
on 2017-07-10

| Changed in systemd (Ubuntu Xenial): | |
| --- | --- |
| **status**: | New → Confirmed |
| Changed in systemd (Ubuntu Yakkety): | |
| **status**: | New → Fix Released |
| Changed in systemd (Ubuntu Zesty): | |
| **status**: | New → Fix Released |
| **description**: | updated |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Łukasz Zemczak (sil2100)](https://launchpad.net/~sil2100) wrote on 2017-07-10:  [**Please test proposed package**](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/8) |  |  | [#8](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/8) |
| --- | --- | --- | --- |

Hello Chris, or anyone else affected,

Accepted systemd into xenial-proposed. The package will build now and be available at [https://launchpad.net/ubuntu/+source/systemd/229-4ubuntu18](https://launchpad.net/ubuntu/%2Bsource/systemd/229-4ubuntu18) in a few hours, and then in the -proposed repository.

Please help us by testing this new package. See <https://wiki.ubuntu.com/Testing/EnableProposed> for documentation on how to enable and use -proposed.Your feedback will aid us getting this update out to other Ubuntu users.

If this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested and change the tag from verification-needed-xenial to verification-done-xenial. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed-xenial. In either case, details of your testing will help us make a better decision.

Further information regarding the verification process can be found at <https://wiki.ubuntu.com/QATeam/PerformingSRUVerification> . Thank you in advance!

Hello Chris, or anyone else affected,
Accepted systemd into xenial-proposed. The package will build now and be available at https://launchpad.net/ubuntu/+source/systemd/229-4ubuntu18 in a few hours, and then in the -proposed repository.
Please help us by testing this new package. See https://wiki.ubuntu.com/Testing/EnableProposed for documentation on how to enable and use -proposed.Your feedback will aid us getting this update out to other Ubuntu users.
If this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested and change the tag from verification-needed-xenial to verification-done-xenial. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed-xenial. In either case, details of your testing will help us make a better decision.
Further information regarding the verification process can be found at https://wiki.ubuntu.com/QATeam/PerformingSRUVerification . Thank you in advance!

| Changed in systemd (Ubuntu Xenial): | |
| --- | --- |
| **status**: | Confirmed → Fix Committed |
| **tags**: | added: verification-needed verification-needed-xenial |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2017-07-12: |  |  | [#9](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/9) |
| --- | --- | --- | --- |

Instead of disconnect, I now get invalid reply response and the systemd-resolved service is not crashing.

Instead of disconnect, I now get invalid reply response and the systemd-resolved service is not crashing.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2017-07-12: |  |  | [#10](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/10) |
| --- | --- | --- | --- |

Crashes with 229-4ubuntu17, crash resiliant with 229-4ubuntu18.

Crashes with 229-4ubuntu17, crash resiliant with 229-4ubuntu18.

| **tags**: | added: verification-done verification-done-xenialremoved: verification-needed verification-needed-xenial |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Adam Conrad (adconrad)](https://launchpad.net/~adconrad) wrote on 2017-07-18: |  |  | [#11](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/11) |
| --- | --- | --- | --- |

Hello Chris, or anyone else affected,

Accepted systemd into xenial-proposed. The package will build now and be available at [https://launchpad.net/ubuntu/+source/systemd/229-4ubuntu19](https://launchpad.net/ubuntu/%2Bsource/systemd/229-4ubuntu19) in a few hours, and then in the -proposed repository.

Please help us by testing this new package. See <https://wiki.ubuntu.com/Testing/EnableProposed> for documentation on how to enable and use -proposed.Your feedback will aid us getting this update out to other Ubuntu users.

If this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested and change the tag from verification-needed-xenial to verification-done-xenial. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed-xenial. In either case, details of your testing will help us make a better decision.

Further information regarding the verification process can be found at <https://wiki.ubuntu.com/QATeam/PerformingSRUVerification> . Thank you in advance!

Hello Chris, or anyone else affected,
Accepted systemd into xenial-proposed. The package will build now and be available at https://launchpad.net/ubuntu/+source/systemd/229-4ubuntu19 in a few hours, and then in the -proposed repository.
Please help us by testing this new package. See https://wiki.ubuntu.com/Testing/EnableProposed for documentation on how to enable and use -proposed.Your feedback will aid us getting this update out to other Ubuntu users.
If this package fixes the bug for you, please add a comment to this bug, mentioning the version of the package you tested and change the tag from verification-needed-xenial to verification-done-xenial. If it does not fix the bug for you, please add a comment stating that, and change the tag to verification-failed-xenial. In either case, details of your testing will help us make a better decision.
Further information regarding the verification process can be found at https://wiki.ubuntu.com/QATeam/PerformingSRUVerification . Thank you in advance!

| **tags**: | added: verification-needed verification-needed-xenialremoved: verification-done verification-done-xenial |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2017-07-20: |  |  | [#12](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/12) |
| --- | --- | --- | --- |

Starting with systemd 229-4ubuntu17, pointed systemd-resolve to the break-tcp DNS server and observed crash in the journal after calling systemd-resolve start.ubuntu.com.

Upgraded to 229-4ubuntu19, and now systemd-resolve start.ubuntu.com instead of disconnecting and crashing systemd-resolved daemon, keeps the systemd-resolved daemon running and an error is bubbled up back to the clinet received invalid reply.

Starting with systemd 229-4ubuntu17, pointed systemd-resolve to the break-tcp DNS server and observed crash in the journal after calling systemd-resolve start.ubuntu.com.
Upgraded to 229-4ubuntu19, and now systemd-resolve start.ubuntu.com instead of disconnecting and crashing systemd-resolved daemon, keeps the systemd-resolved daemon running and an error is bubbled up back to the clinet received invalid reply.

| **tags**: | added: verification-done verification-done-xenialremoved: verification-needed verification-needed-xenial |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2017-07-20: |  |  | [#14](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/14) |
| --- | --- | --- | --- |

This bug was fixed in the package systemd - 229-4ubuntu19

---------------

systemd (229-4ubuntu19) xenial; urgency=medium

\* debian/extra/units/systemd-resolved.service.d/resolvconf.conf: partially

    revert, by removing ExecStart|StopPost lines, as these are not needed on

    xenial and generate warnings in the journal. (LP: [#1704677](/bugs/1704677))

systemd (229-4ubuntu18) xenial; urgency=medium

\* debian/extra/units/systemd-resolved.service.d/resolvconf.conf: if resolved

    is going to be started, make sure this blocks network-online.target.

    (LP: [#1673860](/bugs/1673860))

  \* networkd: cherry-pick support for setting bridge port's priority

    (LP: [#1668347](/bugs/1668347))

  \* Cherrypick upstream commit to enable system use kernel maximum limit for

    RLIMIT\_NOFILE isntead of hard-coded (low) limit of 65536. (LP: [#1686361](/bugs/1686361))

  \* Cherrypick upstream patch for platform predictable interface names.

    (LP: [#1686784](/bugs/1686784))

  \* resolved: fix null pointer dereference crash (LP: [#1621396](/bugs/1621396))

  \* Cherrypick core/timer downgrade message about random time addition

    (LP: [#1692136](/bugs/1692136))

  \* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: [#1695546](/bugs/1695546))

    - CVE-2017-9445

  \* Cherry-pick subset of patches to introduce infinity value in logind.conf

    for UserTasksMax (LP: [#1651518](/bugs/1651518))

-- Dimitri John Ledkov <email address hidden> Mon, 17 Jul 2017 17:00:42 +0100

This bug was fixed in the package systemd - 229-4ubuntu19
---------------
systemd (229-4ubuntu19) xenial; urgency=medium
\* debian/extra/units/systemd-resolved.service.d/resolvconf.conf: partially
revert, by removing ExecStart|StopPost lines, as these are not needed on
xenial and generate warnings in the journal. (LP: #1704677)
systemd (229-4ubuntu18) xenial; urgency=medium
\* debian/extra/units/systemd-resolved.service.d/resolvconf.conf: if resolved
is going to be started, make sure this blocks network-online.target.
(LP: #1673860)
\* networkd: cherry-pick support for setting bridge port's priority
(LP: #1668347)
\* Cherrypick upstream commit to enable system use kernel maximum limit for
RLIMIT\_NOFILE isntead of hard-coded (low) limit of 65536. (LP: #1686361)
\* Cherrypick upstream patch for platform predictable interface names.
(LP: #1686784)
\* resolved: fix null pointer dereference crash (LP: #1621396)
\* Cherrypick core/timer downgrade message about random time addition
(LP: #1692136)
\* SECURITY UPDATE: Out-of-bounds write in systemd-resolved (LP: #1695546)
- CVE-2017-9445
\* Cherry-pick subset of patches to introduce infinity value in logind.conf
for UserTasksMax (LP: #1651518)
-- Dimitri John Ledkov <xnox@ubuntu.com> Mon, 17 Jul 2017 17:00:42 +0100

| Changed in systemd (Ubuntu Xenial): | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Adam Conrad (adconrad)](https://launchpad.net/~adconrad) wrote on 2017-07-20:  [**Update Released**](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/13) |  |  | [#13](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/comments/13) |
| --- | --- | --- | --- |

The verification of the Stable Release Update for systemd has completed successfully and the package has now been released to -updates. Subsequently, the Ubuntu Stable Release Updates Team is being unsubscribed and will not receive messages about this bug report. In the event that you encounter a regression using the package from -updates please report a new bug using ubuntu-bug and tag the bug report regression-update so we can easily find any regressions.

The verification of the Stable Release Update for systemd has completed successfully and the package has now been released to -updates. Subsequently, the Ubuntu Stable Release Updates Team is being unsubscribed and will not receive messages about this bug report. In the event that you encounter a regression using the package from -updates please report a new bug using ubuntu-bug and tag the bug report regression-update so we can easily find any regressions.

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/systemd/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [lp1695546.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4895609/%2Bfiles/lp1695546.patch)
  [Edit](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4895609 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Baddcomment?field.patch=on)

## Bug attachments

* [break-tcp.py](https://bugs.launchpad.net/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4888093/%2Bfiles/break-tcp.py)
  [Edit](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Battachment/4888093 "Change attachment details")

* [Add attachment](/ubuntu/%2Bsource/systemd/%2Bbug/1695546/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from openwall.com_96aff5c6_20250125_081957.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](7) [[next>]](9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <03ffaee7-2345-db4b-b16c-b859ed5637cd@canonical.com>
Date: Tue, 27 Jun 2017 18:58:29 +0100
From: Chris Coulson <chris.coulson@...onical.com>
To: oss-security@...ts.openwall.com
Subject: CVE-2017-9445: Out-of-bounds write in systemd-resolved with crafted
 TCP payload

Hi,

I recently discovered an out-of-bounds write in systemd-resolved in
Ubuntu, which is possible to trigger with a specially crafted TCP payload.

Details from the Ubuntu bug follow:
<https://launchpad.net/bugs/1695546>

----
Certain sizes passed to dns_packet_new can cause it to allocate a buffer
that's too small. A page-aligned number - sizeof(DnsPacket) +
sizeof(iphdr) + sizeof(udphdr) will do this - so, on x86 this will be a
page-aligned number - 80. Eg, calling dns_packet_new with a size of 4016
on x86 will result in an allocation of 4096 bytes, but 108 bytes of this
are for the DnsPacket struct.

A malicious DNS server can exploit this by responding with a specially
crafted TCP payload to trick systemd-resolved in to allocating a buffer
that's too small, and subsequently write arbitrary data beyond the end
of it.

I believe this was introduced by
<https://github.com/systemd/systemd/commit/a0166609f782da91710dea9183d1bf138538db37>
(v223) and affects all subsequent versions up to and including v233.
----

A patch to resolve this has been provided by Zbigniew
Jędrzejewski-Szmek, along with an additional patch to implement a test.
Both of these are attached.

Many thanks,
Chris

View attachment "[0001-test-resolved-packet-add-a-simple-test-for-our-alloc.patch](8/1)" of type "text/x-patch" (3748 bytes)

View attachment "[0002-resolved-simplify-alloc-size-calculation.patch](8/2)" of type "text/x-patch" (1828 bytes)

Download attachment "[signature.asc](8/3)" of type "application/pgp-signature" (456 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


