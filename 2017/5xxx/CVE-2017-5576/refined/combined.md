=== Content from github.com_b72282bd_20250124_150235.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F0f2ff82e11c86c05d051cae32b58226392d33bbf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F0f2ff82e11c86c05d051cae32b58226392d33bbf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/0f2ff82e11c86c05d051cae32b58226392d33bbf)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

drm/vc4: Fix an integer overflow in temporary allocation layout.

[Browse files](/torvalds/linux/tree/0f2ff82e11c86c05d051cae32b58226392d33bbf)
Browse the repository at this point in the history

```
We copy the unvalidated ioctl arguments from the user into kernel
temporary memory to run the validation from, to avoid a race where the
user updates the unvalidate contents in between validating them and
copying them into the validated BO.

However, in setting up the layout of the kernel side, we failed to
check one of the additions (the roundup() for shader_rec_offset)
against integer overflow, allowing a nearly MAX_UINT value of
bin_cl_size to cause us to under-allocate the temporary space that we
then copy_from_user into.

Reported-by: Murray McAllister <murray.mcallister@insomniasec.com>
Signed-off-by: Eric Anholt <eric@anholt.net>
Fixes: [d5b1a78](https://github.com/torvalds/linux/commit/d5b1a78a772f1e31a94f8babfa964152ec5e9aa5) ("drm/vc4: Add support for drawing 3D frames.")
```

* Loading branch information

[![@anholt](https://avatars.githubusercontent.com/u/3431811?s=40&v=4)](/anholt)

[anholt](/torvalds/linux/commits?author=anholt "View all commits by anholt")
committed
Jan 17, 2017

1 parent
[21ccc32](/torvalds/linux/commit/21ccc32496b2f63228f5232b3ac0e426e8fb3c31)

commit 0f2ff82

Showing
**1 changed file**
with
**2 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[drivers/gpu/drm/vc4/vc4\_gem.c](#diff-fb6a866f2c3582d410024b48b2a9989554cc8b0afd49ffe3909dd513153538f3 "drivers/gpu/drm/vc4/vc4_gem.c")

Show comments

[View file](/torvalds/linux/blob/0f2ff82e11c86c05d051cae32b58226392d33bbf/drivers/gpu/drm/vc4/vc4_gem.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -594,7 +594,8 @@ vc4\_get\_bcl(struct drm\_device \*dev, struct vc4\_exec\_info \*exec) |
|  |  | args->shader\_rec\_count); |
|  |  | struct vc4\_bo \*bo; |
|  |  |  |
|  |  | if (uniforms\_offset < shader\_rec\_offset || |
|  |  | if (shader\_rec\_offset < args->bin\_cl\_size || |
|  |  | uniforms\_offset < shader\_rec\_offset || |
|  |  | exec\_size < uniforms\_offset || |
|  |  | args->shader\_rec\_count >= (UINT\_MAX / |
|  |  | sizeof(struct vc4\_shader\_state)) || |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0f2ff82`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F0f2ff82e11c86c05d051cae32b58226392d33bbf) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from access.redhat.com_3b74c5a5_20250126_014755.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.openwall.com_33a6e34e_20250124_150233.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](6) [[next>]](../../../2017/01/22/1) [[thread-next>]](../../../2017/01/24/3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <f7ba24cc-1b0e-7ea8-fd2d-d062c817d55d@insomniasec.com>
Date: Sun, 22 Jan 2017 10:26:36 +1300
From: Murray McAllister <murray.mcallister@...omniasec.com>
To: oss-security@...ts.openwall.com
Subject: CVE request: Linux kernel: vc4: int overflow leading to heap-based
 buffer overflow

Hi,

This issue affects the VC4_SUBMIT_CL IOCTL in the VideoCore DRM driver,
so probably only affects devices like the Raspberry Pi.

Quoting from Eric Anholt's post:

""
We copy the unvalidated ioctl arguments from the user into kernel
temporary memory to run the validation from, to avoid a race where the
user updates the unvalidate contents in between validating them and
copying them into the validated BO.

However, in setting up the layout of the kernel side, we failed to
check one of the additions (the roundup() for shader_rec_offset)
against integer overflow, allowing a nearly MAX_UINT value of
bin_cl_size to cause us to under-allocate the temporary space that we
then copy_from_user into.
""

<https://lkml.org/lkml/2017/1/17/761>
<https://lkml.org/lkml/2017/1/17/759> (discovered by Ingo Molnar)

I am not subscribed to the list so please mail me if you have any issues.

Chur

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from git.kernel.org_510f4946_20250124_150232.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Anholt <eric@anholt.net> | 2017-01-17 21:42:53 +1100 |
| --- | --- | --- |
| committer | Eric Anholt <eric@anholt.net> | 2017-01-17 22:05:55 +1100 |
| commit | [0f2ff82e11c86c05d051cae32b58226392d33bbf](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)) | |
| tree | [a902de69d6b8d2aacae17a8549bffe959037d0e2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf) | |
| parent | [21ccc32496b2f63228f5232b3ac0e426e8fb3c31](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=21ccc32496b2f63228f5232b3ac0e426e8fb3c31) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf&id2=21ccc32496b2f63228f5232b3ac0e426e8fb3c31)) | |
| download | [linux-0f2ff82e11c86c05d051cae32b58226392d33bbf.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-0f2ff82e11c86c05d051cae32b58226392d33bbf.tar.gz) | |

drm/vc4: Fix an integer overflow in temporary allocation layout.We copy the unvalidated ioctl arguments from the user into kernel
temporary memory to run the validation from, to avoid a race where the
user updates the unvalidate contents in between validating them and
copying them into the validated BO.
However, in setting up the layout of the kernel side, we failed to
check one of the additions (the roundup() for shader\_rec\_offset)
against integer overflow, allowing a nearly MAX\_UINT value of
bin\_cl\_size to cause us to under-allocate the temporary space that we
then copy\_from\_user into.
Reported-by: Murray McAllister <murray.mcallister@insomniasec.com>
Signed-off-by: Eric Anholt <eric@anholt.net>
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_gem.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/gpu/drm/vc4/vc4_gem.c?id=0f2ff82e11c86c05d051cae32b58226392d33bbf) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_gem.c b/drivers/gpu/drm/vc4/vc4\_gem.cindex db920771bfb564..c5fe3554858e51 100644--- a/[drivers/gpu/drm/vc4/vc4\_gem.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/gpu/drm/vc4/vc4_gem.c?id=21ccc32496b2f63228f5232b3ac0e426e8fb3c31)+++ b/[drivers/gpu/drm/vc4/vc4\_gem.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/gpu/drm/vc4/vc4_gem.c?id=0f2ff82e11c86c05d051cae32b58226392d33bbf)@@ -594,7 +594,8 @@ vc4\_get\_bcl(struct drm\_device \*dev, struct vc4\_exec\_info \*exec) args->shader\_rec\_count); struct vc4\_bo \*bo; - if (uniforms\_offset < shader\_rec\_offset ||+ if (shader\_rec\_offset < args->bin\_cl\_size ||+ uniforms\_offset < shader\_rec\_offset || exec\_size < uniforms\_offset || args->shader\_rec\_count >= (UINT\_MAX / sizeof(struct vc4\_shader\_state)) || |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-24 15:01:09 +0000



=== Content from bugzilla.redhat.com_a4889a9b_20250124_150234.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1416436)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1416436)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1416436)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1416436

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1416436**](show_bug.cgi?id=1416436)
(CVE-2017-5576)
- [CVE-2017-5576](https://access.redhat.com/security/cve/CVE-2017-5576) kernel: vc4: Integer overflow in temporary allocation layout

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2017-5576 kernel: vc4: Integer overflow in temporary allocation layout

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED NOTABUG | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2017-5576 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | low | | [Severity:](page.cgi?id=fields.html#bug_severity) | low | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1416439](show_bug.cgi?id=1416439 "CLOSED ERRATA - CVE-2017-5576 CVE-2017-5577 kernel: various flaws [fedora-all]") [1420048](show_bug.cgi?id=1420048) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1416438](show_bug.cgi?id=1416438) | | TreeView+ | [depends on](buglist.cgi?bug_id=1416436&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1416436&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2017-01-25 13:33 UTC by Andrej Nemec | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-02-17 02:42 UTC ([History](show_activity.cgi?id=1416436)) | | [CC List:](page.cgi?id=fields.html#cclist) | 34 users (show)  agordeev aquini bhu dhoward esammons fhrbata gansalmon iboverma ichavero itamar jforbes jkacur jkastner jonathan jross jwboyer kernel-maint kernel-mgr labbott lgoncalv lwang madhu.chinakonda matt mchehab mcressma mguzik nmurray pholasek plougher rt-maint rvrbovsk slawomir vdronov williams | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: | Integer overflow in the vc4\_get\_bcl function in drivers/gpu/drm/vc4/vc4\_gem.c in the VideoCore DRM driver in the Linux kernel before 4.9.7 allows local users to cause a denial of service or possibly have unspecified other impact via a crafted size value in a VC4\_SUBMIT\_CL ioctl call. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2017-02-07 16:40:39 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1416436#c0)  Andrej Nemec    2017-01-25 13:33:12 UTC  ``` Integer overflow in the vc4_get_bcl function in drivers/gpu/drm/vc4/vc4_gem.c in the VideoCore DRM driver in the Linux kernel before 4.9.7 allows local users to cause a denial of service or possibly have unspecified other impact via a crafted size value in a VC4_SUBMIT_CL ioctl call.  References:  <http://seclists.org/oss-sec/2017/q1/165>  Upstream patch:  <https://lkml.org/lkml/2017/1/17/761>  <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=0f2ff82e11c86c05d051cae32b58226392d33bbf>   ```  [Comment 1](show_bug.cgi?id=1416436#c1)  Andrej Nemec    2017-01-25 13:38:59 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1416439](show_bug.cgi?id=1416439 "CLOSED ERRATA - CVE-2017-5576 CVE-2017-5577 kernel: various flaws [fedora-all]")]   ```  [Comment 5](show_bug.cgi?id=1416436#c5)  Vladis Dronov    2017-02-07 16:40:39 UTC  ``` Statement:  This issue does not affect the Linux kernel packages as shipped with Red Hat Enterprise Linux 5, 6, 7 and MRG-2 as the code with the flaw is not present in the products listed.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1416436&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from lkml.org_049e5292_20250124_150240.html ===


| [lkml.org](/) | Â | [[lkml]](/lkml) Â  [[2017]](/lkml/2017) Â  [[Jan]](/lkml/2017/1) Â  [[17]](/lkml/2017/1/17) Â  [[last100]](/lkml/last100) Â  [RSS Feed](/rss.php)Views: [wrap][no wrap] Â  [[headers]](/lkml/mheaders/2017/1/17/761)Â  [[forward]](/lkml/bounce/2017/1/17/761)Â | Â |
| --- | --- | --- | --- |
| Messages in this thread  * [First message in thread](/lkml/2017/1/17/761) * [Eric Anholt](/lkml/2017/1/17/759)   + [Eric Anholt](/lkml/2017/1/17/759)  Patch in this message  * [Get diff 1](/lkml/diff/2017/1/17/761/1) | / | | | From | Eric Anholt <> | | --- | --- | | Subject | [PATCH 1/2] drm/vc4: Fix an integer overflow in temporary allocation layout. | | Date | Wed, 18 Jan 2017 07:20:49 +1100 | |  | | --- | --- | --- | --- | --- | --- | --- | --- |  ``` We copy the unvalidated ioctl arguments from the user into kerneltemporary memory to run the validation from, to avoid a race where theuser updates the unvalidate contents in between validating them andcopying them into the validated BO.However, in setting up the layout of the kernel side, we failed tocheck one of the additions (the roundup() for shader_rec_offset)against integer overflow, allowing a nearly MAX_UINT value ofbin_cl_size to cause us to under-allocate the temporary space that wethen copy_from_user into.Reported-by: Murray McAllister <murray.mcallister@insomniasec.com>Signed-off-by: Eric Anholt <eric@anholt.net>Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")--- drivers/gpu/drm/vc4/vc4_gem.c | 3 ++- 1 file changed, 2 insertions(+), 1 deletion(-)diff --git a/drivers/gpu/drm/vc4/vc4_gem.c b/drivers/gpu/drm/vc4/vc4_gem.cindex db920771bfb5..c5fe3554858e 100644--- a/drivers/gpu/drm/vc4/vc4_gem.c+++ b/drivers/gpu/drm/vc4/vc4_gem.c@@ -594,7 +594,8 @@ vc4_get_bcl(struct drm_device *dev, struct vc4_exec_info *exec) 					  args->shader_rec_count); 	struct vc4_bo *bo; -	if (uniforms_offset < shader_rec_offset ||+	if (shader_rec_offset < args->bin_cl_size ||+	    uniforms_offset < shader_rec_offset || 	    exec_size < uniforms_offset || 	    args->shader_rec_count >= (UINT_MAX / 					  sizeof(struct vc4_shader_state)) ||-- 2.11.0 ``` | \ |
| Â |
| Â | \ | Â | / |
| Â | | Last update: 2017-01-17 21:30 Â Â  [from the cache]Â©2003-2020 [Jasper Spaans](http://blog.jasper.es/)|hosted at [Digital Ocean](https://www.digitalocean.com/?refcode=9a8e99d24cf9) and my Meterkast|[Read the blog](http://blog.jasper.es/categories.html#lkml-ref) | Â |



=== Content from www.kernel.org_e313b094_20250124_150233.html ===
commit fd2ffe57dda03cb070204f53864ecdfd002aa2e3
Author: Greg Kroah-Hartman
Date: Wed Feb 1 08:33:31 2017 +0100
Linux 4.9.7
commit b59dd202f231431c256b56de129e979d9563612f
Author: Francisco Jerez
Date: Thu Jan 12 12:44:54 2017 +0200
drm/i915: Remove WaDisableLSQCROPERFforOCL KBL workaround.
commit 4fc020d864647ea3ae8cb8f17d63e48e87ebd0bf upstream.
The WaDisableLSQCROPERFforOCL workaround has the side effect of
disabling an L3SQ optimization that has huge performance implications
and is unlikely to be necessary for the correct functioning of usual
graphic workloads. Userspace is free to re-enable the workaround on
demand, and is generally in a better position to determine whether the
workaround is necessary than the DRM is (e.g. only during the
execution of compute kernels that rely on both L3 fences and HDC R/W
requests).
The same workaround seems to apply to BDW (at least to production
stepping G1) and SKL as well (the internal workaround database claims
that it does for all steppings, while the BSpec workaround table only
mentions pre-production steppings), but the DRM doesn't do anything
beyond whitelisting the L3SQCREG4 register so userspace can enable it
when it sees fit. Do the same on KBL platforms.
Improves performance of the GFXBench4 gl\_manhattan31 benchmark by 60%,
and gl\_4 (AKA car chase) by 14% on a KBL GT2 running Mesa master --
This is followed by a regression of 35% and 10% respectively for the
same benchmarks and platform caused by my recent patch series
switching userspace to use the dataport constant cache instead of the
sampler to implement uniform pull constant loads, which caused us to
hit more heavily the L3 cache (and on platforms other than KBL had the
opposite effect of improving performance of the same two benchmarks).
The overall effect on KBL of this change combined with the recent
userspace change is respectively 4.6% and 2.6%. SynMark2 OglShMapPcf
was affected by the constant cache changes (though it improved as it
did on other platforms rather than regressing), but is not
significantly affected by this patch (with statistical significance of
5% and sample size 20).
v2: Drop some more code to avoid unused variable warning.
Fixes: 738fa1b3123f ("drm/i915/kbl: Add WaDisableLSQCROPERFforOCL")
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=99256
Signed-off-by: Francisco Jerez
Cc: Matthew Auld
Cc: Eero Tamminen
Cc: Jani Nikula
Cc: Mika Kuoppala
Cc: beignet@lists.freedesktop.org
Reviewed-by: Mika Kuoppala
[Removed double Fixes tag]
Signed-off-by: Mika Kuoppala
Link: http://patchwork.freedesktop.org/patch/msgid/1484217894-20505-1-git-send-email-mika.kuoppala@intel.com
(cherry picked from commit 8726f2faa371514fba2f594d799db95203dfeee0)
Signed-off-by: Jani Nikula
[ Francisco Jerez: Rebase on v4.9 branch. ]
Signed-off-by: Francisco Jerez
Signed-off-by: Greg Kroah-Hartman
commit 922813f4d66fb317e8602d058d03a1619af1ffd0
Author: Peter Zijlstra
Date: Wed Jan 11 21:09:50 2017 +0100
perf/core: Fix concurrent sys\_perf\_event\_open() vs. 'move\_group' race
commit 321027c1fe77f892f4ea07846aeae08cefbbb290 upstream.
Di Shen reported a race between two concurrent sys\_perf\_event\_open()
calls where both try and move the same pre-existing software group
into a hardware context.
The problem is exactly that described in commit:
f63a8daa5812 ("perf: Fix event->ctx locking")
... where, while we wait for a ctx->mutex acquisition, the event->ctx
relation can have changed under us.
That very same commit failed to recognise sys\_perf\_event\_context() as an
external access vector to the events and thereby didn't apply the
established locking rules correctly.
So while one sys\_perf\_event\_open() call is stuck waiting on
mutex\_lock\_double(), the other (which owns said locks) moves the group
about. So by the time the former sys\_perf\_event\_open() acquires the
locks, the context we've acquired is stale (and possibly dead).
Apply the established locking rules as per perf\_event\_ctx\_lock\_nested()
to the mutex\_lock\_double() for the 'move\_group' case. This obviously means
we need to validate state after we acquire the locks.
Reported-by: Di Shen (Keen Lab)
Tested-by: John Dias
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Kees Cook
Cc: Linus Torvalds
Cc: Min Chong
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Fixes: f63a8daa5812 ("perf: Fix event->ctx locking")
Link: http://lkml.kernel.org/r/20170106131444.GZ3174@twins.programming.kicks-ass.net
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit f5f415c13209c5a7a71da85462815288321483df
Author: David Rientjes
Date: Tue Jan 24 15:18:10 2017 -0800
mm, memcg: do not retry precharge charges
commit 3674534b775354516e5c148ea48f51d4d1909a78 upstream.
When memory.move\_charge\_at\_immigrate is enabled and precharges are
depleted during move, mem\_cgroup\_move\_charge\_pte\_range() will attempt to
increase the size of the precharge.
Prevent precharges from ever looping by setting \_\_GFP\_NORETRY. This was
probably the intention of the GFP\_KERNEL & ~\_\_GFP\_NORETRY, which is
pointless as written.
Fixes: 0029e19ebf84 ("mm: memcontrol: remove explicit OOM parameter in charge path")
Link: http://lkml.kernel.org/r/alpine.DEB.2.10.1701130208510.69402@chino.kir.corp.google.com
Signed-off-by: David Rientjes
Acked-by: Michal Hocko
Cc: Johannes Weiner
Cc: Vladimir Davydov
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 98185d4b18a14dad0b95efd85225960b5435727d
Author: Andy Shevchenko
Date: Thu Jan 19 18:39:40 2017 +0200
platform/x86: intel\_mid\_powerbtn: Set IRQ\_ONESHOT
commit 5a00b6c2438460b870a451f14593fc40d3c7edf6 upstream.
The commit 1c6c69525b40 ("genirq: Reject bogus threaded irq requests")
starts refusing misconfigured interrupt handlers. This makes
intel\_mid\_powerbtn not working anymore.
Add a mandatory flag to a threaded IRQ request in the driver.
Fixes: 1c6c69525b40 ("genirq: Reject bogus threaded irq requests")
Signed-off-by: Andy Shevchenko
Signed-off-by: Greg Kroah-Hartman
commit adb260d15134f3aabd6e1bf39ee7f4ea28385c2d
Author: Dan Carpenter
Date: Sat Jan 7 09:33:34 2017 +0300
platform/x86: mlx-platform: free first dev on error
commit 63d762b88cb5510f2bfdb5112ced18cde867ae61 upstream.
There is an off-by-one error so we don't unregister priv->pdev\_mux[0].
Also it's slightly simpler as a while loop instead of a for loop.
Fixes: 58cbbee2391c ("x86/platform/mellanox: Introduce support for Mellanox systems platform")
Signed-off-by: Dan Carpenter
Acked-by: Vadim Pasternak
Signed-off-by: Andy Shevchenko
Signed-off-by: Greg Kroah-Hartman
commit 776050a9b55e17b72b5684794b9580d72e920e17
Author: Robin Murphy
Date: Tue Jan 10 17:51:17 2017 +0000
virtio\_mmio: Set DMA masks appropriately
commit f7f6634d23830ff74335734fbdb28ea109c1f349 upstream.
Once DMA API usage is enabled, it becomes apparent that virtio-mmio is
inadvertently relying on the default 32-bit DMA mask, which leads to
problems like rapidly exhausting SWIOTLB bounce buffers.
Ensure that we set the appropriate 64-bit DMA mask whenever possible,
with the coherent mask suitably limited for the legacy vring as per
a0be1db4304f ("virtio\_pci: Limit DMA mask to 44 bits for legacy virtio
devices").
Cc: Andy Lutomirski
Cc: Michael S. Tsirkin
Reported-by: Jean-Philippe Brucker
Fixes: b42111382f0e ("virtio\_mmio: Use the DMA API if enabled")
Signed-off-by: Robin Murphy
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Greg Kroah-Hartman
commit 143a9ad4e68cc5c210e6e99e910d6b77cc8a9ec5
Author: Yasuaki Ishimatsu
Date: Tue Jan 24 15:17:45 2017 -0800
memory\_hotplug: make zone\_can\_shift() return a boolean value
commit 8a1f780e7f28c7c1d640118242cf68d528c456cd upstream.
online\_{kernel|movable} is used to change the memory zone to
ZONE\_{NORMAL|MOVABLE} and online the memory.
To check that memory zone can be changed, zone\_can\_shift() is used.
Currently the function returns minus integer value, plus integer
value and 0. When the function returns minus or plus integer value,
it means that the memory zone can be changed to ZONE\_{NORNAL|MOVABLE}.
But when the function returns 0, there are two meanings.
One of the meanings is that the memory zone does not need to be changed.
For example, when memory is in ZONE\_NORMAL and onlined by online\_kernel
the memory zone does not need to be changed.
Another meaning is that the memory zone cannot be changed. When memory
is in ZONE\_NORMAL and onlined by online\_movable, the memory zone may
not be changed to ZONE\_MOVALBE due to memory online limitation(see
Documentation/memory-hotplug.txt). In this case, memory must not be
onlined.
The patch changes the return type of zone\_can\_shift() so that memory
online operation fails when memory zone cannot be changed as follows:
Before applying patch:
# grep -A 35 "Node 2" /proc/zoneinfo
Node 2, zone Normal
node\_scanned 0
spanned 8388608
present 7864320
managed 7864320
# echo online\_movable > memory4097/state
# grep -A 35 "Node 2" /proc/zoneinfo
Node 2, zone Normal
node\_scanned 0
spanned 8388608
present 8388608
managed 8388608
online\_movable operation succeeded. But memory is onlined as
ZONE\_NORMAL, not ZONE\_MOVABLE.
After applying patch:
# grep -A 35 "Node 2" /proc/zoneinfo
Node 2, zone Normal
node\_scanned 0
spanned 8388608
present 7864320
managed 7864320
# echo online\_movable > memory4097/state
bash: echo: write error: Invalid argument
# grep -A 35 "Node 2" /proc/zoneinfo
Node 2, zone Normal
node\_scanned 0
spanned 8388608
present 7864320
managed 7864320
online\_movable operation failed because of failure of changing
the memory zone from ZONE\_NORMAL to ZONE\_MOVABLE
Fixes: df429ac03936 ("memory-hotplug: more general validation of zone during online")
Link: http://lkml.kernel.org/r/2f9c3837-33d7-b6e5-59c0-6ca4372b2d84@gmail.com
Signed-off-by: Yasuaki Ishimatsu
Reviewed-by: Reza Arbab
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit da1fdb8456ac79533aa09ce61b99a84ac7ca57b9
Author: Andy Shevchenko
Date: Tue Jan 10 16:38:52 2017 +0200
pinctrl: baytrail: Rectify debounce support
commit 04ff5a095d662e0879f0eb04b9247e092210aeff upstream.
The commit 658b476c742f ("pinctrl: baytrail: Add debounce configuration")
implements debounce for Baytrail pin control, but seems wasn't tested properly.
The register which keeps debounce value is separated from the configuration
one. Writing wrong values to the latter will guarantee wrong behaviour of the
driver and even might break something physically.
Besides above there is missed case how to disable it, which is actually done
through the bit in configuration register.
Rectify implementation here by using proper register for debounce value.
Fixes: 658b476c742f ("pinctrl: baytrail: Add debounce configuration")
Cc: Cristina Ciocan
Signed-off-by: Andy Shevchenko
Acked-by: Mika Westerberg
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 583eded5860b84344d91462796cc5e5d40bbc27b
Author: Masahiro Yamada
Date: Tue Jan 17 19:52:54 2017 +0900
pinctrl: uniphier: fix Ethernet (RMII) pin-mux setting for LD20
commit df1539c25cce98e2ac69881958850c6535240707 upstream.
Fix the pin-mux values for the MDC, MDIO, MDIO\_INTL, PHYRSTL pins.
Fixes: 1e359ab1285e ("pinctrl: uniphier: add Ethernet pin-mux settings")
Signed-off-by: Masahiro Yamada
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 35948ae694c0d6aceda6d41ca1b624206f702da1
Author: Mika Westerberg
Date: Tue Jan 10 17:31:56 2017 +0300
pinctrl: broxton: Use correct PADCFGLOCK offset
commit ecc8995363ee6231b32dad61c955b371b79cc4cf upstream.
PADCFGLOCK (and PADCFGLOCK\_TX) offset in Broxton actually starts at 0x060
and not 0x090 as used in the driver. Fix it to use the correct offset.
Signed-off-by: Mika Westerberg
Reviewed-by: Andy Shevchenko
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 668a827a6c9daa88efb4464144a6bd7b2146c66c
Author: Arnd Bergmann
Date: Fri Dec 9 09:41:29 2016 -0200
s5k4ecgx: select CRC32 helper
commit c739c0a7c3c2472d7562b8f802cdce44d2597c8b upstream.
A rare randconfig build failure shows up in this driver when
the CRC32 helper is not there:
drivers/media/built-in.o: In function `s5k4ecgx\_s\_power':
s5k4ecgx.c:(.text+0x9eb4): undefined reference to `crc32\_le'
This adds the 'select' that all other users of this function have.
Fixes: 8b99312b7214 ("[media] Add v4l2 subdev driver for S5K4ECGX sensor")
Signed-off-by: Arnd Bergmann
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 9a335996bfcfce1fd7fe7549fb1a679489774b99
Author: Yonatan Cohen
Date: Thu Jan 19 15:25:59 2017 +0200
IB/rxe: Prevent from completer to operate on non valid QP
commit 2d4b21e0a2913612274a69a3ba1bfee4cffc6e77 upstream.
On UD QP completer tasklet is scheduled for each packet sent.
If it is followed by a destroy\_qp(), the kernel panic will
happen as the completer tries to operate on a destroyed QP.
Fixes: 8700e3e7c485 ("Soft RoCE driver")
Signed-off-by: Yonatan Cohen
Reviewed-by: Moni Shoua
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit fed1e89a16e3684e1bd218e1d6a78f83b5ceb865
Author: Maor Gottlieb
Date: Thu Jan 19 15:25:58 2017 +0200
IB/rxe: Fix rxe dev insertion to rxe\_dev\_list
commit f39f775218a7520e3700de2003c84a042c3b5972 upstream.
The first argument of list\_add\_tail is the new item and the second
is the head of the list. Fix the code to pass arguments in the
right order, otherwise not all the rxe devices will be removed
during teardown.
Fixes: 8700e3e7c4857 ('Soft RoCE driver')
Signed-off-by: Maor Gottlieb
Reviewed-by: Moni Shoua
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit c81ee4ed9c0d49514254487eb037548dd5e25ef8
Author: Kenneth Lee
Date: Thu Jan 5 15:00:05 2017 +0800
IB/umem: Release pid in error and ODP flow
commit 828f6fa65ce7e80f77f5ab12942e44eb3d9d174e upstream.
1. Release pid before enter odp flow
2. Release pid when fail to allocate memory
Fixes: 87773dd56d54 ("IB: ib\_umem\_release() should decrement mm->pinned\_vm from ib\_umem\_get")
Fixes: 8ada2c1c0c1d ("IB/core: Add support for on demand paging regions")
Signed-off-by: Kenneth Lee
Reviewed-by: Haggai Eran
Reviewed-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit d7c3d7e453b70e9e9e81d8409e5f8c004597ec05
Author: Ander Conselvan de Oliveira
Date: Fri Jan 20 16:28:45 2017 +0200
drm/i915: Check for NULL atomic state in intel\_crtc\_disable\_noatomic()
commit 6d1d427a4e24c403b4adf928d61994bdaa0ca03a upstream.
In intel\_crtc\_disable\_noatomic(), bail on a failure to allocate an
atomic state to avoid a NULL pointer dereference.
Fixes: 4a80655827af ("drm/i915: Pass atomic state to crtc enable/disable functions")
Cc: Maarten Lankhorst
Cc: Daniel Vetter
Cc: Daniel Vetter
Cc: Jani Nikula
Cc: intel-gfx@lists.freedesktop.org
Signed-off-by: Ander Conselvan de Oliveira
Reviewed-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/1484922525-6131-4-git-send-email-ander.conselvan.de.oliveira@intel.com
(cherry picked from commit 31bb2ef97ea9db343348f9b5ccaa9bb6f48fc655)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 181478cdb75eb4d9865064b15cb93418c72759f2
Author: Ander Conselvan de Oliveira
Date: Fri Jan 20 16:28:44 2017 +0200
drm/i915: Fix calculation of rotated x and y offsets for planar formats
commit 3781bd6e7d64d5f5bea9fdee11ab9460a700c0e4 upstream.
Parameters tile\_size, tile\_width and tile\_height were passed in the
wrong order to \_intel\_adjust\_tile\_offset() when calculating the rotated
offsets.
This doesn't fix any user visible bug, since for packed formats new
and old offset are the same and the rotated offsets are within a tile
before they are fed to \_intel\_adjust\_tile\_offset(). In that case, the
offsets are unchanged. That is not true for planar formats, but those
are currently not supported.
Fixes: 66a2d927cb0e ("drm/i915: Make intel\_adjust\_tile\_offset() work for linear buffers")
Cc: Ville Syrjälä
Cc: Sivakumar Thulasimani
Cc: Daniel Vetter
Cc: Jani Nikula
Cc: intel-gfx@lists.freedesktop.org
Signed-off-by: Ander Conselvan de Oliveira
Reviewed-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/1484922525-6131-3-git-send-email-ander.conselvan.de.oliveira@intel.com
(cherry picked from commit 46a1bd289507dfcc428fb9daf65421ed6be6af8b)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit ff4956555513d0ad0088866c748a30bf10a61019
Author: Ander Conselvan de Oliveira
Date: Fri Jan 20 16:28:43 2017 +0200
drm/i915: Don't init hpd polling for vlv and chv from runtime\_suspend()
commit 21d6e0bde50713922a6520ef84e5fd245b05d468 upstream.
An error in the condition for avoiding the call to intel\_hpd\_poll\_init()
for valleyview and cherryview from intel\_runtime\_suspend() caused it to
be called unconditionally. Fix it.
Fixes: 19625e85c6ec ("drm/i915: Enable polling when we don't have hpd")
Cc: Ville Syrjälä
Cc: Daniel Vetter
Cc: Lyude
Cc: Daniel Vetter
Cc: Jani Nikula
Cc: intel-gfx@lists.freedesktop.org
Signed-off-by: Ander Conselvan de Oliveira
Reviewed-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/1484922525-6131-2-git-send-email-ander.conselvan.de.oliveira@intel.com
(cherry picked from commit 04313b00b79405f86d815100f85c47a2ee5b8ca0)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 8d7c76ae613ed9efd4548e85b894794a562dada4
Author: Ander Conselvan de Oliveira
Date: Fri Jan 20 16:28:42 2017 +0200
drm/i915: Don't leak edid in intel\_crt\_detect\_ddc()
commit c34f078675f505c4437919bb1897b1351f16a050 upstream.
In the path where intel\_crt\_detect\_ddc() detects a CRT, if would return
true without freeing the edid.
Fixes: a2bd1f541f19 ("drm/i915: check whether we actually received an edid in detect\_ddc")
Cc: Chris Wilson
Cc: Daniel Vetter
Cc: Daniel Vetter
Cc: Jani Nikula
Cc: intel-gfx@lists.freedesktop.org
Signed-off-by: Ander Conselvan de Oliveira
Reviewed-by: Ville Syrjälä
Reviewed-by: Jani Nikula
Link: http://patchwork.freedesktop.org/patch/msgid/1484922525-6131-1-git-send-email-ander.conselvan.de.oliveira@intel.com
(cherry picked from commit c96b63a6a7ac4bd670ec2e663793a9a31418b790)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 2cff678d0bb506595f7ca765c6e3b3ff0130f7a9
Author: Clint Taylor
Date: Wed Jan 18 13:38:43 2017 -0800
drm/i915: prevent crash with .disable\_display parameter
commit 27892bbdc9233f33bf0f44e08aab8f12e0dec142 upstream.
The .disable\_display parameter was causing a fatal crash when fbdev
was dereferenced during driver init.
V1: protection in i915\_drv.c
V2: Moved protection to intel\_fbdev.c
Fixes: 43cee314345a ("drm/i915/fbdev: Limit the global async-domain synchronization")
Testcase: igt/drv\_module\_reload/basic-no-display
Cc: Chris Wilson
Signed-off-by: Clint Taylor
Link: http://patchwork.freedesktop.org/patch/msgid/1484775523-29428-1-git-send-email-clinton.a.taylor@intel.com
Reviewed-by: Chris Wilson
Cc: Lukas Wunner
Cc: Daniel Vetter
Cc: Jani Nikula
Signed-off-by: Chris Wilson
(cherry picked from commit 5b8cd0755f8a06a851c436a013e7be0823fb155a)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 9913aca2d5879a474f4ecb07c081ef1d0f7b3cf0
Author: Chris Wilson
Date: Thu Jan 5 15:59:40 2017 +0000
drm/i915: Clear ret before unbinding in i915\_gem\_evict\_something()
commit e88893fea17996018b2d68a22e677ea04f3baadf upstream.
Missed when rebasing patches, I failed to set ret to zero before
starting the unbind loop (which depends upon ret being zero).
Reported-by: Matthew Auld
Fixes: 9332f3b1b99a ("drm/i915: Combine loops within i915\_gem\_evict\_something")
Signed-off-by: Chris Wilson
Cc: Matthew Auld
Link: http://patchwork.freedesktop.org/patch/msgid/20170105155940.10033-1-chris@chris-wilson.co.uk
Reviewed-by: Matthew Auld
(cherry picked from commit 121dfbb2a2ef1c5f49e15c38ccc47ff0beb59446)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 1b8ff91ae545d36337de459c7195f6f369dc776d
Author: Laurent Pinchart
Date: Fri Dec 9 09:47:19 2016 -0200
v4l: tvp5150: Don't override output pinmuxing at stream on/off time
commit 79d6205a3f741c9fb89cfc47dfa0eddb1526726d upstream.
The s\_stream() handler incorrectly writes the whole MISC\_CTL register to
enable or disable the outputs, overriding the output pinmuxing
configuration. Fix it to only touch the output enable bits.
The CONF\_SHARED\_PIN register is also written by the same function,
resulting in muxing the INTREQ signal instead of the VBLK/GPCL signal on
the INTREQ/GPCL/VBLK pin. As the driver doesn't support interrupts this
is obviously incorrect, and breaks operation on other devices. Fix it by
removing the write.
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 11e5015ae1d12473f12baa1e8cc66849be019c3a
Author: Laurent Pinchart
Date: Fri Dec 9 09:47:18 2016 -0200
v4l: tvp5150: Fix comment regarding output pin muxing
commit b4b2de386bbb6589d81596999d4a924928dc119b upstream.
The FID/GLCO/VLK/HVLK and INTREQ/GPCL/VBLK pins are muxed differently
depending on whether the input is an S-Video or composite signal. The
comment that explains the logic doesn't reflect the code. It appears
that the comment is incorrect, as disabling the output data bus in
composite mode makes no sense. Update the comment to match the code.
While at it define macros for the MISC\_CTL register bits, the code is
too confusing with numerical values.
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit d25f9bfeb62f812e8aa7eded53df8155bff25ee5
Author: Laurent Pinchart
Date: Fri Dec 9 09:47:17 2016 -0200
v4l: tvp5150: Reset device at probe time, not in get/set format handlers
commit aff808e813fc2d311137754165cf53d4ee6ddcc2 upstream.
The tvp5150 doesn't support format setting through the subdev pad API
and thus implements the set format handler as a get format operation.
The single handler, tvp5150\_fill\_fmt(), resets the device by calling
tvp5150\_reset(). This causes malfunction as the device can be reset at
will, possibly from userspace when the subdev userspace API is enabled.
The reset call was added in commit ec2c4f3f93cb ("[media] media:
tvp5150: Add mbus\_fmt callbacks"), probably as an attempt to set the
device to a known state before detecting the current TV standard.
However, the get format handler doesn't access the hardware to get the
TV standard since commit 963ddc63e20d ("[media] media: tvp5150: Add
cropping support"). There is thus no need to reset the device when
getting the format.
However, removing the tvp5150\_reset() from the get/set format handlers
results in the function not being called at all if the bridge driver
doesn't use the .reset() operation. The operation is nowadays abused and
shouldn't be used, so shouldn't expect bridge drivers to call it. To
make sure the device is properly initialize, move the reset call from
the format handlers to the probe function.
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit fe6531075e1dd8a7784bf0450186be1380eafb86
Author: Max Kellermann
Date: Thu Dec 15 19:51:07 2016 -0200
pctv452e: move buffer to heap, no mutex
commit 48775cb73c2e26b7ca9d679875a6e570c8b8e124 upstream.
commit 73d5c5c864f4 ("[media] pctv452e: don't do DMA on stack") caused
a NULL pointer dereference which occurs when dvb\_usb\_init()
calls dvb\_usb\_device\_power\_ctrl() for the first time, before the
frontend has been attached. It also caused a recursive deadlock because
tt3650\_ci\_msg\_locked() has already locked the mutex.
So, partially revert it, but move the buffer to the heap
(DMA capable), not to the stack (may not be DMA capable).
Instead of sharing one buffer which needs mutex protection,
do a new heap allocation for each call.
Fixes: commit 73d5c5c864f4 ("[media] pctv452e: don't do DMA on stack")
Signed-off-by: Max Kellermann
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 0bd3cb8d470b7fdf0fbf677fcc19da915e740edc
Author: Steve Wise
Date: Thu Dec 22 07:40:36 2016 -0800
iw\_cxgb4: free EQ queue memory on last deref
commit c12a67fec8d99bb554e8d4e99120d418f1a39c87 upstream.
Commit ad61a4c7a9b7 ("iw\_cxgb4: don't block in destroy\_qp awaiting
the last deref") introduced a bug where the RDMA QP EQ queue memory
(and QIDs) are possibly freed before the underlying connection has been
fully shutdown. The result being a possible DMA read issued by HW after
the queue memory has been unmapped and freed. This results in possible
WR corruption in the worst case, system bus errors if an IOMMU is in use,
and SGE "bad WR" errors reported in the very least. The fix is to defer
unmap/free of queue memory and QID resources until the QP struct has
been fully dereferenced. To do this, the c4iw\_ucontext must also be kept
around until the last QP that references it is fully freed. In addition,
since the last QP deref can happen in an IRQ disabled context, we need
a new workqueue thread to do the final unmap/free of the EQ queue memory.
Fixes: ad61a4c7a9b7 ("iw\_cxgb4: don't block in destroy\_qp awaiting the last deref")
Signed-off-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit cb1d48f55a6dd1ad04caec1c140c2a136eb99206
Author: Kinglong Mee
Date: Fri Jan 20 16:48:39 2017 +0800
SUNRPC: cleanup ida information when removing sunrpc module
commit c929ea0b910355e1876c64431f3d5802f95b3d75 upstream.
After removing sunrpc module, I get many kmemleak information as,
unreferenced object 0xffff88003316b1e0 (size 544):
comm "gssproxy", pid 2148, jiffies 4294794465 (age 4200.081s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[] kmemleak\_alloc+0x4a/0xa0
[] kmem\_cache\_alloc+0x15e/0x1f0
[] ida\_pre\_get+0xaa/0x150
[] ida\_simple\_get+0xad/0x180
[] nlmsvc\_lookup\_host+0x4ab/0x7f0 [lockd]
[] lockd+0x4d/0x270 [lockd]
[] param\_set\_timeout+0x55/0x100 [lockd]
[] svc\_defer+0x114/0x3f0 [sunrpc]
[] svc\_defer+0x2d7/0x3f0 [sunrpc]
[] rpc\_show\_info+0x8a/0x110 [sunrpc]
[] proc\_reg\_write+0x7f/0xc0
[] \_\_vfs\_write+0xdf/0x3c0
[] vfs\_write+0xef/0x240
[] SyS\_write+0xad/0x130
[] entry\_SYSCALL\_64\_fastpath+0x1a/0xa9
[] 0xffffffffffffffff
I found, the ida information (dynamic memory) isn't cleanup.
Signed-off-by: Kinglong Mee
Fixes: 2f048db4680a ("SUNRPC: Add an identifier for struct rpc\_clnt")
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 5637949edb50c54b3074f76b648d7f873d8a6814
Author: Benjamin Coddington
Date: Tue Jan 24 11:34:20 2017 -0500
NFSv4.0: always send mode in SETATTR after EXCLUSIVE4
commit a430607b2ef7c3be090f88c71cfcb1b3988aa7c0 upstream.
Some nfsv4.0 servers may return a mode for the verifier following an open
with EXCLUSIVE4 createmode, but this does not mean the client should skip
setting the mode in the following SETATTR. It should only do that for
EXCLUSIVE4\_1 or UNGAURDED createmode.
Fixes: 5334c5bdac92 ("NFS: Send attributes in OPEN request for NFS4\_CREATE\_EXCLUSIVE4\_1")
Signed-off-by: Benjamin Coddington
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 0a7023506112ea7c634dffe08683d5d90f52eec6
Author: Trond Myklebust
Date: Mon Jan 23 22:44:12 2017 -0500
NFSv4.1: Fix a deadlock in layoutget
commit 8ac092519ad91931c96d306c4bfae2c6587c325f upstream.
We cannot call nfs4\_handle\_exception() without first ensuring that the
slot has been freed. If not, we end up deadlocking with the process
waiting for recovery to complete, and recovery waiting for the slot
table to drain.
Fixes: 2e80dbe7ac51 ("NFSv4.1: Close callback races for OPEN, LAYOUTGET...")
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 73fdda3b01cd76c6570a4146bfdc6703cfce73ee
Author: Chuck Lever
Date: Sun Jan 22 14:04:29 2017 -0500
nfs: Don't increment lock sequence ID after NFS4ERR\_MOVED
commit 059aa734824165507c65fd30a55ff000afd14983 upstream.
Xuan Qi reports that the Linux NFSv4 client failed to lock a file
that was migrated. The steps he observed on the wire:
1. The client sent a LOCK request to the source server
2. The source server replied NFS4ERR\_MOVED
3. The client switched to the destination server
4. The client sent the same LOCK request to the destination
server with a bumped lock sequence ID
5. The destination server rejected the LOCK request with
NFS4ERR\_BAD\_SEQID
RFC 3530 section 8.1.5 provides a list of NFS errors which do not
bump a lock sequence ID.
However, RFC 3530 is now obsoleted by RFC 7530. In RFC 7530 section
9.1.7, this list has been updated by the addition of NFS4ERR\_MOVED.
Reported-by: Xuan Qi
Signed-off-by: Chuck Lever
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 2b95f1210e5010feb767edefcfff53f2c611c1c5
Author: Helge Deller
Date: Sat Jan 28 11:52:02 2017 +0100
parisc: Don't use BITS\_PER\_LONG in userspace-exported swab.h header
commit 2ad5d52d42810bed95100a3d912679d8864421ec upstream.
In swab.h the "#if BITS\_PER\_LONG > 32" breaks compiling userspace programs if
BITS\_PER\_LONG is #defined by userspace with the sizeof() compiler builtin.
Solve this problem by using \_\_BITS\_PER\_LONG instead. Since we now
#include asm/bitsperlong.h avoid further potential userspace pollution
by moving the #define of SHIFT\_PER\_LONG to bitops.h which is not
exported to userspace.
This patch unbreaks compiling qemu on hppa/parisc.
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit ca332b96ba623aa3243a79d355684974f88c3f1a
Author: Vineet Gupta
Date: Fri Jan 27 10:45:27 2017 -0800
ARC: [arcompact] handle unaligned access delay slot corner case
commit 9aed02feae57bf7a40cb04ea0e3017cb7a998db4 upstream.
After emulating an unaligned access in delay slot of a branch, we
pretend as the delay slot never happened - so return back to actual
branch target (or next PC if branch was not taken).
Curently we did this by handling STATUS32.DE, we also need to clear the
BTA.T bit, which is disregarded when returning from original misaligned
exception, but could cause weirdness if it took the interrupt return
path (in case interrupt was acive too)
One ARC700 customer ran into this when enabling unaligned access fixup
for kernel mode accesses as well
Signed-off-by: Vineet Gupta
Signed-off-by: Greg Kroah-Hartman
commit 9d5f2c151ec01949e4cc02333bc843b128110f55
Author: Vineet Gupta
Date: Tue Jan 24 10:23:42 2017 -0800
ARC: udelay: fix inline assembler by adding LP\_COUNT to clobber list
commit 36425cd67052e3becf325fd4d3ba5691791ef7e4 upstream.
commit 3c7c7a2fc8811bc ("ARC: Don't use "+l" inline asm constraint")
modified the inline assembly to setup LP\_COUNT register manually and NOT
rely on gcc to do it (with the +l inline assembler contraint hint, now
being retired in the compiler)
However the fix was flawed as we didn't add LP\_COUNT to asm clobber list,
meaning gcc doesn't know that LP\_COUNT or zero-delay-loops are in action
in the inline asm.
This resulted in some fun - as nested ZOL loops were being generared
| mov lp\_count,250000 ;16 # tmp235,
| lp .L\_\_GCC\_\_LP14 # <======= OUTER LOOP (gcc generated)
| .L14:
| ld r2, [r5] # MEM[(volatile u32 \*)prephitmp\_43], w
| dmb 1
| breq r2, -1, @.L21 #, w,,
| bbit0 r2,1,@.L13 # w,,
| ld r4,[r7] ;25 # loops\_per\_jiffy, loops\_per\_jiffy
| mpymu r3,r4,r6 #, loops\_per\_jiffy, tmp234
|
| mov lp\_count, r3 # <====== INNER LOOP (from inline asm)
| lp 1f
| nop
| 1:
| nop\_s
| .L\_\_GCC\_\_LP14: ; loop end, start is @.L14 #,
This caused issues with drivers relying on sane behaviour of udelay
friends.
With LP\_COUNT added to clobber list, gcc doesn't generate the outer
loop in say above case.
Addresses STAR 9001146134
Reported-by: Joao Pinto
Fixes: 3c7c7a2fc8811bc ("ARC: Don't use "+l" inline asm constraint")
Signed-off-by: Vineet Gupta
Signed-off-by: Greg Kroah-Hartman
commit 50f5972cc23179e90e8452998bcb609694a9d927
Author: Yegor Yefremov
Date: Wed Jan 18 11:35:57 2017 +0100
can: ti\_hecc: add missing prepare and unprepare of the clock
commit befa60113ce7ea270cb51eada28443ca2756f480 upstream.
In order to make the driver work with the common clock framework, this
patch converts the clk\_enable()/clk\_disable() to
clk\_prepare\_enable()/clk\_disable\_unprepare().
Also add error checking for clk\_prepare\_enable().
Signed-off-by: Yegor Yefremov
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 9f56548b007769191f7dff7585eb317369991c22
Author: Einar Jón
Date: Fri Aug 12 13:50:41 2016 +0200
can: c\_can\_pci: fix null-pointer-deref in c\_can\_start() - set device pointer
commit c97c52be78b8463ac5407f1cf1f22f8f6cf93a37 upstream.
The priv->device pointer for c\_can\_pci is never set, but it is used
without a NULL check in c\_can\_start(). Setting it in c\_can\_pci\_probe()
like c\_can\_plat\_probe() prevents c\_can\_pci.ko from crashing, with and
without CONFIG\_PM.
This might also cause the pm\_runtime\_\*() functions in c\_can.c to
actually be executed for c\_can\_pci devices - they are the only other
place where priv->device is used, but they all contain a null check.
Signed-off-by: Einar Jón
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit a1af471b4151176e26330d3c4a9589711866e2b1
Author: Israel Rukshin
Date: Wed Jan 4 15:59:37 2017 +0200
IB/srp: fix invalid indirect\_sg\_entries parameter value
commit 0a475ef4226e305bdcffe12b401ca1eab06c4913 upstream.
After setting indirect\_sg\_entries module\_param to huge value (e.g 500,000),
srp\_alloc\_req\_data() fails to allocate indirect descriptors for the request
ring (kmalloc fails). This commit enforces the maximum value of
indirect\_sg\_entries to be SG\_MAX\_SEGMENTS as signified in module param
description.
Fixes: 65e8617fba17 (scsi: rename SCSI\_MAX\_{SG, SG\_CHAIN}\_SEGMENTS)
Fixes: c07d424d6118 (IB/srp: add support for indirect tables that don't fit in SRP\_CMD)
Signed-off-by: Israel Rukshin
Signed-off-by: Max Gurtovoy
Reviewed-by: Laurence Oberman
Reviewed-by: Bart Van Assche --
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit c2293e76babeebea894f584c11a07290b4f701da
Author: Israel Rukshin
Date: Wed Dec 28 12:48:28 2016 +0200
IB/srp: fix mr allocation when the device supports sg gaps
commit ad8e66b4a80182174f73487ed25fd2140cf43361 upstream.
If the device support arbitrary sg list mapping (device cap
IB\_DEVICE\_SG\_GAPS\_REG set) we allocate the memory regions with
IB\_MR\_TYPE\_SG\_GAPS.
Fixes: 509c5f33f4f6 ("IB/srp: Prevent mapping failures")
Signed-off-by: Israel Rukshin
Signed-off-by: Max Gurtovoy
Reviewed-by: Leon Romanovsky
Reviewed-by: Mark Bloch
Reviewed-by: Yuval Shaia
Reviewed-by: Bart Van Assche
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 24be606cd3b433412488ce962842489fe6e34a7a
Author: Max Gurtovoy
Date: Wed Jan 18 00:40:39 2017 +0200
IB/iser: Fix sg\_tablesize calculation
commit 1e5db6c31ade4150c2e2b1a21e39f776c38fea39 upstream.
For devices that can register page list that is bigger than
USHRT\_MAX, we actually take the wrong value for sg\_tablesize.
E.g: for CX4 max\_fast\_reg\_page\_list\_len is 65536 (bigger than USHRT\_MAX)
so we set sg\_tablesize to 0 by mistake. Therefore, each IO that is
bigger than 4k splitted to "< 4k" chunks that cause performance degredation.
Remove wrong sg\_tablesize assignment, and use the value that was set during
address resolution handler with the needed casting.
Signed-off-by: Max Gurtovoy
Reviewed-by: Sagi Grimberg
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 95600605ffaa644d3f6fce55faf40ec12cec7855
Author: Nicolas Iooss
Date: Sun Jan 22 14:41:22 2017 +0100
IB/cxgb3: fix misspelling in header guard
commit b1a27eac7fefff33ccf6acc919fc0725bf9815fb upstream.
Use CXGB3\_... instead of CXBG3\_...
Fixes: a85fb3383340 ("IB/cxgb3: Move user vendor structures")
Signed-off-by: Nicolas Iooss
Reviewed-by: Leon Romanovsky
Acked-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit d7f56ee1198a1d0657368abc4dcd10ae109a8433
Author: Martin Schwidefsky
Date: Tue Jan 24 08:05:52 2017 +0100
s390/ptrace: Preserve previous registers for short regset write
commit 9dce990d2cf57b5ed4e71a9cdbd7eae4335111ff upstream.
Ensure that if userspace supplies insufficient data to
PTRACE\_SETREGSET to fill all the registers, the thread's old
registers are preserved.
convert\_vx\_to\_fp() is adapted to handle only a specified number of
registers rather than unconditionally handling all of them: other
callers of this function are adapted appropriately.
Based on an initial patch by Dave Martin.
Reported-by: Dave Martin
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit 62d7f2123f19a7e81c53bcd08f2902cd54c52b64
Author: Christian Borntraeger
Date: Mon Jan 23 22:59:44 2017 +0100
s390/mm: Fix cmma unused transfer from pgste into pte
commit 0d6da872d3e4a60f43c295386d7ff9a4cdcd57e9 upstream.
The last pgtable rework silently disabled the CMMA unused state by
setting a local pte variable (a parameter) instead of propagating it
back into the caller. Fix it.
Fixes: ebde765c0e85 ("s390/mm: uninline ptep\_xxx functions from pgtable.h")
Cc: Martin Schwidefsky
Cc: Claudio Imbrenda
Signed-off-by: Christian Borntraeger
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit 97a2e39b7ab93008c8bc432675ee36ad3de3fce1
Author: Jack Morgenstein
Date: Sun Jan 15 20:15:00 2017 +0200
RDMA/cma: Fix unknown symbol when CONFIG\_IPV6 is not enabled
commit b4cfe3971f6eab542dd7ecc398bfa1aeec889934 upstream.
If IPV6 has not been enabled in the underlying kernel, we must avoid
calling IPV6 procedures in rdma\_cm.ko.
This requires using "IS\_ENABLED(CONFIG\_IPV6)" in "if" statements
surrounding any code which calls external IPV6 procedures.
In the instance fixed here, procedure cma\_bind\_addr() called
ipv6\_addr\_type() -- which resulted in calling external procedure
\_\_ipv6\_addr\_type().
Fixes: 6c26a77124ff ("RDMA/cma: fix IPv6 address resolution")
Cc: Spencer Baugh
Signed-off-by: Jack Morgenstein
Reviewed-by: Moni Shoua
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit ffb97c11d05fea9a3ff29ad1d9e9c854e0a06dc2
Author: Omar Sandoval
Date: Wed Jan 25 17:06:40 2017 -0800
Btrfs: remove ->{get, set}\_acl() from btrfs\_dir\_ro\_inode\_operations
commit 57b59ed2e5b91e958843609c7884794e29e6c4cb upstream.
Subvolume directory inodes can't have ACLs.
Signed-off-by: Omar Sandoval
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit ad80fada9d6d8177d1593a9b5772e80a758db595
Author: Omar Sandoval
Date: Wed Jan 25 17:06:39 2017 -0800
Btrfs: disable xattr operations on subvolume directories
commit 1fdf41941b8010691679638f8d0c8d08cfee7726 upstream.
When you snapshot a subvolume containing a subvolume, you get a
placeholder directory where the subvolume would be. These directory
inodes have ->i\_ops set to btrfs\_dir\_ro\_inode\_operations. Previously,
these i\_ops didn't include the xattr operation callbacks. The conversion
to xattr\_handlers missed this case, leading to bogus attempts to set
xattrs on these inodes. This manifested itself as failures when running
delayed inodes.
To fix this, clear IOP\_XATTR in ->i\_opflags on these inodes.
Fixes: 6c6ef9f26e59 ("xattr: Stop calling {get,set,remove}xattr inode operations")
Cc: Andreas Gruenbacher
Reported-by: Chris Murphy
Tested-by: Chris Murphy
Signed-off-by: Omar Sandoval
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 79babd4a6ce26d6b0e6a56da47efb723431abc70
Author: Omar Sandoval
Date: Wed Jan 25 17:06:38 2017 -0800
Btrfs: remove old tree\_root case in btrfs\_read\_locked\_inode()
commit 67ade058ef2c65a3e56878af9c293ec76722a2e5 upstream.
As Jeff explained in c2951f32d36c ("btrfs: remove old tree\_root dirent
processing in btrfs\_real\_readdir()"), supporting this old format is no
longer necessary since the Btrfs magic number has been updated since we
changed to the current format. There are other places where we still
handle this old format, but since this is part of a fix that is going to
stable, I'm only removing this one for now.
Signed-off-by: Omar Sandoval
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 959f9709c0251275f05fd9092ff25e9b9bec237e
Author: Arnd Bergmann
Date: Fri Jan 27 13:32:14 2017 +0100
ISDN: eicon: silence misleading array-bounds warning
commit 950eabbd6ddedc1b08350b9169a6a51b130ebaaf upstream.
With some gcc versions, we get a warning about the eicon driver,
and that currently shows up as the only remaining warning in one
of the build bots:
In file included from ../drivers/isdn/hardware/eicon/message.c:30:0:
eicon/message.c: In function 'mixer\_notify\_update':
eicon/platform.h:333:18: warning: array subscript is above array bounds [-Warray-bounds]
The code is easily changed to open-code the unusual PUT\_WORD() line
causing this to avoid the warning.
Link: http://arm-soc.lixom.net/buildlogs/stable-rc/v4.4.45/
Signed-off-by: Arnd Bergmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4859524143609fee04d69a8069f9a83317e4bb7c
Author: Brian Foster
Date: Thu Jan 26 13:18:09 2017 -0800
xfs: prevent quotacheck from overloading inode lru
commit e0d76fa4475ef2cf4b52d18588b8ce95153d021b upstream.
Quotacheck runs at mount time in situations where quota accounting must
be recalculated. In doing so, it uses bulkstat to visit every inode in
the filesystem. Historically, every inode processed during quotacheck
was released and immediately tagged for reclaim because quotacheck runs
before the superblock is marked active by the VFS. In other words,
the final iput() lead to an immediate ->destroy\_inode() call, which
allowed the XFS background reclaim worker to start reclaiming inodes.
Commit 17c12bcd3 ("xfs: when replaying bmap operations, don't let
unlinked inodes get reaped") marks the XFS superblock active sooner as
part of the mount process to support caching inodes processed during log
recovery. This occurs before quotacheck and thus means all inodes
processed by quotacheck are inserted to the LRU on release. The
s\_umount lock is held until the mount has completed and thus prevents
the shrinkers from operating on the sb. This means that quotacheck can
excessively populate the inode LRU and lead to OOM conditions on systems
without sufficient RAM.
Update the quotacheck bulkstat handler to set XFS\_IGET\_DONTCACHE on
inodes processed by quotacheck. This causes ->drop\_inode() to return 1
and in turn causes iput\_final() to evict the inode. This preserves the
original quotacheck behavior and prevents it from overloading the LRU
and running out of memory.
Reported-by: Martin Svec
Signed-off-by: Brian Foster
Reviewed-by: Eric Sandeen
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Greg Kroah-Hartman
commit 03707d6c36f9c7355c22e43039c09804e96a02b6
Author: Eric Dumazet
Date: Wed Jan 25 18:20:55 2017 -0800
sysctl: fix proc\_doulongvec\_ms\_jiffies\_minmax()
commit ff9f8a7cf935468a94d9927c68b00daae701667e upstream.
We perform the conversion between kernel jiffies and ms only when
exporting kernel value to user space.
We need to do the opposite operation when value is written by user.
Only matters when HZ != 1000
Signed-off-by: Eric Dumazet
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c7556867782ee8ae0383a1e99df09222f1f01332
Author: Nikolay Borisov
Date: Fri Jan 20 15:21:35 2017 +0200
userns: Make ucounts lock irq-safe
commit 880a38547ff08715ce4f1daf9a4bb30c87676e68 upstream.
The ucounts\_lock is being used to protect various ucounts lifecycle
management functionalities. However, those services can also be invoked
when a pidns is being freed in an RCU callback (e.g. softirq context).
This can lead to deadlocks. There were already efforts trying to
prevent similar deadlocks in add7c65ca426 ("pid: fix lockdep deadlock
warning due to ucount\_lock"), however they just moved the context
from hardirq to softrq. Fix this issue once and for all by explictly
making the lock disable irqs altogether.
Dmitry Vyukov  reported:
> I've got the following deadlock report while running syzkaller fuzzer
> on eec0d3d065bfcdf9cd5f56dd2a36b94d12d32297 of linux-next (on odroid
> device if it matters):
>
> =================================
> [ INFO: inconsistent lock state ]
> 4.10.0-rc3-next-20170112-xc2-dirty #6 Not tainted
> ---------------------------------
> inconsistent {SOFTIRQ-ON-W} -> {IN-SOFTIRQ-W} usage.
> swapper/2/0 [HC0[0]:SC1[1]:HE1:SE0] takes:
> (ucounts\_lock){+.?...}, at: [< inline >] spin\_lock
> ./include/linux/spinlock.h:302
> (ucounts\_lock){+.?...}, at: []
> put\_ucounts+0x60/0x138 kernel/ucount.c:162
> {SOFTIRQ-ON-W} state was registered at:
> [] mark\_lock+0x220/0xb60 kernel/locking/lockdep.c:3054
> [< inline >] mark\_irqflags kernel/locking/lockdep.c:2941
> [] \_\_lock\_acquire+0x388/0x3260 kernel/locking/lockdep.c:3295
> [] lock\_acquire+0xa4/0x138 kernel/locking/lockdep.c:3753
> [< inline >] \_\_raw\_spin\_lock ./include/linux/spinlock\_api\_smp.h:144
> [] \_raw\_spin\_lock+0x90/0xd0 kernel/locking/spinlock.c:151
> [< inline >] spin\_lock ./include/linux/spinlock.h:302
> [< inline >] get\_ucounts kernel/ucount.c:131
> [] inc\_ucount+0x80/0x6c8 kernel/ucount.c:189
> [< inline >] inc\_mnt\_namespaces fs/namespace.c:2818
> [] alloc\_mnt\_ns+0x78/0x3a8 fs/namespace.c:2849
> [] create\_mnt\_ns+0x28/0x200 fs/namespace.c:2959
> [< inline >] init\_mount\_tree fs/namespace.c:3199
> [] mnt\_init+0x258/0x384 fs/namespace.c:3251
> [] vfs\_caches\_init+0x6c/0x80 fs/dcache.c:3626
> [] start\_kernel+0x414/0x460 init/main.c:648
> [] \_\_primary\_switched+0x6c/0x70 arch/arm64/kernel/head.S:456
> irq event stamp: 2316924
> hardirqs last enabled at (2316924): [< inline >] rcu\_do\_batch
> kernel/rcu/tree.c:2911
> hardirqs last enabled at (2316924): [< inline >]
> invoke\_rcu\_callbacks kernel/rcu/tree.c:3182
> hardirqs last enabled at (2316924): [< inline >]
> \_\_rcu\_process\_callbacks kernel/rcu/tree.c:3149
> hardirqs last enabled at (2316924): []
> rcu\_process\_callbacks+0x7a4/0xc28 kernel/rcu/tree.c:3166
> hardirqs last disabled at (2316923): [< inline >] rcu\_do\_batch
> kernel/rcu/tree.c:2900
> hardirqs last disabled at (2316923): [< inline >]
> invoke\_rcu\_callbacks kernel/rcu/tree.c:3182
> hardirqs last disabled at (2316923): [< inline >]
> \_\_rcu\_process\_callbacks kernel/rcu/tree.c:3149
> hardirqs last disabled at (2316923): []
> rcu\_process\_callbacks+0x210/0xc28 kernel/rcu/tree.c:3166
> softirqs last enabled at (2316912): []
> \_local\_bh\_enable+0x4c/0x80 kernel/softirq.c:155
> softirqs last disabled at (2316913): [< inline >]
> do\_softirq\_own\_stack ./include/linux/interrupt.h:488
> softirqs last disabled at (2316913): [< inline >]
> invoke\_softirq kernel/softirq.c:371
> softirqs last disabled at (2316913): []
> irq\_exit+0x264/0x308 kernel/softirq.c:405
>
> other info that might help us debug this:
> Possible unsafe locking scenario:
>
> CPU0
> ----
> lock(ucounts\_lock);
>
> lock(ucounts\_lock);
>
> \*\*\* DEADLOCK \*\*\*
>
> 1 lock held by swapper/2/0:
> #0: (rcu\_callback){......}, at: [< inline >] \_\_rcu\_reclaim
> kernel/rcu/rcu.h:108
> #0: (rcu\_callback){......}, at: [< inline >] rcu\_do\_batch
> kernel/rcu/tree.c:2919
> #0: (rcu\_callback){......}, at: [< inline >]
> invoke\_rcu\_callbacks kernel/rcu/tree.c:3182
> #0: (rcu\_callback){......}, at: [< inline >]
> \_\_rcu\_process\_callbacks kernel/rcu/tree.c:3149
> #0: (rcu\_callback){......}, at: []
> rcu\_process\_callbacks+0x720/0xc28 kernel/rcu/tree.c:3166
>
> stack backtrace:
> CPU: 2 PID: 0 Comm: swapper/2 Not tainted 4.10.0-rc3-next-20170112-xc2-dirty #6
> Hardware name: Hardkernel ODROID-C2 (DT)
> Call trace:
> [] dump\_backtrace+0x0/0x440 arch/arm64/kernel/traps.c:500
> [] show\_stack+0x20/0x30 arch/arm64/kernel/traps.c:225
> [] dump\_stack+0x110/0x168
> [] print\_usage\_bug.part.27+0x49c/0x4bc
> kernel/locking/lockdep.c:2387
> [< inline >] print\_usage\_bug kernel/locking/lockdep.c:2357
> [< inline >] valid\_state kernel/locking/lockdep.c:2400
> [< inline >] mark\_lock\_irq kernel/locking/lockdep.c:2617
> [] mark\_lock+0x934/0xb60 kernel/locking/lockdep.c:3065
> [< inline >] mark\_irqflags kernel/locking/lockdep.c:2923
> [] \_\_lock\_acquire+0x640/0x3260 kernel/locking/lockdep.c:3295
> [] lock\_acquire+0xa4/0x138 kernel/locking/lockdep.c:3753
> [< inline >] \_\_raw\_spin\_lock ./include/linux/spinlock\_api\_smp.h:144
> [] \_raw\_spin\_lock+0x90/0xd0 kernel/locking/spinlock.c:151
> [< inline >] spin\_lock ./include/linux/spinlock.h:302
> [] put\_ucounts+0x60/0x138 kernel/ucount.c:162
> [] dec\_ucount+0xf4/0x158 kernel/ucount.c:214
> [< inline >] dec\_pid\_namespaces kernel/pid\_namespace.c:89
> [] delayed\_free\_pidns+0x40/0xe0 kernel/pid\_namespace.c:156
> [< inline >] \_\_rcu\_reclaim kernel/rcu/rcu.h:118
> [< inline >] rcu\_do\_batch kernel/rcu/tree.c:2919
> [< inline >] invoke\_rcu\_callbacks kernel/rcu/tree.c:3182
> [< inline >] \_\_rcu\_process\_callbacks kernel/rcu/tree.c:3149
> [] rcu\_process\_callbacks+0x768/0xc28 kernel/rcu/tree.c:3166
> [] \_\_do\_softirq+0x324/0x6e0 kernel/softirq.c:284
> [< inline >] do\_softirq\_own\_stack ./include/linux/interrupt.h:488
> [< inline >] invoke\_softirq kernel/softirq.c:371
> [] irq\_exit+0x264/0x308 kernel/softirq.c:405
> [] \_\_handle\_domain\_irq+0xc0/0x150 kernel/irq/irqdesc.c:636
> [] gic\_handle\_irq+0x68/0xd8
> Exception stack(0xffff8000648e7dd0 to 0xffff8000648e7f00)
> 7dc0: ffff8000648d4b3c 0000000000000007
> 7de0: 0000000000000000 1ffff0000c91a967 1ffff0000c91a967 1ffff0000c91a967
> 7e00: ffff20000a4b6b68 0000000000000001 0000000000000007 0000000000000001
> 7e20: 1fffe4000149ae90 ffff200009d35000 0000000000000000 0000000000000002
> 7e40: 0000000000000000 0000000000000000 0000000002624a1a 0000000000000000
> 7e60: 0000000000000000 ffff200009cbcd88 000060006d2ed000 0000000000000140
> 7e80: ffff200009cff000 ffff200009cb6000 ffff200009cc2020 ffff200009d2159d
> 7ea0: 0000000000000000 ffff8000648d4380 0000000000000000 ffff8000648e7f00
> 7ec0: ffff20000820a478 ffff8000648e7f00 ffff20000820a47c 0000000010000145
> 7ee0: 0000000000000140 dfff200000000000 ffffffffffffffff ffff20000820a478
> [] el1\_irq+0xb8/0x130 arch/arm64/kernel/entry.S:486
> [< inline >] arch\_local\_irq\_restore
> ./arch/arm64/include/asm/irqflags.h:81
> [] rcu\_idle\_exit+0x64/0xa8 kernel/rcu/tree.c:1030
> [< inline >] cpuidle\_idle\_call kernel/sched/idle.c:200
> [] do\_idle+0x1dc/0x2d0 kernel/sched/idle.c:243
> [] cpu\_startup\_entry+0x24/0x28 kernel/sched/idle.c:345
> [] secondary\_start\_kernel+0x2cc/0x358
> arch/arm64/kernel/smp.c:276
> [<000000000279f1a4>] 0x279f1a4
Reported-by: Dmitry Vyukov
Tested-by: Dmitry Vyukov
Fixes: add7c65ca426 ("pid: fix lockdep deadlock warning due to ucount\_lock")
Fixes: f333c700c610 ("pidns: Add a limit on the number of pid namespaces")
Link: https://www.spinics.net/lists/kernel/msg2426637.html
Signed-off-by: Nikolay Borisov
Signed-off-by: Eric W. Biederman
Signed-off-by: Greg Kroah-Hartman
commit 13e39d5930ec5a4e0711a6d88bcea84bfd13d4bb
Author: Will Deacon
Date: Fri Jan 20 10:33:32 2017 +0000
vring: Force use of DMA API for ARM-based systems with legacy devices
commit c7070619f3408d9a0dffbed9149e6f00479cf43b upstream.
Booting Linux on an ARM fastmodel containing an SMMU emulation results
in an unexpected I/O page fault from the legacy virtio-blk PCI device:
[ 1.211721] arm-smmu-v3 2b400000.smmu: event 0x10 received:
[ 1.211800] arm-smmu-v3 2b400000.smmu: 0x00000000fffff010
[ 1.211880] arm-smmu-v3 2b400000.smmu: 0x0000020800000000
[ 1.211959] arm-smmu-v3 2b400000.smmu: 0x00000008fa081002
[ 1.212075] arm-smmu-v3 2b400000.smmu: 0x0000000000000000
[ 1.212155] arm-smmu-v3 2b400000.smmu: event 0x10 received:
[ 1.212234] arm-smmu-v3 2b400000.smmu: 0x00000000fffff010
[ 1.212314] arm-smmu-v3 2b400000.smmu: 0x0000020800000000
[ 1.212394] arm-smmu-v3 2b400000.smmu: 0x00000008fa081000
[ 1.212471] arm-smmu-v3 2b400000.smmu: 0x0000000000000000
This is because the legacy virtio-blk device is behind an SMMU, so we
have consequently swizzled its DMA ops and configured the SMMU to
translate accesses. This then requires the vring code to use the DMA API
to establish translations, otherwise all transactions will result in
fatal faults and termination.
Given that ARM-based systems only see an SMMU if one is really present
(the topology is all described by firmware tables such as device-tree or
IORT), then we can safely use the DMA API for all legacy virtio devices.
Modern devices can advertise the prescense of an IOMMU using the
VIRTIO\_F\_IOMMU\_PLATFORM feature flag.
Cc: Andy Lutomirski
Cc: Michael S. Tsirkin
Fixes: 876945dbf649 ("arm64: Hook up IOMMU dma\_ops")
Signed-off-by: Will Deacon
Signed-off-by: Michael S. Tsirkin
Acked-by: Marc Zyngier
Signed-off-by: Greg Kroah-Hartman
commit 96e5cec10e7a75c931f8993633b3a5cedc99144e
Author: Vlastimil Babka
Date: Tue Jan 24 15:18:41 2017 -0800
mm, page\_alloc: fix premature OOM when racing with cpuset mems update
commit e47483bca2cc59a4593b37a270b16ee42b1d9f08 upstream.
Ganapatrao Kulkarni reported that the LTP test cpuset01 in stress mode
triggers OOM killer in few seconds, despite lots of free memory. The
test attempts to repeatedly fault in memory in one process in a cpuset,
while changing allowed nodes of the cpuset between 0 and 1 in another
process.
The problem comes from insufficient protection against cpuset changes,
which can cause get\_page\_from\_freelist() to consider all zones as
non-eligible due to nodemask and/or current->mems\_allowed. This was
masked in the past by sufficient retries, but since commit 682a3385e773
("mm, page\_alloc: inline the fast path of the zonelist iterator") we fix
the preferred\_zoneref once, and don't iterate over the whole zonelist in
further attempts, thus the only eligible zones might be placed in the
zonelist before our starting point and we always miss them.
A previous patch fixed this problem for current->mems\_allowed. However,
cpuset changes also update the task's mempolicy nodemask. The fix has
two parts. We have to repeat the preferred\_zoneref search when we
detect cpuset update by way of seqcount, and we have to check the
seqcount before considering OOM.
[akpm@linux-foundation.org: fix typo in comment]
Link: http://lkml.kernel.org/r/20170120103843.24587-5-vbabka@suse.cz
Fixes: c33d6c06f60f ("mm, page\_alloc: avoid looking up the first zone in a zonelist twice")
Signed-off-by: Vlastimil Babka
Reported-by: Ganapatrao Kulkarni
Acked-by: Mel Gorman
Acked-by: Hillf Danton
Cc: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit b678e4ff7ce0d01bb14f0adb92c1786b0a341cca
Author: Vlastimil Babka
Date: Tue Jan 24 15:18:38 2017 -0800
mm, page\_alloc: move cpuset seqcount checking to slowpath
commit 5ce9bfef1d27944c119a397a9d827bef795487ce upstream.
This is a preparation for the following patch to make review simpler.
While the primary motivation is a bug fix, this also simplifies the fast
path, although the moved code is only enabled when cpusets are in use.
Link: http://lkml.kernel.org/r/20170120103843.24587-4-vbabka@suse.cz
Signed-off-by: Vlastimil Babka
Acked-by: Mel Gorman
Acked-by: Hillf Danton
Cc: Ganapatrao Kulkarni
Cc: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d1656c5aef4d72f03a7833d07a378c8f604b8307
Author: Vlastimil Babka
Date: Tue Jan 24 15:18:35 2017 -0800
mm, page\_alloc: fix fast-path race with cpuset update or removal
commit 16096c25bf0ca5d87e4fa6ec6108ba53feead212 upstream.
Ganapatrao Kulkarni reported that the LTP test cpuset01 in stress mode
triggers OOM killer in few seconds, despite lots of free memory. The
test attempts to repeatedly fault in memory in one process in a cpuset,
while changing allowed nodes of the cpuset between 0 and 1 in another
process.
One possible cause is that in the fast path we find the preferred
zoneref according to current mems\_allowed, so that it points to the
middle of the zonelist, skipping e.g. zones of node 1 completely. If
the mems\_allowed is updated to contain only node 1, we never reach it in
the zonelist, and trigger OOM before checking the cpuset\_mems\_cookie.
This patch fixes the particular case by redoing the preferred zoneref
search if we switch back to the original nodemask. The condition is
also slightly changed so that when the last non-root cpuset is removed,
we don't miss it.
Note that this is not a full fix, and more patches will follow.
Link: http://lkml.kernel.org/r/20170120103843.24587-3-vbabka@suse.cz
Fixes: 682a3385e773 ("mm, page\_alloc: inline the fast path of the zonelist iterator")
Signed-off-by: Vlastimil Babka
Reported-by: Ganapatrao Kulkarni
Acked-by: Michal Hocko
Acked-by: Mel Gorman
Acked-by: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ade7afe9dca6b13919f88abd38eefe32f22eaeb3
Author: Vlastimil Babka
Date: Tue Jan 24 15:18:32 2017 -0800
mm, page\_alloc: fix check for NULL preferred\_zone
commit ea57485af8f4221312a5a95d63c382b45e7840dc upstream.
Patch series "fix premature OOM regression in 4.7+ due to cpuset races".
This is v2 of my attempt to fix the recent report based on LTP cpuset
stress test [1]. The intention is to go to stable 4.9 LTSS with this,
as triggering repeated OOMs is not nice. That's why the patches try to
be not too intrusive.
Unfortunately why investigating I found that modifying the testcase to
use per-VMA policies instead of per-task policies will bring the OOM's
back, but that seems to be much older and harder to fix problem. I have
posted a RFC [2] but I believe that fixing the recent regressions has a
higher priority.
Longer-term we might try to think how to fix the cpuset mess in a better
and less error prone way. I was for example very surprised to learn,
that cpuset updates change not only task->mems\_allowed, but also
nodemask of mempolicies. Until now I expected the parameter to
alloc\_pages\_nodemask() to be stable. I wonder why do we then treat
cpusets specially in get\_page\_from\_freelist() and distinguish HARDWALL
etc, when there's unconditional intersection between mempolicy and
cpuset. I would expect the nodemask adjustment for saving overhead in
g\_p\_f(), but that clearly doesn't happen in the current form. So we
have both crazy complexity and overhead, AFAICS.
[1] https://lkml.kernel.org/r/CAFpQJXUq-JuEP=QPidy4p\_=FN0rkH5Z-kfB4qBvsf6jMS87Edg@mail.gmail.com
[2] https://lkml.kernel.org/r/7c459f26-13a6-a817-e508-b65b903a8378@suse.cz
This patch (of 4):
Since commit c33d6c06f60f ("mm, page\_alloc: avoid looking up the first
zone in a zonelist twice") we have a wrong check for NULL preferred\_zone,
which can theoretically happen due to concurrent cpuset modification. We
check the zoneref pointer which is never NULL and we should check the zone
pointer. Also document this in first\_zones\_zonelist() comment per Michal
Hocko.
Fixes: c33d6c06f60f ("mm, page\_alloc: avoid looking up the first zone in a zonelist twice")
Link: http://lkml.kernel.org/r/20170120103843.24587-2-vbabka@suse.cz
Signed-off-by: Vlastimil Babka
Acked-by: Mel Gorman
Acked-by: Hillf Danton
Cc: Ganapatrao Kulkarni
Cc: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9b1a1ae9b5281e12893a34bcbd1686b5bcd2cd82
Author: Vlastimil Babka
Date: Tue Jan 24 15:18:18 2017 -0800
mm/mempolicy.c: do not put mempolicy before using its nodemask
commit d51e9894d27492783fc6d1b489070b4ba66ce969 upstream.
Since commit be97a41b291e ("mm/mempolicy.c: merge alloc\_hugepage\_vma to
alloc\_pages\_vma") alloc\_pages\_vma() can potentially free a mempolicy by
mpol\_cond\_put() before accessing the embedded nodemask by
\_\_alloc\_pages\_nodemask(). The commit log says it's so "we can use a
single exit path within the function" but that's clearly wrong. We can
still do that when doing mpol\_cond\_put() after the allocation attempt.
Make sure the mempolicy is not freed prematurely, otherwise
\_\_alloc\_pages\_nodemask() can end up using a bogus nodemask, which could
lead e.g. to premature OOM.
Fixes: be97a41b291e ("mm/mempolicy.c: merge alloc\_hugepage\_vma to alloc\_pages\_vma")
Link: http://lkml.kernel.org/r/20170118141124.8345-1-vbabka@suse.cz
Signed-off-by: Vlastimil Babka
Acked-by: Kirill A. Shutemov
Acked-by: Michal Hocko
Acked-by: David Rientjes
Cc: Aneesh Kumar K.V
Cc: Andrea Arcangeli
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6676aa65464f23e32efe1857a51fe341dfb10e03
Author: Keno Fischer
Date: Tue Jan 24 15:17:48 2017 -0800
mm/huge\_memory.c: respect FOLL\_FORCE/FOLL\_COW for thp
commit 8310d48b125d19fcd9521d83b8293e63eb1646aa upstream.
In commit 19be0eaffa3a ("mm: remove gup\_flags FOLL\_WRITE games from
\_\_get\_user\_pages()"), the mm code was changed from unsetting FOLL\_WRITE
after a COW was resolved to setting the (newly introduced) FOLL\_COW
instead. Simultaneously, the check in gup.c was updated to still allow
writes with FOLL\_FORCE set if FOLL\_COW had also been set.
However, a similar check in huge\_memory.c was forgotten. As a result,
remote memory writes to ro regions of memory backed by transparent huge
pages cause an infinite loop in the kernel (handle\_mm\_fault sets
FOLL\_COW and returns 0 causing a retry, but follow\_trans\_huge\_pmd bails
out immidiately because `(flags & FOLL\_WRITE) && !pmd\_write(\*pmd)` is
true.
While in this state the process is stil SIGKILLable, but little else
works (e.g. no ptrace attach, no other signals). This is easily
reproduced with the following code (assuming thp are set to always):
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
#define TEST\_SIZE 5 \* 1024 \* 1024
int main(void) {
int status;
pid\_t child;
int fd = open("/proc/self/mem", O\_RDWR);
void \*addr = mmap(NULL, TEST\_SIZE, PROT\_READ,
MAP\_ANONYMOUS | MAP\_PRIVATE, 0, 0);
assert(addr != MAP\_FAILED);
pid\_t parent\_pid = getpid();
if ((child = fork()) == 0) {
void \*addr2 = mmap(NULL, TEST\_SIZE, PROT\_READ | PROT\_WRITE,
MAP\_ANONYMOUS | MAP\_PRIVATE, 0, 0);
assert(addr2 != MAP\_FAILED);
memset(addr2, 'a', TEST\_SIZE);
pwrite(fd, addr2, TEST\_SIZE, (uintptr\_t)addr);
return 0;
}
assert(child == waitpid(child, &status, 0));
assert(WIFEXITED(status) && WEXITSTATUS(status) == 0);
return 0;
}
Fix this by updating follow\_trans\_huge\_pmd in huge\_memory.c analogously
to the update in gup.c in the original commit. The same pattern exists
in follow\_devmap\_pmd. However, we should not be able to reach that
check with FOLL\_COW set, so add WARN\_ONCE to make sure we notice if we
ever do.
[akpm@linux-foundation.org: coding-style fixes]
Link: http://lkml.kernel.org/r/20170106015025.GA38411@juliacomputing.com
Signed-off-by: Keno Fischer
Acked-by: Kirill A. Shutemov
Cc: Greg Thelen
Cc: Nicholas Piggin
Cc: Willy Tarreau
Cc: Oleg Nesterov
Cc: Kees Cook
Cc: Andy Lutomirski
Cc: Michal Hocko
Cc: Hugh Dickins
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a2104c7cd3b24c4329b6193f7ec0882ce612f110
Author: Lucas Stach
Date: Fri Jan 27 11:33:04 2017 +0100
drm/atomic: clear out fence when duplicating state
[Fixed differently in 4.10]
The fence needs to be cleared out, otherwise the following commit
might wait on a stale fence from the previous commit. This was fixed
as a side effect of 9626014258a5 (drm/fence: add in-fences support)
in kernel 4.10.
As this commit introduces new functionality and as such can not be
applied to stable, this patch is the minimal fix for the kernel 4.9
stable series.
Signed-off-by: Lucas Stach
Reviewed-by: Daniel Vetter
Tested-by: Fabio Estevam
Signed-off-by: Greg Kroah-Hartman
commit bbae3c4525966606db790ac7b7910b8639b5da42
Author: Alex Deucher
Date: Wed Jan 25 12:00:29 2017 -0500
Revert "drm/radeon: always apply pci shutdown callbacks"
commit b9b487e494712c8e5905b724e12f5ef17e9ae6f9 upstream.
This seems to break reboot on some evergreen systems.
bugs:
https://bugs.freedesktop.org/show\_bug.cgi?id=99524
https://bugzilla.kernel.org/show\_bug.cgi?id=192271
This reverts commit a481daa88fd4d6b54f25348972bba10b5f6a84d0.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 5270c017f19f32812d7d83ba6e45873b8db503d0
Author: Dan Carpenter
Date: Fri Jan 13 10:49:00 2017 +0300
drm/vc4: fix a bounds check
commit 21ccc32496b2f63228f5232b3ac0e426e8fb3c31 upstream.
We accidentally return success even if vc4\_full\_res\_bounds\_check() fails.
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
Signed-off-by: Dan Carpenter
Reviewed-by: Eric Engestrom
Reviewed-by: Eric Anholt
Signed-off-by: Greg Kroah-Hartman
commit cfba2a001d0e36905016bb4f87fc47245c944c36
Author: Eric Anholt
Date: Tue Jan 17 21:58:06 2017 +1100
drm/vc4: Return -EINVAL on the overflow checks failing.
commit 6b8ac63847bc2f958dd93c09edc941a0118992d9 upstream.
By failing to set the errno, we'd continue on to trying to set up the
RCL, and then oops on trying to dereference the tile\_bo that binning
validation should have set up.
Reported-by: Ingo Molnar
Signed-off-by: Eric Anholt
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
Signed-off-by: Greg Kroah-Hartman
commit b9edac54cb85da589ca809bf8dcf86e5cd3f41c0
Author: Eric Anholt
Date: Tue Jan 17 21:42:53 2017 +1100
drm/vc4: Fix an integer overflow in temporary allocation layout.
commit 0f2ff82e11c86c05d051cae32b58226392d33bbf upstream.
We copy the unvalidated ioctl arguments from the user into kernel
temporary memory to run the validation from, to avoid a race where the
user updates the unvalidate contents in between validating them and
copying them into the validated BO.
However, in setting up the layout of the kernel side, we failed to
check one of the additions (the roundup() for shader\_rec\_offset)
against integer overflow, allowing a nearly MAX\_UINT value of
bin\_cl\_size to cause us to under-allocate the temporary space that we
then copy\_from\_user into.
Reported-by: Murray McAllister
Signed-off-by: Eric Anholt
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
Signed-off-by: Greg Kroah-Hartman
commit 32600835ebe1bd972d01ce7f331b87bd80705d30
Author: Eric Anholt
Date: Mon Oct 10 09:44:06 2016 -0700
drm/vc4: Fix memory leak of the CRTC state.
commit 7622b25543665567d8830a63210385b7d705924b upstream.
The underscores variant frees the pointers inside, while the
no-underscores variant calls underscores and then frees the struct.
Signed-off-by: Eric Anholt
Fixes: d8dbf44f13b9 ("drm/vc4: Make the CRTCs cooperate on allocating display lists.")
Signed-off-by: Greg Kroah-Hartman
commit 4c741e2adb351a44d1f4bc210aafd382939ac7ae
Author: Ville Syrjälä
Date: Mon Nov 7 22:20:54 2016 +0200
drm/i915: Ignore bogus plane coordinates on SKL when the plane is not visible
commit 3bfdfdcbce2796ce75bf2d85fd8471858d702e5d upstream.
When the plane is invisible we may have all sorts of bogus stuff
in the coordinates, which we must ignore or else we might fail the
plane update. This started to happen on SKL when I moved the plane
offset computation to happen in the check phase. Previously we
happily ignored it all since we never called the update\_plane hook
with an invisible plane.
Cc: Sivakumar Thulasimani
Cc: drm-intel-fixes@lists.freedesktop.org
Fixes: b63a16f6cd89 ("drm/i915: Compute display surface offset in the plane check hook for SKL+")
Signed-off-by: Ville Syrjälä
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=98258
Testcase: igt/pm\_rpm/legacy-planes
Testcase: igt/pm\_rpm/universal-planes
Reviewed-by: Matt Roper
Signed-off-by: Matt Roper
Link: http://patchwork.freedesktop.org/patch/msgid/1478550057-24864-3-git-send-email-ville.syrjala@linux.intel.com
(cherry picked from commit a5e4c7d0aa6784d8abe95c3ceef0da9656d17468)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit f1dc9aaee02950e95cc045209d9bf07955bc16d8
Author: Takashi Iwai
Date: Mon Jan 9 15:56:14 2017 +0100
drm: Fix broken VT switch with video=1366x768 option
commit fdf35a6b22247746a7053fc764d04218a9306f82 upstream.
I noticed that the VT switch doesn't work any longer with a Dell
laptop with 1366x768 eDP when the machine is connected with a DP
monitor. It behaves as if VT were switched, but the graphics remain
frozen. Actually the keyboard works, so I could switch back to VT7
again.
I tried to track down the problem, and encountered a long story until
we reach to this error:
- The machine is booted with video=1366x768 option (the distro
installer seems to add it as default).
- Recently, drm\_helper\_probe\_single\_connector\_modes() deals with
cmdline modes, and it tries to create a new mode when no
matching mode is found.
- The drm\_mode\_create\_from\_cmdline\_mode() creates a mode based on
either CVT of GFT according to the given cmdline mode; in our case,
it's 1366x768.
- Since both CVT and GFT can't express the width 1366 due to
alignment, the resultant mode becomes 1368x768, slightly larger than
the given size.
- Later on, the atomic commit is performed, and in
drm\_atomic\_check\_only(), the size of each plane is checked.
- The size check of 1366x768 fails due to the above, and eventually
the whole VT switch fails.
Back in the history, we've had a manual fix-up of 1368x768 in various
places via c09dedb7a50e ("drm/edid: Add a workaround for 1366x768 HD
panel"), but they have been all in drm\_edid.c at probing the modes
from EDID. For addressing the problem above, we need a similar hack
to the mode newly created from cmdline, manually adjusting the width
when the expected size is 1366 while we get 1368 instead.
Fixes: eaf99c749d43 ("drm: Perform cmdline mode parsing during...")
Signed-off-by: Takashi Iwai
Link: http://patchwork.freedesktop.org/patch/msgid/20170109145614.29454-1-tiwai@suse.de
Reviewed-by: Ville Syrjälä
Signed-off-by: Ville Syrjälä
Signed-off-by: Greg Kroah-Hartman
commit 2abb7f408f7cfb9af9218e74507f5f44af154302
Author: Peter Ujfalusi
Date: Mon Jan 9 16:31:58 2017 +0200
drm: Schedule the output\_poll\_work with 1s delay if we have delayed event
commit 68f458eec7069d618a6c884ca007426e0cea411b upstream.
Instead of scheduling the work to handle the initial delayed event, use 1s
delay.
This delay should not be needed, but Optimus/nouveau will fail in a
mysterious way if the delayed event is handled as soon as possible like it
is done in drm\_helper\_probe\_single\_connector\_modes() in case the poll
was enabled before.
Reverting 339fd36238dd would give back the 10 sec (!) delay to handle the
delayed event. Adding 1sec delay to the poll\_work is enough to work around
the issue in Optimus setups and gives shorter response on handling the
initial delayed event.
Fixes: 339fd36238dd ("drm: drm\_probe\_helper: Fix output\_poll\_work scheduling")
Signed-off-by: Peter Ujfalusi
[danvet: Add FIXME to the comment to make it stick out more.]
Signed-off-by: Daniel Vetter
Link: http://patchwork.freedesktop.org/patch/msgid/20170109143158.21917-1-peter.ujfalusi@ti.com
Signed-off-by: Greg Kroah-Hartman
commit e4be4d4942b92cdd2d3e87ed178269bcd5844526
Author: Dave Martin
Date: Fri Jan 6 17:54:51 2017 +0000
tile/ptrace: Preserve previous registers for short regset write
commit fd7c99142d77dc4a851879a66715abf12a3193fb upstream.
Ensure that if userspace supplies insufficient data to
PTRACE\_SETREGSET to fill all the registers, the thread's old
registers are preserved.
Signed-off-by: Dave Martin
Signed-off-by: Chris Metcalf
Signed-off-by: Greg Kroah-Hartman
commit 544160b6ea18670196d1173c099f2cced5075132
Author: Kees Cook
Date: Tue Jan 24 15:18:24 2017 -0800
fbdev: color map copying bounds checking
commit 2dc705a9930b4806250fbf5a76e55266e59389f2 upstream.
Copying color maps to userspace doesn't check the value of to->start,
which will cause kernel heap buffer OOB read due to signedness wraps.
CVE-2016-8405
Link: http://lkml.kernel.org/r/20170105224249.GA50925@beast
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kees Cook
Reported-by: Peter Pi (@heisecode) of Trend Micro
Cc: Min Chong
Cc: Dan Carpenter
Cc: Tomi Valkeinen
Cc: Bartlomiej Zolnierkiewicz
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman

