=== Content from github.com_37806c1c_20250126_062018.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F296)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F296)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=acpica%2Facpica)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[acpica](/acpica)
/
**[acpica](/acpica/acpica)**
Public

* [Notifications](/login?return_to=%2Facpica%2Facpica) You must be signed in to change notification settings
* [Fork
  374](/login?return_to=%2Facpica%2Facpica)
* [Star
   506](/login?return_to=%2Facpica%2Facpica)

* [Code](/acpica/acpica)
* [Issues
  73](/acpica/acpica/issues)
* [Pull requests
  12](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects
  0](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

Additional navigation options

* [Code](/acpica/acpica)
* [Issues](/acpica/acpica/issues)
* [Pull requests](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# acpi: acpica: fix acpi operand cache leak in nseval.c #296

 Merged

[acpibob](/acpibob)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_operand\_cache\_memory\_leak\_in\_acpi\_ns\_evaluate](/kkamagui/acpica/tree/fix_operand_cache_memory_leak_in_acpi_ns_evaluate "kkamagui/acpica:fix_operand_cache_memory_leak_in_acpi_ns_evaluate")

Feb 28, 2018

 Merged

# [acpi: acpica: fix acpi operand cache leak in nseval.c](#top) #296

[acpibob](/acpibob)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_operand\_cache\_memory\_leak\_in\_acpi\_ns\_evaluate](/kkamagui/acpica/tree/fix_operand_cache_memory_leak_in_acpi_ns_evaluate "kkamagui/acpica:fix_operand_cache_memory_leak_in_acpi_ns_evaluate")

Feb 28, 2018

[Conversation
3](/acpica/acpica/pull/296)
[Commits
1](/acpica/acpica/pull/296/commits)
[Checks
0](/acpica/acpica/pull/296/checks)
[Files changed](/acpica/acpica/pull/296/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![kkamagui](https://avatars.githubusercontent.com/u/1183342?s=60&v=4)](/kkamagui)

Copy link

Contributor

### @kkamagui **[kkamagui](/kkamagui)** commented [Jul 19, 2017](#issue-243963397)

I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel

terminates ACPI function and continues to boot process. While kernel terminates

ACPI function, kmem\_cache\_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:

> [ 0.464168] ACPI: Added \_OSI(Module Device)
>
> [ 0.467022] ACPI: Added \_OSI(Processor Device)
>
> [ 0.469376] ACPI: Added \_OSI(3.0 \_SCP Extensions)
>
> [ 0.471647] ACPI: Added \_OSI(Processor Aggregator Device)
>
> [ 0.477997] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>
> [ 0.482706] ACPI Exception: AE\_AML\_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>
> [ 0.487503] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE\_AML\_INTERNAL (20170303/psparse-543)
>
> [ 0.492136] ACPI Error: Method parse/execution failed [\_SB.\_INI] (Node ffff88021710a618), AE\_AML\_INTERNAL (20170303/psparse-543)
>
> [ 0.497683] ACPI: Interpreter enabled
>
> [ 0.499385] ACPI: (supports S0)
>
> [ 0.501151] ACPI: Using IOAPIC for interrupt routing
>
> [ 0.503342] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>
> [ 0.506522] ACPI Exception: AE\_AML\_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>
> [ 0.510463] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE\_AML\_INTERNAL (20170303/psparse-543)
>
> [ 0.514477] ACPI Error: Method parse/execution failed [\_PIC] (Node ffff88021710ab18), AE\_AML\_INTERNAL (20170303/psparse-543)
>
> [ 0.518867] ACPI Exception: AE\_AML\_INTERNAL, Evaluating \_PIC (20170303/bus-991)
>
> [ 0.522384] kmem\_cache\_destroy Acpi-Operand: Slab cache still has objects
>
> [ 0.524597] CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 [#26](https://github.com/acpica/acpica/pull/26)
>
> [ 0.526795] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>
> [ 0.529668] Call Trace:
>
> [ 0.530811] ? dump\_stack+0x5c/0x81
>
> [ 0.532240] ? kmem\_cache\_destroy+0x1aa/0x1c0
>
> [ 0.533905] ? acpi\_os\_delete\_cache+0xa/0x10
>
> [ 0.535497] ? acpi\_ut\_delete\_caches+0x3f/0x7b
>
> [ 0.537237] ? acpi\_terminate+0xa/0x14
>
> [ 0.538701] ? acpi\_init+0x2af/0x34f
>
> [ 0.540008] ? acpi\_sleep\_proc\_init+0x27/0x27
>
> [ 0.541593] ? do\_one\_initcall+0x4e/0x1a0
>
> [ 0.543008] ? kernel\_init\_freeable+0x19e/0x21f
>
> [ 0.546202] ? rest\_init+0x80/0x80
>
> [ 0.547513] ? kernel\_init+0xa/0x100
>
> [ 0.548817] ? ret\_from\_fork+0x25/0x30
>
> [ 0.550587] vgaarb: loaded
>
> [ 0.551716] EDAC MC: Ver: 3.0.0
>
> [ 0.553744] PCI: Probing PCI hardware
>
> [ 0.555038] PCI host bridge to bus 0000:00
>
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found AcpiNsEvaluate() function

only removes Info->ReturnObject in AE\_CTRL\_RETURN\_VALUE case. But, when errors

occur, the status value is not AE\_CTRL\_RETURN\_VALUE, and Info->ReturnObject is

also not null. Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows

memory locations of kernel functions in stack dump. Some malicious users

could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han kkamagui@gmail.com

Sorry, something went wrong.

All reactions

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&v=4)](/kkamagui)

`[acpi: acpica: fix acpi operand cache leak in nseval.c](/acpica/acpica/pull/296/commits/37f2c716f2c6ab14c3ba557a539c3ee3224931b5 "acpi: acpica: fix acpi operand cache leak in nseval.c

I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.464168] ACPI: Added _OSI(Module Device)
>[    0.467022] ACPI: Added _OSI(Processor Device)
>[    0.469376] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.471647] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.477997] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>[    0.482706] ACPI Exception: AE_AML_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>[    0.487503] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.492136] ACPI Error: Method parse/execution failed [\_SB._INI] (Node ffff88021710a618), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.497683] ACPI: Interpreter enabled
>[    0.499385] ACPI: (supports S0)
>[    0.501151] ACPI: Using IOAPIC for interrupt routing
>[    0.503342] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>[    0.506522] ACPI Exception: AE_AML_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>[    0.510463] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.514477] ACPI Error: Method parse/execution failed [\_PIC] (Node ffff88021710ab18), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.518867] ACPI Exception: AE_AML_INTERNAL, Evaluating _PIC (20170303/bus-991)
>[    0.522384] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.524597] CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 #26
>[    0.526795] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.529668] Call Trace:
>[    0.530811]  ? dump_stack+0x5c/0x81
>[    0.532240]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.533905]  ? acpi_os_delete_cache+0xa/0x10
>[    0.535497]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.537237]  ? acpi_terminate+0xa/0x14
>[    0.538701]  ? acpi_init+0x2af/0x34f
>[    0.540008]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.541593]  ? do_one_initcall+0x4e/0x1a0
>[    0.543008]  ? kernel_init_freeable+0x19e/0x21f
>[    0.546202]  ? rest_init+0x80/0x80
>[    0.547513]  ? kernel_init+0xa/0x100
>[    0.548817]  ? ret_from_fork+0x25/0x30
>[    0.550587] vgaarb: loaded
>[    0.551716] EDAC MC: Ver: 3.0.0
>[    0.553744] PCI: Probing PCI hardware
>[    0.555038] PCI host bridge to bus 0000:00
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found AcpiNsEvaluate() function
only removes Info->ReturnObject in AE_CTRL_RETURN_VALUE case. But, when errors
occur, the status value is not AE_CTRL_RETURN_VALUE, and Info->ReturnObject is
also not null. Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>")`
 …

`[37f2c71](/acpica/acpica/pull/296/commits/37f2c716f2c6ab14c3ba557a539c3ee3224931b5)`

```
I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.464168] ACPI: Added _OSI(Module Device)
>[    0.467022] ACPI: Added _OSI(Processor Device)
>[    0.469376] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.471647] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.477997] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>[    0.482706] ACPI Exception: AE_AML_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>[    0.487503] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.492136] ACPI Error: Method parse/execution failed [\_SB._INI] (Node ffff88021710a618), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.497683] ACPI: Interpreter enabled
>[    0.499385] ACPI: (supports S0)
>[    0.501151] ACPI: Using IOAPIC for interrupt routing
>[    0.503342] ACPI Error: Null stack entry at ffff880215c0aad8 (20170303/exresop-174)
>[    0.506522] ACPI Exception: AE_AML_INTERNAL, While resolving operands for [OpcodeName unavailable] (20170303/dswexec-461)
>[    0.510463] ACPI Error: Method parse/execution failed [\DBG] (Node ffff88021710ab40), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.514477] ACPI Error: Method parse/execution failed [\_PIC] (Node ffff88021710ab18), AE_AML_INTERNAL (20170303/psparse-543)
>[    0.518867] ACPI Exception: AE_AML_INTERNAL, Evaluating _PIC (20170303/bus-991)
>[    0.522384] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.524597] CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 [acpica#26](https://github.com/acpica/acpica/pull/26)
>[    0.526795] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.529668] Call Trace:
>[    0.530811]  ? dump_stack+0x5c/0x81
>[    0.532240]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.533905]  ? acpi_os_delete_cache+0xa/0x10
>[    0.535497]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.537237]  ? acpi_terminate+0xa/0x14
>[    0.538701]  ? acpi_init+0x2af/0x34f
>[    0.540008]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.541593]  ? do_one_initcall+0x4e/0x1a0
>[    0.543008]  ? kernel_init_freeable+0x19e/0x21f
>[    0.546202]  ? rest_init+0x80/0x80
>[    0.547513]  ? kernel_init+0xa/0x100
>[    0.548817]  ? ret_from_fork+0x25/0x30
>[    0.550587] vgaarb: loaded
>[    0.551716] EDAC MC: Ver: 3.0.0
>[    0.553744] PCI: Probing PCI hardware
>[    0.555038] PCI host bridge to bus 0000:00
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found AcpiNsEvaluate() function
only removes Info->ReturnObject in AE_CTRL_RETURN_VALUE case. But, when errors
occur, the status value is not AE_CTRL_RETURN_VALUE, and Info->ReturnObject is
also not null. Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>
```

[![@acpibob](https://avatars.githubusercontent.com/u/966572?s=80&v=4)](/acpibob)

Copy link

Contributor

### **[acpibob](/acpibob)** commented [Nov 9, 2017](#issuecomment-343281009)

| We are still looking at these, and could use some help reproducing them. |
| --- |

All reactions

Sorry, something went wrong.

[![@ahs3](https://avatars.githubusercontent.com/u/993068?s=40&v=4)](/ahs3)
[ahs3](/ahs3)
mentioned this pull request
[Feb 6, 2018](#ref-pullrequest-243953682)

[acpi: acpica: fix acpi operand cache leak in dsutils.c
#295](/acpica/acpica/pull/295)
 Merged

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Feb 6, 2018](#issuecomment-363458310)

| I am afraid that there is nothing new.  I have been solving a critical security issue in BIOS/UEFI firmware since last December.  It seems that it is worth to be merged and after solving BIOS/UEFI issue, I will keep monitoring it. |
| --- |

All reactions

Sorry, something went wrong.

[![@acpibob](https://avatars.githubusercontent.com/u/966572?s=40&v=4)](/acpibob)
[acpibob](/acpibob)
merged commit [`6fb12fc`](/acpica/acpica/commit/6fb12fc21f662270da3bc6fc95094cc183c46e88)
into
acpica:master

[Feb 28, 2018](https://github.com/acpica/acpica/pull/296#event-1497669585)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F296)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=52&v=4)](/kkamagui) [![@acpibob](https://avatars.githubusercontent.com/u/966572?s=52&v=4)](/acpibob)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ac55e265_20250126_062021.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-8xw3-8jcr-ch76)

**CVE-2017-13693**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-8xw3-8jcr-ch76)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2017-13693](/advisories/GHSA-8xw3-8jcr-ch76)

## The acpi\_ds\_create\_operands() function in drivers/acpi...

Moderate severity

Unreviewed

Published
May 17, 2022
to the GitHub Advisory Database
•
Updated Feb 3, 2023

## Package

No package listed—
[Suggest a package](/advisories/GHSA-8xw3-8jcr-ch76/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

The acpi\_ds\_create\_operands() function in drivers/acpi/acpica/dsutils.c in the Linux kernel through 4.12.9 does not flush the operand cache and causes a kernel stack dump, which allows local users to obtain sensitive information from kernel memory and bypass the KASLR protection mechanism (in the kernel through 4.9) via a crafted ACPI table.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2017-13693>
* [acpica/acpica@987a3b5](https://github.com/acpica/acpica/commit/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)
* <https://patchwork.kernel.org/patch/9919053/>
* <http://www.securityfocus.com/bid/100502>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2017-13693)
Aug 25, 2017

Published to the GitHub Advisory Database
May 17, 2022

Last updated
Feb 3, 2023

### Severity

Moderate

5.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N

### EPSS score

0.042%

# Exploit Prediction Scoring System (EPSS)

This score estimates the probability of this vulnerability being exploited within the next 30 days.
Data provided by [FIRST](https://www.first.org/epss/user-guide).

 (5th percentile)

### Weaknesses

[CWE-200](/advisories?query=cwe%3A200)

### CVE ID

CVE-2017-13693

### GHSA ID

GHSA-8xw3-8jcr-ch76

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-8xw3-8jcr-ch76/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_add83a25_20250125_053103.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F295%2Fcommits%2F987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F295%2Fcommits%2F987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=acpica%2Facpica)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[acpica](/acpica)
/
**[acpica](/acpica/acpica)**
Public

* [Notifications](/login?return_to=%2Facpica%2Facpica) You must be signed in to change notification settings
* [Fork
  374](/login?return_to=%2Facpica%2Facpica)
* [Star
   505](/login?return_to=%2Facpica%2Facpica)

* [Code](/acpica/acpica)
* [Issues
  73](/acpica/acpica/issues)
* [Pull requests
  12](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects
  0](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

Additional navigation options

* [Code](/acpica/acpica)
* [Issues](/acpica/acpica/issues)
* [Pull requests](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)
to your account

# acpi: acpica: fix acpi operand cache leak in dsutils.c #295

 Merged

[SaketADumbre](/SaketADumbre)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_operand\_cache\_memory\_leak\_in\_acpi\_ds\_obj\_stack\_pop\_and\_delete](/kkamagui/acpica/tree/fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete "kkamagui/acpica:fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete")

Dec 12, 2024

[Conversation
17](/acpica/acpica/pull/295)
[Commits
1](/acpica/acpica/pull/295/commits)
[Checks
0](/acpica/acpica/pull/295/checks)
[Files changed](/acpica/acpica/pull/295/files)

 Merged

# [acpi: acpica: fix acpi operand cache leak in dsutils.c](#top) #295

 Changes from **all commits**

Commits

[Show all changes

1 commit](/acpica/acpica/pull/295/files)
Select commit

[`987a3b5`
acpi: acpica: fix acpi operand cache leak in dswstate.c

kkamagui Jul 19, 2017](/acpica/acpica/pull/295/commits/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)

**File filter**

### Filter by extension

Filter by extension

.c
(1)

All 1 file type selected

---

Viewed files

[Clear filters](/acpica/acpica/pull/295/commits/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

acpi: acpica: fix acpi operand cache leak in dswstate.c

```
I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.585957] ACPI: Added _OSI(Module Device)
>[    0.587218] ACPI: Added _OSI(Processor Device)
>[    0.588530] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.589790] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.591534] ACPI Error: Illegal I/O port address/length above 64K: C806E00000004002/0x2 (20170303/hwvalid-155)
>[    0.594351] ACPI Exception: AE_LIMIT, Unable to initialize fixed events (20170303/evevent-88)
>[    0.597858] ACPI: Unable to start the ACPI Interpreter
>[    0.599162] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
>[    0.601836] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.603556] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 [#26](https://github.com/acpica/acpica/pull/26)
>[    0.605159] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.609177] Call Trace:
>[    0.610063]  ? dump_stack+0x5c/0x81
>[    0.611118]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.612632]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.613906]  ? acpi_os_delete_cache+0xa/0x10
>[    0.617986]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.619293]  ? acpi_terminate+0xa/0x14
>[    0.620394]  ? acpi_init+0x2af/0x34f
>[    0.621616]  ? __class_create+0x4c/0x80
>[    0.623412]  ? video_setup+0x7f/0x7f
>[    0.624585]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.625861]  ? do_one_initcall+0x4e/0x1a0
>[    0.627513]  ? kernel_init_freeable+0x19e/0x21f
>[    0.628972]  ? rest_init+0x80/0x80
>[    0.630043]  ? kernel_init+0xa/0x100
>[    0.631084]  ? ret_from_fork+0x25/0x30
>[    0.633343] vgaarb: loaded
>[    0.635036] EDAC MC: Ver: 3.0.0
>[    0.638601] PCI: Probing PCI hardware
>[    0.639833] PCI host bridge to bus 0000:00
>[    0.641031] pci_bus 0000:00: root bus resource [io  0x0000-0xffff]
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found acpi_ds_obj_stack_pop_and_
delete() function miscalculated the top of the stack. acpi_ds_obj_stack_push()
function uses walk_state->operand_index for start position of the top, but
acpi_ds_obj_stack_pop_and_delete() function considers index 0 for it.
Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>
```

* Loading branch information

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&v=4)](/kkamagui)

[kkamagui](/acpica/acpica/commits?author=kkamagui "View all commits by kkamagui")
committed
Jul 28, 2017

commit 987a3b5cf7175916e2a4b6ea5b8e70f830dfe732

## There are no files selected for viewing

9 changes: 8 additions & 1 deletion

9
[source/components/dispatcher/dsutils.c](#diff-52bb7e4209b4b1245151967ab5c5ec80c35482a28003b4b1a36fd271ebae1e2e "source/components/dispatcher/dsutils.c")

Show comments

[View file](/kkamagui/acpica/blob/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732/source/components/dispatcher/dsutils.c)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -868,6 +868,8 @@ AcpiDsCreateOperands ( |
|  |  | ACPI\_PARSE\_OBJECT \*Arguments[ACPI\_OBJ\_NUM\_OPERANDS]; |
|  |  | UINT32 ArgCount = 0; |
|  |  | UINT32 Index = WalkState->NumOperands; |
|  |  | UINT32 PrevNumOperands = WalkState->NumOperands; |
|  |  | UINT32 NewNumOperands; |
|  |  | UINT32 i; |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -900,6 +902,7 @@ AcpiDsCreateOperands ( |
|  |  |  |
|  |  | /\* Create the interpreter arguments, in reverse order \*/ |
|  |  |  |
|  |  | NewNumOperands = Index; |
|  |  | Index--; |
|  |  | for (i = 0; i < ArgCount; i++) |
|  |  | { |
| Expand Down  Expand Up | | @@ -927,7 +930,11 @@ AcpiDsCreateOperands ( |
|  |  | \* pop everything off of the operand stack and delete those |
|  |  | \* objects |
|  |  | \*/ |
|  |  | AcpiDsObjStackPopAndDelete (ArgCount, WalkState); |
|  |  | WalkState->NumOperands = i; |
|  |  | AcpiDsObjStackPopAndDelete (NewNumOperands, WalkState); |
|  |  |  |
|  |  | /\* Restore operand count \*/ |
|  |  | WalkState->NumOperands = PrevNumOperands; |
|  |  |  |
|  |  | ACPI\_EXCEPTION ((AE\_INFO, Status, "While creating Arg %u", Index)); |
|  |  | return\_ACPI\_STATUS (Status); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_07f6590a_20250126_062014.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpi)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpi)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

![@acpi](https://avatars.githubusercontent.com/u/310096?s=64&v=4)

**acpi**
[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Facpi)

[Overview](/acpi)
[Repositories
0](/acpi?tab=repositories)
[Projects
0](/acpi?tab=projects)
[Packages
0](/acpi?tab=packages)
[Stars
0](/acpi?tab=stars)

More

* [Overview](/acpi)
* [Repositories](/acpi?tab=repositories)
* [Projects](/acpi?tab=projects)
* [Packages](/acpi?tab=packages)
* [Stars](/acpi?tab=stars)

![@acpi](https://avatars.githubusercontent.com/u/310096?s=64&v=4)

**acpi**

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Facpi)

[![View acpi's full-sized avatar](https://avatars.githubusercontent.com/u/310096?v=4)](https://avatars.githubusercontent.com/u/310096?v=4)

# acpi

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Facpi)

[3
followers](https://github.com/acpi?tab=followers) · [0
following](https://github.com/acpi?tab=following)

Block or Report

# Block or report acpi

**Block user**

Prevent this user from interacting with your repositories and sending you notifications.
Learn more about [blocking users](https://docs.github.com/articles/blocking-a-user-from-your-personal-account).

You must be logged in to block users.

Add an optional note:

Please don't include any personal information such as legal names or email addresses. Maximum 100 characters, markdown supported. This note will be visible to only you.

Block user

**Report abuse**

Contact GitHub support about this user’s behavior.
Learn more about [reporting abuse](https://docs.github.com/articles/reporting-abuse-or-spam).

[Report abuse](/contact/report-abuse?report=acpi+%28user%29)

[Overview](/acpi)
[Repositories
0](/acpi?tab=repositories)
[Projects
0](/acpi?tab=projects)
[Packages
0](/acpi?tab=packages)
[Stars
0](/acpi?tab=stars)

More

* [Overview](/acpi)
* [Repositories](/acpi?tab=repositories)
* [Projects](/acpi?tab=projects)
* [Packages](/acpi?tab=packages)
* [Stars](/acpi?tab=stars)

## Popular repositories Loading

## acpi doesn't have any public repositories yet.

Something went wrong, please refresh the page to try again.

If the problem persists, check the [GitHub status page](https://www.githubstatus.com/)
or [contact support](/contact).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_46208a5f_20250126_062016.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F278)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F278)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=acpica%2Facpica)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[acpica](/acpica)
/
**[acpica](/acpica/acpica)**
Public

* [Notifications](/login?return_to=%2Facpica%2Facpica) You must be signed in to change notification settings
* [Fork
  374](/login?return_to=%2Facpica%2Facpica)
* [Star
   506](/login?return_to=%2Facpica%2Facpica)

* [Code](/acpica/acpica)
* [Issues
  73](/acpica/acpica/issues)
* [Pull requests
  12](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects
  0](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

Additional navigation options

* [Code](/acpica/acpica)
* [Issues](/acpica/acpica/issues)
* [Pull requests](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# acpi: acpica: fix acpi parse and parseext cache leaks #278

 Merged

[SaketADumbre](/SaketADumbre)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_acpi\_parse\_and\_parseext\_leaks\_v2](/kkamagui/acpica/tree/fix_acpi_parse_and_parseext_leaks_v2 "kkamagui/acpica:fix_acpi_parse_and_parseext_leaks_v2")

Dec 12, 2024

 Merged

# [acpi: acpica: fix acpi parse and parseext cache leaks](#top) #278

[SaketADumbre](/SaketADumbre)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_acpi\_parse\_and\_parseext\_leaks\_v2](/kkamagui/acpica/tree/fix_acpi_parse_and_parseext_leaks_v2 "kkamagui/acpica:fix_acpi_parse_and_parseext_leaks_v2")

Dec 12, 2024

+16

−28

[Conversation
20](/acpica/acpica/pull/278)
[Commits
1](/acpica/acpica/pull/278/commits)
[Checks
0](/acpica/acpica/pull/278/checks)
[Files changed
1](/acpica/acpica/pull/278/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![kkamagui](https://avatars.githubusercontent.com/u/1183342?s=60&v=4)](/kkamagui)

Copy link

Contributor

### @kkamagui **[kkamagui](/kkamagui)** commented [Jun 23, 2017](#issue-238044163) • edited Loading

I'm Seunghun Han, and I work for National Security Research Institute of

South Korea.

I have been doing a research on ACPI and found an ACPI cache leak in ACPI

early abort cases.

Boot log of ACPI cache leak is as follows:

[ 0.352414] ACPI: Added \_OSI(Module Device)

[ 0.353182] ACPI: Added \_OSI(Processor Device)

[ 0.353182] ACPI: Added \_OSI(3.0 \_SCP Extensions)

[ 0.353182] ACPI: Added \_OSI(Processor Aggregator Device)

[ 0.356028] ACPI: Unable to start the ACPI Interpreter

[ 0.356799] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)

[ 0.360215] kmem\_cache\_destroy Acpi-State: Slab cache still has objects

[ 0.360648] CPU: 0 PID: 1 Comm: swapper/0 Tainted: G W

4.12.0-rc4-next-20170608+ [#10](https://github.com/acpica/acpica/pull/10)

[ 0.361273] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS

VirtualBox 12/01/2006

[ 0.361873] Call Trace:

[ 0.362243] ? dump\_stack+0x5c/0x81

[ 0.362591] ? kmem\_cache\_destroy+0x1aa/0x1c0

[ 0.362944] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.363296] ? acpi\_os\_delete\_cache+0xa/0x10

[ 0.363646] ? acpi\_ut\_delete\_caches+0x6d/0x7b

[ 0.364000] ? acpi\_terminate+0xa/0x14

[ 0.364000] ? acpi\_init+0x2af/0x34f

[ 0.364000] ? \_\_class\_create+0x4c/0x80

[ 0.364000] ? video\_setup+0x7f/0x7f

[ 0.364000] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.364000] ? do\_one\_initcall+0x4e/0x1a0

[ 0.364000] ? kernel\_init\_freeable+0x189/0x20a

[ 0.364000] ? rest\_init+0xc0/0xc0

[ 0.364000] ? kernel\_init+0xa/0x100

[ 0.364000] ? ret\_from\_fork+0x25/0x30

I analyzed this memory leak in detail. I found that “Acpi-State” cache and

“Acpi-Parse” cache were merged because the size of cache objects was same

slab cache size.

I finally found “Acpi-Parse” cache and “Acpi-ParseExt” cache were leaked

using SLAB\_NEVER\_MERGE flag in kmem\_cache\_create() function.

Real ACPI cache leak point is as follows:

[ 0.360101] ACPI: Added \_OSI(Module Device)

[ 0.360101] ACPI: Added \_OSI(Processor Device)

[ 0.360101] ACPI: Added \_OSI(3.0 \_SCP Extensions)

[ 0.361043] ACPI: Added \_OSI(Processor Aggregator Device)

[ 0.364016] ACPI: Unable to start the ACPI Interpreter

[ 0.365061] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)

[ 0.368174] kmem\_cache\_destroy Acpi-Parse: Slab cache still has objects

[ 0.369332] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G W

4.12.0-rc4-next-20170608+ [#8](https://github.com/acpica/acpica/pull/8)

[ 0.371256] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS

VirtualBox 12/01/2006

[ 0.372000] Call Trace:

[ 0.372000] ? dump\_stack+0x5c/0x81

[ 0.372000] ? kmem\_cache\_destroy+0x1aa/0x1c0

[ 0.372000] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.372000] ? acpi\_os\_delete\_cache+0xa/0x10

[ 0.372000] ? acpi\_ut\_delete\_caches+0x56/0x7b

[ 0.372000] ? acpi\_terminate+0xa/0x14

[ 0.372000] ? acpi\_init+0x2af/0x34f

[ 0.372000] ? \_\_class\_create+0x4c/0x80

[ 0.372000] ? video\_setup+0x7f/0x7f

[ 0.372000] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.372000] ? do\_one\_initcall+0x4e/0x1a0

[ 0.372000] ? kernel\_init\_freeable+0x189/0x20a

[ 0.372000] ? rest\_init+0xc0/0xc0

[ 0.372000] ? kernel\_init+0xa/0x100

[ 0.372000] ? ret\_from\_fork+0x25/0x30

[ 0.388039] kmem\_cache\_destroy Acpi-ParseExt: Slab cache still has objects

[ 0.389063] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G W

4.12.0-rc4-next-20170608+ [#8](https://github.com/acpica/acpica/pull/8)

[ 0.390557] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS

VirtualBox 12/01/2006

[ 0.392000] Call Trace:

[ 0.392000] ? dump\_stack+0x5c/0x81

[ 0.392000] ? kmem\_cache\_destroy+0x1aa/0x1c0

[ 0.392000] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.392000] ? acpi\_os\_delete\_cache+0xa/0x10

[ 0.392000] ? acpi\_ut\_delete\_caches+0x6d/0x7b

[ 0.392000] ? acpi\_terminate+0xa/0x14

[ 0.392000] ? acpi\_init+0x2af/0x34f

[ 0.392000] ? \_\_class\_create+0x4c/0x80

[ 0.392000] ? video\_setup+0x7f/0x7f

[ 0.392000] ? acpi\_sleep\_proc\_init+0x27/0x27

[ 0.392000] ? do\_one\_initcall+0x4e/0x1a0

[ 0.392000] ? kernel\_init\_freeable+0x189/0x20a

[ 0.392000] ? rest\_init+0xc0/0xc0

[ 0.392000] ? kernel\_init+0xa/0x100

[ 0.392000] ? ret\_from\_fork+0x25/0x30

When early abort is occurred due to invalid ACPI information, Linux kernel

terminates ACPI by calling acpi\_terminate() function. The function calls

acpi\_ut\_delete\_caches() function to delete local caches (acpi\_gbl\_namespace\_

cache, state\_cache, operand\_cache, ps\_node\_cache, ps\_node\_ext\_cache).

But the deletion codes in acpi\_ut\_delete\_caches() function only delete

slab caches using kmem\_cache\_destroy() function, therefore the cache

objects should be flushed before acpi\_ut\_delete\_caches() function.

"Acpi-Parse" cache and "Acpi-ParseExt" cache are used in an AML parse

function, acpi\_ps\_parse\_loop(). The function should complete all ops

using acpi\_ps\_complete\_final\_op() when an error occurs due to invalid

AML codes.

However, the current implementation of acpi\_ps\_complete\_final\_op() does not

complete all ops when it meets some errors and this cause cache leak.

This cache leak has a security threat because an old kernel (<= 4.9) shows

memory locations of kernel functions in stack dump. Some malicious users

could use this information to neutralize kernel ASLR.

To fix ACPI cache leak for enhancing security, I made a patch to complete all

ops unconditionally for acpi\_ps\_complete\_final\_op() function.

I hope that this patch improves the security of Linux kernel.

Thank you.

Signed-off-by: Seunghun Han kkamagui@gmail.com

Sorry, something went wrong.

All reactions

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)
[kkamagui](/kkamagui)
mentioned this pull request
[Jun 23, 2017](#ref-pullrequest-236618840)

[acpi: acpica: fix acpi parse and parseext cache leaks
#275](/acpica/acpica/pull/275)
 Closed

[![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=80&v=4)](/zetalog)

Copy link

Contributor

### **[zetalog](/zetalog)** commented [Jun 23, 2017](#issuecomment-310578814)

| You needn't initiate another pull request. github automatically updates your pull request when you updates your branch that generates the pull request. |
| --- |

All reactions

Sorry, something went wrong.

[![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=80&v=4)](/zetalog)

Copy link

Contributor

### **[zetalog](/zetalog)** commented [Jun 23, 2017](#issuecomment-310579254) • edited Loading

| What if you fix this in this way:  ``` diff --git a/source/components/parser/psobject.c b/source/components/parser/psobject.c index 5d59492..6f9bf23 100644 --- a/source/components/parser/psobject.c +++ b/source/components/parser/psobject.c @@ -768,7 +768,8 @@ AcpiPsCompleteFinalOp (      ACPI_PARSE_OBJECT       *Op,      ACPI_STATUS             Status)  { -    ACPI_STATUS             Status2; +    ACPI_STATUS             ReturnStatus = AE_OK; +    BOOLEAN                 Ascending = TRUE;          ACPI_FUNCTION_TRACE_PTR (PsCompleteFinalOp, WalkState); @@ -785,7 +786,7 @@ AcpiPsCompleteFinalOp (      {          if (Op)          { -            if (WalkState->AscendingCallback != NULL) +            if (Ascending && WalkState->AscendingCallback != NULL)              {                  WalkState->Op = Op;                  WalkState->OpInfo = AcpiPsGetOpcodeInfo (Op->Common.AmlOpcode); @@ -804,41 +805,28 @@ AcpiPsCompleteFinalOp (                    if (Status == AE_CTRL_TERMINATE)                  { -                    Status = AE_OK; - -                    /* Clean up */ -                    do -                    { -                        if (Op) -                        { -                            Status2 = AcpiPsCompleteThisOp (WalkState, Op); -                            if (ACPI_FAILURE (Status2)) -                            { -                                return_ACPI_STATUS (Status2); -                            } -                        } - -                        AcpiPsPopScope (&(WalkState->ParserState), &Op, -                            &WalkState->ArgTypes, &WalkState->ArgCount); - -                    } while (Op); - -                    return_ACPI_STATUS (Status); +                    Ascending = FALSE; +                    ReturnStatus = AE_CTRL_TERMINATE;                  }                    else if (ACPI_FAILURE (Status))                  {                      /* First error is most important */   -                    (void) AcpiPsCompleteThisOp (WalkState, Op); -                    return_ACPI_STATUS (Status); +                    Ascending = FALSE; +                    ReturnStatus = Status;                  }              }   -            Status2 = AcpiPsCompleteThisOp (WalkState, Op); -            if (ACPI_FAILURE (Status2)) +            Status = AcpiPsCompleteThisOp (WalkState, Op); +            if (ACPI_FAILURE (Status))              { -                return_ACPI_STATUS (Status2); +                Ascending = FALSE; +                if (ACPI_SUCCESS (ReturnStatus) || +                    ReturnStatus == AE_CTRL_TERMINATE) +                { +                    ReturnStatus = Status; +                }              }          }   @@ -847,5 +835,5 @@ AcpiPsCompleteFinalOp (        } while (Op);   -    return_ACPI_STATUS (Status); +    return_ACPI_STATUS (ReturnStatus);  }  ```  Also in your patch description, properly describes this memory leakage with a few words related to the control transfer mechanism in order to provide more comprehensive information to the reviewers. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Jun 23, 2017](#issuecomment-310592188) • edited Loading

| Hi, your solution is very clear and I agree with you.  By the way, I change some part of your code like this. In "if (Status == AE\_CTRL\_TERMINATE)" case, I change "Status = AE\_OK" to "ReturnStatus = AE\_OK". The original code wants to return AE\_OK code in AE\_CTRL\_TERMINATE case.  ``` diff --git a/source/components/parser/psobject.c b/source/components/parser/psobject.c index 5d59492..b117801 100644 --- a/source/components/parser/psobject.c +++ b/source/components/parser/psobject.c @@ -768,7 +768,8 @@ AcpiPsCompleteFinalOp (      ACPI_PARSE_OBJECT       *Op,      ACPI_STATUS             Status)  { -    ACPI_STATUS             Status2; +    ACPI_STATUS             ReturnStatus = AE_OK; +    BOOLEAN                 Ascending = TRUE;          ACPI_FUNCTION_TRACE_PTR (PsCompleteFinalOp, WalkState); @@ -785,7 +786,7 @@ AcpiPsCompleteFinalOp (      {          if (Op)          { -            if (WalkState->AscendingCallback != NULL) +            if (Ascending && WalkState->AscendingCallback != NULL)              {                  WalkState->Op = Op;                  WalkState->OpInfo = AcpiPsGetOpcodeInfo (Op->Common.AmlOpcode); @@ -804,41 +805,23 @@ AcpiPsCompleteFinalOp (                    if (Status == AE_CTRL_TERMINATE)                  { -                    Status = AE_OK; - -                    /* Clean up */ -                    do -                    { -                        if (Op) -                        { -                            Status2 = AcpiPsCompleteThisOp (WalkState, Op); -                            if (ACPI_FAILURE (Status2)) -                            { -                                return_ACPI_STATUS (Status2); -                            } -                        } - -                        AcpiPsPopScope (&(WalkState->ParserState), &Op, -                            &WalkState->ArgTypes, &WalkState->ArgCount); - -                    } while (Op); - -                    return_ACPI_STATUS (Status); +                    ReturnStatus = AE_OK; +                    Ascending = FALSE;                  }                    else if (ACPI_FAILURE (Status))                  {                      /* First error is most important */   -                    (void) AcpiPsCompleteThisOp (WalkState, Op); -                    return_ACPI_STATUS (Status); +                    ReturnStatus = Status; +                    Ascending = FALSE;                  }              }   -            Status2 = AcpiPsCompleteThisOp (WalkState, Op); -            if (ACPI_FAILURE (Status2)) +            Status = AcpiPsCompleteThisOp (WalkState, Op); +            if (ACPI_FAILURE (Status) && ACPI_SUCCESS (ReturnStatus))              { -                return_ACPI_STATUS (Status2); +                ReturnStatus = Status;              }          }   @@ -847,5 +830,5 @@ AcpiPsCompleteFinalOp (        } while (Op);   -    return_ACPI_STATUS (Status); +    return_ACPI_STATUS (ReturnStatus);  }  ```  I have tested this code work well and update new commit to this pull-request, <https://github.com/acpica/acpica/pull/278/commits>. If you are OK, would you merge this pull-request?  Thank you. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Jun 23, 2017](#issuecomment-310614306) • edited Loading

| Hi, I found some code changes after I sent a new commit.  I think that you want to return AE\_CTRL\_TERMINATE status instead of AE\_OK. So, I tested it in my machine and made a new commit for it.  Please review commits(v1 to v3) in my pull-requests. <https://github.com/acpica/acpica/pull/278/commits>.  If you have any request, please let me know.  Thank you. |
| --- |

All reactions

Sorry, something went wrong.

[![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=80&v=4)](/zetalog)

Copy link

Contributor

### **[zetalog](/zetalog)** commented [Jun 26, 2017](#issuecomment-310937943) • edited Loading

| Please rebase the branch, merge the 3 commits into 1 single commit. And use "git push --force" to update the pull request.  If you are OK, would you merge this pull-request?  I'm not sure. I cannot determine anything, I can only help to review it and provide my comments. |
| --- |

All reactions

Sorry, something went wrong.

 [![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)
[kkamagui](/kkamagui)
[force-pushed](/acpica/acpica/compare/58690ef296166655d1ddc2de44c46282df68b8a0..4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0)
the
fix\_acpi\_parse\_and\_parseext\_leaks\_v2

branch
from
[`58690ef`](/acpica/acpica/commit/58690ef296166655d1ddc2de44c46282df68b8a0) to
[`4a0243e`](/acpica/acpica/commit/4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0)  [Compare](/acpica/acpica/compare/58690ef296166655d1ddc2de44c46282df68b8a0..4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0)
[June 26, 2017 01:47](#event-1137931783)

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Jun 26, 2017](#issuecomment-310945339) • edited Loading

| Hi, Thank you for your advice.  I merged the 3 commit into 1 single commit and just pushed it to the pull-request. Please review my commit, <https://github.com/acpica/acpica/pull/278/commits>  If you have any request, please let me know.  Thank you. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Feb 6, 2018](#issuecomment-363458615)

| I am afraid that there is nothing new.  I have been solving a critical security issue in BIOS/UEFI firmware since last December.  It seems that it is worth to be merged and after solving BIOS/UEFI issue, I will keep monitoring it. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Mar 2, 2018](#issuecomment-370045246) • edited Loading

| Hi.  Finally, I made a tool which can reproduce this memory leak report. Please check my github below and your email. <https://github.com/kkamagui/acpica/tree/linux_kernel_app>  I hope that my tool helps you. If you have any further question, please let me know.  Best regards. |
| --- |

All reactions

Sorry, something went wrong.

[![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=80&u=6659dcc9a617b838a792b8b13b557b179b844bb5&v=4)](/SchmErik)

Copy link

Contributor

### **[SchmErik](/SchmErik)** commented [Apr 2, 2018](#issuecomment-378070193)

| Can you update the commit message explaining how you altered AcpiPsCompleteFinalOp instead of AcpiPsParseLoop? Thanks |
| --- |

All reactions

Sorry, something went wrong.

[![SchmErik](https://avatars.githubusercontent.com/u/11355936?s=60&v=4)](/SchmErik)

**[SchmErik](/SchmErik)**
reviewed
[Apr 3, 2018](#pullrequestreview-109031592)

 [View reviewed changes](/acpica/acpica/pull/278/files)

[source/components/parser/psobject.c](/acpica/acpica/pull/278/files#diff-b85286c845bc3c09c0140017d4ae177b1be0ff2e9ecd65dbec10d4541215e3ff)
Outdated

|  |  | @@ -768,7 +768,8 @@ AcpiPsCompleteFinalOp ( | |
| --- | --- | --- | --- |
|  |  | ACPI\_PARSE\_OBJECT \*Op, |
|  |  | ACPI\_STATUS Status) |
|  |  | { |
|  |  | ACPI\_STATUS Status2; |
|  |  | ACPI\_STATUS ReturnStatus = AE\_OK; |

Copy link

Contributor

### @SchmErik **[SchmErik](/SchmErik)** [Apr 3, 2018](#discussion_r178892105)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

We should change this to ReturnStatus = Status. This will preserve the old behavior if Op is NULL.

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @kkamagui **[kkamagui](/kkamagui)** [Apr 3, 2018](#discussion_r178899432)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

That is a good point. I will change the code and commit message. Thank you for your advice.

Sorry, something went wrong.

All reactions

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&v=4)](/kkamagui)

`[acpi: acpica: fix acpi parse and parseext cache leaks](/acpica/acpica/pull/278/commits/8829e70e1360c81e7a5a901b5d4f48330e021ea5 "acpi: acpica: fix acpi parse and parseext cache leaks

I'm Seunghun Han, and I work for National Security Research Institute of
South Korea.

I have been doing a research on ACPI and found an ACPI cache leak in ACPI
early abort cases.

Boot log of ACPI cache leak is as follows:
[    0.352414] ACPI: Added _OSI(Module Device)
[    0.353182] ACPI: Added _OSI(Processor Device)
[    0.353182] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.353182] ACPI: Added _OSI(Processor Aggregator Device)
[    0.356028] ACPI: Unable to start the ACPI Interpreter
[    0.356799] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
[    0.360215] kmem_cache_destroy Acpi-State: Slab cache still has objects
[    0.360648] CPU: 0 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ #10
[    0.361273] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.361873] Call Trace:
[    0.362243]  ? dump_stack+0x5c/0x81
[    0.362591]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.362944]  ? acpi_sleep_proc_init+0x27/0x27
[    0.363296]  ? acpi_os_delete_cache+0xa/0x10
[    0.363646]  ? acpi_ut_delete_caches+0x6d/0x7b
[    0.364000]  ? acpi_terminate+0xa/0x14
[    0.364000]  ? acpi_init+0x2af/0x34f
[    0.364000]  ? __class_create+0x4c/0x80
[    0.364000]  ? video_setup+0x7f/0x7f
[    0.364000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.364000]  ? do_one_initcall+0x4e/0x1a0
[    0.364000]  ? kernel_init_freeable+0x189/0x20a
[    0.364000]  ? rest_init+0xc0/0xc0
[    0.364000]  ? kernel_init+0xa/0x100
[    0.364000]  ? ret_from_fork+0x25/0x30

I analyzed this memory leak in detail. I found that “Acpi-State” cache and
“Acpi-Parse” cache were merged because the size of cache objects was same
slab cache size.

I finally found “Acpi-Parse” cache and “Acpi-ParseExt” cache were leaked
using SLAB_NEVER_MERGE flag in kmem_cache_create() function.

Real ACPI cache leak point is as follows:
[    0.360101] ACPI: Added _OSI(Module Device)
[    0.360101] ACPI: Added _OSI(Processor Device)
[    0.360101] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.361043] ACPI: Added _OSI(Processor Aggregator Device)
[    0.364016] ACPI: Unable to start the ACPI Interpreter
[    0.365061] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
[    0.368174] kmem_cache_destroy Acpi-Parse: Slab cache still has objects
[    0.369332] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ #8
[    0.371256] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.372000] Call Trace:
[    0.372000]  ? dump_stack+0x5c/0x81
[    0.372000]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.372000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.372000]  ? acpi_os_delete_cache+0xa/0x10
[    0.372000]  ? acpi_ut_delete_caches+0x56/0x7b
[    0.372000]  ? acpi_terminate+0xa/0x14
[    0.372000]  ? acpi_init+0x2af/0x34f
[    0.372000]  ? __class_create+0x4c/0x80
[    0.372000]  ? video_setup+0x7f/0x7f
[    0.372000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.372000]  ? do_one_initcall+0x4e/0x1a0
[    0.372000]  ? kernel_init_freeable+0x189/0x20a
[    0.372000]  ? rest_init+0xc0/0xc0
[    0.372000]  ? kernel_init+0xa/0x100
[    0.372000]  ? ret_from_fork+0x25/0x30
[    0.388039] kmem_cache_destroy Acpi-ParseExt: Slab cache still has objects
[    0.389063] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ #8
[    0.390557] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.392000] Call Trace:
[    0.392000]  ? dump_stack+0x5c/0x81
[    0.392000]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.392000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.392000]  ? acpi_os_delete_cache+0xa/0x10
[    0.392000]  ? acpi_ut_delete_caches+0x6d/0x7b
[    0.392000]  ? acpi_terminate+0xa/0x14
[    0.392000]  ? acpi_init+0x2af/0x34f
[    0.392000]  ? __class_create+0x4c/0x80
[    0.392000]  ? video_setup+0x7f/0x7f
[    0.392000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.392000]  ? do_one_initcall+0x4e/0x1a0
[    0.392000]  ? kernel_init_freeable+0x189/0x20a
[    0.392000]  ? rest_init+0xc0/0xc0
[    0.392000]  ? kernel_init+0xa/0x100
[    0.392000]  ? ret_from_fork+0x25/0x30

When early abort is occurred due to invalid ACPI information, Linux kernel
terminates ACPI by calling acpi_terminate() function. The function calls
acpi_ut_delete_caches() function to delete local caches (acpi_gbl_namespace_
cache, state_cache, operand_cache, ps_node_cache, ps_node_ext_cache).

But the deletion codes in acpi_ut_delete_caches() function only delete
slab caches using kmem_cache_destroy() function, therefore the cache
objects should be flushed before acpi_ut_delete_caches() function.

\"Acpi-Parse\" cache and \"Acpi-ParseExt\" cache are used in an AML parse
function, acpi_ps_parse_loop(). The function should complete all ops
using acpi_ps_complete_final_op() when an error occurs due to invalid
AML codes.
However, the current implementation of acpi_ps_complete_final_op() does not
complete all ops when it meets some errors and this cause cache leak.

This cache leak has a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

To fix ACPI cache leak for enhancing security, I made a patch to complete all
ops unconditionally for acpi_ps_complete_final_op() function.

I hope that this patch improves the security of Linux kernel.

Thank you.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>")`
 …

`[8829e70](/acpica/acpica/pull/278/commits/8829e70e1360c81e7a5a901b5d4f48330e021ea5)`

```
I'm Seunghun Han, and I work for National Security Research Institute of
South Korea.

I have been doing a research on ACPI and found an ACPI cache leak in ACPI
early abort cases.

Boot log of ACPI cache leak is as follows:
[    0.352414] ACPI: Added _OSI(Module Device)
[    0.353182] ACPI: Added _OSI(Processor Device)
[    0.353182] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.353182] ACPI: Added _OSI(Processor Aggregator Device)
[    0.356028] ACPI: Unable to start the ACPI Interpreter
[    0.356799] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
[    0.360215] kmem_cache_destroy Acpi-State: Slab cache still has objects
[    0.360648] CPU: 0 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ [acpica#10](https://github.com/acpica/acpica/pull/10)
[    0.361273] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.361873] Call Trace:
[    0.362243]  ? dump_stack+0x5c/0x81
[    0.362591]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.362944]  ? acpi_sleep_proc_init+0x27/0x27
[    0.363296]  ? acpi_os_delete_cache+0xa/0x10
[    0.363646]  ? acpi_ut_delete_caches+0x6d/0x7b
[    0.364000]  ? acpi_terminate+0xa/0x14
[    0.364000]  ? acpi_init+0x2af/0x34f
[    0.364000]  ? __class_create+0x4c/0x80
[    0.364000]  ? video_setup+0x7f/0x7f
[    0.364000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.364000]  ? do_one_initcall+0x4e/0x1a0
[    0.364000]  ? kernel_init_freeable+0x189/0x20a
[    0.364000]  ? rest_init+0xc0/0xc0
[    0.364000]  ? kernel_init+0xa/0x100
[    0.364000]  ? ret_from_fork+0x25/0x30

I analyzed this memory leak in detail. I found that “Acpi-State” cache and
“Acpi-Parse” cache were merged because the size of cache objects was same
slab cache size.

I finally found “Acpi-Parse” cache and “Acpi-ParseExt” cache were leaked
using SLAB_NEVER_MERGE flag in kmem_cache_create() function.

Real ACPI cache leak point is as follows:
[    0.360101] ACPI: Added _OSI(Module Device)
[    0.360101] ACPI: Added _OSI(Processor Device)
[    0.360101] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.361043] ACPI: Added _OSI(Processor Aggregator Device)
[    0.364016] ACPI: Unable to start the ACPI Interpreter
[    0.365061] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
[    0.368174] kmem_cache_destroy Acpi-Parse: Slab cache still has objects
[    0.369332] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ [acpica#8](https://github.com/acpica/acpica/pull/8)
[    0.371256] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.372000] Call Trace:
[    0.372000]  ? dump_stack+0x5c/0x81
[    0.372000]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.372000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.372000]  ? acpi_os_delete_cache+0xa/0x10
[    0.372000]  ? acpi_ut_delete_caches+0x56/0x7b
[    0.372000]  ? acpi_terminate+0xa/0x14
[    0.372000]  ? acpi_init+0x2af/0x34f
[    0.372000]  ? __class_create+0x4c/0x80
[    0.372000]  ? video_setup+0x7f/0x7f
[    0.372000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.372000]  ? do_one_initcall+0x4e/0x1a0
[    0.372000]  ? kernel_init_freeable+0x189/0x20a
[    0.372000]  ? rest_init+0xc0/0xc0
[    0.372000]  ? kernel_init+0xa/0x100
[    0.372000]  ? ret_from_fork+0x25/0x30
[    0.388039] kmem_cache_destroy Acpi-ParseExt: Slab cache still has objects
[    0.389063] CPU: 1 PID: 1 Comm: swapper/0 Tainted: G        W
4.12.0-rc4-next-20170608+ [acpica#8](https://github.com/acpica/acpica/pull/8)
[    0.390557] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS
VirtualBox 12/01/2006
[    0.392000] Call Trace:
[    0.392000]  ? dump_stack+0x5c/0x81
[    0.392000]  ? kmem_cache_destroy+0x1aa/0x1c0
[    0.392000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.392000]  ? acpi_os_delete_cache+0xa/0x10
[    0.392000]  ? acpi_ut_delete_caches+0x6d/0x7b
[    0.392000]  ? acpi_terminate+0xa/0x14
[    0.392000]  ? acpi_init+0x2af/0x34f
[    0.392000]  ? __class_create+0x4c/0x80
[    0.392000]  ? video_setup+0x7f/0x7f
[    0.392000]  ? acpi_sleep_proc_init+0x27/0x27
[    0.392000]  ? do_one_initcall+0x4e/0x1a0
[    0.392000]  ? kernel_init_freeable+0x189/0x20a
[    0.392000]  ? rest_init+0xc0/0xc0
[    0.392000]  ? kernel_init+0xa/0x100
[    0.392000]  ? ret_from_fork+0x25/0x30

When early abort is occurred due to invalid ACPI information, Linux kernel
terminates ACPI by calling acpi_terminate() function. The function calls
acpi_ut_delete_caches() function to delete local caches (acpi_gbl_namespace_
cache, state_cache, operand_cache, ps_node_cache, ps_node_ext_cache).

But the deletion codes in acpi_ut_delete_caches() function only delete
slab caches using kmem_cache_destroy() function, therefore the cache
objects should be flushed before acpi_ut_delete_caches() function.

"Acpi-Parse" cache and "Acpi-ParseExt" cache are used in an AML parse
function, acpi_ps_parse_loop(). The function should complete all ops
using acpi_ps_complete_final_op() when an error occurs due to invalid
AML codes.
However, the current implementation of acpi_ps_complete_final_op() does not
complete all ops when it meets some errors and this cause cache leak.

This cache leak has a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

To fix ACPI cache leak for enhancing security, I made a patch to complete all
ops unconditionally for acpi_ps_complete_final_op() function.

I hope that this patch improves the security of Linux kernel.

Thank you.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>
```

 [![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)
[kkamagui](/kkamagui)
[force-pushed](/acpica/acpica/compare/4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0..8829e70e1360c81e7a5a901b5d4f48330e021ea5)
the
fix\_acpi\_parse\_and\_parseext\_leaks\_v2

branch
from
[`4a0243e`](/acpica/acpica/commit/4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0) to
[`8829e70`](/acpica/acpica/commit/8829e70e1360c81e7a5a901b5d4f48330e021ea5)  [Compare](/acpica/acpica/compare/4a0243ecb4c94e2d73510d096c5ea4d0711fc6c0..8829e70e1360c81e7a5a901b5d4f48330e021ea5)
[April 3, 2018 18:00](#event-1554740017)

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Apr 3, 2018](#issuecomment-378343173)

| I updated my commit message and changed the code according to [@SchmErik](https://github.com/SchmErik) 's review comment. Please check the commit message and the code. Thank you. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Apr 4, 2018](#issuecomment-378441961) via email

| Hi Erik, I changed commit message and the code according to your advice. Please check it. Best regards. Seunghun 2018년 4월 4일 (수) 오전 1:54, Erik Schmauss <notifications@github.com>님이 작성: …  \*\*\*@\*\*\*.\*\*\*\* commented on this pull request. ------------------------------ In source/components/parser/psobject.c <[#278 (comment)](https://github.com/acpica/acpica/pull/278#discussion_r178892105)>: > @@ -768,7 +768,8 @@ AcpiPsCompleteFinalOp ( ACPI\_PARSE\_OBJECT \*Op, ACPI\_STATUS Status) { - ACPI\_STATUS Status2; + ACPI\_STATUS ReturnStatus = AE\_OK; We should change this to ReturnStatus = Status. This will preserve the old behavior if Op is NULL. — You are receiving this because you were mentioned. Reply to this email directly, view it on GitHub <[#278 (review)](https://github.com/acpica/acpica/pull/278#pullrequestreview-109031592)>, or mute the thread <<https://github.com/notifications/unsubscribe-auth/ABIObiGJDIkdI8DC8CLo_FPKqH48uhH0ks5tk6lIgaJpZM4ODJir>> . |
| --- |

All reactions

Sorry, something went wrong.

[![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=80&u=6659dcc9a617b838a792b8b13b557b179b844bb5&v=4)](/SchmErik)

Copy link

Contributor

### **[SchmErik](/SchmErik)** commented [Apr 9, 2018](#issuecomment-379913150) • edited Loading

| Hi, I decided to basically rebased your linuxkernel app to the latest head of the APCICA and I could not reproduce this. The linuxkernel app branch that you have is based on an ACPICA version that does not have one of the major features that we added, mainly parsing the table as a method. This is found in this commit here: [8faf6fc](https://github.com/acpica/acpica/commit/8faf6fca445eb7219963d80543fb802302a7a8c7) If we parse the tables with the very latest commit in ACPICA, I don't see this memory leak... So it doesn't seem like this commit is useful because the memory leak is fixed. This commit is in Linus' tree so you could test the latest to see if it contains memory leaks.. Maybe we should just back-port these commits to older versions. It would be nice for older kernels to have this commit anyway. What do you think? |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Apr 10, 2018](#issuecomment-379986788)

| Hi, Erik. Thank you for your reply.  I also ported my linuxkernel tool to the latest version of ACPICA and I finally found the reason why you could not reproduce the bug.  The major difference is AcpiGbl\_ParseTableAsTermList flag of acpifx.h file in [8faf6fc](https://github.com/acpica/acpica/commit/8faf6fca445eb7219963d80543fb802302a7a8c7) commit.  If the flag is TRUE, AcpiNsParseTable() function executes AcpiNsExecuteTable() instead of AcpiNsOneCompleteParse() function. So I set the flag to FALSE, I could reproduce the memory leak.  It seems that the library user still can set the flag to FALSE (like Linux kernel under v4.16.1) and AcpiPsCompleteFinalOp() function still has the bug. Therefore if we don't fix this bug, someday it will come out another way.  In my opinion, we would better to fix the bug in AcpiPsCompleteFinalOp(). How about you?  Thank you. |
| --- |

All reactions

Sorry, something went wrong.

[![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=80&u=6659dcc9a617b838a792b8b13b557b179b844bb5&v=4)](/SchmErik)

Copy link

Contributor

### **[SchmErik](/SchmErik)** commented [Apr 10, 2018](#issuecomment-380177948)

| Hi Seunghun,  You make a good point. A user could set ParseTableAsTermList in the current upstream to reproduce this memory leak. Our long term plan is to get rid of ParseTableAsTermList flag after a few release cycles and make the parser behavior call AcpiNsExecuteTable() as the only option. [@acpibob](https://github.com/acpibob) what do you think? |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 9, 2024](#issuecomment-2529386389)

| Is there still any community interest in merging this PR? I have no objections to merging it if there is any interest! |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)
[SaketADumbre](/SaketADumbre)
mentioned this pull request
[Dec 11, 2024](#ref-pullrequest-243953682)

[acpi: acpica: fix acpi operand cache leak in dsutils.c
#295](/acpica/acpica/pull/295)
 Merged

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [Dec 12, 2024](#issuecomment-2537850523)

| I am simply google and found that [CVE-2017-13694](https://github.com/advisories/GHSA-cc4x-9vpx-cphw "CVE-2017-13694") relates to this patch . Just put a comment here for note. |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 12, 2024](#issuecomment-2539420949)

| Thanks a lot [@joeyli](https://github.com/joeyli) and [@kkamagui](https://github.com/kkamagui) for the contributions! |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)
[SaketADumbre](/SaketADumbre)
merged commit [`828a390`](/acpica/acpica/commit/828a3909cb6c7917fd26cd73b517bc05748968d3)
into
acpica:master

[Dec 12, 2024](https://github.com/acpica/acpica/pull/278#event-15637479496)

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)
[SaketADumbre](/SaketADumbre)
mentioned this pull request
[Dec 12, 2024](#ref-pullrequest-2736378937)

[[GHSA-cc4x-9vpx-cphw] The acpi\_ps\_complete\_final\_op() function in drivers/acpi...
github/advisory-database#5082](/github/advisory-database/pull/5082)
 Closed

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [Dec 13, 2024](#issuecomment-2540319521)

| Thanks for Saket's help! |
| --- |

 ❤️
1
 SaketADumbre reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F278)

Reviewers

[![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=40&v=4)](/SchmErik) [SchmErik](/SchmErik)

SchmErik left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

5 participants

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=52&v=4)](/kkamagui) [![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=52&v=4)](/zetalog) [![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=52&v=4)](/SchmErik) [![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=52&v=4)](/SaketADumbre) [![@joeyli](https://avatars.githubusercontent.com/u/124434?s=52&v=4)](/joeyli)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_2eaeecab_20250126_062023.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F295)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F295)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=acpica%2Facpica)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[acpica](/acpica)
/
**[acpica](/acpica/acpica)**
Public

* [Notifications](/login?return_to=%2Facpica%2Facpica) You must be signed in to change notification settings
* [Fork
  374](/login?return_to=%2Facpica%2Facpica)
* [Star
   506](/login?return_to=%2Facpica%2Facpica)

* [Code](/acpica/acpica)
* [Issues
  73](/acpica/acpica/issues)
* [Pull requests
  12](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects
  0](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

Additional navigation options

* [Code](/acpica/acpica)
* [Issues](/acpica/acpica/issues)
* [Pull requests](/acpica/acpica/pulls)
* [Discussions](/acpica/acpica/discussions)
* [Actions](/acpica/acpica/actions)
* [Projects](/acpica/acpica/projects)
* [Wiki](/acpica/acpica/wiki)
* [Security](/acpica/acpica/security)
* [Insights](/acpica/acpica/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Facpica%2Facpica%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# acpi: acpica: fix acpi operand cache leak in dsutils.c #295

 Merged

[SaketADumbre](/SaketADumbre)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_operand\_cache\_memory\_leak\_in\_acpi\_ds\_obj\_stack\_pop\_and\_delete](/kkamagui/acpica/tree/fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete "kkamagui/acpica:fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete")

Dec 12, 2024

 Merged

# [acpi: acpica: fix acpi operand cache leak in dsutils.c](#top) #295

[SaketADumbre](/SaketADumbre)
merged 1 commit into
[acpica:master](/acpica/acpica/tree/master "acpica/acpica:master")
from
[kkamagui:fix\_operand\_cache\_memory\_leak\_in\_acpi\_ds\_obj\_stack\_pop\_and\_delete](/kkamagui/acpica/tree/fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete "kkamagui/acpica:fix_operand_cache_memory_leak_in_acpi_ds_obj_stack_pop_and_delete")

Dec 12, 2024

[Conversation
17](/acpica/acpica/pull/295)
[Commits
1](/acpica/acpica/pull/295/commits)
[Checks
0](/acpica/acpica/pull/295/checks)
[Files changed](/acpica/acpica/pull/295/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![kkamagui](https://avatars.githubusercontent.com/u/1183342?s=60&v=4)](/kkamagui)

Copy link

Contributor

### @kkamagui **[kkamagui](/kkamagui)** commented [Jul 19, 2017](#issue-243953682)

I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel

terminates ACPI function and continues to boot process. While kernel terminates

ACPI function, kmem\_cache\_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:

> [ 0.585957] ACPI: Added \_OSI(Module Device)
>
> [ 0.587218] ACPI: Added \_OSI(Processor Device)
>
> [ 0.588530] ACPI: Added \_OSI(3.0 \_SCP Extensions)
>
> [ 0.589790] ACPI: Added \_OSI(Processor Aggregator Device)
>
> [ 0.591534] ACPI Error: Illegal I/O port address/length above 64K: C806E00000004002/0x2 (20170303/hwvalid-155)
>
> [ 0.594351] ACPI Exception: AE\_LIMIT, Unable to initialize fixed events (20170303/evevent-88)
>
> [ 0.597858] ACPI: Unable to start the ACPI Interpreter
>
> [ 0.599162] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
>
> [ 0.601836] kmem\_cache\_destroy Acpi-Operand: Slab cache still has objects
>
> [ 0.603556] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 [#26](https://github.com/acpica/acpica/pull/26)
>
> [ 0.605159] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>
> [ 0.609177] Call Trace:
>
> [ 0.610063] ? dump\_stack+0x5c/0x81
>
> [ 0.611118] ? kmem\_cache\_destroy+0x1aa/0x1c0
>
> [ 0.612632] ? acpi\_sleep\_proc\_init+0x27/0x27
>
> [ 0.613906] ? acpi\_os\_delete\_cache+0xa/0x10
>
> [ 0.617986] ? acpi\_ut\_delete\_caches+0x3f/0x7b
>
> [ 0.619293] ? acpi\_terminate+0xa/0x14
>
> [ 0.620394] ? acpi\_init+0x2af/0x34f
>
> [ 0.621616] ? \_\_class\_create+0x4c/0x80
>
> [ 0.623412] ? video\_setup+0x7f/0x7f
>
> [ 0.624585] ? acpi\_sleep\_proc\_init+0x27/0x27
>
> [ 0.625861] ? do\_one\_initcall+0x4e/0x1a0
>
> [ 0.627513] ? kernel\_init\_freeable+0x19e/0x21f
>
> [ 0.628972] ? rest\_init+0x80/0x80
>
> [ 0.630043] ? kernel\_init+0xa/0x100
>
> [ 0.631084] ? ret\_from\_fork+0x25/0x30
>
> [ 0.633343] vgaarb: loaded
>
> [ 0.635036] EDAC MC: Ver: 3.0.0
>
> [ 0.638601] PCI: Probing PCI hardware
>
> [ 0.639833] PCI host bridge to bus 0000:00
>
> [ 0.641031] pci\_bus 0000:00: root bus resource [io 0x0000-0xffff]
>
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found acpi\_ds\_obj\_stack\_pop\_and\_

delete() function miscalculated the top of the stack. acpi\_ds\_obj\_stack\_push()

function uses walk\_state->operand\_index for start position of the top, but

acpi\_ds\_obj\_stack\_pop\_and\_delete() function considers index 0 for it.

Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows

memory locations of kernel functions in stack dump. Some malicious users

could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han kkamagui@gmail.com

Sorry, something went wrong.

 👍
1
 kkh0607 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=80&v=4)](/zetalog)

Copy link

Contributor

### **[zetalog](/zetalog)** commented [Jul 28, 2017](#issuecomment-318594397)

| This looks like a slight issue that can be detected by coverity tools.  It looks AcpiDsObjStackPopAndDelete() only wants to revert what has been done in AcpiDsCreateOperands(). So can you fix the caller - AcpiDsCreateOperands()? |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&v=4)](/kkamagui)

`[acpi: acpica: fix acpi operand cache leak in dswstate.c](/acpica/acpica/pull/295/commits/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732 "acpi: acpica: fix acpi operand cache leak in dswstate.c

I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.585957] ACPI: Added _OSI(Module Device)
>[    0.587218] ACPI: Added _OSI(Processor Device)
>[    0.588530] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.589790] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.591534] ACPI Error: Illegal I/O port address/length above 64K: C806E00000004002/0x2 (20170303/hwvalid-155)
>[    0.594351] ACPI Exception: AE_LIMIT, Unable to initialize fixed events (20170303/evevent-88)
>[    0.597858] ACPI: Unable to start the ACPI Interpreter
>[    0.599162] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
>[    0.601836] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.603556] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 #26
>[    0.605159] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.609177] Call Trace:
>[    0.610063]  ? dump_stack+0x5c/0x81
>[    0.611118]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.612632]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.613906]  ? acpi_os_delete_cache+0xa/0x10
>[    0.617986]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.619293]  ? acpi_terminate+0xa/0x14
>[    0.620394]  ? acpi_init+0x2af/0x34f
>[    0.621616]  ? __class_create+0x4c/0x80
>[    0.623412]  ? video_setup+0x7f/0x7f
>[    0.624585]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.625861]  ? do_one_initcall+0x4e/0x1a0
>[    0.627513]  ? kernel_init_freeable+0x19e/0x21f
>[    0.628972]  ? rest_init+0x80/0x80
>[    0.630043]  ? kernel_init+0xa/0x100
>[    0.631084]  ? ret_from_fork+0x25/0x30
>[    0.633343] vgaarb: loaded
>[    0.635036] EDAC MC: Ver: 3.0.0
>[    0.638601] PCI: Probing PCI hardware
>[    0.639833] PCI host bridge to bus 0000:00
>[    0.641031] pci_bus 0000:00: root bus resource [io  0x0000-0xffff]
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found acpi_ds_obj_stack_pop_and_
delete() function miscalculated the top of the stack. acpi_ds_obj_stack_push()
function uses walk_state->operand_index for start position of the top, but
acpi_ds_obj_stack_pop_and_delete() function considers index 0 for it.
Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>")`
 …

`[987a3b5](/acpica/acpica/pull/295/commits/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)`

```
I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination occurs due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.585957] ACPI: Added _OSI(Module Device)
>[    0.587218] ACPI: Added _OSI(Processor Device)
>[    0.588530] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.589790] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.591534] ACPI Error: Illegal I/O port address/length above 64K: C806E00000004002/0x2 (20170303/hwvalid-155)
>[    0.594351] ACPI Exception: AE_LIMIT, Unable to initialize fixed events (20170303/evevent-88)
>[    0.597858] ACPI: Unable to start the ACPI Interpreter
>[    0.599162] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
>[    0.601836] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.603556] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 [acpica#26](https://github.com/acpica/acpica/pull/26)
>[    0.605159] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.609177] Call Trace:
>[    0.610063]  ? dump_stack+0x5c/0x81
>[    0.611118]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.612632]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.613906]  ? acpi_os_delete_cache+0xa/0x10
>[    0.617986]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.619293]  ? acpi_terminate+0xa/0x14
>[    0.620394]  ? acpi_init+0x2af/0x34f
>[    0.621616]  ? __class_create+0x4c/0x80
>[    0.623412]  ? video_setup+0x7f/0x7f
>[    0.624585]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.625861]  ? do_one_initcall+0x4e/0x1a0
>[    0.627513]  ? kernel_init_freeable+0x19e/0x21f
>[    0.628972]  ? rest_init+0x80/0x80
>[    0.630043]  ? kernel_init+0xa/0x100
>[    0.631084]  ? ret_from_fork+0x25/0x30
>[    0.633343] vgaarb: loaded
>[    0.635036] EDAC MC: Ver: 3.0.0
>[    0.638601] PCI: Probing PCI hardware
>[    0.639833] PCI host bridge to bus 0000:00
>[    0.641031] pci_bus 0000:00: root bus resource [io  0x0000-0xffff]
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found acpi_ds_obj_stack_pop_and_
delete() function miscalculated the top of the stack. acpi_ds_obj_stack_push()
function uses walk_state->operand_index for start position of the top, but
acpi_ds_obj_stack_pop_and_delete() function considers index 0 for it.
Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.

Signed-off-by: Seunghun Han <kkamagui@gmail.com>
```

 [![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)
[kkamagui](/kkamagui)
[force-pushed](/acpica/acpica/compare/726d43a5840e0b955f6c4042dc9b6bc521a31783..987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)
the
fix\_operand\_cache\_memory\_leak\_in\_acpi\_ds\_obj\_stack\_pop\_and\_delete

branch
from
[`726d43a`](/acpica/acpica/commit/726d43a5840e0b955f6c4042dc9b6bc521a31783) to
[`987a3b5`](/acpica/acpica/commit/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)  [Compare](/acpica/acpica/compare/726d43a5840e0b955f6c4042dc9b6bc521a31783..987a3b5cf7175916e2a4b6ea5b8e70f830dfe732)
[July 28, 2017 10:32](#event-1183297349)

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Jul 28, 2017](#issuecomment-318620279)

| Hello, Lv.  According to your comment, I changed the caller, AcpiDsCreateOperands() and pushed again. Please check my revised commit, [987a3b5](https://github.com/acpica/acpica/commit/987a3b5cf7175916e2a4b6ea5b8e70f830dfe732) .  I tested it in my PC, and confirmed it works fine. If you have any request, please let me know.  Best regards. Seunghun. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=40&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)
[kkamagui](/kkamagui)
changed the title
~~acpi: acpica: fix acpi operand cache leak in dswstate.c~~
acpi: acpica: fix acpi operand cache leak in dsutils.c
[Aug 24, 2017](#event-1219096553)

[![@acpibob](https://avatars.githubusercontent.com/u/966572?s=80&v=4)](/acpibob)

Copy link

Contributor

### **[acpibob](/acpibob)** commented [Sep 7, 2017](#issuecomment-327932812)

| I'm wondering what exactly you mean by "malicious ACPI table" |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Sep 9, 2017](#issuecomment-328251357)

| Hello, Robert.  I have been researching on ACPI table and I assume that some malicious users can change the table using initrd.gz, firmware flashing, etc.  As you know, these attacks are well-known in security and I have been analyzing the effect of those attacks.  Best regards.  Seunghun. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Nov 3, 2017](#issuecomment-341793187)

| Hello, [@timofonic](https://github.com/timofonic) .  I consider that ACPI table tampering by a malicious user and ACPI table tampering by a malicious user are the same. Because they can make memory information leaks and these vulnerabilities could neutralize security features in the system.  I have been cooperating with Intel for several months and I hope this patch is merged soon.  Best regards.  Seunghun. |
| --- |

All reactions

Sorry, something went wrong.

[![@ahs3](https://avatars.githubusercontent.com/u/993068?s=80&u=45e2d049c485ef9678b7a121b4fee4bc379a7aec&v=4)](/ahs3)

Copy link

Contributor

### **[ahs3](/ahs3)** commented [Feb 6, 2018](#issuecomment-363268051)

| Is there any probability of this patch being merged? It does appear to resolve a known, public security issue ([CVE-2017-13693](https://github.com/advisories/GHSA-8xw3-8jcr-ch76 "CVE-2017-13693")) yet it has stalled. Two other pull requests ([#295](https://github.com/acpica/acpica/pull/295) and [#296](https://github.com/acpica/acpica/pull/296)) are in exactly the same situation.  If these patches are not to be applied as they are, what would be needed to correct them?  Thanks. |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Feb 6, 2018](#issuecomment-363462381) via email

| Hello, Timofonic. ACPI table has essential information and executable code, ASL. So security researchers and attackers are interested in ACPI table and use it to do something malicious. This is ACPI tampering. If you have any request, please let me know. Best regards. Seunghun. 2018. 2. 6. 오후 11:58에 "Timofonic" <notifications@github.com>님이 작성: [@kkamagui](https://github.com/kkamagui) <<https://github.com/kkamagui>> I'm sorry. It seems I didn't understand the mean of this fix. What do you mean by "ACPI table tampering"? Excuse me for my ignorance! [@ahs3](https://github.com/ahs3) <<https://github.com/ahs3>> It would be nice if it fixed security issues, indeed. [@acpibob](https://github.com/acpibob) <<https://github.com/acpibob>> ACPI Master, any news? ;) — You are receiving this because you were mentioned. Reply to this email directly, view it on GitHub <[#295 (comment)](https://github.com/acpica/acpica/pull/295#issuecomment-363447801)>, or mute the thread <<https://github.com/notifications/unsubscribe-auth/ABIObnKj2TgwpzagXx4ZBh1a46nstlGeks5tSGicgaJpZM4OcXF0>> . |
| --- |

All reactions

Sorry, something went wrong.

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=80&u=c7e2122f5494d1f157f5e0dc8291bb42e61f7f8c&v=4)](/kkamagui)

Copy link

Contributor

Author

### **[kkamagui](/kkamagui)** commented [Mar 2, 2018](#issuecomment-370045697)

| Hi.  Finally, I made a tool which can reproduce this memory leak report. Please check my github below and your email. <https://github.com/kkamagui/acpica/tree/linux_kernel_app>  I hope that my tool helps you. If you have any further question, please let me know.  Best regards. |
| --- |

All reactions

Sorry, something went wrong.

[![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=80&u=6659dcc9a617b838a792b8b13b557b179b844bb5&v=4)](/SchmErik)

Copy link

Contributor

### **[SchmErik](/SchmErik)** commented [Apr 2, 2018](#issuecomment-378052148)

| Looks good to me |
| --- |

All reactions

Sorry, something went wrong.

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [May 31, 2022](#issuecomment-1141731267)

| Hi all,  Why this patch still not be merged to mainline. Does there have any concern of this patch?  Thanks! |
| --- |

All reactions

Sorry, something went wrong.

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [Jun 4, 2022](#issuecomment-1146483257)

| I have filed a acpica bug against this [CVE-2017-13693](https://github.com/advisories/GHSA-8xw3-8jcr-ch76 "CVE-2017-13693") patch: <https://bugs.acpica.org/show_bug.cgi?id=1549>  email: [https://lists.acpica.org/hyperkitty/list/devel@acpica.org/thread/CZX3DW4ZFEDCU76FCMGGWOPCZGDQSTBQ/](https://lists.acpica.org/hyperkitty/list/devel%40acpica.org/thread/CZX3DW4ZFEDCU76FCMGGWOPCZGDQSTBQ/) |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 9, 2024](#issuecomment-2529372839)

| Is there still any interest in this patch? I can take it and merge it if that is what the majority prefers, after all the CVE exploits are no ordinary bugs to be ignored..... |
| --- |

All reactions

Sorry, something went wrong.

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [Dec 10, 2024](#issuecomment-2530602070)

| Is there still any interest in this patch? I can take it and merge it if that is what the majority prefers, after all the CVE exploits are no ordinary bugs to be ignored.....  It will be good if you can take the patch. Per my understood, this patch can fix [CVE-2017-13693](https://github.com/advisories/GHSA-8xw3-8jcr-ch76 "CVE-2017-13693") which relates to KASLR. Any distro who enabled KASLR should cares it. |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 11, 2024](#issuecomment-2537250432)

| Is there still any interest in this patch? I can take it and merge it if that is what the majority prefers, after all the CVE exploits are no ordinary bugs to be ignored.....  It will be good if you can take the patch. Per my understood, this patch can fix [CVE-2017-13693](https://github.com/advisories/GHSA-8xw3-8jcr-ch76) which relates to KASLR. Any distro who enabled KASLR should cares it.  What about PR [#278](https://github.com/acpica/acpica/pull/278) from the same author? Any comments on that or interest in general? |
| --- |

All reactions

Sorry, something went wrong.

[![@joeyli](https://avatars.githubusercontent.com/u/124434?s=80&v=4)](/joeyli)

Copy link

### **[joeyli](/joeyli)** commented [Dec 12, 2024](#issuecomment-2537861566) • edited Loading

| Is there still any interest in this patch? I can take it and merge it if that is what the majority prefers, after all the CVE exploits are no ordinary bugs to be ignored.....  It will be good if you can take the patch. Per my understood, this patch can fix [CVE-2017-13693](https://github.com/advisories/GHSA-8xw3-8jcr-ch76) which relates to KASLR. Any distro who enabled KASLR should cares it.  What about PR [#278](https://github.com/acpica/acpica/pull/278) from the same author? Any comments on that or interest in general?  Looks PR [#278](https://github.com/acpica/acpica/pull/278) is similar with [#295](https://github.com/acpica/acpica/pull/295). Both of them can trigger stack dump to show kernel memory location (<= 4.9) when booting for neutralizing KASLR ([CVE-2017-13694](https://github.com/advisories/GHSA-cc4x-9vpx-cphw "CVE-2017-13694")). So my suggestion is that you can also take it. |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 12, 2024](#issuecomment-2539414785)

| Thanks for the detailed response, I can merge them both if there are no conflicts! I can also update the CVE reports. |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)
[SaketADumbre](/SaketADumbre)
merged commit [`28b55ec`](/acpica/acpica/commit/28b55ece2bfce77e6648f5e70d4b7851ee30910c)
into
acpica:master

[Dec 12, 2024](https://github.com/acpica/acpica/pull/295#event-15637625473)

[SaketADumbre](/SaketADumbre)
added a commit
that referenced
this pull request
[Dec 12, 2024](#ref-commit-1d7a0aa)
[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)

`[Fix warnings from PR](/acpica/acpica/commit/1d7a0aa04793ff731da13f2070877ec7a9498571 "Fix warnings from PR #295 merge - possible loss of data from UINT32 to UINT8 conversions") [#295](https://github.com/acpica/acpica/pull/295) [merge - possible loss of data from UINT32 t…](/acpica/acpica/commit/1d7a0aa04793ff731da13f2070877ec7a9498571 "Fix warnings from PR #295 merge - possible loss of data from UINT32 to UINT8 conversions")`
…

`[1d7a0aa](/acpica/acpica/commit/1d7a0aa04793ff731da13f2070877ec7a9498571)`

```
…o UINT8 conversions
```

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=80&v=4)](/SaketADumbre)

Copy link

Collaborator

### **[SaketADumbre](/SaketADumbre)** commented [Dec 12, 2024](#issuecomment-2539495850)

| Fixed warnings related to UINT32 -> UINT8 conversion which could result in possible data loss. |
| --- |

All reactions

Sorry, something went wrong.

[![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=40&v=4)](/SaketADumbre)
[SaketADumbre](/SaketADumbre)
mentioned this pull request
[Dec 12, 2024](#ref-pullrequest-2736426147)

[[GHSA-8xw3-8jcr-ch76] The acpi\_ds\_create\_operands() function in drivers/acpi...
github/advisory-database#5083](/github/advisory-database/pull/5083)
 Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Facpica%2Facpica%2Fpull%2F295)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

7 participants

[![@kkamagui](https://avatars.githubusercontent.com/u/1183342?s=52&v=4)](/kkamagui) [![@zetalog](https://avatars.githubusercontent.com/u/3615765?s=52&v=4)](/zetalog) [![@acpibob](https://avatars.githubusercontent.com/u/966572?s=52&v=4)](/acpibob) [![@ahs3](https://avatars.githubusercontent.com/u/993068?s=52&v=4)](/ahs3) [![@SchmErik](https://avatars.githubusercontent.com/u/11355936?s=52&v=4)](/SchmErik) [![@joeyli](https://avatars.githubusercontent.com/u/124434?s=52&v=4)](/joeyli) [![@SaketADumbre](https://avatars.githubusercontent.com/u/97769119?s=52&v=4)](/SaketADumbre)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from avatars.githubusercontent.com_9631c9d9_20250126_062025.html ===
���� JFIF  ` `  �� ;CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 90
�� C 



�� C  

��  P P" ��           
�� �   } !1AQa"q2���#B��R��$3br�
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz���������������������������������������������������������������������������        
�� �  w !1AQaq"2�B���� #3R�br�
$4�%�&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz��������������������������������������������������������������������������   ? ��A�m/#���L\��|����Zȹ�a�ޛ}��Y��է��deh�>�ps�ps��>�N���+H��6��:%�p�\K=��b�̠mD���}��{Kp��X��F���A�\*����.�ɮ4-O�S�!�Գ�!��VU\a�g�FM~x~ϟ�O��5���Ԯ�lndX/��R��'����>����?���5�ԚV�mozc�J�i�yH!B���bĨ�r5�:���w���|g����'����G�a�㴍V�IoZ�mde�t<�+��/|8�m�j2ɦ\_]xfm>ْ��ۉg/���p�I9+�k�g�4����#I7l��`���#+}�G�Xp'��>���n�w⥷�M�-Y,�A$�G�2�М��q�%�{
�=���F�R��}cZ�!�y�T����s#�RI��r��c �}+�������Ǌt=?I�X!k�� �
4��.��\�Z�
����)/��$�-̯5�ԑ:`�c`%�����
��� �oxSWҭoWG2.����x��;7��,��;�Bini�hx�� ��x��jQg~�+�+�֖p"���c��\_�H���
-�4�` #^��q�j��=�Qu{]J�6���x|����bo)6���8BPK�jx�����`ј�$u�|�㏄���/��-����flv��s� ���OQ6�u��on?�����ak��zf�iSO!�'܍��J�I��1�)S�'G^����lx�N�y�������O �-~$���M4 �i�?�m�.0�������
��� �i'���?���~�|�ͫ|7�Ɲ�ǧAsgF����\*6� fGRz�nh)#�ۍ\*�M]#��!���!t����E�Ct�,���b��/��A�P��� i���Ʃ}2�m[}]��,9�8�TA�����b�3�\_<7}�
M~xYg�(�5�M+3�t���zG����X�u�jD!�au$N�B�� {f���精XT�qVGG�/!ʞ�:����V�ʊ�Y%�S�BŶ�\�t�&��%�
=�
^�m���X��~j+¼g�J��'��;9��+�DSxl��m(^.�΄�5sS[��K��@q�4�` `8�k\_���c��c����$�十ߦ�v�^}s���@�;�/�ʄ彸��<� ۗ&K+�]zH#m��0����f\�n������k>���8�P�a����\*�ᔎ��L��Z�1�Hў~ff#��za^oq�X�͍�}@j@�)�ѷ� ���c�3]֑��j����9&��qi��9���Z��;��;`����kf���ia�2p:�Z���}����(�<N�n�21�ƻ�3�V7ZM��o��i!Vh|�R�G+׭}�<����p��"�9? x� �����m�K�549.$ܸO�+������ZǏ%����-?ȍ �q,�v�=����B�zD\_i�E7c,�Q��8��]Lz���"xݏ�+��'sǲ�� щ%�{y�0��q�~
���;Dy��onY�ZB� #���5��\*p�m�~e��Cw�\_[$��ۤ\*��L�PRO����t�v��ER����cI����
��� ��"�q#� ���q]v��Ku(�O�"�I~b�Cdי�\_����������"�@�� ���:�g����)os<+�rxϱ���4i�r��g��F>s��M��
��4�ײ�$�4 ��'�~�p��F��zW��jz��4B��i�Gcpz� í{ۻx�@�9��g�bz(�I=�|�����}
�̮Ց�?��k�9-�yŬvp���o��c�#늹��~�E�?��ݽ��l� �ϟ�3�p��Ok⯈��݄�u�L-����������ƹ+K�)�l��?��+��F��n|.&J�YN;F�v��F~#�1�IFn"VC!>f܁!��@}���ׁ��|#m�Ce�f�<�41 ���\1�ѷ�<��M[�߈/�����l-R9����Ǒ��V�?�5d���g�݂�׌�c[K6������{��k�[���;�8���?�?���������G2�[����SR]���>��<sQ�=9�t���>�l�|/V7g��j�<�9x�y�O�|9��/���N������J��oF���p��A������z�W�S�N��==k��c9W,�+�U=�h���

=== Content from avatars.githubusercontent.com_0411fec4_20250126_062014.html ===
�PNG

   
IHDR  �  �   �.�b  �IDATx���Q��@F��
&P� �  u����дL�{����In�e�����f ��� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� �m/��q�[���}��g�G��=�e$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�������}�x�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$,�|��:fOx�m�gOx��� ��H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A����x/�u̞ /��H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���H; A���HXf�lۺϞ@�y�'|\*�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$���;Ƙ���\v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�� b$�� v@�   ��K��,    IEND�B`�

=== Content from patchwork.kernel.org_7042230f_20250125_053105.html ===

Toggle navigation

[Patchwork](/)
Linux ACPI

* [Patches](/project/linux-acpi/list/)
* [Bundles](/project/linux-acpi/bundles/)
* [About this project](/project/linux-acpi/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

9919053

[diff](/project/linux-acpi/patch/1503551495-33286-1-git-send-email-kkamagui%40gmail.com/raw/ "Download patch diff")
[mbox](/project/linux-acpi/patch/1503551495-33286-1-git-send-email-kkamagui%40gmail.com/mbox/ "Download patch mbox")
# acpi: acpica: fix acpi operand cache leak in dsutils.c

| Message ID | 1503551495-33286-1-git-send-email-kkamagui@gmail.com ([mailing list archive](https://lore.kernel.org/r/1503551495-33286-1-git-send-email-kkamagui%40gmail.com)) |
| --- | --- |
| State | Rejected, archived |
| Headers | show ``` Return-Path: <linux-acpi-owner@kernel.org> Received: from mail.wl.linuxfoundation.org (pdx-wl-mail.web.codeaurora.org 	[172.30.200.125]) 	by pdx-korg-patchwork.web.codeaurora.org (Postfix) with ESMTP id 	13EBB60353 for <patchwork-linux-acpi@patchwork.kernel.org>; 	Thu, 24 Aug 2017 05:12:56 +0000 (UTC) Received: from mail.wl.linuxfoundation.org (localhost [127.0.0.1]) 	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id 0657F28B3F 	for <patchwork-linux-acpi@patchwork.kernel.org>; 	Thu, 24 Aug 2017 05:12:56 +0000 (UTC) Received: by mail.wl.linuxfoundation.org (Postfix, from userid 486) 	id EF2F928B47; Thu, 24 Aug 2017 05:12:55 +0000 (UTC) X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on 	pdx-wl-mail.web.codeaurora.org X-Spam-Level:  X-Spam-Status: No, score=-6.3 required=2.0 tests=BAYES_00, 	DKIM_ADSP_CUSTOM_MED,  	DKIM_SIGNED, FREEMAIL_FROM, RCVD_IN_DNSWL_HI, RCVD_IN_SORBS_SPAM, 	T_DKIM_INVALID autolearn=ham version=3.3.1 Received: from vger.kernel.org (vger.kernel.org [209.132.180.67]) 	by mail.wl.linuxfoundation.org (Postfix) with ESMTP id C920E28B41 	for <patchwork-linux-acpi@patchwork.kernel.org>; 	Thu, 24 Aug 2017 05:12:54 +0000 (UTC) Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand 	id S1751038AbdHXFMx (ORCPT 	<rfc822;patchwork-linux-acpi@patchwork.kernel.org>); 	Thu, 24 Aug 2017 01:12:53 -0400 Received: from mail-pg0-f67.google.com ([74.125.83.67]:34399 "EHLO 	mail-pg0-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org 	with ESMTP id S1750806AbdHXFMw (ORCPT 	<rfc822; linux-acpi@vger.kernel.org>); Thu, 24 Aug 2017 01:12:52 -0400 Received: by mail-pg0-f67.google.com with SMTP id p14so2303136pgd.1; 	Wed, 23 Aug 2017 22:12:52 -0700 (PDT) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; 	d=gmail.com; s=20161025; 	h=from:to:cc:subject:date:message-id; 	bh=K4mpm0tREJx9Epvlqlw4iK1putD842drhxZoiKnM+tQ=; 	b=LP5BpJCo792vEVred+1tbAcrN8/NRxuRV7r8ifgXT8htzxTPP2GwnVu12s+bA4CzQ+ 	+px+WkixCgvZEN2vEfd9f7s1/P+UV7mbeQbd4OYmnEQD12sN3GvDVDQUkef7mDhe8Rqi 	z59UlWA1W0sXRFpNNzV2NmgrpFQBj9s7YSM4YiajEIy33/oIrJ9BRDHM8Mwe/Ruezllz 	cMEwQR9nssSA7LA7xqbEBqt2LtjL26iR99IQEwMd31uDc0yKXQ7UDqC9UPMdvatVWJJR 	ruWzzF6svK8zj0m16l1ebskzMLNDpFs7h4f54Bk79fGB7do22aCyENzZE1MlzBVb8c9i 	jjiw== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; 	d=1e100.net; s=20161025; 	h=x-gm-message-state:from:to:cc:subject:date:message-id; 	bh=K4mpm0tREJx9Epvlqlw4iK1putD842drhxZoiKnM+tQ=; 	b=bRGnhoSExjGhvjqSdab8XTOA5avHCUykpt2x3AeF29UenBC+z46hZYFWcCqJz+hAke 	/42L/F5qide3GRcQqNn2YgxRbzBOEeBUrndlj/lrJw0F2bm+kscnBqfD6DCNuyxuumYy 	MxSBmBXNtaWizuG49UIYZPc6VTGlXdwNpL/8zeMXtZzL7uqeXoagbabyFiMtDO6Hudno 	9ogsESWywdUlRe1DVLhBauMsuyHZOdlGzcWrNMSd6oRaTS1oCX/K4syYgFpgDjoiaGta 	z0j6f/St9COJ28DvYuJ0b+7f+Myamw29AJKEre2k2PWTicsE6s4yogfUvLbPxrRcysmt 	aPTA== X-Gm-Message-State: AHYfb5heNoXjtHyScxnqCzBUfMgNgXrkM3+DoEI3ElhRF0XMR2ZmQ9rm 	9k3Pdcmh6+Ilxg== X-Received: by 10.84.229.77 with SMTP id d13mr5643126pln.67.1503551571870; 	Wed, 23 Aug 2017 22:12:51 -0700 (PDT) Received: from localhost.localdomain ([175.203.71.232]) 	by smtp.gmail.com with ESMTPSA id 	r9sm5425362pfd.126.2017.08.23.22.12.49 	(version=TLS1_2 cipher=ECDHE-RSA-AES128-SHA bits=128/128); 	Wed, 23 Aug 2017 22:12:51 -0700 (PDT) From: Seunghun Han <kkamagui@gmail.com> To: lv.zheng@intel.com Cc: robert.moore@intel.com, rafael.j.wysocki@intel.com, 	linux-acpi@vger.kernel.org, devel@acpica.org, 	linux-kernel@vger.kernel.org, security@kernel.org, 	Seunghun Han <kkamagui@gmail.com> Subject: [PATCH] acpi: acpica: fix acpi operand cache leak in dsutils.c Date: Thu, 24 Aug 2017 14:11:35 +0900 Message-Id: <1503551495-33286-1-git-send-email-kkamagui@gmail.com> X-Mailer: git-send-email 2.1.4 Sender: linux-acpi-owner@vger.kernel.org Precedence: bulk List-ID: <linux-acpi.vger.kernel.org> X-Mailing-List: linux-acpi@vger.kernel.org X-Virus-Scanned: ClamAV using ClamSMTP  ``` |

## Commit Message

[Seunghun Han](/project/linux-acpi/list/?submitter=172635)
Aug. 24, 2017, 5:11 a.m. UTC
```

I found an ACPI cache leak in ACPI early termination and boot continuing case.

When early termination is occurred due to malicious ACPI table, Linux kernel
terminates ACPI function and continues to boot process. While kernel terminates
ACPI function, kmem_cache_destroy() reports Acpi-Operand cache leak.

Boot log of ACPI operand cache leak is as follows:
>[    0.585957] ACPI: Added _OSI(Module Device)
>[    0.587218] ACPI: Added _OSI(Processor Device)
>[    0.588530] ACPI: Added _OSI(3.0 _SCP Extensions)
>[    0.589790] ACPI: Added _OSI(Processor Aggregator Device)
>[    0.591534] ACPI Error: Illegal I/O port address/length above 64K: C806E00000004002/0x2 (20170303/hwvalid-155)
>[    0.594351] ACPI Exception: AE_LIMIT, Unable to initialize fixed events (20170303/evevent-88)
>[    0.597858] ACPI: Unable to start the ACPI Interpreter
>[    0.599162] ACPI Error: Could not remove SCI handler (20170303/evmisc-281)
>[    0.601836] kmem_cache_destroy Acpi-Operand: Slab cache still has objects
>[    0.603556] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.12.0-rc5 #26
>[    0.605159] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
>[    0.609177] Call Trace:
>[    0.610063]  ? dump_stack+0x5c/0x81
>[    0.611118]  ? kmem_cache_destroy+0x1aa/0x1c0
>[    0.612632]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.613906]  ? acpi_os_delete_cache+0xa/0x10
>[    0.617986]  ? acpi_ut_delete_caches+0x3f/0x7b
>[    0.619293]  ? acpi_terminate+0xa/0x14
>[    0.620394]  ? acpi_init+0x2af/0x34f
>[    0.621616]  ? __class_create+0x4c/0x80
>[    0.623412]  ? video_setup+0x7f/0x7f
>[    0.624585]  ? acpi_sleep_proc_init+0x27/0x27
>[    0.625861]  ? do_one_initcall+0x4e/0x1a0
>[    0.627513]  ? kernel_init_freeable+0x19e/0x21f
>[    0.628972]  ? rest_init+0x80/0x80
>[    0.630043]  ? kernel_init+0xa/0x100
>[    0.631084]  ? ret_from_fork+0x25/0x30
>[    0.633343] vgaarb: loaded
>[    0.635036] EDAC MC: Ver: 3.0.0
>[    0.638601] PCI: Probing PCI hardware
>[    0.639833] PCI host bridge to bus 0000:00
>[    0.641031] pci_bus 0000:00: root bus resource [io  0x0000-0xffff]
> ... Continue to boot and log is omitted ...

I analyzed this memory leak in detail and found acpi_ds_obj_stack_pop_and_
delete() function miscalculated the top of the stack. acpi_ds_obj_stack_push()
function uses walk_state->operand_index for start position of the top, but
acpi_ds_obj_stack_pop_and_delete() function considers index 0 for it.
Therefore, this causes acpi operand memory leak.

This cache leak causes a security threat because an old kernel (<= 4.9) shows
memory locations of kernel functions in stack dump. Some malicious users
could use this information to neutralize kernel ASLR.

I made a patch to fix ACPI operand cache leak.
Signed-off-by: Seunghun Han <kkamagui@gmail.com>
---
 drivers/acpi/acpica/dsutils.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

```

9919053

[diff](/project/linux-acpi/patch/1503551495-33286-1-git-send-email-kkamagui%40gmail.com/raw/ "Download patch diff")
[mbox](/project/linux-acpi/patch/1503551495-33286-1-git-send-email-kkamagui%40gmail.com/mbox/ "Download patch mbox")
## Patch

```

diff --git a/drivers/acpi/acpica/dsutils.c b/drivers/acpi/acpica/dsutils.c
index 0dabd9b..2c8a060 100644
--- a/drivers/acpi/acpica/dsutils.c
+++ b/drivers/acpi/acpica/dsutils.c
@@ -705,6 +705,8 @@  acpi_ds_create_operands(struct acpi_walk_state *walk_state,
 	union acpi_parse_object *arguments[ACPI_OBJ_NUM_OPERANDS];
 	u32 arg_count = 0;
 	u32 index = walk_state->num_operands;
+	u32 prev_num_operands = walk_state->num_operands;
+	u32 new_num_operands;
 	u32 i;

 	ACPI_FUNCTION_TRACE_PTR(ds_create_operands, first_arg);
@@ -733,6 +735,7 @@  acpi_ds_create_operands(struct acpi_walk_state *walk_state,

 	/* Create the interpreter arguments, in reverse order */

+	new_num_operands = index;
 	index--;
 	for (i = 0; i < arg_count; i++) {
 		arg = arguments[index];
@@ -757,7 +760,11 @@  acpi_ds_create_operands(struct acpi_walk_state *walk_state,
 	 * pop everything off of the operand stack and delete those
 	 * objects
 	 */
-	acpi_ds_obj_stack_pop_and_delete(arg_count, walk_state);
+	walk_state->num_operands = i;
+	acpi_ds_obj_stack_pop_and_delete(new_num_operands, walk_state);
+
+	/* Restore operand count */
+	walk_state->num_operands = prev_num_operands;

 	ACPI_EXCEPTION((AE_INFO, status, "While creating Arg %u", index));
 	return_ACPI_STATUS(status);

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/)
patch tracking system | version v2.2.6 | [about patchwork](/about/)


