=== Content from github.com_9ef59293_20250125_210552.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F6e8572ea8bb56d0216bb1b410e5040edc051b120)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F6e8572ea8bb56d0216bb1b410e5040edc051b120)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=sandstorm-io%2Fsandstorm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sandstorm-io](/sandstorm-io)
/
**[sandstorm](/sandstorm-io/sandstorm)**
Public

* [Notifications](/login?return_to=%2Fsandstorm-io%2Fsandstorm) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2Fsandstorm-io%2Fsandstorm)
* [Star
   6.8k](/login?return_to=%2Fsandstorm-io%2Fsandstorm)

* [Code](/sandstorm-io/sandstorm)
* [Issues
  629](/sandstorm-io/sandstorm/issues)
* [Pull requests
  20](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects
  0](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

Additional navigation options

* [Code](/sandstorm-io/sandstorm)
* [Issues](/sandstorm-io/sandstorm/issues)
* [Pull requests](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

## Commit

[Permalink](/sandstorm-io/sandstorm/commit/6e8572ea8bb56d0216bb1b410e5040edc051b120)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix newline detection in zip paths.

[Browse files](/sandstorm-io/sandstorm/tree/6e8572ea8bb56d0216bb1b410e5040edc051b120)
Browse the repository at this point in the history

* Loading branch information

[![@kentonv](https://avatars.githubusercontent.com/u/4001805?s=40&v=4)](/kentonv)

[kentonv](/sandstorm-io/sandstorm/commits?author=kentonv "View all commits by kentonv")
committed
Mar 1, 2017

1 parent
[4ea8df7](/sandstorm-io/sandstorm/commit/4ea8df7403381d9b657b121b3c98d8081b27414d)

commit 6e8572e

Showing
**1 changed file**
with
**13 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

26 changes: 13 additions & 13 deletions

26
[src/sandstorm/backup.c++](#diff-67752a1221f34aae82facbcc123b2a742b68c750dbe89f74c76db521f8597950 "src/sandstorm/backup.c++")

Show comments

[View file](/sandstorm-io/sandstorm/blob/6e8572ea8bb56d0216bb1b410e5040edc051b120/src/sandstorm/backup.c%2B%2B)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -252,23 +252,23 @@ void BackupMain::pump(kj::InputStream& in, kj::OutputStream& out) { |
|  |  | } |
|  |  |  |
|  |  | bool BackupMain::findFilesToZip(kj::StringPtr path, kj::OutputStream& out) { |
|  |  | // If the path contains a newline, we cannot correctly pass it to `zip` since `zip` expects |
|  |  | // one file per line. For security reasons, we must detect and filter out these files. |
|  |  | // Hopefully this never happens legitimately? |
|  |  | if (path.findFirst('\n') != nullptr) { |
|  |  | KJ\_LOG(ERROR, "tried to backup file containing newlines", path); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | struct stat stats; |
|  |  | KJ\_SYSCALL(lstat(path.cStr(), &stats)); |
|  |  | if (S\_ISREG(stats.st\_mode) || S\_ISLNK(stats.st\_mode)) { |
|  |  | // Regular file or link can be zipped; write to file stream. |
|  |  | // If the path contains a newline, we cannot correctly pass it to `zip` since `zip` expects |
|  |  | // one file per line. For security reasons, we must detect and filter out these files. |
|  |  | // Hopefully this never happens legitimately? |
|  |  | if (path.findFirst('\n') == nullptr) { |
|  |  | kj::ArrayPtr<const byte> pieces[2]; |
|  |  | pieces[0] = path.asBytes(); |
|  |  | pieces[1] = kj::StringPtr("\n").asBytes(); |
|  |  | out.write(pieces); |
|  |  | return true; |
|  |  | } else { |
|  |  | KJ\_LOG(ERROR, "tried to backup file containing newlines", path); |
|  |  | return false; |
|  |  | } |
|  |  | kj::ArrayPtr<const byte> pieces[2]; |
|  |  | pieces[0] = path.asBytes(); |
|  |  | pieces[1] = kj::StringPtr("\n").asBytes(); |
|  |  | out.write(pieces); |
|  |  | return true; |
|  |  | } else if (S\_ISDIR(stats.st\_mode)) { |
|  |  | // Subdirectory; enumerate contents. |
|  |  | bool packedAny = false; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6e8572e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F6e8572ea8bb56d0216bb1b410e5040edc051b120) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from sandstorm.io_1907aebb_20250126_115739.html ===

[This site is historical, from when Sandstorm was a startup. Sandstorm the open source project has moved to sandstorm.org. More info »](/news/2024-01-14-move-to-sandstorm-org)

[Sandstorm.io](/)
[Get Sandstorm](/get)
[Features](/features)
[Technology](/how-it-works)
[Blog](/news/)
[Docs](https://docs.sandstorm.io)
[Code](https://github.com/sandstorm-io/sandstorm)
[Community](/community)
[About](/about)

# **Sandstorm** is an open sourceplatform for self-hosting web apps

[Online Demo](https://demo.sandstorm.io)
[Get Sandstorm](/get)

## Self-host web-based productivity apps easily and securely.

Sandstorm is an open source project built by a community of volunteers with the goal of making
it really easy to run open source web applications.

* ### Chat

  Sync up with your colleagues securely using Rocket.Chat.
* ### File Storage

  Store all your files and share them with others using Davros.
* ### Task & Project Management

  Organize all your tasks and ideas using Wekan.
* ### Document Editing

  Create, edit, and collaborate on documents with Etherpad.

[Online Demo](https://demo.sandstorm.io/demo)
[Get it now](/get)
[Check out the apps available on Sandstorm »](https://apps.sandstorm.io)

## How is it different?

### Usability | Designed for Humans

**Installing apps on Sandstorm is as easy as installing apps on your phone.**

Find any app you want on the App Market and start using it with a few clicks. Every app comes with automatic updates.

**All your apps and data in one place, with consistent access control.**

Sandstorm keeps a list so you can find everything you create. Sandstorm's unified access control system covers data from every app, and everything is private to you by default.

### Security | Secure by Default

**Sandstorm protects you.** Each document, chat room, mail box, notebook, blog, or anything else you create is a "grain" in Sandstorm. Sandstorm containerizes each one in its own secure sandbox from which it cannot talk to the world without express permission. All your grains are private until you share them. The result is that 95% of security vulnerabilities are automatically mitigated.

Skeptical? Learn more about [Sandstorm's security model](https://docs.sandstorm.io/en/latest/using/security-practices/) and [security non-events](https://docs.sandstorm.io/en/latest/using/security-non-events/).

**Sandstorm makes it easy to adhere to security, regulatory, and data privacy requirements.** Sandstorm manages access control on every document, so it can show who has access and allow you to revoke that access at any time. Self-hosting Sandstorm enables organizations to have complete control over where their data is stored.

### Freedom | You're in Control

**You choose where your data lives:** You can use Sandstorm in the cloud on a variety of hosting services, or you can [install it on your own machines.](/get) You can even move between these options at any time. No matter where you decide to run Sandstorm, the apps are the same.

**With Sandstorm, you do not get locked into walled gardens.** You can mix and match apps from multiple developers with ease, and even throw in apps of your own as needed. Many Sandstorm apps are open source, which means you can modify them to suit you needs.

## Who is it for?

### Individuals

Sandstorm makes it safe & easy to use open source web apps. It adds security hardening and protects your privacy. Apps never disappear, and you can add your own. Run your [own server.](/get)

[Learn More](/features)

### Businesses

Sandstorm lets you keep all your company's data in one place, rather than scattered across dozens of web apps. At the same time, it lets each team in your company choose their own tools and deploy applications to meet their needs, without having to file tickets and wait for support from other teams. This makes your employees more productive while keeping your data safe and under control.

[Learn More](/business)

### Developers

Ship your code as a Sandstorm app package and don't worry about how to run a service or scale it up. On Sandstorm, independent developers, hobbyists, and open source projects can build quality applications that people can actually use, without worrying about how to run a service.

[Learn More](/developer)

* ### [Get Sandstorm](/get)

  + [Self-host Sandstorm](/get)+ [Source code (GitHub)](https://github.com/sandstorm-io/sandstorm)+ [For educators](/go/education)
* ### [Features](/features)

  + [App Market](https://apps.sandstorm.io)
  + [Core features](/features)+ [Security features](/features#security)+ [For organizations](/business)+ [For developers](/developer)
* ### [Documentation](https://docs.sandstorm.io)

  + [How to use Sandstorm](https://docs.sandstorm.io/en/latest/using/)+ [Developer Hub](https://docs.sandstorm.io/en/latest/developing/)+ [Administering & installing](https://docs.sandstorm.io/en/latest/administering/)+ [Security](https://docs.sandstorm.io/en/latest/using/security-practices/)
* ### [Technology (How it Works)](/how-it-works)

  + [Fine-grained object containers](/how-it-works#grains)+ [Capability-based security](/how-it-works#capabilities)
* ### [Community](/community)

  + [Sandstorm Blog](/news)+ [Connect with us](/community#connect-with)+ [Help others](/community#helpothers)+ [Help the project](/community#helpproject)
* ### [About](/about)

  + [Sandstorm story](/about)+ [Team](/about#team)+ [Advisors](/about#advisors)+ Contact
* ### Connect

This page was hand-crafted using only the finest web technologies.



=== Content from github.com_55ed60cb_20250125_210550.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fblob%2Fv0.202%2Fsrc%2Fsandstorm%2Fbackup.c%252B%252B)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fblob%2Fv0.202%2Fsrc%2Fsandstorm%2Fbackup.c%252B%252B)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=sandstorm-io%2Fsandstorm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sandstorm-io](/sandstorm-io)
/
**[sandstorm](/sandstorm-io/sandstorm)**
Public

* [Notifications](/login?return_to=%2Fsandstorm-io%2Fsandstorm) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2Fsandstorm-io%2Fsandstorm)
* [Star
   6.8k](/login?return_to=%2Fsandstorm-io%2Fsandstorm)

* [Code](/sandstorm-io/sandstorm/tree/v0.202)
* [Issues
  629](/sandstorm-io/sandstorm/issues)
* [Pull requests
  20](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects
  0](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

Additional navigation options

* [Code](/sandstorm-io/sandstorm/tree/v0.202)
* [Issues](/sandstorm-io/sandstorm/issues)
* [Pull requests](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

## Files

 v0.202
## Breadcrumbs

1. [sandstorm](/sandstorm-io/sandstorm/tree/v0.202)
2. /[src](/sandstorm-io/sandstorm/tree/v0.202/src)
3. /[sandstorm](/sandstorm-io/sandstorm/tree/v0.202/src/sandstorm)
/
# backup.c++

Copy path Blame  Blame
## Latest commit

## History

[History](/sandstorm-io/sandstorm/commits/v0.202/src/sandstorm/backup.c%2B%2B)294 lines (255 loc) · 10.4 KB v0.202
## Breadcrumbs

1. [sandstorm](/sandstorm-io/sandstorm/tree/v0.202)
2. /[src](/sandstorm-io/sandstorm/tree/v0.202/src)
3. /[sandstorm](/sandstorm-io/sandstorm/tree/v0.202/src/sandstorm)
/
# backup.c++

Top
## File metadata and controls

* Code
* Blame

294 lines (255 loc) · 10.4 KB[Raw](https://github.com/sandstorm-io/sandstorm/raw/refs/tags/v0.202/src/sandstorm/backup.c%2B%2B)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293// Sandstorm - Personal Cloud Sandbox// Copyright (c) 2015 Sandstorm Development Group, Inc. and contributors// All rights reserved.//// Licensed under the Apache License, Version 2.0 (the "License");// you may not use this file except in compliance with the License.// You may obtain a copy of the License at//// http://www.apache.org/licenses/LICENSE-2.0//// Unless required by applicable law or agreed to in writing, software// distributed under the License is distributed on an "AS IS" BASIS,// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.// See the License for the specific language governing permissions and// limitations under the License.
#include "backup.h"#include "util.h"#include "version.h"#include <kj/debug.h>#include <sched.h>#include <sys/mount.h>#include <sys/syscall.h>#include <sys/stat.h>#include <sys/types.h>#include <sys/prctl.h>#include <sys/capability.h>
// In case kernel headers are old.#ifndef PR\_SET\_NO\_NEW\_PRIVS#define PR\_SET\_NO\_NEW\_PRIVS 38#endif
namespace sandstorm {
BackupMain::BackupMain(kj::ProcessContext& context): context(context) {}
kj::MainFunc BackupMain::getMain() { return kj::MainBuilder(context, "Sandstorm version " SANDSTORM\_VERSION, "Backs up the grain directory in <grain> to <file>, reading the grain " "metadata struct on stdin. Or, restores the backup in <file>, " "unpacking it to <grain>, and writing the metadata to stdout. In " "backup mode, <file> can be `-` to write the data to stdout.") .addOptionWithArg({"uid"}, KJ\_BIND\_METHOD(\*this, setUid), "<uid>", "Use setuid sandbox rather than userns. Must start as root, but swiches " "to <uid> to run the app.") .addOption({'r', "restore"}, KJ\_BIND\_METHOD(\*this, setRestore), "Restore a backup, rather than create a backup.") .addOptionWithArg({"root"}, KJ\_BIND\_METHOD(\*this, setRoot), "<root>", "Set the \"root directory\" to map in, which contains the zip/unzip binaries.") .expectArg("<file>", KJ\_BIND\_METHOD(\*this, setFile)) .expectArg("<grain>", KJ\_BIND\_METHOD(\*this, run)) .build();}
bool BackupMain::setRestore() { restore = true; return true;}
bool BackupMain::setFile(kj::StringPtr arg) { filename = arg; return true;}
bool BackupMain::setRoot(kj::StringPtr arg) { root = arg; return true;}
bool BackupMain::setUid(kj::StringPtr arg) { KJ\_IF\_MAYBE(u, parseUInt(arg, 10)) { if (getuid() != 0) { return false; } if (\*u == 0) { return false; } KJ\_SYSCALL(seteuid(\*u)); sandboxUid = \*u; return true; } else { return false; }}
void BackupMain::writeSetgroupsIfPresent(const char \*contents) { KJ\_IF\_MAYBE(fd, raiiOpenIfExists("/proc/self/setgroups", O\_WRONLY | O\_CLOEXEC)) { kj::FdOutputStream(kj::mv(\*fd)).write(contents, strlen(contents)); }}
void BackupMain::writeUserNSMap(const char \*type, kj::StringPtr contents) { kj::FdOutputStream(raiiOpen(kj::str("/proc/self/", type, "\_map").cStr(), O\_WRONLY | O\_CLOEXEC)) .write(contents.begin(), contents.size());}
void BackupMain::bind(kj::StringPtr src, kj::StringPtr dst, unsigned long flags) { // Contrary to the documentation of MS\_BIND claiming this is no longer the case after 2.6.26, // mountflags are ignored on the initial bind. We have to issue a subsequent remount to set // them. KJ\_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS\_BIND | MS\_REC, nullptr), src, dst); KJ\_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS\_BIND | MS\_REC | MS\_REMOUNT | flags, nullptr), src, dst);}
bool BackupMain::run(kj::StringPtr grainDir) { // Enable no\_new\_privs so that once we drop privileges we can never regain them through e.g. // execing a suid-root binary, as a backup measure. This is a backup measure in case someone // finds an arbitrary code execution exploit in zip/unzip; it's not needed otherwise. KJ\_SYSCALL(prctl(PR\_SET\_NO\_NEW\_PRIVS, 1, 0, 0, 0));
 // Create files / directories before we potentially change the UID, so that they are created // with the right owner. if (restore) { KJ\_SYSCALL(mkdir(kj::str(grainDir, "/sandbox").cStr(), 0770)); } else if (filename != "-") { // Instead of binding into mount tree later, just open the file and we'll compress to stdout. KJ\_SYSCALL(dup2(raiiOpen(filename, O\_WRONLY | O\_CREAT | O\_TRUNC | O\_CLOEXEC), STDOUT\_FILENO)); }
 if (sandboxUid == nullptr) { uid\_t uid = getuid(); gid\_t gid = getgid();
 KJ\_SYSCALL(unshare(CLONE\_NEWUSER | CLONE\_NEWNS | // Unshare other stuff; like no\_new\_privs, this is only to defend against hypothetical // arbitrary code execution bugs in zip/unzip. CLONE\_NEWNET | CLONE\_NEWIPC | CLONE\_NEWPID | CLONE\_NEWUTS)); writeSetgroupsIfPresent("deny\n"); writeUserNSMap("uid", kj::str("1000 ", uid, " 1\n")); writeUserNSMap("gid", kj::str("1000 ", gid, " 1\n")); } else { KJ\_SYSCALL(seteuid(0)); KJ\_SYSCALL(unshare(CLONE\_NEWNS | // Unshare other stuff; like no\_new\_privs, this is only to defend against hypothetical // arbitrary code execution bugs in zip/unzip. CLONE\_NEWNET | CLONE\_NEWIPC | CLONE\_NEWPID | CLONE\_NEWUTS)); }
 // To really unshare the mount namespace, we also have to make sure all mounts are private. // The parameters here were derived by strace'ing `mount --make-rprivate /`. AFAICT the flags // are undocumented. :( KJ\_SYSCALL(mount("none", "/", nullptr, MS\_REC | MS\_PRIVATE, nullptr));
 // Mount root read-only. bind(kj::str(root, "/"), "/tmp", MS\_BIND | MS\_NOSUID | MS\_RDONLY);
 if (access("/tmp/dev/null", F\_OK) != 0) { // Looks like we need to bind in /dev. KJ\_SYSCALL(mount("/dev", "/tmp/dev", nullptr, MS\_BIND, nullptr)); }
 // Hide sensitive directories. KJ\_SYSCALL(mount("tmpfs", "/tmp/proc", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000")); KJ\_SYSCALL(mount("tmpfs", "/tmp/var", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000")); KJ\_SYSCALL(mount("tmpfs", "/tmp/etc", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000"));
 // Mount inner tmpfs. KJ\_SYSCALL(mount("tmpfs", "/tmp/tmp", "tmpfs", 0, "size=8m,nr\_inodes=128,mode=777"));
 // Bind in the grain's `data` (=`sandbox`). KJ\_SYSCALL(mkdir("/tmp/tmp/data", 0777)); bind(kj::str(grainDir, "/sandbox"), "/tmp/tmp/data", MS\_NODEV | MS\_NOSUID | MS\_NOEXEC | (restore ? 0 : MS\_RDONLY));
 // Bind in the grain's `log`. When restoring, we discard the log. if (!restore) { KJ\_SYSCALL(mknod("/tmp/tmp/log", S\_IFREG | 0666, 0)); bind(kj::str(grainDir, "/log"), "/tmp/tmp/log", MS\_RDONLY | MS\_NOEXEC | MS\_NOSUID | MS\_NODEV); }
 // Bind in the file. if (restore) { KJ\_SYSCALL(mknod("/tmp/tmp/file.zip", S\_IFREG | 0666, 0)); KJ\_SYSCALL(mount(filename.cStr(), "/tmp/tmp/file.zip", nullptr, MS\_BIND, nullptr)); }
 // Use Andy's ridiculous pivot\_root trick to place ourselves into the sandbox. // See supervisor-main.c++ for more discussion. { auto oldRootDir = raiiOpen("/", O\_RDONLY | O\_DIRECTORY | O\_CLOEXEC); KJ\_SYSCALL(syscall(SYS\_pivot\_root, "/tmp", "/tmp")); KJ\_SYSCALL(fchdir(oldRootDir)); KJ\_SYSCALL(umount2(".", MNT\_DETACH)); KJ\_SYSCALL(chdir("/tmp")); }
 KJ\_IF\_MAYBE(u, sandboxUid) { KJ\_SYSCALL(setresuid(\*u, \*u, \*u)); }
 // TODO(security): We could seccomp this pretty tightly, but that would only be necessary to // defend against \*both\* zip/unzip \*and\* the Linux kernel having bugs at the same time. It's // fairly involved to set up, so maybe not worthwhile, unless we could factor the code out of // supervisor.c++...
 if (!restore) { // Read stdin to metadata file. kj::FdInputStream in(STDIN\_FILENO); kj::FdOutputStream out(raiiOpen("metadata", O\_WRONLY | O\_CREAT | O\_EXCL | O\_CLOEXEC)); pump(in, out); }
 { // Drop crapabilities. struct \_\_user\_cap\_header\_struct hdr; struct \_\_user\_cap\_data\_struct data[2]; hdr.version = \_LINUX\_CAPABILITY\_VERSION\_3; hdr.pid = 0; memset(data, 0, sizeof(data)); // All capabilities disabled! KJ\_SYSCALL(capset(&hdr, data)); umask(0007); }
 // TODO(someday): Find a zip library that doesn't suck and use it instead of shelling out // to zip/unzip. if (restore) { Subprocess({"unzip", "-q", "file.zip", "data/\*", "metadata"}).waitForSuccess();
 // Read metadata file to stdout. kj::FdInputStream in(raiiOpen("metadata", O\_RDONLY | O\_CLOEXEC)); kj::FdOutputStream out(STDOUT\_FILENO); pump(in, out); } else { Subprocess::Options zipOptions({"zip", "-qy@", "-"}); auto inPipe = Pipe::make(); zipOptions.stdin = inPipe.readEnd; Subprocess zip(kj::mv(zipOptions)); inPipe.readEnd = nullptr;
 { kj::FdOutputStream out(kj::mv(inPipe.writeEnd)); for (auto& entry: listDirectory(".")) { findFilesToZip(entry, out); } }
 zip.waitForSuccess(); }
 return true;}
void BackupMain::pump(kj::InputStream& in, kj::OutputStream& out) { byte buffer[4096]; while (size\_t n = in.tryRead(buffer, 1, sizeof(buffer))) { out.write(buffer, n); }}
bool BackupMain::findFilesToZip(kj::StringPtr path, kj::OutputStream& out) { struct stat stats; KJ\_SYSCALL(lstat(path.cStr(), &stats)); if (S\_ISREG(stats.st\_mode) || S\_ISLNK(stats.st\_mode)) { // Regular file or link can be zipped; write to file stream. // If the path contains a newline, we cannot correctly pass it to `zip` since `zip` expects // one file per line. For security reasons, we must detect and filter out these files. // Hopefully this never happens legitimately? if (path.findFirst('\n') == nullptr) { kj::ArrayPtr<const byte> pieces[2]; pieces[0] = path.asBytes(); pieces[1] = kj::StringPtr("\n").asBytes(); out.write(pieces); return true; } else { KJ\_LOG(ERROR, "tried to backup file containing newlines", path); return false; } } else if (S\_ISDIR(stats.st\_mode)) { // Subdirectory; enumerate contents. bool packedAny = false; for (auto& entry: listDirectory(path)) { if (findFilesToZip(kj::str(path, '/', entry), out)) { packedAny = true; } }
 if (!packedAny) { // Empty directory. Need to make sure it gets into the zip. kj::ArrayPtr<const byte> pieces[2]; pieces[0] = path.asBytes(); pieces[1] = kj::StringPtr("\n").asBytes(); out.write(pieces); } return true; } else { return false; }}
} // namespace sandstorm

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from sandstorm.io_0aece663_20250125_210552.html ===

[This site is historical, from when Sandstorm was a startup. Sandstorm the open source project has moved to sandstorm.org. More info »](/news/2024-01-14-move-to-sandstorm-org)

[Sandstorm.io](/)
[Get Sandstorm](/get)
[Features](/features)
[Technology](/how-it-works)
[Blog](/news/)
[Docs](https://docs.sandstorm.io)
[Code](https://github.com/sandstorm-io/sandstorm)
[Community](/community)
[About](/about)

# Sandstorm Blog

* [Fediverse](https://floss.social/%40sandstorm)* [Github](https://github.com/sandstorm-io/sandstorm)

[Sandstorm is a self-hostable web productivity suite.
Host your own](/get)
### Recommended Posts

* [Open Source Web Apps Aren't Viable; Let's Fix That](/news/2014-07-21-open-source-web-apps-require-federated-hosting)
* [Sandstorm's security track record, and what it means for self-hosting](/news/2016-02-29-security-track-record)
* [Decentralization is about diversity](/news/2016-08-17-decentralization-is-about-diversity)
* [8 New open source self-hostable apps](/news/2016-01-22-8-new-open-source-apps.html)
* [Sandstorm for Work Beta: LDAP, SAML, organization management](/news/2016-04-06-sandstorm-for-work)
* [Free publicity for your indie web app, and free Oasis service for you](/news/2016-02-05-app-author-publicity-oasis)
* [Free, automated SSL certificates for Sandstorm self-hosters](/news/2015-10-01-free-ssl-certificates.html)
* [Why doesn't Sandstorm just run Docker apps?](/news/2014-08-19-why-not-run-docker-apps.html)
* [Understand the Sandstorm sharing model](/news/2015-05-05-delegation-is-the-cornerstone-of-civilization.html)

### Further Reading

* [How Sandstorm Works](/how-it-works)
* [Sandstorm Documentation](http://docs.sandstorm.io)
* [How to install Sandstorm](/install)

[« All posts](/news/ "All posts")

## Sandstorm gets a security review

By [Kenton Varda](https://github.com/kentonv)
- 02 Mar 2017

Sandstorm recently underwent a security review by [DevCore Inc.](http://devco.re/), commissioned by Department of Cyber Security of Taiwan. The company has in the past found RCEs in big-name services like [Uber](https://hackerone.com/reports/125980) and [Facebook](http://devco.re/blog/2016/04/21/how-I-hacked-facebook-and-found-someones-backdoor-script-eng-ver/).

Although the full report is not public (and is not in English), Taiwan’s Digital Minister, [Audrey Tang](https://en.wikipedia.org/wiki/Audrey_Tang), tells us that overall DevCore feels Sandstorm has “excellent security design.”

As would be expected of any good security review, DevCore did find several issues. Last night we released build 0.203 to fix them. All servers should automatically update within 24 hours of the release (by midnight tonight, PST), but if you’d like to speed up the process (or if you have disabled automatic updates), you can SSH into your server now and type:

```
sudo sandstorm update

```
### Vulnerabilities Discovered (and fixed)

#### 1. Insufficient e-mail address validation

When logging in with an e-mail address, a user could enter an address like “foo@evil.com,bar@example.com”. In this case, login e-mails would be sent to *both* addresses, while Sandstorm would treat the user as if they were a member of the latter domain, “example.com”. Hence, an attacker could specify their real address as the first address and a fake address at a domain of their choice as the second, in order to appear to be a member of the domain. Servers that use Sandstorm’s organizational features (until recently only available as part of the [now-defunct](https://sandstorm.io/news/2017-02-06-sandstorm-returning-to-community-roots) product “Sandstorm for Work”) can be configured to automatically promote members of a domain to full users, allowing them to install apps, create grains, and discover the identities of other members of the organization. Such users would **not** receive access to any other grains on the server, but an attacker could install their own apps that consume the server’s resources, including CPU, RAM, and disk. An attacker could also combine this vulnerability with one of the others below, all of which require full user status as a starting point.

The root cause of this bug is Sandstorm’s use of a library called Nodemailer to send e-mail. It turns out that Nodemailer “helpfully” interprets comma-separated lists of addresses as multiple addresses. This is true even if the string is already part of an array. For instance, say you pass the following array in the `to` field of a mail sent via Nodemailer:

```
[ "foo@example.com",
  "bar@example.com,baz@example.com",
  { name: "Garply", address: "qux@example.com,corge@example.com" } ]

```

Surprisingly, this three-element array will send e-mail to *five* addresses – foo@, bar@, baz@, qux@, and corge@.

We did not anticipate this feature and assumed that Nodemailer would fail to send e-mail to an invalid address.

**Severity:** Moderate **if** Sandstorm is configured with an organization defined by e-mail domain. If you do not define an organization, or if you define it by LDAP, SAML, or G Suite domain, then we do not believe this bug can be meaningfully exploited.

**Fix:** Sandstorm now performs its own validation of addresses to ensure, among other things, that no separator characters are accepted and only one @-sign is allowed. Fixed in commit [37bd9a7](https://github.com/sandstorm-io/sandstorm/commit/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d).

#### 2. Insufficient path validation when building ZIP backups

The owner of a Sandstorm grain can download a backup of the grain’s content in ZIP format. Sandstorm shells out to the `zip` utility to build this archive, but does so inside a sandbox designed to prevent exploitation of bugs in the utility.

Unfortunately, a combination of factors resulted in the possibility of a minor data leak:

* The list of files to include in the archive is passed to `zip` on standard input, delimited by newlines. However, it is possible for a filename to contain a newline character. Sandstorm actually checked for this, but accidentally failed to perform the check in one code path triggered by the existence of an empty directory.
* The zip sandbox carefully hid sensitive directories like `/var`, `/proc`, and even `/etc`. However, after the zip sandbox was written, two new directories, `/etc.host` and `/run.host`, which are aliases for the host system’s `/etc` and `/run`, were added. Unfortunately, the zip sandbox was not updated to hide these directories, hence they were visible to the zip program.

As a result of this, a user could create a grain containing an empty directory named `/var/blah\n/etc.host/passwd`, save a backup, and find the backup contained a copy of the host’s `/etc/passwd` file (which, despite its name, does not contain passwords, but does contain a list of local user accounts).

**Severity:** Low. An attacker who has full user status (permission to create grains) can read files located in the server’s `/etc` and `/run` directories that are set world-readable (or specifically readable to the Sandstorm service account). No other host system directories are exposed. Usually, any files under `/etc` that contain sensitive secrets would be hidden from all users except root, hence would not be readable by Sandstorm nor by the attacker.

**Fix:** We have fixed the validation of filenames so that newlines are never permitted, and we have enhanced the zip sandbox to use a whitelist of top-level directories rather than a blacklist. Fixed in commits [4ea8df7](https://github.com/sandstorm-io/sandstorm/commit/4ea8df7403381d9b657b121b3c98d8081b27414d) and [6e8572e](https://github.com/sandstorm-io/sandstorm/commit/6e8572ea8bb56d0216bb1b410e5040edc051b120).

#### 3. Server-side request forgery

Apps running on Sandstorm can make outgoing HTTP requests through a few mechanisms. Additionally, users can instruct Sandstorm to download an app package file from an arbitrary URL. Sandstorm did not attempt to prevent these requests from reaching localhost or private network destinations. Because of this, a full user of the Sandstorm server (but not a visitor) could probe the internal network on which the Sandstorm server was hosted, as well as services exposed to localhost on the server itself.

This is a problem if unprotected services are exposed to the Sandstorm server *and* you have invited users to your server who should not be trusted to access those services. Sandstorm itself does not expose any unprotected services to localhost, so some other service must be running locally to cause a problem. Only HTTP requests are possible.

**Severity:** High **if** unprotected HTTP services are visible to the Sandstorm server *and* you have invited users to your server who should not be trusted to access those services. Otherwise, low. Sandstorm itself does not expose any unprotected services to localhost, so some other service must be running locally to cause a problem. Only HTTP requests are possible.

**Fix:** Sandstorm now allows the server admin to configure an IP address blacklist. User-initiated requests will not be allowed from these addresses. By default, standard private network address ranges are blacklisted. Annoyingly, this “fix” is likely to break some servers who use private app indexes, but avoiding such breakage would mean leaving others vulnerable. Admins will need to update their blacklists accordingly. Fixed in commit [164997f](https://github.com/sandstorm-io/sandstorm/commit/164997fb958effbc90c5328c166706280a84aaa1).

#### 4. Failure to mitigate Linux kernel CVE-2017-6074

*(This was caught by Sandstorm core developer [David Renshaw](https://github.com/dwrensha), not by DevCore, but is fixed in the same release.)*

A recent Linux kernel bug could allow a malicious app to cause a kernel panic or perhaps break out of its sandbox. The bug is in Linux, but Sandstorm aims to protect against such bugs via seccomp. [Historically, Sandstorm’s sandbox has been very successful at blocking Linux vulnerabilities before they are discovered.](https://docs.sandstorm.io/en/latest/using/security-non-events/#linux-kernel) However, this one slipped through. On Sandstorm, the published PoC exploit for this bug only causes a kernel panic (not a sandbox breakout), but a developer with deep understanding of the bug and the Linux kernel might be able to create a successful attack in other ways.

**Severity:** High if you permit users you don’t trust to install apps on your server, or commonly install apps from untrustworthy sources, and you do not keep your kernel up-to-date.

**Fix:** Sandstorm’s seccomp filter has been updated to prohibit the creation of DCCP sockets. Fixed in commit [34749f9](https://github.com/sandstorm-io/sandstorm/commit/34749f9c0141a89680860b15433e8ac9dbdbbb62).

### Conclusion

We are excited to have received such a thorough security review. Some of the problems discovered were very obscure and we’re impressed that DevCore was able to find them. We thank Audrey Tang and the Department of Cyber Security of Taiwan for commissioning this review.

* ### [Get Sandstorm](/get)

  + [Self-host Sandstorm](/get)+ [Source code (GitHub)](https://github.com/sandstorm-io/sandstorm)+ [For educators](/go/education)
* ### [Features](/features)

  + [App Market](https://apps.sandstorm.io)
  + [Core features](/features)+ [Security features](/features#security)+ [For organizations](/business)+ [For developers](/developer)
* ### [Documentation](https://docs.sandstorm.io)

  + [How to use Sandstorm](https://docs.sandstorm.io/en/latest/using/)+ [Developer Hub](https://docs.sandstorm.io/en/latest/developing/)+ [Administering & installing](https://docs.sandstorm.io/en/latest/administering/)+ [Security](https://docs.sandstorm.io/en/latest/using/security-practices/)
* ### [Technology (How it Works)](/how-it-works)

  + [Fine-grained object containers](/how-it-works#grains)+ [Capability-based security](/how-it-works#capabilities)
* ### [Community](/community)

  + [Sandstorm Blog](/news)+ [Connect with us](/community#connect-with)+ [Help others](/community#helpothers)+ [Help the project](/community#helpproject)
* ### [About](/about)

  + [Sandstorm story](/about)+ [Team](/about#team)+ [Advisors](/about#advisors)+ Contact
* ### Connect

This page was hand-crafted using only the finest web technologies.



=== Content from devco.re_35b1a190_20250125_210549.html ===


[![](/images/logo.svg)](/en/)

* Services
  [## Red Team Assessment

  Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.](/en/services/red-team/)
  [## Penetration Testing

  Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.](/en/services/penetration-test/)
  [## Security Consulting

  Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.](/en/services/security-consulting/)
  [## Security Training

  Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.](/en/services/security-training/)
* Research
  [## Overview

  Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.](/en/research/overview/)
  [## Competitions and Awards

  Awards from international cybersecurity competitions.](/en/research/awards/)
  [## Enterprise Vulnerability Reports

  Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.](/en/research/bug-bounty/)
  [## International Conferences

  Sharing vulnerability research and security knowledge at international cybersecurity conferences.](/en/research/talks/)
  [## CVE List

  Discovery of critical vulnerabilities in leading international products and services.](/en/research/cve/)
* Company
  [## Company Overview

  Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment, Penetration Testing, Security Consulting, and Security Training.](/en/company/about/)
  [## Team Members

  Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.](/en/company/our-team/)
  [## Achievements

  DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.](/en/company/history/)
  [## Corporate Social Responsibility

  We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.](/en/company/csr/)
  [## Job Opportunities

  Join us to secure the world and improve the cybersecurity industry together.](/en/company/jobs/)
* News
  [## BLOG

  Latest news](/en/blog/)
  [## Media Resources

  Media Kit, Logo and Usage Guideline](/en/media-kit/)
* [Search](/en/search/)
* [Contact](/en/contact/)

* Services
  [## Red Team Assessment](/en/services/red-team/)
  [## Penetration Testing](/en/services/penetration-test/)
  [## Security Consulting](/en/services/security-consulting/)
  [## Security Training](/en/services/security-training/)
* Research
  [## Overview](/en/research/overview/)
  [## Competitions and Awards](/en/research/awards/)
  [## Enterprise Vulnerability Reports](/en/research/bug-bounty/)
  [## International Conferences](/en/research/talks/)
  [## CVE List](/en/research/cve/)
* Company
  [## Company Overview](/en/company/about/)
  [## Team Members](/en/company/our-team/)
  [## Achievements](/en/company/history/)
  [## Corporate Social Responsibility](/en/company/csr/)
  [## Job Opportunities](/en/company/jobs/)
* News
  [## BLOG](/en/blog/)
  [## Media Resources](/en/media-kit/)
* [## Search](/en/search/)
  [## Contact](/en/contact/)
* Language
  [## 中文](/)
  [## English](/en)

# BLOG

* [All Articles](/en/blog/)
* [Tech Editorials](/en/blog/category/Tech%20Editorials/)
* [Media Resources](/en/media-kit/)

[Tech Editorials](/en/blog/category/Tech%20Editorials)
[#Advisory](/en/blog/tag/Advisory/) [#CVE](/en/blog/tag/CVE/) [#Vulnerability](/en/blog/tag/Vulnerability/)
# Sandstorm Security Review

[Shaolin](/en/blog/author/shaolin)
2018-01-26

![](https://devco.re/assets/img/blog/20180126/cover.png)

---

[Sandstorm Security Review](/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/) (English Version)

[一次在 Sandstorm 跳脫沙箱的滲透經驗](/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/) (中文版本)

## Introduction

In early 2017, we had a pentesting target protected with [Sandstorm](https://sandstorm.io/). Sandstorm is a web-based platform which allows users to install their web apps, such as WordPress, GitLab, etc. The main feature of Sandstorm is that it containerizes every app in its own sandbox. Therefore, even though we had found several vulnerabilities of the apps, we still could not put a threat to the server.

In order to leverage the vulnerabilities, we put part of efforts into review of Sandstorm’s source codes, and tried to escape the sandbox to impact the whole server. Finally, we found a number of uncommon and interesting vulnerabilities, and received CVE IDs as follows:

* CVE-2017-6198 (Denial of Service)
* CVE-2017-6199 (Bypassing Authorization Schema)
* CVE-2017-6200 (Insecure Direct Object References)
* CVE-2017-6201 (Server-Side Request Forgery)

## Exploitation Details

### CVE-2017-6198

This is a DoS created by system resource exhaustion. The root cause is that Sandstorm does not have a comprehensive policy to limit the amount of resource used by every apps run on it. In `src/sandstorm/supervisor.c++` only the maximum number of files opened by each process was limited. See the codes below:

```
void SupervisorMain::setResourceLimits() {
  struct rlimit limit;
  memset(&limit, 0, sizeof(limit));
  limit.rlim_cur = 1024;
  limit.rlim_max = 4096;
  KJ_SYSCALL(setrlimit(RLIMIT_NOFILE, &limit));
}

```

Ref: [https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824](https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c%2B%2B#L824)

Since supervisor does not restrict the amount of subprocesses and storage usage, attackers can raise a resource exhaustion attack to crash the server by simply uploading a malicious app which keeps calling fork() (aka the “fork bomb”) or consumes huge storage space.

### CVE-2017-6199

Usually Sandstorm will designate unique permissions to the specific members of a certain organization, and the default membership validation method is to check user’s email address and see whether the string after `@` exists in their white list. See the codes below:

```
if (identity.services.email.email.toLowerCase().split("@").pop() === emailDomain) {
    return true;
}

```

Ref: <https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112>

Therefore, when an attacker fills in an email like `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` and the system will automatically consider the attacker a member of the `aaa.bbb` organization.

Another key factor that contributes to the successful attack lies in one of the features when users log on Sandstorm. Users does not need to set up passwords for Sandstorm. Each time when the users need to log onto the service, they only need to fill in their email address, and they’ll receive a set of random unique password for login. The reason why the example above works is because the system treats `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` as a user from aaa.bbb domain, and the random password will be sent to the two email addresses, `[[email protected]](/cdn-cgi/l/email-protection)` and `[[email protected]](/cdn-cgi/l/email-protection)` As long as one can receive the password, they can log in to use the service.

Below is a quick demonstration:

1. On Sandstorm, restrict access to users from domain `aaa.bbb` only.
   ![](/assets/img/blog/20180126/1.png)
2. On login page, fill in `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` for the email field.
   (Note: at the front end, the email field is checked with HTML5 validation, but it is not further checked for validity at the back end)
   ![](/assets/img/blog/20180126/2.png)
3. Retrieve random password in [[email protected]](/cdn-cgi/l/email-protection) mailbox.
   ![](/assets/img/blog/20180126/3.png)
4. Login successful. `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` is considered as a user and member of `aaa.bbb` organization!
   ![](/assets/img/blog/20180126/4.png)

In our pentesting, the target website allowed users from validated domains to install their own apps. Therefore, through this bypass exploit, further attacks could be accomplished by combining other vulnerabilities described in this blog post (CVE-2017-6198, CVE-2017-6200, CVE-2017-6201).

### CVE-2017-6200

This is an interesting vulnerability. Totally two little validation flaws were exploited to initiate this attack!
On Sandstorm, owners of each Grain (Sandstorm container, in short, an app sandbox) can download their backup data for the app. But because of the two vulnerabilities in the packing process, an attacker can pack the files under the `/etc` and `/run` directories located on the server outside the sandbox. The security issues were as follows:

1. The packing process has hid `/var`, `/proc`, `/etc` and other sensitive directories, but did not hide `/etc.host` and `/run.host` these two directories. These directories are the aliases for the directories `/etc` and `/run` on the server respectively, which are relatively newer features.
2. The system will pack the legitimate files, have them sorted out, and create zip packages through the standard input interface. The separation between files are determined by line-breaks (`\n`). As a result, when a line-break string appears in the file name, illegal path file names can be injected and packed with zip. Although the app checks whether there is a line-break in the file name, but the directory name was not checked.

Ref: <https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271>

By using these two vulnerabilities together, the attacker simply has to create a directory in the sandbox `/var/exp\n/etc.host/passwd\n` , then backup files containing `/etc/passwd` on the server can be retrieved through backup downloading function.

Screenshot of a real-world scenario:

1. First, create a new directory in Grain `/var/exp\n/etc.host/passwd\n`, and use the Grain Backup function to download the backup file.
   ![](/assets/img/blog/20180126/5.png)
2. After unzipping the backup file, from `etc.host` we’ll see `/etc/passwd` of the server outside the sandbox.
   ![](/assets/img/blog/20180126/6.png)

### CVE-2017-6201

This is a classic SSRF (Server-Side Request Forgery) issue. Sandstorm allow installation of apps from arbitrary sources, and an attacker can simply let the server access a certain location by providing an installation URL. The problem was identified on `https://[target]/install/xxxChangeItEveryTimexxx?url=http://127.0.0.1:22/` This sample link confirms whether the server’s port 22 is open.

![](/assets/img/blog/20180126/7.png)

(Parse Error, which implies server’s port 22 is open)
## Follow-up Updates

After we reported the vulnerabilities, Sandstorm fixed it immediately and then published an article:
<https://sandstorm.io/news/2017-03-02-security-review>

Through this pentesting experience, we consider Sandstorm a safe platform with outstanding security mechanisms. This is mainly attributed to its fundamental design rationale: to assume that every app installed is malicious. With this vigilant assumption, Sandstorm’s defence mechanisms for the core system become comprehensive and watertight. Apart from the server-side protection, some common client-side attacks (such as XSS, CSRF) are handled properly by Sandstorm’s unique countermeasures, such as host name randomization. That is, it is very difficult for attackers to sabotage the server by simply manipulating the apps, and so does privilege escalation through attacking at the client-side.

Nevertheless, such an impressive platform still had some minor mistakes which led to security issues. Most of the vulnerabilities found this time are improper usages of libraries or negligence of existing defence architecture while introducing new features. These types of vulnerability are also common in our other projects. We would like to take the opportunity to remind developers, always present a comprehensive security review especially when developing new features to avoid vulnerabilities caused by the gaps between defence mechanisms.

[### Shaolin](/en/blog/author/shaolin)
Red Team Director

喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。

[![](/images/logo.svg)](/en/)

###### Services

* [Red Team Assessment](/en/services/red-team/)
* [Penetration Testing](/en/services/penetration-test/)
* [Security Consulting](/en/services/security-consulting/)
* [Security Training](/en/services/security-training/)

###### Research

* [Overview](/en/research/overview/)
* [Competitions and Awards](/en/research/awards/)
* [Enterprise Vulnerability Reports](/en/research/bug-bounty/)
* [International Conferences](/en/research/talks/)
* [CVE List](/en/research/cve/)

###### Company

* [Company Overview](/en/company/about/)
* [Team Members](/en/company/our-team/)
* [Achievements](/en/company/history/)
* [Corporate Social Responsibility](/en/company/csr/)
* [Job Opportunities](/en/company/jobs/)
* [Contact](/en/contact/)

###### News

* [Blog](/en/blog/)
* [Media Resources](/en/media-kit/)

© 2025 DEVCORE **All rights reserved.**
[Privacy Policy](/en/privacy-policy/)

Language :[中文](/)|[English](/en/)



=== Content from github.com_c7889316_20250125_210551.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F4ea8df7403381d9b657b121b3c98d8081b27414d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F4ea8df7403381d9b657b121b3c98d8081b27414d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=sandstorm-io%2Fsandstorm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sandstorm-io](/sandstorm-io)
/
**[sandstorm](/sandstorm-io/sandstorm)**
Public

* [Notifications](/login?return_to=%2Fsandstorm-io%2Fsandstorm) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2Fsandstorm-io%2Fsandstorm)
* [Star
   6.8k](/login?return_to=%2Fsandstorm-io%2Fsandstorm)

* [Code](/sandstorm-io/sandstorm)
* [Issues
  629](/sandstorm-io/sandstorm/issues)
* [Pull requests
  20](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects
  0](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

Additional navigation options

* [Code](/sandstorm-io/sandstorm)
* [Issues](/sandstorm-io/sandstorm/issues)
* [Pull requests](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

## Commit

[Permalink](/sandstorm-io/sandstorm/commit/4ea8df7403381d9b657b121b3c98d8081b27414d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Improve security of zip/unzip sandbox by switching the sandboxed file…

[Browse files](/sandstorm-io/sandstorm/tree/4ea8df7403381d9b657b121b3c98d8081b27414d)
Browse the repository at this point in the history

```
…system from blacklisting directories to whitelisting them.
```

* Loading branch information

[![@kentonv](https://avatars.githubusercontent.com/u/4001805?s=40&v=4)](/kentonv)

[kentonv](/sandstorm-io/sandstorm/commits?author=kentonv "View all commits by kentonv")
committed
Mar 1, 2017

1 parent
[37bd9a7](/sandstorm-io/sandstorm/commit/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d)

commit 4ea8df7

Showing
**1 changed file**
with
**14 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

27 changes: 14 additions & 13 deletions

27
[src/sandstorm/backup.c++](#diff-67752a1221f34aae82facbcc123b2a742b68c750dbe89f74c76db521f8597950 "src/sandstorm/backup.c++")

Show comments

[View file](/sandstorm-io/sandstorm/blob/4ea8df7403381d9b657b121b3c98d8081b27414d/src/sandstorm/backup.c%2B%2B)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -144,21 +144,22 @@ bool BackupMain::run(kj::StringPtr grainDir) { |
|  |  | // are undocumented. :( |
|  |  | KJ\_SYSCALL(mount("none", "/", nullptr, MS\_REC | MS\_PRIVATE, nullptr)); |
|  |  |  |
|  |  | // Mount root read-only. |
|  |  | bind(kj::str(root, "/"), "/tmp", MS\_BIND | MS\_NOSUID | MS\_RDONLY); |
|  |  |  |
|  |  | if (access("/tmp/dev/null", F\_OK) != 0) { |
|  |  | // Looks like we need to bind in /dev. |
|  |  | KJ\_SYSCALL(mount("/dev", "/tmp/dev", nullptr, MS\_BIND, nullptr)); |
|  |  | // Create tmpfs root to whitelist directories that we want to bind in. |
|  |  | KJ\_SYSCALL(mount("tmpfs", "/tmp", "tmpfs", 0, "size=8m,nr\_inodes=128,mode=755")); |
|  |  |  |
|  |  | // Bind in whitelisted directories. |
|  |  | const char\* WHITELIST[] = { "dev", "bin", "lib", "lib64", "usr" }; |
|  |  | for (const char\* dir: WHITELIST) { |
|  |  | auto src = kj::str(root, "/", dir); |
|  |  | auto dst = kj::str("/tmp/", dir); |
|  |  | if (access(src.cStr(), F\_OK) == 0) { |
|  |  | KJ\_SYSCALL(mkdir(dst.cStr(), 0755)); |
|  |  | bind(src, dst, MS\_BIND | MS\_NOSUID | MS\_RDONLY); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Hide sensitive directories. |
|  |  | KJ\_SYSCALL(mount("tmpfs", "/tmp/proc", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000")); |
|  |  | KJ\_SYSCALL(mount("tmpfs", "/tmp/var", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000")); |
|  |  | KJ\_SYSCALL(mount("tmpfs", "/tmp/etc", "tmpfs", 0, "size=32k,nr\_inodes=8,mode=000")); |
|  |  |  |
|  |  | // Mount inner tmpfs. |
|  |  | KJ\_SYSCALL(mount("tmpfs", "/tmp/tmp", "tmpfs", 0, "size=8m,nr\_inodes=128,mode=777")); |
|  |  | // Make sandboxed /tmp. |
|  |  | KJ\_SYSCALL(mkdir("/tmp/tmp", 0777)); |
|  |  |  |
|  |  | // Bind in the grain's `data` (=`sandbox`). |
|  |  | KJ\_SYSCALL(mkdir("/tmp/tmp/data", 0777)); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4ea8df7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F4ea8df7403381d9b657b121b3c98d8081b27414d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


