=== Content from devco.re_35b1a190_20250125_201733.html ===


[![](/images/logo.svg)](/en/)

* Services
  [## Red Team Assessment

  Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.](/en/services/red-team/)
  [## Penetration Testing

  Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.](/en/services/penetration-test/)
  [## Security Consulting

  Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.](/en/services/security-consulting/)
  [## Security Training

  Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.](/en/services/security-training/)
* Research
  [## Overview

  Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.](/en/research/overview/)
  [## Competitions and Awards

  Awards from international cybersecurity competitions.](/en/research/awards/)
  [## Enterprise Vulnerability Reports

  Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.](/en/research/bug-bounty/)
  [## International Conferences

  Sharing vulnerability research and security knowledge at international cybersecurity conferences.](/en/research/talks/)
  [## CVE List

  Discovery of critical vulnerabilities in leading international products and services.](/en/research/cve/)
* Company
  [## Company Overview

  Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment, Penetration Testing, Security Consulting, and Security Training.](/en/company/about/)
  [## Team Members

  Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.](/en/company/our-team/)
  [## Achievements

  DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.](/en/company/history/)
  [## Corporate Social Responsibility

  We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.](/en/company/csr/)
  [## Job Opportunities

  Join us to secure the world and improve the cybersecurity industry together.](/en/company/jobs/)
* News
  [## BLOG

  Latest news](/en/blog/)
  [## Media Resources

  Media Kit, Logo and Usage Guideline](/en/media-kit/)
* [Search](/en/search/)
* [Contact](/en/contact/)

* Services
  [## Red Team Assessment](/en/services/red-team/)
  [## Penetration Testing](/en/services/penetration-test/)
  [## Security Consulting](/en/services/security-consulting/)
  [## Security Training](/en/services/security-training/)
* Research
  [## Overview](/en/research/overview/)
  [## Competitions and Awards](/en/research/awards/)
  [## Enterprise Vulnerability Reports](/en/research/bug-bounty/)
  [## International Conferences](/en/research/talks/)
  [## CVE List](/en/research/cve/)
* Company
  [## Company Overview](/en/company/about/)
  [## Team Members](/en/company/our-team/)
  [## Achievements](/en/company/history/)
  [## Corporate Social Responsibility](/en/company/csr/)
  [## Job Opportunities](/en/company/jobs/)
* News
  [## BLOG](/en/blog/)
  [## Media Resources](/en/media-kit/)
* [## Search](/en/search/)
  [## Contact](/en/contact/)
* Language
  [## 中文](/)
  [## English](/en)

# BLOG

* [All Articles](/en/blog/)
* [Tech Editorials](/en/blog/category/Tech%20Editorials/)
* [Media Resources](/en/media-kit/)

[Tech Editorials](/en/blog/category/Tech%20Editorials)
[#Advisory](/en/blog/tag/Advisory/) [#CVE](/en/blog/tag/CVE/) [#Vulnerability](/en/blog/tag/Vulnerability/)
# Sandstorm Security Review

[Shaolin](/en/blog/author/shaolin)
2018-01-26

![](https://devco.re/assets/img/blog/20180126/cover.png)

---

[Sandstorm Security Review](/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200-en/) (English Version)

[一次在 Sandstorm 跳脫沙箱的滲透經驗](/blog/2018/01/26/Sandstorm-Security-Review-CVE-2017-6200/) (中文版本)

## Introduction

In early 2017, we had a pentesting target protected with [Sandstorm](https://sandstorm.io/). Sandstorm is a web-based platform which allows users to install their web apps, such as WordPress, GitLab, etc. The main feature of Sandstorm is that it containerizes every app in its own sandbox. Therefore, even though we had found several vulnerabilities of the apps, we still could not put a threat to the server.

In order to leverage the vulnerabilities, we put part of efforts into review of Sandstorm’s source codes, and tried to escape the sandbox to impact the whole server. Finally, we found a number of uncommon and interesting vulnerabilities, and received CVE IDs as follows:

* CVE-2017-6198 (Denial of Service)
* CVE-2017-6199 (Bypassing Authorization Schema)
* CVE-2017-6200 (Insecure Direct Object References)
* CVE-2017-6201 (Server-Side Request Forgery)

## Exploitation Details

### CVE-2017-6198

This is a DoS created by system resource exhaustion. The root cause is that Sandstorm does not have a comprehensive policy to limit the amount of resource used by every apps run on it. In `src/sandstorm/supervisor.c++` only the maximum number of files opened by each process was limited. See the codes below:

```
void SupervisorMain::setResourceLimits() {
  struct rlimit limit;
  memset(&limit, 0, sizeof(limit));
  limit.rlim_cur = 1024;
  limit.rlim_max = 4096;
  KJ_SYSCALL(setrlimit(RLIMIT_NOFILE, &limit));
}

```

Ref: [https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c++#L824](https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/supervisor.c%2B%2B#L824)

Since supervisor does not restrict the amount of subprocesses and storage usage, attackers can raise a resource exhaustion attack to crash the server by simply uploading a malicious app which keeps calling fork() (aka the “fork bomb”) or consumes huge storage space.

### CVE-2017-6199

Usually Sandstorm will designate unique permissions to the specific members of a certain organization, and the default membership validation method is to check user’s email address and see whether the string after `@` exists in their white list. See the codes below:

```
if (identity.services.email.email.toLowerCase().split("@").pop() === emailDomain) {
    return true;
}

```

Ref: <https://github.com/sandstorm-io/sandstorm/blob/v0.202/shell/packages/sandstorm-db/db.js#L1112>

Therefore, when an attacker fills in an email like `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` and the system will automatically consider the attacker a member of the `aaa.bbb` organization.

Another key factor that contributes to the successful attack lies in one of the features when users log on Sandstorm. Users does not need to set up passwords for Sandstorm. Each time when the users need to log onto the service, they only need to fill in their email address, and they’ll receive a set of random unique password for login. The reason why the example above works is because the system treats `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` as a user from aaa.bbb domain, and the random password will be sent to the two email addresses, `[[email protected]](/cdn-cgi/l/email-protection)` and `[[email protected]](/cdn-cgi/l/email-protection)` As long as one can receive the password, they can log in to use the service.

Below is a quick demonstration:

1. On Sandstorm, restrict access to users from domain `aaa.bbb` only.
   ![](/assets/img/blog/20180126/1.png)
2. On login page, fill in `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` for the email field.
   (Note: at the front end, the email field is checked with HTML5 validation, but it is not further checked for validity at the back end)
   ![](/assets/img/blog/20180126/2.png)
3. Retrieve random password in [[email protected]](/cdn-cgi/l/email-protection) mailbox.
   ![](/assets/img/blog/20180126/3.png)
4. Login successful. `[[email protected]](/cdn-cgi/l/email-protection),[[email protected]](/cdn-cgi/l/email-protection)` is considered as a user and member of `aaa.bbb` organization!
   ![](/assets/img/blog/20180126/4.png)

In our pentesting, the target website allowed users from validated domains to install their own apps. Therefore, through this bypass exploit, further attacks could be accomplished by combining other vulnerabilities described in this blog post (CVE-2017-6198, CVE-2017-6200, CVE-2017-6201).

### CVE-2017-6200

This is an interesting vulnerability. Totally two little validation flaws were exploited to initiate this attack!
On Sandstorm, owners of each Grain (Sandstorm container, in short, an app sandbox) can download their backup data for the app. But because of the two vulnerabilities in the packing process, an attacker can pack the files under the `/etc` and `/run` directories located on the server outside the sandbox. The security issues were as follows:

1. The packing process has hid `/var`, `/proc`, `/etc` and other sensitive directories, but did not hide `/etc.host` and `/run.host` these two directories. These directories are the aliases for the directories `/etc` and `/run` on the server respectively, which are relatively newer features.
2. The system will pack the legitimate files, have them sorted out, and create zip packages through the standard input interface. The separation between files are determined by line-breaks (`\n`). As a result, when a line-break string appears in the file name, illegal path file names can be injected and packed with zip. Although the app checks whether there is a line-break in the file name, but the directory name was not checked.

Ref: <https://github.com/sandstorm-io/sandstorm/blob/v0.202/src/sandstorm/backup.c%2B%2B#L271>

By using these two vulnerabilities together, the attacker simply has to create a directory in the sandbox `/var/exp\n/etc.host/passwd\n` , then backup files containing `/etc/passwd` on the server can be retrieved through backup downloading function.

Screenshot of a real-world scenario:

1. First, create a new directory in Grain `/var/exp\n/etc.host/passwd\n`, and use the Grain Backup function to download the backup file.
   ![](/assets/img/blog/20180126/5.png)
2. After unzipping the backup file, from `etc.host` we’ll see `/etc/passwd` of the server outside the sandbox.
   ![](/assets/img/blog/20180126/6.png)

### CVE-2017-6201

This is a classic SSRF (Server-Side Request Forgery) issue. Sandstorm allow installation of apps from arbitrary sources, and an attacker can simply let the server access a certain location by providing an installation URL. The problem was identified on `https://[target]/install/xxxChangeItEveryTimexxx?url=http://127.0.0.1:22/` This sample link confirms whether the server’s port 22 is open.

![](/assets/img/blog/20180126/7.png)

(Parse Error, which implies server’s port 22 is open)
## Follow-up Updates

After we reported the vulnerabilities, Sandstorm fixed it immediately and then published an article:
<https://sandstorm.io/news/2017-03-02-security-review>

Through this pentesting experience, we consider Sandstorm a safe platform with outstanding security mechanisms. This is mainly attributed to its fundamental design rationale: to assume that every app installed is malicious. With this vigilant assumption, Sandstorm’s defence mechanisms for the core system become comprehensive and watertight. Apart from the server-side protection, some common client-side attacks (such as XSS, CSRF) are handled properly by Sandstorm’s unique countermeasures, such as host name randomization. That is, it is very difficult for attackers to sabotage the server by simply manipulating the apps, and so does privilege escalation through attacking at the client-side.

Nevertheless, such an impressive platform still had some minor mistakes which led to security issues. Most of the vulnerabilities found this time are improper usages of libraries or negligence of existing defence architecture while introducing new features. These types of vulnerability are also common in our other projects. We would like to take the opportunity to remind developers, always present a comprehensive security review especially when developing new features to avoid vulnerabilities caused by the gaps between defence mechanisms.

[### Shaolin](/en/blog/author/shaolin)
Red Team Director

喜愛資訊技術、喜歡跟別人走不一樣的路。有一點點智障的熱血人，期望能利用資訊的力量對世界有所貢獻。

[![](/images/logo.svg)](/en/)

###### Services

* [Red Team Assessment](/en/services/red-team/)
* [Penetration Testing](/en/services/penetration-test/)
* [Security Consulting](/en/services/security-consulting/)
* [Security Training](/en/services/security-training/)

###### Research

* [Overview](/en/research/overview/)
* [Competitions and Awards](/en/research/awards/)
* [Enterprise Vulnerability Reports](/en/research/bug-bounty/)
* [International Conferences](/en/research/talks/)
* [CVE List](/en/research/cve/)

###### Company

* [Company Overview](/en/company/about/)
* [Team Members](/en/company/our-team/)
* [Achievements](/en/company/history/)
* [Corporate Social Responsibility](/en/company/csr/)
* [Job Opportunities](/en/company/jobs/)
* [Contact](/en/contact/)

###### News

* [Blog](/en/blog/)
* [Media Resources](/en/media-kit/)

© 2025 DEVCORE **All rights reserved.**
[Privacy Policy](/en/privacy-policy/)

Language :[中文](/)|[English](/en/)



=== Content from github.com_f53357ba_20250125_201739.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=sandstorm-io%2Fsandstorm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sandstorm-io](/sandstorm-io)
/
**[sandstorm](/sandstorm-io/sandstorm)**
Public

* [Notifications](/login?return_to=%2Fsandstorm-io%2Fsandstorm) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2Fsandstorm-io%2Fsandstorm)
* [Star
   6.8k](/login?return_to=%2Fsandstorm-io%2Fsandstorm)

* [Code](/sandstorm-io/sandstorm)
* [Issues
  629](/sandstorm-io/sandstorm/issues)
* [Pull requests
  20](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects
  0](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

Additional navigation options

* [Code](/sandstorm-io/sandstorm)
* [Issues](/sandstorm-io/sandstorm/issues)
* [Pull requests](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

## Commit

[Permalink](/sandstorm-io/sandstorm/commit/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Validate e-mail addresses more strictly.

[Browse files](/sandstorm-io/sandstorm/tree/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d)
Browse the repository at this point in the history

* Loading branch information

[![@kentonv](https://avatars.githubusercontent.com/u/4001805?s=40&v=4)](/kentonv)

[kentonv](/sandstorm-io/sandstorm/commits?author=kentonv "View all commits by kentonv")
committed
Mar 1, 2017

1 parent
[d534fcb](/sandstorm-io/sandstorm/commit/d534fcbbc2b9b0e2f94fa3d7d1f11fdf2f8fc2e4)

commit 37bd9a7

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**44 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* shell

  + imports/server

    - shell/imports/server/email.js
      [email.js](#diff-76df405cae39023e8212bc23f5c637424a05976e372a7a91f6774d48442ec408)
  + packages/sandstorm-db

    - shell/packages/sandstorm-db/db.js
      [db.js](#diff-8da55536aca37fb3cbdeea27f073556eec03c208f197178deb00f749f4406236)
  + server

    - accounts/email-token

      * shell/server/accounts/email-token/token-server.js
        [token-server.js](#diff-3032547639d5dfa95a6b90168916cd34f6bc059e07825ec27e6f06f8b60ae18c)
    - shell/server/admin-server.js
      [admin-server.js](#diff-f5813027d753684832af4e95fcdfeae9011b81948b50176f475c1ef4a63cc2c9)

## There are no files selected for viewing

36 changes: 36 additions & 0 deletions

36
[shell/imports/server/email.js](#diff-76df405cae39023e8212bc23f5c637424a05976e372a7a91f6774d48442ec408 "shell/imports/server/email.js")

Show comments

[View file](/sandstorm-io/sandstorm/blob/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d/shell/imports/server/email.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -75,13 +75,49 @@ const getPool = function (smtpConfig) { |
|  |  | }; |
|  |  |  |
|  |  | const smtpSend = function (pool, mailOptions) { |
|  |  | console.log(mailOptions); |
|  |  | pool.\_futureWrappedSendMail(mailOptions).wait(); |
|  |  | }; |
|  |  |  |
|  |  | // From http://emailregex.com/, which claims this is the W3C standard for the HTML input element, |
|  |  | // although their link is broken and I can find no evidence that this is a standard. The page |
|  |  | // lists several regexes, ostensibly in syntaxes intended for different programming languages, |
|  |  | // but each regex is in fact substantially different for no apparent reason. |
|  |  | // |
|  |  | // The most important thing here is that we disallow separators that might allow a user to confuse |
|  |  | // nodemailer into thinking the address is a list. Unfortunately, nodemailer will happily separate |
|  |  | // strings into lists splitting on all kinds of separator characters, such as commas, semicolons, |
|  |  | // etc. This regex should accomplish that both by disallowing the separators, and by disallowing |
|  |  | // multiple @ signs. The rest is for show. |
|  |  | const EMAIL\_REGEX = /^[a-zA-Z0-9.!#$%&’\*+/=?^\_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)\*$/; |
|  |  |  |
|  |  | function validateEmail(email) { |
|  |  | if (email instanceof Array) { |
|  |  | email.forEach(validateEmail); |
|  |  | } else if (typeof email === "object" && "address" in email) { |
|  |  | validateEmail(email.address); |
|  |  | } else if (email) { |
|  |  | check(email, String); |
|  |  |  |
|  |  | if (!email.match(EMAIL\_REGEX)) { |
|  |  | console.log(email); |
|  |  | throw new Meteor.Error(400, "invalid e-mail address"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | const rawSend = function (mailOptions, smtpConfig) { |
|  |  | // Sends an email mailOptions object structured as described in |
|  |  | // https://github.com/nodemailer/mailcomposer#e-mail-message-fields |
|  |  | // across the transport described by smtpConfig. |
|  |  |  |
|  |  | // For fields that are supposed to be lists of addresses, if only a single string is provided, |
|  |  | // wrap it in an array. This prevents nodemailer from interpreting the address as a |
|  |  | // comma-separated list. |
|  |  | ["from", "to", "cc", "bcc", "replyTo"].forEach(field => { |
|  |  | validateEmail(mailOptions[field]); |
|  |  | }); |
|  |  |  |
|  |  | const pool = getPool(smtpConfig); |
|  |  | if (pool) { |
|  |  | smtpSend(pool, mailOptions); |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[shell/packages/sandstorm-db/db.js](#diff-8da55536aca37fb3cbdeea27f073556eec03c208f197178deb00f749f4406236 "shell/packages/sandstorm-db/db.js")

Show comments

[View file](/sandstorm-io/sandstorm/blob/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d/shell/packages/sandstorm-db/db.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1516,9 +1516,11 @@ \_.extend(SandstormDb.prototype, { |
|  |  |  |
|  |  | // First remove any instances of characters that cause trouble for SimpleSmtp. Ideally, |
|  |  | // we could escape such characters with a backslash, but that does not seem to help here. |
|  |  | // TODO(cleanup): Unclear whether this sanitization is still necessary now that we return a |
|  |  | // structured object and have moved to nodemailer. I'm not touching it for now. |
|  |  | const sanitized = displayName.replace(/"|<|>|\\|\r/g, ""); |
|  |  |  |
|  |  | return "\"" + sanitized + "\" <" + this.getReturnAddress() + ">"; |
|  |  | return { name: sanitized, address: this.getReturnAddress() }; |
|  |  | }, |
|  |  |  |
|  |  | getPrimaryEmail(accountId, identityId) { |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[shell/server/accounts/email-token/token-server.js](#diff-3032547639d5dfa95a6b90168916cd34f6bc059e07825ec27e6f06f8b60ae18c "shell/server/accounts/email-token/token-server.js")

Show comments

[View file](/sandstorm-io/sandstorm/blob/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d/shell/server/accounts/email-token/token-server.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -199,7 +199,7 @@ const sendTokenEmail = function (db, email, token, options) { |
|  |  |  |
|  |  | const sendOptions = { |
|  |  | to: email, |
|  |  | from: db.getServerTitle() + " <" + db.getReturnAddress() + ">", |
|  |  | from: { name: globalDb.getServerTitle(), address: db.getReturnAddress() }, |
|  |  | subject: subject, |
|  |  | text: text, |
|  |  | }; |
| Expand Down | |  |

7 changes: 4 additions & 3 deletions

7
[shell/server/admin-server.js](#diff-f5813027d753684832af4e95fcdfeae9011b81948b50176f475c1ef4a63cc2c9 "shell/server/admin-server.js")

Show comments

[View file](/sandstorm-io/sandstorm/blob/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d/shell/server/admin-server.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -185,7 +185,7 @@ Meteor.methods({ |
|  |  | try { |
|  |  | sendEmail({ |
|  |  | to: to, |
|  |  | from: globalDb.getServerTitle() + " <" + returnAddress + ">", |
|  |  | from: { name: globalDb.getServerTitle(), address: returnAddress }, |
|  |  | subject: "Testing your Sandstorm's SMTP setting", |
|  |  | text: "Success! Your outgoing SMTP is working.", |
|  |  | smtpConfig: restConfig, |
| Expand Down  Expand Up | | @@ -224,10 +224,11 @@ Meteor.methods({ |
|  |  |  |
|  |  | sendInvites: function (token, origin, from, list, subject, message, quota) { |
|  |  | checkAuth(token); |
|  |  | check([origin, from, list, subject, message], [String]); |
|  |  | check(from, { name: String, address: String }); |
|  |  | check([origin, list, subject, message], [String]); |
|  |  | check(quota, Match.OneOf(undefined, null, Number)); |
|  |  |  |
|  |  | if (!from.trim()) { |
|  |  | if (!from.address.trim()) { |
|  |  | throw new Meteor.Error(403, "Must enter 'from' address."); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `37bd9a7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fcommit%2F37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c5a12808_20250125_201736.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fblob%2Fv0.202%2Fshell%2Fpackages%2Fsandstorm-db%2Fdb.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsandstorm-io%2Fsandstorm%2Fblob%2Fv0.202%2Fshell%2Fpackages%2Fsandstorm-db%2Fdb.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=sandstorm-io%2Fsandstorm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sandstorm-io](/sandstorm-io)
/
**[sandstorm](/sandstorm-io/sandstorm)**
Public

* [Notifications](/login?return_to=%2Fsandstorm-io%2Fsandstorm) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2Fsandstorm-io%2Fsandstorm)
* [Star
   6.8k](/login?return_to=%2Fsandstorm-io%2Fsandstorm)

* [Code](/sandstorm-io/sandstorm/tree/v0.202)
* [Issues
  629](/sandstorm-io/sandstorm/issues)
* [Pull requests
  20](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects
  0](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

Additional navigation options

* [Code](/sandstorm-io/sandstorm/tree/v0.202)
* [Issues](/sandstorm-io/sandstorm/issues)
* [Pull requests](/sandstorm-io/sandstorm/pulls)
* [Actions](/sandstorm-io/sandstorm/actions)
* [Projects](/sandstorm-io/sandstorm/projects)
* [Wiki](/sandstorm-io/sandstorm/wiki)
* [Security](/sandstorm-io/sandstorm/security)
* [Insights](/sandstorm-io/sandstorm/pulse)

## Files

 v0.202
## Breadcrumbs

1. [sandstorm](/sandstorm-io/sandstorm/tree/v0.202)
2. /[shell](/sandstorm-io/sandstorm/tree/v0.202/shell)
3. /[packages](/sandstorm-io/sandstorm/tree/v0.202/shell/packages)
4. /[sandstorm-db](/sandstorm-io/sandstorm/tree/v0.202/shell/packages/sandstorm-db)
/
# db.js

Copy path Blame  Blame
## Latest commit

## History

[History](/sandstorm-io/sandstorm/commits/v0.202/shell/packages/sandstorm-db/db.js)2865 lines (2483 loc) · 115 KB v0.202
## Breadcrumbs

1. [sandstorm](/sandstorm-io/sandstorm/tree/v0.202)
2. /[shell](/sandstorm-io/sandstorm/tree/v0.202/shell)
3. /[packages](/sandstorm-io/sandstorm/tree/v0.202/shell/packages)
4. /[sandstorm-db](/sandstorm-io/sandstorm/tree/v0.202/shell/packages/sandstorm-db)
/
# db.js

Top
## File metadata and controls

* Code
* Blame

2865 lines (2483 loc) · 115 KB[Raw](https://github.com/sandstorm-io/sandstorm/raw/refs/tags/v0.202/shell/packages/sandstorm-db/db.js)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000// Sandstorm - Personal Cloud Sandbox// Copyright (c) 2014 Sandstorm Development Group, Inc. and contributors// All rights reserved.//// Licensed under the Apache License, Version 2.0 (the "License");// you may not use this file except in compliance with the License.// You may obtain a copy of the License at//// http://www.apache.org/licenses/LICENSE-2.0//// Unless required by applicable law or agreed to in writing, software// distributed under the License is distributed on an "AS IS" BASIS,// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.// See the License for the specific language governing permissions and// limitations under the License.
// This file defines the database schema.
// Useful for debugging: Set the env variable LOG\_MONGO\_QUERIES to have the server write every// query it makes, so you can see if it's doing queries too often, etc.if (Meteor.isServer && process.env.LOG\_MONGO\_QUERIES) { const oldFind = Mongo.Collection.prototype.find; Mongo.Collection.prototype.find = function () { console.log(this.\_prefix, arguments); return oldFind.apply(this, arguments); };}
// Helper so that we don't have to if (Meteor.isServer) before declaring indexes.if (Meteor.isServer) { Mongo.Collection.prototype.ensureIndexOnServer = Mongo.Collection.prototype.\_ensureIndex;} else { Mongo.Collection.prototype.ensureIndexOnServer = function () {};}
// TODO(soon): Systematically go through this file and add ensureIndexOnServer() as needed.
const collectionOptions = { defineMutationMethods: Meteor.isClient };// Set to `true` on the client so that method simulation works. Set to `false` on the server// so that we can be extra certain that all mutations must go through methods.
// Users = new Mongo.Collection("users");// The users collection is special and can be accessed through `Meteor.users`.// See https://docs.meteor.com/#/full/meteor\_users.//// There are two distinct types of entries in the users collection: identities and accounts. An// identity contains personal profile information and typically includes some intrinsic method for// authenticating as the owner of that information.//// An account is an owner of app actions, grains, contacts, notifications, and payment info.// Each account can have multiple identities linked to it. To log in as an account you must first// authenticate as one of its linked identities.//// Every user contains the following fields:// \_id: Unique string ID. For accounts, this is random. For identities, this is the globally// stable SHA-256 ID of this identity, hex-encoded.// createdAt: Date when this entry was added to the collection.// lastActive: Date of the user's most recent interaction with this Sandstorm server.// services: Object containing login data used by Meteor authentication services.// expires: Date when this user should be deleted. Only present for demo users.// upgradedFromDemo: If present, the date when this user was upgraded from being a demo user.// TODO(cleanup): Unlike other dates in our database, this is stored as a number// rather than as a Date object. We should fix that.// appDemoId: If present and non-null, then the user is a demo user who arrived via an /appdemo/// link. This field contains the app ID of the app that the user started out demoing.// Unlike the `expires` field, this field is not cleared when the user upgrades from// being a demo user.// suspended: If this exists, this account/identity is supsended. Both accounts and identities// can be suspended. After some amount of time, the user will be completely deleted// and removed from the DB.// It is an object with fields:// voluntary: Boolean. This is true if the user initiated it. They will have the// chance to still login and reverse the suspension/deletion.// admin: The userId of the admin who suspended the account.// timestamp: Date object. When the suspension occurred.// willDelete: Boolean. If true, this account will be deleted after some time.//// Identity users additionally contain the following fields:// profile: Object containing the data that will be shared with users and grains that come into// contact with this identity. Includes the following fields:// service: String containing the name of this identity's authentication method.// name: String containing the chosen display name of the identity.// handle: String containing the identity's preferred handle.// picture: \_id into the StaticAssets table for the identity's picture. If not present,// an identicon will be used.// pronoun: One of "male", "female", "neutral", or "robot".// unverifiedEmail: If present, a string containing an email address specified by the user.// referredBy: ID of the Account that referred this Identity.//// Account users additionally contain the following fields:// loginIdentities: Array of identity objects, each of which may include the following fields.// id: The globally-stable SHA-256 ID of this identity, hex-encoded.// nonloginIdentities: Array of identity objects, of the same form as `loginIdentities`. We use// a separate array here so that we can use a Mongo index to enforce the// invariant that an identity only be a login identity for a single account.// primaryEmail: String containing this account's primary email address. Must be a verified adress// of one of this account's linked identities. Call SandstormDb.getUserEmails()// to do this checking automatically.// isAdmin: Boolean indicating whether this account is allowed to access the Sandstorm admin panel.// signupKey: If this is an invited user, then this field contains their signup key.// signupNote: If the user was invited through a link, then this field contains the note that the// inviter admin attached to the key.// signupEmail: If the user was invited by email, then this field contains the email address that// the invite was sent to.// hasCompletedSignup: True if this account has confirmed its profile and agreed to this server's// terms of service.// plan: \_id of an entry in the Plans table which determines the user's quota.// planBonus: {storage, compute, grains} bonus amounts to add to the user's plan. The payments// module writes data here; we merely read it. Missing fields should be treated as// zeroes. Does not yet include referral bonus, which is calculated separately.// TODO(cleanup): Use for referral bonus too.// storageUsage: Number of bytes this user is currently storing.// payments: Object defined by payments module, if loaded.// dailySentMailCount: Number of emails sent by this user today; used to limit spam.// accessRequests: Object containing the following fields; used to limit spam.// count: Number of "request access" emails during sent during the current interval.// resetOn: Date when the count should be reset.// referredByComplete: ID of the Account that referred this Account. If this is set, we// stop writing new referredBy values onto Identities for this account.// referredCompleteDate: The Date at which the completed referral occurred.// referredIdentityIds: List of Identity IDs that this Account has referred. This is used for// reliably determining which Identity's names are safe to display.// experiments: Object where each field is an experiment that the user is in, and each value// is the parameters for that experiment. Typically, the value simply names which// experiment group which the user is in, where "control" is one group. If an experiment// is not listed, then the user should not be considered at all for the purpose of that// experiment. Each experiment may define a point in time where users not already in the// experiment may be added to it and assigned to a group (for example, at user creation// time). Current experiments:// firstTimeBillingPrompt: Value is "control" or "test". Users are assigned to groups at// account creation on servers where billing is enabled (i.e. Oasis). Users in the// test group will see a plan selection dialog and asked to make an explitic choice// (possibly "free") before they can create grains (but not when opening someone// else's shared grain). The goal of the experiment is to determine whether this// prompt scares users away -- and also whether it increases paid signups.// freeGrainLimit: Value is "control" or or a number indicating the grain limit that the// user should receive when on the "free" plan, e.g. "Infinity".// stashedOldUser: A complete copy of this user from before the accounts/identities migration.// TODO(cleanup): Delete this field once we're sure it's safe to do so.
Meteor.users.ensureIndexOnServer("services.google.email", { sparse: 1 });Meteor.users.ensureIndexOnServer("services.github.emails.email", { sparse: 1 });Meteor.users.ensureIndexOnServer("services.email.email", { unique: 1, sparse: 1 });Meteor.users.ensureIndexOnServer("loginIdentities.id", { unique: 1, sparse: 1 });Meteor.users.ensureIndexOnServer("nonloginIdentities.id", { sparse: 1 });Meteor.users.ensureIndexOnServer("services.google.id", { unique: 1, sparse: 1 });Meteor.users.ensureIndexOnServer("services.github.id", { unique: 1, sparse: 1 });Meteor.users.ensureIndexOnServer("suspended.willDelete", { sparse: 1 });
// TODO(cleanup): This index is obsolete; delete it.Meteor.users.ensureIndexOnServer("identities.id", { unique: 1, sparse: 1 });
Packages = new Mongo.Collection("packages", collectionOptions);// Packages which are installed or downloading.//// Each contains:// \_id: 128-bit prefix of SHA-256 hash of spk file, hex-encoded.// status: String. One of "download", "verify", "unpack", "analyze", "ready", "failed", "delete"// progress: Float. -1 = N/A, 0-1 = fractional progress (e.g. download percentage),// >1 = download byte count.// error: If status is "failed", error message string.// manifest: If status is "ready", the package manifest. See "Manifest" in package.capnp.// appId: If status is "ready", the application ID string. Packages representing different// versions of the same app have the same appId. The spk tool defines the app ID format// and can cryptographically verify that a package belongs to a particular app ID.// shouldCleanup: If true, a reference to this package was recently dropped, and the package// collector should at some point check whether there are any other references and, if not,// delete the package.// url: When status is "download", the URL from which the SPK can be obtained, if provided.// isAutoUpdated: This package was downloaded as part of an auto-update. We shouldn't clean it up// even if it has no users.// authorPgpKeyFingerprint: Verified PGP key fingerprint (SHA-1, hex, all-caps) of the app// packager.
DevPackages = new Mongo.Collection("devpackages", collectionOptions);// List of packages currently made available via the dev tools running on the local machine.// This is normally empty; the only time it is non-empty is when a developer is using the spk tool// on the local machine to publish an under-development app to this server. That should only ever// happen on developers' desktop machines.//// While a dev package is published, it automatically appears as installed by every user of the// server, and it overrides all packages with the same application ID. If any instances of those// packages are currently open, they are killed and reset on publish.//// When the dev tool disconnects, the package is automatically unpublished, and any open instances// are again killed and refreshed.//// Each contains:// \_id: The package ID string (as with Packages.\_id).// appId: The app ID this package is intended to override (as with Packages.appId).// timestamp: Time when the package was last updated. If this changes while the package is// published, all running instances are reset. This is used e.g. to reset the app each time// changes are made to the source code.// manifest: The app's manifest, as with Packages.manifest.// mountProc: True if the supervisor should mount /proc.
UserActions = new Mongo.Collection("userActions", collectionOptions);// List of actions that each user has installed which create new grains. Each app may install// some number of actions (usually, one).//// Each contains:// \_id: random// userId: Account ID of the user who has installed this action.// packageId: Package used to run this action.// appId: Same as Packages.findOne(packageId).appId; denormalized for searchability.// appTitle: Same as Packages.findOne(packageId).manifest.appTitle; denormalized so// that clients can access it without subscribing to the Packages collection.// appVersion: Same as Packages.findOne(packageId).manifest.appVersion; denormalized for// searchability.// appMarketingVersion: Human-readable presentation of the app version, e.g. "2.9.17"// title: JSON-encoded LocalizedText title for this action, e.g.// `{defaultText: "New Spreadsheet"}`.// nounPhrase: JSON-encoded LocalizedText describing what is created when this action is run.// command: Manifest.Command to run this action (see package.capnp).
Grains = new Mongo.Collection("grains", collectionOptions);// Grains belonging to users.//// Each contains:// \_id: random// packageId: \_id of the package of which this grain is an instance.// packageSalt: If present, a random string that will used in session ID generation. This field// is usually updated when `packageId` is updated, triggering automatic refreshes for// clients with active sessions.// appId: Same as Packages.findOne(packageId).appId; denormalized for searchability.// appVersion: Same as Packages.findOne(packageId).manifest.appVersion; denormalized for// searchability.// userId: The \_id of the account that owns this grain.// identityId: The identity with which the owning account prefers to open this grain.// title: Human-readable string title, as chosen by the user.// lastUsed: Date when the grain was last used by a user.// private: If true, then knowledge of `\_id` does not suffice to open this grain.// cachedViewInfo: The JSON-encoded result of `UiView.getViewInfo()`, cached from the most recent// time a session to this grain was opened.// trashed: If present, the Date when this grain was moved to the trash bin. Thirty days after// this date, the grain will be automatically deleted.// suspended: If true, the owner of this grain has been suspended. They will soon be deleted,// so treat this grain the same as "trashed". It is denormalized out of Users for ease// of querying.// ownerSeenAllActivity: True if the owner has viewed the grain since the last activity event// occurred. See also ApiTokenOwner.user.seenAllActivity.// size: On-disk size of the grain in bytes.//// The following fields \*might\* also exist. These are temporary hacks used to implement e-mail and// web publishing functionality without powerbox support; they will be replaced once the powerbox// is implemented.// publicId: An id used to publicly identify this grain. Used e.g. to route incoming e-mail and// web publishing. This field is initialized when first requested by the app.
Grains.ensureIndexOnServer("cachedViewInfo.matchRequests.tags.id", { sparse: 1 });
RoleAssignments = new Mongo.Collection("roleAssignments", collectionOptions);// \*OBSOLETE\* Before `user` was a variant of ApiTokenOwner, this collection was used to store edges// in the permissions sharing graph. This functionality has been subsumed by the ApiTokens// collection.
Contacts = new Mongo.Collection("contacts", collectionOptions);// Edges in the social graph.//// If Alice has Bob as a contact, then she is allowed to see Bob's profile information and Bob// will show up in her user-picker UI for actions like share-by-identity.//// Contacts are not symmetric. Bob might be one of Alice's contacts even if Alice is not one of// Bob's.//// Each contains:// \_id: random// ownerId: The accountId of the user account who owns this contact.// petname: Human-readable label chosen by and only visible to the owner. Uniquely identifies// the contact to the owner.// created: Date when this contact was created.// identityId: The `\_id` of the user whose contact info this contains.
Sessions = new Mongo.Collection("sessions", collectionOptions);// UI sessions open to particular grains. A new session is created each time a user opens a grain.//// Each contains:// \_id: String generated as a SHA256 hash of the grain ID, the user ID, a salt generated by the// client, and the grain's `packageSalt`.// grainId: \_id of the grain to which this session is connected.// hostId: ID part of the hostname from which this grain is being served. I.e. this replaces the// '\*' in WILDCARD\_HOST.// tabId: Random value unique to the grain tab in which this session is displayed. Typically// every session has a different `tabId`, but embedded sessions (including in the powerbox)// have the same `tabId` as the outer session.// timestamp: Time of last keep-alive message to this session. Sessions time out after some// period.// userId: Account ID of the user who owns this session.// identityId: Identity ID of the user who owns this session.// hashedToken: If the session is owned by an anonymous user, the \_id of the entry in ApiTokens// that was used to open it. Note that for old-style sharing (i.e. when !grain.private),// anonymous users can get access without an API token and so neither userId nor hashedToken// are present.// powerboxView: Information about a server-initiated powerbox interaction taking place in this// session. When the client sees a `powerboxView` appear on the session, it opens the// powerbox popup according to the contents. This field is an object containing one of:// offer: A capability is being offered to the user by the app. This is an object containing:// token: For a non-UiView capability, the API token that can be used to restore this// capability.// uiView: A UiView capability. This object contains one of:// tokenId: The \_id of an ApiToken belonging to the current user.// token: A full webkey token which can be opened by an anonymous user.// fulfill: A capability is being offered which fulfills the active powerbox request. This// is an object with members:// token: The SturdyRef of the fulfilling capability. This token can only be used in a call// to claimRequest() by the requesting// grain.// descriptor: Packed-base64 PowerboxDescriptor for the capability.// powerboxRequest: If present, this session is a powerbox request session. Object containing:// descriptors: Array of PowerboxDescriptors representing the request.// requestingSession: Session ID of the session initiating the request.// viewInfo: The UiView.ViewInfo corresponding to the underlying UiSession. This isn't populated// until newSession is called on the UiView.// permissions: The permissions for the current identity on this UiView. This isn't populated// until newSession is called on the UiView.// hasLoaded: Marked as true by the proxy when the underlying UiSession has responded to its first// request
SignupKeys = new Mongo.Collection("signupKeys", collectionOptions);// Invite keys which may be used by users to get access to Sandstorm.//// Each contains:// \_id: random// used: Boolean indicating whether this key has already been consumed.// note: Text note assigned when creating key, to keep track of e.g. whom the key was for.// email: If this key was sent as an email invite, the email address to which it was sent.
ActivityStats = new Mongo.Collection("activityStats", collectionOptions);// Contains usage statistics taken on a regular interval. Each entry is a data point.//// Each contains:// timestamp: Date when measurements were taken.// daily: Contains stats counts pertaining to the last day before the sample time.// weekly: Contains stats counts pertaining to the last seven days before the sample time.// monthly: Contains stats counts pertaining to the last thirty days before the timestamp.//// Each of daily, weekly, and monthly contains:// activeUsers: The number of unique users who have used a grain on the server in the time// interval. Only counts logged-in users.// demoUsers: Demo users.// appDemoUsers: Users that came in through "app demo".// activeGrains: The number of unique grains that have been used in the time interval.// apps: An object indexed by app ID recording, for each app:// owners: Number of unique owners of this app (counting only grains that still exist).// sharedUsers: Number of users who have accessed other people's grains of this app (counting// only grains that still exist).// grains: Number of active grains of this app (that still exist).// deleted: Number of non-demo grains of this app that were deleted.// demoed: Number of demo grains created and expired.// appDemoUsers: Number of app demos initiated with this app.
DeleteStats = new Mongo.Collection("deleteStats", collectionOptions);// Contains records of objects that were deleted, for stat-keeping purposes.//// Each contains:// type: "grain" or "user" or "demoGrain" or "demoUser" or "appDemoUser"// lastActive: Date of the user's or grain's last activity.// appId: For type = "grain", the app ID of the grain. For type = "appDemoUser", the app ID they// arrived to demo. For others, undefined.// experiments: The experiments the user (or owner of the grain) was in. See user.experiments.
FileTokens = new Mongo.Collection("fileTokens", collectionOptions);// Tokens corresponding to backup files that are currently stored on the server. A user receives// a token when they create a backup file (either by uploading it, or by backing up one of their// grains) and may use the token to read the file (either to download it, or to restore a new// grain from it).//// Each contains:// \_id: The unguessable token string.// name: Suggested filename.// timestamp: File creation time. Used to figure out when the token and file should be wiped.
ApiTokens = new Mongo.Collection("apiTokens", collectionOptions);// Access tokens for APIs exported by apps.//// Originally API tokens were only used by external users through the HTTP API endpoint. However,// now they are also used to implement SturdyRefs, not just held by external users, but also when// an app holds a SturdyRef to another app within the same server. See the various `save()`,// `restore()`, and `drop()` methods in `grain.capnp` (on `SandstormApi`, `AppPersistent`, and// `MainView`) -- the fields of type `Data` are API tokens.//// Each contains:// \_id: A SHA-256 hash of the token, base64-encoded.// grainId: The grain servicing this API. (Not present if the API isn't serviced by a grain.)// identityId: For UiView capabilities, this is the identity for which the view is attenuated.// That is, the UiView's newSession() method will intersect the requested permissions// with this identity's permissions before forwarding on to the underlying app. If// `identityId` is not present, then no identity attenuation is applied, i.e. this is// a raw UiView as implemented by the app. (The `roleAssignment` field, below, may// still apply. For non-UiView capabilities, `identityId` is never present. Note that// this is NOT the identity against which the `requiredPermissions` parameter of// `SandstormApi.restore()` is checked; that would be `owner.grain.introducerIdentity`.// accountId: For tokens where `identityId` is set, the `\_id` (in the Users table) of the account// that created the token.// roleAssignment: If this API token represents a UiView, this field contains a JSON-encoded// Grain.ViewSharingLink.RoleAssignment representing the permissions it carries. These// permissions will be intersected with those held by `identityId` when the view is// opened.// forSharing: If true, requests sent to the HTTP API endpoint with this token will be treated as// anonymous rather than as directly associated with `identityId`. This has no effect// on the permissions granted.// objectId: If present, this token represents an arbitrary Cap'n Proto capability exported by// the app or its supervisor (whereas without this it strictly represents UiView).// sturdyRef is the JSON-encoded SupervisorObjectId (defined in `supervisor.capnp`).// Note that if the SupervisorObjectId contains an AppObjectId, that field is// treated as type AnyPointer, and so encoded as a raw Cap'n Proto message.// frontendRef: If present, this token actually refers to an object implemented by the front-end,// not a particular grain. (`grainId` and `identityId` are not set.) This is an object// containing exactly one of the following fields:// notificationHandle: A `Handle` for an ongoing notification, as returned by// `NotificationTarget.addOngoing`. The value is an `\_id` from the// `Notifications` collection.// ipNetwork: An IpNetwork capability that is implemented by the frontend. Eventually, this// will be moved out of the frontend and into the backend, but we'll migrate the// database when that happens. This field contains the boolean true to signify that// it has been set.// ipInterface: Ditto IpNetwork, except it's an IpInterface.// emailVerifier: An EmailVerifier capability that is implemented by the frontend. The// value is an object containing the fields `id` and `services`. `id` is the// value returned by `EmailVerifier.getId()` and is used as part of a// powerbox query for matching verified emails. `services` is a// list of names of identity providers that are trusted to verify addresses.// If `services` is omitted or falsy, all configured identity providers are// trusted. Note that a malicious user could specify invalid names in the// list; they should be ignored.// verifiedEmail: An VerifiedEmail capability that is implemented by the frontend.// An object containing `verifierId`, `tabId`, and `address`.// identity: An Identity capability. The field is the identity ID.// parentToken: If present, then this token represents exactly the capability represented by// the ApiToken with \_id = parentToken, except possibly (if it is a UiView) attenuated// by `roleAssignment` (if present). To facilitate permissions computations, if the// capability is a UiView, then `grainId` is set to the backing grain, `identityId`// is set to the identity that shared the view, and `accountId` is set to the account// that shared the view. Neither `objectId` nor `frontendRef` is present when// `parentToken` is present.// petname: Human-readable label for this access token, useful for identifying tokens for// revocation. This should be displayed when visualizing incoming capabilities to// the grain identified by `grainId`.// created: Date when this token was created.// revoked: If true, then this sturdyref has been revoked and can no longer be restored. It may// become un-revoked in the future.// trashed: If present, the Date when this token was moved to the trash bin. Thirty days after// this date, the token will be automatically deleted.// suspended: If true, the owner of this token has been suspended. They will soon be deleted,// so treat this token the same as "trashed". It is denormalized out of Users for// ease of querying.// expires: Optional expiration Date. If undefined, the token does not expire.// lastUsed: Optional Date when this token was last used.// owner: A `ApiTokenOwner` (defined in `supervisor.capnp`, stored as a JSON object)// as passed to the `save()` call that created this token. If not present, treat// as `webkey` (the default for `ApiTokenOwner`).// expiresIfUnused:// Optional Date after which the token, if it has not been used yet, expires.// This field should be cleared on a token's first use.// requirements: List of conditions which must hold for this token to be considered valid.// Semantically, this list specifies the powers which were \*used\* to originally// create the token. If any condition in the list becomes untrue, then the token must// be considered revoked, and all live refs and sturdy refs obtained transitively// through it must also become revoked. Each item is the JSON serialization of the// `MembraneRequirement` structure defined in `supervisor.capnp`.// hasApiHost: If true, there is an entry in ApiHosts for this token, which will need to be// cleaned up when the token is.//// It is important to note that a token's owner and provider are independent from each other. To// illustrate, here is an approximate definition of ApiToken in pseudo Cap'n Proto schema language://// struct ApiToken {// owner :ApiTokenOwner;// provider :union {// grain :group {// grainId :Text;// union {// uiView :group {// identityId :Text;// roleAssignment :RoleAssignment;// forSharing :Bool;// }// objectId :SupervisorObjectId;// }// }// frontendRef :union {// notificationHandle :Text;// ipNetwork :Bool;// ipInterface :Bool;// emailVerifier :group {// id :Text;// services :List(String);// }// verifiedEmail :group {// verifierId :Text;// tabId :Text;// address :Text;// }// identity :Text;// }// child :group {// parentToken :Text;// union {// uiView :group {// grainId :Text;// identityId :Text;// roleAssignment :RoleAssignment = (allAccess = ());// }// other :Void;// }// }// }// requirements: List(Supervisor.MembraneRequirement);// ...// }
ApiTokens.ensureIndexOnServer("grainId", { sparse: 1 });ApiTokens.ensureIndexOnServer("owner.user.identityId", { sparse: 1 });ApiTokens.ensureIndexOnServer("frontendRef.emailVerifier.id", { sparse: 1 });
ApiHosts = new Mongo.Collection("apiHosts", collectionOptions);// Allows defining some limited static behavior for an API host when accessed unauthenticated. This// mainly exists to allow backwards-compatibility with client applications that expect to be able// to probe an API host without authentication to determine capabilities such as DAV protocols// supported, before authenticating to perform real requests. An app can specify these properties// when creating an offerTemplate.//// Each contains:// \_id: apiHostIdHashForToken() of the corresponding API token.// hash2: hash(hash(token)), aka hash(ApiToken.\_id). Used to allow ApiHosts to be cleaned// up when ApiTokens are deleted.// options: Specifies how to respond to unauthenticated OPTIONS requests on this host.// This is an object containing fields:// dav: List of strings specifying DAV header `compliance-class`es, e.g. "1" or// "calendar-access". https://tools.ietf.org/html/rfc4918#section-10.1// resources: Object mapping URL paths (including initial '/') to static HTTP responses to// give when those paths are accessed unauthenticated. Due to Mongo disliking '.'// and '$' in keys, these characters must be escaped as '\uFF0E' and '\uFF04'// (see SandstormDb.escapeMongoKey). Each value in this map is an object with// fields:// type: Content-Type.// language: Content-Language.// encoding: Content-Encoding.// body: Entity-body as a string or buffer.
Notifications = new Mongo.Collection("notifications", collectionOptions);// Notifications for a user.//// Each contains:// \_id: random// grainId: The grain originating this notification, if any.// userId: Account ID of the user receiving the notification.// text: The JSON-ified LocalizedText to display in the notification.// isUnread: Boolean indicating if this notification is unread.// timestamp: Date when this notification was last updated// eventType: If this notification is due to an activity event, this is the numeric index// of the event type on the grain's ViewInfo.// count: The number of times this exact event has repeated. Identical events are// aggregated by incrementing the count.// initiatingIdentity: Identity ID of the user who initiated this notification.// initiatorAnonymous: True if the initiator is an anonymous user. If neither this nor// initiatingIdentity is present, the notification is not from a user.// path: Path inside the grain to which the user should be directed if they click on// the notification.// ongoing: If present, this is an ongoing notification, and this field contains an// ApiToken referencing the `OngoingNotification` capability.// admin: If present, this is a notification intended for an admin.// action: If present, this is a (string) link that the notification should direct the// admin to.// type: The type of notification -- currently can only be "reportStats".// appUpdates: If present, this is an app update notification. It is an object with the appIds// as keys.// $appId: The appId that has an outstanding update.// packageId: The packageId that it will update to.// name: The name of the app. (appTitle from package.manifest)// version: The app's version number. (appVersion from package.manifest)// marketingVersion: String marketing version of this app. (appMarketingVersion from package.manifest)// referral: If this boolean field is true, then treat this notification as a referral// notification. This causes text to be ignored, since we need custom logic.// mailingListBonus: Like `referral`, but notify the user about the mailing list bonus. This is// a one-time notification only to Oasis users who existed when the bonus program// was implemented.
ActivitySubscriptions = new Mongo.Collection("activitySubscriptions", collectionOptions);// Activity events to which a user is subscribed.//// Each contains:// \_id: random// identityId: Who is subscribed.// grainId: Grain to which subscription applies.// threadPath: If present, the subscription is on a specific thread. Otherwise, it is on the// whole grain.// mute: If true, this is an anti-subscription -- matching events should NOT notify.// This allows is useful to express:// - A user wants to subscribe to a grain but mute a specific thread.// - The owner of a grain does not want notifications (normally, they are// implicitly subscribed).// - A user no longer wishes to be implicitly subscribed to threads in a grain on// which they comment, so they mute the grain.
ActivitySubscriptions.ensureIndexOnServer("identityId");ActivitySubscriptions.ensureIndexOnServer({ "grainId": 1, "threadPath": 1 });
StatsTokens = new Mongo.Collection("statsTokens", collectionOptions);// Access tokens for the Stats collection//// These tokens are used for accessing the ActivityStats collection remotely// (ie. from a dashboard webapp)//// Each contains:// \_id: The token. At least 128 bits entropy (Random.id(22)).
Misc = new Mongo.Collection("misc", collectionOptions);// Miscellaneous configuration and other settings//// This table is currently only used for persisting BASE\_URL from one session to the next,// but in general any miscellaneous settings should go in here//// Each contains:// \_id: The name of the setting. eg. "BASE\_URL"// value: The value of the setting.
Settings = new Mongo.Collection("settings", collectionOptions);// Settings for this Sandstorm instance go here. They are configured through the adminSettings// route. This collection differs from misc in that any admin user can update it through the admin// interface.//// Each contains:// \_id: The name of the setting. eg. "smtpConfig"// value: The value of the setting.// automaticallyReset: Sometimes the server needs to automatically reset a setting. When it does// so, it will also write an object to this field indicating why the reset was// needed. That object can have the following variants:// baseUrlChangedFrom: The reset was due to BASE\_URL changing. This field contains a string// with the old BASE\_URL.// preinstalledApps: A list of objects:// appId: The Packages.appId of the app to install// status: packageId// packageId: The Packages.\_id of the app to install//// potentially other fields that are unique to the setting
Migrations = new Mongo.Collection("migrations", collectionOptions);// This table tracks which migrations we have applied to this instance.// It contains a single entry:// \_id: "migrations\_applied"// value: The number of migrations this instance has successfully completed.
StaticAssets = new Mongo.Collection("staticAssets", collectionOptions);// Collection of static assets served up from the Sandstorm server's "static" host. We only// support relatively small assets: under 1MB each.//// Each contains:// \_id: Random ID; will be used in the URL.// hash: A base64-encoded SHA-256 hash of the data, used to de-dupe.// mimeType: MIME type of the asset, suitable for Content-Type header.// encoding: Either "gzip" or not present, suitable for Content-Encoding header.// content: The asset content (byte buffer).// refcount: Number of places where this asset's ID appears in the database. Since Mongo doesn't// have transactions, this needs to bias towards over-counting; a backup GC could be used// to catch leaked assets, although it's probably not a big deal in practice.
AssetUploadTokens = new Mongo.Collection("assetUploadTokens", collectionOptions);// Collection of tokens representing a single-use permission to upload an asset, such as a new// profile picture.//// Each contains:// \_id: Random ID.// purpose: Contains one of the following, indicating how the asset is to be used:// profilePicture: Indicates that the upload is a new profile picture. Contains fields:// userId: Account ID of user whose picture shall be replaced.// identityId: Which of the user's identities shall be updated.// expires: Time when this token will go away if unused.
Plans = new Mongo.Collection("plans", collectionOptions);// Subscription plans, which determine quota.//// Each contains:// \_id: Plan ID, usually a short string like "free", "standard", "large", "mega", ...// storage: Number of bytes this user is allowed to store.// compute: Number of kilobyte-RAM-seconds this user is allowed to consume.// computeLabel: Label to display to the user describing this plan's compute units.// grains: Total number of grains this user can create (often `Infinity`).// price: Price per month in US cents.// hidden: If true, a user cannot switch to this plan, but some users may be on it and are// allowed to switch away.// title: Title from display purposes. If missing, default to capitalizing \_id.
AppIndex = new Mongo.Collection("appIndex", collectionOptions);// A mirror of the data from the App Market index//// Each contains:// \_id: the appId of the app// The rest of the fields are defined in src/sandstorm/app-index/app-index.capnp:AppIndexForMarket
KeybaseProfiles = new Mongo.Collection("keybaseProfiles", collectionOptions);// Cache of Keybase profile information. The profile for a user is re-fetched every time a package// by that user is installed, as well as if the keybase profile is requested and not already// present for some reason.//// Each contains:// \_id: PGP key fingerprint (SHA-1, hex, all-caps)// displayName: Display name from Keybase. (NOT VERIFIED AT ALL.)// handle: Keybase handle.// proofs: The "proofs\_summary.all" array from the Keybase lookup. See the non-existent Keybase// docs for details. We also add a boolean "status" field to each proof indicating whether// we have directly verified the proof ourselves. Its values may be "unverified" (Keybase// returned this but we haven't checked it directly), "verified" (we verified the proof and it// is valid), "invalid" (we checked the proof and it was definitely bogus), or "checking" (the// server is currently actively checking this proof). Note that if a check fails due to network// errors, the status goes back to "unverified".//// WARNING: Currently verification is NOT IMPLEMENTED, so all proofs will be "unverified"// for now and we just trust Keybase.
FeatureKey = new Mongo.Collection("featureKey", collectionOptions);// OBSOLETE: This was used to implement the Sandstorm for Work paywall, which has been removed.// Collection object still defined because it could have old data in it, for servers that used// to have a feature key.
SetupSession = new Mongo.Collection("setupSession", collectionOptions);// Responsible for storing information about setup sessions. Contains a single document with three// keys://// \_id: "current-session"// creationDate: Date object indicating when this session was created.// hashedSessionId: the sha256 of the secret session id that was returned to the client
const DesktopNotifications = new Mongo.Collection("desktopNotifications", collectionOptions);// Responsible for very short-lived queueing of desktop notification information.// Entries are removed when they are ~30 seconds old. This collection is a bit// odd in that it is intended primarily for edge-triggered communications, but// Meteor's collections aren't really designed to support that organization.// Fields for each ://// \_id: String. Used as the tag to coordinate notification merging between browser tabs.// creationDate: Date object. indicating when this notification was posted.// userId: String. Account id to which this notification was published.// notificationId: String. ID of the matching event in the Notifications table to dismiss if this// notification is activated.// appActivity: Object with fields:// user: Optional Object. Not present if this notification wasn't generated by a user. If// present, it will have one of the following shapes:// { anonymous: true } if this notification was generated by an anonymous user. Otherwise:// {// identityId: String The user's identity ID.// name: String The user's display name.// avatarUrl: String The URL for the user's profile picture.// },// grainId: String, Which grain this action took place on// path: String, The path of the notification.// body: Util.LocalizedText, The main body of the activity event.// actionText: Util.LocalizedText, What action the user took, e.g.// { defaultText: "added a comment" }
const StandaloneDomains = new Mongo.Collection("standaloneDomains", collectionOptions);// A standalone domain that points to a single share link. These domains act a little different// than a normal shared Sandstorm grain. They completely drop any Sandstorm topbar/sidebar, and at// first glance look completely like a non-Sandstorm hosted webserver. The apps instead act in// concert with Sandstorm through the postMessage API, which allows it to do things like prompt for// login.// Fields for each ://// \_id: String. The domain name to use.// token: String. \_id of a sharing token (it must be a webkey).
if (Meteor.isServer) { Meteor.publish("credentials", function () { // Data needed for isSignedUp() and isAdmin() to work.
 if (this.userId) { const db = this.connection.sandstormDb; return [ Meteor.users.find({ \_id: this.userId }, { fields: { signupKey: 1, isAdmin: 1, expires: 1, storageUsage: 1, plan: 1, planBonus: 1, hasCompletedSignup: 1, experiments: 1, referredIdentityIds: 1, cachedStorageQuota: 1, suspended: 1, }, }), db.collections.plans.find(), ]; } else { return []; } });}
const countReferrals = function (user) { const referredIdentityIds = user.referredIdentityIds; return (referredIdentityIds && referredIdentityIds.length || 0);};
const calculateReferralBonus = function (user) { // This function returns an object of the form: // // - {grains: 0, storage: 0} // // which are extra resources this account gets as part of participating in the referral // program. (Storage is measured in bytes, as usual for plans.)
 // TODO(cleanup): Consider moving referral bonus logic into Oasis payments module (since it's // payments-specific) and aggregating into `planBonus`.
 // Authorization note: Only call this if accountId is the current user! const isPaid = (user.plan && user.plan !== "free");
 successfulReferralsCount = countReferrals(user); if (isPaid) { const maxPaidStorageBonus = 30 \* 1e9; return { grains: 0, storage: Math.min( successfulReferralsCount \* 2 \* 1e9, maxPaidStorageBonus), }; } else { const maxFreeStorageBonus = 2 \* 1e9; const bonus = { storage: Math.min( successfulReferralsCount \* 50 \* 1e6, maxFreeStorageBonus), }; if (successfulReferralsCount > 0) { bonus.grains = Infinity; } else { bonus.grains = 0; }
 return bonus; }};
isAdmin = function () { // Returns true if the user is the administrator.
 const user = Meteor.user(); if (user && user.isAdmin) { return true; } else { return false; }};
isAdminById = function (id) { // Returns true if the user's id is the administrator.
 const user = Meteor.users.findOne({ \_id: id }, { fields: { isAdmin: 1 } }); if (user && user.isAdmin) { return true; } else { return false; }};
findAdminUserForToken = function (token) { if (!token.requirements) { return; }
 const requirements = token.requirements.filter(function (requirement) { return "userIsAdmin" in requirement; });
 if (requirements.length > 1) { return; }
 if (requirements.length === 0) { return; }
 return requirements[0].userIsAdmin;};
const wildcardHost = Meteor.settings.public.wildcardHost.toLowerCase().split("\*");
if (wildcardHost.length != 2) { throw new Error("Wildcard host must contain exactly one asterisk.");}
matchWildcardHost = function (host) { // See if the hostname is a member of our wildcard. If so, extract the ID.
 // We remove everything after the first ":" character so that our // comparison logic ignores port numbers. const prefix = wildcardHost[0]; const suffix = wildcardHost[1].split(":")[0]; const hostSansPort = host.split(":")[0];
 if (hostSansPort.lastIndexOf(prefix, 0) >= 0 && hostSansPort.indexOf(suffix, -suffix.length) >= 0 && hostSansPort.length >= prefix.length + suffix.length) { const id = hostSansPort.slice(prefix.length, -suffix.length); if (id.match(/^[-a-z0-9]\*$/)) { return id; } }
 return null;};
makeWildcardHost = function (id) { return wildcardHost[0] + id + wildcardHost[1];};
const isApiHostId = function (hostId) { if (hostId) { const split = hostId.split("-"); if (split[0] === "api") return split[1] || "\*"; }
 return false;};
const isTokenSpecificHostId = function (hostId) { return hostId.lastIndexOf("api-", 0) === 0;};
let apiHostIdHashForToken;if (Meteor.isServer) { const Crypto = Npm.require("crypto"); apiHostIdHashForToken = function (token) { // Given an API token, compute the host ID that must be used when requesting this token.
 // We add a leading 'x' to the hash so that knowing the hostname alone is not sufficient to // find the corresponding API token in the ApiTokens table (whose \_id values are also hashes // of tokens). This doesn't technically add any security, but helps prove that we don't have // any bugs which would allow someone who knows only the hostname to access the app API. return Crypto.createHash("sha256").update("x" + token).digest("hex").slice(0, 32); };} else { apiHostIdHashForToken = function (token) { // Given an API token, compute the host ID that must be used when requesting this token.
 // We add a leading 'x' to the hash so that knowing the hostname alone is not sufficient to // find the corresponding API token in the ApiTokens table (whose \_id values are also hashes // of tokens). This doesn't technically add any security, but helps prove that we don't have // any bugs which would allow someone who knows only the hostname to access the app API. return SHA256("x" + token).slice(0, 32); };}
const apiHostIdForToken = function (token) { return "api-" + apiHostIdHashForToken(token);};
const makeApiHost = function (token) { return makeWildcardHost(apiHostIdForToken(token));};
if (Meteor.isServer) { const Url = Npm.require("url"); getWildcardOrigin = function () { // The wildcard URL can be something like "foo-\*-bar.example.com", but sometimes when we're // trying to specify a pattern matching hostnames (say, a Content-Security-Policy directive), // an astrisk is only allowed as the first character and must be followed by a period. So we need // "\*.example.com" instead -- which matches more than we actually want, but is the best we can // really do. We also add the protocol to the front (again, that's what CSP wants).
 // TODO(cleanup): `protocol` is computed in other files, like proxy.js. Put it somewhere common. const protocol = Url.parse(process.env.ROOT\_URL).protocol;
 const dotPos = wildcardHost[1].indexOf("."); if (dotPos < 0) { return protocol + "//\*"; } else { return protocol + "//\*" + wildcardHost[1].slice(dotPos); } };}
SandstormDb = function (quotaManager) { // quotaManager is an object with the following method: // updateUserQuota: It is provided two arguments // db: This SandstormDb object // user: A collections.users account object // and returns a quota object: // storage: A number (can be Infinity) // compute: A number (can be Infinity) // grains: A number (can be Infinity)
 this.quotaManager = quotaManager; this.collections = { // Direct access to underlying collections. DEPRECATED, but better than accessing the top-level // collection globals directly. // // TODO(cleanup): Over time, we will provide methods covering each supported query and remove // direct access to the collections. users: Meteor.users,
 packages: Packages, devPackages: DevPackages, userActions: UserActions, grains: Grains, roleAssignments: RoleAssignments, // Deprecated, only used by the migration that eliminated it. contacts: Contacts, sessions: Sessions, signupKeys: SignupKeys, activityStats: ActivityStats, deleteStats: DeleteStats, fileTokens: FileTokens, apiTokens: ApiTokens, apiHosts: ApiHosts, notifications: Notifications, activitySubscriptions: ActivitySubscriptions, statsTokens: StatsTokens, misc: Misc, settings: Settings, migrations: Migrations,[View remainder of file in raw view](https://github.com/sandstorm-io/sandstorm/raw/refs/tags/v0.202/shell/packages/sandstorm-db/db.js)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from sandstorm.io_0aece663_20250125_201739.html ===

[This site is historical, from when Sandstorm was a startup. Sandstorm the open source project has moved to sandstorm.org. More info »](/news/2024-01-14-move-to-sandstorm-org)

[Sandstorm.io](/)
[Get Sandstorm](/get)
[Features](/features)
[Technology](/how-it-works)
[Blog](/news/)
[Docs](https://docs.sandstorm.io)
[Code](https://github.com/sandstorm-io/sandstorm)
[Community](/community)
[About](/about)

# Sandstorm Blog

* [Fediverse](https://floss.social/%40sandstorm)* [Github](https://github.com/sandstorm-io/sandstorm)

[Sandstorm is a self-hostable web productivity suite.
Host your own](/get)
### Recommended Posts

* [Open Source Web Apps Aren't Viable; Let's Fix That](/news/2014-07-21-open-source-web-apps-require-federated-hosting)
* [Sandstorm's security track record, and what it means for self-hosting](/news/2016-02-29-security-track-record)
* [Decentralization is about diversity](/news/2016-08-17-decentralization-is-about-diversity)
* [8 New open source self-hostable apps](/news/2016-01-22-8-new-open-source-apps.html)
* [Sandstorm for Work Beta: LDAP, SAML, organization management](/news/2016-04-06-sandstorm-for-work)
* [Free publicity for your indie web app, and free Oasis service for you](/news/2016-02-05-app-author-publicity-oasis)
* [Free, automated SSL certificates for Sandstorm self-hosters](/news/2015-10-01-free-ssl-certificates.html)
* [Why doesn't Sandstorm just run Docker apps?](/news/2014-08-19-why-not-run-docker-apps.html)
* [Understand the Sandstorm sharing model](/news/2015-05-05-delegation-is-the-cornerstone-of-civilization.html)

### Further Reading

* [How Sandstorm Works](/how-it-works)
* [Sandstorm Documentation](http://docs.sandstorm.io)
* [How to install Sandstorm](/install)

[« All posts](/news/ "All posts")

## Sandstorm gets a security review

By [Kenton Varda](https://github.com/kentonv)
- 02 Mar 2017

Sandstorm recently underwent a security review by [DevCore Inc.](http://devco.re/), commissioned by Department of Cyber Security of Taiwan. The company has in the past found RCEs in big-name services like [Uber](https://hackerone.com/reports/125980) and [Facebook](http://devco.re/blog/2016/04/21/how-I-hacked-facebook-and-found-someones-backdoor-script-eng-ver/).

Although the full report is not public (and is not in English), Taiwan’s Digital Minister, [Audrey Tang](https://en.wikipedia.org/wiki/Audrey_Tang), tells us that overall DevCore feels Sandstorm has “excellent security design.”

As would be expected of any good security review, DevCore did find several issues. Last night we released build 0.203 to fix them. All servers should automatically update within 24 hours of the release (by midnight tonight, PST), but if you’d like to speed up the process (or if you have disabled automatic updates), you can SSH into your server now and type:

```
sudo sandstorm update

```
### Vulnerabilities Discovered (and fixed)

#### 1. Insufficient e-mail address validation

When logging in with an e-mail address, a user could enter an address like “foo@evil.com,bar@example.com”. In this case, login e-mails would be sent to *both* addresses, while Sandstorm would treat the user as if they were a member of the latter domain, “example.com”. Hence, an attacker could specify their real address as the first address and a fake address at a domain of their choice as the second, in order to appear to be a member of the domain. Servers that use Sandstorm’s organizational features (until recently only available as part of the [now-defunct](https://sandstorm.io/news/2017-02-06-sandstorm-returning-to-community-roots) product “Sandstorm for Work”) can be configured to automatically promote members of a domain to full users, allowing them to install apps, create grains, and discover the identities of other members of the organization. Such users would **not** receive access to any other grains on the server, but an attacker could install their own apps that consume the server’s resources, including CPU, RAM, and disk. An attacker could also combine this vulnerability with one of the others below, all of which require full user status as a starting point.

The root cause of this bug is Sandstorm’s use of a library called Nodemailer to send e-mail. It turns out that Nodemailer “helpfully” interprets comma-separated lists of addresses as multiple addresses. This is true even if the string is already part of an array. For instance, say you pass the following array in the `to` field of a mail sent via Nodemailer:

```
[ "foo@example.com",
  "bar@example.com,baz@example.com",
  { name: "Garply", address: "qux@example.com,corge@example.com" } ]

```

Surprisingly, this three-element array will send e-mail to *five* addresses – foo@, bar@, baz@, qux@, and corge@.

We did not anticipate this feature and assumed that Nodemailer would fail to send e-mail to an invalid address.

**Severity:** Moderate **if** Sandstorm is configured with an organization defined by e-mail domain. If you do not define an organization, or if you define it by LDAP, SAML, or G Suite domain, then we do not believe this bug can be meaningfully exploited.

**Fix:** Sandstorm now performs its own validation of addresses to ensure, among other things, that no separator characters are accepted and only one @-sign is allowed. Fixed in commit [37bd9a7](https://github.com/sandstorm-io/sandstorm/commit/37bd9a7f4eb776cdc2d3615f0bfea1254b66f59d).

#### 2. Insufficient path validation when building ZIP backups

The owner of a Sandstorm grain can download a backup of the grain’s content in ZIP format. Sandstorm shells out to the `zip` utility to build this archive, but does so inside a sandbox designed to prevent exploitation of bugs in the utility.

Unfortunately, a combination of factors resulted in the possibility of a minor data leak:

* The list of files to include in the archive is passed to `zip` on standard input, delimited by newlines. However, it is possible for a filename to contain a newline character. Sandstorm actually checked for this, but accidentally failed to perform the check in one code path triggered by the existence of an empty directory.
* The zip sandbox carefully hid sensitive directories like `/var`, `/proc`, and even `/etc`. However, after the zip sandbox was written, two new directories, `/etc.host` and `/run.host`, which are aliases for the host system’s `/etc` and `/run`, were added. Unfortunately, the zip sandbox was not updated to hide these directories, hence they were visible to the zip program.

As a result of this, a user could create a grain containing an empty directory named `/var/blah\n/etc.host/passwd`, save a backup, and find the backup contained a copy of the host’s `/etc/passwd` file (which, despite its name, does not contain passwords, but does contain a list of local user accounts).

**Severity:** Low. An attacker who has full user status (permission to create grains) can read files located in the server’s `/etc` and `/run` directories that are set world-readable (or specifically readable to the Sandstorm service account). No other host system directories are exposed. Usually, any files under `/etc` that contain sensitive secrets would be hidden from all users except root, hence would not be readable by Sandstorm nor by the attacker.

**Fix:** We have fixed the validation of filenames so that newlines are never permitted, and we have enhanced the zip sandbox to use a whitelist of top-level directories rather than a blacklist. Fixed in commits [4ea8df7](https://github.com/sandstorm-io/sandstorm/commit/4ea8df7403381d9b657b121b3c98d8081b27414d) and [6e8572e](https://github.com/sandstorm-io/sandstorm/commit/6e8572ea8bb56d0216bb1b410e5040edc051b120).

#### 3. Server-side request forgery

Apps running on Sandstorm can make outgoing HTTP requests through a few mechanisms. Additionally, users can instruct Sandstorm to download an app package file from an arbitrary URL. Sandstorm did not attempt to prevent these requests from reaching localhost or private network destinations. Because of this, a full user of the Sandstorm server (but not a visitor) could probe the internal network on which the Sandstorm server was hosted, as well as services exposed to localhost on the server itself.

This is a problem if unprotected services are exposed to the Sandstorm server *and* you have invited users to your server who should not be trusted to access those services. Sandstorm itself does not expose any unprotected services to localhost, so some other service must be running locally to cause a problem. Only HTTP requests are possible.

**Severity:** High **if** unprotected HTTP services are visible to the Sandstorm server *and* you have invited users to your server who should not be trusted to access those services. Otherwise, low. Sandstorm itself does not expose any unprotected services to localhost, so some other service must be running locally to cause a problem. Only HTTP requests are possible.

**Fix:** Sandstorm now allows the server admin to configure an IP address blacklist. User-initiated requests will not be allowed from these addresses. By default, standard private network address ranges are blacklisted. Annoyingly, this “fix” is likely to break some servers who use private app indexes, but avoiding such breakage would mean leaving others vulnerable. Admins will need to update their blacklists accordingly. Fixed in commit [164997f](https://github.com/sandstorm-io/sandstorm/commit/164997fb958effbc90c5328c166706280a84aaa1).

#### 4. Failure to mitigate Linux kernel CVE-2017-6074

*(This was caught by Sandstorm core developer [David Renshaw](https://github.com/dwrensha), not by DevCore, but is fixed in the same release.)*

A recent Linux kernel bug could allow a malicious app to cause a kernel panic or perhaps break out of its sandbox. The bug is in Linux, but Sandstorm aims to protect against such bugs via seccomp. [Historically, Sandstorm’s sandbox has been very successful at blocking Linux vulnerabilities before they are discovered.](https://docs.sandstorm.io/en/latest/using/security-non-events/#linux-kernel) However, this one slipped through. On Sandstorm, the published PoC exploit for this bug only causes a kernel panic (not a sandbox breakout), but a developer with deep understanding of the bug and the Linux kernel might be able to create a successful attack in other ways.

**Severity:** High if you permit users you don’t trust to install apps on your server, or commonly install apps from untrustworthy sources, and you do not keep your kernel up-to-date.

**Fix:** Sandstorm’s seccomp filter has been updated to prohibit the creation of DCCP sockets. Fixed in commit [34749f9](https://github.com/sandstorm-io/sandstorm/commit/34749f9c0141a89680860b15433e8ac9dbdbbb62).

### Conclusion

We are excited to have received such a thorough security review. Some of the problems discovered were very obscure and we’re impressed that DevCore was able to find them. We thank Audrey Tang and the Department of Cyber Security of Taiwan for commissioning this review.

* ### [Get Sandstorm](/get)

  + [Self-host Sandstorm](/get)+ [Source code (GitHub)](https://github.com/sandstorm-io/sandstorm)+ [For educators](/go/education)
* ### [Features](/features)

  + [App Market](https://apps.sandstorm.io)
  + [Core features](/features)+ [Security features](/features#security)+ [For organizations](/business)+ [For developers](/developer)
* ### [Documentation](https://docs.sandstorm.io)

  + [How to use Sandstorm](https://docs.sandstorm.io/en/latest/using/)+ [Developer Hub](https://docs.sandstorm.io/en/latest/developing/)+ [Administering & installing](https://docs.sandstorm.io/en/latest/administering/)+ [Security](https://docs.sandstorm.io/en/latest/using/security-practices/)
* ### [Technology (How it Works)](/how-it-works)

  + [Fine-grained object containers](/how-it-works#grains)+ [Capability-based security](/how-it-works#capabilities)
* ### [Community](/community)

  + [Sandstorm Blog](/news)+ [Connect with us](/community#connect-with)+ [Help others](/community#helpothers)+ [Help the project](/community#helpproject)
* ### [About](/about)

  + [Sandstorm story](/about)+ [Team](/about#team)+ [Advisors](/about#advisors)+ Contact
* ### Connect

This page was hand-crafted using only the finest web technologies.


