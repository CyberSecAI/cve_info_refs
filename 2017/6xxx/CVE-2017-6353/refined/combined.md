=== Content from www.openwall.com_1e24a0e1_20250124_143043.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux Â  *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper Â  *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists Â  *for password cracking*](/wordlists/)+ [passwdqc Â  *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt Â  *KDF & password hashing*](/yescrypt/)+ [yespower Â  *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish Â  *password hashing*](/crypt/)+ [phpass Â  *ditto in PHP*](/phpass/)+ [tcb Â  *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd Â  *port scan detector*](/scanlogd/)+ [popa3d Â  *tiny POP3 daemon*](/popa3d/)+ [blists Â  *web interface to mailing lists*](/blists/)+ [msulogin Â  *single user mode login*](/msulogin/)+ [php\_mt\_seed Â  *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20170227120706.3entdizfnyz5iwrf@lorien.valinor.li>
Date: Mon, 27 Feb 2017 13:07:06 +0100
From: Salvatore Bonaccorso <carnil@...ian.org>
To: OSS Security Mailinglist <oss-security@...ts.openwall.com>
Subject: Linux: CVE-2017-6353: sctp: deny peeloff operation on asocs with
 threads sleeping on it

Hi

Via the CVE webform, MITRE has assigned CVE-2017-6353 for:

<https://marc.info/?l=linux-netdev&m=148785309416337&w=2>

>Subject:    [PATCH net] sctp: deny peeloff operation on asocs with threads sleeping on it
>From:       Marcelo Ricardo Leitner <marcelo.leitner () gmail ! com>
>Date:       2017-02-23 12:31:18
>
>commit 2dcab5984841 ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
>attempted to avoid a BUG_ON call when the association being used for a
>sendmsg() is blocked waiting for more sndbuf and another thread did a
>peeloff operation on such asoc, moving it to another socket.
>
>As Ben Hutchings noticed, then in such case it would return without
>locking back the socket and would cause two unlocks in a row.
>
>Further analysis also revealed that it could allow a double free if the
>application managed to peeloff the asoc that is created during the
>sendmsg call, because then sctp_sendmsg() would try to free the asoc
>that was created only for that call.
>
>This patch takes another approach. It will deny the peeloff operation
>if there is a thread sleeping on the asoc, so this situation doesn't
>exist anymore. This avoids the issues described above and also honors
>the syscalls that are already being handled (it can be multiple sendmsg
>calls).
>
>Joint work with Xin Long.
>
>Fixes: 2dcab5984841 ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
>Cc: Alexander Popov <alex.popov@...ux.com>
>Cc: Ben Hutchings <ben@...adent.org.uk>
>Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@...il.com>
>Signed-off-by: Xin Long <lucien.xin@...il.com>
>---
>Hi, please consider this one for -stable too. Thanks
>
> net/sctp/socket.c | 8 ++++++--
> 1 file changed, 6 insertions(+), 2 deletions(-)
>
>diff --git a/net/sctp/socket.c b/net/sctp/socket.c
>index 1b5d669e30292a57ed57dd920d81be2a57f97b22..d04a8b66098c8a574642b026bff990ac64c21468 100644
>--- a/net/sctp/socket.c
>+++ b/net/sctp/socket.c
>@@ -4734,6 +4734,12 @@ int sctp_do_peeloff(struct sock *sk, sctp_assoc_t id, struct socket **sockp)
> 	if (!asoc)
> 		return -EINVAL;
>
>+	/* If there is a thread waiting on more sndbuf space for
>+	 * sending on this asoc, it cannot be peeled.
>+	 */
>+	if (waitqueue_active(&asoc->wait))
>+		return -EBUSY;
>+
> 	/* An association cannot be branched off from an already peeled-off
> 	 * socket, nor is this supported for tcp style sockets.
> 	 */
>@@ -7426,8 +7432,6 @@ static int sctp_wait_for_sndbuf(struct sctp_association *asoc, long *timeo_p,
> 		 */
> 		release_sock(sk);
> 		current_timeo = schedule_timeout(current_timeo);
>-		if (sk != asoc->base.sk)
>-			goto do_error;
> 		lock_sock(sk);
>
> 		*timeo_p = current_timeo;
>--
>2.9.3

This was found while reviewing the fix of CVE-2017-5986 (2dcab5984841
("sctp: avoid BUG_ON on sctp_wait_for_sndbuf"))

Regards,
Salvatore

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_fdb3266c_20250124_143045.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fdfcb9f4f99f1e9a49e43398a7bfbf56927544af1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fdfcb9f4f99f1e9a49e43398a7bfbf56927544af1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

sctp: deny peeloff operation on asocs with threads sleeping on it

[Browse files](/torvalds/linux/tree/dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)
Browse the repository at this point in the history

```
commit [2dcab59](https://github.com/torvalds/linux/commit/2dcab598484185dea7ec22219c76dcdd59e3cb90) ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
attempted to avoid a BUG_ON call when the association being used for a
sendmsg() is blocked waiting for more sndbuf and another thread did a
peeloff operation on such asoc, moving it to another socket.

As Ben Hutchings noticed, then in such case it would return without
locking back the socket and would cause two unlocks in a row.

Further analysis also revealed that it could allow a double free if the
application managed to peeloff the asoc that is created during the
sendmsg call, because then sctp_sendmsg() would try to free the asoc
that was created only for that call.

This patch takes another approach. It will deny the peeloff operation
if there is a thread sleeping on the asoc, so this situation doesn't
exist anymore. This avoids the issues described above and also honors
the syscalls that are already being handled (it can be multiple sendmsg
calls).

Joint work with Xin Long.

Fixes: [2dcab59](https://github.com/torvalds/linux/commit/2dcab598484185dea7ec22219c76dcdd59e3cb90) ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
Cc: Alexander Popov <alex.popov@linux.com>
Cc: Ben Hutchings <ben@decadent.org.uk>
Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
```

* Loading branch information

[![@marceloleitner](https://avatars.githubusercontent.com/u/370788?s=40&v=4)](/marceloleitner) [![@davem330](https://avatars.githubusercontent.com/u/1053866?s=40&v=4)](/davem330)

[marceloleitner](/torvalds/linux/commits?author=marceloleitner "View all commits by marceloleitner")
authored and
[davem330](/torvalds/linux/commits?author=davem330 "View all commits by davem330")
committed
Feb 24, 2017

1 parent
[f1ef09f](/torvalds/linux/commit/f1ef09fde17f9b77ca1435a5b53a28b203afb81c)

commit dfcb9f4

Showing
**1 changed file**
with
**6 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

8 changes: 6 additions & 2 deletions

8
[net/sctp/socket.c](#diff-84adddc2ddf5dab68a6fd41bd81078f9ec66fd43249425f4d1f0cf9c9e6886eb "net/sctp/socket.c")

Show comments

[View file](/torvalds/linux/blob/dfcb9f4f99f1e9a49e43398a7bfbf56927544af1/net/sctp/socket.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4862,6 +4862,12 @@ int sctp\_do\_peeloff(struct sock \*sk, sctp\_assoc\_t id, struct socket \*\*sockp) |
|  |  | if (!asoc) |
|  |  | return -EINVAL; |
|  |  |  |
|  |  | /\* If there is a thread waiting on more sndbuf space for |
|  |  | \* sending on this asoc, it cannot be peeled. |
|  |  | \*/ |
|  |  | if (waitqueue\_active(&asoc->wait)) |
|  |  | return -EBUSY; |
|  |  |  |
|  |  | /\* An association cannot be branched off from an already peeled-off |
|  |  | \* socket, nor is this supported for tcp style sockets. |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -7599,8 +7605,6 @@ static int sctp\_wait\_for\_sndbuf(struct sctp\_association \*asoc, long \*timeo\_p, |
|  |  | \*/ |
|  |  | release\_sock(sk); |
|  |  | current\_timeo = schedule\_timeout(current\_timeo); |
|  |  | if (sk != asoc->base.sk) |
|  |  | goto do\_error; |
|  |  | lock\_sock(sk); |
|  |  |  |
|  |  | \*timeo\_p = current\_timeo; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `dfcb9f4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fdfcb9f4f99f1e9a49e43398a7bfbf56927544af1) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from www.debian.org_a4b392c9_20250124_143042.html ===


---

[[Date Prev](msg00058.html)][[Date Next](msg00060.html)]
[[Thread Prev](msg00058.html)][[Thread Next](msg00060.html)]
[[Date Index](maillist.html#00059)]
[[Thread Index](threads.html#00059)]

# [SECURITY] [DSA 3804-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 3804-1] linux security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Wed, 08 Mar 2017 16:59:59 +0000
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/E1clewR-0006ii-Mp%40master.debian.org)Â [E1clewR-0006ii-Mp@master.debian.org](msg00059.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-3804-1                   security@debian.org
<https://www.debian.org/security/>                     Salvatore Bonaccorso
March 08, 2017                        <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2016-9588 CVE-2017-2636 CVE-2017-5669 CVE-2017-5986
                 CVE-2017-6214 CVE-2017-6345 CVE-2017-6346 CVE-2017-6348
                 CVE-2017-6353

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or have other
impacts.

CVE-2016-9588

    Jim Mattson discovered that the KVM implementation for Intel x86
    processors does not properly handle #BP and #OF exceptions in an
    L2 (nested) virtual machine. A local attacker in an L2 guest VM
    can take advantage of this flaw to cause a denial of service for
    the L1 guest VM.

CVE-2017-2636

    Alexander Popov discovered a race condition flaw in the n_hdlc
    line discipline that can lead to a double free. A local
    unprivileged user can take advantage of this flaw for privilege
    escalation. On systems that do not already have the n_hdlc module
    loaded, this can be mitigated by disabling it:
    echo >> /etc/modprobe.d/disable-n_hdlc.conf install n_hdlc false

CVE-2017-5669

    Gareth Evans reported that privileged users can map memory at
    address 0 through the shmat() system call. This could make it
    easier to exploit other kernel security vulnerabilities via a
    set-UID program.

CVE-2017-5986

    Alexander Popov reported a race condition in the SCTP
    implementation that can be used by local users to cause a
    denial-of-service (crash). The initial fix for this was incorrect
    and introduced further security issues (CVE-2017-6353). This
    update includes a later fix that avoids those. On systems that do
    not already have the sctp module loaded, this can be mitigated by
    disabling it:
    echo >> /etc/modprobe.d/disable-sctp.conf install sctp false

CVE-2017-6214

    Dmitry Vyukov reported a bug in the TCP implementation's handling
    of urgent data in the splice() system call. This can be used by a
    remote attacker for denial-of-service (hang) against applications
    that read from TCP sockets with splice().

CVE-2017-6345

    Andrey Konovalov reported that the LLC type 2 implementation
    incorrectly assigns socket buffer ownership. This can be used
    by a local user to cause a denial-of-service (crash). On systems
    that do not already have the llc2 module loaded, this can be
    mitigated by disabling it:
    echo >> /etc/modprobe.d/disable-llc2.conf install llc2 false

CVE-2017-6346

    Dmitry Vyukov reported a race condition in the raw packet (af_packet)
    fanout feature. Local users with the CAP_NET_RAW capability (in any
    user namespace) can use this for denial-of-service and possibly for
    privilege escalation.

CVE-2017-6348

    Dmitry Vyukov reported that the general queue implementation in
    the IrDA subsystem does not properly manage multiple locks,
    possibly allowing local users to cause a denial-of-service
    (deadlock) via crafted operations on IrDA devices.

For the stable distribution (jessie), these problems have been fixed in
version 3.16.39-1+deb8u2.

We recommend that you upgrade your linux packages.

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAljAOE9fFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0Q3Rg/7BAWcn97hmyotDGbm1LQLrRBiyjW66+aT51IHzbKbY8y+dVUodFDOeVpt
EWoisRwmeLj8A79v5GTV9Fdhu86vKt+E7N93KVeNQY8ELLxNEM+v4R0QGFbfzFpz
8CQn3kpZgQP9grMKBiY2quJNgXm18eWBDBdpQwvkOzr5AtKGNnX9nqEx6xWezA79
okdBJM88jETOWWI91njTCJIVYFhJOw1hBV+dYJVZIibR5pvjRLHRkGXhVDvE5erZ
m5VehpBlmdJAuK9JoovzKenEWJmAL775nwWKIyau4P+FsQxkPzuk1sk4MrqC9ZML
KShQP9FX/YbqhBDtIN/8pTK/r0zqn/L0FZc89woqdTCotzrgoRjiSjgTU37WhU66
YxfDNYzJ7EeAWH68UjiMNcABz4tlEr5U8B+eQLJYzgGeF5s37j3l0UqmWJ/6j8fB
gaza8eLvw0/97Cx9Wzp7blbjaQ722z0tfKJ7NiLgGTUJU655R4XtMAcPDc8Dr8mP
ocncMDy76L+B9JdTh3+KK0DsMv0YLnOK/d6LzHkGJtap/UubQZTNHIeAd472Sygm
iBj/R2ZZhZRoMoWjqlmBf4ZjyVgOpofOYSWPJ/AEdgF8zkCMA1ZBmB/WXqLyvOkh
WFR8Cq23dNS+GYtyqqi7jbAhEzqv36fzJ7pymr1/RrikrRwRW3E=
=WOjC
-----END PGP SIGNATURE-----

```

---



=== Content from git.kernel.org_241a4475_20250124_143042.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marcelo Ricardo Leitner <marcelo.leitner@gmail.com> | 2017-02-23 09:31:18 -0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2017-02-24 11:10:38 -0500 |
| commit | [dfcb9f4f99f1e9a49e43398a7bfbf56927544af1](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)) | |
| tree | [5ac5995348e86b899e6fc634c81fc0f1dce54c37](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1) | |
| parent | [f1ef09fde17f9b77ca1435a5b53a28b203afb81c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f1ef09fde17f9b77ca1435a5b53a28b203afb81c) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1&id2=f1ef09fde17f9b77ca1435a5b53a28b203afb81c)) | |
| download | [linux-dfcb9f4f99f1e9a49e43398a7bfbf56927544af1.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-dfcb9f4f99f1e9a49e43398a7bfbf56927544af1.tar.gz) | |

sctp: deny peeloff operation on asocs with threads sleeping on itcommit 2dcab5984841 ("sctp: avoid BUG\_ON on sctp\_wait\_for\_sndbuf")
attempted to avoid a BUG\_ON call when the association being used for a
sendmsg() is blocked waiting for more sndbuf and another thread did a
peeloff operation on such asoc, moving it to another socket.
As Ben Hutchings noticed, then in such case it would return without
locking back the socket and would cause two unlocks in a row.
Further analysis also revealed that it could allow a double free if the
application managed to peeloff the asoc that is created during the
sendmsg call, because then sctp\_sendmsg() would try to free the asoc
that was created only for that call.
This patch takes another approach. It will deny the peeloff operation
if there is a thread sleeping on the asoc, so this situation doesn't
exist anymore. This avoids the issues described above and also honors
the syscalls that are already being handled (it can be multiple sendmsg
calls).
Joint work with Xin Long.
Fixes: 2dcab5984841 ("sctp: avoid BUG\_ON on sctp\_wait\_for\_sndbuf")
Cc: Alexander Popov <alex.popov@linux.com>
Cc: Ben Hutchings <ben@decadent.org.uk>
Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)

| -rw-r--r-- | [net/sctp/socket.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sctp/socket.c?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/sctp/socket.c b/net/sctp/socket.cindex b5321486fbed30..465a9c8464f947 100644--- a/[net/sctp/socket.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sctp/socket.c?id=f1ef09fde17f9b77ca1435a5b53a28b203afb81c)+++ b/[net/sctp/socket.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sctp/socket.c?id=dfcb9f4f99f1e9a49e43398a7bfbf56927544af1)@@ -4862,6 +4862,12 @@ int sctp\_do\_peeloff(struct sock \*sk, sctp\_assoc\_t id, struct socket \*\*sockp) if (!asoc) return -EINVAL; + /\* If there is a thread waiting on more sndbuf space for+ \* sending on this asoc, it cannot be peeled.+ \*/+ if (waitqueue\_active(&asoc->wait))+ return -EBUSY;+ /\* An association cannot be branched off from an already peeled-off \* socket, nor is this supported for tcp style sockets. \*/@@ -7599,8 +7605,6 @@ static int sctp\_wait\_for\_sndbuf(struct sctp\_association \*asoc, long \*timeo\_p, \*/ release\_sock(sk); current\_timeo = schedule\_timeout(current\_timeo);- if (sk != asoc->base.sk)- goto do\_error; lock\_sock(sk);  \*timeo\_p = current\_timeo; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-24 14:29:19 +0000



=== Content from marc.info_b14441fc_20250126_013344.html ===

```
[[prev in list](?l=linux-netdev&m=148785164415963&w=2)] [[next in list](?l=linux-netdev&m=148785407316613&w=2)] [[prev in thread](?l=linux-sctp&m=148785309116336&w=2)] [[next in thread](?l=linux-sctp&m=148795268015474&w=2)]
List:       [linux-netdev](?l=linux-netdev&r=1&w=2)
Subject:    [[PATCH net] sctp: deny peeloff operation on asocs with threads sleeping on it](?t=148785312000005&r=1&w=2)
From:       [Marcelo Ricardo Leitner <marcelo.leitner () gmail ! com>](?a=139860681400001&r=1&w=2)
Date:       [2017-02-23 12:31:18](?l=linux-netdev&r=1&w=2&b=201702)
Message-ID: [e3adb3f22270407764cfbeb1adb7e4c95cf42cbb.1487800862.git.marcelo.leitner () gmail ! com](?i=e3adb3f22270407764cfbeb1adb7e4c95cf42cbb.1487800862.git.marcelo.leitner%20()%20gmail%20!%20com)
[Download RAW [message](?l=linux-netdev&m=148785309416337&q=mbox) or [body](?l=linux-netdev&m=148785309416337&q=raw)]

commit 2dcab5984841 ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
attempted to avoid a BUG_ON call when the association being used for a
sendmsg() is blocked waiting for more sndbuf and another thread did a
peeloff operation on such asoc, moving it to another socket.

As Ben Hutchings noticed, then in such case it would return without
locking back the socket and would cause two unlocks in a row.

Further analysis also revealed that it could allow a double free if the
application managed to peeloff the asoc that is created during the
sendmsg call, because then sctp_sendmsg() would try to free the asoc
that was created only for that call.

This patch takes another approach. It will deny the peeloff operation
if there is a thread sleeping on the asoc, so this situation doesn't
exist anymore. This avoids the issues described above and also honors
the syscalls that are already being handled (it can be multiple sendmsg
calls).

Joint work with Xin Long.

Fixes: 2dcab5984841 ("sctp: avoid BUG_ON on sctp_wait_for_sndbuf")
Cc: Alexander Popov <alex.popov@linux.com>
Cc: Ben Hutchings <ben@decadent.org.uk>
Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
---
Hi, please consider this one for -stable too. Thanks

 net/sctp/socket.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/net/sctp/socket.c b/net/sctp/socket.c
index 1b5d669e30292a57ed57dd920d81be2a57f97b22..d04a8b66098c8a574642b026bff990ac64c21468 100644
--- a/net/sctp/socket.c
+++ b/net/sctp/socket.c
@@ -4734,6 +4734,12 @@ int sctp_do_peeloff(struct sock *sk, sctp_assoc_t id, struct socket **sockp)
 	if (!asoc)
 		return -EINVAL;

+	/* If there is a thread waiting on more sndbuf space for
+	 * sending on this asoc, it cannot be peeled.
+	 */
+	if (waitqueue_active(&asoc->wait))
+		return -EBUSY;
+
 	/* An association cannot be branched off from an already peeled-off
 	 * socket, nor is this supported for tcp style sockets.
 	 */
@@ -7426,8 +7432,6 @@ static int sctp_wait_for_sndbuf(struct sctp_association *asoc, long *timeo_p,
 		 */
 		release_sock(sk);
 		current_timeo = schedule_timeout(current_timeo);
-		if (sk != asoc->base.sk)
-			goto do_error;
 		lock_sock(sk);

 		*timeo_p = current_timeo;
--
2.9.3

[[prev in list](?l=linux-netdev&m=148785164415963&w=2)] [[next in list](?l=linux-netdev&m=148785407316613&w=2)] [[prev in thread](?l=linux-sctp&m=148785309116336&w=2)] [[next in thread](?l=linux-sctp&m=148795268015474&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
AddÂ aÂ list |
SponsoredÂ byÂ [KoreLogic](http://www.korelogic.com/)


