=== Content from bugzilla.suse.com_1dd8e312_20250125_161409.html ===


| Bugzilla – Bug 1025068 | VUL-0: CVE-2017-2626: libICE: Weak Entropy Usage in Session Keys in libICE | Last modified: 2019-07-22 14:39:34 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1025068)
* |
  [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

[**Bug 1025068**](show_bug.cgi?id=1025068)
(CVE-2017-2626)
- VUL-0: CVE-2017-2626: libICE: Weak Entropy Usage in Session Keys in libICE

[Summary:](page.cgi?id=glossary.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
VUL-0: CVE-2017-2626: libICE: Weak Entropy Usage in Session Keys in libICE

| | [Status](page.cgi?id=status_resolution_matrix.html): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=glossary.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2017-2626 | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | SUSE Security Incidents | | [Classification:](page.cgi?id=glossary.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Novell Products | | [Component:](describecomponents.cgi?product=SUSE Security Incidents "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Incidents ([show other bugs](buglist.cgi?component=Incidents&product=SUSE%20Security%20Incidents&bug_status=__open__)) | | [Version:](page.cgi?id=glossary.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=glossary.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Other Other | |  | | | [Priority](page.cgi?id=glossary.html#priority): | P3 - Medium **Severity**: Normal | | [Target Milestone:](page.cgi?id=glossary.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Deadline](page.cgi?id=fields.html#deadline): | 2017-07-17 | | [Assignee:](page.cgi?id=glossary.html#assigned_to "The person in charge of resolving the bug.") | Security Team bot | | [QA Contact:](page.cgi?id=glossary.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") | Security Team bot | |  | | | [URL:](page.cgi?id=glossary.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=glossary.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") | CVSSv3:RedHat:CVE-2017-2626:5.2:(AV:L... | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=glossary.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=glossary.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1025639](show_bug.cgi?id=1025639 "RESOLVED FIXED - VUL-0: TRACKERBUG: xorg-x11: Multiple Vulnerabilities in X.org (Advisory: X41-2017-001)") | |  | Show dependency [tree](showdependencytree.cgi?id=1025068&hide_resolved=1) / [graph](showdependencygraph.cgi?id=1025068) | |  | | Reported: | 2017-02-13 16:44 UTC by Matthias Gerstner | | --- | --- | | Modified: | 2019-07-22 14:39 UTC ([History](show_activity.cgi?id=1025068)) | | CC List: | 5 users (show)  abergmann matthias.gerstner meissner sndirsch tyuan | |  | | | [See Also:](page.cgi?id=glossary.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Found By:](page.cgi?id=glossary.html#cf_foundby "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Services Priority:](page.cgi?id=glossary.html#cf_nts_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Business Priority:](page.cgi?id=glossary.html#cf_biz_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Blocker:](page.cgi?id=glossary.html#cf_blocker "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Marketing QA Status:](page.cgi?id=glossary.html#cf_marketing_qa_status "A custom Drop Down field in this installation of Bugzilla.") | --- | | [IT Deployment:](page.cgi?id=glossary.html#cf_it_deployment "A custom Drop Down field in this installation of Bugzilla.") | --- | |  | |  * [Clone This Bug](enter_bug.cgi?cloned_bug_id=1025068) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**X41-2017-001.txt**](attachment.cgi?id=715740 "View the content of the attachment") (9.90 KB, text/plain)  [2017-02-28 14:58 UTC](#attach_715740 "Go to the comment associated with the attachment"), Marcus Meissner | [Details](attachment.cgi?id=715740&action=edit) | | [**icetest.c**](attachment.cgi?id=715748 "View the content of the attachment") (3.78 KB, text/plain)  [2017-02-28 15:53 UTC](#attach_715748 "Go to the comment associated with the attachment"), Marcus Meissner | [Details](attachment.cgi?id=715748&action=edit) | | [**drop in replacement for getentropy() using getrandom()**](attachment.cgi?id=729646 "View the content of the attachment") (747 bytes, text/plain)  [2017-06-21 09:00 UTC](#attach_729646 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=729646&action=edit) | | [**drop in replacement for getentropy() using /dev/urandom**](attachment.cgi?id=729648 "View the content of the attachment") (746 bytes, text/plain)  [2017-06-21 09:00 UTC](#attach_729648 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=729648&action=edit) | | [**correct drop in replacement for getentropy() using getrandom()**](attachment.cgi?id=729649 "View the content of the attachment") (622 bytes, text/plain)  [2017-06-21 09:10 UTC](#attach_729649 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=729649&action=edit) | | [**Additional patch for openSUSE 42.2 with using these drop-in replacements for getentropy()**](attachment.cgi?id=729681 "View the content of the attachment") (2.98 KB, patch)  [2017-06-21 12:33 UTC](#attach_729681 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=729681&action=edit) | [Diff](attachment.cgi?id=729681&action=diff) | | [**Complete patch for Leap 42.2 with those drop-in replacements for getentropy()**](attachment.cgi?id=729683 "View the content of the attachment") (5.31 KB, patch)  [2017-06-21 12:46 UTC](#attach_729683 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=729683&action=edit) | [Diff](attachment.cgi?id=729683&action=diff) | | [**Merge getrandom() and /dev/urandom usage in one function**](attachment.cgi?id=730002 "View the content of the attachment") (2.18 KB, patch)  [2017-06-23 09:05 UTC](#attach_730002 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=730002&action=edit) | [Diff](attachment.cgi?id=730002&action=diff) | | [**runtime check for getrandom(), wrapper around both implementations**](attachment.cgi?id=730193 "View the content of the attachment") (1.91 KB, text/plain)  [2017-06-26 11:38 UTC](#attach_730193 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=730193&action=edit) | | [**Integrated previous patch by Matthias Gerstner**](attachment.cgi?id=730205 "View the content of the attachment") (3.08 KB, patch)  [2017-06-26 12:42 UTC](#attach_730205 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=730205&action=edit) | [Diff](attachment.cgi?id=730205&action=diff) | | [**Additional patch for openSUSE 42.2 with using drop-in replacements for getentropy()**](attachment.cgi?id=730212 "View the content of the attachment") (2.63 KB, patch)  [2017-06-26 13:57 UTC](#attach_730212 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=730212&action=edit) | [Diff](attachment.cgi?id=730212&action=diff) | | [**Complete patch for Leap 42.2 with that drop-in replacement for getentropy()**](attachment.cgi?id=730213 "View the content of the attachment") (5.52 KB, patch)  [2017-06-26 14:01 UTC](#attach_730213 "Go to the comment associated with the attachment"), Stefan Dirsch | [Details](attachment.cgi?id=730213&action=edit) | [Diff](attachment.cgi?id=730213&action=diff) | | [**adjusted PoC program**](attachment.cgi?id=730361 "View the content of the attachment") (4.03 KB, text/x-csrc)  [2017-06-27 11:08 UTC](#attach_730361 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=730361&action=edit) | | [**icetest2.c**](attachment.cgi?id=730982 "View the content of the attachment") (4.04 KB, text/plain)  [2017-07-03 08:06 UTC](#attach_730982 "Go to the comment associated with the attachment"), Marcus Meissner | [Details](attachment.cgi?id=730982&action=edit) | | [**improved icetest PoC for SLES11**](attachment.cgi?id=731944 "View the content of the attachment") (4.12 KB, text/x-csrc)  [2017-07-11 11:10 UTC](#attach_731944 "Go to the comment associated with the attachment"), Matthias Gerstner | [Details](attachment.cgi?id=731944&action=edit) | | [Show Obsolete](#a0) (7) [View All](attachment.cgi?bugid=1025068&action=viewall&hide_obsolete=1)  [Add an attachment](attachment.cgi?bugid=1025068&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=1025068&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1025068#c0)  Matthias Gerstner   2017-02-13 16:44:51 UTC  ``` Embargoed until CRD 2017-02-28.  Received via private discussion on mailing list:  Summary and Impact ------------------  libICE depends on arc4random() as well to generate the session cookies, thereby falling back to the same weak mechanism as libXdmcp.   For this issue a PoC is available which takes 2-3 seconds to retrieve  the key.  See also [bug 1025046](show_bug.cgi?id=1025046 "RESOLVED FIXED - VUL-0: CVE-2017-2625: libXdmcp: Weak entropy usage for session keys in libxdm"). ``` [Comment 1](show_bug.cgi?id=1025068#c1)  Matthias Gerstner   2017-02-13 16:47:57 UTC  ``` This is about function IceGenerateMagicCookie() in iceauth.c. We don't even have an arc4random() variant in our codestreams:  SUSE:SLE-12:Update/libICE/libICE-1.0.8/src/iceauth.c SUSE:SLE-11:Update/xorg-x11-libICE/libICE-1.0.4/src/iceauth.c SUSE:SLE-10-SP3:Update/xorg-x11/xc/lib/ICE/iceauth.c  It's all based on gettimeofday().  There is no final patch available yet. In worst case we can read sensible random data from /dev/?random.  We will give an update when the final patch is available. ``` [Comment 2](show_bug.cgi?id=1025068#c2)  Swamp Workflow Management   2017-02-13 23:02:03 UTC  ``` bugbot adjusting priority ``` [Comment 4](show_bug.cgi?id=1025068#c4)  Marcus Meissner   2017-02-28 14:57:54 UTC  ``` is now public ``` [Comment 5](show_bug.cgi?id=1025068#c5)  Marcus Meissner   2017-02-28 14:58:30 UTC  ``` Created [attachment 715740](attachment.cgi?id=715740 "X41-2017-001.txt") [[details]](attachment.cgi?id=715740&action=edit "X41-2017-001.txt") X41-2017-001.txt  X41-2017-001.txt  Weak Entropy Usage in Session Keys in libICE ============================================ Vulnerability Type: Other Affected Products: libICE Attack Type: Local Impact: Escalation of Privileges         Severity Rating: medium Confirmed Affected Version: 1.0.9 and lower Confirmed Patched Version: Vector: local CVE: CVE-2017-2626 CVSS Score: 7.1 CVSS Vector: CVSS:3.0/AV:L/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:N  Summary and Impact ------------------  libICE depends on arc4random() as well to generate the session cookies, thereby falling back to the same weak mechanism as libXdmcp:          IceGenerateMagicCookie (                 int len         )         {             char    *auth;         #ifndef HAVE_ARC4RANDOM_BUF             long    ldata[2];             int     seed;             int     value;             int     i;         #endif                      if ((auth = malloc (len + 1)) == NULL)                 return (NULL);                  #ifdef HAVE_ARC4RANDOM_BUF             arc4random_buf(auth, len);         #else         #ifdef ITIMER_REAL             {                 struct timeval  now;                 X_GETTIMEOFDAY (&now);                 ldata[0] = now.tv_sec;                 ldata[1] = now.tv_usec;             }         #else             {                 long    time ();                 ldata[0] = time ((long *) 0);                 ldata[1] = getpid ();             }         #endif             seed = (ldata[0]) + (ldata[1] << 16);             srand (seed);             for (i = 0; i < len; i++)             {                 value = rand ();                 auth[i] = value & 0xff;             }         #endif             auth[len] = '\0';             return (auth);         }  For this issue a PoC is available which takes 2-3 seconds to retrieve the key:  <https://www.x41-dsec.de/lab/sources/icetest.c>  Workaround ----------  Compile against libbsd ``` [Comment 6](show_bug.cgi?id=1025068#c6)  Marcus Meissner   2017-02-28 15:53:59 UTC  ``` Created [attachment 715748](attachment.cgi?id=715748 "icetest.c") [[details]](attachment.cgi?id=715748&action=edit "icetest.c") icetest.c  a reproducer posted by x41. ``` [Comment 7](show_bug.cgi?id=1025068#c7)  Stefan Dirsch   2017-05-18 12:36:27 UTC  ``` Meanwhile a fix came into git (libICE):  ff5e59f32255913bb1cdf51441b98c9107ae165b ``` [Comment 8](show_bug.cgi?id=1025068#c8)  Bernhard Wiedemann   2017-06-11 20:01:11 UTC  ``` This is an autogenerated message for OBS integration: This bug (1025068) was mentioned in <https://build.opensuse.org/request/show/502905> Factory / libICE ``` [Comment 9](show_bug.cgi?id=1025068#c9)  Stefan Dirsch   2017-06-11 20:19:15 UTC  ``` Factory is done. See above.  I also prepared updated packages for sle12, sle11 and even sle10. But now I noticed, that it didn't make any sense. :-(  getentropy() needs glibc 2.25, which is currently only provided by factory. Leap 42.2/42.3 doesn't fullfill this requirement, let alone sle12, sle11, sle10.   arc4random_buf() needs libbsd. Do we really want to add this requirement for the Leap products (42.2/42.3)? On sle12, sle11, sle10 we apparently ship no libbsd.  Matthias? Marcus? ``` [Comment 10](show_bug.cgi?id=1025068#c10)  Matthias Gerstner   2017-06-21 09:00:16 UTC  ``` Created [attachment 729646](attachment.cgi?id=729646 "drop in replacement for getentropy() using getrandom()") [[details]](attachment.cgi?id=729646&action=edit "drop in replacement for getentropy() using getrandom()") drop in replacement for getentropy() using getrandom() ``` [Comment 11](show_bug.cgi?id=1025068#c11)  Matthias Gerstner   2017-06-21 09:00:58 UTC  ``` Created [attachment 729648](attachment.cgi?id=729648 "drop in replacement for getentropy() using /dev/urandom") [[details]](attachment.cgi?id=729648&action=edit "drop in replacement for getentropy() using /dev/urandom") drop in replacement for getentropy() using /dev/urandom ``` [Comment 12](show_bug.cgi?id=1025068#c12)  Matthias Gerstner   2017-06-21 09:08:55 UTC  ``` Hi Stefan,  (In reply to sndirsch@suse.com from [comment #9](show_bug.cgi?id=1025068#c9)) > getentropy() needs glibc 2.25, which is currently only provided by factory. Leap 42.2/42.3 doesn't fullfill this requirement, let alone sle12, sle11, sle10.  >  > arc4random_buf() needs libbsd. Do we really want to add this requirement for the Leap products (42.2/42.3)? On sle12, sle11, sle10 we apparently ship no libbsd. >  > Matthias? Marcus?  Given how easy this is to exploit I'd like to see this fixed in some way on the older versions.  How about using a drop-in replacement for getentropy() on the versions that miss it? I've provided examples:  - in [attachment 729646](attachment.cgi?id=729646 "drop in replacement for getentropy() using getrandom()") [[details]](attachment.cgi?id=729646&action=edit "drop in replacement for getentropy() using getrandom()") using the getrandom() system call - in [attachment 729648](attachment.cgi?id=729648 "drop in replacement for getentropy() using /dev/urandom") [[details]](attachment.cgi?id=729648&action=edit "drop in replacement for getentropy() using /dev/urandom") using /dev/urandom, for versions that don't have the   getrandom() system call.  If this works for you then we could to the same for the other [bug 1025046](show_bug.cgi?id=1025046 "RESOLVED FIXED - VUL-0: CVE-2017-2625: libXdmcp: Weak entropy usage for session keys in libxdm") and [bug 1025084](show_bug.cgi?id=1025084 "RESOLVED FIXED - VUL-0: xorg-x11-server: Weak Entropy Usage in xorg server in GenerateRandomData()"). The code should be reviewed closely by somebody else than me, however, if we are going to use it. ``` [Comment 13](show_bug.cgi?id=1025068#c13)  Matthias Gerstner   2017-06-21 09:10:56 UTC  ``` Created [attachment 729649](attachment.cgi?id=729649 "correct drop in replacement for getentropy() using getrandom()") [[details]](attachment.cgi?id=729649&action=edit "correct drop in replacement for getentropy() using getrandom()") correct drop in replacement for getentropy() using getrandom() ``` [Comment 14](show_bug.cgi?id=1025068#c14)  Matthias Gerstner   2017-06-21 09:13:20 UTC  ``` Comment on [attachment 729646](attachment.cgi?id=729646 "drop in replacement for getentropy() using getrandom()") [[details]](attachment.cgi?id=729646&action=edit "drop in replacement for getentropy() using getrandom()") drop in replacement for getentropy() using getrandom()  #include <linux/random.h> #include <sys/syscall.h> #include <errno.h>  int getentropy(void *buffer, size_t length) { 	int res; 	size_t filled = 0;  	if( length > 256 ) 	{ 		errno = EIO; 		return -1; 	}  	while( filled < length ) 	{ 		/* 		 * glibc does not contain a syscall wrapper for this in older 		 * versions 		 */ 		res = syscall(SYS_getrandom, (char*)buffer + filled, length - filled, 0);  		if( res == -1 ) 		{ 			if( errno == EINTR ) 				continue;  			return -1; 		} 		else if( res == 0 ) 		{ 			// no more bytes available? should not happen 			errno = EIO; 			return -1; 		}  		filled += res; 	}  	return 0; } ``` [Comment 15](show_bug.cgi?id=1025068#c15)  Stefan Dirsch   2017-06-21 12:33:22 UTC  ``` Created [attachment 729681](attachment.cgi?id=729681&action=diff "Additional patch for openSUSE 42.2 with using these drop-in replacements for getentropy()") [[details]](attachment.cgi?id=729681&action=edit "Additional patch for openSUSE 42.2 with using these drop-in replacements for getentropy()") Additional patch for openSUSE 42.2 with using these drop-in replacements for getentropy() ``` [Comment 16](show_bug.cgi?id=1025068#c16)  Stefan Dirsch   2017-06-21 12:46:46 UTC  ``` Created [attachment 729683](attachment.cgi?id=729683&action=diff "Complete patch for Leap 42.2 with those drop-in replacements for getentropy()") [[details]](attachment.cgi?id=729683&action=edit "Complete patch for Leap 42.2 with those drop-in replacements for getentropy()") Complete patch for Leap 42.2 with those drop-in replacements for getentropy() ``` [Comment 17](show_bug.cgi?id=1025068#c17)  Stefan Dirsch   2017-06-21 12:51:12 UTC  ``` Apparently Leap 42.2 doesn't provide getrandom() either or I did something wrong. Can you confirm this, please?  [    7s] checking for arc4random_buf... no [    7s] checking for getentropy... no [    7s] checking for getrandom... no ``` [Comment 18](show_bug.cgi?id=1025068#c18)  Marcus Meissner   2017-06-21 13:25:29 UTC  ``` mattzhias patch is not using getrandom itself, it uses syscall() ``` [Comment 19](show_bug.cgi?id=1025068#c19)  Stefan Dirsch   2017-06-21 16:24:27 UTC  ``` Which means what? How is this related to configure not finding getrandom() on Leap 42.2? ``` [Comment 20](show_bug.cgi?id=1025068#c20)  Stefan Dirsch   2017-06-21 16:29:25 UTC  ``` Or is it only possible to figure out, whether getrandom() is available during runtime? I can rewrite the patch, so the getrandom() replacement is tried. And if that fails, use the /dev/urandom replacement. I just need to know ... ``` [Comment 21](show_bug.cgi?id=1025068#c21)  Matthias Gerstner   2017-06-22 10:08:06 UTC  ``` (In reply to Stefan Dirsch from [comment #19](show_bug.cgi?id=1025068#c19)) > Which means what? How is this related to configure not finding getrandom() > on Leap 42.2?  The thing is that glibc only recently added a wrapper/declaration for the getrandom system call. It's been added to version 2.25:  <https://sourceware.org/ml/libc-alpha/2017-02/msg00079.html>  The system call was implemented in kernel for a much longer time, however:  <https://github.com/torvalds/linux/commit/c6e9d6f388947> <https://lwn.net/Articles/711013/>  The configure check seems to look for the system call declaration, which is not present. The code I provided uses the syscall() approach to work around the missing declaration.  I don't know if there's a configure check to only check whether the system call is implemented in the kernel (would return ENOSYS if not so).  The problem is also stated here:  <http://permalink.gmane.org/gmane.comp.lib.glibc.bugs/22297>  We could change the drop-in replacement to check at runtime, whether the getrandom() system call works, and fall back to reading /dev/urandom in case ENOSYS is returned. I can adjust the code if and provide to you, if you need it. ``` [Comment 22](show_bug.cgi?id=1025068#c22)  Stefan Dirsch   2017-06-22 21:38:13 UTC  ``` (In reply to Matthias Gerstner from [comment #21](show_bug.cgi?id=1025068#c21)) > We could change the drop-in replacement to check at runtime, whether the > getrandom() system call works, and fall back to reading /dev/urandom in case > ENOSYS is returned. I can adjust the code if and provide to you, if you need > it.  That would be helpful and would make sense, I think. Of course I can just try both drop-in replacements as proposed in [comment #20](show_bug.cgi?id=1025068#c20). ``` [Comment 23](show_bug.cgi?id=1025068#c23)  Stefan Dirsch   2017-06-23 09:05:43 UTC  ``` Created [attachment 730002](attachment.cgi?id=730002&action=diff "Merge getrandom() and /dev/urandom usage in one function") [[details]](attachment.cgi?id=730002&action=edit "Merge getrandom() and /dev/urandom usage in one function") Merge getrandom() and /dev/urandom usage in one function  How about this one? I guess I need a review here. ;-) ``` [Comment 24](show_bug.cgi?id=1025068#c24)  Matthias Gerstner   2017-06-26 11:38:15 UTC  ``` Created [attachment 730193](attachment.cgi?id=730193 "runtime check for getrandom(), wrapper around both implementations") [[details]](attachment.cgi?id=730193&action=edit "runtime check for getrandom(), wrapper around both implementations") runtime check for getrandom(), wrapper around both implementations ``` [Comment 25](show_bug.cgi?id=1025068#c25)  Matthias Gerstner   2017-06-26 11:43:39 UTC  ``` (In reply to sndirsch@suse.com from [comment #23](show_bug.cgi?id=1025068#c23)) > Created [attachment 730002](attachment.cgi?id=730002&action=diff "Merge getrandom() and /dev/urandom usage in one function") [[details]](attachment.cgi?id=730002&action=edit "Merge getrandom() and /dev/urandom usage in one function") > Merge getrandom() and /dev/urandom usage in one function >  > How about this one? I guess I need a review here. ;-)  Sorry for the delay but I was sick for some days.  I'd rather keep the two approaches of using getrandom() / urandom clearly separated, even if it means some duplicate code. It's easier to read and we can also more easily compare it to similar wrappers in glibc, for example.  Also we need a check for the definition of SYS_getrandom.  Please find a new suggestion in [attachment 730193](attachment.cgi?id=730193 "runtime check for getrandom(), wrapper around both implementations") [[details]](attachment.cgi?id=730193&action=edit "runtime check for getrandom(), wrapper around both implementations"). ``` [Comment 26](show_bug.cgi?id=1025068#c26)  Stefan Dirsch   2017-06-26 12:42:13 UTC  ``` Created [attachment 730205](attachment.cgi?id=730205&action=diff "Integrated previous patch by Matthias Gerstner") [[details]](attachment.cgi?id=730205&action=edit "Integrated previous patch by Matthias Gerstner") Integrated previous patch by Matthias Gerstner  Added configure check for SYS_getrandom, which doesn't seem to work. :-(   checking for arc4random_buf in -lbsd... no checking for asprintf... yes checking for arc4random_buf... no checking for getentropy... no checking for SYS_getrandom... no  At least not on openSUSE 42.2.  Renamed getentropy() wrapper to getentropy_emulate(). ``` [Comment 27](show_bug.cgi?id=1025068#c27)  Stefan Dirsch   2017-06-26 12:46:50 UTC  ``` I'm afraid I haven't understood, what you've meant with    "Also we need a check for the definition of SYS_getrandom"  :-( ``` [Comment 28](show_bug.cgi?id=1025068#c28)  Matthias Gerstner   2017-06-26 13:39:10 UTC  ``` Sorry, should have been more clear. I was referring to the    #ifdef SYS_getrandom  that is already in the new code I suggested. ``` [Comment 29](show_bug.cgi?id=1025068#c29)  Stefan Dirsch   2017-06-26 13:50:36 UTC  ``` Ok. So no need for a configure check. ;-) ``` [Comment 30](show_bug.cgi?id=1025068#c30)  Stefan Dirsch   2017-06-26 13:57:37 UTC  ``` Created [attachment 730212](attachment.cgi?id=730212&action=diff "Additional patch for openSUSE 42.2 with using drop-in replacements for getentropy()") [[details]](attachment.cgi?id=730212&action=edit "Additional patch for openSUSE 42.2 with using drop-in replacements for getentropy()") Additional patch for openSUSE 42.2 with using drop-in replacements for getentropy() ``` [Comment 31](show_bug.cgi?id=1025068#c31)  Stefan Dirsch   2017-06-26 14:01:33 UTC  ``` Created [attachment 730213](attachment.cgi?id=730213&action=diff "Complete patch for Leap 42.2 with that drop-in replacement for getentropy()") [[details]](attachment.cgi?id=730213&action=edit "Complete patch for Leap 42.2 with that drop-in replacement for getentropy()") Complete patch for Leap 42.2 with that drop-in replacement for getentropy() ``` [Comment 32](show_bug.cgi?id=1025068#c32)  Matthias Gerstner   2017-06-27 11:08:05 UTC  ``` Created [attachment 730361](attachment.cgi?id=730361 "adjusted PoC program") [[details]](attachment.cgi?id=730361&action=edit "adjusted PoC program") adjusted PoC program  Let's not forget about the QA reproducer so we can check whether our patch really works. I'm attached an adjusted variant of the PoC program with which I was able to reproduce the issue. I've tested this on SLE-12 SP2.  For compilation you need to install:    zypper in libICE-devel  Then build:    gcc -oicetest2 icetest2.c -O2 -lICE  Remove old ICE connections and restart display manager (without this there seems to be a too high time jitter from boot for the PoC to work):    rm /tmp/.ICE-unix/*   systemctl restart xdm  Run the PoC:    ./icetest2  *Without* the bugfix this should show:  > Connection opened > Using time: 1498561424 212899  *After* the bugfix this should show:  > Failed ``` [Comment 33](show_bug.cgi?id=1025068#c33)  Stefan Dirsch   2017-06-27 11:45:18 UTC  ``` Thanks for the reproducer! I will test this later.  On sle10 O_CLOEXEC option for open() is not available yet. Also it isn''t supported before Kernel 2.6.23 and we still ship Kernel 2.6.16 with sle10.  So I've removed this option and close the FD before returning from the getentropy_urandom(...) function. Hope this makes sense. ``` [Comment 34](show_bug.cgi?id=1025068#c34)  Stefan Dirsch   2017-06-27 12:15:18 UTC  ``` (In reply to Stefan Dirsch from [comment #33](show_bug.cgi?id=1025068#c33)) > Thanks for the reproducer! I will test this later.  Appears to work. Tested on Leap 42.3 with my current patches. :-) ``` [Comment 35](show_bug.cgi?id=1025068#c35)  Stefan Dirsch   2017-06-27 12:30:30 UTC  ``` Patches submitted for Leap 42.2, sle12, sle11 and sle10. Reassigning back to security team. ``` [Comment 36](show_bug.cgi?id=1025068#c36)  Bernhard Wiedemann   2017-06-27 14:00:26 UTC  ``` This is an autogenerated message for OBS integration: This bug (1025068) was mentioned in <https://build.opensuse.org/request/show/506471> 42.2 / libICE ``` [Comment 38](show_bug.cgi?id=1025068#c38)  Matthias Gerstner   2017-06-27 14:08:42 UTC  ``` (In reply to sndirsch@suse.com from [comment #33](show_bug.cgi?id=1025068#c33))  > So I've removed this option and close the FD before returning from the > getentropy_urandom(...) function. Hope this makes sense.  That's correct but also leads me to a bug in my code: The close() needs to be added to all exit paths in all codestreams like this, otherwise there's a file descriptor leak:  > int getentropy_urandom(void *buffer, size_t length) > { > 	int random_fd = -1; > 	ssize_t res = -1; > 	size_t filled = 0; >  > 	if( length > 256 ) > 	{ > 		errno = EIO; > 		return -1; > 	} >  > 	random_fd = open("/dev/urandom", O_RDONLY | O_CLOEXEC); >  > 	if( random_fd == -1 ) > 	{ > 		return -1; > 	} >  > 	while( filled < length ) > 	{ > 		res = read(random_fd, (char*)buffer + filled, length - filled); >  > 		if( res == -1 ) > 		{ > 			// shouldn't actually happen acc. to man(4) random, > 			// but you never know > 			if( errno == EINTR ) > 				continue; >  > 			close(random_fd); > 			return -1; > 		} > 		else if( res == 0 ) > 		{ > 			// no more bytes available? should not happen > 			close(random_fd); > 			errno = EIO; > 			return -1; > 		} >  > 		filled += res; > 	} >  > 	close(random_fd); > 	return 0; > }  Can you please fix this, too? Sorry that this bug turned into such a monster :-( ``` [Comment 39](show_bug.cgi?id=1025068#c39)  Stefan Dirsch   2017-06-27 14:35:58 UTC  ``` (In reply to Matthias Gerstner from [comment #38](show_bug.cgi?id=1025068#c38)) > > So I've removed this option and close the FD before returning from the > > getentropy_urandom(...) function. Hope this makes sense. >  > That's correct but also leads me to a bug in my code: The close() needs to be > added to all exit paths in all codestreams like this, otherwise there's a > file descriptor leak: > Can you please fix this, too?   done. :-)  > Sorry that this bug turned into such a monster > :-(  np ``` [Comment 40](show_bug.cgi?id=1025068#c40)  Bernhard Wiedemann   2017-06-27 16:00:37 UTC  ``` This is an autogenerated message for OBS integration: This bug (1025068) was mentioned in <https://build.opensuse.org/request/show/506493> 42.2 / libICE ``` [Comment 43](show_bug.cgi?id=1025068#c43)  Swamp Workflow Management   2017-07-01 08:28:48 UTC  ``` An update workflow for this issue was started. This issue was rated as moderate. Please submit fixed packages until 2017-07-17. When done, reassign the bug to security-team@suse.de. <https://swamp.suse.de/webswamp/wf/63741> ``` [Comment 44](show_bug.cgi?id=1025068#c44)  Marcus Meissner   2017-07-03 08:06:05 UTC  ``` Created [attachment 730982](attachment.cgi?id=730982 "icetest2.c") [[details]](attachment.cgi?id=730982&action=edit "icetest2.c") icetest2.c  QA REPRODUCER:  gcc -O2 -Wall -g -o icetest2 icetest2.c  -lICE ./icetest2  it should NOT report "Connection opened" like: Trying connection local/jet.franken.de:@/tmp/.ICE-unix/2777 Connection opened Using time: 1498981551 122280 ``` [Comment 45](show_bug.cgi?id=1025068#c45)  Swamp Workflow Management   2017-07-06 22:10:56 UTC  ``` openSUSE-SU-2017:1801-1: An update that fixes one vulnerability is now available.  Category: security (moderate) Bug References: 1025068 CVE References: CVE-2017-2626 Sources used: openSUSE Leap 42.2 (src):    libICE-1.0.9-5.3.1 ``` [Comment 46](show_bug.cgi?id=1025068#c46)  Tony Yuan   2017-07-10 05:17:55 UTC  ``` When I am running the test case(icetest2) on sles11sp4. It seems it's falling in infinite loop and can never exit. The gnome-session daemon uses up 100% cpu.  Even after I kill the icetest2 process the gnome-session still uses 100% cpu. I have to reboot for gnome-session to go back to normal.  The result is the same regardless of whether I install the update or not. ``` [Comment 47](show_bug.cgi?id=1025068#c47)  Tony Yuan   2017-07-10 05:19:48 UTC  ``` The test case work well on sles12sp2 without the problem on #c46 ``` [Comment 48](show_bug.cgi?id=1025068#c48)  Stefan Dirsch   2017-07-10 09:00:05 UTC  ``` Hmm. Even before security update? Have you read instructions of [comment #32](show_bug.cgi?id=1025068#c32)?  > [...] > systemctl restart xdm  Since we did not have systemd on sle11 yet, this needs to be    rcxdm restart  Just to be sure ... ``` [Comment 49](show_bug.cgi?id=1025068#c49)  Tony Yuan   2017-07-10 09:16:25 UTC  ``` (In reply to Stefan Dirsch from [comment #48](show_bug.cgi?id=1025068#c48)) > Hmm. Even before security update? Have you read instructions of [comment #32](show_bug.cgi?id=1025068#c32)?  Yes, I followed the instructions of [comment #32](show_bug.cgi?id=1025068#c32)   >  > > [...] > > systemctl restart xdm >  > Since we did not have systemd on sle11 yet, this needs to be >  >   rcxdm restart >  > Just to be sure ...  Yes, rcxdm restart (or telinit 3, telinit 5) ``` [Comment 50](show_bug.cgi?id=1025068#c50)  Stefan Dirsch   2017-07-10 09:55:30 UTC  ``` Then I don't know either. It is my understanding that gnome-session is not running before one is doing a login, right?  I believe I was testing without login at all. I was logged in into the VM as root via ssh, removed the sockets below  /tmp/.ICE-unix, restarted display manager and then ran the reproducer withouth having access to any X display.  Matthias, can you help us here? ``` [Comment 51](show_bug.cgi?id=1025068#c51)  Matthias Gerstner   2017-07-10 12:43:30 UTC  ``` (In reply to Stefan Dirsch from [comment #50](show_bug.cgi?id=1025068#c50)) > Then I don't know either. It is my understanding that gnome-session is not > running before one is doing a login, right? >  > I believe I was testing without login at all. I was logged in into the VM as > root via ssh, removed the sockets below  /tmp/.ICE-unix, restarted display > manager and then ran the reproducer withouth having access to any X display.  Some local user must be logged in with a display manager like gdm that uses libICE for communication. Otherwise there should be no sockets in /tmp/.ICE-unix to brute force.   > Matthias, can you help us here?  Yeah I can reproduce the infinite loop in gnome-session on SLES-11-SP4 as well. gnome-session is the daemon that implements the other end of the libICE authentication in this scenario. After a long time of debugging it fell on my head. There's a file descriptor leak, probably in gnome-session or some X library on SLES-11-SP4. When you look at    ls -l /proc/`pidof gnome-session`/fd  you'll see that 1023 file descriptors are opened by gnome-session and thus it can't accept() any more requests from the icetest2 PoC application. You'll also get a large .xsession-errors file in the logged in user's home directory with lines like this:    _IceTransSocketUNIXAccept: accept() failed  All further communication of the gnome-session daemon then fails and the open gnome session is more or less broken, gnome-session wasting resources trying to communicate.  Long story short: There's also some local DoS in the gdm/X setup on SLES-11-SP4 allowing a local user to perform ~1024 unsuccessful calls to IceOpenConnection() and the gdm session will break.  I haven't found the exact location where the leak occurs. Will need to dig more into the sources. ``` [Comment 52](show_bug.cgi?id=1025068#c52)  Matthias Gerstner   2017-07-10 14:58:16 UTC  ``` So I've found the issue in gnome-session causing the file descriptor leak. Basically this commit is missing:  <https://github.com/GNOME/gnome-session/commit/b0dc999e0b45355314616321dbb6cb71e729fc9d>  I've made a branch of gnome-session in    home:mgerstner:branches:SUSE:SLE-11-SP1:Update/gnome-session  containing this fix. Using this variant of gnome-session the issue goes away. For this issue we should open a bug against gnome-session maintainers, might even we worth a CVE, because it's an easy local denial of service, but only in old software.  However, even with fixed gnome-session, it seems the PoC is still not working (failing). This might be due to a slightly different random data seed used in SLE-11-SP4. I might investigate this further tomorrow. ``` [Comment 53](show_bug.cgi?id=1025068#c53)  Matthias Gerstner   2017-07-11 11:10:58 UTC  ``` Created [attachment 731944](attachment.cgi?id=731944 "improved icetest PoC for SLES11") [[details]](attachment.cgi?id=731944&action=edit "improved icetest PoC for SLES11") improved icetest PoC for SLES11  So I've been able to reproduce the PoC on SLES11-SP4 now. Using the gnome-session package from [comment#52](show_bug.cgi?id=1025068#c52) and using this new attachment icetest3.c. This PoC worked reliably multiple times for me. The reason why the previous PoC was not working well was that on SLES11-SP4 the file system does not store nanosecond precision timestamps for the sockets in /tmp/.ICE-unix/*. Therefore the interval chosen by the previous PoC was not big enough. The new PoC cycles through all possible values that IceGenerateMagicCookie() can use. It doesn't take much longer to run.  Regarding the DoS issue in gnome-session on SLES11-SP4 I've submitted a CVE request and will post to oss-sec, security team will open a separate bug for that.  Please tell me when there are any other issues with testing this. ``` [Comment 54](show_bug.cgi?id=1025068#c54)  Swamp Workflow Management   2017-07-11 19:13:34 UTC  ``` SUSE-SU-2017:1835-1: An update that fixes one vulnerability is now available.  Category: security (moderate) Bug References: 1025068 CVE References: CVE-2017-2626 Sources used: SUSE Linux Enterprise Software Development Kit 12-SP2 (src):    libICE-1.0.8-10.1 SUSE Linux Enterprise Server for Raspberry Pi 12-SP2 (src):    libICE-1.0.8-10.1 SUSE Linux Enterprise Server 12-SP2 (src):    libICE-1.0.8-10.1 SUSE Linux Enterprise Desktop 12-SP2 (src):    libICE-1.0.8-10.1 ``` [Comment 55](show_bug.cgi?id=1025068#c55)  Tony Yuan   2017-07-12 06:59:50 UTC  ``` I created a branch for gnome-session from yours and tested the new reproducer with the gnome-session. It works well.   A question: should we approve the sle11sp4 libice update now or wait until the fixed gnome-session update is available? ``` [Comment 56](show_bug.cgi?id=1025068#c56)  Matthias Gerstner   2017-07-12 08:30:40 UTC  ``` For the record: We've opened [bug 1048274](show_bug.cgi?id=1048274 "RESOLVED FIXED - VUL-1: CVE-2017-11171: gnome-session: Bad reference counting in the context of accept_ice_connection() ingsm-xsmp-server.c in old versions of gnome-session up until version 2.29.92allows a local attacker to establish ICE connections to gn") for the gnome-session issue.  This is independent of the libICE issue handled in this bug. The gnome-session bugfix is only required for testing the PoC for the libICE bug. ``` [Comment 57](show_bug.cgi?id=1025068#c57)  Marcus Meissner   2017-07-12 09:05:57 UTC  ``` If the ICE issue is now fixed, you can approve it even before we have a gnome-session fix ``` [Comment 58](show_bug.cgi?id=1025068#c58)  Swamp Workflow Management   2017-07-12 19:10:40 UTC  ``` SUSE-SU-2017:1848-1: An update that fixes one vulnerability is now available.  Category: security (moderate) Bug References: 1025068 CVE References: CVE-2017-2626 Sources used: SUSE Linux Enterprise Software Development Kit 11-SP4 (src):    xorg-x11-libICE-7.4-3.1 SUSE Linux Enterprise Server 11-SP4 (src):    xorg-x11-libICE-7.4-3.1 SUSE Linux Enterprise Debuginfo 11-SP4 (src):    xorg-x11-libICE-7.4-3.1 ``` [Comment 59](show_bug.cgi?id=1025068#c59)  Marcus Meissner   2017-10-25 19:18:19 UTC  ``` released ``` [Comment 60](show_bug.cgi?id=1025068#c60)  Swamp Workflow Management   2018-02-01 17:10:19 UTC  ``` SUSE-SU-2018:0337-1: An update that fixes one vulnerability is now available.  Category: security (moderate) Bug References: 1025068 CVE References: CVE-2017-2626 Sources used: SUSE Linux Enterprise Software Development Kit 12-SP3 (src):    libICE-1.0.8-12.1 SUSE Linux Enterprise Server 12-SP3 (src):    libICE-1.0.8-12.1 SUSE Linux Enterprise Desktop 12-SP3 (src):    libICE-1.0.8-12.1 ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=1025068)
* - [XML](show_bug.cgi?ctype=xml&id=1025068)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=1025068)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1025068)
  + |
    [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

+ Legal:
+ [openSUSE](http://en.opensuse.org/Terms_of_site)
+ [SUSE](https://www.suse.com/company/legal/)



=== Content from github.com_01c5cced_20250125_161410.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGNOME%2Fgnome-session%2Fcommit%2Fb0dc999e0b45355314616321dbb6cb71e729fc9d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGNOME%2Fgnome-session%2Fcommit%2Fb0dc999e0b45355314616321dbb6cb71e729fc9d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=GNOME%2Fgnome-session)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[GNOME](/GNOME)
/
**[gnome-session](/GNOME/gnome-session)**
Public

* [Notifications](/login?return_to=%2FGNOME%2Fgnome-session) You must be signed in to change notification settings
* [Fork
  13](/login?return_to=%2FGNOME%2Fgnome-session)
* [Star
   18](/login?return_to=%2FGNOME%2Fgnome-session)

* [Code](/GNOME/gnome-session)
* [Pull requests
  0](/GNOME/gnome-session/pulls)
* [Actions](/GNOME/gnome-session/actions)
* [Projects
  0](/GNOME/gnome-session/projects)
* [Security](/GNOME/gnome-session/security)
* [Insights](/GNOME/gnome-session/pulse)

Additional navigation options

* [Code](/GNOME/gnome-session)
* [Pull requests](/GNOME/gnome-session/pulls)
* [Actions](/GNOME/gnome-session/actions)
* [Projects](/GNOME/gnome-session/projects)
* [Security](/GNOME/gnome-session/security)
* [Insights](/GNOME/gnome-session/pulse)

## Commit

[Permalink](/GNOME/gnome-session/commit/b0dc999e0b45355314616321dbb6cb71e729fc9d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gsm] Delay the creation of the GsmXSMPClient until it really exists

[Browse files](/GNOME/gnome-session/tree/b0dc999e0b45355314616321dbb6cb71e729fc9d)
Browse the repository at this point in the history

```
We used to create the GsmXSMPClient before the XSMP connection is really
accepted. This can lead to some issues, though. An example is:
<https://bugzilla.gnome.org/show_bug.cgi?id=598211#c19>. Quoting:

 "What is happening is that a new client (probably metacity in your
 case) is opening an ICE connection in the GSM_MANAGER_PHASE_END_SESSION
 phase, which causes a new GsmXSMPClient to be added to the client
 store. The GSM_MANAGER_PHASE_EXIT phase then begins before the client
 has had a chance to establish a xsmp connection, which means that
 client->priv->conn will not be initialized at the point that xsmp_stop
 is called on the new unregistered client."

The fix is to create the GsmXSMPClient object when there's a real XSMP
connection. This implies moving the timeout that makes sure we don't
have an empty client to the XSMP server.

<https://bugzilla.gnome.org/show_bug.cgi?id=598211>
```

* Loading branch information

[![@vuntz](https://avatars.githubusercontent.com/u/1758783?s=40&v=4)](/vuntz)

Romain Perier
authored and
[vuntz](/GNOME/gnome-session/commits?author=vuntz "View all commits by vuntz")
committed
Mar 9, 2010

1 parent
[5198aa0](/GNOME/gnome-session/commit/5198aa08d2b77204cd8bf669a64f2e044d9a9e0d)

commit b0dc999

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**124 additions**
and
**56 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* gnome-session

  + gnome-session/gsm-xsmp-client.c
    [gsm-xsmp-client.c](#diff-dd86793759992829b17aef9ec1659700cf4d7c9065b6ff8df7f2b6014b57a119)
  + gnome-session/gsm-xsmp-server.c
    [gsm-xsmp-server.c](#diff-143dcf845b861a940b29eb89fb916904583fffe0104669a8e731045c6d2795d1)

## There are no files selected for viewing

30 changes: 0 additions & 30 deletions

30
[gnome-session/gsm-xsmp-client.c](#diff-dd86793759992829b17aef9ec1659700cf4d7c9065b6ff8df7f2b6014b57a119 "gnome-session/gsm-xsmp-client.c")

Show comments

[View file](/GNOME/gnome-session/blob/b0dc999e0b45355314616321dbb6cb71e729fc9d/gnome-session/gsm-xsmp-client.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -51,7 +51,6 @@ struct GsmXSMPClientPrivate |
|  |  | IceConn ice\_connection; |
|  |  |  |
|  |  | guint watch\_id; |
|  |  | guint protocol\_timeout; |
|  |  |  |
|  |  | char \*description; |
|  |  | GPtrArray \*props; |
| Expand Down  Expand Up | | @@ -115,22 +114,6 @@ client\_iochannel\_watch (GIOChannel \*channel, |
|  |  | return keep\_going; |
|  |  | } |
|  |  |  |
|  |  | /\* Called if too much time passes between the initial connection and |
|  |  | \* the XSMP protocol setup. |
|  |  | \*/ |
|  |  | static gboolean |
|  |  | \_client\_protocol\_timeout (GsmXSMPClient \*client) |
|  |  | { |
|  |  | g\_debug ("GsmXSMPClient: client\_protocol\_timeout for client '%s' in ICE status %d", |
|  |  | client->priv->description, |
|  |  | IceConnectionStatus (client->priv->ice\_connection)); |
|  |  |  |
|  |  | gsm\_client\_set\_status (GSM\_CLIENT (client), GSM\_CLIENT\_FAILED); |
|  |  | gsm\_client\_disconnected (GSM\_CLIENT (client)); |
|  |  |  |
|  |  | return FALSE; |
|  |  | } |
|  |  |  |
|  |  | static SmProp \* |
|  |  | find\_property (GsmXSMPClient \*client, |
|  |  | const char \*name, |
| Expand Down  Expand Up | | @@ -193,10 +176,6 @@ setup\_connection (GsmXSMPClient \*client) |
|  |  | client); |
|  |  | g\_io\_channel\_unref (channel); |
|  |  |  |
|  |  | client->priv->protocol\_timeout = g\_timeout\_add\_seconds (5, |
|  |  | (GSourceFunc)\_client\_protocol\_timeout, |
|  |  | client); |
|  |  |  |
|  |  | set\_description (client); |
|  |  |  |
|  |  | g\_debug ("GsmXSMPClient: New client '%s'", client->priv->description); |
| Expand Down  Expand Up | | @@ -869,10 +848,6 @@ gsm\_xsmp\_client\_disconnect (GsmXSMPClient \*client) |
|  |  | IceSetShutdownNegotiation (client->priv->ice\_connection, FALSE); |
|  |  | IceCloseConnection (client->priv->ice\_connection); |
|  |  | } |
|  |  |  |
|  |  | if (client->priv->protocol\_timeout > 0) { |
|  |  | g\_source\_remove (client->priv->protocol\_timeout); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static void |
| Expand Down  Expand Up | | @@ -1305,11 +1280,6 @@ gsm\_xsmp\_client\_connect (GsmXSMPClient \*client, |
|  |  | { |
|  |  | client->priv->conn = conn; |
|  |  |  |
|  |  | if (client->priv->protocol\_timeout) { |
|  |  | g\_source\_remove (client->priv->protocol\_timeout); |
|  |  | client->priv->protocol\_timeout = 0; |
|  |  | } |
|  |  |  |
|  |  | g\_debug ("GsmXSMPClient: Initializing client %s", client->priv->description); |
|  |  |  |
|  |  | \*mask\_ret = 0; |
| Expand Down | |  |

150 changes: 124 additions & 26 deletions

150
[gnome-session/gsm-xsmp-server.c](#diff-143dcf845b861a940b29eb89fb916904583fffe0104669a8e731045c6d2795d1 "gnome-session/gsm-xsmp-server.c")

Show comments

[View file](/GNOME/gnome-session/blob/b0dc999e0b45355314616321dbb6cb71e729fc9d/gnome-session/gsm-xsmp-server.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -91,44 +91,134 @@ typedef struct { |
|  |  | IceListenObj listener; |
|  |  | } GsmIceConnectionData; |
|  |  |  |
|  |  | typedef struct { |
|  |  | guint watch\_id; |
|  |  | guint protocol\_timeout; |
|  |  | } GsmIceConnectionWatch; |
|  |  |  |
|  |  | static void |
|  |  | disconnect\_ice\_connection (IceConn ice\_conn) |
|  |  | { |
|  |  | IceSetShutdownNegotiation (ice\_conn, FALSE); |
|  |  | IceCloseConnection (ice\_conn); |
|  |  | } |
|  |  |  |
|  |  | static void |
|  |  | free\_ice\_connection\_watch (GsmIceConnectionWatch \*data) |
|  |  | { |
|  |  | if (data->watch\_id) { |
|  |  | g\_source\_remove (data->watch\_id); |
|  |  | data->watch\_id = 0; |
|  |  | } |
|  |  |  |
|  |  | if (data->protocol\_timeout) { |
|  |  | g\_source\_remove (data->protocol\_timeout); |
|  |  | data->protocol\_timeout = 0; |
|  |  | } |
|  |  |  |
|  |  | g\_free (data); |
|  |  | } |
|  |  |  |
|  |  | static gboolean |
|  |  | ice\_protocol\_timeout (IceConn ice\_conn) |
|  |  | { |
|  |  | GsmIceConnectionWatch \*data; |
|  |  |  |
|  |  | g\_debug ("GsmXsmpServer: ice\_protocol\_timeout for IceConn %p with status %d", |
|  |  | ice\_conn, IceConnectionStatus (ice\_conn)); |
|  |  |  |
|  |  | data = ice\_conn->context; |
|  |  |  |
|  |  | free\_ice\_connection\_watch (data); |
|  |  | disconnect\_ice\_connection (ice\_conn); |
|  |  |  |
|  |  | return FALSE; |
|  |  | } |
|  |  |  |
|  |  | static gboolean |
|  |  | auth\_iochannel\_watch (GIOChannel \*source, |
|  |  | GIOCondition condition, |
|  |  | IceConn ice\_conn) |
|  |  | { |
|  |  |  |
|  |  | GsmIceConnectionWatch \*data; |
|  |  | gboolean keep\_going; |
|  |  |  |
|  |  | data = ice\_conn->context; |
|  |  |  |
|  |  | switch (IceProcessMessages (ice\_conn, NULL, NULL)) { |
|  |  | case IceProcessMessagesSuccess: |
|  |  | keep\_going = TRUE; |
|  |  | break; |
|  |  | case IceProcessMessagesIOError: |
|  |  | g\_debug ("GsmXsmpServer: IceProcessMessages returned IceProcessMessagesIOError"); |
|  |  | free\_ice\_connection\_watch (data); |
|  |  | disconnect\_ice\_connection (ice\_conn); |
|  |  | keep\_going = FALSE; |
|  |  | break; |
|  |  | case IceProcessMessagesConnectionClosed: |
|  |  | g\_debug ("GsmXsmpServer: IceProcessMessages returned IceProcessMessagesConnectionClosed"); |
|  |  | free\_ice\_connection\_watch (data); |
|  |  | keep\_going = FALSE; |
|  |  | break; |
|  |  | default: |
|  |  | g\_assert\_not\_reached (); |
|  |  | } |
|  |  |  |
|  |  | return keep\_going; |
|  |  | } |
|  |  |  |
|  |  | /\* IceAcceptConnection returns a new ICE connection that is in a "pending" state, |
|  |  | \* this is because authentification may be necessary. |
|  |  | \* So we've to authenticate it, before accept\_xsmp\_connection() is called. |
|  |  | \* Then each GsmXSMPClient will have its own IceConn watcher |
|  |  | \*/ |
|  |  | static void |
|  |  | auth\_ice\_connection (IceConn ice\_conn) |
|  |  | { |
|  |  | GIOChannel \*channel; |
|  |  | GsmIceConnectionWatch \*data; |
|  |  | int fd; |
|  |  |  |
|  |  | g\_debug ("GsmXsmpServer: auth\_ice\_connection()"); |
|  |  |  |
|  |  | fd = IceConnectionNumber (ice\_conn); |
|  |  | fcntl (fd, F\_SETFD, fcntl (fd, F\_GETFD, 0) | FD\_CLOEXEC); |
|  |  | channel = g\_io\_channel\_unix\_new (fd); |
|  |  |  |
|  |  | data = g\_new0 (GsmIceConnectionWatch, 1); |
|  |  | ice\_conn->context = data; |
|  |  |  |
|  |  | data->protocol\_timeout = g\_timeout\_add\_seconds (5, |
|  |  | (GSourceFunc)ice\_protocol\_timeout, |
|  |  | ice\_conn); |
|  |  | data->watch\_id = g\_io\_add\_watch (channel, |
|  |  | G\_IO\_IN | G\_IO\_ERR, |
|  |  | (GIOFunc)auth\_iochannel\_watch, |
|  |  | ice\_conn); |
|  |  | g\_io\_channel\_unref (channel); |
|  |  | } |
|  |  |  |
|  |  | /\* This is called (by glib via xsmp->ice\_connection\_watch) when a |
|  |  | \* connection is first received on the ICE listening socket. (We |
|  |  | \* expect that the client will then initiate XSMP on the connection; |
|  |  | \* if it does not, GsmXSMPClient will eventually time out and close |
|  |  | \* the connection.) |
|  |  | \* |
|  |  | \* FIXME: it would probably make more sense to not create a |
|  |  | \* GsmXSMPClient object until accept\_xsmp\_connection, below (and to do |
|  |  | \* the timing-out here in xsmp.c). |
|  |  | \* connection is first received on the ICE listening socket. |
|  |  | \*/ |
|  |  | static gboolean |
|  |  | accept\_ice\_connection (GIOChannel \*source, |
|  |  | GIOCondition condition, |
|  |  | GsmIceConnectionData \*data) |
|  |  | { |
|  |  | IceListenObj listener; |
|  |  | IceConn ice\_conn; |
|  |  | IceAcceptStatus status; |
|  |  | GsmClient \*client; |
|  |  | GsmXsmpServer \*server; |
|  |  |  |
|  |  | listener = data->listener; |
|  |  | server = data->server; |
|  |  |  |
|  |  | g\_debug ("GsmXsmpServer: accept\_ice\_connection()"); |
|  |  |  |
|  |  | ice\_conn = IceAcceptConnection (listener, &status); |
|  |  | ice\_conn = IceAcceptConnection (data->listener, &status); |
|  |  | if (status != IceAcceptSuccess) { |
|  |  | g\_debug ("GsmXsmpServer: IceAcceptConnection returned %d", status); |
|  |  | return TRUE; |
|  |  | } |
|  |  |  |
|  |  | client = gsm\_xsmp\_client\_new (ice\_conn); |
|  |  | ice\_conn->context = client; |
|  |  |  |
|  |  | gsm\_store\_add (server->priv->client\_store, gsm\_client\_peek\_id (client), G\_OBJECT (client)); |
|  |  | /\* the store will own the ref \*/ |
|  |  | g\_object\_unref (client); |
|  |  | auth\_ice\_connection (ice\_conn); |
|  |  |  |
|  |  | return TRUE; |
|  |  | } |
| Expand Down  Expand Up | | @@ -224,8 +314,9 @@ accept\_xsmp\_connection (SmsConn sms\_conn, |
|  |  | SmsCallbacks \*callbacks\_ret, |
|  |  | char \*\*failure\_reason\_ret) |
|  |  | { |
|  |  | IceConn ice\_conn; |
|  |  | GsmXSMPClient \*client; |
|  |  | IceConn ice\_conn; |
|  |  | GsmClient \*client; |
|  |  | GsmIceConnectionWatch \*data; |
|  |  |  |
|  |  | /\* FIXME: what about during shutdown but before gsm\_xsmp\_shutdown? \*/ |
|  |  | if (server->priv->xsmp\_sockets == NULL) { |
| Expand All | | @@ -236,11 +327,18 @@ accept\_xsmp\_connection (SmsConn sms\_conn, |
|  |  | } |
|  |  |  |
|  |  | ice\_conn = SmsGetIceConnection (sms\_conn); |
|  |  | client = ice\_conn->context; |
|  |  | data = ice\_conn->context; |
|  |  |  |
|  |  | g\_return\_val\_if\_fail (client != NULL, TRUE); |
|  |  | /\* Each GsmXSMPClient has its own IceConn watcher \*/ |
|  |  | free\_ice\_connection\_watch (data); |
|  |  |  |
|  |  | client = gsm\_xsmp\_client\_new (ice\_conn); |
|  |  |  |
|  |  | gsm\_store\_add (server->priv->client\_store, gsm\_client\_peek\_id (client), G\_OBJECT (client)); |
|  |  | /\* the store will own the ref \*/ |
|  |  | g\_object\_unref (client); |
|  |  |  |
|  |  | gsm\_xsmp\_client\_connect (client, sms\_conn, mask\_ret, callbacks\_ret); |
|  |  | gsm\_xsmp\_client\_connect (GSM\_XSMP\_CLIENT (client), sms\_conn, mask\_ret, callbacks\_ret); |
|  |  |  |
|  |  | return TRUE; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b0dc999`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGNOME%2Fgnome-session%2Fcommit%2Fb0dc999e0b45355314616321dbb6cb71e729fc9d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


