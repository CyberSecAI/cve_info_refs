=== Content from portal.msrc.microsoft.com_43a61d2f_20250126_082014.html ===
You need to enable JavaScript to run this app.

=== Content from posts.specterops.io_ea7bd4b2_20250125_115833.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F71c76c1588f9&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---top_nav_layout_nav----------------------------------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# UMCI Bypass Using PSWorkFlowUtility: CVE-2017–0215

[![Matt Nelson](https://miro.medium.com/v2/resize:fill:88:88/0*6mGXmQSDMYyKuVUK.jpg)](https://medium.com/%40enigma0x3?source=post_page---byline--71c76c1588f9--------------------------------)[![Posts By SpecterOps Team Members](https://miro.medium.com/v2/resize:fill:48:48/1*D-FDlfkqivRBQZoESrwtqw.png)](https://posts.specterops.io/?source=post_page---byline--71c76c1588f9--------------------------------)

[Matt Nelson](https://medium.com/%40enigma0x3?source=post_page---byline--71c76c1588f9--------------------------------)

·

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1bb43103a9a9&operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&user=Matt+Nelson&userId=1bb43103a9a9&source=post_page-1bb43103a9a9--byline--71c76c1588f9---------------------post_header-----------)

Published in[Posts By SpecterOps Team Members](https://posts.specterops.io/?source=post_page---byline--71c76c1588f9--------------------------------)·3 min read·Oct 19, 2017

--

Listen

Share

When looking for User Mode Code Integrity (UMCI) bypasses in the context of [Device Guard](https://docs.microsoft.com/en-us/windows/device-security/device-guard/device-guard-deployment-guide), my typical approach has been to hunt for Microsoft-signed PowerShell scripts/modules that contain some sort of functionality that allows for unsigned code execution. Fortunately, there are plenty that exist on Windows 10 by default. One such bypass was [CVE-2017–0215](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0215), which abused the “PSWorkFlowUtility” PowerShell module to execute arbitrary unsigned PowerShell code.

You might ask, how? Looking at this module, you will notice that it has an embedded Authenticode signature block, which makes it portable (an attacker can bring the old, vulnerable version to their target as the certificate and file hash is included in the file). What else stands out to you?

![]()

Vulnerable PSWorkFlowUtility PowerShell Module

We know that in the context of UMCI, the most locked down scenario is only allowing Microsoft signed code to run. Since this module is signed by Microsoft, it will be permitted to execute in Full Language Mode (as opposed to Constrained Language Mode). This particular module simply takes PowerShell code via a parameter (as a string) and continues to call “Invoke-Expression” on it, which simply executes it.

![]()

UMCI/CLM Bypassed

As you can see, taking the square root of Pi is blocked in Constrained Language Mode as method invocation on most .NET types are not permitted. If we import the PSWorkFlowUtility module and pass that code via the “-Expression” parameter, it will execute in Full Language Mode, giving us the result. To mitigate this, Microsoft fixed the built-in module by removing the authenticode signature and adding “[[System.Security.SecurityCritical()]”](https://msdn.microsoft.com/en-us/library/system.security.securitycriticalattribute%28v%3Dvs.110%29.aspx), which makes the module security transparent and subject to Constrained Language Mode ([CVE-2017–0215](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0215)).

![]()

Fixed PSWorkFlowUtility PowerShell Module

Since the old, vulnerable module file was Authenticode signed (making it portable), it is required to block the old, vulnerable version of this module. This can be done via the file’s hash, but it is essential that all previous, vulnerable versions of the file be accounted for — a responsibility that should honestly lie on Microsoft since they are able to collect the hashes across all Windows builds where the vulnerable module is present.

Another viable mitigation for blocking the old, vulnerable version is to note that the embedded signature is not Windows-signed (i.e. has the Windows System Component Verification EKU — 1.3.6.1.4.1.311.10.3.6). Device Guard CI policies permit limiting a publisher rule by a specific enhanced key usage (EKU). A stricter policy would allow only Windows-signed code to run — a rule that’s present in [Matt Graeber](https://github.com/mattifestation)’s Device Guard [base reference policy](https://gist.github.com/mattifestation/0e17c5ffbe66597f0d78a2861202848c#file-baseenforcementpolicy-xml-L28-L34). If only Windows-signed code is permitted to execute, the vulnerable version of Invoke-AsWorkflow would be limited to execution within constrained language mode, effectively mitigating the previous vulnerability. Now, vulnerable code can and will be Windows-signed but in this case, this vulnerability is effectively mitigated with a stronger Device Guard CI policy.

The old, vulnerable version of the module can be found here: <https://gist.github.com/enigma0x3/dca6f24b2b94e120daae37505d209ecc>

-Matt N.

*Originally published at* [*enigma0x3.net*](https://enigma0x3.net/2017/10/19/umci-bypass-using-psworkflowutility-cve-2017-0215/) *on October 19, 2017.*

[Microsoft](https://medium.com/tag/microsoft?source=post_page-----71c76c1588f9--------------------------------)[Research](https://medium.com/tag/research?source=post_page-----71c76c1588f9--------------------------------)[Device Guard](https://medium.com/tag/device-guard?source=post_page-----71c76c1588f9--------------------------------)[Bypass](https://medium.com/tag/bypass?source=post_page-----71c76c1588f9--------------------------------)[Powershell](https://medium.com/tag/powershell?source=post_page-----71c76c1588f9--------------------------------)

--

--

[![Posts By SpecterOps Team Members](https://miro.medium.com/v2/resize:fill:96:96/1*D-FDlfkqivRBQZoESrwtqw.png)](https://posts.specterops.io/?source=post_page---post_publication_info--71c76c1588f9--------------------------------)[![Posts By SpecterOps Team Members](https://miro.medium.com/v2/resize:fill:128:128/1*D-FDlfkqivRBQZoESrwtqw.png)](https://posts.specterops.io/?source=post_page---post_publication_info--71c76c1588f9--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fspecter-ops-posts&operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&collection=Posts+By+SpecterOps+Team+Members&collectionId=f05f8696e3cc&source=post_page---post_publication_info--71c76c1588f9---------------------follow_profile-----------)[## Published in Posts By SpecterOps Team Members](https://posts.specterops.io/?source=post_page---post_publication_info--71c76c1588f9--------------------------------)[4.93K Followers](/followers?source=post_page---post_publication_info--71c76c1588f9--------------------------------)·[Last published 1 day ago](/insurance-companies-can-reduce-risk-with-attack-path-management-d6afa0ba1f5a?source=post_page---post_publication_info--71c76c1588f9--------------------------------)

Posts from SpecterOps team members on various topics relating information security

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fspecter-ops-posts&operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&collection=Posts+By+SpecterOps+Team+Members&collectionId=f05f8696e3cc&source=post_page---post_publication_info--71c76c1588f9---------------------follow_profile-----------)[![Matt Nelson](https://miro.medium.com/v2/resize:fill:96:96/0*6mGXmQSDMYyKuVUK.jpg)](https://medium.com/%40enigma0x3?source=post_page---post_author_info--71c76c1588f9--------------------------------)[![Matt Nelson](https://miro.medium.com/v2/resize:fill:128:128/0*6mGXmQSDMYyKuVUK.jpg)](https://medium.com/%40enigma0x3?source=post_page---post_author_info--71c76c1588f9--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1bb43103a9a9&operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&user=Matt+Nelson&userId=1bb43103a9a9&source=post_page-1bb43103a9a9--post_author_info--71c76c1588f9---------------------follow_profile-----------)[## Written by Matt Nelson](https://medium.com/%40enigma0x3?source=post_page---post_author_info--71c76c1588f9--------------------------------)[1.5K Followers](https://medium.com/%40enigma0x3/followers?source=post_page---post_author_info--71c76c1588f9--------------------------------)·[56 Following](https://medium.com/%40enigma0x3/following?source=post_page---post_author_info--71c76c1588f9--------------------------------)

Red Teamer | Security Researcher | Enjoys abusing features | Tweets are my own | <http://github.com/enigma0x3>

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1bb43103a9a9&operation=register&redirect=https%3A%2F%2Fposts.specterops.io%2Fumci-bypass-using-psworkflowutility-cve-2017-0215-71c76c1588f9&user=Matt+Nelson&userId=1bb43103a9a9&source=post_page-1bb43103a9a9--post_author_info--71c76c1588f9---------------------follow_profile-----------)
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----71c76c1588f9--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----71c76c1588f9--------------------------------)[About](https://medium.com/about?autoplay=1&source=post_page-----71c76c1588f9--------------------------------)[Careers](https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----71c76c1588f9--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----71c76c1588f9--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----71c76c1588f9--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----71c76c1588f9--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----71c76c1588f9--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----71c76c1588f9--------------------------------)[Teams](https://medium.com/business?source=post_page-----71c76c1588f9--------------------------------)


