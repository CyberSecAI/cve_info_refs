=== Content from blog.0patch.com_29125441_20250126_031659.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, May 15, 2017

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[May 15, 2017](https://blog.0patch.com/2017/05/0patching-worst-windows-remote-code.html "permanent link")

### [0patching the "Worst Windows Remote Code Execution Bug in Recent Memory" CVE-2017-0290](https://blog.0patch.com/2017/05/0patching-worst-windows-remote-code.html)

**Building up our Skills and Speed for the Future WannaCry Attacks**

By Mitja Kolsek, 0patch Team

Like many other stories of the past week, mine begins with this tweet.

> I think [@natashenka](https://twitter.com/natashenka) and I just discovered the worst Windows remote code exec in recent memory. This is crazy bad. Report on the way. ðŸ”¥ðŸ”¥ðŸ”¥
> â€” Tavis Ormandy (@taviso) [May 6, 2017](https://twitter.com/taviso/status/860679110728622080)

[Natalie Silvanovich](https://twitter.com/natashenka) and [Tavis Ormandy](https://twitter.com/taviso) of Google Project Zero found a [pretty nasty bug in Microsoft Malware Protection Engine](https://bugs.chromium.org/p/project-zero/issues/detail?id=1252&desc=5), allowing an attacker to execute arbitrary code as LocalSystem
on any Windows computer running any Microsoft anti-malware product such
as Security Essentials or Windows Defender by simply having that
computer access a malicious file. Attack vectors were abundant, from
emailing the file or sending it via any other channel like Skype or
Messenger, to having it hosted on a malicious web site or uploading it
to an IIS web server.

Unlike many other stories of the past
week, mine is not about how Natalie and Tavis found this bug, how they
reported it to Microsoft or how the fact that they found and reported it
was made known to the public. Rather, it is about the bug itself, its
root cause, and - of course - about writing a micropatch for it.

But
first: why would we want to write a micropatch for a vulnerability that
would quickly get automatically fixed on all Windows computers anyway?
As you may know, Microsoft was super fast in fixing this bug and made an
[update](https://technet.microsoft.com/en-us/library/security/4022344.aspx) available literally over the weekend. Furthermore, the Malware Protection Engine is implemented as a dynamic-load library mpengine.dll,
and Microsoft designed their anti-malware products smartly enough to not
require a computer restart - the old DLL is simply unloaded, and the new
one loaded.

So why write a micropatch? Well, [not every computer gets updated automatically](http://www.thewindowsclub.com/update-windows-defender-automatic-windows-updates-disabled):
while automatic application of updates is configured by default, admins
can change that if they want to control what gets applied when. And
enterprise admins like to have such control, allowing them to test new
code before deploying it to computers throughout their organization.
Just imagine the updated mpengine.dll having a flaw that prevented users from accessing legitimate files.

Another
reason for writing this micropatch was to learn, as we haven't patched a
security product before - and one can expect to stumble upon something
new here (and stumble I did, as you will see). The final reason was to
teach, to share some knowledge with those of you who want to analyze
vulnerabilities yourselves and learn how to write micropatches.

**Reproducing CVE-2017-0290**

The first step in analyzing a vulnerability is to reproduce its exploitation. The Project Zero report provides a downloadable [proof-of-concept file](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=283405), which has a .zip
extension, but is really an HTML-lookalike file that comprises a tiny
exploit bit and a lot of random HTML content that makes sure the engine
processes the file.

Reproducing on 64-bit Windows 8.1
was trivial - just downloading and saving the file was enough to make
the Windows Defender service crash, instantly turning from this:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNjSMMKPSK2grwW4SpDSCuEoqx3olIh3Gjbt8rIuT3oSyKbRq7FPftZrxpmvsMGJLmQ8gSsguAJkt1x_1pktqwExThfB7ynpHtqQWTxh4qOVNYSIq4Fnuf57hpJlUKHkOfH6KfW_93ecaA/s400/Windows_defender_working.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNjSMMKPSK2grwW4SpDSCuEoqx3olIh3Gjbt8rIuT3oSyKbRq7FPftZrxpmvsMGJLmQ8gSsguAJkt1x_1pktqwExThfB7ynpHtqQWTxh4qOVNYSIq4Fnuf57hpJlUKHkOfH6KfW_93ecaA/s1600/Windows_defender_working.png)

Â to this:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoiCKSDuvDnQC1h2Wi3d_kkKraLoD5M6KPo4hwGa_de2Cg-Cgx8crHcLHsrewc6_XGNiNDuVPgsWfdWW2gFQ-_4bA6z9geQ6Rontb4qsBIiYb-uPCinr9CuxTthIyozXUBtFanOrkM68nb/s400/Windows_defender_not_working.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoiCKSDuvDnQC1h2Wi3d_kkKraLoD5M6KPo4hwGa_de2Cg-Cgx8crHcLHsrewc6_XGNiNDuVPgsWfdWW2gFQ-_4bA6z9geQ6Rontb4qsBIiYb-uPCinr9CuxTthIyozXUBtFanOrkM68nb/s1600/Windows_defender_not_working.png)

After the crash, the Application Event Log contained an Error event about this crash, revealing the crashing module being mpengine.dll, and the crash location being at offset 0x21745a. (You will find a different crash address in Google's report because they were working on a 32-bit computer.)

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj_19ukjF0e3RIc36apRJ6F4CEWNszD0cQ-mAy_KlS5Q7OFrLrSZ1kV0RtCbQV9HP2wpKH1fedX4Z_fhlK-ZPYOKOgfpyYZaMfdY7dVahg0KOdw0yJtKLhor09ZCAZRPKFJov77q8EGJ5G0/s400/crash_event_log.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj_19ukjF0e3RIc36apRJ6F4CEWNszD0cQ-mAy_KlS5Q7OFrLrSZ1kV0RtCbQV9HP2wpKH1fedX4Z_fhlK-ZPYOKOgfpyYZaMfdY7dVahg0KOdw0yJtKLhor09ZCAZRPKFJov77q8EGJ5G0/s1600/crash_event_log.PNG)

Note that I was using mpengine.dll
version 1.1.13701.0, which is the last vulnerable version before the
fixed 1.1.13704.0. It is always good to do your analysis on the last
vulnerable version in order to minimize the difference with the fixed
version - you will thank yourself when diffing these versions.

**Analyzing CVE-2017-0290**

With
the bug successfully reproduced, the path was clear towards analysis.
Here, the Google report was a great start, as Natalie and Tavis have
clearly gained substantial understanding of what goes on in the crash
case. The most important detail for me was that it was a type confusion
error, specifically with some function expecting a *string* object but getting a *number* object (which resulted in calling a string vtable function where there really was no vtable).

This
was important because when a bug is a type confusion error, a typical
fix is to add the missing check for the correct type. And such a fix is
usually easy to recognize when observing the difference between
vulnerable and fixed code.

Which brings us to IDA. The image below shows the function that crashed - the exact access violation location was the mov rax, [rcx] instruction (see the red box) at address 0x75A31745A, which is at offsetÂ  0x21745a from mpengine.dll's default base address.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwg3EtS-e9OgNpDNRBqLfJ4BOWHxSZi2g72agf5-5acJD-n2aId6r44YdAx0VlfVheynceYGXgZyYOXcLOdecY4ZEsNE_D3Nd7XLgoCtkN4QZ57jUopgwxTwQ2tkKdb5Aae6QpNipmv_p1/s640/Crash_function_0.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwg3EtS-e9OgNpDNRBqLfJ4BOWHxSZi2g72agf5-5acJD-n2aId6r44YdAx0VlfVheynceYGXgZyYOXcLOdecY4ZEsNE_D3Nd7XLgoCtkN4QZ57jUopgwxTwQ2tkKdb5Aae6QpNipmv_p1/s1600/Crash_function_0.PNG)

When
a vendor patch is available, diffing the vulnerable and the patched
version usually provides useful information and allows you to understand
the bug, and the patch, better. Diffing can be a time-consuming
operation though first for the computer and then for you, and with large
binaries (mpengine.dll is 12MB) you can get *a lot* of matched functions, and finding where the *code logic* is different - as opposed to where the code is different - can be somewhat frustrating.

So I went on to diff the two versions of mpengine.dll, the vulnerable 1.1.13701.0 and the patched 1.1.13704.0. There were 38440 matched functions, which, in scientific terms, is *an awful lot*.
What I could do with these results was compare the above crashing
function between the two versions. If I was lucky, the patch would be
there and I could go home early.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhX05UdKWzgjnFL_rNzKHxGeKjGxksWfk6EYjw2U5vgzsLjC200EUVUrByWkJXwe4bVLtEu6Ka-b5fYW-U5hMNcpvE1A8B_Z9sbkXzkQVMjLy34ZP9FWzhJDKikjbAVago34lrG57Ta-fsT/s640/Diff2.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhX05UdKWzgjnFL_rNzKHxGeKjGxksWfk6EYjw2U5vgzsLjC200EUVUrByWkJXwe4bVLtEu6Ka-b5fYW-U5hMNcpvE1A8B_Z9sbkXzkQVMjLy34ZP9FWzhJDKikjbAVago34lrG57Ta-fsT/s1600/Diff2.PNG)

Nope.
Both functions are logically identical, which means that the flaw (and
the patch) is somewhere higher on the call stack. At this point one could diff all
functions that call this function, but there are about 50 of them - and if all of those turned out to be
identical as well, such approach could turn into an exponential mission impossible.
(Not to mention that IDA may not see all callers.)

Now
about the call stack: you will notice that I haven't used a debugger up
to this point, and the reason is that Windows Defender is a [protected service](https://msdn.microsoft.com/en-us/library/windows/desktop/dn313124%28v%3Dvs.85%29.aspx)
and as such tries very hard to protect itself from tampering. You
cannot attach a debugger to a protected process, even if you're a local
administrator. And it's not easy to un-protect a protected service
either: while its protected status is defined by the LaunchProtected registry value (in our case under HKLM\SYSTEM\CurrentControlSet\Services\WinDefend), you cannot change that value for Windows Defender while Windows Defender is running as it prevents you from "attacking" it.

Fortunately,
we have a way to stop Windows Defender - by crashing it with the PoC.
So what I did was crash Windows Defender, rename its LaunchProtected registry value, restarted the computer (the protected status of services is read only at system startup), then configured [Windows Error Reporting](https://msdn.microsoft.com/en-us/library/windows/desktop/bb787181%28v%3Dvs.85%29.aspx) to generate dump files for crashing processes. (I only created the LocalDumps key and the DumpFolder value containing "C:\dumps" in it.)

After crashing Windows Defender again, I got its mini dump file in C:\dumps, and it contained a full call stack for the access violation. I was only interested in locations from mpengine.dll:

mpengine!FreeSigFiles+0x11ea9a
mpengine!FreeSigFiles+0x12046f
mpengine!FreeSigFiles+0x111e81
mpengine!FreeSigFiles+0x111d9e
mpengine!FreeSigFiles+0x125eaa
mpengine!FreeSigFiles+0x3de1d
mpengine!FreeSigFiles+0x3dbf5
mpengine!FreeSigFiles+0x125eaa
mpengine!FreeSigFiles+0x117ade
mpengine!FreeSigFiles+0x120146
mpengine!FreeSigFiles+0x113d76
mpengine!FreeSigFiles+0xcce7f
mpengine+0x54a99
mpengine+0x865e1
mpengine+0x50f3f
mpengine+0x50d1f
mpengine+0x8c208
mpengine+0x8bf47
mpengine!FreeSigFiles+0x174a3
mpengine+0x13b7d
mpengine!FreeSigFiles+0x1535a
mpengine!\_rsignal+0x243
mpengine!\_rsignal+0xe7

The
top one we already know - it's the access violation location in the
crashing function that we diffed just moments ago. So I proceeded with
the second address, FreeSigFiles+0x12046f,
and located it in IDA. It was, as expected, after a call to the
crashing function. I then took the address of the function containing
that address, and viewed the diff with its patched version.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFh5DXf63pqwu6I92jATIty46__zsqTiG73st6IQHkVmf6fT0Vb_Z-CrUnlgVptBmCsIzU0ki7630gc-D4UBMFhLY9aScxa3brF_aVgb7ipjZ8f-SrtR1uOJaNVobvZkL2Q-383V5mDMLG/s640/Diff1.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFh5DXf63pqwu6I92jATIty46__zsqTiG73st6IQHkVmf6fT0Vb_Z-CrUnlgVptBmCsIzU0ki7630gc-D4UBMFhLY9aScxa3brF_aVgb7ipjZ8f-SrtR1uOJaNVobvZkL2Q-383V5mDMLG/s1600/Diff1.PNG)

Now
we're talking! This looks like a typical added check that exits a
function if something is not right. (The patched version is on the
left.) The upper red block is added code that takes rdi
(the object) and passes it to a call to some function, and if the
result of that function is 4, the execution continues as before,
otherwise the return value (al)
is set to 0 in the lower red block, and the function exits. The
function that gets called from the upper red block seems to determine
the type of the object and returns its *type code*. Reviewing other calls to this function I found a very obvious implementation of JavaScript's typeof operator, which confirmed that *type code* for string is actually 4.

This
is clearly the patch I was looking for. It was simple, it did exactly
what I was expecting it to do, and it was in the code path of our crash.

**Micropatching CVE-2017-0290**

My goal at this point was to create a micropatch that would inject the same patch logic into the vulnerable version of mpengine.dll.
In a perfect world, I could use literally the same code that I found in
the patched version, and inject it in the same place - but in this
world a compiler likes to use different registers and different
implementation of the same logic in two subsequent builds. So I had to
re-implement the patch logic from the original patch.

Let's look at the vulnerable function in IDA.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiJFNIx0SVFMrdJdnxvDTOKCAQH8PS-4DgaIGfn3evpnQphWRn1ZM5ZWBDJLS6-u3I4RDG8ty4BC5a57J2KhS0xrnbQplkLZoMQK881RXFr2rT2H_7t7Zyv9k7Lejuje5tVkhu4oswcoHk7/s640/vulnerable_function.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiJFNIx0SVFMrdJdnxvDTOKCAQH8PS-4DgaIGfn3evpnQphWRn1ZM5ZWBDJLS6-u3I4RDG8ty4BC5a57J2KhS0xrnbQplkLZoMQK881RXFr2rT2H_7t7Zyv9k7Lejuje5tVkhu4oswcoHk7/s1600/vulnerable_function.PNG)

The
above image shows the vulnerable function and a good location for
injecting our code. The location is selected so that it allows us to
jump from our patchlet code directly to the function epilogue (the
lowest block of code).

Here is the patch code for 64-bit mpengine.dll version 1.1.13701.0:

;0patch for CVE-2017-0290 in 64-bit mpengine.dll version 1.1.13701.0

MODULE\_PATH "C:\Analysis\CVE-2017-0290\mpengine.dll\_64bit\_1.1.13701.0\mpengine.dll"
PATCH\_ID 271
PATCH\_FORMAT\_VER 2
VULN\_ID 2436
PLATFORM win64

patchlet\_start
Â PATCHLET\_ID 1
Â PATCHLET\_TYPE 2
Â PATCHLET\_OFFSET 0x218E10

Â ; We'll need the GetTypeOf function and the location of function epilogue
Â PIT mpengine.dll!0x218940,mpengine.dll!0x218E9A

Â ; Note that GetTypeOf taints the following registers:
Â ; rdx - always
Â ; rcx - only in case of an exception
Â ; rax - expected, this is the return value

Â code\_start

Â  push rcxÂ Â Â Â Â Â Â Â Â  ; We need to preserve rcx, as it's still used after our patchlet code
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; while GetTypeOf taints rdx, we don't need to preserve it
Â  mov rcx, r9Â Â Â Â Â Â  ; r9 points to the object
Â  call PIT\_0x218940 ; GetTypeOf object
Â  pop rcxÂ Â Â Â Â Â Â Â Â Â  ; restore rcx
Â  cmp eax, 4Â Â Â Â Â Â Â  ; is the object of type string?
Â  jz OKÂ Â Â Â Â Â Â Â Â Â Â Â  ; It is? Very well, continue...

Â  xor al, alÂ Â Â Â Â Â Â  ; It isn't? Exit this function without doing anything, return 0
Â  call PIT\_ExploitBlocked ; Show "Exploit attempt blocked"
Â  jmp PIT\_0x218E9AÂ  ; Jump to function epilogue

Â  OK:

Â code\_end
patchlet\_end

What this single-patchlet patch, inserted at the shown point in code, does is - just as the original patch - call GetTypeOf on the object (whose address is in register r9)
and see if its type code is 4 (string). If it is, it continues
execution of original code where it was injected . Otherwise, it sets
the return code (register al) to 0 and jumps to function epilogue.

Note that in order to avoid any negative side effects, I had to (1) review the GetTypeOf function to see which registers it may taint and whether that could impact the code after our injected patch (it taints rdx and rcx, but rdx holds nothing valuable at our injection point), and then (2) store rcx on the stack before calling GetTypeOf function because rcx holds some value that is still being used after our injected patch.

I also wrote the same patch for the last vulnerable 32-bit version of mpengine.dll. If you have 0patch Agent installed, patches
ZP-271 and ZP-272 should
already be downloaded to your computer, waiting for any occurrence of the vulnerable mpengine.dll getting loaded.

**The Irony of Protected Services**

To
restore the original system configuration, I turned Windows Defender
back to a protected service, and... shoot, the patch stopped getting
applied. It quickly became clear that we can't inject our loader into
the protected Windows Defender because only binaries signed by Microsoft
are allowed to get loaded. (It's a bit [more complex than that](https://msdn.microsoft.com/en-us/library/windows/desktop/dn313124%28v%3Dvs.85%29.aspx)
but close enough.) This is Windows Defender protecting itself against
local malware - even with admin privileges - trying to compromise it.

The
irony is that a Windows anti-malware protection prevents our security
product from fixing a vulnerability in Windows Defender, while the
exploit for the same vulnerability can freely execute arbitrary code in
Windows Defender. (Hmm, perhaps we should leverage this exploit to get
our code running inside Windows Defender and thereby fix it.)

So
while we're exploring options for extending our reach towards patching
protected services, patches ZP-271 and ZP-272 for Malware Protection
Engine will only get applied on Windows 7 and Windows Vista, which don't
have protected services.

**Experimenting with Micropatches for CVE-2017-0290**

If you want to experiment with these micropatches, you'll need two things:

1. A
   32-bit or 64-bit Windows 7 computer running Windows Defender. While you
   could also do the testing on newer Windows versions, you would have to
   un-protect the Windows Defender service in order to proceed.
2. Vulnerable mpengine.dll. If your Windows Defender doesn't happen to have this exact version (unlikely, due to automatic updates), you can get it here:

1. [32-bit mpengine.dll version 1.1.13701.0](https://0patch.com/poc/CVE-2017-0290/mpengine.dll_1.1.13701.0-32b/mpengine.dll) for 32-bit Windows
2. [64-bit mpengine.dll version 1.1.13701.0](https://0patch.com/poc/CVE-2017-0290/mpengine.dll_1.1.13701.0-64b/mpengine.dll) for 64-bit Windows

First of all, stop the Windows Defender service via elevated Services console.

Then browse to C:\ProgramData\Microsoft\Windows Defender
(folder permissions don't originally allow you to open it so Windows
will ask you for elevation, after which it will add your account to the
folder ACL). Open folder Definition Updates,
and notice one or more subfolders with GUID-like names starting with
curly braces. Open each of these folders to find the one containing mpengine.dll. Rename the existing mpengine.dll into something else, then save the vulnerable mpengine.dll there.

Start the Windows Defender service.

Download the [proof-of-concept file](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=283405) and store it in some empty temporary folder.

Launch
the Windows Defender console via the Control Panel, and Custom-Scan the
above folder. Notice that Windows Defender service crashes.

Now install 0patch Agent on the computer. If you don't already have it, [download a free copy](https://dist.0patch.com/download/latestagent) and register it with your [free 0patch account](https://dist.0patch.com/User/Register).

Finally,
restart the Windows Defender service and re-scan the temporary folder.
This time, you'll see an "Exploit Attempt Blocked" popup instead of
Windows Defender crashing.

If you want to build our patches yourself, you can [download their source code](https://0patch.com/poc/CVE-2017-0290/ZP-271-272.zip) and build them using [0patch Agent for Developers](https://dist.0patch.com/download/latestagentdev).

While this
vulnerability has already been automatically fixed on most computers, it
turned out to be an interesting learning experience to micropatch it. I
hope this post will help future micropatchers jump-start their
research.

While I was writing this post, the world got pierced by the [WannaCry](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack) ransomware worm exploiting a known vulnerability that had an official patch available for Windows operating systems which Microsoft supported at the time. Many hospitals and other critical infrastructure components were taken offline, partly also because they were stuck with unsupported OSs such as Windows XP. They have very rational and complex reasons for being on such outdated systems in 2017, and undoubtedly they will have similar reasons next year and the year after. One of our goals with 0patch is to provide protection for such end-of-support systems while users scramble to update them (and have the same problem almost immediately afterwards). Defending against modern attackers will require rapid response, and this exercise with CVE-2017-0290 - although likely of low value to users - was an example of building up skills and speed. The world will need a lot of 3rd-party patch developers though, so all existing and prospective security researchers are warmly welcome to join us.

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[2 comments:](https://blog.0patch.com/2017/05/0patching-worst-windows-remote-code.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=8373402676750627869&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=8373402676750627869&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=8373402676750627869&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=8373402676750627869&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=8373402676750627869&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=8373402676750627869&target=pinterest "Share to Pinterest")

[Newer Posts](https://blog.0patch.com/search?updated-max=2017-11-03T11:28:00-07:00&max-results=7&reverse-paginate=true "Newer Posts")

[Older Posts](https://blog.0patch.com/search?updated-max=2017-05-15T05:02:00-07:00&max-results=7 "Older Posts")

[Home](https://blog.0patch.com/)

Subscribe to:
[Posts (Atom)](https://blog.0patch.com/feeds/posts/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + â–¼
    [May](https://blog.0patch.com/2017/05/)
    (1)
    - [0patching the "Worst Windows Remote Code Execution...](https://blog.0patch.com/2017/05/0patching-worst-windows-remote-code.html)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from blog.0patch.com_36f2fdae_20250126_031700.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, July 10, 2017

Posted by

[Luka Treiber](https://www.blogger.com/profile/14692357778161412891 "author profile")

on

[July 10, 2017](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html "permanent link")

### 0patching the Quick Brown Fox of CVE-2017-0283

By Luka Treiber, 0patch Team.

Among many other things, last Patch Tuesday brought a fix for an RCE vulnerability named "Windows Uniscribe font processing heap-based memory corruption in USP10!MergeLigRecords".Â  A couple of days later [Mateusz Jurczyk](https://twitter.com/j00ru) of Google Project Zero published a [report](https://bugs.chromium.org/p/project-zero/issues/detail?id=1198&can=1&q=uniscribe&sort=-id) with [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873) attached. Out of the eight vulnerabilities reported at the same time
in that Windows library I chose to patch this one for being
the most severe.

**Reproduction**

Opening font files from the PoC.zip package in Windows Font Viewer displayed the "quick brown fox text" in weird constellations but without a crash. With no exact PoC instructions given this was the procedure that worked for me on Windows 7 x64:

1. unpack the [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873)
2. install signal\_sigsegv\_313372b5\_210\_42111ccffd2e10aba8b5e6ba45289ef3.ttf (or any other TTF from the package) on the system
3. run Notepad
4. select Format->Font...>[Font] 4000 Tall and [Script] Arabic

immediately a crash occurs at

(1410.378): Unknown exception - code c000041d (!!! second chance !!!)

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`025230e8=??

The callstack: it matches the one from report

msvcrt!memcpy+0x1c0

USP10!MergeLigRecords+0x7f

USP10!LoadTTOArabicShapeTables+0x5f8

USP10!LoadArabicShapeTables+0x148

USP10!ArabicLoadTbl+0xf0

USP10!UpdateCache+0xf5

**Analysis of the PoC**

It is usually worth to take a look at PoC and try to understand its payload first before diving into debugging, and thus save a lot of time by knowing what data patterns to look for in the application's memory. So I searched the Internet for the original TTF file the PoC was derived from. I quickly found one and started diffing the two files in order to locate malformed font attributes. Comparison showed a common structure of the files. However, it became clear that an automatic fuzzer was used and too many attributes were polluted with suspicious values to sift through by hand. That task was definitely not a time-saver so I had to give it up.

**Analysis of the official patch**

Extracting and analyzing the official patch is the next reasonable
thing to do after a Patch Tuesday. So let's see how this goes.

TheÂ vulnerable version 1.626.7601.23688 of usp10.dll got replaced by the patched 1.626.7601.23807. The files are both of approximately the same size (788KB) and when compared using BinDiff a match of 733 functions is found. Among those are also the ones from the crash call stack above. It makes sense to check differences in those functions first as the patch is often a sanity check on input data inserted before a vulnerable call. The first one - USP10!MergeLigRecords from the immediate crash context - is identical but the next one - USP10!LoadTTOArabicShapeTables - shows some interesting changes in the function graph. Left is the old (vulnerable) and right is the new (patched) version of usp10.dll

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s640/loop.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s1600/loop.PNG)

We can see that the vulnerable call MergeLigRecords is enclosed in a loop.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s640/ttoGetTableInfo_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s1600/ttoGetTableInfo_new.PNG)[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s640/cmp.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s1600/cmp.PNG)
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s640/MergeLigRecords_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s1600/MergeLigRecords_new.PNG)

Within that loop the only significant change in the patched version is the gray cmp-jnz block that has been added to the patched DLL version. Could this be *the* patch? With limited analysis done so far it is hard to say what the data in comparison (rsp+var\_9C) means, but it is clear that by introduction of that block the criteria to reach the problematic call is more refined than in the old version. This is also a behavior I would expect of a patch.

The only way to make sure is to debug. So we start WinDbg and attach it to notepad.exe on a vulnerable system. We set three breakpoints. One at the vulnerable MergeLigRecords, one before the call to ttoGetTableInfo, and one after. The ttoGetTableInfo call is interesting because it takes two struct parameters - TTOOutput and TTOInput. The gray if block that follows right after, checks if one of the TTOOutput attributes (rsp+var\_9C) is 4 and in case of a mismatch exits the loop. So what we're interested in is where/if rsp+var\_9C changes inside ttoGetTableInfo and how it is related to the crash inside MergeLigRecords. Before we hit [F5] in WinDbg and click-through the PoC we also need to locate a match for the rsp+var\_9C attribute from the patched version in the vulnerable code.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s640/attrib_match.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s1600/attrib_match.PNG)

We see that, conveniently, a reference to the same attribute can be found in the old LoadTTOArabicShapeTables named as rsp+var\_A4 (it resolves to @rsp+34 in the snippets below).

Now we can observe our checkpoints in WinDbg

0:002> bu0 @!"usp10"+1e32f "dw @rsp+34 L1";

0:002> bu1 @!"usp10"+1e334 "dw @rsp+34 L1";

0:002> bu2 @!"usp10"+1e3f3;

0:002> g

In the first two passes, the value of var\_A4 is 0004 and does not change. Also the USP10!MergeLigRecords call executes without a crash.

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

In the third pass, var\_A4 gets changed by the ttoGetTableInfo call from 0004 to 0001 and MergeLigRecords crashes the app.

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0001**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> p

(14a8.189c): Access violation - code c0000005 (first chance)

First chance exceptions are reported before any exception handling.

This exception may be expected and handled.

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`03bf5018=??

At this point we can conclude that the gray cmp-jnz block would've prevented the crash so we found a patch candidate and can make a 0patch of it.

**Patching**

So far we've assembled all required pieces to build one - it's all in the gray block in above diff. And below is the resulting .0pp file I made.

MODULE\_PATH "C:\Windows\System32\usp10.dll"

PATCH\_ID 273

PATCH\_FORMAT\_VER 2

VULN\_ID 2536

PLATFORM win64

patchlet\_start

PATCHLET\_ID 1

PATCHLET\_TYPE 2

PATCHLET\_OFFSET 0x0001e32f

PIT USP10!0x2e0f0Â Â Â Â Â  ; import USP10!ttoGetTableInfo

JUMPOVERBYTES 5

N\_ORIGINALBYTES 1

Â code\_start

Â  call PIT\_0x2e0f0Â Â Â Â  ; call USP10!ttoGetTableInfo

Â  cmp word[rsp+34h], 4 ; var\_A4

Â  je skipÂ Â Â  Â Â Â  Â Â Â  Â  ; inverse condition from original patch

Â  or eax, 01hÂ Â Â  Â Â Â  Â  ; set piggyback condition

Â  skip:

Â code\_end

patchlet\_end

When turning the official patch into a 0patch I used a "jump condition piggy-backing" technique already described in a [previous post](https://blog.0patch.com/2017/02/0patching-0-day-windows-gdi32dll-memory.html) (only this time It is the *quick brown fox* I'm piggy-backing). Conveniently the official patch is right next to a jump (jnz) that exits the problematic loop so this is also the location for our 0patch. I placed it before the original jnz. Due to lack of space (jnz is only 2 bytes long while we always need 5 to jump to our patch code) I had to place it before the ttoGetTableInfo call that 0patch Agent will substitute with the 5 byte jump. The first instruction in the patch is therefore the substituted original call to ttoGetTableInfo. What follows it is the check from the official patch. First var\_A4 is compared to 4 to check if the loop can continue, otherwise eax that holds the result of ttoGetTableInfo, is set to 1 so the test eax,eax instruction from original code that follows the patch will set a jump flag (zf=0) for the jnz that will exit the loop.

After compiling this .0pp file with 0patch Builder, the patch gets applied and the PoC crashes no more. Our team tested it also against the other TTF files from the PoC.zip package and all of them seem to be disarmed. It is worth noting, however, that this patch only covers the execution route discovered in the Reproduction section above. In the diff of LoadTTOArabicShapeTablesthere there is one more cmp-jnz gray block added to the patched usp10.dll that exits a similar loop to the one covered above. But since there is no public PoC available that would trigger that branch of execution we won't include it in a 0patch. The only safe way for 0patch to work is to cover testable execution paths.

Now, if you haven't so far, install [0patch Agent](https://dist.0patch.com/download/latestagent)Â  and check the PoC to test it for yourself. Next time you see a quick brown fox jumping, make sure that you have 0patch Agent enabled.

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=6686648322237739999&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html "Newer Post")

[Older Post](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/6686648322237739999/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + â–¼
    [July](https://blog.0patch.com/2017/07/)
    (1)
    - [0patching the Quick Brown Fox of CVE-2017-0283](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html)
  + â–º
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from bugs.chromium.org_6b5f3bd3_20250124_201248.html ===



=== Content from 0patch.blogspot.com_c57197a1_20250124_201248.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, July 10, 2017

Posted by

[Luka Treiber](https://www.blogger.com/profile/14692357778161412891 "author profile")

on

[July 10, 2017](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html "permanent link")

### 0patching the Quick Brown Fox of CVE-2017-0283

By Luka Treiber, 0patch Team.

Among many other things, last Patch Tuesday brought a fix for an RCE vulnerability named "Windows Uniscribe font processing heap-based memory corruption in USP10!MergeLigRecords".Â  A couple of days later [Mateusz Jurczyk](https://twitter.com/j00ru) of Google Project Zero published a [report](https://bugs.chromium.org/p/project-zero/issues/detail?id=1198&can=1&q=uniscribe&sort=-id) with [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873) attached. Out of the eight vulnerabilities reported at the same time
in that Windows library I chose to patch this one for being
the most severe.

**Reproduction**

Opening font files from the PoC.zip package in Windows Font Viewer displayed the "quick brown fox text" in weird constellations but without a crash. With no exact PoC instructions given this was the procedure that worked for me on Windows 7 x64:

1. unpack the [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873)
2. install signal\_sigsegv\_313372b5\_210\_42111ccffd2e10aba8b5e6ba45289ef3.ttf (or any other TTF from the package) on the system
3. run Notepad
4. select Format->Font...>[Font] 4000 Tall and [Script] Arabic

immediately a crash occurs at

(1410.378): Unknown exception - code c000041d (!!! second chance !!!)

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`025230e8=??

The callstack: it matches the one from report

msvcrt!memcpy+0x1c0

USP10!MergeLigRecords+0x7f

USP10!LoadTTOArabicShapeTables+0x5f8

USP10!LoadArabicShapeTables+0x148

USP10!ArabicLoadTbl+0xf0

USP10!UpdateCache+0xf5

**Analysis of the PoC**

It is usually worth to take a look at PoC and try to understand its payload first before diving into debugging, and thus save a lot of time by knowing what data patterns to look for in the application's memory. So I searched the Internet for the original TTF file the PoC was derived from. I quickly found one and started diffing the two files in order to locate malformed font attributes. Comparison showed a common structure of the files. However, it became clear that an automatic fuzzer was used and too many attributes were polluted with suspicious values to sift through by hand. That task was definitely not a time-saver so I had to give it up.

**Analysis of the official patch**

Extracting and analyzing the official patch is the next reasonable
thing to do after a Patch Tuesday. So let's see how this goes.

TheÂ vulnerable version 1.626.7601.23688 of usp10.dll got replaced by the patched 1.626.7601.23807. The files are both of approximately the same size (788KB) and when compared using BinDiff a match of 733 functions is found. Among those are also the ones from the crash call stack above. It makes sense to check differences in those functions first as the patch is often a sanity check on input data inserted before a vulnerable call. The first one - USP10!MergeLigRecords from the immediate crash context - is identical but the next one - USP10!LoadTTOArabicShapeTables - shows some interesting changes in the function graph. Left is the old (vulnerable) and right is the new (patched) version of usp10.dll

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s640/loop.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s1600/loop.PNG)

We can see that the vulnerable call MergeLigRecords is enclosed in a loop.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s640/ttoGetTableInfo_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s1600/ttoGetTableInfo_new.PNG)[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s640/cmp.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s1600/cmp.PNG)
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s640/MergeLigRecords_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s1600/MergeLigRecords_new.PNG)

Within that loop the only significant change in the patched version is the gray cmp-jnz block that has been added to the patched DLL version. Could this be *the* patch? With limited analysis done so far it is hard to say what the data in comparison (rsp+var\_9C) means, but it is clear that by introduction of that block the criteria to reach the problematic call is more refined than in the old version. This is also a behavior I would expect of a patch.

The only way to make sure is to debug. So we start WinDbg and attach it to notepad.exe on a vulnerable system. We set three breakpoints. One at the vulnerable MergeLigRecords, one before the call to ttoGetTableInfo, and one after. The ttoGetTableInfo call is interesting because it takes two struct parameters - TTOOutput and TTOInput. The gray if block that follows right after, checks if one of the TTOOutput attributes (rsp+var\_9C) is 4 and in case of a mismatch exits the loop. So what we're interested in is where/if rsp+var\_9C changes inside ttoGetTableInfo and how it is related to the crash inside MergeLigRecords. Before we hit [F5] in WinDbg and click-through the PoC we also need to locate a match for the rsp+var\_9C attribute from the patched version in the vulnerable code.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s640/attrib_match.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s1600/attrib_match.PNG)

We see that, conveniently, a reference to the same attribute can be found in the old LoadTTOArabicShapeTables named as rsp+var\_A4 (it resolves to @rsp+34 in the snippets below).

Now we can observe our checkpoints in WinDbg

0:002> bu0 @!"usp10"+1e32f "dw @rsp+34 L1";

0:002> bu1 @!"usp10"+1e334 "dw @rsp+34 L1";

0:002> bu2 @!"usp10"+1e3f3;

0:002> g

In the first two passes, the value of var\_A4 is 0004 and does not change. Also the USP10!MergeLigRecords call executes without a crash.

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

In the third pass, var\_A4 gets changed by the ttoGetTableInfo call from 0004 to 0001 and MergeLigRecords crashes the app.

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0001**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> p

(14a8.189c): Access violation - code c0000005 (first chance)

First chance exceptions are reported before any exception handling.

This exception may be expected and handled.

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`03bf5018=??

At this point we can conclude that the gray cmp-jnz block would've prevented the crash so we found a patch candidate and can make a 0patch of it.

**Patching**

So far we've assembled all required pieces to build one - it's all in the gray block in above diff. And below is the resulting .0pp file I made.

MODULE\_PATH "C:\Windows\System32\usp10.dll"

PATCH\_ID 273

PATCH\_FORMAT\_VER 2

VULN\_ID 2536

PLATFORM win64

patchlet\_start

PATCHLET\_ID 1

PATCHLET\_TYPE 2

PATCHLET\_OFFSET 0x0001e32f

PIT USP10!0x2e0f0Â Â Â Â Â  ; import USP10!ttoGetTableInfo

JUMPOVERBYTES 5

N\_ORIGINALBYTES 1

Â code\_start

Â  call PIT\_0x2e0f0Â Â Â Â  ; call USP10!ttoGetTableInfo

Â  cmp word[rsp+34h], 4 ; var\_A4

Â  je skipÂ Â Â  Â Â Â  Â Â Â  Â  ; inverse condition from original patch

Â  or eax, 01hÂ Â Â  Â Â Â  Â  ; set piggyback condition

Â  skip:

Â code\_end

patchlet\_end

When turning the official patch into a 0patch I used a "jump condition piggy-backing" technique already described in a [previous post](https://blog.0patch.com/2017/02/0patching-0-day-windows-gdi32dll-memory.html) (only this time It is the *quick brown fox* I'm piggy-backing). Conveniently the official patch is right next to a jump (jnz) that exits the problematic loop so this is also the location for our 0patch. I placed it before the original jnz. Due to lack of space (jnz is only 2 bytes long while we always need 5 to jump to our patch code) I had to place it before the ttoGetTableInfo call that 0patch Agent will substitute with the 5 byte jump. The first instruction in the patch is therefore the substituted original call to ttoGetTableInfo. What follows it is the check from the official patch. First var\_A4 is compared to 4 to check if the loop can continue, otherwise eax that holds the result of ttoGetTableInfo, is set to 1 so the test eax,eax instruction from original code that follows the patch will set a jump flag (zf=0) for the jnz that will exit the loop.

After compiling this .0pp file with 0patch Builder, the patch gets applied and the PoC crashes no more. Our team tested it also against the other TTF files from the PoC.zip package and all of them seem to be disarmed. It is worth noting, however, that this patch only covers the execution route discovered in the Reproduction section above. In the diff of LoadTTOArabicShapeTablesthere there is one more cmp-jnz gray block added to the patched usp10.dll that exits a similar loop to the one covered above. But since there is no public PoC available that would trigger that branch of execution we won't include it in a 0patch. The only safe way for 0patch to work is to cover testable execution paths.

Now, if you haven't so far, install [0patch Agent](https://dist.0patch.com/download/latestagent)Â  and check the PoC to test it for yourself. Next time you see a quick brown fox jumping, make sure that you have 0patch Agent enabled.

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=6686648322237739999&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html "Newer Post")

[Older Post](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/6686648322237739999/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + â–¼
    [July](https://blog.0patch.com/2017/07/)
    (1)
    - [0patching the Quick Brown Fox of CVE-2017-0283](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html)
  + â–º
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from blog.0patch.com_7f5ca92a_20250126_031659.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, June 19, 2017

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[June 19, 2017](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html "permanent link")

### [A Quick Analysis of Microsoft's ESTEEMAUDIT Patch](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html)

**And why CVE-2017-0176 and CVE-2017-9073 are probably not the same thing**

By Mitja Kolsek, 0patch Team

As you may know, we at 0patch wrote a [micropatch for Equation Group's ESTEEMAUDIT exploit](https://twitter.com/0patch/status/864819472615571456) last month. It took us quite a while to reproduce the issue until we figured out that the attack only works against computers joined in a Windows domain, but after that, writing a patch was fairly simple. The image below shows its source code and the "Exploit Attempt Blocked" dialog that gets shown when ESTEEMAUDIT attack is detected and blocked.

Our patch is really simple: we check whether the data received from the remote smart card (imitated by ESTEEMAUDIT) is larger than 80h, which is the size of the destination buffer in gpkcsp.dll. If the received data is larger - and with ESTEEMAUDIT it is - we first alert our locally running 0patch agent (which pops up the alert) and then reduce the size of received data to 80h to prevent buffer overflow. This effectively blocks the attack without disrupting legitimate functionality by introducing just 4 machine instructions into the original code.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifabN3hsSMfpL0pnLdlmb7hI1ob_Ia4TL_Kc27aNjJI4LQEKfges1dVUwBFb5GY8Ytu1xAMr_B3_yUmbjUFIAONqqB7RtlyW5jFcGYiU1s9UKYw0pZhuD4GP1o6xRPqFDyOfWt-7YiCszN/s640/ExploitBlocked.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifabN3hsSMfpL0pnLdlmb7hI1ob_Ia4TL_Kc27aNjJI4LQEKfges1dVUwBFb5GY8Ytu1xAMr_B3_yUmbjUFIAONqqB7RtlyW5jFcGYiU1s9UKYw0pZhuD4GP1o6xRPqFDyOfWt-7YiCszN/s1600/ExploitBlocked.png)

About a month later, Microsoft published their [official update for ESTEEMAUDIT and several other vulnerabilities](https://blogs.technet.microsoft.com/msrc/2017/06/13/june-2017-security-update-release/) despite originally indicating that they would only provide these updates to customers with extended support. This is good: official vendor updates are the preferred way to fix vulnerabilities, and 0patch aims to provide most value when fixing issues that have no official fixes, or to provide protection from critical vulnerabilities to organizations in their [security update gap](https://blog.0patch.com/2016/01/bridging-security-update-gap-with-0patch.html).

Naturally, we were interested in how Microsoft fixed this vulnerability and compare their fix to ours. Enter IDA Pro and BinDiff; after a few minutes, we could compare the two side-by-side.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk_7ygWAxusQ1wJ4ivyXIhod7syvksMiFsOb8SD8m0fq3dkDaIZuwSPSooAqsOutLIJxpVzrlwo5WaI-r0DGYvs29wHV5O7Mx95zkiFHKQLR5-HbcMu416jEiXq7KS9jo-8Om0bwgkVsIP/s640/Microsoft_esteemaudit_patch_2.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk_7ygWAxusQ1wJ4ivyXIhod7syvksMiFsOb8SD8m0fq3dkDaIZuwSPSooAqsOutLIJxpVzrlwo5WaI-r0DGYvs29wHV5O7Mx95zkiFHKQLR5-HbcMu416jEiXq7KS9jo-8Om0bwgkVsIP/s1600/Microsoft_esteemaudit_patch_2.PNG)

With fixed code on the left, and vulnerable code on the right, it's not-surprisingly obvious that Microsoft's patch also introduces the same check we did, at the exact same location. The main difference between our fixes is that while we just cut the received data to valid length, they spawn an error if the data is too long, and abandon the connection.

This makes sense: an official patch should provide troubleshooting info, wile a micropatch should just close the hole with minimum code.

But surprise: BinDiff shows another change.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTaSnu-hJ9m_7R-fw4zGmTbIoJuPjDiWWTtrYT-qRZWVGMS9DnSQuzuBCpGwczNoyrQ3P7BOm89zbWbcgl503eGXrTAajECshzDn_o7lFZ4WWK1fMBAO1EnzldpsXCL3-MXOsZrufwm8Wg/s640/Microsoft_esteemaudit_patch.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTaSnu-hJ9m_7R-fw4zGmTbIoJuPjDiWWTtrYT-qRZWVGMS9DnSQuzuBCpGwczNoyrQ3P7BOm89zbWbcgl503eGXrTAajECshzDn_o7lFZ4WWK1fMBAO1EnzldpsXCL3-MXOsZrufwm8Wg/s1600/Microsoft_esteemaudit_patch.PNG)

Elsewhere in the code, Microsoft added another similar check, also checking for the received data length exceeding 80h - and responding with an error if so.

They obviously reviewed their code and noticed that a similar bug exists after another DoSCardTransmit call, and fixed it as well. Note that this second bug is *not* exploited by ESTEEMAUDIT, but would likely be found by interested parties based on the first one. Microsoft and other decent software vendors routinely search their code for vulnerabilities similar to those they learn about (either internally or externally), and proactively fix them.

This second bug, however, begs the question: Are there any other similar bugs there?

There are 66 calls to DoSCardTransmit in gpkcsp.dll, and we briefly looked at them. We were interested in cases where the received buffer would be copied to some other buffer. There actually was one such case, apart from those patched by Microsoft, as shown on the image below.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6kKNU5TVGj4QUItQHjdLDr8H3xuzMOcZ8z-oFmwNA-4ThEaZHWq1UJvpgjmVvM2RHQ59SiQx_FUxCkaJEmq3TQPwoCBemSMblwuXsndCtxj6HE45vSE8dBPnEmFjGzJMCsbt-p8whHxeB/s640/Microsoft_esteemaudit_notpatched1.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6kKNU5TVGj4QUItQHjdLDr8H3xuzMOcZ8z-oFmwNA-4ThEaZHWq1UJvpgjmVvM2RHQ59SiQx_FUxCkaJEmq3TQPwoCBemSMblwuXsndCtxj6HE45vSE8dBPnEmFjGzJMCsbt-p8whHxeB/s1600/Microsoft_esteemaudit_notpatched1.PNG)

Again, the latest gpkcsp.dll is on the left side, and apparently no data length check was added to it. The code is suspiciously similar to the vulnerable code, but it really all depends on the size of the destination buffer at ds:[edx+ebx]. We had no time to look further into this but we hope Microsoft did and found it to be non-exploitable.

By the way, the ESTEEMAUDIT vulnerability [was assigned CVE-2017-9073](https://twitter.com/mkolsek/status/865314075605159938) but Microsoft [associates its fix with CVE-2017-0176](https://support.microsoft.com/en-us/help/4022747/security-update-for-windows-xp-and-windows-server-2003). This causes some confusion and makes people wonder whether the two CVEs are duplicates. Based on the above analysis of Microsoft's fix, it seems most accurate to say that CVE-2017-9073 is a subset of CVE-2017-0176, the former being only the ESTEEMAUDIT vulnerability and the latter also including the second similar issue that Microsoft also patched.

[Update 2019/4/15: We have subsequently learned that CVE-2017-9073 got marked a duplicate of CVE-2017-0176.]

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[No comments:](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=1001789266992359114&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1001789266992359114&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1001789266992359114&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1001789266992359114&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1001789266992359114&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1001789266992359114&target=pinterest "Share to Pinterest")

[Newer Posts](https://blog.0patch.com/search?updated-max=2017-11-09T09:38:00-08:00&max-results=7&reverse-paginate=true "Newer Posts")

[Older Posts](https://blog.0patch.com/search?updated-max=2017-06-19T08:00:00-07:00&max-results=7 "Older Posts")

[Home](https://blog.0patch.com/)

Subscribe to:
[Posts (Atom)](https://blog.0patch.com/feeds/posts/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + â–¼
    [June](https://blog.0patch.com/2017/06/)
    (1)
    - [A Quick Analysis of Microsoft's ESTEEMAUDIT Patch](https://blog.0patch.com/2017/06/a-quick-analysis-of-microsofts.html)
  + â–º
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from blog.0patch.com_6d00395f_20250126_031700.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, July 10, 2017

Posted by

[Luka Treiber](https://www.blogger.com/profile/14692357778161412891 "author profile")

on

[July 10, 2017](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html "permanent link")

### [0patching the Quick Brown Fox of CVE-2017-0283](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html)

By Luka Treiber, 0patch Team.

Among many other things, last Patch Tuesday brought a fix for an RCE vulnerability named "Windows Uniscribe font processing heap-based memory corruption in USP10!MergeLigRecords".Â  A couple of days later [Mateusz Jurczyk](https://twitter.com/j00ru) of Google Project Zero published a [report](https://bugs.chromium.org/p/project-zero/issues/detail?id=1198&can=1&q=uniscribe&sort=-id) with [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873) attached. Out of the eight vulnerabilities reported at the same time
in that Windows library I chose to patch this one for being
the most severe.

**Reproduction**

Opening font files from the PoC.zip package in Windows Font Viewer displayed the "quick brown fox text" in weird constellations but without a crash. With no exact PoC instructions given this was the procedure that worked for me on Windows 7 x64:

1. unpack the [PoC](https://bugs.chromium.org/p/project-zero/issues/attachment?aid=275873)
2. install signal\_sigsegv\_313372b5\_210\_42111ccffd2e10aba8b5e6ba45289ef3.ttf (or any other TTF from the package) on the system
3. run Notepad
4. select Format->Font...>[Font] 4000 Tall and [Script] Arabic

immediately a crash occurs at

(1410.378): Unknown exception - code c000041d (!!! second chance !!!)

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`025230e8=??

The callstack: it matches the one from report

msvcrt!memcpy+0x1c0

USP10!MergeLigRecords+0x7f

USP10!LoadTTOArabicShapeTables+0x5f8

USP10!LoadArabicShapeTables+0x148

USP10!ArabicLoadTbl+0xf0

USP10!UpdateCache+0xf5

**Analysis of the PoC**

It is usually worth to take a look at PoC and try to understand its payload first before diving into debugging, and thus save a lot of time by knowing what data patterns to look for in the application's memory. So I searched the Internet for the original TTF file the PoC was derived from. I quickly found one and started diffing the two files in order to locate malformed font attributes. Comparison showed a common structure of the files. However, it became clear that an automatic fuzzer was used and too many attributes were polluted with suspicious values to sift through by hand. That task was definitely not a time-saver so I had to give it up.

**Analysis of the official patch**

Extracting and analyzing the official patch is the next reasonable
thing to do after a Patch Tuesday. So let's see how this goes.

TheÂ vulnerable version 1.626.7601.23688 of usp10.dll got replaced by the patched 1.626.7601.23807. The files are both of approximately the same size (788KB) and when compared using BinDiff a match of 733 functions is found. Among those are also the ones from the crash call stack above. It makes sense to check differences in those functions first as the patch is often a sanity check on input data inserted before a vulnerable call. The first one - USP10!MergeLigRecords from the immediate crash context - is identical but the next one - USP10!LoadTTOArabicShapeTables - shows some interesting changes in the function graph. Left is the old (vulnerable) and right is the new (patched) version of usp10.dll

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s640/loop.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgPjPowV896yGNEX5Wm-PVjLjU8sD5ffPWlZNZc8Y25T56kmflRciRgwTmt34XKEklYkjtSetPViG_0lLH7-bj6JTJVMVzB6Gp23QiWmi22YAh85gCbJAL9QJpYMVV6AwDQRo8tb3qB02l/s1600/loop.PNG)

We can see that the vulnerable call MergeLigRecords is enclosed in a loop.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s640/ttoGetTableInfo_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqy1R9zwv7Fb98QWgrzzRhEfPkiGvO7KhiwJ0A_Vs55gRIqFAP4Oy2hheJshtt61CLXZkflbcFSZQUghHJbzNqX5oSQtdHklF1Ftb6y9I03Ys3jgi2w28W-1GNt91MzaWW2P4QY5n4d7q/s1600/ttoGetTableInfo_new.PNG)[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s640/cmp.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifC7Tt2H_IOeG7jiHu1OEeSdbVmuLV_y-wg87WRb1FjJEQjfVWT2jglSNPZ8haf0Falx8NxzMOFo9m8UQIuyDitcNf2bysSE4yTCbc15LOQj4Au88GflXK6a9rPGBRIwLW6qj6HyPhWIGO/s1600/cmp.PNG)
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s640/MergeLigRecords_new.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhK13jrRngKutp7_DgQPTZs7d3tpKEa0EMZMsNWnhgBEC9DywO_pjmwlknKaRMFHkM9Saaa-rGb97z8GUh-emoymyzVs6ox-Kf04NbGbSoUVNSlQfOiGM7xkxWoYM_N3zTJ012ekpWDZHsr/s1600/MergeLigRecords_new.PNG)

Within that loop the only significant change in the patched version is the gray cmp-jnz block that has been added to the patched DLL version. Could this be *the* patch? With limited analysis done so far it is hard to say what the data in comparison (rsp+var\_9C) means, but it is clear that by introduction of that block the criteria to reach the problematic call is more refined than in the old version. This is also a behavior I would expect of a patch.

The only way to make sure is to debug. So we start WinDbg and attach it to notepad.exe on a vulnerable system. We set three breakpoints. One at the vulnerable MergeLigRecords, one before the call to ttoGetTableInfo, and one after. The ttoGetTableInfo call is interesting because it takes two struct parameters - TTOOutput and TTOInput. The gray if block that follows right after, checks if one of the TTOOutput attributes (rsp+var\_9C) is 4 and in case of a mismatch exits the loop. So what we're interested in is where/if rsp+var\_9C changes inside ttoGetTableInfo and how it is related to the crash inside MergeLigRecords. Before we hit [F5] in WinDbg and click-through the PoC we also need to locate a match for the rsp+var\_9C attribute from the patched version in the vulnerable code.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s640/attrib_match.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuUJXB5aD84kE3GNJaPZDgqMKNAi9DLqR6Ylrw7feVpuDl4K8SCzimcLXqVyCptNlWh1gERpTLUqDEQo4bAzb_HTcicELo1lSRaZhHORd0VwwgtDtgGexi3rBRufOk9TlqV8T51tFb3abh/s1600/attrib_match.PNG)

We see that, conveniently, a reference to the same attribute can be found in the old LoadTTOArabicShapeTables named as rsp+var\_A4 (it resolves to @rsp+34 in the snippets below).

Now we can observe our checkpoints in WinDbg

0:002> bu0 @!"usp10"+1e32f "dw @rsp+34 L1";

0:002> bu1 @!"usp10"+1e334 "dw @rsp+34 L1";

0:002> bu2 @!"usp10"+1e3f3;

0:002> g

In the first two passes, the value of var\_A4 is 0004 and does not change. Also the USP10!MergeLigRecords call executes without a crash.

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> g

In the third pass, var\_A4 gets changed by the ttoGetTableInfo call from 0004 to 0001 and MergeLigRecords crashes the app.

00000000`001edd14Â  **0004**

USP10!LoadTTOArabicShapeTables+0x52f:

000007fe`fd59e32f e8bcfd0000Â Â Â Â Â  callÂ Â Â  USP10!ttoGetTableInfo (000007fe`fd5ae0f0)

0:000> g

00000000`001edd14Â  **0001**

USP10!LoadTTOArabicShapeTables+0x534:

000007fe`fd59e334 85c0Â Â Â Â Â Â Â Â Â Â Â  testÂ Â Â  eax,eax

0:000> g

Breakpoint 2 hit

USP10!LoadTTOArabicShapeTables+0x5f3:

000007fe`fd59e3f3 e8b8010000Â Â Â Â Â  callÂ Â Â  USP10!MergeLigRecords (000007fe`fd59e5b0)

0:000> p

(14a8.189c): Access violation - code c0000005 (first chance)

First chance exceptions are reported before any exception handling.

This exception may be expected and handled.

msvcrt!memcpy+0x1c0:

000007fe`fd651444 8a040aÂ Â Â Â Â Â Â Â Â  movÂ Â Â Â  al,byte ptr [rdx+rcx] ds:00000000`03bf5018=??

At this point we can conclude that the gray cmp-jnz block would've prevented the crash so we found a patch candidate and can make a 0patch of it.

**Patching**

So far we've assembled all required pieces to build one - it's all in the gray block in above diff. And below is the resulting .0pp file I made.

MODULE\_PATH "C:\Windows\System32\usp10.dll"

PATCH\_ID 273

PATCH\_FORMAT\_VER 2

VULN\_ID 2536

PLATFORM win64

patchlet\_start

PATCHLET\_ID 1

PATCHLET\_TYPE 2

PATCHLET\_OFFSET 0x0001e32f

PIT USP10!0x2e0f0Â Â Â Â Â  ; import USP10!ttoGetTableInfo

JUMPOVERBYTES 5

N\_ORIGINALBYTES 1

Â code\_start

Â  call PIT\_0x2e0f0Â Â Â Â  ; call USP10!ttoGetTableInfo

Â  cmp word[rsp+34h], 4 ; var\_A4

Â  je skipÂ Â Â  Â Â Â  Â Â Â  Â  ; inverse condition from original patch

Â  or eax, 01hÂ Â Â  Â Â Â  Â  ; set piggyback condition

Â  skip:

Â code\_end

patchlet\_end

When turning the official patch into a 0patch I used a "jump condition piggy-backing" technique already described in a [previous post](https://blog.0patch.com/2017/02/0patching-0-day-windows-gdi32dll-memory.html) (only this time It is the *quick brown fox* I'm piggy-backing). Conveniently the official patch is right next to a jump (jnz) that exits the problematic loop so this is also the location for our 0patch. I placed it before the original jnz. Due to lack of space (jnz is only 2 bytes long while we always need 5 to jump to our patch code) I had to place it before the ttoGetTableInfo call that 0patch Agent will substitute with the 5 byte jump. The first instruction in the patch is therefore the substituted original call to ttoGetTableInfo. What follows it is the check from the official patch. First var\_A4 is compared to 4 to check if the loop can continue, otherwise eax that holds the result of ttoGetTableInfo, is set to 1 so the test eax,eax instruction from original code that follows the patch will set a jump flag (zf=0) for the jnz that will exit the loop.

After compiling this .0pp file with 0patch Builder, the patch gets applied and the PoC crashes no more. Our team tested it also against the other TTF files from the PoC.zip package and all of them seem to be disarmed. It is worth noting, however, that this patch only covers the execution route discovered in the Reproduction section above. In the diff of LoadTTOArabicShapeTablesthere there is one more cmp-jnz gray block added to the patched usp10.dll that exits a similar loop to the one covered above. But since there is no public PoC available that would trigger that branch of execution we won't include it in a 0patch. The only safe way for 0patch to work is to cover testable execution paths.

Now, if you haven't so far, install [0patch Agent](https://dist.0patch.com/download/latestagent)Â  and check the PoC to test it for yourself. Next time you see a quick brown fox jumping, make sure that you have 0patch Agent enabled.

[No comments:](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=6686648322237739999&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=6686648322237739999&target=pinterest "Share to Pinterest")

[Newer Posts](https://blog.0patch.com/search?updated-max=2017-11-17T02:46:00-08:00&max-results=7&reverse-paginate=true "Newer Posts")

[Older Posts](https://blog.0patch.com/search?updated-max=2017-07-10T02:19:00-07:00&max-results=7 "Older Posts")

[Home](https://blog.0patch.com/)

Subscribe to:
[Posts (Atom)](https://blog.0patch.com/feeds/posts/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + â–¼
    [July](https://blog.0patch.com/2017/07/)
    (1)
    - [0patching the Quick Brown Fox of CVE-2017-0283](https://blog.0patch.com/2017/07/0patching-quick-brown-fox-of-cve-2017.html)
  + â–º
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from portal.msrc.microsoft.com_feb814fc_20250124_201248.html ===
You need to enable JavaScript to run this app.

=== Content from www.exploit-db.com_7d276e14_20250124_201250.html ===

[![Exploit Database](/images/spider-white.png)](/)
[Exploit Database](/)

* [Exploits](/)
* [GHDB](/google-hacking-database)
* [Papers](/papers)
* [Shellcodes](/shellcodes)

---

* [Search EDB](/search)
* [SearchSploit Manual](/searchsploit)
* [Submissions](/submit)

---

* [Online Training](https://www.offsec.com/)

[![Exploit Database](/images/edb-logo.png)](/)

* [Stats](/exploit-database-statistics)
* [About Us](/)

  [About Exploit-DB](/about-exploit-db)
  [Exploit-DB History](/history)
  [FAQ](/faq)
* Search

# Microsoft Windows - 'USP10!MergeLigRecords' Uniscribe Font Processing Heap Memory Corruption

#### EDB-ID:

###### 42234

#### CVE:

###### [2017-0283](https://nvd.nist.gov/vuln/detail/CVE-2017-0283)

---

**EDB Verified:**

#### Author:

###### [Google Security Research](/?author=7725)

#### Type:

###### [dos](/?type=dos)

---

#### Platform:

###### [Windows](/?platform=windows)

#### Date:

###### 2017-06-23

---

**Vulnerable App:**

```
Source: https://bugs.chromium.org/p/project-zero/issues/detail?id=1198

We have encountered a crash in the Windows Uniscribe user-mode library, in the memmove() function called by USP10!MergeLigRecords, while trying to display text using a corrupted font file:

---
(4e0.6dc): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000001 ebx=00000036 ecx=000023af edx=00000003 esi=03624337 edi=0362436d
eip=76e1026a esp=003cefd8 ebp=003cefe0 iopl=0         nv up ei pl nz ac pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010216
msvcrt!memmove+0x224:
76e1026a 8a4603          mov     al,byte ptr [esi+3]        ds:0023:0362433a=??
0:000> kb
 # ChildEBP RetAddr  Args to Child
00 003cefe0 774c772d 03621fc1 03621f8b 000023b0 msvcrt!memmove+0x224
01 003ceffc 774c75c3 03615fd0 036159d0 003cf098 USP10!MergeLigRecords+0x3d
02 003cf05c 774c7124 0000001a 035b3d88 035bffa8 USP10!LoadTTOArabicShapeTables+0x3f3
03 003cf070 774cc734 2e0105bd 035b3d88 035a6124 USP10!LoadArabicShapeTables+0xd4
04 003cf08c 774ba5a0 2e0105bd 036157d0 0000001a USP10!ArabicLoadTbl+0xd4
05 003cf0b4 774ba692 035a6124 2e0105bd 0000001a USP10!UpdateCache+0xb0
06 003cf0c8 774c15fd 2e0105bd 035a6000 774c16ab USP10!ScriptCheckCache+0x62
07 003cf0d4 774c16ab 00000001 00000001 00000000 USP10!GetShapeFunction+0xd
08 003cf10c 774c2bd4 00000001 00000004 003cf18c USP10!RenderItemNoFallback+0x5b
09 003cf138 774c2e62 00000001 00000004 003cf18c USP10!RenderItemWithFallback+0x104
0a 003cf15c 774c43f9 00000004 003cf18c 035a6124 USP10!RenderItem+0x22
0b 003cf1a0 774b7a04 000004a0 00000400 2e0105bd USP10!ScriptStringAnalyzeGlyphs+0x1e9
0c 003cf1b8 760a1736 2e0105bd 035a6040 0000000a USP10!ScriptStringAnalyse+0x284
0d 003cf204 760a18c1 2e0105bd 003cf688 0000000a LPK!LpkStringAnalyse+0xe5
0e 003cf300 760a17b4 2e0105bd 00000000 00000000 LPK!LpkCharsetDraw+0x332
0f 003cf334 77df56a9 2e0105bd 00000000 00000000 LPK!LpkDrawTextEx+0x40
10 003cf374 77df5a64 2e0105bd 00000048 00000000 USER32!DT_DrawStr+0x13c
11 003cf3c0 77df580f 2e0105bd 003cf688 003cf69c USER32!DT_GetLineBreak+0x78
12 003cf46c 77df5882 2e0105bd 00000000 0000000a USER32!DrawTextExWorker+0x250
13 003cf490 77df5b68 2e0105bd 003cf688 ffffffff USER32!DrawTextExW+0x1e
14 003cf4c4 000e6c3a 2e0105bd 003cf688 ffffffff USER32!DrawTextW+0x4d
[...]
0:000> db poi(ebp+8)
03621fc1  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fd1  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fe1  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621ff1  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 d0 d0 d0 d0 ??  ...............?
03622001  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
03622011  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
03622021  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
03622031  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0:000> db poi(ebp+c)
03621f8b  00 b5 00 b7 00 b9 00 bb-00 bd 00 bf 00 c3 00 c5  ................
03621f9b  00 c9 00 cb 00 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fab  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fbb  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fcb  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621fdb  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621feb  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
03621ffb  c0 d0 d0 d0 d0 ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  .....???????????
0:000> dd esi
03624337  ???????? ???????? ???????? ????????
03624347  ???????? ???????? ???????? ????????
03624357  ???????? ???????? ???????? ????????
03624367  ???????? ???????? ???????? ????????
03624377  ???????? ???????? ???????? ????????
03624387  ???????? ???????? ???????? ????????
03624397  ???????? ???????? ???????? ????????
036243a7  ???????? ???????? ???????? ????????
0:000> dd edi
0362436d  ???????? ???????? ???????? ????????
0362437d  ???????? ???????? ???????? ????????
0362438d  ???????? ???????? ???????? ????????
0362439d  ???????? ???????? ???????? ????????
036243ad  ???????? ???????? ???????? ????????
036243bd  ???????? ???????? ???????? ????????
036243cd  ???????? ???????? ???????? ????????
036243dd  ???????? ???????? ???????? ????????
---

The issue reproduces on Windows 7. It is easiest to reproduce with PageHeap enabled, but it is also possible to observe a crash in a default system configuration. In order to reproduce the problem with the provided samples, it might be necessary to use a custom program which displays all of the font's glyphs at various point sizes.

It's worth noting that the crash is almost identical to the one reported in  Issue #1026 , which was supposedly fixed as CVE-2017-0087 in the MS17-011 bulletin. The number of times we have encountered this crash while fuzzing the patched version of USP10.DLL might suggest that the fix was incomplete (or alternatively, that there is a separate bug which causes a crash in the same code location).

Attached are 6 proof of concept malformed font files which trigger the crash.

Proof of Concept:
https://gitlab.com/exploit-database/exploitdb-bin-sploits/-/raw/main/bin-sploits/42234.zip

```

**Tags:**

**Advisory/Source:**
[Link](https://bugs.chromium.org/p/project-zero/issues/detail?id=1198)

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/statistics) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Databases
[Exploits](/)
[Google Hacking](/google-hacking-database)
[Papers](/papers)
[Shellcodes](/shellcodes)

Links
[Search Exploit-DB](/search)
[Submit Entry](/submit)
[SearchSploit Manual](/searchsploit)
[Exploit Statistics](/statistics)

Sites
[OffSec](https://www.offsec.com)
[Kali Linux](https://www.kali.org/)
[VulnHub](https://www.vulnhub.com)

Solutions
[Courses and Certifications](https://www.offsec.com/courses-and-certifications/)
[Learn Subscriptions](https://www.offsec.com/learn/)
[OffSec Cyber Range](https://www.offsec.com/cyber-range/)
[Proving Grounds](https://www.offsec.com/labs/)
[Penetration Testing Services](https://www.offsec.com/penetration-testing/)

* [Exploit Database by OffSec](/)
* [Terms](/terms)
* [Privacy](/privacy)
* [About Us](/about-exploit-db)
* [FAQ](/faq)
* [Cookies](/cookies)

Â©
[OffSec Services Limited](https://www.offsec.com/) 2025. All rights reserved.

##### About The Exploit Database

Ã—

[![OffSec](/images/offsec-logo.png)](https://www.offsec.com/)
The Exploit Database is maintained by [OffSec](https://www.offsec.com/community-projects/), an information security training company
that provides various [Information Security Certifications](https://www.offsec.com/courses-and-certifications/) as well as high end [penetration testing](https://www.offsec.com/penetration-testing/) services. The Exploit Database is a
non-profit project that is provided as a public service by OffSec.

The Exploit Database is a [CVE
compliant](http://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html) archive of public exploits and corresponding vulnerable software,
developed for use by penetration testers and vulnerability researchers. Our aim is to serve
the most comprehensive collection of exploits gathered through direct submissions, mailing
lists, as well as other public sources, and present them in a freely-available and
easy-to-navigate database. The Exploit Database is a repository for exploits and
proof-of-concepts rather than advisories, making it a valuable resource for those who need
actionable data right away.

The [Google Hacking Database (GHDB)](/google-hacking-database)
is a categorized index of Internet search engine queries designed to uncover interesting,
and usually sensitive, information made publicly available on the Internet. In most cases,
this information was never meant to be made public but due to any number of factors this
information was linked in a web document that was crawled by a search engine that
subsequently followed that link and indexed the sensitive information.

The process known as â€œGoogle Hackingâ€ was popularized in 2000 by Johnny
Long, a professional hacker, who began cataloging these queries in a database known as the
Google Hacking Database. His initial efforts were amplified by countless hours of community
member effort, documented in the book Google Hacking For Penetration Testers and popularised
by a barrage of media attention and Johnnyâ€™s talks on the subject such as this early talk
recorded at [DEFCON 13](https://www.defcon.org/html/links/dc-archives/dc-13-archive.html). Johnny coined the term â€œGoogledorkâ€ to refer
to â€œa foolish or inept person as revealed by Googleâ€œ. This was meant to draw attention to
the fact that this was not a â€œGoogle problemâ€ but rather the result of an often
unintentional misconfiguration on the part of a user or a program installed by the user.
Over time, the term â€œdorkâ€ became shorthand for a search query that located sensitive
information and â€œdorksâ€ were included with may web application vulnerability releases to
show examples of vulnerable web sites.

After nearly a decade of hard work by the community, Johnny turned the GHDB
over to [OffSec](https://www.offsec.com/community-projects/) in November 2010, and it is now maintained as
an extension of the [Exploit Database](/). Today, the GHDB includes searches for
other online search engines such as [Bing](https://www.bing.com/),
and other online repositories like [GitHub](https://github.com/),
producing different, yet equally valuable results.

Close

##### OffSec Resources

Ã—

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
|  | [Proving Grounds](https://www.offsec.com/labs/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/serchsploit) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Close

##### Search The Exploit Database

Ã—

Title

CVE

Type

dos

local

remote

shellcode

papers

webapps

Platform

AIX

ASP

BSD

BSD\_PPC

BSD\_x86

BSDi\_x86

CGI

FreeBSD

FreeBSD\_x86

FreeBSD\_x86-64

Generator

Hardware

HP-UX

IRIX

JSP

Linux

Linux\_MIPS

Linux\_PPC

Linux\_SPARC

Linux\_x86

Linux\_x86-64

MINIX

Multiple

NetBSD\_x86

Novell

OpenBSD

OpenBSD\_x86

OSX\_PPC

OSX

PHP

Plan9

QNX

SCO

SCO\_x86

Solaris

Solaris\_SPARC

Solaris\_x86

Tru64

ULTRIX

Unix

UnixWare

Windows\_x86

Windows\_x86-64

Windows

ARM

CFM

Netware

SuperH\_SH4

Java

BeOS

Immunix

Palm\_OS

AtheOS

iOS

Android

XML

Perl

Python

System\_z

JSON

ASHX

Ruby

ASPX

macOS

Linux\_CRISv32

eZine

Magazine

NodeJS

Alpha

Solaris\_MIPS

Lua

watchOS

VxWorks

Python2

Python3

TypeScript

Go

Author

Content

Port

14

21

22

23

25

42

49

53

66

69

70

79

80

81

102

105

110

111

113

119

123

135

139

143

161

162

164

383

389

402

406

411

443

444

445

446

502

504

513

514

515

532

548

554

555

617

623

631

655

689

783

787

808

873

888

901

998

1000

1040

1089

1099

1100

1114

1120

1194

1235

1471

1521

1533

1581

1589

1604

1617

1723

1743

1761

1812

1858

1861

1900

1947

2000

2022

2049

2100

2103

2121

2125

2181

2242

2315

2375

2380

2381

2401

2480

2525

2640

2810

2812

2947

2954

2990

3000

3030

3050

3052

3128

3129

3181

3200

3217

3306

3333

3378

3389

3460

3465

3500

3535

3632

3690

3790

3814

3817

4000

4002

4070

4081

4105

4111

4322

4343

4434

4444

4501

4555

4592

4661

4750

4848

5000

5060

5061

5080

5081

5093

5151

5180

5247

5250

5272

5308

5432

5466

5554

5555

5600

5655

5666

5800

5803

5814

5858

5900

5984

6066

6070

6080

6082

6101

6112

6129

6379

6502

6503

6660

6667

7001

7002

7070

7071

7080

7100

7144

7210

7272

7290

7426

7443

7510

7547

7649

7770

7777

7778

7787

7879

7902

8000

8001

8002

8004

8008

8020

8022

8023

8028

8030

8080

8081

8082

8088

8090

8181

8300

8400

8443

8445

8473

8500

8585

8619

8800

8812

8839

8880

8888

9000

9001

9002

9080

9090

9091

9100

9124

9200

9251

9256

9443

9447

9784

9788

9855

9876

9900

9987

9993

9999

10000

10001

10080

10202

10203

10443

10616

11000

11211

11460

12203

12221

12345

12397

12401

13327

13701

13722

13838

16992

18821

18881

19000

19810

19813

20000

20002

20010

20031

20111

20171

22003

23423

25672

26000

27015

27700

28015

30000

30303

31337

32400

32674

32764

34205

37215

37777

37848

38292

40007

41523

44334

46824

48080

49152

50000

50496

52311

52789

52869

52986

53413

54345

54890

55554

55555

56380

57772

58080

62514

Tag

WordPress Core

Metasploit Framework (MSF)

WordPress Plugin

SQL Injection (SQLi)

Cross-Site Scripting (XSS)

File Inclusion (LFI/RFI)

Cross-Site Request Forgery (CSRF)

Denial of Service (DoS)

Code Injection

Command Injection

Authentication Bypass / Credentials Bypass (AB/CB)

Client Side

Use After Free (UAF)

Out Of Bounds

Remote

Local

XML External Entity (XXE)

Integer Overflow

Server-Side Request Forgery (SSRF)

Race Condition

NULL Pointer Dereference

Malware

Buffer Overflow

Heap Overflow

Type Confusion

Object Injection

Bug Report

Console

Pwn2Own

Traversal

Deserialization

Verified

Has App

No Metasploit

Search



=== Content from blog.0patch.com_926528a8_20250126_031659.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Thursday, August 24, 2017

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[August 24, 2017](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html "permanent link")

### [0patching Foxit Reader's saveAs "0day" (CVE-2017-10952)](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html)

**3rd-Party Patching a Logical Bug**

By Mitja Kolsek, the 0patch team

A bit of introduction: last week we could all witness a familiar *"It's a vuln - no it's not"* dance, this time featuring [Zero Day Initiative](http://www.zerodayinitiative.com/) and [Foxit Software](https://www.foxitsoftware.com/). In short, ZDI reported to Foxit two security issues in its Reader and PhantomPDF products discovered by [Steven Seeley](https://twitter.com/steventseeley) and Ariele Caltabiano. Foxit said they would not fix these issues as their exploitation requires the user to disable *Secure Mode* and thus allow unsafe JavaScript code to execute. ZDI then moved to publishÂ [proof-of-concept details](https://www.zerodayinitiative.com/blog/2017/8/17/busting-myths-in-foxit-reader), which resulted in [Foxit deciding to address these issues](https://www.foxitsoftware.com/support/security-advisories.php) anyway. Finally,
[Alex InfÃ¼hr](https://twitter.com/insertScript) reminded us that he also found an reported [two similar issues](http://insert-script.blogspot.si/2017/08/a-tale-about-foxit-reader-safe-reading.html) to Foxit before.

Foxit stated that they would "*add an additional guard in PhantomPDF/Reader code where when opening a
PDF document contains these powerful ( and thus potentially insecure)
JavaScript functions, the software will check if the document is
digitally signed by a verifiable/trustworthy person of entity. Only
certified documents can run these powerful JS functions even when â€œSafe
Reading Modeâ€ is turned off.*"

They also announced their plan to "*release a Reader/PhantomPDF 8.3.2 patch update this week (ETA Aug 25th)
with additional guard against misuse of powerful (potentially
insecure) JavaScript functions â€” this will make Foxit software
equivalent to what Adobe does.*"

We at [0patch](https://0patch.com/) like a challenge as much as the next guy. While we're usually patching memory corruption bugs (most critical remotely exploitable vulns are of that sort), we're happy to demonstrate that in-memory micrpatching can just as well be used for fixing logical bugs - at least temporarily, until the official vendor fix is applied.

So we set upon creating a micropatch for CVE-2017-10952, allowing a script inside a PDF document to use the saveAs function to save itself to an arbitrarily chosen location on user's computer, using an arbitrarily chosen file extension. For example, a PDF document containing a <html> block with some script anywhere in it could simply save itself as an HTA file (locally executable HTML file) in user's StartUp folder like this:

this.saveAs("/c/Users/â€+
identity.loginName +
â€/AppData/Roaming/Microsoft/Windows/STARTM~1/Programs/Startup/si.hta");

As a result, when the user logged in to Windows the next time, this HTA file would get executed.

**Reproducing the issue**

Reproducing the issue was simple: we downloaded and installed the latest version of Foxit Reader (8.3.1.21155) and put the above code into a sample PDF file to get our [POC](https://0patch.com/poc/CVE-2017-10952/poc_CVE-2017-10952.pdf).

Opening the POC in Foxit Reader with default/recommended configuration resulted in the Safe Reading Mode warning. Pressing "OK" was enough to disable Safe Reading Mode and get our code executed. Indeed, si.hta got created in the StartUp folder.

**Analysis**

It's generally not trivial to find code that implements a JavaScript function, especially if the result of the POC is not a crash. However, in this case the saveAs function writes a file to disk so it can be intercepted at a call to one of the disk-writing Windows API functions. While the ZDI article mentions the WriteFile function, putting a breakpoint on it resulted in way too many hits. So we went with CreateFile.

However, CreateFile also got called constantly with some BMP file that Foxit Reader seems to be loading all the time for some reason. Making the breakpoint conditional did the trick by simply checking two letters of the file path and not breaking if they matched the said BMP file path:

bp kernel32!CreateFileW "j poi(poi(esp+4)+6)!=0x00730055 ''; 'gc'"

Bingo! The first break occurred right in our saveAs call, confirmed by our HTA path being passed to CreateFile. The call stack tail looked like this:

0030eba8 01703c5e kernel32!CreateFileW
0030ebdc 016f7d4f FOXITREADER+0x823c5e
0030ebfc 011c5a22 FOXITREADER+0x817d4f
0030efac 010bd155 FOXITREADER+0x2e5a22
0030f068 0238ad23 FOXITREADER+0x1dd155
0030f230 02377492 FOXITREADER+0x14aad23

0030f2e4 012f17c7 FOXITREADER+0x1497492
0030f31c 0217568e FOXITREADER+0x4117c7

Time for IDA. As FOXITREADER.EXE is a 54MB beast, it took IDA quite a while to sort it all out. After that, looking at the functions in the call stack revealed that the one containing address FOXITREADER+0x14aad23 holds the bulk of saveAs implementation. There are references to all [saveAs](http://help.adobe.com/livedocs/acrobat_sdk/11/Acrobat11_HTMLHelp/wwhelp/wwhimpl/common/html/wwhelp.htm?context=Acrobat11_HTMLHelp&file=JS_API_AcroJS.89.530.html) arguments there (cPath, cConvID, cFS, bCopy and bPromptToOverwrite), and one can see the logic ofÂ  bPromptToOverwrite value, which, if true, calls PathFileExistsW and sets a local variable we called allowed\_to\_save\_file to 0 if the user declines the overwrite.

The image below shows the place where allowed\_to\_save\_file is set to 0, and a bit further down where allowed\_to\_save\_file is checked, whereby a bunch of code is bypassed if it is 0. The bypassed code includes the green block where the execution proceeds towards the CreateFile call.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhB-IaX2Fsz6viF_PEg7pJngv1f7k9lpd7lopBtXKK4DZhnu8r6UNJOi7C-l2fPC69uekK57C4elkdAOoMFZq_YJYI1vy6R7v192MUl00rmZOnr22QPzGKxsH3nrRoY4_Gw70U83OFVAp9R/s640/saveAs_logic.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhB-IaX2Fsz6viF_PEg7pJngv1f7k9lpd7lopBtXKK4DZhnu8r6UNJOi7C-l2fPC69uekK57C4elkdAOoMFZq_YJYI1vy6R7v192MUl00rmZOnr22QPzGKxsH3nrRoY4_Gw70U83OFVAp9R/s1600/saveAs_logic.PNG)

**Patching**

It would be very difficult for us to do exactly what Foxit is about to do to address this issue (only allowing properly signed documents to use dangerous functions like saveAs) because digging down deeper to find a way to the data on document signatures could easily take us days. So we decided to simplify the fix in a way to still allow saveAs, but not in a RCE-style dangerous way.

We noticed (and tested) that in contrast to Adobe's products, Foxit Reader's [saveAs](http://help.adobe.com/livedocs/acrobat_sdk/11/Acrobat11_HTMLHelp/wwhelp/wwhimpl/common/html/wwhelp.htm?context=Acrobat11_HTMLHelp&file=JS_API_AcroJS.89.530.html) function doesn't seem to support document conversion. Consequently, it makes no sense to allow a document to save itself with any other extension than ".pdf". So our logic would be to check the file name passed to saveAs, and only allow files with a ".pdf" extension to proceed, while silently blocking all other extensions.

Having this patching logic in place, we already knew how to get the file path in the function shown above, so we only needed a way to sabotage the file creation for disallowed extensions without causing any unwanted side effects.

The implementation of bPromptToOverwrite logic came in handy as we saw that when the user doesn't allow overwriting, the execution simply bypasses a code block that otherwise leads to CreateFile, and that surely has no unwanted side effects.

So we did a similar thing: We decided to inject our patch code at the beginning of the green block and do the following there:

*1) Get the address of the last "." in cPath\_string (if any).
2) If no dot, jump out of the block
3) Make a case-insensitive \_wcsicmp with ".pdf"
4) If we don't have a match, jump out of the block*

*5) Otherwise continue*

IDA was really helpful in identifying implementations of \_wcsrchr and \_wcsicmp inside FOXITREADER.EXE for us so we didn't have to implement them in the patch.

Furthermore, we decided to identify any attempt to save a file with some other file extension as an exploit attempt, which results in an "Exploit Attempt Blocked" popup.

This is the micropatch that came out of this:

; target: Foxit Reader 8.3.1.21155

MODULE\_PATH "C:\Program Files (x86)\Foxit Software\Foxit Reader\FoxitReader.exe"
PATCH\_ID 275
PATCH\_FORMAT\_VER 2
VULN\_ID 2891
PLATFORM win32

patchlet\_start
PATCHLET\_ID 1
PATCHLET\_TYPE 2

PIT FoxitReader.exe!0x5CA2A1,FoxitReader.exe!0x5C9A22,FoxitReader.exe!0x14AAD23

PATCHLET\_OFFSET 0x14AACF2
N\_ORIGINALBYTES 5

code\_start

Â Â  Â mov edx, dword [ebp-1A0h]
Â Â  Â push '.'
Â Â  Â push edx
Â Â  Â call PIT\_0x5CA2A1Â Â Â Â Â Â Â Â Â Â  ; (\_wcsrchr) find the last dot in cPath
Â Â  Â add esp, 8Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; restore esp
Â Â  Â test eax, eaxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  ; was a dot found?
Â Â  Â jz AbortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; no dot found, we don't allow that

Â Â  Â call GetLocalPdfStringÂ Â Â Â Â  ; a trick to get the address of a local
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; string on stack
Â Â  Â dw \_\_utf16\_\_(".pdf"),0

Â Â  Â GetLocalPdfString:Â Â Â Â Â Â Â Â Â  ; at this point, the address of string
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; ".pdf" is on the stack
Â Â  Â push eaxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; eax points to the found dot in cPath
Â Â  Â call PIT\_0x5C9A22Â Â Â Â Â Â Â Â Â Â  ; (\_wcsicmp) compare the two strings,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; case insensitive
Â Â  Â add esp, 8Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; restore esp
Â Â  Â test eax, eaxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  ; do strings match?
Â Â  Â jz ContinueÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; they do match, we allow saveAs to continue

Â Â  Â Abort:
Â Â  Â call PIT\_ExploitBlockedÂ Â Â Â  ; show the "Exploit Blocked" popup
Â Â  Â jmp PIT\_0x14AAD23Â Â Â Â Â Â Â Â Â Â  ; jmp out of the block, sabotaging saveAs

Â Â  Â Continue:

code\_end
patchlet\_end

**Micropatch in Action**

We made a video to quickly show you how 0patch Agent applies this micropatch to a running Foxit Reader, effectively patching it without disturbing the user.

**Closing Remarks**

We made this micropatch to show how logical vulnerabilities can also be patched, and to demonstrate the amount of effort required for creating a micropatch. It took us 6 man-hours from installing the vulnerable Foxit Reader to having a working micropatch. Mind you, the majority of time was spent on analyzing the vulnerability and Reader's code, and deciding on a good way to patch. The original product developers already know the product inside out and would skip most of this process.

We believe that with Foxit's intimate knowledge of their product, and our knowledge of micropatching, a high-quality micropatch could be made in less than an hour. With our distribution system, it would be on everyone's computer within
another hour, and applied automatically. Even users using Foxit Reader
at that time would not notice anything - Reader would instantly get from
"vulnerable" to "fixed" while they would scroll the pages of some
document. And that's how we believe most software vulnerabilities should (and could) be fixed.

If you have [0patch Agent](https://dist.0patch.com/download/latestagent) installed (it's free!), this micropatch is already on your computer and is getting automatically applied when you launch the vulnerable Foxit Reader. You can use this [POC](https://0patch.com/poc/CVE-2017-10952/poc_CVE-2017-10952.pdf) to play with it. Have fun, write some micropatches and if you're a software vendor interested in equipping your products with self-micropatching ability, ping us at support@0patch.com.

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

Update 8/29/2017: The latest Foxit Reader (8.3.2.25013) fixes CVE-2017-10951, CVE-2017-10952, and both vulnerabilities reported by
Alex InfÃ¼hr.

[No comments:](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=4741949623410303694&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=4741949623410303694&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=4741949623410303694&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=4741949623410303694&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=4741949623410303694&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=4741949623410303694&target=pinterest "Share to Pinterest")

[Newer Posts](https://blog.0patch.com/search?updated-max=2017-11-23T07:34:00-08:00&max-results=7&reverse-paginate=true "Newer Posts")

[Older Posts](https://blog.0patch.com/search?updated-max=2017-08-24T06:41:00-07:00&max-results=7 "Older Posts")

[Home](https://blog.0patch.com/)

Subscribe to:
[Posts (Atom)](https://blog.0patch.com/feeds/posts/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* â–º
  [2025](https://blog.0patch.com/2025/)
  (1)
  + â–º
    [January](https://blog.0patch.com/2025/01/)
    (1)

* â–º
  [2024](https://blog.0patch.com/2024/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + â–º
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2024/01/)
    (1)

* â–º
  [2023](https://blog.0patch.com/2023/)
  (26)
  + â–º
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + â–º
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + â–º
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + â–º
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2023/01/)
    (2)

* â–º
  [2022](https://blog.0patch.com/2022/)
  (26)
  + â–º
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + â–º
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + â–º
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + â–º
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + â–º
    [January](https://blog.0patch.com/2022/01/)
    (1)

* â–º
  [2021](https://blog.0patch.com/2021/)
  (23)
  + â–º
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + â–º
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + â–º
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + â–º
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + â–º
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2021/01/)
    (2)

* â–º
  [2020](https://blog.0patch.com/2020/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + â–º
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + â–º
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + â–º
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + â–º
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + â–º
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2020/01/)
    (2)

* â–º
  [2019](https://blog.0patch.com/2019/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + â–º
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + â–º
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â–º
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â–º
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + â–º
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + â–º
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + â–º
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + â–º
    [January](https://blog.0patch.com/2018/01/)
    (2)

* â–¼
  [2017](https://blog.0patch.com/2017/)
  (19)
  + â–º
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + â–º
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + â–º
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + â–º
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + â–¼
    [August](https://blog.0patch.com/2017/08/)
    (1)
    - [0patching Foxit Reader's saveAs "0day" (CVE-2017-1...](https://blog.0patch.com/2017/08/0patching-foxit-readers-saveas-0day-cve.html)
  + â–º
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + â–º
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + â–º
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + â–º
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2017/01/)
    (1)

* â–º
  [2016](https://blog.0patch.com/2016/)
  (7)
  + â–º
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + â–º
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + â–º
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + â–º
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).


