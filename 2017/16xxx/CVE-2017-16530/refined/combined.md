=== Content from groups.google.com_981d9e2b_20250125_193620.html ===
[![](https://fonts.gstatic.com/s/i/productlogos/groups/v9/web-48dp/logo_groups_color_1x_web_48dp.png)Groups](./my-groups "Groups")ConversationsAll groups and messagesSend feedback to GoogleHelpTraining[Sign in](https://accounts.google.com/ServiceLogin?hl=en&passive=true&continue=https://groups.google.com&ec=GAZA0AM)[Groups](./my-groups "Groups")
## syzkaller

[Conversations](./g/syzkaller)[About](./g/syzkaller/about)[Privacy](https://policies.google.com/privacy?hl=en_US) • [Terms](https://policies.google.com/terms?hl=en_US)

Groups keyboard shortcuts have been updatedDismissSee shortcuts
# usb/storage/uas: slab-out-of-bounds in uas\_probe

 366 viewsSkip to first unread message![Andrey Konovalov's profile photo](https://lh3.googleusercontent.com/a/default-user=s40-c)
### Andrey Konovalov

unread,Sep 21, 2017, 4:39:07 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Oliver Neukum, Alan Stern, Greg Kroah-Hartman, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerHi!

I've got the following report while fuzzing the kernel with syzkaller.

On commit ebb2c2437d8008d46796902ff390653822af6cc4 (Sep 18).

The issue occurs when we iterate over interface altsettings, but I

don't see the driver doing anything wrong. I might be missing

something, or this might be an issue in USB core altsettings parsing.

==================================================================

BUG: KASAN: slab-out-of-bounds in uas\_probe+0x15de/0x1680

Read of size 1 at addr ffff880063ba9ad4 by task kworker/1:2/1845

CPU: 1 PID: 1845 Comm: kworker/1:2 Not tainted

4.14.0-rc1-42251-gebb2c2437d80 #215

Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011

Workqueue: usb\_hub\_wq hub\_event

Call Trace:

 \_\_dump\_stack lib/dump\_stack.c:16

 dump\_stack+0x292/0x395 lib/dump\_stack.c:52

 print\_address\_description+0x78/0x280 mm/kasan/report.c:252

 kasan\_report\_error mm/kasan/report.c:351

 kasan\_report+0x22f/0x340 mm/kasan/report.c:409

 \_\_asan\_report\_load1\_noabort+0x19/0x20 mm/kasan/report.c:427

 uas\_is\_interface drivers/usb/storage/uas-detect.h:9

 uas\_find\_uas\_alt\_setting drivers/usb/storage/uas-detect.h:19

 uas\_use\_uas\_driver drivers/usb/storage/uas-detect.h:64

 uas\_probe+0x15de/0x1680 drivers/usb/storage/uas.c:938

 usb\_probe\_interface+0x35d/0x8e0 drivers/usb/core/driver.c:361

 really\_probe drivers/base/dd.c:413

 driver\_probe\_device+0x610/0xa00 drivers/base/dd.c:557

 \_\_device\_attach\_driver+0x230/0x290 drivers/base/dd.c:653

 bus\_for\_each\_drv+0x161/0x210 drivers/base/bus.c:463

 \_\_device\_attach+0x26e/0x3d0 drivers/base/dd.c:710

 device\_initial\_probe+0x1f/0x30 drivers/base/dd.c:757

 bus\_probe\_device+0x1eb/0x290 drivers/base/bus.c:523

 device\_add+0xd0b/0x1660 drivers/base/core.c:1835

 usb\_set\_configuration+0x104e/0x1870 drivers/usb/core/message.c:1932

 generic\_probe+0x73/0xe0 drivers/usb/core/generic.c:174

 usb\_probe\_device+0xaf/0xe0 drivers/usb/core/driver.c:266

 really\_probe drivers/base/dd.c:413

 driver\_probe\_device+0x610/0xa00 drivers/base/dd.c:557

 \_\_device\_attach\_driver+0x230/0x290 drivers/base/dd.c:653

 bus\_for\_each\_drv+0x161/0x210 drivers/base/bus.c:463

 \_\_device\_attach+0x26e/0x3d0 drivers/base/dd.c:710

 device\_initial\_probe+0x1f/0x30 drivers/base/dd.c:757

 bus\_probe\_device+0x1eb/0x290 drivers/base/bus.c:523

 device\_add+0xd0b/0x1660 drivers/base/core.c:1835

 usb\_new\_device+0x7b8/0x1020 drivers/usb/core/hub.c:2457

 hub\_port\_connect drivers/usb/core/hub.c:4903

 hub\_port\_connect\_change drivers/usb/core/hub.c:5009

 port\_event drivers/usb/core/hub.c:5115

 hub\_event+0x194d/0x3740 drivers/usb/core/hub.c:5195

 process\_one\_work+0xc7f/0x1db0 kernel/workqueue.c:2119

 worker\_thread+0x221/0x1850 kernel/workqueue.c:2253

 kthread+0x3a1/0x470 kernel/kthread.c:231

 ret\_from\_fork+0x2a/0x40 arch/x86/entry/entry\_64.S:431

Allocated by task 2641:

 save\_stack\_trace+0x1b/0x20 arch/x86/kernel/stacktrace.c:59

 save\_stack+0x43/0xd0 mm/kasan/kasan.c:447

 set\_track mm/kasan/kasan.c:459

 kasan\_kmalloc+0xad/0xe0 mm/kasan/kasan.c:551

 kmem\_cache\_alloc\_node\_trace+0x15e/0x2d0 mm/slub.c:2800

 kmalloc\_node ./include/linux/slab.h:531

 kzalloc\_node ./include/linux/slab.h:677

 \_\_get\_vm\_area\_node+0x141/0x570 mm/vmalloc.c:1402

 \_\_vmalloc\_node\_range+0xa8/0x730 mm/vmalloc.c:1760

 \_\_vmalloc\_node mm/vmalloc.c:1810

 \_\_vmalloc\_node\_flags mm/vmalloc.c:1824

 vmalloc+0x4a/0x50 mm/vmalloc.c:1846

 n\_tty\_open+0x20/0x470 drivers/tty/n\_tty.c:1883

 tty\_ldisc\_open.isra.1+0x78/0xc0 drivers/tty/tty\_ldisc.c:466

 tty\_ldisc\_setup+0x8f/0x100 drivers/tty/tty\_ldisc.c:780

 tty\_init\_dev+0x1a2/0x4a0 drivers/tty/tty\_io.c:1332

 ptmx\_open+0xfe/0x320 drivers/tty/pty.c:831

 chrdev\_open+0x25c/0x710 fs/char\_dev.c:416

 do\_dentry\_open+0x74e/0xd60 fs/open.c:752

 vfs\_open+0x10c/0x230 fs/open.c:866

 do\_last fs/namei.c:3387

 path\_openat+0xf22/0x34d0 fs/namei.c:3527

 do\_filp\_open+0x2a1/0x460 fs/namei.c:3562

 do\_sys\_open+0x543/0x720 fs/open.c:1059

 SYSC\_open fs/open.c:1077

 SyS\_open+0x32/0x40 fs/open.c:1072

 entry\_SYSCALL\_64\_fastpath+0x23/0xc2 arch/x86/entry/entry\_64.S:202

Freed by task 2641:

 save\_stack\_trace+0x1b/0x20 arch/x86/kernel/stacktrace.c:59

 save\_stack+0x43/0xd0 mm/kasan/kasan.c:447

 set\_track mm/kasan/kasan.c:459

 kasan\_slab\_free+0x72/0xc0 mm/kasan/kasan.c:524

 slab\_free\_hook mm/slub.c:1390

 slab\_free\_freelist\_hook mm/slub.c:1412

 slab\_free mm/slub.c:2988

 kfree+0xf6/0x2f0 mm/slub.c:3919

 \_\_vunmap+0x24c/0x2f0 mm/vmalloc.c:1545

 vfree+0x55/0xe0 mm/vmalloc.c:1606

 n\_tty\_close+0xb7/0x120 drivers/tty/n\_tty.c:1864

 tty\_ldisc\_close.isra.0+0x9e/0xd0 drivers/tty/tty\_ldisc.c:490

 tty\_ldisc\_kill+0x50/0xc0 drivers/tty/tty\_ldisc.c:639

 tty\_ldisc\_hangup+0x2a6/0x5c0 drivers/tty/tty\_ldisc.c:758

 \_\_tty\_hangup.part.22+0x2e6/0x690 drivers/tty/tty\_io.c:612

 \_\_tty\_hangup drivers/tty/tty\_io.c:570

 tty\_vhangup+0x26/0x30 drivers/tty/tty\_io.c:684

 pty\_close+0x36a/0x4b0 drivers/tty/pty.c:77

 tty\_release+0x44b/0x1520 drivers/tty/tty\_io.c:1638

 \_\_fput+0x33e/0x800 fs/file\_table.c:210

 \_\_\_\_fput+0x1a/0x20 fs/file\_table.c:244

 task\_work\_run+0x1af/0x280 kernel/task\_work.c:112

 tracehook\_notify\_resume ./include/linux/tracehook.h:191

 exit\_to\_usermode\_loop+0x1e1/0x220 arch/x86/entry/common.c:162

 prepare\_exit\_to\_usermode arch/x86/entry/common.c:197

 syscall\_return\_slowpath+0x414/0x480 arch/x86/entry/common.c:266

 entry\_SYSCALL\_64\_fastpath+0xc0/0xc2 arch/x86/entry/entry\_64.S:238

The buggy address belongs to the object at ffff880063ba9a80

 which belongs to the cache kmalloc-64 of size 64

The buggy address is located 20 bytes to the right of

 64-byte region [ffff880063ba9a80, ffff880063ba9ac0)

The buggy address belongs to the page:

page:ffffea00018eea40 count:1 mapcount:0 mapping: (null) index:0x0

flags: 0x100000000000100(slab)

raw: 0100000000000100 0000000000000000 0000000000000000 00000001802a002a

raw: ffffea0001a42280 0000000a0000000a ffff88006c403800 0000000000000000

page dumped because: kasan: bad access detected

Memory state around the buggy address:

 ffff880063ba9980: 00 00 fc fc fc fc fc fc fb fb fb fb fb fb fb fb

 ffff880063ba9a00: fc fc fc fc fb fb fb fb fb fb fb fb fc fc fc fc

>ffff880063ba9a80: fb fb fb fb fb fb fb fb fc fc fc fc fb fb fb fb

 ^

 ffff880063ba9b00: fb fb fb fb fc fc fc fc 00 00 00 00 00 fc fc fc

 ffff880063ba9b80: fc fc fc fc fb fb fb fb fb fb fb fb fc fc fc fc

==================================================================

![Greg Kroah-Hartman's profile photo](//lh3.googleusercontent.com/a-/ALV-UjXv73WOW0a053l58W-UoWI9gGzL2RXXvOpCdkOqBLtuIDXn2ko=s40-c)
### Greg Kroah-Hartman

unread,Sep 21, 2017, 5:10:40 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Andrey Konovalov, Oliver Neukum, Alan Stern, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerOn Thu, Sep 21, 2017 at 05:39:05PM +0200, Andrey Konovalov wrote:

> Hi!

>

> I've got the following report while fuzzing the kernel with syzkaller.

>

> On commit ebb2c2437d8008d46796902ff390653822af6cc4 (Sep 18).

>

> The issue occurs when we iterate over interface altsettings, but I

> don't see the driver doing anything wrong. I might be missing

> something, or this might be an issue in USB core altsettings parsing.

Any chance you happen to have the descriptors that you were feeding into

the kernel at this crash? That might help in figuring out what "went

wrong".

thanks,

greg k-h

![Andrey Konovalov's profile photo](https://lh3.googleusercontent.com/a/default-user=s40-c)
### Andrey Konovalov

unread,Sep 21, 2017, 5:24:24 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Greg Kroah-Hartman, Oliver Neukum, Alan Stern, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerHere's the data that I feed into dummy\_udc:

00 00 00 00 09 02 12 00 01 34 05 80 07 09 04 6e

09 00 08 06 62 00 12 01 05 00 cb f7 71 83 04 00

05 00 ab f6 07 81 08 01

Also attaching a C reproducer (requires dummy\_hcd and gadgetfs) and my .config.

>

> thanks,

>

> greg k-h

uas\_is\_interface-oob-poc.c[](https://groups.google.com/group/syzkaller/attach/36373fec109fd/uas_is_interface-oob-poc.c?part=0.1).config[](https://groups.google.com/group/syzkaller/attach/36373fec109fd/.config?part=0.2)![Alan Stern's profile photo](//lh3.googleusercontent.com/a-/ALV-UjVnOsGo-xXxvfctQ56YYSavPp1EmN5mZVvt52laXUSH8a1akQ=s40-c)
### Alan Stern

unread,Sep 21, 2017, 5:50:33 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Andrey Konovalov, Oliver Neukum, Greg Kroah-Hartman, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerOn Thu, 21 Sep 2017, Andrey Konovalov wrote:

> Hi!

>

> I've got the following report while fuzzing the kernel with syzkaller.

>

> On commit ebb2c2437d8008d46796902ff390653822af6cc4 (Sep 18).

>

> The issue occurs when we iterate over interface altsettings, but I

> don't see the driver doing anything wrong. I might be missing

> something, or this might be an issue in USB core altsettings parsing.

My guess is the latter, although I can't see what is going wrong. Can

you provide the code that does this?

Alan Stern

![Andrey Konovalov's profile photo](https://lh3.googleusercontent.com/a/default-user=s40-c)
### Andrey Konovalov

unread,Sep 21, 2017, 6:16:24 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Alan Stern, Oliver Neukum, Greg Kroah-Hartman, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerI did, see the previous email (replying in case you missed it).

>

> Alan Stern

>

![Alan Stern's profile photo](//lh3.googleusercontent.com/a-/ALV-UjVnOsGo-xXxvfctQ56YYSavPp1EmN5mZVvt52laXUSH8a1akQ=s40-c)
### Alan Stern

unread,Sep 21, 2017, 8:04:07 PM9/21/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Andrey Konovalov, Greg Kroah-Hartman, Oliver Neukum, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerWhy do your reproducers use an mmap'ed array for their data instead of

a plain old statically allocated array?

Anyway, this turns out to be a genuine (and subtle!) bug in the uas

driver. The uas\_find\_uas\_alt\_setting() routine in uas-detect.h returns

a bAlternateSetting value, but then the uas\_use\_uas\_driver() routine

uses this value as an index to the altsetting array -- which it isn't.

Normally this doesn't cause any problems because the the entries in the

array have bAlternateSetting values 0, 1, etc., so the value is equal

to the index. But in your fuzzed case, that wasn't true.

The patch below fixes this bug, by returning a pointer to the

alt-setting entry instead of either the value or the index. Pointers

are less subject to misinterpretation.

Alan Stern

Index: usb-4.x/drivers/usb/storage/uas-detect.h

===================================================================

--- usb-4.x.orig/drivers/usb/storage/uas-detect.h

+++ usb-4.x/drivers/usb/storage/uas-detect.h

@@ -9,7 +9,8 @@ static int uas\_is\_interface(struct usb\_h

 intf->desc.bInterfaceProtocol == USB\_PR\_UAS);

 }

-static int uas\_find\_uas\_alt\_setting(struct usb\_interface \*intf)

+static struct usb\_host\_interface \*uas\_find\_uas\_alt\_setting(

+ struct usb\_interface \*intf)

 {

 int i;

@@ -17,10 +18,10 @@ static int uas\_find\_uas\_alt\_setting(stru

 struct usb\_host\_interface \*alt = &intf->altsetting[i];

 if (uas\_is\_interface(alt))

- return alt->desc.bAlternateSetting;

+ return alt;

 }

- return -ENODEV;

+ return NULL;

 }

 static int uas\_find\_endpoints(struct usb\_host\_interface \*alt,

@@ -58,14 +59,14 @@ static int uas\_use\_uas\_driver(struct usb

 struct usb\_device \*udev = interface\_to\_usbdev(intf);

 struct usb\_hcd \*hcd = bus\_to\_hcd(udev->bus);

 unsigned long flags = id->driver\_info;

- int r, alt;

-

+ struct usb\_host\_interface \*alt;

+ int r;

 alt = uas\_find\_uas\_alt\_setting(intf);

- if (alt < 0)

+ if (!alt)

 return 0;

- r = uas\_find\_endpoints(&intf->altsetting[alt], eps);

+ r = uas\_find\_endpoints(alt, eps);

 if (r < 0)

 return 0;

Index: usb-4.x/drivers/usb/storage/uas.c

===================================================================

--- usb-4.x.orig/drivers/usb/storage/uas.c

+++ usb-4.x/drivers/usb/storage/uas.c

@@ -873,14 +873,14 @@ MODULE\_DEVICE\_TABLE(usb, uas\_usb\_ids);

 static int uas\_switch\_interface(struct usb\_device \*udev,

 struct usb\_interface \*intf)

 {

- int alt;

+ struct usb\_host\_interface \*alt;

 alt = uas\_find\_uas\_alt\_setting(intf);

- if (alt < 0)

- return alt;

+ if (!alt)

+ return -ENODEV;

- return usb\_set\_interface(udev,

- intf->altsetting[0].desc.bInterfaceNumber, alt);

+ return usb\_set\_interface(udev, alt->desc.bInterfaceNumber,

+ alt->desc.bAlternateSetting);

 }

 static int uas\_configure\_endpoints(struct uas\_dev\_info \*devinfo)

![Greg Kroah-Hartman's profile photo](//lh3.googleusercontent.com/a-/ALV-UjXv73WOW0a053l58W-UoWI9gGzL2RXXvOpCdkOqBLtuIDXn2ko=s40-c)
### Greg Kroah-Hartman

unread,Sep 22, 2017, 8:58:07 AM9/22/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Alan Stern, Andrey Konovalov, Oliver Neukum, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerUgh, messy, nice catch and fix, I'll go queue it up now, thanks for

resolving this.

greg k-h

![Greg Kroah-Hartman's profile photo](//lh3.googleusercontent.com/a-/ALV-UjXv73WOW0a053l58W-UoWI9gGzL2RXXvOpCdkOqBLtuIDXn2ko=s40-c)
### Greg Kroah-Hartman

unread,Sep 22, 2017, 9:09:19 AM9/22/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Alan Stern, Andrey Konovalov, Oliver Neukum, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerOops, no, you didn't send this as a "real" patch yet, I'll wait :)

![Andrey Konovalov's profile photo](https://lh3.googleusercontent.com/a/default-user=s40-c)
### Andrey Konovalov

unread,Sep 22, 2017, 12:37:40 PM9/22/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Alan Stern, Greg Kroah-Hartman, Oliver Neukum, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerOn Thu, Sep 21, 2017 at 9:04 PM, Alan Stern <st...@rowland.harvard.edu> wrote:

> On Thu, 21 Sep 2017, Andrey Konovalov wrote:

>

>> On Thu, Sep 21, 2017 at 6:10 PM, Greg Kroah-Hartman

>> <gre...@linuxfoundation.org> wrote:

>> > On Thu, Sep 21, 2017 at 05:39:05PM +0200, Andrey Konovalov wrote:

>> >> Hi!

>> >>

>> >> I've got the following report while fuzzing the kernel with syzkaller.

>> >>

>> >> On commit ebb2c2437d8008d46796902ff390653822af6cc4 (Sep 18).

>> >>

>> >> The issue occurs when we iterate over interface altsettings, but I

>> >> don't see the driver doing anything wrong. I might be missing

>> >> something, or this might be an issue in USB core altsettings parsing.

>> >

>> >

>> > Any chance you happen to have the descriptors that you were feeding into

>> > the kernel at this crash? That might help in figuring out what "went

>> > wrong".

>>

>> Here's the data that I feed into dummy\_udc:

>>

>> 00 00 00 00 09 02 12 00 01 34 05 80 07 09 04 6e

>> 09 00 08 06 62 00 12 01 05 00 cb f7 71 83 04 00

>> 05 00 ab f6 07 81 08 01

>>

>> Also attaching a C reproducer (requires dummy\_hcd and gadgetfs) and my .config.

>

> Why do your reproducers use an mmap'ed array for their data instead of

> a plain old statically allocated array?

That's just the way syzkaller generates reproducers, it uses mmap() to

allocate memory to feed into syscalls.

>

> Anyway, this turns out to be a genuine (and subtle!) bug in the uas

> driver. The uas\_find\_uas\_alt\_setting() routine in uas-detect.h returns

> a bAlternateSetting value, but then the uas\_use\_uas\_driver() routine

> uses this value as an index to the altsetting array -- which it isn't.

>

> Normally this doesn't cause any problems because the the entries in the

> array have bAlternateSetting values 0, 1, etc., so the value is equal

> to the index. But in your fuzzed case, that wasn't true.

>

> The patch below fixes this bug, by returning a pointer to the

> alt-setting entry instead of either the value or the index. Pointers

> are less subject to misinterpretation.

The patch helps, thanks!

Tested-by: Andrey Konovalov <andre...@google.com>

![Alan Stern's profile photo](//lh3.googleusercontent.com/a-/ALV-UjVnOsGo-xXxvfctQ56YYSavPp1EmN5mZVvt52laXUSH8a1akQ=s40-c)
### Alan Stern

unread,Sep 22, 2017, 3:58:37 PM9/22/17Reply to authorSign in to reply to authorForwardSign in to forwardDeleteYou do not have permission to delete messages in this groupCopy linkReport messageShow original messageEither email addresses are anonymous for this group or you need the view member email addresses permission to view the original messageto Greg Kroah-Hartman, Andrey Konovalov, Oliver Neukum, USB list, linux...@vger.kernel.org, usb-s...@lists.one-eyed-alien.net, LKML, Dmitry Vyukov, Kostya Serebryany, syzkallerI was waiting for Andrey to verify that the problem was really gone.

I'll submit it officially later today.

On Fri, 22 Sep 2017, Felipe Balbi wrote:

> > Felipe, any objection for me taking this, and the other gadget driver

> > fixes that Alan just sent out, directly in my tree?

>

> none whatsoever, for all of them:

There's still more to come. I've got four patches for dummy-hcd just

about ready to send. :-)

Alan Stern

Reply allReply to authorForward0 new messages

=== Content from github.com_49277612_20250125_193618.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F786de92b3cb26012d3d0f00ee37adf14527f35c4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F786de92b3cb26012d3d0f00ee37adf14527f35c4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/786de92b3cb26012d3d0f00ee37adf14527f35c4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

USB: uas: fix bug in handling of alternate settings

[Browse files](/torvalds/linux/tree/786de92b3cb26012d3d0f00ee37adf14527f35c4)
Browse the repository at this point in the history

```
The uas driver has a subtle bug in the way it handles alternate
settings.  The uas_find_uas_alt_setting() routine returns an
altsetting value (the bAlternateSetting number in the descriptor), but
uas_use_uas_driver() then treats that value as an index to the
intf->altsetting array, which it isn't.

Normally this doesn't cause any problems because the various
alternate settings have bAlternateSetting values 0, 1, 2, ..., so the
value is equal to the index in the array.  But this is not guaranteed,
and Andrey Konovalov used the syzkaller fuzzer with KASAN to get a
slab-out-of-bounds error by violating this assumption.

This patch fixes the bug by making uas_find_uas_alt_setting() return a
pointer to the altsetting entry rather than either the value or the
index.  Pointers are less subject to misinterpretation.

Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-by: Andrey Konovalov <andreyknvl@google.com>
Tested-by: Andrey Konovalov <andreyknvl@google.com>
CC: Oliver Neukum <oneukum@suse.com>
CC: <stable@vger.kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
```

* Loading branch information

[![@AlanStern](https://avatars.githubusercontent.com/u/28933196?s=40&v=4)](/AlanStern) [![@gregkh](https://avatars.githubusercontent.com/u/14953?s=40&v=4)](/gregkh)

[AlanStern](/torvalds/linux/commits?author=AlanStern "View all commits by AlanStern")
authored and
[gregkh](/torvalds/linux/commits?author=gregkh "View all commits by gregkh")
committed
Sep 22, 2017

1 parent
[113f6eb](/torvalds/linux/commit/113f6eb6d50cfa5e2a1cdcf1678b12661fa272ab)

commit 786de92

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**13 additions**
and
**12 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* drivers/usb/storage

  + drivers/usb/storage/uas-detect.h
    [uas-detect.h](#diff-5bb040bc5646d6804bdbdbfb2d86e3f63d348682b2919985e331d8ec0864eecb)
  + drivers/usb/storage/uas.c
    [uas.c](#diff-82871c5411d0ee7d43ce3e8d5d7baa5aa0b48ebde84c553c1f915ab57104f456)

## There are no files selected for viewing

15 changes: 8 additions & 7 deletions

15
[drivers/usb/storage/uas-detect.h](#diff-5bb040bc5646d6804bdbdbfb2d86e3f63d348682b2919985e331d8ec0864eecb "drivers/usb/storage/uas-detect.h")

Show comments

[View file](/torvalds/linux/blob/786de92b3cb26012d3d0f00ee37adf14527f35c4/drivers/usb/storage/uas-detect.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,18 +9,19 @@ static int uas\_is\_interface(struct usb\_host\_interface \*intf) |
|  |  | intf->desc.bInterfaceProtocol == USB\_PR\_UAS); |
|  |  | } |
|  |  |  |
|  |  | static int uas\_find\_uas\_alt\_setting(struct usb\_interface \*intf) |
|  |  | static struct usb\_host\_interface \*uas\_find\_uas\_alt\_setting( |
|  |  | struct usb\_interface \*intf) |
|  |  | { |
|  |  | int i; |
|  |  |  |
|  |  | for (i = 0; i < intf->num\_altsetting; i++) { |
|  |  | struct usb\_host\_interface \*alt = &intf->altsetting[i]; |
|  |  |  |
|  |  | if (uas\_is\_interface(alt)) |
|  |  | return alt->desc.bAlternateSetting; |
|  |  | return alt; |
|  |  | } |
|  |  |  |
|  |  | return -ENODEV; |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | static int uas\_find\_endpoints(struct usb\_host\_interface \*alt, |
| Expand Down  Expand Up | | @@ -58,14 +59,14 @@ static int uas\_use\_uas\_driver(struct usb\_interface \*intf, |
|  |  | struct usb\_device \*udev = interface\_to\_usbdev(intf); |
|  |  | struct usb\_hcd \*hcd = bus\_to\_hcd(udev->bus); |
|  |  | unsigned long flags = id->driver\_info; |
|  |  | int r, alt; |
|  |  |  |
|  |  | struct usb\_host\_interface \*alt; |
|  |  | int r; |
|  |  |  |
|  |  | alt = uas\_find\_uas\_alt\_setting(intf); |
|  |  | if (alt < 0) |
|  |  | if (!alt) |
|  |  | return 0; |
|  |  |  |
|  |  | r = uas\_find\_endpoints(&intf->altsetting[alt], eps); |
|  |  | r = uas\_find\_endpoints(alt, eps); |
|  |  | if (r < 0) |
|  |  | return 0; |
|  |  |  |
| Expand Down | |  |

10 changes: 5 additions & 5 deletions

10
[drivers/usb/storage/uas.c](#diff-82871c5411d0ee7d43ce3e8d5d7baa5aa0b48ebde84c553c1f915ab57104f456 "drivers/usb/storage/uas.c")

Show comments

[View file](/torvalds/linux/blob/786de92b3cb26012d3d0f00ee37adf14527f35c4/drivers/usb/storage/uas.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -873,14 +873,14 @@ MODULE\_DEVICE\_TABLE(usb, uas\_usb\_ids); |
|  |  | static int uas\_switch\_interface(struct usb\_device \*udev, |
|  |  | struct usb\_interface \*intf) |
|  |  | { |
|  |  | int alt; |
|  |  | struct usb\_host\_interface \*alt; |
|  |  |  |
|  |  | alt = uas\_find\_uas\_alt\_setting(intf); |
|  |  | if (alt < 0) |
|  |  | return alt; |
|  |  | if (!alt) |
|  |  | return -ENODEV; |
|  |  |  |
|  |  | return usb\_set\_interface(udev, |
|  |  | intf->altsetting[0].desc.bInterfaceNumber, alt); |
|  |  | return usb\_set\_interface(udev, alt->desc.bInterfaceNumber, |
|  |  | alt->desc.bAlternateSetting); |
|  |  | } |
|  |  |  |
|  |  | static int uas\_configure\_endpoints(struct uas\_dev\_info \*devinfo) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `786de92`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F786de92b3cb26012d3d0f00ee37adf14527f35c4) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


