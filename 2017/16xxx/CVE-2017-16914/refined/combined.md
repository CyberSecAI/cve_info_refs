=== Content from secuniaresearch.flexerasoftware.com_1e6fc486_20250125_123732.html ===


[Skip to main content](#main-content)
[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

Search

## Main navigation

* Solutions
  + Column 1
    - Business challenge
      * [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
      * [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
      * [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
      * [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
      * [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
      * [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
      * [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
      * [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
      * [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
      * [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
      * [Public sector](https://www.flexera.com/solutions/public-sector)
  + Column 2
    - Spend management by vendor
      * [IBM](https://www.flexera.com/solutions/vendor/ibm)
      * [Oracle](https://www.flexera.com/solutions/vendor/oracle)
      * [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
      * [SAP](https://www.flexera.com/solutions/vendor/sap)
      * [VMware](https://www.flexera.com/solutions/vendor/vmware)
      * [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
      * [AWS](https://www.flexera.com/solutions/vendor/aws)
      * [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
      * [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
      * [Adobe](https://www.flexera.com/solutions/vendor/adobe)

  ### Achieve more through a united FinOps and ITAM function

  The future is hybrid. Break down the walls between ITAM and FinOps to drive more revenue, more customer growth and more innovation.

  [Discover More](https://www.flexera.com/resources/hybrid-itam-finops)
* Products
  + Column 1
    - [Flexera One](https://www.flexera.com/products/flexera-one)
      * [IT Visibility](https://www.flexera.com/products/flexera-one/it-visibility)
      * [ITAM](https://www.flexera.com/products/flexera-one/it-asset-management)
      * [SaaS Management](https://www.flexera.com/products/flexera-one/saas-management)
      * [FinOps](https://www.flexera.com/products/flexera-one/finops)
      * [Technology Intelligence Platform](https://www.flexera.com/products/flexera-one/technology-intelligence-platform)
  + Column 2
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
      * [Snow Spend Optimizer](https://www.flexera.com/products/snow-atlas/snow-spend-optimizer)
      * [Snow SaaS Management](https://www.flexera.com/products/snow-atlas/snow-saas-management)
  + Column 3
    - Hide group
      * [Security](https://www.flexera.com/products/security)
      * [Application Readiness](https://www.flexera.com/products/adminstudio)
      * [All products](https://www.flexera.com/products)
      * [All Snow products](https://www.flexera.com/products/snow)
      * [Integrations](https://www.flexera.com/products/integrations)

  ### Flexera 2024 State of the Cloud Report

  What do transformative initiatives such as GenAI, machine learning and sustainability mean for the cloud? Check out the 2024 State of the Cloud Report to find the answer as well as all the latest cloud computing trends.

  [View Report](https://info.flexera.com/CM-REPORT-State-of-the-Cloud)
* Success
  + Column 1
    - [Customer success](https://www.flexera.com/customer-success)
      * Support
        + [Flexera support portal](https://community.flexera.com/s/support-hub)
        + [Flexera product documentation](https://docs.flexera.com)
        + [Snow product documentation](https://docs.snowsoftware.io/)
      * Services and training
        + [Services](https://www.flexera.com/customer-success/services)
        + [Training](https://www.flexera.com/customer-success/training)
  + Column 2
    - Hide group
      * [Technology Intelligence Awards](https://www.flexera.com/customer-success/awards)
      * [Flexera community](https://community.flexera.com/s/)

  ### Insights from Gartner®

  Find a curated series of actionable and objective insights for IT executives and their teams. Get expert insights from valued analysts, courtesy of Flexera.

  [Discover More](https://www.flexera.com/resources/gartner-analyst-research)
* Resources
  + Column 1
    - [Resources](https://www.flexera.com/resources)
      * [Webinars](https://www.flexera.com/resources?type%5Bwebinar%5D=webinar)
      * [Videos](https://www.flexera.com/resources?type%5Bvideo%5D=video)
      * [Datasheets](https://www.flexera.com/resources?type%5Bdatasheet%5D=datasheet)
      * [White papers & reports](https://www.flexera.com/resources?type%5Bwhite-paper-industry-report%5D=white-paper-industry-report)
  + Column 2
    - Hide group
      * [Blog](/blog/)
      * [Case studies](https://www.flexera.com/resources/case-studies)
      * [Events](https://www.flexera.com/resources?type%5Bevent%5D=event)
      * [Analyst Research](https://www.flexera.com/resources/gartner-analyst-research)
      * [Glossary](https://www.flexera.com/resources/glossary)
      * [Demos & trials](https://www.flexera.com/resources?type%5Bdemo-trials%5D=demo-trials)
      * [Business value calculator](https://www.flexera.com/resources/business-value-calculator)

  ### Flexera 2025 IT Priorities Report

  Insights from Flexera’s 2025 IT Priorities Report highlight what’s top of mind for IT decision makers in the year ahead. Discover the challenges, priorities and opportunities that will shape the future IT landscape.

  [View Report](https://info.flexera.com/ITV-REPORT-IT-Priorities)
* About
  + Column 1
    - [Company](https://www.flexera.com/about-us)
      * [About](https://www.flexera.com/about-us)
      * [Careers](https://www.flexera.com/about-us/careers)
      * [Contact](https://www.flexera.com/about-us/contact-us)
      * [Leadership](https://www.flexera.com/about-us/leadership)
    - [Partners](https://www.flexera.com/about-us/partners)
      * [Partner program](https://www.flexera.com/about-us/partners/partner-program)
      * [Partner directory](https://www.flexera.com/about-us/partners/directory)
  + Column 2
    - [Press center](https://www.flexera.com/about-us/press-center)
      * [Press releases](https://www.flexera.com/about-us/all-press-releases)
      * [Awards](https://www.flexera.com/about-us/press-center#awards)
      * [Articles](https://www.flexera.com/about-us/all-articles)
    - Hide group
      * Social responsibility
        + [ESG](https://www.flexera.com/about-us/environmental-social-governance)
        + [Diversity](https://www.flexera.com/about-us/diversity)

  ### More value with technology intelligence

  The unparalleled synergy of Flexera and Snow provides the Technology Intelligence you need for more efficiency, insight and governance than ever before.

  [Discover More](https://www.flexera.com/more-value-with-technology-intelligence)

Search

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

## External Links

* External Links
  + [Community](https://community.flexera.com/)
  + [Product Access](https://app.flexera.com/login)
  + [Partner Portal](https://flexera.channeltivity.com/Login)

[Book a demo](/about-us/contact-us?C_Interest1=sales)

# Secunia Research

## The world’s best vulnerability intelligence

The Secunia Research team from Flexera provides the most accurate and reliable source of vulnerability intelligence.

[Contact Us](https://www.flexera.com/about-us/contact-us?C_Interest1=sales&C_SolutionInterest=SVM)
Watch video (0:29)

Related links

* [Anatomy of a security advisory](https://www.flexera.com/resources/infographics/anatomy-of-a-security-advisory)
* [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)
* [Software Vulnerability Manager](/products/software-vulnerability-manager)
* [Security advisories from Secunia Research](https://www.flexera.com/products/security/software-vulnerability-advisories)
* [Report a vulnerability](https://www.flexera.com/about-us/contact-us/report-vulnerability)

 ![Secunia Research](/sites/default/files/2022-04/hero-secunia-research-bg.jpg)

Featured Details

## Multiple ways to consume Secunia Research

Secunia delivers software security research that provides reliable, curated and actionable vulnerability intelligence. Organizations can expect to receive standardized, validated and enriched vulnerability research on a specific version of a software product. Secunia Research supports four solutions:

![Software Vulnerability Research](/sites/default/files/2022-04/icon-secunia-research-svr.svg)

### [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)

Software Vulnerability Research utilizes Secunia Research to drive awareness of vulnerabilities matching your specified criteria

[Learn More](https://www.flexera.com/products/software-vulnerability-research)

![Software Vulnerability Manager](/sites/default/files/2022-04/icon-secunia-research-svm.svg)

### [Software Vulnerability Manager](/products/software-vulnerability-manager)

Software Vulnerability Manager uses Secunia Research data to identify, prioritize and patch known vulnerable software detected in your environment

[Learn More](/products/software-vulnerability-manager)

![Data Platform](/sites/default/files/2022-04/icon-secunia-research-dp.svg)

### [Data Platform](https://www.flexera.com/products/data-platform)

Data Platform leverages Secunia Research to provide high-level insights based on major or minor versions of software in your normalized inventory

[Learn More](https://www.flexera.com/products/data-platform)

![Flexera One](/sites/default/files/2022-04/icon-secunia-research-flexera-one.svg)

### [Flexera One](/flexera-one)

Flexera One utilizes Secunia Research (alongside public NVD data) to provide more granular matching of build-level versions of software in your normalized inventory within its IT Asset Management and IT Visibility solutions

[Learn More](/flexera-one)

How it works

## Accurate, reliable vulnerability insights at your fingertips

The Secunia Research team from Flexera is comprised of several security specialists who conduct vulnerability research in various products in addition to testing, verifying and validating public vulnerability reports. Since its inception in 2002, the goal of the Secunia Research team is to provide the most accurate and reliable source of vulnerability intelligence.

Delivering the world’s best vulnerability intelligence requires skill and passion. Team members continually develop their skills exploring various high-profile closed and open-source software using a variety of approaches, focusing chiefly on thorough code audits and binary analysis. The team has received industry recognition, including naming members to [Microsoft’s Most Valuable Security Researchers](https://msrc-blog.microsoft.com/2019/08/07/announcing-2019-msrc-most-valuable-security-researchers/) list.

Secunia researchers discover hard-to-find vulnerabilities that aren’t normally identified with techniques such as fuzzing, and the results have been impressive. Members of the Secunia Research team have discovered critical vulnerabilities in products from vendors including Microsoft, Symantec, IBM, Adobe, RealNetworks, Trend Micro, HP, Blue Coat, Samba, CA, Mozilla and Apple.

The team produces invaluable security advisories based on research of the vulnerabilities affecting any given software update. Sometimes a single update can address multiple vulnerabilities of varying criticalities and threats; but these advisories aggregate and distill findings down to a single advisory perfect for the prioritization of patching efforts within [Software Vulnerability Manager](/products/software-vulnerability-manager). Criticality scores are consistently applied along with details around attack vector and other valuable details within [Software Vulnerability Research](/products/software-vulnerability-research/secunia-research). Illegitimate vulnerability reports are also investigated and rejected so you can focus only on what truly matters.

Informing IT, Transforming IT

## Industry insights to help keep you informed

[#### Webinar

### Stay Ahead of Cyber Threats: Flexera's Latest Vulnerability Insights

Join us for this session where we'll explore the latest findings from the Flexera Monthly Vulnerability Insights Report.](https://info.flexera.com/SVM-WBNR-Vulnerability-Insights-Roundtable)

[#### Webinar

### Dive deeper into the Flexera Annual Vulnerability Insights

We'll explore the key findings from the Flexera Annual Vulnerability Insights Report. Learn about the latest cybersecurity trends, the most targeted industries, the types of vulnerabilities, plus management and mitigation strategies.](https://info.flexera.com/SVM-WBNR-Flexera-Annual-Vulnerability-Insights?lead_source=Website%20Visitor&id=Flexera.com-Resources)

#### Video

### Close the Risk Window with Software Vulnerability Manager

Stop reacting. Gain control. Stay secure. Build a more effective risk mitigation process leveraging Secunia Research vulnerability intelligence and the largest repository of third-party patch data in the industry.

Remote video URL

[#### Trial

### Software Vulnerability Manager Assessment free trial

Get access to the complete set of modules of Software Vulnerability Manager: Research, Assessment and Patching](https://info.flexera.com/SVM-EVAL-Software-Vulnerability-Manager)

[#### Datasheet

### Protect your ServiceNow® investment with the highest quality data

IT Visibility offers certified ServiceNow integrations that accelerate platform expansion, improve ROI and increase efficiencies across ITIL processes by delivering clean software and hardware asset data directly.](/sites/default/files/datasheet-itv-maximize-servicenow-investment.pdf)

[#### Blog

### Avoid missing crucial vulnerability intelligence amid NVD backlog

Recent developments regarding the National Vulnerability Database (NVD) have some technology leaders on edge. Since February, the U.S. National Institute of Standards and Technology (NIST) has almost completely stopped enriching software vulnerabi...](https://www.flexera.com/blog/vulnerability-management/avoid-missing-crucial-vulnerability-intelligence-amid-nvd-backlog/)

[View all resources](https://www.flexera.com/resources?category%5Bsoftware-vulnerability-management%5D=software-vulnerability-management)

## Footer Menu

* Column
  + Business challenge
    - [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
    - [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
    - [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
    - [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
    - [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
    - [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
    - [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
    - [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
    - [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
    - [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
    - [Public sector](https://www.flexera.com/solutions/public-sector)
* Column
  + Spend management by vendor
    - [IBM](https://www.flexera.com/solutions/vendor/ibm)
    - [Oracle](https://www.flexera.com/solutions/vendor/oracle)
    - [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
    - [SAP](https://www.flexera.com/solutions/vendor/sap)
    - [VMware](https://www.flexera.com/solutions/vendor/vmware)
    - [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
    - [AWS](https://www.flexera.com/solutions/vendor/aws)
    - [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
    - [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
    - [Adobe](https://www.flexera.com/solutions/vendor/adobe)
* Column
  + Products
    - [Flexera One](https://www.flexera.com/products/flexera-one)
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
    - [Security](https://www.flexera.com/products/security)
    - [Application Readiness](https://www.flexera.com/products/adminstudio)
    - [All products](https://www.flexera.com/products)
    - [All Snow products](https://www.flexera.com/products/snow)
    - [Integrations](https://www.flexera.com/products/integrations)
* Column
  + Company
    - [About](https://www.flexera.com/about-us)
    - [Careers](https://www.flexera.com/about-us/careers)
    - [Leadership](https://www.flexera.com/about-us/leadership)
    - [Contact us](https://www.flexera.com/about-us/contact-us)
    - [Media / press center](https://www.flexera.com/about-us/press-center)
    - [Revenera.com](https://www.revenera.com)

 +1.800.374.4353

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

 [![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

© 2025 Flexera. All Rights Reserved.

## Footer

* [Privacy Policy](https://www.flexera.com/legal/privacy-policy)
* [Terms and conditions](https://www.flexera.com/legal)
* [Contact Us](https://www.flexera.com/about-us/contact-us)
* [Impressum](https://www.flexera.com/about-us/impressum)
* [Site Map](https://www.flexera.com/sitemap)

#####

×

...



=== Content from cdn.kernel.org_74f7b897_20250125_123721.html ===
commit 96c00ece76be83d99dc7f66fd15e5641524791cf
Author: Greg Kroah-Hartman
Date: Wed Dec 20 10:05:01 2017 +0100
Linux 4.4.107
commit a815c0a370cf9bab9f209e11b954a63b419827ad
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 26c66554d7bf86ca332200e77c3279c9a220bf27
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 112814db6ec47d62943945754cf54fe5067d1a8f
Author: Bart Van Assche
Date: Wed Oct 11 10:48:45 2017 -0700
RDMA/cma: Avoid triggering undefined behavior
[ Upstream commit c0b64f58e8d49570aa9ee55d880f92c20ff0166b ]
According to the C standard the behavior of computations with
integer operands is as follows:
\* A computation involving unsigned operands can never overflow,
because a result that cannot be represented by the resulting
unsigned integer type is reduced modulo the number that is one
greater than the largest value that can be represented by the
resulting type.
\* The behavior for signed integer underflow and overflow is
undefined.
Hence only use unsigned integers when checking for integer
overflow.
This patch is what I came up with after having analyzed the
following smatch warnings:
drivers/infiniband/core/cma.c:3448: cma\_resolve\_ib\_udp() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
drivers/infiniband/core/cma.c:3505: cma\_connect\_ib() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
Signed-off-by: Bart Van Assche
Acked-by: Sean Hefty
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4bbb49138f4ac262389754e0e0fad4b1d809a570
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b8d510ff71651f2058e947c8004cdcb809c15d61
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a114af87c0ba390b0146411f89a2a953ffe3c31f
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 798f085014243bf3239130889f69bb18a71e5a3e
Author: weiping zhang
Date: Thu Oct 12 14:56:44 2017 +0800
scsi: sd: change allow\_restart to bool in sysfs interface
[ Upstream commit 658e9a6dc1126f21fa417cd213e1cdbff8be0ba2 ]
/sys/class/scsi\_disk/0:2:0:0/allow\_restart can be changed to 0
unexpectedly by writing an invalid string such as the following:
echo asdf > /sys/class/scsi\_disk/0:2:0:0/allow\_restart
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c387c02d604d8ff4d422968e5348bb245e443b9e
Author: weiping zhang
Date: Thu Oct 12 14:57:06 2017 +0800
scsi: sd: change manage\_start\_stop to bool in sysfs interface
[ Upstream commit 623401ee33e42cee64d333877892be8db02951eb ]
/sys/class/scsi\_disk/0:2:0:0/manage\_start\_stop can be changed to 0
unexpectly by writing an invalid string.
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2e03af22f65c67c1b0dcb0f98eee9061fe3bc0da
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 930fb06d16171744f3ec3ca23cb3618f27bfd01b
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 24bc48af0aee2e144655b3b1d36a96def03480d0
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 09379498aff08a64e1b7f366145e7e26209501dc
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5f2dbdff20e02e381e557bd9b6dd8111d3b89997
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
commit bd3486ded7a0c313a6575343e6c2b21d14476645 upstream.
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit 68d3bc40f5ca75c2927a9deaf887412976918bf9
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit afa8f0a7af7041665443603ee3c20609733ce940
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28a5b0e438f18bbacc977a38cf47b3d265ac3d27
Author: Martin Wilck
Date: Fri Oct 20 16:51:08 2017 -0500
scsi: hpsa: destroy sas transport properties before scsi\_host
[ Upstream commit dfb2e6f46b3074eb85203d8f0888b71ec1c2e37a ]
This patch cleans up a lot of warnings when unloading the driver.
A current example of the stack trace starts with:
[ 142.570715] sysfs group 'power' not found for kobject 'port-5:0'
There can be hundreds of these messages during a driver unload.
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
His original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102085.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
---------------------------
Original patch description:
---------------------------
Unloading the hpsa driver causes warnings
[ 1063.793652] WARNING: CPU: 1 PID: 4850 at ../fs/sysfs/group.c:237 device\_del+0x54/0x240()
[ 1063.793659] sysfs group ffffffff81cf21a0 not found for kobject 'port-2:0'
with two different stacks:
1)
[ 1063.793774] [] device\_del+0x54/0x240
[ 1063.793780] [] transport\_remove\_classdev+0x4a/0x60
[ 1063.793784] [] attribute\_container\_device\_trigger+0xa6/0xb0
[ 1063.793802] [] sas\_port\_delete+0x126/0x160 [scsi\_transport\_sas]
[ 1063.793819] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
2)
[ 1063.797103] [] device\_del+0x54/0x240
[ 1063.797118] [] sas\_port\_delete+0x12e/0x160 [scsi\_transport\_sas]
[ 1063.797134] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
This is caused by the fact that host device hostX is deleted before the
SAS transport devices hostX/port-a:b.
This patch fixes this by reverting the order of device deletions.
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 942eb7dd5e42702e3743852b151b307f1181fd45
Author: Martin Wilck
Date: Fri Oct 20 16:51:14 2017 -0500
scsi: hpsa: cleanup sas\_phy structures in sysfs when unloading
[ Upstream commit 55ca38b4255bb336c2d35990bdb2b368e19b435a ]
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
The original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102083.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
--------------------------------------
Original patch description from Martin:
--------------------------------------
When the hpsa module is unloaded using rmmod, dangling
symlinks remain under /sys/class/sas\_phy. Fix this by
calling sas\_phy\_delete() rather than sas\_phy\_free (which,
according to comments, should not be called for PHYs that
have been set up successfully, anyway).
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ec662d6560733ea730535069426c2eacec0ff908
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 02922f3bb37f864ec2057ecc42f1d8c1a394b574
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f267a1390b419c46007351fae4eccaf00d204ab9
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 92eff81ad96ad64f26df6c15eb6a734a1a13e8e0
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 230c4ba404d35ca035e76ebb268a1d86187a581b
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2712523730272e74d21fd7720a0f0c8e7b91b24e
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ab9b3db4082872109372c39e4c730778752bd823
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2a5bb1284e72ba1363320284b23b2da9ad72a7d6
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 561b9d998e654801d439529adb7aa09e3a0d33d4
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 083dd685aebd7ed22320a3e02c405a67c5c0cbd0
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f56be2ce49c120f76243be425ec3d9e3ee44ae12
Author: Sébastien Szymanski
Date: Tue Aug 1 12:40:07 2017 +0200
clk: imx6: refine hdmi\_isfr's parent to make HDMI work on i.MX6 SoCs w/o VPU
[ Upstream commit c68ee58d9ee7b856ac722f18f4f26579c8fbd2b4 ]
On i.MX6 SoCs without VPU (in my case MCIMX6D4AVT10AC), the hdmi driver
fails to probe:
[ 2.540030] dwhdmi-imx 120000.hdmi: Unsupported HDMI controller
(0000:00:00)
[ 2.548199] imx-drm display-subsystem: failed to bind 120000.hdmi
(ops dw\_hdmi\_imx\_ops): -19
[ 2.557403] imx-drm display-subsystem: master bind failed: -19
That's because hdmi\_isfr's parent, video\_27m, is not correctly ungated.
As explained in commit 5ccc248cc537 ("ARM: imx6q: clk: Add support for
mipi\_core\_cfg clock as a shared clock gate"), video\_27m is gated by
CCM\_CCGR3[CG8].
On i.MX6 SoCs with VPU, the hdmi is working thanks to the
CCM\_CMEOR[mod\_en\_ov\_vpu] bit which makes the video\_27m ungated whatever
is in CCM\_CCGR3[CG8]. The issue can be reproduced by setting
CCMEOR[mod\_en\_ov\_vpu] to 0.
Make the HDMI work in every case by setting hdmi\_isfr's parent to
mipi\_core\_cfg.
Signed-off-by: Sébastien Szymanski
Reviewed-by: Fabio Estevam
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 22a1e337ed68e1a660f6b1c5fcef76b7c7ac63e1
Author: Chen Zhong
Date: Thu Oct 5 11:50:23 2017 +0800
clk: mediatek: add the option for determining PLL source clock
[ Upstream commit c955bf3998efa3355790a4d8c82874582f1bc727 ]
Since the previous setup always sets the PLL using crystal 26MHz, this
doesn't always happen in every MediaTek platform. So the patch added
flexibility for assigning extra member for determining the PLL source
clock.
Signed-off-by: Chen Zhong
Signed-off-by: Sean Wang
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b59614cfd2d3619eedc1b711ac51efb7636efba6
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 44de70ecec2d9aaf2a0f0c790ae4bba592c6ca3a
Author: Robert Baronescu
Date: Tue Oct 10 13:22:00 2017 +0300
crypto: tcrypt - fix buffer lengths in test\_aead\_speed()
[ Upstream commit 7aacbfcb331ceff3ac43096d563a1f93ed46e35e ]
Fix the way the length of the buffers used for
encryption / decryption are computed.
For e.g. in case of encryption, input buffer does not contain
an authentication tag.
Signed-off-by: Robert Baronescu
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b397507641fb1e4b657dc93c38a9180971af8d8f
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 75ee360a5114a702cda274efb42c4416046e5ab4
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 646191449e769c29f1c01a945491c4ca2005eedf
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e14086b2c9bcc10b54e674078e606b1b0a0a6916
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7d93603ddb655df966e3feee669009ff6f335994
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 09f29c7a953d81344a78516e04de16aecc238a67
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c6c3637ee8ab7cbfd2ca458c5c01b0e2d3d91b79
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 59720463cf28d178321612de38ebc376022c7095
Author: KUWAZAWA Takuya
Date: Sun Oct 15 20:54:10 2017 +0900
netfilter: ipvs: Fix inappropriate output of procfs
[ Upstream commit c5504f724c86ee925e7ffb80aa342cfd57959b13 ]
Information about ipvs in different network namespace can be seen via procfs.
How to reproduce:
# ip netns add ns01
# ip netns add ns02
# ip netns exec ns01 ip a add dev lo 127.0.0.1/8
# ip netns exec ns02 ip a add dev lo 127.0.0.1/8
# ip netns exec ns01 ipvsadm -A -t 10.1.1.1:80
# ip netns exec ns02 ipvsadm -A -t 10.1.1.2:80
The ipvsadm displays information about its own network namespace only.
# ip netns exec ns01 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.1:80 wlc
# ip netns exec ns02 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.2:80 wlc
But I can see information about other network namespace via procfs.
# ip netns exec ns01 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010101:0050 wlc
TCP 0A010102:0050 wlc
# ip netns exec ns02 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010102:0050 wlc
Signed-off-by: KUWAZAWA Takuya
Acked-by: Julian Anastasov
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f46b4bab4e93d035ca0b11c8c1fb2babae41f527
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ef476a74f8edf332adb89d83dbba36c4c2ce77c5
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e6d8207a84b0050df467ec7f5f600f4fef79c0a0
Author: Peter Ujfalusi
Date: Wed Nov 8 12:02:25 2017 +0200
dmaengine: ti-dma-crossbar: Correct am335x/am43xx mux value type
[ Upstream commit 288e7560e4d3e259aa28f8f58a8dfe63627a1bf6 ]
The used 0x1f mask is only valid for am335x family of SoC, different family
using this type of crossbar might have different number of electable
events. In case of am43xx family 0x3f mask should have been used for
example.
Instead of trying to handle each family's mask, just use u8 type to store
the mux value since the event offsets are aligned to byte offset.
Fixes: 42dbdcc6bf965 ("dmaengine: ti-dma-crossbar: Add support for crossbar on AM33xx/AM43xx")
Signed-off-by: Peter Ujfalusi
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 600b973fc56f91a6daf9d640ce3ecd6555875fdb
Author: Philipp Zabel
Date: Tue Nov 7 13:12:17 2017 +0100
rtc: pcf8563: fix output clock rate
[ Upstream commit a3350f9c57ffad569c40f7320b89da1f3061c5bb ]
The pcf8563\_clkout\_recalc\_rate function erroneously ignores the
frequency index read from the CLKO register and always returns
32768 Hz.
Fixes: a39a6405d5f9 ("rtc: pcf8563: add CLKOUT to common clock framework")
Signed-off-by: Philipp Zabel
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ac0468efee605b6a6260223cbac53aea37412615
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 033d20b727f31fe047ea2f314eb0ac3a87df71ce
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 314ce05757950210dea77a043c33ad2bb28c2a42
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2f5427451738a4449b69438e079ad13b405ebfc6
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 57fa76a466731f94b183dadeb97aae05115e5153
Author: Robert Stonehouse
Date: Tue Nov 7 17:30:30 2017 +0000
sfc: don't warn on successful change of MAC
[ Upstream commit cbad52e92ad7f01f0be4ca58bde59462dc1afe3a ]
Fixes: 535a61777f44e ("sfc: suppress handled MCDI failures when changing the MAC address")
Signed-off-by: Bert Kenward
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c9b79738c0ab9c54d95760403cfd17f67f956a45
Author: Mike Christie
Date: Thu Mar 2 04:59:50 2017 -0600
target: fix race during implicit transition work flushes
[ Upstream commit 760bf578edf8122f2503a3a6a3f4b0de3b6ce0bb ]
This fixes the following races:
1. core\_alua\_do\_transition\_tg\_pt could have read
tg\_pt\_gp\_alua\_access\_state and gone into this if chunk:
if (!explicit &&
atomic\_read(&tg\_pt\_gp->tg\_pt\_gp\_alua\_access\_state) ==
ALUA\_ACCESS\_STATE\_TRANSITION) {
and then core\_alua\_do\_transition\_tg\_pt\_work could update the
state. core\_alua\_do\_transition\_tg\_pt would then only set
tg\_pt\_gp\_alua\_pending\_state and the tg\_pt\_gp\_alua\_access\_state would
not get updated with the second calls state.
2. core\_alua\_do\_transition\_tg\_pt could be setting
tg\_pt\_gp\_transition\_complete while the tg\_pt\_gp\_transition\_work
is already completing. core\_alua\_do\_transition\_tg\_pt then waits on the
completion that will never be called.
To handle these issues, we just call flush\_work which will return when
core\_alua\_do\_transition\_tg\_pt\_work has completed so there is no need
to do the complete/wait. And, if core\_alua\_do\_transition\_tg\_pt\_work
was running, instead of trying to sneak in the state change, we just
schedule up another core\_alua\_do\_transition\_tg\_pt\_work call.
Note that this does not handle a possible race where there are multiple
threads call core\_alua\_do\_transition\_tg\_pt at the same time. I think
we need a mutex in target\_tg\_pt\_gp\_alua\_access\_state\_store.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dfd6deed831348fc8d6cb3efca1c68c3d5b195c7
Author: Mike Christie
Date: Thu Mar 2 04:59:48 2017 -0600
target: fix ALUA transition timeout handling
[ Upstream commit d7175373f2745ed4abe5b388d5aabd06304f801e ]
The implicit transition time tells initiators the min time
to wait before timing out a transition. We currently schedule
the transition to occur in tg\_pt\_gp\_implicit\_trans\_secs
seconds so there is no room for delays. If
core\_alua\_do\_transition\_tg\_pt\_work->core\_alua\_update\_tpg\_primary\_metadata
needs to write out info to a remote file, then the initiator can
easily time out the operation.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7f5084b98f8990317e13f6fe42238684896842f0
Author: Mike Christie
Date: Wed Mar 1 23:13:26 2017 -0600
target: Use system workqueue for ALUA transitions
[ Upstream commit 207ee84133c00a8a2a5bdec94df4a5b37d78881c ]
If tcmu-runner is processing a STPG and needs to change the kernel's
ALUA state then we cannot use the same work queue for task management
requests and ALUA transitions, because we could deadlock. The problem
occurs when a STPG times out before tcmu-runner is able to
call into target\_tg\_pt\_gp\_alua\_access\_state\_store->
core\_alua\_do\_port\_transition -> core\_alua\_do\_transition\_tg\_pt ->
queue\_work. In this case, the tmr is on the work queue waiting for
the STPG to complete, but the STPG transition is now queued behind
the waiting tmr.
Note:
This bug will also be fixed by this patch:
http://www.spinics.net/lists/target-devel/msg14560.html
which switches the tmr code to use the system workqueues.
For both, I am not sure if we need a dedicated workqueue since
it is not a performance path and I do not think we need WQ\_MEM\_RECLAIM
to make forward progress to free up memory like the block layer does.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9b4a2e04c22969d474394df0f882411ddfa3cd7
Author: Zygo Blaxell
Date: Fri Mar 10 16:45:44 2017 -0500
btrfs: add missing memset while reading compressed inline extents
[ Upstream commit e1699d2d7bf6e6cce3e1baff19f9dd4595a58664 ]
This is a story about 4 distinct (and very old) btrfs bugs.
Commit c8b978188c ("Btrfs: Add zlib compression support") added
three data corruption bugs for inline extents (bugs #1-3).
Commit 93c82d5750 ("Btrfs: zero page past end of inline file items")
fixed bug #1: uncompressed inline extents followed by a hole and more
extents could get non-zero data in the hole as they were read. The fix
was to add a memset in btrfs\_get\_extent to zero out the hole.
Commit 166ae5a418 ("btrfs: fix inline compressed read err corruption")
fixed bug #2: compressed inline extents which contained non-zero bytes
might be replaced with zero bytes in some cases. This patch removed an
unhelpful memset from uncompress\_inline, but the case where memset is
required was missed.
There is also a memset in the decompression code, but this only covers
decompressed data that is shorter than the ram\_bytes from the extent
ref record. This memset doesn't cover the region between the end of the
decompressed data and the end of the page. It has also moved around a
few times over the years, so there's no single patch to refer to.
This patch fixes bug #3: compressed inline extents followed by a hole
and more extents could get non-zero data in the hole as they were read
(i.e. bug #3 is the same as bug #1, but s/uncompressed/compressed/).
The fix is the same: zero out the hole in the compressed case too,
by putting a memset back in uncompress\_inline, but this time with
correct parameters.
The last and oldest bug, bug #0, is the cause of the offending inline
extent/hole/extent pattern. Bug #0 is a subtle and mostly-harmless quirk
of behavior somewhere in the btrfs write code. In a few special cases,
an inline extent and hole are allowed to persist where they normally
would be combined with later extents in the file.
A fast reproducer for bug #0 is presented below. A few offending extents
are also created in the wild during large rsync transfers with the -S
flag. A Linux kernel build (git checkout; make allyesconfig; make -j8)
will produce a handful of offending files as well. Once an offending
file is created, it can present different content to userspace each
time it is read.
Bug #0 is at least 4 and possibly 8 years old. I verified every vX.Y
kernel back to v3.5 has this behavior. There are fossil records of this
bug's effects in commits all the way back to v2.6.32. I have no reason
to believe bug #0 wasn't present at the beginning of btrfs compression
support in v2.6.29, but I can't easily test kernels that old to be sure.
It is not clear whether bug #0 is worth fixing. A fix would likely
require injecting extra reads into currently write-only paths, and most
of the exceptional cases caused by bug #0 are already handled now.
Whether we like them or not, bug #0's inline extents followed by holes
are part of the btrfs de-facto disk format now, and we need to be able
to read them without data corruption or an infoleak. So enough about
bug #0, let's get back to bug #3 (this patch).
An example of on-disk structure leading to data corruption found in
the wild:
item 61 key (606890 INODE\_ITEM 0) itemoff 9662 itemsize 160
inode generation 50 transid 50 size 47424 nbytes 49141
block group 0 mode 100644 links 1 uid 0 gid 0
rdev 0 flags 0x0(none)
item 62 key (606890 INODE\_REF 603050) itemoff 9642 itemsize 20
inode ref index 3 namelen 10 name: DB\_File.so
item 63 key (606890 EXTENT\_DATA 0) itemoff 8280 itemsize 1362
inline extent data size 1341 ram 4085 compress(zlib)
item 64 key (606890 EXTENT\_DATA 4096) itemoff 8227 itemsize 53
extent data disk byte 5367308288 nr 20480
extent data offset 0 nr 45056 ram 45056
extent compression(zlib)
Different data appears in userspace during each read of the 11 bytes
between 4085 and 4096. The extent in item 63 is not long enough to
fill the first page of the file, so a memset is required to fill the
space between item 63 (ending at 4085) and item 64 (beginning at 4096)
with zero.
Here is a reproducer from Liu Bo, which demonstrates another method
of creating the same inline extent and hole pattern:
Using 'page\_poison=on' kernel command line (or enable
CONFIG\_PAGE\_POISONING) run the following:
# touch foo
# chattr +c foo
# xfs\_io -f -c "pwrite -W 0 1000" foo
# xfs\_io -f -c "falloc 4 8188" foo
# od -x foo
# echo 3 >/proc/sys/vm/drop\_caches
# od -x foo
This produce the following on my box:
Correct output: file contains 1000 data bytes followed
by zeros:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 0000 0000 0000 0000
0001760 0000 0000 0000 0000 0000 0000 0000 0000
\*
0020000
Actual output: the data after the first 1000 bytes
will be different each run:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 6c63 7400 635f 006d
0001760 5f74 6f43 7400 435f 0053 5f74 7363 7400
0002000 435f 0056 5f74 6164 7400 645f 0062 5f74
(...)
Signed-off-by: Zygo Blaxell
Reviewed-by: Liu Bo
Reviewed-by: Chris Mason
Signed-off-by: Chris Mason
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 248aa3accad95cb1e381188bb41beceb7a4ac49e
Author: Olga Kornievskaia
Date: Wed Mar 8 14:39:15 2017 -0500
NFSv4.1 respect server's max size in CREATE\_SESSION
[ Upstream commit 033853325fe3bdc70819a8b97915bd3bca41d3af ]
Currently client doesn't respect max sizes server returns in CREATE\_SESSION.
nfs4\_session\_set\_rwsize() gets called and server->rsize, server->wsize are 0
so they never get set to the sizes returned by the server.
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a49aa7aadbd36395d3463bcadcdf187477c048ad
Author: Daniel Drake
Date: Tue Feb 7 13:08:23 2017 -0600
efi/esrt: Cleanup bad memory map log messages
[ Upstream commit 822f5845f710e57d7e2df1fd1ee00d6e19d334fe ]
The Intel Compute Stick STCK1A8LFC and Weibu F3C platforms both
log 2 error messages during boot:
efi: requested map not found.
esrt: ESRT header is not in the memory map.
Searching the web, this seems to affect many other platforms too.
Since these messages are logged as errors, they appear on-screen during
the boot process even when using the "quiet" boot parameter used by
distros.
Demote the ESRT error to a warning so that it does not appear on-screen,
and delete the error logging from efi\_mem\_desc\_lookup; both callsites
of that function log more specific messages upon failure.
Out of curiosity I looked closer at the Weibu F3C. There is no entry in
the UEFI-provided memory map which corresponds to the ESRT pointer, but
hacking the code to map it anyway, the ESRT does appear to be valid with
2 entries.
Signed-off-by: Daniel Drake
Cc: Matt Fleming
Acked-by: Peter Jones
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dc81417eedf55a92503b718ecd7b5b356a2c7d97
Author: Daniel Borkmann
Date: Wed Mar 15 22:53:37 2017 +0100
perf symbols: Fix symbols\_\_fixup\_end heuristic for corner cases
[ Upstream commit e7ede72a6d40cb3a30c087142d79381ca8a31dab ]
The current symbols\_\_fixup\_end() heuristic for the last entry in the rb
tree is suboptimal as it leads to not being able to recognize the symbol
in the call graph in a couple of corner cases, for example:
i) If the symbol has a start address (f.e. exposed via kallsyms)
that is at a page boundary, then the roundup(curr->start, 4096)
for the last entry will result in curr->start == curr->end with
a symbol length of zero.
ii) If the symbol has a start address that is shortly before a page
boundary, then also here, curr->end - curr->start will just be
very few bytes, where it's unrealistic that we could perform a
match against.
Instead, change the heuristic to roundup(curr->start, 4096) + 4096, so
that we can catch such corner cases and have a better chance to find
that specific symbol. It's still just best effort as the real end of the
symbol is unknown to us (and could even be at a larger offset than the
current range), but better than the current situation.
Alexei reported that he recently run into case i) with a JITed eBPF
program (these are all page aligned) as the last symbol which wasn't
properly shown in the call graph (while other eBPF program symbols in
the rb tree were displayed correctly). Since this is a generic issue,
lets try to improve the heuristic a bit.
Reported-and-Tested-by: Alexei Starovoitov
Signed-off-by: Daniel Borkmann
Fixes: 2e538c4a1847 ("perf tools: Improve kernel/modules symbol lookup")
Link: http://lkml.kernel.org/r/bb5c80d27743be6f12afc68405f1956a330e1bc9.1489614365.git.daniel@iogearbox.net
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit acc7d1bd901cde5acc6891ebc6be6cfc614fb868
Author: Jack Morgenstein
Date: Mon Mar 13 19:29:08 2017 +0200
net/mlx4\_core: Avoid delays during VF driver device shutdown
[ Upstream commit 4cbe4dac82e423ecc9a0ba46af24a860853259f4 ]
Some Hypervisors detach VFs from VMs by instantly causing an FLR event
to be generated for a VF.
In the mlx4 case, this will cause that VF's comm channel to be disabled
before the VM has an opportunity to invoke the VF device's "shutdown"
method.
For such Hypervisors, there is a race condition between the VF's
shutdown method and its internal-error detection/reset thread.
The internal-error detection/reset thread (which runs every 5 seconds) also
detects a disabled comm channel. If the internal-error detection/reset
flow wins the race, we still get delays (while that flow tries repeatedly
to detect comm-channel recovery).
The cited commit fixed the command timeout problem when the
internal-error detection/reset flow loses the race.
This commit avoids the unneeded delays when the internal-error
detection/reset flow wins.
Fixes: d585df1c5ccf ("net/mlx4\_core: Avoid command timeouts during VF driver device shutdown")
Signed-off-by: Jack Morgenstein
Reported-by: Simon Xiao
Signed-off-by: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5e469e44c8fd338183ea08adb143bb6e9a645ff1
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix afs\_kill\_pages()
[ Upstream commit 7286a35e893176169b09715096a4aca557e2ccd2 ]
Fix afs\_kill\_pages() in two ways:
(1) If a writeback has been partially flushed, then if we try and kill the
pages it contains, some of them may no longer be undergoing writeback
and end\_page\_writeback() will assert.
Fix this by checking to see whether the page in question is actually
undergoing writeback before ending that writeback.
(2) The loop that scans for pages to kill doesn't increase the first page
index, and so the loop may not terminate, but it will try to process
the same pages over and over again.
Fix this by increasing the first page index to one after the last page
we processed.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 80f74cef482f3ea77f918eeb739e588aeaeb20f9
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix page leak in afs\_write\_begin()
[ Upstream commit 6d06b0d25209c80e99c1e89700f1e09694a3766b ]
afs\_write\_begin() leaks a ref and a lock on a page if afs\_fill\_page()
fails. Fix the leak by unlocking and releasing the page in the error path.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c58d7796ab9329241d54c143658132980ad536a5
Author: Marc Dionne
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Populate and use client modification time
[ Upstream commit ab94f5d0dd6fd82e7eeca5e7c8096eaea0a0261f ]
The inode timestamps should be set from the client time
in the status received from the server, rather than the
server time which is meant for internal server use.
Set AFS\_SET\_MTIME and populate the mtime for operations
that take an input status, such as file/dir creation
and StoreData. If an input time is not provided the
server will set the vnode times based on the current server
time.
In a situation where the server has some skew with the
client, this could lead to the client seeing a timestamp
in the future for a file that it just created or wrote.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fa034538cb041dd79eba2affd76c232eb7aefa2c
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Fix the maths in afs\_fs\_store\_data()
[ Upstream commit 146a1192783697810b63a1e41c4d59fc93387340 ]
afs\_fs\_store\_data() works out of the size of the write it's going to make,
but it uses 32-bit unsigned subtraction in one place that gets
automatically cast to loff\_t.
However, if to < offset, then the number goes negative, but as the result
isn't signed, this doesn't get sign-extended to 64-bits when placed in a
loff\_t.
Fix by casting the operands to loff\_t.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1efae6ca3418855d3106aef4d763bf2f29b4c04d
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Prevent callback expiry timer overflow
[ Upstream commit 56e714312e7dbd6bb83b2f78d3ec19a404c7649f ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs\_vnode record to use ktime\_get\_real\_seconds() instead, for the
fields cb\_expires and cb\_expires\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 43e68e3725df183ec3b3eeb0207d6265a96477d2
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Migrate vlocation fields to 64-bit
[ Upstream commit 8a79790bf0b7da216627ffb85f52cfb4adbf1e4e ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs's vlocation record to use ktime\_get\_real\_seconds() instead, for the
fields time\_of\_death and update\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9d8d20570f39fd38a78333ea2404250041288f43
Author: David Howells
Date: Thu Mar 16 16:27:45 2017 +0000
afs: Flush outstanding writes when an fd is closed
[ Upstream commit 58fed94dfb17e89556b5705f20f90e5b2971b6a1 ]
Flush outstanding writes in afs when an fd is closed. This is what NFS and
CIFS do.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 549d7b98f55e61aa30b2db241509f43265c7175e
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Adjust mode bits processing
[ Upstream commit 627f46943ff90bcc32ddeb675d881c043c6fa2ae ]
Mode bits for an afs file should not be enforced in the usual
way.
For files, the absence of user bits can restrict file access
with respect to what is granted by the server.
These bits apply regardless of the owner or the current uid; the
rest of the mode bits (group, other) are ignored.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bb7a7cd6194f9d1f789ce4f83a086024bc93941f
Author: Marc Dionne
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Populate group ID from vnode status
[ Upstream commit 6186f0788b31f44affceeedc7b48eb10faea120d ]
The group was hard coded to GLOBAL\_ROOT\_GID; use the group
ID that was received from the server.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1c277e9ebba6ee648b70e4dc4794e67c3d2d80cd
Author: David Howells
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Fix missing put\_page()
[ Upstream commit 29c8bbbd6e21daa0997d1c3ee886b897ee7ad652 ]
In afs\_writepages\_region(), inside the loop where we find dirty pages to
deal with, one of the if-statements is missing a put\_page().
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fec8348008b5b7ab934b1553e34dfff37a03ade2
Author: Alex Deucher
Date: Wed Mar 15 21:11:46 2017 -0400
drm/radeon: reinstate oland workaround for sclk
[ Upstream commit 66822d815ae61ecb2d9dba9031517e8a8476969d ]
Higher sclks seem to be unstable on some boards.
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=100222
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6a51e93b2fe340708110899605fa36877db4c29c
Author: yong mao
Date: Sat Mar 4 15:10:03 2017 +0800
mmc: mediatek: Fixed bug where clock frequency could be set wrong
[ Upstream commit 40ceda09c8c84694c2ca6b00bcc6dc71e8e62d96 ]
This patch can fix two issues:
Issue 1:
In previous code, div may be overflow when setting clock frequency
as f\_min. We can use DIV\_ROUND\_UP to fix this boundary related
issue.
Issue 2:
In previous code, we can not set the correct clock frequency when
div equals 0xff.
Signed-off-by: Yong Mao
Signed-off-by: Chaotian Jing
Reviewed-by: Daniel Kurtz
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 51b3eac39a6ce8e90b1faad510f8fdaed2805b62
Author: Steven Rostedt (VMware)
Date: Thu Mar 2 15:10:59 2017 +0100
sched/deadline: Use deadline instead of period when calculating overflow
[ Upstream commit 2317d5f1c34913bac5971d93d69fb6c31bb74670 ]
I was testing Daniel's changes with his test case, and tweaked it a
little. Instead of having the runtime equal to the deadline, I
increased the deadline ten fold.
Daniel's test case had:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
To make it more interesting, I changed it to:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 20 \* 1000 \* 1000; /\* 20 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
The results were rather surprising. The behavior that Daniel's patch
was fixing came back. The task started using much more than .1% of the
CPU. More like 20%.
Looking into this I found that it was due to the dl\_entity\_overflow()
constantly returning true. That's because it uses the relative period
against relative runtime vs the absolute deadline against absolute
runtime.
runtime / (deadline - t) > dl\_runtime / dl\_period
There's even a comment mentioning this, and saying that when relative
deadline equals relative period, that the equation is the same as using
deadline instead of period. That comment is backwards! What we really
want is:
runtime / (deadline - t) > dl\_runtime / dl\_deadline
We care about if the runtime can make its deadline, not its period. And
then we can say "when the deadline equals the period, the equation is
the same as using dl\_period instead of dl\_deadline".
After correcting this, now when the task gets enqueued, it can throttle
correctly, and Daniel's fix to the throttling of sleeping deadline
tasks works even when the runtime and deadline are not the same.
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Daniel Bristot de Oliveira
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/02135a27f1ae3fe5fd032568a5a2f370e190e8d7.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ca91884bcf7de730344ab13cbcaf4279e7fe38a7
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:58 2017 +0100
sched/deadline: Throttle a constrained deadline task activated after the deadline
[ Upstream commit df8eac8cafce7d086be3bd5cf5a838fa37594dfb ]
During the activation, CBS checks if it can reuse the current task's
runtime and period. If the deadline of the task is in the past, CBS
cannot use the runtime, and so it replenishes the task. This rule
works fine for implicit deadline tasks (deadline == period), and the
CBS was designed for implicit deadline tasks. However, a task with
constrained deadline (deadine < period) might be awakened after the
deadline, but before the next period. In this case, replenishing the
task would allow it to run for runtime / deadline. As in this case
deadline < period, CBS enables a task to run for more than the
runtime / period. In a very loaded system, this can cause a domino
effect, making other tasks miss their deadlines.
To avoid this problem, in the activation of a constrained deadline
task after the deadline but before the next period, throttle the
task and set the replenishing timer to the begin of the next period,
unless it is boosted.
Reproducer:
--------------- %< ---------------
int main (int argc, char \*\*argv)
{
int ret;
int flags = 0;
unsigned long l = 0;
struct timespec ts;
struct sched\_attr attr;
memset(&attr, 0, sizeof(attr));
attr.size = sizeof(attr);
attr.sched\_policy = SCHED\_DEADLINE;
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
ts.tv\_sec = 0;
ts.tv\_nsec = 2000 \* 1000; /\* 2 ms \*/
ret = sched\_setattr(0, &attr, flags);
if (ret < 0) {
perror("sched\_setattr");
exit(-1);
}
for(;;) {
/\* XXX: you may need to adjust the loop \*/
for (l = 0; l < 150000; l++);
/\*
\* The ideia is to go to sleep right before the deadline
\* and then wake up before the next period to receive
\* a new replenishment.
\*/
nanosleep(&ts, NULL);
}
exit(0);
}
--------------- >% ---------------
On my box, this reproducer uses almost 50% of the CPU time, which is
obviously wrong for a task with 2/2000 reservation.
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/edf58354e01db46bf42df8d2dd32418833f68c89.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cd0e18d2f24b58f0793f3c7af2d75def1daec8a2
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:57 2017 +0100
sched/deadline: Make sure the replenishment timer fires in the next period
[ Upstream commit 5ac69d37784b237707a7b15d199cdb6c6fdb6780 ]
Currently, the replenishment timer is set to fire at the deadline
of a task. Although that works for implicit deadline tasks because the
deadline is equals to the begin of the next period, that is not correct
for constrained deadline tasks (deadline < period).
For instance:
f.c:
--------------- %< ---------------
int main (void)
{
for(;;);
}
--------------- >% ---------------
# gcc -o f f.c
# trace-cmd record -e sched:sched\_switch \
-e syscalls:sys\_exit\_sched\_setattr \
chrt -d --sched-runtime 490000000 \
--sched-deadline 500000000 \
--sched-period 1000000000 0 ./f
# trace-cmd report | grep "{pid of ./f}"
After setting parameters, the task is replenished and continue running
until being throttled:
f-11295 [003] 13322.113776: sys\_exit\_sched\_setattr: 0x0
The task is throttled after running 492318 ms, as expected:
f-11295 [003] 13322.606094: sched\_switch: f:11295 [-1] R ==> watchdog/3:32 [0]
But then, the task is replenished 500719 ms after the first
replenishment:
-0 [003] 13322.614495: sched\_switch: swapper/3:0 [120] R ==> f:11295 [-1]
Running for 490277 ms:
f-11295 [003] 13323.104772: sched\_switch: f:11295 [-1] R ==> swapper/3:0 [120]
Hence, in the first period, the task runs 2 \* runtime, and that is a bug.
During the first replenishment, the next deadline is set one period away.
So the runtime / period starts to be respected. However, as the second
replenishment took place in the wrong instant, the next replenishment
will also be held in a wrong instant of time. Rather than occurring in
the nth period away from the first activation, it is taking place
in the (nth period - relative deadline).
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Luca Abeni
Reviewed-by: Steven Rostedt (VMware)
Reviewed-by: Juri Lelli
Cc: Linus Torvalds
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/ac50d89887c25285b47465638354b63362f8adff.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c6567f5af9ab46754befb953761135b37b249f5
Author: Alex Deucher
Date: Tue Mar 14 14:42:03 2017 -0400
drm/radeon/si: add dpm quirk for Oland
[ Upstream commit 0f424de1fd9bc4ab24bd1fe5430ab5618e803e31 ]
OLAND 0x1002:0x6604 0x1028:0x066F 0x00 seems to have problems
with higher sclks.
Acked-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c383ebf1acd6e30fb6b93078d5c0b20c1769a907
Author: Taku Izumi
Date: Wed Mar 15 13:47:50 2017 +0900
fjes: Fix wrong netdevice feature flags
[ Upstream commit fe8daf5fa715f7214952f06a387e4b7de818c5be ]
This patch fixes netdev->features for Extended Socket network device.
Currently Extended Socket network device's netdev->feature claims
NETIF\_F\_HW\_CSUM, however this is completely wrong. There's no feature
of checksum offloading.
That causes invalid TCP/UDP checksum and packet rejection when IP
forwarding from Extended Socket network device to other network device.
NETIF\_F\_HW\_CSUM should be omitted.
Signed-off-by: Taku Izumi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a33a9d0c705fefb20a937708314aad65e09da110
Author: Don Brace
Date: Fri Mar 10 14:35:17 2017 -0600
scsi: hpsa: limit outstanding rescans
[ Upstream commit 87b9e6aa87d9411f1059aa245c0c79976bc557ac ]
Avoid rescan storms. No need to queue another if one is pending.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0a609298214bed0db80da031e9193b2c39a96c3b
Author: Don Brace
Date: Fri Mar 10 14:35:11 2017 -0600
scsi: hpsa: update check for logical volume status
[ Upstream commit 85b29008d8af6d94a0723aaa8d93cfb6e041158b ]
- Add in a new case for volume offline. Resolves internal testing bug
for multilun array management.
- Return correct status for failed TURs.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b0def6f1e26b4b3a53865f9e34d95f6cd460a22a
Author: Stafford Horne
Date: Mon Mar 13 07:44:45 2017 +0900
openrisc: fix issue handling 8 byte get\_user calls
[ Upstream commit 154e67cd8e8f964809d0e75e44bb121b169c75b3 ]
Was getting the following error with allmodconfig:
ERROR: "\_\_get\_user\_bad" [lib/test\_user\_copy.ko] undefined!
This was simply a missing break statement, causing an unwanted fall
through.
Signed-off-by: Stafford Horne
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1236cc3664dc6b5ad9fe5175ef2c033bb25c5102
Author: Alexander Shishkin
Date: Thu Jun 30 16:10:51 2016 +0300
intel\_th: pci: Add Gemini Lake support
[ Upstream commit 340837f985c2cb87ca0868d4aa9ce42b0fab3a21 ]
This adds Intel(R) Trace Hub PCI ID for Gemini Lake SOC.
Signed-off-by: Alexander Shishkin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d270d24ee59682db2d84fabc5ee12ff7c75ed43e
Author: Jiri Pirko
Date: Tue Mar 14 14:00:01 2017 +0100
mlxsw: reg: Fix SPVMLR max record count
[ Upstream commit e9093b1183bbac462d2caef3eac165778c0b1bf1 ]
The num\_rec field is 8 bit, so the maximal count number is 255.
This fixes vlans learning not being enabled for wider ranges than 255.
Fixes: a4feea74cd7a ("mlxsw: reg: Add Switch Port VLAN MAC Learning register definition")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e934e13550a0803fae96167515d34a96797edcbd
Author: Jiri Pirko
Date: Tue Mar 14 14:00:00 2017 +0100
mlxsw: reg: Fix SPVM max record count
[ Upstream commit f004ec065b4879d6bc9ba0211af2169b3ce3097f ]
The num\_rec field is 8 bit, so the maximal count number is 255. This
fixes vlans not being enabled for wider ranges than 255.
Fixes: b2e345f9a454 ("mlxsw: reg: Add Switch Port VID and Switch Port VLAN Membership registers definitions")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 677a7aac2ec61af2f8cf6d4ebb59c7a7671bf320
Author: Vlad Yasevich
Date: Tue Mar 14 08:58:08 2017 -0400
net: Resend IGMP memberships upon peer notification.
[ Upstream commit 37c343b4f4e70e9dc328ab04903c0ec8d154c1a4 ]
When we notify peers of potential changes, it's also good to update
IGMP memberships. For example, during VM migration, updating IGMP
memberships will redirect existing multicast streams to the VM at the
new location.
Signed-off-by: Vladislav Yasevich
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 26af6a8b51f110a4c3b69156a1d9886bbccffabf
Author: Matthias Kaehlcke
Date: Mon Mar 13 14:30:29 2017 -0700
dmaengine: Fix array index out of bounds warning in \_\_get\_unmap\_pool()
[ Upstream commit 23f963e91fd81f44f6b316b1c24db563354c6be8 ]
This fixes the following warning when building with clang and
CONFIG\_DMA\_ENGINE\_RAID=n :
drivers/dma/dmaengine.c:1102:11: error: array index 2 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[2];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
^
drivers/dma/dmaengine.c:1104:11: error: array index 3 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[3];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Dan Williams
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cd4b8684621ae667af599db2d3f3062f37c47dd
Author: Johan Hovold
Date: Mon Mar 13 13:42:03 2017 +0100
net: wimax/i2400m: fix NULL-deref at probe
[ Upstream commit 6e526fdff7be4f13b24f929a04c0e9ae6761291e ]
Make sure to check the number of endpoints to avoid dereferencing a
NULL-pointer or accessing memory beyond the endpoint array should a
malicious device lack the expected endpoints.
The endpoints are specifically dereferenced in the i2400m\_bootrom\_init
path during probe (e.g. in i2400mu\_tx\_bulk\_out).
Fixes: f398e4240fce ("i2400m/USB: probe/disconnect, dev init/shutdown
and reset backends")
Cc: Inaky Perez-Gonzalez
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b424289863d09900643c8e2dd6fa53a465895258
Author: Tahsin Erdogan
Date: Fri Mar 10 12:09:49 2017 -0800
writeback: fix memory leak in wb\_queue\_work()
[ Upstream commit 4a3a485b1ed0e109718cc8c9d094fa0f552de9b2 ]
When WB\_registered flag is not set, wb\_queue\_work() skips queuing the
work, but does not perform the necessary clean up. In particular, if
work->auto\_free is true, it should free the memory.
The leak condition can be reprouced by following these steps:
mount /dev/sdb /mnt/sdb
/\* In qemu console: device\_del sdb \*/
umount /dev/sdb
Above will result in a wb\_queue\_work() call on an unregistered wb and
thus leak memory.
Reported-by: John Sperbeck
Signed-off-by: Tahsin Erdogan
Reviewed-by: Jan Kara
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fbdf477fcff6b16869665cbf7a38c1b6dbfe0d8a
Author: Florian Westphal
Date: Thu Mar 9 23:22:30 2017 +0100
netfilter: bridge: honor frag\_max\_size when refragmenting
[ Upstream commit 4ca60d08cbe65f501baad64af50fceba79c19fbb ]
consider a bridge with mtu 9000, but end host sending smaller
packets to another host with mtu < 9000.
In this case, after reassembly, bridge+defrag would refragment,
and then attempt to send the reassembled packet as long as it
was below 9k.
Instead we have to cap by the largest fragment size seen.
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7edb2d2d86808c05ea75f4269c41bcc775988b08
Author: Tomi Valkeinen
Date: Tue Feb 28 10:11:45 2017 +0200
drm/omap: fix dmabuf mmap for dma\_alloc'ed buffers
[ Upstream commit 9fa1d7537242bd580ffa99c4725a0407096aad26 ]
omap\_gem\_dmabuf\_mmap() returns an error (with a WARN) when called for a
buffer which is allocated with dma\_alloc\_\*(). This prevents dmabuf mmap
from working on SoCs without DMM, e.g. AM4 and OMAP3.
I could not find any reason for omap\_gem\_dmabuf\_mmap() rejecting such
buffers, and just removing the if() fixes the limitation.
Signed-off-by: Tomi Valkeinen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dbfba339c729fa1fc355166b1b77b0a81a4e07ee
Author: Dmitry Torokhov
Date: Tue Feb 28 17:14:41 2017 -0800
Input: i8042 - add TUXEDO BU1406 (N24\_25BU) to the nomux list
[ Upstream commit a4c2a13129f7c5bcf81704c06851601593303fd5 ]
TUXEDO BU1406 does not implement active multiplexing mode properly,
and takes around 550 ms in i8042\_set\_mux\_mode(). Given that the
device does not have external AUX port, there is no downside in
disabling the MUX mode.
Reported-by: Paul Menzel
Suggested-by: Vojtech Pavlik
Reviewed-by: Marcos Paulo de Souza
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit df56784760405b586a94beb94ad513ad45094ae1
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_reset\_versions for NFSv4.
[ Upstream commit 800a938f0bf9130c8256116649c0cc5806bfb2fd ]
If you write "-2 -3 -4" to the "versions" file, it will
notice that no versions are enabled, and nfsd\_reset\_versions()
is called.
This enables all major versions, not no minor versions.
So we lose the invariant that NFSv4 is only advertised when
at least one minor is enabled.
Fix the code to explicitly enable minor versions for v4,
change it to use nfsd\_vers() to test and set, and simplify
the code.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5b0334584ad613c3ab0009c51828af3c1f3b653e
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_minorversion(.., NFSD\_AVAIL)
[ Upstream commit 928c6fb3a9bfd6c5b287aa3465226add551c13c0 ]
Current code will return 1 if the version is supported,
and -1 if it isn't.
This is confusing and inconsistent with the one place where this
is used.
So change to return 1 if it is supported, and zero if not.
i.e. an error is never returned.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 067cb6b2f7162fa11c4f7c423e31bb3c39f29665
Author: Doug Berger
Date: Thu Mar 9 16:58:48 2017 -0800
net: bcmgenet: Power up the internal PHY before probing the MII
[ Upstream commit 6be371b053dc86f11465cc1abce2e99bda0a0574 ]
When using the internal PHY it must be powered up when the MII is probed
or the PHY will not be detected. Since the PHY is powered up at reset
this has not been a problem. However, when the kernel is restarted with
kexec the PHY will likely be powered down when the kernel starts so it
will not be detected and the Ethernet link will not be established.
This commit explicitly powers up the internal PHY when the GENET driver
is probed to correct this behavior.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a33e082dcaf42ce5813e7368a4c1a6666501fcf8
Author: Doug Berger
Date: Thu Mar 9 16:58:46 2017 -0800
net: bcmgenet: power down internal phy if open or resume fails
[ Upstream commit 7627409cc4970e8c8b9de6945ad86a575290a94e ]
Since the internal PHY is powered up during the open and resume
functions it should be powered back down if the functions fail.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8aaed873f3b980a85087f2b5347a0acafb4bd63d
Author: Doug Berger
Date: Thu Mar 9 16:58:45 2017 -0800
net: bcmgenet: reserved phy revisions must be checked first
[ Upstream commit eca4bad73409aedc6ff22f823c18b67a4f08c851 ]
The reserved gphy\_rev value of 0x01ff must be tested before the old
or new scheme for GPHY major versioning are tested, otherwise it will
be treated as 0xff00 according to the old scheme.
Fixes: b04a2f5b9ff5 ("net: bcmgenet: add support for new GENET PHY revision scheme")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c25da696fca149bb76e7ee37844f872565493c92
Author: Doug Berger
Date: Thu Mar 9 16:58:44 2017 -0800
net: bcmgenet: correct MIB access of UniMAC RUNT counters
[ Upstream commit 1ad3d225e5a40ca6c586989b4baaca710544c15a ]
The gap between the Tx status counters and the Rx RUNT counters is now
being added to allow correct reporting of the registers.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 296b584763f7d87d475da9eba5090b874b7b50ac
Author: Doug Berger
Date: Thu Mar 9 16:58:43 2017 -0800
net: bcmgenet: correct the RBUF\_OVFL\_CNT and RBUF\_ERR\_CNT MIB values
[ Upstream commit ffff71328a3c321f7c14cc1edd33577717037744 ]
The location of the RBUF overflow and error counters has moved between
different version of the GENET MAC. This commit corrects the driver to
read from the correct locations depending on the version of the GENET
MAC.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit accbd99507b1b22a0402cfd7b385a87a541f404d
Author: Alexander Potapenko
Date: Wed Mar 8 18:08:16 2017 +0100
net: initialize msg.msg\_flags in recvfrom
[ Upstream commit 9f138fa609c47403374a862a08a41394be53d461 ]
KMSAN reports a use of uninitialized memory in put\_cmsg() because
msg.msg\_flags in recvfrom haven't been initialized properly.
The flag values don't affect the result on this path, but it's still a
good idea to initialize them explicitly.
Signed-off-by: Alexander Potapenko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b5213e1e9f25ccde958aa6364815ee87fef91100
Author: Andrea Arcangeli
Date: Thu Mar 9 16:17:14 2017 -0800
userfaultfd: selftest: vm: allow to build in vm/ directory
[ Upstream commit 46aa6a302b53f543f8e8b8e1714dc5e449ad36a6 ]
linux/tools/testing/selftests/vm $ make
gcc -Wall -I ../../../../usr/include compaction\_test.c -lrt -o /compaction\_test
/usr/lib/gcc/x86\_64-pc-linux-gnu/4.9.4/../../../../x86\_64-pc-linux-gnu/bin/ld: cannot open output file /compaction\_test: Permission denied
collect2: error: ld returned 1 exit status
make: \*\*\* [../lib.mk:54: /compaction\_test] Error 1
Since commit a8ba798bc8ec ("selftests: enable O and KBUILD\_OUTPUT")
selftests/vm build fails if run from the "selftests/vm" directory, but
it works in the selftests/ directory. It's quicker to be able to do a
local vm-only build after a tree wipe and this patch allows for it
again.
Link: http://lkml.kernel.org/r/20170302173738.18994-4-aarcange@redhat.com
Signed-off-by: Andrea Arcangeli
Cc: Mike Rapoport
Cc: "Dr. David Alan Gilbert"
Cc: Mike Kravetz
Cc: Pavel Emelyanov
Cc: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ee9be99630398c907261042ed092612bcbfaa69d
Author: Andrea Arcangeli
Date: Thu Mar 9 16:16:28 2017 -0800
userfaultfd: shmem: \_\_do\_fault requires VM\_FAULT\_NOPAGE
[ Upstream commit 6bbc4a4144b1a69743022ac68dfaf6e7d993abb9 ]
\_\_do\_fault assumes vmf->page has been initialized and is valid if
VM\_FAULT\_NOPAGE is not returned by vma->vm\_ops->fault(vma, vmf).
handle\_userfault() in turn should return VM\_FAULT\_NOPAGE if it doesn't
return VM\_FAULT\_SIGBUS or VM\_FAULT\_RETRY (the other two possibilities).
This VM\_FAULT\_NOPAGE case is only invoked when signal are pending and it
didn't matter for anonymous memory before. It only started to matter
since shmem was introduced. hugetlbfs also takes a different path and
doesn't exercise \_\_do\_fault.
Link: http://lkml.kernel.org/r/20170228154201.GH5816@redhat.com
Signed-off-by: Andrea Arcangeli
Reported-by: Dmitry Vyukov
Cc: "Kirill A. Shutemov"
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0d0456ec2b089457233f4a33c9939dfeff11fbbd
Author: Guoqing Jiang
Date: Fri Feb 24 11:15:12 2017 +0800
md-cluster: free md\_cluster\_info if node leave cluster
[ Upstream commit 9c8043f337f14d1743006dfc59c03e80a42e3884 ]
To avoid memory leak, we need to free the cinfo which
is allocated when node join cluster.
Reviewed-by: NeilBrown
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a1d72bc18e776f8c5fc5918fc4f4a2795f31a416
Author: Javier Martinez Canillas
Date: Wed Feb 22 15:23:22 2017 -0300
usb: phy: isp1301: Add OF device ID table
[ Upstream commit fd567653bdb908009b650f079bfd4b63169e2ac4 ]
The driver doesn't have a struct of\_device\_id table but supported devices
are registered via Device Trees. This is working on the assumption that a
I2C device registered via OF will always match a legacy I2C device ID and
that the MODALIAS reported will always be of the form i2c:.
But this could change in the future so the correct approach is to have an
OF device ID table if the devices are registered via OF.
Signed-off-by: Javier Martinez Canillas
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 75252bfe9e493a314d62e820aea07a6c48dea833
Author: Ilan peer
Date: Mon Dec 26 18:17:36 2016 +0200
mac80211: Fix addition of mesh configuration element
commit 57629915d568c522ac1422df7bba4bee5b5c7a7c upstream.
The code was setting the capabilities byte to zero,
after it was already properly set previously. Fix it.
The bug was found while debugging hwsim mesh tests failures
that happened since the commit mentioned below.
Fixes: 76f43b4c0a93 ("mac80211: Remove invalid flag operations in mesh TSF synchronization")
Signed-off-by: Ilan Peer
Reviewed-by: Masashi Honma
Signed-off-by: Johannes Berg
Cc: Richard Schütz
Cc: Mathias Kretschmer
Signed-off-by: Greg Kroah-Hartman
commit 13e86efb2eee6bd1f2d0aae5b0273e8e65683c9d
Author: Eric Biggers
Date: Fri Dec 8 15:13:27 2017 +0000
KEYS: add missing permission check for request\_key() destination
commit 4dca6ea1d9432052afb06baf2e3ae78188a4410b upstream.
When the request\_key() syscall is not passed a destination keyring, it
links the requested key (if constructed) into the "default" request-key
keyring. This should require Write permission to the keyring. However,
there is actually no permission check.
This can be abused to add keys to any keyring to which only Search
permission is granted. This is because Search permission allows joining
the keyring. keyctl\_set\_reqkey\_keyring(KEY\_REQKEY\_DEFL\_SESSION\_KEYRING)
then will set the default request-key keyring to the session keyring.
Then, request\_key() can be used to add keys to the keyring.
Both negatively and positively instantiated keys can be added using this
method. Adding negative keys is trivial. Adding a positive key is a
bit trickier. It requires that either /sbin/request-key positively
instantiates the key, or that another thread adds the key to the process
keyring at just the right time, such that request\_key() misses it
initially but then finds it in construct\_alloc\_key().
Fix this bug by checking for Write permission to the keyring in
construct\_get\_dest\_keyring() when the default keyring is being used.
We don't do the permission check for non-default keyrings because that
was already done by the earlier call to lookup\_user\_key(). Also,
request\_key\_and\_link() is currently passed a 'struct key \*' rather than
a key\_ref\_t, so the "possessed" bit is unavailable.
We also don't do the permission check for the "requestor keyring", to
continue to support the use case described by commit 8bbf4976b59f
("KEYS: Alter use of key instantiation link-to-keyring argument") where
/sbin/request-key recursively calls request\_key() to add keys to the
original requestor's destination keyring. (I don't know of any users
who actually do that, though...)
Fixes: 3e30148c3d52 ("[PATCH] Keys: Make request-key create an authorisation key")
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Signed-off-by: Greg Kroah-Hartman
commit ef7ce82bc28065fd916fc1c0f7e00c2151fcd8a0
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f upstream.
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Signed-off-by: Greg Kroah-Hartman
commit 2c367edaba650af3d58fd68b6600fc4cbed77c1a
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
commit c894aa97577e47d3066b27b32499ecf899bfa8b0 upstream.
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 52425e042843c935f35480192610fca850283578
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
commit 6f6a23a213be51728502b88741ba6a10cda2441d upstream.
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit af36d95af55f4bac94128875491671771d3d4916
Author: Steven Rostedt
Date: Sat Dec 2 13:04:54 2017 -0500
sched/rt: Do not pull from current CPU if only one CPU to pull
commit f73c52a5bcd1710994e53fbccc378c42b97a06b6 upstream.
Daniel Wagner reported a crash on the BeagleBone Black SoC.
This is a single CPU architecture, and does not have a functional
arch\_send\_call\_function\_single\_ipi() implementation which can crash
the kernel if that is called.
As it only has one CPU, it shouldn't be called, but if the kernel is
compiled for SMP, the push/pull RT scheduling logic now calls it for
irq\_work if the one CPU is overloaded, it can use that function to call
itself and crash the kernel.
Ideally, we should disable the SCHED\_FEAT(RT\_PUSH\_IPI) if the system
only has a single CPU. But SCHED\_FEAT is a constant if sched debugging
is turned off. Another fix can also be used, and this should also help
with normal SMP machines. That is, do not initiate the pull code if
there's only one RT overloaded CPU, and that CPU happens to be the
current CPU that is scheduling in a lower priority task.
Even on a system with many CPUs, if there's many RT tasks waiting to
run on a single CPU, and that CPU schedules in another RT task of lower
priority, it will initiate the PULL logic in case there's a higher
priority RT task on another CPU that is waiting to run. But if there is
no other CPU with waiting RT tasks, it will initiate the RT pull logic
on itself (as it still has RT tasks waiting to run). This is a wasted
effort.
Not only does this help with SMP code where the current CPU is the only
one with RT overloaded tasks, it should also solve the issue that
Daniel encountered, because it will prevent the PULL logic from
executing, as there's only one CPU on the system, and the check added
here will cause it to exit the RT pull code.
Reported-by: Daniel Wagner
Signed-off-by: Steven Rostedt (VMware)
Acked-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: linux-rt-users
Fixes: 4bdced5c9 ("sched/rt: Simplify the IPI based RT balancing logic")
Link: http://lkml.kernel.org/r/20171202130454.4cbbfe8d@vmware.local.home
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit f98ee9c0007bfe8f4465fabc762372add67d18fb
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 upstream.
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit ffc7565746bb2fc063fc0f484c55ef6d8951a6ee
Author: Sukumar Ghorai
Date: Wed Aug 16 14:46:55 2017 -0700
Bluetooth: btusb: driver to enable the usb-wakeup feature
commit a0085f2510e8976614ad8f766b209448b385492f upstream.
BT-Controller connected as platform non-root-hub device and
usb-driver initialize such device with wakeup disabled,
Ref. usb\_new\_device().
At present wakeup-capability get enabled by hid-input device from usb
function driver(e.g. BT HID device) at runtime. Again some functional
driver does not set usb-wakeup capability(e.g LE HID device implement
as HID-over-GATT), and can't wakeup the host on USB.
Most of the device operation (such as mass storage) initiated from host
(except HID) and USB wakeup aligned with host resume procedure. For BT
device, usb-wakeup capability need to enable form btusc driver as a
generic solution for multiple profile use case and required for USB remote
wakeup (in-bus wakeup) while host is suspended. Also usb-wakeup feature
need to enable/disable with HCI interface up and down.
Signed-off-by: Sukumar Ghorai
Signed-off-by: Amit K Bag
Acked-by: Oliver Neukum
Signed-off-by: Marcel Holtmann
Cc: Matthias Kaehlcke
Signed-off-by: Greg Kroah-Hartman
commit 8c7c3d5b785f539da3f45920c7c1ab5de5727ba7
Author: Yan, Zheng
Date: Thu Nov 30 11:59:22 2017 +0800
ceph: drop negative child dentries before try pruning inode's alias
commit 040d786032bf59002d374b86d75b04d97624005c upstream.
Negative child dentry holds reference on inode's alias, it makes
d\_prune\_aliases() do nothing.
Signed-off-by: "Yan, Zheng"
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 2862cfca39894ac265fbb5cde9a3ff90c02201f3
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a upstream.
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit dfdf5fa3e6647c0fc02be8d857b6b8b7098946ff
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 upstream.
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
Signed-off-by: Greg Kroah-Hartman
commit 05de6fa5c0e2fbbed4d41eaf2b474a863c544532
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
commit 62354454625741f0569c2cbe45b2d192f8fd258e upstream.
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit a34419b3f6a277b4da240f7b7a5e8be4d5c2356b
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
commit 90e406f96f630c07d631a021fd4af10aac913e77 upstream.
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit c60db4f68593e381571fdf9e2111363e1793cdf4
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb upstream.
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8a311b0462b59d12cb14e82e626d3612d988135b
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
commit ecaaab5649781c5a0effdaf298a925063020500e upstream.
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 43cd7f38612df31fbd929588c065cfbc42102aab
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 upstream.
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman


=== Content from lists.debian.org_4cb0aa4a_20250125_123730.html ===


---

[Date Prev][[Date Next](msg00001.html)]
[Thread Prev][[Thread Next](msg00001.html)]
[[Date Index](maillist.html#00000)]
[[Thread Index](threads.html#00000)]

# [SECURITY] [DLA 1369-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 1369-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Wed, 02 May 2018 21:58:29 +0100
* *Message-id*: <[[🔎]](/msgid-search/b7523f224fe2386a0f6ce54b31b558cafa6b3a9a.camel%40debian.org) [b7523f224fe2386a0f6ce54b31b558cafa6b3a9a.camel@debian.org](msg00000.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux
Version        : 3.2.101-1
CVE ID         : CVE-2017-0861 CVE-2017-5715 CVE-2017-13166 CVE-2017-16526
                 CVE-2017-16911 CVE-2017-16912 CVE-2017-16913 CVE-2017-16914
                 CVE-2017-18017 CVE-2017-18203 CVE-2017-18216 CVE-2018-1068
                 CVE-2018-1092 CVE-2018-5332 CVE-2018-5333 CVE-2018-5750
                 CVE-2018-5803 CVE-2018-6927 CVE-2018-7492 CVE-2018-7566
                 CVE-2018-7740 CVE-2018-7757 CVE-2018-7995 CVE-2018-8781
                 CVE-2018-8822 CVE-2018-1000004 CVE-2018-1000199
Debian Bug     : 887106

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2017-0861

    Robb Glasser reported a potential use-after-free in the ALSA (sound)
    PCM core.  We believe this was not possible in practice.

CVE-2017-5715

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 2 (branch
    target injection) and is mitigated for the x86 architecture (amd64
    and i386) by using the "retpoline" compiler feature which allows
    indirect branches to be isolated from speculative execution.

CVE-2017-13166

    A bug in the 32-bit compatibility layer of the v4l2 ioctl handling
    code has been found.  Memory protections ensuring user-provided
    buffers always point to userland memory were disabled, allowing
    destination addresses to be in kernel space.  On a 64-bit kernel
    (amd64 flavour) a local user with access to a suitable video
    device can exploit this to overwrite kernel memory, leading to
    privilege escalation.

CVE-2017-16526

    Andrey Konovalov reported that the UWB subsystem may dereference
    an invalid pointer in an error case.  A local user might be able
    to use this for denial of service.

CVE-2017-16911

    Secunia Research reported that the USB/IP vhci_hcd driver exposed
    kernel heap addresses to local users.  This information could aid the
    exploitation of other vulnerabilities.

CVE-2017-16912

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to an out-of-bounds read.  A remote user able to connect to the
    USB/IP server could use this for denial of service.

CVE-2017-16913

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to excessive memory allocation.  A remote user able to connect to
    the USB/IP server could use this for denial of service.

CVE-2017-16914

    Secunia Research reported that the USB/IP stub driver failed to
    check for an invalid combination of fields in a recieved packet,
    leading to a null pointer dereference.  A remote user able to
    connect to the USB/IP server could use this for denial of service.

CVE-2017-18017

    Denys Fedoryshchenko reported that the netfilter xt_TCPMSS module
    failed to validate TCP header lengths, potentially leading to a
    use-after-free.  If this module is loaded, it could be used by a
    remote attacker for denial of service or possibly for code
    execution.

CVE-2017-18203

    Hou Tao reported that there was a race condition in creation and
    deletion of device-mapper (DM) devices.  A local user could
    potentially use this for denial of service.

CVE-2017-18216

    Alex Chen reported that the OCFS2 filesystem failed to hold a
    necessary lock during nodemanager sysfs file operations,
    potentially leading to a null pointer dereference.  A local user
    could use this for denial of service.

CVE-2018-1068

    The syzkaller tool found that the 32-bit compatibility layer of
    ebtables did not sufficiently validate offset values.  On a 64-bit
    kernel (amd64 flavour), a local user with the CAP_NET_ADMIN
    capability could use this to overwrite kernel memory, possibly
    leading to privilege escalation.

CVE-2018-1092

    Wen Xu reported that a crafted ext4 filesystem image would
    trigger a null dereference when mounted.  A local user able
    to mount arbitrary filesystems could use this for denial of
    service.

CVE-2018-5332

    Mohamed Ghannam reported that the RDS protocol did not
    sufficiently validate RDMA requests, leading to an out-of-bounds
    write.  A local attacker on a system with the rds module loaded
    could use this for denial of service or possibly for privilege
    escalation.

CVE-2018-5333

    Mohamed Ghannam reported that the RDS protocol did not properly
    handle an error case, leading to a null pointer dereference.  A
    local attacker on a system with the rds module loaded could
    possibly use this for denial of service.

CVE-2018-5750

    Wang Qize reported that the ACPI sbshc driver logged a kernel heap
    address.  This information could aid the exploitation of other
    vulnerabilities.

CVE-2018-5803

    Alexey Kodanev reported that the SCTP protocol did not range-check
    the length of chunks to be created.  A local or remote user could
    use this to cause a denial of service.

CVE-2018-6927

    Li Jinyue reported that the FUTEX_REQUEUE operation on futexes did
    not check for negative parameter values, which might lead to a
    denial of service or other security impact.

CVE-2018-7492

    The syzkaller tool found that the RDS protocol was lacking a null
    pointer check.  A local attacker on a system with the rds module
    loaded could use this for denial of service.

CVE-2018-7566

    范龙飞 (Fan LongFei) reported a race condition in the ALSA (sound)
    sequencer core, between write and ioctl operations.  This could
    lead to an out-of-bounds access or use-after-free.  A local user
    with access to a sequencer device could use this for denial of
    service or possibly for privilege escalation.

CVE-2018-7740

    Nic Losby reported that the hugetlbfs filesystem's mmap operation
    did not properly range-check the file offset.  A local user with
    access to files on a hugetlbfs filesystem could use this to cause
    a denial of service.

CVE-2018-7757

    Jason Yan reported a memory leak in the SAS (Serial-Attached
    SCSI) subsystem.  A local user on a system with SAS devices
    could use this to cause a denial of service.

CVE-2018-7995

    Seunghun Han reported a race condition in the x86 MCE
    (Machine Check Exception) driver.  This is unlikely to have
    any security impact.

CVE-2018-8781

    Eyal Itkin reported that the udl (DisplayLink) driver's mmap
    operation did not properly range-check the file offset.  A local
    user with access to a udl framebuffer device could exploit this to
    overwrite kernel memory, leading to privilege escalation.

CVE-2018-8822

    Dr Silvio Cesare of InfoSect reported that the ncpfs client
    implementation did not validate reply lengths from the server.  An
    ncpfs server could use this to cause a denial of service or
    remote code execution in the client.

CVE-2018-1000004

    Luo Quan reported a race condition in the ALSA (sound) sequencer
    core, between multiple ioctl operations.  This could lead to a
    deadlock or use-after-free.  A local user with access to a
    sequencer device could use this for denial of service or possibly
    for privilege escalation.

CVE-2018-1000199

    Andy Lutomirski discovered that the ptrace subsystem did not
    sufficiently validate hardware breakpoint settings.  Local users
    can use this to cause a denial of service, or possibly for
    privilege escalation, on x86 (amd64 and i386) and possibly other
    architectures.

Additionally, some mitigations for CVE-2017-5753 are included in this
release:

CVE-2017-5753

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 1
    (bounds-check bypass) and is mitigated by identifying vulnerable
    code sections (array bounds checking followed by array access) and
    replacing the array access with the speculation-safe
    array_index_nospec() function.

    More use sites will be added over time.

For Debian 7 "Wheezy", these problems have been fixed in version
3.2.101-1.  This version also includes bug fixes from upstream versions
up to and including 3.2.101.  It also fixes a regression in the
procfs hidepid option in the previous version (Debian bug #887106).

We recommend that you upgrade your linux packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams
```

**Attachment:
[signature.asc](pgpQ_Lyjwu10v.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from cdn.kernel.org_6679bb35_20250125_123720.html ===
commit 7b3775017f4e6b87dfd2c7f63d1eaf057948f31d
Author: Greg Kroah-Hartman
Date: Wed Dec 20 10:10:38 2017 +0100
Linux 4.14.8
commit bed6119aa21b28f096880342f9e2445f9ad47b25
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
commit bd3486ded7a0c313a6575343e6c2b21d14476645 upstream.
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit d094690cbed906ca96752cb94abed50fbf1cfaa3
Author: Brian Norris
Date: Thu Oct 19 11:45:19 2017 -0700
ath10k: fix build errors with !CONFIG\_PM
[ Upstream commit 20665a9076d48e9abd9a2db13d307f58f7ef6647 ]
Build errors have been reported with CONFIG\_PM=n:
drivers/net/wireless/ath/ath10k/pci.c:3416:8: error: implicit
declaration of function 'ath10k\_pci\_suspend'
[-Werror=implicit-function-declaration]
drivers/net/wireless/ath/ath10k/pci.c:3428:8: error: implicit
declaration of function 'ath10k\_pci\_resume'
[-Werror=implicit-function-declaration]
These are caused by the combination of the following two commits:
6af1de2e4ec4 ("ath10k: mark PM functions as \_\_maybe\_unused")
96378bd2c6cd ("ath10k: fix core PCI suspend when WoWLAN is supported but
disabled")
Both build fine on their own.
But now that ath10k\_pci\_pm\_{suspend,resume}() is compiled
unconditionally, we should also compile ath10k\_pci\_{suspend,resume}()
unconditionally.
And drop the #ifdef around ath10k\_pci\_hif\_{suspend,resume}() too; they
are trivial (empty), so we're not saving much space by compiling them
out. And the alternatives would be to sprinkle more \_\_maybe\_unused, or
spread the #ifdef's further.
Build tested with the following combinations:
CONFIG\_PM=y && CONFIG\_PM\_SLEEP=y
CONFIG\_PM=y && CONFIG\_PM\_SLEEP=n
CONFIG\_PM=n
Fixes: 96378bd2c6cd ("ath10k: fix core PCI suspend when WoWLAN is supported but disabled")
Fixes: 096ad2a15fd8 ("Merge branch 'ath-next'")
Signed-off-by: Brian Norris
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5c212b59ded7fc9382e1c55c100f82709cf542ca
Author: Brian Norris
Date: Wed Oct 4 12:22:55 2017 +0300
ath10k: fix core PCI suspend when WoWLAN is supported but disabled
[ Upstream commit 96378bd2c6cda5f04d0f6da2cd35d4670a982c38 ]
For devices where the FW supports WoWLAN but user-space has not
configured it, we don't do any PCI-specific suspend/resume operations,
because mac80211 doesn't call drv\_suspend() when !wowlan. This has
particularly bad effects for some platforms, because we don't stop the
power-save timer, and if this timer goes off after the PCI controller
has suspended the link, Bad Things will happen.
Commit 32faa3f0ee50 ("ath10k: add the PCI PM core suspend/resume ops")
got some of this right, in that it understood there was a problem on
non-WoWLAN firmware. But it forgot the $subject case.
Fix this by moving all the PCI driver suspend/resume logic exclusively
into the driver PM hooks. This shouldn't affect WoWLAN support much
(this just gets executed later on).
I would just as well kill the entirety of ath10k\_hif\_suspend(), as it's
not even implemented on the USB or SDIO drivers. I expect that we don't
need the callback, except to return "supported" (i.e., 0) or "not
supported" (i.e., -EOPNOTSUPP).
Fixes: 32faa3f0ee50 ("ath10k: add the PCI PM core suspend/resume ops")
Fixes: 77258d409ce4 ("ath10k: enable pci soc powersaving")
Signed-off-by: Brian Norris
Cc: Ryan Hsu
Cc: Kalle Valo
Cc: Michal Kazior
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e37eb54a000c767e7f39b806fb048c4be75ed786
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 99ab42f783da58540c80c91a2af8e8c764c46ca8
Author: Rakesh Pandit
Date: Fri Oct 13 14:45:56 2017 +0200
lightnvm: pblk: protect line bitmap while submitting meta io
[ Upstream commit e57903fd972a398b7140d0bc055714e13a0e58c5 ]
It seems pblk\_dealloc\_page would race against pblk\_alloc\_pages for
line bitmap for sector allocation.The chances are very low but might
as well protect the bitmap properly.
Signed-off-by: Rakesh Pandit
Reviewed-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 136e415e7a6a7d3d8666560b2147145c7636a455
Author: Javier González
Date: Fri Oct 13 14:46:06 2017 +0200
lightnvm: pblk: fix min size for page mempool
[ Upstream commit bd432417681a224d9fa4a9d43be7d4edc82135b2 ]
pblk uses an internal page mempool for allocating pages on internal
bios. The main two users of this memory pool are partial reads (reads
with some sectors in cache and some on media) and padded writes, which
need to add dummy pages to an existing bio already containing valid
data (and with a large enough bioset allocated). In both cases, the
maximum number of pages per bio is defined by the maximum number of
physical sectors supported by the underlying device.
This patch fixes a bad mempool allocation, where the min\_nr of elements
on the pool was fixed (to 16), which is lower than the maximum number
of sectors supported by NVMe (as of the time for this patch). Instead,
use the maximum number of allowed sectors reported by the device.
Reported-by: Jens Axboe
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 83ef2175ba013ab5ec9b1ec50944ba60a6af888d
Author: Javier González
Date: Fri Oct 13 14:46:01 2017 +0200
lightnvm: pblk: initialize debug stat counter
[ Upstream commit a1121176ff757e3c073490a69608ea0b18a00ec1 ]
Initialize the stat counter for garbage collected reads.
Fixes: a4bd217b43268 ("lightnvm: physical block device (pblk) target")
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8594a9a79c390fc99c8d8af21b3208396c94b231
Author: Javier González
Date: Fri Oct 13 14:46:02 2017 +0200
lightnvm: pblk: use right flag for GC allocation
[ Upstream commit 7d327a9ed6c4dca341ebf99012e0a6b80a3050e6 ]
The data buffer for the GC path allocates virtual memory through
vmalloc. When this change was introduced, a flag signaling kmalloc'ed
memory was wrongly introduced. Use the right flag when creating a bio
from this buffer.
Fixes: de54e703a422 ("lightnvm: pblk: use vmalloc for GC data buffer")
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e22f692fbabafe322db0c3821e02a5d6da350bef
Author: Rakesh Pandit
Date: Fri Oct 13 14:46:28 2017 +0200
lightnvm: pblk: fix changing GC group list for a line
[ Upstream commit 27b978725d895e704aab44b99242a0514485d798 ]
pblk\_line\_gc\_list seems to had a bug since the introduction of pblk in
getting GC list for a line. In b20ba1bc7 while redesigning the GC
algorithm, the naming for the GC thresholds was altered, but the
values for high\_thrs and mid\_thrs were not. The result is that when
moving to the GC lists, the mid threshold is never evaluated.
Fixes: a4bd217b4("lightnvm: physical block device (pblk) target")
Signed-off-by: Rakesh Pandit
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1b07f7511a773db3a165b0a2eca35df5ba6dd1d3
Author: Hans Holmberg
Date: Fri Oct 13 14:46:34 2017 +0200
lightnvm: pblk: prevent gc kicks when gc is not operational
[ Upstream commit 3e3a5b8ebd5d3b1d68facc58b0674a2564653222 ]
GC can be kicked after it has been shut down when closing the last
line during exit, resulting in accesses to freed structures.
Make sure that GC is not triggered while it is not operational.
Also make sure that GC won't be re-activated during exit when
running on another processor by using timer\_del\_sync.
Signed-off-by: Hans Holmberg
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e6a9d261e95f5ba5cda38ca9c6b7e580656032c4
Author: Matteo Croce
Date: Thu Oct 12 16:12:37 2017 +0200
icmp: don't fail on fragment reassembly time exceeded
[ Upstream commit 258bbb1b0e594ad5f5652cb526b3c63e6a7fad3d ]
The ICMP implementation currently replies to an ICMP time exceeded message
(type 11) with an ICMP host unreachable message (type 3, code 1).
However, time exceeded messages can either represent "time to live exceeded
in transit" (code 0) or "fragment reassembly time exceeded" (code 1).
Unconditionally replying to "fragment reassembly time exceeded" with
host unreachable messages might cause unjustified connection resets
which are now easily triggered as UFO has been removed, because, in turn,
sending large buffers triggers IP fragmentation.
The issue can be easily reproduced by running a lot of UDP streams
which is likely to trigger IP fragmentation:
# start netserver in the test namespace
ip netns add test
ip netns exec test netserver
# create a VETH pair
ip link add name veth0 type veth peer name veth0 netns test
ip link set veth0 up
ip -n test link set veth0 up
for i in $(seq 20 29); do
# assign addresses to both ends
ip addr add dev veth0 192.168.$i.1/24
ip -n test addr add dev veth0 192.168.$i.2/24
# start the traffic
netperf -L 192.168.$i.1 -H 192.168.$i.2 -t UDP\_STREAM -l 0 &
done
# wait
send\_data: data send error: No route to host (errno 113)
netperf: send\_omni: send\_data failed: No route to host
We need to differentiate instead: if fragment reassembly time exceeded
is reported, we need to silently drop the packet,
if time to live exceeded is reported, maintain the current behaviour.
In both cases increment the related error count "icmpInTimeExcds".
While at it, fix a typo in a comment, and convert the if statement
into a switch to mate it more readable.
Signed-off-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 023bff1b335860493dce3769c942b0172ea0fb5a
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 02ef1dd301c2f1ca0ffe58f75bf2f0f4bd291270
Author: Bart Van Assche
Date: Wed Oct 11 10:48:45 2017 -0700
RDMA/cma: Avoid triggering undefined behavior
[ Upstream commit c0b64f58e8d49570aa9ee55d880f92c20ff0166b ]
According to the C standard the behavior of computations with
integer operands is as follows:
\* A computation involving unsigned operands can never overflow,
because a result that cannot be represented by the resulting
unsigned integer type is reduced modulo the number that is one
greater than the largest value that can be represented by the
resulting type.
\* The behavior for signed integer underflow and overflow is
undefined.
Hence only use unsigned integers when checking for integer
overflow.
This patch is what I came up with after having analyzed the
following smatch warnings:
drivers/infiniband/core/cma.c:3448: cma\_resolve\_ib\_udp() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
drivers/infiniband/core/cma.c:3505: cma\_connect\_ib() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
Signed-off-by: Bart Van Assche
Acked-by: Sean Hefty
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9fc290e529b4948b2b18fa943d8bd5c3a5d5b6e1
Author: Bart Van Assche
Date: Wed Oct 11 10:48:43 2017 -0700
IB/core: Fix endianness annotation in rdma\_is\_multicast\_addr()
[ Upstream commit 1c3aea2bc8f0b2e5b57375ead40457ff75a3a2ec ]
Since ipv4\_addr is a big endian 32-bit number, annotate it as such.
Fixes: commit be1d325a3358 ("IB/core: Set RoCEv2 MGID according to spec")
Signed-off-by: Bart Van Assche
Reviewed-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f7af60377ec05e2452a73c349b4fa2a4196480c8
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d9490e7ca55bafac97fa65a3d34244386469eb50
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 42364042b7dd4ba7fed36c1db0a157c7c48282ca
Author: Chuck Lever
Date: Mon Oct 9 12:03:26 2017 -0400
xprtrdma: Don't defer fencing an async RPC's chunks
[ Upstream commit 8f66b1a529047a972cb9602a919c53a95f3d7a2b ]
In current kernels, waiting in xprt\_release appears to be safe to
do. I had erroneously believed that for ASYNC RPCs, waiting of any
kind in xprt\_release->xprt\_rdma\_free would result in deadlock. I've
done injection testing and consulted with Trond to confirm that
waiting in the RPC release path is safe.
For the very few times where RPC resources haven't yet been released
earlier by the reply handler, it is safe to wait synchronously in
xprt\_rdma\_free for invalidation rather than defering it to MR
recovery.
Note: When the QP is error state, posting a LocalInvalidate should
flush and mark the MR as bad. There is no way the remote HCA can
access that MR via a QP in error state, so it is effectively already
inaccessible and thus safe for the Upper Layer to access. The next
time the MR is used it should be recognized and cleaned up properly
by frwr\_op\_map.
Signed-off-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 46788d19e137fc48d93f0a29eade2e02e05317f6
Author: Guoqing Jiang
Date: Fri Sep 29 09:16:43 2017 +0800
md-cluster: fix wrong condition check in raid1\_write\_request
[ Upstream commit 385f4d7f946b08f36f68b0a28e95a319925b6b62 ]
The check used here is to avoid conflict between write and
resync, however we used the wrong logic, it should be the
inverse of the checking inside "if".
Fixes: 589a1c4 ("Suspend writes in RAID1 if within range")
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 339aba679813ff1fabde362147919d3f6e536568
Author: Artur Paszkiewicz
Date: Fri Sep 29 22:54:19 2017 +0200
raid5-ppl: check recovery\_offset when performing ppl recovery
[ Upstream commit 07719ff767dcd8cc42050f185d332052f3816546 ]
If starting an array that is undergoing rebuild, make ppl recovery honor
the recovery\_offset of a member disk and don't read data that is not yet
in-sync.
Signed-off-by: Artur Paszkiewicz
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b197f67ccfeb86d180a152796b5e3b7de1f611ef
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dd2581c675e4311abc68826c25ec2563bccb3337
Author: weiping zhang
Date: Thu Oct 12 14:56:44 2017 +0800
scsi: sd: change allow\_restart to bool in sysfs interface
[ Upstream commit 658e9a6dc1126f21fa417cd213e1cdbff8be0ba2 ]
/sys/class/scsi\_disk/0:2:0:0/allow\_restart can be changed to 0
unexpectedly by writing an invalid string such as the following:
echo asdf > /sys/class/scsi\_disk/0:2:0:0/allow\_restart
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 47b5dbdd983e0319cd5d135bbfe7e564f4bbaabc
Author: weiping zhang
Date: Thu Oct 12 14:57:06 2017 +0800
scsi: sd: change manage\_start\_stop to bool in sysfs interface
[ Upstream commit 623401ee33e42cee64d333877892be8db02951eb ]
/sys/class/scsi\_disk/0:2:0:0/manage\_start\_stop can be changed to 0
unexpectly by writing an invalid string.
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fc8f4ca137d9525b6f7db4b1d3e8f07a087518ec
Author: Wei Yongjun
Date: Tue Oct 17 12:11:46 2017 +0000
nullb: fix error return code in null\_init()
[ Upstream commit 30c516d750396c5f3ec9cb04c9e025c25e91495e ]
Fix to return error code -ENOMEM from the null\_alloc\_dev() error
handling case instead of 0, as done elsewhere in this function.
Fixes: 2984c8684f96 ("nullb: factor disk parameters")
Signed-off-by: Wei Yongjun
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c97e41076a298dbc4e910c33048e553658388eed
Author: Colin Ian King
Date: Tue Oct 17 16:54:52 2017 +0100
ipmi\_si: fix memory leak on new\_smi
[ Upstream commit c0a32fe13cd323ca9420500b16fd69589c9ba91e ]
The error exit path omits kfree'ing the allocated new\_smi, causing a memory
leak. Fix this by kfree'ing new\_smi.
Detected by CoverityScan, CID#14582571 ("Resource Leak")
Fixes: 7e030d6dff71 ("ipmi: Prefer ACPI system interfaces over SMBIOS ones")
Signed-off-by: Colin Ian King
Signed-off-by: Corey Minyard
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f2d81d0f030afc7a873bb3454eaf59f384543baf
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:07 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_disassoc\_cmd
[ Upstream commit 08880f8e08cbd814e870e9d3ab9530abc1bce226 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_set\_802\_11\_bssid(acquire the spinlock)
rtw\_disassoc\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f898f36664a5d64a55c1257e55dfacaae6a86bb7
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:45 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_createbss\_cmd
[ Upstream commit 2bf9806d4228f7a6195f8e03eda0479d2a93b411 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_surveydone\_event\_callback(acquire the spinlock)
rtw\_createbss\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f18b2039d904f344dae779451592814e2c646686
Author: Don Hiatt
Date: Mon Oct 9 12:38:12 2017 -0700
IB/hfi1: Mask out A bit from psn trace
[ Upstream commit d0a2f454713a42447ee4007582c0e43c47bcf230 ]
The trace logic prior to the fixes below used to mask the
A bit from the psn. It now mistakenly displays the A bit,
which is already displayed separately.
Fix by adding the appropriate mask to the psn tracing.
Fixes: 228d2af1b723 ("IB/hfi1: Separate input/output header tracing")
Fixes: 863cf89d472f ("IB/hfi1: Add 16B trace support")
Reviewed-by: Mike Marciniszyn
Signed-off-by: Don Hiatt
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4e2836b43102633dc9bffbc170be43e1d147914c
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b57259ca055f7f2c7237dcc0e5aac446b2fa6da9
Author: Parav Pandit
Date: Mon Oct 16 08:45:16 2017 +0300
IB/core: Fix calculation of maximum RoCE MTU
[ Upstream commit 99260132fde7bddc6e0132ce53da94d1c9ccabcb ]
The original code only took into consideration the largest header
possible after the IB\_BTH\_BYTES. This was incorrect, as the largest
possible header size is the largest possible combination of headers we
might run into. The new code accounts for all possible headers in the
largest possible combination and subtracts that from the MTU to make
sure that all packets will fit on the wire.
Link: https://www.spinics.net/lists/linux-rdma/msg54558.html
Fixes: 3c86aa70bf67 ("RDMA/cm: Add RDMA CM support for IBoE devices")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Reported-by: Roland Dreier
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cb27c88b080274e5f94ae7a7c4da7275925ab33
Author: Parav Pandit
Date: Mon Oct 16 08:45:15 2017 +0300
IB/core: Fix use workqueue without WQ\_MEM\_RECLAIM
[ Upstream commit 39baf10310e6669564a485b55267fae70a4e44ae ]
The IB/core provides address resolution service and invokes callback
handler when address resolve request completes of requester in worker
thread context.
Such caller might allocate or free memory in callback handler
depending on the completion status to make further progress or to
terminate a connection. Most ULPs resolve route which involves
allocating route entry and path record elements in callback event handler.
It has been noticed that WQ\_MEM\_RECLAIM flag should not be used for
workers that tend to allocate memory in this [1] thread discussion.
In order to mitigate this situation, WQ\_MEM\_RECLAIM flag was dropped for
other such WQs in this [2] patch.
Similar problem might arise with address resolution path, though its not
yet noticed. The ib\_addr workqueue is not memory reclaim path due to its
nature of invoking callback that might allocate memory or don't free any
memory under memory pressure.
[1] https://www.spinics.net/lists/linux-rdma/msg53239.html
[2] https://www.spinics.net/lists/linux-rdma/msg53416.html
Fixes: f54816261c2b ("IB/addr: Remove deprecated create\_singlethread\_workqueue")
Fixes: 5fff41e1f89d ("IB/core: Fix race condition in resolving IP to MAC")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 84607a2958762c94741fc96e947e6a134cd5f5c3
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8151940acc356ba61e0992f464fca38118860c31
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 57db94d4b72479c6c1e31d18e83a581d5d6d0ee9
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4684da79d20edf232e33442775506e600fc4fe6f
Author: Ross Zwisler
Date: Wed Oct 18 12:21:55 2017 -0600
dev/dax: fix uninitialized variable build warning
[ Upstream commit 0a3ff78699d1817e711441715d22665475466036 ]
Fix this build warning:
warning: 'phys' may be used uninitialized in this function
[-Wuninitialized]
As reported here:
https://lkml.org/lkml/2017/10/16/152
http://kisskb.ellerman.id.au/kisskb/buildresult/13181373/log/
Signed-off-by: Ross Zwisler
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 93fc8284472124140a7946c4e5f555e06808f4a2
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b53af57679492180417d584be410b1134de15cd2
Author: Wanpeng Li
Date: Thu Oct 19 07:00:34 2017 +0800
KVM: nVMX: Fix EPT switching advertising
[ Upstream commit 575b3a2cb439b03fd603ea77c73c76f3ed237596 ]
I can use vmxcap tool to observe "EPTP Switching yes" even if EPT is not
exposed to L1.
EPT switching is advertised unconditionally since it is emulated, however,
it can be treated as an extended feature for EPT and it should not be
advertised if EPT itself is not exposed. This patch fixes it.
Reviewed-by: David Hildenbrand
Cc: Paolo Bonzini
Cc: Radim Krčmář
Cc: Jim Mattson
Signed-off-by: Wanpeng Li
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fdfcb06c5944afb78007cfc25e527ff689b2a344
Author: Eric Dumazet
Date: Wed Oct 18 17:02:03 2017 -0700
ipv4: ipv4\_default\_advmss() should use route mtu
[ Upstream commit 164a5e7ad531e181334a3d3f03d0d5ad20d6faea ]
ipv4\_default\_advmss() incorrectly uses the device MTU instead
of the route provided one. IPv6 has the proper behavior,
lets harmonize the two protocols.
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 48185ffb6dc3eb64846039117d76148d3e3d7022
Author: Matthias Brugger
Date: Sat Oct 21 10:17:47 2017 +0200
soc: mediatek: pwrap: fix compiler errors
[ Upstream commit fb2c1934f30577756e55e24e8870b45c78da3bc2 ]
When compiling using sparse, we got the following error:
drivers/soc/mediatek/mtk-pmic-wrap.c:686:25: error: dubious one-bit signed bitfield
Changing the data type to unsigned fixes this.
Signed-off-by: Matthias Brugger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cd01922985ce5c00cf050f12daef304cc452761
Author: Breno Leitao
Date: Tue Oct 17 16:20:18 2017 -0200
powerpc/xmon: Check before calling xive functions
[ Upstream commit 402e172a2ce76210f2fe921cf419d12103851344 ]
Currently xmon could call XIVE functions from OPAL even if the XIVE is
disabled or does not exist in the system, as in POWER8 machines. This
causes the following exception:
1:mon> dx
cpu 0x1: Vector: 700 (Program Check) at [c000000423c93450]
pc: c00000000009cfa4: opal\_xive\_dump+0x50/0x68
lr: c0000000000997b8: opal\_return+0x0/0x50
This patch simply checks if XIVE is enabled before calling XIVE
functions.
Fixes: 243e25112d06 ("powerpc/xive: Native exploitation of the XIVE interrupt controller")
Suggested-by: Guilherme G. Piccoli
Signed-off-by: Breno Leitao
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8ee1eada4f1a6671517dc51f6bc11174faebea02
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b59dc14b0b102d42d6bd54ae77848ddc00a4596c
Author: Johan Hovold
Date: Mon Oct 16 15:06:19 2017 +0200
serdev: ttyport: enforce tty-driver open() requirement
[ Upstream commit dee7d0f3b200c67c6ee96bd37c6e8fa52690ab56 ]
The tty-driver open routine is mandatory, but the serdev
tty-port-controller implementation did not treat it as such and would
instead fall back to calling tty\_port\_open() directly.
Signed-off-by: Johan Hovold
Acked-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 669ff2a9aa71edea93a0b74c1273080cad68dfb7
Author: Lipeng
Date: Mon Oct 23 19:51:01 2017 +0800
net: hns3: fix a bug when alloc new buffer
[ Upstream commit b9077428ec5569aacb2952d8a2ffb51c8988d3c2 ]
When alloce new buffer to HW, should unmap the old buffer first.
This old code map the old buffer but not unmap the old buffer,
this patch fixes it.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 122e18d27d77031b909a06f110f6da225502d033
Author: Lipeng
Date: Mon Oct 23 19:51:02 2017 +0800
net: hns3: fix the bug when map buffer fail
[ Upstream commit 564883bb4dc1a4f3cba6344e77743175694b0761 ]
If one buffer had been recieved to stack, driver will alloc a new buffer,
map the buffer to device and replace the old buffer. When map fail, should
only free the new alloced buffer, but not free all buffers in the ring.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9409e1c775f35b2571be427cde272ce80cdc19e7
Author: Lipeng
Date: Mon Oct 23 19:51:05 2017 +0800
net: hns3: fix the TX/RX ring.queue\_index in hns3\_ring\_get\_cfg
[ Upstream commit 66b447301ac710ee237dba8b653244018fbb6168 ]
The interface hns3\_ring\_get\_cfg only update TX ring queue\_index,
but do not update RX ring queue\_index. This patch fixes it.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aeb01451f9e2d3e9b2ac2ad30426c68957c307ed
Author: Alexey Khoroshilov
Date: Sat Oct 14 01:06:56 2017 +0300
mfd: mxs-lradc: Fix error handling in mxs\_lradc\_probe()
[ Upstream commit 362741a21a5c4b9ee31e75ce28d63c6d238a745c ]
There is the only path, where mxs\_lradc\_probe() leaves clk undisabled,
since it does return instead of goto err\_clk.
Found by Linux Driver Verification project (linuxtesting.org).
Signed-off-by: Alexey Khoroshilov
Signed-off-by: Lee Jones
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8268e93b2b879912ae84952acef17e4c78f3b66d
Author: Martin Wilck
Date: Fri Oct 20 16:51:08 2017 -0500
scsi: hpsa: destroy sas transport properties before scsi\_host
[ Upstream commit dfb2e6f46b3074eb85203d8f0888b71ec1c2e37a ]
This patch cleans up a lot of warnings when unloading the driver.
A current example of the stack trace starts with:
[ 142.570715] sysfs group 'power' not found for kobject 'port-5:0'
There can be hundreds of these messages during a driver unload.
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
His original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102085.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
---------------------------
Original patch description:
---------------------------
Unloading the hpsa driver causes warnings
[ 1063.793652] WARNING: CPU: 1 PID: 4850 at ../fs/sysfs/group.c:237 device\_del+0x54/0x240()
[ 1063.793659] sysfs group ffffffff81cf21a0 not found for kobject 'port-2:0'
with two different stacks:
1)
[ 1063.793774] [] device\_del+0x54/0x240
[ 1063.793780] [] transport\_remove\_classdev+0x4a/0x60
[ 1063.793784] [] attribute\_container\_device\_trigger+0xa6/0xb0
[ 1063.793802] [] sas\_port\_delete+0x126/0x160 [scsi\_transport\_sas]
[ 1063.793819] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
2)
[ 1063.797103] [] device\_del+0x54/0x240
[ 1063.797118] [] sas\_port\_delete+0x12e/0x160 [scsi\_transport\_sas]
[ 1063.797134] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
This is caused by the fact that host device hostX is deleted before the
SAS transport devices hostX/port-a:b.
This patch fixes this by reverting the order of device deletions.
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7a7797199d9b96989ab5f30eadad077a8dc7c970
Author: Martin Wilck
Date: Fri Oct 20 16:51:14 2017 -0500
scsi: hpsa: cleanup sas\_phy structures in sysfs when unloading
[ Upstream commit 55ca38b4255bb336c2d35990bdb2b368e19b435a ]
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
The original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102083.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
--------------------------------------
Original patch description from Martin:
--------------------------------------
When the hpsa module is unloaded using rmmod, dangling
symlinks remain under /sys/class/sas\_phy. Fix this by
calling sas\_phy\_delete() rather than sas\_phy\_free (which,
according to comments, should not be called for PHYs that
have been set up successfully, anyway).
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b61aba91eb72efc5117d24d3f4455dcaf67f1e63
Author: Xiaofei Tan
Date: Tue Oct 24 23:51:38 2017 +0800
scsi: hisi\_sas: fix the risk of freeing slot twice
[ Upstream commit 6ba0fbc35aa9f3bc8c12be3b4047055c9ce2ac92 ]
The function hisi\_sas\_slot\_task\_free() is used to free the slot and do
tidy-up of LLDD resources. The LLDD generally should know the state of
a slot and decide when to free it, and it should only be done once.
For some scenarios, we really don't know the state, like when TMF
timeout. In this case, we check task->lldd\_task before calling
hisi\_sas\_slot\_task\_free().
However, we may miss some scenarios when we should also check
task->lldd\_task, and it is not SMP safe to check task->lldd\_task as we
don't protect it within spin lock.
This patch is to fix this risk of freeing slot twice, as follows:
1. Check task->lldd\_task in the hisi\_sas\_slot\_task\_free(), and give
up freeing of this time if task->lldd\_task is NULL.
2. Set slot->buf to NULL after it is freed.
Signed-off-by: Xiaofei Tan
Signed-off-by: John Garry
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 96ed7ca7323be977d617d077146b322e844bdcb9
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18c8d94eac0fd6c859033b2eb05941f19c3f7b4a
Author: Leon Romanovsky
Date: Wed Oct 25 07:41:11 2017 +0300
RDMA/cxgb4: Declare stag as \_\_be32
[ Upstream commit 35fb2a88ed4b77356fa679a8525c869a3594e287 ]
The scqe.stag is actually \_\_b32, fix it.
drivers/infiniband/hw/cxgb4/cq.c:754:52: warning: cast to restricted \_\_be32
Cc: Steve Wise
Signed-off-by: Leon Romanovsky
Reviewed-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9d48d002a2f68e35bea2872a5533436848f30a60
Author: Lipeng
Date: Tue Oct 24 21:02:09 2017 +0800
net: hns3: fix the bug of hns3\_set\_txbd\_baseinfo
[ Upstream commit 7036d26f328f12a323069eb16d965055b4cb3795 ]
The SC bits of TX BD mean switch control. For this area, value 0
indicates no switch control, the packet is routed according to the
forwarding table. Value 1 indicates that the packet is transmitted
to the network bypassing the forwarding table.
As HNS3 driver need support VF later, VF conmunicate with its own
PF need forwarding table. This patch sets SC bits of TX BD 0 and use
forwarding table.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1d9205558e50b7af5fe5b054bf26f93c9255786e
Author: Lipeng
Date: Tue Oct 24 21:02:10 2017 +0800
net: hns3: add nic\_client check when initialize roce base information
[ Upstream commit 3a46f34d20d453f09defb76b11a567647939c0aa ]
Roce driver works base on HNS3 driver.If insmod Roce driver before
NIC driver there is a error because do not check nic\_client. This patch
adds nic\_client check when initialize roce base information.
Fixes: 46a3df9 (net: hns3: Add HNS3 Acceleration Engine & Compatibility Layer Support)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0949f8afa8f1b9d6ebce48606e41dfcdafbaca4a
Author: Lipeng
Date: Tue Oct 24 21:02:11 2017 +0800
net: hns3: fix a bug in hclge\_uninit\_client\_instance
[ Upstream commit a17dcf3f0124698d1120da71574bf4c339e5a368 ]
HNS3 driver initialize hdev->roce\_client and vport->roce.client in
hclge\_init\_client\_instance, and need set hdev->roce\_client and
vport->roce.client NULL.
If do not set them NULL when uninit, it will fail in the scene:
insmod hns3.ko, hns-roce.ko, hns-roce-hw-v3.ko successfully, but
rmmod hns3.ko after rmmod hns-roce-hw-v2.ko and hns-roce.ko.
This patch fixes the issue.
Fixes: 46a3df9 (net: hns3: Add HNS3 Acceleration Engine & Compatibility Layer Support)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 68a6765b70d90debde63bd26599c3422116751ef
Author: Egil Hjelmeland
Date: Tue Oct 24 17:14:10 2017 +0200
net: dsa: lan9303: Do not disable switch fabric port 0 at .probe
[ Upstream commit 3c91b0c1de8d013490bbc41ce9ee8810ea5baddd ]
Make the LAN9303 work when lan9303\_probe() is called twice.
For some unknown reason the LAN9303 switch fail to forward data when switch
fabric port 0 TX is disabled during probe. (Write of LAN9303\_MAC\_TX\_CFG\_0
in lan9303\_disable\_processing\_port().)
In that situation the switch fabric seem to receive frames, because the ALR
is learning addresses. But no frames are transmitted on any of the ports.
In our system lan9303\_probe() is called twice, first time
dsa\_register\_switch() return -EPROBE\_DEFER. As an experiment, modified the
code to skip writing LAN9303\_MAC\_TX\_CFG\_0, port 0 during the first probe.
Then the switch works as expected.
Resolve the problem by not calling lan9303\_disable\_processing\_port() on
port 0 during probe. Ports 1 and 2 are still disabled.
Although unsatisfying that the exact failure mechanism is not known,
the patch should not cause any harm.
Signed-off-by: Egil Hjelmeland
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4be2d1ad59d0d9251bd1fc618a6d1266b16e3b75
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 61bc71d34a00801657591e142f374794b6dc3548
Author: Darrick J. Wong
Date: Tue Oct 17 21:37:32 2017 -0700
xfs: return a distinct error code value for IGET\_INCORE cache misses
[ Upstream commit ed438b476b611c67089760037139f93ea8ed41d5 ]
For an XFS\_IGET\_INCORE iget operation, if the inode isn't in the cache,
return ENODATA so that we don't confuse it with the pre-existing ENOENT
cases (inode is in cache, but freed).
Signed-off-by: Darrick J. Wong
Reviewed-by: Brian Foster
Reviewed-by: Dave Chinner
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 742b570da6e6447e4a98acceb27e8a7d5b436d7c
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ff62605e0d79c870f679bcd8571bf9cb5f7e1c93
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4edcbfc5651276a28a1501e03198f6f16974617c
Author: Christoph Hellwig
Date: Wed Oct 18 13:20:01 2017 +0200
nvme: use kref\_get\_unless\_zero in nvme\_find\_get\_ns
[ Upstream commit 2dd4122854f697afc777582d18548dded03ce5dd ]
For kref\_get\_unless\_zero to protect against lookup vs free races we need
to use it in all places where we aren't guaranteed to already hold a
reference. There is no such guarantee in nvme\_find\_get\_ns, so switch to
kref\_get\_unless\_zero in this function.
Signed-off-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Reviewed-by: Hannes Reinecke
Reviewed-by: Johannes Thumshirn
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 21cd9fe750941100b7b4643ffd765215b6daff64
Author: Osama Khan
Date: Sat Oct 21 10:42:21 2017 +0000
platform/x86: hp\_accel: Add quirk for HP ProBook 440 G4
[ Upstream commit 163ca80013aafb6dc9cb295de3db7aeab9ab43f8 ]
Added support for HP ProBook 440 G4 laptops by including the accelerometer
orientation quirk for that device. Testing was performed based on the
axis orientation guidelines here:
https://www.kernel.org/doc/Documentation/misc-devices/lis3lv02d
which states "If the left side is elevated, X increases (becomes positive)".
When tested, on lifting the left edge, x values became increasingly negative
thus indicating an inverted x-axis on the installed lis3lv02d chip.
This was compensated by adding an entry for this device in hp\_accel.c
specifying the quirk as x\_inverted. The patch was tested on a
ProBook 440 G4 device and x-axis as well as y and z-axis values are now
generated as per spec.
Signed-off-by: Osama Khan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6bd7a9bc48ac642cb3ded1e40fcfee44c8a0aa1a
Author: Felix Manlunas
Date: Thu Oct 26 16:46:36 2017 -0700
liquidio: fix kernel panic in VF driver
[ Upstream commit aa28667cfbe4ff6f14454dda210b1f2e485f99b5 ]
Doing ifconfig down on VF driver in the middle of receiving line rate
traffic causes a kernel panic:
LiquidIO\_VF 0000:02:00.3: should not come here should not get rx when poll mode = 0 for vf
BUG: unable to handle kernel NULL pointer dereference at (null)
.
.
.
Call Trace:
? tasklet\_action+0x102/0x120
\_\_do\_softirq+0x91/0x292
irq\_exit+0xb6/0xc0
do\_IRQ+0x4f/0xd0
common\_interrupt+0x93/0x93

RIP: 0010:cpuidle\_enter\_state+0x142/0x2f0
RSP: 0018:ffffffffa6403e20 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffff59
RAX: 0000000000000000 RBX: 0000000000000003 RCX: 000000000000001f
RDX: 0000000000000000 RSI: 000000002ab7519f RDI: 0000000000000000
RBP: ffffffffa6403e58 R08: 0000000000000084 R09: 0000000000000018
R10: ffffffffa6403df0 R11: 00000000000003c7 R12: 0000000000000003
R13: ffffd27ebd806800 R14: ffffffffa64d40d8 R15: 0000007be072823f
cpuidle\_enter+0x17/0x20
call\_cpuidle+0x23/0x40
do\_idle+0x18c/0x1f0
cpu\_startup\_entry+0x64/0x70
rest\_init+0xa5/0xb0
start\_kernel+0x45e/0x46b
x86\_64\_start\_reservations+0x24/0x26
x86\_64\_start\_kernel+0x6f/0x72
secondary\_startup\_64+0xa5/0xa5
Code: Bad RIP value.
RIP: (null) RSP: ffff9246ed003f28
CR2: 0000000000000000
---[ end trace 92731e80f31b7d7d ]---
Kernel panic - not syncing: Fatal exception in interrupt
Kernel Offset: 0x24000000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
---[ end Kernel panic - not syncing: Fatal exception in interrupt
Reason is: in the function assigned to net\_device\_ops->ndo\_stop, the steps
for bringing down the interface are done in the wrong order. The step that
notifies the NIC firmware to stop forwarding packets to host is done too
late. Fix it by moving that step to the beginning.
Signed-off-by: Felix Manlunas
Signed-off-by: Raghu Vatsavayi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 06f430379273700696eef22159117789853a38e3
Author: Tushar Dave
Date: Fri Oct 27 16:12:30 2017 -0700
samples/bpf: adjust rlimit RLIMIT\_MEMLOCK for xdp1
[ Upstream commit 6dfca831c03ef654b1f7bff1b8d487d330e9f76b ]
Default rlimit RLIMIT\_MEMLOCK is 64KB, causes bpf map failure.
e.g.
[root@lab bpf]#./xdp1 -N $(
Acked-by: Alexei Starovoitov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c0f98c0dbced1c1b48fd4427075f8a5295b402fb
Author: Bartosz Chronowski
Date: Thu Oct 26 10:22:43 2017 +0200
Bluetooth: btusb: Add new NFA344A entry.
[ Upstream commit 858ff38af77fc660092e82474ecc6ac135ed29fe ]
This change allows proper low power mode entry in suspend.
/sys/kernel/debug/usb/devices entry:
T: Bus=01 Lev=01 Prnt=01 Port=05 Cnt=03 Dev#= 3 Spd=12 MxCh= 0
D: Ver= 2.01 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0489 ProdID=e09f Rev= 0.01
C:\* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=1ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 64 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 64 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
Signed-off-by: Bartosz Chronowski
Signed-off-by: Marcel Holtmann
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a54d17dba2ba4a1eaab65fd282f4b4c9bf80418b
Author: Neil Armstrong
Date: Thu Oct 19 12:31:09 2017 +0200
ARM64: dts: meson-gxbb-odroidc2: fix usb1 power supply
[ Upstream commit e841ec956e539f4002f5e9fe9f9e904dcca12d5d ]
Looking at the schematics, the USB Power Supply is shared between the
two USB interfaces,
If the usb0 fails to initialize, the second one won't have power.
Fixes: 5a0803bd5ae2 ("ARM64: dts: meson-gxbb-odroidc2: Enable USB Nodes")
Signed-off-by: Neil Armstrong
Signed-off-by: Kevin Hilman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 000a335b2d3828382bb4612ceee176a5cbd05752
Author: Geert Uytterhoeven
Date: Thu Oct 26 17:12:33 2017 +0200
mtd: spi-nor: stm32-quadspi: Fix uninitialized error return code
[ Upstream commit 05521bd3d117704a1458eb4d0c3ae821858658f2 ]
With gcc 4.1.2:
drivers/mtd/spi-nor/stm32-quadspi.c: In function ‘stm32\_qspi\_tx\_poll’:
drivers/mtd/spi-nor/stm32-quadspi.c:230: warning: ‘ret’ may be used uninitialized in this function
Indeed, if stm32\_qspi\_cmd.len is zero, ret will be uninitialized.
This length is passed from outside the driver using the
spi\_nor.{read,write}{,\_reg}() callbacks.
Several functions in drivers/mtd/spi-nor/spi-nor.c (e.g. write\_enable(),
write\_disable(), and erase\_chip()) call spi\_nor.write\_reg() with a zero
length.
Fix this by returning an explicit zero on success.
Fixes: 0d43d7ab277a048c ("mtd: spi-nor: add driver for STM32 quad spi flash controller")
Signed-off-by: Geert Uytterhoeven
Acked-by: Ludovic Barre
Signed-off-by: Cyrille Pitchen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bca4d7e1a19cfdde2a4a340339e46248a691b196
Author: Sergey Matyukevich
Date: Mon Oct 30 13:13:46 2017 +0300
qtnfmac: modify full Tx queue error reporting
[ Upstream commit e9931f984dd1e80adb3b5e095ef175fe383bc92d ]
Under heavy load it is normal that h/w Tx queue is almost full all the time
and reclaim should be done before transmitting next packet. Warning still
should be reported as well as s/w Tx queues should be stopped in the
case when reclaim failed.
Signed-off-by: Sergey Matyukevich
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c97df8e004de63e50384706d00adb590adcef054
Author: Christophe JAILLET
Date: Sun Sep 10 13:19:38 2017 +0200
btrfs: tests: Fix a memory leak in error handling path in 'run\_test()'
[ Upstream commit 9ca2e97fa3c3216200afe35a3b111ec51cc796d2 ]
If 'btrfs\_alloc\_path()' fails, we must free the resources already
allocated, as done in the other error handling paths in this function.
Signed-off-by: Christophe JAILLET
Reviewed-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 864a5fb1c6066ade93a640a279bcd191952e4181
Author: Colin Ian King
Date: Mon Sep 11 16:15:28 2017 +0100
btrfs: avoid null pointer dereference on fs\_info when calling btrfs\_crit
[ Upstream commit 3993b112dac968612b0b213ed59cb30f50b0015b ]
There are checks on fs\_info in \_\_btrfs\_panic to avoid dereferencing a
null fs\_info, however, there is a call to btrfs\_crit that may also
dereference a null fs\_info. Fix this by adding a check to see if fs\_info
is null and only print the s\_id if fs\_info is non-null.
Detected by CoverityScan CID#401973 ("Dereference after null check")
Fixes: efe120a067c8 ("Btrfs: convert printk to btrfs\_ and fix BTRFS prefix")
Signed-off-by: Colin Ian King
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da76a65a011490a0b0bd9f50d872f26e629d1eed
Author: Anand Jain
Date: Thu Sep 28 14:51:09 2017 +0800
btrfs: undo writable superblocke when sprouting fails
[ Upstream commit 0af2c4bf5a012a40a2f9230458087d7f068339d0 ]
When new device is being added to seed FS, seed FS is marked writable,
but when we fail to bring in the new device, we missed to undo the
writable part. This patch fixes it.
Signed-off-by: Anand Jain
Reviewed-by: Nikolay Borisov
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9e87c49d62f4c5b9ae4a56b8f62865c4712c8d4d
Author: Nikolay Borisov
Date: Thu Sep 28 10:53:17 2017 +0300
btrfs: Explicitly handle btrfs\_update\_root failure
[ Upstream commit 9417ebc8a676487c6ec8825f92fb28f7dbeb5f4b ]
btrfs\_udpate\_root can fail and it aborts the transaction, the correct
way to handle an aborted transaction is to explicitly end with
btrfs\_end\_transaction. Even now the code is correct since
btrfs\_commit\_transaction would handle an aborted transaction but this is
more of an implementation detail. So let's be explicit in handling
failure in btrfs\_update\_root.
Furthermore btrfs\_commit\_transaction can also fail and by ignoring it's
return value we could have left the in-memory copy of the root item in
an inconsistent state. So capture the error value which allows us to
correctly revert the RO/RW flags in case of commit failure.
Signed-off-by: Nikolay Borisov
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4bcbfac98d517eae6d12257aed923347be16930c
Author: Anand Jain
Date: Sat Oct 14 08:34:02 2017 +0800
btrfs: fix false EIO for missing device
[ Upstream commit 102ed2c5ff932439bbbe74c7bd63e6d5baa9f732 ]
When one of the device is missing, bbio\_error() takes care of setting
the error status. And if its only IO that is pending in that stripe, it
fails to check the status of the other IO at %bbio\_error before setting
the error %bi\_status for the %orig\_bio. Fix this by checking if
%bbio->error has exceeded the %bbio->max\_errors.
Reproducer as below fdatasync error is seen intermittently.
mount -o degraded /dev/sdc /btrfs
dd status=none if=/dev/zero of=$(mktemp /btrfs/XXX) bs=4096 count=1 conv=fdatasync
dd: fdatasync failed for ‘/btrfs/LSe’: Input/output error
The reason for the intermittences of the problem is because
the following conditions have to be met, which depends on timing:
In btrfs\_map\_bio()
- the RAID1 the missing device has to be at %dev\_nr = 1
In bbio\_error()
. before bbio\_error() is called the bio of the not-missing
device at %dev\_nr = 0 must be completed so that the below
condition is true
if (atomic\_dec\_and\_test(&bbio->stripes\_pending)) {
Signed-off-by: Anand Jain
Reviewed-by: Liu Bo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7bd6bf08dd5b30dbe0696a7387dedc65a5f9a3e6
Author: Nick Desaulniers
Date: Fri Oct 27 09:33:41 2017 -0700
arm64: prevent regressions in compressed kernel image size when upgrading to binutils 2.27
[ Upstream commit fd9dde6abcb9bfe6c6bee48834e157999f113971 ]
Upon upgrading to binutils 2.27, we found that our lz4 and gzip
compressed kernel images were significantly larger, resulting is 10ms
boot time regressions.
As noted by Rahul:
"aarch64 binaries uses RELA relocations, where each relocation entry
includes an addend value. This is similar to x86\_64. On x86\_64, the
addend values are also stored at the relocation offset for relative
relocations. This is an optimization: in the case where code does not
need to be relocated, the loader can simply skip processing relative
relocations. In binutils-2.25, both bfd and gold linkers did this for
x86\_64, but only the gold linker did this for aarch64. The kernel build
here is using the bfd linker, which stored zeroes at the relocation
offsets for relative relocations. Since a set of zeroes compresses
better than a set of non-zero addend values, this behavior was resulting
in much better lz4 compression.
The bfd linker in binutils-2.27 is now storing the actual addend values
at the relocation offsets. The behavior is now consistent with what it
does for x86\_64 and what gold linker does for both architectures. The
change happened in this upstream commit:
https://sourceware.org/git/?p=binutils-gdb.git;a=commit;h=1f56df9d0d5ad89806c24e71f296576d82344613
Since a bunch of zeroes got replaced by non-zero addend values, we see
the side effect of lz4 compressed image being a bit bigger.
To get the old behavior from the bfd linker, "--no-apply-dynamic-relocs"
flag can be used:
$ LDFLAGS="--no-apply-dynamic-relocs" make
With this flag, the compressed image size is back to what it was with
binutils-2.25.
If the kernel is using ASLR, there aren't additional runtime costs to
--no-apply-dynamic-relocs, as the relocations will need to be applied
again anyway after the kernel is relocated to a random address.
If the kernel is not using ASLR, then presumably the current default
behavior of the linker is better. Since the static linker performed the
dynamic relocs, and the kernel is not moved to a different address at
load time, it can skip applying the relocations all over again."
Some measurements:
$ ld -v
GNU ld (binutils-2.25-f3d35cf6) 2.25.51.20141117
^
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300652760 Oct 26 11:57 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932627 Oct 26 11:57 Image.lz4-dtb
$ ld -v
GNU ld (binutils-2.27-53dd00a1) 2.27.0.20170315
^
pre patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 11:43 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 18159474 Oct 26 11:43 Image.lz4-dtb
post patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 12:06 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932466 Oct 26 12:06 Image.lz4-dtb
By Siqi's measurement w/ gzip:
binutils 2.27 with this patch (with --no-apply-dynamic-relocs):
Image 41535488
Image.gz 13404067
binutils 2.27 without this patch (without --no-apply-dynamic-relocs):
Image 41535488
Image.gz 14125516
Any compression scheme should be able to get better results from the
longer runs of zeros, not just GZIP and LZ4.
10ms boot time savings isn't anything to get excited about, but users of
arm64+compression+bfd-2.27 should not have to pay a penalty for no
runtime improvement.
Reported-by: Gopinath Elanchezhian
Reported-by: Sindhuri Pentyala
Reported-by: Wei Wang
Suggested-by: Ard Biesheuvel
Suggested-by: Rahul Chaudhry
Suggested-by: Siqi Lin
Suggested-by: Stephen Hines
Signed-off-by: Nick Desaulniers
Reviewed-by: Ard Biesheuvel
[will: added comment to Makefile]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e508e6026b198b9879e0d1850fdef8ef1d4d0805
Author: Ronald Tschalär
Date: Wed Oct 25 22:15:19 2017 -0700
Bluetooth: hci\_ldisc: Fix another race when closing the tty.
[ Upstream commit 0338b1b393ec7910898e8f7b25b3bf31a7282e16 ]
The following race condition still existed:
P1 P2
cancel\_work\_sync()
hci\_uart\_tx\_wakeup()
hci\_uart\_write\_work()
hci\_uart\_dequeue()
clear\_bit(HCI\_UART\_PROTO\_READY)
hci\_unregister\_dev(hdev)
hci\_free\_dev(hdev)
hu->proto->close(hu)
kfree(hu)
access to hdev and hu
Cancelling the work after clearing the HCI\_UART\_PROTO\_READY bit avoids
this as any hci\_uart\_tx\_wakeup() issued after the flag is cleared will
detect that and not schedule further work.
Signed-off-by: Ronald Tschalär
Reviewed-by: Lukas Wunner
Signed-off-by: Marcel Holtmann
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7d1beb462e18b55fa5d0990d0f60fbf4edfda61b
Author: Patel Jay P
Date: Mon Oct 23 06:05:53 2017 -0700
Ib/hfi1: Return actual operational VLs in port info query
[ Upstream commit 00f9203119dd2774564407c7a67b17d81916298b ]
\_\_subn\_get\_opa\_portinfo stores value returned by hfi1\_get\_ib\_cfg() as
operational vls. hfi1\_get\_ib\_cfg() returns vls\_operational field in
hfi1\_pportdata. The problem with this is that the value is always equal
to vls\_supported field in hfi1\_pportdata.
The logic to calculate operational\_vls is to set value passed by FM
(in \_\_subn\_set\_opa\_portinfo routine). If no value is passed then
default value is stored in operational\_vls.
Field actual\_vls\_operational is calculated on the basis of buffer
control table. Hence, modifying hfi1\_get\_ib\_cfg() to return
actual\_operational\_vls when used with HFI1\_IB\_CFG\_OP\_VLS parameter
Reviewed-by: Mike Marciniszyn
Reviewed-by: Dennis Dalessandro
Signed-off-by: Patel Jay P
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d5860344c243308c0d5e9751553d52d957b29e5b
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c9973b3d35267028edf8b9a4df6310161bd0ef37
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 81309f8b9b69913233733ed61c4c87dab5436902
Author: Arun Kumar Neelakantam
Date: Mon Oct 30 11:11:24 2017 +0530
rpmsg: glink: Initialize the "intent\_req\_comp" completion variable
[ Upstream commit 2394facb17bcace4b3c19b50202177a5d8903b64 ]
The "intent\_req\_comp" variable is used without initialization which
results in NULL pointer dereference in qcom\_glink\_request\_intent().
we need to initialize the completion variable before using it.
Fixes: 27b9c5b66b23 ("rpmsg: glink: Request for intents when unavailable")
Signed-off-by: Arun Kumar Neelakantam
Signed-off-by: Bjorn Andersson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7291d99ebc67be887e5c915489706e6fe720992a
Author: Adam Sampson
Date: Tue Oct 24 16:14:46 2017 -0400
media: usbtv: fix brightness and contrast controls
[ Upstream commit b3168c87c0492661badc3e908f977d79e7738a41 ]
Because the brightness and contrast controls share a register,
usbtv\_s\_ctrl needs to read the existing values for both controls before
inserting the new value. However, the code accidentally wrote to the
registers (from an uninitialised stack array), rather than reading them.
The user-visible effect of this was that adjusting the brightness would
also set the contrast to a random value, and vice versa -- so it wasn't
possible to correctly adjust the brightness of usbtv's video output.
Tested with an "EasyDAY" UTV007 device.
Fixes: c53a846c48f2 ("usbtv: add video controls")
Signed-off-by: Adam Sampson
Reviewed-by: Lubomir Rintel
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1678bb970113e62469ca510bff20eb95bbdeaec2
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aa902be00448f3bc69fd54b1a0a8f5b4b6a47c5b
Author: Douglas Gilbert
Date: Sun Oct 29 10:47:19 2017 -0400
scsi: scsi\_debug: write\_same: fix error report
[ Upstream commit e33d7c56450b0a5c7290cbf9e1581fab5174f552 ]
The scsi\_debug driver incorrectly suggests there is an error with the
SCSI WRITE SAME command when the number\_of\_logical\_blocks is greater
than 1. It will also suggest there is an error when NDOB
(no data-out buffer) is set and the number\_of\_logical\_blocks is
greater than 0. Both are valid, fix.
Signed-off-by: Douglas Gilbert
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 95e8d653ea987adfe108173bd5969201a363bf19
Author: Dan Carpenter
Date: Sat Sep 30 11:16:51 2017 +0300
misc: pci\_endpoint\_test: Avoid triggering a BUG()
[ Upstream commit 846df244ebefbc9f7b91e9ae7a5e5a2e69fb4772 ]
If you call ida\_simple\_remove(&pci\_endpoint\_test\_ida, id) with a
negative "id" then it triggers an immediate BUG\_ON(). Let's not allow
that.
Fixes: 2c156ac71c6b ("misc: Add host side PCI driver for PCI test function device")
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 85d63b76bdd1b570b9c16e60f83eb3185e22b30d
Author: Kishon Vijay Abraham I
Date: Wed Oct 11 14:14:36 2017 +0530
misc: pci\_endpoint\_test: Fix failure path return values in probe
[ Upstream commit 80068c93688f6143100859c4856f895801c1a1d9 ]
Return value of pci\_endpoint\_test\_probe is not set properly in a couple of
failure cases. Fix it here.
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5642562d0b4f616cac2b4d7f81de0a58f2247b59
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 556787a174e6f77c7aec167af846f1297e3860f8
Author: Kuninori Morimoto
Date: Wed Nov 1 07:16:58 2017 +0000
ASoC: rsnd: rsnd\_ssi\_run\_mods() needs to care ssi\_parent\_mod
[ Upstream commit 21781e87881f9c420871b1d1f3f29d4cd7bffb10 ]
SSI parent mod might be NULL. ssi\_parent\_mod() needs to care
about it. Otherwise, it uses negative shift.
This patch fixes it.
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f7ee900a4f2c76902ce368e93d34b7580cc7ff04
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d213c4c0a9b0d8fb0958d4a461868525ee6d864
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a23c8c70b5ece8d18c49927a0bace4471d8563cb
Author: Nicolin Chen
Date: Fri Sep 15 12:10:13 2017 -0700
clk: tegra: Use readl\_relaxed\_poll\_timeout\_atomic() in tegra210\_clock\_init()
[ Upstream commit 22ef01a203d27fee8b7694020b7e722db7efd2a7 ]
Below is the call trace of tegra210\_init\_pllu() function:
start\_kernel()
-> time\_init()
--> of\_clk\_init()
---> tegra210\_clock\_init()
----> tegra210\_pll\_init()
-----> tegra210\_init\_pllu()
Because the preemption is disabled in the start\_kernel before calling
time\_init, tegra210\_init\_pllu is actually in an atomic context while
it includes a readl\_relaxed\_poll\_timeout that might sleep.
So this patch just changes this readl\_relaxed\_poll\_timeout() to its
atomic version.
Signed-off-by: Nicolin Chen
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 85dcb3c850a79751b2239f434a4b6b36a75a865e
Author: Ming Lei
Date: Sat Oct 14 17:22:25 2017 +0800
blk-mq-sched: dispatch from scheduler IFF progress is made in ->dispatch
[ Upstream commit 5e3d02bbafad38975099b5848f5ebadedcf7bb7e ]
When the hw queue is busy, we shouldn't take requests from the scheduler
queue any more, otherwise it is difficult to do IO merge.
This patch fixes the awful IO performance on some SCSI devices(lpfc,
qla2xxx, ...) when mq-deadline/kyber is used by not taking requests if
hw queue is busy.
Reviewed-by: Omar Sandoval
Reviewed-by: Bart Van Assche
Reviewed-by: Christoph Hellwig
Signed-off-by: Ming Lei
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6facfe25e62e702304591bd114bcf7d6067c86e4
Author: Leo Yan
Date: Fri Sep 1 08:47:14 2017 +0800
clk: hi6220: mark clock cs\_atb\_syspll as critical
[ Upstream commit d2a3671ebe6479483a12f94fcca63c058d95ad64 ]
Clock cs\_atb\_syspll is pll used for coresight trace bus; when clock
cs\_atb\_syspll is disabled and operates its child clock node cs\_atb
results in system hang. So mark clock cs\_atb\_syspll as critical to
keep it enabled.
Cc: Guodong Xu
Cc: Zhangfei Gao
Cc: Haojian Zhuang
Signed-off-by: Leo Yan
Signed-off-by: Michael Turquette
Link: lkml.kernel.org/r/1504226835-2115-2-git-send-email-leo.yan@linaro.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d9e497c9424896581b18f0807652364180401c7b
Author: Mauro Carvalho Chehab
Date: Wed Nov 1 08:09:59 2017 -0400
media: camss-vfe: always initialize reg at vfe\_set\_xbar\_cfg()
[ Upstream commit 9917fbcfa20ab987d6381fd0365665e5c1402d75 ]
if output->wm\_num is bigger than 2, the value for reg is
not initialized, as warned by smatch:
drivers/media/platform/qcom/camss-8x16/camss-vfe.c:633 vfe\_set\_xbar\_cfg() error: uninitialized symbol 'reg'.
drivers/media/platform/qcom/camss-8x16/camss-vfe.c:637 vfe\_set\_xbar\_cfg() error: uninitialized symbol 'reg'.
That shouldn't happen in practice, so add a logic that will
break the loop if i > 1, fixing the warnings.
Signed-off-by: Mauro Carvalho Chehab
Acked-by: Todor Tomov
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit de0bbe07a49ce9bf5bc4fc1846bd453151e7a334
Author: Sébastien Szymanski
Date: Tue Aug 1 12:40:07 2017 +0200
clk: imx6: refine hdmi\_isfr's parent to make HDMI work on i.MX6 SoCs w/o VPU
[ Upstream commit c68ee58d9ee7b856ac722f18f4f26579c8fbd2b4 ]
On i.MX6 SoCs without VPU (in my case MCIMX6D4AVT10AC), the hdmi driver
fails to probe:
[ 2.540030] dwhdmi-imx 120000.hdmi: Unsupported HDMI controller
(0000:00:00)
[ 2.548199] imx-drm display-subsystem: failed to bind 120000.hdmi
(ops dw\_hdmi\_imx\_ops): -19
[ 2.557403] imx-drm display-subsystem: master bind failed: -19
That's because hdmi\_isfr's parent, video\_27m, is not correctly ungated.
As explained in commit 5ccc248cc537 ("ARM: imx6q: clk: Add support for
mipi\_core\_cfg clock as a shared clock gate"), video\_27m is gated by
CCM\_CCGR3[CG8].
On i.MX6 SoCs with VPU, the hdmi is working thanks to the
CCM\_CMEOR[mod\_en\_ov\_vpu] bit which makes the video\_27m ungated whatever
is in CCM\_CCGR3[CG8]. The issue can be reproduced by setting
CCMEOR[mod\_en\_ov\_vpu] to 0.
Make the HDMI work in every case by setting hdmi\_isfr's parent to
mipi\_core\_cfg.
Signed-off-by: Sébastien Szymanski
Reviewed-by: Fabio Estevam
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27731e18a571b07c4042d83679184c78957bac1a
Author: Adriana Reus
Date: Mon Oct 2 13:32:10 2017 +0300
clk: imx: imx7d: Fix parent clock for OCRAM\_CLK
[ Upstream commit edc5a8e754aba9c6eaeddd18cb1e72462f99b16c ]
The parent of OCRAM\_CLK should be axi\_main\_root\_clk
and not axi\_post\_div.
before:
axi\_src 1 1 332307692 0 0
axi\_cg 1 1 332307692 0 0
axi\_pre\_div 1 1 332307692 0 0
axi\_post\_div 1 1 332307692 0 0
ocram\_clk 0 0 332307692 0 0
main\_axi\_root\_clk 1 1 332307692 0 0
after:
axi\_src 1 1 332307692 0 0
axi\_cg 1 1 332307692 0 0
axi\_pre\_div 1 1 332307692 0 0
axi\_post\_div 1 1 332307692 0 0
main\_axi\_root\_clk 1 1 332307692 0 0
ocram\_clk 0 0 332307692 0 0
Reference Doc: i.MX 7D Reference Manual - Chap 5, p 516
(https://www.nxp.com/docs/en/reference-manual/IMX7DRM.pdf)
Fixes: 8f6d8094b215 ("ARM: imx: add imx7d clk tree support")
Signed-off-by: Adriana Reus
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3c38ce8767c6203bf3d479a570ece2a38502ac6b
Author: Chen Zhong
Date: Thu Oct 5 11:50:23 2017 +0800
clk: mediatek: add the option for determining PLL source clock
[ Upstream commit c955bf3998efa3355790a4d8c82874582f1bc727 ]
Since the previous setup always sets the PLL using crystal 26MHz, this
doesn't always happen in every MediaTek platform. So the patch added
flexibility for assigning extra member for determining the PLL source
clock.
Signed-off-by: Chen Zhong
Signed-off-by: Sean Wang
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3c5fed838b473e565e44ada69ff51e07317e2c8a
Author: Hans de Goede
Date: Thu Nov 2 10:30:11 2017 +0100
staging: rtl8188eu: Revert part of "staging: rtl8188eu: fix comments with lines over 80 characters"
[ Upstream commit 4004a9870bbefdb6644c3d2033f5315920a3b669 ]
Commit 74e1e498e84e ("staging: rtl8188eu: fix comments with lines over 80
characters") not only changed comments but also changed an if check:
-if (pmlmepriv->cur\_network.join\_res != true) {
+if (!(pmlmepriv->cur\_network.join\_res)) {
This is not equivalent as join\_res is an int and can have values such
as -2 and -3.
Note for the next time, please only make one type of changes in a single
clean-up commit.
Fixes: 74e1e498e84e ("staging: rtl8188eu: fix comments with lines over 80 ...")
Cc: Juliana Rodrigues
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7018a57cf7018dca6469d73b485d4a35cea97649
Author: qumingguang
Date: Thu Nov 2 20:45:22 2017 +0800
net: hns3: Fix a misuse to devm\_free\_irq
[ Upstream commit ae064e6123f89f90af7e4ea190cc0c612643ca93 ]
we should use free\_irq to free the nic irq during the unloading time.
because we use request\_irq to apply it when nic up. It will crash if
up net device after reset the port. This patch fixes the issue.
Signed-off-by: qumingguang
Signed-off-by: Lipeng
Signed-off-by: Yunsheng Lin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 62785073959347a14eecb395e810a97e745996f2
Author: Fuyun Liang
Date: Fri Nov 3 12:18:26 2017 +0800
net: hns3: fix for getting advertised\_caps in hns3\_get\_link\_ksettings
[ Upstream commit 2b39cabb2a283cea0c3d96d9370575371726164f ]
This patch fixes a bug for ethtool's get\_link\_ksettings().
The advertising for autoneg is always added to advertised\_caps
whether autoneg is enable or disable. This patch fixes it.
Fixes: 496d03e (net: hns3: Add Ethtool support to HNS3 driver)
Signed-off-by: Fuyun Liang
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f58a90e027d8ff3f24e20429500f0923663afbd4
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6479a108b35857674ca2a74e049e3089d12ee444
Author: Robert Baronescu
Date: Tue Oct 10 13:22:00 2017 +0300
crypto: tcrypt - fix buffer lengths in test\_aead\_speed()
[ Upstream commit 7aacbfcb331ceff3ac43096d563a1f93ed46e35e ]
Fix the way the length of the buffers used for
encryption / decryption are computed.
For e.g. in case of encryption, input buffer does not contain
an authentication tag.
Signed-off-by: Robert Baronescu
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ade07fa32f5ab083d558199e906d612b5d535553
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 79f41e0f8ae0e3298bfcfd8c085b5242add83e9b
Author: Eryu Guan
Date: Wed Nov 1 21:43:50 2017 -0700
xfs: truncate pagecache before writeback in xfs\_setattr\_size()
[ Upstream commit 350976ae21873b0d36584ea005076356431b8f79 ]
On truncate down, if new size is not block size aligned, we zero the
rest of block to avoid exposing stale data to user, and
iomap\_truncate\_page() skips zeroing if the range is already in
unwritten state or a hole. Then we writeback from on-disk i\_size to
the new size if this range hasn't been written to disk yet, and
truncate page cache beyond new EOF and set in-core i\_size.
The problem is that we could write data between di\_size and newsize
before removing the page cache beyond newsize, as the extents may
still be in unwritten state right after a buffer write. As such, the
page of data that newsize lies in has not been zeroed by page cache
invalidation before it is written, and xfs\_do\_writepage() hasn't
triggered it's "zero data beyond EOF" case because we haven't
updated in-core i\_size yet. Then a subsequent mmap read could see
non-zeros past EOF.
I occasionally see this in fsx runs in fstests generic/112, a
simplified fsx operation sequence is like (assuming 4k block size
xfs):
fallocate 0x0 0x1000 0x0 keep\_size
write 0x0 0x1000 0x0
truncate 0x0 0x800 0x1000
punch\_hole 0x0 0x800 0x800
mapread 0x0 0x800 0x800
where fallocate allocates unwritten extent but doesn't update
i\_size, buffer write populates the page cache and extent is still
unwritten, truncate skips zeroing page past new EOF and writes the
page to disk, punch\_hole invalidates the page cache, at last mapread
reads the block back and sees non-zero beyond EOF.
Fix it by moving truncate\_setsize() to before writeback so the page
cache invalidation zeros the partial page at the new EOF. This also
triggers "zero data beyond EOF" in xfs\_do\_writepage() at writeback
time, because newsize has been set and page straddles the newsize.
Also fixed the wrong 'end' param of filemap\_write\_and\_wait\_range()
call while we're at it, the 'end' is inclusive and should be
'newsize - 1'.
Suggested-by: Dave Chinner
Signed-off-by: Eryu Guan
Acked-by: Dave Chinner
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 07a93b48a0f73e0cb74355a7dd80c6ad55bed674
Author: Gary R Hook
Date: Fri Nov 3 10:50:34 2017 -0600
iommu/amd: Limit the IOVA page range to the specified addresses
[ Upstream commit b92b4fb5c14257c0e7eae291ecc1f7b1962e1699 ]
The extent of pages specified when applying a reserved region should
include up to the last page of the range, but not the page following
the range.
Signed-off-by: Gary R Hook
Fixes: 8d54d6c8b8f3 ('iommu/amd: Implement apply\_dm\_region call-back')
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ddf2588a05c820b305bc6db2fe6e498a3bc6fde9
Author: Liu Bo
Date: Fri Nov 3 11:24:44 2017 -0600
badblocks: fix wrong return value in badblocks\_set if badblocks are disabled
[ Upstream commit 39b4954c0a1556f8f7f1fdcf59a227117fcd8a0b ]
MD's rdev\_set\_badblocks() expects that badblocks\_set() returns 1 if
badblocks are disabled, otherwise, rdev\_set\_badblocks() will record
superblock changes and return success in that case and md will fail to
report an IO error which it should.
This bug has existed since badblocks were introduced in commit
9e0e252a048b ("badblocks: Add core badblock management code").
Signed-off-by: Liu Bo
Acked-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f6a341e87c656f1e2e9959cfdd2d02561724558f
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 23d3f106f88ca21fd2911ae2f3a4f8aa7b56fddc
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e389507ad355226019147985c29a5b4282aa1e4d
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 68d702c6689d83000060118f940e0adce88e42aa
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 96d275b841efc6decf61afafc1703f0e9b92253d
Author: Bart Van Assche
Date: Tue Oct 31 11:03:18 2017 -0700
target/iscsi: Detect conn\_cmd\_list corruption early
[ Upstream commit 6eaf69e4ec075f5af236c0c89f75639a195db904 ]
Certain behavior of the initiator can cause the target driver to
send both a reject and a SCSI response. If that happens two
target\_put\_sess\_cmd() calls will occur without the command having
been removed from conn\_cmd\_list. In other words, conn\_cmd\_list
will get corrupted once the freed memory is reused. Although the
Linux kernel can detect list corruption if list debugging is
enabled, in this case the context in which list corruption is
detected is not related to the context that caused list corruption.
Hence add WARN\_ON() statements that report the context that is
causing list corruption.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c90db58f5bb6d5ba203815e28cb5e7eb20b86b27
Author: Kuppuswamy Sathyanarayanan
Date: Sun Oct 29 02:49:54 2017 -0700
platform/x86: intel\_punit\_ipc: Fix resource ioremap warning
[ Upstream commit 6cc8cbbc8868033f279b63e98b26b75eaa0006ab ]
For PUNIT device, ISPDRIVER\_IPC and GTDDRIVER\_IPC resources are not
mandatory. So when PMC IPC driver creates a PUNIT device, if these
resources are not available then it creates dummy resource entries for
these missing resources. But during PUNIT device probe, doing ioremap on
these dummy resources generates following warning messages.
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
This patch fixes this issue by adding extra check for resource size
before performing ioremap operation.
Signed-off-by: Kuppuswamy Sathyanarayanan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f8b31d88a698909f0bcc4142e4637e2baee5c320
Author: Tyrel Datwyler
Date: Thu Sep 28 20:19:20 2017 -0400
powerpc/pseries/vio: Dispose of virq mapping on vdevice unregister
[ Upstream commit b8f89fea599d91e674497aad572613eb63181f31 ]
When a vdevice is DLPAR removed from the system the vio subsystem
doesn't bother unmapping the virq from the irq\_domain. As a result we
have a virq mapped to a hardware irq that is no longer valid for the
irq\_domain. A side effect is that we are left with /proc/irq/
affinity entries, and attempts to modify the smp\_affinity of the irq
will fail.
In the following observed example the kernel log is spammed by
ics\_rtas\_set\_affinity errors after the removal of a VSCSI adapter.
This is a result of irqbalance trying to adjust the affinity every 10
seconds.
rpadlpar\_io: slot U8408.E8E.10A7ACV-V5-C25 removed
ics\_rtas\_set\_affinity: ibm,set-xive irq=655385 returns -3
ics\_rtas\_set\_affinity: ibm,set-xive irq=655385 returns -3
This patch fixes the issue by calling irq\_dispose\_mapping() on the
virq of the viodev on unregister.
Fixes: f2ab6219969f ("powerpc/pseries: Add PFO support to the VIO bus")
Signed-off-by: Tyrel Datwyler
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0fe5286e49d4e1fe7eba347302b3d3dee217eade
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2637cb1e3d8086cd31a96e60c3e7e0aa74c043f4
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d815f4efbb2a04e57632fc4daa6ebaf5fca52123
Author: KUWAZAWA Takuya
Date: Sun Oct 15 20:54:10 2017 +0900
netfilter: ipvs: Fix inappropriate output of procfs
[ Upstream commit c5504f724c86ee925e7ffb80aa342cfd57959b13 ]
Information about ipvs in different network namespace can be seen via procfs.
How to reproduce:
# ip netns add ns01
# ip netns add ns02
# ip netns exec ns01 ip a add dev lo 127.0.0.1/8
# ip netns exec ns02 ip a add dev lo 127.0.0.1/8
# ip netns exec ns01 ipvsadm -A -t 10.1.1.1:80
# ip netns exec ns02 ipvsadm -A -t 10.1.1.2:80
The ipvsadm displays information about its own network namespace only.
# ip netns exec ns01 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.1:80 wlc
# ip netns exec ns02 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.2:80 wlc
But I can see information about other network namespace via procfs.
# ip netns exec ns01 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010101:0050 wlc
TCP 0A010102:0050 wlc
# ip netns exec ns02 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010102:0050 wlc
Signed-off-by: KUWAZAWA Takuya
Acked-by: Julian Anastasov
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c4e7af283374329a6eca97dfa782d710417f3e19
Author: Gustavo A. R. Silva
Date: Sat Nov 4 23:52:54 2017 -0500
thunderbolt: tb: fix use after free in tb\_activate\_pcie\_devices
[ Upstream commit a2e373438f72391493a4425efc1b82030b6b4fd5 ]
Add a ̣̣continue statement in order to avoid using a previously
free'd pointer tunnel in list\_add.
Addresses-Coverity-ID: 1415336
Fixes: 9d3cce0b6136 ("thunderbolt: Introduce thunderbolt bus and connection manager")
Signed-off-by: Gustavo A. R. Silva
Acked-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 837da470dc16168a4ea75989b0f902efe795dda4
Author: Matthias Brugger
Date: Mon Oct 30 12:37:55 2017 +0100
iommu/mediatek: Fix driver name
[ Upstream commit 395df08d2e1de238a9c8c33fdcd0e2160efd63a9 ]
There exist two Mediatek iommu drivers for the two different
generations of the device. But both drivers have the same name
"mtk-iommu". This breaks the registration of the second driver:
Error: Driver 'mtk-iommu' is already registered, aborting...
Fix this by changing the name for first generation to
"mtk-iommu-v1".
Fixes: b17336c55d89 ("iommu/mediatek: add support for mtk iommu generation one HW")
Signed-off-by: Matthias Brugger
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fe1c1819b4340f53ac2da07991c810fceaf06bba
Author: Mika Westerberg
Date: Fri Oct 13 21:35:43 2017 +0300
PCI: Do not allocate more buses than available in parent
[ Upstream commit a20c7f36bd3d20d245616ae223bb9d05dfb6f050 ]
One can ask more buses to be reserved for hotplug bridges by passing
pci=hpbussize=N in the kernel command line. If the parent bus does not
have enough bus space available we incorrectly create child bus with the
requested number of subordinate buses.
In the example below hpbussize is set to one more than we have available
buses in the root port:
pci 0000:07:00.0: [8086:1578] type 01 class 0x060400
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 0
pci 0000:07:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 1
pci\_bus 0000:08: busn\_res: can not insert [bus 08-ff] under [bus 07-3f] (conflicts with (null) [bus 07-3f])
pci\_bus 0000:08: scanning bus
...
pci\_bus 0000:0a: bus scan returning with max=40
pci\_bus 0000:0a: busn\_res: [bus 0a-ff] end is updated to 40
pci\_bus 0000:0a: [bus 0a-40] partially hidden behind bridge 0000:07 [bus 07-3f]
pci\_bus 0000:08: bus scan returning with max=40
pci\_bus 0000:08: busn\_res: [bus 08-ff] end is updated to 40
Instead of allowing this, limit the subordinate number to be less than or
equal the maximum subordinate number allocated for the parent bus (if it
has any).
Signed-off-by: Mika Westerberg
[bhelgaas: remove irrelevant dmesg messages]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9565e1e078329da7c92dd6812685bf8a2dd9b8e
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27a12c783e700be095c39abe2749a20c3ab8ea11
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 540236e28f32749f5d1711020fbcab5be3afbf7f
Author: Wei Yongjun
Date: Mon Nov 6 11:11:28 2017 +0000
mlxsw: spectrum: Fix error return code in mlxsw\_sp\_port\_create()
[ Upstream commit d86fd113ebbb37726ef7c7cc6fd6d5ce377455d6 ]
Fix to return a negative error code from the VID create error handling
case instead of 0, as done elsewhere in this function.
Fixes: c57529e1d5d8 ("mlxsw: spectrum: Replace vPorts with Port-VLAN")
Signed-off-by: Wei Yongjun
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ac6864737c0240499f1cd0689cd61b2bad6e04c8
Author: Peter Ujfalusi
Date: Wed Nov 8 12:02:25 2017 +0200
dmaengine: ti-dma-crossbar: Correct am335x/am43xx mux value type
[ Upstream commit 288e7560e4d3e259aa28f8f58a8dfe63627a1bf6 ]
The used 0x1f mask is only valid for am335x family of SoC, different family
using this type of crossbar might have different number of electable
events. In case of am43xx family 0x3f mask should have been used for
example.
Instead of trying to handle each family's mask, just use u8 type to store
the mux value since the event offsets are aligned to byte offset.
Fixes: 42dbdcc6bf965 ("dmaengine: ti-dma-crossbar: Add support for crossbar on AM33xx/AM43xx")
Signed-off-by: Peter Ujfalusi
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b1d0ddc83e3cb2b9e5641ee52f235fcf463fd1d8
Author: Pankaj Bharadiya
Date: Tue Nov 7 16:16:19 2017 +0530
ASoC: Intel: Skylake: Fix uuid\_module memory leak in failure case
[ Upstream commit f8e066521192c7debe59127d90abbe2773577e25 ]
In the loop that adds the uuid\_module to the uuid\_list list, allocated
memory is not properly freed in the error path free uuid\_list whenever
any of the memory allocation in the loop fails to avoid memory leak.
Signed-off-by: Pankaj Bharadiya
Signed-off-by: Guneshwor Singh
Acked-By: Vinod Koul
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 32f733a8f470bf37b77da08d60868aace87f78f7
Author: Rajat Jain
Date: Tue Oct 31 14:44:24 2017 -0700
PM / s2idle: Clear the events\_check\_enabled flag
[ Upstream commit 95b982b45122c57da2ee0b46cce70775e1d987af ]
Problem: This flag does not get cleared currently in the suspend or
resume path in the following cases:
\* In case some driver's suspend routine returns an error.
\* Successful s2idle case
\* etc?
Why is this a problem: What happens is that the next suspend attempt
could fail even though the user did not enable the flag by writing to
/sys/power/wakeup\_count. This is 1 use case how the issue can be seen
(but similar use case with driver suspend failure can be thought of):
1. Read /sys/power/wakeup\_count
2. echo count > /sys/power/wakeup\_count
3. echo freeze > /sys/power/wakeup\_count
4. Let the system suspend, and wakeup the system using some wake source
that calls pm\_wakeup\_event() e.g. power button or something.
5. Note that the combined wakeup count would be incremented due
to the pm\_wakeup\_event() in the resume path.
6. After resuming the events\_check\_enabled flag is still set.
At this point if the user attempts to freeze again (without writing to
/sys/power/wakeup\_count), the suspend would fail even though there has
been no wake event since the past resume.
Address that by clearing the flag just before a resume is completed,
so that it is always cleared for the corner cases mentioned above.
Signed-off-by: Rajat Jain
Acked-by: Pavel Machek
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c4760b9c8d06f541d37784afb3bbeaf895346b9b
Author: Pixel Ding
Date: Wed Nov 8 10:20:01 2017 +0800
drm/amdgpu: bypass lru touch for KIQ ring submission
[ Upstream commit dce1e131dd4dc68099ff1b70aa03cd2d0acf8639 ]
KIQ ring submission is used for register accessing on SRIOV
VF that could happen both in irq enabled and irq disabled cases.
Inversion lock could happen on adev->ring\_lru\_list\_lock, while
this operation is useless and just adds overhead in this use
case.
Signed-off-by: Pixel Ding
Reviewed-by: Monk Liu
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 73e31f2af17843c640fd7e0c8d73f13773dd1777
Author: Arnd Bergmann
Date: Tue Nov 7 11:46:05 2017 +0100
scsi: aacraid: use timespec64 instead of timeval
[ Upstream commit 820f188659122602ab217dd80cfa32b3ac0c55c0 ]
aacraid passes the current time to the firmware in one of two ways,
either as year/month/day/... or as 32-bit unsigned seconds.
The first one is broken on 32-bit architectures as it cannot go past
year 2038. Using timespec64 here makes it behave properly on both 32-bit
and 64-bit architectures, and avoids relying on signed integer overflow
to pass times into the second interface.
The interface used in aac\_send\_hosttime() however is still problematic
in year 2106 when 32-bit seconds overflow. Hopefully we don't have to
worry about aacraid by that time.
Signed-off-by: Arnd Bergmann
Reviewed-by: Dave Carroll
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28461320cc952e8a971ec415743ae97120937fbd
Author: Philipp Zabel
Date: Tue Nov 7 13:12:17 2017 +0100
rtc: pcf8563: fix output clock rate
[ Upstream commit a3350f9c57ffad569c40f7320b89da1f3061c5bb ]
The pcf8563\_clkout\_recalc\_rate function erroneously ignores the
frequency index read from the CLKO register and always returns
32768 Hz.
Fixes: a39a6405d5f9 ("rtc: pcf8563: add CLKOUT to common clock framework")
Signed-off-by: Philipp Zabel
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d6f59ef5b840c5815430d63bb08e8dcbd9e2a132
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit df235d2ee36e70a43b122c0eb34064794ef4464c
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 456279d0e3ad7cb3b6b90aeb07c189c7f8590ab0
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9a40df232448539f6586f9a0c72ca89fd694fbe
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 71307dd192e7ac012894dfebd9c47cb5afc0611b
Author: Robert Stonehouse
Date: Tue Nov 7 17:30:30 2017 +0000
sfc: don't warn on successful change of MAC
[ Upstream commit cbad52e92ad7f01f0be4ca58bde59462dc1afe3a ]
Fixes: 535a61777f44e ("sfc: suppress handled MCDI failures when changing the MAC address")
Signed-off-by: Bert Kenward
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dba1ca0e9a6fc57703eaa3c8d7293b8efc72c2af
Author: Sébastien Szymanski
Date: Fri Nov 10 10:01:43 2017 +0100
HID: cp2112: fix broken gpio\_direction\_input callback
[ Upstream commit 7da85fbf1c87d4f73621e0e7666a3387497075a9 ]
When everything goes smoothly, ret is set to 0 which makes the function
to return EIO error.
Fixes: 8e9faa15469e ("HID: cp2112: fix gpio-callback error handling")
Signed-off-by: Sébastien Szymanski
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b3e3728ed55b9ddd7b1600ebad11f16aa665dfcb
Author: Guy Levi
Date: Wed Oct 25 22:39:35 2017 +0300
IB/mlx4: Fix RSS's QPC attributes assignments
[ Upstream commit 108809a0571cd1e1b317c5c083a371e163e1f8f9 ]
In the modify QP handler the base\_qpn\_udp field in the RSS QPC is
overwrite later by irrelevant value assignment. Hence, ingress packets
which gets to the RSS QP will be steered then to a garbage QPN.
The patch fixes this by skipping the above assignment when a RSS QP is
modified, also, the RSS context's attributes assignments are relocated
just before the context is posted to avoid future issues like this.
Additionally, this patch takes the opportunity to change the code to be
disciplined to the device's manual and assigns the RSS QP context just at
RESET to INIT transition.
Fixes:3078f5f1bd8b ("IB/mlx4: Add support for RSS QP")
Signed-off-by: Guy Levi
Reviewed-by: Yishai Hadas
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 38620054ea18edb165451bf24367f212960ff344
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f upstream.
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Signed-off-by: Greg Kroah-Hartman
commit 0228af23dd6962c16682d85fdf1bab6bbf77a007
Author: Theodore Ts'o
Date: Sun Dec 10 23:44:11 2017 -0500
ext4: add missing error check in \_\_ext4\_new\_inode()
commit 996fc4477a0ea28226b30d175f053fb6f9a4fa36 upstream.
It's possible for ext4\_get\_acl() to return an ERR\_PTR. So we need to
add a check for this case in \_\_ext4\_new\_inode(). Otherwise on an
error we can end up oops the kernel.
This was getting triggered by xfstests generic/388, which is a test
which exercises the shutdown code path.
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 4ff7da066d64e5083ef886203ba3a0623343c632
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
commit c894aa97577e47d3066b27b32499ecf899bfa8b0 upstream.
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit ae0bba6b38110e8b57b92aa820df8f78d3965fe6
Author: Andi Kleen
Date: Sun Dec 3 20:38:01 2017 -0500
ext4: support fast symlinks from ext3 file systems
commit fc82228a5e3860502dbf3bfa4a9570cb7093cf7f upstream.
407cd7fb83c0 (ext4: change fast symlink test to not rely on i\_blocks)
broke ~10 years old ext3 file systems created by 2.6.17. Any ELF
executable fails because the /lib/ld-linux.so.2 fast symlink
cannot be read anymore.
The patch assumed fast symlinks were created in a specific way,
but that's not true on these really old file systems.
The new behavior is apparently needed only with the large EA inode
feature.
Revert to the old behavior if the large EA inode feature is not set.
This makes my old VM boot again.
Fixes: 407cd7fb83c0 (ext4: change fast symlink test to not rely on i\_blocks)
Signed-off-by: Andi Kleen
Signed-off-by: Theodore Ts'o
Reviewed-by: Andreas Dilger
Signed-off-by: Greg Kroah-Hartman
commit 2dea756b487547788c1f28439fbc3df270e6bf30
Author: Kees Cook
Date: Tue Dec 12 11:28:38 2017 -0800
Revert "exec: avoid RLIMIT\_STACK races with prlimit()"
commit 779f4e1c6c7c661db40dfebd6dd6bda7b5f88aa3 upstream.
This reverts commit 04e35f4495dd560db30c25efca4eecae8ec8c375.
SELinux runs with secureexec for all non-"noatsecure" domain transitions,
which means lots of processes end up hitting the stack hard-limit change
that was introduced in order to fix a race with prlimit(). That race fix
will need to be redesigned.
Reported-by: Laura Abbott
Reported-by: Tomáš Trnka
Signed-off-by: Kees Cook
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0aa5d007ba673bc35378422b0c2b2b797da69424
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
commit 6f6a23a213be51728502b88741ba6a10cda2441d upstream.
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 3df23f7ce7255d1ef2a616071cac359a245fb6de
Author: Thomas Gleixner
Date: Fri Dec 15 10:32:03 2017 +0100
posix-timer: Properly check sigevent->sigev\_notify
commit cef31d9af908243421258f1df35a4a644604efbe upstream.
timer\_create() specifies via sigevent->sigev\_notify the signal delivery for
the new timer. The valid modes are SIGEV\_NONE, SIGEV\_SIGNAL, SIGEV\_THREAD
and (SIGEV\_SIGNAL | SIGEV\_THREAD\_ID).
The sanity check in good\_sigevent() is only checking the valid combination
for the SIGEV\_THREAD\_ID bit, i.e. SIGEV\_SIGNAL, but if SIGEV\_THREAD\_ID is
not set it accepts any random value.
This has no real effects on the posix timer and signal delivery code, but
it affects show\_timer() which handles the output of /proc/$PID/timers. That
function uses a string array to pretty print sigev\_notify. The access to
that array has no bound checks, so random sigev\_notify cause access beyond
the array bounds.
Add proper checks for the valid notify modes and remove the SIGEV\_THREAD\_ID
masking from various code pathes as SIGEV\_NONE can never be set in
combination with SIGEV\_THREAD\_ID.
Reported-by: Eric Biggers
Reported-by: Dmitry Vyukov
Reported-by: Alexey Dobriyan
Signed-off-by: Thomas Gleixner
Cc: John Stultz
Signed-off-by: Greg Kroah-Hartman
commit 6e46e964e2978f64f30b89be2423093b43e77466
Author: David Lechner
Date: Sun Dec 3 19:54:41 2017 -0600
eeprom: at24: change nvmem stride to 1
commit 7f6d2ecd3d7acaf205ea7b3e96f9ffc55b92298b upstream.
Trying to read the MAC address from an eeprom that has an offset that
is not a multiple of 4 causes an error currently.
Fix it by changing the nvmem stride to 1.
Signed-off-by: David Lechner
[Bartosz: tweaked the commit message]
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit e48a17d115f84048294ae366ff6e9dd7c8c6cca4
Author: Kirill A. Shutemov
Date: Mon Dec 4 15:40:56 2017 +0300
x86/boot/compressed/64: Print error if 5-level paging is not supported
commit 6d7e0ba2d2be9e50cccba213baf07e0e183c1b24 upstream.
If the machine does not support the paging mode for which the kernel was
compiled, the boot process cannot continue.
It's not possible to let the kernel detect the mismatch as it does not even
reach the point where cpu features can be evaluted due to a triple fault in
the KASLR setup.
Instead of instantaneous silent reboot, emit an error message which gives
the user the information why the boot fails.
Fixes: 77ef56e4f0fb ("x86: Enable 5-level paging support via CONFIG\_X86\_5LEVEL=y")
Reported-by: Borislav Petkov
Signed-off-by: Kirill A. Shutemov
Signed-off-by: Thomas Gleixner
Tested-by: Borislav Petkov
Cc: Andi Kleen
Cc: Andy Lutomirski
Cc: linux-mm@kvack.org
Cc: Cyrill Gorcunov
Cc: Linus Torvalds
Link: https://lkml.kernel.org/r/20171204124059.63515-3-kirill.shutemov@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 1bd2b3061273f1bd7d691e3ea5c15e1f57f8ab6d
Author: Kirill A. Shutemov
Date: Mon Dec 4 15:40:55 2017 +0300
x86/boot/compressed/64: Detect and handle 5-level paging at boot-time
commit 08529078d8d9adf689bf39cc38d53979a0869970 upstream.
Prerequisite for fixing the current problem of instantaneous reboots when a
5-level paging kernel is booted on 4-level paging hardware.
At the same time this change prepares the decompression code to boot-time
switching between 4- and 5-level paging.
[ tglx: Folded the GCC < 5 fix. ]
Fixes: 77ef56e4f0fb ("x86: Enable 5-level paging support via CONFIG\_X86\_5LEVEL=y")
Signed-off-by: Kirill A. Shutemov
Signed-off-by: Thomas Gleixner
Cc: Andi Kleen
Cc: Andy Lutomirski
Cc: linux-mm@kvack.org
Cc: Cyrill Gorcunov
Cc: Borislav Petkov
Cc: Linus Torvalds
Link: https://lkml.kernel.org/r/20171204124059.63515-2-kirill.shutemov@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 2d8262155ab3d20219ca5815f65573592d717c3a
Author: Steve Wise
Date: Mon Nov 27 13:16:32 2017 -0800
iw\_cxgb4: only insert drain cqes if wq is flushed
commit c058ecf6e455fac7346d46197a02398ead90851f upstream.
Only insert our special drain CQEs to support ib\_drain\_sq/rq() after
the wq is flushed. Otherwise, existing but not yet polled CQEs can be
returned out of order to the user application. This can happen when the
QP has exited RTS but not yet flushed the QP, which can happen during
a normal close (vs abortive close).
In addition never count the drain CQEs when determining how many CQEs
need to be synthesized during the flush operation. This latter issue
should never happen if the QP is properly flushed before inserting the
drain CQE, but I wanted to avoid corrupting the CQ state. So we handle
it and log a warning once.
Fixes: 4fe7c2962e11 ("iw\_cxgb4: refactor sq/rq drain logic")
Signed-off-by: Steve Wise
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit 7dd1362247ebfe06ab1f58d7fee739c5f773a0ac
Author: Trond Myklebust
Date: Thu Dec 14 21:24:08 2017 -0500
SUNRPC: Fix a race in the receive code path
commit 90d91b0cd371193d9dbfa9beacab8ab9a4cb75e0 upstream.
We must ensure that the call to rpc\_sleep\_on() in xprt\_transmit() cannot
race with the call to xprt\_complete\_rqst().
Reported-by: Chuck Lever
Link: https://bugzilla.linux-nfs.org/show\_bug.cgi?id=317
Fixes: ce7c252a8c74 ("SUNRPC: Add a separate spinlock to protect..")
Reviewed-by: Chuck Lever
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit fbce429b410cc443ec3fa3293a0e4e5804ae4f2d
Author: monty\_pavel@sina.com
Date: Sat Nov 25 01:43:50 2017 +0800
dm: fix various targets to dm\_register\_target after module \_\_init resources created
commit 7e6358d244e4706fe612a77b9c36519a33600ac0 upstream.
A NULL pointer is seen if two concurrent "vgchange -ay -K "
processes race to load the dm-thin-pool module:
PID: 25992 TASK: ffff883cd7d23500 CPU: 4 COMMAND: "vgchange"
#0 [ffff883cd743d600] machine\_kexec at ffffffff81038fa9
0000001 [ffff883cd743d660] crash\_kexec at ffffffff810c5992
0000002 [ffff883cd743d730] oops\_end at ffffffff81515c90
0000003 [ffff883cd743d760] no\_context at ffffffff81049f1b
0000004 [ffff883cd743d7b0] \_\_bad\_area\_nosemaphore at ffffffff8104a1a5
0000005 [ffff883cd743d800] bad\_area at ffffffff8104a2ce
0000006 [ffff883cd743d830] \_\_do\_page\_fault at ffffffff8104aa6f
0000007 [ffff883cd743d950] do\_page\_fault at ffffffff81517bae
0000008 [ffff883cd743d980] page\_fault at ffffffff81514f95
[exception RIP: kmem\_cache\_alloc+108]
RIP: ffffffff8116ef3c RSP: ffff883cd743da38 RFLAGS: 00010046
RAX: 0000000000000004 RBX: ffffffff81121b90 RCX: ffff881bf1e78cc0
RDX: 0000000000000000 RSI: 00000000000000d0 RDI: 0000000000000000
RBP: ffff883cd743da68 R8: ffff881bf1a4eb00 R9: 0000000080042000
R10: 0000000000002000 R11: 0000000000000000 R12: 00000000000000d0
R13: 0000000000000000 R14: 00000000000000d0 R15: 0000000000000246
ORIG\_RAX: ffffffffffffffff CS: 0010 SS: 0018
0000009 [ffff883cd743da70] mempool\_alloc\_slab at ffffffff81121ba5
0000010 [ffff883cd743da80] mempool\_create\_node at ffffffff81122083
0000011 [ffff883cd743dad0] mempool\_create at ffffffff811220f4
0000012 [ffff883cd743dae0] pool\_ctr at ffffffffa08de049 [dm\_thin\_pool]
0000013 [ffff883cd743dbd0] dm\_table\_add\_target at ffffffffa0005f2f [dm\_mod]
0000014 [ffff883cd743dc30] table\_load at ffffffffa0008ba9 [dm\_mod]
0000015 [ffff883cd743dc90] ctl\_ioctl at ffffffffa0009dc4 [dm\_mod]
The race results in a NULL pointer because:
Process A (vgchange -ay -K):
a. send DM\_LIST\_VERSIONS\_CMD ioctl;
b. pool\_target not registered;
c. modprobe dm\_thin\_pool and wait until end.
Process B (vgchange -ay -K):
a. send DM\_LIST\_VERSIONS\_CMD ioctl;
b. pool\_target registered;
c. table\_load->dm\_table\_add\_target->pool\_ctr;
d. \_new\_mapping\_cache is NULL and panic.
Note:
1. process A and process B are two concurrent processes.
2. pool\_target can be detected by process B but
\_new\_mapping\_cache initialization has not ended.
To fix dm-thin-pool, and other targets (cache, multipath, and snapshot)
with the same problem, simply dm\_register\_target() after all resources
created during module init (as labelled with \_\_init) are finished.
Signed-off-by: monty
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit 282e4b259d4f9429f7813efc8076dd601ed59f45
Author: Steven Rostedt
Date: Sat Dec 2 13:04:54 2017 -0500
sched/rt: Do not pull from current CPU if only one CPU to pull
commit f73c52a5bcd1710994e53fbccc378c42b97a06b6 upstream.
Daniel Wagner reported a crash on the BeagleBone Black SoC.
This is a single CPU architecture, and does not have a functional
arch\_send\_call\_function\_single\_ipi() implementation which can crash
the kernel if that is called.
As it only has one CPU, it shouldn't be called, but if the kernel is
compiled for SMP, the push/pull RT scheduling logic now calls it for
irq\_work if the one CPU is overloaded, it can use that function to call
itself and crash the kernel.
Ideally, we should disable the SCHED\_FEAT(RT\_PUSH\_IPI) if the system
only has a single CPU. But SCHED\_FEAT is a constant if sched debugging
is turned off. Another fix can also be used, and this should also help
with normal SMP machines. That is, do not initiate the pull code if
there's only one RT overloaded CPU, and that CPU happens to be the
current CPU that is scheduling in a lower priority task.
Even on a system with many CPUs, if there's many RT tasks waiting to
run on a single CPU, and that CPU schedules in another RT task of lower
priority, it will initiate the PULL logic in case there's a higher
priority RT task on another CPU that is waiting to run. But if there is
no other CPU with waiting RT tasks, it will initiate the RT pull logic
on itself (as it still has RT tasks waiting to run). This is a wasted
effort.
Not only does this help with SMP code where the current CPU is the only
one with RT overloaded tasks, it should also solve the issue that
Daniel encountered, because it will prevent the PULL logic from
executing, as there's only one CPU on the system, and the check added
here will cause it to exit the RT pull code.
Reported-by: Daniel Wagner
Signed-off-by: Steven Rostedt (VMware)
Acked-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: linux-rt-users
Fixes: 4bdced5c9 ("sched/rt: Simplify the IPI based RT balancing logic")
Link: http://lkml.kernel.org/r/20171202130454.4cbbfe8d@vmware.local.home
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit c2f79ce3fe441486b3ab3dfce0f7bf49bd07dc3c
Author: Jason Yan
Date: Mon Dec 11 15:03:33 2017 +0800
scsi: libsas: fix length error in sas\_smp\_handler()
commit 621f6401fdeefe96dfe9eab4b167c7c39f552bb0 upstream.
The return value of smp\_execute\_task\_sg() is the untransferred residual,
but bsg\_job\_done() requires the length of payload received. This makes
SMP passthrough commands from userland by sg ioctl to libsas get a wrong
response. The userland tools such as smp\_utils failed because of these
wrong responses:
~#smp\_discover /dev/bsg/expander-2\:13
response too short, len=0
~#smp\_discover /dev/bsg/expander-2\:134
response too short, len=0
Fix this by passing the actual received length to bsg\_job\_done(). And if
smp\_execute\_task\_sg() returns 0, this means received length is exactly
the buffer length.
[mkp: typo]
Fixes: 651a01364994 ("scsi: scsi\_transport\_sas: switch to bsg-lib for SMP passthrough")
Signed-off-by: Jason Yan
Reported-by: chenqilin
Tested-by: chenqilin
CC: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 39c4330c9779d0acc213a0ace72b88a7b7a06012
Author: Bart Van Assche
Date: Tue Dec 5 16:57:51 2017 -0800
scsi: core: Fix a scsi\_show\_rq() NULL pointer dereference
commit 14e3062fb18532175af4d1c4073597999f7a2248 upstream.
Avoid that scsi\_show\_rq() triggers a NULL pointer dereference if called
after sd\_uninit\_command(). Swap the NULL pointer assignment and the
mempool\_free() call in sd\_uninit\_command() to make it less likely that
scsi\_show\_rq() triggers a use-after-free. Note: even with these changes
scsi\_show\_rq() can trigger a use-after-free but that's a lesser evil
than e.g. suppressing debug information for T10 PI Type 2 commands
completely. This patch fixes the following oops:
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: scsi\_format\_opcode\_name+0x1a/0x1c0
CPU: 1 PID: 1881 Comm: cat Not tainted 4.14.0-rc2.blk\_mq\_io\_hang+ #516
Call Trace:
\_\_scsi\_format\_command+0x27/0xc0
scsi\_show\_rq+0x5c/0xc0
\_\_blk\_mq\_debugfs\_rq\_show+0x116/0x130
blk\_mq\_debugfs\_rq\_show+0xe/0x10
seq\_read+0xfe/0x3b0
full\_proxy\_read+0x54/0x90
\_\_vfs\_read+0x37/0x160
vfs\_read+0x96/0x130
SyS\_read+0x55/0xc0
entry\_SYSCALL\_64\_fastpath+0x1a/0xa5
[mkp: added Type 2]
Fixes: 0eebd005dd07 ("scsi: Implement blk\_mq\_ops.show\_rq()")
Reported-by: Ming Lei
Signed-off-by: Bart Van Assche
Cc: James E.J. Bottomley
Cc: Martin K. Petersen
Cc: Ming Lei
Cc: Christoph Hellwig
Cc: Hannes Reinecke
Cc: Johannes Thumshirn
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 9854611cf5e604773fecfa75bfafc03621df508c
Author: Mark Rutland
Date: Wed Dec 13 11:45:42 2017 +0000
arm64: fix CONFIG\_DEBUG\_WX address reporting
commit 1d08a044cf12aee37dfd54837558e3295287b343 upstream.
In ptdump\_check\_wx(), we pass walk\_pgd() a start address of 0 (rather
than VA\_START) for the init\_mm. This means that any reported W&X
addresses are offset by VA\_START, which is clearly wrong and can make
them appear like userspace addresses.
Fix this by telling the ptdump code that we're walking init\_mm starting
at VA\_START. We don't need to update the addr\_markers, since these are
still valid bounds regardless.
Fixes: 1404d6f13e47 ("arm64: dump: Add checking for writable and exectuable pages")
Signed-off-by: Mark Rutland
Cc: Kees Cook
Cc: Laura Abbott
Reported-by: Timur Tabi
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit cdcfd13a66eb53fd96dc480de79c423aa0de9d39
Author: Steve Capper
Date: Mon Dec 4 14:13:05 2017 +0000
arm64: Initialise high\_memory global variable earlier
commit f24e5834a2c3f6c5f814a417f858226f0a010ade upstream.
The high\_memory global variable is used by
cma\_declare\_contiguous(.) before it is defined.
We don't notice this as we compute \_\_pa(high\_memory - 1), and it looks
like we're processing a VA from the direct linear map.
This problem becomes apparent when we flip the kernel virtual address
space and the linear map is moved to the bottom of the kernel VA space.
This patch moves the initialisation of high\_memory before it used.
Fixes: f7426b983a6a ("mm: cma: adjust address limit to avoid hitting low/high memory boundary")
Signed-off-by: Steve Capper
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit db9d4784eb5ba8c69ea6b1a7b7c7c7af0b6bdf4d
Author: Steve Capper
Date: Fri Dec 1 17:22:14 2017 +0000
arm64: mm: Fix pte\_mkclean, pte\_mkdirty semantics
commit 8781bcbc5e69d7da69e84c7044ca0284848d5d01 upstream.
On systems with hardware dirty bit management, the ltp madvise09 unit
test fails due to dirty bit information being lost and pages being
incorrectly freed.
This was bisected to:
arm64: Ignore hardware dirty bit updates in ptep\_set\_wrprotect()
Reverting this commit leads to a separate problem, that the unit test
retains pages that should have been dropped due to the function
madvise\_free\_pte\_range(.) not cleaning pte's properly.
Currently pte\_mkclean only clears the software dirty bit, thus the
following code sequence can appear:
pte = pte\_mkclean(pte);
if (pte\_dirty(pte))
// this condition can return true with HW DBM!
This patch also adjusts pte\_mkclean to set PTE\_RDONLY thus effectively
clearing both the SW and HW dirty information.
In order for this to function on systems without HW DBM, we need to
also adjust pte\_mkdirty to remove the read only bit from writable pte's
to avoid infinite fault loops.
Fixes: 64c26841b349 ("arm64: Ignore hardware dirty bit updates in ptep\_set\_wrprotect()")
Reported-by: Bhupinder Thakur
Tested-by: Bhupinder Thakur
Reviewed-by: Catalin Marinas
Signed-off-by: Steve Capper
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 268b2cc325061c60fa2dccfa4d61495e9306c4fa
Author: Scott Mayhew
Date: Fri Dec 8 16:00:12 2017 -0500
nfs: don't wait on commit in nfs\_commit\_inode() if there were no commit requests
commit dc4fd9ab01ab379ae5af522b3efd4187a7c30a31 upstream.
If there were no commit requests, then nfs\_commit\_inode() should not
wait on the commit or mark the inode dirty, otherwise the following
BUG\_ON can be triggered:
[ 1917.130762] kernel BUG at fs/inode.c:578!
[ 1917.130766] Oops: Exception in kernel mode, sig: 5 [#1]
[ 1917.130768] SMP NR\_CPUS=2048 NUMA pSeries
[ 1917.130772] Modules linked in: iscsi\_tcp libiscsi\_tcp libiscsi scsi\_transport\_iscsi blocklayoutdriver rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache sunrpc sg nx\_crypto pseries\_rng ip\_tables xfs libcrc32c sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_common ibmvscsi scsi\_transport\_srp ibmveth scsi\_tgt dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 1917.130805] CPU: 2 PID: 14923 Comm: umount.nfs4 Tainted: G ------------ T 3.10.0-768.el7.ppc64 #1
[ 1917.130810] task: c0000005ecd88040 ti: c00000004cea0000 task.ti: c00000004cea0000
[ 1917.130813] NIP: c000000000354178 LR: c000000000354160 CTR: c00000000012db80
[ 1917.130816] REGS: c00000004cea3720 TRAP: 0700 Tainted: G ------------ T (3.10.0-768.el7.ppc64)
[ 1917.130820] MSR: 8000000100029032  CR: 22002822 XER: 20000000
[ 1917.130828] CFAR: c00000000011f594 SOFTE: 1
GPR00: c000000000354160 c00000004cea39a0 c0000000014c4700 c0000000018cc750
GPR04: 000000000000c750 80c0000000000000 0600000000000000 04eeb76bea749a03
GPR08: 0000000000000034 c0000000018cc758 0000000000000001 d000000005e619e8
GPR12: c00000000012db80 c000000007b31200 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR24: 0000000000000000 c000000000dfc3ec 0000000000000000 c0000005eefc02c0
GPR28: d0000000079dbd50 c0000005b94a02c0 c0000005b94a0250 c0000005b94a01c8
[ 1917.130867] NIP [c000000000354178] .evict+0x1c8/0x350
[ 1917.130871] LR [c000000000354160] .evict+0x1b0/0x350
[ 1917.130873] Call Trace:
[ 1917.130876] [c00000004cea39a0] [c000000000354160] .evict+0x1b0/0x350 (unreliable)
[ 1917.130880] [c00000004cea3a30] [c0000000003558cc] .evict\_inodes+0x13c/0x270
[ 1917.130884] [c00000004cea3af0] [c000000000327d20] .kill\_anon\_super+0x70/0x1e0
[ 1917.130896] [c00000004cea3b80] [d000000005e43e30] .nfs\_kill\_super+0x20/0x60 [nfs]
[ 1917.130900] [c00000004cea3c00] [c000000000328a20] .deactivate\_locked\_super+0xa0/0x1b0
[ 1917.130903] [c00000004cea3c80] [c00000000035ba54] .cleanup\_mnt+0xd4/0x180
[ 1917.130907] [c00000004cea3d10] [c000000000119034] .task\_work\_run+0x114/0x150
[ 1917.130912] [c00000004cea3db0] [c00000000001ba6c] .do\_notify\_resume+0xcc/0x100
[ 1917.130916] [c00000004cea3e30] [c00000000000a7b0] .ret\_from\_except\_lite+0x5c/0x60
[ 1917.130919] Instruction dump:
[ 1917.130921] 7fc3f378 486734b5 60000000 387f00a0 38800003 4bdcb365 60000000 e95f00a0
[ 1917.130927] 694a0060 7d4a0074 794ad182 694a0001 <0b0a0000> 892d02a4 2f890000 40de0134
Signed-off-by: Scott Mayhew
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 74b6274f8c5e81d7243ca2dea4f80c8585b3d0e0
Author: Daniel Jurgens
Date: Tue Dec 5 22:30:02 2017 +0200
IB/core: Don't enforce PKey security on SMI MADs
commit 0fbe8f575b15585eec3326e43708fbbc024e8486 upstream.
Per the infiniband spec an SMI MAD can have any PKey. Checking the pkey
on SMI MADs is not necessary, and it seems that some older adapters
using the mthca driver don't follow the convention of using the default
PKey, resulting in false denials, or errors querying the PKey cache.
SMI MAD security is still enforced, only agents allowed to manage the
subnet are able to receive or send SMI MADs.
Reported-by: Chris Blake
Fixes: 47a2b338fe63 ("IB/core: Enforce security on management datagrams")
Signed-off-by: Daniel Jurgens
Reviewed-by: Parav Pandit
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 4995bfa99096410af00aa0b1b374005494c709f3
Author: Daniel Jurgens
Date: Tue Dec 5 22:30:01 2017 +0200
IB/core: Bound check alternate path port number
commit 4cae8ff136782d77b108cb3a5ba53e60597ba3a6 upstream.
The alternate port number is used as an array index in the IB
security implementation, invalid values can result in a kernel panic.
Fixes: d291f1a65232 ("IB/core: Enforce PKey security on QPs")
Signed-off-by: Daniel Jurgens
Reviewed-by: Parav Pandit
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 2b3ff282dff3a42a081bef0f8249a99f64d7669f
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 upstream.
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 912fe79116f2456a00cf4a9b2ad3ef207ba3e162
Author: Chunfeng Yun
Date: Fri Dec 8 18:10:06 2017 +0200
usb: xhci: fix TDS for MTK xHCI1.1
commit 72b663a99c074a8d073e7ecdae446cfb024ef551 upstream.
For MTK's xHCI 1.0 or latter, TD size is the number of max
packet sized packets remaining in the TD, not including
this TRB (following spec).
For MTK's xHCI 0.96 and older, TD size is the number of max
packet sized packets remaining in the TD, including this TRB
(not following spec).
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit eae219a2fc5554d86b9ac4d31bef73c273e926c0
Author: Yan, Zheng
Date: Thu Nov 30 11:59:22 2017 +0800
ceph: drop negative child dentries before try pruning inode's alias
commit 040d786032bf59002d374b86d75b04d97624005c upstream.
Negative child dentry holds reference on inode's alias, it makes
d\_prune\_aliases() do nothing.
Signed-off-by: "Yan, Zheng"
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 318cea7d8d801cfa70f5b3a3a991425cd502b574
Author: Christoph Fritz
Date: Sat Dec 9 23:47:55 2017 +0100
mmc: core: apply NO\_CMD23 quirk to some specific cards
commit 91516a2a4734614d62ee3ed921f8f88acc67c000 upstream.
To get an usdhc Apacer and some ATP SD cards work reliable, CMD23 needs
to be disabled. This has been tested on i.MX6 (sdhci-esdhc) and rk3288
(dw\_mmc-rockchip).
Without this patch on i.MX6 (sdhci-esdhc):
$ dd if=/dev/urandom of=/mnt/test bs=1M count=10 conv=fsync
|
| mmc0: starting CMD25 arg 00a71f00 flags 000000b5
| mmc0: blksz 512 blocks 1024 flags 00000100 tsac 3000 ms nsac 0
| mmc0: CMD12 arg 00000000 flags 0000049d
| sdhci [sdhci\_irq()]: \*\*\* mmc0 got interrupt: 0x00000001
| mmc0: Timeout waiting for hardware interrupt.
Without this patch on rk3288 (dw\_mmc-rockchip):
| mmc1: Card stuck in programming state! mmcblk1 card\_busy\_detect
| dwmmc\_rockchip ff0c0000.dwmmc: Busy; trying anyway
| mmc\_host mmc1: Bus speed (slot 0) = 400000Hz (slot req 400000Hz,
| actual 400000HZ div = 0)
| mmc1: card never left busy state
| mmc1: tried to reset card, got error -110
| blk\_update\_request: I/O error, dev mmcblk1, sector 139778
| Buffer I/O error on dev mmcblk1p1, logical block 131586, lost async
| page write
Signed-off-by: Christoph Fritz
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit d78a5506cf0ea112124c1ffa5c0aae09b579d96d
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a upstream.
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit b6a2ad646c13bb9d1231bce5599cb3176ff33ca4
Author: Shuah Khan
Date: Thu Dec 7 14:16:49 2017 -0700
usbip: prevent vhci\_hcd driver from leaking a socket pointer address
commit 2f2d0088eb93db5c649d2a5e34a3800a8a935fc5 upstream.
When a client has a USB device attached over IP, the vhci\_hcd driver is
locally leaking a socket pointer address via the
/sys/devices/platform/vhci\_hcd/status file (world-readable) and in debug
output when "usbip --debug port" is run.
Fix it to not leak. The socket pointer address is not used at the moment
and it was made visible as a convenient way to find IP address from socket
pointer address by looking up /proc/net/{tcp,tcp6}.
As this opens a security hole, the fix replaces socket pointer address with
sockfd.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 1621db059603e781f61a9bf33cba639b42faf0bc
Author: Shuah Khan
Date: Thu Dec 7 14:16:48 2017 -0700
usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input
commit c6688ef9f29762e65bce325ef4acd6c675806366 upstream.
Harden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 7120d742ad8d0f1fe37e4b73827e166fc1e01eea
Author: Shuah Khan
Date: Thu Dec 7 14:16:47 2017 -0700
usbip: fix stub\_rx: get\_pipe() to validate endpoint number
commit 635f545a7e8be7596b9b2b6a43cab6bbd5a88e43 upstream.
get\_pipe() routine doesn't validate the input endpoint number
and uses to reference ep\_in and ep\_out arrays. Invalid endpoint
number can trigger BUG(). Range check the epnum and returning
error instead of calling BUG().
Change caller stub\_recv\_cmd\_submit() to handle the get\_pipe()
error return.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit cb6ee0f3c19980328529d5ed7a1650e41164ca49
Author: Amir Goldstein
Date: Wed Nov 29 07:35:21 2017 +0200
ovl: update ctx->pos on impure dir iteration
commit b02a16e6413a2f782e542ef60bad9ff6bf212f8a upstream.
This fixes a regression with readdir of impure dir in overlayfs
that is shared to VM via 9p fs.
Reported-by: Miguel Bernal Marin
Fixes: 4edb83bb1041 ("ovl: constant d\_ino for non-merge dirs")
Signed-off-by: Amir Goldstein
Tested-by: Miguel Bernal Marin
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 066f40dc495d5ab2ec9a871cb8703d9591d636c5
Author: Vivek Goyal
Date: Mon Nov 27 10:12:44 2017 -0500
ovl: Pass ovl\_get\_nlink() parameters in right order
commit 08d8f8a5b094b66b29936e8751b4a818b8db1207 upstream.
Right now we seem to be passing index as "lowerdentry" and origin.dentry
as "upperdentry". IIUC, we should pass these parameters in reversed order
and this looks like a bug.
Signed-off-by: Vivek Goyal
Acked-by: Amir Goldstein
Fixes: caf70cb2ba5d ("ovl: cleanup orphan index entries")
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 4c5ae6a301a5415d1334f6c655bebf91d475bd89
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 upstream.
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
Signed-off-by: Greg Kroah-Hartman
commit 6391294874d505a5e8681c41439a74e7019b267f
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
commit 62354454625741f0569c2cbe45b2d192f8fd258e upstream.
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit b8582c0f792fc1603a8998de60a156359f15dfd4
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
commit 90e406f96f630c07d631a021fd4af10aac913e77 upstream.
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 55fe4698d80ecb553d015b5df96ccf9584cbc06b
Author: Michal Hocko
Date: Thu Dec 14 15:33:15 2017 -0800
mm, oom\_reaper: fix memory corruption
commit 4837fe37adff1d159904f0c013471b1ecbcb455e upstream.
David Rientjes has reported the following memory corruption while the
oom reaper tries to unmap the victims address space
BUG: Bad page map in process oom\_reaper pte:6353826300000000 pmd:00000000
addr:00007f50cab1d000 vm\_flags:08100073 anon\_vma:ffff9eea335603f0 mapping: (null) index:7f50cab1d
file: (null) fault: (null) mmap: (null) readpage: (null)
CPU: 2 PID: 1001 Comm: oom\_reaper
Call Trace:
unmap\_page\_range+0x1068/0x1130
\_\_oom\_reap\_task\_mm+0xd5/0x16b
oom\_reaper+0xff/0x14c
kthread+0xc1/0xe0
Tetsuo Handa has noticed that the synchronization inside exit\_mmap is
insufficient. We only synchronize with the oom reaper if
tsk\_is\_oom\_victim which is not true if the final \_\_mmput is called from
a different context than the oom victim exit path. This can trivially
happen from context of any task which has grabbed mm reference (e.g. to
read /proc// file which requires mm etc.).
The race would look like this
oom\_reaper oom\_victim task
mmget\_not\_zero
do\_exit
mmput
\_\_oom\_reap\_task\_mm mmput
\_\_mmput
exit\_mmap
remove\_vma
unmap\_page\_range
Fix this issue by providing a new mm\_is\_oom\_victim() helper which
operates on the mm struct rather than a task. Any context which
operates on a remote mm struct should use this helper in place of
tsk\_is\_oom\_victim. The flag is set in mark\_oom\_victim and never cleared
so it is stable in the exit\_mmap path.
Debugged by Tetsuo Handa.
Link: http://lkml.kernel.org/r/20171210095130.17110-1-mhocko@kernel.org
Fixes: 212925802454 ("mm: oom: let oom\_reap\_task and exit\_mmap run concurrently")
Signed-off-by: Michal Hocko
Reported-by: David Rientjes
Acked-by: David Rientjes
Cc: Tetsuo Handa
Cc: Andrea Argangeli
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c5d9b78d530a45f0c226317764a7865f7911ab46
Author: Thiago Rafael Becker
Date: Thu Dec 14 15:33:12 2017 -0800
kernel: make groups\_sort calling a responsibility group\_info allocators
commit bdcf0a423ea1c40bbb40e7ee483b50fc8aa3d758 upstream.
In testing, we found that nfsd threads may call set\_groups in parallel
for the same entry cached in auth.unix.gid, racing in the call of
groups\_sort, corrupting the groups for that entry and leading to
permission denials for the client.
This patch:
- Make groups\_sort globally visible.
- Move the call to groups\_sort to the modifiers of group\_info
- Remove the call to groups\_sort from set\_groups
Link: http://lkml.kernel.org/r/20171211151420.18655-1-thiago.becker@gmail.com
Signed-off-by: Thiago Rafael Becker
Reviewed-by: Matthew Wilcox
Reviewed-by: NeilBrown
Acked-by: "J. Bruce Fields"
Cc: Al Viro
Cc: Martin Schwidefsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d3d2f01a6eaf6022167c94afba34b6d6722392c9
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb upstream.
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c8def7a4185b8b1ec2b843af346977f00259414e
Author: Arnd Bergmann
Date: Thu Dec 14 15:32:34 2017 -0800
string.h: workaround for increased stack usage
commit 146734b091430c80d80bb96b1139a96fb4bc830e upstream.
The hardened strlen() function causes rather large stack usage in at
least one file in the kernel, in particular when CONFIG\_KASAN is
enabled:
drivers/media/usb/em28xx/em28xx-dvb.c: In function 'em28xx\_dvb\_init':
drivers/media/usb/em28xx/em28xx-dvb.c:2062:1: error: the frame size of 3256 bytes is larger than 204 bytes [-Werror=frame-larger-than=]
Analyzing this problem led to the discovery that gcc fails to merge the
stack slots for the i2c\_board\_info[] structures after we strlcpy() into
them, due to the 'noreturn' attribute on the source string length check.
I reported this as a gcc bug, but it is unlikely to get fixed for gcc-8,
since it is relatively easy to work around, and it gets triggered
rarely. An earlier workaround I did added an empty inline assembly
statement before the call to fortify\_panic(), which works surprisingly
well, but is really ugly and unintuitive.
This is a new approach to the same problem, this time addressing it by
not calling the 'extern \_\_real\_strnlen()' function for string constants
where \_\_builtin\_strlen() is a compile-time constant and therefore known
to be safe.
We do this by checking if the last character in the string is a
compile-time constant '\0'. If it is, we can assume that strlen() of
the string is also constant.
As a side-effect, this should also improve the object code output for
any other call of strlen() on a string constant.
[akpm@linux-foundation.org: add comment]
Link: http://lkml.kernel.org/r/20171205215143.3085755-1-arnd@arndb.de
Link: https://gcc.gnu.org/bugzilla/show\_bug.cgi?id=82365
Link: https://patchwork.kernel.org/patch/9980413/
Link: https://patchwork.kernel.org/patch/9974047/
Fixes: 6974f0c4555 ("include/linux/string.h: add the option of fortified string.h functions")
Signed-off-by: Arnd Bergmann
Cc: Kees Cook
Cc: Mauro Carvalho Chehab
Cc: Dmitry Vyukov
Cc: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Daniel Micay
Cc: Greg Kroah-Hartman
Cc: Martin Wilck
Cc: Dan Williams
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6f3fc5f95975e101b198ecf223ad6f9f8994b191
Author: Ronnie Sahlberg
Date: Tue Nov 21 09:36:33 2017 +1100
cifs: fix NULL deref in SMB2\_read
commit a821df3f1af72aa6a0d573eea94a7dd2613e9f4e upstream.
Signed-off-by: Ronnie Sahlberg
Reviewed-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit cf1048e46d4f301261d946e73add464fb95fd5a4
Author: Eric Biggers
Date: Tue Nov 28 00:46:24 2017 -0800
crypto: af\_alg - fix NULL pointer dereference in
commit 887207ed9e5812ed9239b6d07185a2d35dda91db upstream.
af\_alg\_free\_areq\_sgls()
If allocating the ->tsgl member of 'struct af\_alg\_async\_req' failed,
during cleanup we dereferenced the NULL ->tsgl pointer in
af\_alg\_free\_areq\_sgls(), because ->tsgl\_entries was nonzero.
Fix it by only freeing the ->tsgl list if it is non-NULL.
This affected both algif\_skcipher and algif\_aead.
Fixes: e870456d8e7c ("crypto: algif\_skcipher - overhaul memory management")
Fixes: d887c52d6ae4 ("crypto: algif\_aead - overhaul memory management")
Reported-by: syzbot
Signed-off-by: Eric Biggers
Reviewed-by: Stephan Mueller
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit c68b31521d5fb7216cb1113130399afe65437c6c
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
commit ecaaab5649781c5a0effdaf298a925063020500e upstream.
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 902ae89f841de0c8d2857919296923f6332e174f
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 upstream.
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 80dbdc5ae74d6167edf081f8865df06fb6615578
Author: Eric Biggers
Date: Sun Nov 26 23:16:49 2017 -0800
crypto: rsa - fix buffer overread when stripping leading zeroes
commit d2890c3778b164fde587bc16583f3a1c87233ec5 upstream.
In rsa\_get\_n(), if the buffer contained all 0's and "FIPS mode" is
enabled, we would read one byte past the end of the buffer while
scanning the leading zeroes. Fix it by checking 'n\_sz' before '!\*ptr'.
This bug was reachable by adding a specially crafted key of type
"asymmetric" (requires CONFIG\_RSA and CONFIG\_X509\_CERTIFICATE\_PARSER).
KASAN report:
BUG: KASAN: slab-out-of-bounds in rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
Read of size 1 at addr ffff88003501a708 by task keyctl/196
CPU: 1 PID: 196 Comm: keyctl Not tainted 4.14.0-09238-g1d3b78bbc6e9 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110\_100015-anatol 04/01/2014
Call Trace:
rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
asn1\_ber\_decoder+0x82a/0x1fd0 lib/asn1\_decoder.c:328
rsa\_set\_pub\_key+0xd3/0x320 crypto/rsa.c:278
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
pkcs1pad\_set\_pub\_key+0xae/0x200 crypto/rsa-pkcs1pad.c:117
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
public\_key\_verify\_signature+0x270/0x9d0 crypto/asymmetric\_keys/public\_key.c:106
x509\_check\_for\_self\_signed+0x2ea/0x480 crypto/asymmetric\_keys/x509\_public\_key.c:141
x509\_cert\_parse+0x46a/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:129
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Allocated by task 196:
\_\_do\_kmalloc mm/slab.c:3711 [inline]
\_\_kmalloc\_track\_caller+0x118/0x2e0 mm/slab.c:3726
kmemdup+0x17/0x40 mm/util.c:118
kmemdup ./include/linux/string.h:414 [inline]
x509\_cert\_parse+0x2cb/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:106
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 5a7de97309f5 ("crypto: rsa - return raw integers for the ASN.1 parser")
Cc: Tudor Ambarus
Signed-off-by: Eric Biggers
Reviewed-by: James Morris
Reviewed-by: David Howells
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 96c2dfaebe1a8eba95d43732a1413c777469128c
Author: Eric Biggers
Date: Mon Nov 27 23:23:05 2017 -0800
crypto: algif\_aead - fix reference counting of null skcipher
commit b32a7dc8aef1882fbf983eb354837488cc9d54dc upstream.
In the AEAD interface for AF\_ALG, the reference to the "null skcipher"
held by each tfm was being dropped in the wrong place -- when each
af\_alg\_ctx was freed instead of when the aead\_tfm was freed. As
discovered by syzkaller, a specially crafted program could use this to
cause the null skcipher to be freed while it is still in use.
Fix it by dropping the reference in the right place.
Fixes: 72548b093ee3 ("crypto: algif\_aead - copy AAD from src to dst")
Reported-by: syzbot
Signed-off-by: Eric Biggers
Reviewed-by: Stephan Mueller
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 3d27b022022a88e189c0e9d63c4ac01af354735f
Author: Martin Kaiser
Date: Tue Oct 17 22:53:08 2017 +0200
mfd: fsl-imx25: Clean up irq settings during removal
commit 18f77393796848e68909e65d692c1d1436f06e06 upstream.
When fsl-imx25-tsadc is compiled as a module, loading, unloading and
reloading the module will lead to a crash.
Unable to handle kernel paging request at virtual address bf005430
[] (irq\_find\_matching\_fwspec)
from [] (of\_irq\_get+0x58/0x74)
[] (of\_irq\_get)
from [] (platform\_get\_irq+0x48/0xc8)
[] (platform\_get\_irq)
from [] (mx25\_tsadc\_probe+0x220/0x2f4 [fsl\_imx25\_tsadc])
irq\_find\_matching\_fwspec() loops over all registered irq domains. The
irq domain is still registered from last time the module was loaded but
the pointer to its operations is invalid after the module was unloaded.
Add a removal function which clears the irq handler and removes the irq
domain. With this cleanup in place, it's possible to unload and reload
the module.
Signed-off-by: Martin Kaiser
Reviewed-by: Lucas Stach
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman


=== Content from usn.ubuntu.com_57df2232_20250125_123734.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3619-2: Linux kernel (Xenial HWE) vulnerabilities

5 April 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty

## Details

USN-3619-1 fixed vulnerabilities in the Linux kernel for Ubuntu 16.04

LTS. This update provides the corresponding updates for the Linux

Hardware Enablement (HWE) kernel from Ubuntu 16.04 LTS for Ubuntu

14.04 LTS.

Jann Horn discovered that the Berkeley Packet Filter (BPF) implementation

in the Linux kernel improperly performed sign extension in some situations.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-16995](/security/CVE-2017-16995))

It was discovered that a race condition leading to a use-after-free

vulnerability existed in the ALSA PCM subsystem of the Linux kernel. A

local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-0861](/security/CVE-2017-0861))

It was discovered that the KVM implementation in the Linux kernel allowed

passthrough of the diagnostic I/O port 0x80. An attacker in a guest VM

could use this to cause a denial of service (system crash) in the host OS.

([CVE-2017-1000407](/security/CVE-2017-1000407))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a use-after-free vulnerability existed in the

network namespaces implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2017-15129](/security/CVE-2017-15129))

It was discovered that the Advanced Linux Sound Architecture (ALSA)

subsystem in the Linux kernel contained a use-after-free when handling

device removal. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16528](/security/CVE-2017-16528))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the DiBcom DiB0700 USB DVB driver in the

Linux kernel did not properly handle detach events. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16646](/security/CVE-2017-16646))

Andrey Konovalov discovered that the CDC USB Ethernet driver did not

properly validate device descriptors. A physically proximate attacker could

use this to cause a denial of service (system crash). ([CVE-2017-16649](/security/CVE-2017-16649))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure

vulnerability. A physically proximate attacker could use this to expose

sensitive information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the HugeTLB component of the Linux kernel did not

properly handle holes in hugetlb ranges. A local attacker could use this to

expose sensitive information (kernel memory). ([CVE-2017-16994](/security/CVE-2017-16994))

It was discovered that the netfilter component of the Linux did not

properly restrict access to the connection tracking helpers list. A local

attacker could use this to bypass intended access restrictions.

([CVE-2017-17448](/security/CVE-2017-17448))

It was discovered that the netlink subsystem in the Linux kernel did not

properly restrict observations of netlink messages to the appropriate net

namespace. A local attacker could use this to expose sensitive information

(kernel netlink traffic). ([CVE-2017-17449](/security/CVE-2017-17449))

It was discovered that the netfilter passive OS fingerprinting (xt\_osf)

module did not properly perform access control checks. A local attacker

could improperly modify the system-wide OS fingerprint list.

([CVE-2017-17450](/security/CVE-2017-17450))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

contained an out-of-bounds read when handling memory-mapped I/O. A local

attacker could use this to expose sensitive information. ([CVE-2017-17741](/security/CVE-2017-17741))

It was discovered that the Salsa20 encryption algorithm implementations in

the Linux kernel did not properly handle zero-length inputs. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2017-17805](/security/CVE-2017-17805))

It was discovered that the HMAC implementation did not validate the state

of the underlying cryptographic hash algorithm. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-17806](/security/CVE-2017-17806))

It was discovered that the keyring implementation in the Linux kernel did

not properly check permissions when a key request was performed on a task's

default keyring. A local attacker could use this to add keys to

unauthorized keyrings. ([CVE-2017-17807](/security/CVE-2017-17807))

Alexei Starovoitov discovered that the Berkeley Packet Filter (BPF)

implementation in the Linux kernel contained a branch-pruning logic issue

around unreachable code. A local attacker could use this to cause a denial

of service. ([CVE-2017-17862](/security/CVE-2017-17862))

It was discovered that the parallel cryptography component of the Linux

kernel incorrectly freed kernel memory. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-18075](/security/CVE-2017-18075))

It was discovered that a race condition existed in the Device Mapper

component of the Linux kernel. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2017-18203](/security/CVE-2017-18203))

It was discovered that a race condition existed in the OCFS2 file system

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (kernel deadlock). ([CVE-2017-18204](/security/CVE-2017-18204))

It was discovered that an infinite loop could occur in the madvise(2)

implementation in the Linux kernel in certain circumstances. A local

attacker could use this to cause a denial of service (system hang).

([CVE-2017-18208](/security/CVE-2017-18208))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

It was discovered that the Broadcom NetXtremeII ethernet driver in the

Linux kernel did not properly validate Generic Segment Offload (GSO) packet

sizes. An attacker could use this to cause a denial of service (interface

unavailability). ([CVE-2018-1000026](/security/CVE-2018-1000026))

It was discovered that the Reliable Datagram Socket (RDS) implementation in

the Linux kernel contained an out-of-bounds write during RDMA page

allocation. An attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2018-5332](/security/CVE-2018-5332))

Mohamed Ghannam discovered a null pointer dereference in the RDS (Reliable

Datagram Sockets) protocol implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-5333](/security/CVE-2018-5333))

范龙飞 discovered that a race condition existed in loop block device

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5344](/security/CVE-2018-5344))

It was discovered that an integer overflow error existed in the futex

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash). ([CVE-2018-6927](/security/CVE-2018-6927))

It was discovered that a NULL pointer dereference existed in the RDS

(Reliable Datagram Sockets) protocol implementation in the Linux kernel. A

local attacker could use this to cause a denial of service (system crash).

([CVE-2018-7492](/security/CVE-2018-7492))

It was discovered that the Broadcom UniMAC MDIO bus controller driver in

the Linux kernel did not properly validate device resources. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-8043](/security/CVE-2018-8043))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-4.4.0-1016-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1016.16](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1016.16)
* [linux-image-4.4.0-119-generic](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-0861](/security/CVE-2017-0861)
* [CVE-2017-1000407](/security/CVE-2017-1000407)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-15129](/security/CVE-2017-15129)
* [CVE-2017-16528](/security/CVE-2017-16528)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16646](/security/CVE-2017-16646)
* [CVE-2017-16649](/security/CVE-2017-16649)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-16994](/security/CVE-2017-16994)
* [CVE-2017-16995](/security/CVE-2017-16995)
* [CVE-2017-17448](/security/CVE-2017-17448)
* [CVE-2017-17449](/security/CVE-2017-17449)
* [CVE-2017-17450](/security/CVE-2017-17450)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-17741](/security/CVE-2017-17741)
* [CVE-2017-17805](/security/CVE-2017-17805)
* [CVE-2017-17806](/security/CVE-2017-17806)
* [CVE-2017-17807](/security/CVE-2017-17807)
* [CVE-2017-17862](/security/CVE-2017-17862)
* [CVE-2017-18075](/security/CVE-2017-18075)
* [CVE-2017-18203](/security/CVE-2017-18203)
* [CVE-2017-18204](/security/CVE-2017-18204)
* [CVE-2017-18208](/security/CVE-2017-18208)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2018-1000026](/security/CVE-2018-1000026)
* [CVE-2018-5332](/security/CVE-2018-5332)
* [CVE-2018-5333](/security/CVE-2018-5333)
* [CVE-2018-5344](/security/CVE-2018-5344)
* [CVE-2018-6927](/security/CVE-2018-6927)
* [CVE-2018-7492](/security/CVE-2018-7492)
* [CVE-2018-8043](/security/CVE-2018-8043)

## Related notices

* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3619-1](/security/notices/USN-3619-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3632-1](/security/notices/USN-3632-1)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3523-2](/security/notices/USN-3523-2)
* [USN-3633-1](/security/notices/USN-3633-1)
* [USN-3523-1](/security/notices/USN-3523-1)
* [USN-3523-3](/security/notices/USN-3523-3)
* [USN-3620-1](/security/notices/USN-3620-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3653-1](/security/notices/USN-3653-1)
* [USN-3657-1](/security/notices/USN-3657-1)
* [USN-3655-1](/security/notices/USN-3655-1)
* [USN-3653-2](/security/notices/USN-3653-2)
* [USN-3655-2](/security/notices/USN-3655-2)
* [USN-3698-2](/security/notices/USN-3698-2)
* [USN-3697-1](/security/notices/USN-3697-1)
* [USN-3698-1](/security/notices/USN-3698-1)
* [USN-3697-2](/security/notices/USN-3697-2)
* [USN-3674-2](/security/notices/USN-3674-2)
* [USN-3674-1](/security/notices/USN-3674-1)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3630-2](/security/notices/USN-3630-2)
* [USN-3630-1](/security/notices/USN-3630-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from www.spinics.net_3c954c19_20250125_123740.html ===


# [PATCH 0/4] USB over IP Secuurity fixes

[[Date Prev](msg163479.html)][[Date Next](msg163481.html)][[Thread Prev](msg163469.html)][[Thread Next](msg163477.html)][[Date Index](mail10.html#163480)][[Thread Index](thrd10.html#163480)]

---

* *To*: shuah@xxxxxxxxxx, valentina.manea.m@xxxxxxxxx, gregkh@xxxxxxxxxxxxxxxxxxx
* *Subject*: [PATCH 0/4] USB over IP Secuurity fixes
* *From*: Shuah Khan <shuahkh@xxxxxxxxxxxxxxx>
* *Date*: Thu, 7 Dec 2017 14:16:46 -0700
* *Cc*: Shuah Khan <shuahkh@xxxxxxxxxxxxxxx>, linux-usb@xxxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx, vuln@xxxxxxxxxxx

---

```
Jakub Jirasek from Secunia Research at Flexera reported security
vulnerabilities in the USB over IP driver. This patch series all
the 4 reported problems.

Jakub, could you please suggest an email address I can use for the
Reported-by tag?

Shuah Khan (4):
  usbip: fix stub_rx: get_pipe() to validate endpoint number
  usbip: fix stub_rx: harden CMD_SUBMIT path to handle malicious input
  usbip: prevent vhci_hcd driver from leaking a socket pointer address
  usbip: fix stub_send_ret_submit() vulnerability to null
    transfer_buffer

 drivers/usb/usbip/stub_rx.c          | 51 +++++++++++++++++++++++++++++-------
 drivers/usb/usbip/stub_tx.c          |  7 +++++
 drivers/usb/usbip/usbip_common.h     |  1 +
 drivers/usb/usbip/vhci_sysfs.c       | 25 +++++++++++-------
 tools/usb/usbip/libsrc/vhci_driver.c |  8 +++---
 5 files changed, 69 insertions(+), 23 deletions(-)

--
2.14.1

--
To unsubscribe from this list: send the line "unsubscribe linux-usb" in
the body of a message to majordomo@xxxxxxxxxxxxxxx
More majordomo info at  <http://vger.kernel.org/majordomo-info.html>

```

---

* **Follow-Ups**:
  + **[RE: [PATCH 0/4] USB over IP Secuurity fixes](msg163513.html)**
    - *From:* Secunia Research
  + **[Re: [PATCH 0/4] USB over IP Secuurity fixes](msg163491.html)**
    - *From:* Greg KH
  + **[[PATCH 1/4] usbip: fix stub\_rx: get\_pipe() to validate endpoint number](msg163481.html)**
    - *From:* Shuah Khan
  + **[[PATCH 2/4] usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input](msg163479.html)**
    - *From:* Shuah Khan
  + **[[PATCH 4/4] usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer](msg163478.html)**
    - *From:* Shuah Khan
  + **[[PATCH 3/4] usbip: prevent vhci\_hcd driver from leaking a socket pointer address](msg163477.html)**
    - *From:* Shuah Khan

* Prev by Date:
  **[[PATCH 2/4] usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input](msg163479.html)**
* Next by Date:
  **[[PATCH 1/4] usbip: fix stub\_rx: get\_pipe() to validate endpoint number](msg163481.html)**
* Previous by thread:
  **[[PATCH v1 0/1] lsusb: Fix potential floating point exception.](msg163469.html)**
* Next by thread:
  **[[PATCH 3/4] usbip: prevent vhci\_hcd driver from leaking a socket pointer address](msg163477.html)**
* Index(es):
  + [**Date**](mail10.html#163480)
  + [**Thread**](thrd10.html#163480)

[[Index of Archives]](/lists/)

[[Linux Media]](/lists/linux-media/)

[[Linux Input]](/lists/linux-input/)

[[Linux Audio Users]](/lists/linux-audio-users/)

[[Yosemite News]](https://yosemitenews.info/)

[[Linux Kernel]](/lists/kernel/)

[[Linux SCSI]](/lists/linux-scsi/)

[[Old Linux USB Devel Archive]](/lists/linux-usb-devel/)

---

|  | [Powered by Linux](/lists/) |
| --- | --- |



=== Content from secuniaresearch.flexerasoftware.com_4fe37b37_20250125_123731.html ===


[Skip to main content](#main-content)
[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

Search

## Main navigation

* Solutions
  + Column 1
    - Business challenge
      * [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
      * [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
      * [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
      * [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
      * [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
      * [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
      * [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
      * [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
      * [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
      * [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
      * [Public sector](https://www.flexera.com/solutions/public-sector)
  + Column 2
    - Spend management by vendor
      * [IBM](https://www.flexera.com/solutions/vendor/ibm)
      * [Oracle](https://www.flexera.com/solutions/vendor/oracle)
      * [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
      * [SAP](https://www.flexera.com/solutions/vendor/sap)
      * [VMware](https://www.flexera.com/solutions/vendor/vmware)
      * [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
      * [AWS](https://www.flexera.com/solutions/vendor/aws)
      * [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
      * [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
      * [Adobe](https://www.flexera.com/solutions/vendor/adobe)

  ### Achieve more through a united FinOps and ITAM function

  The future is hybrid. Break down the walls between ITAM and FinOps to drive more revenue, more customer growth and more innovation.

  [Discover More](https://www.flexera.com/resources/hybrid-itam-finops)
* Products
  + Column 1
    - [Flexera One](https://www.flexera.com/products/flexera-one)
      * [IT Visibility](https://www.flexera.com/products/flexera-one/it-visibility)
      * [ITAM](https://www.flexera.com/products/flexera-one/it-asset-management)
      * [SaaS Management](https://www.flexera.com/products/flexera-one/saas-management)
      * [FinOps](https://www.flexera.com/products/flexera-one/finops)
      * [Technology Intelligence Platform](https://www.flexera.com/products/flexera-one/technology-intelligence-platform)
  + Column 2
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
      * [Snow Spend Optimizer](https://www.flexera.com/products/snow-atlas/snow-spend-optimizer)
      * [Snow SaaS Management](https://www.flexera.com/products/snow-atlas/snow-saas-management)
  + Column 3
    - Hide group
      * [Security](https://www.flexera.com/products/security)
      * [Application Readiness](https://www.flexera.com/products/adminstudio)
      * [All products](https://www.flexera.com/products)
      * [All Snow products](https://www.flexera.com/products/snow)
      * [Integrations](https://www.flexera.com/products/integrations)

  ### Flexera 2024 State of the Cloud Report

  What do transformative initiatives such as GenAI, machine learning and sustainability mean for the cloud? Check out the 2024 State of the Cloud Report to find the answer as well as all the latest cloud computing trends.

  [View Report](https://info.flexera.com/CM-REPORT-State-of-the-Cloud)
* Success
  + Column 1
    - [Customer success](https://www.flexera.com/customer-success)
      * Support
        + [Flexera support portal](https://community.flexera.com/s/support-hub)
        + [Flexera product documentation](https://docs.flexera.com)
        + [Snow product documentation](https://docs.snowsoftware.io/)
      * Services and training
        + [Services](https://www.flexera.com/customer-success/services)
        + [Training](https://www.flexera.com/customer-success/training)
  + Column 2
    - Hide group
      * [Technology Intelligence Awards](https://www.flexera.com/customer-success/awards)
      * [Flexera community](https://community.flexera.com/s/)

  ### Insights from Gartner®

  Find a curated series of actionable and objective insights for IT executives and their teams. Get expert insights from valued analysts, courtesy of Flexera.

  [Discover More](https://www.flexera.com/resources/gartner-analyst-research)
* Resources
  + Column 1
    - [Resources](https://www.flexera.com/resources)
      * [Webinars](https://www.flexera.com/resources?type%5Bwebinar%5D=webinar)
      * [Videos](https://www.flexera.com/resources?type%5Bvideo%5D=video)
      * [Datasheets](https://www.flexera.com/resources?type%5Bdatasheet%5D=datasheet)
      * [White papers & reports](https://www.flexera.com/resources?type%5Bwhite-paper-industry-report%5D=white-paper-industry-report)
  + Column 2
    - Hide group
      * [Blog](/blog/)
      * [Case studies](https://www.flexera.com/resources/case-studies)
      * [Events](https://www.flexera.com/resources?type%5Bevent%5D=event)
      * [Analyst Research](https://www.flexera.com/resources/gartner-analyst-research)
      * [Glossary](https://www.flexera.com/resources/glossary)
      * [Demos & trials](https://www.flexera.com/resources?type%5Bdemo-trials%5D=demo-trials)
      * [Business value calculator](https://www.flexera.com/resources/business-value-calculator)

  ### Flexera 2025 IT Priorities Report

  Insights from Flexera’s 2025 IT Priorities Report highlight what’s top of mind for IT decision makers in the year ahead. Discover the challenges, priorities and opportunities that will shape the future IT landscape.

  [View Report](https://info.flexera.com/ITV-REPORT-IT-Priorities)
* About
  + Column 1
    - [Company](https://www.flexera.com/about-us)
      * [About](https://www.flexera.com/about-us)
      * [Careers](https://www.flexera.com/about-us/careers)
      * [Contact](https://www.flexera.com/about-us/contact-us)
      * [Leadership](https://www.flexera.com/about-us/leadership)
    - [Partners](https://www.flexera.com/about-us/partners)
      * [Partner program](https://www.flexera.com/about-us/partners/partner-program)
      * [Partner directory](https://www.flexera.com/about-us/partners/directory)
  + Column 2
    - [Press center](https://www.flexera.com/about-us/press-center)
      * [Press releases](https://www.flexera.com/about-us/all-press-releases)
      * [Awards](https://www.flexera.com/about-us/press-center#awards)
      * [Articles](https://www.flexera.com/about-us/all-articles)
    - Hide group
      * Social responsibility
        + [ESG](https://www.flexera.com/about-us/environmental-social-governance)
        + [Diversity](https://www.flexera.com/about-us/diversity)

  ### More value with technology intelligence

  The unparalleled synergy of Flexera and Snow provides the Technology Intelligence you need for more efficiency, insight and governance than ever before.

  [Discover More](https://www.flexera.com/more-value-with-technology-intelligence)

Search

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

## External Links

* External Links
  + [Community](https://community.flexera.com/)
  + [Product Access](https://app.flexera.com/login)
  + [Partner Portal](https://flexera.channeltivity.com/Login)

[Book a demo](/about-us/contact-us?C_Interest1=sales)

# Secunia Research

## The world’s best vulnerability intelligence

The Secunia Research team from Flexera provides the most accurate and reliable source of vulnerability intelligence.

[Contact Us](https://www.flexera.com/about-us/contact-us?C_Interest1=sales&C_SolutionInterest=SVM)
Watch video (0:29)

Related links

* [Anatomy of a security advisory](https://www.flexera.com/resources/infographics/anatomy-of-a-security-advisory)
* [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)
* [Software Vulnerability Manager](/products/software-vulnerability-manager)
* [Security advisories from Secunia Research](https://www.flexera.com/products/security/software-vulnerability-advisories)
* [Report a vulnerability](https://www.flexera.com/about-us/contact-us/report-vulnerability)

 ![Secunia Research](/sites/default/files/2022-04/hero-secunia-research-bg.jpg)

Featured Details

## Multiple ways to consume Secunia Research

Secunia delivers software security research that provides reliable, curated and actionable vulnerability intelligence. Organizations can expect to receive standardized, validated and enriched vulnerability research on a specific version of a software product. Secunia Research supports four solutions:

![Software Vulnerability Research](/sites/default/files/2022-04/icon-secunia-research-svr.svg)

### [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)

Software Vulnerability Research utilizes Secunia Research to drive awareness of vulnerabilities matching your specified criteria

[Learn More](https://www.flexera.com/products/software-vulnerability-research)

![Software Vulnerability Manager](/sites/default/files/2022-04/icon-secunia-research-svm.svg)

### [Software Vulnerability Manager](/products/software-vulnerability-manager)

Software Vulnerability Manager uses Secunia Research data to identify, prioritize and patch known vulnerable software detected in your environment

[Learn More](/products/software-vulnerability-manager)

![Data Platform](/sites/default/files/2022-04/icon-secunia-research-dp.svg)

### [Data Platform](https://www.flexera.com/products/data-platform)

Data Platform leverages Secunia Research to provide high-level insights based on major or minor versions of software in your normalized inventory

[Learn More](https://www.flexera.com/products/data-platform)

![Flexera One](/sites/default/files/2022-04/icon-secunia-research-flexera-one.svg)

### [Flexera One](/flexera-one)

Flexera One utilizes Secunia Research (alongside public NVD data) to provide more granular matching of build-level versions of software in your normalized inventory within its IT Asset Management and IT Visibility solutions

[Learn More](/flexera-one)

How it works

## Accurate, reliable vulnerability insights at your fingertips

The Secunia Research team from Flexera is comprised of several security specialists who conduct vulnerability research in various products in addition to testing, verifying and validating public vulnerability reports. Since its inception in 2002, the goal of the Secunia Research team is to provide the most accurate and reliable source of vulnerability intelligence.

Delivering the world’s best vulnerability intelligence requires skill and passion. Team members continually develop their skills exploring various high-profile closed and open-source software using a variety of approaches, focusing chiefly on thorough code audits and binary analysis. The team has received industry recognition, including naming members to [Microsoft’s Most Valuable Security Researchers](https://msrc-blog.microsoft.com/2019/08/07/announcing-2019-msrc-most-valuable-security-researchers/) list.

Secunia researchers discover hard-to-find vulnerabilities that aren’t normally identified with techniques such as fuzzing, and the results have been impressive. Members of the Secunia Research team have discovered critical vulnerabilities in products from vendors including Microsoft, Symantec, IBM, Adobe, RealNetworks, Trend Micro, HP, Blue Coat, Samba, CA, Mozilla and Apple.

The team produces invaluable security advisories based on research of the vulnerabilities affecting any given software update. Sometimes a single update can address multiple vulnerabilities of varying criticalities and threats; but these advisories aggregate and distill findings down to a single advisory perfect for the prioritization of patching efforts within [Software Vulnerability Manager](/products/software-vulnerability-manager). Criticality scores are consistently applied along with details around attack vector and other valuable details within [Software Vulnerability Research](/products/software-vulnerability-research/secunia-research). Illegitimate vulnerability reports are also investigated and rejected so you can focus only on what truly matters.

Informing IT, Transforming IT

## Industry insights to help keep you informed

[#### Webinar

### Stay Ahead of Cyber Threats: Flexera's Latest Vulnerability Insights

Join us for this session where we'll explore the latest findings from the Flexera Monthly Vulnerability Insights Report.](https://info.flexera.com/SVM-WBNR-Vulnerability-Insights-Roundtable)

[#### Webinar

### Dive deeper into the Flexera Annual Vulnerability Insights

We'll explore the key findings from the Flexera Annual Vulnerability Insights Report. Learn about the latest cybersecurity trends, the most targeted industries, the types of vulnerabilities, plus management and mitigation strategies.](https://info.flexera.com/SVM-WBNR-Flexera-Annual-Vulnerability-Insights?lead_source=Website%20Visitor&id=Flexera.com-Resources)

#### Video

### Close the Risk Window with Software Vulnerability Manager

Stop reacting. Gain control. Stay secure. Build a more effective risk mitigation process leveraging Secunia Research vulnerability intelligence and the largest repository of third-party patch data in the industry.

Remote video URL

[#### Trial

### Software Vulnerability Manager Assessment free trial

Get access to the complete set of modules of Software Vulnerability Manager: Research, Assessment and Patching](https://info.flexera.com/SVM-EVAL-Software-Vulnerability-Manager)

[#### Datasheet

### Protect your ServiceNow® investment with the highest quality data

IT Visibility offers certified ServiceNow integrations that accelerate platform expansion, improve ROI and increase efficiencies across ITIL processes by delivering clean software and hardware asset data directly.](/sites/default/files/datasheet-itv-maximize-servicenow-investment.pdf)

[#### Blog

### Avoid missing crucial vulnerability intelligence amid NVD backlog

Recent developments regarding the National Vulnerability Database (NVD) have some technology leaders on edge. Since February, the U.S. National Institute of Standards and Technology (NIST) has almost completely stopped enriching software vulnerabi...](https://www.flexera.com/blog/vulnerability-management/avoid-missing-crucial-vulnerability-intelligence-amid-nvd-backlog/)

[View all resources](https://www.flexera.com/resources?category%5Bsoftware-vulnerability-management%5D=software-vulnerability-management)

## Footer Menu

* Column
  + Business challenge
    - [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
    - [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
    - [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
    - [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
    - [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
    - [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
    - [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
    - [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
    - [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
    - [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
    - [Public sector](https://www.flexera.com/solutions/public-sector)
* Column
  + Spend management by vendor
    - [IBM](https://www.flexera.com/solutions/vendor/ibm)
    - [Oracle](https://www.flexera.com/solutions/vendor/oracle)
    - [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
    - [SAP](https://www.flexera.com/solutions/vendor/sap)
    - [VMware](https://www.flexera.com/solutions/vendor/vmware)
    - [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
    - [AWS](https://www.flexera.com/solutions/vendor/aws)
    - [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
    - [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
    - [Adobe](https://www.flexera.com/solutions/vendor/adobe)
* Column
  + Products
    - [Flexera One](https://www.flexera.com/products/flexera-one)
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
    - [Security](https://www.flexera.com/products/security)
    - [Application Readiness](https://www.flexera.com/products/adminstudio)
    - [All products](https://www.flexera.com/products)
    - [All Snow products](https://www.flexera.com/products/snow)
    - [Integrations](https://www.flexera.com/products/integrations)
* Column
  + Company
    - [About](https://www.flexera.com/about-us)
    - [Careers](https://www.flexera.com/about-us/careers)
    - [Leadership](https://www.flexera.com/about-us/leadership)
    - [Contact us](https://www.flexera.com/about-us/contact-us)
    - [Media / press center](https://www.flexera.com/about-us/press-center)
    - [Revenera.com](https://www.revenera.com)

 +1.800.374.4353

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

 [![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

© 2025 Flexera. All Rights Reserved.

## Footer

* [Privacy Policy](https://www.flexera.com/legal/privacy-policy)
* [Terms and conditions](https://www.flexera.com/legal)
* [Contact Us](https://www.flexera.com/about-us/contact-us)
* [Impressum](https://www.flexera.com/about-us/impressum)
* [Site Map](https://www.flexera.com/sitemap)

#####

×

...



=== Content from cdn.kernel.org_db6d17ac_20250125_123715.html ===
commit 30ad2851a645bb5f42c72f21ceb166877cf7e695
Author: Sasha Levin
Date: Mon Jan 22 12:40:06 2018 -0800
Linux 4.1.49
Signed-off-by: Sasha Levin
commit 623dfab42becf5c56c9a31b7eaf90cb6eb86459f
Author: Long Li
Date: Wed Jan 10 13:21:29 2018 -0700
storvsc: do not assume SG list is continuous when doing bounce buffers
The original patch was made for stable 4.1 and was Acked on 08/22/2017, but for
some reason it never made it to the stable tree.
Change from v1:
Changed comment that this patch is for linux-stable 4.1 and all prior stable
kernels.
storvsc checks the SG list for gaps before passing them to Hyper-v device.
If there are gaps, data is copied to a bounce buffer and a continuous data
buffer is passed to Hyper-V.
The check on gaps assumes SG list is continuous, and not chained. This is
not always true. Failing the check may result in incorrect I/O data
passed to the Hyper-v device.
This code path is not used post Linux 4.1.
[LL: Backport for 4.1]
Signed-off-by: Long Li
Acked-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit feedfe2129e348e075b72a5e3e1c7c52d0c769e4
Author: Martin Kepplinger
Date: Fri Nov 6 16:31:02 2015 -0800
bitops.h: add sign\_extend64()
[ Upstream commit 48e203e21b29cd4b2c58403fe8bca68e2e854895 ]
Months back, this was discussed, see https://lkml.org/lkml/2015/1/18/289
The result was the 64-bit version being "likely fine", "valuable" and
"correct". The discussion fell asleep but since there are possible users,
let's add it.
Signed-off-by: Martin Kepplinger
Cc: Peter Zijlstra
Cc: Ingo Molnar
Cc: Arnaldo Carvalho de Melo
Cc: Thomas Gleixner
Cc: "H. Peter Anvin"
Cc: George Spelvin
Cc: Rasmus Villemoes
Cc: Maxime Coquelin
Cc: Denys Vlasenko
Cc: Yury Norov
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit ba00cc7686f6df5ca08a2a40d5c80ef744368d23
Author: Nicholas Krause
Date: Sat Jul 4 16:34:32 2015 -0400
gpio: 74xx: Fix build warning about void to integer cast
[ Upstream commit 54442658d8e83b0589731620bd958cc8b2857167 ]
This fixes the build warning , warning: cast from pointer to integer
of different size when building this file on a x86 allmodconfig
configuration. In order for me to fix this build warning I changed
the cast in the function mmio\_74xx\_gpio\_probe from casting the
variable data of the stucture pointer of\_id to uintptr\_t rather
then unsigned when assigning to the variable flag of the structure
pointer priv of the structure type mmio\_74xx\_gpio\_priv.
Signed-off-by: Nicholas Krause
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit 6f2248686a9b20ad8c9bea6126b2495d7f8048e7
Author: Arnd Bergmann
Date: Fri Jul 1 18:02:22 2016 +0100
ARM: 8584/1: floppy: avoid gcc-6 warning
[ Upstream commit dd665be0e243873343a28e18f9f345927b658daf ]
gcc-6.0 warns about comparisons between two identical expressions,
which is what we get in the floppy driver when writing to the FD\_DOR
register:
drivers/block/floppy.c: In function 'set\_dor':
drivers/block/floppy.c:810:44: error: self-comparison always evaluates to true [-Werror=tautological-compare]
fd\_outb(newdor, FD\_DOR);
It would be nice to use a static inline function instead of the
macro, to avoid the warning, but we cannot do that because the
FD\_DOR definition is incomplete at this point.
Adding a cast to (u32) is a harmless way to shut up the warning,
just not very nice.
Signed-off-by: Arnd Bergmann
Signed-off-by: Russell King
Signed-off-by: Sasha Levin
commit 74b6cfd76efd9787afc57dd8983881911b8806ec
Author: Arnd Bergmann
Date: Wed Nov 16 16:20:37 2016 +0100
ARM: ux500: fix prcmu\_is\_cpu\_in\_wfi() calculation
[ Upstream commit f0e8faa7a5e894b0fc99d24be1b18685a92ea466 ]
This function clearly never worked and always returns true,
as pointed out by gcc-7:
arch/arm/mach-ux500/pm.c: In function 'prcmu\_is\_cpu\_in\_wfi':
arch/arm/mach-ux500/pm.c:137:212: error: ?:
using integer constants in boolean context, the expression
will always evaluate to 'true' [-Werror=int-in-bool-context]
With the added braces, the condition actually makes sense.
Fixes: 34fe6f107eab ("mfd : Check if the other db8500 core is in WFI")
Signed-off-by: Arnd Bergmann
Acked-by: Daniel Lezcano
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit cef20adbe64cd8550ede8d551f8f6ebcf805d5ef
Author: Linus Torvalds
Date: Wed Jul 12 19:25:47 2017 -0700
disable new gcc-7.1.1 warnings for now
[ Upstream commit bd664f6b3e376a8ef4990f87d08271cc2d01ba9a ]
I made the mistake of upgrading my desktop to the new Fedora 26 that
comes with gcc-7.1.1.
There's nothing wrong per se that I've noticed, but I now have 1500
lines of warnings, mostly from the new format-truncation warning
triggering all over the tree.
We use 'snprintf()' and friends in a lot of places, and often know that
the numbers are fairly small (ie a controller index or similar), but gcc
doesn't know that, and sees an 'int', and thinks that it could be some
huge number. And then complains when our buffers are not able to fit
the name for the ten millionth controller.
These warnings aren't necessarily bad per se, and we probably want to
look through them subsystem by subsystem, but at least during the merge
window they just mean that I can't even see if somebody is introducing
any \*real\* problems when I pull.
So warnings disabled for now.
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 3c59dd4fae37154386b4a04543b137e054fba04a
Author: Arnd Bergmann
Date: Thu Nov 24 17:26:22 2016 +0100
irda: fix overly long udelay()
[ Upstream commit c9bd28233b6d0d82ac3ba0215723be0a8262c39c ]
irda\_get\_mtt() returns a hardcoded '10000' in some cases,
and with gcc-7, we get a build error because this triggers a
compile-time check in udelay():
drivers/net/irda/w83977af\_ir.o: In function `w83977af\_hard\_xmit':
w83977af\_ir.c:(.text.w83977af\_hard\_xmit+0x14c): undefined reference to `\_\_bad\_udelay'
Older compilers did not run into this because they either did not
completely inline the irda\_get\_mtt() or did not consider the
10000 value a constant expression.
The code has been wrong since the start of git history.
Signed-off-by: Arnd Bergmann
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit eaedee951a16779f8056e50c799ff7e6f455c953
Author: Martin Liska
Date: Fri May 12 15:46:35 2017 -0700
gcov: support GCC 7.1
[ Upstream commit 05384213436ab690c46d9dfec706b80ef8d671ab ]
Starting from GCC 7.1, \_\_gcov\_exit is a new symbol expected to be
implemented in a profiling runtime.
[akpm@linux-foundation.org: coding-style fixes]
[mliska@suse.cz: v2]
Link: http://lkml.kernel.org/r/e63a3c59-0149-c97e-4084-20ca8f146b26@suse.cz
Link: http://lkml.kernel.org/r/8c4084fa-3885-29fe-5fc4-0d4ca199c785@suse.cz
Signed-off-by: Martin Liska
Acked-by: Peter Oberparleiter
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 8ec347fc139013501ba175fa9760b3b79796da7f
Author: Florian Meier
Date: Thu Jul 14 12:07:26 2016 -0700
gcov: add support for gcc version >= 6
[ Upstream commit d02038f972538b93011d78c068f44514fbde0a8c ]
Link: http://lkml.kernel.org/r/20160701130914.GA23225@styxhp
Signed-off-by: Florian Meier
Reviewed-by: Peter Oberparleiter
Tested-by: Peter Oberparleiter
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 4862c0509c9d20d610da6a15ac9ce86de3dc5ba6
Author: Lorenzo Stoakes
Date: Tue Jun 30 14:57:49 2015 -0700
gcov: add support for GCC 5.1
[ Upstream commit 3e44c471a2dab210f7e9b1e5f7d4d54d52df59eb ]
Fix kernel gcov support for GCC 5.1. Similar to commit a992bf836f9
("gcov: add support for GCC 4.9"), this patch takes into account the
existence of a new gcov counter (see gcc's gcc/gcov-counter.def.)
Firstly, it increments GCOV\_COUNTERS (to 10), which makes the data
structure struct gcov\_info compatible with GCC 5.1.
Secondly, a corresponding counter function \_\_gcov\_merge\_icall\_topn (Top N
value tracking for indirect calls) is included in base.c with the other
gcov counters unused for kernel profiling.
Signed-off-by: Lorenzo Stoakes
Cc: Andrey Ryabinin
Cc: Yuan Pengfei
Tested-by: Peter Oberparleiter
Reviewed-by: Peter Oberparleiter
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit daa876c7e8b4f66d7fceb19eb1959f47ea103bff
Author: Arnd Bergmann
Date: Thu Nov 19 11:42:26 2015 +0100
net: tulip: turn compile-time warning into dev\_warn()
[ Upstream commit de92718883ddbcd11b738d36ffcf57617b97fa12 ]
The tulip driver causes annoying build-time warnings for allmodconfig
builds for all recent architectures:
dec/tulip/winbond-840.c:910:2: warning: #warning Processor architecture undefined
dec/tulip/tulip\_core.c:101:2: warning: #warning Processor architecture undefined!
This is the last remaining warning for arm64, and I'd like to get rid of
it. We don't really know the cache line size, architecturally it would
be at least 16 bytes, but all implementations I found have 64 or 128
bytes. Configuring tulip for 32-byte lines as we do on ARM32 seems to
be the safe but slow default, and nobody who cares about performance these
days would use a tulip chip anyway, so we can just use that.
To save the next person the job of trying to find out what this is for
and picking a default for their architecture just to kill off the warning,
I'm now removing the preprocessor #warning and turning it into a pr\_warn
or dev\_warn that prints the equivalent information when the driver gets
loaded.
Signed-off-by: Arnd Bergmann
Acked-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit aef3297a50e7fd666a817aba566537fceeee0f1a
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
commit 411934395be9e8074f08876c4b9fcbfee2574f43
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
commit 1e6e40c8b310566b8d49c272be4fe1fe550409ff
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 89e819fc3f468e6a539596c24146d014fa9078c6
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
commit de6513563f35dead300c82411c174d8834b84bb3
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 67cd91a587fa5bf071406a1ed91a9ed13b480973
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 911c1eaea477b8c4938e851b5720044e4e323505
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 4695854c19d6831928e2467b9f7a375bbd6d4f7b
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
commit 50cad28ec97ea9a0a6ed9018c24384dee57fb8e3
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit b4aad4ba23e9901f51e42dd30e552f91c40d63c5
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
[ Upstream commit bd3486ded7a0c313a6575343e6c2b21d14476645 ]
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Cc: stable@vger.kernel.org # v3.16+
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 817c8706ce04e19209ffa05c68b038e3c56143ec
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit eae9baa0fb770a801472d0b19604c30c5ab64451
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
commit e9d85866c84c8ea47b04185a8343823962b1fc6b
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit dc8736a8624ecf22090ff23fa1532fbe5252f3f9
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
commit c53b1162f90c24e3a308d0cd885edc9b0c141f60
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
commit 5a260ef67e55cc6dce5c39acecc2cbfb0ef3150d
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d2573c551583421b21a07116ff847ca9e27cd256
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit a7a5473af8b85c8604b5ae5bbbd3e3c077584436
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit b45f3bb8f1a532b92922ff15a41435679eafdae8
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
commit bfd3a082492c4bf283e5c783205f67760c30daed
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
commit 2b3e37c146695fa8b0f7747e75b64ef807a36f48
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 350e8cd3ccd99691d51da10a79d6954740fa9b09
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
commit a5579ec0173222b49e104e17aab63cd664d14024
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 7103f7e1bcc4f3387c371d7ad3f102597e84da0c
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit abc0400cd8accd1ace0d69b7c0994014aaa9bb7b
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
commit 787542f14a548dd43113a0556400c59fb990f058
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
commit 1d3f887ec1417723796770fee371ddbd2f882c9a
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
commit 36376ec8e77b9e537b29dbb8a1497968c4b25e95
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
commit ea51d62d96c1ff9c39614fb855aca7d2fc4c68fa
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
commit d807bd894ab8ee75f166a2929e1467fb91624535
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
commit 703f625378288d753bdd8a22822a5254ff1a0b3f
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
commit fc5d20b5cc21cf82d196bbf173a29cdde4fb9236
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit 7a10bd329fd5a2510cadd9fd6cc54b4436603257
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
commit f1530123dba028c4a656bff29c0706a94cf95c9d
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
commit 46c0f37ae53cede02cfde76587a86163c5158708
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
commit c94e3801ad2c95cce2e17c32a58d3550d621d3be
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
commit 30d5fde364f7137fe5f95bb07200ae0eb265d81b
Author: Mike Christie
Date: Wed Mar 1 23:13:26 2017 -0600
target: Use system workqueue for ALUA transitions
[ Upstream commit 207ee84133c00a8a2a5bdec94df4a5b37d78881c ]
If tcmu-runner is processing a STPG and needs to change the kernel's
ALUA state then we cannot use the same work queue for task management
requests and ALUA transitions, because we could deadlock. The problem
occurs when a STPG times out before tcmu-runner is able to
call into target\_tg\_pt\_gp\_alua\_access\_state\_store->
core\_alua\_do\_port\_transition -> core\_alua\_do\_transition\_tg\_pt ->
queue\_work. In this case, the tmr is on the work queue waiting for
the STPG to complete, but the STPG transition is now queued behind
the waiting tmr.
Note:
This bug will also be fixed by this patch:
http://www.spinics.net/lists/target-devel/msg14560.html
which switches the tmr code to use the system workqueues.
For both, I am not sure if we need a dedicated workqueue since
it is not a performance path and I do not think we need WQ\_MEM\_RECLAIM
to make forward progress to free up memory like the block layer does.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
commit 768b1d1dbb46f8c7525c30e8cdb4cd1f38d98e99
Author: Zygo Blaxell
Date: Fri Mar 10 16:45:44 2017 -0500
btrfs: add missing memset while reading compressed inline extents
[ Upstream commit e1699d2d7bf6e6cce3e1baff19f9dd4595a58664 ]
This is a story about 4 distinct (and very old) btrfs bugs.
Commit c8b978188c ("Btrfs: Add zlib compression support") added
three data corruption bugs for inline extents (bugs #1-3).
Commit 93c82d5750 ("Btrfs: zero page past end of inline file items")
fixed bug #1: uncompressed inline extents followed by a hole and more
extents could get non-zero data in the hole as they were read. The fix
was to add a memset in btrfs\_get\_extent to zero out the hole.
Commit 166ae5a418 ("btrfs: fix inline compressed read err corruption")
fixed bug #2: compressed inline extents which contained non-zero bytes
might be replaced with zero bytes in some cases. This patch removed an
unhelpful memset from uncompress\_inline, but the case where memset is
required was missed.
There is also a memset in the decompression code, but this only covers
decompressed data that is shorter than the ram\_bytes from the extent
ref record. This memset doesn't cover the region between the end of the
decompressed data and the end of the page. It has also moved around a
few times over the years, so there's no single patch to refer to.
This patch fixes bug #3: compressed inline extents followed by a hole
and more extents could get non-zero data in the hole as they were read
(i.e. bug #3 is the same as bug #1, but s/uncompressed/compressed/).
The fix is the same: zero out the hole in the compressed case too,
by putting a memset back in uncompress\_inline, but this time with
correct parameters.
The last and oldest bug, bug #0, is the cause of the offending inline
extent/hole/extent pattern. Bug #0 is a subtle and mostly-harmless quirk
of behavior somewhere in the btrfs write code. In a few special cases,
an inline extent and hole are allowed to persist where they normally
would be combined with later extents in the file.
A fast reproducer for bug #0 is presented below. A few offending extents
are also created in the wild during large rsync transfers with the -S
flag. A Linux kernel build (git checkout; make allyesconfig; make -j8)
will produce a handful of offending files as well. Once an offending
file is created, it can present different content to userspace each
time it is read.
Bug #0 is at least 4 and possibly 8 years old. I verified every vX.Y
kernel back to v3.5 has this behavior. There are fossil records of this
bug's effects in commits all the way back to v2.6.32. I have no reason
to believe bug #0 wasn't present at the beginning of btrfs compression
support in v2.6.29, but I can't easily test kernels that old to be sure.
It is not clear whether bug #0 is worth fixing. A fix would likely
require injecting extra reads into currently write-only paths, and most
of the exceptional cases caused by bug #0 are already handled now.
Whether we like them or not, bug #0's inline extents followed by holes
are part of the btrfs de-facto disk format now, and we need to be able
to read them without data corruption or an infoleak. So enough about
bug #0, let's get back to bug #3 (this patch).
An example of on-disk structure leading to data corruption found in
the wild:
item 61 key (606890 INODE\_ITEM 0) itemoff 9662 itemsize 160
inode generation 50 transid 50 size 47424 nbytes 49141
block group 0 mode 100644 links 1 uid 0 gid 0
rdev 0 flags 0x0(none)
item 62 key (606890 INODE\_REF 603050) itemoff 9642 itemsize 20
inode ref index 3 namelen 10 name: DB\_File.so
item 63 key (606890 EXTENT\_DATA 0) itemoff 8280 itemsize 1362
inline extent data size 1341 ram 4085 compress(zlib)
item 64 key (606890 EXTENT\_DATA 4096) itemoff 8227 itemsize 53
extent data disk byte 5367308288 nr 20480
extent data offset 0 nr 45056 ram 45056
extent compression(zlib)
Different data appears in userspace during each read of the 11 bytes
between 4085 and 4096. The extent in item 63 is not long enough to
fill the first page of the file, so a memset is required to fill the
space between item 63 (ending at 4085) and item 64 (beginning at 4096)
with zero.
Here is a reproducer from Liu Bo, which demonstrates another method
of creating the same inline extent and hole pattern:
Using 'page\_poison=on' kernel command line (or enable
CONFIG\_PAGE\_POISONING) run the following:
# touch foo
# chattr +c foo
# xfs\_io -f -c "pwrite -W 0 1000" foo
# xfs\_io -f -c "falloc 4 8188" foo
# od -x foo
# echo 3 >/proc/sys/vm/drop\_caches
# od -x foo
This produce the following on my box:
Correct output: file contains 1000 data bytes followed
by zeros:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 0000 0000 0000 0000
0001760 0000 0000 0000 0000 0000 0000 0000 0000
\*
0020000
Actual output: the data after the first 1000 bytes
will be different each run:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 6c63 7400 635f 006d
0001760 5f74 6f43 7400 435f 0053 5f74 7363 7400
0002000 435f 0056 5f74 6164 7400 645f 0062 5f74
(...)
Signed-off-by: Zygo Blaxell
Reviewed-by: Liu Bo
Reviewed-by: Chris Mason
Signed-off-by: Chris Mason
Signed-off-by: Sasha Levin
commit 265926de6f07bcc02059f03bfc57dd1fda13b032
Author: Olga Kornievskaia
Date: Wed Mar 8 14:39:15 2017 -0500
NFSv4.1 respect server's max size in CREATE\_SESSION
[ Upstream commit 033853325fe3bdc70819a8b97915bd3bca41d3af ]
Currently client doesn't respect max sizes server returns in CREATE\_SESSION.
nfs4\_session\_set\_rwsize() gets called and server->rsize, server->wsize are 0
so they never get set to the sizes returned by the server.
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit c7da20b8ca027a7554224814e1f2d098d1268e3b
Author: Daniel Borkmann
Date: Wed Mar 15 22:53:37 2017 +0100
perf symbols: Fix symbols\_\_fixup\_end heuristic for corner cases
[ Upstream commit e7ede72a6d40cb3a30c087142d79381ca8a31dab ]
The current symbols\_\_fixup\_end() heuristic for the last entry in the rb
tree is suboptimal as it leads to not being able to recognize the symbol
in the call graph in a couple of corner cases, for example:
i) If the symbol has a start address (f.e. exposed via kallsyms)
that is at a page boundary, then the roundup(curr->start, 4096)
for the last entry will result in curr->start == curr->end with
a symbol length of zero.
ii) If the symbol has a start address that is shortly before a page
boundary, then also here, curr->end - curr->start will just be
very few bytes, where it's unrealistic that we could perform a
match against.
Instead, change the heuristic to roundup(curr->start, 4096) + 4096, so
that we can catch such corner cases and have a better chance to find
that specific symbol. It's still just best effort as the real end of the
symbol is unknown to us (and could even be at a larger offset than the
current range), but better than the current situation.
Alexei reported that he recently run into case i) with a JITed eBPF
program (these are all page aligned) as the last symbol which wasn't
properly shown in the call graph (while other eBPF program symbols in
the rb tree were displayed correctly). Since this is a generic issue,
lets try to improve the heuristic a bit.
Reported-and-Tested-by: Alexei Starovoitov
Signed-off-by: Daniel Borkmann
Fixes: 2e538c4a1847 ("perf tools: Improve kernel/modules symbol lookup")
Link: http://lkml.kernel.org/r/bb5c80d27743be6f12afc68405f1956a330e1bc9.1489614365.git.daniel@iogearbox.net
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 889408d364b74df8b175617885d762a74c690315
Author: Jack Morgenstein
Date: Mon Mar 13 19:29:08 2017 +0200
net/mlx4\_core: Avoid delays during VF driver device shutdown
[ Upstream commit 4cbe4dac82e423ecc9a0ba46af24a860853259f4 ]
Some Hypervisors detach VFs from VMs by instantly causing an FLR event
to be generated for a VF.
In the mlx4 case, this will cause that VF's comm channel to be disabled
before the VM has an opportunity to invoke the VF device's "shutdown"
method.
For such Hypervisors, there is a race condition between the VF's
shutdown method and its internal-error detection/reset thread.
The internal-error detection/reset thread (which runs every 5 seconds) also
detects a disabled comm channel. If the internal-error detection/reset
flow wins the race, we still get delays (while that flow tries repeatedly
to detect comm-channel recovery).
The cited commit fixed the command timeout problem when the
internal-error detection/reset flow loses the race.
This commit avoids the unneeded delays when the internal-error
detection/reset flow wins.
Fixes: d585df1c5ccf ("net/mlx4\_core: Avoid command timeouts during VF driver device shutdown")
Signed-off-by: Jack Morgenstein
Reported-by: Simon Xiao
Signed-off-by: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4f5f3108254093bad63632335bdc245e02eb4427
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix afs\_kill\_pages()
[ Upstream commit 7286a35e893176169b09715096a4aca557e2ccd2 ]
Fix afs\_kill\_pages() in two ways:
(1) If a writeback has been partially flushed, then if we try and kill the
pages it contains, some of them may no longer be undergoing writeback
and end\_page\_writeback() will assert.
Fix this by checking to see whether the page in question is actually
undergoing writeback before ending that writeback.
(2) The loop that scans for pages to kill doesn't increase the first page
index, and so the loop may not terminate, but it will try to process
the same pages over and over again.
Fix this by increasing the first page index to one after the last page
we processed.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit b38a026e7efd5d260fdb52160d51cd1e29b8a476
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix page leak in afs\_write\_begin()
[ Upstream commit 6d06b0d25209c80e99c1e89700f1e09694a3766b ]
afs\_write\_begin() leaks a ref and a lock on a page if afs\_fill\_page()
fails. Fix the leak by unlocking and releasing the page in the error path.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit fe218174a8cd439eff908001a7ebcdfd6786a114
Author: Marc Dionne
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Populate and use client modification time
[ Upstream commit ab94f5d0dd6fd82e7eeca5e7c8096eaea0a0261f ]
The inode timestamps should be set from the client time
in the status received from the server, rather than the
server time which is meant for internal server use.
Set AFS\_SET\_MTIME and populate the mtime for operations
that take an input status, such as file/dir creation
and StoreData. If an input time is not provided the
server will set the vnode times based on the current server
time.
In a situation where the server has some skew with the
client, this could lead to the client seeing a timestamp
in the future for a file that it just created or wrote.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 6057493b8d401c2586479fe1e19accb883398feb
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Fix the maths in afs\_fs\_store\_data()
[ Upstream commit 146a1192783697810b63a1e41c4d59fc93387340 ]
afs\_fs\_store\_data() works out of the size of the write it's going to make,
but it uses 32-bit unsigned subtraction in one place that gets
automatically cast to loff\_t.
However, if to < offset, then the number goes negative, but as the result
isn't signed, this doesn't get sign-extended to 64-bits when placed in a
loff\_t.
Fix by casting the operands to loff\_t.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 6002fff6d220c112935fa96a2d796528b71aac05
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Prevent callback expiry timer overflow
[ Upstream commit 56e714312e7dbd6bb83b2f78d3ec19a404c7649f ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs\_vnode record to use ktime\_get\_real\_seconds() instead, for the
fields cb\_expires and cb\_expires\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 3e8f3e799ee57e69b4b1592e9f43005f7e474e4e
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Migrate vlocation fields to 64-bit
[ Upstream commit 8a79790bf0b7da216627ffb85f52cfb4adbf1e4e ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs's vlocation record to use ktime\_get\_real\_seconds() instead, for the
fields time\_of\_death and update\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit a4855bd91dc695528e5f2175cd3f62baa4cad812
Author: David Howells
Date: Thu Mar 16 16:27:45 2017 +0000
afs: Flush outstanding writes when an fd is closed
[ Upstream commit 58fed94dfb17e89556b5705f20f90e5b2971b6a1 ]
Flush outstanding writes in afs when an fd is closed. This is what NFS and
CIFS do.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 878b514971dccc110ab715513b4349983904aeda
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Adjust mode bits processing
[ Upstream commit 627f46943ff90bcc32ddeb675d881c043c6fa2ae ]
Mode bits for an afs file should not be enforced in the usual
way.
For files, the absence of user bits can restrict file access
with respect to what is granted by the server.
These bits apply regardless of the owner or the current uid; the
rest of the mode bits (group, other) are ignored.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 70f9b817ed9032b8b598c7e60b5508d007bf6e37
Author: Marc Dionne
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Populate group ID from vnode status
[ Upstream commit 6186f0788b31f44affceeedc7b48eb10faea120d ]
The group was hard coded to GLOBAL\_ROOT\_GID; use the group
ID that was received from the server.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 416538a008726455cda2fd90eee5a03c875a3e37
Author: David Howells
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Fix missing put\_page()
[ Upstream commit 29c8bbbd6e21daa0997d1c3ee886b897ee7ad652 ]
In afs\_writepages\_region(), inside the loop where we find dirty pages to
deal with, one of the if-statements is missing a put\_page().
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit d70aca3a2e967822b307fa272ae38875f5028667
Author: Steven Rostedt (VMware)
Date: Thu Mar 2 15:10:59 2017 +0100
sched/deadline: Use deadline instead of period when calculating overflow
[ Upstream commit 2317d5f1c34913bac5971d93d69fb6c31bb74670 ]
I was testing Daniel's changes with his test case, and tweaked it a
little. Instead of having the runtime equal to the deadline, I
increased the deadline ten fold.
Daniel's test case had:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
To make it more interesting, I changed it to:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 20 \* 1000 \* 1000; /\* 20 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
The results were rather surprising. The behavior that Daniel's patch
was fixing came back. The task started using much more than .1% of the
CPU. More like 20%.
Looking into this I found that it was due to the dl\_entity\_overflow()
constantly returning true. That's because it uses the relative period
against relative runtime vs the absolute deadline against absolute
runtime.
runtime / (deadline - t) > dl\_runtime / dl\_period
There's even a comment mentioning this, and saying that when relative
deadline equals relative period, that the equation is the same as using
deadline instead of period. That comment is backwards! What we really
want is:
runtime / (deadline - t) > dl\_runtime / dl\_deadline
We care about if the runtime can make its deadline, not its period. And
then we can say "when the deadline equals the period, the equation is
the same as using dl\_period instead of dl\_deadline".
After correcting this, now when the task gets enqueued, it can throttle
correctly, and Daniel's fix to the throttling of sleeping deadline
tasks works even when the runtime and deadline are not the same.
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Daniel Bristot de Oliveira
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/02135a27f1ae3fe5fd032568a5a2f370e190e8d7.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit f67d6545f01b0307e55baf97bbdc21dec7ea1c33
Author: Don Brace
Date: Fri Mar 10 14:35:17 2017 -0600
scsi: hpsa: limit outstanding rescans
[ Upstream commit 87b9e6aa87d9411f1059aa245c0c79976bc557ac ]
Avoid rescan storms. No need to queue another if one is pending.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 50c09c63594385b7e66feae26235925eb70b5759
Author: Stafford Horne
Date: Mon Mar 13 07:44:45 2017 +0900
openrisc: fix issue handling 8 byte get\_user calls
[ Upstream commit 154e67cd8e8f964809d0e75e44bb121b169c75b3 ]
Was getting the following error with allmodconfig:
ERROR: "\_\_get\_user\_bad" [lib/test\_user\_copy.ko] undefined!
This was simply a missing break statement, causing an unwanted fall
through.
Signed-off-by: Stafford Horne
Signed-off-by: Sasha Levin
commit 825e8f8cd88fef30039f6c97210e0651ae59df4a
Author: Vlad Yasevich
Date: Tue Mar 14 08:58:08 2017 -0400
net: Resend IGMP memberships upon peer notification.
[ Upstream commit 37c343b4f4e70e9dc328ab04903c0ec8d154c1a4 ]
When we notify peers of potential changes, it's also good to update
IGMP memberships. For example, during VM migration, updating IGMP
memberships will redirect existing multicast streams to the VM at the
new location.
Signed-off-by: Vladislav Yasevich
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a7eaeaf53fdd70df40d295e752166faf702d80f4
Author: Matthias Kaehlcke
Date: Mon Mar 13 14:30:29 2017 -0700
dmaengine: Fix array index out of bounds warning in \_\_get\_unmap\_pool()
[ Upstream commit 23f963e91fd81f44f6b316b1c24db563354c6be8 ]
This fixes the following warning when building with clang and
CONFIG\_DMA\_ENGINE\_RAID=n :
drivers/dma/dmaengine.c:1102:11: error: array index 2 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[2];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
^
drivers/dma/dmaengine.c:1104:11: error: array index 3 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[3];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Dan Williams
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 978a56a324ad7e5e52ccbaa5bff2ab76ca4dcb4f
Author: Johan Hovold
Date: Mon Mar 13 13:42:03 2017 +0100
net: wimax/i2400m: fix NULL-deref at probe
[ Upstream commit 6e526fdff7be4f13b24f929a04c0e9ae6761291e ]
Make sure to check the number of endpoints to avoid dereferencing a
NULL-pointer or accessing memory beyond the endpoint array should a
malicious device lack the expected endpoints.
The endpoints are specifically dereferenced in the i2400m\_bootrom\_init
path during probe (e.g. in i2400mu\_tx\_bulk\_out).
Fixes: f398e4240fce ("i2400m/USB: probe/disconnect, dev init/shutdown
and reset backends")
Cc: Inaky Perez-Gonzalez
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6f7feb80d24c956b3f3c731a7dec11b6650dae92
Author: Dmitry Torokhov
Date: Tue Feb 28 17:14:41 2017 -0800
Input: i8042 - add TUXEDO BU1406 (N24\_25BU) to the nomux list
[ Upstream commit a4c2a13129f7c5bcf81704c06851601593303fd5 ]
TUXEDO BU1406 does not implement active multiplexing mode properly,
and takes around 550 ms in i8042\_set\_mux\_mode(). Given that the
device does not have external AUX port, there is no downside in
disabling the MUX mode.
Reported-by: Paul Menzel
Suggested-by: Vojtech Pavlik
Reviewed-by: Marcos Paulo de Souza
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit 7c6d4318dce23369a144d5ebe9669395ac705e15
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_reset\_versions for NFSv4.
[ Upstream commit 800a938f0bf9130c8256116649c0cc5806bfb2fd ]
If you write "-2 -3 -4" to the "versions" file, it will
notice that no versions are enabled, and nfsd\_reset\_versions()
is called.
This enables all major versions, not no minor versions.
So we lose the invariant that NFSv4 is only advertised when
at least one minor is enabled.
Fix the code to explicitly enable minor versions for v4,
change it to use nfsd\_vers() to test and set, and simplify
the code.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
commit a24c04fb2b307be0e0bc4a6e2e12ecacf8e90ed1
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_minorversion(.., NFSD\_AVAIL)
[ Upstream commit 928c6fb3a9bfd6c5b287aa3465226add551c13c0 ]
Current code will return 1 if the version is supported,
and -1 if it isn't.
This is confusing and inconsistent with the one place where this
is used.
So change to return 1 if it is supported, and zero if not.
i.e. an error is never returned.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
commit d3ecf7891a2b3dce47a961481e77b3f41c468290
Author: Doug Berger
Date: Thu Mar 9 16:58:48 2017 -0800
net: bcmgenet: Power up the internal PHY before probing the MII
[ Upstream commit 6be371b053dc86f11465cc1abce2e99bda0a0574 ]
When using the internal PHY it must be powered up when the MII is probed
or the PHY will not be detected. Since the PHY is powered up at reset
this has not been a problem. However, when the kernel is restarted with
kexec the PHY will likely be powered down when the kernel starts so it
will not be detected and the Ethernet link will not be established.
This commit explicitly powers up the internal PHY when the GENET driver
is probed to correct this behavior.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3c84a327df800c2eb5040b9198d865c9fbd333c0
Author: Doug Berger
Date: Thu Mar 9 16:58:45 2017 -0800
net: bcmgenet: reserved phy revisions must be checked first
[ Upstream commit eca4bad73409aedc6ff22f823c18b67a4f08c851 ]
The reserved gphy\_rev value of 0x01ff must be tested before the old
or new scheme for GPHY major versioning are tested, otherwise it will
be treated as 0xff00 according to the old scheme.
Fixes: b04a2f5b9ff5 ("net: bcmgenet: add support for new GENET PHY revision scheme")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0e4db24608573ece6ea98914960c71f33c8288d7
Author: Doug Berger
Date: Thu Mar 9 16:58:44 2017 -0800
net: bcmgenet: correct MIB access of UniMAC RUNT counters
[ Upstream commit 1ad3d225e5a40ca6c586989b4baaca710544c15a ]
The gap between the Tx status counters and the Rx RUNT counters is now
being added to allow correct reporting of the registers.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0594bbed16ac83b0d7626cc14c11eacb5c87b590
Author: Doug Berger
Date: Thu Mar 9 16:58:43 2017 -0800
net: bcmgenet: correct the RBUF\_OVFL\_CNT and RBUF\_ERR\_CNT MIB values
[ Upstream commit ffff71328a3c321f7c14cc1edd33577717037744 ]
The location of the RBUF overflow and error counters has moved between
different version of the GENET MAC. This commit corrects the driver to
read from the correct locations depending on the version of the GENET
MAC.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b8fcc2ddaeffd3ed32437c7a52d9f6ef189450a7
Author: Alexander Potapenko
Date: Wed Mar 8 18:08:16 2017 +0100
net: initialize msg.msg\_flags in recvfrom
[ Upstream commit 9f138fa609c47403374a862a08a41394be53d461 ]
KMSAN reports a use of uninitialized memory in put\_cmsg() because
msg.msg\_flags in recvfrom haven't been initialized properly.
The flag values don't affect the result on this path, but it's still a
good idea to initialize them explicitly.
Signed-off-by: Alexander Potapenko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 23d1aa2220b016890938281138beafe7b9175050
Author: Guoqing Jiang
Date: Fri Feb 24 11:15:12 2017 +0800
md-cluster: free md\_cluster\_info if node leave cluster
[ Upstream commit 9c8043f337f14d1743006dfc59c03e80a42e3884 ]
To avoid memory leak, we need to free the cinfo which
is allocated when node join cluster.
Reviewed-by: NeilBrown
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
commit 2e9bfadeec14b8bc1b2c0486bc24cb868ca81a99
Author: Javier Martinez Canillas
Date: Wed Feb 22 15:23:22 2017 -0300
usb: phy: isp1301: Add OF device ID table
[ Upstream commit fd567653bdb908009b650f079bfd4b63169e2ac4 ]
The driver doesn't have a struct of\_device\_id table but supported devices
are registered via Device Trees. This is working on the assumption that a
I2C device registered via OF will always match a legacy I2C device ID and
that the MODALIAS reported will always be of the form i2c:.
But this could change in the future so the correct approach is to have an
OF device ID table if the devices are registered via OF.
Signed-off-by: Javier Martinez Canillas
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 8445dd361d31cebdb8ecaaf356258bf27ebe4cce
Author: Ilan peer
Date: Mon Dec 26 18:17:36 2016 +0200
mac80211: Fix addition of mesh configuration element
[ Upstream commit 57629915d568c522ac1422df7bba4bee5b5c7a7c ]
The code was setting the capabilities byte to zero,
after it was already properly set previously. Fix it.
The bug was found while debugging hwsim mesh tests failures
that happened since the commit mentioned below.
Fixes: 76f43b4c0a93 ("mac80211: Remove invalid flag operations in mesh TSF synchronization")
Signed-off-by: Ilan Peer
Reviewed-by: Masashi Honma
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 27bc8f4750a7e61fdbeaf654e6194cada59df75b
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
[ Upstream commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f ]
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
commit 47711554c6da1a8904abb2ba43d2f7ee1b1b5a00
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
[ Upstream commit c894aa97577e47d3066b27b32499ecf899bfa8b0 ]
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
commit 6b92b07e2cb0e90327f03928cadfcbb625d33378
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
[ Upstream commit 6f6a23a213be51728502b88741ba6a10cda2441d ]
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Cc: stable@vger.kernel.org
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 412551c467675878bbf55667e478da7cddcd66a4
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
[ Upstream commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 ]
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Cc: stable
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit e1d46b53a6442b23bb4de8ed59c34a75cc6d25d4
Author: Sukumar Ghorai
Date: Wed Aug 16 14:46:55 2017 -0700
Bluetooth: btusb: driver to enable the usb-wakeup feature
[ Upstream commit a0085f2510e8976614ad8f766b209448b385492f ]
BT-Controller connected as platform non-root-hub device and
usb-driver initialize such device with wakeup disabled,
Ref. usb\_new\_device().
At present wakeup-capability get enabled by hid-input device from usb
function driver(e.g. BT HID device) at runtime. Again some functional
driver does not set usb-wakeup capability(e.g LE HID device implement
as HID-over-GATT), and can't wakeup the host on USB.
Most of the device operation (such as mass storage) initiated from host
(except HID) and USB wakeup aligned with host resume procedure. For BT
device, usb-wakeup capability need to enable form btusc driver as a
generic solution for multiple profile use case and required for USB remote
wakeup (in-bus wakeup) while host is suspended. Also usb-wakeup feature
need to enable/disable with HCI interface up and down.
Signed-off-by: Sukumar Ghorai
Signed-off-by: Amit K Bag
Acked-by: Oliver Neukum
Signed-off-by: Marcel Holtmann
Signed-off-by: Sasha Levin
commit 5319d08ca465eec277d04b5a3cee34f80b601c74
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
[ Upstream commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a ]
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Cc: stable
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 5b2323b62af18be000ef627f302b5bf167402de6
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
[ Upstream commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 ]
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
CC:
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 6be358198e6ec261dad9b9b0f735dbb741a4fd72
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
[ Upstream commit 62354454625741f0569c2cbe45b2d192f8fd258e ]
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit d3c33f3be0db46d534332f09217a1c5cf745c3de
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
[ Upstream commit 90e406f96f630c07d631a021fd4af10aac913e77 ]
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Cc: stable@vger.kernel.org
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Sasha Levin
commit 705277dab0bf482aee987e2c92139c590ac72922
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
[ Upstream commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb ]
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit bbda4c57b91619642a94b193531312fe01bc2398
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
[ Upstream commit ecaaab5649781c5a0effdaf298a925063020500e ]
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Cc:  # v2.6.25+
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit bd7f57da8fff9b75204d6dd2b3ac6a30a6430a5c
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
[ Upstream commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 ]
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Cc:
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 4e1911325f19114d781c9e8b14a3565d966bd64a
Author: Vincent Pelletier
Date: Sun Nov 26 06:52:53 2017 +0000
usb: gadget: ffs: Forbid usb\_ep\_alloc\_request from sleeping
[ Upstream commit 30bf90ccdec1da9c8198b161ecbff39ce4e5a9ba ]
Found using DEBUG\_ATOMIC\_SLEEP while submitting an AIO read operation:
[ 100.853642] BUG: sleeping function called from invalid context at mm/slab.h:421
[ 100.861148] in\_atomic(): 1, irqs\_disabled(): 1, pid: 1880, name: python
[ 100.867954] 2 locks held by python/1880:
[ 100.867961] #0: (&epfile->mutex){....}, at: [] ffs\_mutex\_lock+0x27/0x30 [usb\_f\_fs]
[ 100.868020] #1: (&(&ffs->eps\_lock)->rlock){....}, at: [] ffs\_epfile\_io.isra.17+0x24b/0x590 [usb\_f\_fs]
[ 100.868076] CPU: 1 PID: 1880 Comm: python Not tainted 4.14.0-edison+ #118
[ 100.868085] Hardware name: Intel Corporation Merrifield/BODEGA BAY, BIOS 542 2015.01.21:18.19.48
[ 100.868093] Call Trace:
[ 100.868122] dump\_stack+0x47/0x62
[ 100.868156] \_\_\_might\_sleep+0xfd/0x110
[ 100.868182] \_\_might\_sleep+0x68/0x70
[ 100.868217] kmem\_cache\_alloc\_trace+0x4b/0x200
[ 100.868248] ? dwc3\_gadget\_ep\_alloc\_request+0x24/0xe0 [dwc3]
[ 100.868302] dwc3\_gadget\_ep\_alloc\_request+0x24/0xe0 [dwc3]
[ 100.868343] usb\_ep\_alloc\_request+0x16/0xc0 [udc\_core]
[ 100.868386] ffs\_epfile\_io.isra.17+0x444/0x590 [usb\_f\_fs]
[ 100.868424] ? \_raw\_spin\_unlock\_irqrestore+0x27/0x40
[ 100.868457] ? kiocb\_set\_cancel\_fn+0x57/0x60
[ 100.868477] ? ffs\_ep0\_poll+0xc0/0xc0 [usb\_f\_fs]
[ 100.868512] ffs\_epfile\_read\_iter+0xfe/0x157 [usb\_f\_fs]
[ 100.868551] ? security\_file\_permission+0x9c/0xd0
[ 100.868587] ? rw\_verify\_area+0xac/0x120
[ 100.868633] aio\_read+0x9d/0x100
[ 100.868692] ? \_\_fget+0xa2/0xd0
[ 100.868727] ? \_\_might\_sleep+0x68/0x70
[ 100.868763] SyS\_io\_submit+0x471/0x680
[ 100.868878] do\_int80\_syscall\_32+0x4e/0xd0
[ 100.868921] entry\_INT80\_32+0x2a/0x2a
[ 100.868932] EIP: 0xb7fbb676
[ 100.868941] EFLAGS: 00000292 CPU: 1
[ 100.868951] EAX: ffffffda EBX: b7aa2000 ECX: 00000002 EDX: b7af8368
[ 100.868961] ESI: b7fbb660 EDI: b7aab000 EBP: bfb6c658 ESP: bfb6c638
[ 100.868973] DS: 007b ES: 007b FS: 0000 GS: 0033 SS: 007b
Signed-off-by: Vincent Pelletier
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 72b01bee76591d3741a87a689bf210d729d530f8
Author: Eric Dumazet
Date: Tue Nov 28 08:03:30 2017 -0800
net/packet: fix a race in packet\_bind() and packet\_notifier()
[ Upstream commit 15fe076edea787807a7cdc168df832544b58eba6 ]
syzbot reported crashes [1] and provided a C repro easing bug hunting.
When/if packet\_do\_bind() calls \_\_unregister\_prot\_hook() and releases
po->bind\_lock, another thread can run packet\_notifier() and process an
NETDEV\_UP event.
This calls register\_prot\_hook() and hooks again the socket right before
first thread is able to grab again po->bind\_lock.
Fixes this issue by temporarily setting po->num to 0, as suggested by
David Miller.
[1]
dev\_remove\_pack: ffff8801bf16fa80 not found
------------[ cut here ]------------
kernel BUG at net/core/dev.c:7945! ( BUG\_ON(!list\_empty(&dev->ptype\_all)); )
invalid opcode: 0000 [#1] SMP KASAN
Dumping ftrace buffer:
(ftrace buffer empty)
Modules linked in:
device syz0 entered promiscuous mode
CPU: 0 PID: 3161 Comm: syzkaller404108 Not tainted 4.14.0+ #190
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
task: ffff8801cc57a500 task.stack: ffff8801cc588000
RIP: 0010:netdev\_run\_todo+0x772/0xae0 net/core/dev.c:7945
RSP: 0018:ffff8801cc58f598 EFLAGS: 00010293
RAX: ffff8801cc57a500 RBX: dffffc0000000000 RCX: ffffffff841f75b2
RDX: 0000000000000000 RSI: 1ffff100398b1ede RDI: ffff8801bf1f8810
device syz0 entered promiscuous mode
RBP: ffff8801cc58f898 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: ffff8801bf1f8cd8
R13: ffff8801cc58f870 R14: ffff8801bf1f8780 R15: ffff8801cc58f7f0
FS: 0000000001716880(0000) GS:ffff8801db400000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020b13000 CR3: 0000000005e25000 CR4: 00000000001406f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
rtnl\_unlock+0xe/0x10 net/core/rtnetlink.c:106
tun\_detach drivers/net/tun.c:670 [inline]
tun\_chr\_close+0x49/0x60 drivers/net/tun.c:2845
\_\_fput+0x333/0x7f0 fs/file\_table.c:210
\_\_\_\_fput+0x15/0x20 fs/file\_table.c:244
task\_work\_run+0x199/0x270 kernel/task\_work.c:113
exit\_task\_work include/linux/task\_work.h:22 [inline]
do\_exit+0x9bb/0x1ae0 kernel/exit.c:865
do\_group\_exit+0x149/0x400 kernel/exit.c:968
SYSC\_exit\_group kernel/exit.c:979 [inline]
SyS\_exit\_group+0x1d/0x20 kernel/exit.c:977
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
RIP: 0033:0x44ad19
Fixes: 30f7ea1c2b5f ("packet: race condition in packet\_bind")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Francesco Ruggeri
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4ccd91f02562785d51cbbd4546099ab9fdd7271b
Author: Hangbin Liu
Date: Thu Nov 30 10:41:14 2017 +0800
sit: update frag\_off info
[ Upstream commit f859b4af1c52493ec21173ccc73d0b60029b5b88 ]
After parsing the sit netlink change info, we forget to update frag\_off in
ipip6\_tunnel\_update(). Fix it by assigning frag\_off with new value.
Reported-by: Jianlin Shi
Signed-off-by: Hangbin Liu
Acked-by: Nicolas Dichtel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit dcd241dca9507cf4b3980505e2482ed6aba347b5
Author: Håkon Bugge
Date: Wed Dec 6 17:18:28 2017 +0100
rds: Fix NULL pointer dereference in \_\_rds\_rdma\_map
[ Upstream commit f3069c6d33f6ae63a1668737bc78aaaa51bff7ca ]
This is a fix for syzkaller719569, where memory registration was
attempted without any underlying transport being loaded.
Analysis of the case reveals that it is the setsockopt() RDS\_GET\_MR
(2) and RDS\_GET\_MR\_FOR\_DEST (7) that are vulnerable.
Here is an example stack trace when the bug is hit:
BUG: unable to handle kernel NULL pointer dereference at 00000000000000c0
IP: \_\_rds\_rdma\_map+0x36/0x440 [rds]
PGD 2f93d03067 P4D 2f93d03067 PUD 2f93d02067 PMD 0
Oops: 0000 [#1] SMP
Modules linked in: bridge stp llc tun rpcsec\_gss\_krb5 nfsv4
dns\_resolver nfs fscache rds binfmt\_misc sb\_edac intel\_powerclamp
coretemp kvm\_intel kvm irqbypass crct10dif\_pclmul c rc32\_pclmul
ghash\_clmulni\_intel pcbc aesni\_intel crypto\_simd glue\_helper cryptd
iTCO\_wdt mei\_me sg iTCO\_vendor\_support ipmi\_si mei ipmi\_devintf nfsd
shpchp pcspkr i2c\_i801 ioatd ma ipmi\_msghandler wmi lpc\_ich mfd\_core
auth\_rpcgss nfs\_acl lockd grace sunrpc ip\_tables ext4 mbcache jbd2
mgag200 i2c\_algo\_bit drm\_kms\_helper ixgbe syscopyarea ahci sysfillrect
sysimgblt libahci mdio fb\_sys\_fops ttm ptp libata sd\_mod mlx4\_core drm
crc32c\_intel pps\_core megaraid\_sas i2c\_core dca dm\_mirror
dm\_region\_hash dm\_log dm\_mod
CPU: 48 PID: 45787 Comm: repro\_set2 Not tainted 4.14.2-3.el7uek.x86\_64 #2
Hardware name: Oracle Corporation ORACLE SERVER X5-2L/ASM,MOBO TRAY,2U, BIOS 31110000 03/03/2017
task: ffff882f9190db00 task.stack: ffffc9002b994000
RIP: 0010:\_\_rds\_rdma\_map+0x36/0x440 [rds]
RSP: 0018:ffffc9002b997df0 EFLAGS: 00010202
RAX: 0000000000000000 RBX: ffff882fa2182580 RCX: 0000000000000000
RDX: 0000000000000000 RSI: ffffc9002b997e40 RDI: ffff882fa2182580
RBP: ffffc9002b997e30 R08: 0000000000000000 R09: 0000000000000002
R10: ffff885fb29e3838 R11: 0000000000000000 R12: ffff882fa2182580
R13: ffff882fa2182580 R14: 0000000000000002 R15: 0000000020000ffc
FS: 00007fbffa20b700(0000) GS:ffff882fbfb80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000000000c0 CR3: 0000002f98a66006 CR4: 00000000001606e0
Call Trace:
rds\_get\_mr+0x56/0x80 [rds]
rds\_setsockopt+0x172/0x340 [rds]
? \_\_fget\_light+0x25/0x60
? \_\_fdget+0x13/0x20
SyS\_setsockopt+0x80/0xe0
do\_syscall\_64+0x67/0x1b0
entry\_SYSCALL64\_slow\_path+0x25/0x25
RIP: 0033:0x7fbff9b117f9
RSP: 002b:00007fbffa20aed8 EFLAGS: 00000293 ORIG\_RAX: 0000000000000036
RAX: ffffffffffffffda RBX: 00000000000c84a4 RCX: 00007fbff9b117f9
RDX: 0000000000000002 RSI: 0000400000000114 RDI: 000000000000109b
RBP: 00007fbffa20af10 R08: 0000000000000020 R09: 00007fbff9dd7860
R10: 0000000020000ffc R11: 0000000000000293 R12: 0000000000000000
R13: 00007fbffa20b9c0 R14: 00007fbffa20b700 R15: 0000000000000021
Code: 41 56 41 55 49 89 fd 41 54 53 48 83 ec 18 8b 87 f0 02 00 00 48
89 55 d0 48 89 4d c8 85 c0 0f 84 2d 03 00 00 48 8b 87 00 03 00 00 <48>
83 b8 c0 00 00 00 00 0f 84 25 03 00 0 0 48 8b 06 48 8b 56 08
The fix is to check the existence of an underlying transport in
\_\_rds\_rdma\_map().
Signed-off-by: Håkon Bugge
Reported-by: syzbot
Acked-by: Santosh Shilimkar
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0740244eaa5a8fd33f61c23d8ecc04907defa25e
Author: Paul Moore
Date: Fri Sep 1 09:44:34 2017 -0400
audit: ensure that 'audit=1' actually enables audit for PID 1
[ Upstream commit 173743dd99a49c956b124a74c8aacb0384739a4c ]
Prior to this patch we enabled audit in audit\_init(), which is too
late for PID 1 as the standard initcalls are run after the PID 1 task
is forked. This means that we never allocate an audit\_context (see
audit\_alloc()) for PID 1 and therefore miss a lot of audit events
generated by PID 1.
This patch enables audit as early as possible to help ensure that when
PID 1 is forked it can allocate an audit\_context if required.
Reviewed-by: Richard Guy Briggs
Signed-off-by: Paul Moore
Signed-off-by: Sasha Levin
commit 1a7dc738e4e0bcdb386090e94f168b9db6274a4d
Author: David Howells
Date: Thu Nov 2 15:27:48 2017 +0000
afs: Connect up the CB.ProbeUuid
[ Upstream commit f4b3526d83c40dd8bf5948b9d7a1b2c340f0dcc8 ]
The handler for the CB.ProbeUuid operation in the cache manager is
implemented, but isn't listed in the switch-statement of operation
selection, so won't be used. Fix this by adding it.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
commit 97370566e9bc8acba3aea9406c2d1bd51484337d
Author: Majd Dibbiny
Date: Mon Oct 30 14:23:13 2017 +0200
IB/mlx5: Assign send CQ and recv CQ of UMR QP
[ Upstream commit 31fde034a8bd964a5c7c1a5663fc87a913158db2 ]
The UMR's QP is created by calling mlx5\_ib\_create\_qp directly, and
therefore the send CQ and the recv CQ on the ibqp weren't assigned.
Assign them right after calling the mlx5\_ib\_create\_qp to assure
that any access to those pointers will work as expected and won't
crash the system as might happen as part of reset flow.
Fixes: e126ba97dba9 ("mlx5: Add driver for Mellanox Connect-IB adapters")
Signed-off-by: Majd Dibbiny
Reviewed-by: Yishai Hadas
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit f2c5c3e03a7e355cfcb1a0faf1421a683e584261
Author: Mark Bloch
Date: Thu Nov 2 15:22:26 2017 +0200
IB/mlx4: Increase maximal message size under UD QP
[ Upstream commit 5f22a1d87c5315a98981ecf93cd8de226cffe6ca ]
Maximal message should be used as a limit to the max message payload allowed,
without the headers. The ConnectX-3 check is done against this value includes
the headers. When the payload is 4K this will cause the NIC to drop packets.
Increase maximal message to 8K as workaround, this shouldn't change current
behaviour because we continue to set the MTU to 4k.
To reproduce;
set MTU to 4296 on the corresponding interface, for example:
ifconfig eth0 mtu 4296 (both server and client)
On server:
ib\_send\_bw -c UD -d mlx4\_0 -s 4096 -n 1000000 -i1 -m 4096
On client:
ib\_send\_bw -d mlx4\_0 -c UD  -s 4096 -n 1000000 -i 1 -m 4096
Fixes: 6e0d733d9215 ("IB/mlx4: Allow 4K messages for UD QPs")
Signed-off-by: Mark Bloch
Reviewed-by: Majd Dibbiny
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit b486022b7bb8ccce0e44d43e77f15ed5f9f6cb68
Author: Herbert Xu
Date: Fri Nov 10 14:14:06 2017 +1100
xfrm: Copy policy family in clone\_policy
[ Upstream commit 0e74aa1d79a5bbc663e03a2804399cae418a0321 ]
The syzbot found an ancient bug in the IPsec code. When we cloned
a socket policy (for example, for a child TCP socket derived from a
listening socket), we did not copy the family field. This results
in a live policy with a zero family field. This triggers a BUG\_ON
check in the af\_key code when the cloned policy is retrieved.
This patch fixes it by copying the family field over.
Reported-by: syzbot
Signed-off-by: Herbert Xu
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 0770152f94381de6750af9bc809f8a5f81e4909a
Author: Arvind Yadav
Date: Tue Nov 14 13:42:38 2017 +0530
atm: horizon: Fix irq release error
[ Upstream commit bde533f2ea607cbbbe76ef8738b36243939a7bc2 ]
atm\_dev\_register() can fail here and passed parameters to free irq
which is not initialised. Initialization of 'dev->irq' happened after
the 'goto out\_free\_irq'. So using 'irq' insted of 'dev->irq' in
free\_irq().
Signed-off-by: Arvind Yadav
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9cdc7a37fae11c28727a7455c6469c44bfd585a6
Author: Xin Long
Date: Wed Nov 15 16:57:26 2017 +0800
sctp: use the right sk after waking up from wait\_buf sleep
[ Upstream commit cea0cc80a6777beb6eb643d4ad53690e1ad1d4ff ]
Commit dfcb9f4f99f1 ("sctp: deny peeloff operation on asocs with threads
sleeping on it") fixed the race between peeloff and wait sndbuf by
checking waitqueue\_active(&asoc->wait) in sctp\_do\_peeloff().
But it actually doesn't work, as even if waitqueue\_active returns false
the waiting sndbuf thread may still not yet hold sk lock. After asoc is
peeled off, sk is not asoc->base.sk any more, then to hold the old sk
lock couldn't make assoc safe to access.
This patch is to fix this by changing to hold the new sk lock if sk is
not asoc->base.sk, meanwhile, also set the sk in sctp\_sendmsg with the
new sk.
With this fix, there is no more race between peeloff and waitbuf, the
check 'waitqueue\_active' in sctp\_do\_peeloff can be removed.
Thanks Marcelo and Neil for making this clear.
v1->v2:
fix it by changing to lock the new sock instead of adding a flag in asoc.
Suggested-by: Neil Horman
Signed-off-by: Xin Long
Acked-by: Neil Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1b62d491c31fbd831ee3485157a3903f9445464b
Author: Xin Long
Date: Wed Nov 15 16:55:54 2017 +0800
sctp: do not free asoc when it is already dead in sctp\_sendmsg
[ Upstream commit ca3af4dd28cff4e7216e213ba3b671fbf9f84758 ]
Now in sctp\_sendmsg sctp\_wait\_for\_sndbuf could schedule out without
holding sock sk. It means the current asoc can be freed elsewhere,
like when receiving an abort packet.
If the asoc is just created in sctp\_sendmsg and sctp\_wait\_for\_sndbuf
returns err, the asoc will be freed again due to new\_asoc is not nil.
An use-after-free issue would be triggered by this.
This patch is to fix it by setting new\_asoc with nil if the asoc is
already dead when cpu schedules back, so that it will not be freed
again in sctp\_sendmsg.
v1->v2:
set new\_asoc as nil in sctp\_sendmsg instead of sctp\_wait\_for\_sndbuf.
Suggested-by: Neil Horman
Reported-by: Dmitry Vyukov
Signed-off-by: Xin Long
Acked-by: Neil Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6b015b715200452c0967eae5f1cdcf05e92611d4
Author: Pavel Tatashin
Date: Wed Nov 15 17:36:18 2017 -0800
sparc64/mm: set fields in deferred pages
[ Upstream commit 2a20aa171071a334d80c4e5d5af719d8374702fc ]
Without deferred struct page feature (CONFIG\_DEFERRED\_STRUCT\_PAGE\_INIT),
flags and other fields in "struct page"es are never changed prior to
first initializing struct pages by going through \_\_init\_single\_page().
With deferred struct page feature enabled there is a case where we set
some fields prior to initializing:
mem\_init() {
register\_page\_bootmem\_info();
free\_all\_bootmem();
...
}
When register\_page\_bootmem\_info() is called only non-deferred struct
pages are initialized. But, this function goes through some reserved
pages which might be part of the deferred, and thus are not yet
initialized.
mem\_init
register\_page\_bootmem\_info
register\_page\_bootmem\_info\_node
get\_page\_bootmem
.. setting fields here ..
such as: page->freelist = (void \*)type;
free\_all\_bootmem()
free\_low\_memory\_core\_early()
for\_each\_reserved\_mem\_region()
reserve\_bootmem\_region()
init\_reserved\_page() <- Only if this is deferred reserved page
\_\_init\_single\_pfn()
\_\_init\_single\_page()
memset(0) <-- Loose the set fields here
We end up with similar issue as in the previous patch, where currently
we do not observe problem as memory is zeroed. But, if flag asserts are
changed we can start hitting issues.
Also, because in this patch series we will stop zeroing struct page
memory during allocation, we must make sure that struct pages are
properly initialized prior to using them.
The deferred-reserved pages are initialized in free\_all\_bootmem().
Therefore, the fix is to switch the above calls.
Link: http://lkml.kernel.org/r/20171013173214.27300-4-pasha.tatashin@oracle.com
Signed-off-by: Pavel Tatashin
Reviewed-by: Steven Sistare
Reviewed-by: Daniel Jordan
Reviewed-by: Bob Picco
Acked-by: David S. Miller
Acked-by: Michal Hocko
Cc: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Ard Biesheuvel
Cc: Catalin Marinas
Cc: Christian Borntraeger
Cc: Dmitry Vyukov
Cc: Heiko Carstens
Cc: "H. Peter Anvin"
Cc: Ingo Molnar
Cc: Mark Rutland
Cc: Matthew Wilcox
Cc: Mel Gorman
Cc: Michal Hocko
Cc: Sam Ravnborg
Cc: Thomas Gleixner
Cc: Will Deacon
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit c9fb7628f9c8a12c698558fbf7b62ee17650f780
Author: Chuck Lever
Date: Fri Nov 3 13:46:06 2017 -0400
sunrpc: Fix rpc\_task\_begin trace point
[ Upstream commit b2bfe5915d5fe7577221031a39ac722a0a2a1199 ]
The rpc\_task\_begin trace point always display a task ID of zero.
Move the trace point call site so that it picks up the new task ID.
Signed-off-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 3c2c40b46e8586b37f4b76e1ba570d40108b2ee0
Author: Trond Myklebust
Date: Mon Nov 6 15:28:04 2017 -0500
NFS: Fix a typo in nfs\_rename()
[ Upstream commit d803224c84be067754db7fa58a93f36f61566493 ]
On successful rename, the "old\_dentry" is retained and is attached to
the "new\_dir", so we need to call nfs\_set\_verifier() accordingly.
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit bf48b8e1f2f6ac7937a058c3cc5b8b666dcdf7cf
Author: Randy Dunlap
Date: Fri Nov 17 15:27:35 2017 -0800
dynamic-debug-howto: fix optional/omitted ending line number to be LARGE instead of 0
[ Upstream commit 1f3c790bd5989fcfec9e53ad8fa09f5b740c958f ]
line-range is supposed to treat "1-" as "1-endoffile", so
handle the special case by setting last\_lineno to UINT\_MAX.
Fixes this error:
dynamic\_debug:ddebug\_parse\_query: last-line:0 < 1st-line:1
dynamic\_debug:ddebug\_exec\_query: query parse failed
Link: http://lkml.kernel.org/r/10a6a101-e2be-209f-1f41-54637824788e@infradead.org
Signed-off-by: Randy Dunlap
Acked-by: Jason Baron
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 3888f4ba09bdb5177b011ff7fbd431e8545395f8
Author: Stephen Bates
Date: Fri Nov 17 15:28:16 2017 -0800
lib/genalloc.c: make the avail variable an atomic\_long\_t
[ Upstream commit 36a3d1dd4e16bcd0d2ddfb4a2ec7092f0ae0d931 ]
If the amount of resources allocated to a gen\_pool exceeds 2^32 then the
avail atomic overflows and this causes problems when clients try and
borrow resources from the pool. This is only expected to be an issue on
64 bit systems.
Add the  header to pull in atomic\_long\* operations. So
that 32 bit systems continue to use atomic32\_t but 64 bit systems can
use atomic64\_t.
Link: http://lkml.kernel.org/r/1509033843-25667-1-git-send-email-sbates@raithlin.com
Signed-off-by: Stephen Bates
Reviewed-by: Logan Gunthorpe
Reviewed-by: Mathieu Desnoyers
Reviewed-by: Daniel Mentz
Cc: Jonathan Corbet
Cc: Andrew Morton
Cc: Will Deacon
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 3e3780098e9ffac153347f6bf6dabf0f3d20b135
Author: Xin Long
Date: Fri Nov 17 14:27:06 2017 +0800
route: update fnhe\_expires for redirect when the fnhe exists
[ Upstream commit e39d5246111399dbc6e11cd39fd8580191b86c47 ]
Now when creating fnhe for redirect, it sets fnhe\_expires for this
new route cache. But when updating the exist one, it doesn't do it.
It will cause this fnhe never to be expired.
Paolo already noticed it before, in Jianlin's test case, it became
even worse:
When ip route flush cache, the old fnhe is not to be removed, but
only clean it's members. When redirect comes again, this fnhe will
be found and updated, but never be expired due to fnhe\_expires not
being set.
So fix it by simply updating fnhe\_expires even it's for redirect.
Fixes: aee06da6726d ("ipv4: use seqlock for nh\_exceptions")
Reported-by: Jianlin Shi
Acked-by: Hannes Frederic Sowa
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2f52207aba567a9e02e739e72c904ffd5edb042f
Author: Xin Long
Date: Fri Nov 17 14:27:18 2017 +0800
route: also update fnhe\_genid when updating a route cache
[ Upstream commit cebe84c6190d741045a322f5343f717139993c08 ]
Now when ip route flush cache and it turn out all fnhe\_genid != genid.
If a redirect/pmtu icmp packet comes and the old fnhe is found and all
it's members but fnhe\_genid will be updated.
Then next time when it looks up route and tries to rebind this fnhe to
the new dst, the fnhe will be flushed due to fnhe\_genid != genid. It
causes this redirect/pmtu icmp packet acutally not to be applied.
This patch is to also reset fnhe\_genid when updating a route cache.
Fixes: 5aad1de5ea2c ("ipv4: use separate genid for next hop exceptions")
Acked-by: Hannes Frederic Sowa
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bdc95e2f8a07c9f6c27a123de732bb15293ff7d0
Author: Ben Hutchings
Date: Fri Nov 10 18:48:50 2017 +0000
mac80211\_hwsim: Fix memory leak in hwsim\_new\_radio\_nl()
[ Upstream commit 67bd52386125ce1159c0581cbcd2740addf33cd4 ]
hwsim\_new\_radio\_nl() now copies the name attribute in order to add a
null-terminator. mac80211\_hwsim\_new\_radio() (indirectly) copies it
again into the net\_device structure, so the first copy is not used or
freed later. Free the first copy before returning.
Fixes: ff4dd73dd2b4 ("mac80211\_hwsim: check HWSIM\_ATTR\_RADIO\_NAME length")
Signed-off-by: Ben Hutchings
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit e5a85e30e2926626290921aa7c624ed6befdcefc
Author: Jérémy Lefaure
Date: Wed Jun 28 20:57:29 2017 -0400
EDAC, i5000, i5400: Fix definition of NRECMEMB register
[ Upstream commit a8c8261425649da58bdf08221570e5335ad33a31 ]
In the i5000 and i5400 drivers, the NRECMEMB register is defined as a
16-bit value, which results in wrong shifts in the code, as reported by
sparse.
In the datasheets ([1], section 3.9.22.20 and [2], section 3.9.22.21),
this register is a 32-bit register. A u32 value for the register fixes
the wrong shifts warnings and matches the datasheet.
Also fix the mask to access to the CAS bits [27:16] in the i5000 driver.
[1]: https://www.intel.com/content/dam/doc/datasheet/5000p-5000v-5000z-chipset-memory-controller-hub-datasheet.pdf
[2]: https://www.intel.se/content/dam/doc/datasheet/5400-chipset-memory-controller-hub-datasheet.pdf
Signed-off-by: Jérémy Lefaure
Cc: linux-edac
Link: http://lkml.kernel.org/r/20170629005729.8478-1-jeremy.lefaure@lse.epita.fr
Signed-off-by: Borislav Petkov
Signed-off-by: Sasha Levin
commit a838aec6b78acf4f5a9d61463bfe288d5dfe28c6
Author: Jérémy Lefaure
Date: Wed Mar 8 20:18:09 2017 -0500
EDAC, i5000, i5400: Fix use of MTR\_DRAM\_WIDTH macro
[ Upstream commit e61555c29c28a4a3b6ba6207f4a0883ee236004d ]
The MTR\_DRAM\_WIDTH macro returns the data width. It is sometimes used
as if it returned a boolean true if the width if 8. Fix the tests where
MTR\_DRAM\_WIDTH is misused.
Signed-off-by: Jérémy Lefaure
Cc: linux-edac
Link: http://lkml.kernel.org/r/20170309011809.8340-1-jeremy.lefaure@lse.epita.fr
Signed-off-by: Borislav Petkov
Signed-off-by: Sasha Levin
commit ce0872ea1a1302c7c4d2f73d19a83b5b1c8d5adb
Author: Jan Kara
Date: Wed Mar 8 14:56:05 2017 +0100
axonram: Fix gendisk handling
[ Upstream commit 672a2c87c83649fb0167202342ce85af9a3b4f1c ]
It is invalid to call del\_gendisk() when disk->queue is NULL. Fix error
handling in axon\_ram\_probe() to avoid doing that.
Also del\_gendisk() does not drop a reference to gendisk allocated by
alloc\_disk(). That has to be done by put\_disk(). Add that call where
needed.
Reported-by: Dan Carpenter
Signed-off-by: Jan Kara
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 682a37f2ac67b0dbb31c22c697cc0d13338a6e9e
Author: Chris Brandt
Date: Mon Mar 6 15:20:51 2017 -0500
i2c: riic: fix restart condition
[ Upstream commit 2501c1bb054290679baad0ff7f4f07c714251f4c ]
While modifying the driver to use the STOP interrupt, the completion of the
intermediate transfers need to wake the driver back up in order to initiate
the next transfer (restart condition). Otherwise you get never ending
interrupts and only the first transfer sent.
Fixes: 71ccea095ea1 ("i2c: riic: correctly finish transfers")
Reported-by: Simon Horman
Signed-off-by: Chris Brandt
Tested-by: Simon Horman
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 2a89161286f919d61c52110850e9c9e199010321
Author: Krzysztof Kozlowski
Date: Sun Mar 5 19:14:07 2017 +0200
crypto: s5p-sss - Fix completing crypto request in IRQ handler
[ Upstream commit 07de4bc88ce6a4d898cad9aa4c99c1df7e87702d ]
In a regular interrupt handler driver was finishing the crypt/decrypt
request by calling complete on crypto request. This is disallowed since
converting to skcipher in commit b286d8b1a690 ("crypto: skcipher - Add
skcipher walk interface") and causes a warning:
WARNING: CPU: 0 PID: 0 at crypto/skcipher.c:430 skcipher\_walk\_first+0x13c/0x14c
The interrupt is marked shared but in fact there are no other users
sharing it. Thus the simplest solution seems to be to just use a
threaded interrupt handler, after converting it to oneshot.
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 2c9349827832c48ad6aa02add4e0cb41b6522b79
Author: WANG Cong
Date: Sun Mar 5 12:34:53 2017 -0800
ipv6: reorder icmpv6\_init() and ip6\_mr\_init()
[ Upstream commit 15e668070a64bb97f102ad9cf3bccbca0545cda8 ]
Andrey reported the following kernel crash:
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] SMP KASAN
Dumping ftrace buffer:
(ftrace buffer empty)
Modules linked in:
CPU: 0 PID: 14446 Comm: syz-executor6 Not tainted 4.10.0+ #82
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
task: ffff88001f311700 task.stack: ffff88001f6e8000
RIP: 0010:ip6mr\_sk\_done+0x15a/0x3d0 net/ipv6/ip6mr.c:1618
RSP: 0018:ffff88001f6ef418 EFLAGS: 00010202
RAX: dffffc0000000000 RBX: 1ffff10003edde8c RCX: ffffc900043ee000
RDX: 0000000000000004 RSI: ffffffff83e3b3f8 RDI: 0000000000000020
RBP: ffff88001f6ef508 R08: fffffbfff0dcc5d8 R09: 0000000000000000
R10: ffffffff86e62ec0 R11: 0000000000000000 R12: 0000000000000000
R13: 0000000000000000 R14: ffff88001f6ef4e0 R15: ffff8800380a0040
FS: 00007f7a52cec700(0000) GS:ffff88003ec00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000061c500 CR3: 000000001f1ae000 CR4: 00000000000006f0
DR0: 0000000020000000 DR1: 0000000020000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000600
Call Trace:
rawv6\_close+0x4c/0x80 net/ipv6/raw.c:1217
inet\_release+0xed/0x1c0 net/ipv4/af\_inet.c:425
inet6\_release+0x50/0x70 net/ipv6/af\_inet6.c:432
sock\_release+0x8d/0x1e0 net/socket.c:597
\_\_sock\_create+0x39d/0x880 net/socket.c:1226
sock\_create\_kern+0x3f/0x50 net/socket.c:1243
inet\_ctl\_sock\_create+0xbb/0x280 net/ipv4/af\_inet.c:1526
icmpv6\_sk\_init+0x163/0x500 net/ipv6/icmp.c:954
ops\_init+0x10a/0x550 net/core/net\_namespace.c:115
setup\_net+0x261/0x660 net/core/net\_namespace.c:291
copy\_net\_ns+0x27e/0x540 net/core/net\_namespace.c:396
9pnet\_virtio: no channels available for device ./file1
create\_new\_namespaces+0x437/0x9b0 kernel/nsproxy.c:106
unshare\_nsproxy\_namespaces+0xae/0x1e0 kernel/nsproxy.c:205
SYSC\_unshare kernel/fork.c:2281 [inline]
SyS\_unshare+0x64e/0x1000 kernel/fork.c:2231
entry\_SYSCALL\_64\_fastpath+0x1f/0xc2
This is because net->ipv6.mr6\_tables is not initialized at that point,
ip6mr\_rules\_init() is not called yet, therefore on the error path when
we iterator the list, we trigger this oops. Fix this by reordering
ip6mr\_rules\_init() before icmpv6\_sk\_init().
Reported-by: Andrey Konovalov
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bec0486f2e3bb92e9372ec3bda987de095255541
Author: Michal Schmidt
Date: Fri Mar 3 17:08:30 2017 +0100
bnx2x: fix possible overrun of VFPF multicast addresses array
[ Upstream commit 22118d861cec5da6ed525aaf12a3de9bfeffc58f ]
It is too late to check for the limit of the number of VF multicast
addresses after they have already been copied to the req->multicast[]
array, possibly overflowing it.
Do the check before copying.
Also fix the error path to not skip unlocking vf2pf\_mutex.
Signed-off-by: Michal Schmidt
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a713e366738922fadfa782fa8eb31b1d4f6cb6f4
Author: Michal Schmidt
Date: Fri Mar 3 17:08:28 2017 +0100
bnx2x: prevent crash when accessing PTP with interface down
[ Upstream commit 466e8bf10ac104d96e1ea813e8126e11cb72ea20 ]
It is possible to crash the kernel by accessing a PTP device while its
associated bnx2x interface is down. Before the interface is brought up,
the timecounter is not initialized, so accessing it results in NULL
dereference.
Fix it by checking if the interface is up.
Use -ENETDOWN as the error code when the interface is down.
-EFAULT in bnx2x\_ptp\_adjfreq() did not seem right.
Tested using phc\_ctl get/set/adj/freq commands.
Signed-off-by: Michal Schmidt
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8fdb631e3e3406433af007116d84f19ad1e6f096
Author: Blomme, Maarten
Date: Thu Mar 2 13:08:36 2017 +0100
spi\_ks8995: fix "BUG: key accdaa28 not in .data!"
[ Upstream commit 4342696df764ec65dcdfbd0c10d90ea52505f8ba ]
Signed-off-by: Maarten Blomme
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f1c73d4ed0778d765e808144d987b12f31bd29b2
Author: Mark Rutland
Date: Mon Feb 20 12:30:11 2017 +0000
arm: KVM: Survive unknown traps from guests
[ Upstream commit f050fe7a9164945dd1c28be05bf00e8cfb082ccf ]
Currently we BUG() if we see a HSR.EC value we don't recognise. As
configurable disables/enables are added to the architecture (controlled
by RES1/RES0 bits respectively), with associated synchronous exceptions,
it may be possible for a guest to trigger exceptions with classes that
we don't recognise.
While we can't service these exceptions in a manner useful to the guest,
we can avoid bringing down the host. Per ARM DDI 0406C.c, all currently
unallocated HSR EC encodings are reserved, and per ARM DDI
0487A.k\_iss10775, page G6-4395, EC values within the range 0x00 - 0x2c
are reserved for future use with synchronous exceptions, and EC values
within the range 0x2d - 0x3f may be used for either synchronous or
asynchronous exceptions.
The patch makes KVM handle any unknown EC by injecting an UNDEFINED
exception into the guest, with a corresponding (ratelimited) warning in
the host dmesg. We could later improve on this with with a new (opt-in)
exit to the host userspace.
Cc: Dave Martin
Cc: Suzuki K Poulose
Reviewed-by: Christoffer Dall
Signed-off-by: Mark Rutland
Signed-off-by: Marc Zyngier
Signed-off-by: Sasha Levin
commit 38ae8173704dbdae198173b7f3107aec375ab4c1
Author: Wanpeng Li
Date: Mon Mar 6 04:03:28 2017 -0800
KVM: nVMX: reset nested\_run\_pending if the vCPU is going to be reset
[ Upstream commit 2f707d97982286b307ef2a9b034e19aabc1abb56 ]
Reported by syzkaller:
WARNING: CPU: 1 PID: 27742 at arch/x86/kvm/vmx.c:11029
nested\_vmx\_vmexit+0x5c35/0x74d0 arch/x86/kvm/vmx.c:11029
CPU: 1 PID: 27742 Comm: a.out Not tainted 4.10.0+ #229
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:15 [inline]
dump\_stack+0x2ee/0x3ef lib/dump\_stack.c:51
panic+0x1fb/0x412 kernel/panic.c:179
\_\_warn+0x1c4/0x1e0 kernel/panic.c:540
warn\_slowpath\_null+0x2c/0x40 kernel/panic.c:583
nested\_vmx\_vmexit+0x5c35/0x74d0 arch/x86/kvm/vmx.c:11029
vmx\_leave\_nested arch/x86/kvm/vmx.c:11136 [inline]
vmx\_set\_msr+0x1565/0x1910 arch/x86/kvm/vmx.c:3324
kvm\_set\_msr+0xd4/0x170 arch/x86/kvm/x86.c:1099
do\_set\_msr+0x11e/0x190 arch/x86/kvm/x86.c:1128
\_\_msr\_io arch/x86/kvm/x86.c:2577 [inline]
msr\_io+0x24b/0x450 arch/x86/kvm/x86.c:2614
kvm\_arch\_vcpu\_ioctl+0x35b/0x46a0 arch/x86/kvm/x86.c:3497
kvm\_vcpu\_ioctl+0x232/0x1120 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:2721
vfs\_ioctl fs/ioctl.c:43 [inline]
do\_vfs\_ioctl+0x1bf/0x1790 fs/ioctl.c:683
SYSC\_ioctl fs/ioctl.c:698 [inline]
SyS\_ioctl+0x8f/0xc0 fs/ioctl.c:689
entry\_SYSCALL\_64\_fastpath+0x1f/0xc2
The syzkaller folks reported a nested\_run\_pending warning during userspace
clear VMX capability which is exposed to L1 before.
The warning gets thrown while doing
(\*(uint32\_t\*)0x20aecfe8 = (uint32\_t)0x1);
(\*(uint32\_t\*)0x20aecfec = (uint32\_t)0x0);
(\*(uint32\_t\*)0x20aecff0 = (uint32\_t)0x3a);
(\*(uint32\_t\*)0x20aecff4 = (uint32\_t)0x0);
(\*(uint64\_t\*)0x20aecff8 = (uint64\_t)0x0);
r[29] = syscall(\_\_NR\_ioctl, r[4], 0x4008ae89ul,
0x20aecfe8ul, 0, 0, 0, 0, 0, 0);
i.e. KVM\_SET\_MSR ioctl with
struct kvm\_msrs {
.nmsrs = 1,
.pad = 0,
.entries = {
{.index = MSR\_IA32\_FEATURE\_CONTROL,
.reserved = 0,
.data = 0}
}
}
The VMLANCH/VMRESUME emulation should be stopped since the CPU is going to
reset here. This patch resets the nested\_run\_pending since the CPU is going
to be reset hence there should be nothing pending.
Reported-by: Dmitry Vyukov
Suggested-by: Radim Krčmář
Cc: Paolo Bonzini
Cc: Radim Krčmář
Cc: Dmitry Vyukov
Cc: David Hildenbrand
Signed-off-by: Wanpeng Li
Reviewed-by: David Hildenbrand
Reviewed-by: Jim Mattson
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
commit a28fd13338eac8b47942e6b2bebfd1cee9f4aae8
Author: Franck Demathieu
Date: Mon Mar 6 14:41:06 2017 +0100
irqchip/crossbar: Fix incorrect type of register size
[ Upstream commit 4b9de5da7e120c7f02395da729f0ec77ce7a6044 ]
The 'size' variable is unsigned according to the dt-bindings.
As this variable is used as integer in other places, create a new variable
that allows to fix the following sparse issue (-Wtypesign):
drivers/irqchip/irq-crossbar.c:279:52: warning: incorrect type in argument 3 (different signedness)
drivers/irqchip/irq-crossbar.c:279:52: expected unsigned int [usertype] \*out\_value
drivers/irqchip/irq-crossbar.c:279:52: got int \*
Signed-off-by: Franck Demathieu
Signed-off-by: Marc Zyngier
Signed-off-by: Sasha Levin
commit a33fe2bcd33d42088aba4778a249ef83e6a3601a
Author: James Smart
Date: Sat Mar 4 09:30:25 2017 -0800
scsi: lpfc: Fix crash during Hardware error recovery on SLI3 adapters
[ Upstream commit 5d181531bc6169e19a02a27d202cf0e982db9d0e ]
if REG\_VPI fails, the driver was incorrectly issuing INIT\_VFI
(a SLI4 command) on a SLI3 adapter.
Signed-off-by: Dick Kennedy
Signed-off-by: James Smart
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 6b4d70f553acd2203608eb27858dba88ad68b691
Author: Tejun Heo
Date: Mon Mar 6 15:33:42 2017 -0500
workqueue: trigger WARN if queue\_delayed\_work() is called with NULL @wq
[ Upstream commit 637fdbae60d6cb9f6e963c1079d7e0445c86ff7d ]
If queue\_delayed\_work() gets called with NULL @wq, the kernel will
oops asynchronuosly on timer expiration which isn't too helpful in
tracking down the offender. This actually happened with smc.
\_\_queue\_delayed\_work() already does several input sanity checks
synchronously. Add NULL @wq check.
Reported-by: Dave Jones
Link: http://lkml.kernel.org/r/20170227171439.jshx3qplflyrgcv7@codemonkey.org.uk
Signed-off-by: Tejun Heo
Signed-off-by: Sasha Levin
commit af0e7947de8c4b80e55ebd8bf96b6d795eca9cc3
Author: Tejun Heo
Date: Mon Mar 6 15:26:54 2017 -0500
libata: drop WARN from protocol error in ata\_sff\_qc\_issue()
[ Upstream commit 0580b762a4d6b70817476b90042813f8573283fa ]
ata\_sff\_qc\_issue() expects upper layers to never issue commands on a
command protocol that it doesn't implement. While the assumption
holds fine with the usual IO path, nothing filters based on the
command protocol in the passthrough path (which was added later),
allowing the warning to be tripped with a passthrough command with the
right (well, wrong) protocol.
Failing with AC\_ERR\_SYSTEM is the right thing to do anyway. Remove
the unnecessary WARN.
Reported-by: Dmitry Vyukov
Link: http://lkml.kernel.org/r/CACT4Y+bXkvevNZU8uP6X0QVqsj6wNoUA\_1exfTSOzc+SmUtMOA@mail.gmail.com
Signed-off-by: Tejun Heo
Signed-off-by: Sasha Levin
commit 1c33170076ba1e16f6cb4021e3c76f485dea39cc
Author: Christophe JAILLET
Date: Tue Feb 21 22:33:11 2017 +0100
USB: gadgetfs: Fix a potential memory leak in 'dev\_config()'
[ Upstream commit b6e7aeeaf235901c42ec35de4633c7c69501d303 ]
'kbuf' is allocated just a few lines above using 'memdup\_user()'.
If the 'if (dev->buf)' test fails, this memory is never released.
Signed-off-by: Christophe JAILLET
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 37177405c4afb7967cd091946be37ed2c94ff339
Author: John Keeping
Date: Tue Feb 28 10:55:30 2017 +0000
usb: gadget: configs: plug memory leak
[ Upstream commit 38355b2a44776c25b0f2ad466e8c51bb805b3032 ]
When binding a gadget to a device, "name" is stored in gi->udc\_name, but
this does not happen when unregistering and the string is leaked.
Signed-off-by: John Keeping
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 1792ffc3256cc910c9a016a763bfe240957c5b9b
Author: David Daney
Date: Wed Mar 1 14:04:53 2017 -0800
module: set \_\_jump\_table alignment to 8
[ Upstream commit ab42632156becd35d3884ee5c14da2bedbf3149a ]
For powerpc the \_\_jump\_table section in modules is not aligned, this
causes a WARN\_ON() splat when loading a module containing a \_\_jump\_table.
Strict alignment became necessary with commit 3821fd35b58d
("jump\_label: Reduce the size of struct static\_key"), currently in
linux-next, which uses the two least significant bits of pointers to
\_\_jump\_table elements.
Fix by forcing \_\_jump\_table to 8, which is the same alignment used for
this section in the kernel proper.
Link: http://lkml.kernel.org/r/20170301220453.4756-1-david.daney@cavium.com
Reviewed-by: Jason Baron
Acked-by: Jessica Yu
Acked-by: Michael Ellerman  (powerpc)
Tested-by: Sachin Sant
Signed-off-by: David Daney
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Sasha Levin
commit 0e1ac5b7b4619345e87971f798c141d6e9ae74bc
Author: Sachin Sant
Date: Sun Feb 26 11:38:39 2017 +0530
selftest/powerpc: Fix false failures for skipped tests
[ Upstream commit a6d8a21596df041f36f4c2ccc260c459e3e851f1 ]
Tests under alignment subdirectory are skipped when executed on previous
generation hardware, but harness still marks them as failed.
test: test\_copy\_unaligned
tags: git\_version:unknown
[SKIP] Test skipped on line 26
skip: test\_copy\_unaligned
selftests: copy\_unaligned [FAIL]
The MAGIC\_SKIP\_RETURN\_VALUE value assigned to rc variable is retained till
the program exit which causes the test to be marked as failed.
This patch resets the value before returning to the main() routine.
With this patch the test o/p is as follows:
test: test\_copy\_unaligned
tags: git\_version:unknown
[SKIP] Test skipped on line 26
skip: test\_copy\_unaligned
selftests: copy\_unaligned [PASS]
Signed-off-by: Sachin Sant
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
commit 6500fffd7f0978a35b9d1188b4064483c46d4525
Author: Ladislav Michl
Date: Sat Feb 11 14:02:49 2017 +0100
ARM: OMAP2+: gpmc-onenand: propagate error on initialization failure
[ Upstream commit 7807e086a2d1f69cc1a57958cac04fea79fc2112 ]
gpmc\_probe\_onenand\_child returns success even on gpmc\_onenand\_init
failure. Fix that.
Signed-off-by: Ladislav Michl
Acked-by: Roger Quadros
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit ef14323b7bb53a532bec39d724a1fdd52f0da5a4
Author: Steffen Klassert
Date: Wed Feb 15 11:38:58 2017 +0100
vti6: Don't report path MTU below IPV6\_MIN\_MTU.
[ Upstream commit e3dc847a5f85b43ee2bfc8eae407a7e383483228 ]
In vti6\_xmit(), the check for IPV6\_MIN\_MTU before we
send a ICMPV6\_PKT\_TOOBIG message is missing. So we might
report a PMTU below 1280. Fix this by adding the required
check.
Fixes: ccd740cbc6e ("vti6: Add pmtu handling to vti6\_xmit.")
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 64fc772bc598e0bbd5222b5a41d3d8bdabf7bc0b
Author: Stephen Hemminger
Date: Tue Mar 7 09:15:53 2017 -0800
scsi: storvsc: Workaround for virtual DVD SCSI version
[ Upstream commit f1c635b439a5c01776fe3a25b1e2dc546ea82e6f ]
Hyper-V host emulation of SCSI for virtual DVD device reports SCSI
version 0 (UNKNOWN) but is still capable of supporting REPORTLUN.
Without this patch, a GEN2 Linux guest on Hyper-V will not boot 4.11
successfully with virtual DVD ROM device. What happens is that the SCSI
scan process falls back to doing sequential probing by INQUIRY. But the
storvsc driver has a previous workaround that masks/blocks all errors
reports from INQUIRY (or MODE\_SENSE) commands. This workaround causes
the scan to then populate a full set of bogus LUN's on the target and
then sends kernel spinning off into a death spiral doing block reads on
the non-existent LUNs.
By setting the correct blacklist flags, the target with the DVD device
is scanned with REPORTLUN and that works correctly.
Patch needs to go in current 4.11, it is safe but not necessary in older
kernels.
Signed-off-by: Stephen Hemminger
Reviewed-by: K. Y. Srinivasan
Reviewed-by: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 163b3139e68906a91fe4d924c2705383c712774f
Author: Dave Martin
Date: Tue Dec 5 14:56:42 2017 +0000
arm64: fpsimd: Prevent registers leaking from dead tasks
[ Upstream commit 071b6d4a5d343046f253a5a8835d477d93992002 ]
Currently, loading of a task's fpsimd state into the CPU registers
is skipped if that task's state is already present in the registers
of that CPU.
However, the code relies on the struct fpsimd\_state \* (and by
extension struct task\_struct \*) to unambiguously identify a task.
There is a particular case in which this doesn't work reliably:
when a task exits, its task\_struct may be recycled to describe a
new task.
Consider the following scenario:
1) Task P loads its fpsimd state onto cpu C.
per\_cpu(fpsimd\_last\_state, C) := P;
P->thread.fpsimd\_state.cpu := C;
2) Task X is scheduled onto C and loads its fpsimd state on C.
per\_cpu(fpsimd\_last\_state, C) := X;
X->thread.fpsimd\_state.cpu := C;
3) X exits, causing X's task\_struct to be freed.
4) P forks a new child T, which obtains X's recycled task\_struct.
T == X.
T->thread.fpsimd\_state.cpu == C (inherited from P).
5) T is scheduled on C.
T's fpsimd state is not loaded, because
per\_cpu(fpsimd\_last\_state, C) == T (== X) &&
T->thread.fpsimd\_state.cpu == C.
(This is the check performed by fpsimd\_thread\_switch().)
So, T gets X's registers because the last registers loaded onto C
were those of X, in (2).
This patch fixes the problem by ensuring that the sched-in check
fails in (5): fpsimd\_flush\_task\_state(T) is called when T is
forked, so that T->thread.fpsimd\_state.cpu == C cannot be true.
This relies on the fact that T is not schedulable until after
copy\_thread() completes.
Once T's fpsimd state has been loaded on some CPU C there may still
be other cpus D for which per\_cpu(fpsimd\_last\_state, D) ==
&X->thread.fpsimd\_state. But D is necessarily != C in this case,
and the check in (5) must fail.
An alternative fix would be to do refcounting on task\_struct. This
would result in each CPU holding a reference to the last task whose
fpsimd state was loaded there. It's not clear whether this is
preferable, and it involves higher overhead than the fix proposed
in this patch. It would also move all the task\_struct freeing
work into the context switch critical section, or otherwise some
deferred cleanup mechanism would need to be introduced, neither of
which seems obviously justified.
Cc:
Fixes: 005f78cd8849 ("arm64: defer reloading a task's FPSIMD state to userland resume")
Signed-off-by: Dave Martin
Reviewed-by: Ard Biesheuvel
[will: word-smithed the comment so it makes more sense]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 6552b7695ca65e6ca412948d4aa0179df69dbc1d
Author: Andrew Honig
Date: Fri Dec 1 10:21:09 2017 -0800
KVM: VMX: remove I/O port 0x80 bypass on Intel hosts
[ Upstream commit d59d51f088014f25c2562de59b9abff4f42a7468 ]
This fixes CVE-2017-1000407.
KVM allows guests to directly access I/O port 0x80 on Intel hosts. If
the guest floods this port with writes it generates exceptions and
instability in the host kernel, leading to a crash. With this change
guest writes to port 0x80 on Intel will behave the same as they
currently behave on AMD systems.
Prevent the flooding by removing the code that sets port 0x80 as a
passthrough port. This is essentially the same as upstream patch
99f85a28a78e96d28907fe036e1671a218fee597, except that patch was
for AMD chipsets and this patch is for Intel.
Signed-off-by: Andrew Honig
Signed-off-by: Jim Mattson
Fixes: fdef3ad1b386 ("KVM: VMX: Enable io bitmaps to avoid IO port 0x80 VMEXITs")
Cc:
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
commit ca59a0466d51aec281701ba2123d5418afa137f4
Author: Kristina Martsenko
Date: Thu Nov 16 17:58:20 2017 +0000
arm64: KVM: fix VTTBR\_BADDR\_MASK BUG\_ON off-by-one
[ Upstream commit 26aa7b3b1c0fb3f1a6176a0c1847204ef4355693 ]
VTTBR\_BADDR\_MASK is used to sanity check the size and alignment of the
VTTBR address. It seems to currently be off by one, thereby only
allowing up to 47-bit addresses (instead of 48-bit) and also
insufficiently checking the alignment. This patch fixes it.
As an example, with 4k pages, before this patch we have:
PHYS\_MASK\_SHIFT = 48
VTTBR\_X = 37 - 24 = 13
VTTBR\_BADDR\_SHIFT = 13 - 1 = 12
VTTBR\_BADDR\_MASK = ((1 << 35) - 1) << 12 = 0x00007ffffffff000
Which is wrong, because the mask doesn't allow bit 47 of the VTTBR
address to be set, and only requires the address to be 12-bit (4k)
aligned, while it actually needs to be 13-bit (8k) aligned because we
concatenate two 4k tables.
With this patch, the mask becomes 0x0000ffffffffe000, which is what we
want.
Fixes: 0369f6a34b9f ("arm64: KVM: EL2 register definitions")
Cc:  # 3.11.x
Reviewed-by: Suzuki K Poulose
Reviewed-by: Christoffer Dall
Signed-off-by: Kristina Martsenko
Signed-off-by: Marc Zyngier
Signed-off-by: Christoffer Dall
Signed-off-by: Sasha Levin
commit 31bf7fd58b40cd1c0dc787c17885d8acf773b689
Author: Laurent Caumont
Date: Sat Nov 11 12:44:46 2017 -0500
media: dvb: i2c transfers over usb cannot be done from stack
[ Upstream commit b4756707152700c96acdfe149cb1ca4cec306c7a ]
Since commit 29d2fef8be11 ("usb: catch attempts to submit urbs
with a vmalloc'd transfer buffer"), the AverMedia AverTV DVB-T
USB 2.0 (a800) fails to probe.
Cc: stable@vger.kernel.org
Signed-off-by: Sean Young
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 336200ecc7442e99d176e64bed270a1ee12ef30a
Author: Dave Gordon
Date: Thu Aug 18 18:17:22 2016 +0100
drm: extra printk() wrapper macros
[ Upstream commit 30b0da8d556e65ff935a56cd82c05ba0516d3e4a ]
We had only DRM\_INFO() and DRM\_ERROR(), whereas the underlying printk()
provides several other useful intermediate levels such as NOTICE and
WARNING. So this patch fills out the set by providing both regular and
once-only macros for each of the levels INFO, NOTICE, and WARNING, using
a common underlying macro that does all the token-pasting.
DRM\_ERROR is unchanged, as it's not just a printk wrapper.
v2:
Fix whitespace, missing ## (Eric Engestrom)
Signed-off-by: Dave Gordon
Reviewed-by: Eric Engestrom
Cc: dri-devel@lists.freedesktop.org
Acked-by: Dave Airlie
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Sasha Levin
commit 7ccf6a41095507186c4fff0cad8de381a530ac3b
Author: Daniel Thompson
Date: Mon Mar 2 14:13:36 2015 +0000
kdb: Fix handling of kallsyms\_symbol\_next() return value
[ Upstream commit c07d35338081d107e57cf37572d8cc931a8e32e2 ]
kallsyms\_symbol\_next() returns a boolean (true on success). Currently
kdb\_read() tests the return value with an inequality that
unconditionally evaluates to true.
This is fixed in the obvious way and, since the conditional branch is
supposed to be unreachable, we also add a WARN\_ON().
Reported-by: Dan Carpenter
Signed-off-by: Daniel Thompson
Cc: linux-stable
Signed-off-by: Jason Wessel
Signed-off-by: Sasha Levin
commit 50d50270d3d6b87c6e44822bee7aac736b1fe0f8
Author: Robin Murphy
Date: Thu Sep 28 15:14:01 2017 +0100
iommu/vt-d: Fix scatterlist offset handling
[ Upstream commit 29a90b70893817e2f2bb3cea40a29f5308e21b21 ]
The intel-iommu DMA ops fail to correctly handle scatterlists where
sg->offset is greater than PAGE\_SIZE - the IOVA allocation is computed
appropriately based on the page-aligned portion of the offset, but the
mapping is set up relative to sg->page, which means it fails to actually
cover the whole buffer (and in the worst case doesn't cover it at all):
(sg->dma\_address + sg->dma\_len) ----+
sg->dma\_address ---------+ |
iov\_pfn------+ | |
| | |
v v v
iova: a b c d e f
|--------|--------|--------|--------|--------|
<...calculated....>
[\_\_\_\_\_mapped\_\_\_\_\_\_]
pfn: 0 1 2 3 4 5
|--------|--------|--------|--------|--------|
^ ^ ^
| | |
sg->page ----+ | |
sg->offset --------------+ |
(sg->offset + sg->length) ----------+
As a result, the caller ends up overrunning the mapping into whatever
lies beyond, which usually goes badly:
[ 429.645492] DMAR: DRHD: handling fault status reg 2
[ 429.650847] DMAR: [DMA Write] Request device [02:00.4] fault addr f2682000 ...
Whilst this is a fairly rare occurrence, it can happen from the result
of intermediate scatterlist processing such as scatterwalk\_ffwd() in the
crypto layer. Whilst that particular site could be fixed up, it still
seems worthwhile to bring intel-iommu in line with other DMA API
implementations in handling this robustly.
To that end, fix the intel\_map\_sg() path to line up the mapping
correctly (in units of MM pages rather than VT-d pages to match the
aligned\_nrpages() calculation) regardless of the offset, and use
sg\_phys() consistently for clarity.
Reported-by: Harsh Jain
Signed-off-by: Robin Murphy
Reviewed by: Ashok Raj
Tested by: Jacob Pan
Cc: stable@vger.kernel.org
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
commit 1eb1c013cc42e878cb3c87b1587c3bb303dea8d5
Author: Jaejoong Kim
Date: Mon Dec 4 15:31:49 2017 +0900
ALSA: usb-audio: Add check return value for usb\_string()
[ Upstream commit 89b89d121ffcf8d9546633b98ded9d18b8f75891 ]
snd\_usb\_copy\_string\_desc() returns zero if usb\_string() fails.
In case of failure, we need to check the snd\_usb\_copy\_string\_desc()'s
return value and add an exception case
Signed-off-by: Jaejoong Kim
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 1972b63db65eeead06e9e8e21bc7e26ef4807769
Author: Jaejoong Kim
Date: Mon Dec 4 15:31:48 2017 +0900
ALSA: usb-audio: Fix out-of-bound error
[ Upstream commit 251552a2b0d454badc8f486e6d79100970c744b0 ]
The snd\_usb\_copy\_string\_desc() retrieves the usb string corresponding to
the index number through the usb\_string(). The problem is that the
usb\_string() returns the length of the string (>= 0) when successful, but
it can also return a negative value about the error case or status of
usb\_control\_msg().
If iClockSource is '0' as shown below, usb\_string() will returns -EINVAL.
This will result in '0' being inserted into buf[-22], and the following
KASAN out-of-bound error message will be output.
AudioControl Interface Descriptor:
bLength 8
bDescriptorType 36
bDescriptorSubtype 10 (CLOCK\_SOURCE)
bClockID 1
bmAttributes 0x07 Internal programmable Clock (synced to SOF)
bmControls 0x07
Clock Frequency Control (read/write)
Clock Validity Control (read-only)
bAssocTerminal 0
iClockSource 0
To fix it, check usb\_string()'return value and bail out.
==================================================================
BUG: KASAN: stack-out-of-bounds in parse\_audio\_unit+0x1327/0x1960 [snd\_usb\_audio]
Write of size 1 at addr ffff88007e66735a by task systemd-udevd/18376
CPU: 0 PID: 18376 Comm: systemd-udevd Not tainted 4.13.0+ #3
Hardware name: LG Electronics 15N540-RFLGL/White Tip Mountain, BIOS 15N5
Call Trace:
dump\_stack+0x63/0x8d
print\_address\_description+0x70/0x290
? parse\_audio\_unit+0x1327/0x1960 [snd\_usb\_audio]
kasan\_report+0x265/0x350
\_\_asan\_store1+0x4a/0x50
parse\_audio\_unit+0x1327/0x1960 [snd\_usb\_audio]
? save\_stack+0xb5/0xd0
? save\_stack\_trace+0x1b/0x20
? save\_stack+0x46/0xd0
? kasan\_kmalloc+0xad/0xe0
? kmem\_cache\_alloc\_trace+0xff/0x230
? snd\_usb\_create\_mixer+0xb0/0x4b0 [snd\_usb\_audio]
? usb\_audio\_probe+0x4de/0xf40 [snd\_usb\_audio]
? usb\_probe\_interface+0x1f5/0x440
? driver\_probe\_device+0x3ed/0x660
? build\_feature\_ctl+0xb10/0xb10 [snd\_usb\_audio]
? save\_stack\_trace+0x1b/0x20
? init\_object+0x69/0xa0
? snd\_usb\_find\_csint\_desc+0xa8/0xf0 [snd\_usb\_audio]
snd\_usb\_mixer\_controls+0x1dc/0x370 [snd\_usb\_audio]
? build\_audio\_procunit+0x890/0x890 [snd\_usb\_audio]
? snd\_usb\_create\_mixer+0xb0/0x4b0 [snd\_usb\_audio]
? kmem\_cache\_alloc\_trace+0xff/0x230
? usb\_ifnum\_to\_if+0xbd/0xf0
snd\_usb\_create\_mixer+0x25b/0x4b0 [snd\_usb\_audio]
? snd\_usb\_create\_stream+0x255/0x2c0 [snd\_usb\_audio]
usb\_audio\_probe+0x4de/0xf40 [snd\_usb\_audio]
? snd\_usb\_autosuspend.part.7+0x30/0x30 [snd\_usb\_audio]
? \_\_pm\_runtime\_idle+0x90/0x90
? kernfs\_activate+0xa6/0xc0
? usb\_match\_one\_id\_intf+0xdc/0x130
? \_\_pm\_runtime\_set\_status+0x2d4/0x450
usb\_probe\_interface+0x1f5/0x440
Cc:
Signed-off-by: Jaejoong Kim
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 633255b43de114aefa72610922fa86bbda7cd951
Author: Takashi Iwai
Date: Thu Nov 30 10:08:28 2017 +0100
ALSA: seq: Remove spurious WARN\_ON() at timer check
[ Upstream commit 43a3542870328601be02fcc9d27b09db467336ef ]
The use of snd\_BUG\_ON() in ALSA sequencer timer may lead to a spurious
WARN\_ON() when a slave timer is deployed as its backend and a
corresponding master timer stops meanwhile. The symptom was triggered
by syzkaller spontaneously.
Since the NULL timer is valid there, rip off snd\_BUG\_ON().
Reported-by: syzbot
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 0bde6f9d1faf3d4aaf8346d8a326cf02e7ea1a3a
Author: Robb Glasser
Date: Tue Dec 5 09:16:55 2017 -0800
ALSA: pcm: prevent UAF in snd\_pcm\_info
[ Upstream commit 362bca57f5d78220f8b5907b875961af9436e229 ]
When the device descriptor is closed, the `substream->runtime` pointer
is freed. But another thread may be in the ioctl handler, case
SNDRV\_CTL\_IOCTL\_PCM\_INFO. This case calls snd\_pcm\_info\_user() which
calls snd\_pcm\_info() which accesses the now freed `substream->runtime`.
Note: this fixes CVE-2017-0861
Signed-off-by: Robb Glasser
Signed-off-by: Nick Desaulniers
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit fad18b48c112a932c80a77f38a5dc26bd0e13a2e
Author: Rafael J. Wysocki
Date: Fri Dec 1 15:08:12 2017 +0100
x86/PCI: Make broadcom\_postcore\_init() check acpi\_disabled
[ Upstream commit ddec3bdee05b06f1dda20ded003c3e10e4184cab ]
acpi\_os\_get\_root\_pointer() may return a valid address even if acpi\_disabled
is set, but the host bridge information from the ACPI tables is not going
to be used in that case and the Broadcom host bridge initialization should
not be skipped then, So make broadcom\_postcore\_init() check acpi\_disabled
too to avoid this issue.
Fixes: 6361d72b04d1 (x86/PCI: read Broadcom CNB20LE host bridge info before PCI scan)
Reported-by: Dave Hansen
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Thomas Gleixner
Cc: Bjorn Helgaas
Cc: Linux PCI
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/3186627.pxZj1QbYNg@aspire.rjw.lan
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 110bf7c92a9910ba877eb30006025cf50a143cbb
Author: Eric Biggers
Date: Fri Dec 8 15:13:27 2017 +0000
X.509: reject invalid BIT STRING for subjectPublicKey
[ Upstream commit 0f30cbea005bd3077bd98cd29277d7fc2699c1da ]
Adding a specially crafted X.509 certificate whose subjectPublicKey
ASN.1 value is zero-length caused x509\_extract\_key\_data() to set the
public key size to SIZE\_MAX, as it subtracted the nonexistent BIT STRING
metadata byte. Then, x509\_cert\_parse() called kmemdup() with that bogus
size, triggering the WARN\_ON\_ONCE() in kmalloc\_slab().
This appears to be harmless, but it still must be fixed since WARNs are
never supposed to be user-triggerable.
Fix it by updating x509\_cert\_parse() to validate that the value has a
BIT STRING metadata byte, and that the byte is 0 which indicates that
the number of bits in the bitstring is a multiple of 8.
It would be nice to handle the metadata byte in asn1\_ber\_decoder()
instead. But that would be tricky because in the general case a BIT
STRING could be implicitly tagged, and/or could legitimately have a
length that is not a whole number of bytes.
Here was the WARN (cleaned up slightly):
WARNING: CPU: 1 PID: 202 at mm/slab\_common.c:971 kmalloc\_slab+0x5d/0x70 mm/slab\_common.c:971
Modules linked in:
CPU: 1 PID: 202 Comm: keyctl Tainted: G B 4.14.0-09238-g1d3b78bbc6e9 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110\_100015-anatol 04/01/2014
task: ffff880033014180 task.stack: ffff8800305c8000
Call Trace:
\_\_do\_kmalloc mm/slab.c:3706 [inline]
\_\_kmalloc\_track\_caller+0x22/0x2e0 mm/slab.c:3726
kmemdup+0x17/0x40 mm/util.c:118
kmemdup include/linux/string.h:414 [inline]
x509\_cert\_parse+0x2cb/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:106
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 42d5ec27f873 ("X.509: Add an ASN.1 decoder")
Cc:  # v3.7+
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Reviewed-by: James Morris
Signed-off-by: Sasha Levin
commit c75c77e330f1d619a1e505620fa3d4ebca9b4b8e
Author: Eric Biggers
Date: Fri Dec 8 15:13:27 2017 +0000
ASN.1: check for error from ASN1\_OP\_END\_\_ACT actions
[ Upstream commit 81a7be2cd69b412ab6aeacfe5ebf1bb6e5bce955 ]
asn1\_ber\_decoder() was ignoring errors from actions associated with the
opcodes ASN1\_OP\_END\_SEQ\_ACT, ASN1\_OP\_END\_SET\_ACT,
ASN1\_OP\_END\_SEQ\_OF\_ACT, and ASN1\_OP\_END\_SET\_OF\_ACT. In practice, this
meant the pkcs7\_note\_signed\_info() action (since that was the only user
of those opcodes). Fix it by checking for the error, just like the
decoder does for actions associated with the other opcodes.
This bug allowed users to leak slab memory by repeatedly trying to add a
specially crafted "pkcs7\_test" key (requires CONFIG\_PKCS7\_TEST\_KEY).
In theory, this bug could also be used to bypass module signature
verification, by providing a PKCS#7 message that is misparsed such that
a signature's ->authattrs do not contain its ->msgdigest. But it
doesn't seem practical in normal cases, due to restrictions on the
format of the ->authattrs.
Fixes: 42d5ec27f873 ("X.509: Add an ASN.1 decoder")
Cc:  # v3.7+
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Reviewed-by: James Morris
Signed-off-by: Sasha Levin
commit cb18143c205ee4e7310c22b29c3f6851e8b97029
Author: Huacai Chen
Date: Tue Nov 21 14:23:39 2017 +0100
scsi: libsas: align sata\_device's rps\_resp on a cacheline
[ Upstream commit c2e8fbf908afd81ad502b567a6639598f92c9b9d ]
The rps\_resp buffer in ata\_device is a DMA target, but it isn't
explicitly cacheline aligned. Due to this, adjacent fields can be
overwritten with stale data from memory on non-coherent architectures.
As a result, the kernel is sometimes unable to communicate with an SATA
device behind a SAS expander.
Fix this by ensuring that the rps\_resp buffer is cacheline aligned.
This issue is similar to that fixed by Commit 84bda12af31f93 ("libata:
align ap->sector\_buf") and Commit 4ee34ea3a12396f35b26 ("libata: Align
ata\_device's id on a cacheline").
Cc: stable@vger.kernel.org
Signed-off-by: Huacai Chen
Signed-off-by: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 993e0f72a3ce3e0ac86e83d84515c7825b580812
Author: William Breathitt Gray
Date: Wed Nov 8 10:23:11 2017 -0500
isa: Prevent NULL dereference in isa\_bus driver callbacks
[ Upstream commit 5a244727f428a06634f22bb890e78024ab0c89f3 ]
The isa\_driver structure for an isa\_bus device is stored in the device
platform\_data member of the respective device structure. This
platform\_data member may be reset to NULL if isa\_driver match callback
for the device fails, indicating a device unsupported by the ISA driver.
This patch fixes a possible NULL pointer dereference if one of the
isa\_driver callbacks to attempted for an unsupported device. This error
should not occur in practice since ISA devices are typically manually
configured and loaded by the users, but we may as well prevent this
error from popping up for the 0day testers.
Fixes: a5117ba7da37 ("[PATCH] Driver model: add ISA bus")
Signed-off-by: William Breathitt Gray
Cc: stable
Acked-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit f0d372ffcd7b2ffe8ceaf3658b279ff54f5e8324
Author: Paul Meyer
Date: Tue Nov 14 13:06:47 2017 -0700
hv: kvp: Avoid reading past allocated blocks from KVP file
[ Upstream commit 297d6b6e56c2977fc504c61bbeeaa21296923f89 ]
While reading in more than one block (50) of KVP records, the allocation
goes per block, but the reads used the total number of allocated records
(without resetting the pointer/stream). This causes the records buffer to
overrun when the refresh reads more than one block over the previous
capacity (e.g. reading more than 100 KVP records whereas the in-memory
database was empty before).
Fix this by reading the correct number of KVP records from file each time.
Signed-off-by: Paul Meyer
Signed-off-by: Long Li
Cc: stable@vger.kernel.org
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit fb30b3f000902ff8c4368c2d929c96ed777d15d7
Author: weiping zhang
Date: Wed Nov 29 09:23:01 2017 +0800
virtio: release virtio index when fail to device\_register
[ Upstream commit e60ea67bb60459b95a50a156296041a13e0e380e ]
index can be reused by other virtio device.
Cc: stable@vger.kernel.org
Signed-off-by: weiping zhang
Reviewed-by: Cornelia Huck
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Sasha Levin
commit 8a7022f7625040e4295d89f72200cabd8195bdaf
Author: Martin Kelly
Date: Tue Dec 5 11:15:50 2017 -0800
can: usb\_8dev: cancel urb on -EPIPE and -EPROTO
[ Upstream commit 12147edc434c9e4c7c2f5fee2e5519b2e5ac34ce ]
In mcba\_usb, we have observed that when you unplug the device, the driver will
endlessly resubmit failing URBs, which can cause CPU stalls. This issue
is fixed in mcba\_usb by catching the codes seen on device disconnect
(-EPIPE and -EPROTO).
This driver also resubmits in the case of -EPIPE and -EPROTO, so fix it
in the same way.
Signed-off-by: Martin Kelly
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 8b65515d121586ebbfb1440768e35b207dde98b2
Author: Martin Kelly
Date: Tue Dec 5 11:15:48 2017 -0800
can: esd\_usb2: cancel urb on -EPIPE and -EPROTO
[ Upstream commit 7a31ced3de06e9878e4f9c3abe8f87d9344d8144 ]
In mcba\_usb, we have observed that when you unplug the device, the driver will
endlessly resubmit failing URBs, which can cause CPU stalls. This issue
is fixed in mcba\_usb by catching the codes seen on device disconnect
(-EPIPE and -EPROTO).
This driver also resubmits in the case of -EPIPE and -EPROTO, so fix it
in the same way.
Signed-off-by: Martin Kelly
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 1faeca460ed7144544652dac82412e01a5ca9f29
Author: Martin Kelly
Date: Tue Dec 5 11:15:47 2017 -0800
can: ems\_usb: cancel urb on -EPIPE and -EPROTO
[ Upstream commit bd352e1adfe0d02d3ea7c8e3fb19183dc317e679 ]
In mcba\_usb, we have observed that when you unplug the device, the driver will
endlessly resubmit failing URBs, which can cause CPU stalls. This issue
is fixed in mcba\_usb by catching the codes seen on device disconnect
(-EPIPE and -EPROTO).
This driver also resubmits in the case of -EPIPE and -EPROTO, so fix it
in the same way.
Signed-off-by: Martin Kelly
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit bf4857475f657204552d790fd979577076d6e4ce
Author: Martin Kelly
Date: Tue Dec 5 11:15:49 2017 -0800
can: kvaser\_usb: cancel urb on -EPIPE and -EPROTO
[ Upstream commit 6aa8d5945502baf4687d80de59b7ac865e9e666b ]
In mcba\_usb, we have observed that when you unplug the device, the driver will
endlessly resubmit failing URBs, which can cause CPU stalls. This issue
is fixed in mcba\_usb by catching the codes seen on device disconnect
(-EPIPE and -EPROTO).
This driver also resubmits in the case of -EPIPE and -EPROTO, so fix it
in the same way.
Signed-off-by: Martin Kelly
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 16ec63f0f106391c728010e00263f7ee1f0d75c8
Author: Jimmy Assarsson
Date: Tue Nov 21 08:22:28 2017 +0100
can: kvaser\_usb: ratelimit errors if incomplete messages are received
[ Upstream commit 8bd13bd522ff7dfa0eb371921aeb417155f7a3be ]
Avoid flooding the kernel log with "Formate error", if incomplete message
are received.
Signed-off-by: Jimmy Assarsson
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 5875c419e115db4f1cdd0fbc7dfac08b88cade9b
Author: Jimmy Assarsson
Date: Tue Nov 21 08:22:27 2017 +0100
can: kvaser\_usb: Fix comparison bug in kvaser\_usb\_read\_bulk\_callback()
[ Upstream commit e84f44eb5523401faeb9cc1c97895b68e3cfb78d ]
The conditon in the while-loop becomes true when actual\_length is less than
2 (MSG\_HEADER\_LEN). In best case we end up with a former, already
dispatched msg, that got msg->len greater than actual\_length. This will
result in a "Format error" error printout.
Problem seen when unplugging a Kvaser USB device connected to a vbox guest.
warning: comparison between signed and unsigned integer expressions
[-Wsign-compare]
Signed-off-by: Jimmy Assarsson
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit db0081b8eab496df2b7c94ccce32e3ebb8aaefd8
Author: Jimmy Assarsson
Date: Tue Nov 21 08:22:26 2017 +0100
can: kvaser\_usb: free buf in error paths
[ Upstream commit 435019b48033138581a6171093b181fc6b4d3d30 ]
The allocated buffer was not freed if usb\_submit\_urb() failed.
Signed-off-by: Jimmy Assarsson
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 47a7b5ceecabda125be97c710831bb631ad7f8e9
Author: Oliver Stäbler
Date: Mon Nov 20 14:45:15 2017 +0100
can: ti\_hecc: Fix napi poll return value for repoll
[ Upstream commit f6c23b174c3c96616514827407769cbcfc8005cf ]
After commit d75b1ade567f ("net: less interrupt masking in NAPI") napi
repoll is done only when work\_done == budget.
So we need to return budget if there are still packets to receive.
Signed-off-by: Oliver Stäbler
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit be83ae76a679737f448472b44daeb03298dce61e
Author: Colin Ian King
Date: Tue Nov 7 16:45:04 2017 +0000
usb: host: fix incorrect updating of offset
[ Upstream commit 1d5a31582ef046d3b233f0da1a68ae26519b2f0a ]
The variable temp is incorrectly being updated, instead it should
be offset otherwise the loop just reads the same capability value
and loops forever. Thanks to Alan Stern for pointing out the
correct fix to my original fix. Fix also cleans up clang warning:
drivers/usb/host/ehci-dbg.c:840:4: warning: Value stored to 'temp'
is never read
Fixes: d49d43174400 ("USB: misc ehci updates")
Cc: stable
Signed-off-by: Colin Ian King
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 6951610430a4ac63c48d7a810bbad34d58722e02
Author: Oliver Neukum
Date: Thu Nov 23 16:39:52 2017 +0100
USB: usbfs: Filter flags passed in from user space
[ Upstream commit 446f666da9f019ce2ffd03800995487e79a91462 ]
USBDEVFS\_URB\_ISO\_ASAP must be accepted only for ISO endpoints.
Improve sanity checking.
Reported-by: Andrey Konovalov
Signed-off-by: Oliver Neukum
Cc: stable
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit d2eff96c49c9af5fe2dc33afec2ebb2e5b18f613
Author: Dan Carpenter
Date: Fri Sep 22 23:43:25 2017 +0300
USB: devio: Prevent integer overflow in proc\_do\_submiturb()
[ Upstream commit 57999d1107c1e60c2ca7088f2ac0f819e2f554b3 ]
There used to be an integer overflow check in proc\_do\_submiturb() but
we removed it. It turns out that it's still required. The
uurb->buffer\_length variable is a signed integer and it's controlled by
the user. It can lead to an integer overflow when we do:
num\_sgs = DIV\_ROUND\_UP(uurb->buffer\_length, USB\_SG\_SIZE);
If we strip away the macro then that line looks like this:
num\_sgs = (uurb->buffer\_length + USB\_SG\_SIZE - 1) / USB\_SG\_SIZE;
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
It's the first addition which can overflow.
Fixes: 1129d270cbfb ("USB: Increase usbfs transfer limit")
Cc: stable
Signed-off-by: Dan Carpenter
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit c91c25944050752582c79608f0dbe2a6a265b305
Author: Mateusz Berezecki
Date: Wed Dec 21 09:19:14 2016 -0800
USB: Increase usbfs transfer limit
[ Upstream commit 1129d270cbfbb7e2b1ec3dede4a13930bdd10e41 ]
Promote a variable keeping track of USB transfer memory usage to a
wider data type and allow for higher bandwidth transfers from a large
number of USB devices connected to a single host.
Signed-off-by: Mateusz Berezecki
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 3800bd5096064fbe93329c33ab8442852d50a61c
Author: Yu Chen
Date: Fri Dec 1 13:41:20 2017 +0200
usb: xhci: fix panic in xhci\_free\_virt\_devices\_depth\_first
[ Upstream commit 80e457699a8dbdd70f2d26911e46f538645c55fc ]
Check vdev->real\_port 0 to avoid panic
[ 9.261347] [] xhci\_free\_virt\_devices\_depth\_first+0x58/0x108
[ 9.261352] [] xhci\_mem\_cleanup+0x1bc/0x570
[ 9.261355] [] xhci\_stop+0x140/0x1c8
[ 9.261365] [] usb\_remove\_hcd+0xfc/0x1d0
[ 9.261369] [] xhci\_plat\_remove+0x6c/0xa8
[ 9.261377] [] platform\_drv\_remove+0x2c/0x70
[ 9.261384] [] \_\_device\_release\_driver+0x80/0x108
[ 9.261387] [] device\_release\_driver+0x2c/0x40
[ 9.261392] [] bus\_remove\_device+0xe0/0x120
[ 9.261396] [] device\_del+0x114/0x210
[ 9.261399] [] platform\_device\_del+0x30/0xa0
[ 9.261403] [] dwc3\_otg\_work+0x204/0x488
[ 9.261407] [] event\_work+0x304/0x5b8
[ 9.261414] [] process\_one\_work+0x148/0x490
[ 9.261417] [] worker\_thread+0x50/0x4a0
[ 9.261421] [] kthread+0xe8/0x100
[ 9.261427] [] ret\_from\_fork+0x10/0x50
The problem can occur if xhci\_plat\_remove() is called shortly after
xhci\_plat\_probe(). While xhci\_free\_virt\_devices\_depth\_first been
called before the device has been setup and get real\_port initialized.
The problem occurred on Hikey960 and was reproduced by Guenter Roeck
on Kevin with chromeos-4.4.
Fixes: ee8665e28e8d ("xhci: free xhci virtual devices with leaf nodes first")
Cc: Guenter Roeck
Cc:  # v4.10+
Reviewed-by: Guenter Roeck
Tested-by: Guenter Roeck
Signed-off-by: Fan Ning
Signed-off-by: Li Rui
Signed-off-by: yangdi
Signed-off-by: Yu Chen
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 8e7b166320edf88a778c2e108aa7faed81af0a40
Author: Mike Looijmans
Date: Thu Nov 9 13:16:46 2017 +0100
usb: hub: Cycle HUB power when initialization fails
[ Upstream commit 973593a960ddac0f14f0d8877d2d0abe0afda795 ]
Sometimes the USB device gets confused about the state of the initialization and
the connection fails. In particular, the device thinks that it's already set up
and running while the host thinks the device still needs to be configured. To
work around this issue, power-cycle the hub's output to issue a sort of "reset"
to the device. This makes the device restart its state machine and then the
initialization succeeds.
This fixes problems where the kernel reports a list of errors like this:
usb 1-1.3: device not accepting address 19, error -71
The end result is a non-functioning device. After this patch, the sequence
becomes like this:
usb 1-1.3: new high-speed USB device number 18 using ci\_hdrc
usb 1-1.3: device not accepting address 18, error -71
usb 1-1.3: new high-speed USB device number 19 using ci\_hdrc
usb 1-1.3: device not accepting address 19, error -71
usb 1-1-port3: attempt power cycle
usb 1-1.3: new high-speed USB device number 21 using ci\_hdrc
usb-storage 1-1.3:1.2: USB Mass Storage device detected
Signed-off-by: Mike Looijmans
Acked-by: Alan Stern
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 9dc021c202539c38b9f321806b0d2fc0b7f0e14b
Author: Rui Sousa
Date: Mon Feb 13 10:01:25 2017 +0800
net: fec: fix multicast filtering hardware setup
[ Upstream commit 01f8902bcf3ff124d0aeb88a774180ebcec20ace ]
Fix hardware setup of multicast address hash:
- Never clear the hardware hash (to avoid packet loss)
- Construct the hash register values in software and then write once
to hardware
Signed-off-by: Rui Sousa
Signed-off-by: Fugang Duan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8bae4d83e608649a8432b0234755b518de6f3bf2
Author: Jan Kara
Date: Wed Feb 8 14:30:53 2017 -0800
mm: avoid returning VM\_FAULT\_RETRY from ->page\_mkwrite handlers
[ Upstream commit 0911d0041c22922228ca52a977d7b0b0159fee4b ]
Some ->page\_mkwrite handlers may return VM\_FAULT\_RETRY as its return
code (GFS2 or Lustre can definitely do this). However VM\_FAULT\_RETRY
from ->page\_mkwrite is completely unhandled by the mm code and results
in locking and writeably mapping the page which definitely is not what
the caller wanted.
Fix Lustre and block\_page\_mkwrite\_ret() used by other filesystems
(notably GFS2) to return VM\_FAULT\_NOPAGE instead which results in
bailing out from the fault code, the CPU then retries the access, and we
fault again effectively doing what the handler wanted.
Link: http://lkml.kernel.org/r/20170203150729.15863-1-jack@suse.cz
Signed-off-by: Jan Kara
Reported-by: Al Viro
Reviewed-by: Jinshan Xiong
Cc: Matthew Wilcox
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit dc09971d7092130626f4ba86d7b55d3c3cb6faf9
Author: Jason Baron
Date: Tue Jan 24 21:49:41 2017 -0500
tcp: correct memory barrier usage in tcp\_check\_space()
[ Upstream commit 56d806222ace4c3aeae516cd7a855340fb2839d8 ]
sock\_reset\_flag() maps to \_\_clear\_bit() not the atomic version clear\_bit().
Thus, we need smp\_mb(), smp\_mb\_\_after\_atomic() is not sufficient.
Fixes: 3c7151275c0c ("tcp: add memory barriers to write space paths")
Cc: Eric Dumazet
Cc: Oleg Nesterov
Signed-off-by: Jason Baron
Acked-by: Eric Dumazet
Reported-by: Oleg Nesterov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 940fc0fc3010ed9aaec006a8c85fce00eb7d7be3
Author: Iago Abal
Date: Wed Jan 11 14:00:21 2017 +0100
dmaengine: pl330: fix double lock
[ Upstream commit 91539eb1fda2d530d3b268eef542c5414e54bf1a ]
The static bug finder EBA (http://www.iagoabal.eu/eba/) reported the
following double-lock bug:
Double lock:
1. spin\_lock\_irqsave(pch->lock, flags) at pl330\_free\_chan\_resources:2236;
2. call to function `pl330\_release\_channel' immediately after;
3. call to function `dma\_pl330\_rqcb' in line 1753;
4. spin\_lock\_irqsave(pch->lock, flags) at dma\_pl330\_rqcb:1505.
I have fixed it as suggested by Marek Szyprowski.
First, I have replaced `pch->lock' with `pl330->lock' in functions
`pl330\_alloc\_chan\_resources' and `pl330\_free\_chan\_resources'. This avoids
the double-lock by acquiring a different lock than `dma\_pl330\_rqcb'.
NOTE that, as a result, `pl330\_free\_chan\_resources' executes
`list\_splice\_tail\_init' on `pch->work\_list' under lock `pl330->lock',
whereas in the rest of the code `pch->work\_list' is protected by
`pch->lock'. I don't know if this may cause race conditions. Similarly
`pch->cyclic' is written by `pl330\_alloc\_chan\_resources' under
`pl330->lock' but read by `pl330\_tx\_submit' under `pch->lock'.
Second, I have removed locking from `pl330\_request\_channel' and
`pl330\_release\_channel' functions. Function `pl330\_request\_channel' is
only called from `pl330\_alloc\_chan\_resources', so the lock is already
held. Function `pl330\_release\_channel' is called from
`pl330\_free\_chan\_resources', which already holds the lock, and from
`pl330\_del'. Function `pl330\_del' is called in an error path of
`pl330\_probe' and at the end of `pl330\_remove', but I assume that there
cannot be concurrent accesses to the protected data at those points.
Signed-off-by: Iago Abal
Reviewed-by: Marek Szyprowski
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit b40bf0f48cb0b58ba64b924545c8cbfce5d48e25
Author: Parthasarathy Bhuvaragan
Date: Tue Jan 24 13:00:48 2017 +0100
tipc: fix cleanup at module unload
[ Upstream commit 35e22e49a5d6a741ebe7f2dd280b2052c3003ef7 ]
In tipc\_server\_stop(), we iterate over the connections with limiting
factor as server's idr\_in\_use. We ignore the fact that this variable
is decremented in tipc\_close\_conn(), leading to premature exit.
In this commit, we iterate until the we have no connections left.
Acked-by: Ying Xue
Acked-by: Jon Maloy
Tested-by: John Thompson
Signed-off-by: Parthasarathy Bhuvaragan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f37ddb16f1c3b362b65bf60b6ae47a61aef90bdf
Author: Colin Ian King
Date: Fri Jan 20 13:01:57 2017 +0000
net: sctp: fix array overrun read on sctp\_timer\_tbl
[ Upstream commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d ]
The comparison on the timeout can lead to an array overrun
read on sctp\_timer\_tbl because of an off-by-one error. Fix
this by using < instead of <= and also compare to the array
size rather than SCTP\_EVENT\_TIMEOUT\_MAX.
Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
Signed-off-by: Colin Ian King
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6db42b569047e3edcbf6d4333db46c8890249407
Author: Trond Myklebust
Date: Fri Jan 13 13:31:32 2017 -0500
NFSv4: Fix client recovery when server reboots multiple times
[ Upstream commit c6180a6237174f481dc856ed6e890d8196b6f0fb ]
If the server reboots multiple times, the client should rely on the
server to tell it that it cannot reclaim state as per section 9.6.3.4
in RFC7530 and section 8.4.2.1 in RFC5661.
Currently, the client is being to conservative, and is assuming that
if the server reboots while state recovery is in progress, then it must
ignore state that was not recovered before the reboot.
Signed-off-by: Trond Myklebust
Signed-off-by: Sasha Levin
commit e82ffdf0df73c325c8c324ab680447e5b45ea131
Author: Benjamin Coddington
Date: Thu Jan 5 10:20:16 2017 -0500
nfs: Don't take a reference on fl->fl\_file for LOCK operation
[ Upstream commit 4b09ec4b14a168bf2c687e1f598140c3c11e9222 ]
I have reports of a crash that look like \_\_fput() was called twice for
a NFSv4.0 file. It seems possible that the state manager could try to
reclaim a lock and take a reference on the fl->fl\_file at the same time the
file is being released if, during the close(), a signal interrupts the wait
for outstanding IO while removing locks which then skips the removal
of that lock.
Since 83bfff23e9ed ("nfs4: have do\_vfs\_lock take an inode pointer") has
removed the need to traverse fl->fl\_file->f\_inode in nfs4\_lock\_done(),
taking that reference is no longer necessary.
Signed-off-by: Benjamin Coddington
Reviewed-by: Jeff Layton
Signed-off-by: Trond Myklebust
Signed-off-by: Sasha Levin
commit f3fca5512aea1b3c8519c0c378cdcb41e9f0658a
Author: Vlad Tsyrklevich
Date: Mon Jan 9 20:57:48 2017 +0700
net/appletalk: Fix kernel memory disclosure
[ Upstream commit ce7e40c432ba84da104438f6799d460a4cad41bc ]
ipddp\_route structs contain alignment padding so kernel heap memory
is leaked when they are copied to user space in
ipddp\_ioctl(SIOCFINDIPDDPRT). Change kmalloc() to kzalloc() to clear
that memory.
Signed-off-by: Vlad Tsyrklevich
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c1dae9f5f4612a33a253e07f8fcd80cd39949f09
Author: David Forster
Date: Fri Jan 6 10:27:59 2017 +0000
vti6: fix device register to report IFLA\_INFO\_KIND
[ Upstream commit 93e246f783e6bd1bc64fdfbfe68b18161f69b28e ]
vti6 interface is registered before the rtnl\_link\_ops block
is attached. As a result the resulting RTM\_NEWLINK is missing
IFLA\_INFO\_KIND. Re-order attachment of rtnl\_link\_ops block to fix.
Signed-off-by: Dave Forster
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 63745efc72c36d450e46e2d710516de8a061054d
Author: Peter Ujfalusi
Date: Tue Jan 3 13:22:34 2017 +0200
ARM: OMAP1: DMA: Correct the number of logical channels
[ Upstream commit 657279778af54f35e54b07b6687918f254a2992c ]
OMAP1510, OMAP5910 and OMAP310 have only 9 logical channels.
OMAP1610, OMAP5912, OMAP1710, OMAP730, and OMAP850 have 16 logical channels
available.
The wired 17 for the lch\_count must have been used to cover the 16 + 1
dedicated LCD channel, in reality we can only use 9 or 16 channels.
The d->chan\_count is not used by the omap-dma stack, so we can skip the
setup. chan\_count was configured to the number of logical channels and not
the actual number of physical channels anyways.
Signed-off-by: Peter Ujfalusi
Acked-by: Aaro Koskinen
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit cbbdc8f66360272ad19f6094baaa61e457d16276
Author: Florian Fainelli
Date: Tue Jan 3 16:34:49 2017 -0800
net: systemport: Pad packet before inserting TSB
[ Upstream commit 38e5a85562a6cd911fc26d951d576551a688574c ]
Inserting the TSB means adding an extra 8 bytes in front the of packet
that is going to be used as metadata information by the TDMA engine, but
stripped off, so it does not really help with the packet padding.
For some odd packet sizes that fall below the 60 bytes payload (e.g: ARP)
we can end-up padding them after the TSB insertion, thus making them 64
bytes, but with the TDMA stripping off the first 8 bytes, they could
still be smaller than 64 bytes which is required to ingress the switch.
Fix this by swapping the padding and TSB insertion, guaranteeing that
the packets have the right sizes.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1e3183d48594ffbbf8c3393f18f1069176afee1c
Author: Florian Fainelli
Date: Tue Jan 3 16:34:48 2017 -0800
net: systemport: Utilize skb\_put\_padto()
[ Upstream commit bb7da333d0a9f3bddc08f84187b7579a3f68fd24 ]
Since we need to pad our packets, utilize skb\_put\_padto() which
increases skb->len by how much we need to pad, allowing us to eliminate
the test on skb->len right below.
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f553cd8397d90eea5580f6ea6cf4bd09ef24852f
Author: Masami Hiramatsu
Date: Tue Sep 19 19:01:40 2017 +0900
kprobes/x86: Disable preemption in ftrace-based jprobes
[ Upstream commit 5bb4fc2d8641219732eb2bb654206775a4219aca ]
Disable preemption in ftrace-based jprobe handlers as
described in Documentation/kprobes.txt:
"Probe handlers are run with preemption disabled."
This will fix jprobes behavior when CONFIG\_PREEMPT=y.
Signed-off-by: Masami Hiramatsu
Cc: Alexei Starovoitov
Cc: Alexei Starovoitov
Cc: Ananth N Mavinakayanahalli
Cc: Linus Torvalds
Cc: Paul E . McKenney
Cc: Peter Zijlstra
Cc: Steven Rostedt
Cc: Thomas Gleixner
Link: http://lkml.kernel.org/r/150581530024.32348.9863783558598926771.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 870743f8d9ad65f9bbde7832a5bfd5518ca35a67
Author: Thomas Richter
Date: Wed Sep 13 10:12:09 2017 +0200
perf test attr: Fix ignored test case result
[ Upstream commit 22905582f6dd4bbd0c370fe5732c607452010c04 ]
Command perf test -v 16 (Setup struct perf\_event\_attr test) always
reports success even if the test case fails. It works correctly if you
also specify -F (for don't fork).
root@s35lp76 perf]# ./perf test -v 16
15: Setup struct perf\_event\_attr :
--- start ---
running './tests/attr/test-record-no-delay'
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.002 MB /tmp/tmp4E1h7R/perf.data
(1 samples) ]
expected task=0, got 1
expected precise\_ip=0, got 3
expected wakeup\_events=1, got 0
FAILED './tests/attr/test-record-no-delay' - match failure
test child finished with 0
---- end ----
Setup struct perf\_event\_attr: Ok
The reason for the wrong error reporting is the return value of the
system() library call. It is called in run\_dir() file tests/attr.c and
returns the exit status, in above case 0xff00.
This value is given as parameter to the exit() function which can only
handle values 0-0xff.
The child process terminates with exit value of 0 and the parent does
not detect any error.
This patch corrects the error reporting and prints the correct test
result.
Signed-off-by: Thomas-Mich Richter
Acked-by: Jiri Olsa
Cc: Heiko Carstens
Cc: Hendrik Brueckner
Cc: Martin Schwidefsky
Cc: Thomas-Mich Richter
LPU-Reference: 20170913081209.39570-2-tmricht@linux.vnet.ibm.com
Link: http://lkml.kernel.org/n/tip-rdube6rfcjsr1nzue72c7lqn@git.kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit bc26e3e8be2ad05a6f6b508f0c3a862b44d85c86
Author: Jibin Xu
Date: Sun Sep 10 20:11:42 2017 -0700
sysrq : fix Show Regs call trace on ARM
[ Upstream commit b00bebbc301c8e1f74f230dc82282e56b7e7a6db ]
When kernel configuration SMP,PREEMPT and DEBUG\_PREEMPT are enabled,
echo 1 >/proc/sys/kernel/sysrq
echo p >/proc/sysrq-trigger
kernel will print call trace as below:
sysrq: SysRq : Show Regs
BUG: using \_\_this\_cpu\_read() in preemptible [00000000] code: sh/435
caller is \_\_this\_cpu\_preempt\_check+0x18/0x20
Call trace:
[] dump\_backtrace+0x0/0x1d0
[] show\_stack+0x24/0x30
[] dump\_stack+0x90/0xb0
[] check\_preemption\_disabled+0x100/0x108
[] \_\_this\_cpu\_preempt\_check+0x18/0x20
[] sysrq\_handle\_showregs+0x1c/0x40
[] \_\_handle\_sysrq+0x12c/0x1a0
[] write\_sysrq\_trigger+0x60/0x70
[] proc\_reg\_write+0x90/0xd0
[] \_\_vfs\_write+0x48/0x90
[] vfs\_write+0xa4/0x190
[] SyS\_write+0x54/0xb0
[] el0\_svc\_naked+0x24/0x28
This can be seen on a common board like an r-pi3.
This happens because when echo p >/proc/sysrq-trigger,
get\_irq\_regs() is called outside of IRQ context,
if preemption is enabled in this situation,kernel will
print the call trace. Since many prior discussions on
the mailing lists have made it clear that get\_irq\_regs
either just returns NULL or stale data when used outside
of IRQ context,we simply avoid calling it outside of
IRQ context.
Signed-off-by: Jibin Xu
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 668e191ced4dbf483fedb3f98920b014b1ecb446
Author: Gustavo A. R. Silva
Date: Mon Oct 16 12:40:29 2017 -0500
EDAC, sb\_edac: Fix missing break in switch
[ Upstream commit a8e9b186f153a44690ad0363a56716e7077ad28c ]
Add missing break statement in order to prevent the code from falling
through.
Signed-off-by: Gustavo A. R. Silva
Cc: Qiuxu Zhuo
Cc: linux-edac
Link: http://lkml.kernel.org/r/20171016174029.GA19757@embeddedor.com
Signed-off-by: Borislav Petkov
Signed-off-by: Sasha Levin
commit d65d97837a83dc61d60917b9eda9f5fe4d7dd7e4
Author: Hiromitsu Yamasaki
Date: Thu Nov 2 10:32:36 2017 +0100
spi: sh-msiof: Fix DMA transfer size check
[ Upstream commit 36735783fdb599c94b9c86824583df367c65900b ]
DMA supports 32-bit words only,
even if BITLEN1 of SITMDR2 register is 16bit.
Fixes: b0d0ce8b6b91 ("spi: sh-msiof: Add DMA support")
Signed-off-by: Hiromitsu Yamasaki
Signed-off-by: Simon Horman
Acked-by: Geert Uytterhoeven
Acked-by: Dirk Behme
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit bbf799a53f80fc15e256c30cb10bee1d5f80cfb3
Author: Lukas Wunner
Date: Sat Oct 28 11:35:49 2017 +0200
serial: 8250\_fintek: Fix rs485 disablement on invalid ioctl()
[ Upstream commit 3236a965486ba0c6043cf2c7b51943d8b382ae29 ]
This driver's ->rs485\_config callback checks if SER\_RS485\_RTS\_ON\_SEND
and SER\_RS485\_RTS\_AFTER\_SEND have the same value. If they do, it means
the user has passed in invalid data with the TIOCSRS485 ioctl()
since RTS must have a different polarity when sending and when not
sending. In this case, rs485 mode is not enabled (the RS485\_URA bit
is not set in the RS485 Enable Register) and this is supposed to be
signaled back to the user by clearing the SER\_RS485\_ENABLED bit in
struct serial\_rs485 ... except a missing tilde character is preventing
that from happening.
Fixes: 28e3fb6c4dce ("serial: Add support for Fintek F81216A LPC to 4 UART")
Cc: Ricardo Ribalda Delgado
Cc: "Ji-Ze Hong (Peter Hong)"
Signed-off-by: Lukas Wunner
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 282dc3f75ee440d2c74427546ccc76237b843e1f
Author: Christian Borntraeger
Date: Mon Oct 30 14:38:58 2017 +0100
s390/pci: do not require AIS facility
[ Upstream commit 48070c73058be6de9c0d754d441ed7092dfc8f12 ]
As of today QEMU does not provide the AIS facility to its guest. This
prevents Linux guests from using PCI devices as the ais facility is
checked during init. As this is just a performance optimization, we can
move the ais check into the code where we need it (calling the SIC
instruction). This is used at initialization and on interrupt. Both
places do not require any serialization, so we can simply skip the
instruction.
Since we will now get all interrupts, we can also avoid the 2nd scan.
As we can have multiple interrupts in parallel we might trigger spurious
irqs more often for the non-AIS case but the core code can handle that.
Signed-off-by: Christian Borntraeger
Reviewed-by: Pierre Morel
Reviewed-by: Halil Pasic
Acked-by: Sebastian Ott
Signed-off-by: Heiko Carstens
Signed-off-by: Sasha Levin
commit 1203cd50416157f5dba4742a7c50b2a6c9efd344
Author: Boshi Wang
Date: Fri Oct 20 16:01:03 2017 +0800
ima: fix hash algorithm initialization
[ Upstream commit ebe7c0a7be92bbd34c6ff5b55810546a0ee05bee ]
The hash\_setup function always sets the hash\_setup\_done flag, even
when the hash algorithm is invalid. This prevents the default hash
algorithm defined as CONFIG\_IMA\_DEFAULT\_HASH from being used.
This patch sets hash\_setup\_done flag only for valid hash algorithms.
Fixes: e7a2ad7eb6f4 "ima: enable support for larger default filedata hash
algorithms"
Signed-off-by: Boshi Wang
Signed-off-by: Mimi Zohar
Signed-off-by: Sasha Levin
commit 553111085c72988d535381aa679dfddee39c24b0
Author: Matt Wilson
Date: Mon Nov 13 11:31:31 2017 -0800
serial: 8250\_pci: Add Amazon PCI serial device ID
[ Upstream commit 3bfd1300abfe3adb18e84a89d97a0e82a22124bb ]
This device will be used in future Amazon EC2 instances as the primary
serial port (i.e., data sent to this port will be available via the
GetConsoleOuput [1] EC2 API).
[1] http://docs.aws.amazon.com/AWSEC2/latest/APIReference/API\_GetConsoleOutput.html
Cc: stable
Signed-off-by: Matt Wilson
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit eba5e6ff42d9bd8c33b301d4bd6ebd1892bd1b80
Author: Kai-Heng Feng
Date: Tue Nov 14 01:31:15 2017 -0500
usb: quirks: Add no-lpm quirk for KY-688 USB 3.1 Type-C Hub
[ Upstream commit e43a12f1793ae1fe006e26fe9327a8840a92233c ]
KY-688 USB 3.1 Type-C Hub internally uses a Genesys Logic hub to connect
to Realtek r8153.
Similar to commit ("7496cfe5431f2 usb: quirks: Add no-lpm quirk for Moshi
USB to Ethernet Adapter"), no-lpm can make r8153 ethernet work.
Signed-off-by: Kai-Heng Feng
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit b55902dd3ce515ee45177c2926358fe0fb077d27
Author: Hans de Goede
Date: Tue Nov 14 19:27:22 2017 +0100
uas: Always apply US\_FL\_NO\_ATA\_1X quirk to Seagate devices
[ Upstream commit 7fee72d5e8f1e7b8d8212e28291b1a0243ecf2f1 ]
We've been adding this as a quirk on a per device basis hoping that
newer disk enclosures would do better, but that has not happened,
so simply apply this quirk to all Seagate devices.
Signed-off-by: Hans de Goede
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 37993da309a63f734578df21e2541094ad39d7f2
Author: Rui Hua
Date: Fri Nov 24 15:14:26 2017 -0800
bcache: recover data from backing when data is clean
[ Upstream commit e393aa2446150536929140739f09c6ecbcbea7f0 ]
When we send a read request and hit the clean data in cache device, there
is a situation called cache read race in bcache(see the commit in the tail
of cache\_look\_up(), the following explaination just copy from there):
The bucket we're reading from might be reused while our bio is in flight,
and we could then end up reading the wrong data. We guard against this
by checking (in bch\_cache\_read\_endio()) if the pointer is stale again;
if so, we treat it as an error (s->iop.error = -EINTR) and reread from
the backing device (but we don't pass that error up anywhere)
It should be noted that cache read race happened under normal
circumstances, not the circumstance when SSD failed, it was counted
and shown in /sys/fs/bcache/XXX/internal/cache\_read\_races.
Without this patch, when we use writeback mode, we will never reread from
the backing device when cache read race happened, until the whole cache
device is clean, because the condition
(s->recoverable && (dc && !atomic\_read(&dc->has\_dirty))) is false in
cached\_dev\_read\_error(). In this situation, the s->iop.error(= -EINTR)
will be passed up, at last, user will receive -EINTR when it's bio end,
this is not suitable, and wield to up-application.
In this patch, we use s->read\_dirty\_data to judge whether the read
request hit dirty data in cache device, it is safe to reread data from
the backing device when the read request hit clean data. This can not
only handle cache read race, but also recover data when failed read
request from cache device.
[edited by mlyle to fix up whitespace, commit log title, comment
spelling]
Fixes: d59b23795933 ("bcache: only permit to recovery read error when cache device is clean")
Cc:  # 4.14
Signed-off-by: Hua Rui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Michael Lyle
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 151eae0b40efbc839f0eadfb72032560fc44e2fb
Author: Coly Li
Date: Mon Oct 30 14:46:31 2017 -0700
bcache: only permit to recovery read error when cache device is clean
[ Upstream commit d59b23795933678c9638fd20c942d2b4f3cd6185 ]
When bcache does read I/Os, for example in writeback or writethrough mode,
if a read request on cache device is failed, bcache will try to recovery
the request by reading from cached device. If the data on cached device is
not synced with cache device, then requester will get a stale data.
For critical storage system like database, providing stale data from
recovery may result an application level data corruption, which is
unacceptible.
With this patch, for a failed read request in writeback or writethrough
mode, recovery a recoverable read request only happens when cache device
is clean. That is to say, all data on cached device is up to update.
For other cache modes in bcache, read request will never hit
cached\_dev\_read\_error(), they don't need this patch.
Please note, because cache mode can be switched arbitrarily in run time, a
writethrough mode might be switched from a writeback mode. Therefore
checking dc->has\_data in writethrough mode still makes sense.
Changelog:
V4: Fix parens error pointed by Michael Lyle.
v3: By response from Kent Oversteet, he thinks recovering stale data is a
bug to fix, and option to permit it is unnecessary. So this version
the sysfs file is removed.
v2: rename sysfs entry from allow\_stale\_data\_on\_failure to
allow\_stale\_data\_on\_failure, and fix the confusing commit log.
v1: initial patch posted.
[small change to patch comment spelling by mlyle]
Signed-off-by: Coly Li
Signed-off-by: Michael Lyle
Reported-by: Arne Wolf
Reviewed-by: Michael Lyle
Cc: Kent Overstreet
Cc: Nix
Cc: Kai Krakow
Cc: Eric Wheeler
Cc: Junhui Tang
Cc: stable@vger.kernel.org
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit d0dc056013e2601e645f6ac87decf279107199c9
Author: Tang Junhui
Date: Wed Sep 6 14:25:53 2017 +0800
bcache: do not subtract sectors\_to\_gc for bypassed IO
[ Upstream commit 69daf03adef5f7bc13e0ac86b4b8007df1767aab ]
Since bypassed IOs use no bucket, so do not subtract sectors\_to\_gc to
trigger gc thread.
Signed-off-by: tang.junhui
Acked-by: Coly Li
Reviewed-by: Eric Wheeler
Reviewed-by: Christoph Hellwig
Cc: stable@vger.kernel.org
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 7633901a23e975811e78ce4bc46e623dc79cbe3b
Author: WANG Cong
Date: Sat Jun 24 23:50:30 2017 -0700
tcp: reset sk\_rx\_dst in tcp\_disconnect()
[ Upstream commit d747a7a51b00984127a88113cdbbc26f91e9d815 ]
We have to reset the sk->sk\_rx\_dst when we disconnect a TCP
connection, because otherwise when we re-connect it this
dst reference is simply overridden in tcp\_finish\_connect().
This fixes a dst leak which leads to a loopback dev refcnt
leak. It is a long-standing bug, Kevin reported a very similar
(if not same) bug before. Thanks to Andrei for providing such
a reliable reproducer which greatly narrows down the problem.
Fixes: 41063e9dd119 ("ipv4: Early TCP socket demux.")
Reported-by: Andrei Vagin
Reported-by: Kevin Xu
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5615a7bebb369bd9e09f2f1311f70eb8cdae4bb6
Author: WANG Cong
Date: Wed Jun 21 14:34:58 2017 -0700
ipv6: avoid unregistering inet6\_dev for loopback
[ Upstream commit 60abc0be96e00ca71bac083215ac91ad2e575096 ]
The per netns loopback\_dev->ip6\_ptr is unregistered and set to
NULL when its mtu is set to smaller than IPV6\_MIN\_MTU, this
leads to that we could set rt->rt6i\_idev NULL after a
rt6\_uncached\_list\_flush\_dev() and then crash after another
call.
In this case we should just bring its inet6\_dev down, rather
than unregistering it, at least prior to commit 176c39af29bc
("netns: fix addrconf\_ifdown kernel panic") we always
override the case for loopback.
Thanks a lot to Andrey for finding a reliable reproducer.
Fixes: 176c39af29bc ("netns: fix addrconf\_ifdown kernel panic")
Reported-by: Andrey Konovalov
Cc: Andrey Konovalov
Cc: Daniel Lezcano
Cc: David Ahern
Signed-off-by: Cong Wang
Acked-by: David Ahern
Tested-by: Andrey Konovalov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5ff32f710c40f59ff7021f9e66b76c708515cb48
Author: Russell King
Date: Tue May 30 16:21:51 2017 +0100
net: phy: fix marvell phy status reading
[ Upstream commit 898805e0cdf7fd860ec21bf661d3a0285a3defbd ]
The Marvell driver incorrectly provides phydev->lp\_advertising as the
logical and of the link partner's advert and our advert. This is
incorrect - this field is supposed to store the link parter's unmodified
advertisment.
This allows ethtool to report the correct link partner auto-negotiation
status.
Fixes: be937f1f89ca ("Marvell PHY m88e1111 driver fix")
Signed-off-by: Russell King
Reviewed-by: Andrew Lunn
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 62437482578a9c221c8162e4cb0c3fc7d0f8a605
Author: Kristina Martsenko
Date: Wed May 3 16:37:46 2017 +0100
arm64: hw\_breakpoint: fix watchpoint matching for tagged pointers
[ Upstream commit 7dcd9dd8cebe9fa626af7e2358d03a37041a70fb ]
When we take a watchpoint exception, the address that triggered the
watchpoint is found in FAR\_EL1. We compare it to the address of each
configured watchpoint to see which one was hit.
The configured watchpoint addresses are untagged, while the address in
FAR\_EL1 will have an address tag if the data access was done using a
tagged address. The tag needs to be removed to compare the address to
the watchpoints.
Currently we don't remove it, and as a result can report the wrong
watchpoint as being hit (specifically, always either the highest TTBR0
watchpoint or lowest TTBR1 watchpoint). This patch removes the tag.
Fixes: d50240a5f6ce ("arm64: mm: permit use of tagged pointers at EL0")
Cc:  # 3.12.x-
Acked-by: Mark Rutland
Acked-by: Will Deacon
Signed-off-by: Kristina Martsenko
Signed-off-by: Catalin Marinas
Signed-off-by: Sasha Levin
commit c19aa530105b0d780ad72a78a7ef271037bcb774
Author: Eric Biggers
Date: Thu Jun 8 14:48:40 2017 +0100
KEYS: fix dereferencing NULL payload with nonzero length
[ Upstream commit 5649645d725c73df4302428ee4e02c869248b4c5 ]
sys\_add\_key() and the KEYCTL\_UPDATE operation of sys\_keyctl() allowed a
NULL payload with nonzero length to be passed to the key type's
->preparse(), ->instantiate(), and/or ->update() methods. Various key
types including asymmetric, cifs.idmap, cifs.spnego, and pkcs7\_test did
not handle this case, allowing an unprivileged user to trivially cause a
NULL pointer dereference (kernel oops) if one of these key types was
present. Fix it by doing the copy\_from\_user() when 'plen' is nonzero
rather than when '\_payload' is non-NULL, causing the syscall to fail
with EFAULT as expected when an invalid buffer is specified.
Cc: stable@vger.kernel.org # 2.6.10+
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
commit a5e71be0786d72497535db1d79678feb9ca7bda5
Author: Gabriel Krisman Bertazi
Date: Wed Dec 28 16:42:00 2016 -0200
8250\_pci: Fix potential use-after-free in error path
[ Upstream commit c130b666a9a711f985a0a44b58699ebe14bb7245 ]
Commit f209fa03fc9d ("serial: 8250\_pci: Detach low-level driver during
PCI error recovery") introduces a potential use-after-free in case the
pciserial\_init\_ports call in serial8250\_io\_resume fails, which may
happen if a memory allocation fails or if the .init quirk failed for
whatever reason). If this happen, further pci\_get\_drvdata will return a
pointer to freed memory.
This patch reworks the PCI recovery resume hook to restore the old priv
structure in this case, which should be ok, since the ports were already
detached. Such error during recovery causes us to give up on the
recovery.
Fixes: f209fa03fc9d ("serial: 8250\_pci: Detach low-level driver during
PCI error recovery")
Reported-by: Michal Suchanek
Signed-off-by: Gabriel Krisman Bertazi
Signed-off-by: Guilherme G. Piccoli
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit c87134f416a6c3b302bed97d38977c9845171d38
Author: Jason A. Donenfeld
Date: Thu Mar 23 12:24:43 2017 +0100
padata: avoid race in reordering
[ Upstream commit de5540d088fe97ad583cc7d396586437b32149a5 ]
Under extremely heavy uses of padata, crashes occur, and with list
debugging turned on, this happens instead:
[87487.298728] WARNING: CPU: 1 PID: 882 at lib/list\_debug.c:33
\_\_list\_add+0xae/0x130
[87487.301868] list\_add corruption. prev->next should be next
(ffffb17abfc043d0), but was ffff8dba70872c80. (prev=ffff8dba70872b00).
[87487.339011] [] dump\_stack+0x68/0xa3
[87487.342198] [] ? console\_unlock+0x281/0x6d0
[87487.345364] [] \_\_warn+0xff/0x140
[87487.348513] [] warn\_slowpath\_fmt+0x4a/0x50
[87487.351659] [] \_\_list\_add+0xae/0x130
[87487.354772] [] ? \_raw\_spin\_lock+0x64/0x70
[87487.357915] [] padata\_reorder+0x1e6/0x420
[87487.361084] [] padata\_do\_serial+0xa5/0x120
padata\_reorder calls list\_add\_tail with the list to which its adding
locked, which seems correct:
spin\_lock(&squeue->serial.lock);
list\_add\_tail(&padata->list, &squeue->serial.list);
spin\_unlock(&squeue->serial.lock);
This therefore leaves only place where such inconsistency could occur:
if padata->list is added at the same time on two different threads.
This pdata pointer comes from the function call to
padata\_get\_next(pd), which has in it the following block:
next\_queue = per\_cpu\_ptr(pd->pqueue, cpu);
padata = NULL;
reorder = &next\_queue->reorder;
if (!list\_empty(&reorder->list)) {
padata = list\_entry(reorder->list.next,
struct padata\_priv, list);
spin\_lock(&reorder->lock);
list\_del\_init(&padata->list);
atomic\_dec(&pd->reorder\_objects);
spin\_unlock(&reorder->lock);
pd->processed++;
goto out;
}
out:
return padata;
I strongly suspect that the problem here is that two threads can race
on reorder list. Even though the deletion is locked, call to
list\_entry is not locked, which means it's feasible that two threads
pick up the same padata object and subsequently call list\_add\_tail on
them at the same time. The fix is thus be hoist that lock outside of
that block.
Signed-off-by: Jason A. Donenfeld
Acked-by: Steffen Klassert
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit b3282b3115cdd97609cbf3491995c5cc2bb57660
Author: David Hildenbrand
Date: Thu Mar 23 18:24:19 2017 +0100
KVM: kvm\_io\_bus\_unregister\_dev() should never fail
[ Upstream commit 90db10434b163e46da413d34db8d0e77404cc645 ]
No caller currently checks the return value of
kvm\_io\_bus\_unregister\_dev(). This is evil, as all callers silently go on
freeing their device. A stale reference will remain in the io\_bus,
getting at least used again, when the iobus gets teared down on
kvm\_destroy\_vm() - leading to use after free errors.
There is nothing the callers could do, except retrying over and over
again.
So let's simply remove the bus altogether, print an error and make
sure no one can access this broken bus again (returning -ENOMEM on any
attempt to access it).
Fixes: e93f8a0f821e ("KVM: convert io\_bus to SRCU")
Cc: stable@vger.kernel.org # 3.4+
Reported-by: Dmitry Vyukov
Reviewed-by: Cornelia Huck
Signed-off-by: David Hildenbrand
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 4decce66d9e0542d75debac85998aa68b6753504
Author: Uwe Kleine-König
Date: Sat Jul 2 17:28:10 2016 +0200
rtc: s35390a: improve irq handling
[ Upstream commit 3bd32722c827d00eafe8e6d5b83e9f3148ea7c7e ]
On some QNAP NAS devices the rtc can wake the machine. Several people
noticed that once the machine was woken this way it fails to shut down.
That's because the driver fails to acknowledge the interrupt and so it
keeps active and restarts the machine immediatly after shutdown. See
https://bugs.debian.org/794266 for a bug report.
Doing this correctly requires to interpret the INT2 flag of the first read
of the STATUS1 register because this bit is cleared by read.
Note this is not maximally robust though because a pending irq isn't
detected when the STATUS1 register was already read (and so INT2 is not
set) but the irq was not disabled. But that is a hardware imposed problem
that cannot easily be fixed by software.
Signed-off-by: Uwe Kleine-König
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
commit a740217c448eb1b16b7bca95d55d212e6772bf44
Author: Uwe Kleine-König
Date: Sat Jul 2 17:28:09 2016 +0200
rtc: s35390a: implement reset routine as suggested by the reference
[ Upstream commit 8e6583f1b5d1f5f129b873f1428b7e414263d847 ]
There were two deviations from the reference manual: you have to wait
half a second when POC is active and you might have to repeat
initialization when POC or BLD are still set after the sequence.
Note however that as POC and BLD are cleared by read the driver might
not be able to detect that a reset is necessary. I don't have a good
idea how to fix this.
Additionally report the value read from STATUS1 to the caller. This
prepares the next patch.
Signed-off-by: Uwe Kleine-König
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
commit 7b1ae699502eb7ef1ac9911567d199b23420c87d
Author: Uwe Kleine-König
Date: Sat Jul 2 17:28:08 2016 +0200
rtc: s35390a: fix reading out alarm
[ Upstream commit f87e904ddd8f0ef120e46045b0addeb1cc88354e ]
There are several issues fixed in this patch:
- When alarm isn't enabled, set .enabled to zero instead of returning
-EINVAL.
- Ignore how IRQ1 is configured when determining if IRQ2 is on.
- The three alarm registers have an enable flag which must be
evaluated.
- The chip always triggers when the seconds register gets 0.
Note that the rtc framework however doesn't handle the result correctly
because it doesn't check wday being initialized and so interprets an
alarm being set for 10:00 AM in three days as 10:00 AM tomorrow (or
today if that's not over yet).
Signed-off-by: Uwe Kleine-König
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
commit 74f74c6040e0d6dd326793e7ad2976af33baba73
Author: Felix Fietkau
Date: Thu Jan 19 12:28:22 2017 +0100
MIPS: Lantiq: Fix cascaded IRQ setup
[ Upstream commit 6c356eda225e3ee134ed4176b9ae3a76f793f4dd ]
With the IRQ stack changes integrated, the XRX200 devices started
emitting a constant stream of kernel messages like this:
[ 565.415310] Spurious IRQ: CAUSE=0x1100c300
This is caused by IP0 getting handled by plat\_irq\_dispatch() rather than
its vectored interrupt handler, which is fixed by commit de856416e714
("MIPS: IRQ Stack: Fix erroneous jal to plat\_irq\_dispatch").
Fix plat\_irq\_dispatch() to handle non-vectored IPI interrupts correctly
by setting up IP2-6 as proper chained IRQ handlers and calling do\_IRQ
for all MIPS CPU interrupts.
Signed-off-by: Felix Fietkau
Acked-by: John Crispin
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/15077/
[james.hogan@imgtec.com: tweaked commit message]
Signed-off-by: James Hogan
Signed-off-by: Sasha Levin
commit b5fa0ad35bff76260919cd94812bcd4d0af5eadc
Author: Peter Xu
Date: Wed Mar 15 16:01:17 2017 +0800
KVM: x86: clear bus pointer when destroyed
[ Upstream commit df630b8c1e851b5e265dc2ca9c87222e342c093b ]
When releasing the bus, let's clear the bus pointers to mark it out. If
any further device unregister happens on this bus, we know that we're
done if we found the bus being released already.
Signed-off-by: Peter Xu
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
commit 269e73f9e8bf03f6bbb139b16e53d29e7f45e372
Author: Ilya Dryomov
Date: Tue Mar 21 13:44:28 2017 +0100
libceph: force GFP\_NOIO for socket allocations
[ Upstream commit 633ee407b9d15a75ac9740ba9d3338815e1fcb95 ]
sock\_alloc\_inode() allocates socket+inode and socket\_wq with
GFP\_KERNEL, which is not allowed on the writeback path:
Workqueue: ceph-msgr con\_work [libceph]
ffff8810871cb018 0000000000000046 0000000000000000 ffff881085d40000
0000000000012b00 ffff881025cad428 ffff8810871cbfd8 0000000000012b00
ffff880102fc1000 ffff881085d40000 ffff8810871cb038 ffff8810871cb148
Call Trace:
[] schedule+0x29/0x70
[] schedule\_timeout+0x1bd/0x200
[] ? ttwu\_do\_wakeup+0x2c/0x120
[] ? ttwu\_do\_activate.constprop.135+0x66/0x70
[] wait\_for\_completion+0xbf/0x180
[] ? try\_to\_wake\_up+0x390/0x390
[] flush\_work+0x165/0x250
[] ? worker\_detach\_from\_pool+0xd0/0xd0
[] xlog\_cil\_force\_lsn+0x81/0x200 [xfs]
[] ? \_\_slab\_free+0xee/0x234
[] \_xfs\_log\_force\_lsn+0x4d/0x2c0 [xfs]
[] ? lookup\_page\_cgroup\_used+0xe/0x30
[] ? xfs\_reclaim\_inode+0xa3/0x330 [xfs]
[] xfs\_log\_force\_lsn+0x3f/0xf0 [xfs]
[] ? xfs\_reclaim\_inode+0xa3/0x330 [xfs]
[] xfs\_iunpin\_wait+0xc6/0x1a0 [xfs]
[] ? wake\_atomic\_t\_function+0x40/0x40
[] xfs\_reclaim\_inode+0xa3/0x330 [xfs]
[] xfs\_reclaim\_inodes\_ag+0x257/0x3d0 [xfs]
[] xfs\_reclaim\_inodes\_nr+0x33/0x40 [xfs]
[] xfs\_fs\_free\_cached\_objects+0x15/0x20 [xfs]
[] super\_cache\_scan+0x178/0x180
[] shrink\_slab\_node+0x14e/0x340
[] ? mem\_cgroup\_iter+0x16b/0x450
[] shrink\_slab+0x100/0x140
[] do\_try\_to\_free\_pages+0x335/0x490
[] try\_to\_free\_pages+0xb9/0x1f0
[] ? \_\_alloc\_pages\_direct\_compact+0x69/0x1be
[] \_\_alloc\_pages\_nodemask+0x69a/0xb40
[] alloc\_pages\_current+0x9e/0x110
[] new\_slab+0x2c5/0x390
[] \_\_slab\_alloc+0x33b/0x459
[] ? sock\_alloc\_inode+0x2d/0xd0
[] ? inet\_sendmsg+0x71/0xc0
[] ? sock\_alloc\_inode+0x2d/0xd0
[] kmem\_cache\_alloc+0x1a2/0x1b0
[] sock\_alloc\_inode+0x2d/0xd0
[] alloc\_inode+0x26/0xa0
[] new\_inode\_pseudo+0x1a/0x70
[] sock\_alloc+0x1e/0x80
[] \_\_sock\_create+0x95/0x220
[] sock\_create\_kern+0x24/0x30
[] con\_work+0xef9/0x2050 [libceph]
[] ? rbd\_img\_request\_submit+0x4c/0x60 [rbd]
[] process\_one\_work+0x159/0x4f0
[] worker\_thread+0x11b/0x530
[] ? create\_worker+0x1d0/0x1d0
[] kthread+0xc9/0xe0
[] ? flush\_kthread\_worker+0x90/0x90
[] ret\_from\_fork+0x58/0x90
[] ? flush\_kthread\_worker+0x90/0x90
Use memalloc\_noio\_{save,restore}() to temporarily force GFP\_NOIO here.
Cc: stable@vger.kernel.org # 3.10+, needs backporting
Link: http://tracker.ceph.com/issues/19309
Reported-by: Sergey Jerusalimov
Signed-off-by: Ilya Dryomov
Reviewed-by: Jeff Layton
Signed-off-by: Sasha Levin
commit 21af28db5ef7c8bed49f9dfaaa9ad410032b635e
Author: Dave Martin
Date: Mon Mar 27 15:10:57 2017 +0100
metag/ptrace: Reject partial NT\_METAG\_RPIPE writes
[ Upstream commit 7195ee3120d878259e8d94a5d9f808116f34d5ea ]
It's not clear what behaviour is sensible when doing partial write of
NT\_METAG\_RPIPE, so just don't bother.
This patch assumes that userspace will never rely on a partial SETREGSET
in this case, since it's not clear what should happen anyway.
Signed-off-by: Dave Martin
Acked-by: James Hogan
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 6779b4582eca8357ee731e95185c0f9f20abf71b
Author: Dave Martin
Date: Mon Mar 27 15:10:56 2017 +0100
metag/ptrace: Provide default TXSTATUS for short NT\_PRSTATUS
[ Upstream commit 5fe81fe98123ce41265c65e95d34418d30d005d1 ]
Ensure that if userspace supplies insufficient data to PTRACE\_SETREGSET
to fill TXSTATUS, a well-defined default value is used, based on the
task's current value.
Suggested-by: James Hogan
Signed-off-by: Dave Martin
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit e77d1491b2a00f9edfbcd53c232ad714afca87a2
Author: Dave Martin
Date: Mon Mar 27 15:10:55 2017 +0100
metag/ptrace: Preserve previous registers for short regset write
[ Upstream commit a78ce80d2c9178351b34d78fec805140c29c193e ]
Ensure that if userspace supplies insufficient data to PTRACE\_SETREGSET
to fill all the registers, the thread's old registers are preserved.
Signed-off-by: Dave Martin
Acked-by: James Hogan
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 3da09f082fb3fa5789b4c6bb5abd90c392cf7d26
Author: Dave Martin
Date: Mon Mar 27 15:10:59 2017 +0100
sparc/ptrace: Preserve previous registers for short regset write
[ Upstream commit d3805c546b275c8cc7d40f759d029ae92c7175f2 ]
Ensure that if userspace supplies insufficient data to PTRACE\_SETREGSET
to fill all the registers, the thread's old registers are preserved.
Signed-off-by: Dave Martin
Acked-by: David S. Miller
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 0585334e230df59103088ce48f018a19fdd8f664
Author: Dave Martin
Date: Mon Mar 27 15:10:58 2017 +0100
mips/ptrace: Preserve previous registers for short regset write
[ Upstream commit d614fd58a2834cfe4efa472c33c8f3ce2338b09b ]
Ensure that if userspace supplies insufficient data to PTRACE\_SETREGSET
to fill all the registers, the thread's old registers are preserved.
Signed-off-by: Dave Martin
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 48dd0fe903bfb00cc7460eb57ac33f24451dcb35
Author: Dave Martin
Date: Mon Mar 27 15:10:53 2017 +0100
c6x/ptrace: Remove useless PTRACE\_SETREGSET implementation
[ Upstream commit fb411b837b587a32046dc4f369acb93a10b1def8 ]
gpr\_set won't work correctly and can never have been tested, and the
correct behaviour is not clear due to the endianness-dependent task
layout.
So, just remove it. The core code will now return -EOPNOTSUPPORT when
trying to set NT\_PRSTATUS on this architecture until/unless a correct
implementation is supplied.
Signed-off-by: Dave Martin
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 171a957989c4f398adb41078dbfff73b0821e383
Author: Andy Whitcroft
Date: Thu Mar 23 07:45:44 2017 +0000
xfrm\_user: validate XFRM\_MSG\_NEWAE incoming ESN size harder
[ Upstream commit f843ee6dd019bcece3e74e76ad9df0155655d0df ]
Kees Cook has pointed out that xfrm\_replay\_state\_esn\_len() is subject to
wrapping issues. To ensure we are correctly ensuring that the two ESN
structures are the same size compare both the overall size as reported
by xfrm\_replay\_state\_esn\_len() and the internal length are the same.
CVE-2017-7184
Signed-off-by: Andy Whitcroft
Acked-by: Steffen Klassert
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 438db92d7f2792e3bad17be70e6edf0f44a081f0
Author: Andy Whitcroft
Date: Wed Mar 22 07:29:31 2017 +0000
xfrm\_user: validate XFRM\_MSG\_NEWAE XFRMA\_REPLAY\_ESN\_VAL replay\_window
[ Upstream commit 677e806da4d916052585301785d847c3b3e6186a ]
When a new xfrm state is created during an XFRM\_MSG\_NEWSA call we
validate the user supplied replay\_esn to ensure that the size is valid
and to ensure that the replay\_window size is within the allocated
buffer. However later it is possible to update this replay\_esn via a
XFRM\_MSG\_NEWAE call. There we again validate the size of the supplied
buffer matches the existing state and if so inject the contents. We do
not at this point check that the replay\_window is within the allocated
memory. This leads to out-of-bounds reads and writes triggered by
netlink packets. This leads to memory corruption and the potential for
priviledge escalation.
We already attempt to validate the incoming replay information in
xfrm\_new\_ae() via xfrm\_replay\_verify\_len(). This confirms that the user
is not trying to change the size of the replay state buffer which
includes the replay\_esn. It however does not check the replay\_window
remains within that buffer. Add validation of the contained
replay\_window.
CVE-2017-7184
Signed-off-by: Andy Whitcroft
Acked-by: Steffen Klassert
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 5847973a96fdce329f1f589b481d6373d3e692e5
Author: Florian Westphal
Date: Wed Feb 8 11:52:29 2017 +0100
xfrm: policy: init locks early
[ Upstream commit c282222a45cb9503cbfbebfdb60491f06ae84b49 ]
Dmitry reports following splat:
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 13059 Comm: syz-executor1 Not tainted 4.10.0-rc7-next-20170207 #1
[..]
spin\_lock\_bh include/linux/spinlock.h:304 [inline]
xfrm\_policy\_flush+0x32/0x470 net/xfrm/xfrm\_policy.c:963
xfrm\_policy\_fini+0xbf/0x560 net/xfrm/xfrm\_policy.c:3041
xfrm\_net\_init+0x79f/0x9e0 net/xfrm/xfrm\_policy.c:3091
ops\_init+0x10a/0x530 net/core/net\_namespace.c:115
setup\_net+0x2ed/0x690 net/core/net\_namespace.c:291
copy\_net\_ns+0x26c/0x530 net/core/net\_namespace.c:396
create\_new\_namespaces+0x409/0x860 kernel/nsproxy.c:106
unshare\_nsproxy\_namespaces+0xae/0x1e0 kernel/nsproxy.c:205
SYSC\_unshare kernel/fork.c:2281 [inline]
Problem is that when we get error during xfrm\_net\_init we will call
xfrm\_policy\_fini which will acquire xfrm\_policy\_lock before it was
initialized. Just move it around so locks get set up first.
Reported-by: Dmitry Vyukov
Fixes: 283bc9f35bbbcb0e9 ("xfrm: Namespacify xfrm state/policy locks")
Signed-off-by: Florian Westphal
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 2832213a871a607243a257dd5b5015be7c2d9d57
Author: Jiri Slaby
Date: Thu Dec 15 14:31:01 2016 +0100
crypto: algif\_hash - avoid zero-sized array
[ Upstream commit 6207119444595d287b1e9e83a2066c17209698f3 ]
With this reproducer:
struct sockaddr\_alg alg = {
.salg\_family = 0x26,
.salg\_type = "hash",
.salg\_feat = 0xf,
.salg\_mask = 0x5,
.salg\_name = "digest\_null",
};
int sock, sock2;
sock = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(sock, (struct sockaddr \*)&alg, sizeof(alg));
sock2 = accept(sock, NULL, NULL);
setsockopt(sock, SOL\_ALG, ALG\_SET\_KEY, "\x9b\xca", 2);
accept(sock2, NULL, NULL);
==== 8< ======== 8< ======== 8< ======== 8< ====
one can immediatelly see an UBSAN warning:
UBSAN: Undefined behaviour in crypto/algif\_hash.c:187:7
variable length array bound value 0 <= 0
CPU: 0 PID: 15949 Comm: syz-executor Tainted: G E 4.4.30-0-default #1
...
Call Trace:
...
[] ? \_\_ubsan\_handle\_vla\_bound\_not\_positive+0x13d/0x188
[] ? \_\_ubsan\_handle\_out\_of\_bounds+0x1bc/0x1bc
[] ? hash\_accept+0x5bd/0x7d0 [algif\_hash]
[] ? hash\_accept\_nokey+0x3f/0x51 [algif\_hash]
[] ? hash\_accept\_parent\_nokey+0x4a0/0x4a0 [algif\_hash]
[] ? SyS\_accept+0x2b/0x40
It is a correct warning, as hash state is propagated to accept as zero,
but creating a zero-length variable array is not allowed in C.
Fix this as proposed by Herbert -- do "?: 1" on that site. No sizeof or
similar happens in the code there, so we just allocate one byte even
though we do not use the array.
Signed-off-by: Jiri Slaby
Cc: Herbert Xu
Cc: "David S. Miller"  (maintainer:CRYPTO API)
Reported-by: Sasha Levin
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 4ebd212334f5fb10d3ea458f48c2520bd437a943
Author: Takashi Iwai
Date: Wed Jan 11 17:09:50 2017 +0100
fbcon: Fix vc attr at deinit
[ Upstream commit 8aac7f34369726d1a158788ae8aff3002d5eb528 ]
fbcon can deal with vc\_hi\_font\_mask (the upper 256 chars) and adjust
the vc attrs dynamically when vc\_hi\_font\_mask is changed at
fbcon\_init(). When the vc\_hi\_font\_mask is set, it remaps the attrs in
the existing console buffer with one bit shift up (for 9 bits), while
it remaps with one bit shift down (for 8 bits) when the value is
cleared. It works fine as long as the font gets updated after fbcon
was initialized.
However, we hit a bizarre problem when the console is switched to
another fb driver (typically from vesafb or efifb to drmfb). At
switching to the new fb driver, we temporarily rebind the console to
the dummy console, then rebind to the new driver. During the
switching, we leave the modified attrs as is. Thus, the new fbcon
takes over the old buffer as if it were to contain 8 bits chars
(although the attrs are still shifted for 9 bits), and effectively
this results in the yellow color texts instead of the original white
color, as found in the bugzilla entry below.
An easy fix for this is to re-adjust the attrs before leaving the
fbcon at con\_deinit callback. Since the code to adjust the attrs is
already present in the current fbcon code, in this patch, we simply
factor out the relevant code, and call it from fbcon\_deinit().
Bugzilla: https://bugzilla.suse.com/show\_bug.cgi?id=1000619
Signed-off-by: Takashi Iwai
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
commit 7d6b48119b43368dd3f886c84d16361eefb84f10
Author: Sumit Semwal
Date: Sat Mar 25 21:48:19 2017 +0530
serial: 8250\_pci: Detach low-level driver during PCI error recovery
[ Upstream commit f209fa03fc9d131b3108c2e4936181eabab87416 ]
During a PCI error recovery, like the ones provoked by EEH in the ppc64
platform, all IO to the device must be blocked while the recovery is
completed. Current 8250\_pci implementation only suspends the port
instead of detaching it, which doesn't prevent incoming accesses like
TIOCMGET and TIOCMSET calls from reaching the device. Those end up
racing with the EEH recovery, crashing it. Similar races were also
observed when opening the device and when shutting it down during
recovery.
This patch implements a more robust IO blockage for the 8250\_pci
recovery by unregistering the port at the beginning of the procedure and
re-adding it afterwards. Since the port is detached from the uart
layer, we can be sure that no request will make through to the device
during recovery. This is similar to the solution used by the JSM serial
driver.
I thank Peter Hurley  for valuable input on
this one over one year ago.
Signed-off-by: Gabriel Krisman Bertazi
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 76286fd0010e64fb434a2f3fdfdc051f3fdd8668
Author: Sumit Semwal
Date: Sat Mar 25 21:48:16 2017 +0530
[media] uvcvideo: uvc\_scan\_fallback() for webcams with broken chain
[ Upstream commit e950267ab802c8558f1100eafd4087fd039ad634 ]
Some devices have invalid baSourceID references, causing uvc\_scan\_chain()
to fail, but if we just take the entities we can find and put them
together in the most sensible chain we can think of, turns out they do
work anyway. Note: This heuristic assumes there is a single chain.
At the time of writing, devices known to have such a broken chain are
- Acer Integrated Camera (5986:055a)
- Realtek rtl157a7 (0bda:57a7)
Signed-off-by: Henrik Ingo
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit fe51f26e30ab35a5a50df6d4163818c452e9683d
Author: Sumit Semwal
Date: Sat Mar 25 21:48:14 2017 +0530
block: allow WRITE\_SAME commands with the SG\_IO ioctl
[ Upstream commit 25cdb64510644f3e854d502d69c73f21c6df88a9 ]
The WRITE\_SAME commands are not present in the blk\_default\_cmd\_filter
write\_ok list, and thus are failed with -EPERM when the SG\_IO ioctl()
is executed without CAP\_SYS\_RAWIO capability (e.g., unprivileged users).
[ sg\_io() -> blk\_fill\_sghdr\_rq() > blk\_verify\_command() -> -EPERM ]
The problem can be reproduced with the sg\_write\_same command
# sg\_write\_same --num 1 --xferlen 512 /dev/sda
#
# capsh --drop=cap\_sys\_rawio -- -c \
'sg\_write\_same --num 1 --xferlen 512 /dev/sda'
Write same: pass through os error: Operation not permitted
#
For comparison, the WRITE\_VERIFY command does not observe this problem,
since it is in that list:
# capsh --drop=cap\_sys\_rawio -- -c \
'sg\_write\_verify --num 1 --ilen 512 --lba 0 /dev/sda'
#
So, this patch adds the WRITE\_SAME commands to the list, in order
for the SG\_IO ioctl to finish successfully:
# capsh --drop=cap\_sys\_rawio -- -c \
'sg\_write\_same --num 1 --xferlen 512 /dev/sda'
#
That case happens to be exercised by QEMU KVM guests with 'scsi-block' devices
(qemu "-device scsi-block" [1], libvirt "" [2]),
which employs the SG\_IO ioctl() and runs as an unprivileged user (libvirt-qemu).
In that scenario, when a filesystem (e.g., ext4) performs its zero-out calls,
which are translated to write-same calls in the guest kernel, and then into
SG\_IO ioctls to the host kernel, SCSI I/O errors may be observed in the guest:
[...] sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[...] sd 0:0:0:0: [sda] tag#0 Sense Key : Aborted Command [current]
[...] sd 0:0:0:0: [sda] tag#0 Add. Sense: I/O process terminated
[...] sd 0:0:0:0: [sda] tag#0 CDB: Write Same(10) 41 00 01 04 e0 78 00 00 08 00
[...] blk\_update\_request: I/O error, dev sda, sector 17096824
Links:
[1] http://git.qemu.org/?p=qemu.git;a=commit;h=336a6915bc7089fb20fea4ba99972ad9a97c5f52
[2] https://libvirt.org/formatdomain.html#elementsDisks (see 'disk' -> 'device')
Signed-off-by: Mauricio Faria de Oliveira
Signed-off-by: Brahadambal Srinivasan
Reported-by: Manjunatha H R
Reviewed-by: Christoph Hellwig
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 51cbcace401cc742bc16b83eebfa697811098d1e
Author: Sumit Semwal
Date: Sat Mar 25 21:48:12 2017 +0530
PCI: Do any VF BAR updates before enabling the BARs
[ Upstream commit f40ec3c748c6912f6266c56a7f7992de61b255ed ]
Previously we enabled VFs and enable their memory space before calling
pcibios\_sriov\_enable(). But pcibios\_sriov\_enable() may update the VF BARs:
for example, on PPC PowerNV we may change them to manage the association of
VFs to PEs.
Because 64-bit BARs cannot be updated atomically, it's unsafe to update
them while they're enabled. The half-updated state may conflict with other
devices in the system.
Call pcibios\_sriov\_enable() before enabling the VFs so any BAR updates
happen while the VF BARs are disabled.
[bhelgaas: changelog]
Tested-by: Carol Soto
Signed-off-by: Gavin Shan
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit eeaf3677ba86c9eb95799358faa9c53d0354bf38
Author: Sumit Semwal
Date: Sat Mar 25 21:48:10 2017 +0530
PCI: Update BARs using property bits appropriate for type
[ Upstream commit 45d004f4afefdd8d79916ee6d97a9ecd94bb1ffe ]
The BAR property bits (0-3 for memory BARs, 0-1 for I/O BARs) are supposed
to be read-only, but we do save them in res->flags and include them when
updating the BAR.
Mask the I/O property bits with ~PCI\_BASE\_ADDRESS\_IO\_MASK (0x3) instead of
PCI\_REGION\_FLAG\_MASK (0xf) to make it obvious that we can't corrupt bits
2-3 of I/O addresses.
Use PCI\_ROM\_ADDRESS\_MASK for ROM BARs. This means we'll only check the top
21 bits (instead of the 28 bits we used to check) of a ROM BAR to see if
the update was successful.
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit e7c37e14662329dbb0a0a117682374fc20beb987
Author: Sumit Semwal
Date: Sat Mar 25 21:48:09 2017 +0530
PCI: Don't update VF BARs while VF memory space is enabled
[ Upstream commit 546ba9f8f22f71b0202b6ba8967be5cc6dae4e21 ]
If we update a VF BAR while it's enabled, there are two potential problems:
1) Any driver that's using the VF has a cached BAR value that is stale
after the update, and
2) We can't update 64-bit BARs atomically, so the intermediate state
(new lower dword with old upper dword) may conflict with another
device, and an access by a driver unrelated to the VF may cause a bus
error.
Warn about attempts to update VF BARs while they are enabled. This is a
programming error, so use dev\_WARN() to get a backtrace.
Signed-off-by: Bjorn Helgaas
Reviewed-by: Gavin Shan
Signed-off-by: Sasha Levin
commit d388267762adcee75048174a3d2861bbe5dff7c7
Author: Sumit Semwal
Date: Sat Mar 25 21:48:08 2017 +0530
PCI: Decouple IORESOURCE\_ROM\_ENABLE and PCI\_ROM\_ADDRESS\_ENABLE
[ Upstream commit 7a6d312b50e63f598f5b5914c4fd21878ac2b595 ]
Remove the assumption that IORESOURCE\_ROM\_ENABLE == PCI\_ROM\_ADDRESS\_ENABLE.
PCI\_ROM\_ADDRESS\_ENABLE is the ROM enable bit defined by the PCI spec, so if
we're reading or writing a BAR register value, that's what we should use.
IORESOURCE\_ROM\_ENABLE is a corresponding bit in struct resource flags.
Signed-off-by: Bjorn Helgaas
Reviewed-by: Gavin Shan
Signed-off-by: Sasha Levin
commit d7b502b513fbd247fe5b8fd64858750ea5fe0028
Author: Sumit Semwal
Date: Sat Mar 25 21:48:07 2017 +0530
PCI: Add comments about ROM BAR updating
[ Upstream commit 0b457dde3cf8b7c76a60f8e960f21bbd4abdc416 ]
pci\_update\_resource() updates a hardware BAR so its address matches the
kernel's struct resource UNLESS it's a disabled ROM BAR. We only update
those when we enable the ROM.
It's not obvious from the code why ROM BARs should be handled specially.
Apparently there are Matrox devices with defective ROM BARs that read as
zero when disabled. That means that if pci\_enable\_rom() reads the disabled
BAR, sets PCI\_ROM\_ADDRESS\_ENABLE (without re-inserting the address), and
writes it back, it would enable the ROM at address zero.
Add comments and references to explain why we can't make the code look more
rational.
The code changes are from 755528c860b0 ("Ignore disabled ROM resources at
setup") and 8085ce084c0f ("[PATCH] Fix PCI ROM mapping").
Link: https://lkml.org/lkml/2005/8/30/138
Signed-off-by: Bjorn Helgaas
Reviewed-by: Gavin Shan
Signed-off-by: Sasha Levin
commit c6268b0a8d1d1169f876245967ebb8ffffdcb640
Author: Sumit Semwal
Date: Sat Mar 25 21:48:06 2017 +0530
PCI: Remove pci\_resource\_bar() and pci\_iov\_resource\_bar()
[ Upstream commit 286c2378aaccc7343ebf17ec6cd86567659caf70 ]
pci\_std\_update\_resource() only deals with standard BARs, so we don't have
to worry about the complications of VF BARs in an SR-IOV capability.
Compute the BAR address inline and remove pci\_resource\_bar(). That makes
pci\_iov\_resource\_bar() unused, so remove that as well.
Signed-off-by: Bjorn Helgaas
Reviewed-by: Gavin Shan
Signed-off-by: Sasha Levin
commit e71f476f1f27be45803526c3cd44ad87a86e4a0d
Author: Sumit Semwal
Date: Sat Mar 25 21:48:05 2017 +0530
PCI: Separate VF BAR updates from standard BAR updates
[ Upstream commit 6ffa2489c51da77564a0881a73765ea2169f955d ]
Previously pci\_update\_resource() used the same code path for updating
standard BARs and VF BARs in SR-IOV capabilities.
Split the VF BAR update into a new pci\_iov\_update\_resource() internal
interface, which makes it simpler to compute the BAR address (we can get
rid of pci\_resource\_bar() and pci\_iov\_resource\_bar()).
This patch:
- Renames pci\_update\_resource() to pci\_std\_update\_resource(),
- Adds pci\_iov\_update\_resource(),
- Makes pci\_update\_resource() a wrapper that calls the appropriate one,
No functional change intended.
Signed-off-by: Bjorn Helgaas
Reviewed-by: Gavin Shan
Signed-off-by: Sasha Levin
commit b6c8db12dc590c49e838bf9b84146d05438d30a5
Author: Sumit Semwal
Date: Sat Mar 25 21:48:03 2017 +0530
igb: add i211 to i210 PHY workaround
[ Upstream commit 5bc8c230e2a993b49244f9457499f17283da9ec7 ]
i210 and i211 share the same PHY but have different PCI IDs. Don't
forget i211 for any i210 workarounds.
Signed-off-by: Todd Fujinaka
Tested-by: Aaron Brown
Signed-off-by: Jeff Kirsher
Signed-off-by: Sasha Levin
commit 215aa8c6f01795449458831a878d17ad57b65ac8
Author: Sumit Semwal
Date: Sat Mar 25 21:48:02 2017 +0530
igb: Workaround for igb i210 firmware issue
[ Upstream commit 4e684f59d760a2c7c716bb60190783546e2d08a1 ]
Sometimes firmware may not properly initialize I347AT4\_PAGE\_SELECT causing
the probe of an igb i210 NIC to fail. This patch adds an addition zeroing
of this register during igb\_get\_phy\_id to workaround this issue.
Thanks for Jochen Henneberg for the idea and original patch.
Signed-off-by: Chris J Arges
Tested-by: Aaron Brown
Signed-off-by: Jeff Kirsher
Signed-off-by: Sasha Levin
commit 901a56cd88a89a81a923e5cd588e21fa5b780bbd
Author: Darrick J. Wong
Date: Wed Jan 25 20:24:57 2017 -0800
xfs: clear \_XBF\_PAGES from buffers when readahead page
[ Upstream commit 2aa6ba7b5ad3189cc27f14540aa2f57f0ed8df4b ]
If we try to allocate memory pages to back an xfs\_buf that we're trying
to read, it's possible that we'll be so short on memory that the page
allocation fails. For a blocking read we'll just wait, but for
readahead we simply dump all the pages we've collected so far.
Unfortunately, after dumping the pages we neglect to clear the
\_XBF\_PAGES state, which means that the subsequent call to xfs\_buf\_free
thinks that b\_pages still points to pages we own. It then double-frees
the b\_pages pages.
This results in screaming about negative page refcounts from the memory
manager, which xfs oughtn't be triggering. To reproduce this case,
mount a filesystem where the size of the inodes far outweighs the
availalble memory (a ~500M inode filesystem on a VM with 300MB memory
did the trick here) and run bulkstat in parallel with other memory
eating processes to put a huge load on the system. The "check summary"
phase of xfs\_scrub also works for this purpose.
Signed-off-by: Darrick J. Wong
Reviewed-by: Eric Sandeen
Signed-off-by: Sasha Levin
commit 5e36a29d1d6eaf438fa835f1875cec72156976e1
Author: Darrick J. Wong
Date: Mon Dec 5 12:38:38 2016 +1100
xfs: don't allow di\_size with high bit set
[ Upstream commit ef388e2054feedaeb05399ed654bdb06f385d294 ]
The on-disk field di\_size is used to set i\_size, which is a signed
integer of loff\_t. If the high bit of di\_size is set, we'll end up with
a negative i\_size, which will cause all sorts of problems. Since the
VFS won't let us create a file with such length, we should catch them
here in the verifier too.
Signed-off-by: Darrick J. Wong
Reviewed-by: Dave Chinner
Signed-off-by: Dave Chinner
Signed-off-by: Sasha Levin
commit da6d71ba4926027d1ccee806286584061ba99edd
Author: Ilya Dryomov
Date: Wed Mar 1 17:33:27 2017 +0100
libceph: don't set weight to IN when OSD is destroyed
[ Upstream commit b581a5854eee4b7851dedb0f8c2ceb54fb902c06 ]
Since ceph.git commit 4e28f9e63644 ("osd/OSDMap: clear osd\_info,
osd\_xinfo on osd deletion"), weight is set to IN when OSD is deleted.
This changes the result of applying an incremental for clients, not
just OSDs. Because CRUSH computations are obviously affected,
pre-4e28f9e63644 servers disagree with post-4e28f9e63644 clients on
object placement, resulting in misdirected requests.
Mirrors ceph.git commit a6009d1039a55e2c77f431662b3d6cc5a8e8e63f.
Fixes: 930c53286977 ("libceph: apply new\_state before new\_up\_client on incrementals")
Link: http://tracker.ceph.com/issues/19122
Signed-off-by: Ilya Dryomov
Reviewed-by: Sage Weil
Signed-off-by: Sasha Levin
commit 8a40cc46a2303c4978143022b23dd7ec6c1aec71
Author: Tomasz Majchrzak
Date: Thu Jul 28 10:28:25 2016 +0200
raid10: increment write counter after bio is split
[ Upstream commit 9b622e2bbcf049c82e2550d35fb54ac205965f50 ]
md pending write counter must be incremented after bio is split,
otherwise it gets decremented too many times in end bio callback and
becomes negative.
Signed-off-by: Tomasz Majchrzak
Reviewed-by: Artur Paszkiewicz
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
commit e9056085f2970aa35db93705f44e01401334516f
Author: Song Hongyan
Date: Wed Feb 22 17:17:38 2017 +0800
iio: hid-sensor-trigger: Change get poll value function order to avoid sensor properties losing after resume from S3
[ Upstream commit 3bec247474469f769af41e8c80d3a100dd97dd76 ]
In function \_hid\_sensor\_power\_state(), when hid\_sensor\_read\_poll\_value()
is called, sensor's all properties will be updated by the value from
sensor hardware/firmware.
In some implementation, sensor hardware/firmware will do a power cycle
during S3. In this case, after resume, once hid\_sensor\_read\_poll\_value()
is called, sensor's all properties which are kept by driver during S3
will be changed to default value.
But instead, if a set feature function is called first, sensor
hardware/firmware will be recovered to the last status. So change the
sensor\_hub\_set\_feature() calling order to behind of set feature function
to avoid sensor properties lose.
Signed-off-by: Song Hongyan
Acked-by: Srinivas Pandruvada
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit 36e0d023b278834bed53b709691b9a5e9d3f3a58
Author: Michael Engl
Date: Tue Oct 3 13:57:00 2017 +0100
iio: adc: ti\_am335x\_adc: fix fifo overrun recovery
[ Upstream commit e83bb3e6f3efa21f4a9d883a25d0ecd9dfb431e1 ]
The tiadc\_irq\_h(int irq, void \*private) function is handling FIFO
overruns by clearing flags, disabling and enabling the ADC to
recover.
If the ADC is running in continuous mode a FIFO overrun happens
regularly. If the disabling of the ADC happens concurrently with
a new conversion. It might happen that the enabling of the ADC
is ignored by the hardware. This stops the ADC permanently. No
more interrupts are triggered.
According to the AM335x Reference Manual (SPRUH73H October 2011 -
Revised April 2013 - Chapter 12.4 and 12.5) it is necessary to
check the ADC FSM bits in REG\_ADCFSM before enabling the ADC
again. Because the disabling of the ADC is done right after the
current conversion has been finished.
To trigger this bug it is necessary to run the ADC in continuous
mode. The ADC values of all channels need to be read in an endless
loop. The bug appears within the first 6 hours (~5.4 million
handled FIFO overruns). The user space application will hang on
reading new values from the character device.
Fixes: ca9a563805f7a ("iio: ti\_am335x\_adc: Add continuous sampling
support")
Signed-off-by: Michael Engl
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit 8725f73f3577b973997c33af5afaab0fc803b382
Author: Eric Dumazet
Date: Wed Mar 22 08:10:21 2017 -0700
tcp: initialize icsk\_ack.lrcvtime at session start time
[ Upstream commit 15bb7745e94a665caf42bfaabf0ce062845b533b ]
icsk\_ack.lrcvtime has a 0 value at socket creation time.
tcpi\_last\_data\_recv can have bogus value if no payload is ever received.
This patch initializes icsk\_ack.lrcvtime for active sessions
in tcp\_finish\_connect(), and for passive sessions in
tcp\_create\_openreq\_child()
Signed-off-by: Eric Dumazet
Acked-by: Neal Cardwell
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a96f1d23bd8e22a86dea69847f3f4b97f0d8dd56
Author: Eric Dumazet
Date: Tue Mar 21 19:22:28 2017 -0700
ipv4: provide stronger user input validation in nl\_fib\_input()
[ Upstream commit c64c0b3cac4c5b8cb093727d2c19743ea3965c0b ]
Alexander reported a KMSAN splat caused by reads of uninitialized
field (tb\_id\_in) from user provided struct fib\_result\_nl
It turns out nl\_fib\_input() sanity tests on user input is a bit
wrong :
User can pretend nlh->nlmsg\_len is big enough, but provide
at sendmsg() time a too small buffer.
Reported-by: Alexander Potapenko
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bc2ae9441bd27851611b06c0cf85bd1badbfb5e2
Author: Maor Gottlieb
Date: Tue Mar 21 15:59:17 2017 +0200
net/mlx5: Increase number of max QPs in default profile
[ Upstream commit 5f40b4ed975c26016cf41953b7510fe90718e21c ]
With ConnectX-4 sharing SRQs from the same space as QPs, we hit a
limit preventing some applications to allocate needed QPs amount.
Double the size to 256K.
Fixes: e126ba97dba9e ('mlx5: Add driver for Mellanox Connect-IB adapters')
Signed-off-by: Maor Gottlieb
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 47e516803adab641f9f63294b6320bdca4cc2b24
Author: Andrey Ulanov
Date: Tue Mar 14 20:16:42 2017 -0700
net: unix: properly re-increment inflight counter of GC discarded candidates
[ Upstream commit 7df9c24625b9981779afb8fcdbe2bb4765e61147 ]
Dmitry has reported that a BUG\_ON() condition in unix\_notinflight()
may be triggered by a simple code that forwards unix socket in an
SCM\_RIGHTS message.
That is caused by incorrect unix socket GC implementation in unix\_gc().
The GC first collects list of candidates, then (a) decrements their
"children's" inflight counter, (b) checks which inflight counters are
now 0, and then (c) increments all inflight counters back.
(a) and (c) are done by calling scan\_children() with inc\_inflight or
dec\_inflight as the second argument.
Commit 6209344f5a37 ("net: unix: fix inflight counting bug in garbage
collector") changed scan\_children() such that it no longer considers
sockets that do not have UNIX\_GC\_CANDIDATE flag. It also added a block
of code that that unsets this flag \_before\_ invoking
scan\_children(, dec\_iflight, ). This may lead to incorrect inflight
counters for some sockets.
This change fixes this bug by changing order of operations:
UNIX\_GC\_CANDIDATE is now unset only after all inflight counters are
restored to the original state.
kernel BUG at net/unix/garbage.c:149!
RIP: 0010:[] []
unix\_notinflight+0x3b4/0x490 net/unix/garbage.c:149
Call Trace:
[] unix\_detach\_fds.isra.19+0xff/0x170 net/unix/af\_unix.c:1487
[] unix\_destruct\_scm+0xf9/0x210 net/unix/af\_unix.c:1496
[] skb\_release\_head\_state+0x101/0x200 net/core/skbuff.c:655
[] skb\_release\_all+0x1a/0x60 net/core/skbuff.c:668
[] \_\_kfree\_skb+0x1a/0x30 net/core/skbuff.c:684
[] kfree\_skb+0x184/0x570 net/core/skbuff.c:705
[] unix\_release\_sock+0x5b5/0xbd0 net/unix/af\_unix.c:559
[] unix\_release+0x49/0x90 net/unix/af\_unix.c:836
[] sock\_release+0x92/0x1f0 net/socket.c:570
[] sock\_close+0x1b/0x20 net/socket.c:1017
[] \_\_fput+0x34e/0x910 fs/file\_table.c:208
[] \_\_\_\_fput+0x1a/0x20 fs/file\_table.c:244
[] task\_work\_run+0x1a0/0x280 kernel/task\_work.c:116
[< inline >] exit\_task\_work include/linux/task\_work.h:21
[] do\_exit+0x183a/0x2640 kernel/exit.c:828
[] do\_group\_exit+0x14e/0x420 kernel/exit.c:931
[] get\_signal+0x663/0x1880 kernel/signal.c:2307
[] do\_signal+0xc5/0x2190 arch/x86/kernel/signal.c:807
[] exit\_to\_usermode\_loop+0x1ea/0x2d0
arch/x86/entry/common.c:156
[< inline >] prepare\_exit\_to\_usermode arch/x86/entry/common.c:190
[] syscall\_return\_slowpath+0x4d3/0x570
arch/x86/entry/common.c:259
[] entry\_SYSCALL\_64\_fastpath+0xc4/0xc6
Link: https://lkml.org/lkml/2017/3/6/252
Signed-off-by: Andrey Ulanov
Reported-by: Dmitry Vyukov
Fixes: 6209344 ("net: unix: fix inflight counting bug in garbage collector")
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2c472af8144771a3ab4bb0e846aad83bf1bc2d16
Author: Eric Dumazet
Date: Wed Mar 15 13:21:28 2017 -0700
net: properly release sk\_frag.page
[ Upstream commit 22a0e18eac7a9e986fec76c60fa4a2926d1291e2 ]
I mistakenly added the code to release sk->sk\_frag in
sk\_common\_release() instead of sk\_destruct()
TCP sockets using sk->sk\_allocation == GFP\_ATOMIC do no call
sk\_common\_release() at close time, thus leaking one (order-3) page.
iSCSI is using such sockets.
Fixes: 5640f7685831 ("net: use a per task frag allocator")
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 02b24285db6ee1e2e0143425e68396242c937d86
Author: Florian Fainelli
Date: Wed Mar 15 12:57:21 2017 -0700
net: bcmgenet: Do not suspend PHY if Wake-on-LAN is enabled
[ Upstream commit 5371bbf4b295eea334ed453efa286afa2c3ccff3 ]
Suspending the PHY would be putting it in a low power state where it
may no longer allow us to do Wake-on-LAN.
Fixes: cc013fb48898 ("net: bcmgenet: correctly suspend and resume PHY device")
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fe6eaf3dbffd088a6c2230e60e86084123c01b80
Author: Linus Torvalds
Date: Thu Mar 2 12:17:22 2017 -0800
give up on gcc ilog2() constant optimizations
[ Upstream commit 474c90156c8dcc2fa815e6716cc9394d7930cb9c ]
gcc-7 has an "optimization" pass that completely screws up, and
generates the code expansion for the (impossible) case of calling
ilog2() with a zero constant, even when the code gcc compiles does not
actually have a zero constant.
And we try to generate a compile-time error for anybody doing ilog2() on
a constant where that doesn't make sense (be it zero or negative). So
now gcc7 will fail the build due to our sanity checking, because it
created that constant-zero case that didn't actually exist in the source
code.
There's a whole long discussion on the kernel mailing about how to work
around this gcc bug. The gcc people themselevs have discussed their
"feature" in
https://gcc.gnu.org/bugzilla/show\_bug.cgi?id=72785
but it's all water under the bridge, because while it looked at one
point like it would be solved by the time gcc7 was released, that was
not to be.
So now we have to deal with this compiler braindamage.
And the only simple approach seems to be to just delete the code that
tries to warn about bad uses of ilog2().
So now "ilog2()" will just return 0 not just for the value 1, but for
any non-positive value too.
It's not like I can recall anybody having ever actually tried to use
this function on any invalid value, but maybe the sanity check just
meant that such code never made it out in public.
Reported-by: Laura Abbott
Cc: John Stultz ,
Cc: Thomas Gleixner
Cc: Ard Biesheuvel
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit eeedc18bf39e9c71730a0df1cfc65f4d9f29bc51
Author: Jason Gunthorpe
Date: Wed Nov 25 14:05:30 2015 -0700
tpm\_tis: Use devm\_free\_irq not free\_irq
[ Upstream commit 727f28b8ca24a581c7bd868326b8cea1058c720a ]
The interrupt is always allocated with devm\_request\_irq so it
must always be freed with devm\_free\_irq.
Fixes: 448e9c55c12d ("tpm\_tis: verify interrupt during init")
Signed-off-by: Jason Gunthorpe
Acked-by: Jarkko Sakkinen
Tested-by: Jarkko Sakkinen
Tested-by: Martin Wilck
Signed-off-by: Jarkko Sakkinen
Acked-by: Peter Huewe
Signed-off-by: Sasha Levin
commit 729cabd84d0fac2c5f7c25b6dcef5adf828a6e73
Author: Sebastian Ott
Date: Fri Apr 15 09:41:35 2016 +0200
s390/pci: fix use after free in dma\_init
[ Upstream commit dba599091c191d209b1499511a524ad9657c0e5a ]
After a failure during registration of the dma\_table (because of the
function being in error state) we free its memory but don't reset the
associated pointer to zero.
When we then receive a notification from firmware (about the function
being in error state) we'll try to walk and free the dma\_table again.
Fix this by resetting the dma\_table pointer. In addition to that make
sure that we free the iommu\_bitmap when appropriate.
Signed-off-by: Sebastian Ott
Reviewed-by: Gerald Schaefer
Signed-off-by: Martin Schwidefsky
Signed-off-by: Sasha Levin
commit 7f9ab5fb771ec358f6239d0c6541ebd1b266e621
Author: Thomas Huth
Date: Wed May 18 21:01:20 2016 +0200
KVM: PPC: Book3S PR: Fix illegal opcode emulation
[ Upstream commit 708e75a3ee750dce1072134e630d66c4e6eaf63c ]
If kvmppc\_handle\_exit\_pr() calls kvmppc\_emulate\_instruction() to emulate
one instruction (in the BOOK3S\_INTERRUPT\_H\_EMUL\_ASSIST case), it calls
kvmppc\_core\_queue\_program() afterwards if kvmppc\_emulate\_instruction()
returned EMULATE\_FAIL, so the guest gets an program interrupt for the
illegal opcode.
However, the kvmppc\_emulate\_instruction() also tried to inject a
program exception for this already, so the program interrupt gets
injected twice and the return address in srr0 gets destroyed.
All other callers of kvmppc\_emulate\_instruction() are also injecting
a program interrupt, and since the callers have the right knowledge
about the srr1 flags that should be used, it is the function
kvmppc\_emulate\_instruction() that should \_not\_ inject program
interrupts, so remove the kvmppc\_core\_queue\_program() here.
This fixes the issue discovered by Laurent Vivier with kvm-unit-tests
where the logs are filled with these messages when the test tries
to execute an illegal instruction:
Couldn't emulate instruction 0x00000000 (op 0 xop 0)
kvmppc\_handle\_exit\_pr: emulation at 700 failed (00000000)
Signed-off-by: Thomas Huth
Reviewed-by: Alexander Graf
Tested-by: Laurent Vivier
Signed-off-by: Paul Mackerras
Signed-off-by: Sasha Levin
commit 33097614b509ededfc4d416b062b0d253c4cfb0b
Author: Vitaly Kuznetsov
Date: Sat Apr 30 19:21:35 2016 -0700
Drivers: hv: balloon: don't crash when memory is added in non-sorted order
[ Upstream commit 77c0c9735bc0ba5898e637a3a20d6bcb50e3f67d ]
When we iterate through all HA regions in handle\_pg\_range() we have an
assumption that all these regions are sorted in the list and the
'start\_pfn >= has->end\_pfn' check is enough to find the proper region.
Unfortunately it's not the case with WS2016 where host can hot-add regions
in a different order. We end up modifying the wrong HA region and crashing
later on pages online. Modify the check to make sure we found the region
we were searching for while iterating. Fix the same check in pfn\_covered()
as well.
Signed-off-by: Vitaly Kuznetsov
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 626143bc3937e1b00c3ef1fc31923939f1b943fc
Author: Alex Hung
Date: Fri May 27 15:47:06 2016 +0800
ACPI / video: skip evaluating \_DOD when it does not exist
[ Upstream commit e34fbbac669de0b7fb7803929d0477f35f6e2833 ]
Some system supports hybrid graphics and its discrete VGA
does not have any connectors and therefore has no \_DOD method.
Signed-off-by: Alex Hung
Reviewed-by: Aaron Lu
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit e7dfb3682c515f61bc147a898098b3553533665e
Author: Wang, Rui Y
Date: Wed Jan 27 17:08:36 2016 +0800
crypto: mcryptd - Fix load failure
[ Upstream commit ddef482420b1ba8ec45e6123a7e8d3f67b21e5e3 ]
mcryptd\_create\_hash() fails by returning -EINVAL, causing any
driver using mcryptd to fail to load. It is because it needs
to set its statesize properly.
Signed-off-by: Rui Wang
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 093a3219905814c9dc79495ca0b5ccc120f82deb
Author: Wang, Rui Y
Date: Sun Nov 29 22:45:34 2015 +0800
crypto: cryptd - Assign statesize properly
[ Upstream commit 1a07834024dfca5c4bed5de8f8714306e0a11836 ]
cryptd\_create\_hash() fails by returning -EINVAL. It is because after
8996eafdc ("crypto: ahash - ensure statesize is non-zero") all ahash
drivers must have a non-zero statesize.
This patch fixes the problem by properly assigning the statesize.
Signed-off-by: Rui Wang
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 25f7d25dd917c78ab57cbf57017bfc74f6172e65
Author: Wang, Rui Y
Date: Sun Nov 29 22:45:33 2015 +0800
crypto: ghash-clmulni - Fix load failure
[ Upstream commit 3a020a723c65eb8ffa7c237faca26521a024e582 ]
ghash\_clmulni\_intel fails to load on Linux 4.3+ with the following message:
"modprobe: ERROR: could not insert 'ghash\_clmulni\_intel': Invalid argument"
After 8996eafdc ("crypto: ahash - ensure statesize is non-zero") all ahash
drivers are required to implement import()/export(), and must have a non-
zero statesize.
This patch has been tested with the algif\_hash interface. The calculated
digest values, after several rounds of import()s and export()s, match those
calculated by tcrypt.
Signed-off-by: Rui Wang
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 13c33d42d90d559bd3386ce9eeeda6806dee88f3
Author: Roman Mashak
Date: Fri Feb 24 11:00:32 2017 -0500
net sched actions: decrement module reference count after table flush.
[ Upstream commit edb9d1bff4bbe19b8ae0e71b1f38732591a9eeb2 ]
When tc actions are loaded as a module and no actions have been installed,
flushing them would result in actions removed from the memory, but modules
reference count not being decremented, so that the modules would not be
unloaded.
Following is example with GACT action:
% sudo modprobe act\_gact
% lsmod
Module Size Used by
act\_gact 16384 0
%
% sudo tc actions ls action gact
%
% sudo tc actions flush action gact
% lsmod
Module Size Used by
act\_gact 16384 1
% sudo tc actions flush action gact
% lsmod
Module Size Used by
act\_gact 16384 2
% sudo rmmod act\_gact
rmmod: ERROR: Module act\_gact is in use
....
After the fix:
% lsmod
Module Size Used by
act\_gact 16384 0
%
% sudo tc actions add action pass index 1
% sudo tc actions add action pass index 2
% sudo tc actions add action pass index 3
% lsmod
Module Size Used by
act\_gact 16384 3
%
% sudo tc actions flush action gact
% lsmod
Module Size Used by
act\_gact 16384 0
%
% sudo tc actions flush action gact
% lsmod
Module Size Used by
act\_gact 16384 0
% sudo rmmod act\_gact
% lsmod
Module Size Used by
%
Fixes: f97017cdefef ("net-sched: Fix actions flushing")
Signed-off-by: Roman Mashak
Signed-off-by: Jamal Hadi Salim
Acked-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c553b198be9cf82040bad3d760243e5a9d91630e
Author: Hannes Frederic Sowa
Date: Mon Mar 13 00:01:30 2017 +0100
dccp: fix memory leak during tear-down of unsuccessful connection request
[ Upstream commit 72ef9c4125c7b257e3a714d62d778ab46583d6a3 ]
This patch fixes a memory leak, which happens if the connection request
is not fulfilled between parsing the DCCP options and handling the SYN
(because e.g. the backlog is full), because we forgot to free the
list of ack vectors.
Reported-by: Jianwen Ji
Signed-off-by: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0925dd7dcebb20440cdc6b4be1658c75f8da19c1
Author: Jon Maxwell
Date: Fri Mar 10 16:40:33 2017 +1100
dccp/tcp: fix routing redirect race
[ Upstream commit 45caeaa5ac0b4b11784ac6f932c0ad4c6b67cda0 ]
As Eric Dumazet pointed out this also needs to be fixed in IPv6.
v2: Contains the IPv6 tcp/Ipv6 dccp patches as well.
We have seen a few incidents lately where a dst\_enty has been freed
with a dangling TCP socket reference (sk->sk\_dst\_cache) pointing to that
dst\_entry. If the conditions/timings are right a crash then ensues when the
freed dst\_entry is referenced later on. A Common crashing back trace is:
#8 [] page\_fault at ffffffff8163e648
[exception RIP: \_\_tcp\_ack\_snd\_check+74]
.
.
#9 [] tcp\_rcv\_established at ffffffff81580b64
#10 [] tcp\_v4\_do\_rcv at ffffffff8158b54a
#11 [] tcp\_v4\_rcv at ffffffff8158cd02
#12 [] ip\_local\_deliver\_finish at ffffffff815668f4
#13 [] ip\_local\_deliver at ffffffff81566bd9
#14 [] ip\_rcv\_finish at ffffffff8156656d
#15 [] ip\_rcv at ffffffff81566f06
#16 [] \_\_netif\_receive\_skb\_core at ffffffff8152b3a2
#17 [] \_\_netif\_receive\_skb at ffffffff8152b608
#18 [] netif\_receive\_skb at ffffffff8152b690
#19 [] vmxnet3\_rq\_rx\_complete at ffffffffa015eeaf [vmxnet3]
#20 [] vmxnet3\_poll\_rx\_only at ffffffffa015f32a [vmxnet3]
#21 [] net\_rx\_action at ffffffff8152bac2
#22 [] \_\_do\_softirq at ffffffff81084b4f
#23 [] call\_softirq at ffffffff8164845c
#24 [] do\_softirq at ffffffff81016fc5
#25 [] irq\_exit at ffffffff81084ee5
#26 [] do\_IRQ at ffffffff81648ff8
Of course it may happen with other NIC drivers as well.
It's found the freed dst\_entry here:
224 static bool tcp\_in\_quickack\_mode(struct sock \*sk)↩
225 {↩
226 ▹ const struct inet\_connection\_sock \*icsk = inet\_csk(sk);↩
227 ▹ const struct dst\_entry \*dst = \_\_sk\_dst\_get(sk);↩
228 ↩
229 ▹ return (dst && dst\_metric(dst, RTAX\_QUICKACK)) ||↩
230 ▹ ▹ (icsk->icsk\_ack.quick && !icsk->icsk\_ack.pingpong);↩
231 }↩
But there are other backtraces attributed to the same freed dst\_entry in
netfilter code as well.
All the vmcores showed 2 significant clues:
- Remote hosts behind the default gateway had always been redirected to a
different gateway. A rtable/dst\_entry will be added for that host. Making
more dst\_entrys with lower reference counts. Making this more probable.
- All vmcores showed a postitive LockDroppedIcmps value, e.g:
LockDroppedIcmps 267
A closer look at the tcp\_v4\_err() handler revealed that do\_redirect() will run
regardless of whether user space has the socket locked. This can result in a
race condition where the same dst\_entry cached in sk->sk\_dst\_entry can be
decremented twice for the same socket via:
do\_redirect()->\_\_sk\_dst\_check()-> dst\_release().
Which leads to the dst\_entry being prematurely freed with another socket
pointing to it via sk->sk\_dst\_cache and a subsequent crash.
To fix this skip do\_redirect() if usespace has the socket locked. Instead let
the redirect take place later when user space does not have the socket
locked.
The dccp/IPv6 code is very similar in this respect, so fixing it there too.
As Eric Garver pointed out the following commit now invalidates routes. Which
can set the dst->obsolete flag so that ipv4\_dst\_check() returns null and
triggers the dst\_release().
Fixes: ceb3320610d6 ("ipv4: Kill routes during PMTU/redirect updates.")
Cc: Eric Garver
Cc: Hannes Sowa
Signed-off-by: Jon Maxwell
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit eb27a77d58016382ee145d169092e4f70188b435
Author: Sabrina Dubroca
Date: Mon Mar 13 13:28:09 2017 +0100
ipv6: make ECMP route replacement less greedy
[ Upstream commit 67e194007be08d071294456274dd53e0a04fdf90 ]
Commit 27596472473a ("ipv6: fix ECMP route replacement") introduced a
loop that removes all siblings of an ECMP route that is being
replaced. However, this loop doesn't stop when it has replaced
siblings, and keeps removing other routes with a higher metric.
We also end up triggering the WARN\_ON after the loop, because after
this nsiblings < 0.
Instead, stop the loop when we have taken care of all routes with the
same metric as the route being replaced.
Reproducer:
===========
#!/bin/sh
ip netns add ns1
ip netns add ns2
ip -net ns1 link set lo up
for x in 0 1 2 ; do
ip link add veth$x netns ns2 type veth peer name eth$x netns ns1
ip -net ns1 link set eth$x up
ip -net ns2 link set veth$x up
done
ip -net ns1 -6 r a 2000::/64 nexthop via fe80::0 dev eth0 \
nexthop via fe80::1 dev eth1 nexthop via fe80::2 dev eth2
ip -net ns1 -6 r a 2000::/64 via fe80::42 dev eth0 metric 256
ip -net ns1 -6 r a 2000::/64 via fe80::43 dev eth0 metric 2048
echo "before replace, 3 routes"
ip -net ns1 -6 r | grep -v '^fe80\|^ff00'
echo
ip -net ns1 -6 r c 2000::/64 nexthop via fe80::4 dev eth0 \
nexthop via fe80::5 dev eth1 nexthop via fe80::6 dev eth2
echo "after replace, only 2 routes, metric 2048 is gone"
ip -net ns1 -6 r | grep -v '^fe80\|^ff00'
Fixes: 27596472473a ("ipv6: fix ECMP route replacement")
Signed-off-by: Sabrina Dubroca
Acked-by: Nicolas Dichtel
Reviewed-by: Xin Long
Reviewed-by: Michal Kubecek
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cf08429dd9d5855fdac5c9bc3f15fb16e80342c1
Author: David Ahern
Date: Fri Mar 10 09:46:15 2017 -0800
mpls: Send route delete notifications when router module is unloaded
[ Upstream commit e37791ec1ad785b59022ae211f63a16189bacebf ]
When the mpls\_router module is unloaded, mpls routes are deleted but
notifications are not sent to userspace leaving userspace caches
out of sync. Add the call to mpls\_notify\_route in mpls\_net\_exit as
routes are freed.
Fixes: 0189197f44160 ("mpls: Basic routing support")
Signed-off-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f987ee1b77356eacab892e3dd7e4779f745c6359
Author: Etienne Noss
Date: Fri Mar 10 16:55:32 2017 +0100
act\_connmark: avoid crashing on malformed nlattrs with null parms
[ Upstream commit 52491c7607c5527138095edf44c53169dc1ddb82 ]
tcf\_connmark\_init does not check in its configuration if TCA\_CONNMARK\_PARMS
is set, resulting in a null pointer dereference when trying to access it.
[501099.043007] BUG: unable to handle kernel NULL pointer dereference at 0000000000000004
[501099.043039] IP: [] tcf\_connmark\_init+0x8b/0x180 [act\_connmark]
...
[501099.044334] Call Trace:
[501099.044345] [] ? tcf\_action\_init\_1+0x198/0x1b0
[501099.044363] [] ? tcf\_action\_init+0xb0/0x120
[501099.044380] [] ? tcf\_exts\_validate+0xc4/0x110
[501099.044398] [] ? u32\_set\_parms+0xa7/0x270 [cls\_u32]
[501099.044417] [] ? u32\_change+0x680/0x87b [cls\_u32]
[501099.044436] [] ? tc\_ctl\_tfilter+0x4dd/0x8a0
[501099.044454] [] ? security\_capable+0x41/0x60
[501099.044471] [] ? rtnetlink\_rcv\_msg+0xe1/0x220
[501099.044490] [] ? rtnl\_newlink+0x870/0x870
[501099.044507] [] ? netlink\_rcv\_skb+0xa1/0xc0
[501099.044524] [] ? rtnetlink\_rcv+0x24/0x30
[501099.044541] [] ? netlink\_unicast+0x184/0x230
[501099.044558] [] ? netlink\_sendmsg+0x2f8/0x3b0
[501099.044576] [] ? sock\_sendmsg+0x30/0x40
[501099.044592] [] ? SYSC\_sendto+0xd3/0x150
[501099.044608] [] ? \_\_do\_page\_fault+0x2d1/0x510
[501099.044626] [] ? system\_call\_fast\_compare\_end+0xc/0x9b
Fixes: 22a5dc0e5e3e ("net: sched: Introduce connmark action")
Signed-off-by: Étienne Noss
Signed-off-by: Victorien Molle
Acked-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 32f9d631a3eaab2e81875cf4dae12cec4b7864dc
Author: Dmitry V. Levin
Date: Tue Mar 7 23:50:50 2017 +0300
uapi: fix linux/packet\_diag.h userspace compilation error
[ Upstream commit 745cb7f8a5de0805cade3de3991b7a95317c7c73 ]
Replace MAX\_ADDR\_LEN with its numeric value to fix the following
linux/packet\_diag.h userspace compilation error:
/usr/include/linux/packet\_diag.h:67:17: error: 'MAX\_ADDR\_LEN' undeclared here (not in a function)
\_\_u8 pdmc\_addr[MAX\_ADDR\_LEN];
This is not the first case in the UAPI where the numeric value
of MAX\_ADDR\_LEN is used instead of symbolic one, uapi/linux/if\_link.h
already does the same:
$ grep MAX\_ADDR\_LEN include/uapi/linux/if\_link.h
\_\_u8 mac[32]; /\* MAX\_ADDR\_LEN \*/
There are no UAPI headers besides these two that use MAX\_ADDR\_LEN.
Signed-off-by: Dmitry V. Levin
Acked-by: Pavel Emelyanov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1cad88dd2806805ee0eeb3363093d3a15f1c84c7
Author: Eric Dumazet
Date: Fri Mar 3 21:01:03 2017 -0800
net: fix socket refcounting in skb\_complete\_tx\_timestamp()
[ Upstream commit 9ac25fc063751379cb77434fef9f3b088cd3e2f7 ]
TX skbs do not necessarily hold a reference on skb->sk->sk\_refcnt
By the time TX completion happens, sk\_refcnt might be already 0.
sock\_hold()/sock\_put() would then corrupt critical state, like
sk\_wmem\_alloc and lead to leaks or use after free.
Fixes: 62bccb8cdb69 ("net-timestamp: Make the clone operation stand-alone from phy timestamping")
Signed-off-by: Eric Dumazet
Cc: Alexander Duyck
Cc: Johannes Berg
Cc: Soheil Hassas Yeganeh
Cc: Willem de Bruijn
Acked-by: Soheil Hassas Yeganeh
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ddecc365cf9b062b187781b4b26a212c067bea18
Author: Eric Dumazet
Date: Fri Mar 3 21:01:02 2017 -0800
net: fix socket refcounting in skb\_complete\_wifi\_ack()
[ Upstream commit dd4f10722aeb10f4f582948839f066bebe44e5fb ]
TX skbs do not necessarily hold a reference on skb->sk->sk\_refcnt
By the time TX completion happens, sk\_refcnt might be already 0.
sock\_hold()/sock\_put() would then corrupt critical state, like
sk\_wmem\_alloc.
Fixes: bf7fa551e0ce ("mac80211: Resolve sk\_refcnt/sk\_wmem\_alloc issue in wifi ack path")
Signed-off-by: Eric Dumazet
Cc: Alexander Duyck
Cc: Johannes Berg
Cc: Soheil Hassas Yeganeh
Cc: Willem de Bruijn
Acked-by: Soheil Hassas Yeganeh
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0dc0c260ff713013f1d847c48ef8e583798673e2
Author: Eric Dumazet
Date: Fri Mar 3 14:08:21 2017 -0800
tcp: fix various issues for sockets morphing to listen state
[ Upstream commit 02b2faaf0af1d85585f6d6980e286d53612acfc2 ]
Dmitry Vyukov reported a divide by 0 triggered by syzkaller, exploiting
tcp\_disconnect() path that was never really considered and/or used
before syzkaller ;)
I was not able to reproduce the bug, but it seems issues here are the
three possible actions that assumed they would never trigger on a
listener.
1) tcp\_write\_timer\_handler
2) tcp\_delack\_timer\_handler
3) MTU reduction
Only IPv6 MTU reduction was properly testing TCP\_CLOSE and TCP\_LISTEN
states from tcp\_v6\_mtu\_reduced()
Signed-off-by: Eric Dumazet
Reported-by: Dmitry Vyukov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7f02456af7db872876ebf67f89e6e9ca91f4bee3
Author: Arnaldo Carvalho de Melo
Date: Wed Mar 1 16:35:07 2017 -0300
dccp: Unlock sock before calling sk\_free()
[ Upstream commit d5afb6f9b6bb2c57bd0c05e76e12489dc0d037d9 ]
The code where sk\_clone() came from created a new socket and locked it,
but then, on the error path didn't unlock it.
This problem stayed there for a long while, till b0691c8ee7c2 ("net:
Unlock sock before calling sk\_free()") fixed it, but unfortunately the
callers of sk\_clone() (now sk\_clone\_locked()) were not audited and the
one in dccp\_create\_openreq\_child() remained.
Now in the age of the syskaller fuzzer, this was finally uncovered, as
reported by Dmitry:
---- 8< ----
I've got the following report while running syzkaller fuzzer on
86292b33d4b7 ("Merge branch 'akpm' (patches from Andrew)")
[ BUG: held lock freed! ]
4.10.0+ #234 Not tainted
-------------------------
syz-executor6/6898 is freeing memory
ffff88006286cac0-ffff88006286d3b7, with a lock still held there!
(slock-AF\_INET6){+.-...}, at: [] spin\_lock
include/linux/spinlock.h:299 [inline]
(slock-AF\_INET6){+.-...}, at: []
sk\_clone\_lock+0x3d9/0x12c0 net/core/sock.c:1504
5 locks held by syz-executor6/6898:
#0: (sk\_lock-AF\_INET6){+.+.+.}, at: [] lock\_sock
include/net/sock.h:1460 [inline]
#0: (sk\_lock-AF\_INET6){+.+.+.}, at: []
inet\_stream\_connect+0x44/0xa0 net/ipv4/af\_inet.c:681
#1: (rcu\_read\_lock){......}, at: []
inet6\_csk\_xmit+0x12a/0x5d0 net/ipv6/inet6\_connection\_sock.c:126
#2: (rcu\_read\_lock){......}, at: [] \_\_skb\_unlink
include/linux/skbuff.h:1767 [inline]
#2: (rcu\_read\_lock){......}, at: [] \_\_skb\_dequeue
include/linux/skbuff.h:1783 [inline]
#2: (rcu\_read\_lock){......}, at: []
process\_backlog+0x264/0x730 net/core/dev.c:4835
#3: (rcu\_read\_lock){......}, at: []
ip6\_input\_finish+0x0/0x1700 net/ipv6/ip6\_input.c:59
#4: (slock-AF\_INET6){+.-...}, at: [] spin\_lock
include/linux/spinlock.h:299 [inline]
#4: (slock-AF\_INET6){+.-...}, at: []
sk\_clone\_lock+0x3d9/0x12c0 net/core/sock.c:1504
Fix it just like was done by b0691c8ee7c2 ("net: Unlock sock before calling
sk\_free()").
Reported-by: Dmitry Vyukov
Cc: Cong Wang
Cc: Eric Dumazet
Cc: Gerrit Renker
Cc: Thomas Gleixner
Link: http://lkml.kernel.org/r/20170301153510.GE15145@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9ebdfa6c678ccfada9530a84f959b56b54505848
Author: Alexander Potapenko
Date: Wed Mar 1 12:57:20 2017 +0100
net: don't call strlen() on the user buffer in packet\_bind\_spkt()
[ Upstream commit 540e2894f7905538740aaf122bd8e0548e1c34a4 ]
KMSAN (KernelMemorySanitizer, a new error detection tool) reports use of
uninitialized memory in packet\_bind\_spkt():
Acked-by: Eric Dumazet
==================================================================
BUG: KMSAN: use of unitialized memory
CPU: 0 PID: 1074 Comm: packet Not tainted 4.8.0-rc6+ #1891
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs
01/01/2011
0000000000000000 ffff88006b6dfc08 ffffffff82559ae8 ffff88006b6dfb48
ffffffff818a7c91 ffffffff85b9c870 0000000000000092 ffffffff85b9c550
0000000000000000 0000000000000092 00000000ec400911 0000000000000002
Call Trace:
[< inline >] \_\_dump\_stack lib/dump\_stack.c:15
[] dump\_stack+0x238/0x290 lib/dump\_stack.c:51
[] kmsan\_report+0x276/0x2e0 mm/kmsan/kmsan.c:1003
[] \_\_msan\_warning+0x5b/0xb0
mm/kmsan/kmsan\_instr.c:424
[< inline >] strlen lib/string.c:484
[] strlcpy+0x9d/0x200 lib/string.c:144
[] packet\_bind\_spkt+0x144/0x230
net/packet/af\_packet.c:3132
[] SYSC\_bind+0x40d/0x5f0 net/socket.c:1370
[] SyS\_bind+0x82/0xa0 net/socket.c:1356
[] entry\_SYSCALL\_64\_fastpath+0x13/0x8f
arch/x86/entry/entry\_64.o:?
chained origin: 00000000eba00911
[] save\_stack\_trace+0x27/0x50
arch/x86/kernel/stacktrace.c:67
[< inline >] kmsan\_save\_stack\_with\_flags mm/kmsan/kmsan.c:322
[< inline >] kmsan\_save\_stack mm/kmsan/kmsan.c:334
[] kmsan\_internal\_chain\_origin+0x118/0x1e0
mm/kmsan/kmsan.c:527
[] \_\_msan\_set\_alloca\_origin4+0xc3/0x130
mm/kmsan/kmsan\_instr.c:380
[] SYSC\_bind+0x129/0x5f0 net/socket.c:1356
[] SyS\_bind+0x82/0xa0 net/socket.c:1356
[] entry\_SYSCALL\_64\_fastpath+0x13/0x8f
arch/x86/entry/entry\_64.o:?
origin description: ----address@SYSC\_bind (origin=00000000eb400911)
==================================================================
(the line numbers are relative to 4.8-rc6, but the bug persists
upstream)
, when I run the following program as root:
=====================================
#include
#include
#include
#include
int main() {
struct sockaddr addr;
memset(&addr, 0xff, sizeof(addr));
addr.sa\_family = AF\_PACKET;
int fd = socket(PF\_PACKET, SOCK\_PACKET, htons(ETH\_P\_ALL));
bind(fd, &addr, sizeof(addr));
return 0;
}
=====================================
This happens because addr.sa\_data copied from the userspace is not
zero-terminated, and copying it with strlcpy() in packet\_bind\_spkt()
results in calling strlen() on the kernel copy of that non-terminated
buffer.
Signed-off-by: Alexander Potapenko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f8a586d62a8a5ae326bb3c2f4955404cbe4c3942
Author: Paul Hüber
Date: Sun Feb 26 17:58:19 2017 +0100
l2tp: avoid use-after-free caused by l2tp\_ip\_backlog\_recv
[ Upstream commit 51fb60eb162ab84c5edf2ae9c63cf0b878e5547e ]
l2tp\_ip\_backlog\_recv may not return -1 if the packet gets dropped.
The return value is passed up to ip\_local\_deliver\_finish, which treats
negative values as an IP protocol number for resubmission.
Signed-off-by: Paul Hüber
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1e4f22fbf574f06957fcbbeaa9295755f51427c7
Author: Julian Anastasov
Date: Sun Feb 26 17:14:35 2017 +0200
ipv4: mask tos for input route
[ Upstream commit 6e28099d38c0e50d62c1afc054e37e573adf3d21 ]
Restore the lost masking of TOS in input route code to
allow ip rules to match it properly.
Problem [1] noticed by Shmulik Ladkani
[1] http://marc.info/?t=137331755300040&r=1&w=2
Fixes: 89aef8921bfb ("ipv4: Delete routing cache.")
Signed-off-by: Julian Anastasov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ab1c72ff6d613bca13f0d65e52199a53afc50069
Author: David Forster
Date: Fri Feb 24 14:20:32 2017 +0000
vti6: return GRE\_KEY for vti6
[ Upstream commit 7dcdf941cdc96692ab99fd790c8cc68945514851 ]
Align vti6 with vti by returning GRE\_KEY flag. This enables iproute2
to display tunnel keys on "ip -6 tunnel show"
Signed-off-by: David Forster
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2d28a6be926e7e684793f2895b3c4356db239e8e
Author: Matthias Schiffer
Date: Thu Feb 23 17:19:41 2017 +0100
vxlan: correctly validate VXLAN ID against VXLAN\_N\_VID
[ Upstream commit 4e37d6911f36545b286d15073f6f2222f840e81c ]
The incorrect check caused an off-by-one error: the maximum VID 0xffffff
was unusable.
Fixes: d342894c5d2f ("vxlan: virtual extensible lan")
Signed-off-by: Matthias Schiffer
Acked-by: Jiri Benc
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3f51d19d98be281113d2eb801c9021621bb75304
Author: Theodore Ts'o
Date: Tue Feb 14 11:31:15 2017 -0500
ext4: don't BUG when truncating encrypted inodes on the orphan list
[ Upstream commit 0d06863f903ac5f4f6efb0273079d27de3e53a28 ]
Fix a BUG when the kernel tries to mount a file system constructed as
follows:
echo foo > foo.txt
mke2fs -Fq -t ext4 -O encrypt foo.img 100
debugfs -w foo.img << EOF
write foo.txt a
set\_inode\_field a i\_flags 0x80800
set\_super\_value s\_last\_orphan 12
quit
EOF
root@kvm-xfstests:~# mount -o loop foo.img /mnt
[ 160.238770] ------------[ cut here ]------------
[ 160.240106] kernel BUG at /usr/projects/linux/ext4/fs/ext4/inode.c:3874!
[ 160.240106] invalid opcode: 0000 [#1] SMP
[ 160.240106] Modules linked in:
[ 160.240106] CPU: 0 PID: 2547 Comm: mount Tainted: G W 4.10.0-rc3-00034-gcdd33b941b67 #227
[ 160.240106] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.1-1 04/01/2014
[ 160.240106] task: f4518000 task.stack: f47b6000
[ 160.240106] EIP: ext4\_block\_zero\_page\_range+0x1a7/0x2b4
[ 160.240106] EFLAGS: 00010246 CPU: 0
[ 160.240106] EAX: 00000001 EBX: f7be4b50 ECX: f47b7dc0 EDX: 00000007
[ 160.240106] ESI: f43b05a8 EDI: f43babec EBP: f47b7dd0 ESP: f47b7dac
[ 160.240106] DS: 007b ES: 007b FS: 00d8 GS: 0033 SS: 0068
[ 160.240106] CR0: 80050033 CR2: bfd85b08 CR3: 34a00680 CR4: 000006f0
[ 160.240106] Call Trace:
[ 160.240106] ext4\_truncate+0x1e9/0x3e5
[ 160.240106] ext4\_fill\_super+0x286f/0x2b1e
[ 160.240106] ? set\_blocksize+0x2e/0x7e
[ 160.240106] mount\_bdev+0x114/0x15f
[ 160.240106] ext4\_mount+0x15/0x17
[ 160.240106] ? ext4\_calculate\_overhead+0x39d/0x39d
[ 160.240106] mount\_fs+0x58/0x115
[ 160.240106] vfs\_kern\_mount+0x4b/0xae
[ 160.240106] do\_mount+0x671/0x8c3
[ 160.240106] ? \_copy\_from\_user+0x70/0x83
[ 160.240106] ? strndup\_user+0x31/0x46
[ 160.240106] SyS\_mount+0x57/0x7b
[ 160.240106] do\_int80\_syscall\_32+0x4f/0x61
[ 160.240106] entry\_INT80\_32+0x2f/0x2f
[ 160.240106] EIP: 0xb76b919e
[ 160.240106] EFLAGS: 00000246 CPU: 0
[ 160.240106] EAX: ffffffda EBX: 08053838 ECX: 08052188 EDX: 080537e8
[ 160.240106] ESI: c0ed0000 EDI: 00000000 EBP: 080537e8 ESP: bfa13660
[ 160.240106] DS: 007b ES: 007b FS: 0000 GS: 0033 SS: 007b
[ 160.240106] Code: 59 8b 00 a8 01 0f 84 09 01 00 00 8b 07 66 25 00 f0 66 3d 00 80 75 61 89 f8 e8 3e e2 ff ff 84 c0 74 56 83 bf 48 02 00 00 00 75 02 <0f> 0b 81 7d e8 00 10 00 00 74 02 0f 0b 8b 43 04 8b 53 08 31 c9
[ 160.240106] EIP: ext4\_block\_zero\_page\_range+0x1a7/0x2b4 SS:ESP: 0068:f47b7dac
[ 160.317241] ---[ end trace d6a773a375c810a5 ]---
The problem is that when the kernel tries to truncate an inode in
ext4\_truncate(), it tries to clear any on-disk data beyond i\_size.
Without the encryption key, it can't do that, and so it triggers a
BUG.
E2fsck does \*not\* provide this service, and in practice most file
systems have their orphan list processed by e2fsck, so to avoid
crashing, this patch skips this step if we don't have access to the
encryption key (which is the case when processing the orphan list; in
all other cases, we will have the encryption key, or the kernel
wouldn't have allowed the file to be opened).
An open question is whether the fact that e2fsck isn't clearing the
bytes beyond i\_size causing problems --- and if we've lived with it
not doing it for so long, can we drop this from the kernel replay of
the orphan list in all cases (not just when we don't have the key for
encrypted inodes).
Addresses-Google-Bug: #35209576
Signed-off-by: Theodore Ts'o
Signed-off-by: Sasha Levin
commit 5363fd5fe17ac1665ff09d0ab616af1e43287b7a
Author: Mikulas Patocka
Date: Wed Feb 15 11:26:10 2017 -0500
dm: flush queued bios when process blocks to avoid deadlock
[ Upstream commit d67a5f4b5947aba4bfe9a80a2b86079c215ca755 ]
Commit df2cb6daa4 ("block: Avoid deadlocks with bio allocation by
stacking drivers") created a workqueue for every bio set and code
in bio\_alloc\_bioset() that tries to resolve some low-memory deadlocks
by redirecting bios queued on current->bio\_list to the workqueue if the
system is low on memory. However other deadlocks (see below \*\*) may
happen, without any low memory condition, because generic\_make\_request
is queuing bios to current->bio\_list (rather than submitting them).
\*\* the related dm-snapshot deadlock is detailed here:
https://www.redhat.com/archives/dm-devel/2016-July/msg00065.html
Fix this deadlock by redirecting any bios on current->bio\_list to the
bio\_set's rescue workqueue on every schedule() call. Consequently,
when the process blocks on a mutex, the bios queued on
current->bio\_list are dispatched to independent workqueus and they can
complete without waiting for the mutex to be available.
The structure blk\_plug contains an entry cb\_list and this list can contain
arbitrary callback functions that are called when the process blocks.
To implement this fix DM (ab)uses the onstack plug's cb\_list interface
to get its flush\_current\_bio\_list() called at schedule() time.
This fixes the snapshot deadlock - if the map method blocks,
flush\_current\_bio\_list() will be called and it redirects bios waiting
on current->bio\_list to appropriate workqueues.
Fixes: https://bugzilla.redhat.com/show\_bug.cgi?id=1267650
Depends-on: df2cb6daa4 ("block: Avoid deadlocks with bio allocation by stacking drivers")
Signed-off-by: Mikulas Patocka
Signed-off-by: Mike Snitzer
Signed-off-by: Sasha Levin
commit 99472ef5839d8325058185ad56eb6d21302cee38
Author: Luis de Bethencourt
Date: Mon Nov 30 14:32:17 2015 +0000
mvsas: fix misleading indentation
[ Upstream commit 7789cd39274c51bf475411fe22a8ee7255082809 ]
Fix a smatch warning:
drivers/scsi/mvsas/mv\_sas.c:740 mvs\_task\_prep() warn: curly braces intended?
The code is correct, the indention is misleading. When the device is not
ready we want to return SAS\_PHY\_DOWN. But current indentation makes it
look like we only do so in the else branch of if (mvi\_dev).
Signed-off-by: Luis de Bethencourt
Reviewed-by: Johannes Thumshirn
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 325b7e57a494ca56c0516ca3739ce8feebdc147a
Author: Ralf Baechle
Date: Tue Sep 20 14:33:01 2016 +0200
MIPS: DEC: Avoid la pseudo-instruction in delay slots
[ Upstream commit 3021773c7c3e75e20b693931a19362681e744ea9 ]
When expanding the la or dla pseudo-instruction in a delay slot the GNU
assembler will complain should the pseudo-instruction expand to multiple
actual instructions, since only the first of them will be in the delay
slot leading to the pseudo-instruction being only partially executed if
the branch is taken. Use of PTR\_LA in the dec int-handler.S leads to
such warnings:
arch/mips/dec/int-handler.S: Assembler messages:
arch/mips/dec/int-handler.S:149: Warning: macro instruction expanded into multiple instructions in a branch delay slot
arch/mips/dec/int-handler.S:198: Warning: macro instruction expanded into multiple instructions in a branch delay slot
Avoid this by open coding the PTR\_LA macros.
Signed-off-by: Ralf Baechle
Signed-off-by: Sasha Levin
commit 3930194e22c64d4f5dc4891aecd2956d6908856b
Author: Arnd Bergmann
Date: Mon Jan 16 14:20:54 2017 +0100
cpmac: remove hopeless #warning
[ Upstream commit d43e6fb4ac4abfe4ef7c102833ed02330ad701e0 ]
The #warning was present 10 years ago when the driver first got merged.
As the platform is rather obsolete by now, it seems very unlikely that
the warning will cause anyone to fix the code properly.
kernelci.org reports the warning for every build in the meantime, so
I think it's better to just turn it into a code comment to reduce
noise.
Signed-off-by: Arnd Bergmann
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9ef3aa4c76aaf8e6f0a2eaf42125b9e0e048caf1
Author: Arnd Bergmann
Date: Tue Jan 17 16:18:43 2017 +0100
MIPS: ralink: Remove unused rt\*\_wdt\_reset functions
[ Upstream commit 886f9c69fc68f56ddea34d3de51ac1fc2ac8dfbc ]
All pointers to these functions were removed, so now they produce
warnings:
arch/mips/ralink/rt305x.c:92:13: error: 'rt305x\_wdt\_reset' defined but not used [-Werror=unused-function]
This removes the functions. If we need them again, the patch can be
reverted later.
Fixes: f576fb6a0700 ("MIPS: ralink: cleanup the soc specific pinmux data")
Signed-off-by: Arnd Bergmann
Cc: John Crispin
Cc: Colin Ian King
Cc: linux-mips@linux-mips.org
Cc: linux-kernel@vger.kernel.org
Patchwork: https://patchwork.linux-mips.org/patch/15044/
Signed-off-by: Ralf Baechle
Signed-off-by: Sasha Levin
commit 99f864ed7610a19823d59e507b10afa357027f37
Author: John Crispin
Date: Tue Dec 20 19:12:46 2016 +0100
MIPS: ralink: Cosmetic change to prom\_init().
[ Upstream commit 9c48568b3692f1a56cbf1935e4eea835e6b185b1 ]
Over the years the code has been changed various times leading to
argc/argv being defined in a different function to where we actually
use the variables. Clean this up by moving them to prom\_init\_cmdline().
Signed-off-by: John Crispin
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/14902/
Signed-off-by: Ralf Baechle
Signed-off-by: Sasha Levin
commit cbc32b44e8c50e777b7067f3e5a9df2c7564cde3
Author: Arnd Bergmann
Date: Fri Feb 3 10:49:17 2017 +0100
mtd: pmcmsp: use kstrndup instead of kmalloc+strncpy
[ Upstream commit 906b268477bc03daaa04f739844c120fe4dbc991 ]
kernelci.org reports a warning for this driver, as it copies a local
variable into a 'const char \*' string:
drivers/mtd/maps/pmcmsp-flash.c:149:30: warning: passing argument 1 of 'strncpy' discards 'const' qualifier from pointer target type [-Wdiscarded-qualifiers]
Using kstrndup() simplifies the code and avoids the warning.
Signed-off-by: Arnd Bergmann
Acked-by: Marek Vasut
Signed-off-by: Brian Norris
Signed-off-by: Sasha Levin
commit 0b9604a2c14691346459a27a2089e8226c735fea
Author: Arnd Bergmann
Date: Tue Jan 17 16:18:46 2017 +0100
MIPS: ip22: Fix ip28 build for modern gcc
[ Upstream commit 23ca9b522383d3b9b7991d8586db30118992af4a ]
kernelci reports a failure of the ip28\_defconfig build after upgrading its
gcc version:
arch/mips/sgi-ip22/Platform:29: \*\*\* gcc doesn't support needed option -mr10k-cache-barrier=store. Stop.
The problem apparently is that the -mr10k-cache-barrier=store option is now
rejected for CPUs other than r10k. Explicitly including the CPU in the
check fixes this and is safe because both options were introduced in
gcc-4.4.
Signed-off-by: Arnd Bergmann
Cc: linux-mips@linux-mips.org
Cc: linux-kernel@vger.kernel.org
Patchwork: https://patchwork.linux-mips.org/patch/15049/
Signed-off-by: Ralf Baechle
Signed-off-by: Sasha Levin
commit c5e13155b83cce56be3b939287c567058460218e
Author: Arnd Bergmann
Date: Fri Feb 3 17:43:50 2017 +0100
MIPS: ip27: Disable qlge driver in defconfig
[ Upstream commit b617649468390713db1515ea79fc772d2eb897a8 ]
One of the last remaining failures in kernelci.org is for a gcc bug:
drivers/net/ethernet/qlogic/qlge/qlge\_main.c:4819:1: error: insn does not satisfy its constraints:
drivers/net/ethernet/qlogic/qlge/qlge\_main.c:4819:1: internal compiler error: in extract\_constrain\_insn, at recog.c:2190
This is apparently broken in gcc-6 but fixed in gcc-7, and I cannot
reproduce the problem here. However, it is clear that ip27\_defconfig
does not actually need this driver as the platform has only PCI-X but
not PCIe, and the qlge adapter in turn is PCIe-only.
The driver was originally enabled in 2010 along with lots of other
drivers.
Fixes: 59d302b342e5 ("MIPS: IP27: Make defconfig useful again.")
Signed-off-by: Arnd Bergmann
Cc: Ralf Baechle
Cc: linux-mips@linux-mips.org
Cc: linux-kernel@vger.kernel.org
Patchwork: https://patchwork.linux-mips.org/patch/15197/
Signed-off-by: James Hogan
Signed-off-by: Sasha Levin
commit ce842a00e5c4d1c4ac3e6eea1217c48f0cfb09b3
Author: Arnd Bergmann
Date: Fri Feb 3 23:33:23 2017 +0100
crypto: improve gcc optimization flags for serpent and wp512
[ Upstream commit 7d6e9105026788c497f0ab32fa16c82f4ab5ff61 ]
An ancient gcc bug (first reported in 2003) has apparently resurfaced
on MIPS, where kernelci.org reports an overly large stack frame in the
whirlpool hash algorithm:
crypto/wp512.c:987:1: warning: the frame size of 1112 bytes is larger than 1024 bytes [-Wframe-larger-than=]
With some testing in different configurations, I'm seeing large
variations in stack frames size up to 1500 bytes for what should have
around 300 bytes at most. I also checked the reference implementation,
which is essentially the same code but also comes with some test and
benchmarking infrastructure.
It seems that recent compiler versions on at least arm, arm64 and powerpc
have a partial fix for this problem, but enabling "-fsched-pressure", but
even with that fix they suffer from the issue to a certain degree. Some
testing on arm64 shows that the time needed to hash a given amount of
data is roughly proportional to the stack frame size here, which makes
sense given that the wp512 implementation is doing lots of loads for
table lookups, and the problem with the overly large stack is a result
of doing a lot more loads and stores for spilled registers (as seen from
inspecting the object code).
Disabling -fschedule-insns consistently fixes the problem for wp512,
in my collection of cross-compilers, the results are consistently better
or identical when comparing the stack sizes in this function, though
some architectures (notable x86) have schedule-insns disabled by
default.
The four columns are:
default: -O2
press: -O2 -fsched-pressure
nopress: -O2 -fschedule-insns -fno-sched-pressure
nosched: -O2 -no-schedule-insns (disables sched-pressure)
default press nopress nosched
alpha-linux-gcc-4.9.3 1136 848 1136 176
am33\_2.0-linux-gcc-4.9.3 2100 2076 2100 2104
arm-linux-gnueabi-gcc-4.9.3 848 848 1048 352
cris-linux-gcc-4.9.3 272 272 272 272
frv-linux-gcc-4.9.3 1128 1000 1128 280
hppa64-linux-gcc-4.9.3 1128 336 1128 184
hppa-linux-gcc-4.9.3 644 308 644 276
i386-linux-gcc-4.9.3 352 352 352 352
m32r-linux-gcc-4.9.3 720 656 720 268
microblaze-linux-gcc-4.9.3 1108 604 1108 256
mips64-linux-gcc-4.9.3 1328 592 1328 208
mips-linux-gcc-4.9.3 1096 624 1096 240
powerpc64-linux-gcc-4.9.3 1088 432 1088 160
powerpc-linux-gcc-4.9.3 1080 584 1080 224
s390-linux-gcc-4.9.3 456 456 624 360
sh3-linux-gcc-4.9.3 292 292 292 292
sparc64-linux-gcc-4.9.3 992 240 992 208
sparc-linux-gcc-4.9.3 680 592 680 312
x86\_64-linux-gcc-4.9.3 224 240 272 224
xtensa-linux-gcc-4.9.3 1152 704 1152 304
aarch64-linux-gcc-7.0.0 224 224 1104 208
arm-linux-gnueabi-gcc-7.0.1 824 824 1048 352
mips-linux-gcc-7.0.0 1120 648 1120 272
x86\_64-linux-gcc-7.0.1 240 240 304 240
arm-linux-gnueabi-gcc-4.4.7 840 392
arm-linux-gnueabi-gcc-4.5.4 784 728 784 320
arm-linux-gnueabi-gcc-4.6.4 736 728 736 304
arm-linux-gnueabi-gcc-4.7.4 944 784 944 352
arm-linux-gnueabi-gcc-4.8.5 464 464 760 352
arm-linux-gnueabi-gcc-4.9.3 848 848 1048 352
arm-linux-gnueabi-gcc-5.3.1 824 824 1064 336
arm-linux-gnueabi-gcc-6.1.1 808 808 1056 344
arm-linux-gnueabi-gcc-7.0.1 824 824 1048 352
Trying the same test for serpent-generic, the picture is a bit different,
and while -fno-schedule-insns is generally better here than the default,
-fsched-pressure wins overall, so I picked that instead.
default press nopress nosched
alpha-linux-gcc-4.9.3 1392 864 1392 960
am33\_2.0-linux-gcc-4.9.3 536 524 536 528
arm-linux-gnueabi-gcc-4.9.3 552 552 776 536
cris-linux-gcc-4.9.3 528 528 528 528
frv-linux-gcc-4.9.3 536 400 536 504
hppa64-linux-gcc-4.9.3 524 208 524 480
hppa-linux-gcc-4.9.3 768 472 768 508
i386-linux-gcc-4.9.3 564 564 564 564
m32r-linux-gcc-4.9.3 712 576 712 532
microblaze-linux-gcc-4.9.3 724 392 724 512
mips64-linux-gcc-4.9.3 720 384 720 496
mips-linux-gcc-4.9.3 728 384 728 496
powerpc64-linux-gcc-4.9.3 704 304 704 480
powerpc-linux-gcc-4.9.3 704 296 704 480
s390-linux-gcc-4.9.3 560 560 592 536
sh3-linux-gcc-4.9.3 540 540 540 540
sparc64-linux-gcc-4.9.3 544 352 544 496
sparc-linux-gcc-4.9.3 544 344 544 496
x86\_64-linux-gcc-4.9.3 528 536 576 528
xtensa-linux-gcc-4.9.3 752 544 752 544
aarch64-linux-gcc-7.0.0 432 432 656 480
arm-linux-gnueabi-gcc-7.0.1 616 616 808 536
mips-linux-gcc-7.0.0 720 464 720 488
x86\_64-linux-gcc-7.0.1 536 528 600 536
arm-linux-gnueabi-gcc-4.4.7 592 440
arm-linux-gnueabi-gcc-4.5.4 776 448 776 544
arm-linux-gnueabi-gcc-4.6.4 776 448 776 544
arm-linux-gnueabi-gcc-4.7.4 768 448 768 544
arm-linux-gnueabi-gcc-4.8.5 488 488 776 544
arm-linux-gnueabi-gcc-4.9.3 552 552 776 536
arm-linux-gnueabi-gcc-5.3.1 552 552 776 536
arm-linux-gnueabi-gcc-6.1.1 560 560 776 536
arm-linux-gnueabi-gcc-7.0.1 616 616 808 536
I did not do any runtime tests with serpent, so it is possible that stack
frame size does not directly correlate with runtime performance here and
it actually makes things worse, but it's more likely to help here, and
the reduced stack frame size is probably enough reason to apply the patch,
especially given that the crypto code is often used in deep call chains.
Link: https://kernelci.org/build/id/58797d7559b5149efdf6c3a9/logs/
Link: http://www.larc.usp.br/~pbarreto/WhirlpoolPage.html
Link: https://gcc.gnu.org/bugzilla/show\_bug.cgi?id=11488
Link: https://gcc.gnu.org/bugzilla/show\_bug.cgi?id=79149
Cc: Ralf Baechle
Signed-off-by: Arnd Bergmann
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 7c2b8b923b73a9977d044f031cbcf6257e226107
Author: Arnd Bergmann
Date: Mon Jan 16 12:06:09 2017 +0100
libceph: use BUG() instead of BUG\_ON(1)
[ Upstream commit d24cdcd3e40a6825135498e11c20c7976b9bf545 ]
I ran into this compile warning, which is the result of BUG\_ON(1)
not always leading to the compiler treating the code path as
unreachable:
include/linux/ceph/osdmap.h: In function 'ceph\_can\_shift\_osds':
include/linux/ceph/osdmap.h:62:1: error: control reaches end of non-void function [-Werror=return-type]
Using BUG() here avoids the warning.
Signed-off-by: Arnd Bergmann
Signed-off-by: Ilya Dryomov
Signed-off-by: Sasha Levin
commit 2c40db2389d1a839c2fd308d1295360e48822859
Author: Heiko Carstens
Date: Sun Feb 5 23:03:18 2017 +0100
s390: use correct input data address for setup\_randomness
[ Upstream commit 4920e3cf77347d7d7373552d4839e8d832321313 ]
The current implementation of setup\_randomness uses the stack address
and therefore the pointer to the SYSIB 3.2.2 block as input data
address. Furthermore the length of the input data is the number of
virtual-machine description blocks which is typically one.
This means that typically a single zero byte is fed to
add\_device\_randomness.
Fix both of these and use the address of the first virtual machine
description block as input data address and also use the correct
length.
Fixes: bcfcbb6bae64 ("s390: add system information as device randomness")
Signed-off-by: Heiko Carstens
Signed-off-by: Martin Schwidefsky
Signed-off-by: Sasha Levin
commit 5a5c7a67ca04f669586444685d3b4e43b9ad865d
Author: Heiko Carstens
Date: Sat Feb 4 11:40:36 2017 +0100
s390: make setup\_randomness work
[ Upstream commit da8fd820f389a0e29080b14c61bf5cf1d8ef5ca1 ]
Commit bcfcbb6bae64 ("s390: add system information as device
randomness") intended to add some virtual machine specific information
to the randomness pool.
Unfortunately it uses the page allocator before it is ready to use. In
result the page allocator always returns NULL and the setup\_randomness
function never adds anything to the randomness pool.
To fix this use memblock\_alloc and memblock\_free instead.
Fixes: bcfcbb6bae64 ("s390: add system information as device randomness")
Signed-off-by: Heiko Carstens
Signed-off-by: Martin Schwidefsky
Signed-off-by: Sasha Levin
commit a12924ee8b30ffdd6de324d425ac80fff328c4da
Author: Chao Peng
Date: Tue Feb 21 03:50:01 2017 -0500
KVM: VMX: use correct vmcs\_read/write for guest segment selector/base
[ Upstream commit 96794e4ed4d758272c486e1529e431efb7045265 ]
Guest segment selector is 16 bit field and guest segment base is natural
width field. Fix two incorrect invocations accordingly.
Without this patch, build fails when aggressive inlining is used with ICC.
Cc: stable@vger.kernel.org
Signed-off-by: Chao Peng
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 209fd3f3ef14e0b0a1d07d6ff27d75c49e656e84
Author: Alexander Popov
Date: Tue Feb 28 19:54:40 2017 +0300
tty: n\_hdlc: get rid of racy n\_hdlc.tbuf
[ Upstream commit 82f2341c94d270421f383641b7cd670e474db56b ]
Currently N\_HDLC line discipline uses a self-made singly linked list for
data buffers and has n\_hdlc.tbuf pointer for buffer retransmitting after
an error.
The commit be10eb7589337e5defbe214dae038a53dd21add8
("tty: n\_hdlc add buffer flushing") introduced racy access to n\_hdlc.tbuf.
After tx error concurrent flush\_tx\_queue() and n\_hdlc\_send\_frames() can put
one data buffer to tx\_free\_buf\_list twice. That causes double free in
n\_hdlc\_release().
Let's use standard kernel linked list and get rid of n\_hdlc.tbuf:
in case of tx error put current data buffer after the head of tx\_buf\_list.
Signed-off-by: Alexander Popov
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 33455ca987a06dd2f1def30cf34607cd165966bd
Author: Jiri Slaby
Date: Thu Nov 26 19:28:26 2015 +0100
TTY: n\_hdlc, fix lockdep false positive
[ Upstream commit e9b736d88af1a143530565929390cadf036dc799 ]
The class of 4 n\_hdls buf locks is the same because a single function
n\_hdlc\_buf\_list\_init is used to init all the locks. But since
flush\_tx\_queue takes n\_hdlc->tx\_buf\_list.spinlock and then calls
n\_hdlc\_buf\_put which takes n\_hdlc->tx\_free\_buf\_list.spinlock, lockdep
emits a warning:
=============================================
[ INFO: possible recursive locking detected ]
4.3.0-25.g91e30a7-default #1 Not tainted
---------------------------------------------
a.out/1248 is trying to acquire lock:
(&(&list->spinlock)->rlock){......}, at: [] n\_hdlc\_buf\_put+0x20/0x60 [n\_hdlc]
but task is already holding lock:
(&(&list->spinlock)->rlock){......}, at: [] n\_hdlc\_tty\_ioctl+0x127/0x1d0 [n\_hdlc]
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(&(&list->spinlock)->rlock);
lock(&(&list->spinlock)->rlock);
\*\*\* DEADLOCK \*\*\*
May be due to missing lock nesting notation
2 locks held by a.out/1248:
#0: (&tty->ldisc\_sem){++++++}, at: [] tty\_ldisc\_ref\_wait+0x20/0x50
#1: (&(&list->spinlock)->rlock){......}, at: [] n\_hdlc\_tty\_ioctl+0x127/0x1d0 [n\_hdlc]
...
Call Trace:
...
[] \_raw\_spin\_lock\_irqsave+0x50/0x70
[] n\_hdlc\_buf\_put+0x20/0x60 [n\_hdlc]
[] n\_hdlc\_tty\_ioctl+0x144/0x1d0 [n\_hdlc]
[] tty\_ioctl+0x3f1/0xe40
...
Fix it by initializing the spin\_locks separately. This removes also
reduntand memset of a freshly kzallocated space.
Signed-off-by: Jiri Slaby
Reported-by: Dmitry Vyukov
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 14d82e73c8f9288866619df7aa32745c35bfa7c5
Author: James Smart
Date: Sun Feb 12 13:52:25 2017 -0800
scsi: lpfc: Correct WQ creation for pagesize
[ Upstream commit 8ea73db486cda442f0671f4bc9c03a76be398a28 ]
Correct WQ creation for pagesize
The driver was calculating the adapter command pagesize indicator from
the system pagesize. However, the buffers the driver allocates are only
one size (SLI4\_PAGE\_SIZE), so no calculation was necessary.
Signed-off-by: Dick Kennedy
Signed-off-by: James Smart
Reviewed-by: Hannes Reinecke
Reviewed-by: Johannes Thumshirn
Reviewed-by: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit aab728f85cfcce7db6d6b9d1578d8a39e33d9a86
Author: Ralf Baechle
Date: Thu Dec 15 12:27:21 2016 +0100
MIPS: IP22: Reformat inline assembler code to modern standards.
[ Upstream commit f9f1c8db1c37253805eaa32265e1e1af3ae7d0a4 ]
Signed-off-by: Ralf Baechle
Signed-off-by: Sasha Levin
commit 1814c0e512891a6a742384faa17e6362db5c1de0
Author: Christoph Hellwig
Date: Mon Feb 20 07:21:33 2017 +0100
nfsd: special case truncates some more
[ Upstream commit 41f53350a0f36a7b8e31bec0d0ca907e028ab4cd ]
Both the NFS protocols and the Linux VFS use a setattr operation with a
bitmap of attributs to set to set various file attributes including the
file size and the uid/gid.
The Linux syscalls never mixes size updates with unrelated updates like
the uid/gid, and some file systems like XFS and GFS2 rely on the fact
that truncates might not update random other attributes, and many other
file systems handle the case but do not update the different attributes
in the same transaction. NFSD on the other hand passes the attributes
it gets on the wire more or less directly through to the VFS, leading to
updates the file systems don't expect. XFS at least has an assert on
the allowed attributes, which caught an unusual NFS client setting the
size and group at the same time.
To handle this issue properly this switches nfsd to call vfs\_truncate
for size changes, and then handle all other attributes through
notify\_change. As a side effect this also means less boilerplace code
around the size change as we can now reuse the VFS code.
Signed-off-by: Christoph Hellwig
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
commit 722690069fc46fb733b35dd80cebae359c79ff09
Author: Christoph Hellwig
Date: Mon Feb 20 17:04:42 2017 -0500
nfsd: minor nfsd\_setattr cleanup
[ Upstream commit 758e99fefe1d9230111296956335cd35995c0eaf ]
Simplify exit paths, size\_change use.
Signed-off-by: Christoph Hellwig
Cc: stable@kernel.org
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
commit b1427077e8b8e188bece01f03908a736429e1b0f
Author: Peter Rosin
Date: Wed Feb 1 21:40:56 2017 +0100
iio: pressure: mpl3115: do not rely on structure field ordering
[ Upstream commit 9cf6cdba586ced75c69b8314b88b2d2f5ce9b3ed ]
Fixes a regression triggered by a change in the layout of
struct iio\_chan\_spec, but the real bug is in the driver which assumed
a specific structure layout in the first place. Hint: the two bits were
not OR:ed together as implied by the indentation prior to this patch,
there was a comma between them, which accidentally moved the ...\_SCALE
bit to the next structure field. That field was .info\_mask\_shared\_by\_type
before the \_available attributes was added by commit 51239600074b
("iio:core: add a callback to allow drivers to provide \_available
attributes") and .info\_mask\_separate\_available afterwards, and the
regression happened.
info\_mask\_shared\_by\_type is actually a better choice than the originally
intended info\_mask\_separate for the ...\_SCALE bit since a constant is
returned from mpl3115\_read\_raw for the scale. Using
info\_mask\_shared\_by\_type also preserves the behavior from before the
regression and is therefore less likely to cause other interesting side
effects.
The above mentioned regression causes an unintended sysfs attibute to
show up that is not backed by code, in turn causing the following NULL
pointer defererence to happen on access.
Segmentation fault
Unable to handle kernel NULL pointer dereference at virtual address 00000000
pgd = ecc3c000
[00000000] \*pgd=87f91831
Internal error: Oops: 80000007 [#1] SMP ARM
Modules linked in:
CPU: 1 PID: 1051 Comm: cat Not tainted 4.10.0-rc5-00009-gffd8858-dirty #3
Hardware name: Freescale i.MX6 Quad/DualLite (Device Tree)
task: ed54ec00 task.stack: ee2bc000
PC is at 0x0
LR is at iio\_read\_channel\_info\_avail+0x40/0x280
pc : [<00000000>] lr : [] psr: a0070013
sp : ee2bdda8 ip : 00000000 fp : ee2bddf4
r10: c0a53c74 r9 : ed79f000 r8 : ee8d1018
r7 : 00001000 r6 : 00000fff r5 : ee8b9a00 r4 : ed79f000
r3 : ee2bddc4 r2 : ee2bddbc r1 : c0a86dcc r0 : ee8d1000
Flags: NzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment none
Control: 10c5387d Table: 3cc3c04a DAC: 00000051
Process cat (pid: 1051, stack limit = 0xee2bc210)
Stack: (0xee2bdda8 to 0xee2be000)
dda0: ee2bddc0 00000002 c016d720 c016d394 ed54ec00 00000000
ddc0: 60070013 ed413780 00000001 edffd480 ee8b9a00 00000fff 00001000 ee8d1018
dde0: ed79f000 c0a53c74 ee2bde0c ee2bddf8 c0513c58 c06fbbe8 edffd480 edffd540
de00: ee2bde3c ee2bde10 c0293474 c0513c40 c02933e4 ee2bde60 00000001 ed413780
de20: 00000001 ed413780 00000000 edffd480 ee2bde4c ee2bde40 c0291d00 c02933f0
de40: ee2bde9c ee2bde50 c024679c c0291ce0 edffd4b0 b6e37000 00020000 ee2bdf78
de60: 00000000 00000000 ed54ec00 ed013200 00000817 c0a111fc edffd540 ed413780
de80: b6e37000 00020000 00020000 ee2bdf78 ee2bded4 ee2bdea0 c0292890 c0246604
dea0: c0117940 c016ba50 00000025 c0a111fc b6e37000 ed413780 ee2bdf78 00020000
dec0: ee2bc000 b6e37000 ee2bdf44 ee2bded8 c021d158 c0292770 c0117764 b6e36004
dee0: c0f0d7c4 ee2bdfb0 b6f89228 00021008 ee2bdfac ee2bdf00 c0101374 c0117770
df00: 00000000 00000000 ee2bc000 00000000 ee2bdf34 ee2bdf20 c016ba04 c0171080
df20: 00000000 00020000 ed413780 b6e37000 00000000 ee2bdf78 ee2bdf74 ee2bdf48
df40: c021e7a0 c021d130 c023e300 c023e280 ee2bdf74 00000000 00000000 ed413780
df60: ed413780 00020000 ee2bdfa4 ee2bdf78 c021e870 c021e71c 00000000 00000000
df80: 00020000 00020000 b6e37000 00000003 c0108084 00000000 00000000 ee2bdfa8
dfa0: c0107ee0 c021e838 00020000 00020000 00000003 b6e37000 00020000 0001a2b4
dfc0: 00020000 00020000 b6e37000 00000003 7fffe000 00000000 00000000 00020000
dfe0: 00000000 be98eb4c 0000c740 b6f1985c 60070010 00000003 00000000 00000000
Backtrace:
[] (iio\_read\_channel\_info\_avail) from [] (dev\_attr\_show+0x24/0x50)
r10:c0a53c74 r9:ed79f000 r8:ee8d1018 r7:00001000 r6:00000fff r5:ee8b9a00
r4:edffd480
[] (dev\_attr\_show) from [] (sysfs\_kf\_seq\_show+0x90/0x110)
r5:edffd540 r4:edffd480
[] (sysfs\_kf\_seq\_show) from [] (kernfs\_seq\_show+0x2c/0x30)
r10:edffd480 r9:00000000 r8:ed413780 r7:00000001 r6:ed413780 r5:00000001
r4:ee2bde60 r3:c02933e4
[] (kernfs\_seq\_show) from [] (seq\_read+0x1a4/0x4e0)
[] (seq\_read) from [] (kernfs\_fop\_read+0x12c/0x1cc)
r10:ee2bdf78 r9:00020000 r8:00020000 r7:b6e37000 r6:ed413780 r5:edffd540
r4:c0a111fc
[] (kernfs\_fop\_read) from [] (\_\_vfs\_read+0x34/0x118)
r10:b6e37000 r9:ee2bc000 r8:00020000 r7:ee2bdf78 r6:ed413780 r5:b6e37000
r4:c0a111fc
[] (\_\_vfs\_read) from [] (vfs\_read+0x90/0x11c)
r8:ee2bdf78 r7:00000000 r6:b6e37000 r5:ed413780 r4:00020000
[] (vfs\_read) from [] (SyS\_read+0x44/0x90)
r8:00020000 r7:ed413780 r6:ed413780 r5:00000000 r4:00000000
[] (SyS\_read) from [] (ret\_fast\_syscall+0x0/0x1c)
r10:00000000 r8:c0108084 r7:00000003 r6:b6e37000 r5:00020000 r4:00020000
Code: bad PC value
---[ end trace 9c4938ccd0389004 ]---
Fixes: cc26ad455f57 ("iio: Add Freescale MPL3115A2 pressure / temperature sensor driver")
Fixes: 51239600074b ("iio:core: add a callback to allow drivers to provide \_available attributes")
Reported-by: Ken Lin
Tested-by: Ken Lin
Signed-off-by: Peter Rosin
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit 776863245d20de1ea9fd3dd484e95a50c29070a8
Author: Peter Rosin
Date: Wed Feb 1 21:40:57 2017 +0100
iio: pressure: mpl115: do not rely on structure field ordering
[ Upstream commit 6a6e1d56a0769795a36c0461c64bf5e5b9bbb4c0 ]
Fixes a regression triggered by a change in the layout of
struct iio\_chan\_spec, but the real bug is in the driver which assumed
a specific structure layout in the first place. Hint: the three bits were
not OR:ed together as implied by the indentation prior to this patch,
there was a comma between the first two, which accidentally moved the
...\_SCALE and ...\_OFFSET bits to the next structure field. That field
was .info\_mask\_shared\_by\_type before the \_available attributes was added
by commit 51239600074b ("iio:core: add a callback to allow drivers to
provide \_available attributes") and .info\_mask\_separate\_available
afterwards, and the regression happened.
info\_mask\_shared\_by\_type is actually a better choice than the originally
intended info\_mask\_separate for the ...\_SCALE and ...\_OFFSET bits since
a constant is returned from mpl115\_read\_raw for the scale/offset. Using
info\_mask\_shared\_by\_type also preserves the behavior from before the
regression and is therefore less likely to cause other interesting side
effects.
The above mentioned regression causes unintended sysfs attibutes to
show up that are not backed by code, in turn causing a NULL pointer
defererence to happen on access.
Fixes: 3017d90e8931 ("iio: Add Freescale MPL115A2 pressure / temperature sensor driver")
Fixes: 51239600074b ("iio:core: add a callback to allow drivers to provide \_available attributes")
Signed-off-by: Peter Rosin
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit 0423dcf950cabb9613fcfc32b5966d71abe3686e
Author: Theodore Ts'o
Date: Sat Feb 4 23:38:06 2017 -0500
ext4: preserve the needs\_recovery flag when the journal is aborted
[ Upstream commit 97abd7d4b5d9c48ec15c425485f054e1c15e591b ]
If the journal is aborted, the needs\_recovery feature flag should not
be removed. Otherwise, it's the journal might not get replayed and
this could lead to more data getting lost.
Signed-off-by: Theodore Ts'o
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
commit 04a8178ad1eb8a96b4af1c93eac3a72304328996
Author: Hannes Reinecke
Date: Tue Apr 26 08:06:58 2016 +0200
sd: get disk reference in sd\_check\_events()
[ Upstream commit eb72d0bb84eee5d0dc3044fd17b75e7101dabb57 ]
sd\_check\_events() is called asynchronously, and might race
with device removal. So always take a disk reference when
processing the event to avoid the device being removed while
the event is processed.
Signed-off-by: Hannes Reinecke
Reviewed-by: Ewan D. Milne
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 6c2310c96a6f401838d41f08c3df756954f6a6d5
Author: Guennadi Liakhovetski
Date: Mon Dec 12 09:16:51 2016 -0200
[media] uvcvideo: Fix a wrong macro
[ Upstream commit 17c341ec0115837a610b2da15e32546e26068234 ]
Don't mix up UVC\_BUF\_STATE\_\* and VB2\_BUF\_STATE\_\* codes.
Fixes: 6998b6fb4b1c ("[media] uvcvideo: Use videobuf2-vmalloc")
Cc: stable@vger.kernel.org
Signed-off-by: Guennadi Liakhovetski
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
commit 7a69ea1de73b9be5d5b18d81980e5f9972a39748
Author: Maxime Jayat
Date: Tue Feb 21 18:35:51 2017 +0100
net: socket: fix recvmmsg not returning error from sock\_error
[ Upstream commit e623a9e9dec29ae811d11f83d0074ba254aba374 ]
Commit 34b88a68f26a ("net: Fix use after free in the recvmmsg exit path"),
changed the exit path of recvmmsg to always return the datagrams
variable and modified the error paths to set the variable to the error
code returned by recvmsg if necessary.
However in the case sock\_error returned an error, the error code was
then ignored, and recvmmsg returned 0.
Change the error path of recvmmsg to correctly return the error code
of sock\_error.
The bug was triggered by using recvmmsg on a CAN interface which was
not up. Linux 4.6 and later return 0 in this case while earlier
releases returned -ENETDOWN.
Fixes: 34b88a68f26a ("net: Fix use after free in the recvmmsg exit path")
Signed-off-by: Maxime Jayat
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c9556862a64b5ac85bfee1cfd4313615dc21d6f8
Author: David S. Miller
Date: Fri Feb 17 16:19:39 2017 -0500
irda: Fix lockdep annotations in hashbin\_delete().
[ Upstream commit 4c03b862b12f980456f9de92db6d508a4999b788 ]
A nested lock depth was added to the hasbin\_delete() code but it
doesn't actually work some well and results in tons of lockdep splats.
Fix the code instead to properly drop the lock around the operation
and just keep peeking the head of the hashbin queue.
Reported-by: Dmitry Vyukov
Tested-by: Dmitry Vyukov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7babaac5d49ee7a88a5a324668dd13b575635d09
Author: Eric Dumazet
Date: Tue Feb 14 09:03:51 2017 -0800
packet: fix races in fanout\_add()
[ Upstream commit d199fab63c11998a602205f7ee7ff7c05c97164b ]
Multiple threads can call fanout\_add() at the same time.
We need to grab fanout\_mutex earlier to avoid races that could
lead to one thread freeing po->rollover that was set by another thread.
Do the same in fanout\_release(), for peace of mind, and to help us
finding lockdep issues earlier.
Fixes: dc99f600698d ("packet: Add fanout support.")
Fixes: 0648ab70afe6 ("packet: rollover prepare: per-socket state")
Signed-off-by: Eric Dumazet
Cc: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4fc8ff15e26ecfe974b7a3f386550bcfd259b8b1
Author: Eric Dumazet
Date: Sun Feb 12 14:03:52 2017 -0800
net/llc: avoid BUG\_ON() in skb\_orphan()
[ Upstream commit 8b74d439e1697110c5e5c600643e823eb1dd0762 ]
It seems nobody used LLC since linux-3.12.
Fortunately fuzzers like syzkaller still know how to run this code,
otherwise it would be no fun.
Setting skb->sk without skb->destructor leads to all kinds of
bugs, we now prefer to be very strict about it.
Ideally here we would use skb\_set\_owner() but this helper does not exist yet,
only CAN seems to have a private helper for that.
Fixes: 376c7311bdb6 ("net: add a temporary sanity check in skb\_orphan()")
Signed-off-by: Eric Dumazet
Reported-by: Andrey Konovalov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c42a8f220a83dc4460acd97e47388ffaa362c5b1
Author: Colin Ian King
Date: Mon May 16 17:22:54 2016 +0100
rtc: interface: ignore expired timers when enqueuing new timers
[ Upstream commit 2b2f5ff00f63847d95adad6289bd8b05f5983dd5 ]
This patch fixes a RTC wakealarm issue, namely, the event fires during
hibernate and is not cleared from the list, causing hwclock to block.
The current enqueuing does not trigger an alarm if any expired timers
already exist on the timerqueue. This can occur when a RTC wake alarm
is used to wake a machine out of hibernate and the resumed state has
old expired timers that have not been removed from the timer queue.
This fix skips over any expired timers and triggers an alarm if there
are no pending timers on the timerqueue. Note that the skipped expired
timer will get reaped later on, so there is no need to clean it up
immediately.
The issue can be reproduced by putting a machine into hibernate and
waking it with the RTC wakealarm. Running the example RTC test program
from tools/testing/selftests/timers/rtctest.c after the hibernate will
block indefinitely. With the fix, it no longer blocks after the
hibernate resume.
BugLink: http://bugs.launchpad.net/bugs/1333569
Signed-off-by: Colin Ian King
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
commit 30f378e4208a34b767e1e7ef89644f4dd5e455d9
Author: Kent Overstreet
Date: Wed Oct 26 20:31:17 2016 -0700
bcache: Make gc wakeup sane, remove set\_task\_state()
[ Upstream commit be628be09563f8f6e81929efbd7cf3f45c344416 ]
Signed-off-by: Kent Overstreet
Signed-off-by: Sasha Levin
commit 0f9c022c14de92601b65a475cb71c8dc2bc3d9a4
Author: Johannes Thumshirn
Date: Tue Jan 31 10:16:00 2017 +0100
scsi: don't BUG\_ON() empty DMA transfers
[ Upstream commit fd3fc0b4d7305fa7246622dcc0dec69c42443f45 ]
Don't crash the machine just because of an empty transfer. Use WARN\_ON()
combined with returning an error.
Found by Dmitry Vyukov and syzkaller.
[ Changed to "WARN\_ON\_ONCE()". Al has a patch that should fix the root
cause, but a BUG\_ON() is not acceptable in any case, and a WARN\_ON()
might still be a cause of excessive log spamming.
NOTE! If this warning ever triggers, we may end up leaking resources,
since this doesn't bother to try to clean the command up. So this
WARN\_ON\_ONCE() triggering does imply real problems. But BUG\_ON() is
much worse.
People really need to stop using BUG\_ON() for "this shouldn't ever
happen". It makes pretty much any bug worse. - Linus ]
Signed-off-by: Johannes Thumshirn
Reported-by: Dmitry Vyukov
Cc: James Bottomley
Cc: Al Viro
Cc: stable@kernel.org
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin


=== Content from usn.ubuntu.com_1eabcf2d_20250125_123733.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3619-1: Linux kernel vulnerabilities

4 April 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Snapdragon processors

## Details

Jann Horn discovered that the Berkeley Packet Filter (BPF) implementation

in the Linux kernel improperly performed sign extension in some situations.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-16995](/security/CVE-2017-16995))

It was discovered that a race condition leading to a use-after-free

vulnerability existed in the ALSA PCM subsystem of the Linux kernel. A

local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-0861](/security/CVE-2017-0861))

It was discovered that the KVM implementation in the Linux kernel allowed

passthrough of the diagnostic I/O port 0x80. An attacker in a guest VM

could use this to cause a denial of service (system crash) in the host OS.

([CVE-2017-1000407](/security/CVE-2017-1000407))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a use-after-free vulnerability existed in the

network namespaces implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2017-15129](/security/CVE-2017-15129))

It was discovered that the Advanced Linux Sound Architecture (ALSA)

subsystem in the Linux kernel contained a use-after-free when handling

device removal. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16528](/security/CVE-2017-16528))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the DiBcom DiB0700 USB DVB driver in the

Linux kernel did not properly handle detach events. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16646](/security/CVE-2017-16646))

Andrey Konovalov discovered that the CDC USB Ethernet driver did not

properly validate device descriptors. A physically proximate attacker could

use this to cause a denial of service (system crash). ([CVE-2017-16649](/security/CVE-2017-16649))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure vulnerability.

A physically proximate attacker could use this to expose sensitive

information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the HugeTLB component of the Linux kernel did not

properly handle holes in hugetlb ranges. A local attacker could use this to

expose sensitive information (kernel memory). ([CVE-2017-16994](/security/CVE-2017-16994))

It was discovered that the netfilter component of the Linux did not

properly restrict access to the connection tracking helpers list. A local

attacker could use this to bypass intended access restrictions.

([CVE-2017-17448](/security/CVE-2017-17448))

It was discovered that the netlink subsystem in the Linux kernel did not

properly restrict observations of netlink messages to the appropriate net

namespace. A local attacker could use this to expose sensitive information

(kernel netlink traffic). ([CVE-2017-17449](/security/CVE-2017-17449))

It was discovered that the netfilter passive OS fingerprinting (xt\_osf)

module did not properly perform access control checks. A local attacker

could improperly modify the system-wide OS fingerprint list.

([CVE-2017-17450](/security/CVE-2017-17450))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

contained an out-of-bounds read when handling memory-mapped I/O. A local

attacker could use this to expose sensitive information. ([CVE-2017-17741](/security/CVE-2017-17741))

It was discovered that the Salsa20 encryption algorithm implementations in

the Linux kernel did not properly handle zero-length inputs. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2017-17805](/security/CVE-2017-17805))

It was discovered that the HMAC implementation did not validate the state

of the underlying cryptographic hash algorithm. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-17806](/security/CVE-2017-17806))

It was discovered that the keyring implementation in the Linux kernel did

not properly check permissions when a key request was performed on a

task's default keyring. A local attacker could use this to add keys to

unauthorized keyrings. ([CVE-2017-17807](/security/CVE-2017-17807))

Alexei Starovoitov discovered that the Berkeley Packet Filter (BPF)

implementation in the Linux kernel contained a branch-pruning logic issue

around unreachable code. A local attacker could use this to cause a denial

of service. ([CVE-2017-17862](/security/CVE-2017-17862))

It was discovered that the parallel cryptography component of the Linux

kernel incorrectly freed kernel memory. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-18075](/security/CVE-2017-18075))

It was discovered that a race condition existed in the Device Mapper

component of the Linux kernel. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2017-18203](/security/CVE-2017-18203))

It was discovered that a race condition existed in the OCFS2 file system

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (kernel deadlock). ([CVE-2017-18204](/security/CVE-2017-18204))

It was discovered that an infinite loop could occur in the madvise(2)

implementation in the Linux kernel in certain circumstances. A local

attacker could use this to cause a denial of service (system hang).

([CVE-2017-18208](/security/CVE-2017-18208))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

It was discovered that the Broadcom NetXtremeII ethernet driver in the

Linux kernel did not properly validate Generic Segment Offload (GSO) packet

sizes. An attacker could use this to cause a denial of service (interface

unavailability). ([CVE-2018-1000026](/security/CVE-2018-1000026))

It was discovered that the Reliable Datagram Socket (RDS)

implementation in the Linux kernel contained an out-of-bounds write

during RDMA page allocation. An attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-5332](/security/CVE-2018-5332))

Mohamed Ghannam discovered a null pointer dereference in the RDS (Reliable

Datagram Sockets) protocol implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-5333](/security/CVE-2018-5333))

范龙飞 discovered that a race condition existed in loop block device

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5344](/security/CVE-2018-5344))

It was discovered that an integer overflow error existed in the futex

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash). ([CVE-2018-6927](/security/CVE-2018-6927))

It was discovered that a NULL pointer dereference existed in the RDS

(Reliable Datagram Sockets) protocol implementation in the Linux kernel. A

local attacker could use this to cause a denial of service (system crash).

([CVE-2018-7492](/security/CVE-2018-7492))

It was discovered that the Broadcom UniMAC MDIO bus controller driver in

the Linux kernel did not properly validate device resources. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-8043](/security/CVE-2018-8043))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1020-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.4.0-1020.25](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.4.0-1020.25)
* [linux-image-4.4.0-1054-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1054.63](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1054.63)
* [linux-image-4.4.0-1086-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1086.94](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1086.94)
* [linux-image-4.4.0-1088-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.4.0-1088.93](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.4.0-1088.93)
* [linux-image-4.4.0-119-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-0861](/security/CVE-2017-0861)
* [CVE-2017-1000407](/security/CVE-2017-1000407)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-15129](/security/CVE-2017-15129)
* [CVE-2017-16528](/security/CVE-2017-16528)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16646](/security/CVE-2017-16646)
* [CVE-2017-16649](/security/CVE-2017-16649)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-16994](/security/CVE-2017-16994)
* [CVE-2017-16995](/security/CVE-2017-16995)
* [CVE-2017-17448](/security/CVE-2017-17448)
* [CVE-2017-17449](/security/CVE-2017-17449)
* [CVE-2017-17450](/security/CVE-2017-17450)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-17741](/security/CVE-2017-17741)
* [CVE-2017-17805](/security/CVE-2017-17805)
* [CVE-2017-17806](/security/CVE-2017-17806)
* [CVE-2017-17807](/security/CVE-2017-17807)
* [CVE-2017-17862](/security/CVE-2017-17862)
* [CVE-2017-18075](/security/CVE-2017-18075)
* [CVE-2017-18203](/security/CVE-2017-18203)
* [CVE-2017-18204](/security/CVE-2017-18204)
* [CVE-2017-18208](/security/CVE-2017-18208)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2018-1000026](/security/CVE-2018-1000026)
* [CVE-2018-5332](/security/CVE-2018-5332)
* [CVE-2018-5333](/security/CVE-2018-5333)
* [CVE-2018-5344](/security/CVE-2018-5344)
* [CVE-2018-6927](/security/CVE-2018-6927)
* [CVE-2018-7492](/security/CVE-2018-7492)
* [CVE-2018-8043](/security/CVE-2018-8043)

## Related notices

* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3619-2](/security/notices/USN-3619-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3632-1](/security/notices/USN-3632-1)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3523-2](/security/notices/USN-3523-2)
* [USN-3633-1](/security/notices/USN-3633-1)
* [USN-3523-1](/security/notices/USN-3523-1)
* [USN-3523-3](/security/notices/USN-3523-3)
* [USN-3620-1](/security/notices/USN-3620-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3653-1](/security/notices/USN-3653-1)
* [USN-3657-1](/security/notices/USN-3657-1)
* [USN-3655-1](/security/notices/USN-3655-1)
* [USN-3653-2](/security/notices/USN-3653-2)
* [USN-3655-2](/security/notices/USN-3655-2)
* [USN-3698-2](/security/notices/USN-3698-2)
* [USN-3697-1](/security/notices/USN-3697-1)
* [USN-3698-1](/security/notices/USN-3698-1)
* [USN-3697-2](/security/notices/USN-3697-2)
* [USN-3674-2](/security/notices/USN-3674-2)
* [USN-3674-1](/security/notices/USN-3674-1)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3630-2](/security/notices/USN-3630-2)
* [USN-3630-1](/security/notices/USN-3630-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from usn.ubuntu.com_37a1a987_20250125_123736.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3754-1: Linux kernel vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel

## Details

Ralf Spenneberg discovered that the ext4 implementation in the Linux kernel

did not properly validate meta block groups. An attacker with physical

access could use this to specially craft an ext4 image that causes a denial

of service (system crash). ([CVE-2016-10208](/security/CVE-2016-10208))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a buffer overflow existed in the ACPI table parsing

implementation in the Linux kernel. A local attacker could use this to

construct a malicious ACPI table that, when loaded, caused a denial of

service (system crash) or possibly execute arbitrary code.

([CVE-2017-11473](/security/CVE-2017-11473))

It was discovered that the generic SCSI driver in the Linux kernel did not

properly initialize data returned to user space in some situations. A local

attacker could use this to expose sensitive information (kernel memory).

([CVE-2017-14991](/security/CVE-2017-14991))

It was discovered that a race condition existed in the packet fanout

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-15649](/security/CVE-2017-15649))

Andrey Konovalov discovered that the Ultra Wide Band driver in the Linux

kernel did not properly check for an error condition. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16526](/security/CVE-2017-16526))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel

contained a use-after-free vulnerability. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16527](/security/CVE-2017-16527))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel did

not properly validate USB audio buffer descriptors. A physically proximate

attacker could use this cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2017-16529](/security/CVE-2017-16529))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB interface association descriptors. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16531](/security/CVE-2017-16531))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB HID descriptors. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16533](/security/CVE-2017-16533))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB BOS metadata. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16535](/security/CVE-2017-16535))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

It was discovered that the DM04/QQBOX USB driver in the Linux kernel did

not properly handle device attachment and warm-start. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16538](/security/CVE-2017-16538))

Andrey Konovalov discovered an out-of-bounds read in the GTCO digitizer USB

driver for the Linux kernel. A physically proximate attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16643](/security/CVE-2017-16643))

Andrey Konovalov discovered that the video4linux driver for Hauppauge HD

PVR USB devices in the Linux kernel did not properly handle some error

conditions. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16644](/security/CVE-2017-16644))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure

vulnerability. A physically proximate attacker could use this to expose

sensitive information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

It was discovered that an integer overflow existed in the perf subsystem of

the Linux kernel. A local attacker could use this to cause a denial of

service (system crash). ([CVE-2017-18255](/security/CVE-2017-18255))

It was discovered that the keyring subsystem in the Linux kernel did not

properly prevent a user from creating keyrings for other users. A local

attacker could use this cause a denial of service or expose sensitive

information. ([CVE-2017-18270](/security/CVE-2017-18270))

Andy Lutomirski and Willy Tarreau discovered that the KVM implementation in

the Linux kernel did not properly emulate instructions on the SS segment

register. A local attacker in a guest virtual machine could use this to

cause a denial of service (guest OS crash) or possibly gain administrative

privileges in the guest OS. ([CVE-2017-2583](/security/CVE-2017-2583))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

improperly emulated certain instructions. A local attacker could use this

to obtain sensitive information (kernel memory). ([CVE-2017-2584](/security/CVE-2017-2584))

It was discovered that the KLSI KL5KUSB105 serial-to-USB device driver in

the Linux kernel did not properly initialize memory related to logging. A

local attacker could use this to expose sensitive information (kernel

memory). ([CVE-2017-5549](/security/CVE-2017-5549))

Andrey Konovalov discovered an out-of-bounds access in the IPv6 Generic

Routing Encapsulation (GRE) tunneling implementation in the Linux kernel.

An attacker could use this to possibly expose sensitive information.

([CVE-2017-5897](/security/CVE-2017-5897))

Andrey Konovalov discovered that the LLC subsytem in the Linux kernel did

not properly set up a destructor in certain situations. A local attacker

could use this to cause a denial of service (system crash). ([CVE-2017-6345](/security/CVE-2017-6345))

Dmitry Vyukov discovered race conditions in the Infrared (IrDA) subsystem

in the Linux kernel. A local attacker could use this to cause a denial of

service (deadlock). ([CVE-2017-6348](/security/CVE-2017-6348))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

Tuomas Haanpää and Ari Kauppi discovered that the NFSv2 and NFSv3 server

implementations in the Linux kernel did not properly handle certain long

RPC replies. A remote attacker could use this to cause a denial of service

(system crash). ([CVE-2017-7645](/security/CVE-2017-7645))

Pengfei Wang discovered that a race condition existed in the NXP SAA7164 TV

Decoder driver for the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-8831](/security/CVE-2017-8831))

Pengfei Wang discovered that the Turtle Beach MultiSound audio device

driver in the Linux kernel contained race conditions when fetching from the

ring-buffer. A local attacker could use this to cause a denial of service

(infinite loop). ([CVE-2017-9984](/security/CVE-2017-9984), [CVE-2017-9985](/security/CVE-2017-9985))

It was discovered that the wait4() system call in the Linux kernel did not

properly validate its arguments in some situations. A local attacker could

possibly use this to cause a denial of service. ([CVE-2018-10087](/security/CVE-2018-10087))

It was discovered that the kill() system call implementation in the Linux

kernel did not properly validate its arguments in some situations. A local

attacker could possibly use this to cause a denial of service.

([CVE-2018-10124](/security/CVE-2018-10124))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Zhong Jiang discovered that a use-after-free vulnerability existed in the

NUMA memory policy implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2018-10675](/security/CVE-2018-10675))

Wen Xu discovered that a buffer overflow existed in the ext4 filesystem

implementation in the Linux kernel. An attacker could use this to construct

a malicious ext4 image that, when mounted, could cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2018-10877](/security/CVE-2018-10877))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused

a denial of service (system crash) when mounted. ([CVE-2018-1092](/security/CVE-2018-1092))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

It was discovered that the cdrom driver in the Linux kernel contained an

incorrect bounds check. A local attacker could use this to expose sensitive

information (kernel memory). ([CVE-2018-10940](/security/CVE-2018-10940))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Daniel Jiang discovered that a race condition existed in the ipv4 ping

socket implementation in the Linux kernel. A local privileged attacker

could use this to cause a denial of service (system crash). ([CVE-2017-2671](/security/CVE-2017-2671))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

It was discovered that a memory leak existed in the Serial Attached SCSI

(SAS) implementation in the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (memory exhaustion).

([CVE-2018-10021](/security/CVE-2018-10021))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-3.13.0-157-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2016-10208](/security/CVE-2016-10208)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-11473](/security/CVE-2017-11473)
* [CVE-2017-14991](/security/CVE-2017-14991)
* [CVE-2017-15649](/security/CVE-2017-15649)
* [CVE-2017-16526](/security/CVE-2017-16526)
* [CVE-2017-16527](/security/CVE-2017-16527)
* [CVE-2017-16529](/security/CVE-2017-16529)
* [CVE-2017-16531](/security/CVE-2017-16531)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16533](/security/CVE-2017-16533)
* [CVE-2017-16535](/security/CVE-2017-16535)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16538](/security/CVE-2017-16538)
* [CVE-2017-16643](/security/CVE-2017-16643)
* [CVE-2017-16644](/security/CVE-2017-16644)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-18255](/security/CVE-2017-18255)
* [CVE-2017-18270](/security/CVE-2017-18270)
* [CVE-2017-2583](/security/CVE-2017-2583)
* [CVE-2017-2584](/security/CVE-2017-2584)
* [CVE-2017-2671](/security/CVE-2017-2671)
* [CVE-2017-5549](/security/CVE-2017-5549)
* [CVE-2017-5897](/security/CVE-2017-5897)
* [CVE-2017-6345](/security/CVE-2017-6345)
* [CVE-2017-6348](/security/CVE-2017-6348)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2017-7645](/security/CVE-2017-7645)
* [CVE-2017-8831](/security/CVE-2017-8831)
* [CVE-2017-9984](/security/CVE-2017-9984)
* [CVE-2017-9985](/security/CVE-2017-9985)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10021](/security/CVE-2018-10021)
* [CVE-2018-10087](/security/CVE-2018-10087)
* [CVE-2018-10124](/security/CVE-2018-10124)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10675](/security/CVE-2018-10675)
* [CVE-2018-10877](/security/CVE-2018-10877)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1092](/security/CVE-2018-1092)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-10940](/security/CVE-2018-10940)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)

## Related notices

* [USN-3361-1](/security/notices/USN-3361-1)
* [USN-3234-2](/security/notices/USN-3234-2)
* [USN-3234-1](/security/notices/USN-3234-1)
* [USN-3619-2](/security/notices/USN-3619-2)
* [USN-3619-1](/security/notices/USN-3619-1)
* [USN-3469-1](/security/notices/USN-3469-1)
* [USN-3469-2](/security/notices/USN-3469-2)
* [USN-3487-1](/security/notices/USN-3487-1)
* [USN-3485-1](/security/notices/USN-3485-1)
* [USN-3485-3](/security/notices/USN-3485-3)
* [USN-3485-2](/security/notices/USN-3485-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3507-1](/security/notices/USN-3507-1)
* [USN-3631-2](/security/notices/USN-3631-2)
* [USN-3631-1](/security/notices/USN-3631-1)
* [USN-3509-1](/security/notices/USN-3509-1)
* [USN-3509-2](/security/notices/USN-3509-2)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3208-1](/security/notices/USN-3208-1)
* [USN-3208-2](/security/notices/USN-3208-2)
* [USN-3314-1](/security/notices/USN-3314-1)
* [USN-3312-2](/security/notices/USN-3312-2)
* [USN-3312-1](/security/notices/USN-3312-1)
* [USN-3265-1](/security/notices/USN-3265-1)
* [USN-3265-2](/security/notices/USN-3265-2)
* [USN-3420-1](/security/notices/USN-3420-1)
* [USN-3420-2](/security/notices/USN-3420-2)
* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)
* [USN-3678-4](/security/notices/USN-3678-4)
* [USN-3678-3](/security/notices/USN-3678-3)
* [USN-3678-1](/security/notices/USN-3678-1)
* [USN-3678-2](/security/notices/USN-3678-2)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3871-4](/security/notices/USN-3871-4)
* [USN-3871-1](/security/notices/USN-3871-1)
* [USN-3871-5](/security/notices/USN-3871-5)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3871-3](/security/notices/USN-3871-3)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3695-2](/security/notices/USN-3695-2)
* [USN-3695-1](/security/notices/USN-3695-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from git.kernel.org_ab89e463_20250125_123729.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.13.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/drivers/usb/usbip)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/drivers/usb/usbip) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)/[drivers](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)/[usb](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)/[usbip](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shuah Khan <shuahkh@osg.samsung.com> | 2017-12-07 14:16:50 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2017-12-08 17:32:23 +0100 |
| commit | [be6123df1ea8f01ee2f896a16c2b7be3e4557a5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)) | |
| tree | [7b2addc6d11ceacdd9e595c4cc8f84ac8f11aa68](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a) /[drivers/usb/usbip](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a) | |
| parent | [2f2d0088eb93db5c649d2a5e34a3800a8a935fc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=2f2d0088eb93db5c649d2a5e34a3800a8a935fc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a&id2=2f2d0088eb93db5c649d2a5e34a3800a8a935fc5)) | |
| download | [linux-be6123df1ea8f01ee2f896a16c2b7be3e4557a5a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be6123df1ea8f01ee2f896a16c2b7be3e4557a5a.tar.gz) | |

usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_bufferstub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research <vuln@secunia.com>
Cc: stable <stable@vger.kernel.org>
Signed-off-by: Shuah Khan <shuahkh@osg.samsung.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a) (limited to 'drivers/usb/usbip')

| -rw-r--r-- | [drivers/usb/usbip/stub\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip/stub_tx.c?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/usb/usbip/stub\_tx.c b/drivers/usb/usbip/stub\_tx.cindex b18bce96c212b3..53172b1f6257cf 100644--- a/[drivers/usb/usbip/stub\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip/stub_tx.c?id=2f2d0088eb93db5c649d2a5e34a3800a8a935fc5)+++ b/[drivers/usb/usbip/stub\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip/stub_tx.c?id=be6123df1ea8f01ee2f896a16c2b7be3e4557a5a)@@ -167,6 +167,13 @@ static int stub\_send\_ret\_submit(struct stub\_device \*sdev) memset(&pdu\_header, 0, sizeof(pdu\_header)); memset(&msg, 0, sizeof(msg)); + if (urb->actual\_length > 0 && !urb->transfer\_buffer) {+ dev\_err(&sdev->udev->dev,+ "urb: actual\_length %d transfer\_buffer null\n",+ urb->actual\_length);+ return -1;+ }+ if (usb\_pipetype(urb->pipe) == PIPE\_ISOCHRONOUS) iovnum = 2 + urb->number\_of\_packets; else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 12:36:06 +0000



=== Content from cdn.kernel.org_ad93f7ac_20250125_123727.html ===
commit b632d710149f1a638ffa6e999cfbd9ee9fbdada6
Author: Greg Kroah-Hartman
Date: Wed Dec 20 10:07:34 2017 +0100
Linux 4.9.71
commit ed70a2212526bb26b5850f538b5a53793fdd4abf
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f23eb16afd8f230f15ee020159469275adabd15
Author: Matteo Croce
Date: Thu Oct 12 16:12:37 2017 +0200
icmp: don't fail on fragment reassembly time exceeded
[ Upstream commit 258bbb1b0e594ad5f5652cb526b3c63e6a7fad3d ]
The ICMP implementation currently replies to an ICMP time exceeded message
(type 11) with an ICMP host unreachable message (type 3, code 1).
However, time exceeded messages can either represent "time to live exceeded
in transit" (code 0) or "fragment reassembly time exceeded" (code 1).
Unconditionally replying to "fragment reassembly time exceeded" with
host unreachable messages might cause unjustified connection resets
which are now easily triggered as UFO has been removed, because, in turn,
sending large buffers triggers IP fragmentation.
The issue can be easily reproduced by running a lot of UDP streams
which is likely to trigger IP fragmentation:
# start netserver in the test namespace
ip netns add test
ip netns exec test netserver
# create a VETH pair
ip link add name veth0 type veth peer name veth0 netns test
ip link set veth0 up
ip -n test link set veth0 up
for i in $(seq 20 29); do
# assign addresses to both ends
ip addr add dev veth0 192.168.$i.1/24
ip -n test addr add dev veth0 192.168.$i.2/24
# start the traffic
netperf -L 192.168.$i.1 -H 192.168.$i.2 -t UDP\_STREAM -l 0 &
done
# wait
send\_data: data send error: No route to host (errno 113)
netperf: send\_omni: send\_data failed: No route to host
We need to differentiate instead: if fragment reassembly time exceeded
is reported, we need to silently drop the packet,
if time to live exceeded is reported, maintain the current behaviour.
In both cases increment the related error count "icmpInTimeExcds".
While at it, fix a typo in a comment, and convert the if statement
into a switch to mate it more readable.
Signed-off-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2eb165b9fbb722416252c054ac2ef2c3eb777460
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0c70b35bf1583fa5fc9134b87d32cf0bc27d5023
Author: Bart Van Assche
Date: Wed Oct 11 10:48:45 2017 -0700
RDMA/cma: Avoid triggering undefined behavior
[ Upstream commit c0b64f58e8d49570aa9ee55d880f92c20ff0166b ]
According to the C standard the behavior of computations with
integer operands is as follows:
\* A computation involving unsigned operands can never overflow,
because a result that cannot be represented by the resulting
unsigned integer type is reduced modulo the number that is one
greater than the largest value that can be represented by the
resulting type.
\* The behavior for signed integer underflow and overflow is
undefined.
Hence only use unsigned integers when checking for integer
overflow.
This patch is what I came up with after having analyzed the
following smatch warnings:
drivers/infiniband/core/cma.c:3448: cma\_resolve\_ib\_udp() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
drivers/infiniband/core/cma.c:3505: cma\_connect\_ib() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
Signed-off-by: Bart Van Assche
Acked-by: Sean Hefty
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 31eb4108e107aefc9cd5d662b3624533327848fd
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b64ab3ca9d31162cbdbd8acc2d5b68cf37302527
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 91e0cf85caea7f977361f662941100821370d74e
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 64da4e8d00f16bc7db25f6d819c4beac2656a90f
Author: weiping zhang
Date: Thu Oct 12 14:56:44 2017 +0800
scsi: sd: change allow\_restart to bool in sysfs interface
[ Upstream commit 658e9a6dc1126f21fa417cd213e1cdbff8be0ba2 ]
/sys/class/scsi\_disk/0:2:0:0/allow\_restart can be changed to 0
unexpectedly by writing an invalid string such as the following:
echo asdf > /sys/class/scsi\_disk/0:2:0:0/allow\_restart
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1cafdac8919136bd2ee6e0f607c49aacb9bb854b
Author: weiping zhang
Date: Thu Oct 12 14:57:06 2017 +0800
scsi: sd: change manage\_start\_stop to bool in sysfs interface
[ Upstream commit 623401ee33e42cee64d333877892be8db02951eb ]
/sys/class/scsi\_disk/0:2:0:0/manage\_start\_stop can be changed to 0
unexpectly by writing an invalid string.
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8315bcf841ae26d266dbaecd8a47956632478799
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:07 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_disassoc\_cmd
[ Upstream commit 08880f8e08cbd814e870e9d3ab9530abc1bce226 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_set\_802\_11\_bssid(acquire the spinlock)
rtw\_disassoc\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6641d3e307f5b42237a99f2aa961051a71c50393
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:45 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_createbss\_cmd
[ Upstream commit 2bf9806d4228f7a6195f8e03eda0479d2a93b411 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_surveydone\_event\_callback(acquire the spinlock)
rtw\_createbss\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28e006e14ff9b2fe55078c02bb92212b09664517
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 04d5a2d5d2d079ce5966d7e67324c9c4f648c951
Author: Parav Pandit
Date: Mon Oct 16 08:45:16 2017 +0300
IB/core: Fix calculation of maximum RoCE MTU
[ Upstream commit 99260132fde7bddc6e0132ce53da94d1c9ccabcb ]
The original code only took into consideration the largest header
possible after the IB\_BTH\_BYTES. This was incorrect, as the largest
possible header size is the largest possible combination of headers we
might run into. The new code accounts for all possible headers in the
largest possible combination and subtracts that from the MTU to make
sure that all packets will fit on the wire.
Link: https://www.spinics.net/lists/linux-rdma/msg54558.html
Fixes: 3c86aa70bf67 ("RDMA/cm: Add RDMA CM support for IBoE devices")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Reported-by: Roland Dreier
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c744ecec01ae6a92541c381d3548f8753aa50ba2
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f39486bd37ee3edd8658aff1226337c47e4ba32e
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4fdb10391bcafe698f06dd105b0d829744eb1926
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit afeeff4d6156b4965af9cf30ba05b05f04b9c7b0
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
commit bd3486ded7a0c313a6575343e6c2b21d14476645 upstream.
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit 92ad6c13e17ebea6175b978dc0f5b485e7e68cf1
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 421910e924b63f2ccd4d433c77c5cd88063546ba
Author: Matthias Brugger
Date: Sat Oct 21 10:17:47 2017 +0200
soc: mediatek: pwrap: fix compiler errors
[ Upstream commit fb2c1934f30577756e55e24e8870b45c78da3bc2 ]
When compiling using sparse, we got the following error:
drivers/soc/mediatek/mtk-pmic-wrap.c:686:25: error: dubious one-bit signed bitfield
Changing the data type to unsigned fixes this.
Signed-off-by: Matthias Brugger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7745382fe86ce5354dc459948c086d3b5778fb9d
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ab9d2571149322120efcf3d6ce9c24003c946ca1
Author: Martin Wilck
Date: Fri Oct 20 16:51:08 2017 -0500
scsi: hpsa: destroy sas transport properties before scsi\_host
[ Upstream commit dfb2e6f46b3074eb85203d8f0888b71ec1c2e37a ]
This patch cleans up a lot of warnings when unloading the driver.
A current example of the stack trace starts with:
[ 142.570715] sysfs group 'power' not found for kobject 'port-5:0'
There can be hundreds of these messages during a driver unload.
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
His original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102085.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
---------------------------
Original patch description:
---------------------------
Unloading the hpsa driver causes warnings
[ 1063.793652] WARNING: CPU: 1 PID: 4850 at ../fs/sysfs/group.c:237 device\_del+0x54/0x240()
[ 1063.793659] sysfs group ffffffff81cf21a0 not found for kobject 'port-2:0'
with two different stacks:
1)
[ 1063.793774] [] device\_del+0x54/0x240
[ 1063.793780] [] transport\_remove\_classdev+0x4a/0x60
[ 1063.793784] [] attribute\_container\_device\_trigger+0xa6/0xb0
[ 1063.793802] [] sas\_port\_delete+0x126/0x160 [scsi\_transport\_sas]
[ 1063.793819] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
2)
[ 1063.797103] [] device\_del+0x54/0x240
[ 1063.797118] [] sas\_port\_delete+0x12e/0x160 [scsi\_transport\_sas]
[ 1063.797134] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
This is caused by the fact that host device hostX is deleted before the
SAS transport devices hostX/port-a:b.
This patch fixes this by reverting the order of device deletions.
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1723d6668df5107c6026cbbf7afd2c615d74e006
Author: Martin Wilck
Date: Fri Oct 20 16:51:14 2017 -0500
scsi: hpsa: cleanup sas\_phy structures in sysfs when unloading
[ Upstream commit 55ca38b4255bb336c2d35990bdb2b368e19b435a ]
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
The original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102083.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
--------------------------------------
Original patch description from Martin:
--------------------------------------
When the hpsa module is unloaded using rmmod, dangling
symlinks remain under /sys/class/sas\_phy. Fix this by
calling sas\_phy\_delete() rather than sas\_phy\_free (which,
according to comments, should not be called for PHYs that
have been set up successfully, anyway).
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 237e053346f1b049ca9f571040c51c61f0740766
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f84f861f99c44f03f5ed57b40e3bfe951cbae3a
Author: Leon Romanovsky
Date: Wed Oct 25 07:41:11 2017 +0300
RDMA/cxgb4: Declare stag as \_\_be32
[ Upstream commit 35fb2a88ed4b77356fa679a8525c869a3594e287 ]
The scqe.stag is actually \_\_b32, fix it.
drivers/infiniband/hw/cxgb4/cq.c:754:52: warning: cast to restricted \_\_be32
Cc: Steve Wise
Signed-off-by: Leon Romanovsky
Reviewed-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 769bca9339f0775aa2985d4cae9be0e0d72092af
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c82209949bba864177300a681e0c736f982c87ab
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fc4177eacfa6e95a243402790b362736879f1cfd
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6a559523ee6626d191be1da9031845c368e4a6a9
Author: Christoph Hellwig
Date: Wed Oct 18 13:20:01 2017 +0200
nvme: use kref\_get\_unless\_zero in nvme\_find\_get\_ns
[ Upstream commit 2dd4122854f697afc777582d18548dded03ce5dd ]
For kref\_get\_unless\_zero to protect against lookup vs free races we need
to use it in all places where we aren't guaranteed to already hold a
reference. There is no such guarantee in nvme\_find\_get\_ns, so switch to
kref\_get\_unless\_zero in this function.
Signed-off-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Reviewed-by: Hannes Reinecke
Reviewed-by: Johannes Thumshirn
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e2fce5a5578d175cd61822473228ab454782bec7
Author: Osama Khan
Date: Sat Oct 21 10:42:21 2017 +0000
platform/x86: hp\_accel: Add quirk for HP ProBook 440 G4
[ Upstream commit 163ca80013aafb6dc9cb295de3db7aeab9ab43f8 ]
Added support for HP ProBook 440 G4 laptops by including the accelerometer
orientation quirk for that device. Testing was performed based on the
axis orientation guidelines here:
https://www.kernel.org/doc/Documentation/misc-devices/lis3lv02d
which states "If the left side is elevated, X increases (becomes positive)".
When tested, on lifting the left edge, x values became increasingly negative
thus indicating an inverted x-axis on the installed lis3lv02d chip.
This was compensated by adding an entry for this device in hp\_accel.c
specifying the quirk as x\_inverted. The patch was tested on a
ProBook 440 G4 device and x-axis as well as y and z-axis values are now
generated as per spec.
Signed-off-by: Osama Khan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7fab68e1f7308b2b7e3ebdd2483eb7a9572ccec5
Author: Christophe JAILLET
Date: Sun Sep 10 13:19:38 2017 +0200
btrfs: tests: Fix a memory leak in error handling path in 'run\_test()'
[ Upstream commit 9ca2e97fa3c3216200afe35a3b111ec51cc796d2 ]
If 'btrfs\_alloc\_path()' fails, we must free the resources already
allocated, as done in the other error handling paths in this function.
Signed-off-by: Christophe JAILLET
Reviewed-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b7ada2c0ea291e7bf22b51745afd9f1ccfc91292
Author: Nick Desaulniers
Date: Fri Oct 27 09:33:41 2017 -0700
arm64: prevent regressions in compressed kernel image size when upgrading to binutils 2.27
[ Upstream commit fd9dde6abcb9bfe6c6bee48834e157999f113971 ]
Upon upgrading to binutils 2.27, we found that our lz4 and gzip
compressed kernel images were significantly larger, resulting is 10ms
boot time regressions.
As noted by Rahul:
"aarch64 binaries uses RELA relocations, where each relocation entry
includes an addend value. This is similar to x86\_64. On x86\_64, the
addend values are also stored at the relocation offset for relative
relocations. This is an optimization: in the case where code does not
need to be relocated, the loader can simply skip processing relative
relocations. In binutils-2.25, both bfd and gold linkers did this for
x86\_64, but only the gold linker did this for aarch64. The kernel build
here is using the bfd linker, which stored zeroes at the relocation
offsets for relative relocations. Since a set of zeroes compresses
better than a set of non-zero addend values, this behavior was resulting
in much better lz4 compression.
The bfd linker in binutils-2.27 is now storing the actual addend values
at the relocation offsets. The behavior is now consistent with what it
does for x86\_64 and what gold linker does for both architectures. The
change happened in this upstream commit:
https://sourceware.org/git/?p=binutils-gdb.git;a=commit;h=1f56df9d0d5ad89806c24e71f296576d82344613
Since a bunch of zeroes got replaced by non-zero addend values, we see
the side effect of lz4 compressed image being a bit bigger.
To get the old behavior from the bfd linker, "--no-apply-dynamic-relocs"
flag can be used:
$ LDFLAGS="--no-apply-dynamic-relocs" make
With this flag, the compressed image size is back to what it was with
binutils-2.25.
If the kernel is using ASLR, there aren't additional runtime costs to
--no-apply-dynamic-relocs, as the relocations will need to be applied
again anyway after the kernel is relocated to a random address.
If the kernel is not using ASLR, then presumably the current default
behavior of the linker is better. Since the static linker performed the
dynamic relocs, and the kernel is not moved to a different address at
load time, it can skip applying the relocations all over again."
Some measurements:
$ ld -v
GNU ld (binutils-2.25-f3d35cf6) 2.25.51.20141117
^
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300652760 Oct 26 11:57 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932627 Oct 26 11:57 Image.lz4-dtb
$ ld -v
GNU ld (binutils-2.27-53dd00a1) 2.27.0.20170315
^
pre patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 11:43 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 18159474 Oct 26 11:43 Image.lz4-dtb
post patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 12:06 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932466 Oct 26 12:06 Image.lz4-dtb
By Siqi's measurement w/ gzip:
binutils 2.27 with this patch (with --no-apply-dynamic-relocs):
Image 41535488
Image.gz 13404067
binutils 2.27 without this patch (without --no-apply-dynamic-relocs):
Image 41535488
Image.gz 14125516
Any compression scheme should be able to get better results from the
longer runs of zeros, not just GZIP and LZ4.
10ms boot time savings isn't anything to get excited about, but users of
arm64+compression+bfd-2.27 should not have to pay a penalty for no
runtime improvement.
Reported-by: Gopinath Elanchezhian
Reported-by: Sindhuri Pentyala
Reported-by: Wei Wang
Suggested-by: Ard Biesheuvel
Suggested-by: Rahul Chaudhry
Suggested-by: Siqi Lin
Suggested-by: Stephen Hines
Signed-off-by: Nick Desaulniers
Reviewed-by: Ard Biesheuvel
[will: added comment to Makefile]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 52aaa748a948a1bd50fa2ef0d2b9ffad11b0e672
Author: Patel Jay P
Date: Mon Oct 23 06:05:53 2017 -0700
Ib/hfi1: Return actual operational VLs in port info query
[ Upstream commit 00f9203119dd2774564407c7a67b17d81916298b ]
\_\_subn\_get\_opa\_portinfo stores value returned by hfi1\_get\_ib\_cfg() as
operational vls. hfi1\_get\_ib\_cfg() returns vls\_operational field in
hfi1\_pportdata. The problem with this is that the value is always equal
to vls\_supported field in hfi1\_pportdata.
The logic to calculate operational\_vls is to set value passed by FM
(in \_\_subn\_set\_opa\_portinfo routine). If no value is passed then
default value is stored in operational\_vls.
Field actual\_vls\_operational is calculated on the basis of buffer
control table. Hence, modifying hfi1\_get\_ib\_cfg() to return
actual\_operational\_vls when used with HFI1\_IB\_CFG\_OP\_VLS parameter
Reviewed-by: Mike Marciniszyn
Reviewed-by: Dennis Dalessandro
Signed-off-by: Patel Jay P
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9102ed6a5f6a53434f69264ac8457994fde14a88
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c2a0531f59c363fd5b50be46b97248091b13484b
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 75f66eeae657688f1e600214ae297422834d3c43
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 026ffaf65879b3ecc12ffa9c45dfa5894370bd60
Author: Douglas Gilbert
Date: Sun Oct 29 10:47:19 2017 -0400
scsi: scsi\_debug: write\_same: fix error report
[ Upstream commit e33d7c56450b0a5c7290cbf9e1581fab5174f552 ]
The scsi\_debug driver incorrectly suggests there is an error with the
SCSI WRITE SAME command when the number\_of\_logical\_blocks is greater
than 1. It will also suggest there is an error when NDOB
(no data-out buffer) is set and the number\_of\_logical\_blocks is
greater than 0. Both are valid, fix.
Signed-off-by: Douglas Gilbert
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d8914530f247900885850af7cccf81a2b33907b9
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 019433db872f9032cabd2a4a0fbd3df2bb14f539
Author: Kuninori Morimoto
Date: Wed Nov 1 07:16:58 2017 +0000
ASoC: rsnd: rsnd\_ssi\_run\_mods() needs to care ssi\_parent\_mod
[ Upstream commit 21781e87881f9c420871b1d1f3f29d4cd7bffb10 ]
SSI parent mod might be NULL. ssi\_parent\_mod() needs to care
about it. Otherwise, it uses negative shift.
This patch fixes it.
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cf16dac8bd9868cf22203ac498e8e997ad7b0ca1
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27f5597c98590cdd01f2c9bebbf36cb4bce28253
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 54809e38a6298fde41c0b72c2423f5d7c9e847fe
Author: Leo Yan
Date: Fri Sep 1 08:47:14 2017 +0800
clk: hi6220: mark clock cs\_atb\_syspll as critical
[ Upstream commit d2a3671ebe6479483a12f94fcca63c058d95ad64 ]
Clock cs\_atb\_syspll is pll used for coresight trace bus; when clock
cs\_atb\_syspll is disabled and operates its child clock node cs\_atb
results in system hang. So mark clock cs\_atb\_syspll as critical to
keep it enabled.
Cc: Guodong Xu
Cc: Zhangfei Gao
Cc: Haojian Zhuang
Signed-off-by: Leo Yan
Signed-off-by: Michael Turquette
Link: lkml.kernel.org/r/1504226835-2115-2-git-send-email-leo.yan@linaro.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 47b63ea40ee158fbd032047935cf8b4d388ccd24
Author: Sébastien Szymanski
Date: Tue Aug 1 12:40:07 2017 +0200
clk: imx6: refine hdmi\_isfr's parent to make HDMI work on i.MX6 SoCs w/o VPU
[ Upstream commit c68ee58d9ee7b856ac722f18f4f26579c8fbd2b4 ]
On i.MX6 SoCs without VPU (in my case MCIMX6D4AVT10AC), the hdmi driver
fails to probe:
[ 2.540030] dwhdmi-imx 120000.hdmi: Unsupported HDMI controller
(0000:00:00)
[ 2.548199] imx-drm display-subsystem: failed to bind 120000.hdmi
(ops dw\_hdmi\_imx\_ops): -19
[ 2.557403] imx-drm display-subsystem: master bind failed: -19
That's because hdmi\_isfr's parent, video\_27m, is not correctly ungated.
As explained in commit 5ccc248cc537 ("ARM: imx6q: clk: Add support for
mipi\_core\_cfg clock as a shared clock gate"), video\_27m is gated by
CCM\_CCGR3[CG8].
On i.MX6 SoCs with VPU, the hdmi is working thanks to the
CCM\_CMEOR[mod\_en\_ov\_vpu] bit which makes the video\_27m ungated whatever
is in CCM\_CCGR3[CG8]. The issue can be reproduced by setting
CCMEOR[mod\_en\_ov\_vpu] to 0.
Make the HDMI work in every case by setting hdmi\_isfr's parent to
mipi\_core\_cfg.
Signed-off-by: Sébastien Szymanski
Reviewed-by: Fabio Estevam
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d6b6302c36b5459f3f2fa8d5e978b3e25f7e2723
Author: Chen Zhong
Date: Thu Oct 5 11:50:23 2017 +0800
clk: mediatek: add the option for determining PLL source clock
[ Upstream commit c955bf3998efa3355790a4d8c82874582f1bc727 ]
Since the previous setup always sets the PLL using crystal 26MHz, this
doesn't always happen in every MediaTek platform. So the patch added
flexibility for assigning extra member for determining the PLL source
clock.
Signed-off-by: Chen Zhong
Signed-off-by: Sean Wang
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2850c3ec0d25a4f729bd7f2212e178c9303e697a
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18498f1c7089035faba2bc9ba64c5c96542ae0c4
Author: Robert Baronescu
Date: Tue Oct 10 13:22:00 2017 +0300
crypto: tcrypt - fix buffer lengths in test\_aead\_speed()
[ Upstream commit 7aacbfcb331ceff3ac43096d563a1f93ed46e35e ]
Fix the way the length of the buffers used for
encryption / decryption are computed.
For e.g. in case of encryption, input buffer does not contain
an authentication tag.
Signed-off-by: Robert Baronescu
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2ed46cbf23fc48ea63e3a3eaa820de5d54534cb6
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c843e9f8f97ff0d7c3a8232a314b20c1328ba697
Author: Eryu Guan
Date: Wed Nov 1 21:43:50 2017 -0700
xfs: truncate pagecache before writeback in xfs\_setattr\_size()
[ Upstream commit 350976ae21873b0d36584ea005076356431b8f79 ]
On truncate down, if new size is not block size aligned, we zero the
rest of block to avoid exposing stale data to user, and
iomap\_truncate\_page() skips zeroing if the range is already in
unwritten state or a hole. Then we writeback from on-disk i\_size to
the new size if this range hasn't been written to disk yet, and
truncate page cache beyond new EOF and set in-core i\_size.
The problem is that we could write data between di\_size and newsize
before removing the page cache beyond newsize, as the extents may
still be in unwritten state right after a buffer write. As such, the
page of data that newsize lies in has not been zeroed by page cache
invalidation before it is written, and xfs\_do\_writepage() hasn't
triggered it's "zero data beyond EOF" case because we haven't
updated in-core i\_size yet. Then a subsequent mmap read could see
non-zeros past EOF.
I occasionally see this in fsx runs in fstests generic/112, a
simplified fsx operation sequence is like (assuming 4k block size
xfs):
fallocate 0x0 0x1000 0x0 keep\_size
write 0x0 0x1000 0x0
truncate 0x0 0x800 0x1000
punch\_hole 0x0 0x800 0x800
mapread 0x0 0x800 0x800
where fallocate allocates unwritten extent but doesn't update
i\_size, buffer write populates the page cache and extent is still
unwritten, truncate skips zeroing page past new EOF and writes the
page to disk, punch\_hole invalidates the page cache, at last mapread
reads the block back and sees non-zero beyond EOF.
Fix it by moving truncate\_setsize() to before writeback so the page
cache invalidation zeros the partial page at the new EOF. This also
triggers "zero data beyond EOF" in xfs\_do\_writepage() at writeback
time, because newsize has been set and page straddles the newsize.
Also fixed the wrong 'end' param of filemap\_write\_and\_wait\_range()
call while we're at it, the 'end' is inclusive and should be
'newsize - 1'.
Suggested-by: Dave Chinner
Signed-off-by: Eryu Guan
Acked-by: Dave Chinner
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 03bfadfb0d7990bf558dabd6b26e4f06bc32c45b
Author: Gary R Hook
Date: Fri Nov 3 10:50:34 2017 -0600
iommu/amd: Limit the IOVA page range to the specified addresses
[ Upstream commit b92b4fb5c14257c0e7eae291ecc1f7b1962e1699 ]
The extent of pages specified when applying a reserved region should
include up to the last page of the range, but not the page following
the range.
Signed-off-by: Gary R Hook
Fixes: 8d54d6c8b8f3 ('iommu/amd: Implement apply\_dm\_region call-back')
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cb0acb37010c216e4781224ad4ab4c12ca9cb5fe
Author: Liu Bo
Date: Fri Nov 3 11:24:44 2017 -0600
badblocks: fix wrong return value in badblocks\_set if badblocks are disabled
[ Upstream commit 39b4954c0a1556f8f7f1fdcf59a227117fcd8a0b ]
MD's rdev\_set\_badblocks() expects that badblocks\_set() returns 1 if
badblocks are disabled, otherwise, rdev\_set\_badblocks() will record
superblock changes and return success in that case and md will fail to
report an IO error which it should.
This bug has existed since badblocks were introduced in commit
9e0e252a048b ("badblocks: Add core badblock management code").
Signed-off-by: Liu Bo
Acked-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dcdca123814c5303f0e4d0fba67756d35bb0fd1f
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 998201fdc5c9144a2dfaec8811a722c3c5e731d3
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a4f54ec403da9f5eafaba60d67ae8b2613a1bae5
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e086a82a926ace86fc14da0442437c2024d68001
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit abc4b4420af8d2d31fe38dddf998855f5cf9d8dc
Author: Kuppuswamy Sathyanarayanan
Date: Sun Oct 29 02:49:54 2017 -0700
platform/x86: intel\_punit\_ipc: Fix resource ioremap warning
[ Upstream commit 6cc8cbbc8868033f279b63e98b26b75eaa0006ab ]
For PUNIT device, ISPDRIVER\_IPC and GTDDRIVER\_IPC resources are not
mandatory. So when PMC IPC driver creates a PUNIT device, if these
resources are not available then it creates dummy resource entries for
these missing resources. But during PUNIT device probe, doing ioremap on
these dummy resources generates following warning messages.
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
This patch fixes this issue by adding extra check for resource size
before performing ioremap operation.
Signed-off-by: Kuppuswamy Sathyanarayanan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6e5a846d5172c5225bda764797a07c828b5b2650
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d7e7c431d62101505a6a0321986dba498252fd7f
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a463f9c5dfd1bb62f128e6883103117af6f3db1f
Author: KUWAZAWA Takuya
Date: Sun Oct 15 20:54:10 2017 +0900
netfilter: ipvs: Fix inappropriate output of procfs
[ Upstream commit c5504f724c86ee925e7ffb80aa342cfd57959b13 ]
Information about ipvs in different network namespace can be seen via procfs.
How to reproduce:
# ip netns add ns01
# ip netns add ns02
# ip netns exec ns01 ip a add dev lo 127.0.0.1/8
# ip netns exec ns02 ip a add dev lo 127.0.0.1/8
# ip netns exec ns01 ipvsadm -A -t 10.1.1.1:80
# ip netns exec ns02 ipvsadm -A -t 10.1.1.2:80
The ipvsadm displays information about its own network namespace only.
# ip netns exec ns01 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.1:80 wlc
# ip netns exec ns02 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.2:80 wlc
But I can see information about other network namespace via procfs.
# ip netns exec ns01 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010101:0050 wlc
TCP 0A010102:0050 wlc
# ip netns exec ns02 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010102:0050 wlc
Signed-off-by: KUWAZAWA Takuya
Acked-by: Julian Anastasov
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b3b6d1eea0de7115353a3706e5b0c3ff56be0663
Author: Matthias Brugger
Date: Mon Oct 30 12:37:55 2017 +0100
iommu/mediatek: Fix driver name
[ Upstream commit 395df08d2e1de238a9c8c33fdcd0e2160efd63a9 ]
There exist two Mediatek iommu drivers for the two different
generations of the device. But both drivers have the same name
"mtk-iommu". This breaks the registration of the second driver:
Error: Driver 'mtk-iommu' is already registered, aborting...
Fix this by changing the name for first generation to
"mtk-iommu-v1".
Fixes: b17336c55d89 ("iommu/mediatek: add support for mtk iommu generation one HW")
Signed-off-by: Matthias Brugger
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9a4bf05126f42c2632729ab0da503021d74ed454
Author: Mika Westerberg
Date: Fri Oct 13 21:35:43 2017 +0300
PCI: Do not allocate more buses than available in parent
[ Upstream commit a20c7f36bd3d20d245616ae223bb9d05dfb6f050 ]
One can ask more buses to be reserved for hotplug bridges by passing
pci=hpbussize=N in the kernel command line. If the parent bus does not
have enough bus space available we incorrectly create child bus with the
requested number of subordinate buses.
In the example below hpbussize is set to one more than we have available
buses in the root port:
pci 0000:07:00.0: [8086:1578] type 01 class 0x060400
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 0
pci 0000:07:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 1
pci\_bus 0000:08: busn\_res: can not insert [bus 08-ff] under [bus 07-3f] (conflicts with (null) [bus 07-3f])
pci\_bus 0000:08: scanning bus
...
pci\_bus 0000:0a: bus scan returning with max=40
pci\_bus 0000:0a: busn\_res: [bus 0a-ff] end is updated to 40
pci\_bus 0000:0a: [bus 0a-40] partially hidden behind bridge 0000:07 [bus 07-3f]
pci\_bus 0000:08: bus scan returning with max=40
pci\_bus 0000:08: busn\_res: [bus 08-ff] end is updated to 40
Instead of allowing this, limit the subordinate number to be less than or
equal the maximum subordinate number allocated for the parent bus (if it
has any).
Signed-off-by: Mika Westerberg
[bhelgaas: remove irrelevant dmesg messages]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 29a404be7b30237e0894057422407722d3f8bf45
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f44d28e0348dbb081784ab02be57954d75efa13e
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5a7192bc389ea5ac194d046d6a218b7431680a31
Author: Peter Ujfalusi
Date: Wed Nov 8 12:02:25 2017 +0200
dmaengine: ti-dma-crossbar: Correct am335x/am43xx mux value type
[ Upstream commit 288e7560e4d3e259aa28f8f58a8dfe63627a1bf6 ]
The used 0x1f mask is only valid for am335x family of SoC, different family
using this type of crossbar might have different number of electable
events. In case of am43xx family 0x3f mask should have been used for
example.
Instead of trying to handle each family's mask, just use u8 type to store
the mux value since the event offsets are aligned to byte offset.
Fixes: 42dbdcc6bf965 ("dmaengine: ti-dma-crossbar: Add support for crossbar on AM33xx/AM43xx")
Signed-off-by: Peter Ujfalusi
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 03a48dc96505f5b900e44d50e69ea3ee3686c279
Author: Pankaj Bharadiya
Date: Tue Nov 7 16:16:19 2017 +0530
ASoC: Intel: Skylake: Fix uuid\_module memory leak in failure case
[ Upstream commit f8e066521192c7debe59127d90abbe2773577e25 ]
In the loop that adds the uuid\_module to the uuid\_list list, allocated
memory is not properly freed in the error path free uuid\_list whenever
any of the memory allocation in the loop fails to avoid memory leak.
Signed-off-by: Pankaj Bharadiya
Signed-off-by: Guneshwor Singh
Acked-By: Vinod Koul
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9146b10f8cd64c2e467c8f98ccb19dcb15812e83
Author: Philipp Zabel
Date: Tue Nov 7 13:12:17 2017 +0100
rtc: pcf8563: fix output clock rate
[ Upstream commit a3350f9c57ffad569c40f7320b89da1f3061c5bb ]
The pcf8563\_clkout\_recalc\_rate function erroneously ignores the
frequency index read from the CLKO register and always returns
32768 Hz.
Fixes: a39a6405d5f9 ("rtc: pcf8563: add CLKOUT to common clock framework")
Signed-off-by: Philipp Zabel
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cf53526f3312f972043d0c6fa745cfb9f777a0c9
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 90e2591f6f3fd15ac766ffbaed119f43f01fef33
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 92c3c7db8336f6678b31ee0d08ecf3bab81a80ff
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aecce5fc047a99c057931f08977ba6042bb931c4
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0312ab0f0e437cadb9eabef72a1e26a676d2dd64
Author: Robert Stonehouse
Date: Tue Nov 7 17:30:30 2017 +0000
sfc: don't warn on successful change of MAC
[ Upstream commit cbad52e92ad7f01f0be4ca58bde59462dc1afe3a ]
Fixes: 535a61777f44e ("sfc: suppress handled MCDI failures when changing the MAC address")
Signed-off-by: Bert Kenward
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da73389e8aa7975a46b9e85234fcbd7885d0eabd
Author: Sébastien Szymanski
Date: Fri Nov 10 10:01:43 2017 +0100
HID: cp2112: fix broken gpio\_direction\_input callback
[ Upstream commit 7da85fbf1c87d4f73621e0e7666a3387497075a9 ]
When everything goes smoothly, ret is set to 0 which makes the function
to return EIO error.
Fixes: 8e9faa15469e ("HID: cp2112: fix gpio-callback error handling")
Signed-off-by: Sébastien Szymanski
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e15628b293a7dad278d5bbf7d56a539858b0be8f
Author: Dou Liyang
Date: Fri Mar 3 16:02:23 2017 +0800
Revert "x86/acpi: Set persistent cpuid <-> nodeid mapping when booting"
[ Upstream commit c962cff17dfa11f4a8227ac16de2b28aea3312e4 ]
Revert: dc6db24d2476 ("x86/acpi: Set persistent cpuid <-> nodeid mapping when booting")
The mapping of "cpuid <-> nodeid" is established at boot time via ACPI
tables to keep associations of workqueues and other node related items
consistent across cpu hotplug.
But, ACPI tables are unreliable and failures with that boot time mapping
have been reported on machines where the ACPI table and the physical
information which is retrieved at actual hotplug is inconsistent.
Revert the mapping implementation so it can be replaced with a less error
prone approach.
Signed-off-by: Dou Liyang
Tested-by: Xiaolong Ye
Cc: rjw@rjwysocki.net
Cc: linux-acpi@vger.kernel.org
Cc: guzheng1@huawei.com
Cc: izumi.taku@jp.fujitsu.com
Cc: lenb@kernel.org
Link: http://lkml.kernel.org/r/1488528147-2279-2-git-send-email-douly.fnst@cn.fujitsu.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 25b0b3f2373d31d40151b0fbdf35c0035d332a61
Author: Mike Christie
Date: Thu Mar 2 04:59:50 2017 -0600
target: fix race during implicit transition work flushes
[ Upstream commit 760bf578edf8122f2503a3a6a3f4b0de3b6ce0bb ]
This fixes the following races:
1. core\_alua\_do\_transition\_tg\_pt could have read
tg\_pt\_gp\_alua\_access\_state and gone into this if chunk:
if (!explicit &&
atomic\_read(&tg\_pt\_gp->tg\_pt\_gp\_alua\_access\_state) ==
ALUA\_ACCESS\_STATE\_TRANSITION) {
and then core\_alua\_do\_transition\_tg\_pt\_work could update the
state. core\_alua\_do\_transition\_tg\_pt would then only set
tg\_pt\_gp\_alua\_pending\_state and the tg\_pt\_gp\_alua\_access\_state would
not get updated with the second calls state.
2. core\_alua\_do\_transition\_tg\_pt could be setting
tg\_pt\_gp\_transition\_complete while the tg\_pt\_gp\_transition\_work
is already completing. core\_alua\_do\_transition\_tg\_pt then waits on the
completion that will never be called.
To handle these issues, we just call flush\_work which will return when
core\_alua\_do\_transition\_tg\_pt\_work has completed so there is no need
to do the complete/wait. And, if core\_alua\_do\_transition\_tg\_pt\_work
was running, instead of trying to sneak in the state change, we just
schedule up another core\_alua\_do\_transition\_tg\_pt\_work call.
Note that this does not handle a possible race where there are multiple
threads call core\_alua\_do\_transition\_tg\_pt at the same time. I think
we need a mutex in target\_tg\_pt\_gp\_alua\_access\_state\_store.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 892e4f9bc2e218b0126bb4ae7191be366fb4b421
Author: Mike Christie
Date: Thu Mar 2 04:59:48 2017 -0600
target: fix ALUA transition timeout handling
[ Upstream commit d7175373f2745ed4abe5b388d5aabd06304f801e ]
The implicit transition time tells initiators the min time
to wait before timing out a transition. We currently schedule
the transition to occur in tg\_pt\_gp\_implicit\_trans\_secs
seconds so there is no room for delays. If
core\_alua\_do\_transition\_tg\_pt\_work->core\_alua\_update\_tpg\_primary\_metadata
needs to write out info to a remote file, then the initiator can
easily time out the operation.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0d34f4770ea11c92af2c6a15c73aaebc75ea94ed
Author: Mike Christie
Date: Wed Mar 1 23:13:26 2017 -0600
target: Use system workqueue for ALUA transitions
[ Upstream commit 207ee84133c00a8a2a5bdec94df4a5b37d78881c ]
If tcmu-runner is processing a STPG and needs to change the kernel's
ALUA state then we cannot use the same work queue for task management
requests and ALUA transitions, because we could deadlock. The problem
occurs when a STPG times out before tcmu-runner is able to
call into target\_tg\_pt\_gp\_alua\_access\_state\_store->
core\_alua\_do\_port\_transition -> core\_alua\_do\_transition\_tg\_pt ->
queue\_work. In this case, the tmr is on the work queue waiting for
the STPG to complete, but the STPG transition is now queued behind
the waiting tmr.
Note:
This bug will also be fixed by this patch:
http://www.spinics.net/lists/target-devel/msg14560.html
which switches the tmr code to use the system workqueues.
For both, I am not sure if we need a dedicated workqueue since
it is not a performance path and I do not think we need WQ\_MEM\_RECLAIM
to make forward progress to free up memory like the block layer does.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f60ef94477cb0dd3023b337640ea634886ac1d1
Author: Zygo Blaxell
Date: Fri Mar 10 16:45:44 2017 -0500
btrfs: add missing memset while reading compressed inline extents
[ Upstream commit e1699d2d7bf6e6cce3e1baff19f9dd4595a58664 ]
This is a story about 4 distinct (and very old) btrfs bugs.
Commit c8b978188c ("Btrfs: Add zlib compression support") added
three data corruption bugs for inline extents (bugs #1-3).
Commit 93c82d5750 ("Btrfs: zero page past end of inline file items")
fixed bug #1: uncompressed inline extents followed by a hole and more
extents could get non-zero data in the hole as they were read. The fix
was to add a memset in btrfs\_get\_extent to zero out the hole.
Commit 166ae5a418 ("btrfs: fix inline compressed read err corruption")
fixed bug #2: compressed inline extents which contained non-zero bytes
might be replaced with zero bytes in some cases. This patch removed an
unhelpful memset from uncompress\_inline, but the case where memset is
required was missed.
There is also a memset in the decompression code, but this only covers
decompressed data that is shorter than the ram\_bytes from the extent
ref record. This memset doesn't cover the region between the end of the
decompressed data and the end of the page. It has also moved around a
few times over the years, so there's no single patch to refer to.
This patch fixes bug #3: compressed inline extents followed by a hole
and more extents could get non-zero data in the hole as they were read
(i.e. bug #3 is the same as bug #1, but s/uncompressed/compressed/).
The fix is the same: zero out the hole in the compressed case too,
by putting a memset back in uncompress\_inline, but this time with
correct parameters.
The last and oldest bug, bug #0, is the cause of the offending inline
extent/hole/extent pattern. Bug #0 is a subtle and mostly-harmless quirk
of behavior somewhere in the btrfs write code. In a few special cases,
an inline extent and hole are allowed to persist where they normally
would be combined with later extents in the file.
A fast reproducer for bug #0 is presented below. A few offending extents
are also created in the wild during large rsync transfers with the -S
flag. A Linux kernel build (git checkout; make allyesconfig; make -j8)
will produce a handful of offending files as well. Once an offending
file is created, it can present different content to userspace each
time it is read.
Bug #0 is at least 4 and possibly 8 years old. I verified every vX.Y
kernel back to v3.5 has this behavior. There are fossil records of this
bug's effects in commits all the way back to v2.6.32. I have no reason
to believe bug #0 wasn't present at the beginning of btrfs compression
support in v2.6.29, but I can't easily test kernels that old to be sure.
It is not clear whether bug #0 is worth fixing. A fix would likely
require injecting extra reads into currently write-only paths, and most
of the exceptional cases caused by bug #0 are already handled now.
Whether we like them or not, bug #0's inline extents followed by holes
are part of the btrfs de-facto disk format now, and we need to be able
to read them without data corruption or an infoleak. So enough about
bug #0, let's get back to bug #3 (this patch).
An example of on-disk structure leading to data corruption found in
the wild:
item 61 key (606890 INODE\_ITEM 0) itemoff 9662 itemsize 160
inode generation 50 transid 50 size 47424 nbytes 49141
block group 0 mode 100644 links 1 uid 0 gid 0
rdev 0 flags 0x0(none)
item 62 key (606890 INODE\_REF 603050) itemoff 9642 itemsize 20
inode ref index 3 namelen 10 name: DB\_File.so
item 63 key (606890 EXTENT\_DATA 0) itemoff 8280 itemsize 1362
inline extent data size 1341 ram 4085 compress(zlib)
item 64 key (606890 EXTENT\_DATA 4096) itemoff 8227 itemsize 53
extent data disk byte 5367308288 nr 20480
extent data offset 0 nr 45056 ram 45056
extent compression(zlib)
Different data appears in userspace during each read of the 11 bytes
between 4085 and 4096. The extent in item 63 is not long enough to
fill the first page of the file, so a memset is required to fill the
space between item 63 (ending at 4085) and item 64 (beginning at 4096)
with zero.
Here is a reproducer from Liu Bo, which demonstrates another method
of creating the same inline extent and hole pattern:
Using 'page\_poison=on' kernel command line (or enable
CONFIG\_PAGE\_POISONING) run the following:
# touch foo
# chattr +c foo
# xfs\_io -f -c "pwrite -W 0 1000" foo
# xfs\_io -f -c "falloc 4 8188" foo
# od -x foo
# echo 3 >/proc/sys/vm/drop\_caches
# od -x foo
This produce the following on my box:
Correct output: file contains 1000 data bytes followed
by zeros:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 0000 0000 0000 0000
0001760 0000 0000 0000 0000 0000 0000 0000 0000
\*
0020000
Actual output: the data after the first 1000 bytes
will be different each run:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 6c63 7400 635f 006d
0001760 5f74 6f43 7400 435f 0053 5f74 7363 7400
0002000 435f 0056 5f74 6164 7400 645f 0062 5f74
(...)
Signed-off-by: Zygo Blaxell
Reviewed-by: Liu Bo
Reviewed-by: Chris Mason
Signed-off-by: Chris Mason
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5d460d359abefe59e1cac738d37296f3cd4bc1f8
Author: Olga Kornievskaia
Date: Wed Mar 8 14:39:15 2017 -0500
NFSv4.1 respect server's max size in CREATE\_SESSION
[ Upstream commit 033853325fe3bdc70819a8b97915bd3bca41d3af ]
Currently client doesn't respect max sizes server returns in CREATE\_SESSION.
nfs4\_session\_set\_rwsize() gets called and server->rsize, server->wsize are 0
so they never get set to the sizes returned by the server.
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 88af4e34771c88a09ed722bbf4346a2ddfee6dbe
Author: Daniel Drake
Date: Tue Feb 7 13:08:23 2017 -0600
efi/esrt: Cleanup bad memory map log messages
[ Upstream commit 822f5845f710e57d7e2df1fd1ee00d6e19d334fe ]
The Intel Compute Stick STCK1A8LFC and Weibu F3C platforms both
log 2 error messages during boot:
efi: requested map not found.
esrt: ESRT header is not in the memory map.
Searching the web, this seems to affect many other platforms too.
Since these messages are logged as errors, they appear on-screen during
the boot process even when using the "quiet" boot parameter used by
distros.
Demote the ESRT error to a warning so that it does not appear on-screen,
and delete the error logging from efi\_mem\_desc\_lookup; both callsites
of that function log more specific messages upon failure.
Out of curiosity I looked closer at the Weibu F3C. There is no entry in
the UEFI-provided memory map which corresponds to the ESRT pointer, but
hacking the code to map it anyway, the ESRT does appear to be valid with
2 entries.
Signed-off-by: Daniel Drake
Cc: Matt Fleming
Acked-by: Peter Jones
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e30b840d466898a02df6986dbb633b967f0ea594
Author: Daniel Borkmann
Date: Wed Mar 15 22:53:37 2017 +0100
perf symbols: Fix symbols\_\_fixup\_end heuristic for corner cases
[ Upstream commit e7ede72a6d40cb3a30c087142d79381ca8a31dab ]
The current symbols\_\_fixup\_end() heuristic for the last entry in the rb
tree is suboptimal as it leads to not being able to recognize the symbol
in the call graph in a couple of corner cases, for example:
i) If the symbol has a start address (f.e. exposed via kallsyms)
that is at a page boundary, then the roundup(curr->start, 4096)
for the last entry will result in curr->start == curr->end with
a symbol length of zero.
ii) If the symbol has a start address that is shortly before a page
boundary, then also here, curr->end - curr->start will just be
very few bytes, where it's unrealistic that we could perform a
match against.
Instead, change the heuristic to roundup(curr->start, 4096) + 4096, so
that we can catch such corner cases and have a better chance to find
that specific symbol. It's still just best effort as the real end of the
symbol is unknown to us (and could even be at a larger offset than the
current range), but better than the current situation.
Alexei reported that he recently run into case i) with a JITed eBPF
program (these are all page aligned) as the last symbol which wasn't
properly shown in the call graph (while other eBPF program symbols in
the rb tree were displayed correctly). Since this is a generic issue,
lets try to improve the heuristic a bit.
Reported-and-Tested-by: Alexei Starovoitov
Signed-off-by: Daniel Borkmann
Fixes: 2e538c4a1847 ("perf tools: Improve kernel/modules symbol lookup")
Link: http://lkml.kernel.org/r/bb5c80d27743be6f12afc68405f1956a330e1bc9.1489614365.git.daniel@iogearbox.net
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2a47e7de0822ec4794c6a44d8a43c66c49f4d355
Author: Dmitry Vyukov
Date: Sat Mar 4 13:46:12 2017 +0100
tty: fix data race in tty\_ldisc\_ref\_wait()
[ Upstream commit a4a3e061149f09c075f108b6f1cf04d9739a6bc2 ]
tty\_ldisc\_ref\_wait() checks tty->ldisc under tty->ldisc\_sem.
But if ldisc==NULL it releases them sem and reloads
tty->ldisc without holding the sem. This is wrong and
can lead to returning non-NULL ldisc without protection.
Don't reload tty->ldisc second time.
Signed-off-by: Dmitry Vyukov
Cc: syzkaller@googlegroups.com
Cc: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Cc: Peter Hurley
Cc: One Thousand Gnomes
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 70f450fc8610464d4ac2274b403b8b15797c27af
Author: Dmitry Vyukov
Date: Sat Mar 4 14:55:19 2017 +0100
tty: don't panic on OOM in tty\_set\_ldisc()
[ Upstream commit 5362544bebe85071188dd9e479b5a5040841c895 ]
If tty\_ldisc\_open() fails in tty\_set\_ldisc(), it tries to go back
to the old discipline or N\_TTY. But that can fail as well, in such
case it panics. This is not a graceful way to handle OOM.
Leave ldisc==NULL if all attempts fail instead.
Also use existing tty\_ldisc\_reinit() helper function instead of
tty\_ldisc\_restore(). Also don't WARN/BUG in tty\_ldisc\_reinit()
if N\_TTY fails, which would have the same net effect of bringing
kernel down on OOM. Instead print a single line message about
what has happened.
Signed-off-by: Dmitry Vyukov
Cc: syzkaller@googlegroups.com
Cc: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Cc: Peter Hurley
Cc: One Thousand Gnomes
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d57ec51d204d220d0eff1e903fb58af86a889de
Author: David Howells
Date: Thu Mar 16 16:27:10 2017 +0000
rxrpc: Ignore BUSY packets on old calls
[ Upstream commit 4d4a6ac73e7466c2085c307fac41f74ce4568a45 ]
If we receive a BUSY packet for a call we think we've just completed, the
packet is handed off to the connection processor to deal with - but the
connection processor doesn't expect a BUSY packet and so flags a protocol
error.
Fix this by simply ignoring the BUSY packet for the moment.
The symptom of this may appear as a system call failing with EPROTO. This
may be triggered by pressing ctrl-C under some circumstances.
This comes about we abort calls due to interruption by a signal (which we
shouldn't do, but that's going to be a large fix and mostly in fs/afs/).
What happens is that we abort the call and may also abort follow up calls
too (this needs offloading somehoe). So we see a transmission of something
like the following sequence of packets:
DATA for call N
ABORT call N
DATA for call N+1
ABORT call N+1
in very quick succession on the same channel. However, the peer may have
deferred the processing of the ABORT from the call N to a background thread
and thus sees the DATA message from the call N+1 coming in before it has
cleared the channel. Thus it sends a BUSY packet[\*].
[\*] Note that some implementations (OpenAFS, for example) mark the BUSY
packet with one plus the callNumber of the call prior to call N.
Ordinarily, this would be call N, but there's no requirement for the
calls on a channel to be numbered strictly sequentially (the number is
required to increase).
This is wrong and means that the callNumber in the BUSY packet should
be ignored (it really ought to be N+1 since that's what it's in
response to).
Signed-off-by: David Howells
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 42b6d6e824d349eef8a3d1925a2667564a31b8b8
Author: David Ahern
Date: Mon Mar 13 16:49:10 2017 -0700
net: mpls: Fix nexthop alive tracking on down events
[ Upstream commit 61733c91c454a61be0ffc93fe46a5d5f2f048c1c ]
Alive tracking of nexthops can account for a link twice if the carrier
goes down followed by an admin down of the same link rendering multipath
routes useless. This is similar to 79099aab38c8 for UNREGISTER events and
DOWN events.
Fix by tracking number of alive nexthops in mpls\_ifdown similar to the
logic in mpls\_ifup. Checking the flags per nexthop once after all events
have been processed is simpler than trying to maintian a running count
through all event combinations.
Also, WRITE\_ONCE is used instead of ACCESS\_ONCE to set rt\_nhn\_alive
per a comment from checkpatch:
WARNING: Prefer WRITE\_ONCE(, ) over ACCESS\_ONCE() =
Fixes: c89359a42e2a4 ("mpls: support for dead routes")
Signed-off-by: David Ahern
Acked-by: Robert Shearman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fd27dbcae9371d0f15b3f0fcb69a544e41d819ba
Author: Jack Morgenstein
Date: Mon Mar 13 19:29:08 2017 +0200
net/mlx4\_core: Avoid delays during VF driver device shutdown
[ Upstream commit 4cbe4dac82e423ecc9a0ba46af24a860853259f4 ]
Some Hypervisors detach VFs from VMs by instantly causing an FLR event
to be generated for a VF.
In the mlx4 case, this will cause that VF's comm channel to be disabled
before the VM has an opportunity to invoke the VF device's "shutdown"
method.
For such Hypervisors, there is a race condition between the VF's
shutdown method and its internal-error detection/reset thread.
The internal-error detection/reset thread (which runs every 5 seconds) also
detects a disabled comm channel. If the internal-error detection/reset
flow wins the race, we still get delays (while that flow tries repeatedly
to detect comm-channel recovery).
The cited commit fixed the command timeout problem when the
internal-error detection/reset flow loses the race.
This commit avoids the unneeded delays when the internal-error
detection/reset flow wins.
Fixes: d585df1c5ccf ("net/mlx4\_core: Avoid command timeouts during VF driver device shutdown")
Signed-off-by: Jack Morgenstein
Reported-by: Simon Xiao
Signed-off-by: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 65bfe003dcebd1144edacedb43c2f96d813bab79
Author: Sagi Grimberg
Date: Thu Mar 9 13:45:52 2017 +0200
nvmet-rdma: Fix a possible uninitialized variable dereference
[ Upstream commit b25634e2a051bef4b2524b11adddfbfa6448f6cd ]
When handling a new recv command, we grab a new rsp resource and
check for the queue state being live. In case the queue is not in
live state, we simply restore the rsp back to the free list. However
in this flow we didn't set rsp->queue yet, so we cannot dereference it.
Instead, make sure to initialize rsp->queue (and other rsp members)
as soon as possible so we won't reference uninitialized variables.
Reported-by: Yi Zhang
Reported-by: Raju Rangoju
Reviewed-by: Christoph Hellwig
Tested-by: Raju Rangoju
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 571e47760de55281834f28a54f75d51285e7787d
Author: Sagi Grimberg
Date: Mon Mar 6 18:46:20 2017 +0200
nvmet: confirm sq percpu has scheduled and switched to atomic
[ Upstream commit d11ea004a458b982e19b188c386e25a9b66ec446 ]
percpu\_ref\_kill is not enough to prevent subsequent
percpu\_ref\_tryget\_live from failing. Hence call
perfcpu\_ref\_kill\_confirm to make it safe.
Reviewed-by: Christoph Hellwig
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit af0cee086b0920612de5d6ad2a8f406792b5aa9d
Author: Sagi Grimberg
Date: Mon Feb 27 18:44:45 2017 +0200
nvme-loop: fix a possible use-after-free when destroying the admin queue
[ Upstream commit e4c5d3762e2d6d274bd1cc948c47063becfa2103 ]
we need to destroy the nvmet sq and let it finish gracefully
before continue to cleanup the queue.
Reviewed-by: Christoph Hellwig
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a8939aac82b0802fa66ca6455ed8bc88913556cf
Author: David Howells
Date: Thu Mar 16 16:27:49 2017 +0000
afs: Fix abort on signal while waiting for call completion
[ Upstream commit 954cd6dc02a65065aecb7150962c0870c5b0e322 ]
Fix the way in which a call that's in progress and being waited for is
aborted in the case that EINTR is detected. We should be sending
RX\_USER\_ABORT rather than RX\_CALL\_DEAD as the abort code.
Note that since the only two ways out of the loop are if the call completes
or if a signal happens, the kill-the-call clause after the loop has
finished can only happen in the case of EINTR. This means that we only
have one abort case to deal with, not two, and the "KWC" case can never
happen and so can be deleted.
Note further that simply aborting the call isn't necessarily the best thing
here since at this point: the request has been entirely sent and it's
likely the server will do the operation anyway - whether we abort it or
not. In future, we should punt the handling of the remainder of the call
off to a background thread.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d43dda072544ecf7890eab6a920fb602c9aafa63
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix afs\_kill\_pages()
[ Upstream commit 7286a35e893176169b09715096a4aca557e2ccd2 ]
Fix afs\_kill\_pages() in two ways:
(1) If a writeback has been partially flushed, then if we try and kill the
pages it contains, some of them may no longer be undergoing writeback
and end\_page\_writeback() will assert.
Fix this by checking to see whether the page in question is actually
undergoing writeback before ending that writeback.
(2) The loop that scans for pages to kill doesn't increase the first page
index, and so the loop may not terminate, but it will try to process
the same pages over and over again.
Fix this by increasing the first page index to one after the last page
we processed.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 856bb4b609ee1cac2a5c74a30c40ad82e782dabf
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix page leak in afs\_write\_begin()
[ Upstream commit 6d06b0d25209c80e99c1e89700f1e09694a3766b ]
afs\_write\_begin() leaks a ref and a lock on a page if afs\_fill\_page()
fails. Fix the leak by unlocking and releasing the page in the error path.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 833acb3e09dba37c277ed16bc46792c310066264
Author: Marc Dionne
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Populate and use client modification time
[ Upstream commit ab94f5d0dd6fd82e7eeca5e7c8096eaea0a0261f ]
The inode timestamps should be set from the client time
in the status received from the server, rather than the
server time which is meant for internal server use.
Set AFS\_SET\_MTIME and populate the mtime for operations
that take an input status, such as file/dir creation
and StoreData. If an input time is not provided the
server will set the vnode times based on the current server
time.
In a situation where the server has some skew with the
client, this could lead to the client seeing a timestamp
in the future for a file that it just created or wrote.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a3e7a29abf0bf205292ee63bd5d1de54aaa6d18f
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Better abort and net error handling
[ Upstream commit 70af0e3bd65142f9e674961c975451638a7ce1d5 ]
If we receive a network error, a remote abort or a protocol error whilst
we're still transmitting data, make sure we return an appropriate error to
the caller rather than ESHUTDOWN or ECONNABORTED.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ab239061161929a3aa048cb514b0183b8742b04c
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Invalid op ID should abort with RXGEN\_OPCODE
[ Upstream commit 1157f153f37a8586765034470e4f00a4a6c4ce6f ]
When we are given an invalid operation ID, we should abort that with
RXGEN\_OPCODE rather than RX\_INVALID\_OPERATION.
Also map RXGEN\_OPCODE to -ENOTSUPP.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 972e7b7cbf5c82e9b0b963c9443a30dd3354687b
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Fix the maths in afs\_fs\_store\_data()
[ Upstream commit 146a1192783697810b63a1e41c4d59fc93387340 ]
afs\_fs\_store\_data() works out of the size of the write it's going to make,
but it uses 32-bit unsigned subtraction in one place that gets
automatically cast to loff\_t.
However, if to < offset, then the number goes negative, but as the result
isn't signed, this doesn't get sign-extended to 64-bits when placed in a
loff\_t.
Fix by casting the operands to loff\_t.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9329ae4cb10e2563b8ec15a3d6a2a15dfe16fd3d
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Prevent callback expiry timer overflow
[ Upstream commit 56e714312e7dbd6bb83b2f78d3ec19a404c7649f ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs\_vnode record to use ktime\_get\_real\_seconds() instead, for the
fields cb\_expires and cb\_expires\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7da1b85a75d4dd9b090a242ea162f27d2aea7518
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Migrate vlocation fields to 64-bit
[ Upstream commit 8a79790bf0b7da216627ffb85f52cfb4adbf1e4e ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs's vlocation record to use ktime\_get\_real\_seconds() instead, for the
fields time\_of\_death and update\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7286fad1570444b924568b13994843ab28b55dd4
Author: David Howells
Date: Thu Mar 16 16:27:45 2017 +0000
afs: Flush outstanding writes when an fd is closed
[ Upstream commit 58fed94dfb17e89556b5705f20f90e5b2971b6a1 ]
Flush outstanding writes in afs when an fd is closed. This is what NFS and
CIFS do.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit eaaad7646d3de73ca30653e635261827242be124
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Deal with an empty callback array
[ Upstream commit bcd89270d93b7edebb5de5e5e7dca1a77a33496e ]
Servers may send a callback array that is the same size as
the FID array, or an empty array. If the callback count is
0, the code would attempt to read (fid\_count \* 12) bytes of
data, which would fail and result in an unmarshalling error.
This would lead to stale data for remotely modified files
or directories.
Store the callback array size in the internal afs\_call
structure and use that to determine the amount of data to
read.
Signed-off-by: Marc Dionne
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 900048089cc135fea39452ec32aa44415e1c8dba
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Adjust mode bits processing
[ Upstream commit 627f46943ff90bcc32ddeb675d881c043c6fa2ae ]
Mode bits for an afs file should not be enforced in the usual
way.
For files, the absence of user bits can restrict file access
with respect to what is granted by the server.
These bits apply regardless of the owner or the current uid; the
rest of the mode bits (group, other) are ignored.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ba47c159748068a3371fdc0d77c7c1dcef2b7271
Author: Marc Dionne
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Populate group ID from vnode status
[ Upstream commit 6186f0788b31f44affceeedc7b48eb10faea120d ]
The group was hard coded to GLOBAL\_ROOT\_GID; use the group
ID that was received from the server.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c250fae9ad4bb1d629b8451c2e07b300e0fb8bb8
Author: David Howells
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Fix missing put\_page()
[ Upstream commit 29c8bbbd6e21daa0997d1c3ee886b897ee7ad652 ]
In afs\_writepages\_region(), inside the loop where we find dirty pages to
deal with, one of the if-statements is missing a put\_page().
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b29c7b7c62d5aa8ba3748c6dfebeee19c279fc14
Author: Alex Deucher
Date: Wed Mar 15 21:11:46 2017 -0400
drm/radeon: reinstate oland workaround for sclk
[ Upstream commit 66822d815ae61ecb2d9dba9031517e8a8476969d ]
Higher sclks seem to be unstable on some boards.
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=100222
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2a84fce9b0396b62c6e3020b5fb9f5378697b6ae
Author: yong mao
Date: Sat Mar 4 15:10:03 2017 +0800
mmc: mediatek: Fixed bug where clock frequency could be set wrong
[ Upstream commit 40ceda09c8c84694c2ca6b00bcc6dc71e8e62d96 ]
This patch can fix two issues:
Issue 1:
In previous code, div may be overflow when setting clock frequency
as f\_min. We can use DIV\_ROUND\_UP to fix this boundary related
issue.
Issue 2:
In previous code, we can not set the correct clock frequency when
div equals 0xff.
Signed-off-by: Yong Mao
Signed-off-by: Chaotian Jing
Reviewed-by: Daniel Kurtz
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28714e962a719d1898b6cff5d51352bac2135534
Author: Steven Rostedt (VMware)
Date: Thu Mar 2 15:10:59 2017 +0100
sched/deadline: Use deadline instead of period when calculating overflow
[ Upstream commit 2317d5f1c34913bac5971d93d69fb6c31bb74670 ]
I was testing Daniel's changes with his test case, and tweaked it a
little. Instead of having the runtime equal to the deadline, I
increased the deadline ten fold.
Daniel's test case had:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
To make it more interesting, I changed it to:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 20 \* 1000 \* 1000; /\* 20 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
The results were rather surprising. The behavior that Daniel's patch
was fixing came back. The task started using much more than .1% of the
CPU. More like 20%.
Looking into this I found that it was due to the dl\_entity\_overflow()
constantly returning true. That's because it uses the relative period
against relative runtime vs the absolute deadline against absolute
runtime.
runtime / (deadline - t) > dl\_runtime / dl\_period
There's even a comment mentioning this, and saying that when relative
deadline equals relative period, that the equation is the same as using
deadline instead of period. That comment is backwards! What we really
want is:
runtime / (deadline - t) > dl\_runtime / dl\_deadline
We care about if the runtime can make its deadline, not its period. And
then we can say "when the deadline equals the period, the equation is
the same as using dl\_period instead of dl\_deadline".
After correcting this, now when the task gets enqueued, it can throttle
correctly, and Daniel's fix to the throttling of sleeping deadline
tasks works even when the runtime and deadline are not the same.
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Daniel Bristot de Oliveira
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/02135a27f1ae3fe5fd032568a5a2f370e190e8d7.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a2e29113f1abe5299c0af6ab841cbdddfd427fcf
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:58 2017 +0100
sched/deadline: Throttle a constrained deadline task activated after the deadline
[ Upstream commit df8eac8cafce7d086be3bd5cf5a838fa37594dfb ]
During the activation, CBS checks if it can reuse the current task's
runtime and period. If the deadline of the task is in the past, CBS
cannot use the runtime, and so it replenishes the task. This rule
works fine for implicit deadline tasks (deadline == period), and the
CBS was designed for implicit deadline tasks. However, a task with
constrained deadline (deadine < period) might be awakened after the
deadline, but before the next period. In this case, replenishing the
task would allow it to run for runtime / deadline. As in this case
deadline < period, CBS enables a task to run for more than the
runtime / period. In a very loaded system, this can cause a domino
effect, making other tasks miss their deadlines.
To avoid this problem, in the activation of a constrained deadline
task after the deadline but before the next period, throttle the
task and set the replenishing timer to the begin of the next period,
unless it is boosted.
Reproducer:
--------------- %< ---------------
int main (int argc, char \*\*argv)
{
int ret;
int flags = 0;
unsigned long l = 0;
struct timespec ts;
struct sched\_attr attr;
memset(&attr, 0, sizeof(attr));
attr.size = sizeof(attr);
attr.sched\_policy = SCHED\_DEADLINE;
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
ts.tv\_sec = 0;
ts.tv\_nsec = 2000 \* 1000; /\* 2 ms \*/
ret = sched\_setattr(0, &attr, flags);
if (ret < 0) {
perror("sched\_setattr");
exit(-1);
}
for(;;) {
/\* XXX: you may need to adjust the loop \*/
for (l = 0; l < 150000; l++);
/\*
\* The ideia is to go to sleep right before the deadline
\* and then wake up before the next period to receive
\* a new replenishment.
\*/
nanosleep(&ts, NULL);
}
exit(0);
}
--------------- >% ---------------
On my box, this reproducer uses almost 50% of the CPU time, which is
obviously wrong for a task with 2/2000 reservation.
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/edf58354e01db46bf42df8d2dd32418833f68c89.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cc56a00eab7604f2c99ce27665dbb4fa9fa3280
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:57 2017 +0100
sched/deadline: Make sure the replenishment timer fires in the next period
[ Upstream commit 5ac69d37784b237707a7b15d199cdb6c6fdb6780 ]
Currently, the replenishment timer is set to fire at the deadline
of a task. Although that works for implicit deadline tasks because the
deadline is equals to the begin of the next period, that is not correct
for constrained deadline tasks (deadline < period).
For instance:
f.c:
--------------- %< ---------------
int main (void)
{
for(;;);
}
--------------- >% ---------------
# gcc -o f f.c
# trace-cmd record -e sched:sched\_switch \
-e syscalls:sys\_exit\_sched\_setattr \
chrt -d --sched-runtime 490000000 \
--sched-deadline 500000000 \
--sched-period 1000000000 0 ./f
# trace-cmd report | grep "{pid of ./f}"
After setting parameters, the task is replenished and continue running
until being throttled:
f-11295 [003] 13322.113776: sys\_exit\_sched\_setattr: 0x0
The task is throttled after running 492318 ms, as expected:
f-11295 [003] 13322.606094: sched\_switch: f:11295 [-1] R ==> watchdog/3:32 [0]
But then, the task is replenished 500719 ms after the first
replenishment:
-0 [003] 13322.614495: sched\_switch: swapper/3:0 [120] R ==> f:11295 [-1]
Running for 490277 ms:
f-11295 [003] 13323.104772: sched\_switch: f:11295 [-1] R ==> swapper/3:0 [120]
Hence, in the first period, the task runs 2 \* runtime, and that is a bug.
During the first replenishment, the next deadline is set one period away.
So the runtime / period starts to be respected. However, as the second
replenishment took place in the wrong instant, the next replenishment
will also be held in a wrong instant of time. Rather than occurring in
the nth period away from the first activation, it is taking place
in the (nth period - relative deadline).
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Luca Abeni
Reviewed-by: Steven Rostedt (VMware)
Reviewed-by: Juri Lelli
Cc: Linus Torvalds
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/ac50d89887c25285b47465638354b63362f8adff.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0a4d4dac5e342889331a88e70ee24f29c7b64873
Author: Wanpeng Li
Date: Mon Mar 6 21:51:28 2017 -0800
sched/deadline: Add missing update\_rq\_clock() in dl\_task\_timer()
[ Upstream commit dcc3b5ffe1b32771c9a22e2c916fb94c4fcf5b79 ]
The following warning can be triggered by hot-unplugging the CPU
on which an active SCHED\_DEADLINE task is running on:
------------[ cut here ]------------
WARNING: CPU: 7 PID: 0 at kernel/sched/sched.h:833 replenish\_dl\_entity+0x71e/0xc40
rq->clock\_update\_flags < RQCF\_ACT\_SKIP
CPU: 7 PID: 0 Comm: swapper/7 Tainted: G B 4.11.0-rc1+ #24
Hardware name: LENOVO ThinkCentre M8500t-N000/SHARKBAY, BIOS FBKTC1AUS 02/16/2016
Call Trace:
dump\_stack+0x85/0xc4
\_\_warn+0x172/0x1b0
warn\_slowpath\_fmt+0xb4/0xf0
? \_\_warn+0x1b0/0x1b0
? debug\_check\_no\_locks\_freed+0x2c0/0x2c0
? cpudl\_set+0x3d/0x2b0
replenish\_dl\_entity+0x71e/0xc40
enqueue\_task\_dl+0x2ea/0x12e0
? dl\_task\_timer+0x777/0x990
? \_\_hrtimer\_run\_queues+0x270/0xa50
dl\_task\_timer+0x316/0x990
? enqueue\_task\_dl+0x12e0/0x12e0
? enqueue\_task\_dl+0x12e0/0x12e0
\_\_hrtimer\_run\_queues+0x270/0xa50
? hrtimer\_cancel+0x20/0x20
? hrtimer\_interrupt+0x119/0x600
hrtimer\_interrupt+0x19c/0x600
? trace\_hardirqs\_off+0xd/0x10
local\_apic\_timer\_interrupt+0x74/0xe0
smp\_apic\_timer\_interrupt+0x76/0xa0
apic\_timer\_interrupt+0x93/0xa0
The DL task will be migrated to a suitable later deadline rq once the DL
timer fires and currnet rq is offline. The rq clock of the new rq should
be updated. This patch fixes it by updating the rq clock after holding
the new rq's rq lock.
Signed-off-by: Wanpeng Li
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Matt Fleming
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: http://lkml.kernel.org/r/1488865888-15894-1-git-send-email-wanpeng.li@hotmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8d3a318194ec6a3c52384cbc63894e8dfcc15c9b
Author: Sara Sharon
Date: Tue Mar 14 09:50:35 2017 +0200
iwlwifi: mvm: cleanup pending frames in DQA mode
[ Upstream commit 9a3fcf912ef7f5c6e18f9af6875dd13f7311f7aa ]
When a station is asleep, the fw will set it as "asleep".
All queues that are used only by one station will be stopped by
the fw.
In pre-DQA mode this was relevant for aggregation queues. However,
in DQA mode a queue is owned by one station only, so all queues
will be stopped.
As a result, we don't expect to get filtered frames back to
mac80211 and don't have to maintain the entire pending\_frames
state logic, the same way as we do in aggregations.
The correct behavior is to align DQA behavior with the aggregation
queue behaviour pre-DQA:
- Don't count pending frames.
- Let mac80211 know we have frames in these queues so that it can
properly handle trigger frames.
When a trigger frame is received, mac80211 tells the driver to send
frames from the queues using release\_buffered\_frames.
The driver will tell the fw to let frames out even if the station
is asleep. This is done by iwl\_mvm\_sta\_modify\_sleep\_tx\_count.
Reported-and-tested-by: Jens Axboe
Reported-by: Linus Torvalds
Signed-off-by: Sara Sharon
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a524bb57dd367c299b6c61ff39df6328ae49ed08
Author: Vitaly Kuznetsov
Date: Sat Mar 4 18:13:59 2017 -0700
Drivers: hv: util: move waiting for release to hv\_utils\_transport itself
[ Upstream commit e9c18ae6eb2b312f16c63e34b43ea23926daa398 ]
Waiting for release\_event in all three drivers introduced issues on release
as on\_reset() hook is not always called. E.g. if the device was never
opened we will never get the completion.
Move the waiting code to hvutil\_transport\_destroy() and make sure it is
only called when the device is open. hvt->lock serialization should
guarantee the absence of races.
Fixes: 5a66fecbf6aa ("Drivers: hv: util: kvp: Fix a rescind processing issue")
Fixes: 20951c7535b5 ("Drivers: hv: util: Fcopy: Fix a rescind processing issue")
Fixes: d77044d142e9 ("Drivers: hv: util: Backup: Fix a rescind processing issue")
Reported-by: Dexuan Cui
Tested-by: Dexuan Cui
Signed-off-by: Vitaly Kuznetsov
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da626b13ce329cb2629897251226ca8be54ab919
Author: Alex Deucher
Date: Tue Mar 14 14:42:03 2017 -0400
drm/radeon/si: add dpm quirk for Oland
[ Upstream commit 0f424de1fd9bc4ab24bd1fe5430ab5618e803e31 ]
OLAND 0x1002:0x6604 0x1028:0x066F 0x00 seems to have problems
with higher sclks.
Acked-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1867eb805091fbcd654161dbb15acfe3b92f1599
Author: Taku Izumi
Date: Wed Mar 15 13:47:50 2017 +0900
fjes: Fix wrong netdevice feature flags
[ Upstream commit fe8daf5fa715f7214952f06a387e4b7de818c5be ]
This patch fixes netdev->features for Extended Socket network device.
Currently Extended Socket network device's netdev->feature claims
NETIF\_F\_HW\_CSUM, however this is completely wrong. There's no feature
of checksum offloading.
That causes invalid TCP/UDP checksum and packet rejection when IP
forwarding from Extended Socket network device to other network device.
NETIF\_F\_HW\_CSUM should be omitted.
Signed-off-by: Taku Izumi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 91510a623baa8c3be2033e42634ebc837e819635
Author: Don Brace
Date: Fri Mar 10 14:35:23 2017 -0600
scsi: hpsa: do not timeout reset operations
[ Upstream commit 2ef2884980873081a4edae92f9d88dd580c85f6e ]
Resets can take longer than DEFAULT\_TIMEOUT.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0f07e7611184cd78a26dd1fbf13513264896cdac
Author: Don Brace
Date: Fri Mar 10 14:35:17 2017 -0600
scsi: hpsa: limit outstanding rescans
[ Upstream commit 87b9e6aa87d9411f1059aa245c0c79976bc557ac ]
Avoid rescan storms. No need to queue another if one is pending.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c81410a4353d45766564ba6af9a067d33d1525d7
Author: Don Brace
Date: Fri Mar 10 14:35:11 2017 -0600
scsi: hpsa: update check for logical volume status
[ Upstream commit 85b29008d8af6d94a0723aaa8d93cfb6e041158b ]
- Add in a new case for volume offline. Resolves internal testing bug
for multilun array management.
- Return correct status for failed TURs.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8652baa5a31d9f65f93464d27d9a330e3dee6191
Author: Kuninori Morimoto
Date: Tue Mar 14 09:34:49 2017 +0900
ASoC: rcar: clear DE bit only in PDMACHCR when it stops
[ Upstream commit 62a10498afb27370ec6018e9d802b74850fd8d9a ]
R-Car datasheet indicates "Clear DE in PDMACHCR" for transfer stop,
but current code clears all bits in PDMACHCR.
Because of this, DE bit might never been cleared,
and it causes CMD overflow. This patch fixes this issue.
Signed-off-by: Kuninori Morimoto
Tested-by: Hiroyuki Yokoyama
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fd2530a4ee62c17bc8e8715cc6f449c1a1f7f212
Author: Stafford Horne
Date: Mon Mar 13 07:44:45 2017 +0900
openrisc: fix issue handling 8 byte get\_user calls
[ Upstream commit 154e67cd8e8f964809d0e75e44bb121b169c75b3 ]
Was getting the following error with allmodconfig:
ERROR: "\_\_get\_user\_bad" [lib/test\_user\_copy.ko] undefined!
This was simply a missing break statement, causing an unwanted fall
through.
Signed-off-by: Stafford Horne
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18b39b61b2c66556396f8584f0769f221d3383f6
Author: Alexander Shishkin
Date: Thu Jun 30 16:10:51 2016 +0300
intel\_th: pci: Add Gemini Lake support
[ Upstream commit 340837f985c2cb87ca0868d4aa9ce42b0fab3a21 ]
This adds Intel(R) Trace Hub PCI ID for Gemini Lake SOC.
Signed-off-by: Alexander Shishkin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3544f57578a6110f14e837c2a002a8eadad510cf
Author: Arnd Bergmann
Date: Tue Mar 14 22:27:11 2017 +0100
drm: amd: remove broken include path
[ Upstream commit 655d9ca9ac075da1ef2a45012ba48a39f6eb1f58 ]
The AMD ACP driver adds "-I../acp -I../acp/include" to the gcc command
line, which makes no sense, since these are evaluated relative to the
build directory. When we build with "make W=1", they instead cause
a warning:
cc1: error: ../acp/: No such file or directory [-Werror=missing-include-dirs]
cc1: error: ../acp/include: No such file or directory [-Werror=missing-include-dirs]
cc1: all warnings being treated as errors
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.o' failed
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_device.o' failed
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_kms.o' failed
This removes the subdir-ccflags variable that evidently did not
serve any purpose here.
Signed-off-by: Arnd Bergmann
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c9c0971271dfcc5f0e74232446f938e2bed717b
Author: Ram Amrani
Date: Tue Mar 14 15:26:02 2017 +0200
qed: Fix interrupt flags on Rx LL2
[ Upstream commit 1df2adedcce17ad4a39fba74f0e2b611f797fe10 ]
Before iterating over the the LL2 Rx ring, the ring's
spinlock is taken via spin\_lock\_irqsave().
The actual processing of the packet [including handling
by the protocol driver] is done without said lock,
so qed releases the spinlock and re-claims it afterwards.
Problem is that the final spin\_lock\_irqrestore() at the end
of the iteration uses the original flags saved from the
initial irqsave() instead of the flags from the most recent
irqsave(). So it's possible that the interrupt status would
be incorrect at the end of the processing.
Fixes: 0a7fb11c23c0 ("qed: Add Light L2 support");
CC: Ram Amrani
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ac04ab9624b5337628a8a5b96eee81a6fee704e5
Author: Mintz, Yuval
Date: Tue Mar 14 15:26:00 2017 +0200
qed: Fix mapping leak on LL2 rx flow
[ Upstream commit 752ecb2da11124a948567076b60767dc8034cfa5 ]
When receiving an Rx LL2 packet, qed fails to unmap the previous buffer.
Fixes: 0a7fb11c23c0 ("qed: Add Light L2 support");
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8de6d7b28d2f135838275258b715a52db27fdb1c
Author: Ram Amrani
Date: Tue Mar 14 15:25:58 2017 +0200
qed: Align CIDs according to DORQ requirement
[ Upstream commit f3e48119b97f56fb09310c95d49da122a27003d7 ]
The Doorbell HW block can be configured at a granularity
of 16 x CIDs, so we need to make sure that the actual number
of CIDs configured would be a multiplication of 16.
Today, when RoCE is enabled - given that the number is unaligned,
doorbelling the higher CIDs would fail to reach the firmware and
would eventually timeout.
Fixes: dbb799c39717 ("qed: Initialize hardware for new protocols")
Signed-off-by: Ram Amrani
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fddc3df7647e796c8947215a281db95109d17ac1
Author: Jiri Pirko
Date: Tue Mar 14 14:00:01 2017 +0100
mlxsw: reg: Fix SPVMLR max record count
[ Upstream commit e9093b1183bbac462d2caef3eac165778c0b1bf1 ]
The num\_rec field is 8 bit, so the maximal count number is 255.
This fixes vlans learning not being enabled for wider ranges than 255.
Fixes: a4feea74cd7a ("mlxsw: reg: Add Switch Port VLAN MAC Learning register definition")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c8b4e60b5755b65c39db2adcb3cc5ba293e118e
Author: Jiri Pirko
Date: Tue Mar 14 14:00:00 2017 +0100
mlxsw: reg: Fix SPVM max record count
[ Upstream commit f004ec065b4879d6bc9ba0211af2169b3ce3097f ]
The num\_rec field is 8 bit, so the maximal count number is 255. This
fixes vlans not being enabled for wider ranges than 255.
Fixes: b2e345f9a454 ("mlxsw: reg: Add Switch Port VID and Switch Port VLAN Membership registers definitions")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6c548e90a0bcfc8beb29ccb0de5d7d40efb41da9
Author: Vlad Yasevich
Date: Tue Mar 14 08:58:08 2017 -0400
net: Resend IGMP memberships upon peer notification.
[ Upstream commit 37c343b4f4e70e9dc328ab04903c0ec8d154c1a4 ]
When we notify peers of potential changes, it's also good to update
IGMP memberships. For example, during VM migration, updating IGMP
memberships will redirect existing multicast streams to the VM at the
new location.
Signed-off-by: Vladislav Yasevich
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 889163d75fe5e0cb4ead674851e08c4e706d645c
Author: Arnd Bergmann
Date: Tue Mar 14 13:54:12 2017 +0100
irqchip/mvebu-odmi: Select GENERIC\_MSI\_IRQ\_DOMAIN
[ Upstream commit fa23b9d1b89fdc34f296f02e496a20aeff5736be ]
This driver uses the MSI domain but has no strict dependency on PCI\_MSI, so we
may run into a build failure when CONFIG\_GENERIC\_MSI\_IRQ\_DOMAIN is disabled:
drivers/irqchip/irq-mvebu-odmi.c:152:15: error: variable 'odmi\_msi\_ops' has initializer but incomplete type
static struct msi\_domain\_ops odmi\_msi\_ops = {
^~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:155:15: error: variable 'odmi\_msi\_domain\_info' has initializer but incomplete type
static struct msi\_domain\_info odmi\_msi\_domain\_info = {
^~~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:3: error: 'struct msi\_domain\_info' has no member named 'flags'
.flags = (MSI\_FLAG\_USE\_DEF\_DOM\_OPS | MSI\_FLAG\_USE\_DEF\_CHIP\_OPS),
^~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:12: error: 'MSI\_FLAG\_USE\_DEF\_DOM\_OPS' undeclared here (not in a function)
.flags = (MSI\_FLAG\_USE\_DEF\_DOM\_OPS | MSI\_FLAG\_USE\_DEF\_CHIP\_OPS),
^~~~~~~~~~~~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:39: error: 'MSI\_FLAG\_USE\_DEF\_CHIP\_OPS' undeclared here (not in a function); did you mean 'MSI\_FLAG\_USE\_DEF\_DOM\_OPS'?
Selecting the option from this driver seems to solve this nicely, though I could
not find any other instance of this in irqchip drivers.
Signed-off-by: Arnd Bergmann
Acked-by: Thomas Petazzoni
Signed-off-by: Marc Zyngier
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e30ccb5f1c7e00ee189a0991e633b3034801899c
Author: Matthias Kaehlcke
Date: Mon Mar 13 14:30:29 2017 -0700
dmaengine: Fix array index out of bounds warning in \_\_get\_unmap\_pool()
[ Upstream commit 23f963e91fd81f44f6b316b1c24db563354c6be8 ]
This fixes the following warning when building with clang and
CONFIG\_DMA\_ENGINE\_RAID=n :
drivers/dma/dmaengine.c:1102:11: error: array index 2 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[2];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
^
drivers/dma/dmaengine.c:1104:11: error: array index 3 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[3];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Dan Williams
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 46cbe3f51c511b648de0220b14ab4f5832f00020
Author: Johan Hovold
Date: Mon Mar 13 13:42:03 2017 +0100
net: wimax/i2400m: fix NULL-deref at probe
[ Upstream commit 6e526fdff7be4f13b24f929a04c0e9ae6761291e ]
Make sure to check the number of endpoints to avoid dereferencing a
NULL-pointer or accessing memory beyond the endpoint array should a
malicious device lack the expected endpoints.
The endpoints are specifically dereferenced in the i2400m\_bootrom\_init
path during probe (e.g. in i2400mu\_tx\_bulk\_out).
Fixes: f398e4240fce ("i2400m/USB: probe/disconnect, dev init/shutdown
and reset backends")
Cc: Inaky Perez-Gonzalez
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2e70c4d5de8751df5d14a578459a58ef0471e1ef
Author: Tahsin Erdogan
Date: Fri Mar 10 12:09:49 2017 -0800
writeback: fix memory leak in wb\_queue\_work()
[ Upstream commit 4a3a485b1ed0e109718cc8c9d094fa0f552de9b2 ]
When WB\_registered flag is not set, wb\_queue\_work() skips queuing the
work, but does not perform the necessary clean up. In particular, if
work->auto\_free is true, it should free the memory.
The leak condition can be reprouced by following these steps:
mount /dev/sdb /mnt/sdb
/\* In qemu console: device\_del sdb \*/
umount /dev/sdb
Above will result in a wb\_queue\_work() call on an unregistered wb and
thus leak memory.
Reported-by: John Sperbeck
Signed-off-by: Tahsin Erdogan
Reviewed-by: Jan Kara
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d28046fb8c435fc63f51dca30cdeb423d8ab4479
Author: Sagi Grimberg
Date: Mon Mar 13 16:10:11 2017 +0200
blk-mq: Fix tagset reinit in the presence of cpu hot-unplug
[ Upstream commit 0067d4b020ea07a58540acb2c5fcd3364bf326e0 ]
In case cpu was unplugged, we need to make sure not to assume
that the tags for that cpu are still allocated. so check
for null tags when reinitializing a tagset.
Reported-by: Yi Zhang
Signed-off-by: Sagi Grimberg
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 143d13d1e6c0a9ea7e6e86a0279907b174a42b4d
Author: Hiroyuki Yokoyama
Date: Wed Mar 1 03:51:00 2017 +0000
ASoC: rsnd: fix sound route path when using SRC6/SRC9
[ Upstream commit a1c2ff53726907aff5feb37e4cfd45c1ff626431 ]
This patch fixes the problem that the missing value of the route path
setting table and incorrect values are set in the CMD\_ROUTE\_SELECT
register.
Signed-off-by: Hiroyuki Yokoyama
[Kuninori: shared data on MIX and non-MIX case]
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 97b75dad9dd1bc352e199d15516978edb06792fd
Author: Florian Westphal
Date: Thu Mar 9 23:22:30 2017 +0100
netfilter: bridge: honor frag\_max\_size when refragmenting
[ Upstream commit 4ca60d08cbe65f501baad64af50fceba79c19fbb ]
consider a bridge with mtu 9000, but end host sending smaller
packets to another host with mtu < 9000.
In this case, after reassembly, bridge+defrag would refragment,
and then attempt to send the reassembled packet as long as it
was below 9k.
Instead we have to cap by the largest fragment size seen.
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 38780b9ae45a40f0f39f0279c381397fb910b072
Author: Tomi Valkeinen
Date: Tue Feb 28 10:11:45 2017 +0200
drm/omap: fix dmabuf mmap for dma\_alloc'ed buffers
[ Upstream commit 9fa1d7537242bd580ffa99c4725a0407096aad26 ]
omap\_gem\_dmabuf\_mmap() returns an error (with a WARN) when called for a
buffer which is allocated with dma\_alloc\_\*(). This prevents dmabuf mmap
from working on SoCs without DMM, e.g. AM4 and OMAP3.
I could not find any reason for omap\_gem\_dmabuf\_mmap() rejecting such
buffers, and just removing the if() fixes the limitation.
Signed-off-by: Tomi Valkeinen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8fb782bbd21214a211e8e05dd0230ddd9b255e5e
Author: Dmitry Torokhov
Date: Tue Feb 28 17:14:41 2017 -0800
Input: i8042 - add TUXEDO BU1406 (N24\_25BU) to the nomux list
[ Upstream commit a4c2a13129f7c5bcf81704c06851601593303fd5 ]
TUXEDO BU1406 does not implement active multiplexing mode properly,
and takes around 550 ms in i8042\_set\_mux\_mode(). Given that the
device does not have external AUX port, there is no downside in
disabling the MUX mode.
Reported-by: Paul Menzel
Suggested-by: Vojtech Pavlik
Reviewed-by: Marcos Paulo de Souza
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 817f60ccf72cf7d98c4a96d408660bbbcb495489
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_reset\_versions for NFSv4.
[ Upstream commit 800a938f0bf9130c8256116649c0cc5806bfb2fd ]
If you write "-2 -3 -4" to the "versions" file, it will
notice that no versions are enabled, and nfsd\_reset\_versions()
is called.
This enables all major versions, not no minor versions.
So we lose the invariant that NFSv4 is only advertised when
at least one minor is enabled.
Fix the code to explicitly enable minor versions for v4,
change it to use nfsd\_vers() to test and set, and simplify
the code.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0154269f9c122440b841e06c2c16cde10c26bf7b
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_minorversion(.., NFSD\_AVAIL)
[ Upstream commit 928c6fb3a9bfd6c5b287aa3465226add551c13c0 ]
Current code will return 1 if the version is supported,
and -1 if it isn't.
This is confusing and inconsistent with the one place where this
is used.
So change to return 1 if it is supported, and zero if not.
i.e. an error is never returned.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 063c753ef78bee13265bf02df185704e8fdff1f9
Author: Dave Airlie
Date: Fri Mar 10 12:13:04 2017 +1000
drm/amdgpu: fix parser init error path to avoid crash in parser fini
[ Upstream commit 607523d19c9d67ba4cf7bdaced644f11ed04992c ]
If we don't reset the chunk info in the error path, the subsequent
fini path will double free.
Reviewed-by: Christian König
Signed-off-by: Dave Airlie
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d40364d333e3de4cc2e49c80ad8ddb242c46315
Author: Oleksandr Tyshchenko
Date: Mon Feb 27 14:30:26 2017 +0200
iommu/io-pgtable-arm-v7s: Check for leaf entry before dereferencing it
[ Upstream commit a03849e7210277fa212779b7cd9c30e1ab6194b2 ]
Do a check for already installed leaf entry at the current level before
dereferencing it in order to avoid walking the page table down with
wrong pointer to the next level.
Signed-off-by: Oleksandr Tyshchenko
CC: Will Deacon
CC: Robin Murphy
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 721c136ac2780e519cd44940ba47f08cdeafec9d
Author: Daniel Jurgens
Date: Fri Mar 10 14:33:02 2017 +0200
net/mlx5: Don't save PCI state when PCI error is detected
[ Upstream commit 5d47f6c89d568ab61712d8c40676fbb020b68752 ]
When a PCI error is detected the PCI state could be corrupt, don't save
it in that flow. Save the state after initialization. After restoring the
PCI state during slot reset save it again, restoring the state destroys
the previously saved state info.
Fixes: 05ac2c0b7438 ('net/mlx5: Fix race between PCI error handlers and
health work')
Signed-off-by: Daniel Jurgens
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 248cbd97be813adfa675d48e1e702f9d5e7ffca8
Author: Paul Blakey
Date: Fri Mar 10 14:33:01 2017 +0200
net/mlx5: Fix create autogroup prev initializer
[ Upstream commit af36370569eb37420e1e78a2e60c277b781fcd00 ]
The autogroups list is a list of non overlapping group boundaries
sorted by their start index. If the autogroups list wasn't empty
and an empty group slot was found at the start of the list,
the new group was added to the end of the list instead of the
beginning, as the prev initializer was incorrect.
When this was repeated, it caused multiple groups to have
overlapping boundaries.
Fixed that by correctly initializing the prev pointer to the
start of the list.
Fixes: eccec8da3b4e ('net/mlx5: Keep autogroups list ordered')
Signed-off-by: Paul Blakey
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 515d78dc0a89a14c10ce3b3f007c99508aa65e61
Author: David Howells
Date: Fri Mar 10 07:48:49 2017 +0000
rxrpc: Wake up the transmitter if Rx window size increases on the peer
[ Upstream commit 702f2ac87a9a8da23bf8506466bc70175fc970b2 ]
The RxRPC ACK packet may contain an extension that includes the peer's
current Rx window size for this call. We adjust the local Tx window size
to match. However, the transmitter can stall if the receive window is
reduced to 0 by the peer and then reopened.
This is because the normal way that the transmitter is re-energised is by
dropping something out of our Tx queue and thus making space. When a
single gap is made, the transmitter is woken up. However, because there's
nothing in the Tx queue at this point, this doesn't happen.
To fix this, perform a wake\_up() any time we see the peer's Rx window size
increasing.
The observable symptom is that calls start failing on ETIMEDOUT and the
following:
kAFS: SERVER DEAD state=-62
appears in dmesg.
Signed-off-by: David Howells
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e85b9bc29b04bbde927c2c556e0832327bc62279
Author: Doug Berger
Date: Thu Mar 9 16:58:48 2017 -0800
net: bcmgenet: Power up the internal PHY before probing the MII
[ Upstream commit 6be371b053dc86f11465cc1abce2e99bda0a0574 ]
When using the internal PHY it must be powered up when the MII is probed
or the PHY will not be detected. Since the PHY is powered up at reset
this has not been a problem. However, when the kernel is restarted with
kexec the PHY will likely be powered down when the kernel starts so it
will not be detected and the Ethernet link will not be established.
This commit explicitly powers up the internal PHY when the GENET driver
is probed to correct this behavior.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9ac24794f2e688336c64686129df6d2133c9c0b
Author: Doug Berger
Date: Thu Mar 9 16:58:47 2017 -0800
net: bcmgenet: synchronize irq0 status between the isr and task
[ Upstream commit 07c52d6a0b955a8a28834f9354793cfc4b81d0e9 ]
Add a spinlock to ensure that irq0\_stat is not unintentionally altered
as the result of preemption. Also removed unserviced irq0 interrupts
and removed irq1\_stat since there is no bottom half service for those
interrupts.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c3727f6add57b03197b25af01dd1aa26090ed00
Author: Doug Berger
Date: Thu Mar 9 16:58:46 2017 -0800
net: bcmgenet: power down internal phy if open or resume fails
[ Upstream commit 7627409cc4970e8c8b9de6945ad86a575290a94e ]
Since the internal PHY is powered up during the open and resume
functions it should be powered back down if the functions fail.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 66e522ab02cc7ae47cb8f1247e7b74efdc16072e
Author: Doug Berger
Date: Thu Mar 9 16:58:45 2017 -0800
net: bcmgenet: reserved phy revisions must be checked first
[ Upstream commit eca4bad73409aedc6ff22f823c18b67a4f08c851 ]
The reserved gphy\_rev value of 0x01ff must be tested before the old
or new scheme for GPHY major versioning are tested, otherwise it will
be treated as 0xff00 according to the old scheme.
Fixes: b04a2f5b9ff5 ("net: bcmgenet: add support for new GENET PHY revision scheme")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dc8d63c43af042d5740c29f23906788ffbb6eaf4
Author: Doug Berger
Date: Thu Mar 9 16:58:44 2017 -0800
net: bcmgenet: correct MIB access of UniMAC RUNT counters
[ Upstream commit 1ad3d225e5a40ca6c586989b4baaca710544c15a ]
The gap between the Tx status counters and the Rx RUNT counters is now
being added to allow correct reporting of the registers.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bb5c42a5b1d2b484939c1a1d18306853db8fcba9
Author: Doug Berger
Date: Thu Mar 9 16:58:43 2017 -0800
net: bcmgenet: correct the RBUF\_OVFL\_CNT and RBUF\_ERR\_CNT MIB values
[ Upstream commit ffff71328a3c321f7c14cc1edd33577717037744 ]
The location of the RBUF overflow and error counters has moved between
different version of the GENET MAC. This commit corrects the driver to
read from the correct locations depending on the version of the GENET
MAC.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 72cd0c3f66165cce2c91012382a57800f54e3bff
Author: Michael Chan
Date: Wed Mar 8 18:44:35 2017 -0500
bnxt\_en: Ignore 0 value in autoneg supported speed from firmware.
[ Upstream commit 520ad89a54edea84496695d528f73ddcf4a52ea4 ]
In some situations, the firmware will return 0 for autoneg supported
speed. This may happen if the firmware detects no SFP module, for
example. The driver should ignore this so that we don't end up with
an invalid autoneg setting with nothing advertised. When SFP module
is inserted, we'll get the updated settings from firmware at that time.
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ae0ebdba96674c278674d2b12eedde0681e42f91
Author: Alexander Potapenko
Date: Wed Mar 8 18:08:16 2017 +0100
net: initialize msg.msg\_flags in recvfrom
[ Upstream commit 9f138fa609c47403374a862a08a41394be53d461 ]
KMSAN reports a use of uninitialized memory in put\_cmsg() because
msg.msg\_flags in recvfrom haven't been initialized properly.
The flag values don't affect the result on this path, but it's still a
good idea to initialize them explicitly.
Signed-off-by: Alexander Potapenko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6783015096dc66dee0035baeec410f16b6ee2d84
Author: Andrea Arcangeli
Date: Thu Mar 9 16:17:14 2017 -0800
userfaultfd: selftest: vm: allow to build in vm/ directory
[ Upstream commit 46aa6a302b53f543f8e8b8e1714dc5e449ad36a6 ]
linux/tools/testing/selftests/vm $ make
gcc -Wall -I ../../../../usr/include compaction\_test.c -lrt -o /compaction\_test
/usr/lib/gcc/x86\_64-pc-linux-gnu/4.9.4/../../../../x86\_64-pc-linux-gnu/bin/ld: cannot open output file /compaction\_test: Permission denied
collect2: error: ld returned 1 exit status
make: \*\*\* [../lib.mk:54: /compaction\_test] Error 1
Since commit a8ba798bc8ec ("selftests: enable O and KBUILD\_OUTPUT")
selftests/vm build fails if run from the "selftests/vm" directory, but
it works in the selftests/ directory. It's quicker to be able to do a
local vm-only build after a tree wipe and this patch allows for it
again.
Link: http://lkml.kernel.org/r/20170302173738.18994-4-aarcange@redhat.com
Signed-off-by: Andrea Arcangeli
Cc: Mike Rapoport
Cc: "Dr. David Alan Gilbert"
Cc: Mike Kravetz
Cc: Pavel Emelyanov
Cc: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 275314e90c5e84c972be2da278cee60279e07fc7
Author: Andrea Arcangeli
Date: Thu Mar 9 16:16:28 2017 -0800
userfaultfd: shmem: \_\_do\_fault requires VM\_FAULT\_NOPAGE
[ Upstream commit 6bbc4a4144b1a69743022ac68dfaf6e7d993abb9 ]
\_\_do\_fault assumes vmf->page has been initialized and is valid if
VM\_FAULT\_NOPAGE is not returned by vma->vm\_ops->fault(vma, vmf).
handle\_userfault() in turn should return VM\_FAULT\_NOPAGE if it doesn't
return VM\_FAULT\_SIGBUS or VM\_FAULT\_RETRY (the other two possibilities).
This VM\_FAULT\_NOPAGE case is only invoked when signal are pending and it
didn't matter for anonymous memory before. It only started to matter
since shmem was introduced. hugetlbfs also takes a different path and
doesn't exercise \_\_do\_fault.
Link: http://lkml.kernel.org/r/20170228154201.GH5816@redhat.com
Signed-off-by: Andrea Arcangeli
Reported-by: Dmitry Vyukov
Cc: "Kirill A. Shutemov"
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9bcd15bdfb6151e0418fa9321d4dce2b2eb0cb16
Author: Guoqing Jiang
Date: Fri Feb 24 11:15:12 2017 +0800
md-cluster: free md\_cluster\_info if node leave cluster
[ Upstream commit 9c8043f337f14d1743006dfc59c03e80a42e3884 ]
To avoid memory leak, we need to free the cinfo which
is allocated when node join cluster.
Reviewed-by: NeilBrown
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9841d7b08ff6285123663acddd0ec7aa292402b7
Author: Chunfeng Yun
Date: Thu Mar 9 15:39:34 2017 +0200
usb: xhci-mtk: check hcc\_params after adding primary hcd
[ Upstream commit 94a631d91ad341b3b4bdac72d1104d9f090e0ca9 ]
hcc\_params is set in xhci\_gen\_setup() called from usb\_add\_hcd(),
so checks the Maximum Primary Stream Array Size in the hcc\_params
register after adding primary hcd.
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 215df1f35542081485cff549830ff01af98c5279
Author: Radim Krčmář
Date: Tue Mar 7 17:51:49 2017 +0100
KVM: nVMX: do not warn when MSR bitmap address is not backed
[ Upstream commit 05d8d34611139f8435af90ac54b65eb31e82e388 ]
Before trying to do nested\_get\_page() in nested\_vmx\_merge\_msr\_bitmap(),
we have already checked that the MSR bitmap address is valid (4k aligned
and within physical limits). SDM doesn't specify what happens if the
there is no memory mapped at the valid address, but Intel CPUs treat the
situation as if the bitmap was configured to trap all MSRs.
KVM already does that by returning false and a correct handling doesn't
need the guest-trigerrable warning that was reported by syzkaller:
(The warning was originally there to catch some possible bugs in nVMX.)
------------[ cut here ]------------
WARNING: CPU: 0 PID: 7832 at arch/x86/kvm/vmx.c:9709
nested\_vmx\_merge\_msr\_bitmap arch/x86/kvm/vmx.c:9709 [inline]
WARNING: CPU: 0 PID: 7832 at arch/x86/kvm/vmx.c:9709
nested\_get\_vmcs12\_pages+0xfb6/0x15c0 arch/x86/kvm/vmx.c:9640
Kernel panic - not syncing: panic\_on\_warn set ...
CPU: 0 PID: 7832 Comm: syz-executor1 Not tainted 4.10.0+ #229
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:15 [inline]
dump\_stack+0x2ee/0x3ef lib/dump\_stack.c:51
panic+0x1fb/0x412 kernel/panic.c:179
\_\_warn+0x1c4/0x1e0 kernel/panic.c:540
warn\_slowpath\_null+0x2c/0x40 kernel/panic.c:583
nested\_vmx\_merge\_msr\_bitmap arch/x86/kvm/vmx.c:9709 [inline]
nested\_get\_vmcs12\_pages+0xfb6/0x15c0 arch/x86/kvm/vmx.c:9640
enter\_vmx\_non\_root\_mode arch/x86/kvm/vmx.c:10471 [inline]
nested\_vmx\_run+0x6186/0xaab0 arch/x86/kvm/vmx.c:10561
handle\_vmlaunch+0x1a/0x20 arch/x86/kvm/vmx.c:7312
vmx\_handle\_exit+0xfc0/0x3f00 arch/x86/kvm/vmx.c:8526
vcpu\_enter\_guest arch/x86/kvm/x86.c:6982 [inline]
vcpu\_run arch/x86/kvm/x86.c:7044 [inline]
kvm\_arch\_vcpu\_ioctl\_run+0x1418/0x4840 arch/x86/kvm/x86.c:7205
kvm\_vcpu\_ioctl+0x673/0x1120 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:2570
Reported-by: Dmitry Vyukov
Reviewed-by: Jim Mattson
[Jim Mattson explained the bare metal behavior: "I believe this behavior
would be documented in the chipset data sheet rather than the SDM,
since the chipset returns all 1s for an unclaimed read."]
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 50fc2d4152fb03bfbdec186403ce5c49fd0ff77e
Author: Javier Martinez Canillas
Date: Wed Feb 22 15:23:22 2017 -0300
usb: phy: isp1301: Add OF device ID table
[ Upstream commit fd567653bdb908009b650f079bfd4b63169e2ac4 ]
The driver doesn't have a struct of\_device\_id table but supported devices
are registered via Device Trees. This is working on the assumption that a
I2C device registered via OF will always match a legacy I2C device ID and
that the MODALIAS reported will always be of the form i2c:.
But this could change in the future so the correct approach is to have an
OF device ID table if the devices are registered via OF.
Signed-off-by: Javier Martinez Canillas
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bf864220a59c51a676717cbee7f346a400c5ab47
Author: Ilan peer
Date: Mon Dec 26 18:17:36 2016 +0200
mac80211: Fix addition of mesh configuration element
commit 57629915d568c522ac1422df7bba4bee5b5c7a7c upstream.
The code was setting the capabilities byte to zero,
after it was already properly set previously. Fix it.
The bug was found while debugging hwsim mesh tests failures
that happened since the commit mentioned below.
Fixes: 76f43b4c0a93 ("mac80211: Remove invalid flag operations in mesh TSF synchronization")
Signed-off-by: Ilan Peer
Reviewed-by: Masashi Honma
Signed-off-by: Johannes Berg
Cc: Richard Schütz
Cc: Mathias Kretschmer
Signed-off-by: Greg Kroah-Hartman
commit 32e2ae03283b4047f5af9fd1178fe24f38e96601
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f upstream.
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Signed-off-by: Greg Kroah-Hartman
commit 6a851bb99e5c6569e51eb798d6a38b759fdb3302
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
commit c894aa97577e47d3066b27b32499ecf899bfa8b0 upstream.
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 679dbeac0b6bb551e1f3b95673695b22b2ac953d
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
commit 6f6a23a213be51728502b88741ba6a10cda2441d upstream.
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 744cb5ab337218e7a258d2a82c6f5d7afc72cd16
Author: David Lechner
Date: Sun Dec 3 19:54:41 2017 -0600
eeprom: at24: change nvmem stride to 1
commit 7f6d2ecd3d7acaf205ea7b3e96f9ffc55b92298b upstream.
Trying to read the MAC address from an eeprom that has an offset that
is not a multiple of 4 causes an error currently.
Fix it by changing the nvmem stride to 1.
Signed-off-by: David Lechner
[Bartosz: tweaked the commit message]
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit d266817f5028fef8ff521a77777ef1c4b8de890e
Author: Steven Rostedt
Date: Sat Dec 2 13:04:54 2017 -0500
sched/rt: Do not pull from current CPU if only one CPU to pull
commit f73c52a5bcd1710994e53fbccc378c42b97a06b6 upstream.
Daniel Wagner reported a crash on the BeagleBone Black SoC.
This is a single CPU architecture, and does not have a functional
arch\_send\_call\_function\_single\_ipi() implementation which can crash
the kernel if that is called.
As it only has one CPU, it shouldn't be called, but if the kernel is
compiled for SMP, the push/pull RT scheduling logic now calls it for
irq\_work if the one CPU is overloaded, it can use that function to call
itself and crash the kernel.
Ideally, we should disable the SCHED\_FEAT(RT\_PUSH\_IPI) if the system
only has a single CPU. But SCHED\_FEAT is a constant if sched debugging
is turned off. Another fix can also be used, and this should also help
with normal SMP machines. That is, do not initiate the pull code if
there's only one RT overloaded CPU, and that CPU happens to be the
current CPU that is scheduling in a lower priority task.
Even on a system with many CPUs, if there's many RT tasks waiting to
run on a single CPU, and that CPU schedules in another RT task of lower
priority, it will initiate the PULL logic in case there's a higher
priority RT task on another CPU that is waiting to run. But if there is
no other CPU with waiting RT tasks, it will initiate the RT pull logic
on itself (as it still has RT tasks waiting to run). This is a wasted
effort.
Not only does this help with SMP code where the current CPU is the only
one with RT overloaded tasks, it should also solve the issue that
Daniel encountered, because it will prevent the PULL logic from
executing, as there's only one CPU on the system, and the check added
here will cause it to exit the RT pull code.
Reported-by: Daniel Wagner
Signed-off-by: Steven Rostedt (VMware)
Acked-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: linux-rt-users
Fixes: 4bdced5c9 ("sched/rt: Simplify the IPI based RT balancing logic")
Link: http://lkml.kernel.org/r/20171202130454.4cbbfe8d@vmware.local.home
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 9c537f06d61ada88ccc8080be79213ffce1ebf15
Author: Scott Mayhew
Date: Fri Dec 8 16:00:12 2017 -0500
nfs: don't wait on commit in nfs\_commit\_inode() if there were no commit requests
commit dc4fd9ab01ab379ae5af522b3efd4187a7c30a31 upstream.
If there were no commit requests, then nfs\_commit\_inode() should not
wait on the commit or mark the inode dirty, otherwise the following
BUG\_ON can be triggered:
[ 1917.130762] kernel BUG at fs/inode.c:578!
[ 1917.130766] Oops: Exception in kernel mode, sig: 5 [#1]
[ 1917.130768] SMP NR\_CPUS=2048 NUMA pSeries
[ 1917.130772] Modules linked in: iscsi\_tcp libiscsi\_tcp libiscsi scsi\_transport\_iscsi blocklayoutdriver rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache sunrpc sg nx\_crypto pseries\_rng ip\_tables xfs libcrc32c sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_common ibmvscsi scsi\_transport\_srp ibmveth scsi\_tgt dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 1917.130805] CPU: 2 PID: 14923 Comm: umount.nfs4 Tainted: G ------------ T 3.10.0-768.el7.ppc64 #1
[ 1917.130810] task: c0000005ecd88040 ti: c00000004cea0000 task.ti: c00000004cea0000
[ 1917.130813] NIP: c000000000354178 LR: c000000000354160 CTR: c00000000012db80
[ 1917.130816] REGS: c00000004cea3720 TRAP: 0700 Tainted: G ------------ T (3.10.0-768.el7.ppc64)
[ 1917.130820] MSR: 8000000100029032  CR: 22002822 XER: 20000000
[ 1917.130828] CFAR: c00000000011f594 SOFTE: 1
GPR00: c000000000354160 c00000004cea39a0 c0000000014c4700 c0000000018cc750
GPR04: 000000000000c750 80c0000000000000 0600000000000000 04eeb76bea749a03
GPR08: 0000000000000034 c0000000018cc758 0000000000000001 d000000005e619e8
GPR12: c00000000012db80 c000000007b31200 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR24: 0000000000000000 c000000000dfc3ec 0000000000000000 c0000005eefc02c0
GPR28: d0000000079dbd50 c0000005b94a02c0 c0000005b94a0250 c0000005b94a01c8
[ 1917.130867] NIP [c000000000354178] .evict+0x1c8/0x350
[ 1917.130871] LR [c000000000354160] .evict+0x1b0/0x350
[ 1917.130873] Call Trace:
[ 1917.130876] [c00000004cea39a0] [c000000000354160] .evict+0x1b0/0x350 (unreliable)
[ 1917.130880] [c00000004cea3a30] [c0000000003558cc] .evict\_inodes+0x13c/0x270
[ 1917.130884] [c00000004cea3af0] [c000000000327d20] .kill\_anon\_super+0x70/0x1e0
[ 1917.130896] [c00000004cea3b80] [d000000005e43e30] .nfs\_kill\_super+0x20/0x60 [nfs]
[ 1917.130900] [c00000004cea3c00] [c000000000328a20] .deactivate\_locked\_super+0xa0/0x1b0
[ 1917.130903] [c00000004cea3c80] [c00000000035ba54] .cleanup\_mnt+0xd4/0x180
[ 1917.130907] [c00000004cea3d10] [c000000000119034] .task\_work\_run+0x114/0x150
[ 1917.130912] [c00000004cea3db0] [c00000000001ba6c] .do\_notify\_resume+0xcc/0x100
[ 1917.130916] [c00000004cea3e30] [c00000000000a7b0] .ret\_from\_except\_lite+0x5c/0x60
[ 1917.130919] Instruction dump:
[ 1917.130921] 7fc3f378 486734b5 60000000 387f00a0 38800003 4bdcb365 60000000 e95f00a0
[ 1917.130927] 694a0060 7d4a0074 794ad182 694a0001 <0b0a0000> 892d02a4 2f890000 40de0134
Signed-off-by: Scott Mayhew
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 3bdb508d686e4943bfb761d78dc915dd825f811f
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 upstream.
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 7336f5481f6cf913a2d29d98c6e11f4bbe19d3b2
Author: Sukumar Ghorai
Date: Wed Aug 16 14:46:55 2017 -0700
Bluetooth: btusb: driver to enable the usb-wakeup feature
commit a0085f2510e8976614ad8f766b209448b385492f upstream.
BT-Controller connected as platform non-root-hub device and
usb-driver initialize such device with wakeup disabled,
Ref. usb\_new\_device().
At present wakeup-capability get enabled by hid-input device from usb
function driver(e.g. BT HID device) at runtime. Again some functional
driver does not set usb-wakeup capability(e.g LE HID device implement
as HID-over-GATT), and can't wakeup the host on USB.
Most of the device operation (such as mass storage) initiated from host
(except HID) and USB wakeup aligned with host resume procedure. For BT
device, usb-wakeup capability need to enable form btusc driver as a
generic solution for multiple profile use case and required for USB remote
wakeup (in-bus wakeup) while host is suspended. Also usb-wakeup feature
need to enable/disable with HCI interface up and down.
Signed-off-by: Sukumar Ghorai
Signed-off-by: Amit K Bag
Acked-by: Oliver Neukum
Signed-off-by: Marcel Holtmann
Cc: Matthias Kaehlcke
Signed-off-by: Greg Kroah-Hartman
commit cdfe4c0091a8fa5e0a25d82fa0d4684382ac880d
Author: Chunfeng Yun
Date: Fri Dec 8 18:10:06 2017 +0200
usb: xhci: fix TDS for MTK xHCI1.1
commit 72b663a99c074a8d073e7ecdae446cfb024ef551 upstream.
For MTK's xHCI 1.0 or latter, TD size is the number of max
packet sized packets remaining in the TD, not including
this TRB (following spec).
For MTK's xHCI 0.96 and older, TD size is the number of max
packet sized packets remaining in the TD, including this TRB
(not following spec).
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit e081bd0d70bddbf912f6f7f0f82e3e1ac2c52ae6
Author: Yan, Zheng
Date: Thu Nov 30 11:59:22 2017 +0800
ceph: drop negative child dentries before try pruning inode's alias
commit 040d786032bf59002d374b86d75b04d97624005c upstream.
Negative child dentry holds reference on inode's alias, it makes
d\_prune\_aliases() do nothing.
Signed-off-by: "Yan, Zheng"
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 14513e49c43cd3149a03ff9e1c223c3d5803ad09
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a upstream.
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit f3e957266ae56c200fb13a42309c50f84576c64a
Author: Shuah Khan
Date: Thu Dec 7 14:16:48 2017 -0700
usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input
commit c6688ef9f29762e65bce325ef4acd6c675806366 upstream.
Harden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit b6dbace92ed744a80af75036e93615324cd27aec
Author: Felipe Balbi
Date: Mon Sep 26 10:51:18 2016 +0300
usb: add helper to extract bits 12:11 of wMaxPacketSize
commit 541b6fe63023f3059cf85d47ff2767a3e42a8e44 upstream.
According to USB Specification 2.0 table 9-4,
wMaxPacketSize is a bitfield. Endpoint's maxpacket
is laid out in bits 10:0. For high-speed,
high-bandwidth isochronous endpoints, bits 12:11
contain a multiplier to tell us how many
transactions we want to try per uframe.
This means that if we want an isochronous endpoint
to issue 3 transfers of 1024 bytes per uframe,
wMaxPacketSize should contain the value:
1024 | (2 << 11)
or 5120 (0x1400). In order to make Host and
Peripheral controller drivers' life easier, we're
adding a helper which returns bits 12:11. Note that
no care is made WRT to checking endpoint type and
gadget's speed. That's left for drivers to handle.
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 20e825cdf7a1627f92371d45a5322ccecdebcb3b
Author: Shuah Khan
Date: Thu Dec 7 14:16:47 2017 -0700
usbip: fix stub\_rx: get\_pipe() to validate endpoint number
commit 635f545a7e8be7596b9b2b6a43cab6bbd5a88e43 upstream.
get\_pipe() routine doesn't validate the input endpoint number
and uses to reference ep\_in and ep\_out arrays. Invalid endpoint
number can trigger BUG(). Range check the epnum and returning
error instead of calling BUG().
Change caller stub\_recv\_cmd\_submit() to handle the get\_pipe()
error return.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 99542e468b76ae180675566692e0528c4c712661
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 upstream.
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
Signed-off-by: Greg Kroah-Hartman
commit 0d29ae4f5033453ea86d60a736bed58fa4c15007
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
commit 62354454625741f0569c2cbe45b2d192f8fd258e upstream.
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit d760f903419509d933b27d387854eb1e35f88cdf
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
commit 90e406f96f630c07d631a021fd4af10aac913e77 upstream.
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit d1175423ce67bd1903c4f876ba6774e3a48abdc1
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb upstream.
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c32e053a11f231376f0899ef906fd43f8fc8dbd0
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
commit ecaaab5649781c5a0effdaf298a925063020500e upstream.
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 43259d07fceb8cc1f5ba7e8003ae19023e0620f5
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 upstream.
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit cd9b59861f9cad2f1b36eace975060cfc3bc46e4
Author: Eric Biggers
Date: Sun Nov 26 23:16:49 2017 -0800
crypto: rsa - fix buffer overread when stripping leading zeroes
commit d2890c3778b164fde587bc16583f3a1c87233ec5 upstream.
In rsa\_get\_n(), if the buffer contained all 0's and "FIPS mode" is
enabled, we would read one byte past the end of the buffer while
scanning the leading zeroes. Fix it by checking 'n\_sz' before '!\*ptr'.
This bug was reachable by adding a specially crafted key of type
"asymmetric" (requires CONFIG\_RSA and CONFIG\_X509\_CERTIFICATE\_PARSER).
KASAN report:
BUG: KASAN: slab-out-of-bounds in rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
Read of size 1 at addr ffff88003501a708 by task keyctl/196
CPU: 1 PID: 196 Comm: keyctl Not tainted 4.14.0-09238-g1d3b78bbc6e9 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110\_100015-anatol 04/01/2014
Call Trace:
rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
asn1\_ber\_decoder+0x82a/0x1fd0 lib/asn1\_decoder.c:328
rsa\_set\_pub\_key+0xd3/0x320 crypto/rsa.c:278
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
pkcs1pad\_set\_pub\_key+0xae/0x200 crypto/rsa-pkcs1pad.c:117
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
public\_key\_verify\_signature+0x270/0x9d0 crypto/asymmetric\_keys/public\_key.c:106
x509\_check\_for\_self\_signed+0x2ea/0x480 crypto/asymmetric\_keys/x509\_public\_key.c:141
x509\_cert\_parse+0x46a/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:129
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Allocated by task 196:
\_\_do\_kmalloc mm/slab.c:3711 [inline]
\_\_kmalloc\_track\_caller+0x118/0x2e0 mm/slab.c:3726
kmemdup+0x17/0x40 mm/util.c:118
kmemdup ./include/linux/string.h:414 [inline]
x509\_cert\_parse+0x2cb/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:106
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 5a7de97309f5 ("crypto: rsa - return raw integers for the ASN.1 parser")
Cc: Tudor Ambarus
Signed-off-by: Eric Biggers
Reviewed-by: James Morris
Reviewed-by: David Howells
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 1fb73eae9624e2d3583581cd80bf408cc9b3916d
Author: Martin Kaiser
Date: Tue Oct 17 22:53:08 2017 +0200
mfd: fsl-imx25: Clean up irq settings during removal
commit 18f77393796848e68909e65d692c1d1436f06e06 upstream.
When fsl-imx25-tsadc is compiled as a module, loading, unloading and
reloading the module will lead to a crash.
Unable to handle kernel paging request at virtual address bf005430
[] (irq\_find\_matching\_fwspec)
from [] (of\_irq\_get+0x58/0x74)
[] (of\_irq\_get)
from [] (platform\_get\_irq+0x48/0xc8)
[] (platform\_get\_irq)
from [] (mx25\_tsadc\_probe+0x220/0x2f4 [fsl\_imx25\_tsadc])
irq\_find\_matching\_fwspec() loops over all registered irq domains. The
irq domain is still registered from last time the module was loaded but
the pointer to its operations is invalid after the module was unloaded.
Add a removal function which clears the irq handler and removes the irq
domain. With this cleanup in place, it's possible to unload and reload
the module.
Signed-off-by: Martin Kaiser
Reviewed-by: Lucas Stach
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman


=== Content from www.debian.org_336c76e4_20250125_123737.html ===


---

[[Date Prev](msg00114.html)][[Date Next](msg00116.html)]
[[Thread Prev](msg00114.html)][[Thread Next](msg00116.html)]
[[Date Index](maillist.html#00115)]
[[Thread Index](threads.html#00115)]

# [SECURITY] [DSA 4187-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4187-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Tue, 01 May 2018 17:12:02 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1fDYos-0003QT-4F%40seger.debian.org) [E1fDYos-0003QT-4F@seger.debian.org](msg00115.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4187-1                   security@debian.org
<https://www.debian.org/security/>                            Ben Hutchings
May 01, 2018                          <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2015-9016 CVE-2017-0861 CVE-2017-5715 CVE-2017-5753
                 CVE-2017-13166 CVE-2017-13220 CVE-2017-16526 CVE-2017-16911
                 CVE-2017-16912 CVE-2017-16913 CVE-2017-16914 CVE-2017-18017
                 CVE-2017-18203 CVE-2017-18216 CVE-2017-18232 CVE-2017-18241
                 CVE-2018-1066 CVE-2018-1068 CVE-2018-1092 CVE-2018-5332
                 CVE-2018-5333 CVE-2018-5750 CVE-2018-5803 CVE-2018-6927
                 CVE-2018-7492 CVE-2018-7566 CVE-2018-7740 CVE-2018-7757
                 CVE-2018-7995 CVE-2018-8781 CVE-2018-8822 CVE-2018-1000004
                 CVE-2018-1000199

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2015-9016

    Ming Lei reported a race condition in the multiqueue block layer
    (blk-mq).  On a system with a driver using blk-mq (mtip32xx,
    null_blk, or virtio_blk), a local user might be able to use this
    for denial of service or possibly for privilege escalation.

CVE-2017-0861

    Robb Glasser reported a potential use-after-free in the ALSA (sound)
    PCM core.  We believe this was not possible in practice.

CVE-2017-5715

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 2 (branch
    target injection) and is mitigated for the x86 architecture (amd64
    and i386) by using the "retpoline" compiler feature which allows
    indirect branches to be isolated from speculative execution.

CVE-2017-5753

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 1
    (bounds-check bypass) and is mitigated by identifying vulnerable
    code sections (array bounds checking followed by array access) and
    replacing the array access with the speculation-safe
    array_index_nospec() function.

    More use sites will be added over time.

CVE-2017-13166

    A bug in the 32-bit compatibility layer of the v4l2 ioctl handling
    code has been found. Memory protections ensuring user-provided
    buffers always point to userland memory were disabled, allowing
    destination addresses to be in kernel space. On a 64-bit kernel a
    local user with access to a suitable video device can exploit this
    to overwrite kernel memory, leading to privilege escalation.

CVE-2017-13220

    Al Viro reported that the Bluetooth HIDP implementation could
    dereference a pointer before performing the necessary type check.
    A local user could use this to cause a denial of service.

CVE-2017-16526

    Andrey Konovalov reported that the UWB subsystem may dereference
    an invalid pointer in an error case.  A local user might be able
    to use this for denial of service.

CVE-2017-16911

    Secunia Research reported that the USB/IP vhci_hcd driver exposed
    kernel heap addresses to local users.  This information could aid the
    exploitation of other vulnerabilities.

CVE-2017-16912

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to an out-of-bounds read.  A remote user able to connect to the
    USB/IP server could use this for denial of service.

CVE-2017-16913

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to excessive memory allocation.  A remote user able to connect to
    the USB/IP server could use this for denial of service.

CVE-2017-16914

    Secunia Research reported that the USB/IP stub driver failed to
    check for an invalid combination of fields in a received packet,
    leading to a null pointer dereference.  A remote user able to
    connect to the USB/IP server could use this for denial of service.

CVE-2017-18017

    Denys Fedoryshchenko reported that the netfilter xt_TCPMSS module
    failed to validate TCP header lengths, potentially leading to a
    use-after-free.  If this module is loaded, it could be used by a
    remote attacker for denial of service or possibly for code
    execution.

CVE-2017-18203

    Hou Tao reported that there was a race condition in creation and
    deletion of device-mapper (DM) devices.  A local user could
    potentially use this for denial of service.

CVE-2017-18216

    Alex Chen reported that the OCFS2 filesystem failed to hold a
    necessary lock during nodemanager sysfs file operations,
    potentially leading to a null pointer dereference.  A local user
    could use this for denial of service.

CVE-2017-18232

    Jason Yan reported a race condition in the SAS (Serial-Attached
    SCSI) subsystem, between probing and destroying a port.  This
    could lead to a deadlock.  A physically present attacker could
    use this to cause a denial of service.

CVE-2017-18241

    Yunlei He reported that the f2fs implementation does not properly
    initialise its state if the "noflush_merge" mount option is used.
    A local user with access to a filesystem mounted with this option
    could use this to cause a denial of service.

CVE-2018-1066

    Dan Aloni reported to Red Hat that the CIFS client implementation
    would dereference a null pointer if the server sent an invalid
    response during NTLMSSP setup negotiation.  This could be used
    by a malicious server for denial of service.

CVE-2018-1068

    The syzkaller tool found that the 32-bit compatibility layer of
    ebtables did not sufficiently validate offset values. On a 64-bit
    kernel, a local user with the CAP_NET_ADMIN capability (in any user
    namespace) could use this to overwrite kernel memory, possibly
    leading to privilege escalation. Debian disables unprivileged user
    namespaces by default.

CVE-2018-1092

    Wen Xu reported that a crafted ext4 filesystem image would
    trigger a null dereference when mounted.  A local user able
    to mount arbitrary filesystems could use this for denial of
    service.

CVE-2018-5332

    Mohamed Ghannam reported that the RDS protocol did not
    sufficiently validate RDMA requests, leading to an out-of-bounds
    write.  A local attacker on a system with the rds module loaded
    could use this for denial of service or possibly for privilege
    escalation.

CVE-2018-5333

    Mohamed Ghannam reported that the RDS protocol did not properly
    handle an error case, leading to a null pointer dereference.  A
    local attacker on a system with the rds module loaded could
    possibly use this for denial of service.

CVE-2018-5750

    Wang Qize reported that the ACPI sbshc driver logged a kernel heap
    address.  This information could aid the exploitation of other
    vulnerabilities.

CVE-2018-5803

    Alexey Kodanev reported that the SCTP protocol did not range-check
    the length of chunks to be created.  A local or remote user could
    use this to cause a denial of service.

CVE-2018-6927

    Li Jinyue reported that the FUTEX_REQUEUE operation on futexes did
    not check for negative parameter values, which might lead to a
    denial of service or other security impact.

CVE-2018-7492

    The syzkaller tool found that the RDS protocol was lacking a null
    pointer check.  A local attacker on a system with the rds module
    loaded could use this for denial of service.

CVE-2018-7566

    Fan LongFei reported a race condition in the ALSA (sound)
    sequencer core, between write and ioctl operations.  This could
    lead to an out-of-bounds access or use-after-free.  A local user
    with access to a sequencer device could use this for denial of
    service or possibly for privilege escalation.

CVE-2018-7740

    Nic Losby reported that the hugetlbfs filesystem's mmap operation
    did not properly range-check the file offset.  A local user with
    access to files on a hugetlbfs filesystem could use this to cause
    a denial of service.

CVE-2018-7757

    Jason Yan reported a memory leak in the SAS (Serial-Attached
    SCSI) subsystem.  A local user on a system with SAS devices
    could use this to cause a denial of service.

CVE-2018-7995

    Seunghun Han reported a race condition in the x86 MCE
    (Machine Check Exception) driver.  This is unlikely to have
    any security impact.

CVE-2018-8781

    Eyal Itkin reported that the udl (DisplayLink) driver's mmap
    operation did not properly range-check the file offset.  A local
    user with access to a udl framebuffer device could exploit this to
    overwrite kernel memory, leading to privilege escalation.

CVE-2018-8822

    Dr Silvio Cesare of InfoSect reported that the ncpfs client
    implementation did not validate reply lengths from the server.  An
    ncpfs server could use this to cause a denial of service or
    remote code execution in the client.

CVE-2018-1000004

    Luo Quan reported a race condition in the ALSA (sound) sequencer
    core, between multiple ioctl operations.  This could lead to a
    deadlock or use-after-free.  A local user with access to a
    sequencer device could use this for denial of service or possibly
    for privilege escalation.

CVE-2018-1000199

    Andy Lutomirski discovered that the ptrace subsystem did not
    sufficiently validate hardware breakpoint settings.  Local users
    can use this to cause a denial of service, or possibly for
    privilege escalation, on x86 (amd64 and i386) and possibly other
    architectures.

For the oldstable distribution (jessie), these problems have been fixed
in version 3.16.56-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to its security
tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAlron61fFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0Rtqw//Xf/L4bP65wU9M59Ef6xBt+Eph+yxeMsioGhu80ODdMemlmHzASMtfZjY
AXxyt9l8lbHn8MmwDA4aLhhwHYXwvKATdpHSy1SILrRfb4s9P9uV1vsHaIeZ649E
hDyNon9hP2tPso6BwqiYHZZy9Xxtd+T8vTBeBZwUKOLBkBRvV/gyNSUdJWp6L8WH
aF4D1hHl9ZotDkyIvkubbx77aqbJ88I4R0n69x7L9udFbuXa+U7hV6dJdnpzyl/7
OukJfEtnkaUgWu0MdOfFss6iH5OQISn/y/ricRi29oKQiEp3YwnT5J9pFwSQeJJS
H8ABVt251UoS0J+of3QWw0muOT/6UAF8SNpPKMJXC7Euq8pTmYVPSIeUYf4eqn65
UHZSCKXaszItq+uzVNYdkj504BJ4cG1lFxZtlrFWwKE8p7QOETN0GKvTRdu/SvDd
Hl2nb4HouLpBYS518Th2/MGgzhXXAuO12MH3smenptZbqxKn9Z0XSTJYzFupgJk/
kKF2xkDFBE4toTLVE+6XdUKwYk4vkeDZyOGOwRYThSkKAzrUh5zThgal4HnknD2A
5ye4XLhjgSIT47/nmor6lhxd7WGXGkV33GF0azYlHr/sclfzxcU2Ev3NUBWQ8M3s
CxfIO0FNCzO0WIUf40md7MlIAnDBIRGyYgNIIe7AnSRKKPykEx8=
=wNQS
-----END PGP SIGNATURE-----

```

---


