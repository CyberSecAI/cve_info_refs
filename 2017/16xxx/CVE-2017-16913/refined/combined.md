=== Content from usn.ubuntu.com_37a1a987_20250125_181650.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3754-1: Linux kernel vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel

## Details

Ralf Spenneberg discovered that the ext4 implementation in the Linux kernel

did not properly validate meta block groups. An attacker with physical

access could use this to specially craft an ext4 image that causes a denial

of service (system crash). ([CVE-2016-10208](/security/CVE-2016-10208))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a buffer overflow existed in the ACPI table parsing

implementation in the Linux kernel. A local attacker could use this to

construct a malicious ACPI table that, when loaded, caused a denial of

service (system crash) or possibly execute arbitrary code.

([CVE-2017-11473](/security/CVE-2017-11473))

It was discovered that the generic SCSI driver in the Linux kernel did not

properly initialize data returned to user space in some situations. A local

attacker could use this to expose sensitive information (kernel memory).

([CVE-2017-14991](/security/CVE-2017-14991))

It was discovered that a race condition existed in the packet fanout

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-15649](/security/CVE-2017-15649))

Andrey Konovalov discovered that the Ultra Wide Band driver in the Linux

kernel did not properly check for an error condition. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16526](/security/CVE-2017-16526))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel

contained a use-after-free vulnerability. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16527](/security/CVE-2017-16527))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel did

not properly validate USB audio buffer descriptors. A physically proximate

attacker could use this cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2017-16529](/security/CVE-2017-16529))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB interface association descriptors. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16531](/security/CVE-2017-16531))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB HID descriptors. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16533](/security/CVE-2017-16533))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB BOS metadata. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16535](/security/CVE-2017-16535))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

It was discovered that the DM04/QQBOX USB driver in the Linux kernel did

not properly handle device attachment and warm-start. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16538](/security/CVE-2017-16538))

Andrey Konovalov discovered an out-of-bounds read in the GTCO digitizer USB

driver for the Linux kernel. A physically proximate attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16643](/security/CVE-2017-16643))

Andrey Konovalov discovered that the video4linux driver for Hauppauge HD

PVR USB devices in the Linux kernel did not properly handle some error

conditions. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16644](/security/CVE-2017-16644))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure

vulnerability. A physically proximate attacker could use this to expose

sensitive information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

It was discovered that an integer overflow existed in the perf subsystem of

the Linux kernel. A local attacker could use this to cause a denial of

service (system crash). ([CVE-2017-18255](/security/CVE-2017-18255))

It was discovered that the keyring subsystem in the Linux kernel did not

properly prevent a user from creating keyrings for other users. A local

attacker could use this cause a denial of service or expose sensitive

information. ([CVE-2017-18270](/security/CVE-2017-18270))

Andy Lutomirski and Willy Tarreau discovered that the KVM implementation in

the Linux kernel did not properly emulate instructions on the SS segment

register. A local attacker in a guest virtual machine could use this to

cause a denial of service (guest OS crash) or possibly gain administrative

privileges in the guest OS. ([CVE-2017-2583](/security/CVE-2017-2583))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

improperly emulated certain instructions. A local attacker could use this

to obtain sensitive information (kernel memory). ([CVE-2017-2584](/security/CVE-2017-2584))

It was discovered that the KLSI KL5KUSB105 serial-to-USB device driver in

the Linux kernel did not properly initialize memory related to logging. A

local attacker could use this to expose sensitive information (kernel

memory). ([CVE-2017-5549](/security/CVE-2017-5549))

Andrey Konovalov discovered an out-of-bounds access in the IPv6 Generic

Routing Encapsulation (GRE) tunneling implementation in the Linux kernel.

An attacker could use this to possibly expose sensitive information.

([CVE-2017-5897](/security/CVE-2017-5897))

Andrey Konovalov discovered that the LLC subsytem in the Linux kernel did

not properly set up a destructor in certain situations. A local attacker

could use this to cause a denial of service (system crash). ([CVE-2017-6345](/security/CVE-2017-6345))

Dmitry Vyukov discovered race conditions in the Infrared (IrDA) subsystem

in the Linux kernel. A local attacker could use this to cause a denial of

service (deadlock). ([CVE-2017-6348](/security/CVE-2017-6348))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

Tuomas Haanpää and Ari Kauppi discovered that the NFSv2 and NFSv3 server

implementations in the Linux kernel did not properly handle certain long

RPC replies. A remote attacker could use this to cause a denial of service

(system crash). ([CVE-2017-7645](/security/CVE-2017-7645))

Pengfei Wang discovered that a race condition existed in the NXP SAA7164 TV

Decoder driver for the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-8831](/security/CVE-2017-8831))

Pengfei Wang discovered that the Turtle Beach MultiSound audio device

driver in the Linux kernel contained race conditions when fetching from the

ring-buffer. A local attacker could use this to cause a denial of service

(infinite loop). ([CVE-2017-9984](/security/CVE-2017-9984), [CVE-2017-9985](/security/CVE-2017-9985))

It was discovered that the wait4() system call in the Linux kernel did not

properly validate its arguments in some situations. A local attacker could

possibly use this to cause a denial of service. ([CVE-2018-10087](/security/CVE-2018-10087))

It was discovered that the kill() system call implementation in the Linux

kernel did not properly validate its arguments in some situations. A local

attacker could possibly use this to cause a denial of service.

([CVE-2018-10124](/security/CVE-2018-10124))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Zhong Jiang discovered that a use-after-free vulnerability existed in the

NUMA memory policy implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2018-10675](/security/CVE-2018-10675))

Wen Xu discovered that a buffer overflow existed in the ext4 filesystem

implementation in the Linux kernel. An attacker could use this to construct

a malicious ext4 image that, when mounted, could cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2018-10877](/security/CVE-2018-10877))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused

a denial of service (system crash) when mounted. ([CVE-2018-1092](/security/CVE-2018-1092))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

It was discovered that the cdrom driver in the Linux kernel contained an

incorrect bounds check. A local attacker could use this to expose sensitive

information (kernel memory). ([CVE-2018-10940](/security/CVE-2018-10940))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Daniel Jiang discovered that a race condition existed in the ipv4 ping

socket implementation in the Linux kernel. A local privileged attacker

could use this to cause a denial of service (system crash). ([CVE-2017-2671](/security/CVE-2017-2671))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

It was discovered that a memory leak existed in the Serial Attached SCSI

(SAS) implementation in the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (memory exhaustion).

([CVE-2018-10021](/security/CVE-2018-10021))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-3.13.0-157-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2016-10208](/security/CVE-2016-10208)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-11473](/security/CVE-2017-11473)
* [CVE-2017-14991](/security/CVE-2017-14991)
* [CVE-2017-15649](/security/CVE-2017-15649)
* [CVE-2017-16526](/security/CVE-2017-16526)
* [CVE-2017-16527](/security/CVE-2017-16527)
* [CVE-2017-16529](/security/CVE-2017-16529)
* [CVE-2017-16531](/security/CVE-2017-16531)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16533](/security/CVE-2017-16533)
* [CVE-2017-16535](/security/CVE-2017-16535)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16538](/security/CVE-2017-16538)
* [CVE-2017-16643](/security/CVE-2017-16643)
* [CVE-2017-16644](/security/CVE-2017-16644)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-18255](/security/CVE-2017-18255)
* [CVE-2017-18270](/security/CVE-2017-18270)
* [CVE-2017-2583](/security/CVE-2017-2583)
* [CVE-2017-2584](/security/CVE-2017-2584)
* [CVE-2017-2671](/security/CVE-2017-2671)
* [CVE-2017-5549](/security/CVE-2017-5549)
* [CVE-2017-5897](/security/CVE-2017-5897)
* [CVE-2017-6345](/security/CVE-2017-6345)
* [CVE-2017-6348](/security/CVE-2017-6348)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2017-7645](/security/CVE-2017-7645)
* [CVE-2017-8831](/security/CVE-2017-8831)
* [CVE-2017-9984](/security/CVE-2017-9984)
* [CVE-2017-9985](/security/CVE-2017-9985)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10021](/security/CVE-2018-10021)
* [CVE-2018-10087](/security/CVE-2018-10087)
* [CVE-2018-10124](/security/CVE-2018-10124)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10675](/security/CVE-2018-10675)
* [CVE-2018-10877](/security/CVE-2018-10877)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1092](/security/CVE-2018-1092)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-10940](/security/CVE-2018-10940)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)

## Related notices

* [USN-3361-1](/security/notices/USN-3361-1)
* [USN-3234-2](/security/notices/USN-3234-2)
* [USN-3234-1](/security/notices/USN-3234-1)
* [USN-3619-2](/security/notices/USN-3619-2)
* [USN-3619-1](/security/notices/USN-3619-1)
* [USN-3469-1](/security/notices/USN-3469-1)
* [USN-3469-2](/security/notices/USN-3469-2)
* [USN-3487-1](/security/notices/USN-3487-1)
* [USN-3485-1](/security/notices/USN-3485-1)
* [USN-3485-3](/security/notices/USN-3485-3)
* [USN-3485-2](/security/notices/USN-3485-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3507-1](/security/notices/USN-3507-1)
* [USN-3631-2](/security/notices/USN-3631-2)
* [USN-3631-1](/security/notices/USN-3631-1)
* [USN-3509-1](/security/notices/USN-3509-1)
* [USN-3509-2](/security/notices/USN-3509-2)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3208-1](/security/notices/USN-3208-1)
* [USN-3208-2](/security/notices/USN-3208-2)
* [USN-3314-1](/security/notices/USN-3314-1)
* [USN-3312-2](/security/notices/USN-3312-2)
* [USN-3312-1](/security/notices/USN-3312-1)
* [USN-3265-1](/security/notices/USN-3265-1)
* [USN-3265-2](/security/notices/USN-3265-2)
* [USN-3420-1](/security/notices/USN-3420-1)
* [USN-3420-2](/security/notices/USN-3420-2)
* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)
* [USN-3678-4](/security/notices/USN-3678-4)
* [USN-3678-3](/security/notices/USN-3678-3)
* [USN-3678-1](/security/notices/USN-3678-1)
* [USN-3678-2](/security/notices/USN-3678-2)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3871-4](/security/notices/USN-3871-4)
* [USN-3871-1](/security/notices/USN-3871-1)
* [USN-3871-5](/security/notices/USN-3871-5)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3871-3](/security/notices/USN-3871-3)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3695-2](/security/notices/USN-3695-2)
* [USN-3695-1](/security/notices/USN-3695-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from www.spinics.net_3c954c19_20250125_181652.html ===


# [PATCH 0/4] USB over IP Secuurity fixes

[[Date Prev](msg163479.html)][[Date Next](msg163481.html)][[Thread Prev](msg163469.html)][[Thread Next](msg163477.html)][[Date Index](mail10.html#163480)][[Thread Index](thrd10.html#163480)]

---

* *To*: shuah@xxxxxxxxxx, valentina.manea.m@xxxxxxxxx, gregkh@xxxxxxxxxxxxxxxxxxx
* *Subject*: [PATCH 0/4] USB over IP Secuurity fixes
* *From*: Shuah Khan <shuahkh@xxxxxxxxxxxxxxx>
* *Date*: Thu, 7 Dec 2017 14:16:46 -0700
* *Cc*: Shuah Khan <shuahkh@xxxxxxxxxxxxxxx>, linux-usb@xxxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx, vuln@xxxxxxxxxxx

---

```
Jakub Jirasek from Secunia Research at Flexera reported security
vulnerabilities in the USB over IP driver. This patch series all
the 4 reported problems.

Jakub, could you please suggest an email address I can use for the
Reported-by tag?

Shuah Khan (4):
  usbip: fix stub_rx: get_pipe() to validate endpoint number
  usbip: fix stub_rx: harden CMD_SUBMIT path to handle malicious input
  usbip: prevent vhci_hcd driver from leaking a socket pointer address
  usbip: fix stub_send_ret_submit() vulnerability to null
    transfer_buffer

 drivers/usb/usbip/stub_rx.c          | 51 +++++++++++++++++++++++++++++-------
 drivers/usb/usbip/stub_tx.c          |  7 +++++
 drivers/usb/usbip/usbip_common.h     |  1 +
 drivers/usb/usbip/vhci_sysfs.c       | 25 +++++++++++-------
 tools/usb/usbip/libsrc/vhci_driver.c |  8 +++---
 5 files changed, 69 insertions(+), 23 deletions(-)

--
2.14.1

--
To unsubscribe from this list: send the line "unsubscribe linux-usb" in
the body of a message to majordomo@xxxxxxxxxxxxxxx
More majordomo info at  <http://vger.kernel.org/majordomo-info.html>

```

---

* **Follow-Ups**:
  + **[RE: [PATCH 0/4] USB over IP Secuurity fixes](msg163513.html)**
    - *From:* Secunia Research
  + **[Re: [PATCH 0/4] USB over IP Secuurity fixes](msg163491.html)**
    - *From:* Greg KH
  + **[[PATCH 1/4] usbip: fix stub\_rx: get\_pipe() to validate endpoint number](msg163481.html)**
    - *From:* Shuah Khan
  + **[[PATCH 2/4] usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input](msg163479.html)**
    - *From:* Shuah Khan
  + **[[PATCH 4/4] usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer](msg163478.html)**
    - *From:* Shuah Khan
  + **[[PATCH 3/4] usbip: prevent vhci\_hcd driver from leaking a socket pointer address](msg163477.html)**
    - *From:* Shuah Khan

* Prev by Date:
  **[[PATCH 2/4] usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input](msg163479.html)**
* Next by Date:
  **[[PATCH 1/4] usbip: fix stub\_rx: get\_pipe() to validate endpoint number](msg163481.html)**
* Previous by thread:
  **[[PATCH v1 0/1] lsusb: Fix potential floating point exception.](msg163469.html)**
* Next by thread:
  **[[PATCH 3/4] usbip: prevent vhci\_hcd driver from leaking a socket pointer address](msg163477.html)**
* Index(es):
  + [**Date**](mail10.html#163480)
  + [**Thread**](thrd10.html#163480)

[[Index of Archives]](/lists/)

[[Linux Media]](/lists/linux-media/)

[[Linux Input]](/lists/linux-input/)

[[Linux Audio Users]](/lists/linux-audio-users/)

[[Yosemite News]](https://yosemitenews.info/)

[[Linux Kernel]](/lists/kernel/)

[[Linux SCSI]](/lists/linux-scsi/)

[[Old Linux USB Devel Archive]](/lists/linux-usb-devel/)

---

|  | [Powered by Linux](/lists/) |
| --- | --- |



=== Content from secuniaresearch.flexerasoftware.com_b75e106c_20250125_181646.html ===


[Skip to main content](#main-content)
[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

Search

## Main navigation

* Solutions
  + Column 1
    - Business challenge
      * [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
      * [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
      * [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
      * [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
      * [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
      * [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
      * [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
      * [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
      * [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
      * [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
      * [Public sector](https://www.flexera.com/solutions/public-sector)
  + Column 2
    - Spend management by vendor
      * [IBM](https://www.flexera.com/solutions/vendor/ibm)
      * [Oracle](https://www.flexera.com/solutions/vendor/oracle)
      * [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
      * [SAP](https://www.flexera.com/solutions/vendor/sap)
      * [VMware](https://www.flexera.com/solutions/vendor/vmware)
      * [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
      * [AWS](https://www.flexera.com/solutions/vendor/aws)
      * [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
      * [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
      * [Adobe](https://www.flexera.com/solutions/vendor/adobe)

  ### Achieve more through a united FinOps and ITAM function

  The future is hybrid. Break down the walls between ITAM and FinOps to drive more revenue, more customer growth and more innovation.

  [Discover More](https://www.flexera.com/resources/hybrid-itam-finops)
* Products
  + Column 1
    - [Flexera One](https://www.flexera.com/products/flexera-one)
      * [IT Visibility](https://www.flexera.com/products/flexera-one/it-visibility)
      * [ITAM](https://www.flexera.com/products/flexera-one/it-asset-management)
      * [SaaS Management](https://www.flexera.com/products/flexera-one/saas-management)
      * [FinOps](https://www.flexera.com/products/flexera-one/finops)
      * [Technology Intelligence Platform](https://www.flexera.com/products/flexera-one/technology-intelligence-platform)
  + Column 2
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
      * [Snow Spend Optimizer](https://www.flexera.com/products/snow-atlas/snow-spend-optimizer)
      * [Snow SaaS Management](https://www.flexera.com/products/snow-atlas/snow-saas-management)
  + Column 3
    - Hide group
      * [Security](https://www.flexera.com/products/security)
      * [Application Readiness](https://www.flexera.com/products/adminstudio)
      * [All products](https://www.flexera.com/products)
      * [All Snow products](https://www.flexera.com/products/snow)
      * [Integrations](https://www.flexera.com/products/integrations)

  ### Flexera 2024 State of the Cloud Report

  What do transformative initiatives such as GenAI, machine learning and sustainability mean for the cloud? Check out the 2024 State of the Cloud Report to find the answer as well as all the latest cloud computing trends.

  [View Report](https://info.flexera.com/CM-REPORT-State-of-the-Cloud)
* Success
  + Column 1
    - [Customer success](https://www.flexera.com/customer-success)
      * Support
        + [Flexera support portal](https://community.flexera.com/s/support-hub)
        + [Flexera product documentation](https://docs.flexera.com)
        + [Snow product documentation](https://docs.snowsoftware.io/)
      * Services and training
        + [Services](https://www.flexera.com/customer-success/services)
        + [Training](https://www.flexera.com/customer-success/training)
  + Column 2
    - Hide group
      * [Technology Intelligence Awards](https://www.flexera.com/customer-success/awards)
      * [Flexera community](https://community.flexera.com/s/)

  ### Insights from Gartner®

  Find a curated series of actionable and objective insights for IT executives and their teams. Get expert insights from valued analysts, courtesy of Flexera.

  [Discover More](https://www.flexera.com/resources/gartner-analyst-research)
* Resources
  + Column 1
    - [Resources](https://www.flexera.com/resources)
      * [Webinars](https://www.flexera.com/resources?type%5Bwebinar%5D=webinar)
      * [Videos](https://www.flexera.com/resources?type%5Bvideo%5D=video)
      * [Datasheets](https://www.flexera.com/resources?type%5Bdatasheet%5D=datasheet)
      * [White papers & reports](https://www.flexera.com/resources?type%5Bwhite-paper-industry-report%5D=white-paper-industry-report)
  + Column 2
    - Hide group
      * [Blog](/blog/)
      * [Case studies](https://www.flexera.com/resources/case-studies)
      * [Events](https://www.flexera.com/resources?type%5Bevent%5D=event)
      * [Analyst Research](https://www.flexera.com/resources/gartner-analyst-research)
      * [Glossary](https://www.flexera.com/resources/glossary)
      * [Demos & trials](https://www.flexera.com/resources?type%5Bdemo-trials%5D=demo-trials)
      * [Business value calculator](https://www.flexera.com/resources/business-value-calculator)

  ### Flexera 2025 IT Priorities Report

  Insights from Flexera’s 2025 IT Priorities Report highlight what’s top of mind for IT decision makers in the year ahead. Discover the challenges, priorities and opportunities that will shape the future IT landscape.

  [View Report](https://info.flexera.com/ITV-REPORT-IT-Priorities)
* About
  + Column 1
    - [Company](https://www.flexera.com/about-us)
      * [About](https://www.flexera.com/about-us)
      * [Careers](https://www.flexera.com/about-us/careers)
      * [Contact](https://www.flexera.com/about-us/contact-us)
      * [Leadership](https://www.flexera.com/about-us/leadership)
    - [Partners](https://www.flexera.com/about-us/partners)
      * [Partner program](https://www.flexera.com/about-us/partners/partner-program)
      * [Partner directory](https://www.flexera.com/about-us/partners/directory)
  + Column 2
    - [Press center](https://www.flexera.com/about-us/press-center)
      * [Press releases](https://www.flexera.com/about-us/all-press-releases)
      * [Awards](https://www.flexera.com/about-us/press-center#awards)
      * [Articles](https://www.flexera.com/about-us/all-articles)
    - Hide group
      * Social responsibility
        + [ESG](https://www.flexera.com/about-us/environmental-social-governance)
        + [Diversity](https://www.flexera.com/about-us/diversity)

  ### More value with technology intelligence

  The unparalleled synergy of Flexera and Snow provides the Technology Intelligence you need for more efficiency, insight and governance than ever before.

  [Discover More](https://www.flexera.com/more-value-with-technology-intelligence)

Search

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

## External Links

* External Links
  + [Community](https://community.flexera.com/)
  + [Product Access](https://app.flexera.com/login)
  + [Partner Portal](https://flexera.channeltivity.com/Login)

[Book a demo](/about-us/contact-us?C_Interest1=sales)

# Secunia Research

## The world’s best vulnerability intelligence

The Secunia Research team from Flexera provides the most accurate and reliable source of vulnerability intelligence.

[Contact Us](https://www.flexera.com/about-us/contact-us?C_Interest1=sales&C_SolutionInterest=SVM)
Watch video (0:29)

Related links

* [Anatomy of a security advisory](https://www.flexera.com/resources/infographics/anatomy-of-a-security-advisory)
* [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)
* [Software Vulnerability Manager](/products/software-vulnerability-manager)
* [Security advisories from Secunia Research](https://www.flexera.com/products/security/software-vulnerability-advisories)
* [Report a vulnerability](https://www.flexera.com/about-us/contact-us/report-vulnerability)

 ![Secunia Research](/sites/default/files/2022-04/hero-secunia-research-bg.jpg)

Featured Details

## Multiple ways to consume Secunia Research

Secunia delivers software security research that provides reliable, curated and actionable vulnerability intelligence. Organizations can expect to receive standardized, validated and enriched vulnerability research on a specific version of a software product. Secunia Research supports four solutions:

![Software Vulnerability Research](/sites/default/files/2022-04/icon-secunia-research-svr.svg)

### [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)

Software Vulnerability Research utilizes Secunia Research to drive awareness of vulnerabilities matching your specified criteria

[Learn More](https://www.flexera.com/products/software-vulnerability-research)

![Software Vulnerability Manager](/sites/default/files/2022-04/icon-secunia-research-svm.svg)

### [Software Vulnerability Manager](/products/software-vulnerability-manager)

Software Vulnerability Manager uses Secunia Research data to identify, prioritize and patch known vulnerable software detected in your environment

[Learn More](/products/software-vulnerability-manager)

![Data Platform](/sites/default/files/2022-04/icon-secunia-research-dp.svg)

### [Data Platform](https://www.flexera.com/products/data-platform)

Data Platform leverages Secunia Research to provide high-level insights based on major or minor versions of software in your normalized inventory

[Learn More](https://www.flexera.com/products/data-platform)

![Flexera One](/sites/default/files/2022-04/icon-secunia-research-flexera-one.svg)

### [Flexera One](/flexera-one)

Flexera One utilizes Secunia Research (alongside public NVD data) to provide more granular matching of build-level versions of software in your normalized inventory within its IT Asset Management and IT Visibility solutions

[Learn More](/flexera-one)

How it works

## Accurate, reliable vulnerability insights at your fingertips

The Secunia Research team from Flexera is comprised of several security specialists who conduct vulnerability research in various products in addition to testing, verifying and validating public vulnerability reports. Since its inception in 2002, the goal of the Secunia Research team is to provide the most accurate and reliable source of vulnerability intelligence.

Delivering the world’s best vulnerability intelligence requires skill and passion. Team members continually develop their skills exploring various high-profile closed and open-source software using a variety of approaches, focusing chiefly on thorough code audits and binary analysis. The team has received industry recognition, including naming members to [Microsoft’s Most Valuable Security Researchers](https://msrc-blog.microsoft.com/2019/08/07/announcing-2019-msrc-most-valuable-security-researchers/) list.

Secunia researchers discover hard-to-find vulnerabilities that aren’t normally identified with techniques such as fuzzing, and the results have been impressive. Members of the Secunia Research team have discovered critical vulnerabilities in products from vendors including Microsoft, Symantec, IBM, Adobe, RealNetworks, Trend Micro, HP, Blue Coat, Samba, CA, Mozilla and Apple.

The team produces invaluable security advisories based on research of the vulnerabilities affecting any given software update. Sometimes a single update can address multiple vulnerabilities of varying criticalities and threats; but these advisories aggregate and distill findings down to a single advisory perfect for the prioritization of patching efforts within [Software Vulnerability Manager](/products/software-vulnerability-manager). Criticality scores are consistently applied along with details around attack vector and other valuable details within [Software Vulnerability Research](/products/software-vulnerability-research/secunia-research). Illegitimate vulnerability reports are also investigated and rejected so you can focus only on what truly matters.

Informing IT, Transforming IT

## Industry insights to help keep you informed

[#### Webinar

### Stay Ahead of Cyber Threats: Flexera's Latest Vulnerability Insights

Join us for this session where we'll explore the latest findings from the Flexera Monthly Vulnerability Insights Report.](https://info.flexera.com/SVM-WBNR-Vulnerability-Insights-Roundtable)

[#### Webinar

### Dive deeper into the Flexera Annual Vulnerability Insights

We'll explore the key findings from the Flexera Annual Vulnerability Insights Report. Learn about the latest cybersecurity trends, the most targeted industries, the types of vulnerabilities, plus management and mitigation strategies.](https://info.flexera.com/SVM-WBNR-Flexera-Annual-Vulnerability-Insights?lead_source=Website%20Visitor&id=Flexera.com-Resources)

#### Video

### Close the Risk Window with Software Vulnerability Manager

Stop reacting. Gain control. Stay secure. Build a more effective risk mitigation process leveraging Secunia Research vulnerability intelligence and the largest repository of third-party patch data in the industry.

Remote video URL

[#### Trial

### Software Vulnerability Manager Assessment free trial

Get access to the complete set of modules of Software Vulnerability Manager: Research, Assessment and Patching](https://info.flexera.com/SVM-EVAL-Software-Vulnerability-Manager)

[#### Datasheet

### Protect your ServiceNow® investment with the highest quality data

IT Visibility offers certified ServiceNow integrations that accelerate platform expansion, improve ROI and increase efficiencies across ITIL processes by delivering clean software and hardware asset data directly.](/sites/default/files/datasheet-itv-maximize-servicenow-investment.pdf)

[#### Blog

### Avoid missing crucial vulnerability intelligence amid NVD backlog

Recent developments regarding the National Vulnerability Database (NVD) have some technology leaders on edge. Since February, the U.S. National Institute of Standards and Technology (NIST) has almost completely stopped enriching software vulnerabi...](https://www.flexera.com/blog/vulnerability-management/avoid-missing-crucial-vulnerability-intelligence-amid-nvd-backlog/)

[View all resources](https://www.flexera.com/resources?category%5Bsoftware-vulnerability-management%5D=software-vulnerability-management)

## Footer Menu

* Column
  + Business challenge
    - [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
    - [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
    - [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
    - [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
    - [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
    - [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
    - [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
    - [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
    - [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
    - [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
    - [Public sector](https://www.flexera.com/solutions/public-sector)
* Column
  + Spend management by vendor
    - [IBM](https://www.flexera.com/solutions/vendor/ibm)
    - [Oracle](https://www.flexera.com/solutions/vendor/oracle)
    - [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
    - [SAP](https://www.flexera.com/solutions/vendor/sap)
    - [VMware](https://www.flexera.com/solutions/vendor/vmware)
    - [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
    - [AWS](https://www.flexera.com/solutions/vendor/aws)
    - [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
    - [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
    - [Adobe](https://www.flexera.com/solutions/vendor/adobe)
* Column
  + Products
    - [Flexera One](https://www.flexera.com/products/flexera-one)
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
    - [Security](https://www.flexera.com/products/security)
    - [Application Readiness](https://www.flexera.com/products/adminstudio)
    - [All products](https://www.flexera.com/products)
    - [All Snow products](https://www.flexera.com/products/snow)
    - [Integrations](https://www.flexera.com/products/integrations)
* Column
  + Company
    - [About](https://www.flexera.com/about-us)
    - [Careers](https://www.flexera.com/about-us/careers)
    - [Leadership](https://www.flexera.com/about-us/leadership)
    - [Contact us](https://www.flexera.com/about-us/contact-us)
    - [Media / press center](https://www.flexera.com/about-us/press-center)
    - [Revenera.com](https://www.revenera.com)

 +1.800.374.4353

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

 [![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

© 2025 Flexera. All Rights Reserved.

## Footer

* [Privacy Policy](https://www.flexera.com/legal/privacy-policy)
* [Terms and conditions](https://www.flexera.com/legal)
* [Contact Us](https://www.flexera.com/about-us/contact-us)
* [Impressum](https://www.flexera.com/about-us/impressum)
* [Site Map](https://www.flexera.com/sitemap)

#####

×

...



=== Content from usn.ubuntu.com_57df2232_20250125_181649.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3619-2: Linux kernel (Xenial HWE) vulnerabilities

5 April 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty

## Details

USN-3619-1 fixed vulnerabilities in the Linux kernel for Ubuntu 16.04

LTS. This update provides the corresponding updates for the Linux

Hardware Enablement (HWE) kernel from Ubuntu 16.04 LTS for Ubuntu

14.04 LTS.

Jann Horn discovered that the Berkeley Packet Filter (BPF) implementation

in the Linux kernel improperly performed sign extension in some situations.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-16995](/security/CVE-2017-16995))

It was discovered that a race condition leading to a use-after-free

vulnerability existed in the ALSA PCM subsystem of the Linux kernel. A

local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-0861](/security/CVE-2017-0861))

It was discovered that the KVM implementation in the Linux kernel allowed

passthrough of the diagnostic I/O port 0x80. An attacker in a guest VM

could use this to cause a denial of service (system crash) in the host OS.

([CVE-2017-1000407](/security/CVE-2017-1000407))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a use-after-free vulnerability existed in the

network namespaces implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2017-15129](/security/CVE-2017-15129))

It was discovered that the Advanced Linux Sound Architecture (ALSA)

subsystem in the Linux kernel contained a use-after-free when handling

device removal. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16528](/security/CVE-2017-16528))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the DiBcom DiB0700 USB DVB driver in the

Linux kernel did not properly handle detach events. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16646](/security/CVE-2017-16646))

Andrey Konovalov discovered that the CDC USB Ethernet driver did not

properly validate device descriptors. A physically proximate attacker could

use this to cause a denial of service (system crash). ([CVE-2017-16649](/security/CVE-2017-16649))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure

vulnerability. A physically proximate attacker could use this to expose

sensitive information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the HugeTLB component of the Linux kernel did not

properly handle holes in hugetlb ranges. A local attacker could use this to

expose sensitive information (kernel memory). ([CVE-2017-16994](/security/CVE-2017-16994))

It was discovered that the netfilter component of the Linux did not

properly restrict access to the connection tracking helpers list. A local

attacker could use this to bypass intended access restrictions.

([CVE-2017-17448](/security/CVE-2017-17448))

It was discovered that the netlink subsystem in the Linux kernel did not

properly restrict observations of netlink messages to the appropriate net

namespace. A local attacker could use this to expose sensitive information

(kernel netlink traffic). ([CVE-2017-17449](/security/CVE-2017-17449))

It was discovered that the netfilter passive OS fingerprinting (xt\_osf)

module did not properly perform access control checks. A local attacker

could improperly modify the system-wide OS fingerprint list.

([CVE-2017-17450](/security/CVE-2017-17450))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

contained an out-of-bounds read when handling memory-mapped I/O. A local

attacker could use this to expose sensitive information. ([CVE-2017-17741](/security/CVE-2017-17741))

It was discovered that the Salsa20 encryption algorithm implementations in

the Linux kernel did not properly handle zero-length inputs. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2017-17805](/security/CVE-2017-17805))

It was discovered that the HMAC implementation did not validate the state

of the underlying cryptographic hash algorithm. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-17806](/security/CVE-2017-17806))

It was discovered that the keyring implementation in the Linux kernel did

not properly check permissions when a key request was performed on a task's

default keyring. A local attacker could use this to add keys to

unauthorized keyrings. ([CVE-2017-17807](/security/CVE-2017-17807))

Alexei Starovoitov discovered that the Berkeley Packet Filter (BPF)

implementation in the Linux kernel contained a branch-pruning logic issue

around unreachable code. A local attacker could use this to cause a denial

of service. ([CVE-2017-17862](/security/CVE-2017-17862))

It was discovered that the parallel cryptography component of the Linux

kernel incorrectly freed kernel memory. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-18075](/security/CVE-2017-18075))

It was discovered that a race condition existed in the Device Mapper

component of the Linux kernel. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2017-18203](/security/CVE-2017-18203))

It was discovered that a race condition existed in the OCFS2 file system

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (kernel deadlock). ([CVE-2017-18204](/security/CVE-2017-18204))

It was discovered that an infinite loop could occur in the madvise(2)

implementation in the Linux kernel in certain circumstances. A local

attacker could use this to cause a denial of service (system hang).

([CVE-2017-18208](/security/CVE-2017-18208))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

It was discovered that the Broadcom NetXtremeII ethernet driver in the

Linux kernel did not properly validate Generic Segment Offload (GSO) packet

sizes. An attacker could use this to cause a denial of service (interface

unavailability). ([CVE-2018-1000026](/security/CVE-2018-1000026))

It was discovered that the Reliable Datagram Socket (RDS) implementation in

the Linux kernel contained an out-of-bounds write during RDMA page

allocation. An attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2018-5332](/security/CVE-2018-5332))

Mohamed Ghannam discovered a null pointer dereference in the RDS (Reliable

Datagram Sockets) protocol implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-5333](/security/CVE-2018-5333))

范龙飞 discovered that a race condition existed in loop block device

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5344](/security/CVE-2018-5344))

It was discovered that an integer overflow error existed in the futex

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash). ([CVE-2018-6927](/security/CVE-2018-6927))

It was discovered that a NULL pointer dereference existed in the RDS

(Reliable Datagram Sockets) protocol implementation in the Linux kernel. A

local attacker could use this to cause a denial of service (system crash).

([CVE-2018-7492](/security/CVE-2018-7492))

It was discovered that the Broadcom UniMAC MDIO bus controller driver in

the Linux kernel did not properly validate device resources. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-8043](/security/CVE-2018-8043))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-4.4.0-1016-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1016.16](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1016.16)
* [linux-image-4.4.0-119-generic](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)
* [linux-image-4.4.0-119-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-119.143~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-119.143~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-0861](/security/CVE-2017-0861)
* [CVE-2017-1000407](/security/CVE-2017-1000407)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-15129](/security/CVE-2017-15129)
* [CVE-2017-16528](/security/CVE-2017-16528)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16646](/security/CVE-2017-16646)
* [CVE-2017-16649](/security/CVE-2017-16649)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-16994](/security/CVE-2017-16994)
* [CVE-2017-16995](/security/CVE-2017-16995)
* [CVE-2017-17448](/security/CVE-2017-17448)
* [CVE-2017-17449](/security/CVE-2017-17449)
* [CVE-2017-17450](/security/CVE-2017-17450)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-17741](/security/CVE-2017-17741)
* [CVE-2017-17805](/security/CVE-2017-17805)
* [CVE-2017-17806](/security/CVE-2017-17806)
* [CVE-2017-17807](/security/CVE-2017-17807)
* [CVE-2017-17862](/security/CVE-2017-17862)
* [CVE-2017-18075](/security/CVE-2017-18075)
* [CVE-2017-18203](/security/CVE-2017-18203)
* [CVE-2017-18204](/security/CVE-2017-18204)
* [CVE-2017-18208](/security/CVE-2017-18208)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2018-1000026](/security/CVE-2018-1000026)
* [CVE-2018-5332](/security/CVE-2018-5332)
* [CVE-2018-5333](/security/CVE-2018-5333)
* [CVE-2018-5344](/security/CVE-2018-5344)
* [CVE-2018-6927](/security/CVE-2018-6927)
* [CVE-2018-7492](/security/CVE-2018-7492)
* [CVE-2018-8043](/security/CVE-2018-8043)

## Related notices

* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3619-1](/security/notices/USN-3619-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3632-1](/security/notices/USN-3632-1)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3523-2](/security/notices/USN-3523-2)
* [USN-3633-1](/security/notices/USN-3633-1)
* [USN-3523-1](/security/notices/USN-3523-1)
* [USN-3523-3](/security/notices/USN-3523-3)
* [USN-3620-1](/security/notices/USN-3620-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3653-1](/security/notices/USN-3653-1)
* [USN-3657-1](/security/notices/USN-3657-1)
* [USN-3655-1](/security/notices/USN-3655-1)
* [USN-3653-2](/security/notices/USN-3653-2)
* [USN-3655-2](/security/notices/USN-3655-2)
* [USN-3698-2](/security/notices/USN-3698-2)
* [USN-3697-1](/security/notices/USN-3697-1)
* [USN-3698-1](/security/notices/USN-3698-1)
* [USN-3697-2](/security/notices/USN-3697-2)
* [USN-3674-2](/security/notices/USN-3674-2)
* [USN-3674-1](/security/notices/USN-3674-1)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3630-2](/security/notices/USN-3630-2)
* [USN-3630-1](/security/notices/USN-3630-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from cdn.kernel.org_18af7a76_20250125_181636.html ===
commit 49fe90b853dfb1087d0a734cd7f4af1aa00c8e53
Author: Greg Kroah-Hartman
Date: Wed Jan 31 12:06:14 2018 +0100
Linux 4.4.114
commit 3f84339bd344b2cf0afe64b78d3964bb6422d0f3
Author: Ben Hutchings
Date: Mon Jan 22 20:11:06 2018 +0000
nfsd: auth: Fix gid sorting when rootsquash enabled
commit 1995266727fa8143897e89b55f5d3c79aa828420 upstream.
Commit bdcf0a423ea1 ("kernel: make groups\_sort calling a responsibility
group\_info allocators") appears to break nfsd rootsquash in a pretty
major way.
It adds a call to groups\_sort() inside the loop that copies/squashes
gids, which means the valid gids are sorted along with the following
garbage. The net result is that the highest numbered valid gids are
replaced with any lower-valued garbage gids, possibly including 0.
We should sort only once, after filling in all the gids.
Fixes: bdcf0a423ea1 ("kernel: make groups\_sort calling a responsibility ...")
Signed-off-by: Ben Hutchings
Acked-by: J. Bruce Fields
Signed-off-by: Linus Torvalds
Cc: Wolfgang Walter
Signed-off-by: Greg Kroah-Hartman
commit edaafa805e0f9d09560a4892790b8e19cab8bf09
Author: Dan Streetman
Date: Thu Jan 18 16:14:26 2018 -0500
net: tcp: close sock if net namespace is exiting
[ Upstream commit 4ee806d51176ba7b8ff1efd81f271d7252e03a1d ]
When a tcp socket is closed, if it detects that its net namespace is
exiting, close immediately and do not wait for FIN sequence.
For normal sockets, a reference is taken to their net namespace, so it will
never exit while the socket is open. However, kernel sockets do not take a
reference to their net namespace, so it may begin exiting while the kernel
socket is still open. In this case if the kernel socket is a tcp socket,
it will stay open trying to complete its close sequence. The sock's dst(s)
hold a reference to their interface, which are all transferred to the
namespace's loopback interface when the real interfaces are taken down.
When the namespace tries to take down its loopback interface, it hangs
waiting for all references to the loopback interface to release, which
results in messages like:
unregister\_netdevice: waiting for lo to become free. Usage count = 1
These messages continue until the socket finally times out and closes.
Since the net namespace cleanup holds the net\_mutex while calling its
registered pernet callbacks, any new net namespace initialization is
blocked until the current net namespace finishes exiting.
After this change, the tcp socket notices the exiting net namespace, and
closes immediately, releasing its dst(s) and their reference to the
loopback interface, which lets the net namespace continue exiting.
Link: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1711407
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=97811
Signed-off-by: Dan Streetman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d35cd5e279881ec36ff8cd82a2d9caebc0cce3fc
Author: Eric Dumazet
Date: Wed Jan 17 14:21:13 2018 -0800
flow\_dissector: properly cap thoff field
[ Upstream commit d0c081b49137cd3200f2023c0875723be66e7ce5 ]
syzbot reported yet another crash [1] that is caused by
insufficient validation of DODGY packets.
Two bugs are happening here to trigger the crash.
1) Flow dissection leaves with incorrect thoff field.
2) skb\_probe\_transport\_header() sets transport header to this invalid
thoff, even if pointing after skb valid data.
3) qdisc\_pkt\_len\_init() reads out-of-bound data because it
trusts tcp\_hdrlen(skb)
Possible fixes :
- Full flow dissector validation before injecting bad DODGY packets in
the stack.
This approach was attempted here : https://patchwork.ozlabs.org/patch/
861874/
- Have more robust functions in the core.
This might be needed anyway for stable versions.
This patch fixes the flow dissection issue.
[1]
CPU: 1 PID: 3144 Comm: syzkaller271204 Not tainted 4.15.0-rc4-mm1+ #49
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:256
kasan\_report\_error mm/kasan/report.c:355 [inline]
kasan\_report+0x23b/0x360 mm/kasan/report.c:413
\_\_asan\_report\_load2\_noabort+0x14/0x20 mm/kasan/report.c:432
\_\_tcp\_hdrlen include/linux/tcp.h:35 [inline]
tcp\_hdrlen include/linux/tcp.h:40 [inline]
qdisc\_pkt\_len\_init net/core/dev.c:3160 [inline]
\_\_dev\_queue\_xmit+0x20d3/0x2200 net/core/dev.c:3465
dev\_queue\_xmit+0x17/0x20 net/core/dev.c:3554
packet\_snd net/packet/af\_packet.c:2943 [inline]
packet\_sendmsg+0x3ad5/0x60a0 net/packet/af\_packet.c:2968
sock\_sendmsg\_nosec net/socket.c:628 [inline]
sock\_sendmsg+0xca/0x110 net/socket.c:638
sock\_write\_iter+0x31a/0x5d0 net/socket.c:907
call\_write\_iter include/linux/fs.h:1776 [inline]
new\_sync\_write fs/read\_write.c:469 [inline]
\_\_vfs\_write+0x684/0x970 fs/read\_write.c:482
vfs\_write+0x189/0x510 fs/read\_write.c:544
SYSC\_write fs/read\_write.c:589 [inline]
SyS\_write+0xef/0x220 fs/read\_write.c:581
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 34fad54c2537 ("net: \_\_skb\_flow\_dissect() must cap its return value")
Fixes: a6e544b0a88b ("flow\_dissector: Jump to exit code in \_\_skb\_flow\_dissect")
Signed-off-by: Eric Dumazet
Cc: Willem de Bruijn
Reported-by: syzbot
Acked-by: Jason Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cab8451486a6fd9ba4ce798d41352f45abb44fae
Author: Jim Westfall
Date: Sun Jan 14 04:18:51 2018 -0800
ipv4: Make neigh lookup keys for loopback/point-to-point devices be INADDR\_ANY
[ Upstream commit cd9ff4de0107c65d69d02253bb25d6db93c3dbc1 ]
Map all lookup neigh keys to INADDR\_ANY for loopback/point-to-point devices
to avoid making an entry for every remote ip the device needs to talk to.
This used the be the old behavior but became broken in a263b3093641f
(ipv4: Make neigh lookups directly in output packet path) and later removed
in 0bb4087cbec0 (ipv4: Fix neigh lookup keying over loopback/point-to-point
devices) because it was broken.
Signed-off-by: Jim Westfall
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 29837a4a8764c1b73674eb78c99717cbc73aa9f3
Author: Jim Westfall
Date: Sun Jan 14 04:18:50 2018 -0800
net: Allow neigh contructor functions ability to modify the primary\_key
[ Upstream commit 096b9854c04df86f03b38a97d40b6506e5730919 ]
Use n->primary\_key instead of pkey to account for the possibility that a neigh
constructor function may have modified the primary\_key value.
Signed-off-by: Jim Westfall
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0d9bcadb2226150776c5bf84ef6eb5df03e32b03
Author: Neil Horman
Date: Mon Jan 22 16:06:37 2018 -0500
vmxnet3: repair memory leak
[ Upstream commit 848b159835ddef99cc4193083f7e786c3992f580 ]
with the introduction of commit
b0eb57cb97e7837ebb746404c2c58c6f536f23fa, it appears that rq->buf\_info
is improperly handled. While it is heap allocated when an rx queue is
setup, and freed when torn down, an old line of code in
vmxnet3\_rq\_destroy was not properly removed, leading to rq->buf\_info[0]
being set to NULL prior to its being freed, causing a memory leak, which
eventually exhausts the system on repeated create/destroy operations
(for example, when the mtu of a vmxnet3 interface is changed
frequently.
Fix is pretty straight forward, just move the NULL set to after the
free.
Tested by myself with successful results
Applies to net, and should likely be queued for stable, please
Signed-off-by: Neil Horman
Reported-By: boyang@redhat.com
CC: boyang@redhat.com
CC: Shrikrishna Khare
CC: "VMware, Inc."
CC: David S. Miller
Acked-by: Shrikrishna Khare
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 50194c3f48de2c2374731d4b6b7f3fbb89250094
Author: Xin Long
Date: Mon Jan 15 17:01:36 2018 +0800
sctp: return error if the asoc has been peeled off in sctp\_wait\_for\_sndbuf
[ Upstream commit a0ff660058b88d12625a783ce9e5c1371c87951f ]
After commit cea0cc80a677 ("sctp: use the right sk after waking up from
wait\_buf sleep"), it may change to lock another sk if the asoc has been
peeled off in sctp\_wait\_for\_sndbuf.
However, the asoc's new sk could be already closed elsewhere, as it's in
the sendmsg context of the old sk that can't avoid the new sk's closing.
If the sk's last one refcnt is held by this asoc, later on after putting
this asoc, the new sk will be freed, while under it's own lock.
This patch is to revert that commit, but fix the old issue by returning
error under the old sk's lock.
Fixes: cea0cc80a677 ("sctp: use the right sk after waking up from wait\_buf sleep")
Reported-by: syzbot+ac6ea7baa4432811eb50@syzkaller.appspotmail.com
Signed-off-by: Xin Long
Acked-by: Neil Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 23f521bc70b935156e13897db2873312b18b0437
Author: Xin Long
Date: Mon Jan 15 17:02:00 2018 +0800
sctp: do not allow the v4 socket to bind a v4mapped v6 address
[ Upstream commit c5006b8aa74599ce19104b31d322d2ea9ff887cc ]
The check in sctp\_sockaddr\_af is not robust enough to forbid binding a
v4mapped v6 addr on a v4 socket.
The worse thing is that v4 socket's bind\_verify would not convert this
v4mapped v6 addr to a v4 addr. syzbot even reported a crash as the v4
socket bound a v6 addr.
This patch is to fix it by doing the common sa.sa\_family check first,
then AF\_INET check for v4mapped v6 addrs.
Fixes: 7dab83de50c7 ("sctp: Support ipv6only AF\_INET6 sockets.")
Reported-by: syzbot+7b7b518b1228d2743963@syzkaller.appspotmail.com
Acked-by: Neil Horman
Signed-off-by: Xin Long
Acked-by: Marcelo Ricardo Leitner
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d6611191f5a18d03314ab4a1b621d1892116af79
Author: Francois Romieu
Date: Fri Jan 26 01:53:26 2018 +0100
r8169: fix memory corruption on retrieval of hardware statistics.
[ Upstream commit a78e93661c5fd30b9e1dee464b2f62f966883ef7 ]
Hardware statistics retrieval hurts in tight invocation loops.
Avoid extraneous write and enforce strict ordering of writes targeted to
the tally counters dump area address registers.
Signed-off-by: Francois Romieu
Tested-by: Oliver Freyermuth
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a49558ebc2c4ce129a381d7cf39c4f01ea02c78b
Author: Guillaume Nault
Date: Mon Jan 22 18:06:37 2018 +0100
pppoe: take ->needed\_headroom of lower device into account on xmit
[ Upstream commit 02612bb05e51df8489db5e94d0cf8d1c81f87b0c ]
In pppoe\_sendmsg(), reserving dev->hard\_header\_len bytes of headroom
was probably fine before the introduction of ->needed\_headroom in
commit f5184d267c1a ("net: Allow netdevices to specify needed head/tailroom").
But now, virtual devices typically advertise the size of their overhead
in dev->needed\_headroom, so we must also take it into account in
skb\_reserve().
Allocation size of skb is also updated to take dev->needed\_tailroom
into account and replace the arbitrary 32 bytes with the real size of
a PPPoE header.
This issue was discovered by syzbot, who connected a pppoe socket to a
gre device which had dev->header\_ops->create == ipgre\_header and
dev->hard\_header\_len == 0. Therefore, PPPoE didn't reserve any
headroom, and dev\_hard\_header() crashed when ipgre\_header() tried to
prepend its header to skb->data.
skbuff: skb\_under\_panic: text:000000001d390b3a len:31 put:24
head:00000000d8ed776f data:000000008150e823 tail:0x7 end:0xc0 dev:gre0
------------[ cut here ]------------
kernel BUG at net/core/skbuff.c:104!
invalid opcode: 0000 [#1] SMP KASAN
Dumping ftrace buffer:
(ftrace buffer empty)
Modules linked in:
CPU: 1 PID: 3670 Comm: syzkaller801466 Not tainted
4.15.0-rc7-next-20180115+ #97
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
Google 01/01/2011
RIP: 0010:skb\_panic+0x162/0x1f0 net/core/skbuff.c:100
RSP: 0018:ffff8801d9bd7840 EFLAGS: 00010282
RAX: 0000000000000083 RBX: ffff8801d4f083c0 RCX: 0000000000000000
RDX: 0000000000000083 RSI: 1ffff1003b37ae92 RDI: ffffed003b37aefc
RBP: ffff8801d9bd78a8 R08: 1ffff1003b37ae8a R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000000 R12: ffffffff86200de0
R13: ffffffff84a981ad R14: 0000000000000018 R15: ffff8801d2d34180
FS: 00000000019c4880(0000) GS:ffff8801db300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000208bc000 CR3: 00000001d9111001 CR4: 00000000001606e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
skb\_under\_panic net/core/skbuff.c:114 [inline]
skb\_push+0xce/0xf0 net/core/skbuff.c:1714
ipgre\_header+0x6d/0x4e0 net/ipv4/ip\_gre.c:879
dev\_hard\_header include/linux/netdevice.h:2723 [inline]
pppoe\_sendmsg+0x58e/0x8b0 drivers/net/ppp/pppoe.c:890
sock\_sendmsg\_nosec net/socket.c:630 [inline]
sock\_sendmsg+0xca/0x110 net/socket.c:640
sock\_write\_iter+0x31a/0x5d0 net/socket.c:909
call\_write\_iter include/linux/fs.h:1775 [inline]
do\_iter\_readv\_writev+0x525/0x7f0 fs/read\_write.c:653
do\_iter\_write+0x154/0x540 fs/read\_write.c:932
vfs\_writev+0x18a/0x340 fs/read\_write.c:977
do\_writev+0xfc/0x2a0 fs/read\_write.c:1012
SYSC\_writev fs/read\_write.c:1085 [inline]
SyS\_writev+0x27/0x30 fs/read\_write.c:1082
entry\_SYSCALL\_64\_fastpath+0x29/0xa0
Admittedly PPPoE shouldn't be allowed to run on non Ethernet-like
interfaces, but reserving space for ->needed\_headroom is a more
fundamental issue that needs to be addressed first.
Same problem exists for \_\_pppoe\_xmit(), which also needs to take
dev->needed\_headroom into account in skb\_cow\_head().
Fixes: f5184d267c1a ("net: Allow netdevices to specify needed head/tailroom")
Reported-by: syzbot+ed0838d0fa4c4f2b528e20286e6dc63effc7c14d@syzkaller.appspotmail.com
Signed-off-by: Guillaume Nault
Reviewed-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f50fc5f4f3e5f0d2b55cd09c01f3a09d0ddeb9dc
Author: Eric Dumazet
Date: Thu Jan 18 19:59:19 2018 -0800
net: qdisc\_pkt\_len\_init() should be more robust
[ Upstream commit 7c68d1a6b4db9012790af7ac0f0fdc0d2083422a ]
Without proper validation of DODGY packets, we might very well
feed qdisc\_pkt\_len\_init() with invalid GSO packets.
tcp\_hdrlen() might access out-of-bound data, so let's use
skb\_header\_pointer() and proper checks.
Whole story is described in commit d0c081b49137 ("flow\_dissector:
properly cap thoff field")
We have the goal of validating DODGY packets earlier in the stack,
so we might very well revert this fix in the future.
Signed-off-by: Eric Dumazet
Cc: Willem de Bruijn
Cc: Jason Wang
Reported-by: syzbot+9da69ebac7dddd804552@syzkaller.appspotmail.com
Acked-by: Jason Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bed42ef5ebbfc046e0440f7e0f941cc07f8ca1e8
Author: Craig Gallek
Date: Wed Feb 10 11:50:37 2016 -0500
tcp: \_\_tcp\_hdrlen() helper
commit d9b3fca27385eafe61c3ca6feab6cb1e7dc77482 upstream.
tcp\_hdrlen is wasteful if you already have a pointer to struct tcphdr.
This splits the size calculation into a helper function that can be
used if a struct tcphdr is already available.
Signed-off-by: Craig Gallek
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6c489ab43ccacb9f26620ded90374c582c466344
Author: Felix Fietkau
Date: Fri Jan 19 11:50:46 2018 +0100
net: igmp: fix source address check for IGMPv3 reports
[ Upstream commit ad23b750933ea7bf962678972a286c78a8fa36aa ]
Commit "net: igmp: Use correct source address on IGMPv3 reports"
introduced a check to validate the source address of locally generated
IGMPv3 packets.
Instead of checking the local interface address directly, it uses
inet\_ifa\_match(fl4->saddr, ifa), which checks if the address is on the
local subnet (or equal to the point-to-point address if used).
This breaks for point-to-point interfaces, so check against
ifa->ifa\_local directly.
Cc: Kevin Cernekee
Fixes: a46182b00290 ("net: igmp: Use correct source address on IGMPv3 reports")
Reported-by: Sebastian Gottschall
Signed-off-by: Felix Fietkau
Signed-off-by: David S. Miller
Tested-by: Florian Wolters
Signed-off-by: Greg Kroah-Hartman
commit 1202fc020465b67297f84dfc7127b83805082c69
Author: Yuiko Oshino
Date: Mon Jan 15 13:24:28 2018 -0500
lan78xx: Fix failure in USB Full Speed
[ Upstream commit a5b1379afbfabf91e3a689e82ac619a7157336b3 ]
Fix initialize the uninitialized tx\_qlen to an appropriate value when USB
Full Speed is used.
Fixes: 55d7de9de6c3 ("Microchip's LAN7800 family USB 2/3 to 10/100/1000 Ethernet device driver")
Signed-off-by: Yuiko Oshino
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f64568e420e6b9b523611ef564941b83c7527614
Author: Eric Dumazet
Date: Thu Jan 11 22:31:18 2018 -0800
ipv6: ip6\_make\_skb() needs to clear cork.base.dst
[ Upstream commit 95ef498d977bf44ac094778fd448b98af158a3e6 ]
In my last patch, I missed fact that cork.base.dst was not initialized
in ip6\_make\_skb() :
If ip6\_setup\_cork() returns an error, we might attempt a dst\_release()
on some random pointer.
Fixes: 862c03ee1deb ("ipv6: fix possible mem leaks in ipv6\_make\_skb()")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c867a05df5d1baefbb2040474356b5e02ca5fcaf
Author: Mike Maloney
Date: Wed Jan 10 12:45:10 2018 -0500
ipv6: fix udpv6 sendmsg crash caused by too small MTU
[ Upstream commit 749439bfac6e1a2932c582e2699f91d329658196 ]
The logic in \_\_ip6\_append\_data() assumes that the MTU is at least large
enough for the headers. A device's MTU may be adjusted after being
added while sendmsg() is processing data, resulting in
\_\_ip6\_append\_data() seeing any MTU. For an mtu smaller than the size of
the fragmentation header, the math results in a negative 'maxfraglen',
which causes problems when refragmenting any previous skb in the
skb\_write\_queue, leaving it possibly malformed.
Instead sendmsg returns EINVAL when the mtu is calculated to be less
than IPV6\_MIN\_MTU.
Found by syzkaller:
kernel BUG at ./include/linux/skbuff.h:2064!
invalid opcode: 0000 [#1] SMP KASAN
Dumping ftrace buffer:
(ftrace buffer empty)
Modules linked in:
CPU: 1 PID: 14216 Comm: syz-executor5 Not tainted 4.13.0-rc4+ #2
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
task: ffff8801d0b68580 task.stack: ffff8801ac6b8000
RIP: 0010:\_\_skb\_pull include/linux/skbuff.h:2064 [inline]
RIP: 0010:\_\_ip6\_make\_skb+0x18cf/0x1f70 net/ipv6/ip6\_output.c:1617
RSP: 0018:ffff8801ac6bf570 EFLAGS: 00010216
RAX: 0000000000010000 RBX: 0000000000000028 RCX: ffffc90003cce000
RDX: 00000000000001b8 RSI: ffffffff839df06f RDI: ffff8801d9478ca0
RBP: ffff8801ac6bf780 R08: ffff8801cc3f1dbc R09: 0000000000000000
R10: ffff8801ac6bf7a0 R11: 43cb4b7b1948a9e7 R12: ffff8801cc3f1dc8
R13: ffff8801cc3f1d40 R14: 0000000000001036 R15: dffffc0000000000
FS: 00007f43d740c700(0000) GS:ffff8801dc100000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f7834984000 CR3: 00000001d79b9000 CR4: 00000000001406e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
ip6\_finish\_skb include/net/ipv6.h:911 [inline]
udp\_v6\_push\_pending\_frames+0x255/0x390 net/ipv6/udp.c:1093
udpv6\_sendmsg+0x280d/0x31a0 net/ipv6/udp.c:1363
inet\_sendmsg+0x11f/0x5e0 net/ipv4/af\_inet.c:762
sock\_sendmsg\_nosec net/socket.c:633 [inline]
sock\_sendmsg+0xca/0x110 net/socket.c:643
SYSC\_sendto+0x352/0x5a0 net/socket.c:1750
SyS\_sendto+0x40/0x50 net/socket.c:1718
entry\_SYSCALL\_64\_fastpath+0x1f/0xbe
RIP: 0033:0x4512e9
RSP: 002b:00007f43d740bc08 EFLAGS: 00000216 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00000000007180a8 RCX: 00000000004512e9
RDX: 000000000000002e RSI: 0000000020d08000 RDI: 0000000000000005
RBP: 0000000000000086 R08: 00000000209c1000 R09: 000000000000001c
R10: 0000000000040800 R11: 0000000000000216 R12: 00000000004b9c69
R13: 00000000ffffffff R14: 0000000000000005 R15: 00000000202c2000
Code: 9e 01 fe e9 c5 e8 ff ff e8 7f 9e 01 fe e9 4a ea ff ff 48 89 f7 e8 52 9e 01 fe e9 aa eb ff ff e8 a8 b6 cf fd 0f 0b e8 a1 b6 cf fd <0f> 0b 49 8d 45 78 4d 8d 45 7c 48 89 85 78 fe ff ff 49 8d 85 ba
RIP: \_\_skb\_pull include/linux/skbuff.h:2064 [inline] RSP: ffff8801ac6bf570
RIP: \_\_ip6\_make\_skb+0x18cf/0x1f70 net/ipv6/ip6\_output.c:1617 RSP: ffff8801ac6bf570
Reported-by: syzbot
Signed-off-by: Mike Maloney
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c5371a321a4a3c1f181f4482b3b3ceae06b72879
Author: Ben Hutchings
Date: Mon Jan 22 20:06:42 2018 +0000
ipv6: Fix getsockopt() for sockets with default IPV6\_AUTOFLOWLABEL
[ Upstream commit e9191ffb65d8e159680ce0ad2224e1acbde6985c ]
Commit 513674b5a2c9 ("net: reevalulate autoflowlabel setting after
sysctl setting") removed the initialisation of
ipv6\_pinfo::autoflowlabel and added a second flag to indicate
whether this field or the net namespace default should be used.
The getsockopt() handling for this case was not updated, so it
currently returns 0 for all sockets for which IPV6\_AUTOFLOWLABEL is
not explicitly enabled. Fix it to return the effective value, whether
that has been set at the socket or net namespace level.
Fixes: 513674b5a2c9 ("net: reevalulate autoflowlabel setting after sysctl ...")
Signed-off-by: Ben Hutchings
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e91e5b700fb6f887d4df4a18de0d8865df43d77d
Author: Alexey Kodanev
Date: Fri Jan 26 15:14:16 2018 +0300
dccp: don't restart ccid2\_hc\_tx\_rto\_expire() if sk in closed state
[ Upstream commit dd5684ecae3bd8e44b644f50e2c12c7e57fdfef5 ]
ccid2\_hc\_tx\_rto\_expire() timer callback always restarts the timer
again and can run indefinitely (unless it is stopped outside), and after
commit 120e9dabaf55 ("dccp: defer ccid\_hc\_tx\_delete() at dismantle time"),
which moved ccid\_hc\_tx\_delete() (also includes sk\_stop\_timer()) from
dccp\_destroy\_sock() to sk\_destruct(), this started to happen quite often.
The timer prevents releasing the socket, as a result, sk\_destruct() won't
be called.
Found with LTP/dccp\_ipsec tests running on the bonding device,
which later couldn't be unloaded after the tests were completed:
unregister\_netdevice: waiting for bond0 to become free. Usage count = 148
Fixes: 2a91aa396739 ("[DCCP] CCID2: Initial CCID2 (TCP-Like) implementation")
Signed-off-by: Alexey Kodanev
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 360496cab53af2f1dd77dbe353b7b665bcfdc1e3
Author: Thomas Gleixner
Date: Fri Jan 26 14:54:32 2018 +0100
hrtimer: Reset hrtimer cpu base proper on CPU hotplug
commit d5421ea43d30701e03cadc56a38854c36a8b4433 upstream.
The hrtimer interrupt code contains a hang detection and mitigation
mechanism, which prevents that a long delayed hrtimer interrupt causes a
continous retriggering of interrupts which prevent the system from making
progress. If a hang is detected then the timer hardware is programmed with
a certain delay into the future and a flag is set in the hrtimer cpu base
which prevents newly enqueued timers from reprogramming the timer hardware
prior to the chosen delay. The subsequent hrtimer interrupt after the delay
clears the flag and resumes normal operation.
If such a hang happens in the last hrtimer interrupt before a CPU is
unplugged then the hang\_detected flag is set and stays that way when the
CPU is plugged in again. At that point the timer hardware is not armed and
it cannot be armed because the hang\_detected flag is still active, so
nothing clears that flag. As a consequence the CPU does not receive hrtimer
interrupts and no timers expire on that CPU which results in RCU stalls and
other malfunctions.
Clear the flag along with some other less critical members of the hrtimer
cpu base to ensure starting from a clean state when a CPU is plugged in.
Thanks to Paul, Sebastian and Anna-Maria for their help to get down to the
root cause of that hard to reproduce heisenbug. Once understood it's
trivial and certainly justifies a brown paperbag.
Fixes: 41d2e4949377 ("hrtimer: Tune hrtimer\_interrupt hang logic")
Reported-by: Paul E. McKenney
Signed-off-by: Thomas Gleixner
Cc: Peter Zijlstra
Cc: Sebastian Sewior
Cc: Anna-Maria Gleixner
Link: https://lkml.kernel.org/r/alpine.DEB.2.20.1801261447590.2067@nanos
Signed-off-by: Greg Kroah-Hartman
commit 20c0a04284496b262b172707b7dd122cdd8fe9a1
Author: Jia Zhang
Date: Tue Jan 23 11:41:32 2018 +0100
x86/microcode/intel: Extend BDW late-loading further with LLC size check
commit 7e702d17ed138cf4ae7c00e8c00681ed464587c7 upstream.
Commit b94b73733171 ("x86/microcode/intel: Extend BDW late-loading with a
revision check") reduced the impact of erratum BDF90 for Broadwell model
79.
The impact can be reduced further by checking the size of the last level
cache portion per core.
Tony: "The erratum says the problem only occurs on the large-cache SKUs.
So we only need to avoid the update if we are on a big cache SKU that is
also running old microcode."
For more details, see erratum BDF90 in document #334165 (Intel Xeon
Processor E7-8800/4800 v4 Product Family Specification Update) from
September 2017.
Fixes: b94b73733171 ("x86/microcode/intel: Extend BDW late-loading with a revision check")
Signed-off-by: Jia Zhang
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Acked-by: Tony Luck
Link: https://lkml.kernel.org/r/1516321542-31161-1-git-send-email-zhang.jia@linux.alibaba.com
Signed-off-by: Greg Kroah-Hartman
commit 506ff217e470bdaa78477406a051c0570403307d
Author: Greg KH
Date: Wed Mar 8 19:03:44 2017 +0100
eventpoll.h: add missing epoll event masks
commit 7e040726850a106587485c21bdacc0bfc8a0cbed upstream.
[resend due to me forgetting to cc: linux-api the first time around I
posted these back on Feb 23]
From: Greg Kroah-Hartman
For some reason these values are not in the uapi header file, so any
libc has to define it themselves. To prevent them from needing to do
this, just have the kernel provide the correct values.
Reported-by: Elliott Hughes
Signed-off-by: Greg Hackmann
Signed-off-by: Greg Kroah-Hartman
commit ed73df0b7f23c95b3243a0f4bfc40f962e61d349
Author: Ben Hutchings
Date: Fri Jan 26 16:23:02 2018 +0000
vsyscall: Fix permissions for emulate mode with KAISER/PTI
The backport of KAISER to 4.4 turned vsyscall emulate mode into native
mode. Add a vsyscall\_pgprot variable to hold the correct page
protections, like Borislav and Hugh did for 3.2 and 3.18.
Cc: Borislav Petkov
Cc: Hugh Dickins
Signed-off-by: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit e1e457a49544718928282c56b69af082e1ebe405
Author: Thomas Meyer
Date: Sun Aug 20 13:26:04 2017 +0200
um: link vmlinux with -no-pie
commit 883354afbc109c57f925ccc19840055193da0cc0 upstream.
Debian's gcc defaults to pie. The global Makefile already defines the -fno-pie option.
Link UML dynamic kernel image also with -no-pie to fix the build.
Signed-off-by: Thomas Meyer
Signed-off-by: Richard Weinberger
Cc: Bernie Innocenti
Signed-off-by: Greg Kroah-Hartman
commit 04e7c734e33c53ca2f2b8d027d9f7251f12bb206
Author: Shuah Khan
Date: Fri Dec 15 10:50:09 2017 -0700
usbip: prevent leaking socket pointer address in messages
commit 90120d15f4c397272aaf41077960a157fc4212bf upstream.
usbip driver is leaking socket pointer address in messages. Remove
the messages that aren't useful and print sockfd in the ones that
are useful for debugging.
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit b6f826ba10dce86f74efd3c0953cb9982a3c51e2
Author: Shuah Khan
Date: Thu Dec 7 14:16:48 2017 -0700
usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input
commit c6688ef9f29762e65bce325ef4acd6c675806366 upstream.
Harden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 80e733a9b37fb6b40351bf1924d5a90d89c375ae
Author: Shuah Khan
Date: Thu Dec 7 14:16:47 2017 -0700
usbip: fix stub\_rx: get\_pipe() to validate endpoint number
commit 635f545a7e8be7596b9b2b6a43cab6bbd5a88e43 upstream.
get\_pipe() routine doesn't validate the input endpoint number
and uses to reference ep\_in and ep\_out arrays. Invalid endpoint
number can trigger BUG(). Range check the epnum and returning
error instead of calling BUG().
Change caller stub\_recv\_cmd\_submit() to handle the get\_pipe()
error return.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 18e905a839ed54b135b00e9d9c9dee2ed6908a08
Author: Andrew Goodbody
Date: Tue Feb 2 17:36:39 2016 +0000
usb: usbip: Fix possible deadlocks reported by lockdep
commit 21619792d1eca7e772ca190ba68588e57f29595b upstream.
Change spin\_lock calls to spin\_lock\_irqsave to prevent
attmpted recursive lock taking in interrupt context.
This patch fixes Bug 109351
https://bugzilla.kernel.org/show\_bug.cgi?id=109351
Signed-off-by: Andrew Goodbody
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 9af75003499c7a441e5a483220f5d2cf65861e73
Author: Aaron Ma
Date: Fri Jan 19 09:43:39 2018 -0800
Input: trackpoint - force 3 buttons if 0 button is reported
commit f5d07b9e98022d50720e38aa936fc11c67868ece upstream.
Lenovo introduced trackpoint compatible sticks with minimum PS/2 commands.
They supposed to reply with 0x02, 0x03, or 0x04 in response to the
"Read Extended ID" command, so we would know not to try certain extended
commands. Unfortunately even some trackpoints reporting the original IBM
version (0x01 firmware 0x0e) now respond with incorrect data to the "Get
Extended Buttons" command:
thinkpad\_acpi: ThinkPad BIOS R0DET87W (1.87 ), EC unknown
thinkpad\_acpi: Lenovo ThinkPad E470, model 20H1004SGE
psmouse serio2: trackpoint: IBM TrackPoint firmware: 0x0e, buttons: 0/0
Since there are no trackpoints without buttons, let's assume the trackpoint
has 3 buttons when we get 0 response to the extended buttons query.
Signed-off-by: Aaron Ma
Fixes: https://bugzilla.kernel.org/show\_bug.cgi?id=196253
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 5f1dc06152e1683a9277a2836517d6574757dd1f
Author: Greg Kroah-Hartman
Date: Wed Jan 24 15:28:17 2018 +0100
Revert "module: Add retpoline tag to VERMAGIC"
commit 5132ede0fe8092b043dae09a7cc32b8ae7272baa upstream.
This reverts commit 6cfb521ac0d5b97470883ff9b7facae264b7ab12.
Turns out distros do not want to make retpoline as part of their "ABI",
so this patch should not have been merged. Sorry Andi, this was my
fault, I suggested it when your original patch was the "correct" way of
doing this instead.
Reported-by: Jiri Kosina
Fixes: 6cfb521ac0d5 ("module: Add retpoline tag to VERMAGIC")
Acked-by: Andi Kleen
Cc: Thomas Gleixner
Cc: David Woodhouse
Cc: rusty@rustcorp.com.au
Cc: arjan.van.de.ven@intel.com
Cc: jeyu@kernel.org
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 509ed20926aa67aa9933b13f96002dc86b71ca60
Author: Johannes Thumshirn
Date: Mon Oct 9 13:33:19 2017 +0200
scsi: libiscsi: fix shifting of DID\_REQUEUE host byte
commit eef9ffdf9cd39b2986367bc8395e2772bc1284ba upstream.
The SCSI host byte should be shifted left by 16 in order to have
scsi\_decide\_disposition() do the right thing (.i.e. requeue the
command).
Signed-off-by: Johannes Thumshirn
Fixes: 661134ad3765 ("[SCSI] libiscsi, bnx2i: make bound ep check common")
Cc: Lee Duncan
Cc: Hannes Reinecke
Cc: Bart Van Assche
Cc: Chris Leech
Acked-by: Lee Duncan
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ad941c49a40237b77c543469e9e8daee0482a851
Author: Jiri Slaby
Date: Tue Jun 13 13:35:51 2017 +0200
fs/fcntl: f\_setown, avoid undefined behaviour
commit fc3dc67471461c0efcb1ed22fb7595121d65fad9 upstream.
fcntl(0, F\_SETOWN, 0x80000000) triggers:
UBSAN: Undefined behaviour in fs/fcntl.c:118:7
negation of -2147483648 cannot be represented in type 'int':
CPU: 1 PID: 18261 Comm: syz-executor Not tainted 4.8.1-0-syzkaller #1
...
Call Trace:
...
[] ? f\_setown+0x1d8/0x200
[] ? SyS\_fcntl+0x999/0xf30
[] ? entry\_SYSCALL\_64\_fastpath+0x23/0xc1
Fix that by checking the arg parameter properly (against INT\_MAX) before
"who = -who". And return immediatelly with -EINVAL in case it is wrong.
Note that according to POSIX we can return EINVAL:
http://pubs.opengroup.org/onlinepubs/9699919799/functions/fcntl.html
[EINVAL]
The cmd argument is F\_SETOWN and the value of the argument
is not valid as a process or process group identifier.
[v2] returns an error, v1 used to fail silently
[v3] implement proper check for the bad value INT\_MIN
Signed-off-by: Jiri Slaby
Cc: Jeff Layton
Cc: "J. Bruce Fields"
Cc: Alexander Viro
Cc: linux-fsdevel@vger.kernel.org
Signed-off-by: Jeff Layton
Signed-off-by: Greg Kroah-Hartman
commit e22c8378505e1354b4346c7ecccb446b7c505deb
Author: Jan Kara
Date: Thu Jun 22 09:32:49 2017 +0200
reiserfs: Don't clear SGID when inheriting ACLs
commit 6883cd7f68245e43e91e5ee583b7550abf14523f upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by moving posix\_acl\_update\_mode() out of
\_\_reiserfs\_set\_acl() into reiserfs\_set\_acl(). That way the function will
not be called when inheriting ACLs which is what we want as it prevents
SGID bit clearing and the mode has been properly set by
posix\_acl\_create() anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: reiserfs-devel@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 512e3b18531eb9526a1e695c19043f78e3a0abb1
Author: Jeff Mahoney
Date: Thu Jun 22 16:35:04 2017 -0400
reiserfs: don't preallocate blocks for extended attributes
commit 54930dfeb46e978b447af0fb8ab4e181c1bf9d7a upstream.
Most extended attributes will fit in a single block. More importantly,
we drop the reference to the inode while holding the transaction open
so the preallocated blocks aren't released. As a result, the inode
may be evicted before it's removed from the transaction's prealloc list
which can cause memory corruption.
Signed-off-by: Jeff Mahoney
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit ac125d89f8e980f100f63634a81b84fed7e997cf
Author: Jeff Mahoney
Date: Thu Jun 22 16:47:34 2017 -0400
reiserfs: fix race in prealloc discard
commit 08db141b5313ac2f64b844fb5725b8d81744b417 upstream.
The main loop in \_\_discard\_prealloc is protected by the reiserfs write lock
which is dropped across schedules like the BKL it replaced. The problem is
that it checks the value, calls a routine that schedules, and then adjusts
the state. As a result, two threads that are calling
reiserfs\_prealloc\_discard at the same time can race when one calls
reiserfs\_free\_prealloc\_block, the lock is dropped, and the other calls
reiserfs\_free\_prealloc\_block with the same block number. In the right
circumstances, it can cause the prealloc count to go negative.
Signed-off-by: Jeff Mahoney
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 8e8224de0e1848a5905ebda018969e2ce72258ca
Author: Jan Kara
Date: Wed Jun 21 14:34:15 2017 +0200
ext2: Don't clear SGID when inheriting ACLs
commit a992f2d38e4ce17b8c7d1f7f67b2de0eebdea069 upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by creating \_\_ext2\_set\_acl() function that does not call
posix\_acl\_update\_mode() and use it when inheriting ACLs. That prevents
SGID bit clearing and the mode has been properly set by
posix\_acl\_create() anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: stable@vger.kernel.org
CC: linux-ext4@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit d01ceb4722cd8d64176272434fe332b596750d9c
Author: Kevin Cernekee
Date: Tue Dec 5 15:42:41 2017 -0800
netfilter: xt\_osf: Add missing permission checks
commit 916a27901de01446bcf57ecca4783f6cff493309 upstream.
The capability check in nfnetlink\_rcv() verifies that the caller
has CAP\_NET\_ADMIN in the namespace that "owns" the netlink socket.
However, xt\_osf\_fingers is shared by all net namespaces on the
system. An unprivileged user can create user and net namespaces
in which he holds CAP\_NET\_ADMIN to bypass the netlink\_net\_capable()
check:
vpnns -- nfnl\_osf -f /tmp/pf.os
vpnns -- nfnl\_osf -f /tmp/pf.os -d
These non-root operations successfully modify the systemwide OS
fingerprint list. Add new capable() checks so that they can't.
Signed-off-by: Kevin Cernekee
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit a359a437fbc6bb08aa9cc8e25ef4ac3b77ca727b
Author: Kevin Cernekee
Date: Sun Dec 3 12:12:45 2017 -0800
netfilter: nfnetlink\_cthelper: Add missing permission checks
commit 4b380c42f7d00a395feede754f0bc2292eebe6e5 upstream.
The capability check in nfnetlink\_rcv() verifies that the caller
has CAP\_NET\_ADMIN in the namespace that "owns" the netlink socket.
However, nfnl\_cthelper\_list is shared by all net namespaces on the
system. An unprivileged user can create user and net namespaces
in which he holds CAP\_NET\_ADMIN to bypass the netlink\_net\_capable()
check:
$ nfct helper list
nfct v1.4.4: netlink error: Operation not permitted
$ vpnns -- nfct helper list
{
.name = ftp,
.queuenum = 0,
.l3protonum = 2,
.l4protonum = 6,
.priv\_data\_len = 24,
.status = enabled,
};
Add capable() checks in nfnetlink\_cthelper, as this is cleaner than
trying to generalize the solution.
Signed-off-by: Kevin Cernekee
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 936b21419e7c5be2f81e6dea02fc3d8852f3fb83
Author: Pablo Neira Ayuso
Date: Fri Apr 29 10:39:34 2016 +0200
netfilter: fix IS\_ERR\_VALUE usage
commit 92b4423e3a0bc5d43ecde4bcad871f8b5ba04efd upstream.
This is a forward-port of the original patch from Andrzej Hajda,
he said:
"IS\_ERR\_VALUE should be used only with unsigned long type.
Otherwise it can work incorrectly. To achieve this function
xt\_percpu\_counter\_alloc is modified to return unsigned long,
and its result is assigned to temporary variable to perform
error checking, before assigning to .pcnt field.
The patch follows conclusion from discussion on LKML [1][2].
[1]: http://permalink.gmane.org/gmane.linux.kernel/2120927
[2]: http://permalink.gmane.org/gmane.linux.kernel/2150581"
Original patch from Andrzej is here:
http://patchwork.ozlabs.org/patch/582970/
This patch has clashed with input validation fixes for x\_tables.
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
Acked-by: Michal Kubecek
commit f4ca7cba8ffa94c43913ed322c7d35ab3d6d1e38
Author: Pau Espin Pedrol
Date: Fri Jan 6 20:33:27 2017 +0100
netfilter: use fwmark\_reflect in nf\_send\_reset
commit cc31d43b4154ad5a7d8aa5543255a93b7e89edc2 upstream.
Otherwise, RST packets generated by ipt\_REJECT always have mark 0 when
the routing is checked later in the same code path.
Fixes: e110861f8609 ("net: add a sysctl to reflect the fwmark on replies")
Cc: Lorenzo Colitti
Signed-off-by: Pau Espin Pedrol
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 80291566d8f324563f2d889ef5a470e223d44f5c
Author: Ulrich Weber
Date: Mon Oct 24 18:07:23 2016 +0200
netfilter: nf\_conntrack\_sip: extend request line validation
commit 444f901742d054a4cd5ff045871eac5131646cfb upstream.
on SIP requests, so a fragmented TCP SIP packet from an allow header starting with
INVITE,NOTIFY,OPTIONS,REFER,REGISTER,UPDATE,SUBSCRIBE
Content-Length: 0
will not bet interpreted as an INVITE request. Also Request-URI must start with an alphabetic character.
Confirm with RFC 3261
Request-Line = Method SP Request-URI SP SIP-Version CRLF
Fixes: 30f33e6dee80 ("[NETFILTER]: nf\_conntrack\_sip: support method specific request/response handling")
Signed-off-by: Ulrich Weber
Acked-by: Marco Angaroni
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 2cf26badef7bde1f9ecb9fbdea2079ce366f3013
Author: Florian Westphal
Date: Thu Aug 25 15:33:29 2016 +0200
netfilter: restart search if moved to other chain
commit 95a8d19f28e6b29377a880c6264391a62e07fccc upstream.
In case nf\_conntrack\_tuple\_taken did not find a conflicting entry
check that all entries in this hash slot were tested and restart
in case an entry was moved to another chain.
Reported-by: Eric Dumazet
Fixes: ea781f197d6a ("netfilter: nf\_conntrack: use SLAB\_DESTROY\_BY\_RCU and get rid of call\_rcu()")
Signed-off-by: Florian Westphal
Acked-by: Eric Dumazet
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 2adda392d28baa25ca7803002fdafcaa95b7b1fb
Author: Liping Zhang
Date: Mon Aug 8 22:07:27 2016 +0800
netfilter: nfnetlink\_queue: reject verdict request from different portid
commit 00a3101f561816e58de054a470484996f78eb5eb upstream.
Like NFQNL\_MSG\_VERDICT\_BATCH do, we should also reject the verdict
request when the portid is not same with the initial portid(maybe
from another process).
Fixes: 97d32cf9440d ("netfilter: nfnetlink\_queue: batch verdict support")
Signed-off-by: Liping Zhang
Reviewed-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit d8f5cce0a8bce0decd125ef430ee6196692ff8da
Author: Liping Zhang
Date: Mon Aug 8 21:57:58 2016 +0800
netfilter: nf\_ct\_expect: remove the redundant slash when policy name is empty
commit b173a28f62cf929324a8a6adcc45adadce311d16 upstream.
The 'name' filed in struct nf\_conntrack\_expect\_policy{} is not a
pointer, so check it is NULL or not will always return true. Even if the
name is empty, slash will always be displayed like follows:
# cat /proc/net/nf\_conntrack\_expect
297 l3proto = 2 proto=6 src=1.1.1.1 dst=2.2.2.2 sport=1 dport=1025 ftp/
^
Fixes: 3a8fc53a45c4 ("netfilter: nf\_ct\_helper: allocate 16 bytes for the helper and policy names")
Signed-off-by: Liping Zhang
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit da00455d38a73c9412dd3f99285b48753ff1b61a
Author: Paolo Abeni
Date: Thu May 26 19:08:10 2016 +0200
netfilter: nf\_dup\_ipv6: set again FLOWI\_FLAG\_KNOWN\_NH at flowi6\_flags
commit 83170f3beccccd7ceb4f9a0ac0c4dc736afde90c upstream.
With the commit 48e8aa6e3137 ("ipv6: Set FLOWI\_FLAG\_KNOWN\_NH at
flowi6\_flags") ip6\_pol\_route() callers were asked to to set the
FLOWI\_FLAG\_KNOWN\_NH properly and xt\_TEE was updated accordingly,
but with the later refactor in commit bbde9fc1824a ("netfilter:
factor out packet duplication for IPv4/IPv6") the flowi6\_flags
update was lost.
This commit re-add it just before the routing decision.
Fixes: bbde9fc1824a ("netfilter: factor out packet duplication for IPv4/IPv6")
Signed-off-by: Paolo Abeni
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit a84338dad3c9501a5301db27ee665cda663219fc
Author: Hongxu Jia
Date: Tue Nov 29 21:56:26 2016 -0500
netfilter: arp\_tables: fix invoking 32bit "iptable -P INPUT ACCEPT" failed in 64bit kernel
commit 17a49cd549d9dc8707dc9262210166455c612dde upstream.
Since 09d9686047db ("netfilter: x\_tables: do compat validation via
translate\_table"), it used compatr structure to assign newinfo
structure. In translate\_compat\_table of ip\_tables.c and ip6\_tables.c,
it used compatr->hook\_entry to replace info->hook\_entry and
compatr->underflow to replace info->underflow, but not do the same
replacement in arp\_tables.c.
It caused invoking 32-bit "arptbale -P INPUT ACCEPT" failed in 64bit
kernel.
--------------------------------------
root@qemux86-64:~# arptables -P INPUT ACCEPT
root@qemux86-64:~# arptables -P INPUT ACCEPT
ERROR: Policy for `INPUT' offset 448 != underflow 0
arptables: Incompatible with this kernel
--------------------------------------
Fixes: 09d9686047db ("netfilter: x\_tables: do compat validation via translate\_table")
Signed-off-by: Hongxu Jia
Acked-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 45cf54e13c70ce0ec4875220103916978ce3ed07
Author: Florian Westphal
Date: Thu Jul 14 17:51:26 2016 +0200
netfilter: x\_tables: speed up jump target validation
commit f4dc77713f8016d2e8a3295e1c9c53a21f296def upstream.
The dummy ruleset I used to test the original validation change was broken,
most rules were unreachable and were not tested by mark\_source\_chains().
In some cases rulesets that used to load in a few seconds now require
several minutes.
sample ruleset that shows the behaviour:
echo "\*filter"
for i in $(seq 0 100000);do
printf ":chain\_%06x - [0:0]\n" $i
done
for i in $(seq 0 100000);do
printf -- "-A INPUT -j chain\_%06x\n" $i
printf -- "-A INPUT -j chain\_%06x\n" $i
printf -- "-A INPUT -j chain\_%06x\n" $i
done
echo COMMIT
[ pipe result into iptables-restore ]
This ruleset will be about 74mbyte in size, with ~500k searches
though all 500k[1] rule entries. iptables-restore will take forever
(gave up after 10 minutes)
Instead of always searching the entire blob for a match, fill an
array with the start offsets of every single ipt\_entry struct,
then do a binary search to check if the jump target is present or not.
After this change ruleset restore times get again close to what one
gets when reverting 36472341017529e (~3 seconds on my workstation).
[1] every user-defined rule gets an implicit RETURN, so we get
300k jumps + 100k userchains + 100k returns -> 500k rule entries
Fixes: 36472341017529e ("netfilter: x\_tables: validate targets of jumps")
Reported-by: Jeff Wu
Tested-by: Jeff Wu
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Acked-by: Michal Kubecek
Signed-off-by: Greg Kroah-Hartman
commit 4c19b00e5588828f0d3198b926efade766dcf2c8
Author: Seunghun Han
Date: Wed Apr 26 16:18:08 2017 +0800
ACPICA: Namespace: fix operand cache leak
commit 3b2d69114fefa474fca542e51119036dceb4aa6f upstream.
ACPICA commit a23325b2e583556eae88ed3f764e457786bf4df6
I found some ACPI operand cache leaks in ACPI early abort cases.
Boot log of ACPI operand cache leak is as follows:
>[ 0.174332] ACPI: Added \_OSI(Module Device)
>[ 0.175504] ACPI: Added \_OSI(Processor Device)
>[ 0.176010] ACPI: Added \_OSI(3.0 \_SCP Extensions)
>[ 0.177032] ACPI: Added \_OSI(Processor Aggregator Device)
>[ 0.178284] ACPI: SCI (IRQ16705) allocation failed
>[ 0.179352] ACPI Exception: AE\_NOT\_ACQUIRED, Unable to install
System Control Interrupt handler (20160930/evevent-131)
>[ 0.180008] ACPI: Unable to start the ACPI Interpreter
>[ 0.181125] ACPI Error: Could not remove SCI handler
(20160930/evmisc-281)
>[ 0.184068] kmem\_cache\_destroy Acpi-Operand: Slab cache still has
objects
>[ 0.185358] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.10.0-rc3 #2
>[ 0.186820] Hardware name: innotek gmb\_h virtual\_box/virtual\_box, BIOS
virtual\_box 12/01/2006
>[ 0.188000] Call Trace:
>[ 0.188000] ? dump\_stack+0x5c/0x7d
>[ 0.188000] ? kmem\_cache\_destroy+0x224/0x230
>[ 0.188000] ? acpi\_sleep\_proc\_init+0x22/0x22
>[ 0.188000] ? acpi\_os\_delete\_cache+0xa/0xd
>[ 0.188000] ? acpi\_ut\_delete\_caches+0x3f/0x7b
>[ 0.188000] ? acpi\_terminate+0x5/0xf
>[ 0.188000] ? acpi\_init+0x288/0x32e
>[ 0.188000] ? \_\_class\_create+0x4c/0x80
>[ 0.188000] ? video\_setup+0x7a/0x7a
>[ 0.188000] ? do\_one\_initcall+0x4e/0x1b0
>[ 0.188000] ? kernel\_init\_freeable+0x194/0x21a
>[ 0.188000] ? rest\_init+0x80/0x80
>[ 0.188000] ? kernel\_init+0xa/0x100
>[ 0.188000] ? ret\_from\_fork+0x25/0x30
When early abort is occurred due to invalid ACPI information, Linux kernel
terminates ACPI by calling acpi\_terminate() function. The function calls
acpi\_ns\_terminate() function to delete namespace data and ACPI operand cache
(acpi\_gbl\_module\_code\_list).
But the deletion code in acpi\_ns\_terminate() function is wrapped in
ACPI\_EXEC\_APP definition, therefore the code is only executed when the
definition exists. If the define doesn't exist, ACPI operand cache
(acpi\_gbl\_module\_code\_list) is leaked, and stack dump is shown in kernel log.
This causes a security threat because the old kernel (<= 4.9) shows memory
locations of kernel functions in stack dump, therefore kernel ASLR can be
neutralized.
To fix ACPI operand leak for enhancing security, I made a patch which
removes the ACPI\_EXEC\_APP define in acpi\_ns\_terminate() function for
executing the deletion code unconditionally.
Link: https://github.com/acpica/acpica/commit/a23325b2
Signed-off-by: Seunghun Han
Signed-off-by: Lv Zheng
Signed-off-by: Bob Moore
Signed-off-by: Rafael J. Wysocki
Acked-by: Lee, Chun-Yi
Signed-off-by: Greg Kroah-Hartman
commit 1fe277d48f998bd928f1b6ddcbe72f2a34b6f5ad
Author: Rafael J. Wysocki
Date: Fri Dec 30 02:27:31 2016 +0100
ACPI / scan: Prefer devices without \_HID/\_CID for \_ADR matching
commit c2a6bbaf0c5f90463a7011a295bbdb7e33c80b51 upstream.
The way acpi\_find\_child\_device() works currently is that, if there
are two (or more) devices with the same \_ADR value in the same
namespace scope (which is not specifically allowed by the spec and
the OS behavior in that case is not defined), the first one of them
found to be present (with the help of \_STA) will be returned.
This covers the majority of cases, but is not sufficient if some of
the devices in question have a \_HID (or \_CID) returning some valid
ACPI/PNP device IDs (which is disallowed by the spec) and the
ASL writers' expectation appears to be that the OS will match
devices without a valid ACPI/PNP device ID against a given bus
address first.
To cover this special case as well, modify find\_child\_checks()
to prefer devices without ACPI/PNP device IDs over devices that
have them.
Suggested-by: Mika Westerberg
Signed-off-by: Rafael J. Wysocki
Tested-by: Hans de Goede
Signed-off-by: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit 4d48ba75ec7877939e9f69ef66894f7f9ce4cf38
Author: Rafael J. Wysocki
Date: Thu Jun 2 01:57:50 2016 +0200
ACPI / processor: Avoid reserving IO regions too early
commit 86314751c7945fa0c67f459beeda2e7c610ca429 upstream.
Roland Dreier reports that one of his systems cannot boot because of
the changes made by commit ac212b6980d8 (ACPI / processor: Use common
hotplug infrastructure).
The problematic part of it is the request\_region() call in
acpi\_processor\_get\_info() that used to run at module init time before
the above commit and now it runs much earlier. Unfortunately, the
region(s) reserved by it fall into a range the PCI subsystem attempts
to reserve for AHCI IO BARs. As a result, the PCI reservation fails
and AHCI doesn't work, while previously the PCI reservation would
be made before acpi\_processor\_get\_info() and it would succeed.
That request\_region() call, however, was overlooked by commit
ac212b6980d8, as it is not necessary for the enumeration of the
processors. It only is needed when the ACPI processor driver
actually attempts to handle them which doesn't happen before
loading the ACPI processor driver module. Therefore that call
should have been moved from acpi\_processor\_get\_info() into that
module.
Address the problem by moving the request\_region() call in question
out of acpi\_processor\_get\_info() and use the observation that the
region reserved by it is only needed if the FADT-based CPU
throttling method is going to be used, which means that it should
be sufficient to invoke it from acpi\_processor\_get\_throttling\_fadt().
Fixes: ac212b6980d8 (ACPI / processor: Use common hotplug infrastructure)
Reported-by: Roland Dreier
Tested-by: Roland Dreier
Signed-off-by: Rafael J. Wysocki
Acked-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 699a6cc7dd321113c99e06c6c997e8d15557439c
Author: Rui Wang
Date: Wed Jun 8 14:59:52 2016 +0800
x86/ioapic: Fix incorrect pointers in ioapic\_setup\_resources()
commit 9d98bcec731756b8688b59ec998707924d716d7b upstream.
On a 4-socket Brickland system, hot-removing one ioapic is fine.
Hot-removing the 2nd one causes panic in mp\_unregister\_ioapic()
while calling release\_resource().
It is because the iomem\_res pointer has already been released
when removing the first ioapic.
To explain the use of &res[num] here: res is assigned to ioapic\_resources,
and later in ioapic\_insert\_resources() we do:
struct resource \*r = ioapic\_resources;
for\_each\_ioapic(i) {
insert\_resource(&iomem\_resource, r);
r++;
}
Here 'r' is treated as an arry of 'struct resource', and the r++ ensures
that each element of the array is inserted separately. Thus we should call
release\_resouce() on each element at &res[num].
Fix it by assigning the correct pointers to ioapics[i].iomem\_res in
ioapic\_setup\_resources().
Signed-off-by: Rui Wang
Signed-off-by: Thomas Gleixner
Cc: tony.luck@intel.com
Cc: linux-pci@vger.kernel.org
Cc: rjw@rjwysocki.net
Cc: linux-acpi@vger.kernel.org
Cc: bhelgaas@google.com
Link: http://lkml.kernel.org/r/1465369193-4816-3-git-send-email-rui.y.wang@intel.com
Signed-off-by: Ingo Molnar
Acked-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit bab93a6196224c862c679a1b1e97be8ceef926a5
Author: Jiri Slaby
Date: Wed Dec 14 15:06:07 2016 -0800
ipc: msg, make msgrcv work with LONG\_MIN
commit 999898355e08ae3b92dfd0a08db706e0c6703d30 upstream.
When LONG\_MIN is passed to msgrcv, one would expect to recieve any
message. But convert\_mode does \*msgtyp = -\*msgtyp and -LONG\_MIN is
undefined. In particular, with my gcc -LONG\_MIN produces -LONG\_MIN
again.
So handle this case properly by assigning LONG\_MAX to \*msgtyp if
LONG\_MIN was specified as msgtyp to msgrcv.
This code:
long msg[] = { 100, 200 };
int m = msgget(IPC\_PRIVATE, IPC\_CREAT | 0644);
msgsnd(m, &msg, sizeof(msg), 0);
msgrcv(m, &msg, sizeof(msg), LONG\_MIN, 0);
produces currently nothing:
msgget(IPC\_PRIVATE, IPC\_CREAT|0644) = 65538
msgsnd(65538, {100, "\310\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}, 16, 0) = 0
msgrcv(65538, ...
Except a UBSAN warning:
UBSAN: Undefined behaviour in ipc/msg.c:745:13
negation of -9223372036854775808 cannot be represented in type 'long int':
With the patch, I see what I expect:
msgget(IPC\_PRIVATE, IPC\_CREAT|0644) = 0
msgsnd(0, {100, "\310\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}, 16, 0) = 0
msgrcv(0, {100, "\310\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}, 16, -9223372036854775808, 0) = 16
Link: http://lkml.kernel.org/r/20161024082633.10148-1-jslaby@suse.cz
Signed-off-by: Jiri Slaby
Cc: Davidlohr Bueso
Cc: Manfred Spraul
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 90ca50c56bfba6c670c4b32cc062aa4c2b850938
Author: Vlastimil Babka
Date: Wed Nov 15 17:38:30 2017 -0800
mm, page\_alloc: fix potential false positive in \_\_zone\_watermark\_ok
commit b050e3769c6b4013bb937e879fc43bf1847ee819 upstream.
Since commit 97a16fc82a7c ("mm, page\_alloc: only enforce watermarks for
order-0 allocations"), \_\_zone\_watermark\_ok() check for high-order
allocations will shortcut per-migratetype free list checks for
ALLOC\_HARDER allocations, and return true as long as there's free page
of any migratetype. The intention is that ALLOC\_HARDER can allocate
from MIGRATE\_HIGHATOMIC free lists, while normal allocations can't.
However, as a side effect, the watermark check will then also return
true when there are pages only on the MIGRATE\_ISOLATE list, or (prior to
CMA conversion to ZONE\_MOVABLE) on the MIGRATE\_CMA list. Since the
allocation cannot actually obtain isolated pages, and might not be able
to obtain CMA pages, this can result in a false positive.
The condition should be rare and perhaps the outcome is not a fatal one.
Still, it's better if the watermark check is correct. There also
shouldn't be a performance tradeoff here.
Link: http://lkml.kernel.org/r/20171102125001.23708-1-vbabka@suse.cz
Fixes: 97a16fc82a7c ("mm, page\_alloc: only enforce watermarks for order-0 allocations")
Signed-off-by: Vlastimil Babka
Acked-by: Mel Gorman
Cc: Joonsoo Kim
Cc: Rik van Riel
Cc: David Rientjes
Cc: Johannes Weiner
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 1ab0bb9834766841e0119d472c78077c459654ac
Author: Doug Berger
Date: Mon Jul 10 15:49:44 2017 -0700
cma: fix calculation of aligned offset
commit e048cb32f69038aa1c8f11e5c1b331be4181659d upstream.
The align\_offset parameter is used by bitmap\_find\_next\_zero\_area\_off()
to represent the offset of map's base from the previous alignment
boundary; the function ensures that the returned index, plus the
align\_offset, honors the specified align\_mask.
The logic introduced by commit b5be83e308f7 ("mm: cma: align to physical
address, not CMA region position") has the cma driver calculate the
offset to the \*next\* alignment boundary. In most cases, the base
alignment is greater than that specified when making allocations,
resulting in a zero offset whether we align up or down. In the example
given with the commit, the base alignment (8MB) was half the requested
alignment (16MB) so the math also happened to work since the offset is
8MB in both directions. However, when requesting allocations with an
alignment greater than twice that of the base, the returned index would
not be correctly aligned.
Also, the align\_order arguments of cma\_bitmap\_aligned\_mask() and
cma\_bitmap\_aligned\_offset() should not be negative so the argument type
was made unsigned.
Fixes: b5be83e308f7 ("mm: cma: align to physical address, not CMA region position")
Link: http://lkml.kernel.org/r/20170628170742.2895-1-opendmb@gmail.com
Signed-off-by: Angus Clark
Signed-off-by: Doug Berger
Acked-by: Gregory Fong
Cc: Doug Berger
Cc: Angus Clark
Cc: Laura Abbott
Cc: Vlastimil Babka
Cc: Greg Kroah-Hartman
Cc: Lucas Stach
Cc: Catalin Marinas
Cc: Shiraz Hashim
Cc: Jaewon Kim
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Vlastimil Babka
Signed-off-by: Greg Kroah-Hartman
commit 361376a53481a7e042a1dd320b6bdbde8dc1ba48
Author: Michal Hocko
Date: Fri May 12 15:46:26 2017 -0700
hwpoison, memcg: forcibly uncharge LRU pages
commit 18365225f0440d09708ad9daade2ec11275c3df9 upstream.
Laurent Dufour has noticed that hwpoinsoned pages are kept charged. In
his particular case he has hit a bad\_page("page still charged to
cgroup") when onlining a hwpoison page. While this looks like something
that shouldn't happen in the first place because onlining hwpages and
returning them to the page allocator makes only little sense it shows a
real problem.
hwpoison pages do not get freed usually so we do not uncharge them (at
least not since commit 0a31bc97c80c ("mm: memcontrol: rewrite uncharge
API")). Each charge pins memcg (since e8ea14cc6ead ("mm: memcontrol:
take a css reference for each charged page")) as well and so the
mem\_cgroup and the associated state will never go away. Fix this leak
by forcibly uncharging a LRU hwpoisoned page in delete\_from\_lru\_cache().
We also have to tweak uncharge\_list because it cannot rely on zero ref
count for these pages.
[akpm@linux-foundation.org: coding-style fixes]
Fixes: 0a31bc97c80c ("mm: memcontrol: rewrite uncharge API")
Link: http://lkml.kernel.org/r/20170502185507.GB19165@dhcp22.suse.cz
Signed-off-by: Michal Hocko
Reported-by: Laurent Dufour
Tested-by: Laurent Dufour
Reviewed-by: Balbir Singh
Reviewed-by: Naoya Horiguchi
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 7175e56fa7076ea176ffa6dd41ddad288294ddb5
Author: Michal Hocko
Date: Mon Jul 10 15:49:51 2017 -0700
mm/mmap.c: do not blow on PROT\_NONE MAP\_FIXED holes in the stack
commit 561b5e0709e4a248c67d024d4d94b6e31e3edf2f upstream.
Commit 1be7107fbe18 ("mm: larger stack guard gap, between vmas") has
introduced a regression in some rust and Java environments which are
trying to implement their own stack guard page. They are punching a new
MAP\_FIXED mapping inside the existing stack Vma.
This will confuse expand\_{downwards,upwards} into thinking that the
stack expansion would in fact get us too close to an existing non-stack
vma which is a correct behavior wrt safety. It is a real regression on
the other hand.
Let's work around the problem by considering PROT\_NONE mapping as a part
of the stack. This is a gros hack but overflowing to such a mapping
would trap anyway an we only can hope that usespace knows what it is
doing and handle it propely.
Fixes: 1be7107fbe18 ("mm: larger stack guard gap, between vmas")
Link: http://lkml.kernel.org/r/20170705182849.GA18027@dhcp22.suse.cz
Signed-off-by: Michal Hocko
Debugged-by: Vlastimil Babka
Cc: Ben Hutchings
Cc: Willy Tarreau
Cc: Oleg Nesterov
Cc: Rik van Riel
Cc: Hugh Dickins
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 13757fc50433b6b6f68c21bd88a094d56514cb5b
Author: Vlastimil Babka
Date: Tue Oct 11 13:51:14 2016 -0700
fs/select: add vmalloc fallback for select(2)
commit 2d19309cf86883f634a4f8ec55a54bda87db19bf upstream.
The select(2) syscall performs a kmalloc(size, GFP\_KERNEL) where size grows
with the number of fds passed. We had a customer report page allocation
failures of order-4 for this allocation. This is a costly order, so it might
easily fail, as the VM expects such allocation to have a lower-order fallback.
Such trivial fallback is vmalloc(), as the memory doesn't have to be physically
contiguous and the allocation is temporary for the duration of the syscall
only. There were some concerns, whether this would have negative impact on the
system by exposing vmalloc() to userspace. Although an excessive use of vmalloc
can cause some system wide performance issues - TLB flushes etc. - a large
order allocation is not for free either and an excessive reclaim/compaction can
have a similar effect. Also note that the size is effectively limited by
RLIMIT\_NOFILE which defaults to 1024 on the systems I checked. That means the
bitmaps will fit well within single page and thus the vmalloc() fallback could
be only excercised for processes where root allows a higher limit.
Note that the poll(2) syscall seems to use a linked list of order-0 pages, so
it doesn't need this kind of fallback.
[eric.dumazet@gmail.com: fix failure path logic]
[akpm@linux-foundation.org: use proper type for size]
Link: http://lkml.kernel.org/r/20160927084536.5923-1-vbabka@suse.cz
Signed-off-by: Vlastimil Babka
Acked-by: Michal Hocko
Cc: Alexander Viro
Cc: Eric Dumazet
Cc: David Laight
Cc: Hillf Danton
Cc: Nicholas Piggin
Cc: Jason Baron
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0fd49331f9c1fee00ad9ef125faea9d14d7c6a59
Author: yangbo lu
Date: Wed Nov 25 10:05:37 2015 +0800
mmc: sdhci-of-esdhc: add/remove some quirks according to vendor version
commit 1ef5e49e46b919052474d9b54a15debc79ff0133 upstream.
A previous patch had removed esdhc\_of\_platform\_init() by mistake.
static void esdhc\_of\_platform\_init(struct sdhci\_host \*host)
{
u32 vvn;
vvn = in\_be32(host->ioaddr + SDHCI\_SLOT\_INT\_STATUS);
vvn = (vvn & SDHCI\_VENDOR\_VER\_MASK) >> SDHCI\_VENDOR\_VER\_SHIFT;
if (vvn == VENDOR\_V\_22)
host->quirks2 |= SDHCI\_QUIRK2\_HOST\_NO\_CMD23;
if (vvn > VENDOR\_V\_22)
host->quirks &= ~SDHCI\_QUIRK\_NO\_BUSY\_IRQ;
}
This patch is used to fix it by add/remove some quirks according to
verdor version in probe.
Signed-off-by: Yangbo Lu
Fixes: f4932cfd22f1 ("mmc: sdhci-of-esdhc: support both BE and LE host controller")
Signed-off-by: Ulf Hansson
Signed-off-by: Matthias Brugger
Signed-off-by: Greg Kroah-Hartman
commit 5ee8fef15d0affce9ff482dd99ff33a0578c2368
Author: Minghuan Lian
Date: Mon Feb 29 17:24:15 2016 -0600
PCI: layerscape: Fix MSG TLP drop setting
commit 1195c103f6c98d9ff381cac3a8760d4f8a133627 upstream.
Some kinds of Layerscape PCIe controllers will forward the received message
TLPs to system application address space, which could corrupt system memory
or lead to a system hang. Enable MSG\_DROP to fix this issue.
Signed-off-by: Minghuan Lian
Signed-off-by: Bjorn Helgaas
Signed-off-by: Matthias Brugger
Signed-off-by: Greg Kroah-Hartman
commit 12de6baf0637e2b0067bf5d71c3a7af1ec5b4ff1
Author: Yang Shi
Date: Wed Jan 27 09:32:05 2016 -0800
PCI: layerscape: Add "fsl,ls2085a-pcie" compatible ID
commit dbae40b76abef2f8a7e7bf1701f77df9e73def48 upstream.
The Layerscape PCI host driver must recognize ls2085a compatible when using
firmware with ls2085a compatible property, otherwise the PCI bus won't be
detected even though ls2085a compatible is included by the dts.
Signed-off-by: Yang Shi
Signed-off-by: Bjorn Helgaas
Signed-off-by: Matthias Brugger
Signed-off-by: Greg Kroah-Hartman
commit a91cdfa754905b702a5841b8d2b895599d8fad72
Author: Sudeep Holla
Date: Fri Oct 28 09:45:29 2016 +0100
drivers: base: cacheinfo: fix boot error message when acpi is enabled
commit 55877ef45fbd7f975d078426866b7d1a2435dcc3 upstream.
ARM64 enables both CONFIG\_OF and CONFIG\_ACPI and the firmware can pass
both ACPI tables and the device tree. Based on the kernel parameter, one
of the two will be chosen. If acpi is enabled, then device tree is not
unflattened.
Currently ARM64 platforms report:
"
Failed to find cpu0 device node
Unable to detect cache hierarchy from DT for CPU 0
"
which is incorrect when booting with ACPI. Also latest ACPI v6.1 has no
support for cache properties/hierarchy.
This patch adds check for unflattened device tree and also returns as
"not supported" if ACPI is runtime enabled.
It also removes the reference to DT from the error message as the cache
hierarchy can be detected from the firmware(OF/DT/ACPI)
Cc: Greg Kroah-Hartman
Signed-off-by: Sudeep Holla
Signed-off-by: Mian Yousaf Kaukab
Signed-off-by: Greg Kroah-Hartman
commit f31a8450c09327339939fe195707749c1d67016d
Author: Sudeep Holla
Date: Fri Oct 28 09:45:28 2016 +0100
drivers: base: cacheinfo: fix x86 with CONFIG\_OF enabled
commit fac51482577d5e05bbb0efa8d602a3c2111098bf upstream.
With CONFIG\_OF enabled on x86, we get the following error on boot:
"
Failed to find cpu0 device node
Unable to detect cache hierarchy from DT for CPU 0
"
and the cacheinfo fails to get populated in the corresponding sysfs
entries. This is because cache\_setup\_of\_node looks for of\_node for
setting up the shared cpu\_map without checking that it's already
populated in the architecture specific callback.
In order to indicate that the shared cpu\_map is already populated, this
patch introduces a boolean `cpu\_map\_populated` in struct cpu\_cacheinfo
that can be used by the generic code to skip cache\_shared\_cpu\_map\_setup.
This patch also sets that boolean for x86.
Cc: Greg Kroah-Hartman
Signed-off-by: Sudeep Holla
Signed-off-by: Mian Yousaf Kaukab
Signed-off-by: Greg Kroah-Hartman
commit 29b73cace1b1cc2daf2556b3285d4e79f19bcb3b
Author: Janakarajan Natarajan
Date: Tue Apr 25 16:44:03 2017 -0500
Prevent timer value 0 for MWAITX
commit 88d879d29f9cc0de2d930b584285638cdada6625 upstream.
Newer hardware has uncovered a bug in the software implementation of
using MWAITX for the delay function. A value of 0 for the timer is meant
to indicate that a timeout will not be used to exit MWAITX. On newer
hardware this can result in MWAITX never returning, resulting in NMI
soft lockup messages being printed. On older hardware, some of the other
conditions under which MWAITX can exit masked this issue. The AMD APM
does not currently document this and will be updated.
Please refer to http://marc.info/?l=kvm&m=148950623231140 for
information regarding NMI soft lockup messages on an AMD Ryzen 1800X.
This has been root-caused as a 0 passed to MWAITX causing it to wait
indefinitely.
This change has the added benefit of avoiding the unnecessary setup of
MONITORX/MWAITX when the delay value is zero.
Signed-off-by: Janakarajan Natarajan
Link: http://lkml.kernel.org/r/1493156643-29366-1-git-send-email-Janakarajan.Natarajan@amd.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Davidlohr Bueso
Signed-off-by: Greg Kroah-Hartman
commit 839003061aa9362f23866614862b49b57bfdd6ce
Author: Thomas Gleixner
Date: Mon Oct 24 11:41:56 2016 +0200
timers: Plug locking race vs. timer migration
commit b831275a3553c32091222ac619cfddd73a5553fb upstream.
Linus noticed that lock\_timer\_base() lacks a READ\_ONCE() for accessing the
timer flags. As a consequence the compiler is allowed to reload the flags
between the initial check for TIMER\_MIGRATION and the following timer base
computation and the spin lock of the base.
While this has not been observed (yet), we need to make sure that it never
happens.
Fixes: 0eeda71bc30d ("timer: Replace timer base by a cpu index")
Reported-by: Linus Torvalds
Signed-off-by: Thomas Gleixner
Link: http://lkml.kernel.org/r/alpine.DEB.2.20.1610241711220.4983@nanos
Cc: Andrew Morton
Cc: Peter Zijlstra
Signed-off-by: Mike Galbraith
Signed-off-by: Greg Kroah-Hartman
commit 08b1cf4964d526cf3c2ea9e36ffd752752543ef3
Author: Vegard Nossum
Date: Sat Aug 13 01:37:04 2016 +0200
time: Avoid undefined behaviour in ktime\_add\_safe()
commit 979515c5645830465739254abc1b1648ada41518 upstream.
I ran into this:
================================================================================
UBSAN: Undefined behaviour in kernel/time/hrtimer.c:310:16
signed integer overflow:
9223372036854775807 + 50000 cannot be represented in type 'long long int'
CPU: 2 PID: 4798 Comm: trinity-c2 Not tainted 4.8.0-rc1+ #91
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014
0000000000000000 ffff88010ce6fb88 ffffffff82344740 0000000041b58ab3
ffffffff84f97a20 ffffffff82344694 ffff88010ce6fbb0 ffff88010ce6fb60
000000000000c350 ffff88010ce6f968 dffffc0000000000 ffffffff857bc320
Call Trace:
[] dump\_stack+0xac/0xfc
[] ? \_atomic\_dec\_and\_lock+0xc4/0xc4
[] ubsan\_epilogue+0xd/0x8a
[] handle\_overflow+0x202/0x23d
[] ? val\_to\_string.constprop.6+0x11e/0x11e
[] ? timerqueue\_add+0x151/0x410
[] ? hrtimer\_start\_range\_ns+0x3b8/0x1380
[] ? memset+0x31/0x40
[] \_\_ubsan\_handle\_add\_overflow+0xe/0x10
[] hrtimer\_nanosleep+0x5d9/0x790
[] ? hrtimer\_init\_sleeper+0x80/0x80
[] ? \_\_might\_sleep+0x5b/0x260
[] common\_nsleep+0x20/0x30
[] SyS\_clock\_nanosleep+0x197/0x210
[] ? SyS\_clock\_getres+0x150/0x150
[] ? \_\_this\_cpu\_preempt\_check+0x13/0x20
[] ? \_\_context\_tracking\_exit.part.3+0x30/0x1b0
[] ? SyS\_clock\_getres+0x150/0x150
[] do\_syscall\_64+0x1b3/0x4b0
[] entry\_SYSCALL64\_slow\_path+0x25/0x25
================================================================================
Add a new ktime\_add\_unsafe() helper which doesn't check for overflow, but
doesn't throw a UBSAN warning when it does overflow either.
Cc: Thomas Gleixner
Cc: Ingo Molnar
Cc: Richard Cochran
Cc: Prarit Bhargava
Signed-off-by: Vegard Nossum
Signed-off-by: John Stultz
Signed-off-by: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit 0cb5ae4db47abc3985016aac6326ef98c533fe4d
Author: Eric Biggers
Date: Sun Jan 24 20:08:52 2016 -0600
PM / sleep: declare \_\_tracedata symbols as char[] rather than char
commit f97238373b8662a6d580e204df2e7bcbfa43e27a upstream.
Accessing more than one byte from a symbol declared simply 'char' is undefined
behavior, as reported by UBSAN:
UBSAN: Undefined behaviour in drivers/base/power/trace.c:178:18
load of address ffffffff8203fc78 with insufficient space
for an object of type 'char'
Avoid this by declaring the symbols as arrays.
Signed-off-by: Eric Biggers
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit 08f39b7bcccb532a6b96fdeaf91ed08e4af7dda4
Author: Marc Kleine-Budde
Date: Tue Jan 16 19:30:14 2018 +0100
can: af\_can: canfd\_rcv(): replace WARN\_ONCE by pr\_warn\_once
commit d4689846881d160a4d12a514e991a740bcb5d65a upstream.
If an invalid CANFD frame is received, from a driver or from a tun
interface, a Kernel warning is generated.
This patch replaces the WARN\_ONCE by a simple pr\_warn\_once, so that a
kernel, bootet with panic\_on\_warn, does not panic. A printk seems to be
more appropriate here.
Reported-by: syzbot+e3b775f40babeff6e68b@syzkaller.appspotmail.com
Suggested-by: Dmitry Vyukov
Acked-by: Oliver Hartkopp
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Oliver Hartkopp
Signed-off-by: Greg Kroah-Hartman
commit e7514af60542830a37cd8f2fc0419fc5e320d70c
Author: Marc Kleine-Budde
Date: Tue Jan 16 19:30:14 2018 +0100
can: af\_can: can\_rcv(): replace WARN\_ONCE by pr\_warn\_once
commit 8cb68751c115d176ec851ca56ecfbb411568c9e8 upstream.
If an invalid CAN frame is received, from a driver or from a tun
interface, a Kernel warning is generated.
This patch replaces the WARN\_ONCE by a simple pr\_warn\_once, so that a
kernel, bootet with panic\_on\_warn, does not panic. A printk seems to be
more appropriate here.
Reported-by: syzbot+4386709c0c1284dca827@syzkaller.appspotmail.com
Suggested-by: Dmitry Vyukov
Acked-by: Oliver Hartkopp
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Oliver Hartkopp
Signed-off-by: Greg Kroah-Hartman
commit 1d00e3d9b7ed8fbf6729b7c5a8aae9f2711d2655
Author: Daniel Bristot de Oliveira
Date: Mon May 29 16:24:03 2017 +0200
sched/deadline: Use the revised wakeup rule for suspending constrained dl tasks
commit 3effcb4247e74a51f5d8b775a1ee4abf87cc089a upstream.
We have been facing some problems with self-suspending constrained
deadline tasks. The main reason is that the original CBS was not
designed for such sort of tasks.
One problem reported by Xunlei Pang takes place when a task
suspends, and then is awakened before the deadline, but so close
to the deadline that its remaining runtime can cause the task
to have an absolute density higher than allowed. In such situation,
the original CBS assumes that the task is facing an early activation,
and so it replenishes the task and set another deadline, one deadline
in the future. This rule works fine for implicit deadline tasks.
Moreover, it allows the system to adapt the period of a task in which
the external event source suffered from a clock drift.
However, this opens the window for bandwidth leakage for constrained
deadline tasks. For instance, a task with the following parameters:
runtime = 5 ms
deadline = 7 ms
[density] = 5 / 7 = 0.71
period = 1000 ms
If the task runs for 1 ms, and then suspends for another 1ms,
it will be awakened with the following parameters:
remaining runtime = 4
laxity = 5
presenting a absolute density of 4 / 5 = 0.80.
In this case, the original CBS would assume the task had an early
wakeup. Then, CBS will reset the runtime, and the absolute deadline will
be postponed by one relative deadline, allowing the task to run.
The problem is that, if the task runs this pattern forever, it will keep
receiving bandwidth, being able to run 1ms every 2ms. Following this
behavior, the task would be able to run 500 ms in 1 sec. Thus running
more than the 5 ms / 1 sec the admission control allowed it to run.
Trying to address the self-suspending case, Luca Abeni, Giuseppe
Lipari, and Juri Lelli [1] revisited the CBS in order to deal with
self-suspending tasks. In the new approach, rather than
replenishing/postponing the absolute deadline, the revised wakeup rule
adjusts the remaining runtime, reducing it to fit into the allowed
density.
A revised version of the idea is:
At a given time t, the maximum absolute density of a task cannot be
higher than its relative density, that is:
runtime / (deadline - t) <= dl\_runtime / dl\_deadline
Knowing the laxity of a task (deadline - t), it is possible to move
it to the other side of the equality, thus enabling to define max
remaining runtime a task can use within the absolute deadline, without
over-running the allowed density:
runtime = (dl\_runtime / dl\_deadline) \* (deadline - t)
For instance, in our previous example, the task could still run:
runtime = ( 5 / 7 ) \* 5
runtime = 3.57 ms
Without causing damage for other deadline tasks. It is note worthy
that the laxity cannot be negative because that would cause a negative
runtime. Thus, this patch depends on the patch:
df8eac8cafce ("sched/deadline: Throttle a constrained deadline task activated after the deadline")
Which throttles a constrained deadline task activated after the
deadline.
Finally, it is also possible to use the revised wakeup rule for
all other tasks, but that would require some more discussions
about pros and cons.
[The main difference from the original commit is that
the BW\_SHIFT define was not present yet. As BW\_SHIFT was
introduced in a new feature, I just used the value (20),
likewise we used to use before the #define.
Other changes were required because of comments. - bistrot]
Reported-by: Xunlei Pang
Signed-off-by: Daniel Bristot de Oliveira
[peterz: replaced dl\_is\_constrained with dl\_is\_implicit]
Signed-off-by: Peter Zijlstra (Intel)
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/5c800ab3a74a168a84ee5f3f84d12a02e11383be.1495803804.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Greg Kroah-Hartman
commit 18bb117d1b7690181346e6365c6237b6ceaac4c4
Author: David Woodhouse
Date: Fri Jan 12 17:49:25 2018 +0000
x86/retpoline: Fill RSB on context switch for affected CPUs
commit c995efd5a740d9cbafbf58bde4973e8b50b4d761 upstream.
On context switch from a shallow call stack to a deeper one, as the CPU
does 'ret' up the deeper side it may encounter RSB entries (predictions for
where the 'ret' goes to) which were populated in userspace.
This is problematic if neither SMEP nor KPTI (the latter of which marks
userspace pages as NX for the kernel) are active, as malicious code in
userspace may then be executed speculatively.
Overwrite the CPU's return prediction stack with calls which are predicted
to return to an infinite loop, to "capture" speculation if this
happens. This is required both for retpoline, and also in conjunction with
IBRS for !SMEP && !KPTI.
On Skylake+ the problem is slightly different, and an \*underflow\* of the
RSB may cause errant branch predictions to occur. So there it's not so much
overwrite, as \*filling\* the RSB to attempt to prevent it getting
empty. This is only a partial solution for Skylake+ since there are many
other conditions which may result in the RSB becoming empty. The full
solution on Skylake+ is to use IBRS, which will prevent the problem even
when the RSB becomes empty. With IBRS, the RSB-stuffing will not be
required on context switch.
[ tglx: Added missing vendor check and slighty massaged comments and
changelog ]
[js] backport to 4.4 -- \_\_switch\_to\_asm does not exist there, we
have to patch the switch\_to macros for both x86\_32 and x86\_64.
Signed-off-by: David Woodhouse
Signed-off-by: Thomas Gleixner
Acked-by: Arjan van de Ven
Cc: gnomes@lxorguk.ukuu.org.uk
Cc: Rik van Riel
Cc: Andi Kleen
Cc: Josh Poimboeuf
Cc: thomas.lendacky@amd.com
Cc: Peter Zijlstra
Cc: Linus Torvalds
Cc: Jiri Kosina
Cc: Andy Lutomirski
Cc: Dave Hansen
Cc: Kees Cook
Cc: Tim Chen
Cc: Greg Kroah-Hartman
Cc: Paul Turner
Link: https://lkml.kernel.org/r/1515779365-9032-1-git-send-email-dwmw@amazon.co.uk
Signed-off-by: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit 0dfd5fbcae5d40e5e58bc7c34305498e965bf1ef
Author: Dave Hansen
Date: Thu Jun 2 17:19:27 2016 -0700
x86/cpu/intel: Introduce macros for Intel family numbers
commit 970442c599b22ccd644ebfe94d1d303bf6f87c05 upstream.
Problem:
We have a boatload of open-coded family-6 model numbers. Half of
them have these model numbers in hex and the other half in
decimal. This makes grepping for them tons of fun, if you were
to try.
Solution:
Consolidate all the magic numbers. Put all the definitions in
one header.
The names here are closely derived from the comments describing
the models from arch/x86/events/intel/core.c. We could easily
make them shorter by doing things like s/SANDYBRIDGE/SNB/, but
they seemed fine even with the longer versions to me.
Do not take any of these names too literally, like "DESKTOP"
or "MOBILE". These are all colloquial names and not precise
descriptions of everywhere a given model will show up.
Signed-off-by: Dave Hansen
Cc: Adrian Hunter
Cc: Andy Lutomirski
Cc: Andy Lutomirski
Cc: Borislav Petkov
Cc: Brian Gerst
Cc: Darren Hart
Cc: Dave Hansen
Cc: Denys Vlasenko
Cc: Doug Thompson
Cc: Eduardo Valentin
Cc: H. Peter Anvin
Cc: Jacob Pan
Cc: Kan Liang
Cc: Len Brown
Cc: Linus Torvalds
Cc: Mauro Carvalho Chehab
Cc: Peter Zijlstra
Cc: Rafael J. Wysocki
Cc: Rajneesh Bhardwaj
Cc: Souvik Kumar Chakravarty
Cc: Srinivas Pandruvada
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Tony Luck
Cc: Ulf Hansson
Cc: Viresh Kumar
Cc: Vishwanath Somayaji
Cc: Zhang Rui
Cc: jacob.jun.pan@intel.com
Cc: linux-acpi@vger.kernel.org
Cc: linux-edac@vger.kernel.org
Cc: linux-mmc@vger.kernel.org
Cc: linux-pm@vger.kernel.org
Cc: platform-driver-x86@vger.kernel.org
Link: http://lkml.kernel.org/r/20160603001927.F2A7D828@viggo.jf.intel.com
Signed-off-by: Ingo Molnar
Cc: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit 20e3fa5dd5818b425b18528571e133034833df27
Author: Ben Hutchings
Date: Wed Jan 24 02:31:19 2018 +0000
x86/microcode/intel: Fix BDW late-loading revision check
The backport of commit b94b73733171 ("x86/microcode/intel: Extend BDW
late-loading with a revision check") to 4.4-stable deleted a "return true"
statement. This bug is not present upstream or other stable branches.
Signed-off-by: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 579a9885cfe40645bc62207f318d172c4cad7942
Author: Jonathan Dieter
Date: Mon Feb 27 10:31:03 2017 +0200
usbip: Fix potential format overflow in userspace tools
commit e5dfa3f902b9a642ae8c6997d57d7c41e384a90b upstream.
The usbip userspace tools call sprintf()/snprintf() and don't check for
the return value which can lead the paths to overflow, truncating the
final file in the path.
More urgently, GCC 7 now warns that these aren't checked with
-Wformat-overflow, and with -Werror enabled in configure.ac, that makes
these tools unbuildable.
This patch fixes these problems by replacing sprintf() with snprintf() in
one place and adding checks for the return value of snprintf().
Reviewed-by: Peter Senna Tschudin
Signed-off-by: Jonathan Dieter
Acked-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 4493f49816acc5531ed31ffc600073330393cc61
Author: Jonathan Dieter
Date: Mon Feb 27 10:31:04 2017 +0200
usbip: Fix implicit fallthrough warning
commit cfd6ed4537a9e938fa76facecd4b9cd65b6d1563 upstream.
GCC 7 now warns when switch statements fall through implicitly, and with
-Werror enabled in configure.ac, that makes these tools unbuildable.
We fix this by notifying the compiler that this particular case statement
is meant to fall through.
Reviewed-by: Peter Senna Tschudin
Signed-off-by: Jonathan Dieter
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 28f467e0bdda754aa36390fd90b01823f0d3b18d
Author: Shuah Khan
Date: Thu Dec 7 14:16:49 2017 -0700
usbip: prevent vhci\_hcd driver from leaking a socket pointer address
commit 2f2d0088eb93db5c649d2a5e34a3800a8a935fc5 upstream.
When a client has a USB device attached over IP, the vhci\_hcd driver is
locally leaking a socket pointer address via the
/sys/devices/platform/vhci\_hcd/status file (world-readable) and in debug
output when "usbip --debug port" is run.
Fix it to not leak. The socket pointer address is not used at the moment
and it was made visible as a convenient way to find IP address from socket
pointer address by looking up /proc/net/{tcp,tcp6}.
As this opens a security hole, the fix replaces socket pointer address with
sockfd.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 8bb0c6a1b3b2fe92707ee6f6901bfdfc392f8cd1
Author: Andy Lutomirski
Date: Fri Dec 9 10:24:05 2016 -0800
x86/asm/32: Make sync\_core() handle missing CPUID on all 32-bit kernels
commit 1c52d859cb2d417e7216d3e56bb7fea88444cec9 upstream.
We support various non-Intel CPUs that don't have the CPUID
instruction, so the M486 test was wrong. For now, fix it with a big
hammer: handle missing CPUID on all 32-bit CPUs.
Reported-by: One Thousand Gnomes
Signed-off-by: Andy Lutomirski
Cc: Juergen Gross
Cc: Peter Zijlstra
Cc: Brian Gerst
Cc: Matthew Whitehead
Cc: Borislav Petkov
Cc: Henrique de Moraes Holschuh
Cc: Andrew Cooper
Cc: Boris Ostrovsky
Cc: xen-devel
Link: http://lkml.kernel.org/r/685bd083a7c036f7769510b6846315b17d6ba71f.1481307769.git.luto@kernel.org
Signed-off-by: Thomas Gleixner
Cc: "Zhang, Ning A"
Signed-off-by: Greg Kroah-Hartman


=== Content from cdn.kernel.org_ad93f7ac_20250125_181642.html ===
commit b632d710149f1a638ffa6e999cfbd9ee9fbdada6
Author: Greg Kroah-Hartman
Date: Wed Dec 20 10:07:34 2017 +0100
Linux 4.9.71
commit ed70a2212526bb26b5850f538b5a53793fdd4abf
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f23eb16afd8f230f15ee020159469275adabd15
Author: Matteo Croce
Date: Thu Oct 12 16:12:37 2017 +0200
icmp: don't fail on fragment reassembly time exceeded
[ Upstream commit 258bbb1b0e594ad5f5652cb526b3c63e6a7fad3d ]
The ICMP implementation currently replies to an ICMP time exceeded message
(type 11) with an ICMP host unreachable message (type 3, code 1).
However, time exceeded messages can either represent "time to live exceeded
in transit" (code 0) or "fragment reassembly time exceeded" (code 1).
Unconditionally replying to "fragment reassembly time exceeded" with
host unreachable messages might cause unjustified connection resets
which are now easily triggered as UFO has been removed, because, in turn,
sending large buffers triggers IP fragmentation.
The issue can be easily reproduced by running a lot of UDP streams
which is likely to trigger IP fragmentation:
# start netserver in the test namespace
ip netns add test
ip netns exec test netserver
# create a VETH pair
ip link add name veth0 type veth peer name veth0 netns test
ip link set veth0 up
ip -n test link set veth0 up
for i in $(seq 20 29); do
# assign addresses to both ends
ip addr add dev veth0 192.168.$i.1/24
ip -n test addr add dev veth0 192.168.$i.2/24
# start the traffic
netperf -L 192.168.$i.1 -H 192.168.$i.2 -t UDP\_STREAM -l 0 &
done
# wait
send\_data: data send error: No route to host (errno 113)
netperf: send\_omni: send\_data failed: No route to host
We need to differentiate instead: if fragment reassembly time exceeded
is reported, we need to silently drop the packet,
if time to live exceeded is reported, maintain the current behaviour.
In both cases increment the related error count "icmpInTimeExcds".
While at it, fix a typo in a comment, and convert the if statement
into a switch to mate it more readable.
Signed-off-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2eb165b9fbb722416252c054ac2ef2c3eb777460
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0c70b35bf1583fa5fc9134b87d32cf0bc27d5023
Author: Bart Van Assche
Date: Wed Oct 11 10:48:45 2017 -0700
RDMA/cma: Avoid triggering undefined behavior
[ Upstream commit c0b64f58e8d49570aa9ee55d880f92c20ff0166b ]
According to the C standard the behavior of computations with
integer operands is as follows:
\* A computation involving unsigned operands can never overflow,
because a result that cannot be represented by the resulting
unsigned integer type is reduced modulo the number that is one
greater than the largest value that can be represented by the
resulting type.
\* The behavior for signed integer underflow and overflow is
undefined.
Hence only use unsigned integers when checking for integer
overflow.
This patch is what I came up with after having analyzed the
following smatch warnings:
drivers/infiniband/core/cma.c:3448: cma\_resolve\_ib\_udp() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
drivers/infiniband/core/cma.c:3505: cma\_connect\_ib() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
Signed-off-by: Bart Van Assche
Acked-by: Sean Hefty
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 31eb4108e107aefc9cd5d662b3624533327848fd
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b64ab3ca9d31162cbdbd8acc2d5b68cf37302527
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 91e0cf85caea7f977361f662941100821370d74e
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 64da4e8d00f16bc7db25f6d819c4beac2656a90f
Author: weiping zhang
Date: Thu Oct 12 14:56:44 2017 +0800
scsi: sd: change allow\_restart to bool in sysfs interface
[ Upstream commit 658e9a6dc1126f21fa417cd213e1cdbff8be0ba2 ]
/sys/class/scsi\_disk/0:2:0:0/allow\_restart can be changed to 0
unexpectedly by writing an invalid string such as the following:
echo asdf > /sys/class/scsi\_disk/0:2:0:0/allow\_restart
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1cafdac8919136bd2ee6e0f607c49aacb9bb854b
Author: weiping zhang
Date: Thu Oct 12 14:57:06 2017 +0800
scsi: sd: change manage\_start\_stop to bool in sysfs interface
[ Upstream commit 623401ee33e42cee64d333877892be8db02951eb ]
/sys/class/scsi\_disk/0:2:0:0/manage\_start\_stop can be changed to 0
unexpectly by writing an invalid string.
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8315bcf841ae26d266dbaecd8a47956632478799
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:07 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_disassoc\_cmd
[ Upstream commit 08880f8e08cbd814e870e9d3ab9530abc1bce226 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_set\_802\_11\_bssid(acquire the spinlock)
rtw\_disassoc\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6641d3e307f5b42237a99f2aa961051a71c50393
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:45 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_createbss\_cmd
[ Upstream commit 2bf9806d4228f7a6195f8e03eda0479d2a93b411 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_surveydone\_event\_callback(acquire the spinlock)
rtw\_createbss\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28e006e14ff9b2fe55078c02bb92212b09664517
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 04d5a2d5d2d079ce5966d7e67324c9c4f648c951
Author: Parav Pandit
Date: Mon Oct 16 08:45:16 2017 +0300
IB/core: Fix calculation of maximum RoCE MTU
[ Upstream commit 99260132fde7bddc6e0132ce53da94d1c9ccabcb ]
The original code only took into consideration the largest header
possible after the IB\_BTH\_BYTES. This was incorrect, as the largest
possible header size is the largest possible combination of headers we
might run into. The new code accounts for all possible headers in the
largest possible combination and subtracts that from the MTU to make
sure that all packets will fit on the wire.
Link: https://www.spinics.net/lists/linux-rdma/msg54558.html
Fixes: 3c86aa70bf67 ("RDMA/cm: Add RDMA CM support for IBoE devices")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Reported-by: Roland Dreier
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c744ecec01ae6a92541c381d3548f8753aa50ba2
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f39486bd37ee3edd8658aff1226337c47e4ba32e
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4fdb10391bcafe698f06dd105b0d829744eb1926
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit afeeff4d6156b4965af9cf30ba05b05f04b9c7b0
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
commit bd3486ded7a0c313a6575343e6c2b21d14476645 upstream.
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit 92ad6c13e17ebea6175b978dc0f5b485e7e68cf1
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 421910e924b63f2ccd4d433c77c5cd88063546ba
Author: Matthias Brugger
Date: Sat Oct 21 10:17:47 2017 +0200
soc: mediatek: pwrap: fix compiler errors
[ Upstream commit fb2c1934f30577756e55e24e8870b45c78da3bc2 ]
When compiling using sparse, we got the following error:
drivers/soc/mediatek/mtk-pmic-wrap.c:686:25: error: dubious one-bit signed bitfield
Changing the data type to unsigned fixes this.
Signed-off-by: Matthias Brugger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7745382fe86ce5354dc459948c086d3b5778fb9d
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ab9d2571149322120efcf3d6ce9c24003c946ca1
Author: Martin Wilck
Date: Fri Oct 20 16:51:08 2017 -0500
scsi: hpsa: destroy sas transport properties before scsi\_host
[ Upstream commit dfb2e6f46b3074eb85203d8f0888b71ec1c2e37a ]
This patch cleans up a lot of warnings when unloading the driver.
A current example of the stack trace starts with:
[ 142.570715] sysfs group 'power' not found for kobject 'port-5:0'
There can be hundreds of these messages during a driver unload.
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
His original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102085.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
---------------------------
Original patch description:
---------------------------
Unloading the hpsa driver causes warnings
[ 1063.793652] WARNING: CPU: 1 PID: 4850 at ../fs/sysfs/group.c:237 device\_del+0x54/0x240()
[ 1063.793659] sysfs group ffffffff81cf21a0 not found for kobject 'port-2:0'
with two different stacks:
1)
[ 1063.793774] [] device\_del+0x54/0x240
[ 1063.793780] [] transport\_remove\_classdev+0x4a/0x60
[ 1063.793784] [] attribute\_container\_device\_trigger+0xa6/0xb0
[ 1063.793802] [] sas\_port\_delete+0x126/0x160 [scsi\_transport\_sas]
[ 1063.793819] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
2)
[ 1063.797103] [] device\_del+0x54/0x240
[ 1063.797118] [] sas\_port\_delete+0x12e/0x160 [scsi\_transport\_sas]
[ 1063.797134] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
This is caused by the fact that host device hostX is deleted before the
SAS transport devices hostX/port-a:b.
This patch fixes this by reverting the order of device deletions.
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1723d6668df5107c6026cbbf7afd2c615d74e006
Author: Martin Wilck
Date: Fri Oct 20 16:51:14 2017 -0500
scsi: hpsa: cleanup sas\_phy structures in sysfs when unloading
[ Upstream commit 55ca38b4255bb336c2d35990bdb2b368e19b435a ]
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
The original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102083.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
--------------------------------------
Original patch description from Martin:
--------------------------------------
When the hpsa module is unloaded using rmmod, dangling
symlinks remain under /sys/class/sas\_phy. Fix this by
calling sas\_phy\_delete() rather than sas\_phy\_free (which,
according to comments, should not be called for PHYs that
have been set up successfully, anyway).
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 237e053346f1b049ca9f571040c51c61f0740766
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f84f861f99c44f03f5ed57b40e3bfe951cbae3a
Author: Leon Romanovsky
Date: Wed Oct 25 07:41:11 2017 +0300
RDMA/cxgb4: Declare stag as \_\_be32
[ Upstream commit 35fb2a88ed4b77356fa679a8525c869a3594e287 ]
The scqe.stag is actually \_\_b32, fix it.
drivers/infiniband/hw/cxgb4/cq.c:754:52: warning: cast to restricted \_\_be32
Cc: Steve Wise
Signed-off-by: Leon Romanovsky
Reviewed-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 769bca9339f0775aa2985d4cae9be0e0d72092af
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c82209949bba864177300a681e0c736f982c87ab
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fc4177eacfa6e95a243402790b362736879f1cfd
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6a559523ee6626d191be1da9031845c368e4a6a9
Author: Christoph Hellwig
Date: Wed Oct 18 13:20:01 2017 +0200
nvme: use kref\_get\_unless\_zero in nvme\_find\_get\_ns
[ Upstream commit 2dd4122854f697afc777582d18548dded03ce5dd ]
For kref\_get\_unless\_zero to protect against lookup vs free races we need
to use it in all places where we aren't guaranteed to already hold a
reference. There is no such guarantee in nvme\_find\_get\_ns, so switch to
kref\_get\_unless\_zero in this function.
Signed-off-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Reviewed-by: Hannes Reinecke
Reviewed-by: Johannes Thumshirn
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e2fce5a5578d175cd61822473228ab454782bec7
Author: Osama Khan
Date: Sat Oct 21 10:42:21 2017 +0000
platform/x86: hp\_accel: Add quirk for HP ProBook 440 G4
[ Upstream commit 163ca80013aafb6dc9cb295de3db7aeab9ab43f8 ]
Added support for HP ProBook 440 G4 laptops by including the accelerometer
orientation quirk for that device. Testing was performed based on the
axis orientation guidelines here:
https://www.kernel.org/doc/Documentation/misc-devices/lis3lv02d
which states "If the left side is elevated, X increases (becomes positive)".
When tested, on lifting the left edge, x values became increasingly negative
thus indicating an inverted x-axis on the installed lis3lv02d chip.
This was compensated by adding an entry for this device in hp\_accel.c
specifying the quirk as x\_inverted. The patch was tested on a
ProBook 440 G4 device and x-axis as well as y and z-axis values are now
generated as per spec.
Signed-off-by: Osama Khan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7fab68e1f7308b2b7e3ebdd2483eb7a9572ccec5
Author: Christophe JAILLET
Date: Sun Sep 10 13:19:38 2017 +0200
btrfs: tests: Fix a memory leak in error handling path in 'run\_test()'
[ Upstream commit 9ca2e97fa3c3216200afe35a3b111ec51cc796d2 ]
If 'btrfs\_alloc\_path()' fails, we must free the resources already
allocated, as done in the other error handling paths in this function.
Signed-off-by: Christophe JAILLET
Reviewed-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b7ada2c0ea291e7bf22b51745afd9f1ccfc91292
Author: Nick Desaulniers
Date: Fri Oct 27 09:33:41 2017 -0700
arm64: prevent regressions in compressed kernel image size when upgrading to binutils 2.27
[ Upstream commit fd9dde6abcb9bfe6c6bee48834e157999f113971 ]
Upon upgrading to binutils 2.27, we found that our lz4 and gzip
compressed kernel images were significantly larger, resulting is 10ms
boot time regressions.
As noted by Rahul:
"aarch64 binaries uses RELA relocations, where each relocation entry
includes an addend value. This is similar to x86\_64. On x86\_64, the
addend values are also stored at the relocation offset for relative
relocations. This is an optimization: in the case where code does not
need to be relocated, the loader can simply skip processing relative
relocations. In binutils-2.25, both bfd and gold linkers did this for
x86\_64, but only the gold linker did this for aarch64. The kernel build
here is using the bfd linker, which stored zeroes at the relocation
offsets for relative relocations. Since a set of zeroes compresses
better than a set of non-zero addend values, this behavior was resulting
in much better lz4 compression.
The bfd linker in binutils-2.27 is now storing the actual addend values
at the relocation offsets. The behavior is now consistent with what it
does for x86\_64 and what gold linker does for both architectures. The
change happened in this upstream commit:
https://sourceware.org/git/?p=binutils-gdb.git;a=commit;h=1f56df9d0d5ad89806c24e71f296576d82344613
Since a bunch of zeroes got replaced by non-zero addend values, we see
the side effect of lz4 compressed image being a bit bigger.
To get the old behavior from the bfd linker, "--no-apply-dynamic-relocs"
flag can be used:
$ LDFLAGS="--no-apply-dynamic-relocs" make
With this flag, the compressed image size is back to what it was with
binutils-2.25.
If the kernel is using ASLR, there aren't additional runtime costs to
--no-apply-dynamic-relocs, as the relocations will need to be applied
again anyway after the kernel is relocated to a random address.
If the kernel is not using ASLR, then presumably the current default
behavior of the linker is better. Since the static linker performed the
dynamic relocs, and the kernel is not moved to a different address at
load time, it can skip applying the relocations all over again."
Some measurements:
$ ld -v
GNU ld (binutils-2.25-f3d35cf6) 2.25.51.20141117
^
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300652760 Oct 26 11:57 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932627 Oct 26 11:57 Image.lz4-dtb
$ ld -v
GNU ld (binutils-2.27-53dd00a1) 2.27.0.20170315
^
pre patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 11:43 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 18159474 Oct 26 11:43 Image.lz4-dtb
post patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 12:06 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932466 Oct 26 12:06 Image.lz4-dtb
By Siqi's measurement w/ gzip:
binutils 2.27 with this patch (with --no-apply-dynamic-relocs):
Image 41535488
Image.gz 13404067
binutils 2.27 without this patch (without --no-apply-dynamic-relocs):
Image 41535488
Image.gz 14125516
Any compression scheme should be able to get better results from the
longer runs of zeros, not just GZIP and LZ4.
10ms boot time savings isn't anything to get excited about, but users of
arm64+compression+bfd-2.27 should not have to pay a penalty for no
runtime improvement.
Reported-by: Gopinath Elanchezhian
Reported-by: Sindhuri Pentyala
Reported-by: Wei Wang
Suggested-by: Ard Biesheuvel
Suggested-by: Rahul Chaudhry
Suggested-by: Siqi Lin
Suggested-by: Stephen Hines
Signed-off-by: Nick Desaulniers
Reviewed-by: Ard Biesheuvel
[will: added comment to Makefile]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 52aaa748a948a1bd50fa2ef0d2b9ffad11b0e672
Author: Patel Jay P
Date: Mon Oct 23 06:05:53 2017 -0700
Ib/hfi1: Return actual operational VLs in port info query
[ Upstream commit 00f9203119dd2774564407c7a67b17d81916298b ]
\_\_subn\_get\_opa\_portinfo stores value returned by hfi1\_get\_ib\_cfg() as
operational vls. hfi1\_get\_ib\_cfg() returns vls\_operational field in
hfi1\_pportdata. The problem with this is that the value is always equal
to vls\_supported field in hfi1\_pportdata.
The logic to calculate operational\_vls is to set value passed by FM
(in \_\_subn\_set\_opa\_portinfo routine). If no value is passed then
default value is stored in operational\_vls.
Field actual\_vls\_operational is calculated on the basis of buffer
control table. Hence, modifying hfi1\_get\_ib\_cfg() to return
actual\_operational\_vls when used with HFI1\_IB\_CFG\_OP\_VLS parameter
Reviewed-by: Mike Marciniszyn
Reviewed-by: Dennis Dalessandro
Signed-off-by: Patel Jay P
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9102ed6a5f6a53434f69264ac8457994fde14a88
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c2a0531f59c363fd5b50be46b97248091b13484b
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 75f66eeae657688f1e600214ae297422834d3c43
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 026ffaf65879b3ecc12ffa9c45dfa5894370bd60
Author: Douglas Gilbert
Date: Sun Oct 29 10:47:19 2017 -0400
scsi: scsi\_debug: write\_same: fix error report
[ Upstream commit e33d7c56450b0a5c7290cbf9e1581fab5174f552 ]
The scsi\_debug driver incorrectly suggests there is an error with the
SCSI WRITE SAME command when the number\_of\_logical\_blocks is greater
than 1. It will also suggest there is an error when NDOB
(no data-out buffer) is set and the number\_of\_logical\_blocks is
greater than 0. Both are valid, fix.
Signed-off-by: Douglas Gilbert
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d8914530f247900885850af7cccf81a2b33907b9
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 019433db872f9032cabd2a4a0fbd3df2bb14f539
Author: Kuninori Morimoto
Date: Wed Nov 1 07:16:58 2017 +0000
ASoC: rsnd: rsnd\_ssi\_run\_mods() needs to care ssi\_parent\_mod
[ Upstream commit 21781e87881f9c420871b1d1f3f29d4cd7bffb10 ]
SSI parent mod might be NULL. ssi\_parent\_mod() needs to care
about it. Otherwise, it uses negative shift.
This patch fixes it.
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cf16dac8bd9868cf22203ac498e8e997ad7b0ca1
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27f5597c98590cdd01f2c9bebbf36cb4bce28253
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 54809e38a6298fde41c0b72c2423f5d7c9e847fe
Author: Leo Yan
Date: Fri Sep 1 08:47:14 2017 +0800
clk: hi6220: mark clock cs\_atb\_syspll as critical
[ Upstream commit d2a3671ebe6479483a12f94fcca63c058d95ad64 ]
Clock cs\_atb\_syspll is pll used for coresight trace bus; when clock
cs\_atb\_syspll is disabled and operates its child clock node cs\_atb
results in system hang. So mark clock cs\_atb\_syspll as critical to
keep it enabled.
Cc: Guodong Xu
Cc: Zhangfei Gao
Cc: Haojian Zhuang
Signed-off-by: Leo Yan
Signed-off-by: Michael Turquette
Link: lkml.kernel.org/r/1504226835-2115-2-git-send-email-leo.yan@linaro.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 47b63ea40ee158fbd032047935cf8b4d388ccd24
Author: Sébastien Szymanski
Date: Tue Aug 1 12:40:07 2017 +0200
clk: imx6: refine hdmi\_isfr's parent to make HDMI work on i.MX6 SoCs w/o VPU
[ Upstream commit c68ee58d9ee7b856ac722f18f4f26579c8fbd2b4 ]
On i.MX6 SoCs without VPU (in my case MCIMX6D4AVT10AC), the hdmi driver
fails to probe:
[ 2.540030] dwhdmi-imx 120000.hdmi: Unsupported HDMI controller
(0000:00:00)
[ 2.548199] imx-drm display-subsystem: failed to bind 120000.hdmi
(ops dw\_hdmi\_imx\_ops): -19
[ 2.557403] imx-drm display-subsystem: master bind failed: -19
That's because hdmi\_isfr's parent, video\_27m, is not correctly ungated.
As explained in commit 5ccc248cc537 ("ARM: imx6q: clk: Add support for
mipi\_core\_cfg clock as a shared clock gate"), video\_27m is gated by
CCM\_CCGR3[CG8].
On i.MX6 SoCs with VPU, the hdmi is working thanks to the
CCM\_CMEOR[mod\_en\_ov\_vpu] bit which makes the video\_27m ungated whatever
is in CCM\_CCGR3[CG8]. The issue can be reproduced by setting
CCMEOR[mod\_en\_ov\_vpu] to 0.
Make the HDMI work in every case by setting hdmi\_isfr's parent to
mipi\_core\_cfg.
Signed-off-by: Sébastien Szymanski
Reviewed-by: Fabio Estevam
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d6b6302c36b5459f3f2fa8d5e978b3e25f7e2723
Author: Chen Zhong
Date: Thu Oct 5 11:50:23 2017 +0800
clk: mediatek: add the option for determining PLL source clock
[ Upstream commit c955bf3998efa3355790a4d8c82874582f1bc727 ]
Since the previous setup always sets the PLL using crystal 26MHz, this
doesn't always happen in every MediaTek platform. So the patch added
flexibility for assigning extra member for determining the PLL source
clock.
Signed-off-by: Chen Zhong
Signed-off-by: Sean Wang
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2850c3ec0d25a4f729bd7f2212e178c9303e697a
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18498f1c7089035faba2bc9ba64c5c96542ae0c4
Author: Robert Baronescu
Date: Tue Oct 10 13:22:00 2017 +0300
crypto: tcrypt - fix buffer lengths in test\_aead\_speed()
[ Upstream commit 7aacbfcb331ceff3ac43096d563a1f93ed46e35e ]
Fix the way the length of the buffers used for
encryption / decryption are computed.
For e.g. in case of encryption, input buffer does not contain
an authentication tag.
Signed-off-by: Robert Baronescu
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2ed46cbf23fc48ea63e3a3eaa820de5d54534cb6
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c843e9f8f97ff0d7c3a8232a314b20c1328ba697
Author: Eryu Guan
Date: Wed Nov 1 21:43:50 2017 -0700
xfs: truncate pagecache before writeback in xfs\_setattr\_size()
[ Upstream commit 350976ae21873b0d36584ea005076356431b8f79 ]
On truncate down, if new size is not block size aligned, we zero the
rest of block to avoid exposing stale data to user, and
iomap\_truncate\_page() skips zeroing if the range is already in
unwritten state or a hole. Then we writeback from on-disk i\_size to
the new size if this range hasn't been written to disk yet, and
truncate page cache beyond new EOF and set in-core i\_size.
The problem is that we could write data between di\_size and newsize
before removing the page cache beyond newsize, as the extents may
still be in unwritten state right after a buffer write. As such, the
page of data that newsize lies in has not been zeroed by page cache
invalidation before it is written, and xfs\_do\_writepage() hasn't
triggered it's "zero data beyond EOF" case because we haven't
updated in-core i\_size yet. Then a subsequent mmap read could see
non-zeros past EOF.
I occasionally see this in fsx runs in fstests generic/112, a
simplified fsx operation sequence is like (assuming 4k block size
xfs):
fallocate 0x0 0x1000 0x0 keep\_size
write 0x0 0x1000 0x0
truncate 0x0 0x800 0x1000
punch\_hole 0x0 0x800 0x800
mapread 0x0 0x800 0x800
where fallocate allocates unwritten extent but doesn't update
i\_size, buffer write populates the page cache and extent is still
unwritten, truncate skips zeroing page past new EOF and writes the
page to disk, punch\_hole invalidates the page cache, at last mapread
reads the block back and sees non-zero beyond EOF.
Fix it by moving truncate\_setsize() to before writeback so the page
cache invalidation zeros the partial page at the new EOF. This also
triggers "zero data beyond EOF" in xfs\_do\_writepage() at writeback
time, because newsize has been set and page straddles the newsize.
Also fixed the wrong 'end' param of filemap\_write\_and\_wait\_range()
call while we're at it, the 'end' is inclusive and should be
'newsize - 1'.
Suggested-by: Dave Chinner
Signed-off-by: Eryu Guan
Acked-by: Dave Chinner
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 03bfadfb0d7990bf558dabd6b26e4f06bc32c45b
Author: Gary R Hook
Date: Fri Nov 3 10:50:34 2017 -0600
iommu/amd: Limit the IOVA page range to the specified addresses
[ Upstream commit b92b4fb5c14257c0e7eae291ecc1f7b1962e1699 ]
The extent of pages specified when applying a reserved region should
include up to the last page of the range, but not the page following
the range.
Signed-off-by: Gary R Hook
Fixes: 8d54d6c8b8f3 ('iommu/amd: Implement apply\_dm\_region call-back')
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cb0acb37010c216e4781224ad4ab4c12ca9cb5fe
Author: Liu Bo
Date: Fri Nov 3 11:24:44 2017 -0600
badblocks: fix wrong return value in badblocks\_set if badblocks are disabled
[ Upstream commit 39b4954c0a1556f8f7f1fdcf59a227117fcd8a0b ]
MD's rdev\_set\_badblocks() expects that badblocks\_set() returns 1 if
badblocks are disabled, otherwise, rdev\_set\_badblocks() will record
superblock changes and return success in that case and md will fail to
report an IO error which it should.
This bug has existed since badblocks were introduced in commit
9e0e252a048b ("badblocks: Add core badblock management code").
Signed-off-by: Liu Bo
Acked-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dcdca123814c5303f0e4d0fba67756d35bb0fd1f
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 998201fdc5c9144a2dfaec8811a722c3c5e731d3
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a4f54ec403da9f5eafaba60d67ae8b2613a1bae5
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e086a82a926ace86fc14da0442437c2024d68001
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit abc4b4420af8d2d31fe38dddf998855f5cf9d8dc
Author: Kuppuswamy Sathyanarayanan
Date: Sun Oct 29 02:49:54 2017 -0700
platform/x86: intel\_punit\_ipc: Fix resource ioremap warning
[ Upstream commit 6cc8cbbc8868033f279b63e98b26b75eaa0006ab ]
For PUNIT device, ISPDRIVER\_IPC and GTDDRIVER\_IPC resources are not
mandatory. So when PMC IPC driver creates a PUNIT device, if these
resources are not available then it creates dummy resource entries for
these missing resources. But during PUNIT device probe, doing ioremap on
these dummy resources generates following warning messages.
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
This patch fixes this issue by adding extra check for resource size
before performing ioremap operation.
Signed-off-by: Kuppuswamy Sathyanarayanan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6e5a846d5172c5225bda764797a07c828b5b2650
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d7e7c431d62101505a6a0321986dba498252fd7f
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a463f9c5dfd1bb62f128e6883103117af6f3db1f
Author: KUWAZAWA Takuya
Date: Sun Oct 15 20:54:10 2017 +0900
netfilter: ipvs: Fix inappropriate output of procfs
[ Upstream commit c5504f724c86ee925e7ffb80aa342cfd57959b13 ]
Information about ipvs in different network namespace can be seen via procfs.
How to reproduce:
# ip netns add ns01
# ip netns add ns02
# ip netns exec ns01 ip a add dev lo 127.0.0.1/8
# ip netns exec ns02 ip a add dev lo 127.0.0.1/8
# ip netns exec ns01 ipvsadm -A -t 10.1.1.1:80
# ip netns exec ns02 ipvsadm -A -t 10.1.1.2:80
The ipvsadm displays information about its own network namespace only.
# ip netns exec ns01 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.1:80 wlc
# ip netns exec ns02 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.2:80 wlc
But I can see information about other network namespace via procfs.
# ip netns exec ns01 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010101:0050 wlc
TCP 0A010102:0050 wlc
# ip netns exec ns02 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010102:0050 wlc
Signed-off-by: KUWAZAWA Takuya
Acked-by: Julian Anastasov
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b3b6d1eea0de7115353a3706e5b0c3ff56be0663
Author: Matthias Brugger
Date: Mon Oct 30 12:37:55 2017 +0100
iommu/mediatek: Fix driver name
[ Upstream commit 395df08d2e1de238a9c8c33fdcd0e2160efd63a9 ]
There exist two Mediatek iommu drivers for the two different
generations of the device. But both drivers have the same name
"mtk-iommu". This breaks the registration of the second driver:
Error: Driver 'mtk-iommu' is already registered, aborting...
Fix this by changing the name for first generation to
"mtk-iommu-v1".
Fixes: b17336c55d89 ("iommu/mediatek: add support for mtk iommu generation one HW")
Signed-off-by: Matthias Brugger
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9a4bf05126f42c2632729ab0da503021d74ed454
Author: Mika Westerberg
Date: Fri Oct 13 21:35:43 2017 +0300
PCI: Do not allocate more buses than available in parent
[ Upstream commit a20c7f36bd3d20d245616ae223bb9d05dfb6f050 ]
One can ask more buses to be reserved for hotplug bridges by passing
pci=hpbussize=N in the kernel command line. If the parent bus does not
have enough bus space available we incorrectly create child bus with the
requested number of subordinate buses.
In the example below hpbussize is set to one more than we have available
buses in the root port:
pci 0000:07:00.0: [8086:1578] type 01 class 0x060400
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 0
pci 0000:07:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 1
pci\_bus 0000:08: busn\_res: can not insert [bus 08-ff] under [bus 07-3f] (conflicts with (null) [bus 07-3f])
pci\_bus 0000:08: scanning bus
...
pci\_bus 0000:0a: bus scan returning with max=40
pci\_bus 0000:0a: busn\_res: [bus 0a-ff] end is updated to 40
pci\_bus 0000:0a: [bus 0a-40] partially hidden behind bridge 0000:07 [bus 07-3f]
pci\_bus 0000:08: bus scan returning with max=40
pci\_bus 0000:08: busn\_res: [bus 08-ff] end is updated to 40
Instead of allowing this, limit the subordinate number to be less than or
equal the maximum subordinate number allocated for the parent bus (if it
has any).
Signed-off-by: Mika Westerberg
[bhelgaas: remove irrelevant dmesg messages]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 29a404be7b30237e0894057422407722d3f8bf45
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f44d28e0348dbb081784ab02be57954d75efa13e
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5a7192bc389ea5ac194d046d6a218b7431680a31
Author: Peter Ujfalusi
Date: Wed Nov 8 12:02:25 2017 +0200
dmaengine: ti-dma-crossbar: Correct am335x/am43xx mux value type
[ Upstream commit 288e7560e4d3e259aa28f8f58a8dfe63627a1bf6 ]
The used 0x1f mask is only valid for am335x family of SoC, different family
using this type of crossbar might have different number of electable
events. In case of am43xx family 0x3f mask should have been used for
example.
Instead of trying to handle each family's mask, just use u8 type to store
the mux value since the event offsets are aligned to byte offset.
Fixes: 42dbdcc6bf965 ("dmaengine: ti-dma-crossbar: Add support for crossbar on AM33xx/AM43xx")
Signed-off-by: Peter Ujfalusi
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 03a48dc96505f5b900e44d50e69ea3ee3686c279
Author: Pankaj Bharadiya
Date: Tue Nov 7 16:16:19 2017 +0530
ASoC: Intel: Skylake: Fix uuid\_module memory leak in failure case
[ Upstream commit f8e066521192c7debe59127d90abbe2773577e25 ]
In the loop that adds the uuid\_module to the uuid\_list list, allocated
memory is not properly freed in the error path free uuid\_list whenever
any of the memory allocation in the loop fails to avoid memory leak.
Signed-off-by: Pankaj Bharadiya
Signed-off-by: Guneshwor Singh
Acked-By: Vinod Koul
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9146b10f8cd64c2e467c8f98ccb19dcb15812e83
Author: Philipp Zabel
Date: Tue Nov 7 13:12:17 2017 +0100
rtc: pcf8563: fix output clock rate
[ Upstream commit a3350f9c57ffad569c40f7320b89da1f3061c5bb ]
The pcf8563\_clkout\_recalc\_rate function erroneously ignores the
frequency index read from the CLKO register and always returns
32768 Hz.
Fixes: a39a6405d5f9 ("rtc: pcf8563: add CLKOUT to common clock framework")
Signed-off-by: Philipp Zabel
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit cf53526f3312f972043d0c6fa745cfb9f777a0c9
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 90e2591f6f3fd15ac766ffbaed119f43f01fef33
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 92c3c7db8336f6678b31ee0d08ecf3bab81a80ff
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aecce5fc047a99c057931f08977ba6042bb931c4
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0312ab0f0e437cadb9eabef72a1e26a676d2dd64
Author: Robert Stonehouse
Date: Tue Nov 7 17:30:30 2017 +0000
sfc: don't warn on successful change of MAC
[ Upstream commit cbad52e92ad7f01f0be4ca58bde59462dc1afe3a ]
Fixes: 535a61777f44e ("sfc: suppress handled MCDI failures when changing the MAC address")
Signed-off-by: Bert Kenward
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da73389e8aa7975a46b9e85234fcbd7885d0eabd
Author: Sébastien Szymanski
Date: Fri Nov 10 10:01:43 2017 +0100
HID: cp2112: fix broken gpio\_direction\_input callback
[ Upstream commit 7da85fbf1c87d4f73621e0e7666a3387497075a9 ]
When everything goes smoothly, ret is set to 0 which makes the function
to return EIO error.
Fixes: 8e9faa15469e ("HID: cp2112: fix gpio-callback error handling")
Signed-off-by: Sébastien Szymanski
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e15628b293a7dad278d5bbf7d56a539858b0be8f
Author: Dou Liyang
Date: Fri Mar 3 16:02:23 2017 +0800
Revert "x86/acpi: Set persistent cpuid <-> nodeid mapping when booting"
[ Upstream commit c962cff17dfa11f4a8227ac16de2b28aea3312e4 ]
Revert: dc6db24d2476 ("x86/acpi: Set persistent cpuid <-> nodeid mapping when booting")
The mapping of "cpuid <-> nodeid" is established at boot time via ACPI
tables to keep associations of workqueues and other node related items
consistent across cpu hotplug.
But, ACPI tables are unreliable and failures with that boot time mapping
have been reported on machines where the ACPI table and the physical
information which is retrieved at actual hotplug is inconsistent.
Revert the mapping implementation so it can be replaced with a less error
prone approach.
Signed-off-by: Dou Liyang
Tested-by: Xiaolong Ye
Cc: rjw@rjwysocki.net
Cc: linux-acpi@vger.kernel.org
Cc: guzheng1@huawei.com
Cc: izumi.taku@jp.fujitsu.com
Cc: lenb@kernel.org
Link: http://lkml.kernel.org/r/1488528147-2279-2-git-send-email-douly.fnst@cn.fujitsu.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 25b0b3f2373d31d40151b0fbdf35c0035d332a61
Author: Mike Christie
Date: Thu Mar 2 04:59:50 2017 -0600
target: fix race during implicit transition work flushes
[ Upstream commit 760bf578edf8122f2503a3a6a3f4b0de3b6ce0bb ]
This fixes the following races:
1. core\_alua\_do\_transition\_tg\_pt could have read
tg\_pt\_gp\_alua\_access\_state and gone into this if chunk:
if (!explicit &&
atomic\_read(&tg\_pt\_gp->tg\_pt\_gp\_alua\_access\_state) ==
ALUA\_ACCESS\_STATE\_TRANSITION) {
and then core\_alua\_do\_transition\_tg\_pt\_work could update the
state. core\_alua\_do\_transition\_tg\_pt would then only set
tg\_pt\_gp\_alua\_pending\_state and the tg\_pt\_gp\_alua\_access\_state would
not get updated with the second calls state.
2. core\_alua\_do\_transition\_tg\_pt could be setting
tg\_pt\_gp\_transition\_complete while the tg\_pt\_gp\_transition\_work
is already completing. core\_alua\_do\_transition\_tg\_pt then waits on the
completion that will never be called.
To handle these issues, we just call flush\_work which will return when
core\_alua\_do\_transition\_tg\_pt\_work has completed so there is no need
to do the complete/wait. And, if core\_alua\_do\_transition\_tg\_pt\_work
was running, instead of trying to sneak in the state change, we just
schedule up another core\_alua\_do\_transition\_tg\_pt\_work call.
Note that this does not handle a possible race where there are multiple
threads call core\_alua\_do\_transition\_tg\_pt at the same time. I think
we need a mutex in target\_tg\_pt\_gp\_alua\_access\_state\_store.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 892e4f9bc2e218b0126bb4ae7191be366fb4b421
Author: Mike Christie
Date: Thu Mar 2 04:59:48 2017 -0600
target: fix ALUA transition timeout handling
[ Upstream commit d7175373f2745ed4abe5b388d5aabd06304f801e ]
The implicit transition time tells initiators the min time
to wait before timing out a transition. We currently schedule
the transition to occur in tg\_pt\_gp\_implicit\_trans\_secs
seconds so there is no room for delays. If
core\_alua\_do\_transition\_tg\_pt\_work->core\_alua\_update\_tpg\_primary\_metadata
needs to write out info to a remote file, then the initiator can
easily time out the operation.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0d34f4770ea11c92af2c6a15c73aaebc75ea94ed
Author: Mike Christie
Date: Wed Mar 1 23:13:26 2017 -0600
target: Use system workqueue for ALUA transitions
[ Upstream commit 207ee84133c00a8a2a5bdec94df4a5b37d78881c ]
If tcmu-runner is processing a STPG and needs to change the kernel's
ALUA state then we cannot use the same work queue for task management
requests and ALUA transitions, because we could deadlock. The problem
occurs when a STPG times out before tcmu-runner is able to
call into target\_tg\_pt\_gp\_alua\_access\_state\_store->
core\_alua\_do\_port\_transition -> core\_alua\_do\_transition\_tg\_pt ->
queue\_work. In this case, the tmr is on the work queue waiting for
the STPG to complete, but the STPG transition is now queued behind
the waiting tmr.
Note:
This bug will also be fixed by this patch:
http://www.spinics.net/lists/target-devel/msg14560.html
which switches the tmr code to use the system workqueues.
For both, I am not sure if we need a dedicated workqueue since
it is not a performance path and I do not think we need WQ\_MEM\_RECLAIM
to make forward progress to free up memory like the block layer does.
Signed-off-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8f60ef94477cb0dd3023b337640ea634886ac1d1
Author: Zygo Blaxell
Date: Fri Mar 10 16:45:44 2017 -0500
btrfs: add missing memset while reading compressed inline extents
[ Upstream commit e1699d2d7bf6e6cce3e1baff19f9dd4595a58664 ]
This is a story about 4 distinct (and very old) btrfs bugs.
Commit c8b978188c ("Btrfs: Add zlib compression support") added
three data corruption bugs for inline extents (bugs #1-3).
Commit 93c82d5750 ("Btrfs: zero page past end of inline file items")
fixed bug #1: uncompressed inline extents followed by a hole and more
extents could get non-zero data in the hole as they were read. The fix
was to add a memset in btrfs\_get\_extent to zero out the hole.
Commit 166ae5a418 ("btrfs: fix inline compressed read err corruption")
fixed bug #2: compressed inline extents which contained non-zero bytes
might be replaced with zero bytes in some cases. This patch removed an
unhelpful memset from uncompress\_inline, but the case where memset is
required was missed.
There is also a memset in the decompression code, but this only covers
decompressed data that is shorter than the ram\_bytes from the extent
ref record. This memset doesn't cover the region between the end of the
decompressed data and the end of the page. It has also moved around a
few times over the years, so there's no single patch to refer to.
This patch fixes bug #3: compressed inline extents followed by a hole
and more extents could get non-zero data in the hole as they were read
(i.e. bug #3 is the same as bug #1, but s/uncompressed/compressed/).
The fix is the same: zero out the hole in the compressed case too,
by putting a memset back in uncompress\_inline, but this time with
correct parameters.
The last and oldest bug, bug #0, is the cause of the offending inline
extent/hole/extent pattern. Bug #0 is a subtle and mostly-harmless quirk
of behavior somewhere in the btrfs write code. In a few special cases,
an inline extent and hole are allowed to persist where they normally
would be combined with later extents in the file.
A fast reproducer for bug #0 is presented below. A few offending extents
are also created in the wild during large rsync transfers with the -S
flag. A Linux kernel build (git checkout; make allyesconfig; make -j8)
will produce a handful of offending files as well. Once an offending
file is created, it can present different content to userspace each
time it is read.
Bug #0 is at least 4 and possibly 8 years old. I verified every vX.Y
kernel back to v3.5 has this behavior. There are fossil records of this
bug's effects in commits all the way back to v2.6.32. I have no reason
to believe bug #0 wasn't present at the beginning of btrfs compression
support in v2.6.29, but I can't easily test kernels that old to be sure.
It is not clear whether bug #0 is worth fixing. A fix would likely
require injecting extra reads into currently write-only paths, and most
of the exceptional cases caused by bug #0 are already handled now.
Whether we like them or not, bug #0's inline extents followed by holes
are part of the btrfs de-facto disk format now, and we need to be able
to read them without data corruption or an infoleak. So enough about
bug #0, let's get back to bug #3 (this patch).
An example of on-disk structure leading to data corruption found in
the wild:
item 61 key (606890 INODE\_ITEM 0) itemoff 9662 itemsize 160
inode generation 50 transid 50 size 47424 nbytes 49141
block group 0 mode 100644 links 1 uid 0 gid 0
rdev 0 flags 0x0(none)
item 62 key (606890 INODE\_REF 603050) itemoff 9642 itemsize 20
inode ref index 3 namelen 10 name: DB\_File.so
item 63 key (606890 EXTENT\_DATA 0) itemoff 8280 itemsize 1362
inline extent data size 1341 ram 4085 compress(zlib)
item 64 key (606890 EXTENT\_DATA 4096) itemoff 8227 itemsize 53
extent data disk byte 5367308288 nr 20480
extent data offset 0 nr 45056 ram 45056
extent compression(zlib)
Different data appears in userspace during each read of the 11 bytes
between 4085 and 4096. The extent in item 63 is not long enough to
fill the first page of the file, so a memset is required to fill the
space between item 63 (ending at 4085) and item 64 (beginning at 4096)
with zero.
Here is a reproducer from Liu Bo, which demonstrates another method
of creating the same inline extent and hole pattern:
Using 'page\_poison=on' kernel command line (or enable
CONFIG\_PAGE\_POISONING) run the following:
# touch foo
# chattr +c foo
# xfs\_io -f -c "pwrite -W 0 1000" foo
# xfs\_io -f -c "falloc 4 8188" foo
# od -x foo
# echo 3 >/proc/sys/vm/drop\_caches
# od -x foo
This produce the following on my box:
Correct output: file contains 1000 data bytes followed
by zeros:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 0000 0000 0000 0000
0001760 0000 0000 0000 0000 0000 0000 0000 0000
\*
0020000
Actual output: the data after the first 1000 bytes
will be different each run:
0000000 cdcd cdcd cdcd cdcd cdcd cdcd cdcd cdcd
\*
0001740 cdcd cdcd cdcd cdcd 6c63 7400 635f 006d
0001760 5f74 6f43 7400 435f 0053 5f74 7363 7400
0002000 435f 0056 5f74 6164 7400 645f 0062 5f74
(...)
Signed-off-by: Zygo Blaxell
Reviewed-by: Liu Bo
Reviewed-by: Chris Mason
Signed-off-by: Chris Mason
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5d460d359abefe59e1cac738d37296f3cd4bc1f8
Author: Olga Kornievskaia
Date: Wed Mar 8 14:39:15 2017 -0500
NFSv4.1 respect server's max size in CREATE\_SESSION
[ Upstream commit 033853325fe3bdc70819a8b97915bd3bca41d3af ]
Currently client doesn't respect max sizes server returns in CREATE\_SESSION.
nfs4\_session\_set\_rwsize() gets called and server->rsize, server->wsize are 0
so they never get set to the sizes returned by the server.
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 88af4e34771c88a09ed722bbf4346a2ddfee6dbe
Author: Daniel Drake
Date: Tue Feb 7 13:08:23 2017 -0600
efi/esrt: Cleanup bad memory map log messages
[ Upstream commit 822f5845f710e57d7e2df1fd1ee00d6e19d334fe ]
The Intel Compute Stick STCK1A8LFC and Weibu F3C platforms both
log 2 error messages during boot:
efi: requested map not found.
esrt: ESRT header is not in the memory map.
Searching the web, this seems to affect many other platforms too.
Since these messages are logged as errors, they appear on-screen during
the boot process even when using the "quiet" boot parameter used by
distros.
Demote the ESRT error to a warning so that it does not appear on-screen,
and delete the error logging from efi\_mem\_desc\_lookup; both callsites
of that function log more specific messages upon failure.
Out of curiosity I looked closer at the Weibu F3C. There is no entry in
the UEFI-provided memory map which corresponds to the ESRT pointer, but
hacking the code to map it anyway, the ESRT does appear to be valid with
2 entries.
Signed-off-by: Daniel Drake
Cc: Matt Fleming
Acked-by: Peter Jones
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e30b840d466898a02df6986dbb633b967f0ea594
Author: Daniel Borkmann
Date: Wed Mar 15 22:53:37 2017 +0100
perf symbols: Fix symbols\_\_fixup\_end heuristic for corner cases
[ Upstream commit e7ede72a6d40cb3a30c087142d79381ca8a31dab ]
The current symbols\_\_fixup\_end() heuristic for the last entry in the rb
tree is suboptimal as it leads to not being able to recognize the symbol
in the call graph in a couple of corner cases, for example:
i) If the symbol has a start address (f.e. exposed via kallsyms)
that is at a page boundary, then the roundup(curr->start, 4096)
for the last entry will result in curr->start == curr->end with
a symbol length of zero.
ii) If the symbol has a start address that is shortly before a page
boundary, then also here, curr->end - curr->start will just be
very few bytes, where it's unrealistic that we could perform a
match against.
Instead, change the heuristic to roundup(curr->start, 4096) + 4096, so
that we can catch such corner cases and have a better chance to find
that specific symbol. It's still just best effort as the real end of the
symbol is unknown to us (and could even be at a larger offset than the
current range), but better than the current situation.
Alexei reported that he recently run into case i) with a JITed eBPF
program (these are all page aligned) as the last symbol which wasn't
properly shown in the call graph (while other eBPF program symbols in
the rb tree were displayed correctly). Since this is a generic issue,
lets try to improve the heuristic a bit.
Reported-and-Tested-by: Alexei Starovoitov
Signed-off-by: Daniel Borkmann
Fixes: 2e538c4a1847 ("perf tools: Improve kernel/modules symbol lookup")
Link: http://lkml.kernel.org/r/bb5c80d27743be6f12afc68405f1956a330e1bc9.1489614365.git.daniel@iogearbox.net
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2a47e7de0822ec4794c6a44d8a43c66c49f4d355
Author: Dmitry Vyukov
Date: Sat Mar 4 13:46:12 2017 +0100
tty: fix data race in tty\_ldisc\_ref\_wait()
[ Upstream commit a4a3e061149f09c075f108b6f1cf04d9739a6bc2 ]
tty\_ldisc\_ref\_wait() checks tty->ldisc under tty->ldisc\_sem.
But if ldisc==NULL it releases them sem and reloads
tty->ldisc without holding the sem. This is wrong and
can lead to returning non-NULL ldisc without protection.
Don't reload tty->ldisc second time.
Signed-off-by: Dmitry Vyukov
Cc: syzkaller@googlegroups.com
Cc: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Cc: Peter Hurley
Cc: One Thousand Gnomes
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 70f450fc8610464d4ac2274b403b8b15797c27af
Author: Dmitry Vyukov
Date: Sat Mar 4 14:55:19 2017 +0100
tty: don't panic on OOM in tty\_set\_ldisc()
[ Upstream commit 5362544bebe85071188dd9e479b5a5040841c895 ]
If tty\_ldisc\_open() fails in tty\_set\_ldisc(), it tries to go back
to the old discipline or N\_TTY. But that can fail as well, in such
case it panics. This is not a graceful way to handle OOM.
Leave ldisc==NULL if all attempts fail instead.
Also use existing tty\_ldisc\_reinit() helper function instead of
tty\_ldisc\_restore(). Also don't WARN/BUG in tty\_ldisc\_reinit()
if N\_TTY fails, which would have the same net effect of bringing
kernel down on OOM. Instead print a single line message about
what has happened.
Signed-off-by: Dmitry Vyukov
Cc: syzkaller@googlegroups.com
Cc: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Cc: Peter Hurley
Cc: One Thousand Gnomes
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d57ec51d204d220d0eff1e903fb58af86a889de
Author: David Howells
Date: Thu Mar 16 16:27:10 2017 +0000
rxrpc: Ignore BUSY packets on old calls
[ Upstream commit 4d4a6ac73e7466c2085c307fac41f74ce4568a45 ]
If we receive a BUSY packet for a call we think we've just completed, the
packet is handed off to the connection processor to deal with - but the
connection processor doesn't expect a BUSY packet and so flags a protocol
error.
Fix this by simply ignoring the BUSY packet for the moment.
The symptom of this may appear as a system call failing with EPROTO. This
may be triggered by pressing ctrl-C under some circumstances.
This comes about we abort calls due to interruption by a signal (which we
shouldn't do, but that's going to be a large fix and mostly in fs/afs/).
What happens is that we abort the call and may also abort follow up calls
too (this needs offloading somehoe). So we see a transmission of something
like the following sequence of packets:
DATA for call N
ABORT call N
DATA for call N+1
ABORT call N+1
in very quick succession on the same channel. However, the peer may have
deferred the processing of the ABORT from the call N to a background thread
and thus sees the DATA message from the call N+1 coming in before it has
cleared the channel. Thus it sends a BUSY packet[\*].
[\*] Note that some implementations (OpenAFS, for example) mark the BUSY
packet with one plus the callNumber of the call prior to call N.
Ordinarily, this would be call N, but there's no requirement for the
calls on a channel to be numbered strictly sequentially (the number is
required to increase).
This is wrong and means that the callNumber in the BUSY packet should
be ignored (it really ought to be N+1 since that's what it's in
response to).
Signed-off-by: David Howells
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 42b6d6e824d349eef8a3d1925a2667564a31b8b8
Author: David Ahern
Date: Mon Mar 13 16:49:10 2017 -0700
net: mpls: Fix nexthop alive tracking on down events
[ Upstream commit 61733c91c454a61be0ffc93fe46a5d5f2f048c1c ]
Alive tracking of nexthops can account for a link twice if the carrier
goes down followed by an admin down of the same link rendering multipath
routes useless. This is similar to 79099aab38c8 for UNREGISTER events and
DOWN events.
Fix by tracking number of alive nexthops in mpls\_ifdown similar to the
logic in mpls\_ifup. Checking the flags per nexthop once after all events
have been processed is simpler than trying to maintian a running count
through all event combinations.
Also, WRITE\_ONCE is used instead of ACCESS\_ONCE to set rt\_nhn\_alive
per a comment from checkpatch:
WARNING: Prefer WRITE\_ONCE(, ) over ACCESS\_ONCE() =
Fixes: c89359a42e2a4 ("mpls: support for dead routes")
Signed-off-by: David Ahern
Acked-by: Robert Shearman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fd27dbcae9371d0f15b3f0fcb69a544e41d819ba
Author: Jack Morgenstein
Date: Mon Mar 13 19:29:08 2017 +0200
net/mlx4\_core: Avoid delays during VF driver device shutdown
[ Upstream commit 4cbe4dac82e423ecc9a0ba46af24a860853259f4 ]
Some Hypervisors detach VFs from VMs by instantly causing an FLR event
to be generated for a VF.
In the mlx4 case, this will cause that VF's comm channel to be disabled
before the VM has an opportunity to invoke the VF device's "shutdown"
method.
For such Hypervisors, there is a race condition between the VF's
shutdown method and its internal-error detection/reset thread.
The internal-error detection/reset thread (which runs every 5 seconds) also
detects a disabled comm channel. If the internal-error detection/reset
flow wins the race, we still get delays (while that flow tries repeatedly
to detect comm-channel recovery).
The cited commit fixed the command timeout problem when the
internal-error detection/reset flow loses the race.
This commit avoids the unneeded delays when the internal-error
detection/reset flow wins.
Fixes: d585df1c5ccf ("net/mlx4\_core: Avoid command timeouts during VF driver device shutdown")
Signed-off-by: Jack Morgenstein
Reported-by: Simon Xiao
Signed-off-by: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 65bfe003dcebd1144edacedb43c2f96d813bab79
Author: Sagi Grimberg
Date: Thu Mar 9 13:45:52 2017 +0200
nvmet-rdma: Fix a possible uninitialized variable dereference
[ Upstream commit b25634e2a051bef4b2524b11adddfbfa6448f6cd ]
When handling a new recv command, we grab a new rsp resource and
check for the queue state being live. In case the queue is not in
live state, we simply restore the rsp back to the free list. However
in this flow we didn't set rsp->queue yet, so we cannot dereference it.
Instead, make sure to initialize rsp->queue (and other rsp members)
as soon as possible so we won't reference uninitialized variables.
Reported-by: Yi Zhang
Reported-by: Raju Rangoju
Reviewed-by: Christoph Hellwig
Tested-by: Raju Rangoju
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 571e47760de55281834f28a54f75d51285e7787d
Author: Sagi Grimberg
Date: Mon Mar 6 18:46:20 2017 +0200
nvmet: confirm sq percpu has scheduled and switched to atomic
[ Upstream commit d11ea004a458b982e19b188c386e25a9b66ec446 ]
percpu\_ref\_kill is not enough to prevent subsequent
percpu\_ref\_tryget\_live from failing. Hence call
perfcpu\_ref\_kill\_confirm to make it safe.
Reviewed-by: Christoph Hellwig
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit af0cee086b0920612de5d6ad2a8f406792b5aa9d
Author: Sagi Grimberg
Date: Mon Feb 27 18:44:45 2017 +0200
nvme-loop: fix a possible use-after-free when destroying the admin queue
[ Upstream commit e4c5d3762e2d6d274bd1cc948c47063becfa2103 ]
we need to destroy the nvmet sq and let it finish gracefully
before continue to cleanup the queue.
Reviewed-by: Christoph Hellwig
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a8939aac82b0802fa66ca6455ed8bc88913556cf
Author: David Howells
Date: Thu Mar 16 16:27:49 2017 +0000
afs: Fix abort on signal while waiting for call completion
[ Upstream commit 954cd6dc02a65065aecb7150962c0870c5b0e322 ]
Fix the way in which a call that's in progress and being waited for is
aborted in the case that EINTR is detected. We should be sending
RX\_USER\_ABORT rather than RX\_CALL\_DEAD as the abort code.
Note that since the only two ways out of the loop are if the call completes
or if a signal happens, the kill-the-call clause after the loop has
finished can only happen in the case of EINTR. This means that we only
have one abort case to deal with, not two, and the "KWC" case can never
happen and so can be deleted.
Note further that simply aborting the call isn't necessarily the best thing
here since at this point: the request has been entirely sent and it's
likely the server will do the operation anyway - whether we abort it or
not. In future, we should punt the handling of the remainder of the call
off to a background thread.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d43dda072544ecf7890eab6a920fb602c9aafa63
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix afs\_kill\_pages()
[ Upstream commit 7286a35e893176169b09715096a4aca557e2ccd2 ]
Fix afs\_kill\_pages() in two ways:
(1) If a writeback has been partially flushed, then if we try and kill the
pages it contains, some of them may no longer be undergoing writeback
and end\_page\_writeback() will assert.
Fix this by checking to see whether the page in question is actually
undergoing writeback before ending that writeback.
(2) The loop that scans for pages to kill doesn't increase the first page
index, and so the loop may not terminate, but it will try to process
the same pages over and over again.
Fix this by increasing the first page index to one after the last page
we processed.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 856bb4b609ee1cac2a5c74a30c40ad82e782dabf
Author: David Howells
Date: Thu Mar 16 16:27:48 2017 +0000
afs: Fix page leak in afs\_write\_begin()
[ Upstream commit 6d06b0d25209c80e99c1e89700f1e09694a3766b ]
afs\_write\_begin() leaks a ref and a lock on a page if afs\_fill\_page()
fails. Fix the leak by unlocking and releasing the page in the error path.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 833acb3e09dba37c277ed16bc46792c310066264
Author: Marc Dionne
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Populate and use client modification time
[ Upstream commit ab94f5d0dd6fd82e7eeca5e7c8096eaea0a0261f ]
The inode timestamps should be set from the client time
in the status received from the server, rather than the
server time which is meant for internal server use.
Set AFS\_SET\_MTIME and populate the mtime for operations
that take an input status, such as file/dir creation
and StoreData. If an input time is not provided the
server will set the vnode times based on the current server
time.
In a situation where the server has some skew with the
client, this could lead to the client seeing a timestamp
in the future for a file that it just created or wrote.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a3e7a29abf0bf205292ee63bd5d1de54aaa6d18f
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Better abort and net error handling
[ Upstream commit 70af0e3bd65142f9e674961c975451638a7ce1d5 ]
If we receive a network error, a remote abort or a protocol error whilst
we're still transmitting data, make sure we return an appropriate error to
the caller rather than ESHUTDOWN or ECONNABORTED.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ab239061161929a3aa048cb514b0183b8742b04c
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Invalid op ID should abort with RXGEN\_OPCODE
[ Upstream commit 1157f153f37a8586765034470e4f00a4a6c4ce6f ]
When we are given an invalid operation ID, we should abort that with
RXGEN\_OPCODE rather than RX\_INVALID\_OPERATION.
Also map RXGEN\_OPCODE to -ENOTSUPP.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 972e7b7cbf5c82e9b0b963c9443a30dd3354687b
Author: David Howells
Date: Thu Mar 16 16:27:47 2017 +0000
afs: Fix the maths in afs\_fs\_store\_data()
[ Upstream commit 146a1192783697810b63a1e41c4d59fc93387340 ]
afs\_fs\_store\_data() works out of the size of the write it's going to make,
but it uses 32-bit unsigned subtraction in one place that gets
automatically cast to loff\_t.
However, if to < offset, then the number goes negative, but as the result
isn't signed, this doesn't get sign-extended to 64-bits when placed in a
loff\_t.
Fix by casting the operands to loff\_t.
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9329ae4cb10e2563b8ec15a3d6a2a15dfe16fd3d
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Prevent callback expiry timer overflow
[ Upstream commit 56e714312e7dbd6bb83b2f78d3ec19a404c7649f ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs\_vnode record to use ktime\_get\_real\_seconds() instead, for the
fields cb\_expires and cb\_expires\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7da1b85a75d4dd9b090a242ea162f27d2aea7518
Author: Tina Ruchandani
Date: Thu Mar 16 16:27:46 2017 +0000
afs: Migrate vlocation fields to 64-bit
[ Upstream commit 8a79790bf0b7da216627ffb85f52cfb4adbf1e4e ]
get\_seconds() returns real wall-clock seconds. On 32-bit systems
this value will overflow in year 2038 and beyond. This patch changes
afs's vlocation record to use ktime\_get\_real\_seconds() instead, for the
fields time\_of\_death and update\_at.
Signed-off-by: Tina Ruchandani
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7286fad1570444b924568b13994843ab28b55dd4
Author: David Howells
Date: Thu Mar 16 16:27:45 2017 +0000
afs: Flush outstanding writes when an fd is closed
[ Upstream commit 58fed94dfb17e89556b5705f20f90e5b2971b6a1 ]
Flush outstanding writes in afs when an fd is closed. This is what NFS and
CIFS do.
Reported-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit eaaad7646d3de73ca30653e635261827242be124
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Deal with an empty callback array
[ Upstream commit bcd89270d93b7edebb5de5e5e7dca1a77a33496e ]
Servers may send a callback array that is the same size as
the FID array, or an empty array. If the callback count is
0, the code would attempt to read (fid\_count \* 12) bytes of
data, which would fail and result in an unmarshalling error.
This would lead to stale data for remotely modified files
or directories.
Store the callback array size in the internal afs\_call
structure and use that to determine the amount of data to
read.
Signed-off-by: Marc Dionne
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 900048089cc135fea39452ec32aa44415e1c8dba
Author: Marc Dionne
Date: Thu Mar 16 16:27:44 2017 +0000
afs: Adjust mode bits processing
[ Upstream commit 627f46943ff90bcc32ddeb675d881c043c6fa2ae ]
Mode bits for an afs file should not be enforced in the usual
way.
For files, the absence of user bits can restrict file access
with respect to what is granted by the server.
These bits apply regardless of the owner or the current uid; the
rest of the mode bits (group, other) are ignored.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ba47c159748068a3371fdc0d77c7c1dcef2b7271
Author: Marc Dionne
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Populate group ID from vnode status
[ Upstream commit 6186f0788b31f44affceeedc7b48eb10faea120d ]
The group was hard coded to GLOBAL\_ROOT\_GID; use the group
ID that was received from the server.
Signed-off-by: Marc Dionne
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c250fae9ad4bb1d629b8451c2e07b300e0fb8bb8
Author: David Howells
Date: Thu Mar 16 16:27:43 2017 +0000
afs: Fix missing put\_page()
[ Upstream commit 29c8bbbd6e21daa0997d1c3ee886b897ee7ad652 ]
In afs\_writepages\_region(), inside the loop where we find dirty pages to
deal with, one of the if-statements is missing a put\_page().
Signed-off-by: David Howells
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b29c7b7c62d5aa8ba3748c6dfebeee19c279fc14
Author: Alex Deucher
Date: Wed Mar 15 21:11:46 2017 -0400
drm/radeon: reinstate oland workaround for sclk
[ Upstream commit 66822d815ae61ecb2d9dba9031517e8a8476969d ]
Higher sclks seem to be unstable on some boards.
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=100222
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2a84fce9b0396b62c6e3020b5fb9f5378697b6ae
Author: yong mao
Date: Sat Mar 4 15:10:03 2017 +0800
mmc: mediatek: Fixed bug where clock frequency could be set wrong
[ Upstream commit 40ceda09c8c84694c2ca6b00bcc6dc71e8e62d96 ]
This patch can fix two issues:
Issue 1:
In previous code, div may be overflow when setting clock frequency
as f\_min. We can use DIV\_ROUND\_UP to fix this boundary related
issue.
Issue 2:
In previous code, we can not set the correct clock frequency when
div equals 0xff.
Signed-off-by: Yong Mao
Signed-off-by: Chaotian Jing
Reviewed-by: Daniel Kurtz
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28714e962a719d1898b6cff5d51352bac2135534
Author: Steven Rostedt (VMware)
Date: Thu Mar 2 15:10:59 2017 +0100
sched/deadline: Use deadline instead of period when calculating overflow
[ Upstream commit 2317d5f1c34913bac5971d93d69fb6c31bb74670 ]
I was testing Daniel's changes with his test case, and tweaked it a
little. Instead of having the runtime equal to the deadline, I
increased the deadline ten fold.
Daniel's test case had:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
To make it more interesting, I changed it to:
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 20 \* 1000 \* 1000; /\* 20 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
The results were rather surprising. The behavior that Daniel's patch
was fixing came back. The task started using much more than .1% of the
CPU. More like 20%.
Looking into this I found that it was due to the dl\_entity\_overflow()
constantly returning true. That's because it uses the relative period
against relative runtime vs the absolute deadline against absolute
runtime.
runtime / (deadline - t) > dl\_runtime / dl\_period
There's even a comment mentioning this, and saying that when relative
deadline equals relative period, that the equation is the same as using
deadline instead of period. That comment is backwards! What we really
want is:
runtime / (deadline - t) > dl\_runtime / dl\_deadline
We care about if the runtime can make its deadline, not its period. And
then we can say "when the deadline equals the period, the equation is
the same as using dl\_period instead of dl\_deadline".
After correcting this, now when the task gets enqueued, it can throttle
correctly, and Daniel's fix to the throttling of sleeping deadline
tasks works even when the runtime and deadline are not the same.
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Daniel Bristot de Oliveira
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/02135a27f1ae3fe5fd032568a5a2f370e190e8d7.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a2e29113f1abe5299c0af6ab841cbdddfd427fcf
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:58 2017 +0100
sched/deadline: Throttle a constrained deadline task activated after the deadline
[ Upstream commit df8eac8cafce7d086be3bd5cf5a838fa37594dfb ]
During the activation, CBS checks if it can reuse the current task's
runtime and period. If the deadline of the task is in the past, CBS
cannot use the runtime, and so it replenishes the task. This rule
works fine for implicit deadline tasks (deadline == period), and the
CBS was designed for implicit deadline tasks. However, a task with
constrained deadline (deadine < period) might be awakened after the
deadline, but before the next period. In this case, replenishing the
task would allow it to run for runtime / deadline. As in this case
deadline < period, CBS enables a task to run for more than the
runtime / period. In a very loaded system, this can cause a domino
effect, making other tasks miss their deadlines.
To avoid this problem, in the activation of a constrained deadline
task after the deadline but before the next period, throttle the
task and set the replenishing timer to the begin of the next period,
unless it is boosted.
Reproducer:
--------------- %< ---------------
int main (int argc, char \*\*argv)
{
int ret;
int flags = 0;
unsigned long l = 0;
struct timespec ts;
struct sched\_attr attr;
memset(&attr, 0, sizeof(attr));
attr.size = sizeof(attr);
attr.sched\_policy = SCHED\_DEADLINE;
attr.sched\_runtime = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_deadline = 2 \* 1000 \* 1000; /\* 2 ms \*/
attr.sched\_period = 2 \* 1000 \* 1000 \* 1000; /\* 2 s \*/
ts.tv\_sec = 0;
ts.tv\_nsec = 2000 \* 1000; /\* 2 ms \*/
ret = sched\_setattr(0, &attr, flags);
if (ret < 0) {
perror("sched\_setattr");
exit(-1);
}
for(;;) {
/\* XXX: you may need to adjust the loop \*/
for (l = 0; l < 150000; l++);
/\*
\* The ideia is to go to sleep right before the deadline
\* and then wake up before the next period to receive
\* a new replenishment.
\*/
nanosleep(&ts, NULL);
}
exit(0);
}
--------------- >% ---------------
On my box, this reproducer uses almost 50% of the CPU time, which is
obviously wrong for a task with 2/2000 reservation.
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Luca Abeni
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/edf58354e01db46bf42df8d2dd32418833f68c89.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cc56a00eab7604f2c99ce27665dbb4fa9fa3280
Author: Daniel Bristot de Oliveira
Date: Thu Mar 2 15:10:57 2017 +0100
sched/deadline: Make sure the replenishment timer fires in the next period
[ Upstream commit 5ac69d37784b237707a7b15d199cdb6c6fdb6780 ]
Currently, the replenishment timer is set to fire at the deadline
of a task. Although that works for implicit deadline tasks because the
deadline is equals to the begin of the next period, that is not correct
for constrained deadline tasks (deadline < period).
For instance:
f.c:
--------------- %< ---------------
int main (void)
{
for(;;);
}
--------------- >% ---------------
# gcc -o f f.c
# trace-cmd record -e sched:sched\_switch \
-e syscalls:sys\_exit\_sched\_setattr \
chrt -d --sched-runtime 490000000 \
--sched-deadline 500000000 \
--sched-period 1000000000 0 ./f
# trace-cmd report | grep "{pid of ./f}"
After setting parameters, the task is replenished and continue running
until being throttled:
f-11295 [003] 13322.113776: sys\_exit\_sched\_setattr: 0x0
The task is throttled after running 492318 ms, as expected:
f-11295 [003] 13322.606094: sched\_switch: f:11295 [-1] R ==> watchdog/3:32 [0]
But then, the task is replenished 500719 ms after the first
replenishment:
-0 [003] 13322.614495: sched\_switch: swapper/3:0 [120] R ==> f:11295 [-1]
Running for 490277 ms:
f-11295 [003] 13323.104772: sched\_switch: f:11295 [-1] R ==> swapper/3:0 [120]
Hence, in the first period, the task runs 2 \* runtime, and that is a bug.
During the first replenishment, the next deadline is set one period away.
So the runtime / period starts to be respected. However, as the second
replenishment took place in the wrong instant, the next replenishment
will also be held in a wrong instant of time. Rather than occurring in
the nth period away from the first activation, it is taking place
in the (nth period - relative deadline).
Signed-off-by: Daniel Bristot de Oliveira
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Luca Abeni
Reviewed-by: Steven Rostedt (VMware)
Reviewed-by: Juri Lelli
Cc: Linus Torvalds
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Romulo Silva de Oliveira
Cc: Steven Rostedt
Cc: Thomas Gleixner
Cc: Tommaso Cucinotta
Link: http://lkml.kernel.org/r/ac50d89887c25285b47465638354b63362f8adff.1488392936.git.bristot@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0a4d4dac5e342889331a88e70ee24f29c7b64873
Author: Wanpeng Li
Date: Mon Mar 6 21:51:28 2017 -0800
sched/deadline: Add missing update\_rq\_clock() in dl\_task\_timer()
[ Upstream commit dcc3b5ffe1b32771c9a22e2c916fb94c4fcf5b79 ]
The following warning can be triggered by hot-unplugging the CPU
on which an active SCHED\_DEADLINE task is running on:
------------[ cut here ]------------
WARNING: CPU: 7 PID: 0 at kernel/sched/sched.h:833 replenish\_dl\_entity+0x71e/0xc40
rq->clock\_update\_flags < RQCF\_ACT\_SKIP
CPU: 7 PID: 0 Comm: swapper/7 Tainted: G B 4.11.0-rc1+ #24
Hardware name: LENOVO ThinkCentre M8500t-N000/SHARKBAY, BIOS FBKTC1AUS 02/16/2016
Call Trace:
dump\_stack+0x85/0xc4
\_\_warn+0x172/0x1b0
warn\_slowpath\_fmt+0xb4/0xf0
? \_\_warn+0x1b0/0x1b0
? debug\_check\_no\_locks\_freed+0x2c0/0x2c0
? cpudl\_set+0x3d/0x2b0
replenish\_dl\_entity+0x71e/0xc40
enqueue\_task\_dl+0x2ea/0x12e0
? dl\_task\_timer+0x777/0x990
? \_\_hrtimer\_run\_queues+0x270/0xa50
dl\_task\_timer+0x316/0x990
? enqueue\_task\_dl+0x12e0/0x12e0
? enqueue\_task\_dl+0x12e0/0x12e0
\_\_hrtimer\_run\_queues+0x270/0xa50
? hrtimer\_cancel+0x20/0x20
? hrtimer\_interrupt+0x119/0x600
hrtimer\_interrupt+0x19c/0x600
? trace\_hardirqs\_off+0xd/0x10
local\_apic\_timer\_interrupt+0x74/0xe0
smp\_apic\_timer\_interrupt+0x76/0xa0
apic\_timer\_interrupt+0x93/0xa0
The DL task will be migrated to a suitable later deadline rq once the DL
timer fires and currnet rq is offline. The rq clock of the new rq should
be updated. This patch fixes it by updating the rq clock after holding
the new rq's rq lock.
Signed-off-by: Wanpeng Li
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Matt Fleming
Cc: Juri Lelli
Cc: Linus Torvalds
Cc: Mike Galbraith
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: http://lkml.kernel.org/r/1488865888-15894-1-git-send-email-wanpeng.li@hotmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8d3a318194ec6a3c52384cbc63894e8dfcc15c9b
Author: Sara Sharon
Date: Tue Mar 14 09:50:35 2017 +0200
iwlwifi: mvm: cleanup pending frames in DQA mode
[ Upstream commit 9a3fcf912ef7f5c6e18f9af6875dd13f7311f7aa ]
When a station is asleep, the fw will set it as "asleep".
All queues that are used only by one station will be stopped by
the fw.
In pre-DQA mode this was relevant for aggregation queues. However,
in DQA mode a queue is owned by one station only, so all queues
will be stopped.
As a result, we don't expect to get filtered frames back to
mac80211 and don't have to maintain the entire pending\_frames
state logic, the same way as we do in aggregations.
The correct behavior is to align DQA behavior with the aggregation
queue behaviour pre-DQA:
- Don't count pending frames.
- Let mac80211 know we have frames in these queues so that it can
properly handle trigger frames.
When a trigger frame is received, mac80211 tells the driver to send
frames from the queues using release\_buffered\_frames.
The driver will tell the fw to let frames out even if the station
is asleep. This is done by iwl\_mvm\_sta\_modify\_sleep\_tx\_count.
Reported-and-tested-by: Jens Axboe
Reported-by: Linus Torvalds
Signed-off-by: Sara Sharon
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a524bb57dd367c299b6c61ff39df6328ae49ed08
Author: Vitaly Kuznetsov
Date: Sat Mar 4 18:13:59 2017 -0700
Drivers: hv: util: move waiting for release to hv\_utils\_transport itself
[ Upstream commit e9c18ae6eb2b312f16c63e34b43ea23926daa398 ]
Waiting for release\_event in all three drivers introduced issues on release
as on\_reset() hook is not always called. E.g. if the device was never
opened we will never get the completion.
Move the waiting code to hvutil\_transport\_destroy() and make sure it is
only called when the device is open. hvt->lock serialization should
guarantee the absence of races.
Fixes: 5a66fecbf6aa ("Drivers: hv: util: kvp: Fix a rescind processing issue")
Fixes: 20951c7535b5 ("Drivers: hv: util: Fcopy: Fix a rescind processing issue")
Fixes: d77044d142e9 ("Drivers: hv: util: Backup: Fix a rescind processing issue")
Reported-by: Dexuan Cui
Tested-by: Dexuan Cui
Signed-off-by: Vitaly Kuznetsov
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da626b13ce329cb2629897251226ca8be54ab919
Author: Alex Deucher
Date: Tue Mar 14 14:42:03 2017 -0400
drm/radeon/si: add dpm quirk for Oland
[ Upstream commit 0f424de1fd9bc4ab24bd1fe5430ab5618e803e31 ]
OLAND 0x1002:0x6604 0x1028:0x066F 0x00 seems to have problems
with higher sclks.
Acked-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1867eb805091fbcd654161dbb15acfe3b92f1599
Author: Taku Izumi
Date: Wed Mar 15 13:47:50 2017 +0900
fjes: Fix wrong netdevice feature flags
[ Upstream commit fe8daf5fa715f7214952f06a387e4b7de818c5be ]
This patch fixes netdev->features for Extended Socket network device.
Currently Extended Socket network device's netdev->feature claims
NETIF\_F\_HW\_CSUM, however this is completely wrong. There's no feature
of checksum offloading.
That causes invalid TCP/UDP checksum and packet rejection when IP
forwarding from Extended Socket network device to other network device.
NETIF\_F\_HW\_CSUM should be omitted.
Signed-off-by: Taku Izumi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 91510a623baa8c3be2033e42634ebc837e819635
Author: Don Brace
Date: Fri Mar 10 14:35:23 2017 -0600
scsi: hpsa: do not timeout reset operations
[ Upstream commit 2ef2884980873081a4edae92f9d88dd580c85f6e ]
Resets can take longer than DEFAULT\_TIMEOUT.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0f07e7611184cd78a26dd1fbf13513264896cdac
Author: Don Brace
Date: Fri Mar 10 14:35:17 2017 -0600
scsi: hpsa: limit outstanding rescans
[ Upstream commit 87b9e6aa87d9411f1059aa245c0c79976bc557ac ]
Avoid rescan storms. No need to queue another if one is pending.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Reviewed-by: Tomas Henzl
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c81410a4353d45766564ba6af9a067d33d1525d7
Author: Don Brace
Date: Fri Mar 10 14:35:11 2017 -0600
scsi: hpsa: update check for logical volume status
[ Upstream commit 85b29008d8af6d94a0723aaa8d93cfb6e041158b ]
- Add in a new case for volume offline. Resolves internal testing bug
for multilun array management.
- Return correct status for failed TURs.
Reviewed-by: Scott Benesh
Reviewed-by: Scott Teel
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8652baa5a31d9f65f93464d27d9a330e3dee6191
Author: Kuninori Morimoto
Date: Tue Mar 14 09:34:49 2017 +0900
ASoC: rcar: clear DE bit only in PDMACHCR when it stops
[ Upstream commit 62a10498afb27370ec6018e9d802b74850fd8d9a ]
R-Car datasheet indicates "Clear DE in PDMACHCR" for transfer stop,
but current code clears all bits in PDMACHCR.
Because of this, DE bit might never been cleared,
and it causes CMD overflow. This patch fixes this issue.
Signed-off-by: Kuninori Morimoto
Tested-by: Hiroyuki Yokoyama
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fd2530a4ee62c17bc8e8715cc6f449c1a1f7f212
Author: Stafford Horne
Date: Mon Mar 13 07:44:45 2017 +0900
openrisc: fix issue handling 8 byte get\_user calls
[ Upstream commit 154e67cd8e8f964809d0e75e44bb121b169c75b3 ]
Was getting the following error with allmodconfig:
ERROR: "\_\_get\_user\_bad" [lib/test\_user\_copy.ko] undefined!
This was simply a missing break statement, causing an unwanted fall
through.
Signed-off-by: Stafford Horne
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18b39b61b2c66556396f8584f0769f221d3383f6
Author: Alexander Shishkin
Date: Thu Jun 30 16:10:51 2016 +0300
intel\_th: pci: Add Gemini Lake support
[ Upstream commit 340837f985c2cb87ca0868d4aa9ce42b0fab3a21 ]
This adds Intel(R) Trace Hub PCI ID for Gemini Lake SOC.
Signed-off-by: Alexander Shishkin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3544f57578a6110f14e837c2a002a8eadad510cf
Author: Arnd Bergmann
Date: Tue Mar 14 22:27:11 2017 +0100
drm: amd: remove broken include path
[ Upstream commit 655d9ca9ac075da1ef2a45012ba48a39f6eb1f58 ]
The AMD ACP driver adds "-I../acp -I../acp/include" to the gcc command
line, which makes no sense, since these are evaluated relative to the
build directory. When we build with "make W=1", they instead cause
a warning:
cc1: error: ../acp/: No such file or directory [-Werror=missing-include-dirs]
cc1: error: ../acp/include: No such file or directory [-Werror=missing-include-dirs]
cc1: all warnings being treated as errors
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.o' failed
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_device.o' failed
../scripts/Makefile.build:289: recipe for target 'drivers/gpu/drm/amd/amdgpu/amdgpu\_kms.o' failed
This removes the subdir-ccflags variable that evidently did not
serve any purpose here.
Signed-off-by: Arnd Bergmann
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c9c0971271dfcc5f0e74232446f938e2bed717b
Author: Ram Amrani
Date: Tue Mar 14 15:26:02 2017 +0200
qed: Fix interrupt flags on Rx LL2
[ Upstream commit 1df2adedcce17ad4a39fba74f0e2b611f797fe10 ]
Before iterating over the the LL2 Rx ring, the ring's
spinlock is taken via spin\_lock\_irqsave().
The actual processing of the packet [including handling
by the protocol driver] is done without said lock,
so qed releases the spinlock and re-claims it afterwards.
Problem is that the final spin\_lock\_irqrestore() at the end
of the iteration uses the original flags saved from the
initial irqsave() instead of the flags from the most recent
irqsave(). So it's possible that the interrupt status would
be incorrect at the end of the processing.
Fixes: 0a7fb11c23c0 ("qed: Add Light L2 support");
CC: Ram Amrani
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ac04ab9624b5337628a8a5b96eee81a6fee704e5
Author: Mintz, Yuval
Date: Tue Mar 14 15:26:00 2017 +0200
qed: Fix mapping leak on LL2 rx flow
[ Upstream commit 752ecb2da11124a948567076b60767dc8034cfa5 ]
When receiving an Rx LL2 packet, qed fails to unmap the previous buffer.
Fixes: 0a7fb11c23c0 ("qed: Add Light L2 support");
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8de6d7b28d2f135838275258b715a52db27fdb1c
Author: Ram Amrani
Date: Tue Mar 14 15:25:58 2017 +0200
qed: Align CIDs according to DORQ requirement
[ Upstream commit f3e48119b97f56fb09310c95d49da122a27003d7 ]
The Doorbell HW block can be configured at a granularity
of 16 x CIDs, so we need to make sure that the actual number
of CIDs configured would be a multiplication of 16.
Today, when RoCE is enabled - given that the number is unaligned,
doorbelling the higher CIDs would fail to reach the firmware and
would eventually timeout.
Fixes: dbb799c39717 ("qed: Initialize hardware for new protocols")
Signed-off-by: Ram Amrani
Signed-off-by: Yuval Mintz
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fddc3df7647e796c8947215a281db95109d17ac1
Author: Jiri Pirko
Date: Tue Mar 14 14:00:01 2017 +0100
mlxsw: reg: Fix SPVMLR max record count
[ Upstream commit e9093b1183bbac462d2caef3eac165778c0b1bf1 ]
The num\_rec field is 8 bit, so the maximal count number is 255.
This fixes vlans learning not being enabled for wider ranges than 255.
Fixes: a4feea74cd7a ("mlxsw: reg: Add Switch Port VLAN MAC Learning register definition")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c8b4e60b5755b65c39db2adcb3cc5ba293e118e
Author: Jiri Pirko
Date: Tue Mar 14 14:00:00 2017 +0100
mlxsw: reg: Fix SPVM max record count
[ Upstream commit f004ec065b4879d6bc9ba0211af2169b3ce3097f ]
The num\_rec field is 8 bit, so the maximal count number is 255. This
fixes vlans not being enabled for wider ranges than 255.
Fixes: b2e345f9a454 ("mlxsw: reg: Add Switch Port VID and Switch Port VLAN Membership registers definitions")
Signed-off-by: Jiri Pirko
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6c548e90a0bcfc8beb29ccb0de5d7d40efb41da9
Author: Vlad Yasevich
Date: Tue Mar 14 08:58:08 2017 -0400
net: Resend IGMP memberships upon peer notification.
[ Upstream commit 37c343b4f4e70e9dc328ab04903c0ec8d154c1a4 ]
When we notify peers of potential changes, it's also good to update
IGMP memberships. For example, during VM migration, updating IGMP
memberships will redirect existing multicast streams to the VM at the
new location.
Signed-off-by: Vladislav Yasevich
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 889163d75fe5e0cb4ead674851e08c4e706d645c
Author: Arnd Bergmann
Date: Tue Mar 14 13:54:12 2017 +0100
irqchip/mvebu-odmi: Select GENERIC\_MSI\_IRQ\_DOMAIN
[ Upstream commit fa23b9d1b89fdc34f296f02e496a20aeff5736be ]
This driver uses the MSI domain but has no strict dependency on PCI\_MSI, so we
may run into a build failure when CONFIG\_GENERIC\_MSI\_IRQ\_DOMAIN is disabled:
drivers/irqchip/irq-mvebu-odmi.c:152:15: error: variable 'odmi\_msi\_ops' has initializer but incomplete type
static struct msi\_domain\_ops odmi\_msi\_ops = {
^~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:155:15: error: variable 'odmi\_msi\_domain\_info' has initializer but incomplete type
static struct msi\_domain\_info odmi\_msi\_domain\_info = {
^~~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:3: error: 'struct msi\_domain\_info' has no member named 'flags'
.flags = (MSI\_FLAG\_USE\_DEF\_DOM\_OPS | MSI\_FLAG\_USE\_DEF\_CHIP\_OPS),
^~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:12: error: 'MSI\_FLAG\_USE\_DEF\_DOM\_OPS' undeclared here (not in a function)
.flags = (MSI\_FLAG\_USE\_DEF\_DOM\_OPS | MSI\_FLAG\_USE\_DEF\_CHIP\_OPS),
^~~~~~~~~~~~~~~~~~~~~~~~
drivers/irqchip/irq-mvebu-odmi.c:156:39: error: 'MSI\_FLAG\_USE\_DEF\_CHIP\_OPS' undeclared here (not in a function); did you mean 'MSI\_FLAG\_USE\_DEF\_DOM\_OPS'?
Selecting the option from this driver seems to solve this nicely, though I could
not find any other instance of this in irqchip drivers.
Signed-off-by: Arnd Bergmann
Acked-by: Thomas Petazzoni
Signed-off-by: Marc Zyngier
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e30ccb5f1c7e00ee189a0991e633b3034801899c
Author: Matthias Kaehlcke
Date: Mon Mar 13 14:30:29 2017 -0700
dmaengine: Fix array index out of bounds warning in \_\_get\_unmap\_pool()
[ Upstream commit 23f963e91fd81f44f6b316b1c24db563354c6be8 ]
This fixes the following warning when building with clang and
CONFIG\_DMA\_ENGINE\_RAID=n :
drivers/dma/dmaengine.c:1102:11: error: array index 2 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[2];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
^
drivers/dma/dmaengine.c:1104:11: error: array index 3 is past the end of the array (which contains 1 element) [-Werror,-Warray-bounds]
return &unmap\_pool[3];
^ ~
drivers/dma/dmaengine.c:1083:1: note: array 'unmap\_pool' declared here
static struct dmaengine\_unmap\_pool unmap\_pool[] = {
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Dan Williams
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 46cbe3f51c511b648de0220b14ab4f5832f00020
Author: Johan Hovold
Date: Mon Mar 13 13:42:03 2017 +0100
net: wimax/i2400m: fix NULL-deref at probe
[ Upstream commit 6e526fdff7be4f13b24f929a04c0e9ae6761291e ]
Make sure to check the number of endpoints to avoid dereferencing a
NULL-pointer or accessing memory beyond the endpoint array should a
malicious device lack the expected endpoints.
The endpoints are specifically dereferenced in the i2400m\_bootrom\_init
path during probe (e.g. in i2400mu\_tx\_bulk\_out).
Fixes: f398e4240fce ("i2400m/USB: probe/disconnect, dev init/shutdown
and reset backends")
Cc: Inaky Perez-Gonzalez
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2e70c4d5de8751df5d14a578459a58ef0471e1ef
Author: Tahsin Erdogan
Date: Fri Mar 10 12:09:49 2017 -0800
writeback: fix memory leak in wb\_queue\_work()
[ Upstream commit 4a3a485b1ed0e109718cc8c9d094fa0f552de9b2 ]
When WB\_registered flag is not set, wb\_queue\_work() skips queuing the
work, but does not perform the necessary clean up. In particular, if
work->auto\_free is true, it should free the memory.
The leak condition can be reprouced by following these steps:
mount /dev/sdb /mnt/sdb
/\* In qemu console: device\_del sdb \*/
umount /dev/sdb
Above will result in a wb\_queue\_work() call on an unregistered wb and
thus leak memory.
Reported-by: John Sperbeck
Signed-off-by: Tahsin Erdogan
Reviewed-by: Jan Kara
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d28046fb8c435fc63f51dca30cdeb423d8ab4479
Author: Sagi Grimberg
Date: Mon Mar 13 16:10:11 2017 +0200
blk-mq: Fix tagset reinit in the presence of cpu hot-unplug
[ Upstream commit 0067d4b020ea07a58540acb2c5fcd3364bf326e0 ]
In case cpu was unplugged, we need to make sure not to assume
that the tags for that cpu are still allocated. so check
for null tags when reinitializing a tagset.
Reported-by: Yi Zhang
Signed-off-by: Sagi Grimberg
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 143d13d1e6c0a9ea7e6e86a0279907b174a42b4d
Author: Hiroyuki Yokoyama
Date: Wed Mar 1 03:51:00 2017 +0000
ASoC: rsnd: fix sound route path when using SRC6/SRC9
[ Upstream commit a1c2ff53726907aff5feb37e4cfd45c1ff626431 ]
This patch fixes the problem that the missing value of the route path
setting table and incorrect values are set in the CMD\_ROUTE\_SELECT
register.
Signed-off-by: Hiroyuki Yokoyama
[Kuninori: shared data on MIX and non-MIX case]
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 97b75dad9dd1bc352e199d15516978edb06792fd
Author: Florian Westphal
Date: Thu Mar 9 23:22:30 2017 +0100
netfilter: bridge: honor frag\_max\_size when refragmenting
[ Upstream commit 4ca60d08cbe65f501baad64af50fceba79c19fbb ]
consider a bridge with mtu 9000, but end host sending smaller
packets to another host with mtu < 9000.
In this case, after reassembly, bridge+defrag would refragment,
and then attempt to send the reassembled packet as long as it
was below 9k.
Instead we have to cap by the largest fragment size seen.
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 38780b9ae45a40f0f39f0279c381397fb910b072
Author: Tomi Valkeinen
Date: Tue Feb 28 10:11:45 2017 +0200
drm/omap: fix dmabuf mmap for dma\_alloc'ed buffers
[ Upstream commit 9fa1d7537242bd580ffa99c4725a0407096aad26 ]
omap\_gem\_dmabuf\_mmap() returns an error (with a WARN) when called for a
buffer which is allocated with dma\_alloc\_\*(). This prevents dmabuf mmap
from working on SoCs without DMM, e.g. AM4 and OMAP3.
I could not find any reason for omap\_gem\_dmabuf\_mmap() rejecting such
buffers, and just removing the if() fixes the limitation.
Signed-off-by: Tomi Valkeinen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8fb782bbd21214a211e8e05dd0230ddd9b255e5e
Author: Dmitry Torokhov
Date: Tue Feb 28 17:14:41 2017 -0800
Input: i8042 - add TUXEDO BU1406 (N24\_25BU) to the nomux list
[ Upstream commit a4c2a13129f7c5bcf81704c06851601593303fd5 ]
TUXEDO BU1406 does not implement active multiplexing mode properly,
and takes around 550 ms in i8042\_set\_mux\_mode(). Given that the
device does not have external AUX port, there is no downside in
disabling the MUX mode.
Reported-by: Paul Menzel
Suggested-by: Vojtech Pavlik
Reviewed-by: Marcos Paulo de Souza
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 817f60ccf72cf7d98c4a96d408660bbbcb495489
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_reset\_versions for NFSv4.
[ Upstream commit 800a938f0bf9130c8256116649c0cc5806bfb2fd ]
If you write "-2 -3 -4" to the "versions" file, it will
notice that no versions are enabled, and nfsd\_reset\_versions()
is called.
This enables all major versions, not no minor versions.
So we lose the invariant that NFSv4 is only advertised when
at least one minor is enabled.
Fix the code to explicitly enable minor versions for v4,
change it to use nfsd\_vers() to test and set, and simplify
the code.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0154269f9c122440b841e06c2c16cde10c26bf7b
Author: NeilBrown
Date: Fri Mar 10 11:36:39 2017 +1100
NFSD: fix nfsd\_minorversion(.., NFSD\_AVAIL)
[ Upstream commit 928c6fb3a9bfd6c5b287aa3465226add551c13c0 ]
Current code will return 1 if the version is supported,
and -1 if it isn't.
This is confusing and inconsistent with the one place where this
is used.
So change to return 1 if it is supported, and zero if not.
i.e. an error is never returned.
Signed-off-by: NeilBrown
Signed-off-by: J. Bruce Fields
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 063c753ef78bee13265bf02df185704e8fdff1f9
Author: Dave Airlie
Date: Fri Mar 10 12:13:04 2017 +1000
drm/amdgpu: fix parser init error path to avoid crash in parser fini
[ Upstream commit 607523d19c9d67ba4cf7bdaced644f11ed04992c ]
If we don't reset the chunk info in the error path, the subsequent
fini path will double free.
Reviewed-by: Christian König
Signed-off-by: Dave Airlie
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d40364d333e3de4cc2e49c80ad8ddb242c46315
Author: Oleksandr Tyshchenko
Date: Mon Feb 27 14:30:26 2017 +0200
iommu/io-pgtable-arm-v7s: Check for leaf entry before dereferencing it
[ Upstream commit a03849e7210277fa212779b7cd9c30e1ab6194b2 ]
Do a check for already installed leaf entry at the current level before
dereferencing it in order to avoid walking the page table down with
wrong pointer to the next level.
Signed-off-by: Oleksandr Tyshchenko
CC: Will Deacon
CC: Robin Murphy
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 721c136ac2780e519cd44940ba47f08cdeafec9d
Author: Daniel Jurgens
Date: Fri Mar 10 14:33:02 2017 +0200
net/mlx5: Don't save PCI state when PCI error is detected
[ Upstream commit 5d47f6c89d568ab61712d8c40676fbb020b68752 ]
When a PCI error is detected the PCI state could be corrupt, don't save
it in that flow. Save the state after initialization. After restoring the
PCI state during slot reset save it again, restoring the state destroys
the previously saved state info.
Fixes: 05ac2c0b7438 ('net/mlx5: Fix race between PCI error handlers and
health work')
Signed-off-by: Daniel Jurgens
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 248cbd97be813adfa675d48e1e702f9d5e7ffca8
Author: Paul Blakey
Date: Fri Mar 10 14:33:01 2017 +0200
net/mlx5: Fix create autogroup prev initializer
[ Upstream commit af36370569eb37420e1e78a2e60c277b781fcd00 ]
The autogroups list is a list of non overlapping group boundaries
sorted by their start index. If the autogroups list wasn't empty
and an empty group slot was found at the start of the list,
the new group was added to the end of the list instead of the
beginning, as the prev initializer was incorrect.
When this was repeated, it caused multiple groups to have
overlapping boundaries.
Fixed that by correctly initializing the prev pointer to the
start of the list.
Fixes: eccec8da3b4e ('net/mlx5: Keep autogroups list ordered')
Signed-off-by: Paul Blakey
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 515d78dc0a89a14c10ce3b3f007c99508aa65e61
Author: David Howells
Date: Fri Mar 10 07:48:49 2017 +0000
rxrpc: Wake up the transmitter if Rx window size increases on the peer
[ Upstream commit 702f2ac87a9a8da23bf8506466bc70175fc970b2 ]
The RxRPC ACK packet may contain an extension that includes the peer's
current Rx window size for this call. We adjust the local Tx window size
to match. However, the transmitter can stall if the receive window is
reduced to 0 by the peer and then reopened.
This is because the normal way that the transmitter is re-energised is by
dropping something out of our Tx queue and thus making space. When a
single gap is made, the transmitter is woken up. However, because there's
nothing in the Tx queue at this point, this doesn't happen.
To fix this, perform a wake\_up() any time we see the peer's Rx window size
increasing.
The observable symptom is that calls start failing on ETIMEDOUT and the
following:
kAFS: SERVER DEAD state=-62
appears in dmesg.
Signed-off-by: David Howells
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e85b9bc29b04bbde927c2c556e0832327bc62279
Author: Doug Berger
Date: Thu Mar 9 16:58:48 2017 -0800
net: bcmgenet: Power up the internal PHY before probing the MII
[ Upstream commit 6be371b053dc86f11465cc1abce2e99bda0a0574 ]
When using the internal PHY it must be powered up when the MII is probed
or the PHY will not be detected. Since the PHY is powered up at reset
this has not been a problem. However, when the kernel is restarted with
kexec the PHY will likely be powered down when the kernel starts so it
will not be detected and the Ethernet link will not be established.
This commit explicitly powers up the internal PHY when the GENET driver
is probed to correct this behavior.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9ac24794f2e688336c64686129df6d2133c9c0b
Author: Doug Berger
Date: Thu Mar 9 16:58:47 2017 -0800
net: bcmgenet: synchronize irq0 status between the isr and task
[ Upstream commit 07c52d6a0b955a8a28834f9354793cfc4b81d0e9 ]
Add a spinlock to ensure that irq0\_stat is not unintentionally altered
as the result of preemption. Also removed unserviced irq0 interrupts
and removed irq1\_stat since there is no bottom half service for those
interrupts.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4c3727f6add57b03197b25af01dd1aa26090ed00
Author: Doug Berger
Date: Thu Mar 9 16:58:46 2017 -0800
net: bcmgenet: power down internal phy if open or resume fails
[ Upstream commit 7627409cc4970e8c8b9de6945ad86a575290a94e ]
Since the internal PHY is powered up during the open and resume
functions it should be powered back down if the functions fail.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 66e522ab02cc7ae47cb8f1247e7b74efdc16072e
Author: Doug Berger
Date: Thu Mar 9 16:58:45 2017 -0800
net: bcmgenet: reserved phy revisions must be checked first
[ Upstream commit eca4bad73409aedc6ff22f823c18b67a4f08c851 ]
The reserved gphy\_rev value of 0x01ff must be tested before the old
or new scheme for GPHY major versioning are tested, otherwise it will
be treated as 0xff00 according to the old scheme.
Fixes: b04a2f5b9ff5 ("net: bcmgenet: add support for new GENET PHY revision scheme")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dc8d63c43af042d5740c29f23906788ffbb6eaf4
Author: Doug Berger
Date: Thu Mar 9 16:58:44 2017 -0800
net: bcmgenet: correct MIB access of UniMAC RUNT counters
[ Upstream commit 1ad3d225e5a40ca6c586989b4baaca710544c15a ]
The gap between the Tx status counters and the Rx RUNT counters is now
being added to allow correct reporting of the registers.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bb5c42a5b1d2b484939c1a1d18306853db8fcba9
Author: Doug Berger
Date: Thu Mar 9 16:58:43 2017 -0800
net: bcmgenet: correct the RBUF\_OVFL\_CNT and RBUF\_ERR\_CNT MIB values
[ Upstream commit ffff71328a3c321f7c14cc1edd33577717037744 ]
The location of the RBUF overflow and error counters has moved between
different version of the GENET MAC. This commit corrects the driver to
read from the correct locations depending on the version of the GENET
MAC.
Fixes: 1c1008c793fa ("net: bcmgenet: add main driver file")
Signed-off-by: Doug Berger
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 72cd0c3f66165cce2c91012382a57800f54e3bff
Author: Michael Chan
Date: Wed Mar 8 18:44:35 2017 -0500
bnxt\_en: Ignore 0 value in autoneg supported speed from firmware.
[ Upstream commit 520ad89a54edea84496695d528f73ddcf4a52ea4 ]
In some situations, the firmware will return 0 for autoneg supported
speed. This may happen if the firmware detects no SFP module, for
example. The driver should ignore this so that we don't end up with
an invalid autoneg setting with nothing advertised. When SFP module
is inserted, we'll get the updated settings from firmware at that time.
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ae0ebdba96674c278674d2b12eedde0681e42f91
Author: Alexander Potapenko
Date: Wed Mar 8 18:08:16 2017 +0100
net: initialize msg.msg\_flags in recvfrom
[ Upstream commit 9f138fa609c47403374a862a08a41394be53d461 ]
KMSAN reports a use of uninitialized memory in put\_cmsg() because
msg.msg\_flags in recvfrom haven't been initialized properly.
The flag values don't affect the result on this path, but it's still a
good idea to initialize them explicitly.
Signed-off-by: Alexander Potapenko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6783015096dc66dee0035baeec410f16b6ee2d84
Author: Andrea Arcangeli
Date: Thu Mar 9 16:17:14 2017 -0800
userfaultfd: selftest: vm: allow to build in vm/ directory
[ Upstream commit 46aa6a302b53f543f8e8b8e1714dc5e449ad36a6 ]
linux/tools/testing/selftests/vm $ make
gcc -Wall -I ../../../../usr/include compaction\_test.c -lrt -o /compaction\_test
/usr/lib/gcc/x86\_64-pc-linux-gnu/4.9.4/../../../../x86\_64-pc-linux-gnu/bin/ld: cannot open output file /compaction\_test: Permission denied
collect2: error: ld returned 1 exit status
make: \*\*\* [../lib.mk:54: /compaction\_test] Error 1
Since commit a8ba798bc8ec ("selftests: enable O and KBUILD\_OUTPUT")
selftests/vm build fails if run from the "selftests/vm" directory, but
it works in the selftests/ directory. It's quicker to be able to do a
local vm-only build after a tree wipe and this patch allows for it
again.
Link: http://lkml.kernel.org/r/20170302173738.18994-4-aarcange@redhat.com
Signed-off-by: Andrea Arcangeli
Cc: Mike Rapoport
Cc: "Dr. David Alan Gilbert"
Cc: Mike Kravetz
Cc: Pavel Emelyanov
Cc: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 275314e90c5e84c972be2da278cee60279e07fc7
Author: Andrea Arcangeli
Date: Thu Mar 9 16:16:28 2017 -0800
userfaultfd: shmem: \_\_do\_fault requires VM\_FAULT\_NOPAGE
[ Upstream commit 6bbc4a4144b1a69743022ac68dfaf6e7d993abb9 ]
\_\_do\_fault assumes vmf->page has been initialized and is valid if
VM\_FAULT\_NOPAGE is not returned by vma->vm\_ops->fault(vma, vmf).
handle\_userfault() in turn should return VM\_FAULT\_NOPAGE if it doesn't
return VM\_FAULT\_SIGBUS or VM\_FAULT\_RETRY (the other two possibilities).
This VM\_FAULT\_NOPAGE case is only invoked when signal are pending and it
didn't matter for anonymous memory before. It only started to matter
since shmem was introduced. hugetlbfs also takes a different path and
doesn't exercise \_\_do\_fault.
Link: http://lkml.kernel.org/r/20170228154201.GH5816@redhat.com
Signed-off-by: Andrea Arcangeli
Reported-by: Dmitry Vyukov
Cc: "Kirill A. Shutemov"
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9bcd15bdfb6151e0418fa9321d4dce2b2eb0cb16
Author: Guoqing Jiang
Date: Fri Feb 24 11:15:12 2017 +0800
md-cluster: free md\_cluster\_info if node leave cluster
[ Upstream commit 9c8043f337f14d1743006dfc59c03e80a42e3884 ]
To avoid memory leak, we need to free the cinfo which
is allocated when node join cluster.
Reviewed-by: NeilBrown
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9841d7b08ff6285123663acddd0ec7aa292402b7
Author: Chunfeng Yun
Date: Thu Mar 9 15:39:34 2017 +0200
usb: xhci-mtk: check hcc\_params after adding primary hcd
[ Upstream commit 94a631d91ad341b3b4bdac72d1104d9f090e0ca9 ]
hcc\_params is set in xhci\_gen\_setup() called from usb\_add\_hcd(),
so checks the Maximum Primary Stream Array Size in the hcc\_params
register after adding primary hcd.
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 215df1f35542081485cff549830ff01af98c5279
Author: Radim Krčmář
Date: Tue Mar 7 17:51:49 2017 +0100
KVM: nVMX: do not warn when MSR bitmap address is not backed
[ Upstream commit 05d8d34611139f8435af90ac54b65eb31e82e388 ]
Before trying to do nested\_get\_page() in nested\_vmx\_merge\_msr\_bitmap(),
we have already checked that the MSR bitmap address is valid (4k aligned
and within physical limits). SDM doesn't specify what happens if the
there is no memory mapped at the valid address, but Intel CPUs treat the
situation as if the bitmap was configured to trap all MSRs.
KVM already does that by returning false and a correct handling doesn't
need the guest-trigerrable warning that was reported by syzkaller:
(The warning was originally there to catch some possible bugs in nVMX.)
------------[ cut here ]------------
WARNING: CPU: 0 PID: 7832 at arch/x86/kvm/vmx.c:9709
nested\_vmx\_merge\_msr\_bitmap arch/x86/kvm/vmx.c:9709 [inline]
WARNING: CPU: 0 PID: 7832 at arch/x86/kvm/vmx.c:9709
nested\_get\_vmcs12\_pages+0xfb6/0x15c0 arch/x86/kvm/vmx.c:9640
Kernel panic - not syncing: panic\_on\_warn set ...
CPU: 0 PID: 7832 Comm: syz-executor1 Not tainted 4.10.0+ #229
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:15 [inline]
dump\_stack+0x2ee/0x3ef lib/dump\_stack.c:51
panic+0x1fb/0x412 kernel/panic.c:179
\_\_warn+0x1c4/0x1e0 kernel/panic.c:540
warn\_slowpath\_null+0x2c/0x40 kernel/panic.c:583
nested\_vmx\_merge\_msr\_bitmap arch/x86/kvm/vmx.c:9709 [inline]
nested\_get\_vmcs12\_pages+0xfb6/0x15c0 arch/x86/kvm/vmx.c:9640
enter\_vmx\_non\_root\_mode arch/x86/kvm/vmx.c:10471 [inline]
nested\_vmx\_run+0x6186/0xaab0 arch/x86/kvm/vmx.c:10561
handle\_vmlaunch+0x1a/0x20 arch/x86/kvm/vmx.c:7312
vmx\_handle\_exit+0xfc0/0x3f00 arch/x86/kvm/vmx.c:8526
vcpu\_enter\_guest arch/x86/kvm/x86.c:6982 [inline]
vcpu\_run arch/x86/kvm/x86.c:7044 [inline]
kvm\_arch\_vcpu\_ioctl\_run+0x1418/0x4840 arch/x86/kvm/x86.c:7205
kvm\_vcpu\_ioctl+0x673/0x1120 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:2570
Reported-by: Dmitry Vyukov
Reviewed-by: Jim Mattson
[Jim Mattson explained the bare metal behavior: "I believe this behavior
would be documented in the chipset data sheet rather than the SDM,
since the chipset returns all 1s for an unclaimed read."]
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 50fc2d4152fb03bfbdec186403ce5c49fd0ff77e
Author: Javier Martinez Canillas
Date: Wed Feb 22 15:23:22 2017 -0300
usb: phy: isp1301: Add OF device ID table
[ Upstream commit fd567653bdb908009b650f079bfd4b63169e2ac4 ]
The driver doesn't have a struct of\_device\_id table but supported devices
are registered via Device Trees. This is working on the assumption that a
I2C device registered via OF will always match a legacy I2C device ID and
that the MODALIAS reported will always be of the form i2c:.
But this could change in the future so the correct approach is to have an
OF device ID table if the devices are registered via OF.
Signed-off-by: Javier Martinez Canillas
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bf864220a59c51a676717cbee7f346a400c5ab47
Author: Ilan peer
Date: Mon Dec 26 18:17:36 2016 +0200
mac80211: Fix addition of mesh configuration element
commit 57629915d568c522ac1422df7bba4bee5b5c7a7c upstream.
The code was setting the capabilities byte to zero,
after it was already properly set previously. Fix it.
The bug was found while debugging hwsim mesh tests failures
that happened since the commit mentioned below.
Fixes: 76f43b4c0a93 ("mac80211: Remove invalid flag operations in mesh TSF synchronization")
Signed-off-by: Ilan Peer
Reviewed-by: Masashi Honma
Signed-off-by: Johannes Berg
Cc: Richard Schütz
Cc: Mathias Kretschmer
Signed-off-by: Greg Kroah-Hartman
commit 32e2ae03283b4047f5af9fd1178fe24f38e96601
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f upstream.
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Signed-off-by: Greg Kroah-Hartman
commit 6a851bb99e5c6569e51eb798d6a38b759fdb3302
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
commit c894aa97577e47d3066b27b32499ecf899bfa8b0 upstream.
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 679dbeac0b6bb551e1f3b95673695b22b2ac953d
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
commit 6f6a23a213be51728502b88741ba6a10cda2441d upstream.
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 744cb5ab337218e7a258d2a82c6f5d7afc72cd16
Author: David Lechner
Date: Sun Dec 3 19:54:41 2017 -0600
eeprom: at24: change nvmem stride to 1
commit 7f6d2ecd3d7acaf205ea7b3e96f9ffc55b92298b upstream.
Trying to read the MAC address from an eeprom that has an offset that
is not a multiple of 4 causes an error currently.
Fix it by changing the nvmem stride to 1.
Signed-off-by: David Lechner
[Bartosz: tweaked the commit message]
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit d266817f5028fef8ff521a77777ef1c4b8de890e
Author: Steven Rostedt
Date: Sat Dec 2 13:04:54 2017 -0500
sched/rt: Do not pull from current CPU if only one CPU to pull
commit f73c52a5bcd1710994e53fbccc378c42b97a06b6 upstream.
Daniel Wagner reported a crash on the BeagleBone Black SoC.
This is a single CPU architecture, and does not have a functional
arch\_send\_call\_function\_single\_ipi() implementation which can crash
the kernel if that is called.
As it only has one CPU, it shouldn't be called, but if the kernel is
compiled for SMP, the push/pull RT scheduling logic now calls it for
irq\_work if the one CPU is overloaded, it can use that function to call
itself and crash the kernel.
Ideally, we should disable the SCHED\_FEAT(RT\_PUSH\_IPI) if the system
only has a single CPU. But SCHED\_FEAT is a constant if sched debugging
is turned off. Another fix can also be used, and this should also help
with normal SMP machines. That is, do not initiate the pull code if
there's only one RT overloaded CPU, and that CPU happens to be the
current CPU that is scheduling in a lower priority task.
Even on a system with many CPUs, if there's many RT tasks waiting to
run on a single CPU, and that CPU schedules in another RT task of lower
priority, it will initiate the PULL logic in case there's a higher
priority RT task on another CPU that is waiting to run. But if there is
no other CPU with waiting RT tasks, it will initiate the RT pull logic
on itself (as it still has RT tasks waiting to run). This is a wasted
effort.
Not only does this help with SMP code where the current CPU is the only
one with RT overloaded tasks, it should also solve the issue that
Daniel encountered, because it will prevent the PULL logic from
executing, as there's only one CPU on the system, and the check added
here will cause it to exit the RT pull code.
Reported-by: Daniel Wagner
Signed-off-by: Steven Rostedt (VMware)
Acked-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: linux-rt-users
Fixes: 4bdced5c9 ("sched/rt: Simplify the IPI based RT balancing logic")
Link: http://lkml.kernel.org/r/20171202130454.4cbbfe8d@vmware.local.home
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 9c537f06d61ada88ccc8080be79213ffce1ebf15
Author: Scott Mayhew
Date: Fri Dec 8 16:00:12 2017 -0500
nfs: don't wait on commit in nfs\_commit\_inode() if there were no commit requests
commit dc4fd9ab01ab379ae5af522b3efd4187a7c30a31 upstream.
If there were no commit requests, then nfs\_commit\_inode() should not
wait on the commit or mark the inode dirty, otherwise the following
BUG\_ON can be triggered:
[ 1917.130762] kernel BUG at fs/inode.c:578!
[ 1917.130766] Oops: Exception in kernel mode, sig: 5 [#1]
[ 1917.130768] SMP NR\_CPUS=2048 NUMA pSeries
[ 1917.130772] Modules linked in: iscsi\_tcp libiscsi\_tcp libiscsi scsi\_transport\_iscsi blocklayoutdriver rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache sunrpc sg nx\_crypto pseries\_rng ip\_tables xfs libcrc32c sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_common ibmvscsi scsi\_transport\_srp ibmveth scsi\_tgt dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 1917.130805] CPU: 2 PID: 14923 Comm: umount.nfs4 Tainted: G ------------ T 3.10.0-768.el7.ppc64 #1
[ 1917.130810] task: c0000005ecd88040 ti: c00000004cea0000 task.ti: c00000004cea0000
[ 1917.130813] NIP: c000000000354178 LR: c000000000354160 CTR: c00000000012db80
[ 1917.130816] REGS: c00000004cea3720 TRAP: 0700 Tainted: G ------------ T (3.10.0-768.el7.ppc64)
[ 1917.130820] MSR: 8000000100029032  CR: 22002822 XER: 20000000
[ 1917.130828] CFAR: c00000000011f594 SOFTE: 1
GPR00: c000000000354160 c00000004cea39a0 c0000000014c4700 c0000000018cc750
GPR04: 000000000000c750 80c0000000000000 0600000000000000 04eeb76bea749a03
GPR08: 0000000000000034 c0000000018cc758 0000000000000001 d000000005e619e8
GPR12: c00000000012db80 c000000007b31200 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR24: 0000000000000000 c000000000dfc3ec 0000000000000000 c0000005eefc02c0
GPR28: d0000000079dbd50 c0000005b94a02c0 c0000005b94a0250 c0000005b94a01c8
[ 1917.130867] NIP [c000000000354178] .evict+0x1c8/0x350
[ 1917.130871] LR [c000000000354160] .evict+0x1b0/0x350
[ 1917.130873] Call Trace:
[ 1917.130876] [c00000004cea39a0] [c000000000354160] .evict+0x1b0/0x350 (unreliable)
[ 1917.130880] [c00000004cea3a30] [c0000000003558cc] .evict\_inodes+0x13c/0x270
[ 1917.130884] [c00000004cea3af0] [c000000000327d20] .kill\_anon\_super+0x70/0x1e0
[ 1917.130896] [c00000004cea3b80] [d000000005e43e30] .nfs\_kill\_super+0x20/0x60 [nfs]
[ 1917.130900] [c00000004cea3c00] [c000000000328a20] .deactivate\_locked\_super+0xa0/0x1b0
[ 1917.130903] [c00000004cea3c80] [c00000000035ba54] .cleanup\_mnt+0xd4/0x180
[ 1917.130907] [c00000004cea3d10] [c000000000119034] .task\_work\_run+0x114/0x150
[ 1917.130912] [c00000004cea3db0] [c00000000001ba6c] .do\_notify\_resume+0xcc/0x100
[ 1917.130916] [c00000004cea3e30] [c00000000000a7b0] .ret\_from\_except\_lite+0x5c/0x60
[ 1917.130919] Instruction dump:
[ 1917.130921] 7fc3f378 486734b5 60000000 387f00a0 38800003 4bdcb365 60000000 e95f00a0
[ 1917.130927] 694a0060 7d4a0074 794ad182 694a0001 <0b0a0000> 892d02a4 2f890000 40de0134
Signed-off-by: Scott Mayhew
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 3bdb508d686e4943bfb761d78dc915dd825f811f
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 upstream.
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 7336f5481f6cf913a2d29d98c6e11f4bbe19d3b2
Author: Sukumar Ghorai
Date: Wed Aug 16 14:46:55 2017 -0700
Bluetooth: btusb: driver to enable the usb-wakeup feature
commit a0085f2510e8976614ad8f766b209448b385492f upstream.
BT-Controller connected as platform non-root-hub device and
usb-driver initialize such device with wakeup disabled,
Ref. usb\_new\_device().
At present wakeup-capability get enabled by hid-input device from usb
function driver(e.g. BT HID device) at runtime. Again some functional
driver does not set usb-wakeup capability(e.g LE HID device implement
as HID-over-GATT), and can't wakeup the host on USB.
Most of the device operation (such as mass storage) initiated from host
(except HID) and USB wakeup aligned with host resume procedure. For BT
device, usb-wakeup capability need to enable form btusc driver as a
generic solution for multiple profile use case and required for USB remote
wakeup (in-bus wakeup) while host is suspended. Also usb-wakeup feature
need to enable/disable with HCI interface up and down.
Signed-off-by: Sukumar Ghorai
Signed-off-by: Amit K Bag
Acked-by: Oliver Neukum
Signed-off-by: Marcel Holtmann
Cc: Matthias Kaehlcke
Signed-off-by: Greg Kroah-Hartman
commit cdfe4c0091a8fa5e0a25d82fa0d4684382ac880d
Author: Chunfeng Yun
Date: Fri Dec 8 18:10:06 2017 +0200
usb: xhci: fix TDS for MTK xHCI1.1
commit 72b663a99c074a8d073e7ecdae446cfb024ef551 upstream.
For MTK's xHCI 1.0 or latter, TD size is the number of max
packet sized packets remaining in the TD, not including
this TRB (following spec).
For MTK's xHCI 0.96 and older, TD size is the number of max
packet sized packets remaining in the TD, including this TRB
(not following spec).
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit e081bd0d70bddbf912f6f7f0f82e3e1ac2c52ae6
Author: Yan, Zheng
Date: Thu Nov 30 11:59:22 2017 +0800
ceph: drop negative child dentries before try pruning inode's alias
commit 040d786032bf59002d374b86d75b04d97624005c upstream.
Negative child dentry holds reference on inode's alias, it makes
d\_prune\_aliases() do nothing.
Signed-off-by: "Yan, Zheng"
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 14513e49c43cd3149a03ff9e1c223c3d5803ad09
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a upstream.
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit f3e957266ae56c200fb13a42309c50f84576c64a
Author: Shuah Khan
Date: Thu Dec 7 14:16:48 2017 -0700
usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input
commit c6688ef9f29762e65bce325ef4acd6c675806366 upstream.
Harden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit b6dbace92ed744a80af75036e93615324cd27aec
Author: Felipe Balbi
Date: Mon Sep 26 10:51:18 2016 +0300
usb: add helper to extract bits 12:11 of wMaxPacketSize
commit 541b6fe63023f3059cf85d47ff2767a3e42a8e44 upstream.
According to USB Specification 2.0 table 9-4,
wMaxPacketSize is a bitfield. Endpoint's maxpacket
is laid out in bits 10:0. For high-speed,
high-bandwidth isochronous endpoints, bits 12:11
contain a multiplier to tell us how many
transactions we want to try per uframe.
This means that if we want an isochronous endpoint
to issue 3 transfers of 1024 bytes per uframe,
wMaxPacketSize should contain the value:
1024 | (2 << 11)
or 5120 (0x1400). In order to make Host and
Peripheral controller drivers' life easier, we're
adding a helper which returns bits 12:11. Note that
no care is made WRT to checking endpoint type and
gadget's speed. That's left for drivers to handle.
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 20e825cdf7a1627f92371d45a5322ccecdebcb3b
Author: Shuah Khan
Date: Thu Dec 7 14:16:47 2017 -0700
usbip: fix stub\_rx: get\_pipe() to validate endpoint number
commit 635f545a7e8be7596b9b2b6a43cab6bbd5a88e43 upstream.
get\_pipe() routine doesn't validate the input endpoint number
and uses to reference ep\_in and ep\_out arrays. Invalid endpoint
number can trigger BUG(). Range check the epnum and returning
error instead of calling BUG().
Change caller stub\_recv\_cmd\_submit() to handle the get\_pipe()
error return.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 99542e468b76ae180675566692e0528c4c712661
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 upstream.
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
Signed-off-by: Greg Kroah-Hartman
commit 0d29ae4f5033453ea86d60a736bed58fa4c15007
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
commit 62354454625741f0569c2cbe45b2d192f8fd258e upstream.
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit d760f903419509d933b27d387854eb1e35f88cdf
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
commit 90e406f96f630c07d631a021fd4af10aac913e77 upstream.
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit d1175423ce67bd1903c4f876ba6774e3a48abdc1
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb upstream.
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c32e053a11f231376f0899ef906fd43f8fc8dbd0
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
commit ecaaab5649781c5a0effdaf298a925063020500e upstream.
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 43259d07fceb8cc1f5ba7e8003ae19023e0620f5
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 upstream.
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit cd9b59861f9cad2f1b36eace975060cfc3bc46e4
Author: Eric Biggers
Date: Sun Nov 26 23:16:49 2017 -0800
crypto: rsa - fix buffer overread when stripping leading zeroes
commit d2890c3778b164fde587bc16583f3a1c87233ec5 upstream.
In rsa\_get\_n(), if the buffer contained all 0's and "FIPS mode" is
enabled, we would read one byte past the end of the buffer while
scanning the leading zeroes. Fix it by checking 'n\_sz' before '!\*ptr'.
This bug was reachable by adding a specially crafted key of type
"asymmetric" (requires CONFIG\_RSA and CONFIG\_X509\_CERTIFICATE\_PARSER).
KASAN report:
BUG: KASAN: slab-out-of-bounds in rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
Read of size 1 at addr ffff88003501a708 by task keyctl/196
CPU: 1 PID: 196 Comm: keyctl Not tainted 4.14.0-09238-g1d3b78bbc6e9 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110\_100015-anatol 04/01/2014
Call Trace:
rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
asn1\_ber\_decoder+0x82a/0x1fd0 lib/asn1\_decoder.c:328
rsa\_set\_pub\_key+0xd3/0x320 crypto/rsa.c:278
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
pkcs1pad\_set\_pub\_key+0xae/0x200 crypto/rsa-pkcs1pad.c:117
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
public\_key\_verify\_signature+0x270/0x9d0 crypto/asymmetric\_keys/public\_key.c:106
x509\_check\_for\_self\_signed+0x2ea/0x480 crypto/asymmetric\_keys/x509\_public\_key.c:141
x509\_cert\_parse+0x46a/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:129
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Allocated by task 196:
\_\_do\_kmalloc mm/slab.c:3711 [inline]
\_\_kmalloc\_track\_caller+0x118/0x2e0 mm/slab.c:3726
kmemdup+0x17/0x40 mm/util.c:118
kmemdup ./include/linux/string.h:414 [inline]
x509\_cert\_parse+0x2cb/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:106
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 5a7de97309f5 ("crypto: rsa - return raw integers for the ASN.1 parser")
Cc: Tudor Ambarus
Signed-off-by: Eric Biggers
Reviewed-by: James Morris
Reviewed-by: David Howells
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 1fb73eae9624e2d3583581cd80bf408cc9b3916d
Author: Martin Kaiser
Date: Tue Oct 17 22:53:08 2017 +0200
mfd: fsl-imx25: Clean up irq settings during removal
commit 18f77393796848e68909e65d692c1d1436f06e06 upstream.
When fsl-imx25-tsadc is compiled as a module, loading, unloading and
reloading the module will lead to a crash.
Unable to handle kernel paging request at virtual address bf005430
[] (irq\_find\_matching\_fwspec)
from [] (of\_irq\_get+0x58/0x74)
[] (of\_irq\_get)
from [] (platform\_get\_irq+0x48/0xc8)
[] (platform\_get\_irq)
from [] (mx25\_tsadc\_probe+0x220/0x2f4 [fsl\_imx25\_tsadc])
irq\_find\_matching\_fwspec() loops over all registered irq domains. The
irq domain is still registered from last time the module was loaded but
the pointer to its operations is invalid after the module was unloaded.
Add a removal function which clears the irq handler and removes the irq
domain. With this cleanup in place, it's possible to unload and reload
the module.
Signed-off-by: Martin Kaiser
Reviewed-by: Lucas Stach
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman


=== Content from usn.ubuntu.com_1eabcf2d_20250125_181648.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3619-1: Linux kernel vulnerabilities

4 April 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Snapdragon processors

## Details

Jann Horn discovered that the Berkeley Packet Filter (BPF) implementation

in the Linux kernel improperly performed sign extension in some situations.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-16995](/security/CVE-2017-16995))

It was discovered that a race condition leading to a use-after-free

vulnerability existed in the ALSA PCM subsystem of the Linux kernel. A

local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2017-0861](/security/CVE-2017-0861))

It was discovered that the KVM implementation in the Linux kernel allowed

passthrough of the diagnostic I/O port 0x80. An attacker in a guest VM

could use this to cause a denial of service (system crash) in the host OS.

([CVE-2017-1000407](/security/CVE-2017-1000407))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a use-after-free vulnerability existed in the

network namespaces implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2017-15129](/security/CVE-2017-15129))

It was discovered that the Advanced Linux Sound Architecture (ALSA)

subsystem in the Linux kernel contained a use-after-free when handling

device removal. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16528](/security/CVE-2017-16528))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the DiBcom DiB0700 USB DVB driver in the

Linux kernel did not properly handle detach events. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16646](/security/CVE-2017-16646))

Andrey Konovalov discovered that the CDC USB Ethernet driver did not

properly validate device descriptors. A physically proximate attacker could

use this to cause a denial of service (system crash). ([CVE-2017-16649](/security/CVE-2017-16649))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure vulnerability.

A physically proximate attacker could use this to expose sensitive

information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the HugeTLB component of the Linux kernel did not

properly handle holes in hugetlb ranges. A local attacker could use this to

expose sensitive information (kernel memory). ([CVE-2017-16994](/security/CVE-2017-16994))

It was discovered that the netfilter component of the Linux did not

properly restrict access to the connection tracking helpers list. A local

attacker could use this to bypass intended access restrictions.

([CVE-2017-17448](/security/CVE-2017-17448))

It was discovered that the netlink subsystem in the Linux kernel did not

properly restrict observations of netlink messages to the appropriate net

namespace. A local attacker could use this to expose sensitive information

(kernel netlink traffic). ([CVE-2017-17449](/security/CVE-2017-17449))

It was discovered that the netfilter passive OS fingerprinting (xt\_osf)

module did not properly perform access control checks. A local attacker

could improperly modify the system-wide OS fingerprint list.

([CVE-2017-17450](/security/CVE-2017-17450))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

contained an out-of-bounds read when handling memory-mapped I/O. A local

attacker could use this to expose sensitive information. ([CVE-2017-17741](/security/CVE-2017-17741))

It was discovered that the Salsa20 encryption algorithm implementations in

the Linux kernel did not properly handle zero-length inputs. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2017-17805](/security/CVE-2017-17805))

It was discovered that the HMAC implementation did not validate the state

of the underlying cryptographic hash algorithm. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-17806](/security/CVE-2017-17806))

It was discovered that the keyring implementation in the Linux kernel did

not properly check permissions when a key request was performed on a

task's default keyring. A local attacker could use this to add keys to

unauthorized keyrings. ([CVE-2017-17807](/security/CVE-2017-17807))

Alexei Starovoitov discovered that the Berkeley Packet Filter (BPF)

implementation in the Linux kernel contained a branch-pruning logic issue

around unreachable code. A local attacker could use this to cause a denial

of service. ([CVE-2017-17862](/security/CVE-2017-17862))

It was discovered that the parallel cryptography component of the Linux

kernel incorrectly freed kernel memory. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-18075](/security/CVE-2017-18075))

It was discovered that a race condition existed in the Device Mapper

component of the Linux kernel. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2017-18203](/security/CVE-2017-18203))

It was discovered that a race condition existed in the OCFS2 file system

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (kernel deadlock). ([CVE-2017-18204](/security/CVE-2017-18204))

It was discovered that an infinite loop could occur in the madvise(2)

implementation in the Linux kernel in certain circumstances. A local

attacker could use this to cause a denial of service (system hang).

([CVE-2017-18208](/security/CVE-2017-18208))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

It was discovered that the Broadcom NetXtremeII ethernet driver in the

Linux kernel did not properly validate Generic Segment Offload (GSO) packet

sizes. An attacker could use this to cause a denial of service (interface

unavailability). ([CVE-2018-1000026](/security/CVE-2018-1000026))

It was discovered that the Reliable Datagram Socket (RDS)

implementation in the Linux kernel contained an out-of-bounds write

during RDMA page allocation. An attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-5332](/security/CVE-2018-5332))

Mohamed Ghannam discovered a null pointer dereference in the RDS (Reliable

Datagram Sockets) protocol implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-5333](/security/CVE-2018-5333))

范龙飞 discovered that a race condition existed in loop block device

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5344](/security/CVE-2018-5344))

It was discovered that an integer overflow error existed in the futex

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash). ([CVE-2018-6927](/security/CVE-2018-6927))

It was discovered that a NULL pointer dereference existed in the RDS

(Reliable Datagram Sockets) protocol implementation in the Linux kernel. A

local attacker could use this to cause a denial of service (system crash).

([CVE-2018-7492](/security/CVE-2018-7492))

It was discovered that the Broadcom UniMAC MDIO bus controller driver in

the Linux kernel did not properly validate device resources. A local

attacker could use this to cause a denial of service (system crash).

([CVE-2018-8043](/security/CVE-2018-8043))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1020-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.4.0-1020.25](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.4.0-1020.25)
* [linux-image-4.4.0-1054-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1054.63](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1054.63)
* [linux-image-4.4.0-1086-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1086.94](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1086.94)
* [linux-image-4.4.0-1088-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.4.0-1088.93](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.4.0-1088.93)
* [linux-image-4.4.0-119-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)
* [linux-image-4.4.0-119-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-119.143](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-119.143)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-0861](/security/CVE-2017-0861)
* [CVE-2017-1000407](/security/CVE-2017-1000407)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-15129](/security/CVE-2017-15129)
* [CVE-2017-16528](/security/CVE-2017-16528)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16646](/security/CVE-2017-16646)
* [CVE-2017-16649](/security/CVE-2017-16649)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-16994](/security/CVE-2017-16994)
* [CVE-2017-16995](/security/CVE-2017-16995)
* [CVE-2017-17448](/security/CVE-2017-17448)
* [CVE-2017-17449](/security/CVE-2017-17449)
* [CVE-2017-17450](/security/CVE-2017-17450)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-17741](/security/CVE-2017-17741)
* [CVE-2017-17805](/security/CVE-2017-17805)
* [CVE-2017-17806](/security/CVE-2017-17806)
* [CVE-2017-17807](/security/CVE-2017-17807)
* [CVE-2017-17862](/security/CVE-2017-17862)
* [CVE-2017-18075](/security/CVE-2017-18075)
* [CVE-2017-18203](/security/CVE-2017-18203)
* [CVE-2017-18204](/security/CVE-2017-18204)
* [CVE-2017-18208](/security/CVE-2017-18208)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2018-1000026](/security/CVE-2018-1000026)
* [CVE-2018-5332](/security/CVE-2018-5332)
* [CVE-2018-5333](/security/CVE-2018-5333)
* [CVE-2018-5344](/security/CVE-2018-5344)
* [CVE-2018-6927](/security/CVE-2018-6927)
* [CVE-2018-7492](/security/CVE-2018-7492)
* [CVE-2018-8043](/security/CVE-2018-8043)

## Related notices

* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3619-2](/security/notices/USN-3619-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3632-1](/security/notices/USN-3632-1)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3523-2](/security/notices/USN-3523-2)
* [USN-3633-1](/security/notices/USN-3633-1)
* [USN-3523-1](/security/notices/USN-3523-1)
* [USN-3523-3](/security/notices/USN-3523-3)
* [USN-3620-1](/security/notices/USN-3620-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3653-1](/security/notices/USN-3653-1)
* [USN-3657-1](/security/notices/USN-3657-1)
* [USN-3655-1](/security/notices/USN-3655-1)
* [USN-3653-2](/security/notices/USN-3653-2)
* [USN-3655-2](/security/notices/USN-3655-2)
* [USN-3698-2](/security/notices/USN-3698-2)
* [USN-3697-1](/security/notices/USN-3697-1)
* [USN-3698-1](/security/notices/USN-3698-1)
* [USN-3697-2](/security/notices/USN-3697-2)
* [USN-3674-2](/security/notices/USN-3674-2)
* [USN-3674-1](/security/notices/USN-3674-1)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3630-2](/security/notices/USN-3630-2)
* [USN-3630-1](/security/notices/USN-3630-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from cdn.kernel.org_6679bb35_20250125_181635.html ===
commit 7b3775017f4e6b87dfd2c7f63d1eaf057948f31d
Author: Greg Kroah-Hartman
Date: Wed Dec 20 10:10:38 2017 +0100
Linux 4.14.8
commit bed6119aa21b28f096880342f9e2445f9ad47b25
Author: Bin Liu
Date: Tue Dec 5 08:45:30 2017 -0600
usb: musb: da8xx: fix babble condition handling
commit bd3486ded7a0c313a6575343e6c2b21d14476645 upstream.
When babble condition happens, the musb controller might automatically
turns off VBUS. On DA8xx platform, the controller generates drvvbus
interrupt for turning off VBUS along with the babble interrupt.
In this case, we should handle the babble interrupt first and recover
from the babble condition.
This change ignores the drvvbus interrupt if babble interrupt is also
generated at the same time, so the babble recovery routine works
properly.
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit d094690cbed906ca96752cb94abed50fbf1cfaa3
Author: Brian Norris
Date: Thu Oct 19 11:45:19 2017 -0700
ath10k: fix build errors with !CONFIG\_PM
[ Upstream commit 20665a9076d48e9abd9a2db13d307f58f7ef6647 ]
Build errors have been reported with CONFIG\_PM=n:
drivers/net/wireless/ath/ath10k/pci.c:3416:8: error: implicit
declaration of function 'ath10k\_pci\_suspend'
[-Werror=implicit-function-declaration]
drivers/net/wireless/ath/ath10k/pci.c:3428:8: error: implicit
declaration of function 'ath10k\_pci\_resume'
[-Werror=implicit-function-declaration]
These are caused by the combination of the following two commits:
6af1de2e4ec4 ("ath10k: mark PM functions as \_\_maybe\_unused")
96378bd2c6cd ("ath10k: fix core PCI suspend when WoWLAN is supported but
disabled")
Both build fine on their own.
But now that ath10k\_pci\_pm\_{suspend,resume}() is compiled
unconditionally, we should also compile ath10k\_pci\_{suspend,resume}()
unconditionally.
And drop the #ifdef around ath10k\_pci\_hif\_{suspend,resume}() too; they
are trivial (empty), so we're not saving much space by compiling them
out. And the alternatives would be to sprinkle more \_\_maybe\_unused, or
spread the #ifdef's further.
Build tested with the following combinations:
CONFIG\_PM=y && CONFIG\_PM\_SLEEP=y
CONFIG\_PM=y && CONFIG\_PM\_SLEEP=n
CONFIG\_PM=n
Fixes: 96378bd2c6cd ("ath10k: fix core PCI suspend when WoWLAN is supported but disabled")
Fixes: 096ad2a15fd8 ("Merge branch 'ath-next'")
Signed-off-by: Brian Norris
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5c212b59ded7fc9382e1c55c100f82709cf542ca
Author: Brian Norris
Date: Wed Oct 4 12:22:55 2017 +0300
ath10k: fix core PCI suspend when WoWLAN is supported but disabled
[ Upstream commit 96378bd2c6cda5f04d0f6da2cd35d4670a982c38 ]
For devices where the FW supports WoWLAN but user-space has not
configured it, we don't do any PCI-specific suspend/resume operations,
because mac80211 doesn't call drv\_suspend() when !wowlan. This has
particularly bad effects for some platforms, because we don't stop the
power-save timer, and if this timer goes off after the PCI controller
has suspended the link, Bad Things will happen.
Commit 32faa3f0ee50 ("ath10k: add the PCI PM core suspend/resume ops")
got some of this right, in that it understood there was a problem on
non-WoWLAN firmware. But it forgot the $subject case.
Fix this by moving all the PCI driver suspend/resume logic exclusively
into the driver PM hooks. This shouldn't affect WoWLAN support much
(this just gets executed later on).
I would just as well kill the entirety of ath10k\_hif\_suspend(), as it's
not even implemented on the USB or SDIO drivers. I expect that we don't
need the callback, except to return "supported" (i.e., 0) or "not
supported" (i.e., -EOPNOTSUPP).
Fixes: 32faa3f0ee50 ("ath10k: add the PCI PM core suspend/resume ops")
Fixes: 77258d409ce4 ("ath10k: enable pci soc powersaving")
Signed-off-by: Brian Norris
Cc: Ryan Hsu
Cc: Kalle Valo
Cc: Michal Kazior
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e37eb54a000c767e7f39b806fb048c4be75ed786
Author: Miaoqing Pan
Date: Wed Sep 27 09:13:34 2017 +0800
ath9k: fix tx99 potential info leak
[ Upstream commit ee0a47186e2fa9aa1c56cadcea470ca0ba8c8692 ]
When the user sets count to zero the string buffer would remain
completely uninitialized which causes the kernel to parse its
own stack data, potentially leading to an info leak. In addition
to that, the string might be not terminated properly when the
user data does not contain a 0-terminator.
Signed-off-by: Miaoqing Pan
Reviewed-by: Christoph Böhmwalder
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 99ab42f783da58540c80c91a2af8e8c764c46ca8
Author: Rakesh Pandit
Date: Fri Oct 13 14:45:56 2017 +0200
lightnvm: pblk: protect line bitmap while submitting meta io
[ Upstream commit e57903fd972a398b7140d0bc055714e13a0e58c5 ]
It seems pblk\_dealloc\_page would race against pblk\_alloc\_pages for
line bitmap for sector allocation.The chances are very low but might
as well protect the bitmap properly.
Signed-off-by: Rakesh Pandit
Reviewed-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 136e415e7a6a7d3d8666560b2147145c7636a455
Author: Javier González
Date: Fri Oct 13 14:46:06 2017 +0200
lightnvm: pblk: fix min size for page mempool
[ Upstream commit bd432417681a224d9fa4a9d43be7d4edc82135b2 ]
pblk uses an internal page mempool for allocating pages on internal
bios. The main two users of this memory pool are partial reads (reads
with some sectors in cache and some on media) and padded writes, which
need to add dummy pages to an existing bio already containing valid
data (and with a large enough bioset allocated). In both cases, the
maximum number of pages per bio is defined by the maximum number of
physical sectors supported by the underlying device.
This patch fixes a bad mempool allocation, where the min\_nr of elements
on the pool was fixed (to 16), which is lower than the maximum number
of sectors supported by NVMe (as of the time for this patch). Instead,
use the maximum number of allowed sectors reported by the device.
Reported-by: Jens Axboe
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 83ef2175ba013ab5ec9b1ec50944ba60a6af888d
Author: Javier González
Date: Fri Oct 13 14:46:01 2017 +0200
lightnvm: pblk: initialize debug stat counter
[ Upstream commit a1121176ff757e3c073490a69608ea0b18a00ec1 ]
Initialize the stat counter for garbage collected reads.
Fixes: a4bd217b43268 ("lightnvm: physical block device (pblk) target")
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8594a9a79c390fc99c8d8af21b3208396c94b231
Author: Javier González
Date: Fri Oct 13 14:46:02 2017 +0200
lightnvm: pblk: use right flag for GC allocation
[ Upstream commit 7d327a9ed6c4dca341ebf99012e0a6b80a3050e6 ]
The data buffer for the GC path allocates virtual memory through
vmalloc. When this change was introduced, a flag signaling kmalloc'ed
memory was wrongly introduced. Use the right flag when creating a bio
from this buffer.
Fixes: de54e703a422 ("lightnvm: pblk: use vmalloc for GC data buffer")
Signed-off-by: Javier González
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e22f692fbabafe322db0c3821e02a5d6da350bef
Author: Rakesh Pandit
Date: Fri Oct 13 14:46:28 2017 +0200
lightnvm: pblk: fix changing GC group list for a line
[ Upstream commit 27b978725d895e704aab44b99242a0514485d798 ]
pblk\_line\_gc\_list seems to had a bug since the introduction of pblk in
getting GC list for a line. In b20ba1bc7 while redesigning the GC
algorithm, the naming for the GC thresholds was altered, but the
values for high\_thrs and mid\_thrs were not. The result is that when
moving to the GC lists, the mid threshold is never evaluated.
Fixes: a4bd217b4("lightnvm: physical block device (pblk) target")
Signed-off-by: Rakesh Pandit
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1b07f7511a773db3a165b0a2eca35df5ba6dd1d3
Author: Hans Holmberg
Date: Fri Oct 13 14:46:34 2017 +0200
lightnvm: pblk: prevent gc kicks when gc is not operational
[ Upstream commit 3e3a5b8ebd5d3b1d68facc58b0674a2564653222 ]
GC can be kicked after it has been shut down when closing the last
line during exit, resulting in accesses to freed structures.
Make sure that GC is not triggered while it is not operational.
Also make sure that GC won't be re-activated during exit when
running on another processor by using timer\_del\_sync.
Signed-off-by: Hans Holmberg
Signed-off-by: Matias Bjørling
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e6a9d261e95f5ba5cda38ca9c6b7e580656032c4
Author: Matteo Croce
Date: Thu Oct 12 16:12:37 2017 +0200
icmp: don't fail on fragment reassembly time exceeded
[ Upstream commit 258bbb1b0e594ad5f5652cb526b3c63e6a7fad3d ]
The ICMP implementation currently replies to an ICMP time exceeded message
(type 11) with an ICMP host unreachable message (type 3, code 1).
However, time exceeded messages can either represent "time to live exceeded
in transit" (code 0) or "fragment reassembly time exceeded" (code 1).
Unconditionally replying to "fragment reassembly time exceeded" with
host unreachable messages might cause unjustified connection resets
which are now easily triggered as UFO has been removed, because, in turn,
sending large buffers triggers IP fragmentation.
The issue can be easily reproduced by running a lot of UDP streams
which is likely to trigger IP fragmentation:
# start netserver in the test namespace
ip netns add test
ip netns exec test netserver
# create a VETH pair
ip link add name veth0 type veth peer name veth0 netns test
ip link set veth0 up
ip -n test link set veth0 up
for i in $(seq 20 29); do
# assign addresses to both ends
ip addr add dev veth0 192.168.$i.1/24
ip -n test addr add dev veth0 192.168.$i.2/24
# start the traffic
netperf -L 192.168.$i.1 -H 192.168.$i.2 -t UDP\_STREAM -l 0 &
done
# wait
send\_data: data send error: No route to host (errno 113)
netperf: send\_omni: send\_data failed: No route to host
We need to differentiate instead: if fragment reassembly time exceeded
is reported, we need to silently drop the packet,
if time to live exceeded is reported, maintain the current behaviour.
In both cases increment the related error count "icmpInTimeExcds".
While at it, fix a typo in a comment, and convert the if statement
into a switch to mate it more readable.
Signed-off-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 023bff1b335860493dce3769c942b0172ea0fb5a
Author: Alex Vesker
Date: Tue Oct 10 10:36:41 2017 +0300
IB/ipoib: Grab rtnl lock on heavy flush when calling ndo\_open/stop
[ Upstream commit b4b678b06f6eef18bff44a338c01870234db0bc9 ]
When ndo\_open and ndo\_stop are called RTNL lock should be held.
In this specific case ipoib\_ib\_dev\_open calls the offloaded ndo\_open
which re-sets the number of TX queue assuming RTNL lock is held.
Since RTNL lock is not held, RTNL assert will fail.
Signed-off-by: Alex Vesker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 02ef1dd301c2f1ca0ffe58f75bf2f0f4bd291270
Author: Bart Van Assche
Date: Wed Oct 11 10:48:45 2017 -0700
RDMA/cma: Avoid triggering undefined behavior
[ Upstream commit c0b64f58e8d49570aa9ee55d880f92c20ff0166b ]
According to the C standard the behavior of computations with
integer operands is as follows:
\* A computation involving unsigned operands can never overflow,
because a result that cannot be represented by the resulting
unsigned integer type is reduced modulo the number that is one
greater than the largest value that can be represented by the
resulting type.
\* The behavior for signed integer underflow and overflow is
undefined.
Hence only use unsigned integers when checking for integer
overflow.
This patch is what I came up with after having analyzed the
following smatch warnings:
drivers/infiniband/core/cma.c:3448: cma\_resolve\_ib\_udp() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
drivers/infiniband/core/cma.c:3505: cma\_connect\_ib() warn: signed overflow undefined. 'offset + conn\_param->private\_data\_len < conn\_param->private\_data\_len'
Signed-off-by: Bart Van Assche
Acked-by: Sean Hefty
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9fc290e529b4948b2b18fa943d8bd5c3a5d5b6e1
Author: Bart Van Assche
Date: Wed Oct 11 10:48:43 2017 -0700
IB/core: Fix endianness annotation in rdma\_is\_multicast\_addr()
[ Upstream commit 1c3aea2bc8f0b2e5b57375ead40457ff75a3a2ec ]
Since ipv4\_addr is a big endian 32-bit number, annotate it as such.
Fixes: commit be1d325a3358 ("IB/core: Set RoCEv2 MGID according to spec")
Signed-off-by: Bart Van Assche
Reviewed-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f7af60377ec05e2452a73c349b4fa2a4196480c8
Author: Alexander Duyck
Date: Fri Oct 13 13:40:24 2017 -0700
macvlan: Only deliver one copy of the frame to the macvlan interface
[ Upstream commit dd6b9c2c332b40f142740d1b11fb77c653ff98ea ]
This patch intoduces a slight adjustment for macvlan to address the fact
that in source mode I was seeing two copies of any packet addressed to the
macvlan interface being delivered where there should have been only one.
The issue appears to be that one copy was delivered based on the source MAC
address and then the second copy was being delivered based on the
destination MAC address. To fix it I am just treating a unicast address
match as though it is not a match since source based macvlan isn't supposed
to be matching based on the destination MAC anyway.
Fixes: 79cf79abce71 ("macvlan: add source mode")
Signed-off-by: Alexander Duyck
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d9490e7ca55bafac97fa65a3d34244386469eb50
Author: Jan Kara
Date: Mon Oct 16 11:38:11 2017 +0200
udf: Avoid overflow when session starts at large offset
[ Upstream commit abdc0eb06964fe1d2fea6dd1391b734d0590365d ]
When session starts beyond offset 2^31 the arithmetics in
udf\_check\_vsd() would overflow. Make sure the computation is done in
large enough type.
Reported-by: Cezary Sliwa
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 42364042b7dd4ba7fed36c1db0a157c7c48282ca
Author: Chuck Lever
Date: Mon Oct 9 12:03:26 2017 -0400
xprtrdma: Don't defer fencing an async RPC's chunks
[ Upstream commit 8f66b1a529047a972cb9602a919c53a95f3d7a2b ]
In current kernels, waiting in xprt\_release appears to be safe to
do. I had erroneously believed that for ASYNC RPCs, waiting of any
kind in xprt\_release->xprt\_rdma\_free would result in deadlock. I've
done injection testing and consulted with Trond to confirm that
waiting in the RPC release path is safe.
For the very few times where RPC resources haven't yet been released
earlier by the reply handler, it is safe to wait synchronously in
xprt\_rdma\_free for invalidation rather than defering it to MR
recovery.
Note: When the QP is error state, posting a LocalInvalidate should
flush and mark the MR as bad. There is no way the remote HCA can
access that MR via a QP in error state, so it is effectively already
inaccessible and thus safe for the Upper Layer to access. The next
time the MR is used it should be recognized and cleaned up properly
by frwr\_op\_map.
Signed-off-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 46788d19e137fc48d93f0a29eade2e02e05317f6
Author: Guoqing Jiang
Date: Fri Sep 29 09:16:43 2017 +0800
md-cluster: fix wrong condition check in raid1\_write\_request
[ Upstream commit 385f4d7f946b08f36f68b0a28e95a319925b6b62 ]
The check used here is to avoid conflict between write and
resync, however we used the wrong logic, it should be the
inverse of the checking inside "if".
Fixes: 589a1c4 ("Suspend writes in RAID1 if within range")
Signed-off-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 339aba679813ff1fabde362147919d3f6e536568
Author: Artur Paszkiewicz
Date: Fri Sep 29 22:54:19 2017 +0200
raid5-ppl: check recovery\_offset when performing ppl recovery
[ Upstream commit 07719ff767dcd8cc42050f185d332052f3816546 ]
If starting an array that is undergoing rebuild, make ppl recovery honor
the recovery\_offset of a member disk and don't read data that is not yet
in-sync.
Signed-off-by: Artur Paszkiewicz
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b197f67ccfeb86d180a152796b5e3b7de1f611ef
Author: Dan Carpenter
Date: Wed Oct 4 10:50:37 2017 +0300
scsi: bfa: integer overflow in debugfs
[ Upstream commit 3e351275655d3c84dc28abf170def9786db5176d ]
We could allocate less memory than intended because we do:
bfad->regdata = kzalloc(len << 2, GFP\_KERNEL);
The shift can overflow leading to a crash. This is debugfs code so the
impact is very small. I fixed the network version of this in March with
commit 13e2d5187f6b ("bna: integer overflow bug in debugfs").
Fixes: ab2a9ba189e8 ("[SCSI] bfa: add debugfs support")
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dd2581c675e4311abc68826c25ec2563bccb3337
Author: weiping zhang
Date: Thu Oct 12 14:56:44 2017 +0800
scsi: sd: change allow\_restart to bool in sysfs interface
[ Upstream commit 658e9a6dc1126f21fa417cd213e1cdbff8be0ba2 ]
/sys/class/scsi\_disk/0:2:0:0/allow\_restart can be changed to 0
unexpectedly by writing an invalid string such as the following:
echo asdf > /sys/class/scsi\_disk/0:2:0:0/allow\_restart
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 47b5dbdd983e0319cd5d135bbfe7e564f4bbaabc
Author: weiping zhang
Date: Thu Oct 12 14:57:06 2017 +0800
scsi: sd: change manage\_start\_stop to bool in sysfs interface
[ Upstream commit 623401ee33e42cee64d333877892be8db02951eb ]
/sys/class/scsi\_disk/0:2:0:0/manage\_start\_stop can be changed to 0
unexpectly by writing an invalid string.
Signed-off-by: weiping zhang
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fc8f4ca137d9525b6f7db4b1d3e8f07a087518ec
Author: Wei Yongjun
Date: Tue Oct 17 12:11:46 2017 +0000
nullb: fix error return code in null\_init()
[ Upstream commit 30c516d750396c5f3ec9cb04c9e025c25e91495e ]
Fix to return error code -ENOMEM from the null\_alloc\_dev() error
handling case instead of 0, as done elsewhere in this function.
Fixes: 2984c8684f96 ("nullb: factor disk parameters")
Signed-off-by: Wei Yongjun
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c97e41076a298dbc4e910c33048e553658388eed
Author: Colin Ian King
Date: Tue Oct 17 16:54:52 2017 +0100
ipmi\_si: fix memory leak on new\_smi
[ Upstream commit c0a32fe13cd323ca9420500b16fd69589c9ba91e ]
The error exit path omits kfree'ing the allocated new\_smi, causing a memory
leak. Fix this by kfree'ing new\_smi.
Detected by CoverityScan, CID#14582571 ("Resource Leak")
Fixes: 7e030d6dff71 ("ipmi: Prefer ACPI system interfaces over SMBIOS ones")
Signed-off-by: Colin Ian King
Signed-off-by: Corey Minyard
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f2d81d0f030afc7a873bb3454eaf59f384543baf
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:07 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_disassoc\_cmd
[ Upstream commit 08880f8e08cbd814e870e9d3ab9530abc1bce226 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_set\_802\_11\_bssid(acquire the spinlock)
rtw\_disassoc\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f898f36664a5d64a55c1257e55dfacaae6a86bb7
Author: Jia-Ju Bai
Date: Sun Oct 8 19:54:45 2017 +0800
rtl8188eu: Fix a possible sleep-in-atomic bug in rtw\_createbss\_cmd
[ Upstream commit 2bf9806d4228f7a6195f8e03eda0479d2a93b411 ]
The driver may sleep under a spinlock, and the function call path is:
rtw\_surveydone\_event\_callback(acquire the spinlock)
rtw\_createbss\_cmd
kzalloc(GFP\_KERNEL) --> may sleep
To fix it, GFP\_KERNEL is replaced with GFP\_ATOMIC.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f18b2039d904f344dae779451592814e2c646686
Author: Don Hiatt
Date: Mon Oct 9 12:38:12 2017 -0700
IB/hfi1: Mask out A bit from psn trace
[ Upstream commit d0a2f454713a42447ee4007582c0e43c47bcf230 ]
The trace logic prior to the fixes below used to mask the
A bit from the psn. It now mistakenly displays the A bit,
which is already displayed separately.
Fix by adding the appropriate mask to the psn tracing.
Fixes: 228d2af1b723 ("IB/hfi1: Separate input/output header tracing")
Fixes: 863cf89d472f ("IB/hfi1: Add 16B trace support")
Reviewed-by: Mike Marciniszyn
Signed-off-by: Don Hiatt
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4e2836b43102633dc9bffbc170be43e1d147914c
Author: Jia-Ju Bai
Date: Mon Oct 9 16:45:55 2017 +0800
vt6655: Fix a possible sleep-in-atomic bug in vt6655\_suspend
[ Upstream commit 42c8eb3f6e15367981b274cb79ee4657e2c6949d ]
The driver may sleep under a spinlock, and the function call path is:
vt6655\_suspend (acquire the spinlock)
pci\_set\_power\_state
\_\_pci\_start\_power\_transition (drivers/pci/pci.c)
msleep --> may sleep
To fix it, pci\_set\_power\_state is called without having a spinlock.
This bug is found by my static analysis tool and my code review.
Signed-off-by: Jia-Ju Bai
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b57259ca055f7f2c7237dcc0e5aac446b2fa6da9
Author: Parav Pandit
Date: Mon Oct 16 08:45:16 2017 +0300
IB/core: Fix calculation of maximum RoCE MTU
[ Upstream commit 99260132fde7bddc6e0132ce53da94d1c9ccabcb ]
The original code only took into consideration the largest header
possible after the IB\_BTH\_BYTES. This was incorrect, as the largest
possible header size is the largest possible combination of headers we
might run into. The new code accounts for all possible headers in the
largest possible combination and subtracts that from the MTU to make
sure that all packets will fit on the wire.
Link: https://www.spinics.net/lists/linux-rdma/msg54558.html
Fixes: 3c86aa70bf67 ("RDMA/cm: Add RDMA CM support for IBoE devices")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Reported-by: Roland Dreier
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cb27c88b080274e5f94ae7a7c4da7275925ab33
Author: Parav Pandit
Date: Mon Oct 16 08:45:15 2017 +0300
IB/core: Fix use workqueue without WQ\_MEM\_RECLAIM
[ Upstream commit 39baf10310e6669564a485b55267fae70a4e44ae ]
The IB/core provides address resolution service and invokes callback
handler when address resolve request completes of requester in worker
thread context.
Such caller might allocate or free memory in callback handler
depending on the completion status to make further progress or to
terminate a connection. Most ULPs resolve route which involves
allocating route entry and path record elements in callback event handler.
It has been noticed that WQ\_MEM\_RECLAIM flag should not be used for
workers that tend to allocate memory in this [1] thread discussion.
In order to mitigate this situation, WQ\_MEM\_RECLAIM flag was dropped for
other such WQs in this [2] patch.
Similar problem might arise with address resolution path, though its not
yet noticed. The ib\_addr workqueue is not memory reclaim path due to its
nature of invoking callback that might allocate memory or don't free any
memory under memory pressure.
[1] https://www.spinics.net/lists/linux-rdma/msg53239.html
[2] https://www.spinics.net/lists/linux-rdma/msg53416.html
Fixes: f54816261c2b ("IB/addr: Remove deprecated create\_singlethread\_workqueue")
Fixes: 5fff41e1f89d ("IB/core: Fix race condition in resolving IP to MAC")
Signed-off-by: Parav Pandit
Reviewed-by: Daniel Jurgens
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 84607a2958762c94741fc96e947e6a134cd5f5c3
Author: Kurt Garloff
Date: Tue Oct 17 09:10:45 2017 +0200
scsi: scsi\_devinfo: Add REPORTLUN2 to EMC SYMMETRIX blacklist entry
[ Upstream commit 909cf3e16a5274fe2127cf3cea5c8dba77b2c412 ]
All EMC SYMMETRIX support REPORT\_LUNS, even if configured to report
SCSI-2 for whatever reason.
Signed-off-by: Kurt Garloff
Signed-off-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8151940acc356ba61e0992f464fca38118860c31
Author: NeilBrown
Date: Tue Oct 17 16:18:36 2017 +1100
raid5: Set R5\_Expanded on parity devices as well as data.
[ Upstream commit 235b6003fb28f0dd8e7ed8fbdb088bb548291766 ]
When reshaping a fully degraded raid5/raid6 to a larger
nubmer of devices, the new device(s) are not in-sync
and so that can make the newly grown stripe appear to be
"failed".
To avoid this, we set the R5\_Expanded flag to say "Even though
this device is not fully in-sync, this block is safe so
don't treat the device as failed for this stripe".
This flag is set for data devices, not not for parity devices.
Consequently, if you have a RAID6 with two devices that are partly
recovered and a spare, and start a reshape to include the spare,
then when the reshape gets past the point where the recovery was
up to, it will think the stripes are failed and will get into
an infinite loop, failing to make progress.
So when contructing parity on an EXPAND\_READY stripe,
set R5\_Expanded.
Reported-by: Curt
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 57db94d4b72479c6c1e31d18e83a581d5d6d0ee9
Author: Linus Walleij
Date: Wed Oct 11 11:57:15 2017 +0200
pinctrl: adi2: Fix Kconfig build problem
[ Upstream commit 1c363531dd814dc4fe10865722bf6b0f72ce4673 ]
The build robot is complaining on Blackfin:
drivers/pinctrl/pinctrl-adi2.c: In function 'port\_setup':
>> drivers/pinctrl/pinctrl-adi2.c:221:21: error: dereferencing
pointer to incomplete type 'struct gpio\_port\_t'
writew(readw(&regs->port\_fer) & ~BIT(offset),
^~
drivers/pinctrl/pinctrl-adi2.c: In function 'adi\_gpio\_ack\_irq':
>> drivers/pinctrl/pinctrl-adi2.c:266:18: error: dereferencing
pointer to incomplete type 'struct bfin\_pint\_regs'
if (readl(&regs->invert\_set) & pintbit)
^~
It seems the driver need to include  and
to compile.
The Blackfin architecture was re-defining the Kconfig
PINCTRL symbol which is not OK, so replaced this with
PINCTRL\_BLACKFIN\_ADI2 which selects PINCTRL and PINCTRL\_ADI2
just like most arches do.
Further, the old GPIO driver symbol GPIO\_ADI was possible to
select at the same time as selecting PINCTRL. This was not
working because the arch-local  header contains
an explicit #ifndef PINCTRL clause making compilation break
if you combine them. The same is true for DEBUG\_MMRS.
Make sure the ADI2 pinctrl driver is not selected at the same
time as the old GPIO implementation. (This should be converted
to use gpiolib or pincontrol and move to drivers/...) Also make
sure the old GPIO\_ADI driver or DEBUG\_MMRS is not selected at
the same time as the new PINCTRL implementation, and only make
PINCTRL\_ADI2 selectable for the Blackfin families that actually
have it.
This way it is still possible to add e.g. I2C-based pin
control expanders on the Blackfin.
Cc: Steven Miao
Cc: Huanhuan Feng
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4684da79d20edf232e33442775506e600fc4fe6f
Author: Ross Zwisler
Date: Wed Oct 18 12:21:55 2017 -0600
dev/dax: fix uninitialized variable build warning
[ Upstream commit 0a3ff78699d1817e711441715d22665475466036 ]
Fix this build warning:
warning: 'phys' may be used uninitialized in this function
[-Wuninitialized]
As reported here:
https://lkml.org/lkml/2017/10/16/152
http://kisskb.ellerman.id.au/kisskb/buildresult/13181373/log/
Signed-off-by: Ross Zwisler
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 93fc8284472124140a7946c4e5f555e06808f4a2
Author: nixiaoming
Date: Fri Sep 15 17:45:56 2017 +0800
tty fix oops when rmmod 8250
[ Upstream commit c79dde629d2027ca80329c62854a7635e623d527 ]
After rmmod 8250.ko
tty\_kref\_put starts kwork (release\_one\_tty) to release proc interface
oops when accessing driver->driver\_name in proc\_tty\_unregister\_driver
Use jprobe, found driver->driver\_name point to 8250.ko
static static struct uart\_driver serial8250\_reg
.driver\_name= serial,
Use name in proc\_dir\_entry instead of driver->driver\_name to fix oops
test on linux 4.1.12:
BUG: unable to handle kernel paging request at ffffffffa01979de
IP: [] strchr+0x0/0x30
PGD 1a0d067 PUD 1a0e063 PMD 851c1f067 PTE 0
Oops: 0000 [#1] PREEMPT SMP
Modules linked in: ... ... [last unloaded: 8250]
CPU: 7 PID: 116 Comm: kworker/7:1 Tainted: G O 4.1.12 #1
Hardware name: Insyde RiverForest/Type2 - Board Product Name1, BIOS NE5KV904 12/21/2015
Workqueue: events release\_one\_tty
task: ffff88085b684960 ti: ffff880852884000 task.ti: ffff880852884000
RIP: 0010:[] [] strchr+0x0/0x30
RSP: 0018:ffff880852887c90 EFLAGS: 00010282
RAX: ffffffff81a5eca0 RBX: ffffffffa01979de RCX: 0000000000000004
RDX: ffff880852887d10 RSI: 000000000000002f RDI: ffffffffa01979de
RBP: ffff880852887cd8 R08: 0000000000000000 R09: ffff88085f5d94d0
R10: 0000000000000195 R11: 0000000000000000 R12: ffffffffa01979de
R13: ffff880852887d00 R14: ffffffffa01979de R15: ffff88085f02e840
FS: 0000000000000000(0000) GS:ffff88085f5c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffa01979de CR3: 0000000001a0c000 CR4: 00000000001406e0
Stack:
ffffffff812349b1 ffff880852887cb8 ffff880852887d10 ffff88085f5cd6c2
ffff880852800a80 ffffffffa01979de ffff880852800a84 0000000000000010
ffff88085bb28bd8 ffff880852887d38 ffffffff812354f0 ffff880852887d08
Call Trace:
[] ? \_\_xlate\_proc\_name+0x71/0xd0
[] remove\_proc\_entry+0x40/0x180
[] ? \_raw\_spin\_lock\_irqsave+0x41/0x60
[] ? destruct\_tty\_driver+0x60/0xe0
[] proc\_tty\_unregister\_driver+0x28/0x40
[] destruct\_tty\_driver+0x88/0xe0
[] tty\_driver\_kref\_put+0x1d/0x20
[] release\_one\_tty+0x5a/0xd0
[] process\_one\_work+0x139/0x420
[] worker\_thread+0x121/0x450
[] ? process\_scheduled\_works+0x40/0x40
[] kthread+0xec/0x110
[] ? tg\_rt\_schedulable+0x210/0x220
[] ? kthread\_freezable\_should\_stop+0x80/0x80
[] ret\_from\_fork+0x42/0x70
[] ? kthread\_freezable\_should\_stop+0x80/0x80
Signed-off-by: nixiaoming
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b53af57679492180417d584be410b1134de15cd2
Author: Wanpeng Li
Date: Thu Oct 19 07:00:34 2017 +0800
KVM: nVMX: Fix EPT switching advertising
[ Upstream commit 575b3a2cb439b03fd603ea77c73c76f3ed237596 ]
I can use vmxcap tool to observe "EPTP Switching yes" even if EPT is not
exposed to L1.
EPT switching is advertised unconditionally since it is emulated, however,
it can be treated as an extended feature for EPT and it should not be
advertised if EPT itself is not exposed. This patch fixes it.
Reviewed-by: David Hildenbrand
Cc: Paolo Bonzini
Cc: Radim Krčmář
Cc: Jim Mattson
Signed-off-by: Wanpeng Li
Signed-off-by: Radim Krčmář
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fdfcb06c5944afb78007cfc25e527ff689b2a344
Author: Eric Dumazet
Date: Wed Oct 18 17:02:03 2017 -0700
ipv4: ipv4\_default\_advmss() should use route mtu
[ Upstream commit 164a5e7ad531e181334a3d3f03d0d5ad20d6faea ]
ipv4\_default\_advmss() incorrectly uses the device MTU instead
of the route provided one. IPv6 has the proper behavior,
lets harmonize the two protocols.
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 48185ffb6dc3eb64846039117d76148d3e3d7022
Author: Matthias Brugger
Date: Sat Oct 21 10:17:47 2017 +0200
soc: mediatek: pwrap: fix compiler errors
[ Upstream commit fb2c1934f30577756e55e24e8870b45c78da3bc2 ]
When compiling using sparse, we got the following error:
drivers/soc/mediatek/mtk-pmic-wrap.c:686:25: error: dubious one-bit signed bitfield
Changing the data type to unsigned fixes this.
Signed-off-by: Matthias Brugger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9cd01922985ce5c00cf050f12daef304cc452761
Author: Breno Leitao
Date: Tue Oct 17 16:20:18 2017 -0200
powerpc/xmon: Check before calling xive functions
[ Upstream commit 402e172a2ce76210f2fe921cf419d12103851344 ]
Currently xmon could call XIVE functions from OPAL even if the XIVE is
disabled or does not exist in the system, as in POWER8 machines. This
causes the following exception:
1:mon> dx
cpu 0x1: Vector: 700 (Program Check) at [c000000423c93450]
pc: c00000000009cfa4: opal\_xive\_dump+0x50/0x68
lr: c0000000000997b8: opal\_return+0x0/0x50
This patch simply checks if XIVE is enabled before calling XIVE
functions.
Fixes: 243e25112d06 ("powerpc/xive: Native exploitation of the XIVE interrupt controller")
Suggested-by: Guilherme G. Piccoli
Signed-off-by: Breno Leitao
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8ee1eada4f1a6671517dc51f6bc11174faebea02
Author: Michael Ellerman
Date: Mon Oct 9 21:52:44 2017 +1100
powerpc/perf/hv-24x7: Fix incorrect comparison in memord
[ Upstream commit 05c14c03138532a3cb2aa29c2960445c8753343b ]
In the hv-24x7 code there is a function memord() which tries to
implement a sort function return -1, 0, 1. However one of the
conditions is incorrect, such that it can never be true, because we
will have already returned.
I don't believe there is a bug in practice though, because the
comparisons are an optimisation prior to calling memcmp().
Fix it by swapping the second comparision, so it can be true.
Reported-by: David Binderman
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b59dc14b0b102d42d6bd54ae77848ddc00a4596c
Author: Johan Hovold
Date: Mon Oct 16 15:06:19 2017 +0200
serdev: ttyport: enforce tty-driver open() requirement
[ Upstream commit dee7d0f3b200c67c6ee96bd37c6e8fa52690ab56 ]
The tty-driver open routine is mandatory, but the serdev
tty-port-controller implementation did not treat it as such and would
instead fall back to calling tty\_port\_open() directly.
Signed-off-by: Johan Hovold
Acked-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 669ff2a9aa71edea93a0b74c1273080cad68dfb7
Author: Lipeng
Date: Mon Oct 23 19:51:01 2017 +0800
net: hns3: fix a bug when alloc new buffer
[ Upstream commit b9077428ec5569aacb2952d8a2ffb51c8988d3c2 ]
When alloce new buffer to HW, should unmap the old buffer first.
This old code map the old buffer but not unmap the old buffer,
this patch fixes it.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 122e18d27d77031b909a06f110f6da225502d033
Author: Lipeng
Date: Mon Oct 23 19:51:02 2017 +0800
net: hns3: fix the bug when map buffer fail
[ Upstream commit 564883bb4dc1a4f3cba6344e77743175694b0761 ]
If one buffer had been recieved to stack, driver will alloc a new buffer,
map the buffer to device and replace the old buffer. When map fail, should
only free the new alloced buffer, but not free all buffers in the ring.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9409e1c775f35b2571be427cde272ce80cdc19e7
Author: Lipeng
Date: Mon Oct 23 19:51:05 2017 +0800
net: hns3: fix the TX/RX ring.queue\_index in hns3\_ring\_get\_cfg
[ Upstream commit 66b447301ac710ee237dba8b653244018fbb6168 ]
The interface hns3\_ring\_get\_cfg only update TX ring queue\_index,
but do not update RX ring queue\_index. This patch fixes it.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aeb01451f9e2d3e9b2ac2ad30426c68957c307ed
Author: Alexey Khoroshilov
Date: Sat Oct 14 01:06:56 2017 +0300
mfd: mxs-lradc: Fix error handling in mxs\_lradc\_probe()
[ Upstream commit 362741a21a5c4b9ee31e75ce28d63c6d238a745c ]
There is the only path, where mxs\_lradc\_probe() leaves clk undisabled,
since it does return instead of goto err\_clk.
Found by Linux Driver Verification project (linuxtesting.org).
Signed-off-by: Alexey Khoroshilov
Signed-off-by: Lee Jones
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 8268e93b2b879912ae84952acef17e4c78f3b66d
Author: Martin Wilck
Date: Fri Oct 20 16:51:08 2017 -0500
scsi: hpsa: destroy sas transport properties before scsi\_host
[ Upstream commit dfb2e6f46b3074eb85203d8f0888b71ec1c2e37a ]
This patch cleans up a lot of warnings when unloading the driver.
A current example of the stack trace starts with:
[ 142.570715] sysfs group 'power' not found for kobject 'port-5:0'
There can be hundreds of these messages during a driver unload.
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
His original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102085.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
---------------------------
Original patch description:
---------------------------
Unloading the hpsa driver causes warnings
[ 1063.793652] WARNING: CPU: 1 PID: 4850 at ../fs/sysfs/group.c:237 device\_del+0x54/0x240()
[ 1063.793659] sysfs group ffffffff81cf21a0 not found for kobject 'port-2:0'
with two different stacks:
1)
[ 1063.793774] [] device\_del+0x54/0x240
[ 1063.793780] [] transport\_remove\_classdev+0x4a/0x60
[ 1063.793784] [] attribute\_container\_device\_trigger+0xa6/0xb0
[ 1063.793802] [] sas\_port\_delete+0x126/0x160 [scsi\_transport\_sas]
[ 1063.793819] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
2)
[ 1063.797103] [] device\_del+0x54/0x240
[ 1063.797118] [] sas\_port\_delete+0x12e/0x160 [scsi\_transport\_sas]
[ 1063.797134] [] hpsa\_free\_sas\_port+0x3c/0x70 [hpsa]
This is caused by the fact that host device hostX is deleted before the
SAS transport devices hostX/port-a:b.
This patch fixes this by reverting the order of device deletions.
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7a7797199d9b96989ab5f30eadad077a8dc7c970
Author: Martin Wilck
Date: Fri Oct 20 16:51:14 2017 -0500
scsi: hpsa: cleanup sas\_phy structures in sysfs when unloading
[ Upstream commit 55ca38b4255bb336c2d35990bdb2b368e19b435a ]
I am resubmitting this patch on behalf of Martin Wilck with his
permission.
The original patch can be found here:
https://www.spinics.net/lists/linux-scsi/msg102083.html
This patch did not help until Hannes's
commit 9441284fbc39 ("scsi-fixup-kernel-warning-during-rmmod")
was applied to the kernel.
--------------------------------------
Original patch description from Martin:
--------------------------------------
When the hpsa module is unloaded using rmmod, dangling
symlinks remain under /sys/class/sas\_phy. Fix this by
calling sas\_phy\_delete() rather than sas\_phy\_free (which,
according to comments, should not be called for PHYs that
have been set up successfully, anyway).
Tested-by: Don Brace
Reviewed-by: Don Brace
Signed-off-by: Martin Wilck
Signed-off-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b61aba91eb72efc5117d24d3f4455dcaf67f1e63
Author: Xiaofei Tan
Date: Tue Oct 24 23:51:38 2017 +0800
scsi: hisi\_sas: fix the risk of freeing slot twice
[ Upstream commit 6ba0fbc35aa9f3bc8c12be3b4047055c9ce2ac92 ]
The function hisi\_sas\_slot\_task\_free() is used to free the slot and do
tidy-up of LLDD resources. The LLDD generally should know the state of
a slot and decide when to free it, and it should only be done once.
For some scenarios, we really don't know the state, like when TMF
timeout. In this case, we check task->lldd\_task before calling
hisi\_sas\_slot\_task\_free().
However, we may miss some scenarios when we should also check
task->lldd\_task, and it is not SMP safe to check task->lldd\_task as we
don't protect it within spin lock.
This patch is to fix this risk of freeing slot twice, as follows:
1. Check task->lldd\_task in the hisi\_sas\_slot\_task\_free(), and give
up freeing of this time if task->lldd\_task is NULL.
2. Set slot->buf to NULL after it is freed.
Signed-off-by: Xiaofei Tan
Signed-off-by: John Garry
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 96ed7ca7323be977d617d077146b322e844bdcb9
Author: Alex Williamson
Date: Wed Oct 11 15:35:56 2017 -0600
PCI: Detach driver before procfs & sysfs teardown on device remove
[ Upstream commit 16b6c8bb687cc3bec914de09061fcb8411951fda ]
When removing a device, for example a VF being removed due to SR-IOV
teardown, a "soft" hot-unplug via 'echo 1 > remove' in sysfs, or an actual
hot-unplug, we first remove the procfs and sysfs attributes for the device
before attempting to release the device from any driver bound to it.
Unbinding the driver from the device can take time. The device might need
to write out data or it might be actively in use. If it's in use by
userspace through a vfio driver, the unbind might block until the user
releases the device. This leads to a potentially non-trivial amount of
time where the device exists, but we've torn down the interfaces that
userspace uses to examine devices, for instance lspci might generate this
sort of error:
pcilib: Cannot open /sys/bus/pci/devices/0000:01:0a.3/config
lspci: Unable to read the standard configuration space header of device 0000:01:0a.3
We don't seem to have any dependence on this teardown ordering in the
kernel, so let's unbind the driver first, which is also more symmetric with
the instantiation of the device in pci\_bus\_add\_device().
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 18c8d94eac0fd6c859033b2eb05941f19c3f7b4a
Author: Leon Romanovsky
Date: Wed Oct 25 07:41:11 2017 +0300
RDMA/cxgb4: Declare stag as \_\_be32
[ Upstream commit 35fb2a88ed4b77356fa679a8525c869a3594e287 ]
The scqe.stag is actually \_\_b32, fix it.
drivers/infiniband/hw/cxgb4/cq.c:754:52: warning: cast to restricted \_\_be32
Cc: Steve Wise
Signed-off-by: Leon Romanovsky
Reviewed-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9d48d002a2f68e35bea2872a5533436848f30a60
Author: Lipeng
Date: Tue Oct 24 21:02:09 2017 +0800
net: hns3: fix the bug of hns3\_set\_txbd\_baseinfo
[ Upstream commit 7036d26f328f12a323069eb16d965055b4cb3795 ]
The SC bits of TX BD mean switch control. For this area, value 0
indicates no switch control, the packet is routed according to the
forwarding table. Value 1 indicates that the packet is transmitted
to the network bypassing the forwarding table.
As HNS3 driver need support VF later, VF conmunicate with its own
PF need forwarding table. This patch sets SC bits of TX BD 0 and use
forwarding table.
Fixes: 76ad4f0 (net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1d9205558e50b7af5fe5b054bf26f93c9255786e
Author: Lipeng
Date: Tue Oct 24 21:02:10 2017 +0800
net: hns3: add nic\_client check when initialize roce base information
[ Upstream commit 3a46f34d20d453f09defb76b11a567647939c0aa ]
Roce driver works base on HNS3 driver.If insmod Roce driver before
NIC driver there is a error because do not check nic\_client. This patch
adds nic\_client check when initialize roce base information.
Fixes: 46a3df9 (net: hns3: Add HNS3 Acceleration Engine & Compatibility Layer Support)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0949f8afa8f1b9d6ebce48606e41dfcdafbaca4a
Author: Lipeng
Date: Tue Oct 24 21:02:11 2017 +0800
net: hns3: fix a bug in hclge\_uninit\_client\_instance
[ Upstream commit a17dcf3f0124698d1120da71574bf4c339e5a368 ]
HNS3 driver initialize hdev->roce\_client and vport->roce.client in
hclge\_init\_client\_instance, and need set hdev->roce\_client and
vport->roce.client NULL.
If do not set them NULL when uninit, it will fail in the scene:
insmod hns3.ko, hns-roce.ko, hns-roce-hw-v3.ko successfully, but
rmmod hns3.ko after rmmod hns-roce-hw-v2.ko and hns-roce.ko.
This patch fixes the issue.
Fixes: 46a3df9 (net: hns3: Add HNS3 Acceleration Engine & Compatibility Layer Support)
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 68a6765b70d90debde63bd26599c3422116751ef
Author: Egil Hjelmeland
Date: Tue Oct 24 17:14:10 2017 +0200
net: dsa: lan9303: Do not disable switch fabric port 0 at .probe
[ Upstream commit 3c91b0c1de8d013490bbc41ce9ee8810ea5baddd ]
Make the LAN9303 work when lan9303\_probe() is called twice.
For some unknown reason the LAN9303 switch fail to forward data when switch
fabric port 0 TX is disabled during probe. (Write of LAN9303\_MAC\_TX\_CFG\_0
in lan9303\_disable\_processing\_port().)
In that situation the switch fabric seem to receive frames, because the ALR
is learning addresses. But no frames are transmitted on any of the ports.
In our system lan9303\_probe() is called twice, first time
dsa\_register\_switch() return -EPROBE\_DEFER. As an experiment, modified the
code to skip writing LAN9303\_MAC\_TX\_CFG\_0, port 0 during the first probe.
Then the switch works as expected.
Resolve the problem by not calling lan9303\_disable\_processing\_port() on
port 0 during probe. Ports 1 and 2 are still disabled.
Although unsatisfying that the exact failure mechanism is not known,
the patch should not cause any harm.
Signed-off-by: Egil Hjelmeland
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4be2d1ad59d0d9251bd1fc618a6d1266b16e3b75
Author: Christoph Hellwig
Date: Tue Oct 17 14:16:19 2017 -0700
xfs: fix incorrect extent state in xfs\_bmap\_add\_extent\_unwritten\_real
[ Upstream commit 5e422f5e4fd71d18bc6b851eeb3864477b3d842e ]
There was one spot in xfs\_bmap\_add\_extent\_unwritten\_real that didn't use the
passed in new extent state but always converted to normal, leading to wrong
behavior when converting from normal to unwritten.
Only found by code inspection, it seems like this code path to move partial
extent from written to unwritten while merging it with the next extent is
rarely exercised.
Signed-off-by: Christoph Hellwig
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 61bc71d34a00801657591e142f374794b6dc3548
Author: Darrick J. Wong
Date: Tue Oct 17 21:37:32 2017 -0700
xfs: return a distinct error code value for IGET\_INCORE cache misses
[ Upstream commit ed438b476b611c67089760037139f93ea8ed41d5 ]
For an XFS\_IGET\_INCORE iget operation, if the inode isn't in the cache,
return ENODATA so that we don't confuse it with the pre-existing ENOENT
cases (inode is in cache, but freed).
Signed-off-by: Darrick J. Wong
Reviewed-by: Brian Foster
Reviewed-by: Dave Chinner
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 742b570da6e6447e4a98acceb27e8a7d5b436d7c
Author: Brian Foster
Date: Thu Oct 26 09:31:16 2017 -0700
xfs: fix log block underflow during recovery cycle verification
[ Upstream commit 9f2a4505800607e537e9dd9dea4f55c4b0c30c7a ]
It is possible for mkfs to format very small filesystems with too
small of an internal log with respect to the various minimum size
and block count requirements. If this occurs when the log happens to
be smaller than the scan window used for cycle verification and the
scan wraps the end of the log, the start\_blk calculation in
xlog\_find\_head() underflows and leads to an attempt to scan an
invalid range of log blocks. This results in log recovery failure
and a failed mount.
Since there may be filesystems out in the wild with this kind of
geometry, we cannot simply refuse to mount. Instead, cap the scan
window for cycle verification to the size of the physical log. This
ensures that the cycle verification proceeds as expected when the
scan wraps the end of the log.
Reported-by: Zorro Lang
Signed-off-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ff62605e0d79c870f679bcd8571bf9cb5f7e1c93
Author: Jiri Slaby
Date: Wed Oct 25 15:57:55 2017 +0200
l2tp: cleanup l2tp\_tunnel\_delete calls
[ Upstream commit 4dc12ffeaeac939097a3f55c881d3dc3523dff0c ]
l2tp\_tunnel\_delete does not return anything since commit 62b982eeb458
("l2tp: fix race condition in l2tp\_tunnel\_delete"). But call sites of
l2tp\_tunnel\_delete still do casts to void to avoid unused return value
warnings.
Kill these now useless casts.
Signed-off-by: Jiri Slaby
Cc: Sabrina Dubroca
Cc: Guillaume Nault
Cc: David S. Miller
Cc: netdev@vger.kernel.org
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4edcbfc5651276a28a1501e03198f6f16974617c
Author: Christoph Hellwig
Date: Wed Oct 18 13:20:01 2017 +0200
nvme: use kref\_get\_unless\_zero in nvme\_find\_get\_ns
[ Upstream commit 2dd4122854f697afc777582d18548dded03ce5dd ]
For kref\_get\_unless\_zero to protect against lookup vs free races we need
to use it in all places where we aren't guaranteed to already hold a
reference. There is no such guarantee in nvme\_find\_get\_ns, so switch to
kref\_get\_unless\_zero in this function.
Signed-off-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Reviewed-by: Hannes Reinecke
Reviewed-by: Johannes Thumshirn
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 21cd9fe750941100b7b4643ffd765215b6daff64
Author: Osama Khan
Date: Sat Oct 21 10:42:21 2017 +0000
platform/x86: hp\_accel: Add quirk for HP ProBook 440 G4
[ Upstream commit 163ca80013aafb6dc9cb295de3db7aeab9ab43f8 ]
Added support for HP ProBook 440 G4 laptops by including the accelerometer
orientation quirk for that device. Testing was performed based on the
axis orientation guidelines here:
https://www.kernel.org/doc/Documentation/misc-devices/lis3lv02d
which states "If the left side is elevated, X increases (becomes positive)".
When tested, on lifting the left edge, x values became increasingly negative
thus indicating an inverted x-axis on the installed lis3lv02d chip.
This was compensated by adding an entry for this device in hp\_accel.c
specifying the quirk as x\_inverted. The patch was tested on a
ProBook 440 G4 device and x-axis as well as y and z-axis values are now
generated as per spec.
Signed-off-by: Osama Khan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6bd7a9bc48ac642cb3ded1e40fcfee44c8a0aa1a
Author: Felix Manlunas
Date: Thu Oct 26 16:46:36 2017 -0700
liquidio: fix kernel panic in VF driver
[ Upstream commit aa28667cfbe4ff6f14454dda210b1f2e485f99b5 ]
Doing ifconfig down on VF driver in the middle of receiving line rate
traffic causes a kernel panic:
LiquidIO\_VF 0000:02:00.3: should not come here should not get rx when poll mode = 0 for vf
BUG: unable to handle kernel NULL pointer dereference at (null)
.
.
.
Call Trace:
? tasklet\_action+0x102/0x120
\_\_do\_softirq+0x91/0x292
irq\_exit+0xb6/0xc0
do\_IRQ+0x4f/0xd0
common\_interrupt+0x93/0x93

RIP: 0010:cpuidle\_enter\_state+0x142/0x2f0
RSP: 0018:ffffffffa6403e20 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffff59
RAX: 0000000000000000 RBX: 0000000000000003 RCX: 000000000000001f
RDX: 0000000000000000 RSI: 000000002ab7519f RDI: 0000000000000000
RBP: ffffffffa6403e58 R08: 0000000000000084 R09: 0000000000000018
R10: ffffffffa6403df0 R11: 00000000000003c7 R12: 0000000000000003
R13: ffffd27ebd806800 R14: ffffffffa64d40d8 R15: 0000007be072823f
cpuidle\_enter+0x17/0x20
call\_cpuidle+0x23/0x40
do\_idle+0x18c/0x1f0
cpu\_startup\_entry+0x64/0x70
rest\_init+0xa5/0xb0
start\_kernel+0x45e/0x46b
x86\_64\_start\_reservations+0x24/0x26
x86\_64\_start\_kernel+0x6f/0x72
secondary\_startup\_64+0xa5/0xa5
Code: Bad RIP value.
RIP: (null) RSP: ffff9246ed003f28
CR2: 0000000000000000
---[ end trace 92731e80f31b7d7d ]---
Kernel panic - not syncing: Fatal exception in interrupt
Kernel Offset: 0x24000000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
---[ end Kernel panic - not syncing: Fatal exception in interrupt
Reason is: in the function assigned to net\_device\_ops->ndo\_stop, the steps
for bringing down the interface are done in the wrong order. The step that
notifies the NIC firmware to stop forwarding packets to host is done too
late. Fix it by moving that step to the beginning.
Signed-off-by: Felix Manlunas
Signed-off-by: Raghu Vatsavayi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 06f430379273700696eef22159117789853a38e3
Author: Tushar Dave
Date: Fri Oct 27 16:12:30 2017 -0700
samples/bpf: adjust rlimit RLIMIT\_MEMLOCK for xdp1
[ Upstream commit 6dfca831c03ef654b1f7bff1b8d487d330e9f76b ]
Default rlimit RLIMIT\_MEMLOCK is 64KB, causes bpf map failure.
e.g.
[root@lab bpf]#./xdp1 -N $(
Acked-by: Alexei Starovoitov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c0f98c0dbced1c1b48fd4427075f8a5295b402fb
Author: Bartosz Chronowski
Date: Thu Oct 26 10:22:43 2017 +0200
Bluetooth: btusb: Add new NFA344A entry.
[ Upstream commit 858ff38af77fc660092e82474ecc6ac135ed29fe ]
This change allows proper low power mode entry in suspend.
/sys/kernel/debug/usb/devices entry:
T: Bus=01 Lev=01 Prnt=01 Port=05 Cnt=03 Dev#= 3 Spd=12 MxCh= 0
D: Ver= 2.01 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0489 ProdID=e09f Rev= 0.01
C:\* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=1ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 64 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 64 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
Signed-off-by: Bartosz Chronowski
Signed-off-by: Marcel Holtmann
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a54d17dba2ba4a1eaab65fd282f4b4c9bf80418b
Author: Neil Armstrong
Date: Thu Oct 19 12:31:09 2017 +0200
ARM64: dts: meson-gxbb-odroidc2: fix usb1 power supply
[ Upstream commit e841ec956e539f4002f5e9fe9f9e904dcca12d5d ]
Looking at the schematics, the USB Power Supply is shared between the
two USB interfaces,
If the usb0 fails to initialize, the second one won't have power.
Fixes: 5a0803bd5ae2 ("ARM64: dts: meson-gxbb-odroidc2: Enable USB Nodes")
Signed-off-by: Neil Armstrong
Signed-off-by: Kevin Hilman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 000a335b2d3828382bb4612ceee176a5cbd05752
Author: Geert Uytterhoeven
Date: Thu Oct 26 17:12:33 2017 +0200
mtd: spi-nor: stm32-quadspi: Fix uninitialized error return code
[ Upstream commit 05521bd3d117704a1458eb4d0c3ae821858658f2 ]
With gcc 4.1.2:
drivers/mtd/spi-nor/stm32-quadspi.c: In function ‘stm32\_qspi\_tx\_poll’:
drivers/mtd/spi-nor/stm32-quadspi.c:230: warning: ‘ret’ may be used uninitialized in this function
Indeed, if stm32\_qspi\_cmd.len is zero, ret will be uninitialized.
This length is passed from outside the driver using the
spi\_nor.{read,write}{,\_reg}() callbacks.
Several functions in drivers/mtd/spi-nor/spi-nor.c (e.g. write\_enable(),
write\_disable(), and erase\_chip()) call spi\_nor.write\_reg() with a zero
length.
Fix this by returning an explicit zero on success.
Fixes: 0d43d7ab277a048c ("mtd: spi-nor: add driver for STM32 quad spi flash controller")
Signed-off-by: Geert Uytterhoeven
Acked-by: Ludovic Barre
Signed-off-by: Cyrille Pitchen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit bca4d7e1a19cfdde2a4a340339e46248a691b196
Author: Sergey Matyukevich
Date: Mon Oct 30 13:13:46 2017 +0300
qtnfmac: modify full Tx queue error reporting
[ Upstream commit e9931f984dd1e80adb3b5e095ef175fe383bc92d ]
Under heavy load it is normal that h/w Tx queue is almost full all the time
and reclaim should be done before transmitting next packet. Warning still
should be reported as well as s/w Tx queues should be stopped in the
case when reclaim failed.
Signed-off-by: Sergey Matyukevich
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c97df8e004de63e50384706d00adb590adcef054
Author: Christophe JAILLET
Date: Sun Sep 10 13:19:38 2017 +0200
btrfs: tests: Fix a memory leak in error handling path in 'run\_test()'
[ Upstream commit 9ca2e97fa3c3216200afe35a3b111ec51cc796d2 ]
If 'btrfs\_alloc\_path()' fails, we must free the resources already
allocated, as done in the other error handling paths in this function.
Signed-off-by: Christophe JAILLET
Reviewed-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 864a5fb1c6066ade93a640a279bcd191952e4181
Author: Colin Ian King
Date: Mon Sep 11 16:15:28 2017 +0100
btrfs: avoid null pointer dereference on fs\_info when calling btrfs\_crit
[ Upstream commit 3993b112dac968612b0b213ed59cb30f50b0015b ]
There are checks on fs\_info in \_\_btrfs\_panic to avoid dereferencing a
null fs\_info, however, there is a call to btrfs\_crit that may also
dereference a null fs\_info. Fix this by adding a check to see if fs\_info
is null and only print the s\_id if fs\_info is non-null.
Detected by CoverityScan CID#401973 ("Dereference after null check")
Fixes: efe120a067c8 ("Btrfs: convert printk to btrfs\_ and fix BTRFS prefix")
Signed-off-by: Colin Ian King
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit da76a65a011490a0b0bd9f50d872f26e629d1eed
Author: Anand Jain
Date: Thu Sep 28 14:51:09 2017 +0800
btrfs: undo writable superblocke when sprouting fails
[ Upstream commit 0af2c4bf5a012a40a2f9230458087d7f068339d0 ]
When new device is being added to seed FS, seed FS is marked writable,
but when we fail to bring in the new device, we missed to undo the
writable part. This patch fixes it.
Signed-off-by: Anand Jain
Reviewed-by: Nikolay Borisov
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9e87c49d62f4c5b9ae4a56b8f62865c4712c8d4d
Author: Nikolay Borisov
Date: Thu Sep 28 10:53:17 2017 +0300
btrfs: Explicitly handle btrfs\_update\_root failure
[ Upstream commit 9417ebc8a676487c6ec8825f92fb28f7dbeb5f4b ]
btrfs\_udpate\_root can fail and it aborts the transaction, the correct
way to handle an aborted transaction is to explicitly end with
btrfs\_end\_transaction. Even now the code is correct since
btrfs\_commit\_transaction would handle an aborted transaction but this is
more of an implementation detail. So let's be explicit in handling
failure in btrfs\_update\_root.
Furthermore btrfs\_commit\_transaction can also fail and by ignoring it's
return value we could have left the in-memory copy of the root item in
an inconsistent state. So capture the error value which allows us to
correctly revert the RO/RW flags in case of commit failure.
Signed-off-by: Nikolay Borisov
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 4bcbfac98d517eae6d12257aed923347be16930c
Author: Anand Jain
Date: Sat Oct 14 08:34:02 2017 +0800
btrfs: fix false EIO for missing device
[ Upstream commit 102ed2c5ff932439bbbe74c7bd63e6d5baa9f732 ]
When one of the device is missing, bbio\_error() takes care of setting
the error status. And if its only IO that is pending in that stripe, it
fails to check the status of the other IO at %bbio\_error before setting
the error %bi\_status for the %orig\_bio. Fix this by checking if
%bbio->error has exceeded the %bbio->max\_errors.
Reproducer as below fdatasync error is seen intermittently.
mount -o degraded /dev/sdc /btrfs
dd status=none if=/dev/zero of=$(mktemp /btrfs/XXX) bs=4096 count=1 conv=fdatasync
dd: fdatasync failed for ‘/btrfs/LSe’: Input/output error
The reason for the intermittences of the problem is because
the following conditions have to be met, which depends on timing:
In btrfs\_map\_bio()
- the RAID1 the missing device has to be at %dev\_nr = 1
In bbio\_error()
. before bbio\_error() is called the bio of the not-missing
device at %dev\_nr = 0 must be completed so that the below
condition is true
if (atomic\_dec\_and\_test(&bbio->stripes\_pending)) {
Signed-off-by: Anand Jain
Reviewed-by: Liu Bo
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7bd6bf08dd5b30dbe0696a7387dedc65a5f9a3e6
Author: Nick Desaulniers
Date: Fri Oct 27 09:33:41 2017 -0700
arm64: prevent regressions in compressed kernel image size when upgrading to binutils 2.27
[ Upstream commit fd9dde6abcb9bfe6c6bee48834e157999f113971 ]
Upon upgrading to binutils 2.27, we found that our lz4 and gzip
compressed kernel images were significantly larger, resulting is 10ms
boot time regressions.
As noted by Rahul:
"aarch64 binaries uses RELA relocations, where each relocation entry
includes an addend value. This is similar to x86\_64. On x86\_64, the
addend values are also stored at the relocation offset for relative
relocations. This is an optimization: in the case where code does not
need to be relocated, the loader can simply skip processing relative
relocations. In binutils-2.25, both bfd and gold linkers did this for
x86\_64, but only the gold linker did this for aarch64. The kernel build
here is using the bfd linker, which stored zeroes at the relocation
offsets for relative relocations. Since a set of zeroes compresses
better than a set of non-zero addend values, this behavior was resulting
in much better lz4 compression.
The bfd linker in binutils-2.27 is now storing the actual addend values
at the relocation offsets. The behavior is now consistent with what it
does for x86\_64 and what gold linker does for both architectures. The
change happened in this upstream commit:
https://sourceware.org/git/?p=binutils-gdb.git;a=commit;h=1f56df9d0d5ad89806c24e71f296576d82344613
Since a bunch of zeroes got replaced by non-zero addend values, we see
the side effect of lz4 compressed image being a bit bigger.
To get the old behavior from the bfd linker, "--no-apply-dynamic-relocs"
flag can be used:
$ LDFLAGS="--no-apply-dynamic-relocs" make
With this flag, the compressed image size is back to what it was with
binutils-2.25.
If the kernel is using ASLR, there aren't additional runtime costs to
--no-apply-dynamic-relocs, as the relocations will need to be applied
again anyway after the kernel is relocated to a random address.
If the kernel is not using ASLR, then presumably the current default
behavior of the linker is better. Since the static linker performed the
dynamic relocs, and the kernel is not moved to a different address at
load time, it can skip applying the relocations all over again."
Some measurements:
$ ld -v
GNU ld (binutils-2.25-f3d35cf6) 2.25.51.20141117
^
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300652760 Oct 26 11:57 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932627 Oct 26 11:57 Image.lz4-dtb
$ ld -v
GNU ld (binutils-2.27-53dd00a1) 2.27.0.20170315
^
pre patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 11:43 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 18159474 Oct 26 11:43 Image.lz4-dtb
post patch:
$ ls -l vmlinux
-rwxr-x--- 1 ndesaulniers eng 300376208 Oct 26 12:06 vmlinux
$ ls -l Image.lz4-dtb
-rw-r----- 1 ndesaulniers eng 16932466 Oct 26 12:06 Image.lz4-dtb
By Siqi's measurement w/ gzip:
binutils 2.27 with this patch (with --no-apply-dynamic-relocs):
Image 41535488
Image.gz 13404067
binutils 2.27 without this patch (without --no-apply-dynamic-relocs):
Image 41535488
Image.gz 14125516
Any compression scheme should be able to get better results from the
longer runs of zeros, not just GZIP and LZ4.
10ms boot time savings isn't anything to get excited about, but users of
arm64+compression+bfd-2.27 should not have to pay a penalty for no
runtime improvement.
Reported-by: Gopinath Elanchezhian
Reported-by: Sindhuri Pentyala
Reported-by: Wei Wang
Suggested-by: Ard Biesheuvel
Suggested-by: Rahul Chaudhry
Suggested-by: Siqi Lin
Suggested-by: Stephen Hines
Signed-off-by: Nick Desaulniers
Reviewed-by: Ard Biesheuvel
[will: added comment to Makefile]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e508e6026b198b9879e0d1850fdef8ef1d4d0805
Author: Ronald Tschalär
Date: Wed Oct 25 22:15:19 2017 -0700
Bluetooth: hci\_ldisc: Fix another race when closing the tty.
[ Upstream commit 0338b1b393ec7910898e8f7b25b3bf31a7282e16 ]
The following race condition still existed:
P1 P2
cancel\_work\_sync()
hci\_uart\_tx\_wakeup()
hci\_uart\_write\_work()
hci\_uart\_dequeue()
clear\_bit(HCI\_UART\_PROTO\_READY)
hci\_unregister\_dev(hdev)
hci\_free\_dev(hdev)
hu->proto->close(hu)
kfree(hu)
access to hdev and hu
Cancelling the work after clearing the HCI\_UART\_PROTO\_READY bit avoids
this as any hci\_uart\_tx\_wakeup() issued after the flag is cleared will
detect that and not schedule further work.
Signed-off-by: Ronald Tschalär
Reviewed-by: Lukas Wunner
Signed-off-by: Marcel Holtmann
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7d1beb462e18b55fa5d0990d0f60fbf4edfda61b
Author: Patel Jay P
Date: Mon Oct 23 06:05:53 2017 -0700
Ib/hfi1: Return actual operational VLs in port info query
[ Upstream commit 00f9203119dd2774564407c7a67b17d81916298b ]
\_\_subn\_get\_opa\_portinfo stores value returned by hfi1\_get\_ib\_cfg() as
operational vls. hfi1\_get\_ib\_cfg() returns vls\_operational field in
hfi1\_pportdata. The problem with this is that the value is always equal
to vls\_supported field in hfi1\_pportdata.
The logic to calculate operational\_vls is to set value passed by FM
(in \_\_subn\_set\_opa\_portinfo routine). If no value is passed then
default value is stored in operational\_vls.
Field actual\_vls\_operational is calculated on the basis of buffer
control table. Hence, modifying hfi1\_get\_ib\_cfg() to return
actual\_operational\_vls when used with HFI1\_IB\_CFG\_OP\_VLS parameter
Reviewed-by: Mike Marciniszyn
Reviewed-by: Dennis Dalessandro
Signed-off-by: Patel Jay P
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d5860344c243308c0d5e9751553d52d957b29e5b
Author: tang.junhui
Date: Mon Oct 30 14:46:34 2017 -0700
bcache: fix wrong cache\_misses statistics
[ Upstream commit c157313791a999646901b3e3c6888514ebc36d62 ]
Currently, Cache missed IOs are identified by s->cache\_miss, but actually,
there are many situations that missed IOs are not assigned a value for
s->cache\_miss in cached\_dev\_cache\_miss(), for example, a bypassed IO
(s->iop.bypass = 1), or the cache\_bio allocate failed. In these situations,
it will go to out\_put or out\_submit, and s->cache\_miss is null, which leads
bch\_mark\_cache\_accounting() to treat this IO as a hit IO.
[ML: applied by 3-way merge]
Signed-off-by: tang.junhui
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c9973b3d35267028edf8b9a4df6310161bd0ef37
Author: Liang Chen
Date: Mon Oct 30 14:46:35 2017 -0700
bcache: explicitly destroy mutex while exiting
[ Upstream commit 330a4db89d39a6b43f36da16824eaa7a7509d34d ]
mutex\_destroy does nothing most of time, but it's better to call
it to make the code future proof and it also has some meaning
for like mutex debug.
As Coly pointed out in a previous review, bcache\_exit() may not be
able to handle all the references properly if userspace registers
cache and backing devices right before bch\_debug\_init runs and
bch\_debug\_init failes later. So not exposing userspace interface
until everything is ready to avoid that issue.
Signed-off-by: Liang Chen
Reviewed-by: Michael Lyle
Reviewed-by: Coly Li
Reviewed-by: Eric Wheeler
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 81309f8b9b69913233733ed61c4c87dab5436902
Author: Arun Kumar Neelakantam
Date: Mon Oct 30 11:11:24 2017 +0530
rpmsg: glink: Initialize the "intent\_req\_comp" completion variable
[ Upstream commit 2394facb17bcace4b3c19b50202177a5d8903b64 ]
The "intent\_req\_comp" variable is used without initialization which
results in NULL pointer dereference in qcom\_glink\_request\_intent().
we need to initialize the completion variable before using it.
Fixes: 27b9c5b66b23 ("rpmsg: glink: Request for intents when unavailable")
Signed-off-by: Arun Kumar Neelakantam
Signed-off-by: Bjorn Andersson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7291d99ebc67be887e5c915489706e6fe720992a
Author: Adam Sampson
Date: Tue Oct 24 16:14:46 2017 -0400
media: usbtv: fix brightness and contrast controls
[ Upstream commit b3168c87c0492661badc3e908f977d79e7738a41 ]
Because the brightness and contrast controls share a register,
usbtv\_s\_ctrl needs to read the existing values for both controls before
inserting the new value. However, the code accidentally wrote to the
registers (from an uninitialised stack array), rather than reading them.
The user-visible effect of this was that adjusting the brightness would
also set the contrast to a random value, and vice versa -- so it wasn't
possible to correctly adjust the brightness of usbtv's video output.
Tested with an "EasyDAY" UTV007 device.
Fixes: c53a846c48f2 ("usbtv: add video controls")
Signed-off-by: Adam Sampson
Reviewed-by: Lubomir Rintel
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 1678bb970113e62469ca510bff20eb95bbdeaec2
Author: Bob Peterson
Date: Wed Sep 20 08:30:04 2017 -0500
GFS2: Take inode off order\_write list when setting jdata flag
[ Upstream commit cc555b09d8c3817aeebda43a14ab67049a5653f7 ]
This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log\_flush calls gfs2\_ordered\_write which
calls filemap\_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2\_jdata\_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log\_flush rwsem which is already locked by the log
flush operation.
The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log\_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.
Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2\_log\_flush because the call to filemap\_fdatawrite will
do it for us:
filemap\_fdatawrite() -> \_\_filemap\_fdatawrite\_range()
\_\_filemap\_fdatawrite\_range() -> do\_writepages()
do\_writepages() -> gfs2\_jdata\_writepages()
gfs2\_jdata\_writepages() -> gfs2\_log\_flush()
This patch modifies function do\_gfs2\_set\_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.
Signed-off-by: Bob Peterson
Signed-off-by: Andreas Gruenbacher
Acked-by: Abhijith Das
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit aa902be00448f3bc69fd54b1a0a8f5b4b6a47c5b
Author: Douglas Gilbert
Date: Sun Oct 29 10:47:19 2017 -0400
scsi: scsi\_debug: write\_same: fix error report
[ Upstream commit e33d7c56450b0a5c7290cbf9e1581fab5174f552 ]
The scsi\_debug driver incorrectly suggests there is an error with the
SCSI WRITE SAME command when the number\_of\_logical\_blocks is greater
than 1. It will also suggest there is an error when NDOB
(no data-out buffer) is set and the number\_of\_logical\_blocks is
greater than 0. Both are valid, fix.
Signed-off-by: Douglas Gilbert
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 95e8d653ea987adfe108173bd5969201a363bf19
Author: Dan Carpenter
Date: Sat Sep 30 11:16:51 2017 +0300
misc: pci\_endpoint\_test: Avoid triggering a BUG()
[ Upstream commit 846df244ebefbc9f7b91e9ae7a5e5a2e69fb4772 ]
If you call ida\_simple\_remove(&pci\_endpoint\_test\_ida, id) with a
negative "id" then it triggers an immediate BUG\_ON(). Let's not allow
that.
Fixes: 2c156ac71c6b ("misc: Add host side PCI driver for PCI test function device")
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 85d63b76bdd1b570b9c16e60f83eb3185e22b30d
Author: Kishon Vijay Abraham I
Date: Wed Oct 11 14:14:36 2017 +0530
misc: pci\_endpoint\_test: Fix failure path return values in probe
[ Upstream commit 80068c93688f6143100859c4856f895801c1a1d9 ]
Return value of pci\_endpoint\_test\_probe is not set properly in a couple of
failure cases. Fix it here.
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 5642562d0b4f616cac2b4d7f81de0a58f2247b59
Author: Daniel Lezcano
Date: Thu Oct 19 19:05:58 2017 +0200
thermal/drivers/step\_wise: Fix temperature regulation misbehavior
[ Upstream commit 07209fcf33542c1ff1e29df2dbdf8f29cdaacb10 ]
There is a particular situation when the cooling device is cpufreq and the heat
dissipation is not efficient enough where the temperature increases little by
little until reaching the critical threshold and leading to a SoC reset.
The behavior is reproducible on a hikey6220 with bad heat dissipation (eg.
stacked with other boards).
Running a simple C program doing while(1); for each CPU of the SoC makes the
temperature to reach the passive regulation trip point and ends up to the
maximum allowed temperature followed by a reset.
This issue has been also reported by running the libhugetlbfs test suite.
What is observed is a ping pong between two cpu frequencies, 1.2GHz and 900MHz
while the temperature continues to grow.
It appears the step wise governor calls get\_target\_state() the first time with
the throttle set to true and the trend to 'raising'. The code selects logically
the next state, so the cpu frequency decreases from 1.2GHz to 900MHz, so far so
good. The temperature decreases immediately but still stays greater than the
trip point, then get\_target\_state() is called again, this time with the
throttle set to true \*and\* the trend to 'dropping'. From there the algorithm
assumes we have to step down the state and the cpu frequency jumps back to
1.2GHz. But the temperature is still higher than the trip point, so
get\_target\_state() is called with throttle=1 and trend='raising' again, we jump
to 900MHz, then get\_target\_state() is called with throttle=1 and
trend='dropping', we jump to 1.2GHz, etc ... but the temperature does not
stabilizes and continues to increase.
[ 237.922654] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 237.922678] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 237.922690] thermal cooling\_device0: cur\_state=0
[ 237.922701] thermal cooling\_device0: old\_target=0, target=1
[ 238.026656] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 238.026680] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 238.026694] thermal cooling\_device0: cur\_state=1
[ 238.026707] thermal cooling\_device0: old\_target=1, target=0
[ 238.134647] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 238.134667] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 238.134679] thermal cooling\_device0: cur\_state=0
[ 238.134690] thermal cooling\_device0: old\_target=0, target=1
In this situation the temperature continues to increase while the trend is
oscillating between 'dropping' and 'raising'. We need to keep the current state
untouched if the throttle is set, so the temperature can decrease or a higher
state could be selected, thus preventing this oscillation.
Keeping the next\_target untouched when 'throttle' is true at 'dropping' time
fixes the issue.
The following traces show the governor does not change the next state if
trend==2 (dropping) and throttle==1.
[ 2306.127987] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2306.128009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2306.128021] thermal cooling\_device0: cur\_state=0
[ 2306.128031] thermal cooling\_device0: old\_target=0, target=1
[ 2306.231991] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.232016] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=1
[ 2306.232030] thermal cooling\_device0: cur\_state=1
[ 2306.232042] thermal cooling\_device0: old\_target=1, target=1
[ 2306.335982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2306.336006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=1
[ 2306.336021] thermal cooling\_device0: cur\_state=1
[ 2306.336034] thermal cooling\_device0: old\_target=1, target=1
[ 2306.439984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2306.440008] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2306.440022] thermal cooling\_device0: cur\_state=1
[ 2306.440034] thermal cooling\_device0: old\_target=1, target=0
[ ... ]
After a while, if the temperature continues to increase, the next state becomes
2 which is 720MHz on the hikey. That results in the temperature stabilizing
around the trip point.
[ 2455.831982] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2455.832006] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=0
[ 2455.832019] thermal cooling\_device0: cur\_state=1
[ 2455.832032] thermal cooling\_device0: old\_target=1, target=1
[ 2455.935985] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2455.936013] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2455.936027] thermal cooling\_device0: cur\_state=1
[ 2455.936040] thermal cooling\_device0: old\_target=1, target=1
[ 2456.043984] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=0,throttle=1
[ 2456.044009] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=0,throttle=0
[ 2456.044023] thermal cooling\_device0: cur\_state=1
[ 2456.044036] thermal cooling\_device0: old\_target=1, target=1
[ 2456.148001] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=1,throttle=1
[ 2456.148028] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=1,throttle=1
[ 2456.148042] thermal cooling\_device0: cur\_state=1
[ 2456.148055] thermal cooling\_device0: old\_target=1, target=2
[ 2456.252009] thermal thermal\_zone0: Trip0[type=1,temp=65000]:trend=2,throttle=1
[ 2456.252041] thermal thermal\_zone0: Trip1[type=1,temp=75000]:trend=2,throttle=0
[ 2456.252058] thermal cooling\_device0: cur\_state=2
[ 2456.252075] thermal cooling\_device0: old\_target=2, target=1
IOW, this change is needed to keep the state for a cooling device if the
temperature trend is oscillating while the temperature increases slightly.
Without this change, the situation above leads to a catastrophic crash by a
hardware reset on hikey. This issue has been reported to happen on an OMAP
dra7xx also.
Signed-off-by: Daniel Lezcano
Cc: Keerthy
Cc: John Stultz
Cc: Leo Yan
Tested-by: Keerthy
Reviewed-by: Keerthy
Signed-off-by: Eduardo Valentin
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 556787a174e6f77c7aec167af846f1297e3860f8
Author: Kuninori Morimoto
Date: Wed Nov 1 07:16:58 2017 +0000
ASoC: rsnd: rsnd\_ssi\_run\_mods() needs to care ssi\_parent\_mod
[ Upstream commit 21781e87881f9c420871b1d1f3f29d4cd7bffb10 ]
SSI parent mod might be NULL. ssi\_parent\_mod() needs to care
about it. Otherwise, it uses negative shift.
This patch fixes it.
Signed-off-by: Kuninori Morimoto
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f7ee900a4f2c76902ce368e93d34b7580cc7ff04
Author: Gao Feng
Date: Tue Oct 31 18:25:37 2017 +0800
ppp: Destroy the mutex when cleanup
[ Upstream commit f02b2320b27c16b644691267ee3b5c110846f49e ]
The mutex\_destroy only makes sense when enable DEBUG\_MUTEX. For the
good readbility, it's better to invoke it in exit func when the init
func invokes mutex\_init.
Signed-off-by: Gao Feng
Acked-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3d213c4c0a9b0d8fb0958d4a461868525ee6d864
Author: Michał Mirosław
Date: Tue Sep 19 04:48:10 2017 +0200
clk: tegra: Fix cclk\_lp divisor register
[ Upstream commit 54eff2264d3e9fd7e3987de1d7eba1d3581c631e ]
According to comments in code and common sense, cclk\_lp uses its
own divisor, not cclk\_g's.
Fixes: b08e8c0ecc42 ("clk: tegra: add clock support for Tegra30")
Signed-off-by: Michał Mirosław
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a23c8c70b5ece8d18c49927a0bace4471d8563cb
Author: Nicolin Chen
Date: Fri Sep 15 12:10:13 2017 -0700
clk: tegra: Use readl\_relaxed\_poll\_timeout\_atomic() in tegra210\_clock\_init()
[ Upstream commit 22ef01a203d27fee8b7694020b7e722db7efd2a7 ]
Below is the call trace of tegra210\_init\_pllu() function:
start\_kernel()
-> time\_init()
--> of\_clk\_init()
---> tegra210\_clock\_init()
----> tegra210\_pll\_init()
-----> tegra210\_init\_pllu()
Because the preemption is disabled in the start\_kernel before calling
time\_init, tegra210\_init\_pllu is actually in an atomic context while
it includes a readl\_relaxed\_poll\_timeout that might sleep.
So this patch just changes this readl\_relaxed\_poll\_timeout() to its
atomic version.
Signed-off-by: Nicolin Chen
Acked-By: Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 85dcb3c850a79751b2239f434a4b6b36a75a865e
Author: Ming Lei
Date: Sat Oct 14 17:22:25 2017 +0800
blk-mq-sched: dispatch from scheduler IFF progress is made in ->dispatch
[ Upstream commit 5e3d02bbafad38975099b5848f5ebadedcf7bb7e ]
When the hw queue is busy, we shouldn't take requests from the scheduler
queue any more, otherwise it is difficult to do IO merge.
This patch fixes the awful IO performance on some SCSI devices(lpfc,
qla2xxx, ...) when mq-deadline/kyber is used by not taking requests if
hw queue is busy.
Reviewed-by: Omar Sandoval
Reviewed-by: Bart Van Assche
Reviewed-by: Christoph Hellwig
Signed-off-by: Ming Lei
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6facfe25e62e702304591bd114bcf7d6067c86e4
Author: Leo Yan
Date: Fri Sep 1 08:47:14 2017 +0800
clk: hi6220: mark clock cs\_atb\_syspll as critical
[ Upstream commit d2a3671ebe6479483a12f94fcca63c058d95ad64 ]
Clock cs\_atb\_syspll is pll used for coresight trace bus; when clock
cs\_atb\_syspll is disabled and operates its child clock node cs\_atb
results in system hang. So mark clock cs\_atb\_syspll as critical to
keep it enabled.
Cc: Guodong Xu
Cc: Zhangfei Gao
Cc: Haojian Zhuang
Signed-off-by: Leo Yan
Signed-off-by: Michael Turquette
Link: lkml.kernel.org/r/1504226835-2115-2-git-send-email-leo.yan@linaro.org
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d9e497c9424896581b18f0807652364180401c7b
Author: Mauro Carvalho Chehab
Date: Wed Nov 1 08:09:59 2017 -0400
media: camss-vfe: always initialize reg at vfe\_set\_xbar\_cfg()
[ Upstream commit 9917fbcfa20ab987d6381fd0365665e5c1402d75 ]
if output->wm\_num is bigger than 2, the value for reg is
not initialized, as warned by smatch:
drivers/media/platform/qcom/camss-8x16/camss-vfe.c:633 vfe\_set\_xbar\_cfg() error: uninitialized symbol 'reg'.
drivers/media/platform/qcom/camss-8x16/camss-vfe.c:637 vfe\_set\_xbar\_cfg() error: uninitialized symbol 'reg'.
That shouldn't happen in practice, so add a logic that will
break the loop if i > 1, fixing the warnings.
Signed-off-by: Mauro Carvalho Chehab
Acked-by: Todor Tomov
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit de0bbe07a49ce9bf5bc4fc1846bd453151e7a334
Author: Sébastien Szymanski
Date: Tue Aug 1 12:40:07 2017 +0200
clk: imx6: refine hdmi\_isfr's parent to make HDMI work on i.MX6 SoCs w/o VPU
[ Upstream commit c68ee58d9ee7b856ac722f18f4f26579c8fbd2b4 ]
On i.MX6 SoCs without VPU (in my case MCIMX6D4AVT10AC), the hdmi driver
fails to probe:
[ 2.540030] dwhdmi-imx 120000.hdmi: Unsupported HDMI controller
(0000:00:00)
[ 2.548199] imx-drm display-subsystem: failed to bind 120000.hdmi
(ops dw\_hdmi\_imx\_ops): -19
[ 2.557403] imx-drm display-subsystem: master bind failed: -19
That's because hdmi\_isfr's parent, video\_27m, is not correctly ungated.
As explained in commit 5ccc248cc537 ("ARM: imx6q: clk: Add support for
mipi\_core\_cfg clock as a shared clock gate"), video\_27m is gated by
CCM\_CCGR3[CG8].
On i.MX6 SoCs with VPU, the hdmi is working thanks to the
CCM\_CMEOR[mod\_en\_ov\_vpu] bit which makes the video\_27m ungated whatever
is in CCM\_CCGR3[CG8]. The issue can be reproduced by setting
CCMEOR[mod\_en\_ov\_vpu] to 0.
Make the HDMI work in every case by setting hdmi\_isfr's parent to
mipi\_core\_cfg.
Signed-off-by: Sébastien Szymanski
Reviewed-by: Fabio Estevam
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27731e18a571b07c4042d83679184c78957bac1a
Author: Adriana Reus
Date: Mon Oct 2 13:32:10 2017 +0300
clk: imx: imx7d: Fix parent clock for OCRAM\_CLK
[ Upstream commit edc5a8e754aba9c6eaeddd18cb1e72462f99b16c ]
The parent of OCRAM\_CLK should be axi\_main\_root\_clk
and not axi\_post\_div.
before:
axi\_src 1 1 332307692 0 0
axi\_cg 1 1 332307692 0 0
axi\_pre\_div 1 1 332307692 0 0
axi\_post\_div 1 1 332307692 0 0
ocram\_clk 0 0 332307692 0 0
main\_axi\_root\_clk 1 1 332307692 0 0
after:
axi\_src 1 1 332307692 0 0
axi\_cg 1 1 332307692 0 0
axi\_pre\_div 1 1 332307692 0 0
axi\_post\_div 1 1 332307692 0 0
main\_axi\_root\_clk 1 1 332307692 0 0
ocram\_clk 0 0 332307692 0 0
Reference Doc: i.MX 7D Reference Manual - Chap 5, p 516
(https://www.nxp.com/docs/en/reference-manual/IMX7DRM.pdf)
Fixes: 8f6d8094b215 ("ARM: imx: add imx7d clk tree support")
Signed-off-by: Adriana Reus
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3c38ce8767c6203bf3d479a570ece2a38502ac6b
Author: Chen Zhong
Date: Thu Oct 5 11:50:23 2017 +0800
clk: mediatek: add the option for determining PLL source clock
[ Upstream commit c955bf3998efa3355790a4d8c82874582f1bc727 ]
Since the previous setup always sets the PLL using crystal 26MHz, this
doesn't always happen in every MediaTek platform. So the patch added
flexibility for assigning extra member for determining the PLL source
clock.
Signed-off-by: Chen Zhong
Signed-off-by: Sean Wang
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 3c5fed838b473e565e44ada69ff51e07317e2c8a
Author: Hans de Goede
Date: Thu Nov 2 10:30:11 2017 +0100
staging: rtl8188eu: Revert part of "staging: rtl8188eu: fix comments with lines over 80 characters"
[ Upstream commit 4004a9870bbefdb6644c3d2033f5315920a3b669 ]
Commit 74e1e498e84e ("staging: rtl8188eu: fix comments with lines over 80
characters") not only changed comments but also changed an if check:
-if (pmlmepriv->cur\_network.join\_res != true) {
+if (!(pmlmepriv->cur\_network.join\_res)) {
This is not equivalent as join\_res is an int and can have values such
as -2 and -3.
Note for the next time, please only make one type of changes in a single
clean-up commit.
Fixes: 74e1e498e84e ("staging: rtl8188eu: fix comments with lines over 80 ...")
Cc: Juliana Rodrigues
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 7018a57cf7018dca6469d73b485d4a35cea97649
Author: qumingguang
Date: Thu Nov 2 20:45:22 2017 +0800
net: hns3: Fix a misuse to devm\_free\_irq
[ Upstream commit ae064e6123f89f90af7e4ea190cc0c612643ca93 ]
we should use free\_irq to free the nic irq during the unloading time.
because we use request\_irq to apply it when nic up. It will crash if
up net device after reset the port. This patch fixes the issue.
Signed-off-by: qumingguang
Signed-off-by: Lipeng
Signed-off-by: Yunsheng Lin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 62785073959347a14eecb395e810a97e745996f2
Author: Fuyun Liang
Date: Fri Nov 3 12:18:26 2017 +0800
net: hns3: fix for getting advertised\_caps in hns3\_get\_link\_ksettings
[ Upstream commit 2b39cabb2a283cea0c3d96d9370575371726164f ]
This patch fixes a bug for ethtool's get\_link\_ksettings().
The advertising for autoneg is always added to advertised\_caps
whether autoneg is enable or disable. This patch fixes it.
Fixes: 496d03e (net: hns3: Add Ethtool support to HNS3 driver)
Signed-off-by: Fuyun Liang
Signed-off-by: Lipeng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f58a90e027d8ff3f24e20429500f0923663afbd4
Author: Jan Kara
Date: Fri Nov 3 12:21:21 2017 +0100
mm: Handle 0 flags in \_calc\_vm\_trans() macro
[ Upstream commit 592e254502041f953e84d091eae2c68cba04c10b ]
\_calc\_vm\_trans() does not handle the situation when some of the passed
flags are 0 (which can happen if these VM flags do not make sense for
the architecture). Improve the \_calc\_vm\_trans() macro to return 0 in
such situation. Since all passed flags are constant, this does not add
any runtime overhead.
Signed-off-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6479a108b35857674ca2a74e049e3089d12ee444
Author: Robert Baronescu
Date: Tue Oct 10 13:22:00 2017 +0300
crypto: tcrypt - fix buffer lengths in test\_aead\_speed()
[ Upstream commit 7aacbfcb331ceff3ac43096d563a1f93ed46e35e ]
Fix the way the length of the buffers used for
encryption / decryption are computed.
For e.g. in case of encryption, input buffer does not contain
an authentication tag.
Signed-off-by: Robert Baronescu
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ade07fa32f5ab083d558199e906d612b5d535553
Author: Suzuki K Poulose
Date: Fri Nov 3 11:45:18 2017 +0000
arm-ccn: perf: Prevent module unload while PMU is in use
[ Upstream commit c7f5828bf77dcbd61d51f4736c1d5aa35663fbb4 ]
When the PMU driver is built as a module, the perf expects the
pmu->module to be valid, so that the driver is prevented from
being unloaded while it is in use. Fix the CCN pmu driver to
fill in this field.
Fixes: a33b0daab73a0 ("bus: ARM CCN PMU driver")
Cc: Pawel Moll
Cc: Will Deacon
Acked-by: Mark Rutland
Signed-off-by: Suzuki K Poulose
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 79f41e0f8ae0e3298bfcfd8c085b5242add83e9b
Author: Eryu Guan
Date: Wed Nov 1 21:43:50 2017 -0700
xfs: truncate pagecache before writeback in xfs\_setattr\_size()
[ Upstream commit 350976ae21873b0d36584ea005076356431b8f79 ]
On truncate down, if new size is not block size aligned, we zero the
rest of block to avoid exposing stale data to user, and
iomap\_truncate\_page() skips zeroing if the range is already in
unwritten state or a hole. Then we writeback from on-disk i\_size to
the new size if this range hasn't been written to disk yet, and
truncate page cache beyond new EOF and set in-core i\_size.
The problem is that we could write data between di\_size and newsize
before removing the page cache beyond newsize, as the extents may
still be in unwritten state right after a buffer write. As such, the
page of data that newsize lies in has not been zeroed by page cache
invalidation before it is written, and xfs\_do\_writepage() hasn't
triggered it's "zero data beyond EOF" case because we haven't
updated in-core i\_size yet. Then a subsequent mmap read could see
non-zeros past EOF.
I occasionally see this in fsx runs in fstests generic/112, a
simplified fsx operation sequence is like (assuming 4k block size
xfs):
fallocate 0x0 0x1000 0x0 keep\_size
write 0x0 0x1000 0x0
truncate 0x0 0x800 0x1000
punch\_hole 0x0 0x800 0x800
mapread 0x0 0x800 0x800
where fallocate allocates unwritten extent but doesn't update
i\_size, buffer write populates the page cache and extent is still
unwritten, truncate skips zeroing page past new EOF and writes the
page to disk, punch\_hole invalidates the page cache, at last mapread
reads the block back and sees non-zero beyond EOF.
Fix it by moving truncate\_setsize() to before writeback so the page
cache invalidation zeros the partial page at the new EOF. This also
triggers "zero data beyond EOF" in xfs\_do\_writepage() at writeback
time, because newsize has been set and page straddles the newsize.
Also fixed the wrong 'end' param of filemap\_write\_and\_wait\_range()
call while we're at it, the 'end' is inclusive and should be
'newsize - 1'.
Suggested-by: Dave Chinner
Signed-off-by: Eryu Guan
Acked-by: Dave Chinner
Reviewed-by: Brian Foster
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 07a93b48a0f73e0cb74355a7dd80c6ad55bed674
Author: Gary R Hook
Date: Fri Nov 3 10:50:34 2017 -0600
iommu/amd: Limit the IOVA page range to the specified addresses
[ Upstream commit b92b4fb5c14257c0e7eae291ecc1f7b1962e1699 ]
The extent of pages specified when applying a reserved region should
include up to the last page of the range, but not the page following
the range.
Signed-off-by: Gary R Hook
Fixes: 8d54d6c8b8f3 ('iommu/amd: Implement apply\_dm\_region call-back')
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ddf2588a05c820b305bc6db2fe6e498a3bc6fde9
Author: Liu Bo
Date: Fri Nov 3 11:24:44 2017 -0600
badblocks: fix wrong return value in badblocks\_set if badblocks are disabled
[ Upstream commit 39b4954c0a1556f8f7f1fdcf59a227117fcd8a0b ]
MD's rdev\_set\_badblocks() expects that badblocks\_set() returns 1 if
badblocks are disabled, otherwise, rdev\_set\_badblocks() will record
superblock changes and return success in that case and md will fail to
report an IO error which it should.
This bug has existed since badblocks were introduced in commit
9e0e252a048b ("badblocks: Add core badblock management code").
Signed-off-by: Liu Bo
Acked-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f6a341e87c656f1e2e9959cfdd2d02561724558f
Author: Jiang Yi
Date: Fri Aug 11 11:29:44 2017 +0800
target/file: Do not return error for UNMAP if length is zero
[ Upstream commit 594e25e73440863981032d76c9b1e33409ceff6e ]
The function fd\_execute\_unmap() in target\_core\_file.c calles
ret = file->f\_op->fallocate(file, mode, pos, len);
Some filesystems implement fallocate() to return error if
length is zero (e.g. btrfs) but according to SCSI Block
Commands spec UNMAP should return success for zero length.
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 23d3f106f88ca21fd2911ae2f3a4f8aa7b56fddc
Author: tangwenji
Date: Thu Aug 24 19:59:37 2017 +0800
target:fix condition return in core\_pr\_dump\_initiator\_port()
[ Upstream commit 24528f089d0a444070aa4f715ace537e8d6bf168 ]
When is pr\_reg->isid\_present\_at\_reg is false,this function should return.
This fixes a regression originally introduced by:
commit d2843c173ee53cf4c12e7dfedc069a5bc76f0ac5
Author: Andy Grover
Date: Thu May 16 10:40:55 2013 -0700
target: Alter core\_pr\_dump\_initiator\_port for ease of use
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e389507ad355226019147985c29a5b4282aa1e4d
Author: tangwenji
Date: Fri Sep 15 16:03:13 2017 +0800
iscsi-target: fix memory leak in lio\_target\_tiqn\_addtpg()
[ Upstream commit 12d5a43b2dffb6cd28062b4e19024f7982393288 ]
tpg must free when call core\_tpg\_register() return fail
Signed-off-by: tangwenji
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 68d702c6689d83000060118f940e0adce88e42aa
Author: Bart Van Assche
Date: Tue Oct 31 11:03:17 2017 -0700
target/iscsi: Fix a race condition in iscsit\_add\_reject\_from\_cmd()
[ Upstream commit cfe2b621bb18d86e93271febf8c6e37622da2d14 ]
Avoid that cmd->se\_cmd.se\_tfo is read after a command has already been
freed.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 96d275b841efc6decf61afafc1703f0e9b92253d
Author: Bart Van Assche
Date: Tue Oct 31 11:03:18 2017 -0700
target/iscsi: Detect conn\_cmd\_list corruption early
[ Upstream commit 6eaf69e4ec075f5af236c0c89f75639a195db904 ]
Certain behavior of the initiator can cause the target driver to
send both a reject and a SCSI response. If that happens two
target\_put\_sess\_cmd() calls will occur without the command having
been removed from conn\_cmd\_list. In other words, conn\_cmd\_list
will get corrupted once the freed memory is reused. Although the
Linux kernel can detect list corruption if list debugging is
enabled, in this case the context in which list corruption is
detected is not related to the context that caused list corruption.
Hence add WARN\_ON() statements that report the context that is
causing list corruption.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Christie
Reviewed-by: Hannes Reinecke
Signed-off-by: Nicholas Bellinger
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c90db58f5bb6d5ba203815e28cb5e7eb20b86b27
Author: Kuppuswamy Sathyanarayanan
Date: Sun Oct 29 02:49:54 2017 -0700
platform/x86: intel\_punit\_ipc: Fix resource ioremap warning
[ Upstream commit 6cc8cbbc8868033f279b63e98b26b75eaa0006ab ]
For PUNIT device, ISPDRIVER\_IPC and GTDDRIVER\_IPC resources are not
mandatory. So when PMC IPC driver creates a PUNIT device, if these
resources are not available then it creates dummy resource entries for
these missing resources. But during PUNIT device probe, doing ioremap on
these dummy resources generates following warning messages.
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
intel\_punit\_ipc: can't request region for resource [mem 0x00000000]
This patch fixes this issue by adding extra check for resource size
before performing ioremap operation.
Signed-off-by: Kuppuswamy Sathyanarayanan
Signed-off-by: Andy Shevchenko
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f8b31d88a698909f0bcc4142e4637e2baee5c320
Author: Tyrel Datwyler
Date: Thu Sep 28 20:19:20 2017 -0400
powerpc/pseries/vio: Dispose of virq mapping on vdevice unregister
[ Upstream commit b8f89fea599d91e674497aad572613eb63181f31 ]
When a vdevice is DLPAR removed from the system the vio subsystem
doesn't bother unmapping the virq from the irq\_domain. As a result we
have a virq mapped to a hardware irq that is no longer valid for the
irq\_domain. A side effect is that we are left with /proc/irq/
affinity entries, and attempts to modify the smp\_affinity of the irq
will fail.
In the following observed example the kernel log is spammed by
ics\_rtas\_set\_affinity errors after the removal of a VSCSI adapter.
This is a result of irqbalance trying to adjust the affinity every 10
seconds.
rpadlpar\_io: slot U8408.E8E.10A7ACV-V5-C25 removed
ics\_rtas\_set\_affinity: ibm,set-xive irq=655385 returns -3
ics\_rtas\_set\_affinity: ibm,set-xive irq=655385 returns -3
This patch fixes the issue by calling irq\_dispose\_mapping() on the
virq of the viodev on unregister.
Fixes: f2ab6219969f ("powerpc/pseries: Add PFO support to the VIO bus")
Signed-off-by: Tyrel Datwyler
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 0fe5286e49d4e1fe7eba347302b3d3dee217eade
Author: Christophe Leroy
Date: Wed Oct 18 11:16:47 2017 +0200
powerpc/ipic: Fix status get and status clear
[ Upstream commit 6b148a7ce72a7f87c81cbcde48af014abc0516a9 ]
IPIC Status is provided by register IPIC\_SERSR and not by IPIC\_SERMR
which is the mask register.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 2637cb1e3d8086cd31a96e60c3e7e0aa74c043f4
Author: William A. Kennington III
Date: Fri Sep 22 16:58:00 2017 -0700
powerpc/opal: Fix EBUSY bug in acquiring tokens
[ Upstream commit 71e24d7731a2903b1ae2bba2b2971c654d9c2aa6 ]
The current code checks the completion map to look for the first token
that is complete. In some cases, a completion can come in but the
token can still be on lease to the caller processing the completion.
If this completed but unreleased token is the first token found in the
bitmap by another tasks trying to acquire a token, then the
\_\_test\_and\_set\_bit call will fail since the token will still be on
lease. The acquisition will then fail with an EBUSY.
This patch reorganizes the acquisition code to look at the
opal\_async\_token\_map for an unleased token. If the token has no lease
it must have no outstanding completions so we should never see an
EBUSY, unless we have leased out too many tokens. Since
opal\_async\_get\_token\_inrerruptible is protected by a semaphore, we
will practically never see EBUSY anymore.
Fixes: 8d7248232208 ("powerpc/powernv: Infrastructure to support OPAL async completion")
Signed-off-by: William A. Kennington III
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d815f4efbb2a04e57632fc4daa6ebaf5fca52123
Author: KUWAZAWA Takuya
Date: Sun Oct 15 20:54:10 2017 +0900
netfilter: ipvs: Fix inappropriate output of procfs
[ Upstream commit c5504f724c86ee925e7ffb80aa342cfd57959b13 ]
Information about ipvs in different network namespace can be seen via procfs.
How to reproduce:
# ip netns add ns01
# ip netns add ns02
# ip netns exec ns01 ip a add dev lo 127.0.0.1/8
# ip netns exec ns02 ip a add dev lo 127.0.0.1/8
# ip netns exec ns01 ipvsadm -A -t 10.1.1.1:80
# ip netns exec ns02 ipvsadm -A -t 10.1.1.2:80
The ipvsadm displays information about its own network namespace only.
# ip netns exec ns01 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.1:80 wlc
# ip netns exec ns02 ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 10.1.1.2:80 wlc
But I can see information about other network namespace via procfs.
# ip netns exec ns01 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010101:0050 wlc
TCP 0A010102:0050 wlc
# ip netns exec ns02 cat /proc/net/ip\_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-> RemoteAddress:Port Forward Weight ActiveConn InActConn
TCP 0A010102:0050 wlc
Signed-off-by: KUWAZAWA Takuya
Acked-by: Julian Anastasov
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c4e7af283374329a6eca97dfa782d710417f3e19
Author: Gustavo A. R. Silva
Date: Sat Nov 4 23:52:54 2017 -0500
thunderbolt: tb: fix use after free in tb\_activate\_pcie\_devices
[ Upstream commit a2e373438f72391493a4425efc1b82030b6b4fd5 ]
Add a ̣̣continue statement in order to avoid using a previously
free'd pointer tunnel in list\_add.
Addresses-Coverity-ID: 1415336
Fixes: 9d3cce0b6136 ("thunderbolt: Introduce thunderbolt bus and connection manager")
Signed-off-by: Gustavo A. R. Silva
Acked-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 837da470dc16168a4ea75989b0f902efe795dda4
Author: Matthias Brugger
Date: Mon Oct 30 12:37:55 2017 +0100
iommu/mediatek: Fix driver name
[ Upstream commit 395df08d2e1de238a9c8c33fdcd0e2160efd63a9 ]
There exist two Mediatek iommu drivers for the two different
generations of the device. But both drivers have the same name
"mtk-iommu". This breaks the registration of the second driver:
Error: Driver 'mtk-iommu' is already registered, aborting...
Fix this by changing the name for first generation to
"mtk-iommu-v1".
Fixes: b17336c55d89 ("iommu/mediatek: add support for mtk iommu generation one HW")
Signed-off-by: Matthias Brugger
Signed-off-by: Alex Williamson
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit fe1c1819b4340f53ac2da07991c810fceaf06bba
Author: Mika Westerberg
Date: Fri Oct 13 21:35:43 2017 +0300
PCI: Do not allocate more buses than available in parent
[ Upstream commit a20c7f36bd3d20d245616ae223bb9d05dfb6f050 ]
One can ask more buses to be reserved for hotplug bridges by passing
pci=hpbussize=N in the kernel command line. If the parent bus does not
have enough bus space available we incorrectly create child bus with the
requested number of subordinate buses.
In the example below hpbussize is set to one more than we have available
buses in the root port:
pci 0000:07:00.0: [8086:1578] type 01 class 0x060400
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 0
pci 0000:07:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
pci 0000:07:00.0: scanning [bus 00-00] behind bridge, pass 1
pci\_bus 0000:08: busn\_res: can not insert [bus 08-ff] under [bus 07-3f] (conflicts with (null) [bus 07-3f])
pci\_bus 0000:08: scanning bus
...
pci\_bus 0000:0a: bus scan returning with max=40
pci\_bus 0000:0a: busn\_res: [bus 0a-ff] end is updated to 40
pci\_bus 0000:0a: [bus 0a-40] partially hidden behind bridge 0000:07 [bus 07-3f]
pci\_bus 0000:08: bus scan returning with max=40
pci\_bus 0000:08: busn\_res: [bus 08-ff] end is updated to 40
Instead of allowing this, limit the subordinate number to be less than or
equal the maximum subordinate number allocated for the parent bus (if it
has any).
Signed-off-by: Mika Westerberg
[bhelgaas: remove irrelevant dmesg messages]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9565e1e078329da7c92dd6812685bf8a2dd9b8e
Author: Shriya
Date: Fri Oct 13 10:06:41 2017 +0530
powerpc/powernv/cpufreq: Fix the frequency read by /proc/cpuinfo
[ Upstream commit cd77b5ce208c153260ed7882d8910f2395bfaabd ]
The call to /proc/cpuinfo in turn calls cpufreq\_quick\_get() which
returns the last frequency requested by the kernel, but may not
reflect the actual frequency the processor is running at. This patch
makes a call to cpufreq\_get() instead which returns the current
frequency reported by the hardware.
Fixes: fb5153d05a7d ("powerpc: powernv: Implement ppc\_md.get\_proc\_freq()")
Signed-off-by: Shriya
Signed-off-by: Michael Ellerman
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 27a12c783e700be095c39abe2749a20c3ab8ea11
Author: Qiang
Date: Thu Sep 28 11:54:34 2017 +0800
PCI/PME: Handle invalid data when reading Root Status
[ Upstream commit 3ad3f8ce50914288731a3018b27ee44ab803e170 ]
PCIe PME and native hotplug share the same interrupt number, so hotplug
interrupts are also processed by PME. In some cases, e.g., a Link Down
interrupt, a device may be present but unreachable, so when we try to
read its Root Status register, the read fails and we get all ones data
(0xffffffff).
Previously, we interpreted that data as PCI\_EXP\_RTSTA\_PME being set, i.e.,
"some device has asserted PME," so we scheduled pcie\_pme\_work\_fn(). This
caused an infinite loop because pcie\_pme\_work\_fn() tried to handle PME
requests until PCI\_EXP\_RTSTA\_PME is cleared, but with the link down,
PCI\_EXP\_RTSTA\_PME can't be cleared.
Check for the invalid 0xffffffff data everywhere we read the Root Status
register.
1469d17dd341 ("PCI: pciehp: Handle invalid data when reading from
non-existent devices") added similar checks in the hotplug driver.
Signed-off-by: Qiang Zheng
[bhelgaas: changelog, also check in pcie\_pme\_work\_fn(), use "~0" to follow
other similar checks]
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 540236e28f32749f5d1711020fbcab5be3afbf7f
Author: Wei Yongjun
Date: Mon Nov 6 11:11:28 2017 +0000
mlxsw: spectrum: Fix error return code in mlxsw\_sp\_port\_create()
[ Upstream commit d86fd113ebbb37726ef7c7cc6fd6d5ce377455d6 ]
Fix to return a negative error code from the VID create error handling
case instead of 0, as done elsewhere in this function.
Fixes: c57529e1d5d8 ("mlxsw: spectrum: Replace vPorts with Port-VLAN")
Signed-off-by: Wei Yongjun
Reviewed-by: Ido Schimmel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ac6864737c0240499f1cd0689cd61b2bad6e04c8
Author: Peter Ujfalusi
Date: Wed Nov 8 12:02:25 2017 +0200
dmaengine: ti-dma-crossbar: Correct am335x/am43xx mux value type
[ Upstream commit 288e7560e4d3e259aa28f8f58a8dfe63627a1bf6 ]
The used 0x1f mask is only valid for am335x family of SoC, different family
using this type of crossbar might have different number of electable
events. In case of am43xx family 0x3f mask should have been used for
example.
Instead of trying to handle each family's mask, just use u8 type to store
the mux value since the event offsets are aligned to byte offset.
Fixes: 42dbdcc6bf965 ("dmaengine: ti-dma-crossbar: Add support for crossbar on AM33xx/AM43xx")
Signed-off-by: Peter Ujfalusi
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b1d0ddc83e3cb2b9e5641ee52f235fcf463fd1d8
Author: Pankaj Bharadiya
Date: Tue Nov 7 16:16:19 2017 +0530
ASoC: Intel: Skylake: Fix uuid\_module memory leak in failure case
[ Upstream commit f8e066521192c7debe59127d90abbe2773577e25 ]
In the loop that adds the uuid\_module to the uuid\_list list, allocated
memory is not properly freed in the error path free uuid\_list whenever
any of the memory allocation in the loop fails to avoid memory leak.
Signed-off-by: Pankaj Bharadiya
Signed-off-by: Guneshwor Singh
Acked-By: Vinod Koul
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 32f733a8f470bf37b77da08d60868aace87f78f7
Author: Rajat Jain
Date: Tue Oct 31 14:44:24 2017 -0700
PM / s2idle: Clear the events\_check\_enabled flag
[ Upstream commit 95b982b45122c57da2ee0b46cce70775e1d987af ]
Problem: This flag does not get cleared currently in the suspend or
resume path in the following cases:
\* In case some driver's suspend routine returns an error.
\* Successful s2idle case
\* etc?
Why is this a problem: What happens is that the next suspend attempt
could fail even though the user did not enable the flag by writing to
/sys/power/wakeup\_count. This is 1 use case how the issue can be seen
(but similar use case with driver suspend failure can be thought of):
1. Read /sys/power/wakeup\_count
2. echo count > /sys/power/wakeup\_count
3. echo freeze > /sys/power/wakeup\_count
4. Let the system suspend, and wakeup the system using some wake source
that calls pm\_wakeup\_event() e.g. power button or something.
5. Note that the combined wakeup count would be incremented due
to the pm\_wakeup\_event() in the resume path.
6. After resuming the events\_check\_enabled flag is still set.
At this point if the user attempts to freeze again (without writing to
/sys/power/wakeup\_count), the suspend would fail even though there has
been no wake event since the past resume.
Address that by clearing the flag just before a resume is completed,
so that it is always cleared for the corner cases mentioned above.
Signed-off-by: Rajat Jain
Acked-by: Pavel Machek
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit c4760b9c8d06f541d37784afb3bbeaf895346b9b
Author: Pixel Ding
Date: Wed Nov 8 10:20:01 2017 +0800
drm/amdgpu: bypass lru touch for KIQ ring submission
[ Upstream commit dce1e131dd4dc68099ff1b70aa03cd2d0acf8639 ]
KIQ ring submission is used for register accessing on SRIOV
VF that could happen both in irq enabled and irq disabled cases.
Inversion lock could happen on adev->ring\_lru\_list\_lock, while
this operation is useless and just adds overhead in this use
case.
Signed-off-by: Pixel Ding
Reviewed-by: Monk Liu
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 73e31f2af17843c640fd7e0c8d73f13773dd1777
Author: Arnd Bergmann
Date: Tue Nov 7 11:46:05 2017 +0100
scsi: aacraid: use timespec64 instead of timeval
[ Upstream commit 820f188659122602ab217dd80cfa32b3ac0c55c0 ]
aacraid passes the current time to the firmware in one of two ways,
either as year/month/day/... or as 32-bit unsigned seconds.
The first one is broken on 32-bit architectures as it cannot go past
year 2038. Using timespec64 here makes it behave properly on both 32-bit
and 64-bit architectures, and avoids relying on signed integer overflow
to pass times into the second interface.
The interface used in aac\_send\_hosttime() however is still problematic
in year 2106 when 32-bit seconds overflow. Hopefully we don't have to
worry about aacraid by that time.
Signed-off-by: Arnd Bergmann
Reviewed-by: Dave Carroll
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 28461320cc952e8a971ec415743ae97120937fbd
Author: Philipp Zabel
Date: Tue Nov 7 13:12:17 2017 +0100
rtc: pcf8563: fix output clock rate
[ Upstream commit a3350f9c57ffad569c40f7320b89da1f3061c5bb ]
The pcf8563\_clkout\_recalc\_rate function erroneously ignores the
frequency index read from the CLKO register and always returns
32768 Hz.
Fixes: a39a6405d5f9 ("rtc: pcf8563: add CLKOUT to common clock framework")
Signed-off-by: Philipp Zabel
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d6f59ef5b840c5815430d63bb08e8dcbd9e2a132
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Return an error code if a memory allocation fails
[ Upstream commit 8cae353e6b01ac3f18097f631cdbceb5ff28c7f3 ]
'ret' is known to be 0 at this point.
In case of memory allocation error in 'framebuffer\_alloc()', return
-ENOMEM instead.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit df235d2ee36e70a43b122c0eb34064794ef4464c
Author: Christophe JAILLET
Date: Thu Nov 9 18:09:28 2017 +0100
video: fbdev: au1200fb: Release some resources if a memory allocation fails
[ Upstream commit 451f130602619a17c8883dd0b71b11624faffd51 ]
We should go through the error handling code instead of returning -ENOMEM
directly.
Signed-off-by: Christophe JAILLET
Cc: Tejun Heo
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 456279d0e3ad7cb3b6b90aeb07c189c7f8590ab0
Author: Ladislav Michl
Date: Thu Nov 9 18:09:30 2017 +0100
video: udlfb: Fix read EDID timeout
[ Upstream commit c98769475575c8a585f5b3952f4b5f90266f699b ]
While usb\_control\_msg function expects timeout in miliseconds, a value
of HZ is used. Replace it with USB\_CTRL\_GET\_TIMEOUT and also fix error
message which looks like:
udlfb: Read EDID byte 78 failed err ffffff92
as error is either negative errno or number of bytes transferred use %d
format specifier.
Returned EDID is in second byte, so return error when less than two bytes
are received.
Fixes: 18dffdf8913a ("staging: udlfb: enhance EDID and mode handling support")
Signed-off-by: Ladislav Michl
Cc: Bernie Thompson
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit f9a40df232448539f6586f9a0c72ca89fd694fbe
Author: Geert Uytterhoeven
Date: Thu Nov 9 18:09:33 2017 +0100
fbdev: controlfb: Add missing modes to fix out of bounds access
[ Upstream commit ac831a379d34109451b3c41a44a20ee10ecb615f ]
Dan's static analysis says:
drivers/video/fbdev/controlfb.c:560 control\_setup()
error: buffer overflow 'control\_mac\_modes' 20 <= 21
Indeed, control\_mac\_modes[] has only 20 elements, while VMODE\_MAX is 22,
which may lead to an out of bounds read when parsing vmode commandline
options.
The bug was introduced in v2.4.5.6, when 2 new modes were added to
macmodes.h, but control\_mac\_modes[] wasn't updated:
https://kernel.opensuse.org/cgit/kernel/diff/include/video/macmodes.h?h=v2.5.2&id=29f279c764808560eaceb88fef36cbc35c529aad
Augment control\_mac\_modes[] with the two new video modes to fix this.
Reported-by: Dan Carpenter
Signed-off-by: Geert Uytterhoeven
Cc: Dan Carpenter
Cc: Benjamin Herrenschmidt
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 71307dd192e7ac012894dfebd9c47cb5afc0611b
Author: Robert Stonehouse
Date: Tue Nov 7 17:30:30 2017 +0000
sfc: don't warn on successful change of MAC
[ Upstream commit cbad52e92ad7f01f0be4ca58bde59462dc1afe3a ]
Fixes: 535a61777f44e ("sfc: suppress handled MCDI failures when changing the MAC address")
Signed-off-by: Bert Kenward
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit dba1ca0e9a6fc57703eaa3c8d7293b8efc72c2af
Author: Sébastien Szymanski
Date: Fri Nov 10 10:01:43 2017 +0100
HID: cp2112: fix broken gpio\_direction\_input callback
[ Upstream commit 7da85fbf1c87d4f73621e0e7666a3387497075a9 ]
When everything goes smoothly, ret is set to 0 which makes the function
to return EIO error.
Fixes: 8e9faa15469e ("HID: cp2112: fix gpio-callback error handling")
Signed-off-by: Sébastien Szymanski
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit b3e3728ed55b9ddd7b1600ebad11f16aa665dfcb
Author: Guy Levi
Date: Wed Oct 25 22:39:35 2017 +0300
IB/mlx4: Fix RSS's QPC attributes assignments
[ Upstream commit 108809a0571cd1e1b317c5c083a371e163e1f8f9 ]
In the modify QP handler the base\_qpn\_udp field in the RSS QPC is
overwrite later by irrelevant value assignment. Hence, ingress packets
which gets to the RSS QP will be steered then to a garbage QPN.
The patch fixes this by skipping the above assignment when a RSS QP is
modified, also, the RSS context's attributes assignments are relocated
just before the context is posted to avoid future issues like this.
Additionally, this patch takes the opportunity to change the code to be
disciplined to the device's manual and assigns the RSS QP context just at
RESET to INIT transition.
Fixes:3078f5f1bd8b ("IB/mlx4: Add support for RSS QP")
Signed-off-by: Guy Levi
Reviewed-by: Yishai Hadas
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 38620054ea18edb165451bf24367f212960ff344
Author: Chandan Rajendra
Date: Mon Dec 11 15:00:57 2017 -0500
ext4: fix crash when a directory's i\_size is too small
commit 9d5afec6b8bd46d6ed821aa1579634437f58ef1f upstream.
On a ppc64 machine, when mounting a fuzzed ext2 image (generated by
fsfuzzer) the following call trace is seen,
VFS: brelse: Trying to free free buffer
WARNING: CPU: 1 PID: 6913 at /root/repos/linux/fs/buffer.c:1165 .\_\_brelse.part.6+0x24/0x40
.\_\_brelse.part.6+0x20/0x40 (unreliable)
.ext4\_find\_entry+0x384/0x4f0
.ext4\_lookup+0x84/0x250
.lookup\_slow+0xdc/0x230
.walk\_component+0x268/0x400
.path\_lookupat+0xec/0x2d0
.filename\_lookup+0x9c/0x1d0
.vfs\_statx+0x98/0x140
.SyS\_newfstatat+0x48/0x80
system\_call+0x58/0x6c
This happens because the directory that ext4\_find\_entry() looks up has
inode->i\_size that is less than the block size of the filesystem. This
causes 'nblocks' to have a value of zero. ext4\_bread\_batch() ends up not
reading any of the directory file's blocks. This renders the entries in
bh\_use[] array to continue to have garbage data. buffer\_uptodate() on
bh\_use[0] can then return a zero value upon which brelse() function is
invoked.
This commit fixes the bug by returning -ENOENT when the directory file
has no associated blocks.
Reported-by: Abdul Haleem
Signed-off-by: Chandan Rajendra
Signed-off-by: Greg Kroah-Hartman
commit 0228af23dd6962c16682d85fdf1bab6bbf77a007
Author: Theodore Ts'o
Date: Sun Dec 10 23:44:11 2017 -0500
ext4: add missing error check in \_\_ext4\_new\_inode()
commit 996fc4477a0ea28226b30d175f053fb6f9a4fa36 upstream.
It's possible for ext4\_get\_acl() to return an ERR\_PTR. So we need to
add a check for this case in \_\_ext4\_new\_inode(). Otherwise on an
error we can end up oops the kernel.
This was getting triggered by xfstests generic/388, which is a test
which exercises the shutdown code path.
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 4ff7da066d64e5083ef886203ba3a0623343c632
Author: Eryu Guan
Date: Sun Dec 3 22:52:51 2017 -0500
ext4: fix fdatasync(2) after fallocate(2) operation
commit c894aa97577e47d3066b27b32499ecf899bfa8b0 upstream.
Currently, fallocate(2) with KEEP\_SIZE followed by a fdatasync(2)
then crash, we'll see wrong allocated block number (stat -c %b), the
blocks allocated beyond EOF are all lost. fstests generic/468
exposes this bug.
Commit 67a7d5f561f4 ("ext4: fix fdatasync(2) after extent
manipulation operations") fixed all the other extent manipulation
operation paths such as hole punch, zero range, collapse range etc.,
but forgot the fallocate case.
So similarly, fix it by recording the correct journal tid in ext4
inode in fallocate(2) path, so that ext4\_sync\_file() will wait for
the right tid to be committed on fdatasync(2).
This addresses the test failure in xfstests test generic/468.
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit ae0bba6b38110e8b57b92aa820df8f78d3965fe6
Author: Andi Kleen
Date: Sun Dec 3 20:38:01 2017 -0500
ext4: support fast symlinks from ext3 file systems
commit fc82228a5e3860502dbf3bfa4a9570cb7093cf7f upstream.
407cd7fb83c0 (ext4: change fast symlink test to not rely on i\_blocks)
broke ~10 years old ext3 file systems created by 2.6.17. Any ELF
executable fails because the /lib/ld-linux.so.2 fast symlink
cannot be read anymore.
The patch assumed fast symlinks were created in a specific way,
but that's not true on these really old file systems.
The new behavior is apparently needed only with the large EA inode
feature.
Revert to the old behavior if the large EA inode feature is not set.
This makes my old VM boot again.
Fixes: 407cd7fb83c0 (ext4: change fast symlink test to not rely on i\_blocks)
Signed-off-by: Andi Kleen
Signed-off-by: Theodore Ts'o
Reviewed-by: Andreas Dilger
Signed-off-by: Greg Kroah-Hartman
commit 2dea756b487547788c1f28439fbc3df270e6bf30
Author: Kees Cook
Date: Tue Dec 12 11:28:38 2017 -0800
Revert "exec: avoid RLIMIT\_STACK races with prlimit()"
commit 779f4e1c6c7c661db40dfebd6dd6bda7b5f88aa3 upstream.
This reverts commit 04e35f4495dd560db30c25efca4eecae8ec8c375.
SELinux runs with secureexec for all non-"noatsecure" domain transitions,
which means lots of processes end up hitting the stack hard-limit change
that was introduced in order to fix a race with prlimit(). That race fix
will need to be redesigned.
Reported-by: Laura Abbott
Reported-by: Tomáš Trnka
Signed-off-by: Kees Cook
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0aa5d007ba673bc35378422b0c2b2b797da69424
Author: Adam Wallis
Date: Mon Nov 27 10:45:01 2017 -0500
dmaengine: dmatest: move callback wait queue to thread context
commit 6f6a23a213be51728502b88741ba6a10cda2441d upstream.
Commit adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
introduced a bug (that is in fact documented by the patch commit text)
that leaves behind a dangling pointer. Since the done\_wait structure is
allocated on the stack, future invocations to the DMATEST can produce
undesirable results (e.g., corrupted spinlocks).
Commit a9df21e34b42 ("dmaengine: dmatest: warn user when dma test times
out") attempted to WARN the user that the stack was likely corrupted but
did not fix the actual issue.
This patch fixes the issue by pushing the wait queue and callback
structs into the the thread structure. If a failure occurs due to time,
dmaengine\_terminate\_all will force the callback to safely call
wake\_up\_all() without possibility of using a freed pointer.
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=197605
Fixes: adfa543e7314 ("dmatest: don't use set\_freezable\_with\_signal()")
Reviewed-by: Sinan Kaya
Suggested-by: Shunyong Yang
Signed-off-by: Adam Wallis
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 3df23f7ce7255d1ef2a616071cac359a245fb6de
Author: Thomas Gleixner
Date: Fri Dec 15 10:32:03 2017 +0100
posix-timer: Properly check sigevent->sigev\_notify
commit cef31d9af908243421258f1df35a4a644604efbe upstream.
timer\_create() specifies via sigevent->sigev\_notify the signal delivery for
the new timer. The valid modes are SIGEV\_NONE, SIGEV\_SIGNAL, SIGEV\_THREAD
and (SIGEV\_SIGNAL | SIGEV\_THREAD\_ID).
The sanity check in good\_sigevent() is only checking the valid combination
for the SIGEV\_THREAD\_ID bit, i.e. SIGEV\_SIGNAL, but if SIGEV\_THREAD\_ID is
not set it accepts any random value.
This has no real effects on the posix timer and signal delivery code, but
it affects show\_timer() which handles the output of /proc/$PID/timers. That
function uses a string array to pretty print sigev\_notify. The access to
that array has no bound checks, so random sigev\_notify cause access beyond
the array bounds.
Add proper checks for the valid notify modes and remove the SIGEV\_THREAD\_ID
masking from various code pathes as SIGEV\_NONE can never be set in
combination with SIGEV\_THREAD\_ID.
Reported-by: Eric Biggers
Reported-by: Dmitry Vyukov
Reported-by: Alexey Dobriyan
Signed-off-by: Thomas Gleixner
Cc: John Stultz
Signed-off-by: Greg Kroah-Hartman
commit 6e46e964e2978f64f30b89be2423093b43e77466
Author: David Lechner
Date: Sun Dec 3 19:54:41 2017 -0600
eeprom: at24: change nvmem stride to 1
commit 7f6d2ecd3d7acaf205ea7b3e96f9ffc55b92298b upstream.
Trying to read the MAC address from an eeprom that has an offset that
is not a multiple of 4 causes an error currently.
Fix it by changing the nvmem stride to 1.
Signed-off-by: David Lechner
[Bartosz: tweaked the commit message]
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit e48a17d115f84048294ae366ff6e9dd7c8c6cca4
Author: Kirill A. Shutemov
Date: Mon Dec 4 15:40:56 2017 +0300
x86/boot/compressed/64: Print error if 5-level paging is not supported
commit 6d7e0ba2d2be9e50cccba213baf07e0e183c1b24 upstream.
If the machine does not support the paging mode for which the kernel was
compiled, the boot process cannot continue.
It's not possible to let the kernel detect the mismatch as it does not even
reach the point where cpu features can be evaluted due to a triple fault in
the KASLR setup.
Instead of instantaneous silent reboot, emit an error message which gives
the user the information why the boot fails.
Fixes: 77ef56e4f0fb ("x86: Enable 5-level paging support via CONFIG\_X86\_5LEVEL=y")
Reported-by: Borislav Petkov
Signed-off-by: Kirill A. Shutemov
Signed-off-by: Thomas Gleixner
Tested-by: Borislav Petkov
Cc: Andi Kleen
Cc: Andy Lutomirski
Cc: linux-mm@kvack.org
Cc: Cyrill Gorcunov
Cc: Linus Torvalds
Link: https://lkml.kernel.org/r/20171204124059.63515-3-kirill.shutemov@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 1bd2b3061273f1bd7d691e3ea5c15e1f57f8ab6d
Author: Kirill A. Shutemov
Date: Mon Dec 4 15:40:55 2017 +0300
x86/boot/compressed/64: Detect and handle 5-level paging at boot-time
commit 08529078d8d9adf689bf39cc38d53979a0869970 upstream.
Prerequisite for fixing the current problem of instantaneous reboots when a
5-level paging kernel is booted on 4-level paging hardware.
At the same time this change prepares the decompression code to boot-time
switching between 4- and 5-level paging.
[ tglx: Folded the GCC < 5 fix. ]
Fixes: 77ef56e4f0fb ("x86: Enable 5-level paging support via CONFIG\_X86\_5LEVEL=y")
Signed-off-by: Kirill A. Shutemov
Signed-off-by: Thomas Gleixner
Cc: Andi Kleen
Cc: Andy Lutomirski
Cc: linux-mm@kvack.org
Cc: Cyrill Gorcunov
Cc: Borislav Petkov
Cc: Linus Torvalds
Link: https://lkml.kernel.org/r/20171204124059.63515-2-kirill.shutemov@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 2d8262155ab3d20219ca5815f65573592d717c3a
Author: Steve Wise
Date: Mon Nov 27 13:16:32 2017 -0800
iw\_cxgb4: only insert drain cqes if wq is flushed
commit c058ecf6e455fac7346d46197a02398ead90851f upstream.
Only insert our special drain CQEs to support ib\_drain\_sq/rq() after
the wq is flushed. Otherwise, existing but not yet polled CQEs can be
returned out of order to the user application. This can happen when the
QP has exited RTS but not yet flushed the QP, which can happen during
a normal close (vs abortive close).
In addition never count the drain CQEs when determining how many CQEs
need to be synthesized during the flush operation. This latter issue
should never happen if the QP is properly flushed before inserting the
drain CQE, but I wanted to avoid corrupting the CQ state. So we handle
it and log a warning once.
Fixes: 4fe7c2962e11 ("iw\_cxgb4: refactor sq/rq drain logic")
Signed-off-by: Steve Wise
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit 7dd1362247ebfe06ab1f58d7fee739c5f773a0ac
Author: Trond Myklebust
Date: Thu Dec 14 21:24:08 2017 -0500
SUNRPC: Fix a race in the receive code path
commit 90d91b0cd371193d9dbfa9beacab8ab9a4cb75e0 upstream.
We must ensure that the call to rpc\_sleep\_on() in xprt\_transmit() cannot
race with the call to xprt\_complete\_rqst().
Reported-by: Chuck Lever
Link: https://bugzilla.linux-nfs.org/show\_bug.cgi?id=317
Fixes: ce7c252a8c74 ("SUNRPC: Add a separate spinlock to protect..")
Reviewed-by: Chuck Lever
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit fbce429b410cc443ec3fa3293a0e4e5804ae4f2d
Author: monty\_pavel@sina.com
Date: Sat Nov 25 01:43:50 2017 +0800
dm: fix various targets to dm\_register\_target after module \_\_init resources created
commit 7e6358d244e4706fe612a77b9c36519a33600ac0 upstream.
A NULL pointer is seen if two concurrent "vgchange -ay -K "
processes race to load the dm-thin-pool module:
PID: 25992 TASK: ffff883cd7d23500 CPU: 4 COMMAND: "vgchange"
#0 [ffff883cd743d600] machine\_kexec at ffffffff81038fa9
0000001 [ffff883cd743d660] crash\_kexec at ffffffff810c5992
0000002 [ffff883cd743d730] oops\_end at ffffffff81515c90
0000003 [ffff883cd743d760] no\_context at ffffffff81049f1b
0000004 [ffff883cd743d7b0] \_\_bad\_area\_nosemaphore at ffffffff8104a1a5
0000005 [ffff883cd743d800] bad\_area at ffffffff8104a2ce
0000006 [ffff883cd743d830] \_\_do\_page\_fault at ffffffff8104aa6f
0000007 [ffff883cd743d950] do\_page\_fault at ffffffff81517bae
0000008 [ffff883cd743d980] page\_fault at ffffffff81514f95
[exception RIP: kmem\_cache\_alloc+108]
RIP: ffffffff8116ef3c RSP: ffff883cd743da38 RFLAGS: 00010046
RAX: 0000000000000004 RBX: ffffffff81121b90 RCX: ffff881bf1e78cc0
RDX: 0000000000000000 RSI: 00000000000000d0 RDI: 0000000000000000
RBP: ffff883cd743da68 R8: ffff881bf1a4eb00 R9: 0000000080042000
R10: 0000000000002000 R11: 0000000000000000 R12: 00000000000000d0
R13: 0000000000000000 R14: 00000000000000d0 R15: 0000000000000246
ORIG\_RAX: ffffffffffffffff CS: 0010 SS: 0018
0000009 [ffff883cd743da70] mempool\_alloc\_slab at ffffffff81121ba5
0000010 [ffff883cd743da80] mempool\_create\_node at ffffffff81122083
0000011 [ffff883cd743dad0] mempool\_create at ffffffff811220f4
0000012 [ffff883cd743dae0] pool\_ctr at ffffffffa08de049 [dm\_thin\_pool]
0000013 [ffff883cd743dbd0] dm\_table\_add\_target at ffffffffa0005f2f [dm\_mod]
0000014 [ffff883cd743dc30] table\_load at ffffffffa0008ba9 [dm\_mod]
0000015 [ffff883cd743dc90] ctl\_ioctl at ffffffffa0009dc4 [dm\_mod]
The race results in a NULL pointer because:
Process A (vgchange -ay -K):
a. send DM\_LIST\_VERSIONS\_CMD ioctl;
b. pool\_target not registered;
c. modprobe dm\_thin\_pool and wait until end.
Process B (vgchange -ay -K):
a. send DM\_LIST\_VERSIONS\_CMD ioctl;
b. pool\_target registered;
c. table\_load->dm\_table\_add\_target->pool\_ctr;
d. \_new\_mapping\_cache is NULL and panic.
Note:
1. process A and process B are two concurrent processes.
2. pool\_target can be detected by process B but
\_new\_mapping\_cache initialization has not ended.
To fix dm-thin-pool, and other targets (cache, multipath, and snapshot)
with the same problem, simply dm\_register\_target() after all resources
created during module init (as labelled with \_\_init) are finished.
Signed-off-by: monty
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit 282e4b259d4f9429f7813efc8076dd601ed59f45
Author: Steven Rostedt
Date: Sat Dec 2 13:04:54 2017 -0500
sched/rt: Do not pull from current CPU if only one CPU to pull
commit f73c52a5bcd1710994e53fbccc378c42b97a06b6 upstream.
Daniel Wagner reported a crash on the BeagleBone Black SoC.
This is a single CPU architecture, and does not have a functional
arch\_send\_call\_function\_single\_ipi() implementation which can crash
the kernel if that is called.
As it only has one CPU, it shouldn't be called, but if the kernel is
compiled for SMP, the push/pull RT scheduling logic now calls it for
irq\_work if the one CPU is overloaded, it can use that function to call
itself and crash the kernel.
Ideally, we should disable the SCHED\_FEAT(RT\_PUSH\_IPI) if the system
only has a single CPU. But SCHED\_FEAT is a constant if sched debugging
is turned off. Another fix can also be used, and this should also help
with normal SMP machines. That is, do not initiate the pull code if
there's only one RT overloaded CPU, and that CPU happens to be the
current CPU that is scheduling in a lower priority task.
Even on a system with many CPUs, if there's many RT tasks waiting to
run on a single CPU, and that CPU schedules in another RT task of lower
priority, it will initiate the PULL logic in case there's a higher
priority RT task on another CPU that is waiting to run. But if there is
no other CPU with waiting RT tasks, it will initiate the RT pull logic
on itself (as it still has RT tasks waiting to run). This is a wasted
effort.
Not only does this help with SMP code where the current CPU is the only
one with RT overloaded tasks, it should also solve the issue that
Daniel encountered, because it will prevent the PULL logic from
executing, as there's only one CPU on the system, and the check added
here will cause it to exit the RT pull code.
Reported-by: Daniel Wagner
Signed-off-by: Steven Rostedt (VMware)
Acked-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: linux-rt-users
Fixes: 4bdced5c9 ("sched/rt: Simplify the IPI based RT balancing logic")
Link: http://lkml.kernel.org/r/20171202130454.4cbbfe8d@vmware.local.home
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit c2f79ce3fe441486b3ab3dfce0f7bf49bd07dc3c
Author: Jason Yan
Date: Mon Dec 11 15:03:33 2017 +0800
scsi: libsas: fix length error in sas\_smp\_handler()
commit 621f6401fdeefe96dfe9eab4b167c7c39f552bb0 upstream.
The return value of smp\_execute\_task\_sg() is the untransferred residual,
but bsg\_job\_done() requires the length of payload received. This makes
SMP passthrough commands from userland by sg ioctl to libsas get a wrong
response. The userland tools such as smp\_utils failed because of these
wrong responses:
~#smp\_discover /dev/bsg/expander-2\:13
response too short, len=0
~#smp\_discover /dev/bsg/expander-2\:134
response too short, len=0
Fix this by passing the actual received length to bsg\_job\_done(). And if
smp\_execute\_task\_sg() returns 0, this means received length is exactly
the buffer length.
[mkp: typo]
Fixes: 651a01364994 ("scsi: scsi\_transport\_sas: switch to bsg-lib for SMP passthrough")
Signed-off-by: Jason Yan
Reported-by: chenqilin
Tested-by: chenqilin
CC: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 39c4330c9779d0acc213a0ace72b88a7b7a06012
Author: Bart Van Assche
Date: Tue Dec 5 16:57:51 2017 -0800
scsi: core: Fix a scsi\_show\_rq() NULL pointer dereference
commit 14e3062fb18532175af4d1c4073597999f7a2248 upstream.
Avoid that scsi\_show\_rq() triggers a NULL pointer dereference if called
after sd\_uninit\_command(). Swap the NULL pointer assignment and the
mempool\_free() call in sd\_uninit\_command() to make it less likely that
scsi\_show\_rq() triggers a use-after-free. Note: even with these changes
scsi\_show\_rq() can trigger a use-after-free but that's a lesser evil
than e.g. suppressing debug information for T10 PI Type 2 commands
completely. This patch fixes the following oops:
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: scsi\_format\_opcode\_name+0x1a/0x1c0
CPU: 1 PID: 1881 Comm: cat Not tainted 4.14.0-rc2.blk\_mq\_io\_hang+ #516
Call Trace:
\_\_scsi\_format\_command+0x27/0xc0
scsi\_show\_rq+0x5c/0xc0
\_\_blk\_mq\_debugfs\_rq\_show+0x116/0x130
blk\_mq\_debugfs\_rq\_show+0xe/0x10
seq\_read+0xfe/0x3b0
full\_proxy\_read+0x54/0x90
\_\_vfs\_read+0x37/0x160
vfs\_read+0x96/0x130
SyS\_read+0x55/0xc0
entry\_SYSCALL\_64\_fastpath+0x1a/0xa5
[mkp: added Type 2]
Fixes: 0eebd005dd07 ("scsi: Implement blk\_mq\_ops.show\_rq()")
Reported-by: Ming Lei
Signed-off-by: Bart Van Assche
Cc: James E.J. Bottomley
Cc: Martin K. Petersen
Cc: Ming Lei
Cc: Christoph Hellwig
Cc: Hannes Reinecke
Cc: Johannes Thumshirn
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 9854611cf5e604773fecfa75bfafc03621df508c
Author: Mark Rutland
Date: Wed Dec 13 11:45:42 2017 +0000
arm64: fix CONFIG\_DEBUG\_WX address reporting
commit 1d08a044cf12aee37dfd54837558e3295287b343 upstream.
In ptdump\_check\_wx(), we pass walk\_pgd() a start address of 0 (rather
than VA\_START) for the init\_mm. This means that any reported W&X
addresses are offset by VA\_START, which is clearly wrong and can make
them appear like userspace addresses.
Fix this by telling the ptdump code that we're walking init\_mm starting
at VA\_START. We don't need to update the addr\_markers, since these are
still valid bounds regardless.
Fixes: 1404d6f13e47 ("arm64: dump: Add checking for writable and exectuable pages")
Signed-off-by: Mark Rutland
Cc: Kees Cook
Cc: Laura Abbott
Reported-by: Timur Tabi
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit cdcfd13a66eb53fd96dc480de79c423aa0de9d39
Author: Steve Capper
Date: Mon Dec 4 14:13:05 2017 +0000
arm64: Initialise high\_memory global variable earlier
commit f24e5834a2c3f6c5f814a417f858226f0a010ade upstream.
The high\_memory global variable is used by
cma\_declare\_contiguous(.) before it is defined.
We don't notice this as we compute \_\_pa(high\_memory - 1), and it looks
like we're processing a VA from the direct linear map.
This problem becomes apparent when we flip the kernel virtual address
space and the linear map is moved to the bottom of the kernel VA space.
This patch moves the initialisation of high\_memory before it used.
Fixes: f7426b983a6a ("mm: cma: adjust address limit to avoid hitting low/high memory boundary")
Signed-off-by: Steve Capper
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit db9d4784eb5ba8c69ea6b1a7b7c7c7af0b6bdf4d
Author: Steve Capper
Date: Fri Dec 1 17:22:14 2017 +0000
arm64: mm: Fix pte\_mkclean, pte\_mkdirty semantics
commit 8781bcbc5e69d7da69e84c7044ca0284848d5d01 upstream.
On systems with hardware dirty bit management, the ltp madvise09 unit
test fails due to dirty bit information being lost and pages being
incorrectly freed.
This was bisected to:
arm64: Ignore hardware dirty bit updates in ptep\_set\_wrprotect()
Reverting this commit leads to a separate problem, that the unit test
retains pages that should have been dropped due to the function
madvise\_free\_pte\_range(.) not cleaning pte's properly.
Currently pte\_mkclean only clears the software dirty bit, thus the
following code sequence can appear:
pte = pte\_mkclean(pte);
if (pte\_dirty(pte))
// this condition can return true with HW DBM!
This patch also adjusts pte\_mkclean to set PTE\_RDONLY thus effectively
clearing both the SW and HW dirty information.
In order for this to function on systems without HW DBM, we need to
also adjust pte\_mkdirty to remove the read only bit from writable pte's
to avoid infinite fault loops.
Fixes: 64c26841b349 ("arm64: Ignore hardware dirty bit updates in ptep\_set\_wrprotect()")
Reported-by: Bhupinder Thakur
Tested-by: Bhupinder Thakur
Reviewed-by: Catalin Marinas
Signed-off-by: Steve Capper
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 268b2cc325061c60fa2dccfa4d61495e9306c4fa
Author: Scott Mayhew
Date: Fri Dec 8 16:00:12 2017 -0500
nfs: don't wait on commit in nfs\_commit\_inode() if there were no commit requests
commit dc4fd9ab01ab379ae5af522b3efd4187a7c30a31 upstream.
If there were no commit requests, then nfs\_commit\_inode() should not
wait on the commit or mark the inode dirty, otherwise the following
BUG\_ON can be triggered:
[ 1917.130762] kernel BUG at fs/inode.c:578!
[ 1917.130766] Oops: Exception in kernel mode, sig: 5 [#1]
[ 1917.130768] SMP NR\_CPUS=2048 NUMA pSeries
[ 1917.130772] Modules linked in: iscsi\_tcp libiscsi\_tcp libiscsi scsi\_transport\_iscsi blocklayoutdriver rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache sunrpc sg nx\_crypto pseries\_rng ip\_tables xfs libcrc32c sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_common ibmvscsi scsi\_transport\_srp ibmveth scsi\_tgt dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 1917.130805] CPU: 2 PID: 14923 Comm: umount.nfs4 Tainted: G ------------ T 3.10.0-768.el7.ppc64 #1
[ 1917.130810] task: c0000005ecd88040 ti: c00000004cea0000 task.ti: c00000004cea0000
[ 1917.130813] NIP: c000000000354178 LR: c000000000354160 CTR: c00000000012db80
[ 1917.130816] REGS: c00000004cea3720 TRAP: 0700 Tainted: G ------------ T (3.10.0-768.el7.ppc64)
[ 1917.130820] MSR: 8000000100029032  CR: 22002822 XER: 20000000
[ 1917.130828] CFAR: c00000000011f594 SOFTE: 1
GPR00: c000000000354160 c00000004cea39a0 c0000000014c4700 c0000000018cc750
GPR04: 000000000000c750 80c0000000000000 0600000000000000 04eeb76bea749a03
GPR08: 0000000000000034 c0000000018cc758 0000000000000001 d000000005e619e8
GPR12: c00000000012db80 c000000007b31200 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR24: 0000000000000000 c000000000dfc3ec 0000000000000000 c0000005eefc02c0
GPR28: d0000000079dbd50 c0000005b94a02c0 c0000005b94a0250 c0000005b94a01c8
[ 1917.130867] NIP [c000000000354178] .evict+0x1c8/0x350
[ 1917.130871] LR [c000000000354160] .evict+0x1b0/0x350
[ 1917.130873] Call Trace:
[ 1917.130876] [c00000004cea39a0] [c000000000354160] .evict+0x1b0/0x350 (unreliable)
[ 1917.130880] [c00000004cea3a30] [c0000000003558cc] .evict\_inodes+0x13c/0x270
[ 1917.130884] [c00000004cea3af0] [c000000000327d20] .kill\_anon\_super+0x70/0x1e0
[ 1917.130896] [c00000004cea3b80] [d000000005e43e30] .nfs\_kill\_super+0x20/0x60 [nfs]
[ 1917.130900] [c00000004cea3c00] [c000000000328a20] .deactivate\_locked\_super+0xa0/0x1b0
[ 1917.130903] [c00000004cea3c80] [c00000000035ba54] .cleanup\_mnt+0xd4/0x180
[ 1917.130907] [c00000004cea3d10] [c000000000119034] .task\_work\_run+0x114/0x150
[ 1917.130912] [c00000004cea3db0] [c00000000001ba6c] .do\_notify\_resume+0xcc/0x100
[ 1917.130916] [c00000004cea3e30] [c00000000000a7b0] .ret\_from\_except\_lite+0x5c/0x60
[ 1917.130919] Instruction dump:
[ 1917.130921] 7fc3f378 486734b5 60000000 387f00a0 38800003 4bdcb365 60000000 e95f00a0
[ 1917.130927] 694a0060 7d4a0074 794ad182 694a0001 <0b0a0000> 892d02a4 2f890000 40de0134
Signed-off-by: Scott Mayhew
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 74b6274f8c5e81d7243ca2dea4f80c8585b3d0e0
Author: Daniel Jurgens
Date: Tue Dec 5 22:30:02 2017 +0200
IB/core: Don't enforce PKey security on SMI MADs
commit 0fbe8f575b15585eec3326e43708fbbc024e8486 upstream.
Per the infiniband spec an SMI MAD can have any PKey. Checking the pkey
on SMI MADs is not necessary, and it seems that some older adapters
using the mthca driver don't follow the convention of using the default
PKey, resulting in false denials, or errors querying the PKey cache.
SMI MAD security is still enforced, only agents allowed to manage the
subnet are able to receive or send SMI MADs.
Reported-by: Chris Blake
Fixes: 47a2b338fe63 ("IB/core: Enforce security on management datagrams")
Signed-off-by: Daniel Jurgens
Reviewed-by: Parav Pandit
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 4995bfa99096410af00aa0b1b374005494c709f3
Author: Daniel Jurgens
Date: Tue Dec 5 22:30:01 2017 +0200
IB/core: Bound check alternate path port number
commit 4cae8ff136782d77b108cb3a5ba53e60597ba3a6 upstream.
The alternate port number is used as an array index in the IB
security implementation, invalid values can result in a kernel panic.
Fixes: d291f1a65232 ("IB/core: Enforce PKey security on QPs")
Signed-off-by: Daniel Jurgens
Reviewed-by: Parav Pandit
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 2b3ff282dff3a42a081bef0f8249a99f64d7669f
Author: Mathias Nyman
Date: Fri Dec 8 18:10:05 2017 +0200
xhci: Don't add a virt\_dev to the devs array before it's fully allocated
commit 5d9b70f7d52eb14bb37861c663bae44de9521c35 upstream.
Avoid null pointer dereference if some function is walking through the
devs array accessing members of a new virt\_dev that is mid allocation.
Add the virt\_dev to xhci->devs[i] \_after\_ the virt\_device and all its
members are properly allocated.
issue found by KASAN: null-ptr-deref in xhci\_find\_slot\_id\_by\_port
"Quick analysis suggests that xhci\_alloc\_virt\_device() is not mutex
protected. If so, there is a time frame where xhci->devs[slot\_id] is set
but not fully initialized. Specifically, xhci->devs[i]->udev can be NULL."
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 912fe79116f2456a00cf4a9b2ad3ef207ba3e162
Author: Chunfeng Yun
Date: Fri Dec 8 18:10:06 2017 +0200
usb: xhci: fix TDS for MTK xHCI1.1
commit 72b663a99c074a8d073e7ecdae446cfb024ef551 upstream.
For MTK's xHCI 1.0 or latter, TD size is the number of max
packet sized packets remaining in the TD, not including
this TRB (following spec).
For MTK's xHCI 0.96 and older, TD size is the number of max
packet sized packets remaining in the TD, including this TRB
(not following spec).
Signed-off-by: Chunfeng Yun
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit eae219a2fc5554d86b9ac4d31bef73c273e926c0
Author: Yan, Zheng
Date: Thu Nov 30 11:59:22 2017 +0800
ceph: drop negative child dentries before try pruning inode's alias
commit 040d786032bf59002d374b86d75b04d97624005c upstream.
Negative child dentry holds reference on inode's alias, it makes
d\_prune\_aliases() do nothing.
Signed-off-by: "Yan, Zheng"
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 318cea7d8d801cfa70f5b3a3a991425cd502b574
Author: Christoph Fritz
Date: Sat Dec 9 23:47:55 2017 +0100
mmc: core: apply NO\_CMD23 quirk to some specific cards
commit 91516a2a4734614d62ee3ed921f8f88acc67c000 upstream.
To get an usdhc Apacer and some ATP SD cards work reliable, CMD23 needs
to be disabled. This has been tested on i.MX6 (sdhci-esdhc) and rk3288
(dw\_mmc-rockchip).
Without this patch on i.MX6 (sdhci-esdhc):
$ dd if=/dev/urandom of=/mnt/test bs=1M count=10 conv=fsync
|
| mmc0: starting CMD25 arg 00a71f00 flags 000000b5
| mmc0: blksz 512 blocks 1024 flags 00000100 tsac 3000 ms nsac 0
| mmc0: CMD12 arg 00000000 flags 0000049d
| sdhci [sdhci\_irq()]: \*\*\* mmc0 got interrupt: 0x00000001
| mmc0: Timeout waiting for hardware interrupt.
Without this patch on rk3288 (dw\_mmc-rockchip):
| mmc1: Card stuck in programming state! mmcblk1 card\_busy\_detect
| dwmmc\_rockchip ff0c0000.dwmmc: Busy; trying anyway
| mmc\_host mmc1: Bus speed (slot 0) = 400000Hz (slot req 400000Hz,
| actual 400000HZ div = 0)
| mmc1: card never left busy state
| mmc1: tried to reset card, got error -110
| blk\_update\_request: I/O error, dev mmcblk1, sector 139778
| Buffer I/O error on dev mmcblk1p1, logical block 131586, lost async
| page write
Signed-off-by: Christoph Fritz
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit d78a5506cf0ea112124c1ffa5c0aae09b579d96d
Author: Shuah Khan
Date: Thu Dec 7 14:16:50 2017 -0700
usbip: fix stub\_send\_ret\_submit() vulnerability to null transfer\_buffer
commit be6123df1ea8f01ee2f896a16c2b7be3e4557a5a upstream.
stub\_send\_ret\_submit() handles urb with a potential null transfer\_buffer,
when it replays a packet with potential malicious data that could contain
a null buffer. Add a check for the condition when actual\_length > 0 and
transfer\_buffer is null.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit b6a2ad646c13bb9d1231bce5599cb3176ff33ca4
Author: Shuah Khan
Date: Thu Dec 7 14:16:49 2017 -0700
usbip: prevent vhci\_hcd driver from leaking a socket pointer address
commit 2f2d0088eb93db5c649d2a5e34a3800a8a935fc5 upstream.
When a client has a USB device attached over IP, the vhci\_hcd driver is
locally leaking a socket pointer address via the
/sys/devices/platform/vhci\_hcd/status file (world-readable) and in debug
output when "usbip --debug port" is run.
Fix it to not leak. The socket pointer address is not used at the moment
and it was made visible as a convenient way to find IP address from socket
pointer address by looking up /proc/net/{tcp,tcp6}.
As this opens a security hole, the fix replaces socket pointer address with
sockfd.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 1621db059603e781f61a9bf33cba639b42faf0bc
Author: Shuah Khan
Date: Thu Dec 7 14:16:48 2017 -0700
usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious input
commit c6688ef9f29762e65bce325ef4acd6c675806366 upstream.
Harden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 7120d742ad8d0f1fe37e4b73827e166fc1e01eea
Author: Shuah Khan
Date: Thu Dec 7 14:16:47 2017 -0700
usbip: fix stub\_rx: get\_pipe() to validate endpoint number
commit 635f545a7e8be7596b9b2b6a43cab6bbd5a88e43 upstream.
get\_pipe() routine doesn't validate the input endpoint number
and uses to reference ep\_in and ep\_out arrays. Invalid endpoint
number can trigger BUG(). Range check the epnum and returning
error instead of calling BUG().
Change caller stub\_recv\_cmd\_submit() to handle the get\_pipe()
error return.
Reported-by: Secunia Research
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit cb6ee0f3c19980328529d5ed7a1650e41164ca49
Author: Amir Goldstein
Date: Wed Nov 29 07:35:21 2017 +0200
ovl: update ctx->pos on impure dir iteration
commit b02a16e6413a2f782e542ef60bad9ff6bf212f8a upstream.
This fixes a regression with readdir of impure dir in overlayfs
that is shared to VM via 9p fs.
Reported-by: Miguel Bernal Marin
Fixes: 4edb83bb1041 ("ovl: constant d\_ino for non-merge dirs")
Signed-off-by: Amir Goldstein
Tested-by: Miguel Bernal Marin
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 066f40dc495d5ab2ec9a871cb8703d9591d636c5
Author: Vivek Goyal
Date: Mon Nov 27 10:12:44 2017 -0500
ovl: Pass ovl\_get\_nlink() parameters in right order
commit 08d8f8a5b094b66b29936e8751b4a818b8db1207 upstream.
Right now we seem to be passing index as "lowerdentry" and origin.dentry
as "upperdentry". IIUC, we should pass these parameters in reversed order
and this looks like a bug.
Signed-off-by: Vivek Goyal
Acked-by: Amir Goldstein
Fixes: caf70cb2ba5d ("ovl: cleanup orphan index entries")
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 4c5ae6a301a5415d1334f6c655bebf91d475bd89
Author: Alan Stern
Date: Tue Dec 12 14:25:13 2017 -0500
USB: core: prevent malicious bNumInterfaces overflow
commit 48a4ff1c7bb5a32d2e396b03132d20d552c0eca7 upstream.
A malicious USB device with crafted descriptors can cause the kernel
to access unallocated memory by setting the bNumInterfaces value too
high in a configuration descriptor. Although the value is adjusted
during parsing, this adjustment is skipped in one of the error return
paths.
This patch prevents the problem by setting bNumInterfaces to 0
initially. The existing code already sets it to the proper value
after parsing is complete.
Signed-off-by: Alan Stern
Reported-by: Andrey Konovalov
Signed-off-by: Greg Kroah-Hartman
commit 6391294874d505a5e8681c41439a74e7019b267f
Author: David Kozub
Date: Tue Dec 5 22:40:04 2017 +0100
USB: uas and storage: Add US\_FL\_BROKEN\_FUA for another JMicron JMS567 ID
commit 62354454625741f0569c2cbe45b2d192f8fd258e upstream.
There is another JMS567-based USB3 UAS enclosure (152d:0578) that fails
with the following error:
[sda] tag#0 FAILED Result: hostbyte=DID\_OK driverbyte=DRIVER\_SENSE
[sda] tag#0 Sense Key : Illegal Request [current]
[sda] tag#0 Add. Sense: Invalid field in cdb
The issue occurs both with UAS (occasionally) and mass storage
(immediately after mounting a FS on a disk in the enclosure).
Enabling US\_FL\_BROKEN\_FUA quirk solves this issue.
This patch adds an UNUSUAL\_DEV with US\_FL\_BROKEN\_FUA for the enclosure
for both UAS and mass storage.
Signed-off-by: David Kozub
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit b8582c0f792fc1603a8998de60a156359f15dfd4
Author: Changbin Du
Date: Thu Nov 30 11:39:43 2017 +0800
tracing: Allocate mask\_str buffer dynamically
commit 90e406f96f630c07d631a021fd4af10aac913e77 upstream.
The default NR\_CPUS can be very large, but actual possible nr\_cpu\_ids
usually is very small. For my x86 distribution, the NR\_CPUS is 8192 and
nr\_cpu\_ids is 4. About 2 pages are wasted.
Most machines don't have so many CPUs, so define a array with NR\_CPUS
just wastes memory. So let's allocate the buffer dynamically when need.
With this change, the mutext tracing\_cpumask\_update\_lock also can be
removed now, which was used to protect mask\_str.
Link: http://lkml.kernel.org/r/1512013183-19107-1-git-send-email-changbin.du@intel.com
Fixes: 36dfe9252bd4c ("ftrace: make use of tracing\_cpumask")
Signed-off-by: Changbin Du
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 55fe4698d80ecb553d015b5df96ccf9584cbc06b
Author: Michal Hocko
Date: Thu Dec 14 15:33:15 2017 -0800
mm, oom\_reaper: fix memory corruption
commit 4837fe37adff1d159904f0c013471b1ecbcb455e upstream.
David Rientjes has reported the following memory corruption while the
oom reaper tries to unmap the victims address space
BUG: Bad page map in process oom\_reaper pte:6353826300000000 pmd:00000000
addr:00007f50cab1d000 vm\_flags:08100073 anon\_vma:ffff9eea335603f0 mapping: (null) index:7f50cab1d
file: (null) fault: (null) mmap: (null) readpage: (null)
CPU: 2 PID: 1001 Comm: oom\_reaper
Call Trace:
unmap\_page\_range+0x1068/0x1130
\_\_oom\_reap\_task\_mm+0xd5/0x16b
oom\_reaper+0xff/0x14c
kthread+0xc1/0xe0
Tetsuo Handa has noticed that the synchronization inside exit\_mmap is
insufficient. We only synchronize with the oom reaper if
tsk\_is\_oom\_victim which is not true if the final \_\_mmput is called from
a different context than the oom victim exit path. This can trivially
happen from context of any task which has grabbed mm reference (e.g. to
read /proc// file which requires mm etc.).
The race would look like this
oom\_reaper oom\_victim task
mmget\_not\_zero
do\_exit
mmput
\_\_oom\_reap\_task\_mm mmput
\_\_mmput
exit\_mmap
remove\_vma
unmap\_page\_range
Fix this issue by providing a new mm\_is\_oom\_victim() helper which
operates on the mm struct rather than a task. Any context which
operates on a remote mm struct should use this helper in place of
tsk\_is\_oom\_victim. The flag is set in mark\_oom\_victim and never cleared
so it is stable in the exit\_mmap path.
Debugged by Tetsuo Handa.
Link: http://lkml.kernel.org/r/20171210095130.17110-1-mhocko@kernel.org
Fixes: 212925802454 ("mm: oom: let oom\_reap\_task and exit\_mmap run concurrently")
Signed-off-by: Michal Hocko
Reported-by: David Rientjes
Acked-by: David Rientjes
Cc: Tetsuo Handa
Cc: Andrea Argangeli
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c5d9b78d530a45f0c226317764a7865f7911ab46
Author: Thiago Rafael Becker
Date: Thu Dec 14 15:33:12 2017 -0800
kernel: make groups\_sort calling a responsibility group\_info allocators
commit bdcf0a423ea1c40bbb40e7ee483b50fc8aa3d758 upstream.
In testing, we found that nfsd threads may call set\_groups in parallel
for the same entry cached in auth.unix.gid, racing in the call of
groups\_sort, corrupting the groups for that entry and leading to
permission denials for the client.
This patch:
- Make groups\_sort globally visible.
- Move the call to groups\_sort to the modifiers of group\_info
- Remove the call to groups\_sort from set\_groups
Link: http://lkml.kernel.org/r/20171211151420.18655-1-thiago.becker@gmail.com
Signed-off-by: Thiago Rafael Becker
Reviewed-by: Matthew Wilcox
Reviewed-by: NeilBrown
Acked-by: "J. Bruce Fields"
Cc: Al Viro
Cc: Martin Schwidefsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d3d2f01a6eaf6022167c94afba34b6d6722392c9
Author: NeilBrown
Date: Thu Dec 14 15:32:38 2017 -0800
autofs: fix careless error in recent commit
commit 302ec300ef8a545a7fc7f667e5fd743b091c2eeb upstream.
Commit ecc0c469f277 ("autofs: don't fail mount for transient error") was
meant to replace an 'if' with a 'switch', but instead added the 'switch'
leaving the case in place.
Link: http://lkml.kernel.org/r/87zi6wstmw.fsf@notabene.neil.brown.name
Fixes: ecc0c469f277 ("autofs: don't fail mount for transient error")
Reported-by: Ben Hutchings
Signed-off-by: NeilBrown
Cc: Ian Kent
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c8def7a4185b8b1ec2b843af346977f00259414e
Author: Arnd Bergmann
Date: Thu Dec 14 15:32:34 2017 -0800
string.h: workaround for increased stack usage
commit 146734b091430c80d80bb96b1139a96fb4bc830e upstream.
The hardened strlen() function causes rather large stack usage in at
least one file in the kernel, in particular when CONFIG\_KASAN is
enabled:
drivers/media/usb/em28xx/em28xx-dvb.c: In function 'em28xx\_dvb\_init':
drivers/media/usb/em28xx/em28xx-dvb.c:2062:1: error: the frame size of 3256 bytes is larger than 204 bytes [-Werror=frame-larger-than=]
Analyzing this problem led to the discovery that gcc fails to merge the
stack slots for the i2c\_board\_info[] structures after we strlcpy() into
them, due to the 'noreturn' attribute on the source string length check.
I reported this as a gcc bug, but it is unlikely to get fixed for gcc-8,
since it is relatively easy to work around, and it gets triggered
rarely. An earlier workaround I did added an empty inline assembly
statement before the call to fortify\_panic(), which works surprisingly
well, but is really ugly and unintuitive.
This is a new approach to the same problem, this time addressing it by
not calling the 'extern \_\_real\_strnlen()' function for string constants
where \_\_builtin\_strlen() is a compile-time constant and therefore known
to be safe.
We do this by checking if the last character in the string is a
compile-time constant '\0'. If it is, we can assume that strlen() of
the string is also constant.
As a side-effect, this should also improve the object code output for
any other call of strlen() on a string constant.
[akpm@linux-foundation.org: add comment]
Link: http://lkml.kernel.org/r/20171205215143.3085755-1-arnd@arndb.de
Link: https://gcc.gnu.org/bugzilla/show\_bug.cgi?id=82365
Link: https://patchwork.kernel.org/patch/9980413/
Link: https://patchwork.kernel.org/patch/9974047/
Fixes: 6974f0c4555 ("include/linux/string.h: add the option of fortified string.h functions")
Signed-off-by: Arnd Bergmann
Cc: Kees Cook
Cc: Mauro Carvalho Chehab
Cc: Dmitry Vyukov
Cc: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Daniel Micay
Cc: Greg Kroah-Hartman
Cc: Martin Wilck
Cc: Dan Williams
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6f3fc5f95975e101b198ecf223ad6f9f8994b191
Author: Ronnie Sahlberg
Date: Tue Nov 21 09:36:33 2017 +1100
cifs: fix NULL deref in SMB2\_read
commit a821df3f1af72aa6a0d573eea94a7dd2613e9f4e upstream.
Signed-off-by: Ronnie Sahlberg
Reviewed-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit cf1048e46d4f301261d946e73add464fb95fd5a4
Author: Eric Biggers
Date: Tue Nov 28 00:46:24 2017 -0800
crypto: af\_alg - fix NULL pointer dereference in
commit 887207ed9e5812ed9239b6d07185a2d35dda91db upstream.
af\_alg\_free\_areq\_sgls()
If allocating the ->tsgl member of 'struct af\_alg\_async\_req' failed,
during cleanup we dereferenced the NULL ->tsgl pointer in
af\_alg\_free\_areq\_sgls(), because ->tsgl\_entries was nonzero.
Fix it by only freeing the ->tsgl list if it is non-NULL.
This affected both algif\_skcipher and algif\_aead.
Fixes: e870456d8e7c ("crypto: algif\_skcipher - overhaul memory management")
Fixes: d887c52d6ae4 ("crypto: algif\_aead - overhaul memory management")
Reported-by: syzbot
Signed-off-by: Eric Biggers
Reviewed-by: Stephan Mueller
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit c68b31521d5fb7216cb1113130399afe65437c6c
Author: Eric Biggers
Date: Tue Nov 28 20:56:59 2017 -0800
crypto: salsa20 - fix blkcipher\_walk API usage
commit ecaaab5649781c5a0effdaf298a925063020500e upstream.
When asked to encrypt or decrypt 0 bytes, both the generic and x86
implementations of Salsa20 crash in blkcipher\_walk\_done(), either when
doing 'kfree(walk->buffer)' or 'free\_page((unsigned long)walk->page)',
because walk->buffer and walk->page have not been initialized.
The bug is that Salsa20 is calling blkcipher\_walk\_done() even when
nothing is in 'walk.nbytes'. But blkcipher\_walk\_done() is only meant to
be called when a nonzero number of bytes have been provided.
The broken code is part of an optimization that tries to make only one
call to salsa20\_encrypt\_bytes() to process inputs that are not evenly
divisible by 64 bytes. To fix the bug, just remove this "optimization"
and use the blkcipher\_walk API the same way all the other users do.
Reproducer:
#include
#include
#include
int main()
{
int algfd, reqfd;
struct sockaddr\_alg addr = {
.salg\_type = "skcipher",
.salg\_name = "salsa20",
};
char key[16] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (void \*)&addr, sizeof(addr));
reqfd = accept(algfd, 0, 0);
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
read(reqfd, key, sizeof(key));
}
Reported-by: syzbot
Fixes: eb6f13eb9f81 ("[CRYPTO] salsa20\_generic: Fix multi-page processing")
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 902ae89f841de0c8d2857919296923f6332e174f
Author: Eric Biggers
Date: Tue Nov 28 18:01:38 2017 -0800
crypto: hmac - require that the underlying hash algorithm is unkeyed
commit af3ff8045bbf3e32f1a448542e73abb4c8ceb6f1 upstream.
Because the HMAC template didn't check that its underlying hash
algorithm is unkeyed, trying to use "hmac(hmac(sha3-512-generic))"
through AF\_ALG or through KEYCTL\_DH\_COMPUTE resulted in the inner HMAC
being used without having been keyed, resulting in sha3\_update() being
called without sha3\_init(), causing a stack buffer overflow.
This is a very old bug, but it seems to have only started causing real
problems when SHA-3 support was added (requires CONFIG\_CRYPTO\_SHA3)
because the innermost hash's state is ->import()ed from a zeroed buffer,
and it just so happens that other hash algorithms are fine with that,
but SHA-3 is not. However, there could be arch or hardware-dependent
hash algorithms also affected; I couldn't test everything.
Fix the bug by introducing a function crypto\_shash\_alg\_has\_setkey()
which tests whether a shash algorithm is keyed. Then update the HMAC
template to require that its underlying hash algorithm is unkeyed.
Here is a reproducer:
#include
#include
int main()
{
int algfd;
struct sockaddr\_alg addr = {
.salg\_type = "hash",
.salg\_name = "hmac(hmac(sha3-512-generic))",
};
char key[4096] = { 0 };
algfd = socket(AF\_ALG, SOCK\_SEQPACKET, 0);
bind(algfd, (const struct sockaddr \*)&addr, sizeof(addr));
setsockopt(algfd, SOL\_ALG, ALG\_SET\_KEY, key, sizeof(key));
}
Here was the KASAN report from syzbot:
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:341 [inline]
BUG: KASAN: stack-out-of-bounds in sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
Write of size 4096 at addr ffff8801cca07c40 by task syzkaller076574/3044
CPU: 1 PID: 3044 Comm: syzkaller076574 Not tainted 4.14.0-mm1+ #25
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:17 [inline]
dump\_stack+0x194/0x257 lib/dump\_stack.c:53
print\_address\_description+0x73/0x250 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x25b/0x340 mm/kasan/report.c:409
check\_memory\_region\_inline mm/kasan/kasan.c:260 [inline]
check\_memory\_region+0x137/0x190 mm/kasan/kasan.c:267
memcpy+0x37/0x50 mm/kasan/kasan.c:303
memcpy include/linux/string.h:341 [inline]
sha3\_update+0xdf/0x2e0 crypto/sha3\_generic.c:161
crypto\_shash\_update+0xcb/0x220 crypto/shash.c:109
shash\_finup\_unaligned+0x2a/0x60 crypto/shash.c:151
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
hmac\_finup+0x182/0x330 crypto/hmac.c:152
crypto\_shash\_finup+0xc4/0x120 crypto/shash.c:165
shash\_digest\_unaligned+0x9e/0xd0 crypto/shash.c:172
crypto\_shash\_digest+0xc4/0x120 crypto/shash.c:186
hmac\_setkey+0x36a/0x690 crypto/hmac.c:66
crypto\_shash\_setkey+0xad/0x190 crypto/shash.c:64
shash\_async\_setkey+0x47/0x60 crypto/shash.c:207
crypto\_ahash\_setkey+0xaf/0x180 crypto/ahash.c:200
hash\_setkey+0x40/0x90 crypto/algif\_hash.c:446
alg\_setkey crypto/af\_alg.c:221 [inline]
alg\_setsockopt+0x2a1/0x350 crypto/af\_alg.c:254
SYSC\_setsockopt net/socket.c:1851 [inline]
SyS\_setsockopt+0x189/0x360 net/socket.c:1830
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Reported-by: syzbot
Signed-off-by: Eric Biggers
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 80dbdc5ae74d6167edf081f8865df06fb6615578
Author: Eric Biggers
Date: Sun Nov 26 23:16:49 2017 -0800
crypto: rsa - fix buffer overread when stripping leading zeroes
commit d2890c3778b164fde587bc16583f3a1c87233ec5 upstream.
In rsa\_get\_n(), if the buffer contained all 0's and "FIPS mode" is
enabled, we would read one byte past the end of the buffer while
scanning the leading zeroes. Fix it by checking 'n\_sz' before '!\*ptr'.
This bug was reachable by adding a specially crafted key of type
"asymmetric" (requires CONFIG\_RSA and CONFIG\_X509\_CERTIFICATE\_PARSER).
KASAN report:
BUG: KASAN: slab-out-of-bounds in rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
Read of size 1 at addr ffff88003501a708 by task keyctl/196
CPU: 1 PID: 196 Comm: keyctl Not tainted 4.14.0-09238-g1d3b78bbc6e9 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110\_100015-anatol 04/01/2014
Call Trace:
rsa\_get\_n+0x19e/0x1d0 crypto/rsa\_helper.c:33
asn1\_ber\_decoder+0x82a/0x1fd0 lib/asn1\_decoder.c:328
rsa\_set\_pub\_key+0xd3/0x320 crypto/rsa.c:278
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
pkcs1pad\_set\_pub\_key+0xae/0x200 crypto/rsa-pkcs1pad.c:117
crypto\_akcipher\_set\_pub\_key ./include/crypto/akcipher.h:364 [inline]
public\_key\_verify\_signature+0x270/0x9d0 crypto/asymmetric\_keys/public\_key.c:106
x509\_check\_for\_self\_signed+0x2ea/0x480 crypto/asymmetric\_keys/x509\_public\_key.c:141
x509\_cert\_parse+0x46a/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:129
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Allocated by task 196:
\_\_do\_kmalloc mm/slab.c:3711 [inline]
\_\_kmalloc\_track\_caller+0x118/0x2e0 mm/slab.c:3726
kmemdup+0x17/0x40 mm/util.c:118
kmemdup ./include/linux/string.h:414 [inline]
x509\_cert\_parse+0x2cb/0x620 crypto/asymmetric\_keys/x509\_cert\_parser.c:106
x509\_key\_preparse+0x61/0x750 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xa4/0x150 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x4d4/0x10a0 security/keys/key.c:850
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0xe8/0x290 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0x96
Fixes: 5a7de97309f5 ("crypto: rsa - return raw integers for the ASN.1 parser")
Cc: Tudor Ambarus
Signed-off-by: Eric Biggers
Reviewed-by: James Morris
Reviewed-by: David Howells
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 96c2dfaebe1a8eba95d43732a1413c777469128c
Author: Eric Biggers
Date: Mon Nov 27 23:23:05 2017 -0800
crypto: algif\_aead - fix reference counting of null skcipher
commit b32a7dc8aef1882fbf983eb354837488cc9d54dc upstream.
In the AEAD interface for AF\_ALG, the reference to the "null skcipher"
held by each tfm was being dropped in the wrong place -- when each
af\_alg\_ctx was freed instead of when the aead\_tfm was freed. As
discovered by syzkaller, a specially crafted program could use this to
cause the null skcipher to be freed while it is still in use.
Fix it by dropping the reference in the right place.
Fixes: 72548b093ee3 ("crypto: algif\_aead - copy AAD from src to dst")
Reported-by: syzbot
Signed-off-by: Eric Biggers
Reviewed-by: Stephan Mueller
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 3d27b022022a88e189c0e9d63c4ac01af354735f
Author: Martin Kaiser
Date: Tue Oct 17 22:53:08 2017 +0200
mfd: fsl-imx25: Clean up irq settings during removal
commit 18f77393796848e68909e65d692c1d1436f06e06 upstream.
When fsl-imx25-tsadc is compiled as a module, loading, unloading and
reloading the module will lead to a crash.
Unable to handle kernel paging request at virtual address bf005430
[] (irq\_find\_matching\_fwspec)
from [] (of\_irq\_get+0x58/0x74)
[] (of\_irq\_get)
from [] (platform\_get\_irq+0x48/0xc8)
[] (platform\_get\_irq)
from [] (mx25\_tsadc\_probe+0x220/0x2f4 [fsl\_imx25\_tsadc])
irq\_find\_matching\_fwspec() loops over all registered irq domains. The
irq domain is still registered from last time the module was loaded but
the pointer to its operations is invalid after the module was unloaded.
Add a removal function which clears the irq handler and removes the irq
domain. With this cleanup in place, it's possible to unload and reload
the module.
Signed-off-by: Martin Kaiser
Reviewed-by: Lucas Stach
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_6ee7e00b_20250125_181644.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.13.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6688ef9f29762e65bce325ef4acd6c675806366)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/drivers/usb/usbip)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/drivers/usb/usbip) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6688ef9f29762e65bce325ef4acd6c675806366)/[drivers](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers?id=c6688ef9f29762e65bce325ef4acd6c675806366)/[usb](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb?id=c6688ef9f29762e65bce325ef4acd6c675806366)/[usbip](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shuah Khan <shuahkh@osg.samsung.com> | 2017-12-07 14:16:48 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2017-12-08 17:32:23 +0100 |
| commit | [c6688ef9f29762e65bce325ef4acd6c675806366](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366)) | |
| tree | [083ad6fdada35ec3ccbe4c637f92cc210ad7f5d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6688ef9f29762e65bce325ef4acd6c675806366) /[drivers/usb/usbip](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366) | |
| parent | [635f545a7e8be7596b9b2b6a43cab6bbd5a88e43](/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/usb/usbip?id=635f545a7e8be7596b9b2b6a43cab6bbd5a88e43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip?id=c6688ef9f29762e65bce325ef4acd6c675806366&id2=635f545a7e8be7596b9b2b6a43cab6bbd5a88e43)) | |
| download | [linux-c6688ef9f29762e65bce325ef4acd6c675806366.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6688ef9f29762e65bce325ef4acd6c675806366.tar.gz) | |

usbip: fix stub\_rx: harden CMD\_SUBMIT path to handle malicious inputHarden CMD\_SUBMIT path to handle malicious input that could trigger
large memory allocations. Add checks to validate transfer\_buffer\_length
and number\_of\_packets to protect against bad input requesting for
unbounded memory allocations. Validate early in get\_pipe() and return
failure.
Reported-by: Secunia Research <vuln@secunia.com>
Cc: stable <stable@vger.kernel.org>
Signed-off-by: Shuah Khan <shuahkh@osg.samsung.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6688ef9f29762e65bce325ef4acd6c675806366) (limited to 'drivers/usb/usbip')

| -rw-r--r-- | [drivers/usb/usbip/stub\_rx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/usbip/stub_rx.c?id=c6688ef9f29762e65bce325ef4acd6c675806366) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 31 insertions, 4 deletions

| diff --git a/drivers/usb/usbip/stub\_rx.c b/drivers/usb/usbip/stub\_rx.cindex 4d61063c259dce..493ac2928391ac 100644--- a/[drivers/usb/usbip/stub\_rx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip/stub_rx.c?id=635f545a7e8be7596b9b2b6a43cab6bbd5a88e43)+++ b/[drivers/usb/usbip/stub\_rx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/usbip/stub_rx.c?id=c6688ef9f29762e65bce325ef4acd6c675806366)@@ -322,11 +322,13 @@ static struct stub\_priv \*stub\_priv\_alloc(struct stub\_device \*sdev, return priv; } -static int get\_pipe(struct stub\_device \*sdev, int epnum, int dir)+static int get\_pipe(struct stub\_device \*sdev, struct usbip\_header \*pdu) { struct usb\_device \*udev = sdev->udev; struct usb\_host\_endpoint \*ep; struct usb\_endpoint\_descriptor \*epd = NULL;+ int epnum = pdu->base.ep;+ int dir = pdu->base.direction;  if (epnum < 0 || epnum > 15) goto err\_ret;@@ -339,6 +341,15 @@ static int get\_pipe(struct stub\_device \*sdev, int epnum, int dir) goto err\_ret;  epd = &ep->desc;++ /\* validate transfer\_buffer\_length \*/+ if (pdu->u.cmd\_submit.transfer\_buffer\_length > INT\_MAX) {+ dev\_err(&sdev->udev->dev,+ "CMD\_SUBMIT: -EMSGSIZE transfer\_buffer\_length %d\n",+ pdu->u.cmd\_submit.transfer\_buffer\_length);+ return -1;+ }+ if (usb\_endpoint\_xfer\_control(epd)) { if (dir == USBIP\_DIR\_OUT) return usb\_sndctrlpipe(udev, epnum);@@ -361,6 +372,21 @@ static int get\_pipe(struct stub\_device \*sdev, int epnum, int dir) }  if (usb\_endpoint\_xfer\_isoc(epd)) {+ /\* validate packet size and number of packets \*/+ unsigned int maxp, packets, bytes;++ maxp = usb\_endpoint\_maxp(epd);+ maxp \*= usb\_endpoint\_maxp\_mult(epd);+ bytes = pdu->u.cmd\_submit.transfer\_buffer\_length;+ packets = DIV\_ROUND\_UP(bytes, maxp);++ if (pdu->u.cmd\_submit.number\_of\_packets < 0 ||+ pdu->u.cmd\_submit.number\_of\_packets > packets) {+ dev\_err(&sdev->udev->dev,+ "CMD\_SUBMIT: isoc invalid num packets %d\n",+ pdu->u.cmd\_submit.number\_of\_packets);+ return -1;+ } if (dir == USBIP\_DIR\_OUT) return usb\_sndisocpipe(udev, epnum); else@@ -369,7 +395,7 @@ static int get\_pipe(struct stub\_device \*sdev, int epnum, int dir)  err\_ret: /\* NOT REACHED \*/- dev\_err(&sdev->udev->dev, "get pipe() invalid epnum %d\n", epnum);+ dev\_err(&sdev->udev->dev, "CMD\_SUBMIT: invalid epnum %d\n", epnum); return -1; } @@ -434,7 +460,7 @@ static void stub\_recv\_cmd\_submit(struct stub\_device \*sdev, struct stub\_priv \*priv; struct usbip\_device \*ud = &sdev->ud; struct usb\_device \*udev = sdev->udev;- int pipe = get\_pipe(sdev, pdu->base.ep, pdu->base.direction);+ int pipe = get\_pipe(sdev, pdu);  if (pipe == -1) return;@@ -456,7 +482,8 @@ static void stub\_recv\_cmd\_submit(struct stub\_device \*sdev, }  /\* allocate urb transfer buffer, if needed \*/- if (pdu->u.cmd\_submit.transfer\_buffer\_length > 0) {+ if (pdu->u.cmd\_submit.transfer\_buffer\_length > 0 &&+ pdu->u.cmd\_submit.transfer\_buffer\_length <= INT\_MAX) { priv->urb->transfer\_buffer = kzalloc(pdu->u.cmd\_submit.transfer\_buffer\_length, GFP\_KERNEL); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 18:15:22 +0000



=== Content from secuniaresearch.flexerasoftware.com_1e6fc486_20250125_181646.html ===


[Skip to main content](#main-content)
[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

[![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

Search

## Main navigation

* Solutions
  + Column 1
    - Business challenge
      * [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
      * [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
      * [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
      * [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
      * [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
      * [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
      * [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
      * [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
      * [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
      * [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
      * [Public sector](https://www.flexera.com/solutions/public-sector)
  + Column 2
    - Spend management by vendor
      * [IBM](https://www.flexera.com/solutions/vendor/ibm)
      * [Oracle](https://www.flexera.com/solutions/vendor/oracle)
      * [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
      * [SAP](https://www.flexera.com/solutions/vendor/sap)
      * [VMware](https://www.flexera.com/solutions/vendor/vmware)
      * [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
      * [AWS](https://www.flexera.com/solutions/vendor/aws)
      * [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
      * [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
      * [Adobe](https://www.flexera.com/solutions/vendor/adobe)

  ### Achieve more through a united FinOps and ITAM function

  The future is hybrid. Break down the walls between ITAM and FinOps to drive more revenue, more customer growth and more innovation.

  [Discover More](https://www.flexera.com/resources/hybrid-itam-finops)
* Products
  + Column 1
    - [Flexera One](https://www.flexera.com/products/flexera-one)
      * [IT Visibility](https://www.flexera.com/products/flexera-one/it-visibility)
      * [ITAM](https://www.flexera.com/products/flexera-one/it-asset-management)
      * [SaaS Management](https://www.flexera.com/products/flexera-one/saas-management)
      * [FinOps](https://www.flexera.com/products/flexera-one/finops)
      * [Technology Intelligence Platform](https://www.flexera.com/products/flexera-one/technology-intelligence-platform)
  + Column 2
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
      * [Snow Spend Optimizer](https://www.flexera.com/products/snow-atlas/snow-spend-optimizer)
      * [Snow SaaS Management](https://www.flexera.com/products/snow-atlas/snow-saas-management)
  + Column 3
    - Hide group
      * [Security](https://www.flexera.com/products/security)
      * [Application Readiness](https://www.flexera.com/products/adminstudio)
      * [All products](https://www.flexera.com/products)
      * [All Snow products](https://www.flexera.com/products/snow)
      * [Integrations](https://www.flexera.com/products/integrations)

  ### Flexera 2024 State of the Cloud Report

  What do transformative initiatives such as GenAI, machine learning and sustainability mean for the cloud? Check out the 2024 State of the Cloud Report to find the answer as well as all the latest cloud computing trends.

  [View Report](https://info.flexera.com/CM-REPORT-State-of-the-Cloud)
* Success
  + Column 1
    - [Customer success](https://www.flexera.com/customer-success)
      * Support
        + [Flexera support portal](https://community.flexera.com/s/support-hub)
        + [Flexera product documentation](https://docs.flexera.com)
        + [Snow product documentation](https://docs.snowsoftware.io/)
      * Services and training
        + [Services](https://www.flexera.com/customer-success/services)
        + [Training](https://www.flexera.com/customer-success/training)
  + Column 2
    - Hide group
      * [Technology Intelligence Awards](https://www.flexera.com/customer-success/awards)
      * [Flexera community](https://community.flexera.com/s/)

  ### Insights from Gartner®

  Find a curated series of actionable and objective insights for IT executives and their teams. Get expert insights from valued analysts, courtesy of Flexera.

  [Discover More](https://www.flexera.com/resources/gartner-analyst-research)
* Resources
  + Column 1
    - [Resources](https://www.flexera.com/resources)
      * [Webinars](https://www.flexera.com/resources?type%5Bwebinar%5D=webinar)
      * [Videos](https://www.flexera.com/resources?type%5Bvideo%5D=video)
      * [Datasheets](https://www.flexera.com/resources?type%5Bdatasheet%5D=datasheet)
      * [White papers & reports](https://www.flexera.com/resources?type%5Bwhite-paper-industry-report%5D=white-paper-industry-report)
  + Column 2
    - Hide group
      * [Blog](/blog/)
      * [Case studies](https://www.flexera.com/resources/case-studies)
      * [Events](https://www.flexera.com/resources?type%5Bevent%5D=event)
      * [Analyst Research](https://www.flexera.com/resources/gartner-analyst-research)
      * [Glossary](https://www.flexera.com/resources/glossary)
      * [Demos & trials](https://www.flexera.com/resources?type%5Bdemo-trials%5D=demo-trials)
      * [Business value calculator](https://www.flexera.com/resources/business-value-calculator)

  ### Flexera 2025 IT Priorities Report

  Insights from Flexera’s 2025 IT Priorities Report highlight what’s top of mind for IT decision makers in the year ahead. Discover the challenges, priorities and opportunities that will shape the future IT landscape.

  [View Report](https://info.flexera.com/ITV-REPORT-IT-Priorities)
* About
  + Column 1
    - [Company](https://www.flexera.com/about-us)
      * [About](https://www.flexera.com/about-us)
      * [Careers](https://www.flexera.com/about-us/careers)
      * [Contact](https://www.flexera.com/about-us/contact-us)
      * [Leadership](https://www.flexera.com/about-us/leadership)
    - [Partners](https://www.flexera.com/about-us/partners)
      * [Partner program](https://www.flexera.com/about-us/partners/partner-program)
      * [Partner directory](https://www.flexera.com/about-us/partners/directory)
  + Column 2
    - [Press center](https://www.flexera.com/about-us/press-center)
      * [Press releases](https://www.flexera.com/about-us/all-press-releases)
      * [Awards](https://www.flexera.com/about-us/press-center#awards)
      * [Articles](https://www.flexera.com/about-us/all-articles)
    - Hide group
      * Social responsibility
        + [ESG](https://www.flexera.com/about-us/environmental-social-governance)
        + [Diversity](https://www.flexera.com/about-us/diversity)

  ### More value with technology intelligence

  The unparalleled synergy of Flexera and Snow provides the Technology Intelligence you need for more efficiency, insight and governance than ever before.

  [Discover More](https://www.flexera.com/more-value-with-technology-intelligence)

Search

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

## External Links

* External Links
  + [Community](https://community.flexera.com/)
  + [Product Access](https://app.flexera.com/login)
  + [Partner Portal](https://flexera.channeltivity.com/Login)

[Book a demo](/about-us/contact-us?C_Interest1=sales)

# Secunia Research

## The world’s best vulnerability intelligence

The Secunia Research team from Flexera provides the most accurate and reliable source of vulnerability intelligence.

[Contact Us](https://www.flexera.com/about-us/contact-us?C_Interest1=sales&C_SolutionInterest=SVM)
Watch video (0:29)

Related links

* [Anatomy of a security advisory](https://www.flexera.com/resources/infographics/anatomy-of-a-security-advisory)
* [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)
* [Software Vulnerability Manager](/products/software-vulnerability-manager)
* [Security advisories from Secunia Research](https://www.flexera.com/products/security/software-vulnerability-advisories)
* [Report a vulnerability](https://www.flexera.com/about-us/contact-us/report-vulnerability)

 ![Secunia Research](/sites/default/files/2022-04/hero-secunia-research-bg.jpg)

Featured Details

## Multiple ways to consume Secunia Research

Secunia delivers software security research that provides reliable, curated and actionable vulnerability intelligence. Organizations can expect to receive standardized, validated and enriched vulnerability research on a specific version of a software product. Secunia Research supports four solutions:

![Software Vulnerability Research](/sites/default/files/2022-04/icon-secunia-research-svr.svg)

### [Software Vulnerability Research](https://www.flexera.com/products/software-vulnerability-research)

Software Vulnerability Research utilizes Secunia Research to drive awareness of vulnerabilities matching your specified criteria

[Learn More](https://www.flexera.com/products/software-vulnerability-research)

![Software Vulnerability Manager](/sites/default/files/2022-04/icon-secunia-research-svm.svg)

### [Software Vulnerability Manager](/products/software-vulnerability-manager)

Software Vulnerability Manager uses Secunia Research data to identify, prioritize and patch known vulnerable software detected in your environment

[Learn More](/products/software-vulnerability-manager)

![Data Platform](/sites/default/files/2022-04/icon-secunia-research-dp.svg)

### [Data Platform](https://www.flexera.com/products/data-platform)

Data Platform leverages Secunia Research to provide high-level insights based on major or minor versions of software in your normalized inventory

[Learn More](https://www.flexera.com/products/data-platform)

![Flexera One](/sites/default/files/2022-04/icon-secunia-research-flexera-one.svg)

### [Flexera One](/flexera-one)

Flexera One utilizes Secunia Research (alongside public NVD data) to provide more granular matching of build-level versions of software in your normalized inventory within its IT Asset Management and IT Visibility solutions

[Learn More](/flexera-one)

How it works

## Accurate, reliable vulnerability insights at your fingertips

The Secunia Research team from Flexera is comprised of several security specialists who conduct vulnerability research in various products in addition to testing, verifying and validating public vulnerability reports. Since its inception in 2002, the goal of the Secunia Research team is to provide the most accurate and reliable source of vulnerability intelligence.

Delivering the world’s best vulnerability intelligence requires skill and passion. Team members continually develop their skills exploring various high-profile closed and open-source software using a variety of approaches, focusing chiefly on thorough code audits and binary analysis. The team has received industry recognition, including naming members to [Microsoft’s Most Valuable Security Researchers](https://msrc-blog.microsoft.com/2019/08/07/announcing-2019-msrc-most-valuable-security-researchers/) list.

Secunia researchers discover hard-to-find vulnerabilities that aren’t normally identified with techniques such as fuzzing, and the results have been impressive. Members of the Secunia Research team have discovered critical vulnerabilities in products from vendors including Microsoft, Symantec, IBM, Adobe, RealNetworks, Trend Micro, HP, Blue Coat, Samba, CA, Mozilla and Apple.

The team produces invaluable security advisories based on research of the vulnerabilities affecting any given software update. Sometimes a single update can address multiple vulnerabilities of varying criticalities and threats; but these advisories aggregate and distill findings down to a single advisory perfect for the prioritization of patching efforts within [Software Vulnerability Manager](/products/software-vulnerability-manager). Criticality scores are consistently applied along with details around attack vector and other valuable details within [Software Vulnerability Research](/products/software-vulnerability-research/secunia-research). Illegitimate vulnerability reports are also investigated and rejected so you can focus only on what truly matters.

Informing IT, Transforming IT

## Industry insights to help keep you informed

[#### Webinar

### Stay Ahead of Cyber Threats: Flexera's Latest Vulnerability Insights

Join us for this session where we'll explore the latest findings from the Flexera Monthly Vulnerability Insights Report.](https://info.flexera.com/SVM-WBNR-Vulnerability-Insights-Roundtable)

[#### Webinar

### Dive deeper into the Flexera Annual Vulnerability Insights

We'll explore the key findings from the Flexera Annual Vulnerability Insights Report. Learn about the latest cybersecurity trends, the most targeted industries, the types of vulnerabilities, plus management and mitigation strategies.](https://info.flexera.com/SVM-WBNR-Flexera-Annual-Vulnerability-Insights?lead_source=Website%20Visitor&id=Flexera.com-Resources)

#### Video

### Close the Risk Window with Software Vulnerability Manager

Stop reacting. Gain control. Stay secure. Build a more effective risk mitigation process leveraging Secunia Research vulnerability intelligence and the largest repository of third-party patch data in the industry.

Remote video URL

[#### Trial

### Software Vulnerability Manager Assessment free trial

Get access to the complete set of modules of Software Vulnerability Manager: Research, Assessment and Patching](https://info.flexera.com/SVM-EVAL-Software-Vulnerability-Manager)

[#### Datasheet

### Protect your ServiceNow® investment with the highest quality data

IT Visibility offers certified ServiceNow integrations that accelerate platform expansion, improve ROI and increase efficiencies across ITIL processes by delivering clean software and hardware asset data directly.](/sites/default/files/datasheet-itv-maximize-servicenow-investment.pdf)

[#### Blog

### Avoid missing crucial vulnerability intelligence amid NVD backlog

Recent developments regarding the National Vulnerability Database (NVD) have some technology leaders on edge. Since February, the U.S. National Institute of Standards and Technology (NIST) has almost completely stopped enriching software vulnerabi...](https://www.flexera.com/blog/vulnerability-management/avoid-missing-crucial-vulnerability-intelligence-amid-nvd-backlog/)

[View all resources](https://www.flexera.com/resources?category%5Bsoftware-vulnerability-management%5D=software-vulnerability-management)

## Footer Menu

* Column
  + Business challenge
    - [Software renewals and audits](https://www.flexera.com/solutions/software-renewals-audits)
    - [Software license management and optimization](https://www.flexera.com/solutions/software-usage-costs)
    - [SaaS spend management](https://www.flexera.com/solutions/saas-spend)
    - [Cloud cost management](https://www.flexera.com/solutions/cloud-cost)
    - [IT asset lifecycle management](https://www.flexera.com/solutions/it-asset-lifecycle)
    - [CMDB data quality](https://www.flexera.com/solutions/cmdb-data-quality)
    - [Accurate IT inventory](https://www.flexera.com/solutions/it-inventory)
    - [Security and regulatory risk management](https://www.flexera.com/solutions/it-security-regulatory-risk)
    - [Sustainable IT](https://www.flexera.com/solutions/sustainable-it)
    - [AI-powered transformation](https://www.flexera.com/solutions/ai-powered-transformation)
    - [Public sector](https://www.flexera.com/solutions/public-sector)
* Column
  + Spend management by vendor
    - [IBM](https://www.flexera.com/solutions/vendor/ibm)
    - [Oracle](https://www.flexera.com/solutions/vendor/oracle)
    - [Microsoft](https://www.flexera.com/solutions/vendor/microsoft)
    - [SAP](https://www.flexera.com/solutions/vendor/sap)
    - [VMware](https://www.flexera.com/solutions/vendor/vmware)
    - [ServiceNow](https://www.flexera.com/solutions/vendor/servicenow)
    - [AWS](https://www.flexera.com/solutions/vendor/aws)
    - [Salesforce](https://www.flexera.com/solutions/vendor/salesforce)
    - [BMC](https://www.flexera.com/solutions/cmdb-data-quality/bmc)
    - [Adobe](https://www.flexera.com/solutions/vendor/adobe)
* Column
  + Products
    - [Flexera One](https://www.flexera.com/products/flexera-one)
    - [Snow Atlas](https://www.flexera.com/products/snow-atlas)
    - [Security](https://www.flexera.com/products/security)
    - [Application Readiness](https://www.flexera.com/products/adminstudio)
    - [All products](https://www.flexera.com/products)
    - [All Snow products](https://www.flexera.com/products/snow)
    - [Integrations](https://www.flexera.com/products/integrations)
* Column
  + Company
    - [About](https://www.flexera.com/about-us)
    - [Careers](https://www.flexera.com/about-us/careers)
    - [Leadership](https://www.flexera.com/about-us/leadership)
    - [Contact us](https://www.flexera.com/about-us/contact-us)
    - [Media / press center](https://www.flexera.com/about-us/press-center)
    - [Revenera.com](https://www.revenera.com)

 +1.800.374.4353

en

* [English](https://www.flexera.com/products/security/software-vulnerability-research/secunia-research?referrer=secunia)
* [Deutsch](https://www.flexera.de/products/security/software-vulnerability-research/secunia-research?referrer=secunia)

 [![Home](/themes/custom/flexera/images/logo.svg)](https://www.flexera.com/)

© 2025 Flexera. All Rights Reserved.

## Footer

* [Privacy Policy](https://www.flexera.com/legal/privacy-policy)
* [Terms and conditions](https://www.flexera.com/legal)
* [Contact Us](https://www.flexera.com/about-us/contact-us)
* [Impressum](https://www.flexera.com/about-us/impressum)
* [Site Map](https://www.flexera.com/sitemap)

#####

×

...



=== Content from www.debian.org_336c76e4_20250125_181651.html ===


---

[[Date Prev](msg00114.html)][[Date Next](msg00116.html)]
[[Thread Prev](msg00114.html)][[Thread Next](msg00116.html)]
[[Date Index](maillist.html#00115)]
[[Thread Index](threads.html#00115)]

# [SECURITY] [DSA 4187-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4187-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Tue, 01 May 2018 17:12:02 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1fDYos-0003QT-4F%40seger.debian.org) [E1fDYos-0003QT-4F@seger.debian.org](msg00115.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4187-1                   security@debian.org
<https://www.debian.org/security/>                            Ben Hutchings
May 01, 2018                          <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2015-9016 CVE-2017-0861 CVE-2017-5715 CVE-2017-5753
                 CVE-2017-13166 CVE-2017-13220 CVE-2017-16526 CVE-2017-16911
                 CVE-2017-16912 CVE-2017-16913 CVE-2017-16914 CVE-2017-18017
                 CVE-2017-18203 CVE-2017-18216 CVE-2017-18232 CVE-2017-18241
                 CVE-2018-1066 CVE-2018-1068 CVE-2018-1092 CVE-2018-5332
                 CVE-2018-5333 CVE-2018-5750 CVE-2018-5803 CVE-2018-6927
                 CVE-2018-7492 CVE-2018-7566 CVE-2018-7740 CVE-2018-7757
                 CVE-2018-7995 CVE-2018-8781 CVE-2018-8822 CVE-2018-1000004
                 CVE-2018-1000199

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2015-9016

    Ming Lei reported a race condition in the multiqueue block layer
    (blk-mq).  On a system with a driver using blk-mq (mtip32xx,
    null_blk, or virtio_blk), a local user might be able to use this
    for denial of service or possibly for privilege escalation.

CVE-2017-0861

    Robb Glasser reported a potential use-after-free in the ALSA (sound)
    PCM core.  We believe this was not possible in practice.

CVE-2017-5715

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 2 (branch
    target injection) and is mitigated for the x86 architecture (amd64
    and i386) by using the "retpoline" compiler feature which allows
    indirect branches to be isolated from speculative execution.

CVE-2017-5753

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 1
    (bounds-check bypass) and is mitigated by identifying vulnerable
    code sections (array bounds checking followed by array access) and
    replacing the array access with the speculation-safe
    array_index_nospec() function.

    More use sites will be added over time.

CVE-2017-13166

    A bug in the 32-bit compatibility layer of the v4l2 ioctl handling
    code has been found. Memory protections ensuring user-provided
    buffers always point to userland memory were disabled, allowing
    destination addresses to be in kernel space. On a 64-bit kernel a
    local user with access to a suitable video device can exploit this
    to overwrite kernel memory, leading to privilege escalation.

CVE-2017-13220

    Al Viro reported that the Bluetooth HIDP implementation could
    dereference a pointer before performing the necessary type check.
    A local user could use this to cause a denial of service.

CVE-2017-16526

    Andrey Konovalov reported that the UWB subsystem may dereference
    an invalid pointer in an error case.  A local user might be able
    to use this for denial of service.

CVE-2017-16911

    Secunia Research reported that the USB/IP vhci_hcd driver exposed
    kernel heap addresses to local users.  This information could aid the
    exploitation of other vulnerabilities.

CVE-2017-16912

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to an out-of-bounds read.  A remote user able to connect to the
    USB/IP server could use this for denial of service.

CVE-2017-16913

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to excessive memory allocation.  A remote user able to connect to
    the USB/IP server could use this for denial of service.

CVE-2017-16914

    Secunia Research reported that the USB/IP stub driver failed to
    check for an invalid combination of fields in a received packet,
    leading to a null pointer dereference.  A remote user able to
    connect to the USB/IP server could use this for denial of service.

CVE-2017-18017

    Denys Fedoryshchenko reported that the netfilter xt_TCPMSS module
    failed to validate TCP header lengths, potentially leading to a
    use-after-free.  If this module is loaded, it could be used by a
    remote attacker for denial of service or possibly for code
    execution.

CVE-2017-18203

    Hou Tao reported that there was a race condition in creation and
    deletion of device-mapper (DM) devices.  A local user could
    potentially use this for denial of service.

CVE-2017-18216

    Alex Chen reported that the OCFS2 filesystem failed to hold a
    necessary lock during nodemanager sysfs file operations,
    potentially leading to a null pointer dereference.  A local user
    could use this for denial of service.

CVE-2017-18232

    Jason Yan reported a race condition in the SAS (Serial-Attached
    SCSI) subsystem, between probing and destroying a port.  This
    could lead to a deadlock.  A physically present attacker could
    use this to cause a denial of service.

CVE-2017-18241

    Yunlei He reported that the f2fs implementation does not properly
    initialise its state if the "noflush_merge" mount option is used.
    A local user with access to a filesystem mounted with this option
    could use this to cause a denial of service.

CVE-2018-1066

    Dan Aloni reported to Red Hat that the CIFS client implementation
    would dereference a null pointer if the server sent an invalid
    response during NTLMSSP setup negotiation.  This could be used
    by a malicious server for denial of service.

CVE-2018-1068

    The syzkaller tool found that the 32-bit compatibility layer of
    ebtables did not sufficiently validate offset values. On a 64-bit
    kernel, a local user with the CAP_NET_ADMIN capability (in any user
    namespace) could use this to overwrite kernel memory, possibly
    leading to privilege escalation. Debian disables unprivileged user
    namespaces by default.

CVE-2018-1092

    Wen Xu reported that a crafted ext4 filesystem image would
    trigger a null dereference when mounted.  A local user able
    to mount arbitrary filesystems could use this for denial of
    service.

CVE-2018-5332

    Mohamed Ghannam reported that the RDS protocol did not
    sufficiently validate RDMA requests, leading to an out-of-bounds
    write.  A local attacker on a system with the rds module loaded
    could use this for denial of service or possibly for privilege
    escalation.

CVE-2018-5333

    Mohamed Ghannam reported that the RDS protocol did not properly
    handle an error case, leading to a null pointer dereference.  A
    local attacker on a system with the rds module loaded could
    possibly use this for denial of service.

CVE-2018-5750

    Wang Qize reported that the ACPI sbshc driver logged a kernel heap
    address.  This information could aid the exploitation of other
    vulnerabilities.

CVE-2018-5803

    Alexey Kodanev reported that the SCTP protocol did not range-check
    the length of chunks to be created.  A local or remote user could
    use this to cause a denial of service.

CVE-2018-6927

    Li Jinyue reported that the FUTEX_REQUEUE operation on futexes did
    not check for negative parameter values, which might lead to a
    denial of service or other security impact.

CVE-2018-7492

    The syzkaller tool found that the RDS protocol was lacking a null
    pointer check.  A local attacker on a system with the rds module
    loaded could use this for denial of service.

CVE-2018-7566

    Fan LongFei reported a race condition in the ALSA (sound)
    sequencer core, between write and ioctl operations.  This could
    lead to an out-of-bounds access or use-after-free.  A local user
    with access to a sequencer device could use this for denial of
    service or possibly for privilege escalation.

CVE-2018-7740

    Nic Losby reported that the hugetlbfs filesystem's mmap operation
    did not properly range-check the file offset.  A local user with
    access to files on a hugetlbfs filesystem could use this to cause
    a denial of service.

CVE-2018-7757

    Jason Yan reported a memory leak in the SAS (Serial-Attached
    SCSI) subsystem.  A local user on a system with SAS devices
    could use this to cause a denial of service.

CVE-2018-7995

    Seunghun Han reported a race condition in the x86 MCE
    (Machine Check Exception) driver.  This is unlikely to have
    any security impact.

CVE-2018-8781

    Eyal Itkin reported that the udl (DisplayLink) driver's mmap
    operation did not properly range-check the file offset.  A local
    user with access to a udl framebuffer device could exploit this to
    overwrite kernel memory, leading to privilege escalation.

CVE-2018-8822

    Dr Silvio Cesare of InfoSect reported that the ncpfs client
    implementation did not validate reply lengths from the server.  An
    ncpfs server could use this to cause a denial of service or
    remote code execution in the client.

CVE-2018-1000004

    Luo Quan reported a race condition in the ALSA (sound) sequencer
    core, between multiple ioctl operations.  This could lead to a
    deadlock or use-after-free.  A local user with access to a
    sequencer device could use this for denial of service or possibly
    for privilege escalation.

CVE-2018-1000199

    Andy Lutomirski discovered that the ptrace subsystem did not
    sufficiently validate hardware breakpoint settings.  Local users
    can use this to cause a denial of service, or possibly for
    privilege escalation, on x86 (amd64 and i386) and possibly other
    architectures.

For the oldstable distribution (jessie), these problems have been fixed
in version 3.16.56-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to its security
tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAlron61fFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0Rtqw//Xf/L4bP65wU9M59Ef6xBt+Eph+yxeMsioGhu80ODdMemlmHzASMtfZjY
AXxyt9l8lbHn8MmwDA4aLhhwHYXwvKATdpHSy1SILrRfb4s9P9uV1vsHaIeZ649E
hDyNon9hP2tPso6BwqiYHZZy9Xxtd+T8vTBeBZwUKOLBkBRvV/gyNSUdJWp6L8WH
aF4D1hHl9ZotDkyIvkubbx77aqbJ88I4R0n69x7L9udFbuXa+U7hV6dJdnpzyl/7
OukJfEtnkaUgWu0MdOfFss6iH5OQISn/y/ricRi29oKQiEp3YwnT5J9pFwSQeJJS
H8ABVt251UoS0J+of3QWw0muOT/6UAF8SNpPKMJXC7Euq8pTmYVPSIeUYf4eqn65
UHZSCKXaszItq+uzVNYdkj504BJ4cG1lFxZtlrFWwKE8p7QOETN0GKvTRdu/SvDd
Hl2nb4HouLpBYS518Th2/MGgzhXXAuO12MH3smenptZbqxKn9Z0XSTJYzFupgJk/
kKF2xkDFBE4toTLVE+6XdUKwYk4vkeDZyOGOwRYThSkKAzrUh5zThgal4HnknD2A
5ye4XLhjgSIT47/nmor6lhxd7WGXGkV33GF0azYlHr/sclfzxcU2Ev3NUBWQ8M3s
CxfIO0FNCzO0WIUf40md7MlIAnDBIRGyYgNIIe7AnSRKKPykEx8=
=wNQS
-----END PGP SIGNATURE-----

```

---



=== Content from lists.debian.org_4cb0aa4a_20250125_181644.html ===


---

[Date Prev][[Date Next](msg00001.html)]
[Thread Prev][[Thread Next](msg00001.html)]
[[Date Index](maillist.html#00000)]
[[Thread Index](threads.html#00000)]

# [SECURITY] [DLA 1369-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 1369-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Wed, 02 May 2018 21:58:29 +0100
* *Message-id*: <[[🔎]](/msgid-search/b7523f224fe2386a0f6ce54b31b558cafa6b3a9a.camel%40debian.org) [b7523f224fe2386a0f6ce54b31b558cafa6b3a9a.camel@debian.org](msg00000.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux
Version        : 3.2.101-1
CVE ID         : CVE-2017-0861 CVE-2017-5715 CVE-2017-13166 CVE-2017-16526
                 CVE-2017-16911 CVE-2017-16912 CVE-2017-16913 CVE-2017-16914
                 CVE-2017-18017 CVE-2017-18203 CVE-2017-18216 CVE-2018-1068
                 CVE-2018-1092 CVE-2018-5332 CVE-2018-5333 CVE-2018-5750
                 CVE-2018-5803 CVE-2018-6927 CVE-2018-7492 CVE-2018-7566
                 CVE-2018-7740 CVE-2018-7757 CVE-2018-7995 CVE-2018-8781
                 CVE-2018-8822 CVE-2018-1000004 CVE-2018-1000199
Debian Bug     : 887106

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2017-0861

    Robb Glasser reported a potential use-after-free in the ALSA (sound)
    PCM core.  We believe this was not possible in practice.

CVE-2017-5715

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 2 (branch
    target injection) and is mitigated for the x86 architecture (amd64
    and i386) by using the "retpoline" compiler feature which allows
    indirect branches to be isolated from speculative execution.

CVE-2017-13166

    A bug in the 32-bit compatibility layer of the v4l2 ioctl handling
    code has been found.  Memory protections ensuring user-provided
    buffers always point to userland memory were disabled, allowing
    destination addresses to be in kernel space.  On a 64-bit kernel
    (amd64 flavour) a local user with access to a suitable video
    device can exploit this to overwrite kernel memory, leading to
    privilege escalation.

CVE-2017-16526

    Andrey Konovalov reported that the UWB subsystem may dereference
    an invalid pointer in an error case.  A local user might be able
    to use this for denial of service.

CVE-2017-16911

    Secunia Research reported that the USB/IP vhci_hcd driver exposed
    kernel heap addresses to local users.  This information could aid the
    exploitation of other vulnerabilities.

CVE-2017-16912

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to an out-of-bounds read.  A remote user able to connect to the
    USB/IP server could use this for denial of service.

CVE-2017-16913

    Secunia Research reported that the USB/IP stub driver failed to
    perform a range check on a received packet header field, leading
    to excessive memory allocation.  A remote user able to connect to
    the USB/IP server could use this for denial of service.

CVE-2017-16914

    Secunia Research reported that the USB/IP stub driver failed to
    check for an invalid combination of fields in a recieved packet,
    leading to a null pointer dereference.  A remote user able to
    connect to the USB/IP server could use this for denial of service.

CVE-2017-18017

    Denys Fedoryshchenko reported that the netfilter xt_TCPMSS module
    failed to validate TCP header lengths, potentially leading to a
    use-after-free.  If this module is loaded, it could be used by a
    remote attacker for denial of service or possibly for code
    execution.

CVE-2017-18203

    Hou Tao reported that there was a race condition in creation and
    deletion of device-mapper (DM) devices.  A local user could
    potentially use this for denial of service.

CVE-2017-18216

    Alex Chen reported that the OCFS2 filesystem failed to hold a
    necessary lock during nodemanager sysfs file operations,
    potentially leading to a null pointer dereference.  A local user
    could use this for denial of service.

CVE-2018-1068

    The syzkaller tool found that the 32-bit compatibility layer of
    ebtables did not sufficiently validate offset values.  On a 64-bit
    kernel (amd64 flavour), a local user with the CAP_NET_ADMIN
    capability could use this to overwrite kernel memory, possibly
    leading to privilege escalation.

CVE-2018-1092

    Wen Xu reported that a crafted ext4 filesystem image would
    trigger a null dereference when mounted.  A local user able
    to mount arbitrary filesystems could use this for denial of
    service.

CVE-2018-5332

    Mohamed Ghannam reported that the RDS protocol did not
    sufficiently validate RDMA requests, leading to an out-of-bounds
    write.  A local attacker on a system with the rds module loaded
    could use this for denial of service or possibly for privilege
    escalation.

CVE-2018-5333

    Mohamed Ghannam reported that the RDS protocol did not properly
    handle an error case, leading to a null pointer dereference.  A
    local attacker on a system with the rds module loaded could
    possibly use this for denial of service.

CVE-2018-5750

    Wang Qize reported that the ACPI sbshc driver logged a kernel heap
    address.  This information could aid the exploitation of other
    vulnerabilities.

CVE-2018-5803

    Alexey Kodanev reported that the SCTP protocol did not range-check
    the length of chunks to be created.  A local or remote user could
    use this to cause a denial of service.

CVE-2018-6927

    Li Jinyue reported that the FUTEX_REQUEUE operation on futexes did
    not check for negative parameter values, which might lead to a
    denial of service or other security impact.

CVE-2018-7492

    The syzkaller tool found that the RDS protocol was lacking a null
    pointer check.  A local attacker on a system with the rds module
    loaded could use this for denial of service.

CVE-2018-7566

    范龙飞 (Fan LongFei) reported a race condition in the ALSA (sound)
    sequencer core, between write and ioctl operations.  This could
    lead to an out-of-bounds access or use-after-free.  A local user
    with access to a sequencer device could use this for denial of
    service or possibly for privilege escalation.

CVE-2018-7740

    Nic Losby reported that the hugetlbfs filesystem's mmap operation
    did not properly range-check the file offset.  A local user with
    access to files on a hugetlbfs filesystem could use this to cause
    a denial of service.

CVE-2018-7757

    Jason Yan reported a memory leak in the SAS (Serial-Attached
    SCSI) subsystem.  A local user on a system with SAS devices
    could use this to cause a denial of service.

CVE-2018-7995

    Seunghun Han reported a race condition in the x86 MCE
    (Machine Check Exception) driver.  This is unlikely to have
    any security impact.

CVE-2018-8781

    Eyal Itkin reported that the udl (DisplayLink) driver's mmap
    operation did not properly range-check the file offset.  A local
    user with access to a udl framebuffer device could exploit this to
    overwrite kernel memory, leading to privilege escalation.

CVE-2018-8822

    Dr Silvio Cesare of InfoSect reported that the ncpfs client
    implementation did not validate reply lengths from the server.  An
    ncpfs server could use this to cause a denial of service or
    remote code execution in the client.

CVE-2018-1000004

    Luo Quan reported a race condition in the ALSA (sound) sequencer
    core, between multiple ioctl operations.  This could lead to a
    deadlock or use-after-free.  A local user with access to a
    sequencer device could use this for denial of service or possibly
    for privilege escalation.

CVE-2018-1000199

    Andy Lutomirski discovered that the ptrace subsystem did not
    sufficiently validate hardware breakpoint settings.  Local users
    can use this to cause a denial of service, or possibly for
    privilege escalation, on x86 (amd64 and i386) and possibly other
    architectures.

Additionally, some mitigations for CVE-2017-5753 are included in this
release:

CVE-2017-5753

    Multiple researchers have discovered a vulnerability in various
    processors supporting speculative execution, enabling an attacker
    controlling an unprivileged process to read memory from arbitrary
    addresses, including from the kernel and all other processes
    running on the system.

    This specific attack has been named Spectre variant 1
    (bounds-check bypass) and is mitigated by identifying vulnerable
    code sections (array bounds checking followed by array access) and
    replacing the array access with the speculation-safe
    array_index_nospec() function.

    More use sites will be added over time.

For Debian 7 "Wheezy", these problems have been fixed in version
3.2.101-1.  This version also includes bug fixes from upstream versions
up to and including 3.2.101.  It also fixes a regression in the
procfs hidepid option in the previous version (Debian bug #887106).

We recommend that you upgrade your linux packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams
```

**Attachment:
[signature.asc](pgpQ_Lyjwu10v.pgp)**

*Description:* This is a digitally signed message part

---


