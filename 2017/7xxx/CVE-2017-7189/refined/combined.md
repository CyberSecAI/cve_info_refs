=== Content from github.com_9740eeee_20250126_060117.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fad)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fad)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

![@ad](https://avatars.githubusercontent.com/u/35623?s=64&v=4)

**ad**
[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fad)

[Overview](/ad)
[Repositories
72](/ad?tab=repositories)
[Projects
0](/ad?tab=projects)
[Packages
1](/ad?tab=packages)
[Stars
1.1k](/ad?tab=stars)

More

* [Overview](/ad)
* [Repositories](/ad?tab=repositories)
* [Projects](/ad?tab=projects)
* [Packages](/ad?tab=packages)
* [Stars](/ad?tab=stars)

![@ad](https://avatars.githubusercontent.com/u/35623?s=64&v=4)

**ad**

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fad)

[![View ad's full-sized avatar](https://avatars.githubusercontent.com/u/35623?v=4)](https://avatars.githubusercontent.com/u/35623?v=4)
üíé

danielapatin.ton

# Daniel Apatin ad

üíé

danielapatin.ton

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fad)

[44
followers](https://github.com/ad?tab=followers) ¬∑ [23
following](https://github.com/ad?tab=following)

* Russia, Saint-Petersburg
* <https://blog.apatin.ru>

## [Achievements](/ad?tab=achievements)

[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)x3](/ad?achievement=pull-shark&tab=achievements)[![Achievement: YOLO](https://github.githubassets.com/assets/yolo-default-be0bbff04951.png)](/ad?achievement=yolo&tab=achievements)[![Achievement: Quickdraw](https://github.githubassets.com/assets/quickdraw-default--light-8f798b35341a.png)](/ad?achievement=quickdraw&tab=achievements)[![Achievement: Starstruck](https://github.githubassets.com/assets/starstruck-default--light-a594e2a027e0.png)x2](/ad?achievement=starstruck&tab=achievements)[![Achievement: Arctic Code Vault Contributor](https://github.githubassets.com/assets/arctic-code-vault-contributor-default-df8d74122a06.png)](/ad?achievement=arctic-code-vault-contributor&tab=achievements)
## [Achievements](/ad?tab=achievements)

[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)x3](/ad?achievement=pull-shark&tab=achievements)[![Achievement: YOLO](https://github.githubassets.com/assets/yolo-default-be0bbff04951.png)](/ad?achievement=yolo&tab=achievements)[![Achievement: Quickdraw](https://github.githubassets.com/assets/quickdraw-default--light-8f798b35341a.png)](/ad?achievement=quickdraw&tab=achievements)[![Achievement: Starstruck](https://github.githubassets.com/assets/starstruck-default--light-a594e2a027e0.png)x2](/ad?achievement=starstruck&tab=achievements)[![Achievement: Arctic Code Vault Contributor](https://github.githubassets.com/assets/arctic-code-vault-contributor-default-df8d74122a06.png)](/ad?achievement=arctic-code-vault-contributor&tab=achievements)

Block or Report

# Block or report ad

**Block user**

Prevent this user from interacting with your repositories and sending you notifications.
Learn more about [blocking users](https://docs.github.com/articles/blocking-a-user-from-your-personal-account).

You must be logged in to block users.

Add an optional note:

Please don't include any personal information such as legal names or email addresses. Maximum 100 characters, markdown supported. This note will be visible to only you.

Block user

**Report abuse**

Contact GitHub support about this user‚Äôs behavior.
Learn more about [reporting abuse](https://docs.github.com/articles/reporting-abuse-or-spam).

[Report abuse](/contact/report-abuse?report=ad+%28user%29)

[Overview](/ad)
[Repositories
72](/ad?tab=repositories)
[Projects
0](/ad?tab=projects)
[Packages
1](/ad?tab=packages)
[Stars
1.1k](/ad?tab=stars)

More

* [Overview](/ad)
* [Repositories](/ad?tab=repositories)
* [Projects](/ad?tab=projects)
* [Packages](/ad?tab=packages)
* [Stars](/ad?tab=stars)

[ad](/ad/ad)/README.md

[![alt README header](https://raw.githubusercontent.com/ad/ad/main/assets/header.png)](https://raw.githubusercontent.com/ad/ad/main/assets/header.png)

## Hi there üëã, l'm Daniel

I make elegantly professional **üíª distributed Systems, üì± iOS apps and üåê websites** and also **write some blogs**.

* üßê Interested in full stack. Recent focus on backend.
* üíº Senior Back End.
* üìö Reading more about IT.
* üíª With 20 years' development working experience and technology education.
* ‚õµ Encouraging people for open source collaborations.
* ‚úçüèª I write my personal thoughts on Programming & Tech in my [Personal Blog](https://blog.apatin.ru/).
* üå± Currently learning **Clickhouse**.
* ‚ù§Ô∏è Open Source Software.
* üêß Mac OS & Linux.
* üëØ I‚Äôm looking to collaborate on **Open Source**.
* üí¨ I'm mostly active within the **Golang** communities.

[![](https://camo.githubusercontent.com/9ef80cb4bf796ed81f2176dc9796a2cb40166390b890a5f84f69025250c62571/68747470733a2f2f6769746875622d726561646d652d73746174732e76657263656c2e6170702f6170693f757365726e616d653d616426686964653d636f6e7472696273)](https://camo.githubusercontent.com/9ef80cb4bf796ed81f2176dc9796a2cb40166390b890a5f84f69025250c62571/68747470733a2f2f6769746875622d726561646d652d73746174732e76657263656c2e6170702f6170693f757365726e616d653d616426686964653d636f6e7472696273)

[![Mac OS](https://camo.githubusercontent.com/72738f92a65f80c9d798910bcf3baaad95e09191ad043328111f903efe38ce30/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f532d6d61634f532d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d6170706c65266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/72738f92a65f80c9d798910bcf3baaad95e09191ad043328111f903efe38ce30/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f532d6d61634f532d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d6170706c65266c6f676f436f6c6f723d7768697465)
[![Linux](https://camo.githubusercontent.com/71e2e3aa5b3fe518f7f478d06db4298ddfc230a9464a48111d4c8d5047b370b0/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f532d4c696e75782d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d6c696e7578266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/71e2e3aa5b3fe518f7f478d06db4298ddfc230a9464a48111d4c8d5047b370b0/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f532d4c696e75782d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d6c696e7578266c6f676f436f6c6f723d7768697465)
[![Codium](https://camo.githubusercontent.com/81d6cb4cad33bc6441ad98d8ef8b19819e86b4ac48bf7cc099e1614ffea01ed0/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d5653253230436f64652d3030374143433f7374796c653d666c61742d737175617265266c6f676f3d76697375616c2d73747564696f2d636f6465)](https://camo.githubusercontent.com/81d6cb4cad33bc6441ad98d8ef8b19819e86b4ac48bf7cc099e1614ffea01ed0/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d5653253230436f64652d3030374143433f7374796c653d666c61742d737175617265266c6f676f3d76697375616c2d73747564696f2d636f6465)
[![Go](https://camo.githubusercontent.com/3148ce91929a0830c96f89f0cece195e74a004012d8130f92f2f29a6db2faffa/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d676f2d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d676f266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/3148ce91929a0830c96f89f0cece195e74a004012d8130f92f2f29a6db2faffa/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d676f2d696e666f726d6174696f6e616c3f7374796c653d666c61742d737175617265266c6f676f3d676f266c6f676f436f6c6f723d7768697465)
[![Github](https://camo.githubusercontent.com/4d9ac32e83b6a6b115b6f736f8817cb2a569f9c86bc76a6df23cbde1f9e0bc0a/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4769746875622d3138313731373f7374796c653d666c61742d737175617265266c6f676f3d476974487562266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/4d9ac32e83b6a6b115b6f736f8817cb2a569f9c86bc76a6df23cbde1f9e0bc0a/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4769746875622d3138313731373f7374796c653d666c61742d737175617265266c6f676f3d476974487562266c6f676f436f6c6f723d7768697465)
[![Git](https://camo.githubusercontent.com/a9db99147f7c5ea20e89d78496c1fb0018c8b3afcdd92d3123f8143cf546169c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4769742d4634344432373f7374796c653d666c61742d737175617265266c6f676f3d476974266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/a9db99147f7c5ea20e89d78496c1fb0018c8b3afcdd92d3123f8143cf546169c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4769742d4634344432373f7374796c653d666c61742d737175617265266c6f676f3d476974266c6f676f436f6c6f723d7768697465)
[![Slack](https://camo.githubusercontent.com/119d28cff11a510a5d13949caba0e14e4d9b7d1d56d454e6c6161e87ba90f7be/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d536c61636b2d4530313536333f7374796c653d666c61742d737175617265266c6f676f3d536c61636b266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/119d28cff11a510a5d13949caba0e14e4d9b7d1d56d454e6c6161e87ba90f7be/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d536c61636b2d4530313536333f7374796c653d666c61742d737175617265266c6f676f3d536c61636b266c6f676f436f6c6f723d7768697465)
[![Sketch](https://camo.githubusercontent.com/6b121a139272b7155a99d69c7ca26fa372560d61f8006fcb419b2a1192e0b7d2/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d536b657463682d4641363430303f7374796c653d666c61742d737175617265266c6f676f3d536b65746368266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/6b121a139272b7155a99d69c7ca26fa372560d61f8006fcb419b2a1192e0b7d2/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d536b657463682d4641363430303f7374796c653d666c61742d737175617265266c6f676f3d536b65746368266c6f676f436f6c6f723d7768697465)
[![WebPack](https://camo.githubusercontent.com/3f565f72ffb7d919ce89d65504a4dbcc97edefcb0d5d294d67717959dd3ebffd/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d5765625061636b2d3143373843303f7374796c653d666c61742d737175617265266c6f676f3d5765625061636b266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/3f565f72ffb7d919ce89d65504a4dbcc97edefcb0d5d294d67717959dd3ebffd/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d5765625061636b2d3143373843303f7374796c653d666c61742d737175617265266c6f676f3d5765625061636b266c6f676f436f6c6f723d7768697465)
[![Debian](https://camo.githubusercontent.com/0fbd1794709011dffc211a7925edcf7fda53b5798ee8983a19af364dd27175c9/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d44656269616e2d4138303033303f7374796c653d666c61742d737175617265266c6f676f3d44656269616e266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/0fbd1794709011dffc211a7925edcf7fda53b5798ee8983a19af364dd27175c9/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d44656269616e2d4138303033303f7374796c653d666c61742d737175617265266c6f676f3d44656269616e266c6f676f436f6c6f723d7768697465)
[![Redis](https://camo.githubusercontent.com/934fd82b41deaabbb198fd0deb177857fc602afb2c84a3bd0617bf9760f72c65/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d52656469732d626c61636b3f7374796c653d666c61742d737175617265266c6f676f3d5265646973)](https://camo.githubusercontent.com/934fd82b41deaabbb198fd0deb177857fc602afb2c84a3bd0617bf9760f72c65/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d52656469732d626c61636b3f7374796c653d666c61742d737175617265266c6f676f3d5265646973)
[![Memcache](https://camo.githubusercontent.com/2e31bcfb734ce280d4e51aa472794558987dae616959b68a0759c572b20ace1f/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4d656d63616368652d426c61636b3f7374796c653d666c61742d737175617265)](https://camo.githubusercontent.com/2e31bcfb734ce280d4e51aa472794558987dae616959b68a0759c572b20ace1f/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4d656d63616368652d426c61636b3f7374796c653d666c61742d737175617265)
[![ElasticSearch](https://camo.githubusercontent.com/917d33308537c3a15da182471b5865e05156df0e65ed68d698440b8c271c2f29/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d456c61737469635365617263682d3030353537313f7374796c653d666c61742d737175617265266c6f676f3d656c6173746963736561726368)](https://camo.githubusercontent.com/917d33308537c3a15da182471b5865e05156df0e65ed68d698440b8c271c2f29/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d456c61737469635365617263682d3030353537313f7374796c653d666c61742d737175617265266c6f676f3d656c6173746963736561726368)
[![Bash](https://camo.githubusercontent.com/55b6db513b02f41a85a437bfe53be2c71cadb32cb4f24b745c015b7302784637/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f426173682d3132313031312e7376673f6c6f676f3d676e752d62617368266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/55b6db513b02f41a85a437bfe53be2c71cadb32cb4f24b745c015b7302784637/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f426173682d3132313031312e7376673f6c6f676f3d676e752d62617368266c6f676f436f6c6f723d7768697465)
[![CSS](https://camo.githubusercontent.com/bfc16d4ca4ce30d08e55c0db6d978acda194c986b248807ce7463c6f5f46e6fb/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4353532d3135373242362e7376673f6c6f676f3d63737333266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/bfc16d4ca4ce30d08e55c0db6d978acda194c986b248807ce7463c6f5f46e6fb/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4353532d3135373242362e7376673f6c6f676f3d63737333266c6f676f436f6c6f723d7768697465)
[![HTML](https://camo.githubusercontent.com/d6efe8554e9d9e98ef68344b794a8aa5632e18c44e4b57cea490ac2ce0ba9471/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f48544d4c2d4533344632362e7376673f6c6f676f3d68746d6c35266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/d6efe8554e9d9e98ef68344b794a8aa5632e18c44e4b57cea490ac2ce0ba9471/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f48544d4c2d4533344632362e7376673f6c6f676f3d68746d6c35266c6f676f436f6c6f723d7768697465)
[![JavaScript](https://camo.githubusercontent.com/277d160259bb1a95090c8eb93da0c97eb034b13fea899d17f4d1dbee22c766e9/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4a6176615363726970742d4637444631452e7376673f6c6f676f3d6a617661736372697074266c6f676f436f6c6f723d626c61636b)](https://camo.githubusercontent.com/277d160259bb1a95090c8eb93da0c97eb034b13fea899d17f4d1dbee22c766e9/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4a6176615363726970742d4637444631452e7376673f6c6f676f3d6a617661736372697074266c6f676f436f6c6f723d626c61636b)
[![Markdown](https://camo.githubusercontent.com/f8152fc1ed3d7641e171c9c68f406a5972816ca70d69a4c178861a63929059a1/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d61726b646f776e2d3030303030302e7376673f6c6f676f3d6d61726b646f776e266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/f8152fc1ed3d7641e171c9c68f406a5972816ca70d69a4c178861a63929059a1/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d61726b646f776e2d3030303030302e7376673f6c6f676f3d6d61726b646f776e266c6f676f436f6c6f723d7768697465)
[![PHP](https://camo.githubusercontent.com/7a97202b78f1d2e0ec3f5732f918a8c56624b04656fa320e5e394b4b55514943/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f5048502d3737374242342e7376673f6c6f676f3d706870266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/7a97202b78f1d2e0ec3f5732f918a8c56624b04656fa320e5e394b4b55514943/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f5048502d3737374242342e7376673f6c6f676f3d706870266c6f676f436f6c6f723d7768697465)
[![Python](https://camo.githubusercontent.com/ddedf47a50a905d06f462a69ff3cd8bf48272d6d344bf19b8a5608daad0e6692/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f507974686f6e2d3134333534432e7376673f6c6f676f3d707974686f6e266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/ddedf47a50a905d06f462a69ff3cd8bf48272d6d344bf19b8a5608daad0e6692/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f507974686f6e2d3134333534432e7376673f6c6f676f3d707974686f6e266c6f676f436f6c6f723d7768697465)
[![SASS](https://camo.githubusercontent.com/c44fc7f72c1d60f1fb7583a861c7ed3006ce72935e277888d4bcf9ac1eb80276/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f536173732d686f7470696e6b2e7376673f6c6f676f3d53415353266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/c44fc7f72c1d60f1fb7583a861c7ed3006ce72935e277888d4bcf9ac1eb80276/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f536173732d686f7470696e6b2e7376673f6c6f676f3d53415353266c6f676f436f6c6f723d7768697465)
[![SQL](https://camo.githubusercontent.com/b08938b4cc020eaaa8a50e7c82402ee535201f49bedb57cbf0b1dc277a86c488/68747470733a2f2f637573746f6d2d69636f6e2d6261646765732e6865726f6b756170702e636f6d2f62616467652f53514c2d3032354538432e7376673f6c6f676f3d6461746162617365266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/b08938b4cc020eaaa8a50e7c82402ee535201f49bedb57cbf0b1dc277a86c488/68747470733a2f2f637573746f6d2d69636f6e2d6261646765732e6865726f6b756170702e636f6d2f62616467652f53514c2d3032354538432e7376673f6c6f676f3d6461746162617365266c6f676f436f6c6f723d7768697465)
[![SVG+XML](https://camo.githubusercontent.com/cfb66a78071530cb10b0e2cf66b5fa81379837045b635bf5205c3ddc72021205/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f535647253242584d4c2d6530393832632e7376673f6c6f676f3d737667266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/cfb66a78071530cb10b0e2cf66b5fa81379837045b635bf5205c3ddc72021205/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f535647253242584d4c2d6530393832632e7376673f6c6f676f3d737667266c6f676f436f6c6f723d7768697465)
[![Arduino](https://camo.githubusercontent.com/7baaeadc122c07e4d1871146dab61bdc0c844fa493ef03a3c47ae95a01294a2d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d41726475696e6f2d3030393739443f6c6f676f3d41726475696e6f266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/7baaeadc122c07e4d1871146dab61bdc0c844fa493ef03a3c47ae95a01294a2d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d41726475696e6f2d3030393739443f6c6f676f3d41726475696e6f266c6f676f436f6c6f723d7768697465)
[![Bootstrap](https://camo.githubusercontent.com/04f47e7516874e82bb1fbbaa10e3202bd8f2522d71f90334a1aa1d70f5bec7f4/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f426f6f7473747261702d3739353242332e7376673f6c6f676f3d626f6f747374726170266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/04f47e7516874e82bb1fbbaa10e3202bd8f2522d71f90334a1aa1d70f5bec7f4/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f426f6f7473747261702d3739353242332e7376673f6c6f676f3d626f6f747374726170266c6f676f436f6c6f723d7768697465)
[![GitHub Actions](https://camo.githubusercontent.com/dbac03eadcab12d40e8ec68af726ac1fb706a1e2c91f30d5039e28278cc01dd5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f476974487562253230416374696f6e732d3236373145352e7376673f6c6f676f3d676974687562253230616374696f6e73266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/dbac03eadcab12d40e8ec68af726ac1fb706a1e2c91f30d5039e28278cc01dd5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f476974487562253230416374696f6e732d3236373145352e7376673f6c6f676f3d676974687562253230616374696f6e73266c6f676f436f6c6f723d7768697465)
[![Material Design](https://camo.githubusercontent.com/1836f655a8f278b1b0fb205f0e1dbb64ee83b2f34a0a8a285df4e4bfe7fc8d73/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d6174657269616c25323044657369676e2d3030383143422e7376673f6c6f676f3d6d6174657269616c2d64657369676e266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/1836f655a8f278b1b0fb205f0e1dbb64ee83b2f34a0a8a285df4e4bfe7fc8d73/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d6174657269616c25323044657369676e2d3030383143422e7376673f6c6f676f3d6d6174657269616c2d64657369676e266c6f676f436f6c6f723d7768697465)
[![PHPUnit](https://camo.githubusercontent.com/d7f9f38a4c4f10ce10bfdb54e8221321536836bd633e589722fb791271a65464/68747470733a2f2f637573746f6d2d69636f6e2d6261646765732e6865726f6b756170702e636f6d2f62616467652f504850556e69742d3336363438382e7376673f6c6f676f3d746573742d74756265266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/d7f9f38a4c4f10ce10bfdb54e8221321536836bd633e589722fb791271a65464/68747470733a2f2f637573746f6d2d69636f6e2d6261646765732e6865726f6b756170702e636f6d2f62616467652f504850556e69742d3336363438382e7376673f6c6f676f3d746573742d74756265266c6f676f436f6c6f723d7768697465)
[![React](https://camo.githubusercontent.com/0554678f6499c9c75037174080bced94cea7532f4bcac00fe8e24763b3165bb7/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656163742d3230323332612e7376673f6c6f676f3d7265616374266c6f676f436f6c6f723d253233363144414642)](https://camo.githubusercontent.com/0554678f6499c9c75037174080bced94cea7532f4bcac00fe8e24763b3165bb7/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656163742d3230323332612e7376673f6c6f676f3d7265616374266c6f676f436f6c6f723d253233363144414642)
[![TensorFlow](https://camo.githubusercontent.com/a988a2032de34d035cd32ad313f6728ffdfb43def98da46d62dd02ae793090cc/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f54656e736f72466c6f772d4646364630302e7376673f6c6f676f3d54656e736f72466c6f77266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/a988a2032de34d035cd32ad313f6728ffdfb43def98da46d62dd02ae793090cc/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f54656e736f72466c6f772d4646364630302e7376673f6c6f676f3d54656e736f72466c6f77266c6f676f436f6c6f723d7768697465)
[![GitHub Pages](https://camo.githubusercontent.com/3be2dc392a2138ef3435fdce00f4f72459d9c4a1a2a0c298b9a525d1a35bde90/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f47697448756225323050616765732d3332374643372e7376673f6c6f676f3d676974687562266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/3be2dc392a2138ef3435fdce00f4f72459d9c4a1a2a0c298b9a525d1a35bde90/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f47697448756225323050616765732d3332374643372e7376673f6c6f676f3d676974687562266c6f676f436f6c6f723d7768697465)
[![MongoDB](https://camo.githubusercontent.com/c931ed220b04f83950e9774a758a335f2ca7366d45d4eb9df59ff30a5983142d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d6f6e676f44422d3465613934622e7376673f6c6f676f3d6d6f6e676f6462266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/c931ed220b04f83950e9774a758a335f2ca7366d45d4eb9df59ff30a5983142d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d6f6e676f44422d3465613934622e7376673f6c6f676f3d6d6f6e676f6462266c6f676f436f6c6f723d7768697465)
[![MySQL](https://camo.githubusercontent.com/6c0a8d23b04d2b21fec3224ca47ba19dc84b41bf97f561c62a3d5dd61580aeb5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d7953514c2d3030662e7376673f6c6f676f3d6d7973716c266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/6c0a8d23b04d2b21fec3224ca47ba19dc84b41bf97f561c62a3d5dd61580aeb5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4d7953514c2d3030662e7376673f6c6f676f3d6d7973716c266c6f676f436f6c6f723d7768697465)
[![PostgreSQL](https://camo.githubusercontent.com/9134018ea4e852a9f2a1b638f434b3a98d0eb408e168287d0bcaf117411a9db4/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f506f737467726553514c2d3331363139322e7376673f6c6f676f3d706f737467726573716c266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/9134018ea4e852a9f2a1b638f434b3a98d0eb408e168287d0bcaf117411a9db4/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f506f737467726553514c2d3331363139322e7376673f6c6f676f3d706f737467726573716c266c6f676f436f6c6f723d7768697465)
[![SQLite](https://camo.githubusercontent.com/2192aa8c426b4e823f0b31837f0a2867560d049982e2bae44db5d5a765f73bff/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f53514c6974652d3037343035652e7376673f6c6f676f3d73716c697465266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/2192aa8c426b4e823f0b31837f0a2867560d049982e2bae44db5d5a765f73bff/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f53514c6974652d3037343035652e7376673f6c6f676f3d73716c697465266c6f676f436f6c6f723d7768697465)
[![Adobe](https://camo.githubusercontent.com/2510bb717c3e123afbbddcdfcfef3d6f50a79257fc605affbca78e8f2c47293b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f41646f62652d4646303030302e7376673f6c6f676f3d61646f6265266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/2510bb717c3e123afbbddcdfcfef3d6f50a79257fc605affbca78e8f2c47293b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f41646f62652d4646303030302e7376673f6c6f676f3d61646f6265266c6f676f436f6c6f723d7768697465)
[![Brave](https://camo.githubusercontent.com/903e58bd46f1bd1aa244986a02f081e4a9fcc4e4a50659c013c086bc711afa09/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d42726176652d4642353432423f6c6f676f3d6272617665266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/903e58bd46f1bd1aa244986a02f081e4a9fcc4e4a50659c013c086bc711afa09/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d42726176652d4642353432423f6c6f676f3d6272617665266c6f676f436f6c6f723d7768697465)
[![Codepen](https://camo.githubusercontent.com/92449103292cc3737bf77ce5d819fe0a7951812aab1ec2f08ec958cc15056cdf/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f436f646570656e2d3030303030302e7376673f6c6f676f3d636f646570656e266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/92449103292cc3737bf77ce5d819fe0a7951812aab1ec2f08ec958cc15056cdf/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f436f646570656e2d3030303030302e7376673f6c6f676f3d636f646570656e266c6f676f436f6c6f723d7768697465)
[![OpenSSL](https://camo.githubusercontent.com/1c92145448e07b725956587fc06543d1e9e5f8d48539273cf52dc41775d42dcd/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f70656e53534c2d626c61636b3f6c6f676f3d6f70656e73736c)](https://camo.githubusercontent.com/1c92145448e07b725956587fc06543d1e9e5f8d48539273cf52dc41775d42dcd/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4f70656e53534c2d626c61636b3f6c6f676f3d6f70656e73736c)
[![Flask](https://camo.githubusercontent.com/efe934ec6698cbc3fb1c15caa3ddde479f1a30546d336004bb2a46666f684015/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d666c61736b2d3030303030303f6c6f676f3d466c61736b266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/efe934ec6698cbc3fb1c15caa3ddde479f1a30546d336004bb2a46666f684015/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d666c61736b2d3030303030303f6c6f676f3d466c61736b266c6f676f436f6c6f723d7768697465)
[![Graphql](https://camo.githubusercontent.com/9180cc0089ae2848efd8de3591f119bbbf6e5ef3a286c0709839c333f8936d3d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4772617068716c2d4531303039383f6c6f676f3d4772617068716c266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/9180cc0089ae2848efd8de3591f119bbbf6e5ef3a286c0709839c333f8936d3d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d4772617068716c2d4531303039383f6c6f676f3d4772617068716c266c6f676f436f6c6f723d7768697465)
[![Home Assistant](https://camo.githubusercontent.com/0d5f5abbe4c51ce82b3759845d66b1e4ebc10db30f8378343cbb320406885e6a/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d486f6d65253230417373697374616e742d3431626466353f6c6f676f3d486f6d652b417373697374616e74267374796c653d666c6174266c6f676f436f6c6f723d7768697465)](https://camo.githubusercontent.com/0d5f5abbe4c51ce82b3759845d66b1e4ebc10db30f8378343cbb320406885e6a/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d486f6d65253230417373697374616e742d3431626466353f6c6f676f3d486f6d652b417373697374616e74267374796c653d666c6174266c6f676f436f6c6f723d7768697465)
[![Raspberry Pi](https://camo.githubusercontent.com/0490ba16691b2f7f1534cca482f07c87be0083a465c8a954e23572356c324de7/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d52617370626572727925323050692d4335314134413f7374796c653d666c61742d737175617265266c6f676f3d5261737062657272792d5069)](https://camo.githubusercontent.com/0490ba16691b2f7f1534cca482f07c87be0083a465c8a954e23572356c324de7/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f2d52617370626572727925323050692d4335314134413f7374796c653d666c61742d737175617265266c6f676f3d5261737062657272792d5069)

[![Profile views](https://camo.githubusercontent.com/fdaba25a93be800cdaf80365b9094151c9609e11971eef190845f9a913640b9b/68747470733a2f2f677076632e6172747572696f2e6465762f6164)](https://camo.githubusercontent.com/fdaba25a93be800cdaf80365b9094151c9609e11971eef190845f9a913640b9b/68747470733a2f2f677076632e6172747572696f2e6465762f6164)

## Pinned Loading

1. [GithubListener](/ad/GithubListener) GithubListener Public

   Notifying about new commits from watched repos on github

   Swift

   [25](/ad/GithubListener/stargazers)
   [3](/ad/GithubListener/forks)
2. [MTMR](/ad/MTMR) MTMR Public

   Forked from [Toxblh/MTMR](/Toxblh/MTMR)

   My TouchBar. My rules

   Swift

   [1](/ad/MTMR/stargazers)
3. [BombusMod/BombusMod](/BombusMod/BombusMod) BombusMod/BombusMod Public

   Mobile XMPP client

   Java

   [27](/BombusMod/BombusMod/stargazers)
   [15](/BombusMod/BombusMod/forks)
4. [domru](/ad/domru) domru Public

   domru domofon client

   Go

   [28](/ad/domru/stargazers)
   [8](/ad/domru/forks)
5. [go-githublistener](/ad/go-githublistener) go-githublistener Public

   Go

   [1](/ad/go-githublistener/stargazers)
6. [corpobot](/ad/corpobot) corpobot Public

   –ë–æ—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç–∞–º –∫–æ–º–ø–∞–Ω–∏–∏

   Go

   [5](/ad/corpobot/stargazers)
   [3](/ad/corpobot/forks)

Something went wrong, please refresh the page to try again.

If the problem persists, check the [GitHub status page](https://www.githubstatus.com/)
or [contact support](/contact).

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_21ee1b89_20250126_060121.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fblob%2Fphp-7.1.4%2Fmain%2Fstreams%2Fxp_socket.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fblob%2Fphp-7.1.4%2Fmain%2Fstreams%2Fxp_socket.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=php%2Fphp-src)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[php](/php)
/
**[php-src](/php/php-src)**
Public

* [Notifications](/login?return_to=%2Fphp%2Fphp-src) You must be signed in to change notification settings
* [Fork
  7.8k](/login?return_to=%2Fphp%2Fphp-src)
* [Star
   38.6k](/login?return_to=%2Fphp%2Fphp-src)

* [Code](/php/php-src/tree/php-7.1.4)
* [Issues
  751](/php/php-src/issues)
* [Pull requests
  564](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

Additional navigation options

* [Code](/php/php-src/tree/php-7.1.4)
* [Issues](/php/php-src/issues)
* [Pull requests](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

## Files

¬†php-7.1.4
## Breadcrumbs

1. [php-src](/php/php-src/tree/php-7.1.4)
2. /[main](/php/php-src/tree/php-7.1.4/main)
3. /[streams](/php/php-src/tree/php-7.1.4/main/streams)
/
# xp\_socket.c

Copy path Blame  Blame
## Latest commit

## History

[History](/php/php-src/commits/php-7.1.4/main/streams/xp_socket.c)946 lines (789 loc) ¬∑ 24.8 KB¬†php-7.1.4
## Breadcrumbs

1. [php-src](/php/php-src/tree/php-7.1.4)
2. /[main](/php/php-src/tree/php-7.1.4/main)
3. /[streams](/php/php-src/tree/php-7.1.4/main/streams)
/
# xp\_socket.c

Top
## File metadata and controls

* Code
* Blame

946 lines (789 loc) ¬∑ 24.8 KB[Raw](https://github.com/php/php-src/raw/refs/tags/php-7.1.4/main/streams/xp_socket.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920921922923924925926927928929930931932933934935936937938939940941942943944945946/\* +----------------------------------------------------------------------+ | PHP Version 7 | +----------------------------------------------------------------------+ | Copyright (c) 1997-2017 The PHP Group | +----------------------------------------------------------------------+ | This source file is subject to version 3.01 of the PHP license, | | that is bundled with this package in the file LICENSE, and is | | available through the world-wide-web at the following url: | | http://www.php.net/license/3\_01.txt | | If you did not receive a copy of the PHP license and are unable to | | obtain it through the world-wide-web, please send a note to | | license@php.net so we can mail you a copy immediately. | +----------------------------------------------------------------------+ | Author: Wez Furlong <wez@thebrainroom.com> | +----------------------------------------------------------------------+\*/
/\* $Id$ \*/
#include "php.h"#include "ext/standard/file.h"#include "streams/php\_streams\_int.h"#include "php\_network.h"
#if defined(PHP\_WIN32) || defined(\_\_riscos\_\_) || defined(NETWARE)# undef AF\_UNIX#endif
#if defined(AF\_UNIX)#include <sys/un.h>#endif
#ifndef MSG\_DONTWAIT# define MSG\_DONTWAIT 0#endif
#ifndef MSG\_PEEK# define MSG\_PEEK 0#endif
#ifdef PHP\_WIN32/\* send/recv family on windows expects int \*/# define XP\_SOCK\_BUF\_SIZE(sz) (((sz) > INT\_MAX) ? INT\_MAX : (int)(sz))#else# define XP\_SOCK\_BUF\_SIZE(sz) (sz)#endif
php\_stream\_ops php\_stream\_generic\_socket\_ops;PHPAPI php\_stream\_ops php\_stream\_socket\_ops;php\_stream\_ops php\_stream\_udp\_socket\_ops;#ifdef AF\_UNIXphp\_stream\_ops php\_stream\_unix\_socket\_ops;php\_stream\_ops php\_stream\_unixdg\_socket\_ops;#endif
static int php\_tcp\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam);
/\* {{{ Generic socket stream operations \*/static size\_t php\_sockop\_write(php\_stream \*stream, const char \*buf, size\_t count){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; int didwrite; struct timeval \*ptimeout;
 if (!sock || sock->socket == -1) { return 0; }
 if (sock->timeout.tv\_sec == -1) ptimeout = NULL; else ptimeout = &sock->timeout;
retry: didwrite = send(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(count), (sock->is\_blocked && ptimeout) ? MSG\_DONTWAIT : 0);
 if (didwrite <= 0) { int err = php\_socket\_errno(); char \*estr;
 if (sock->is\_blocked && (err == EWOULDBLOCK || err == EAGAIN)) { int retval;
 sock->timeout\_event = 0;
 do { retval = php\_pollfd\_for(sock->socket, POLLOUT, ptimeout);
 if (retval == 0) { sock->timeout\_event = 1; break; }
 if (retval > 0) { /\* writable now; retry \*/ goto retry; }
 err = php\_socket\_errno(); } while (err == EINTR); } estr = php\_socket\_strerror(err, NULL, 0); php\_error\_docref(NULL, E\_NOTICE, "send of " ZEND\_LONG\_FMT " bytes failed with errno=%d %s", (zend\_long)count, err, estr); efree(estr); }
 if (didwrite > 0) { php\_stream\_notify\_progress\_increment(PHP\_STREAM\_CONTEXT(stream), didwrite, 0); }
 if (didwrite < 0) { didwrite = 0; }
 return didwrite;}
static void php\_sock\_stream\_wait\_for\_data(php\_stream \*stream, php\_netstream\_data\_t \*sock){ int retval; struct timeval \*ptimeout;
 if (!sock || sock->socket == -1) { return; }
 sock->timeout\_event = 0;
 if (sock->timeout.tv\_sec == -1) ptimeout = NULL; else ptimeout = &sock->timeout;
 while(1) { retval = php\_pollfd\_for(sock->socket, PHP\_POLLREADABLE, ptimeout);
 if (retval == 0) sock->timeout\_event = 1;
 if (retval >= 0) break;
 if (php\_socket\_errno() != EINTR) break; }}
static size\_t php\_sockop\_read(php\_stream \*stream, char \*buf, size\_t count){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; ssize\_t nr\_bytes = 0; int err;
 if (!sock || sock->socket == -1) { return 0; }
 if (sock->is\_blocked) { php\_sock\_stream\_wait\_for\_data(stream, sock); if (sock->timeout\_event) return 0; }
 nr\_bytes = recv(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(count), (sock->is\_blocked && sock->timeout.tv\_sec != -1) ? MSG\_DONTWAIT : 0); err = php\_socket\_errno();
 stream->eof = (nr\_bytes == 0 || (nr\_bytes == -1 && err != EWOULDBLOCK && err != EAGAIN));
 if (nr\_bytes > 0) { php\_stream\_notify\_progress\_increment(PHP\_STREAM\_CONTEXT(stream), nr\_bytes, 0); }
 if (nr\_bytes < 0) { nr\_bytes = 0; }
 return nr\_bytes;}
static int php\_sockop\_close(php\_stream \*stream, int close\_handle){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;#ifdef PHP\_WIN32 int n;#endif
 if (!sock) { return 0; }
 if (close\_handle) {
#ifdef PHP\_WIN32 if (sock->socket == -1) sock->socket = SOCK\_ERR;#endif if (sock->socket != SOCK\_ERR) {#ifdef PHP\_WIN32 /\* prevent more data from coming in \*/ shutdown(sock->socket, SHUT\_RD);
 /\* try to make sure that the OS sends all data before we close the connection. \* Essentially, we are waiting for the socket to become writeable, which means \* that all pending data has been sent. \* We use a small timeout which should encourage the OS to send the data, \* but at the same time avoid hanging indefinitely. \* \*/ do { n = php\_pollfd\_for\_ms(sock->socket, POLLOUT, 500); } while (n == -1 && php\_socket\_errno() == EINTR);#endif closesocket(sock->socket); sock->socket = SOCK\_ERR; }
 }
 pefree(sock, php\_stream\_is\_persistent(stream));
 return 0;}
static int php\_sockop\_flush(php\_stream \*stream){#if 0 php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; return fsync(sock->socket);#endif return 0;}
static int php\_sockop\_stat(php\_stream \*stream, php\_stream\_statbuf \*ssb){#if ZEND\_WIN32 return 0;#else php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;
 return zend\_fstat(sock->socket, &ssb->sb);#endif}
static inline int sock\_sendto(php\_netstream\_data\_t \*sock, const char \*buf, size\_t buflen, int flags, struct sockaddr \*addr, socklen\_t addrlen ){ int ret; if (addr) { ret = sendto(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags, addr, XP\_SOCK\_BUF\_SIZE(addrlen));
 return (ret == SOCK\_CONN\_ERR) ? -1 : ret; }#ifdef PHP\_WIN32 return ((ret = send(sock->socket, buf, buflen > INT\_MAX ? INT\_MAX : (int)buflen, flags)) == SOCK\_CONN\_ERR) ? -1 : ret;#else return ((ret = send(sock->socket, buf, buflen, flags)) == SOCK\_CONN\_ERR) ? -1 : ret;#endif}
static inline int sock\_recvfrom(php\_netstream\_data\_t \*sock, char \*buf, size\_t buflen, int flags, zend\_string \*\*textaddr, struct sockaddr \*\*addr, socklen\_t \*addrlen ){ int ret; int want\_addr = textaddr || addr;
 if (want\_addr) { php\_sockaddr\_storage sa; socklen\_t sl = sizeof(sa); ret = recvfrom(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags, (struct sockaddr\*)&sa, &sl); ret = (ret == SOCK\_CONN\_ERR) ? -1 : ret; if (sl) { php\_network\_populate\_name\_from\_sockaddr((struct sockaddr\*)&sa, sl, textaddr, addr, addrlen); } else { if (textaddr) { \*textaddr = ZSTR\_EMPTY\_ALLOC(); } if (addr) { \*addr = NULL; \*addrlen = 0; } } } else { ret = recv(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags); ret = (ret == SOCK\_CONN\_ERR) ? -1 : ret; }
 return ret;}
static int php\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam){ int oldmode, flags; php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; php\_stream\_xport\_param \*xparam;
 if (!sock) { return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }
 switch(option) { case PHP\_STREAM\_OPTION\_CHECK\_LIVENESS: { struct timeval tv; char buf; int alive = 1;
 if (value == -1) { if (sock->timeout.tv\_sec == -1) { tv.tv\_sec = FG(default\_socket\_timeout); tv.tv\_usec = 0; } else { tv = sock->timeout; } } else { tv.tv\_sec = value; tv.tv\_usec = 0; }
 if (sock->socket == -1) { alive = 0; } else if (php\_pollfd\_for(sock->socket, PHP\_POLLREADABLE|POLLPRI, &tv) > 0) {#ifdef PHP\_WIN32 int ret;#else ssize\_t ret;#endif int err;
 ret = recv(sock->socket, &buf, sizeof(buf), MSG\_PEEK); err = php\_socket\_errno(); if (0 == ret || /\* the counterpart did properly shutdown\*/ (0 > ret && err != EWOULDBLOCK && err != EAGAIN && err != EMSGSIZE)) { /\* there was an unrecoverable error \*/ alive = 0; } } return alive ? PHP\_STREAM\_OPTION\_RETURN\_OK : PHP\_STREAM\_OPTION\_RETURN\_ERR; }
 case PHP\_STREAM\_OPTION\_BLOCKING: oldmode = sock->is\_blocked; if (SUCCESS == php\_set\_sock\_blocking(sock->socket, value)) { sock->is\_blocked = value; return oldmode; } return PHP\_STREAM\_OPTION\_RETURN\_ERR;
 case PHP\_STREAM\_OPTION\_READ\_TIMEOUT: sock->timeout = \*(struct timeval\*)ptrparam; sock->timeout\_event = 0; return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case PHP\_STREAM\_OPTION\_META\_DATA\_API: add\_assoc\_bool((zval \*)ptrparam, "timed\_out", sock->timeout\_event); add\_assoc\_bool((zval \*)ptrparam, "blocked", sock->is\_blocked); add\_assoc\_bool((zval \*)ptrparam, "eof", stream->eof); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case PHP\_STREAM\_OPTION\_XPORT\_API: xparam = (php\_stream\_xport\_param \*)ptrparam;
 switch (xparam->op) { case STREAM\_XPORT\_OP\_LISTEN: xparam->outputs.returncode = (listen(sock->socket, xparam->inputs.backlog) == 0) ? 0: -1; return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_GET\_NAME: xparam->outputs.returncode = php\_network\_get\_sock\_name(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_GET\_PEER\_NAME: xparam->outputs.returncode = php\_network\_get\_peer\_name(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_SEND: flags = 0; if ((xparam->inputs.flags & STREAM\_OOB) == STREAM\_OOB) { flags |= MSG\_OOB; } xparam->outputs.returncode = sock\_sendto(sock, xparam->inputs.buf, xparam->inputs.buflen, flags, xparam->inputs.addr, xparam->inputs.addrlen); if (xparam->outputs.returncode == -1) { char \*err = php\_socket\_strerror(php\_socket\_errno(), NULL, 0); php\_error\_docref(NULL, E\_WARNING, "%s\n", err); efree(err); } return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_RECV: flags = 0; if ((xparam->inputs.flags & STREAM\_OOB) == STREAM\_OOB) { flags |= MSG\_OOB; } if ((xparam->inputs.flags & STREAM\_PEEK) == STREAM\_PEEK) { flags |= MSG\_PEEK; } xparam->outputs.returncode = sock\_recvfrom(sock, xparam->inputs.buf, xparam->inputs.buflen, flags, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
#ifdef HAVE\_SHUTDOWN# ifndef SHUT\_RD# define SHUT\_RD 0# endif# ifndef SHUT\_WR# define SHUT\_WR 1# endif# ifndef SHUT\_RDWR# define SHUT\_RDWR 2# endif case STREAM\_XPORT\_OP\_SHUTDOWN: { static const int shutdown\_how[] = {SHUT\_RD, SHUT\_WR, SHUT\_RDWR};
 xparam->outputs.returncode = shutdown(sock->socket, shutdown\_how[xparam->how]); return PHP\_STREAM\_OPTION\_RETURN\_OK; }#endif
 default: return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }
 default: return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }}
static int php\_sockop\_cast(php\_stream \*stream, int castas, void \*\*ret){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;
 if (!sock) { return FAILURE; }
 switch(castas) { case PHP\_STREAM\_AS\_STDIO: if (ret) { \*(FILE\*\*)ret = fdopen(sock->socket, stream->mode); if (\*ret) return SUCCESS; return FAILURE; } return SUCCESS; case PHP\_STREAM\_AS\_FD\_FOR\_SELECT: case PHP\_STREAM\_AS\_FD: case PHP\_STREAM\_AS\_SOCKETD: if (ret) \*(php\_socket\_t \*)ret = sock->socket; return SUCCESS; default: return FAILURE; }}/\* }}} \*/
/\* These may look identical, but we need them this way so that \* we can determine which type of socket we are dealing with \* by inspecting stream->ops. \* A "useful" side-effect is that the user's scripts can then \* make similar decisions using stream\_get\_meta\_data. \* \*/php\_stream\_ops php\_stream\_generic\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "generic\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_sockop\_set\_option,};
php\_stream\_ops php\_stream\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "tcp\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};
php\_stream\_ops php\_stream\_udp\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "udp\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};
#ifdef AF\_UNIXphp\_stream\_ops php\_stream\_unix\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "unix\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};php\_stream\_ops php\_stream\_unixdg\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "udg\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};#endif
/\* network socket operations \*/
#ifdef AF\_UNIXstatic inline int parse\_unix\_address(php\_stream\_xport\_param \*xparam, struct sockaddr\_un \*unix\_addr){ memset(unix\_addr, 0, sizeof(\*unix\_addr)); unix\_addr->sun\_family = AF\_UNIX;
 /\* we need to be binary safe on systems that support an abstract \* namespace \*/ if (xparam->inputs.namelen >= sizeof(unix\_addr->sun\_path)) { /\* On linux, when the path begins with a NUL byte we are \* referring to an abstract namespace. In theory we should \* allow an extra byte below, since we don't need the NULL. \* BUT, to get into this branch of code, the name is too long, \* so we don't care. \*/ xparam->inputs.namelen = sizeof(unix\_addr->sun\_path) - 1; php\_error\_docref(NULL, E\_NOTICE, "socket path exceeded the maximum allowed length of %lu bytes " "and was truncated", (unsigned long)sizeof(unix\_addr->sun\_path)); }
 memcpy(unix\_addr->sun\_path, xparam->inputs.name, xparam->inputs.namelen);
 return 1;}#endif
static inline char \*parse\_ip\_address\_ex(const char \*str, size\_t str\_len, int \*portno, int get\_err, zend\_string \*\*err){ char \*colon; char \*host = NULL;
#ifdef HAVE\_IPV6 if (\*(str) == '[' && str\_len > 1) { /\* IPV6 notation to specify raw address with port (i.e. [fe80::1]:80) \*/ char \*p = memchr(str + 1, ']', str\_len - 2), \*e = NULL; if (!p || \*(p + 1) != ':') { if (get\_err) { \*err = strpprintf(0, "Failed to parse IPv6 address \"%s\"", str); } return NULL; } \*portno = strtol(p + 2, &e, 10); if (e && \*e) { if (get\_err) { \*err = strpprintf(0, "Failed to parse address \"%s\"", str); } return NULL; } return estrndup(str + 1, p - str - 1); }#endif
 if (str\_len) { colon = memchr(str, ':', str\_len - 1); } else { colon = NULL; }
 if (colon) { char \*e = NULL; \*portno = strtol(colon + 1, &e, 10); if (!e || !\*e) { return estrndup(str, colon - str); } }
 if (get\_err) { \*err = strpprintf(0, "Failed to parse address \"%s\"", str); } return NULL;}
static inline char \*parse\_ip\_address(php\_stream\_xport\_param \*xparam, int \*portno){ return parse\_ip\_address\_ex(xparam->inputs.name, xparam->inputs.namelen, portno, xparam->want\_errortext, &xparam->outputs.error\_text);}
static inline int php\_tcp\_sockop\_bind(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam){ char \*host = NULL; int portno, err; long sockopts = STREAM\_SOCKOP\_NONE; zval \*tmpzval = NULL;
#ifdef AF\_UNIX if (stream->ops == &php\_stream\_unix\_socket\_ops || stream->ops == &php\_stream\_unixdg\_socket\_ops) { struct sockaddr\_un unix\_addr;
 sock->socket = socket(PF\_UNIX, stream->ops == &php\_stream\_unix\_socket\_ops ? SOCK\_STREAM : SOCK\_DGRAM, 0);
 if (sock->socket == SOCK\_ERR) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "Failed to create unix%s socket %s", stream->ops == &php\_stream\_unix\_socket\_ops ? "" : "datagram", strerror(errno)); } return -1; }
 parse\_unix\_address(xparam, &unix\_addr);
 return bind(sock->socket, (const struct sockaddr \*)&unix\_addr, (socklen\_t) XtOffsetOf(struct sockaddr\_un, sun\_path) + xparam->inputs.namelen); }#endif
 host = parse\_ip\_address(xparam, &portno);
 if (host == NULL) { return -1; }
#ifdef IPV6\_V6ONLY if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "ipv6\_v6only")) != NULL && Z\_TYPE\_P(tmpzval) != IS\_NULL ) { sockopts |= STREAM\_SOCKOP\_IPV6\_V6ONLY; sockopts |= STREAM\_SOCKOP\_IPV6\_V6ONLY\_ENABLED \* zend\_is\_true(tmpzval); }#endif
#ifdef SO\_REUSEPORT if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_reuseport")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_REUSEPORT; }#endif
#ifdef SO\_BROADCAST if (stream->ops == &php\_stream\_udp\_socket\_ops /\* SO\_BROADCAST is only applicable for UDP \*/ && PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_broadcast")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_BROADCAST; }#endif
 sock->socket = php\_network\_bind\_socket\_to\_local\_addr(host, portno, stream->ops == &php\_stream\_udp\_socket\_ops ? SOCK\_DGRAM : SOCK\_STREAM, sockopts, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err );
 if (host) { efree(host); }
 return sock->socket == -1 ? -1 : 0;}
static inline int php\_tcp\_sockop\_connect(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam){ char \*host = NULL, \*bindto = NULL; int portno, bindport = 0; int err = 0; int ret; zval \*tmpzval = NULL; long sockopts = STREAM\_SOCKOP\_NONE;
#ifdef AF\_UNIX if (stream->ops == &php\_stream\_unix\_socket\_ops || stream->ops == &php\_stream\_unixdg\_socket\_ops) { struct sockaddr\_un unix\_addr;
 sock->socket = socket(PF\_UNIX, stream->ops == &php\_stream\_unix\_socket\_ops ? SOCK\_STREAM : SOCK\_DGRAM, 0);
 if (sock->socket == SOCK\_ERR) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "Failed to create unix socket"); } return -1; }
 parse\_unix\_address(xparam, &unix\_addr);
 ret = php\_network\_connect\_socket(sock->socket, (const struct sockaddr \*)&unix\_addr, (socklen\_t) XtOffsetOf(struct sockaddr\_un, sun\_path) + xparam->inputs.namelen, xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err);
 xparam->outputs.error\_code = err;
 goto out; }#endif
 host = parse\_ip\_address(xparam, &portno);
 if (host == NULL) { return -1; }
 if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "bindto")) != NULL) { if (Z\_TYPE\_P(tmpzval) != IS\_STRING) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "local\_addr context option is not a string."); } efree(host); return -1; } bindto = parse\_ip\_address\_ex(Z\_STRVAL\_P(tmpzval), Z\_STRLEN\_P(tmpzval), &bindport, xparam->want\_errortext, &xparam->outputs.error\_text); }
#ifdef SO\_BROADCAST if (stream->ops == &php\_stream\_udp\_socket\_ops /\* SO\_BROADCAST is only applicable for UDP \*/ && PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_broadcast")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_BROADCAST; }#endif
 if (stream->ops != &php\_stream\_udp\_socket\_ops /\* TCP\_NODELAY is only applicable for TCP \*/#ifdef AF\_UNIX && stream->ops != &php\_stream\_unix\_socket\_ops && stream->ops != &php\_stream\_unixdg\_socket\_ops#endif && PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "tcp\_nodelay")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_TCP\_NODELAY; }
 /\* Note: the test here for php\_stream\_udp\_socket\_ops is important, because we \* want the default to be TCP sockets so that the openssl extension can \* re-use this code. \*/
 sock->socket = php\_network\_connect\_socket\_to\_host(host, portno, stream->ops == &php\_stream\_udp\_socket\_ops ? SOCK\_DGRAM : SOCK\_STREAM, xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err, bindto, bindport, sockopts );
 ret = sock->socket == -1 ? -1 : 0; xparam->outputs.error\_code = err;
 if (host) { efree(host); } if (bindto) { efree(bindto); }
#ifdef AF\_UNIXout:#endif
 if (ret >= 0 && xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC && err == EINPROGRESS) { /\* indicates pending connection \*/ return 1; }
 return ret;}
static inline int php\_tcp\_sockop\_accept(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam STREAMS\_DC){ int clisock; zend\_bool nodelay = 0; zval \*tmpzval = NULL;
 xparam->outputs.client = NULL;
 if ((NULL != PHP\_STREAM\_CONTEXT(stream)) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "tcp\_nodelay")) != NULL && zend\_is\_true(tmpzval)) { nodelay = 1; }
 clisock = php\_network\_accept\_incoming(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &xparam->outputs.error\_code, nodelay);
 if (clisock >= 0) { php\_netstream\_data\_t \*clisockdata = (php\_netstream\_data\_t\*) emalloc(sizeof(\*clisockdata));
 memcpy(clisockdata, sock, sizeof(\*clisockdata)); clisockdata->socket = clisock;
 xparam->outputs.client = php\_stream\_alloc\_rel(stream->ops, clisockdata, NULL, "r+"); if (xparam->outputs.client) { xparam->outputs.client->ctx = stream->ctx; if (stream->ctx) { GC\_REFCOUNT(stream->ctx)++; } } }
 return xparam->outputs.client == NULL ? -1 : 0;}
static int php\_tcp\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; php\_stream\_xport\_param \*xparam;
 switch(option) { case PHP\_STREAM\_OPTION\_XPORT\_API: xparam = (php\_stream\_xport\_param \*)ptrparam;
 switch(xparam->op) { case STREAM\_XPORT\_OP\_CONNECT: case STREAM\_XPORT\_OP\_CONNECT\_ASYNC: xparam->outputs.returncode = php\_tcp\_sockop\_connect(stream, sock, xparam); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_BIND: xparam->outputs.returncode = php\_tcp\_sockop\_bind(stream, sock, xparam); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_ACCEPT: xparam->outputs.returncode = php\_tcp\_sockop\_accept(stream, sock, xparam STREAMS\_CC); return PHP\_STREAM\_OPTION\_RETURN\_OK; default: /\* fall through \*/ ; } } return php\_sockop\_set\_option(stream, option, value, ptrparam);}
PHPAPI php\_stream \*php\_stream\_generic\_socket\_factory(const char \*proto, size\_t protolen, const char \*resourcename, size\_t resourcenamelen, const char \*persistent\_id, int options, int flags, struct timeval \*timeout, php\_stream\_context \*context STREAMS\_DC){ php\_stream \*stream = NULL; php\_netstream\_data\_t \*sock; php\_stream\_ops \*ops;
 /\* which type of socket ? \*/ if (strncmp(proto, "tcp", protolen) == 0) { ops = &php\_stream\_socket\_ops; } else if (strncmp(proto, "udp", protolen) == 0) { ops = &php\_stream\_udp\_socket\_ops; }#ifdef AF\_UNIX else if (strncmp(proto, "unix", protolen) == 0) { ops = &php\_stream\_unix\_socket\_ops; } else if (strncmp(proto, "udg", protolen) == 0) { ops = &php\_stream\_unixdg\_socket\_ops; }#endif else { /\* should never happen \*/ return NULL; }
 sock = pemalloc(sizeof(php\_netstream\_data\_t), persistent\_id ? 1 : 0); memset(sock, 0, sizeof(php\_netstream\_data\_t));
 sock->is\_blocked = 1; sock->timeout.tv\_sec = FG(default\_socket\_timeout); sock->timeout.tv\_usec = 0;
 /\* we don't know the socket until we have determined if we are binding or \* connecting \*/ sock->socket = -1;
 stream = php\_stream\_alloc\_rel(ops, sock, persistent\_id, "r+");
 if (stream == NULL) { pefree(sock, persistent\_id ? 1 : 0); return NULL; }
 if (flags == 0) { return stream; }
 return stream;}
/\* \* Local variables: \* tab-width: 4 \* c-basic-offset: 4 \* End: \* vim600: noet sw=4 ts=4 fdm=marker \* vim<600: noet sw=4 ts=4 \*/

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_cd574bfb_20250126_060119.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fcommit%2Fbab0b99f376dac9170ac81382a5ed526938d595a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fcommit%2Fbab0b99f376dac9170ac81382a5ed526938d595a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=php%2Fphp-src)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[php](/php)
/
**[php-src](/php/php-src)**
Public

* [Notifications](/login?return_to=%2Fphp%2Fphp-src) You must be signed in to change notification settings
* [Fork
  7.8k](/login?return_to=%2Fphp%2Fphp-src)
* [Star
   38.6k](/login?return_to=%2Fphp%2Fphp-src)

* [Code](/php/php-src)
* [Issues
  751](/php/php-src/issues)
* [Pull requests
  564](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

Additional navigation options

* [Code](/php/php-src)
* [Issues](/php/php-src/issues)
* [Pull requests](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

## Commit

[Permalink](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Detect invalid port in xp\_socket parse ip address

[Browse files](/php/php-src/tree/bab0b99f376dac9170ac81382a5ed526938d595a)
Browse the repository at this point in the history

```
For historical reasons, fsockopen() accepts the port and hostname
separately: fsockopen('127.0.0.1', 80)

However, with the introdcution of stream transports in PHP 4.3,
it became possible to include the port in the hostname specifier:

fsockopen('127.0.0.1:80')
Or more formally: fsockopen('tcp://127.0.0.1:80')

Confusing results when these two forms are combined, however.
fsockopen('127.0.0.1:80', 443) results in fsockopen() attempting
to connect to '127.0.0.1:80:443' which any reasonable stack would
consider invalid.

Unfortunately, PHP parses the address looking for the first colon
(with special handling for IPv6, don't worry) and calls atoi()
from there.  atoi() in turn, simply stops parsing at the first
non-numeric character and returns the value so far.

The end result is that the explicitly supplied port is treated
as ignored garbage, rather than producing an error.

This diff replaces atoi() with strtol() and inspects the
stop character.  If additional "garbage" of any kind is found,
it fails and returns an error.
```

* Loading branch information

[![@sgolemon](https://avatars.githubusercontent.com/u/812538?s=40&v=4)](/sgolemon)

[sgolemon](/php/php-src/commits?author=sgolemon "View all commits by sgolemon")
committed
Mar 7, 2017

1 parent
[549a30d](/php/php-src/commit/549a30d2cd7756abc5f5116dfebe217098ade5c5)

commit bab0b99

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**55 additions**
and
**11 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* ext/standard/tests/streams

  + ext/standard/tests/streams/parseip-001.phpt
    [parseip-001.phpt](#diff-2064a6856d0bf523700e09f85f4028167c29675833960f2b577b77943803d742)
* main/streams

  + main/streams/xp\_socket.c
    [xp\_socket.c](#diff-27c6a6b91485f76e8b913437b62985e9af233d9ddb71410ac59f52e84e51f7f7)

## There are no files selected for viewing

37 changes: 37 additions & 0 deletions

37
[ext/standard/tests/streams/parseip-001.phpt](#diff-2064a6856d0bf523700e09f85f4028167c29675833960f2b577b77943803d742 "ext/standard/tests/streams/parseip-001.phpt")

Show comments

[View file](/php/php-src/blob/bab0b99f376dac9170ac81382a5ed526938d595a/ext/standard/tests/streams/parseip-001.phpt)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,37 @@ |
|  |  | --TEST-- |
|  |  | Use of double-port in fsockopen() |
|  |  | --FILE-- |
|  |  | <?php |
|  |  |  |
|  |  | $try = [ |
|  |  | '127.0.0.1:80', |
|  |  | 'tcp://127.0.0.1:80', |
|  |  | '[::1]:80', |
|  |  | 'tcp://[::1]:80', |
|  |  | 'localhost:80', |
|  |  | 'tcp://localhost:80', |
|  |  | ]; |
|  |  |  |
|  |  | foreach ($try as $addr) { |
|  |  | echo "== $addr ==\n"; |
|  |  | var\_dump(@fsockopen($addr, 81, $errno, $errstr), $errstr); |
|  |  | } |
|  |  | --EXPECTF-- |
|  |  | == 127.0.0.1:80 == |
|  |  | bool(false) |
|  |  | string(41) "Failed to parse address "127.0.0.1:80:81"" |
|  |  | == tcp://127.0.0.1:80 == |
|  |  | bool(false) |
|  |  | string(41) "Failed to parse address "127.0.0.1:80:81"" |
|  |  | == [::1]:80 == |
|  |  | bool(false) |
|  |  | string(37) "Failed to parse address "[::1]:80:81"" |
|  |  | == tcp://[::1]:80 == |
|  |  | bool(false) |
|  |  | string(37) "Failed to parse address "[::1]:80:81"" |
|  |  | == localhost:80 == |
|  |  | bool(false) |
|  |  | string(41) "Failed to parse address "localhost:80:81"" |
|  |  | == tcp://localhost:80 == |
|  |  | bool(false) |
|  |  | string(41) "Failed to parse address "localhost:80:81"" |

29 changes: 18 additions & 11 deletions

29
[main/streams/xp\_socket.c](#diff-27c6a6b91485f76e8b913437b62985e9af233d9ddb71410ac59f52e84e51f7f7 "main/streams/xp_socket.c")

Show comments

[View file](/php/php-src/blob/bab0b99f376dac9170ac81382a5ed526938d595a/main/streams/xp_socket.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -571,37 +571,44 @@ static inline char \*parse\_ip\_address\_ex(const char \*str, size\_t str\_len, int \*po |
|  |  | char \*host = NULL; |
|  |  |  |
|  |  | #ifdef HAVE\_IPV6 |
|  |  | char \*p; |
|  |  |  |
|  |  | if (\*(str) == '[' && str\_len > 1) { |
|  |  | /\* IPV6 notation to specify raw address with port (i.e. [fe80::1]:80) \*/ |
|  |  | p = memchr(str + 1, ']', str\_len - 2); |
|  |  | char \*p = memchr(str + 1, ']', str\_len - 2), \*e = NULL; |
|  |  | if (!p || \*(p + 1) != ':') { |
|  |  | if (get\_err) { |
|  |  | \*err = strpprintf(0, "Failed to parse IPv6 address \"%s\"", str); |
|  |  | } |
|  |  | return NULL; |
|  |  | } |
|  |  | \*portno = atoi(p + 2); |
|  |  | \*portno = strtol(p + 2, &e, 10); |
|  |  | if (e && \*e) { |
|  |  | if (get\_err) { |
|  |  | \*err = strpprintf(0, "Failed to parse address \"%s\"", str); |
|  |  | } |
|  |  | return NULL; |
|  |  | } |
|  |  | return estrndup(str + 1, p - str - 1); |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | if (str\_len) { |
|  |  | colon = memchr(str, ':', str\_len - 1); |
|  |  | } else { |
|  |  | colon = NULL; |
|  |  | } |
|  |  |  |
|  |  | if (colon) { |
|  |  | \*portno = atoi(colon + 1); |
|  |  | host = estrndup(str, colon - str); |
|  |  | } else { |
|  |  | if (get\_err) { |
|  |  | \*err = strpprintf(0, "Failed to parse address \"%s\"", str); |
|  |  | char \*e = NULL; |
|  |  | \*portno = strtol(colon + 1, &e, 10); |
|  |  | if (!e || !\*e) { |
|  |  | return estrndup(str, colon - str); |
|  |  | } |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | return host; |
|  |  | if (get\_err) { |
|  |  | \*err = strpprintf(0, "Failed to parse address \"%s\"", str); |
|  |  | } |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | static inline char \*parse\_ip\_address(php\_stream\_xport\_param \*xparam, int \*portno) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 9 comments on commit `bab0b99`

[![@tinuzz](https://avatars.githubusercontent.com/u/1084192?s=80&v=4)](/tinuzz)

Copy link

### @tinuzz **[tinuzz](/tinuzz)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Apr 13, 2017](#commitcomment-21748042) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This commit breaks some undocumented, but possibly widely used feature.

Using a remote socket description with an extra identifier like this:

`tcp://localhost:80/foo`

used to work, and now breaks.

The entire remote socket specifier is used as a 'persistent\_id', which is used to get a cached persistent connection if available. Adding something unique to the end of the URI would force a new connection to be created instead of reusing a cached one.

I don't know if this was meant to work this way (it is not documented for stream\_socket\_client() but [mentioned in the user comments](http://php.net/manual/en/function.stream-socket-client.php#105393)), so I'm not sure if this is a bug. I know of at least one piece of software that relies on this to work, which is the [Magento Redis cache/session storage module](https://github.com/colinmollenhour/credis/blob/958e188b4c00886ba5f1d98ba5955cea01682a85/Client.php#L430).

Regards,

Martijn.

Sorry, something went wrong.

 üëç
6
 ToonSpinISAAC, colinmollenhour, motecshine, royduin, nrk, and AndrejAndb reacted with thumbs up emoji

All reactions

* üëç
  6 reactions

[![@colinmollenhour](https://avatars.githubusercontent.com/u/38738?s=80&v=4)](/colinmollenhour)

Copy link

### @colinmollenhour **[colinmollenhour](/colinmollenhour)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Apr 13, 2017](#commitcomment-21752587) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Also mentioned [on StackOverflow](http://stackoverflow.com/a/30391981/187780) and a regression has already been [reported by a user](https://github.com/colinmollenhour/Cm_RedisSession/issues/111) on a production system.

Sorry, something went wrong.

All reactions

[![@tinuzz](https://avatars.githubusercontent.com/u/1084192?s=80&v=4)](/tinuzz)

Copy link

### @tinuzz **[tinuzz](/tinuzz)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Apr 13, 2017](#commitcomment-21753535)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

FYI, I also [filed this bug report](https://bugs.php.net/bug.php?id=74429) with PHP.

Cheers,

Martijn.

Sorry, something went wrong.

All reactions

[![@kelunik](https://avatars.githubusercontent.com/u/2743004?s=80&v=4)](/kelunik)

Copy link

Member

### @kelunik **[kelunik](/kelunik)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Jun 18, 2017](#commitcomment-22614934)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Artax also relies on URI fragments for transparent connection limiting per host when using a proxy.

Sorry, something went wrong.

All reactions

[![@AgoraSecurity](https://avatars.githubusercontent.com/u/14286143?s=80&v=4)](/AgoraSecurity)

Copy link

### @AgoraSecurity **[AgoraSecurity](/AgoraSecurity)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Feb 28, 2018](#commitcomment-27849621)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

On what versions of PHP has this patch been applied?

I read the Changelog and I saw that in version:

7.0.18 - Fixed bug #74216 (Correctly fail on invalid IP address ports).

7.1.4 - Fixed bug #74216 (Correctly fail on invalid IP address ports).

Anyhow:

7.0.19 - Patch for bug #74216 was reverted.

It's not very clear what versions have been patched

Thanks!

Sorry, something went wrong.

All reactions

[![@hikatu1264](https://avatars.githubusercontent.com/u/5875662?s=80&v=4)](/hikatu1264)

Copy link

### @hikatu1264 **[hikatu1264](/hikatu1264)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Aug 7, 2018](#commitcomment-29982295)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Hi,

Did this bug fix in 5.6.x?

If I want to avoid #74216, do I have to upgrade to 7.1.x?

I read [5.6.37](https://github.com/php/php-src/blob/PHP-5.6.37/main/streams/xp_socket.c) and I think this bug is not fixed

thanks.

Sorry, something went wrong.

All reactions

[![@GarrettVD](https://avatars.githubusercontent.com/u/2552642?s=80&v=4)](/GarrettVD)

Copy link

### @GarrettVD **[GarrettVD](/GarrettVD)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Jul 29, 2019](#commitcomment-34484016)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Any clarification on which versions are affected? Has [CVE-2017-7189](https://github.com/advisories/GHSA-3mh5-9253-628p "CVE-2017-7189") been patched?

Sorry, something went wrong.

All reactions

[![@brianmay](https://avatars.githubusercontent.com/u/112729?s=80&v=4)](/brianmay)

Copy link

### @brianmay **[brianmay](/brianmay)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Jul 30, 2019](#commitcomment-34493194) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Why are related bug reports [#74216](https://bugs.php.net/bug.php?id=74216) and [#74192](https://bugs.php.net/bug.php?id=74192) private and inaccessible? Any chance this could be fixed?

Sorry, something went wrong.

All reactions

[![@cfi-gb](https://avatars.githubusercontent.com/u/34644702?s=80&v=4)](/cfi-gb)

Copy link

### @cfi-gb **[cfi-gb](/cfi-gb)** commented on `[bab0b99](/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)` [Aug 26, 2020](#commitcomment-41781046)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I have written a mail to security@php.net asking for providing public information about the status of [CVE-2017-7189](https://github.com/advisories/GHSA-3mh5-9253-628p "CVE-2017-7189").

But based on some research [bab0b99](https://github.com/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a) was added to PHP 7.0.18 and 7.1.4 fixing [CVE-2017-7189](https://github.com/advisories/GHSA-3mh5-9253-628p "CVE-2017-7189"):

<https://github.com/php/php-src/blob/php-7.0.18/main/streams/xp_socket.c#L568-L612>

<https://github.com/php/php-src/blob/php-7.1.4/main/streams/xp_socket.c#L568-L612>

but the code / changes got removed in 7.0.19 and 7.1.5 again:

<https://github.com/php/php-src/blob/php-7.0.19/main/streams/xp_socket.c#L568-L605>

<https://github.com/php/php-src/blob/php-7.1.5/main/streams/xp_socket.c#L568-L605>

and is still the same up to the most recent PHP 7.4.9 release:

<https://github.com/php/php-src/blob/php-7.4.9/main/streams/xp_socket.c#L578-L615>

Due to <https://bugs.php.net/bug.php?id=74192> being set to private it is currently unclear if this isn't fixed since the revert or if some other code changes were made fixing this CVE in a different way.

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fcommit%2Fbab0b99f376dac9170ac81382a5ed526938d595a) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_df489925_20250126_060117.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-3mh5-9253-628p)

**CVE-2017-7189**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-3mh5-9253-628p)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2017-7189](/advisories/GHSA-3mh5-9253-628p)

## main/streams/xp\_socket.c in PHP 7.x before 2017-03-07...

High severity

Unreviewed

Published
May 24, 2022
to the GitHub Advisory Database
‚Ä¢
Updated Apr 4, 2024

## Package

No package listed‚Äî
[Suggest a package](/advisories/GHSA-3mh5-9253-628p/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

main/streams/xp\_socket.c in PHP 7.x before 2017-03-07 misparses fsockopen calls, such as by interpreting fsockopen('127.0.0.1:80', 443) as if the address/port were 127.0.0.1:80:443, which is later truncated to 127.0.0.1:80. This behavior has a security risk if the explicitly provided port number (i.e., 443 in this example) is hardcoded into an application as a security policy, but the hostname argument (i.e., 127.0.0.1:80 in this example) is obtained from untrusted input.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2017-7189>
* [php/php-src@bab0b99](https://github.com/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a)
* <https://bugs.php.net/bug.php?id=74192>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2017-7189)
Jul 10, 2019

Published to the GitHub Advisory Database
May 24, 2022

Last updated
Apr 4, 2024

### Severity

High

7.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N

### EPSS score

0.197%

# Exploit Prediction Scoring System (EPSS)

This score estimates the probability of this vulnerability being exploited within the next 30 days.
Data provided by [FIRST](https://www.first.org/epss/user-guide).

 (58th percentile)

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### CVE ID

CVE-2017-7189

### GHSA ID

GHSA-3mh5-9253-628p

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-3mh5-9253-628p/improve).

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_ee20b3f1_20250126_060124.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fblob%2Fphp-7.0.18%2Fmain%2Fstreams%2Fxp_socket.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fblob%2Fphp-7.0.18%2Fmain%2Fstreams%2Fxp_socket.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=php%2Fphp-src)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[php](/php)
/
**[php-src](/php/php-src)**
Public

* [Notifications](/login?return_to=%2Fphp%2Fphp-src) You must be signed in to change notification settings
* [Fork
  7.8k](/login?return_to=%2Fphp%2Fphp-src)
* [Star
   38.6k](/login?return_to=%2Fphp%2Fphp-src)

* [Code](/php/php-src/tree/php-7.0.18)
* [Issues
  751](/php/php-src/issues)
* [Pull requests
  564](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

Additional navigation options

* [Code](/php/php-src/tree/php-7.0.18)
* [Issues](/php/php-src/issues)
* [Pull requests](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

## Files

¬†php-7.0.18
## Breadcrumbs

1. [php-src](/php/php-src/tree/php-7.0.18)
2. /[main](/php/php-src/tree/php-7.0.18/main)
3. /[streams](/php/php-src/tree/php-7.0.18/main/streams)
/
# xp\_socket.c

Copy path Blame  Blame
## Latest commit

## History

[History](/php/php-src/commits/php-7.0.18/main/streams/xp_socket.c)933 lines (777 loc) ¬∑ 24.3 KB¬†php-7.0.18
## Breadcrumbs

1. [php-src](/php/php-src/tree/php-7.0.18)
2. /[main](/php/php-src/tree/php-7.0.18/main)
3. /[streams](/php/php-src/tree/php-7.0.18/main/streams)
/
# xp\_socket.c

Top
## File metadata and controls

* Code
* Blame

933 lines (777 loc) ¬∑ 24.3 KB[Raw](https://github.com/php/php-src/raw/refs/tags/php-7.0.18/main/streams/xp_socket.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920921922923924925926927928929930931932933/\* +----------------------------------------------------------------------+ | PHP Version 7 | +----------------------------------------------------------------------+ | Copyright (c) 1997-2017 The PHP Group | +----------------------------------------------------------------------+ | This source file is subject to version 3.01 of the PHP license, | | that is bundled with this package in the file LICENSE, and is | | available through the world-wide-web at the following url: | | http://www.php.net/license/3\_01.txt | | If you did not receive a copy of the PHP license and are unable to | | obtain it through the world-wide-web, please send a note to | | license@php.net so we can mail you a copy immediately. | +----------------------------------------------------------------------+ | Author: Wez Furlong <wez@thebrainroom.com> | +----------------------------------------------------------------------+\*/
/\* $Id$ \*/
#include "php.h"#include "ext/standard/file.h"#include "streams/php\_streams\_int.h"#include "php\_network.h"
#if defined(PHP\_WIN32) || defined(\_\_riscos\_\_) || defined(NETWARE)# undef AF\_UNIX#endif
#if defined(AF\_UNIX)#include <sys/un.h>#endif
#ifndef MSG\_DONTWAIT# define MSG\_DONTWAIT 0#endif
#ifndef MSG\_PEEK# define MSG\_PEEK 0#endif
#ifdef PHP\_WIN32/\* send/recv family on windows expects int \*/# define XP\_SOCK\_BUF\_SIZE(sz) (((sz) > INT\_MAX) ? INT\_MAX : (int)(sz))#else# define XP\_SOCK\_BUF\_SIZE(sz) (sz)#endif
php\_stream\_ops php\_stream\_generic\_socket\_ops;PHPAPI php\_stream\_ops php\_stream\_socket\_ops;php\_stream\_ops php\_stream\_udp\_socket\_ops;#ifdef AF\_UNIXphp\_stream\_ops php\_stream\_unix\_socket\_ops;php\_stream\_ops php\_stream\_unixdg\_socket\_ops;#endif
static int php\_tcp\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam);
/\* {{{ Generic socket stream operations \*/static size\_t php\_sockop\_write(php\_stream \*stream, const char \*buf, size\_t count){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; int didwrite; struct timeval \*ptimeout;
 if (!sock || sock->socket == -1) { return 0; }
 if (sock->timeout.tv\_sec == -1) ptimeout = NULL; else ptimeout = &sock->timeout;
retry: didwrite = send(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(count), (sock->is\_blocked && ptimeout) ? MSG\_DONTWAIT : 0);
 if (didwrite <= 0) { int err = php\_socket\_errno(); char \*estr;
 if (sock->is\_blocked && (err == EWOULDBLOCK || err == EAGAIN)) { int retval;
 sock->timeout\_event = 0;
 do { retval = php\_pollfd\_for(sock->socket, POLLOUT, ptimeout);
 if (retval == 0) { sock->timeout\_event = 1; break; }
 if (retval > 0) { /\* writable now; retry \*/ goto retry; }
 err = php\_socket\_errno(); } while (err == EINTR); } estr = php\_socket\_strerror(err, NULL, 0); php\_error\_docref(NULL, E\_NOTICE, "send of " ZEND\_LONG\_FMT " bytes failed with errno=%ld %s", (zend\_long)count, err, estr); efree(estr); }
 if (didwrite > 0) { php\_stream\_notify\_progress\_increment(PHP\_STREAM\_CONTEXT(stream), didwrite, 0); }
 if (didwrite < 0) { didwrite = 0; }
 return didwrite;}
static void php\_sock\_stream\_wait\_for\_data(php\_stream \*stream, php\_netstream\_data\_t \*sock){ int retval; struct timeval \*ptimeout;
 if (!sock || sock->socket == -1) { return; }
 sock->timeout\_event = 0;
 if (sock->timeout.tv\_sec == -1) ptimeout = NULL; else ptimeout = &sock->timeout;
 while(1) { retval = php\_pollfd\_for(sock->socket, PHP\_POLLREADABLE, ptimeout);
 if (retval == 0) sock->timeout\_event = 1;
 if (retval >= 0) break;
 if (php\_socket\_errno() != EINTR) break; }}
static size\_t php\_sockop\_read(php\_stream \*stream, char \*buf, size\_t count){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; ssize\_t nr\_bytes = 0; int err;
 if (!sock || sock->socket == -1) { return 0; }
 if (sock->is\_blocked) { php\_sock\_stream\_wait\_for\_data(stream, sock); if (sock->timeout\_event) return 0; }
 nr\_bytes = recv(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(count), (sock->is\_blocked && sock->timeout.tv\_sec != -1) ? MSG\_DONTWAIT : 0); err = php\_socket\_errno();
 stream->eof = (nr\_bytes == 0 || (nr\_bytes == -1 && err != EWOULDBLOCK && err != EAGAIN));
 if (nr\_bytes > 0) { php\_stream\_notify\_progress\_increment(PHP\_STREAM\_CONTEXT(stream), nr\_bytes, 0); }
 if (nr\_bytes < 0) { nr\_bytes = 0; }
 return nr\_bytes;}
static int php\_sockop\_close(php\_stream \*stream, int close\_handle){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;#ifdef PHP\_WIN32 int n;#endif
 if (!sock) { return 0; }
 if (close\_handle) {
#ifdef PHP\_WIN32 if (sock->socket == -1) sock->socket = SOCK\_ERR;#endif if (sock->socket != SOCK\_ERR) {#ifdef PHP\_WIN32 /\* prevent more data from coming in \*/ shutdown(sock->socket, SHUT\_RD);
 /\* try to make sure that the OS sends all data before we close the connection. \* Essentially, we are waiting for the socket to become writeable, which means \* that all pending data has been sent. \* We use a small timeout which should encourage the OS to send the data, \* but at the same time avoid hanging indefinitely. \* \*/ do { n = php\_pollfd\_for\_ms(sock->socket, POLLOUT, 500); } while (n == -1 && php\_socket\_errno() == EINTR);#endif closesocket(sock->socket); sock->socket = SOCK\_ERR; }
 }
 pefree(sock, php\_stream\_is\_persistent(stream));
 return 0;}
static int php\_sockop\_flush(php\_stream \*stream){#if 0 php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; return fsync(sock->socket);#endif return 0;}
static int php\_sockop\_stat(php\_stream \*stream, php\_stream\_statbuf \*ssb){#if ZEND\_WIN32 return 0;#else php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;
 return zend\_fstat(sock->socket, &ssb->sb);#endif}
static inline int sock\_sendto(php\_netstream\_data\_t \*sock, const char \*buf, size\_t buflen, int flags, struct sockaddr \*addr, socklen\_t addrlen ){ int ret; if (addr) { ret = sendto(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags, addr, XP\_SOCK\_BUF\_SIZE(addrlen));
 return (ret == SOCK\_CONN\_ERR) ? -1 : ret; }#ifdef PHP\_WIN32 return ((ret = send(sock->socket, buf, buflen > INT\_MAX ? INT\_MAX : (int)buflen, flags)) == SOCK\_CONN\_ERR) ? -1 : ret;#else return ((ret = send(sock->socket, buf, buflen, flags)) == SOCK\_CONN\_ERR) ? -1 : ret;#endif}
static inline int sock\_recvfrom(php\_netstream\_data\_t \*sock, char \*buf, size\_t buflen, int flags, zend\_string \*\*textaddr, struct sockaddr \*\*addr, socklen\_t \*addrlen ){ int ret; int want\_addr = textaddr || addr;
 if (want\_addr) { php\_sockaddr\_storage sa; socklen\_t sl = sizeof(sa); ret = recvfrom(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags, (struct sockaddr\*)&sa, &sl); ret = (ret == SOCK\_CONN\_ERR) ? -1 : ret; if (sl) { php\_network\_populate\_name\_from\_sockaddr((struct sockaddr\*)&sa, sl, textaddr, addr, addrlen); } else { if (textaddr) { \*textaddr = ZSTR\_EMPTY\_ALLOC(); } if (addr) { \*addr = NULL; \*addrlen = 0; } } } else { ret = recv(sock->socket, buf, XP\_SOCK\_BUF\_SIZE(buflen), flags); ret = (ret == SOCK\_CONN\_ERR) ? -1 : ret; }
 return ret;}
static int php\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam){ int oldmode, flags; php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; php\_stream\_xport\_param \*xparam;
 if (!sock) { return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }
 switch(option) { case PHP\_STREAM\_OPTION\_CHECK\_LIVENESS: { struct timeval tv; char buf; int alive = 1;
 if (value == -1) { if (sock->timeout.tv\_sec == -1) { tv.tv\_sec = FG(default\_socket\_timeout); tv.tv\_usec = 0; } else { tv = sock->timeout; } } else { tv.tv\_sec = value; tv.tv\_usec = 0; }
 if (sock->socket == -1) { alive = 0; } else if (php\_pollfd\_for(sock->socket, PHP\_POLLREADABLE|POLLPRI, &tv) > 0) {#ifdef PHP\_WIN32 int ret;#else ssize\_t ret;#endif int err;
 ret = recv(sock->socket, &buf, sizeof(buf), MSG\_PEEK); err = php\_socket\_errno(); if (0 == ret || /\* the counterpart did properly shutdown\*/ (0 > ret && err != EWOULDBLOCK && err != EAGAIN && err != EMSGSIZE)) { /\* there was an unrecoverable error \*/ alive = 0; } } return alive ? PHP\_STREAM\_OPTION\_RETURN\_OK : PHP\_STREAM\_OPTION\_RETURN\_ERR; }
 case PHP\_STREAM\_OPTION\_BLOCKING: oldmode = sock->is\_blocked; if (SUCCESS == php\_set\_sock\_blocking(sock->socket, value)) { sock->is\_blocked = value; return oldmode; } return PHP\_STREAM\_OPTION\_RETURN\_ERR;
 case PHP\_STREAM\_OPTION\_READ\_TIMEOUT: sock->timeout = \*(struct timeval\*)ptrparam; sock->timeout\_event = 0; return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case PHP\_STREAM\_OPTION\_META\_DATA\_API: add\_assoc\_bool((zval \*)ptrparam, "timed\_out", sock->timeout\_event); add\_assoc\_bool((zval \*)ptrparam, "blocked", sock->is\_blocked); add\_assoc\_bool((zval \*)ptrparam, "eof", stream->eof); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case PHP\_STREAM\_OPTION\_XPORT\_API: xparam = (php\_stream\_xport\_param \*)ptrparam;
 switch (xparam->op) { case STREAM\_XPORT\_OP\_LISTEN: xparam->outputs.returncode = (listen(sock->socket, xparam->inputs.backlog) == 0) ? 0: -1; return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_GET\_NAME: xparam->outputs.returncode = php\_network\_get\_sock\_name(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_GET\_PEER\_NAME: xparam->outputs.returncode = php\_network\_get\_peer\_name(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_SEND: flags = 0; if ((xparam->inputs.flags & STREAM\_OOB) == STREAM\_OOB) { flags |= MSG\_OOB; } xparam->outputs.returncode = sock\_sendto(sock, xparam->inputs.buf, xparam->inputs.buflen, flags, xparam->inputs.addr, xparam->inputs.addrlen); if (xparam->outputs.returncode == -1) { char \*err = php\_socket\_strerror(php\_socket\_errno(), NULL, 0); php\_error\_docref(NULL, E\_WARNING, "%s\n", err); efree(err); } return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_RECV: flags = 0; if ((xparam->inputs.flags & STREAM\_OOB) == STREAM\_OOB) { flags |= MSG\_OOB; } if ((xparam->inputs.flags & STREAM\_PEEK) == STREAM\_PEEK) { flags |= MSG\_PEEK; } xparam->outputs.returncode = sock\_recvfrom(sock, xparam->inputs.buf, xparam->inputs.buflen, flags, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL ); return PHP\_STREAM\_OPTION\_RETURN\_OK;
#ifdef HAVE\_SHUTDOWN# ifndef SHUT\_RD# define SHUT\_RD 0# endif# ifndef SHUT\_WR# define SHUT\_WR 1# endif# ifndef SHUT\_RDWR# define SHUT\_RDWR 2# endif case STREAM\_XPORT\_OP\_SHUTDOWN: { static const int shutdown\_how[] = {SHUT\_RD, SHUT\_WR, SHUT\_RDWR};
 xparam->outputs.returncode = shutdown(sock->socket, shutdown\_how[xparam->how]); return PHP\_STREAM\_OPTION\_RETURN\_OK; }#endif
 default: return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }
 default: return PHP\_STREAM\_OPTION\_RETURN\_NOTIMPL; }}
static int php\_sockop\_cast(php\_stream \*stream, int castas, void \*\*ret){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract;
 if (!sock) { return FAILURE; }
 switch(castas) { case PHP\_STREAM\_AS\_STDIO: if (ret) { \*(FILE\*\*)ret = fdopen(sock->socket, stream->mode); if (\*ret) return SUCCESS; return FAILURE; } return SUCCESS; case PHP\_STREAM\_AS\_FD\_FOR\_SELECT: case PHP\_STREAM\_AS\_FD: case PHP\_STREAM\_AS\_SOCKETD: if (ret) \*(php\_socket\_t \*)ret = sock->socket; return SUCCESS; default: return FAILURE; }}/\* }}} \*/
/\* These may look identical, but we need them this way so that \* we can determine which type of socket we are dealing with \* by inspecting stream->ops. \* A "useful" side-effect is that the user's scripts can then \* make similar decisions using stream\_get\_meta\_data. \* \*/php\_stream\_ops php\_stream\_generic\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "generic\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_sockop\_set\_option,};
php\_stream\_ops php\_stream\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "tcp\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};
php\_stream\_ops php\_stream\_udp\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "udp\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};
#ifdef AF\_UNIXphp\_stream\_ops php\_stream\_unix\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "unix\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};php\_stream\_ops php\_stream\_unixdg\_socket\_ops = { php\_sockop\_write, php\_sockop\_read, php\_sockop\_close, php\_sockop\_flush, "udg\_socket", NULL, /\* seek \*/ php\_sockop\_cast, php\_sockop\_stat, php\_tcp\_sockop\_set\_option,};#endif
/\* network socket operations \*/
#ifdef AF\_UNIXstatic inline int parse\_unix\_address(php\_stream\_xport\_param \*xparam, struct sockaddr\_un \*unix\_addr){ memset(unix\_addr, 0, sizeof(\*unix\_addr)); unix\_addr->sun\_family = AF\_UNIX;
 /\* we need to be binary safe on systems that support an abstract \* namespace \*/ if (xparam->inputs.namelen >= sizeof(unix\_addr->sun\_path)) { /\* On linux, when the path begins with a NUL byte we are \* referring to an abstract namespace. In theory we should \* allow an extra byte below, since we don't need the NULL. \* BUT, to get into this branch of code, the name is too long, \* so we don't care. \*/ xparam->inputs.namelen = sizeof(unix\_addr->sun\_path) - 1; php\_error\_docref(NULL, E\_NOTICE, "socket path exceeded the maximum allowed length of %lu bytes " "and was truncated", (unsigned long)sizeof(unix\_addr->sun\_path)); }
 memcpy(unix\_addr->sun\_path, xparam->inputs.name, xparam->inputs.namelen);
 return 1;}#endif
static inline char \*parse\_ip\_address\_ex(const char \*str, size\_t str\_len, int \*portno, int get\_err, zend\_string \*\*err){ char \*colon; char \*host = NULL;
#ifdef HAVE\_IPV6 if (\*(str) == '[' && str\_len > 1) { /\* IPV6 notation to specify raw address with port (i.e. [fe80::1]:80) \*/ char \*p = memchr(str + 1, ']', str\_len - 2), \*e = NULL; if (!p || \*(p + 1) != ':') { if (get\_err) { \*err = strpprintf(0, "Failed to parse IPv6 address \"%s\"", str); } return NULL; } \*portno = strtol(p + 2, &e, 10); if (e && \*e) { if (get\_err) { \*err = strpprintf(0, "Failed to parse address \"%s\"", str); } return NULL; } return estrndup(str + 1, p - str - 1); }#endif
 if (str\_len) { colon = memchr(str, ':', str\_len - 1); } else { colon = NULL; }
 if (colon) { char \*e = NULL; \*portno = strtol(colon + 1, &e, 10); if (!e || !\*e) { return estrndup(str, colon - str); } }
 if (get\_err) { \*err = strpprintf(0, "Failed to parse address \"%s\"", str); } return NULL;}
static inline char \*parse\_ip\_address(php\_stream\_xport\_param \*xparam, int \*portno){ return parse\_ip\_address\_ex(xparam->inputs.name, xparam->inputs.namelen, portno, xparam->want\_errortext, &xparam->outputs.error\_text);}
static inline int php\_tcp\_sockop\_bind(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam){ char \*host = NULL; int portno, err; long sockopts = STREAM\_SOCKOP\_NONE; zval \*tmpzval = NULL;
#ifdef AF\_UNIX if (stream->ops == &php\_stream\_unix\_socket\_ops || stream->ops == &php\_stream\_unixdg\_socket\_ops) { struct sockaddr\_un unix\_addr;
 sock->socket = socket(PF\_UNIX, stream->ops == &php\_stream\_unix\_socket\_ops ? SOCK\_STREAM : SOCK\_DGRAM, 0);
 if (sock->socket == SOCK\_ERR) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "Failed to create unix%s socket %s", stream->ops == &php\_stream\_unix\_socket\_ops ? "" : "datagram", strerror(errno)); } return -1; }
 parse\_unix\_address(xparam, &unix\_addr);
 return bind(sock->socket, (const struct sockaddr \*)&unix\_addr, (socklen\_t) XtOffsetOf(struct sockaddr\_un, sun\_path) + xparam->inputs.namelen); }#endif
 host = parse\_ip\_address(xparam, &portno);
 if (host == NULL) { return -1; }
#ifdef IPV6\_V6ONLY if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "ipv6\_v6only")) != NULL && Z\_TYPE\_P(tmpzval) != IS\_NULL ) { sockopts |= STREAM\_SOCKOP\_IPV6\_V6ONLY; sockopts |= STREAM\_SOCKOP\_IPV6\_V6ONLY\_ENABLED \* zend\_is\_true(tmpzval); }#endif
#ifdef SO\_REUSEPORT if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_reuseport")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_REUSEPORT; }#endif
#ifdef SO\_BROADCAST if (stream->ops == &php\_stream\_udp\_socket\_ops /\* SO\_BROADCAST is only applicable for UDP \*/ && PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_broadcast")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_BROADCAST; }#endif
 sock->socket = php\_network\_bind\_socket\_to\_local\_addr(host, portno, stream->ops == &php\_stream\_udp\_socket\_ops ? SOCK\_DGRAM : SOCK\_STREAM, sockopts, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err );
 if (host) { efree(host); }
 return sock->socket == -1 ? -1 : 0;}
static inline int php\_tcp\_sockop\_connect(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam){ char \*host = NULL, \*bindto = NULL; int portno, bindport = 0; int err = 0; int ret; zval \*tmpzval = NULL; long sockopts = STREAM\_SOCKOP\_NONE;
#ifdef AF\_UNIX if (stream->ops == &php\_stream\_unix\_socket\_ops || stream->ops == &php\_stream\_unixdg\_socket\_ops) { struct sockaddr\_un unix\_addr;
 sock->socket = socket(PF\_UNIX, stream->ops == &php\_stream\_unix\_socket\_ops ? SOCK\_STREAM : SOCK\_DGRAM, 0);
 if (sock->socket == SOCK\_ERR) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "Failed to create unix socket"); } return -1; }
 parse\_unix\_address(xparam, &unix\_addr);
 ret = php\_network\_connect\_socket(sock->socket, (const struct sockaddr \*)&unix\_addr, (socklen\_t) XtOffsetOf(struct sockaddr\_un, sun\_path) + xparam->inputs.namelen, xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err);
 xparam->outputs.error\_code = err;
 goto out; }#endif
 host = parse\_ip\_address(xparam, &portno);
 if (host == NULL) { return -1; }
 if (PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "bindto")) != NULL) { if (Z\_TYPE\_P(tmpzval) != IS\_STRING) { if (xparam->want\_errortext) { xparam->outputs.error\_text = strpprintf(0, "local\_addr context option is not a string."); } efree(host); return -1; } bindto = parse\_ip\_address\_ex(Z\_STRVAL\_P(tmpzval), Z\_STRLEN\_P(tmpzval), &bindport, xparam->want\_errortext, &xparam->outputs.error\_text); }
#ifdef SO\_BROADCAST if (stream->ops == &php\_stream\_udp\_socket\_ops /\* SO\_BROADCAST is only applicable for UDP \*/ && PHP\_STREAM\_CONTEXT(stream) && (tmpzval = php\_stream\_context\_get\_option(PHP\_STREAM\_CONTEXT(stream), "socket", "so\_broadcast")) != NULL && zend\_is\_true(tmpzval) ) { sockopts |= STREAM\_SOCKOP\_SO\_BROADCAST; }#endif
 /\* Note: the test here for php\_stream\_udp\_socket\_ops is important, because we \* want the default to be TCP sockets so that the openssl extension can \* re-use this code. \*/
 sock->socket = php\_network\_connect\_socket\_to\_host(host, portno, stream->ops == &php\_stream\_udp\_socket\_ops ? SOCK\_DGRAM : SOCK\_STREAM, xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &err, bindto, bindport, sockopts );
 ret = sock->socket == -1 ? -1 : 0; xparam->outputs.error\_code = err;
 if (host) { efree(host); } if (bindto) { efree(bindto); }
#ifdef AF\_UNIXout:#endif
 if (ret >= 0 && xparam->op == STREAM\_XPORT\_OP\_CONNECT\_ASYNC && err == EINPROGRESS) { /\* indicates pending connection \*/ return 1; }
 return ret;}
static inline int php\_tcp\_sockop\_accept(php\_stream \*stream, php\_netstream\_data\_t \*sock, php\_stream\_xport\_param \*xparam STREAMS\_DC){ int clisock;
 xparam->outputs.client = NULL;
 clisock = php\_network\_accept\_incoming(sock->socket, xparam->want\_textaddr ? &xparam->outputs.textaddr : NULL, xparam->want\_addr ? &xparam->outputs.addr : NULL, xparam->want\_addr ? &xparam->outputs.addrlen : NULL, xparam->inputs.timeout, xparam->want\_errortext ? &xparam->outputs.error\_text : NULL, &xparam->outputs.error\_code );
 if (clisock >= 0) { php\_netstream\_data\_t \*clisockdata;
 clisockdata = emalloc(sizeof(\*clisockdata));
 if (clisockdata == NULL) { close(clisock); /\* technically a fatal error \*/ } else { memcpy(clisockdata, sock, sizeof(\*clisockdata)); clisockdata->socket = clisock;
 xparam->outputs.client = php\_stream\_alloc\_rel(stream->ops, clisockdata, NULL, "r+"); if (xparam->outputs.client) { xparam->outputs.client->ctx = stream->ctx; if (stream->ctx) { GC\_REFCOUNT(stream->ctx)++; } } } }
 return xparam->outputs.client == NULL ? -1 : 0;}
static int php\_tcp\_sockop\_set\_option(php\_stream \*stream, int option, int value, void \*ptrparam){ php\_netstream\_data\_t \*sock = (php\_netstream\_data\_t\*)stream->abstract; php\_stream\_xport\_param \*xparam;
 switch(option) { case PHP\_STREAM\_OPTION\_XPORT\_API: xparam = (php\_stream\_xport\_param \*)ptrparam;
 switch(xparam->op) { case STREAM\_XPORT\_OP\_CONNECT: case STREAM\_XPORT\_OP\_CONNECT\_ASYNC: xparam->outputs.returncode = php\_tcp\_sockop\_connect(stream, sock, xparam); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_BIND: xparam->outputs.returncode = php\_tcp\_sockop\_bind(stream, sock, xparam); return PHP\_STREAM\_OPTION\_RETURN\_OK;
 case STREAM\_XPORT\_OP\_ACCEPT: xparam->outputs.returncode = php\_tcp\_sockop\_accept(stream, sock, xparam STREAMS\_CC); return PHP\_STREAM\_OPTION\_RETURN\_OK; default: /\* fall through \*/ ; } } return php\_sockop\_set\_option(stream, option, value, ptrparam);}
PHPAPI php\_stream \*php\_stream\_generic\_socket\_factory(const char \*proto, size\_t protolen, const char \*resourcename, size\_t resourcenamelen, const char \*persistent\_id, int options, int flags, struct timeval \*timeout, php\_stream\_context \*context STREAMS\_DC){ php\_stream \*stream = NULL; php\_netstream\_data\_t \*sock; php\_stream\_ops \*ops;
 /\* which type of socket ? \*/ if (strncmp(proto, "tcp", protolen) == 0) { ops = &php\_stream\_socket\_ops; } else if (strncmp(proto, "udp", protolen) == 0) { ops = &php\_stream\_udp\_socket\_ops; }#ifdef AF\_UNIX else if (strncmp(proto, "unix", protolen) == 0) { ops = &php\_stream\_unix\_socket\_ops; } else if (strncmp(proto, "udg", protolen) == 0) { ops = &php\_stream\_unixdg\_socket\_ops; }#endif else { /\* should never happen \*/ return NULL; }
 sock = pemalloc(sizeof(php\_netstream\_data\_t), persistent\_id ? 1 : 0); memset(sock, 0, sizeof(php\_netstream\_data\_t));
 sock->is\_blocked = 1; sock->timeout.tv\_sec = FG(default\_socket\_timeout); sock->timeout.tv\_usec = 0;
 /\* we don't know the socket until we have determined if we are binding or \* connecting \*/ sock->socket = -1;
 stream = php\_stream\_alloc\_rel(ops, sock, persistent\_id, "r+");
 if (stream == NULL) { pefree(sock, persistent\_id ? 1 : 0); return NULL; }
 if (flags == 0) { return stream; }
 return stream;}
/\* \* Local variables: \* tab-width: 4 \* c-basic-offset: 4 \* End: \* vim600: noet sw=4 ts=4 fdm=marker \* vim<600: noet sw=4 ts=4 \*/

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from bugs.php.net_143a7e6c_20250125_043917.html ===


| [Bugs](/) | [php.net](https://php.net/)¬†|¬† [support](https://php.net/support.php)¬†|¬† [documentation](https://php.net/docs.php)¬†|¬† [report a bug](report.php)¬†|¬† [advanced search](search.php)¬†|¬† [search howto](search-howto.php)¬†|¬† [statistics](stats.php)¬†|¬† [random bug](random)¬†|¬† [login](login.php) |
| --- | --- |
| go to bug id or search bugs for | |

| View [Developer](bug.php?id=74192&edit=1) [Edit](bug.php?id=74192&edit=2)   This bug report is marked as private. |
| --- |

|  | |
| --- | --- |
| [PHP](https://php.net/) [Copyright ¬© 2001-2025 The PHP Group](https://php.net/copyright.php) All rights reserved. | Last updated: Sat Jan 25 04:01:29 2025 UTC |



=== Content from avatars.githubusercontent.com_939a9aa3_20250126_060117.html ===
ÔøΩÔøΩÔøΩÔøΩ JFIF  ` `  ÔøΩÔøΩ ;CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 90
ÔøΩÔøΩ C 



ÔøΩÔøΩ C  

ÔøΩÔøΩ  P P" ÔøΩÔøΩ           
ÔøΩÔøΩ ÔøΩ   } !1AQa"q2ÔøΩÔøΩÔøΩ#BÔøΩÔøΩRÔøΩÔøΩ$3brÔøΩ
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ        
ÔøΩÔøΩ ÔøΩ  w !1AQaq"2ÔøΩBÔøΩÔøΩÔøΩÔøΩ #3RÔøΩbrÔøΩ
$4ÔøΩ%ÔøΩ&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ   ? ÔøΩXÔøΩ5mÔøΩÔøΩ%ÔøΩjÔøΩPÔøΩÔøΩIR4ÔøΩÔøΩÔøΩÔøΩMqÔøΩÔøΩÔøΩ—≠ÔøΩÔøΩJÔøΩ-#-ÔøΩÔøΩÔøΩ ÔøΩÔøΩ>1Î∑∑ ÔøΩÔøΩnZ
=ÔøΩKÔøΩP“ìÔøΩ#ÔøΩqÔøΩÔøΩÔøΩÔøΩÔøΩ[ ®ÔøΩ ÔøΩ`ÔøΩÔøΩ?JÔøΩÔøΩWÔøΩ:cAÔøΩÔøΩ>ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩU&ÔøΩÔøΩÔøΩÔøΩ  ÔøΩAÔøΩÔøΩE÷¨ÔøΩAbÔøΩv3ÔøΩ–∑pyÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ0ÔøΩ7vÔøΩD'1ÔøΩnœß5oI÷µÔøΩ\ÔøΩÔøΩROfÔøΩsÔøΩÔøΩÔøΩÔøΩz∆•UÔøΩRÔøΩGKÔøΩÔøΩPÔøΩtÔøΩgÔøΩ5ÔøΩÔøΩ1ÔøΩÔøΩgÔøΩLlÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ «óÔøΩÔøΩ]ÔøΩOJÔøΩNÔøΩÔøΩwNÔøΩ6NÔøΩF>9ÔøΩÃò>ÔøΩÔøΩ\_jbÔøΩÔøΩÔøΩ.◊õÔøΩ:ÔøΩ»ûcÔøΩ\*ÔøΩ}IÔøΩiD3U|QÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩGÔøΩ#r9 ≤ÔøΩÔøΩÔøΩkMÔøΩ5sÔøΩ|ÔøΩÔøΩÔøΩQÔøΩy?ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ\$eqÔøΩ5ÔøΩÔøΩOÛØïØÔøΩ)ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩƒ•V!ÔøΩWÔøΩA==M}…™ÔøΩVÔøΩ]ÔøΩÔøΩÔøΩÔøΩSYÔøΩ+ÔøΩ-ÔøΩ(ÔøΩÔøΩÔøΩ QÔøΩ¬±tFÔøΩÔøΩ¬°ÔøΩkÔøΩÔøΩ⁄éÔøΩÔøΩAÔøΩÔøΩ?ÔøΩÔøΩÔøΩZÔøΩÔøΩOÔøΩtÔøΩHÔøΩ|ÔøΩÔøΩÔøΩÔøΩZÔøΩÔøΩÔøΩ%ÔøΩÔøΩc-ÔøΩÔøΩÔøΩrÔøΩ¬ê>WÔøΩÔøΩ –ÅÔøΩ7’ûÔøΩI-ÔøΩÔøΩÔøΩÔøΩÔøΩ<#G'\ÔøΩ}1\_ak|ÔøΩ;ÔøΩÔøΩ8ÔøΩeÔøΩÔøΩ∆ùmÔøΩ=ÔøΩÔøΩÔøΩÔøΩÔøΩﬂÖÔøΩÔøΩ Z^ÔøΩÔøΩc+ÔøΩÔøΩÔøΩs»óÔøΩÔøΩO;RÔøΩ&tÔøΩÔøΩÔøΩÔøΩÔøΩo
ÔøΩÔøΩÔøΩY\_Y—â6ÔøΩ=JÔøΩ\_ŒæÔøΩÔøΩÔøΩÔøΩÔøΩ:0ÔøΩ|sÔøΩÔøΩÔøΩxÔøΩO”à.ÔøΩvÔøΩÔøΩÔøΩ,!\_eFÔøΩ /ÔøΩ{v>sÔøΩdN1ÔøΩÔøΩÔøΩ3V\sUÔøΩÔøΩN#"“§m4j76ÔøΩ^MÔøΩÔøΩc^ÔøΩÔøΩÔøΩÔøΩÔøΩEÔøΩ<ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ#Q%tkgsÔøΩÔøΩOÔøΩÔøΩMfÔøΩ&ÔøΩÔøΩÔøΩ.QYÔøΩ ÔøΩPÔøΩ`U>3|3ÔøΩÔøΩÔøΩ~ÔøΩÔøΩgÔøΩÔøΩÔøΩÔøΩD[ÔøΩÔøΩÔøΩn>`ÔøΩÔøΩqÔøΩ0:WÔøΩjÔøΩ nÔøΩÔøΩ-ÔøΩ?iÔøΩ"SÔøΩI ÔøΩÔøΩÔøΩR+ÔøΩ?ÔøΩ?|kÔøΩOÔøΩÔøΩÔøΩh[byL@VÔøΩsÔøΩWÔøΩ&ÔøΩÔøΩÔøΩ–ßÔøΩÔøΩmÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ YÔøΩBÔøΩ;ÔøΩÔøΩÔøΩÔøΩEEÔøΩÔøΩ/LÔøΩ÷ûÔøΩt1ÔøΩ]ÔøΩÔøΩLÔøΩÔøΩWÔøΩ:gÔøΩÔøΩ^ÔøΩÔøΩÔøΩUÔøΩÔøΩÔøΩÔøΩvÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ:ÔøΩZÔøΩÔøΩ ÔøΩÔøΩÔøΩnÔøΩÔøΩ`ÔøΩYN\ÔøΩ‘ßÔøΩÔøΩ«ñh~k
n]?ÔøΩhÔøΩÔøΩÔøΩ3DÔøΩÔøΩÔøΩOÔøΩ^ÔøΩÔøΩ;ÔøΩxzÔøΩÔøΩ{IÔøΩDÔøΩsÔøΩÔøΩ<3ÔøΩÔøΩNÔøΩÔøΩÔøΩÔøΩQ|ÔøΩÔøΩÔøΩÔøΩ:ÔøΩÔøΩ9'ﬂÅ]ÔøΩKÔøΩBÔøΩÔøΩÔøΩÔøΩÔøΩ‹úÔøΩÔøΩÔøΩ5!1ÔøΩÔøΩÔøΩ#}ÔøΩUÔøΩ5<ÔøΩÔøΩUÔøΩÔøΩ=kÔøΩ>t…ÑÔøΩUÔøΩOÔøΩgBÔøΩvÔøΩÔøΩÔøΩÔøΩÔøΩKgWÔøΩ:UÔøΩ
ÔøΩÔøΩkÔøΩÔøΩÔøΩÔøΩEr1ÔøΩ◊çfÔøΩ{ÔøΩÔøΩL@;f[KtÔøΩÔøΩÔøΩÔøΩÔøΩlUÔøΩ7]ÔøΩÔøΩÔøΩ2ÔøΩÔøΩ8'ÔøΩdÔøΩÔøΩxÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ[KÔøΩ:x&ÔøΩoÔøΩÔøΩOÔøΩc}
xÔøΩÔøΩÔøΩM€©ÔøΩxRÔøΩ;MmÔøΩÔøΩÔøΩ>ÔøΩ ÔøΩ3OÔøΩÔøΩÔøΩÔøΩÔøΩU‘Æ ”∞T\_ÔøΩÔøΩ ÔøΩfÔøΩKÔøΩYÔøΩÔøΩ$VWÔøΩ>\*]xÔøΩÔøΩÔøΩ9ÔøΩÔøΩÔøΩÔøΩ5ÔøΩ◊≤'ÔøΩOzÔøΩiÔøΩ:]U="zÔøΩ.m"ÔøΩÔøΩ'~ÔøΩÔøΩuÔøΩt!ÔøΩxgƒõ,-Ó†πÔøΩÔøΩPÔøΩp`ÔøΩ'ÔøΩÔøΩÔøΩÔøΩÔøΩ#ÔøΩVÔøΩ√øÔøΩw:ÔøΩÔøΩ^ÔøΩÔøΩpV;ÔøΩÔøΩs—áLÔøΩuÔøΩagÔøΩM.ÔøΩÔøΩciÔøΩÔøΩoÔøΩÔøΩ2ÔøΩ5Ni(ÔøΩnÔøΩJiÔøΩÎ±ûz"ÔøΩÔøΩKÔøΩR(ÔøΩidsÔøΩD$ÔøΩ +‘ºÔøΩrÔøΩTÔøΩ⁄õÔøΩÔøΩÔøΩ–ÅÔøΩ ÔøΩ\_zÔøΩÔøΩ3ÔøΩÔøΩÔøΩÔøΩÔøΩTÔøΩÔøΩÔøΩÔøΩÔøΩBÔøΩÔøΩ8ÔøΩÔøΩÔøΩÔøΩpkÔøΩÔøΩaO8JÔøΩ$ÔøΩpCsÔøΩÔøΩÔøΩ‘èÔøΩW$ÔøΩÔøΩ'LiÔøΩ]ÔøΩ|fÔøΩÔøΩÔøΩÔøΩWzvÔøΩÔøΩcÔøΩlÔøΩÔøΩ;ÔøΩ›üÔøΩ
ÔøΩÔøΩqÔøΩÔøΩGÔøΩwÔøΩÔøΩ@ÔøΩfSÔøΩ91»Æ'ÔøΩ√´OÔøΩÔøΩ8]3GÔøΩ/nÔøΩhÔøΩÔøΩÔøΩtÔøΩfVf$ÔøΩdÔøΩÔøΩÔøΩÔøΩ’öÔøΩk?
ÔøΩ]ZmÔøΩÔøΩE ©kÔøΩ5ÔøΩ2ÔøΩÔøΩw!ÔøΩHÔøΩgÔøΩQRÔøΩÔøΩÔøΩksÔøΩÔøΩoe&ÔøΩ—úÔøΩœÑ^ÔøΩÔøΩÔøΩ07q]jVÔøΩi.ÔøΩCÔøΩÔøΩÔøΩ>ÔøΩTÔøΩ(ÔøΩtÔøΩÔøΩÔøΩkutÔøΩ"E-ÔøΩÔøΩ@|t>ÔøΩkÔøΩÔøΩP5[ÔøΩÔøΩÔøΩyÔøΩÔøΩÔøΩ9ÔøΩPÔøΩoÔøΩ uXÔøΩÔøΩOZÔøΩ7ÔøΩhwTÔøΩFÔøΩÔøΩ5eoÔøΩÔøΩÔøΩLÔøΩ
ÔøΩÔøΩÔøΩÔøΩ ÔøΩ]ÔøΩÔøΩ?ÔøΩgÔøΩÔøΩ1ÔøΩ3GÔøΩY"ÔøΩÔøΩBÔøΩYÔøΩ?qAÔøΩÔøΩ$ÔøΩÔøΩÔøΩÔøΩk⁄ΩÔøΩÔøΩÌèÜÔøΩ)-'rÔøΩÔøΩ ÔøΩ`pAeÔøΩ1ÔøΩ\_iÔøΩ#ÔøΩ6ÔøΩ
<ÔøΩÔøΩ(ÔøΩq fÔøΩÔøΩW-,ÔøΩ73cÔøΩÔøΩÔøΩÔøΩ6ÔøΩXÔøΩZÔøΩIsLÔøΩ/xfÔøΩÔøΩ61ÔøΩBÔøΩÔøΩiqagÔøΩNÔøΩbÔøΩÔøΩÔøΩÔøΩ÷πÔøΩÔøΩ(oÔøΩYÔøΩÔøΩeÔøΩÔøΩ2ÔøΩÔøΩÔøΩnÔøΩÔøΩnÔøΩx'ÔøΩGo\*ÔøΩÔøΩÔøΩ‘åÔøΩÔøΩ|aysuÔøΩ\_ZG#lÔøΩÔøΩÔøΩxÔøΩ$6ÔøΩÔøΩO¬ù\*ÔøΩÔøΩ"jA-QÔøΩÔøΩ
