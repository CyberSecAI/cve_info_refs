=== Content from rhinosecuritylabs.com_455e5f2e_20250125_165023.html ===


# [Rhino Security Labs](https://rhinosecuritylabs.com)

(888) 944-8679

* [Contact Us](https://rhinosecuritylabs.com/contact/)
* [Get a quote](https://rhinosecuritylabs.com/landing/request-a-quote/)

* [Assessments](/assessment-services/)
  + [Application and Network](https://rhinosecuritylabs.com/assessment-services/web-penetration-testing/)
    - [Web Application Penetration Testing](https://rhinosecuritylabs.com/assessment-services/web-penetration-testing/)
    - [Network Penetration Testing](https://rhinosecuritylabs.com/assessment-services/network-penetration-testing/)
    - [Mobile App Penetration Testing](https://rhinosecuritylabs.com/assessment-services/mobile-app-assessment/)
  + [Cloud Penetration Testing](https://rhinosecuritylabs.com/assessment-services/aws-cloud-penetration-testing/)
    - [AWS Penetration Testing](/assessment-services/aws-cloud-penetration-testing/)
    - [GCP Penetration Testing](https://rhinosecuritylabs.com/assessment-services/gcp-penetration-testing/)
    - [Azure Penetration Testing](https://rhinosecuritylabs.com/assessment-services/azure-penetration-testing/)
  + [Adversary Simulation](https://rhinosecuritylabs.com/assessment-services/red-team-engagement/)
    - [Red Team Assessments](https://rhinosecuritylabs.com/assessment-services/red-team-engagement/)
    - [Email Spear Phishing](https://rhinosecuritylabs.com/assessment-services/social-engineering/email-phishing-assessment/)
    - [Vishing (Voice Call) Testing](https://rhinosecuritylabs.com/assessment-services/social-engineering/vishing-assessments/)
* [Industries](https://rhinosecuritylabs.com/industry/)
  + [Technology](https://rhinosecuritylabs.com/industry/technology/)
  + [Healthcare](https://rhinosecuritylabs.com/industry/healthcare/)
  + [Financial](https://rhinosecuritylabs.com/industry/financial/)
  + [Retail](https://rhinosecuritylabs.com/industry/retail/)
* [Resources](https://rhinosecuritylabs.com/resources/)
  + [Security Blog](https://rhinosecuritylabs.com/blog/)
    - [Penetration Testing AWS Environments](https://rhinosecuritylabs.com/penetration-testing/aws-security-vulnerabilities-and-the-attackers-perspective/)
    - [EasyMP Zeroday Disclosure](https://rhinosecuritylabs.com/research/epson-easymp-remote-projection-vulnerabilities/)
  + [Downloads](https://rhinosecuritylabs.com/resources/)
    - [Ebook: Questions For Every Pentest Vendor](https://rhinosecuritylabs.com/landing/6-questions-ask-pentest-vendors/)
    - [Example Pentest Report](https://rhinosecuritylabs.com/landing/penetration-test-report/)
    - [Penetration Testing FAQ](https://rhinosecuritylabs.com/assessment-services/penetration-testing-faq/)
  + [Security Research](/research-and-vulnerability-disclosure)
    - [Research and Tool Development](https://rhinosecuritylabs.com/research-and-vulnerability-disclosure/#section-1)
    - [Vulnerability Disclosure](/research-and-vulnerability-disclosure/#section-2)
* [Security Blog](https://rhinosecuritylabs.com/blog/)
* [Company](https://rhinosecuritylabs.com/company/)
  + [About Us](https://rhinosecuritylabs.com/company/)
  + [Leadership](https://rhinosecuritylabs.com/company/leadership/)
  + [Careers](https://rhinosecuritylabs.com/careers/)
  + [Company Principles](https://rhinosecuritylabs.com/careers/rhino-company-principles/)

* [Assessments](/assessment-services/)

  [Application and Network](https://rhinosecuritylabs.com/assessment-services/web-penetration-testing/)
  + [Web Application Penetration Testing](https://rhinosecuritylabs.com/assessment-services/web-penetration-testing/)
  + [Network Penetration Testing](https://rhinosecuritylabs.com/assessment-services/network-penetration-testing/)
  + [Mobile App Penetration Testing](https://rhinosecuritylabs.com/assessment-services/mobile-app-assessment/)

  [Cloud Penetration Testing](https://rhinosecuritylabs.com/assessment-services/aws-cloud-penetration-testing/)
  + [AWS Penetration Testing](/assessment-services/aws-cloud-penetration-testing/)
  + [GCP Penetration Testing](https://rhinosecuritylabs.com/assessment-services/gcp-penetration-testing/)
  + [Azure Penetration Testing](https://rhinosecuritylabs.com/assessment-services/azure-penetration-testing/)

  [Adversary Simulation](https://rhinosecuritylabs.com/assessment-services/red-team-engagement/)
  + [Red Team Assessments](https://rhinosecuritylabs.com/assessment-services/red-team-engagement/)
  + [Email Spear Phishing](https://rhinosecuritylabs.com/assessment-services/social-engineering/email-phishing-assessment/)
  + [Vishing (Voice Call) Testing](https://rhinosecuritylabs.com/assessment-services/social-engineering/vishing-assessments/)
* [Industries](https://rhinosecuritylabs.com/industry/)

  + [Technology](https://rhinosecuritylabs.com/industry/technology/)
  + [Healthcare](https://rhinosecuritylabs.com/industry/healthcare/)
  + [Financial](https://rhinosecuritylabs.com/industry/financial/)
  + [Retail](https://rhinosecuritylabs.com/industry/retail/)
* [Resources](https://rhinosecuritylabs.com/resources/)

  [Security Blog](https://rhinosecuritylabs.com/blog/)
  + [Penetration Testing AWS Environments](https://rhinosecuritylabs.com/penetration-testing/aws-security-vulnerabilities-and-the-attackers-perspective/)
  + [EasyMP Zeroday Disclosure](https://rhinosecuritylabs.com/research/epson-easymp-remote-projection-vulnerabilities/)

  [Downloads](https://rhinosecuritylabs.com/resources/)
  + [Ebook: Questions For Every Pentest Vendor](https://rhinosecuritylabs.com/landing/6-questions-ask-pentest-vendors/)
  + [Example Pentest Report](https://rhinosecuritylabs.com/landing/penetration-test-report/)
  + [Penetration Testing FAQ](https://rhinosecuritylabs.com/assessment-services/penetration-testing-faq/)

  [Security Research](/research-and-vulnerability-disclosure)
  + [Research and Tool Development](https://rhinosecuritylabs.com/research-and-vulnerability-disclosure/#section-1)
  + [Vulnerability Disclosure](/research-and-vulnerability-disclosure/#section-2)
* [Security Blog](https://rhinosecuritylabs.com/blog/)
* [Company](https://rhinosecuritylabs.com/company/)

  + [About Us](https://rhinosecuritylabs.com/company/)
  + [Leadership](https://rhinosecuritylabs.com/company/leadership/)
  + [Careers](https://rhinosecuritylabs.com/careers/)
  + [Company Principles](https://rhinosecuritylabs.com/careers/rhino-company-principles/)

[Technical Blog](https://rhinosecuritylabs.com/blog-technical)

[Research](https://rhinosecuritylabs.com/research/)

![](https://rhinosecuritylabs.com/wp-content/uploads/2015/10/Web_App-1140x400.jpg "composite of hands using smartphone with padlock background")
# Unitrends Vulnerability Hunting: Remote Code Execution (CVE-2017-7280) – Chapter 2

Benjamin Caudill

*This is chapter two of a two part series on Remote Code Execution (RCE) vulnerability hunting in Unitrends. Fixes to these bugs are available in the latest Unitrends update.*

*The exploits for the Unitrends vulnerabilities mentioned in this security research series can be found on the [Rhino Security GitHub page](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/exploits/Unitrends).*

[In chapter one of this blog series](https://rhinosecuritylabs.com/resources/remote-code-execution-bug-hunting-chapter-1/), we reviewed two simple examples of remote code execution in Unitrends Enterprise Backup appliances. In this blog we’ll detail another vulnerable function that required more analysis in finding how to reach the vulnerable function. With an application as large as Unitrends, the interface will not always show you how to get to your vulnerable function call; however, with the simple tools of find and grep we’ll be able to trace every call along the way.

## RCE IN /API/INCLUDES/RESTORE.PHP (CVE-2017-7283)

In the last blog, heavy back-tracing of code was not required. Navigating to a change password page is relatively intuitive compared to the example we will look at now. From our first find/grep we saw the /api/includes/restore.php file made several calls to exec and shell\_exec. Digging through the file by searching for shell\_exec, we come upon the function downloadFiles which shows:

![]( "restore_php_code1")

The function control flow is roughly as follows:

1. Look for the ‘filenames’ parameter in $data. Return 500 if not found.
2. Set $filenames to $data[‘filenames’] and create a string from this array based on each filename in $filenames.
3. Get the size of the files by feeding filenames into another php file.

The problem here is that if anyone filename in **$data[‘filenames’]** is tainted, you can achieve code execution through the **shell\_exec** in step 3 from above. So now that we’ve located the vulnerable code, we need to find a way to reach it from the web interface. To do so, I used the grep command line tool (and will walk through it in this example), but there are undoubtedly much better ways to do this and automate such a task.

```
~/scratch/html$ grep -r "downloadFiles(" . | tr -s [:space:]
./ui/app/recover/filerecovery/fileLevelRecoveryController.js: $scope.downloadFiles();
./api/includes/restore.php: return $this->downloadFiles($data, $sid);
./api/includes/restore.php: // which therefore invokes 'download-files' to take the downloadFiles() path. What a nested mess!
./api/includes/restore.php: function downloadFiles($data, $sid) {
./api/includes/restore.php: // get the source's max size limit and let the target verify it in downloadFiles() once it adds up all the file sizes.
```

We see that the *downloadFiles* function called from the same file. Reopening the *restore.php* file, we note that:

The downloadFiles function is called in the ‘download-files’ switch/case statement from a function post, which reads as follows:

```
public function post($which, $data, $sid)
{
    global $Log;

    $sid = $sid !== false ? $sid : $this->BP->get_local_system_id();
    $result = array();
    if (is_string($which[0])) {
        switch ($which[0]) {
        ... other cases ...

        case 'download-files':
            if (isset($data['id']) && $data['id'] !== false) {
                return $this->downloadFilesTargetDir($data, $sid);
            } else {
                return $this->downloadFiles($data, $sid);
            }
            break;
```

The function post is a part of the Restores class. To find an instance of the Restores class, we do another grep to search for each declaration using the “new” keyword.

```
~/scratch/html$ grep -rH "new Restores" . | tr -s [:space:]
./api/includes/appliance.php: $restores = new Restores($this->BP);
./api/includes/appliance.php: $restores = new Restores($this->BP);
```

Inside *appliance.php*, we see the class declaration inside a short function called post\_restore which reads:

```
public function post_restore($which, $data, $sid)
{
    require_once('restore.php');
    $restores = new Restores($this->BP);
    return $restores->post($which, $data, $sid);
}
```

Grepping for post\_restore, we see it’s in ./api/index.php, and executed by the function execute\_post. This function is responsible for dispatching POST requests based on the API endpoint hit, which is specified by the following switch/case snippet:

```
// Check access scheme
$method = $request[0];

... code dealing with request validation and var inits ...

switch ($controller->getMethod()) {
    case 'get':
        $status = 200;
        $Log->enterMethod("GET", $request[0], $data, $sid);
        $body = execute_get($request, $data, $sid, $systems);
        break;
    case 'post':
        // adding item returns Created (201)
        $status = 201;
        $Log->enterMethod("POST", $request[0], $data, $sid);
        $body = execute_post($request, $data, $sid, $systems);
        break;

...

function execute_post($request, $data, $sid, $systems)
{

    ... variable declarations ...

    $method = $request[0];
    switch($method) {
        case 'restore':
            $which = -1;
            if (isset($request[1])) {
                $which = array_splice($request, 1);
            }
            if (is_array($which) and $which[0] == "archive") {
                $which = array_splice($which, 1);
                $body = $archive->restore($which, $data, $sid);
            } else {
                $body = $appliance->post_restore($which, $data, $sid);
            }
            break;
```

To recap, we found a vulnerable function in *restore.php*, then back-traced this function call to see it was a part of a larger custom Restores class object, which is instantiated and called in appliance.php. This is called from the main api/index.php file which dispatches POST requests through execute\_post. If we hit the endpoint */api/restore/download-files* then we will successfully call our function. All that’s left is to pass it the data (in this case ‘filenames’) as a JSON array of filenames.

One caveat for this exploit is that the data we’re populating in the command string is encapsulated by string literals (or single quotes) which are used as pseudo sanitization for our input. An example of this is that the command echo ‘`sleep 10`’ will print the line `sleep 10` to the terminal, but echo “`sleep 10`” will cause the terminal to sleep ten seconds. To circumvent this protection we use the newline character to execute our commands directly. Surrounding our malicious file name with “\n” will cause the terminal to interpret it as:

```
sudo rflr_manage.php –-get-size –-filenames ‘(new line returns this command) $FILENAME (new line submits our malicious filename)‘
```

Below is an example of the payload in action captured from Burp’s interceptor.

This resulted in the file /tmp/pwnd in being created. A python wrapper was created around this web request, and the exploit shown below.

![]( "python-wrapper")

## LFI IN UNITRENDS < 9.1.1 (CVE-2017-7282)

Similarly to the *downloadFiles* vulnerability from above, the function downloadFile has no sanitization performed on the filename. It simply opens up the variable **$filename**, which is passed in the POST request, reads the contents of the file, and returns it to the user. We reach it in a similar fashion as above, except instead of the ‘download-files’ case we must hit the ‘download’ case from the switch statement in restore.php.

![]( "unitrends_python_wrapper")

![]( "unitrends_python_output")

Again, a simple wrapper was made in python to automate this process.

## UNRESTRICTED SUPPORT TICKET ACCESS ON SUPPORT.UNITRENDS.COM

I emailed Unitrends support with the above six issues and had a phone call to determine where they should be submitted. After several days of not hearing back, I decided to make an account on support.unitrends.com to manage each of the six tickets I opened. After registering a new account and navigating to “My Profile and Cases,” I found that I was able to see other customers support tickets, emails, conversations with staff and attachments without any extra overhead.

List of support cases in various degrees of progression (these were not my cases, but other Unitrends customers).

![]( "viewing_unitrends_support_ticket")

When viewing a support ticket, I could chat and impersonate staff and even close the case.

![]( "support_ticket_unitrends")

The attachment of the ticket even revealed the root password of the appliance the customer was using.

![]( "chat_unitrends")

## DISCLOSURE AND REMEDIATION

I was told that these vulnerabilities were resolved in Unitrends 9.1.2, which at the time of writing is not available for free trial on their website. I requested to be issued a copy (or at least a trial) of 9.1.2 to verify the patches but was denied. Therefore, I had no way to check if the issues were resolved without paying for a full copy.

After adequate disclosure time passed and plenty of internal meetings, we decided to move forward and publish the research to the Rhino Security Labs website.

Fast forward to when [Chapter 1](https://rhinosecuritylabs.com/resources/remote-code-execution-bug-hunting-chapter-1/) is published. Rhino Security Labs is contacted by Unitrends. It is determined that there was a breakdown of communication between support and the security team which caused the issue not to be escalated to the proper department. Within a matter of days, Unitrends remediates the issue, and we verify the patch.

## DISCLOSURE AND REMEDIATION TIMELINE

**3/6/2017**: Initial contact with support requesting information on vulnerability disclosures. Told I’d receive more information the following day. No information or follow up came.

**3/8/2017**: Called Unitrends support line, told to forward information to support@unitrends.com. Unitrends Support Case #00429561-00429566 opened.

**3/10/2017**: No information from vendor. Called support line again, was notified all my cases were closed. Support is investigating as to why they were closed without contacting me.

**3/10/2017**: Called again, was told all the bugs had been fixed. Wanted to confirm with the development team, told I couldn’t reach them and had to go through sales and buy an appliance. Called the NW Rep from 3/6/2017 to determine if bug bounty program was available, said the director was on time off. I notified him my tickets were listed as resolved and wanted to confirm. Told I’d have answers/contact info on Monday.

**3/13/2017**: Support confirms this was fixed in 9.1.2 but to verify we must buy a new appliance. Opened another ticket showing how the support website of Unitrends is leaking confidential client information. Told it was a known issue and that it was specific to my account and ticket was closed. (This bug is not unique to one account, but affects all accounts.) Was told this is specific to my account only (which it is not) and my support case was closed. Details will follow upon expiry of the 45-day disclosure policy.

Following is the correspondence from Unitrends Support regarding the six bugs.

Mr. Hohnstein,

We are looking into this issue for you now. Your unitrends area representative, [REMOVED] should be back in contact with you soon to confirm we have addressed these issues. I can tell you that it looks like we have addressed these issues in our latest releases 9.1.2 and 9.2. Please allow [REMOVED] to confirm these for you.

Thank you for using Unitrends Customer Support,

…

(My response)

Hey all,

I downloaded the latest trial version on the site and it doesn’t seem to be up to date with the version you mentioned (9.1.2). Could I get a .ova file to confirm the changes, or know when the latest will be pushed out?

Cheers,

…

Mr. Hohnstein,

We will momentarily be denying and deactivating your community account request. If you wish you may activate and update your trial for 30 days of gold support. 9.1.2 release is only available for 2016 users and 9.2 is available currently(See KB 4078 if you have trouble updating) and replaces 9.1.2.

Thank you for using Unitrends Customer Support.

…

**4/10/2017**: Research published to Rhino Security Lab’s website.

**4/13/2017**: Unitrends Sr. Dev contacts Rhino Security Labs. We agree to work together to test the remediation.

**4/14/2017**: Confirm patches and update. [Unitrends response to CVEs security update](https://support.unitrends.com/UnitrendsBackup/s/article/ka040000000PmFfAAK/000001150).

## CONCLUSION

This interaction exemplifies the need for organizational policies and technical controls to be tested and verified. It is important for employees to be trained and know when to escalate an issue. In the end, a couple of fascinating bugs were found, and a few more CVEs issued. The Unitrends security team was quick to communicate with us to patch the issues, and their customers are a little better off for it.

## Related Resources

![]( "resized_image")
### CloudGoat Official Walkthrough Series: ‘sqs\_flag\_shop’

![]( "image (5)")
### CloudGoat: New Scenario and Walkthrough (sns\_secrets)

![]( "blank_vesta_resized")
### Vestaboard: Exploring Broken Access Controls and Privilege Escalation

## Interested in more information?

20603
[Contact Us Today](https://rhinosecuritylabs.com/contact/)

![]()

##### [Assessment Services](https://rhinosecuritylabs.com/assessment-services/)

* [Network Penetration Test](https://rhinosecuritylabs.com/assessment-services/network-penetration-testing/)
* [Webapp Penetration Test](https://rhinosecuritylabs.com/assessment-services/web-penetration-testing/)
* [AWS Cloud Penetration Testing](https://rhinosecuritylabs.com/assessment-services/aws-cloud-penetration-testing/)
* [GCP Cloud Penetration Testing](https://rhinosecuritylabs.com/assessment-services/gcp-penetration-testing/)
* [Azure Penetration Testing](https://rhinosecuritylabs.com/assessment-services/azure-penetration-testing/)
* [Mobile App Assessment](https://rhinosecuritylabs.com/assessment-services/mobile-app-assessment/)
* [Secure Code Review](https://rhinosecuritylabs.com/assessment-services/secure-code-review/)
* [Social Engineering / Phishing Testing](https://rhinosecuritylabs.com/assessment-services/social-engineering/)
* [Vishing (Voice Call) Testing](https://rhinosecuritylabs.com/assessment-services/social-engineering/vishing-assessments/)
* [Red Team Engagements](https://rhinosecuritylabs.com/assessment-services/red-team-engagement/)

##### [Industries](https://rhinosecuritylabs.com/industry/)

* [Healthcare](https://rhinosecuritylabs.com/industry/healthcare/)
* [Finance](https://rhinosecuritylabs.com/industry/financial/)
* [Technology](https://rhinosecuritylabs.com/industry/technology/)
* [Retail](https://rhinosecuritylabs.com/industry/retail/)

##### [Resources](https://rhinosecuritylabs.com/resources/)

* [Technical Blog](https://rhinosecuritylabs.com/blog-technical/)
* [Strategic Blog](https://rhinosecuritylabs.com/blog-strategic/)
* [Example Pentest Report](https://rhinosecuritylabs.com/landing/penetration-test-report/)
* [Technical Research](https://rhinosecuritylabs.com/research-and-vulnerability-disclosure/)
* [Vulnerability Disclosures](https://rhinosecuritylabs.com/research-and-vulnerability-disclosure/)
* [Disclosure Policy](https://rhinosecuritylabs.com/company/vulnerability-disclosure-policy/)
* [Penetration Testing FAQ](https://rhinosecuritylabs.com/assessment-services/penetration-testing-faq/)
* [Support: AWS Pentest Form](https://rhinosecuritylabs.com/assessment-services/support-aws-penetration-testing-form/)

##### [Company](https://rhinosecuritylabs.com/company/)

* [Leadership](https://rhinosecuritylabs.com/company/leadership/)
* [Blog](https://rhinosecuritylabs.com/blog/)
* [Careers](https://rhinosecuritylabs.com/careers/)
* [Company Principles](https://rhinosecuritylabs.com/careers/rhino-company-principles/)
* [Contact Us](https://rhinosecuritylabs.com/contact/)
* [Get a Quote](https://rhinosecuritylabs.com/request-a-quote/)
* [RSS Feed](https://rhinosecuritylabs.com/blog/feed/)

##### About Us

Rhino Security Labs is a top penetration testing and security assessment firm, with a focus on cloud pentesting (AWS, GCP, Azure), network pentesting, web application pentesting, and phishing.

With manual, deep-dive engagements, we identify security vulnerabilities which put clients at risk.

Endorsed by industry leaders, Rhino Security Labs is a trusted security advisor to the Fortune 500.

info@rhinosecuritylabs.com

(888) 944-8679

Rhino Security Labs, Inc


