```
{
  "cve": "CVE-2017-7346",
  "description": "The 'req->mip_levels' parameter in vmw_gb_surface_define_ioctl() is a user-controlled 'uint32_t' value which is used as a loop count limit. This can lead to a kernel lockup and DoS. Add check for 'req->mip_levels'.",
  "vulnerability_details": {
    "root_cause": "The `req->mip_levels` parameter in `vmw_gb_surface_define_ioctl()` is a user-controlled 32-bit integer that is used as a loop counter without proper validation, leading to excessive iterations.",
    "weaknesses": [
      "Unvalidated user-controlled input used as loop counter.",
      "Missing upper limit check on user-supplied value.",
        "Integer overflow vulnerability could occur as `req->mip_levels` is a `uint32_t`."
    ],
    "impact": "A local unprivileged user can cause a denial of service by triggering a kernel lockup due to an infinite loop.",
    "attack_vectors": [
      "Crafted ioctl call to `/dev/dri/renderD*` device.",
      "User-controlled 'req->mip_levels' parameter."
    ],
    "required_capabilities": "Local unprivileged user with access to `/dev/dri/renderD*` device.",
      "additional_info": "The affected code resides in the `drivers/gpu/drm/vmwgfx/vmwgfx_surface.c` file, specifically within the `vmw_gb_surface_define_ioctl()` function. The `req->mip_levels` parameter, controlled by the user, is used as a loop limit in `svga3dsurface_get_serialized_size()`."
  },
  "patch": {
    "description": "The patch introduces a check to limit the value of `req->mip_levels` parameter to prevent excessive looping.",
      "code_changes": "```diff\n--- a/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c\n+++ b/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c\n@@ -1281,6 +1281,10 @@ int vmw_gb_surface_define_ioctl(struct drm_device *dev, void *data,\n \tif (req->multisample_count != 0)\n \t\treturn -EINVAL;\n \n+\tif (req->mip_levels > DRM_VMW_MAX_SURFACE_FACES *\n+\t    DRM_VMW_MAX_MIP_LEVELS)\n+\t\treturn -EINVAL;\n+\n \tif (unlikely(vmw_user_surface_size == 0))\n \t\tvmw_user_surface_size = ttm_round_pot(sizeof(*user_srf)) +\n \t\t\t128;\n```",
      "added_check": "An upper limit check is added to the `req->mip_levels` parameter before it's used in loops. If the value exceeds `DRM_VMW_MAX_SURFACE_FACES * DRM_VMW_MAX_MIP_LEVELS`, the function returns `-EINVAL`."
  }
}
```