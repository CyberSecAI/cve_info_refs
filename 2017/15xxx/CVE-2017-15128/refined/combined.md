=== Content from bugzilla.redhat.com_599caac6_20250124_194314.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1525222)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1525222)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1525222)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1525222

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1525222**](show_bug.cgi?id=1525222)
(CVE-2017-15128)
- [CVE-2017-15128](https://access.redhat.com/security/cve/CVE-2017-15128) kernel: Out of bound access in hugetlb\_mcopy\_atomic\_pte function in mm/hugetlb.c

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2017-15128 kernel: Out of bound access in hugetlb\_mcopy\_atomic\_pte functi...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2017-15128 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1545043](show_bug.cgi?id=1545043 "CLOSED ERRATA - CVE-2017-15128 kernel: Out of bound access in hugetlb_mcopy_atomic_pte function in mm/hugetlb.c [fedora-all]") [1545044](show_bug.cgi?id=1545044 "CLOSED DUPLICATE - CVE-2017-15128 kernel: Out of bound access in hugetlb_mcopy_atomic_pte function in mm/hugetlb.c [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1518303](show_bug.cgi?id=1518303) | | TreeView+ | [depends on](buglist.cgi?bug_id=1525222&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1525222&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2017-12-12 20:06 UTC by Pedro Sampaio | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-01-19 08:27 UTC ([History](show_activity.cgi?id=1525222)) | | [CC List:](page.cgi?id=fields.html#cclist) | 41 users (show)  agordeev airlied ajax aquini bhu blc bskeggs carnil dhoward ewk fhrbata hdegoede hkrzesin hwkernel-mgr iboverma ichavero itamar jarodwilson jforbes jkacur john.j5live jonathan josef jross jwboyer kernel-maint kernel-mgr lgoncalv linville mchehab mcressma mjg59 mlangsdo nmurray rt-maint rvrbovsk skozina slawomir steved williams wmealing | | Fixed In Version: |  | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A flaw was found in the Linux kernel where a local user with a shell account can abuse the userfaultfd syscall when using hugetlbfs. A missing size check in hugetlb\_mcopy\_atomic\_pte could create an invalid inode variable, leading to a kernel panic. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2021-10-27 10:54:08 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1525222#c0)  Pedro Sampaio    2017-12-12 20:06:23 UTC  ``` A flaw was found in Linux kernel. A lack of size check in hugetlb_mcopy_atomic_pte could cause denial of service.  Upstream patch:  <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1e3921471354244f70fe268586ff94a97a6dd4df>  References:  <https://marc.info/?l=linux-mm&m=150819356125109>   ```  [Comment 1](show_bug.cgi?id=1525222#c1)  Salvatore Bonaccorso    2018-01-08 19:47:50 UTC  ``` Hi Pedro,  The link referenced is not accessible, is this issue <https://marc.info/?l=linux-mm&m=150819356125109> and fixed with upstream 1e3921471354244f70fe268586ff94a97a6dd4df ?  Regards, Salvatore   ```  [Comment 2](show_bug.cgi?id=1525222#c2)  Pedro Sampaio    2018-01-08 20:12:52 UTC  ``` Hi Salvatore,  Yes, I believe so. I didn't realize the link wasn't public.  Thanks.   ```  [Comment 3](show_bug.cgi?id=1525222#c3)  Salvatore Bonaccorso    2018-01-10 19:47:01 UTC  ``` Hi Pedro,  Many thanks for confirming!  Regards, Salvatore   ```  [Comment 8](show_bug.cgi?id=1525222#c8)  Eric Christensen    2018-01-23 15:32:04 UTC  ``` Statement:  This issue does not affect the Linux kernel packages as shipped with Red Hat Enterprise Linux 5 and 6 and kernel-alt.  This issue affects the Linux kernel packages as shipped with Red Hat Enterprise Linux 7, realtime and MRG-2. Future Linux kernel updates for the respective releases may address this issue.   ```  [Comment 11](show_bug.cgi?id=1525222#c11)  Wade Mealing    2018-02-14 06:45:09 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1545043](show_bug.cgi?id=1545043 "CLOSED ERRATA - CVE-2017-15128 kernel: Out of bound access in hugetlb_mcopy_atomic_pte function in mm/hugetlb.c [fedora-all]")]   ```  [Comment 12](show_bug.cgi?id=1525222#c12)  Wade Mealing    2018-02-14 06:45:16 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1545044](show_bug.cgi?id=1545044 "CLOSED DUPLICATE - CVE-2017-15128 kernel: Out of bound access in hugetlb_mcopy_atomic_pte function in mm/hugetlb.c [fedora-all]")]   ```  [Comment 13](show_bug.cgi?id=1525222#c13)  Justin M. Forbes    2018-02-14 14:42:14 UTC  ``` This was fixed for Fedora with the 4.13.12 stable updates.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1525222&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from github.com_687f9657_20250124_194314.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F1e3921471354244f70fe268586ff94a97a6dd4df)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F1e3921471354244f70fe268586ff94a97a6dd4df)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/1e3921471354244f70fe268586ff94a97a6dd4df)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

userfaultfd: hugetlbfs: prevent UFFDIO\_COPY to fill beyond the end of…

[Browse files](/torvalds/linux/tree/1e3921471354244f70fe268586ff94a97a6dd4df)
Browse the repository at this point in the history

```
… i_size

This oops:

  kernel BUG at fs/hugetlbfs/inode.c:484!
  RIP: remove_inode_hugepages+0x3d0/0x410
  Call Trace:
    hugetlbfs_setattr+0xd9/0x130
    notify_change+0x292/0x410
    do_truncate+0x65/0xa0
    do_sys_ftruncate.constprop.3+0x11a/0x180
    SyS_ftruncate+0xe/0x10
    tracesys+0xd9/0xde

was caused by the lack of i_size check in hugetlb_mcopy_atomic_pte.

mmap() can still succeed beyond the end of the i_size after vmtruncate
zapped vmas in those ranges, but the faults must not succeed, and that
includes UFFDIO_COPY.

We could differentiate the retval to userland to represent a SIGBUS like
a page fault would do (vs SIGSEGV), but it doesn't seem very useful and
we'd need to pick a random retval as there's no meaningful syscall
retval that would differentiate from SIGSEGV and SIGBUS, there's just
-EFAULT.

Link: [http://lkml.kernel.org/r/20171016223914.2421-2-aarcange@redhat.com](http://lkml.kernel.org/r/20171016223914.2421-2-aarcange%40redhat.com)
Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>
Reviewed-by: Mike Kravetz <mike.kravetz@oracle.com>
Cc: Mike Rapoport <rppt@linux.vnet.ibm.com>
Cc: "Dr. David Alan Gilbert" <dgilbert@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
```

* Loading branch information

[![@aagit](https://avatars.githubusercontent.com/u/1434545?s=40&v=4)](/aagit) [![@torvalds](https://avatars.githubusercontent.com/u/1024025?s=40&v=4)](/torvalds)

[aagit](/torvalds/linux/commits?author=aagit "View all commits by aagit")
authored and
[torvalds](/torvalds/linux/commits?author=torvalds "View all commits by torvalds")
committed
Nov 3, 2017

1 parent
[5cb0512](/torvalds/linux/commit/5cb0512c02ecd7e6214e912e4c150f4219ac78e0)

commit 1e39214

Showing
**1 changed file**
with
**30 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

32 changes: 30 additions & 2 deletions

32
[mm/hugetlb.c](#diff-fb6066ca63d9afdc2e3660c85e2dcc04cf31b37900ca9df2a1019ee8fa80dce0 "mm/hugetlb.c")

Show comments

[View file](/torvalds/linux/blob/1e3921471354244f70fe268586ff94a97a6dd4df/mm/hugetlb.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3984,6 +3984,9 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, |
|  |  | unsigned long src\_addr, |
|  |  | struct page \*\*pagep) |
|  |  | { |
|  |  | struct address\_space \*mapping; |
|  |  | pgoff\_t idx; |
|  |  | unsigned long size; |
|  |  | int vm\_shared = dst\_vma->vm\_flags & VM\_SHARED; |
|  |  | struct hstate \*h = hstate\_vma(dst\_vma); |
|  |  | pte\_t \_dst\_pte; |
| Expand Down  Expand Up | | @@ -4021,13 +4024,24 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, |
|  |  | \_\_SetPageUptodate(page); |
|  |  | set\_page\_huge\_active(page); |
|  |  |  |
|  |  | mapping = dst\_vma->vm\_file->f\_mapping; |
|  |  | idx = vma\_hugecache\_offset(h, dst\_vma, dst\_addr); |
|  |  |  |
|  |  | /\* |
|  |  | \* If shared, add to page cache |
|  |  | \*/ |
|  |  | if (vm\_shared) { |
|  |  | struct address\_space \*mapping = dst\_vma->vm\_file->f\_mapping; |
|  |  | pgoff\_t idx = vma\_hugecache\_offset(h, dst\_vma, dst\_addr); |
|  |  | size = i\_size\_read(mapping->host) >> huge\_page\_shift(h); |
|  |  | ret = -EFAULT; |
|  |  | if (idx >= size) |
|  |  | goto out\_release\_nounlock; |
|  |  |  |
|  |  | /\* |
|  |  | \* Serialization between remove\_inode\_hugepages() and |
|  |  | \* huge\_add\_to\_page\_cache() below happens through the |
|  |  | \* hugetlb\_fault\_mutex\_table that here must be hold by |
|  |  | \* the caller. |
|  |  | \*/ |
|  |  | ret = huge\_add\_to\_page\_cache(page, mapping, idx); |
|  |  | if (ret) |
|  |  | goto out\_release\_nounlock; |
| Expand All | | @@ -4036,6 +4050,20 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, |
|  |  | ptl = huge\_pte\_lockptr(h, dst\_mm, dst\_pte); |
|  |  | spin\_lock(ptl); |
|  |  |  |
|  |  | /\* |
|  |  | \* Recheck the i\_size after holding PT lock to make sure not |
|  |  | \* to leave any page mapped (as page\_mapped()) beyond the end |
|  |  | \* of the i\_size (remove\_inode\_hugepages() is strict about |
|  |  | \* enforcing that). If we bail out here, we'll also leave a |
|  |  | \* page in the radix tree in the vm\_shared case beyond the end |
|  |  | \* of the i\_size, but remove\_inode\_hugepages() will take care |
|  |  | \* of it as soon as we drop the hugetlb\_fault\_mutex\_table. |
|  |  | \*/ |
|  |  | size = i\_size\_read(mapping->host) >> huge\_page\_shift(h); |
|  |  | ret = -EFAULT; |
|  |  | if (idx >= size) |
|  |  | goto out\_release\_unlock; |
|  |  |  |
|  |  | ret = -EEXIST; |
|  |  | if (!huge\_pte\_none(huge\_ptep\_get(dst\_pte))) |
|  |  | goto out\_release\_unlock; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1e39214`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F1e3921471354244f70fe268586ff94a97a6dd4df) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from git.kernel.org_4f1656be_20250124_194312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=1e3921471354244f70fe268586ff94a97a6dd4df)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1e3921471354244f70fe268586ff94a97a6dd4df)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1e3921471354244f70fe268586ff94a97a6dd4df)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1e3921471354244f70fe268586ff94a97a6dd4df)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrea Arcangeli <aarcange@redhat.com> | 2017-11-02 15:59:29 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2017-11-03 07:39:19 -0700 |
| commit | [1e3921471354244f70fe268586ff94a97a6dd4df](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1e3921471354244f70fe268586ff94a97a6dd4df) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=1e3921471354244f70fe268586ff94a97a6dd4df)) | |
| tree | [d103a318db6e2d238365ff0e585dc56fd1962b1d](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1e3921471354244f70fe268586ff94a97a6dd4df) | |
| parent | [5cb0512c02ecd7e6214e912e4c150f4219ac78e0](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5cb0512c02ecd7e6214e912e4c150f4219ac78e0) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1e3921471354244f70fe268586ff94a97a6dd4df&id2=5cb0512c02ecd7e6214e912e4c150f4219ac78e0)) | |
| download | [linux-1e3921471354244f70fe268586ff94a97a6dd4df.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-1e3921471354244f70fe268586ff94a97a6dd4df.tar.gz) | |

userfaultfd: hugetlbfs: prevent UFFDIO\_COPY to fill beyond the end of i\_sizeThis oops:
kernel BUG at fs/hugetlbfs/inode.c:484!
RIP: remove\_inode\_hugepages+0x3d0/0x410
Call Trace:
hugetlbfs\_setattr+0xd9/0x130
notify\_change+0x292/0x410
do\_truncate+0x65/0xa0
do\_sys\_ftruncate.constprop.3+0x11a/0x180
SyS\_ftruncate+0xe/0x10
tracesys+0xd9/0xde
was caused by the lack of i\_size check in hugetlb\_mcopy\_atomic\_pte.
mmap() can still succeed beyond the end of the i\_size after vmtruncate
zapped vmas in those ranges, but the faults must not succeed, and that
includes UFFDIO\_COPY.
We could differentiate the retval to userland to represent a SIGBUS like
a page fault would do (vs SIGSEGV), but it doesn't seem very useful and
we'd need to pick a random retval as there's no meaningful syscall
retval that would differentiate from SIGSEGV and SIGBUS, there's just
-EFAULT.
Link: [http://lkml.kernel.org/r/20171016223914.2421-2-aarcange@redhat.com](http://lkml.kernel.org/r/20171016223914.2421-2-aarcange%40redhat.com)
Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>
Reviewed-by: Mike Kravetz <mike.kravetz@oracle.com>
Cc: Mike Rapoport <rppt@linux.vnet.ibm.com>
Cc: "Dr. David Alan Gilbert" <dgilbert@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1e3921471354244f70fe268586ff94a97a6dd4df)

| -rw-r--r-- | [mm/hugetlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/mm/hugetlb.c?id=1e3921471354244f70fe268586ff94a97a6dd4df) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/mm/hugetlb.c b/mm/hugetlb.cindex 424b0ef08a60cb..2d2ff5e8bf2bc0 100644--- a/[mm/hugetlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/hugetlb.c?id=5cb0512c02ecd7e6214e912e4c150f4219ac78e0)+++ b/[mm/hugetlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/hugetlb.c?id=1e3921471354244f70fe268586ff94a97a6dd4df)@@ -3984,6 +3984,9 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, unsigned long src\_addr, struct page \*\*pagep) {+ struct address\_space \*mapping;+ pgoff\_t idx;+ unsigned long size; int vm\_shared = dst\_vma->vm\_flags & VM\_SHARED; struct hstate \*h = hstate\_vma(dst\_vma); pte\_t \_dst\_pte;@@ -4021,13 +4024,24 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, \_\_SetPageUptodate(page); set\_page\_huge\_active(page); + mapping = dst\_vma->vm\_file->f\_mapping;+ idx = vma\_hugecache\_offset(h, dst\_vma, dst\_addr);+ /\* \* If shared, add to page cache \*/ if (vm\_shared) {- struct address\_space \*mapping = dst\_vma->vm\_file->f\_mapping;- pgoff\_t idx = vma\_hugecache\_offset(h, dst\_vma, dst\_addr);+ size = i\_size\_read(mapping->host) >> huge\_page\_shift(h);+ ret = -EFAULT;+ if (idx >= size)+ goto out\_release\_nounlock; + /\*+ \* Serialization between remove\_inode\_hugepages() and+ \* huge\_add\_to\_page\_cache() below happens through the+ \* hugetlb\_fault\_mutex\_table that here must be hold by+ \* the caller.+ \*/ ret = huge\_add\_to\_page\_cache(page, mapping, idx); if (ret) goto out\_release\_nounlock;@@ -4036,6 +4050,20 @@ int hugetlb\_mcopy\_atomic\_pte(struct mm\_struct \*dst\_mm, ptl = huge\_pte\_lockptr(h, dst\_mm, dst\_pte); spin\_lock(ptl); + /\*+ \* Recheck the i\_size after holding PT lock to make sure not+ \* to leave any page mapped (as page\_mapped()) beyond the end+ \* of the i\_size (remove\_inode\_hugepages() is strict about+ \* enforcing that). If we bail out here, we'll also leave a+ \* page in the radix tree in the vm\_shared case beyond the end+ \* of the i\_size, but remove\_inode\_hugepages() will take care+ \* of it as soon as we drop the hugetlb\_fault\_mutex\_table.+ \*/+ size = i\_size\_read(mapping->host) >> huge\_page\_shift(h);+ ret = -EFAULT;+ if (idx >= size)+ goto out\_release\_unlock;+ ret = -EEXIST; if (!huge\_pte\_none(huge\_ptep\_get(dst\_pte))) goto out\_release\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-24 19:41:50 +0000



=== Content from access.redhat.com_ba2a40b9_20250126_030908.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.kernel.org_cc99d3f3_20250124_194315.html ===
commit 0da74753f7f9a7adf3b4dfa309ba95386daa2098
Author: Greg Kroah-Hartman
Date: Wed Nov 8 10:17:19 2017 +0100
Linux 4.13.12
commit ebe22ac83eb61c2162fa9ff97b9648ee1cfb8c3d
Author: Antoine Tenart
Date: Wed Oct 25 09:23:26 2017 +0200
irqchip/irq-mvebu-gicp: Add missing spin\_lock init
commit c9bb86338a6bb91e4d32db04feb6b8d423e04d06 upstream.
A spin lock is used in the irq-mvebu-gicp driver, but it is never
initialized. This patch adds the missing spin\_lock\_init() call in the
driver's probe function.
Fixes: a68a63cb4dfc ("irqchip/irq-mvebu-gicp: Add new driver for Marvell GICP")
Signed-off-by: Antoine Tenart
Signed-off-by: Thomas Gleixner
Reviewed-by: gregory.clement@free-electrons.com
Acked-by: marc.zyngier@arm.com
Cc: thomas.petazzoni@free-electrons.com
Cc: andrew@lunn.ch
Cc: jason@lakedaemon.net
Cc: nadavh@marvell.com
Cc: miquel.raynal@free-electrons.com
Cc: linux-arm-kernel@lists.infradead.org
Cc: sebastian.hesselbarth@gmail.com
Link: https://lkml.kernel.org/r/20171025072326.21030-1-antoine.tenart@free-electrons.com
Signed-off-by: Greg Kroah-Hartman
commit 55da524bdf0340ccbe73c7ab77f2a1ec1732bad6
Author: Borislav Petkov
Date: Wed Nov 1 17:47:54 2017 +0100
x86/mcelog: Get rid of RCU remnants
commit 7298f08ea8870d44d36c7d6cd07dd0303faef6c2 upstream.
Jeremy reported a suspicious RCU usage warning in mcelog.
/dev/mcelog is called in process context now as part of the notifier
chain and doesn't need any of the fancy RCU and lockless accesses which
it did in atomic context.
Axe it all in favor of a simple mutex synchronization which cures the
problem reported.
Fixes: 5de97c9f6d85 ("x86/mce: Factor out and deprecate the /dev/mcelog driver")
Reported-by: Jeremy Cline
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-and-tested-by: Tony Luck
Cc: Andi Kleen
Cc: linux-edac@vger.kernel.org
Cc: Laura Abbott
Link: https://lkml.kernel.org/r/20171101164754.xzzmskl4ngrqc5br@pd.tnic
Link: https://bugzilla.redhat.com/show\_bug.cgi?id=1498969
Signed-off-by: Greg Kroah-Hartman
commit 88f41b61b6bd55d01cd2c04f911b2d0dae997287
Author: Tejun Heo
Date: Sat Oct 28 09:49:37 2017 -0700
perf/cgroup: Fix perf cgroup hierarchy support
commit be96b316deff35e119760982c43af74e606fa143 upstream.
The following commit:
864c2357ca89 ("perf/core: Do not set cpuctx->cgrp for unscheduled cgroups")
made list\_update\_cgroup\_event() skip setting cpuctx->cgrp if no cgroup event
targets %current's cgroup.
This breaks perf\_event's hierarchical support because events which target one
of the ancestors get ignored.
Fix it by using cgroup\_is\_descendant() test instead of equality.
Signed-off-by: Tejun Heo
Acked-by: Thomas Gleixner
Cc: Arnaldo Carvalho de Melo
Cc: David Carrillo-Cisneros
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: kernel-team@fb.com
Fixes: 864c2357ca89 ("perf/core: Do not set cpuctx->cgrp for unscheduled cgroups")
Link: http://lkml.kernel.org/r/20171028164237.GA972780@devbig577.frc2.facebook.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit ce0eadf4b1bdeabecb9e31dfe39d292767f9febc
Author: Peter Zijlstra
Date: Tue Oct 31 11:18:53 2017 +0100
futex: Fix more put\_pi\_state() vs. exit\_pi\_state\_list() races
commit 153fbd1226fb30b8630802aa5047b8af5ef53c9f upstream.
Dmitry (through syzbot) reported being able to trigger the WARN in
get\_pi\_state() and a use-after-free on:
raw\_spin\_lock\_irq(π\_state->pi\_mutex.wait\_lock);
Both are due to this race:
exit\_pi\_state\_list() put\_pi\_state()
lock(&curr->pi\_lock)
while() {
pi\_state = list\_first\_entry(head);
hb = hash\_futex(π\_state->key);
unlock(&curr->pi\_lock);
dec\_and\_test(π\_state->refcount);
lock(&hb->lock)
lock(π\_state->pi\_mutex.wait\_lock) // uaf if pi\_state free'd
lock(&curr->pi\_lock);
....
unlock(&curr->pi\_lock);
get\_pi\_state(); // WARN; refcount==0
The problem is we take the reference count too late, and don't allow it
being 0. Fix it by using inc\_not\_zero() and simply retrying the loop
when we fail to get a refcount. In that case put\_pi\_state() should
remove the entry from the list.
Reported-by: Dmitry Vyukov
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Thomas Gleixner
Cc: Gratian Crisan
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: dvhart@infradead.org
Cc: syzbot
Cc: syzkaller-bugs@googlegroups.com
Fixes: c74aef2d06a9 ("futex: Fix pi\_state->owner serialization")
Link: http://lkml.kernel.org/r/20171031101853.xpfh72y643kdfhjs@hirez.programming.kicks-ass.net
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit a351eccfb5354b409d01c213910be85429e244c4
Author: Naveen N. Rao
Date: Mon Oct 30 20:42:09 2017 +0530
powerpc/kprobes: Dereference function pointers only if the address does not belong to kernel text
commit e6c4dcb308160115287afd87afb63b5684d75a5b upstream.
This makes the changes introduced in commit 83e840c770f2c5
("powerpc64/elfv1: Only dereference function descriptor for non-text
symbols") to be specific to the kprobe subsystem.
We previously changed ppc\_function\_entry() to always check the provided
address to confirm if it needed to be dereferenced. This is actually
only an issue for kprobe blacklisted asm labels (through use of
\_ASM\_NOKPROBE\_SYMBOL) and can cause other issues with ftrace. Also, the
additional checks are not really necessary for our other uses.
As such, move this check to the kprobes subsystem.
Fixes: 83e840c770f2 ("powerpc64/elfv1: Only dereference function descriptor for non-text symbols")
Signed-off-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit bcef2ac5fefcd273db50d4bad47f69266d3aba0b
Author: Rafael J. Wysocki
Date: Fri Nov 3 16:35:49 2017 +0100
x86: CPU: Fix up "cpu MHz" in /proc/cpuinfo
commit 941f5f0f6ef5338814145cf2b813cf1f98873e2f upstream.
Commit 890da9cf0983 (Revert "x86: do not use cpufreq\_quick\_get() for
/proc/cpuinfo "cpu MHz"") is not sufficient to restore the previous
behavior of "cpu MHz" in /proc/cpuinfo on x86 due to some changes
made after the commit it has reverted.
To address this, make the code in question use arch\_freq\_get\_on\_cpu()
which also is used by cpufreq for reporting the current frequency of
CPUs and since that function doesn't really depend on cpufreq in any
way, drop the CONFIG\_CPU\_FREQ dependency for the object file
containing it.
Also refactor arch\_freq\_get\_on\_cpu() somewhat to avoid IPIs and
return cached values right away if it is called very often over a
short time (to prevent user space from triggering IPI storms through
it).
Fixes: 890da9cf0983 (Revert "x86: do not use cpufreq\_quick\_get() for /proc/cpuinfo "cpu MHz"")
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit cce587de30c755abe0187c2639ac6154d38eef0e
Author: Linus Torvalds
Date: Thu Nov 2 14:06:32 2017 -0700
Revert "x86: do not use cpufreq\_quick\_get() for /proc/cpuinfo "cpu MHz""
commit 890da9cf098364b11a7f7f5c22fa652531624d03 upstream.
This reverts commit 51204e0639c49ada02fd823782ad673b6326d748.
There wasn't really any good reason for it, and people are complaining
(rightly) that it broke existing practice.
Cc: Len Brown
Cc: Thomas Gleixner
Cc: Rafael J. Wysocki
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 539954a756f7749bae8775bdaae3ff4d477fa1e7
Author: Matt Redfearn
Date: Wed Sep 27 10:13:25 2017 +0100
MIPS: SMP: Fix deadlock & online race
commit 9e8c399a88f0b87e41a894911475ed2a8f8dff9e upstream.
Commit 6f542ebeaee0 ("MIPS: Fix race on setting and getting
cpu\_online\_mask") effectively reverted commit 8f46cca1e6c06 ("MIPS: SMP:
Fix possibility of deadlock when bringing CPUs online") and thus has
reinstated the possibility of deadlock.
The commit was based on testing of kernel v4.4, where the CPU hotplug
core code issued a BUG() if the starting CPU is not marked online when
the boot CPU returns from \_\_cpu\_up. The commit fixes this race (in
v4.4), but re-introduces the deadlock situation.
As noted in the commit message, upstream differs in this area. Commit
8df3e07e7f21f ("cpu/hotplug: Let upcoming cpu bring itself fully up")
adds a completion event in the CPU hotplug core code, making this race
impossible. However, people were unhappy with relying on the core code
to do the right thing.
To address the issues both commits were trying to fix, add a second
completion event in the MIPS smp hotplug path. It removes the
possibility of a race, since the MIPS smp hotplug code now synchronises
both the boot and secondary CPUs before they return to the hotplug core
code. It also addresses the deadlock by ensuring that the secondary CPU
is not marked online before it's counters are synchronised.
This fix should also be backported to fix the race condition introduced
by the backport of commit 8f46cca1e6c06 ("MIPS: SMP: Fix possibility of
deadlock when bringing CPUs online"), through really that race only
existed before commit 8df3e07e7f21f ("cpu/hotplug: Let upcoming cpu
bring itself fully up").
Signed-off-by: Matt Redfearn
Fixes: 6f542ebeaee0 ("MIPS: Fix race on setting and getting cpu\_online\_mask")
CC: Matija Glavinic Pecotic
Patchwork: https://patchwork.linux-mips.org/patch/17376/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit dac72696c96b9e109a3a7b04fafa276a7343fb9a
Author: Gustavo A. R. Silva
Date: Tue Oct 31 00:35:03 2017 -0500
MIPS: microMIPS: Fix incorrect mask in insn\_table\_MM
commit 77238e76b9156d28d86c1e31c00ed2960df0e4de upstream.
It seems that this is a typo error and the proper bit masking is
"RT | RS" instead of "RS | RS".
This issue was detected with the help of Coccinelle.
Fixes: d6b3314b49e1 ("MIPS: uasm: Add lh uam instruction")
Reported-by: Julia Lawall
Signed-off-by: Gustavo A. R. Silva
Reviewed-by: James Hogan
Patchwork: https://patchwork.linux-mips.org/patch/17551/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit f7db1164658a70da1fbdfa1599a15b3cb82b1b0b
Author: Jason A. Donenfeld
Date: Mon Oct 23 19:20:56 2017 +0200
MIPS: smp-cmp: Use right include for task\_struct
commit f677b77050c144bd4c515b91ea48bd0efe82355e upstream.
When task\_struct was moved, this MIPS code was neglected. Evidently
nobody is using it anymore. This fixes this build error:
In file included from ./arch/mips/include/asm/thread\_info.h:15:0,
from ./include/linux/thread\_info.h:37,
from ./include/asm-generic/current.h:4,
from ./arch/mips/include/generated/asm/current.h:1,
from ./include/linux/sched.h:11,
from arch/mips/kernel/smp-cmp.c:22:
arch/mips/kernel/smp-cmp.c: In function ‘cmp\_boot\_secondary’:
./arch/mips/include/asm/processor.h:384:41: error: implicit declaration
of function ‘task\_stack\_page’ [-Werror=implicit-function-declaration]
#define \_\_KSTK\_TOS(tsk) ((unsigned long)task\_stack\_page(tsk) + \
^
arch/mips/kernel/smp-cmp.c:84:21: note: in expansion of macro ‘\_\_KSTK\_TOS’
unsigned long sp = \_\_KSTK\_TOS(idle);
^~~~~~~~~~
Fixes: f3ac60671954 ("sched/headers: Move task-stack related APIs from  to ")
Signed-off-by: Jason A. Donenfeld
Patchwork: https://patchwork.linux-mips.org/patch/17522/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit 6208dab1193995b5d327cfe71e301295340d3342
Author: Wei Yongjun
Date: Fri Oct 13 09:25:17 2017 +0000
MIPS: bpf: Fix a typo in build\_one\_insn()
commit 6a2932a463d526e362a6b4e112be226f1d18d088 upstream.
Fix a typo in build\_one\_insn().
Fixes: b6bd53f9c4e8 ("MIPS: Add missing file for eBPF JIT.")
Signed-off-by: Wei Yongjun
Patchwork: https://patchwork.linux-mips.org/patch/17491/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit 9a0422b63d96a15aa253b3aae55a21e1b418468b
Author: Naveen N. Rao
Date: Mon Oct 30 20:42:08 2017 +0530
Revert "powerpc64/elfv1: Only dereference function descriptor for non-text symbols"
commit 63be1a81e40733ecd175713b6a7558dc43f00851 upstream.
This reverts commit 83e840c770f2c5 ("powerpc64/elfv1: Only dereference
function descriptor for non-text symbols").
Chandan reported that on newer kernels, trying to enable function\_graph
tracer on ppc64 (BE) locks up the system with the following trace:
Unable to handle kernel paging request for data at address 0x600000002fa30010
Faulting instruction address: 0xc0000000001f1300
Thread overran stack, or stack corrupted
Oops: Kernel access of bad area, sig: 11 [#1]
BE SMP NR\_CPUS=2048 DEBUG\_PAGEALLOC NUMA pSeries
Modules linked in:
CPU: 1 PID: 6586 Comm: bash Not tainted 4.14.0-rc3-00162-g6e51f1f-dirty #20
task: c000000625c07200 task.stack: c000000625c07310
NIP: c0000000001f1300 LR: c000000000121cac CTR: c000000000061af8
REGS: c000000625c088c0 TRAP: 0380 Not tainted (4.14.0-rc3-00162-g6e51f1f-dirty)
MSR: 8000000000001032  CR: 28002848 XER: 00000000
CFAR: c0000000001f1320 SOFTE: 0
...
NIP [c0000000001f1300] .\_\_is\_insn\_slot\_addr+0x30/0x90
LR [c000000000121cac] .kernel\_text\_address+0x18c/0x1c0
Call Trace:
[c000000625c08b40] [c0000000001bd040] .is\_module\_text\_address+0x20/0x40 (unreliable)
[c000000625c08bc0] [c000000000121cac] .kernel\_text\_address+0x18c/0x1c0
[c000000625c08c50] [c000000000061960] .prepare\_ftrace\_return+0x50/0x130
[c000000625c08cf0] [c000000000061b10] .ftrace\_graph\_caller+0x14/0x34
[c000000625c08d60] [c000000000121b40] .kernel\_text\_address+0x20/0x1c0
[c000000625c08df0] [c000000000061960] .prepare\_ftrace\_return+0x50/0x130
...
[c000000625c0ab30] [c000000000061960] .prepare\_ftrace\_return+0x50/0x130
[c000000625c0abd0] [c000000000061b10] .ftrace\_graph\_caller+0x14/0x34
[c000000625c0ac40] [c000000000121b40] .kernel\_text\_address+0x20/0x1c0
[c000000625c0acd0] [c000000000061960] .prepare\_ftrace\_return+0x50/0x130
[c000000625c0ad70] [c000000000061b10] .ftrace\_graph\_caller+0x14/0x34
[c000000625c0ade0] [c000000000121b40] .kernel\_text\_address+0x20/0x1c0
This is because ftrace is using ppc\_function\_entry() for obtaining the
address of return\_to\_handler() in prepare\_ftrace\_return(). The call to
kernel\_text\_address() itself gets traced and we end up in a recursive
loop.
Fixes: 83e840c770f2 ("powerpc64/elfv1: Only dereference function descriptor for non-text symbols")
Reported-by: Chandan Rajendra
Signed-off-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 105a9eaea219a4febf3a722b592d7896d8ce86f7
Author: Jani Nikula
Date: Thu Oct 26 17:29:31 2017 +0300
drm/i915/edp: read edp display control registers unconditionally
commit 7c838e2a9be5ab79b11c7f1520813bfdf0f45462 upstream.
Per my reading of the eDP spec, DP\_DPCD\_DISPLAY\_CONTROL\_CAPABLE bit in
DP\_EDP\_CONFIGURATION\_CAP should be set if the eDP display control
registers starting at offset DP\_EDP\_DPCD\_REV are "enabled". Currently we
check the bit before reading the registers, and DP\_EDP\_DPCD\_REV is the
only way to detect eDP revision.
Turns out there are (likely buggy) displays that require eDP 1.4+
features, such as supported link rates and link rate select, but do not
have the bit set. Read the display control registers
unconditionally. They are supposed to read zero anyway if they are not
supported, so there should be no harm in this.
This fixes the referenced bug by enabling the eDP version check, and
thus reading of the supported link rates. The panel in question has 0 in
DP\_MAX\_LINK\_RATE which is only supported in eDP 1.4+. Without the
supported link rates method we default to RBR which is insufficient for
the panel native mode. As a curiosity, the panel also has a bogus value
of 0x12 in DP\_EDP\_DPCD\_REV, but that passes our check for >= DP\_EDP\_14
(which is 0x03).
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=103400
Reported-and-tested-by: Nicolas P.
Cc: Ville Syrjälä
Reviewed-by: Ville Syrjälä
Reviewed-by: Manasi Navare
Signed-off-by: Jani Nikula
Link: https://patchwork.freedesktop.org/patch/msgid/20171026142932.17737-1-jani.nikula@intel.com
(cherry picked from commit 0501a3b0eb01ac2209ef6fce76153e5d6b07034e)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Greg Kroah-Hartman
commit b2f619861327dc3332df750b4983e100448e7539
Author: Maarten Lankhorst
Date: Thu Oct 19 17:13:40 2017 +0200
drm/i915: Do not rely on wm preservation for ILK watermarks
commit 8777b927b92cf5b6c29f9f9d3c737addea9ac8a7 upstream.
The original intent was to preserve watermarks as much as possible
in intel\_pipe\_wm.raw\_wm, and put the validated ones in intel\_pipe\_wm.wm.
It seems this approach is insufficient and we don't always preserve
the raw watermarks, so just use the atomic iterator we're already using
to get a const pointer to all bound planes on the crtc.
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=102373
Signed-off-by: Maarten Lankhorst
Acked-by: Ville Syrjälä
Reviewed-by: Matt Roper
Link: https://patchwork.freedesktop.org/patch/msgid/20171019151341.4579-1-maarten.lankhorst@linux.intel.com
(cherry picked from commit 28283f4f359cd7cfa9e65457bb98c507a2cd0cd0)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Greg Kroah-Hartman
commit d549cb65b7982ddec3ef17d398e7d893a9d3705f
Author: Huang Ying
Date: Thu Nov 2 15:59:50 2017 -0700
mm, swap: fix race between swap count continuation operations
commit 2628bd6fc052bd85e9864dae4de494d8a6313391 upstream.
One page may store a set of entries of the sis->swap\_map
(swap\_info\_struct->swap\_map) in multiple swap clusters.
If some of the entries has sis->swap\_map[offset] > SWAP\_MAP\_MAX,
multiple pages will be used to store the set of entries of the
sis->swap\_map. And the pages are linked with page->lru. This is called
swap count continuation. To access the pages which store the set of
entries of the sis->swap\_map simultaneously, previously, sis->lock is
used. But to improve the scalability of \_\_swap\_duplicate(), swap
cluster lock may be used in swap\_count\_continued() now. This may race
with add\_swap\_count\_continuation() which operates on a nearby swap
cluster, in which the sis->swap\_map entries are stored in the same page.
The race can cause wrong swap count in practice, thus cause unfreeable
swap entries or software lockup, etc.
To fix the race, a new spin lock called cont\_lock is added to struct
swap\_info\_struct to protect the swap count continuation page list. This
is a lock at the swap device level, so the scalability isn't very well.
But it is still much better than the original sis->lock, because it is
only acquired/released when swap count continuation is used. Which is
considered rare in practice. If it turns out that the scalability
becomes an issue for some workloads, we can split the lock into some
more fine grained locks.
Link: http://lkml.kernel.org/r/20171017081320.28133-1-ying.huang@intel.com
Fixes: 235b62176712 ("mm/swap: add cluster lock")
Signed-off-by: "Huang, Ying"
Cc: Johannes Weiner
Cc: Shaohua Li
Cc: Tim Chen
Cc: Michal Hocko
Cc: Aaron Lu
Cc: Dave Hansen
Cc: Andi Kleen
Cc: Minchan Kim
Cc: Hugh Dickins
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8cc334b76a24231c2a76d58cb1c9f3889315c009
Author: Mike Kravetz
Date: Thu Nov 2 15:59:41 2017 -0700
fs/hugetlbfs/inode.c: fix hwpoison reserve accounting
commit ab615a5b879292e83653be60aa82113f7c6f462d upstream.
Calling madvise(MADV\_HWPOISON) on a hugetlbfs page will result in bad
(negative) reserved huge page counts. This may not happen immediately,
but may happen later when the underlying file is removed or filesystem
unmounted. For example:
AnonHugePages: 0 kB
ShmemHugePages: 0 kB
HugePages\_Total: 1
HugePages\_Free: 0
HugePages\_Rsvd: 18446744073709551615
HugePages\_Surp: 0
Hugepagesize: 2048 kB
In routine hugetlbfs\_error\_remove\_page(), hugetlb\_fix\_reserve\_counts is
called after remove\_huge\_page. hugetlb\_fix\_reserve\_counts is designed
to only be called/used only if a failure is returned from
hugetlb\_unreserve\_pages. Therefore, call hugetlb\_unreserve\_pages as
required and only call hugetlb\_fix\_reserve\_counts in the unlikely event
that hugetlb\_unreserve\_pages returns an error.
Link: http://lkml.kernel.org/r/20171019230007.17043-2-mike.kravetz@oracle.com
Fixes: 78bb920344b8 ("mm: hwpoison: dissolve in-use hugepage in unrecoverable memory error")
Signed-off-by: Mike Kravetz
Acked-by: Naoya Horiguchi
Cc: Michal Hocko
Cc: Aneesh Kumar
Cc: Anshuman Khandual
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 90d3078dfd76a872d96a555c846fe588f596bdb8
Author: Ashish Samant
Date: Thu Nov 2 15:59:37 2017 -0700
ocfs2: fstrim: Fix start offset of first cluster group during fstrim
commit 105ddc93f06ebe3e553f58563d11ed63dbcd59f0 upstream.
The first cluster group descriptor is not stored at the start of the
group but at an offset from the start. We need to take this into
account while doing fstrim on the first cluster group. Otherwise we
will wrongly start fstrim a few blocks after the desired start block and
the range can cross over into the next cluster group and zero out the
group descriptor there. This can cause filesytem corruption that cannot
be fixed by fsck.
Link: http://lkml.kernel.org/r/1507835579-7308-1-git-send-email-ashish.samant@oracle.com
Signed-off-by: Ashish Samant
Reviewed-by: Junxiao Bi
Reviewed-by: Joseph Qi
Cc: Mark Fasheh
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c14ee6986103f9232c99de035a996547faba6371
Author: Andrea Arcangeli
Date: Thu Nov 2 15:59:29 2017 -0700
userfaultfd: hugetlbfs: prevent UFFDIO\_COPY to fill beyond the end of i\_size
commit 1e3921471354244f70fe268586ff94a97a6dd4df upstream.
This oops:
kernel BUG at fs/hugetlbfs/inode.c:484!
RIP: remove\_inode\_hugepages+0x3d0/0x410
Call Trace:
hugetlbfs\_setattr+0xd9/0x130
notify\_change+0x292/0x410
do\_truncate+0x65/0xa0
do\_sys\_ftruncate.constprop.3+0x11a/0x180
SyS\_ftruncate+0xe/0x10
tracesys+0xd9/0xde
was caused by the lack of i\_size check in hugetlb\_mcopy\_atomic\_pte.
mmap() can still succeed beyond the end of the i\_size after vmtruncate
zapped vmas in those ranges, but the faults must not succeed, and that
includes UFFDIO\_COPY.
We could differentiate the retval to userland to represent a SIGBUS like
a page fault would do (vs SIGSEGV), but it doesn't seem very useful and
we'd need to pick a random retval as there's no meaningful syscall
retval that would differentiate from SIGSEGV and SIGBUS, there's just
-EFAULT.
Link: http://lkml.kernel.org/r/20171016223914.2421-2-aarcange@redhat.com
Signed-off-by: Andrea Arcangeli
Reviewed-by: Mike Kravetz
Cc: Mike Rapoport
Cc: "Dr. David Alan Gilbert"
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3434b0117daee0715869f14820055fd3049d0d8b
Author: Leo Liu
Date: Tue Oct 31 21:12:35 2017 -0400
drm/amdgpu: allow harvesting check for Polaris VCE
commit 32bec2afa525149288e6696079bc85f747fa2138 upstream.
Fixes init failures on Polaris cards with harvested
VCE blocks.
Signed-off-by: Leo Liu
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 54321757bf833ff26ead68c62871c9b44f8efa5b
Author: Leo Liu
Date: Tue Oct 31 21:03:39 2017 -0400
drm/amdgpu: return -ENOENT from uvd 6.0 early init for harvesting
commit cb4b02d7cac56a69d8137d8d843507cca9182aed upstream.
Fixes init failures on polaris cards with harvested UVD.
Signed-off-by: Leo Liu
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 85fc63d11ba390797df9a0a52c0964c4328b3b3e
Author: Arnd Bergmann
Date: Fri Oct 20 21:17:05 2017 +0100
ARM: 8715/1: add a private asm/unaligned.h
commit 1cce91dfc8f7990ca3aea896bfb148f240b12860 upstream.
The asm-generic/unaligned.h header provides two different implementations
for accessing unaligned variables: the access\_ok.h version used when
CONFIG\_HAVE\_EFFICIENT\_UNALIGNED\_ACCESS is set pretends that all pointers
are in fact aligned, while the le\_struct.h version convinces gcc that the
alignment of a pointer is '1', to make it issue the correct load/store
instructions depending on the architecture flags.
On ARMv5 and older, we always use the second version, to let the compiler
use byte accesses. On ARMv6 and newer, we currently use the access\_ok.h
version, so the compiler can use any instruction including stm/ldm and
ldrd/strd that will cause an alignment trap. This trap can significantly
impact performance when we have to do a lot of fixups and, worse, has
led to crashes in the LZ4 decompressor code that does not have a trap
handler.
This adds an ARM specific version of asm/unaligned.h that uses the
le\_struct.h/be\_struct.h implementation unconditionally. This should lead
to essentially the same code on ARMv6+ as before, with the exception of
using regular load/store instructions instead of the trapping instructions
multi-register variants.
The crash in the LZ4 decompressor code was probably introduced by the
patch replacing the LZ4 implementation, commit 4e1a33b105dd ("lib: update
LZ4 compressor module"), so linux-4.11 and higher would be affected most.
However, we probably want to have this backported to all older stable
kernels as well, to help with the performance issues.
There are two follow-ups that I think we should also work on, but not
backport to stable kernels, first to change the asm-generic version of
the header to remove the ARM special case, and second to review all
other uses of CONFIG\_HAVE\_EFFICIENT\_UNALIGNED\_ACCESS to see if they
might be affected by the same problem on ARM.
Signed-off-by: Arnd Bergmann
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 1ac353495acd90072a9e33f38fafb5cf07390593
Author: Yan Markman
Date: Sun Oct 16 00:22:32 2016 +0300
ARM: dts: mvebu: pl310-cache disable double-linefill
commit cda80a82ac3e89309706c027ada6ab232be1d640 upstream.
Under heavy system stress mvebu SoC using Cortex A9 sporadically
encountered instability issues.
The "double linefill" feature of L2 cache was identified as causing
dependency between read and write which lead to the deadlock.
Especially, it was the cause of deadlock seen under heavy PCIe traffic,
as this dependency violates PCIE overtaking rule.
Fixes: c8f5a878e554 ("ARM: mvebu: use DT properties to fine-tune the L2 configuration")
Signed-off-by: Yan Markman
Signed-off-by: Igal Liberman
Signed-off-by: Nadav Haklai
[gregory.clement@free-electrons.com: reformulate commit log, add Armada
375 and add Fixes tag]
Signed-off-by: Gregory CLEMENT
Signed-off-by: Greg Kroah-Hartman
commit 7a598f936b4b748ab1287c5d76ae203153ff5bd6
Author: Julien Thierry
Date: Fri Oct 20 12:34:17 2017 +0100
arm/arm64: kvm: Disable branch profiling in HYP code
commit f9b269f3098121b5d54aaf822e0898c8ed1d3fec upstream.
When HYP code runs into branch profiling code, it attempts to jump to
unmapped memory, causing a HYP Panic.
Disable the branch profiling for code designed to run at HYP mode.
Signed-off-by: Julien Thierry
Acked-by: Marc Zyngier
Cc: Christoffer Dall
Cc: Catalin Marinas
Cc: Will Deacon
Cc: Russell King
Signed-off-by: Christoffer Dall
Signed-off-by: Greg Kroah-Hartman
commit f82ec727d7f29868c69bb382024f6c6bb31dcbbd
Author: Dongjiu Geng
Date: Tue Oct 17 22:23:49 2017 +0800
arm/arm64: KVM: set right LR register value for 32 bit guest when inject abort
commit fd6c8c206fc5d0717b0433b191de0715122f33bb upstream.
When a exception is trapped to EL2, hardware uses ELR\_ELx to hold
the current fault instruction address. If KVM wants to inject a
abort to 32 bit guest, it needs to set the LR register for the
guest to emulate this abort happened in the guest. Because ARM32
architecture is pipelined execution, so the LR value has an offset to
the fault instruction address.
The offsets applied to Link value for exceptions as shown below,
which should be added for the ARM32 link register(LR).
Table taken from ARMv8 ARM DDI0487B-B, table G1-10:
Exception Offset, for PE state of:
A32 T32
Undefined Instruction +4 +2
Prefetch Abort +4 +4
Data Abort +8 +8
IRQ or FIQ +4 +4
[ Removed unused variables in inject\_abt to avoid compile warnings.
-- Christoffer ]
Signed-off-by: Dongjiu Geng
Tested-by: Haibin Zhang
Reviewed-by: Marc Zyngier
Signed-off-by: Christoffer Dall
Signed-off-by: Greg Kroah-Hartman
commit d5ccf4125420a4b1d36f2ff4f0554ae75827db16
Author: Christoffer Dall
Date: Fri Oct 13 11:40:11 2017 +0200
KVM: arm64: its: Fix missing dynamic allocation check in scan\_its\_table
commit 8c1a8a32438b95792bbd8719d1cd4fe36e9eba03 upstream.
We currently allocate an entry dynamically, but we never check if the
allocation actually succeeded. We actually don't need a dynamic
allocation, because we know the maximum size of an ITS table entry, so
we can simply use an allocation on the stack.
Signed-off-by: Christoffer Dall
Signed-off-by: Greg Kroah-Hartman
commit eafa1e5b1dd5f09fd99aba2a5af00282fad6e089
Author: Mark Rutland
Date: Thu Nov 2 16:12:03 2017 +0000
arm64: ensure \_\_dump\_instr() checks addr\_limit
commit 7a7003b1da010d2b0d1dc8bf21c10f5c73b389f1 upstream.
It's possible for a user to deliberately trigger \_\_dump\_instr with a
chosen kernel address.
Let's avoid problems resulting from this by using get\_user() rather than
\_\_get\_user(), ensuring that we don't erroneously access kernel memory.
Where we use \_\_dump\_instr() on kernel text, we already switch to
KERNEL\_DS, so this shouldn't adversely affect those cases.
Fixes: 60ffc30d5652810d ("arm64: Exception handling")
Acked-by: Will Deacon
Signed-off-by: Mark Rutland
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit f2f9b8ff24cf2d1fa2640f273b9a9592005b01f0
Author: Bart Van Assche
Date: Fri Oct 27 08:23:21 2017 -0600
virtio\_blk: Fix an SG\_IO regression
commit efea2abcb03215f2efadfe994ff7f652aaff196b upstream.
Avoid that submitting an SG\_IO ioctl triggers a kernel oops that
is preceded by:
usercopy: kernel memory overwrite attempt detected to (null) () (6 bytes)
kernel BUG at mm/usercopy.c:72!
Reported-by: Dann Frazier
Fixes: commit ca18d6f769d2 ("block: Make most scsi\_req\_init() calls implicit")
Signed-off-by: Bart Van Assche
Cc: Michael S. Tsirkin
Cc: Dann Frazier
Reviewed-by: Christoph Hellwig
Signed-off-by: Greg Kroah-Hartman
Moved virtblk\_initialize\_rq() inside CONFIG\_VIRTIO\_BLK\_SCSI.
Signed-off-by: Jens Axboe
commit 38f0712c10f1fd2318bf96306c7cebbb6cf4467b
Author: Ricard Wanderlof
Date: Thu Sep 7 15:31:38 2017 +0200
ASoC: adau17x1: Workaround for noise bug in ADC
commit 1e6f4fc06f6411adf98bbbe7fcd79442cd2b2a75 upstream.
The ADC in the ADAU1361 (and possibly other Analog Devices codecs)
exhibits a cyclic variation in the noise floor (in our test setup between
-87 and -93 dB), a new value being attained within this range whenever a
new capture stream is started. The cycle repeats after about 10 or 11
restarts.
The workaround recommended by the manufacturer is to toggle the ADOSR bit
in the Converter Control 0 register each time a new capture stream is
started.
I have verified that the patch fixes this problem on the ADAU1361, and
according to the manufacturer toggling the bit in question in this manner
will at least have no detrimental effect on other chips served by this
driver.
Signed-off-by: Ricard Wanderlof
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 5148d5b12d2aa505dd622b79caae40b8886adaab
Author: Eric Biggers
Date: Thu Nov 2 00:47:19 2017 +0000
KEYS: fix out-of-bounds read during ASN.1 parsing
commit 2eb9eabf1e868fda15808954fb29b0f105ed65f1 upstream.
syzkaller with KASAN reported an out-of-bounds read in
asn1\_ber\_decoder(). It can be reproduced by the following command,
assuming CONFIG\_X509\_CERTIFICATE\_PARSER=y and CONFIG\_KASAN=y:
keyctl add asymmetric desc $'\x30\x30' @s
The bug is that the length of an ASN.1 data value isn't validated in the
case where it is encoded using the short form, causing the decoder to
read past the end of the input buffer. Fix it by validating the length.
The bug report was:
BUG: KASAN: slab-out-of-bounds in asn1\_ber\_decoder+0x10cb/0x1730 lib/asn1\_decoder.c:233
Read of size 1 at addr ffff88003cccfa02 by task syz-executor0/6818
CPU: 1 PID: 6818 Comm: syz-executor0 Not tainted 4.14.0-rc7-00008-g5f479447d983 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:16 [inline]
dump\_stack+0xb3/0x10b lib/dump\_stack.c:52
print\_address\_description+0x79/0x2a0 mm/kasan/report.c:252
kasan\_report\_error mm/kasan/report.c:351 [inline]
kasan\_report+0x236/0x340 mm/kasan/report.c:409
\_\_asan\_report\_load1\_noabort+0x14/0x20 mm/kasan/report.c:427
asn1\_ber\_decoder+0x10cb/0x1730 lib/asn1\_decoder.c:233
x509\_cert\_parse+0x1db/0x650 crypto/asymmetric\_keys/x509\_cert\_parser.c:89
x509\_key\_preparse+0x64/0x7a0 crypto/asymmetric\_keys/x509\_public\_key.c:174
asymmetric\_key\_preparse+0xcb/0x1a0 crypto/asymmetric\_keys/asymmetric\_type.c:388
key\_create\_or\_update+0x347/0xb20 security/keys/key.c:855
SYSC\_add\_key security/keys/keyctl.c:122 [inline]
SyS\_add\_key+0x1cd/0x340 security/keys/keyctl.c:62
entry\_SYSCALL\_64\_fastpath+0x1f/0xbe
RIP: 0033:0x447c89
RSP: 002b:00007fca7a5d3bd8 EFLAGS: 00000246 ORIG\_RAX: 00000000000000f8
RAX: ffffffffffffffda RBX: 00007fca7a5d46cc RCX: 0000000000447c89
RDX: 0000000020006f4a RSI: 0000000020006000 RDI: 0000000020001ff5
RBP: 0000000000000046 R08: fffffffffffffffd R09: 0000000000000000
R10: 0000000000000002 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007fca7a5d49c0 R15: 00007fca7a5d4700
Fixes: 42d5ec27f873 ("X.509: Add an ASN.1 decoder")
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Signed-off-by: James Morris
Signed-off-by: Greg Kroah-Hartman
commit 83e9bfea12107b2b8d4838b37b31d5061c549aca
Author: Eric Biggers
Date: Thu Nov 2 00:47:12 2017 +0000
KEYS: trusted: fix writing past end of buffer in trusted\_read()
commit a3c812f7cfd80cf51e8f5b7034f7418f6beb56c1 upstream.
When calling keyctl\_read() on a key of type "trusted", if the
user-supplied buffer was too small, the kernel ignored the buffer length
and just wrote past the end of the buffer, potentially corrupting
userspace memory. Fix it by instead returning the size required, as per
the documentation for keyctl\_read().
We also don't even fill the buffer at all in this case, as this is
slightly easier to implement than doing a short read, and either
behavior appears to be permitted. It also makes it match the behavior
of the "encrypted" key type.
Fixes: d00a1c72f7f4 ("keys: add new trusted key-type")
Reported-by: Ben Hutchings
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Reviewed-by: Mimi Zohar
Reviewed-by: James Morris
Signed-off-by: James Morris
Signed-off-by: Greg Kroah-Hartman
commit 4988317d1fc062e2b75195a25c24352b2f6e59ee
Author: Eric Biggers
Date: Thu Nov 2 00:47:03 2017 +0000
KEYS: return full count in keyring\_read() if buffer is too small
commit 3239b6f29bdfb4b0a2ba59df995fc9e6f4df7f1f upstream.
Commit e645016abc80 ("KEYS: fix writing past end of user-supplied buffer
in keyring\_read()") made keyring\_read() stop corrupting userspace memory
when the user-supplied buffer is too small. However it also made the
return value in that case be the short buffer size rather than the size
required, yet keyctl\_read() is actually documented to return the size
required. Therefore, switch it over to the documented behavior.
Note that for now we continue to have it fill the short buffer, since it
did that before (pre-v3.13) and dump\_key\_tree\_aux() in keyutils arguably
relies on it.
Fixes: e645016abc80 ("KEYS: fix writing past end of user-supplied buffer in keyring\_read()")
Reported-by: Ben Hutchings
Signed-off-by: Eric Biggers
Signed-off-by: David Howells
Reviewed-by: James Morris
Signed-off-by: James Morris
Signed-off-by: Greg Kroah-Hartman
commit 7d64e01cf2b626a76c4c465fc64f1107dded8441
Author: Ronnie Sahlberg
Date: Mon Oct 30 13:28:03 2017 +1100
cifs: check MaxPathNameComponentLength != 0 before using it
commit f74bc7c6679200a4a83156bb89cbf6c229fe8ec0 upstream.
And fix tcon leak in error path.
Signed-off-by: Ronnie Sahlberg
Signed-off-by: Steve French
Reviewed-by: David Disseldorp
Signed-off-by: Greg Kroah-Hartman
commit 75b5bdbeb2a7093cd131818d5d4b39349f11b124
Author: Takashi Iwai
Date: Sun Oct 29 11:10:43 2017 +0100
ALSA: seq: Fix nested rwsem annotation for lockdep splat
commit 1f20f9ff57ca23b9f5502fca85ce3977e8496cb1 upstream.
syzkaller reported the lockdep splat due to the possible deadlock of
grp->list\_mutex of each sequencer client object. Actually this is
rather a false-positive report due to the missing nested lock
annotations. The sequencer client may deliver the event directly to
another client which takes another own lock.
For addressing this issue, this patch replaces the simple down\_read()
with down\_read\_nested(). As a lock subclass, the already existing
"hop" can be re-used, which indicates the depth of the call.
Reference: http://lkml.kernel.org/r/089e082686ac9b482e055c832617@google.com
Reported-by: syzbot
Reported-by: Dmitry Vyukov
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 7fcb232d281879dd3d76d4cfb521d3216d848865
Author: Takashi Iwai
Date: Sun Oct 29 11:02:04 2017 +0100
ALSA: timer: Add missing mutex lock for compat ioctls
commit 79fb0518fec8c8b4ea7f1729f54f293724b3dbb0 upstream.
The races among ioctl and other operations were protected by the
commit af368027a49a ("ALSA: timer: Fix race among timer ioctls") and
later fixes, but one code path was forgotten in the scenario: the
32bit compat ioctl. As syzkaller recently spotted, a very similar
use-after-free may happen with the combination of compat ioctls.
The fix is simply to apply the same ioctl\_lock to the compat\_ioctl
callback, too.
Fixes: af368027a49a ("ALSA: timer: Fix race among timer ioctls")
Reference: http://lkml.kernel.org/r/089e082686ac9b482e055c832617@google.com
Reported-by: syzbot
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman

