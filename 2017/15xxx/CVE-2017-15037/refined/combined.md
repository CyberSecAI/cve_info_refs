=== Content from svnweb.freebsd.org_7001748a_20250124_200022.html ===


| **</>[[base]](/base/)** |  |
| --- | --- |

![ViewVC logotype](/*docroot*/images/viewvc-logo.png)
# Revision 324102

---

| Jump to revision: | [Previous](/base?view=revision&revision=324101 "Previous Revision") [Next](/base?view=revision&revision=324103 "Next Revision") |
| --- | --- |
| Author: | cem |
| Date: | Fri Sep 29 15:53:26 2017 UTC *(7 years, 3 months ago)* |
| Changed paths: | **1** |
| Log Message: | ``` netsmb: Fix buggy/racy smb_strdupin()  smb_strdupin() tried to roll a copyin() based strlen to allocate a buffer and then blindly copyin that size.  Of course, a malicious user program could simultaneously manipulate the buffer, resulting in a non-terminated string being copied.  Later assumptions in the code rely upon the string being nul-terminated.  Just use copyinstr() and drop the racy sizing.  PR:		222687 Reported by:	Meng Xu <meng.xu AT gatech.edu> Security:	possible local DoS Sponsored by:	Dell EMC Isilon   ``` |

---

## Changed paths

| Path | Details |
| --- | --- |
| [Directoryhead/sys/netsmb/smb\_subr.c](/base/head/sys/netsmb/smb_subr.c?view=markup&pathrev=324102 "View File Contents") | [modified](/base/head/sys/netsmb/smb_subr.c?view=log&pathrev=324102 "View Log") , [text changed](/base/head/sys/netsmb/smb_subr.c?r1=324102&r2=324101&pathrev=324102 "View Diff") |

---

|  | **[ViewVC Help](/%2Adocroot%2A/help_rootview.html)** |
| --- | --- |
| Powered by [ViewVC 1.1.27](http://viewvc.org/) |  |



=== Content from bugs.freebsd.org_5c12a697_20250124_200021.html ===


FreeBSD Bugzilla – Bug 222687
smb\_strdupin() does not properly check the length of string duped-in
Last modified: 2019-02-09 08:11:30 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](page.cgi?id=reporting.html)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=222687&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=222687&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 222687**](show_bug.cgi?id=222687)
- smb\_strdupin() does not properly check the length of string duped-in

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
smb\_strdupin() does not properly check the length of string duped-in

| | [Status](page.cgi?id=fields.html#bug_status): | Closed FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Base System | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Base System "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | kern ([show other bugs](buglist.cgi?component=kern&product=Base%20System&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | CURRENT | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Any Any | |  | | | [Importance](page.cgi?id=fields.html#importance): | --- Affects Some People | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Conrad Meyer | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2017-09-29 14:17 UTC by Meng Xu | | --- | --- | | Modified: | 2019-02-09 08:11 UTC ([History](show_activity.cgi?id=222687)) | | CC List: | 13 users (show)  39librosweb alexlen593 cadenjacob98 cem deletehistoryfree delphij heatherrosado4 jm398964 mariadenial1123 michael.osipov pswag994 swills tablosazi.farahan | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | | --- | --- | --- | | [Add an attachment](attachment.cgi?bugid=222687&action=enter) (proposed patch, testcase, etc.) | | |   | Note You need to [log in](show_bug.cgi?id=222687&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=222687#c0)  Meng Xu    2017-09-29 14:17:19 UTC  ``` In function smb_strdupin(), it first guesses the length of the input string (by incrementally read and testing for the NULL terminator) and then copyin the whole string from userspace. However, given that another user thread can "scramble" the userspace buffer while smb_strdupin() is in execution, it might result in a case where the string after second copyin is not  NULL terminated.  This itself is not yet a very serious issue. However, it does become a bug later. smb_strdupin() is invoked in smb_usr_t2request() by t2p->t_name = smb_strdupin(dp->ioc_name, 128); And later in downstream functions  smb_t2_request(t2p) --> smb_t2_request_int(t2p) there is a call to t2p->t_name: nmlen = t2p->t_name ? strlen(t2p->t_name) : 0  Now if t2p->t_name is not NULL terminated, calling strlen(t2p->t_name) will cause wield behaviors, such as invalid memory accesses. ```  [Comment 1](show_bug.cgi?id=222687#c1)  commit-hook   freebsd_committer freebsd_triage  2017-09-29 15:54:20 UTC  ``` A commit references this bug:  Author: cem Date: Fri Sep 29 15:53:26 UTC 2017 New revision: 324102 URL: <https://svnweb.freebsd.org/changeset/base/324102>  Log:   netsmb: Fix buggy/racy smb_strdupin()    smb_strdupin() tried to roll a copyin() based strlen to allocate a buffer   and then blindly copyin that size.  Of course, a malicious user program   could simultaneously manipulate the buffer, resulting in a non-terminated   string being copied.    Later assumptions in the code rely upon the string being nul-terminated.    Just use copyinstr() and drop the racy sizing.    PR:		222687   Reported by:	Meng Xu <meng.xu AT gatech.edu>   Security:	possible local DoS   Sponsored by:	Dell EMC Isilon  Changes:   head/sys/netsmb/smb_subr.c ```  [Comment 2](show_bug.cgi?id=222687#c2)  Xin LI   freebsd_committer freebsd_triage  2017-10-08 05:53:41 UTC  ``` Note: MITRE have assigned CVE-2017-15037 for this issue. ```  [Comment 3](show_bug.cgi?id=222687#c3)  Ben Simmons    2017-10-30 14:16:07 UTC  ``` MARKED AS SPAM ```  [Comment 4](show_bug.cgi?id=222687#c4)  vali gholami    2017-12-17 07:13:16 UTC  ``` MARKED AS SPAM ```  [Comment 5](show_bug.cgi?id=222687#c5)  omejames    2018-01-25 10:23:17 UTC  ``` MARKED AS SPAM ```  [Comment 6](show_bug.cgi?id=222687#c6)  Michael Osipov    2018-02-06 13:09:35 UTC  ``` Why hasn't this beeen MFCed? ```  [Comment 7](show_bug.cgi?id=222687#c7)  commit-hook   freebsd_committer freebsd_triage  2018-04-01 16:44:07 UTC  ``` A commit references this bug:  Author: markj Date: Sun Apr  1 16:43:30 UTC 2018 New revision: 331867 URL: <https://svnweb.freebsd.org/changeset/base/331867>  Log:   MFC r324102 (by cem):   netsmb: Fix buggy/racy smb_strdupin()    PR:	222687  Changes: _U  stable/11/   stable/11/sys/netsmb/smb_subr.c ```  [Comment 8](show_bug.cgi?id=222687#c8)  Kuha    2018-04-25 22:40:30 UTC  ``` MARKED AS SPAM ```  [Comment 9](show_bug.cgi?id=222687#c9)  maria denial    2018-05-18 05:59:47 UTC  ``` MARKED AS SPAM ```  [Comment 10](show_bug.cgi?id=222687#c10)  deletehistoryfree    2018-05-22 19:51:34 UTC  ``` MARKED AS SPAM ```  [Comment 11](show_bug.cgi?id=222687#c11)  heather rosado    2018-08-02 05:57:58 UTC  ``` MARKED AS SPAM ```  [Comment 12](show_bug.cgi?id=222687#c12)  pedro    2018-08-19 21:26:35 UTC  ``` MARKED AS SPAM ```  [Comment 13](show_bug.cgi?id=222687#c13)  John Martin    2019-02-09 08:11:30 UTC  ``` MARKED AS SPAM ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=222687)
* - [XML](show_bug.cgi?ctype=xml&id=222687)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=222687)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](page.cgi?id=reporting.html)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=222687&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=222687&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


