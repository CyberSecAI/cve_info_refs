=== Content from usn.ubuntu.com_63554672_20250124_161837.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3706-1: libjpeg-turbo vulnerabilities

9 July 2018

libjpeg-turbo could be made to crash or run programs as your login if it
opened a specially crafted file.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 18.04 ESM](/security/notices?release=bionic)
* [Ubuntu 17.10](/security/notices?release=artful)
* [Ubuntu 16.04 ESM](/security/notices?release=xenial)
* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [libjpeg-turbo](/security/cves?package=libjpeg-turbo) - library for handling JPEG files

## Details

It was discovered that libjpeg-turbo incorrectly handled certain malformed

JPEG images. If a user or automated system were tricked into opening a

specially crafted JPEG image, a remote attacker could cause libjpeg-turbo

to crash, resulting in a denial of service, or possibly execute arbitrary

code.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 18.04

* [libjpeg-turbo8](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo)
  -
  [1.5.2-0ubuntu5.18.04.1](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo/1.5.2-0ubuntu5.18.04.1)

##### Ubuntu 17.10

* [libjpeg-turbo8](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo)
  -
  [1.5.2-0ubuntu5.17.10.1](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo/1.5.2-0ubuntu5.17.10.1)

##### Ubuntu 16.04

* [libjpeg-turbo8](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo)
  -
  [1.4.2-0ubuntu3.1](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo/1.4.2-0ubuntu3.1)

##### Ubuntu 14.04

* [libjpeg-turbo8](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo)
  -
  [1.3.0-0ubuntu2.1](https://launchpad.net/ubuntu/%2Bsource/libjpeg-turbo/1.3.0-0ubuntu2.1)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2014-9092](/security/CVE-2014-9092)
* [CVE-2016-3616](/security/CVE-2016-3616)
* [CVE-2017-15232](/security/CVE-2017-15232)
* [CVE-2018-11212](/security/CVE-2018-11212)
* [CVE-2018-11213](/security/CVE-2018-11213)
* [CVE-2018-11214](/security/CVE-2018-11214)
* [CVE-2018-1152](/security/CVE-2018-1152)

## Related notices

* [USN-3706-2](/security/notices/USN-3706-2)
* [USN-5336-1](/security/notices/USN-5336-1)
* [USN-5497-1](/security/notices/USN-5497-1)
* [USN-5497-2](/security/notices/USN-5497-2)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from github.com_b672d225_20250124_161834.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibjpeg-turbo%2Flibjpeg-turbo%2Fpull%2F182)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibjpeg-turbo%2Flibjpeg-turbo%2Fpull%2F182)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=libjpeg-turbo%2Flibjpeg-turbo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[libjpeg-turbo](/libjpeg-turbo)
/
**[libjpeg-turbo](/libjpeg-turbo/libjpeg-turbo)**
Public

* [Notifications](/login?return_to=%2Flibjpeg-turbo%2Flibjpeg-turbo) You must be signed in to change notification settings
* [Fork
  1k](/login?return_to=%2Flibjpeg-turbo%2Flibjpeg-turbo)
* [Star
   3.8k](/login?return_to=%2Flibjpeg-turbo%2Flibjpeg-turbo)

* [Code](/libjpeg-turbo/libjpeg-turbo)
* [Issues
  18](/libjpeg-turbo/libjpeg-turbo/issues)
* [Pull requests
  2](/libjpeg-turbo/libjpeg-turbo/pulls)
* [Discussions](/libjpeg-turbo/libjpeg-turbo/discussions)
* [Actions](/libjpeg-turbo/libjpeg-turbo/actions)
* [Projects
  0](/libjpeg-turbo/libjpeg-turbo/projects)
* [Security](/libjpeg-turbo/libjpeg-turbo/security)
* [Insights](/libjpeg-turbo/libjpeg-turbo/pulse)

Additional navigation options

* [Code](/libjpeg-turbo/libjpeg-turbo)
* [Issues](/libjpeg-turbo/libjpeg-turbo/issues)
* [Pull requests](/libjpeg-turbo/libjpeg-turbo/pulls)
* [Discussions](/libjpeg-turbo/libjpeg-turbo/discussions)
* [Actions](/libjpeg-turbo/libjpeg-turbo/actions)
* [Projects](/libjpeg-turbo/libjpeg-turbo/projects)
* [Security](/libjpeg-turbo/libjpeg-turbo/security)
* [Insights](/libjpeg-turbo/libjpeg-turbo/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Flibjpeg-turbo%2Flibjpeg-turbo%2Fissues%2Fnew%2Fchoose)

By clicking âSign up for GitHubâ, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). Weâll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Flibjpeg-turbo%2Flibjpeg-turbo%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Handle NULL buffer when discarding rows #182

 Closed

[kornelski](/kornelski)
wants to merge
2
commits into
[libjpeg-turbo:master](/libjpeg-turbo/libjpeg-turbo/tree/master "libjpeg-turbo/libjpeg-turbo:master")
from
[kornelski:quantnull](/kornelski/libjpeg-turbo/tree/quantnull "kornelski/libjpeg-turbo:quantnull")

 Closed

# [Handle NULL buffer when discarding rows](#top) #182

[kornelski](/kornelski)
wants to merge
2
commits into
[libjpeg-turbo:master](/libjpeg-turbo/libjpeg-turbo/tree/master "libjpeg-turbo/libjpeg-turbo:master")
from
[kornelski:quantnull](/kornelski/libjpeg-turbo/tree/quantnull "kornelski/libjpeg-turbo:quantnull")

[Conversation
18](/libjpeg-turbo/libjpeg-turbo/pull/182)
[Commits
2](/libjpeg-turbo/libjpeg-turbo/pull/182/commits)
[Checks
0](/libjpeg-turbo/libjpeg-turbo/pull/182/checks)
[Files changed](/libjpeg-turbo/libjpeg-turbo/pull/182/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![kornelski](https://avatars.githubusercontent.com/u/72159?s=60&v=4)](/kornelski)

Copy link

Contributor

### @kornelski **[kornelski](/kornelski)** commented [Sep 30, 2017](#issue-261842206)

I've got a report about a crash:

[mozilla/mozjpeg#268](https://github.com/mozilla/mozjpeg/issues/268)

I've handled in the function that crashed (jquant1.c) as well as up the stack in the function that was the real cause of it (`read_and_discard_scanlines` uses `NULL` buffer and expects that to be handled gracefully).

Sorry, something went wrong.

All reactions

[![dwbuiten](https://avatars.githubusercontent.com/u/1189609?s=60&v=4)](/dwbuiten)

**[dwbuiten](/dwbuiten)**
reviewed
[Oct 2, 2017](#pullrequestreview-66564006)

 [View reviewed changes](/libjpeg-turbo/libjpeg-turbo/pull/182/files)

[jdpostct.c](/libjpeg-turbo/libjpeg-turbo/pull/182/files#diff-dafc32266693e2534cb192fc498948ac1a37f7ff99a350e522d84d4659b22b4c)

|  |  | @@ -132,6 +132,11 @@ post\_process\_1pass (j\_decompress\_ptr cinfo, | |
| --- | --- | --- | --- |
|  |  | my\_post\_ptr post = (my\_post\_ptr) cinfo->post; |
|  |  | JDIMENSION num\_rows, max\_rows; |
|  |  |  |
|  |  | /\* read\_and\_discard\_scanlines may call it with rows "available", but no buffer \*/ |

Copy link

### @dwbuiten **[dwbuiten](/dwbuiten)** [Oct 2, 2017](#discussion_r142231764)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

That seems kinda iffy of `read_and_discard_scanlines`. Is it actually intended to do that?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @kornelski **[kornelski](/kornelski)** [Oct 2, 2017](#discussion_r142237304)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It is iffy, but I don't know that function. I suppose NULL works well for discarding :)

Sorry, something went wrong.

All reactions

Copy link

### @dwbuiten **[dwbuiten](/dwbuiten)** [Oct 2, 2017](#discussion_r142241021)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Looking at [this](https://github.com/mozilla/mozjpeg/blob/6ee36adc4eaaac0837e86f22ec6c8cafe4b84c92/jdapistd.c#L296-L302), it seems like it's a bit of a hack anyway, so I guess the check is OK. :/

Sorry, something went wrong.

All reactions

[jdpostct.c](/libjpeg-turbo/libjpeg-turbo/pull/182/files#diff-dafc32266693e2534cb192fc498948ac1a37f7ff99a350e522d84d4659b22b4c)
Outdated

|  |  | @@ -132,6 +132,11 @@ post\_process\_1pass (j\_decompress\_ptr cinfo, | |
| --- | --- | --- | --- |
|  |  | my\_post\_ptr post = (my\_post\_ptr) cinfo->post; |
|  |  | JDIMENSION num\_rows, max\_rows; |
|  |  |  |
|  |  | /\* read\_and\_discard\_scanlines may call it with rows "available", but no buffer \*/ |
|  |  | if (!output\_buf) { |

Copy link

### @dwbuiten **[dwbuiten](/dwbuiten)** [Oct 2, 2017](#discussion_r142232187)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

NIT: libjpeg style is to use `(buf == NULL)` (probably because of some mythical system where this will fail due to NULL being implementation defined as a a type of zero value).

Sorry, something went wrong.

All reactions

[jquant1.c](/libjpeg-turbo/libjpeg-turbo/pull/182/files#diff-1d19bd96d4d9643532fd3a4102ff046ad4365e99e22b1ead627745a15acf4ab1)
Outdated

|  |  | @@ -531,6 +531,10 @@ quantize\_ord\_dither (j\_decompress\_ptr cinfo, JSAMPARRAY input\_buf, | |
| --- | --- | --- | --- |
|  |  | JDIMENSION col; |
|  |  | JDIMENSION width = cinfo->output\_width; |
|  |  |  |
|  |  | if (!output\_buf && num\_rows) { |

Copy link

### @dwbuiten **[dwbuiten](/dwbuiten)** [Oct 2, 2017](#discussion_r142232224)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Ditto.

Sorry, something went wrong.

All reactions

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=40&v=4)](/kornelski)

`[Handle NULL buffer when discarding rows](/libjpeg-turbo/libjpeg-turbo/pull/182/commits/1ecd9a5729d78518397889a630e3534bd9d963a8 "Handle NULL buffer when discarding rows")`

`[1ecd9a5](/libjpeg-turbo/libjpeg-turbo/pull/182/commits/1ecd9a5729d78518397889a630e3534bd9d963a8)`

 [![@kornelski](https://avatars.githubusercontent.com/u/72159?s=40&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)
[kornelski](/kornelski)
[force-pushed](/libjpeg-turbo/libjpeg-turbo/compare/f08171523b4c688ff3328f321fa55d03a71fbd32..1ecd9a5729d78518397889a630e3534bd9d963a8)
the
quantnull

branch
from
[`f081715`](/libjpeg-turbo/libjpeg-turbo/commit/f08171523b4c688ff3328f321fa55d03a71fbd32) to
[`1ecd9a5`](/libjpeg-turbo/libjpeg-turbo/commit/1ecd9a5729d78518397889a630e3534bd9d963a8)  [Compare](/libjpeg-turbo/libjpeg-turbo/compare/f08171523b4c688ff3328f321fa55d03a71fbd32..1ecd9a5729d78518397889a630e3534bd9d963a8)
[October 2, 2017 19:53](#event-1274743706)

[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=80&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)

Copy link

Member

### **[dcommander](/dcommander)** commented [Oct 2, 2017](#issuecomment-333677765)

| [@mattsarett](https://github.com/mattsarett) any comments? |
| --- |

All reactions

Sorry, something went wrong.

[![pgajdos](https://avatars.githubusercontent.com/u/4067843?s=60&v=4)](/pgajdos)

**[pgajdos](/pgajdos)**
reviewed
[Oct 12, 2017](#pullrequestreview-68890956)

 [View reviewed changes](/libjpeg-turbo/libjpeg-turbo/pull/182/files/1ecd9a5729d78518397889a630e3534bd9d963a8)

[jquant1.c](/libjpeg-turbo/libjpeg-turbo/pull/182/files/1ecd9a5729d78518397889a630e3534bd9d963a8#diff-1d19bd96d4d9643532fd3a4102ff046ad4365e99e22b1ead627745a15acf4ab1)

|  |  | @@ -531,6 +531,10 @@ quantize\_ord\_dither (j\_decompress\_ptr cinfo, JSAMPARRAY input\_buf, | |
| --- | --- | --- | --- |
|  |  | JDIMENSION col; |
|  |  | JDIMENSION width = cinfo->output\_width; |
|  |  |  |
|  |  | if (output\_buf == NULL && num\_rows) { |
|  |  | ERREXIT(cinfo, JERR\_BAD\_PARAM); |

Copy link

### @pgajdos **[pgajdos](/pgajdos)** [Oct 12, 2017](#discussion_r144259793)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I do not see JERR\_BAD\_PARAM defined, am I missing something?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @kornelski **[kornelski](/kornelski)** [Oct 12, 2017](#discussion_r144265182)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Indeed, I forgot to include it in the patch. Fixed.

Sorry, something went wrong.

All reactions

Copy link

### @pgajdos **[pgajdos](/pgajdos)** [Oct 12, 2017](#discussion_r144291649)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thanks!

Sorry, something went wrong.

All reactions

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=40&v=4)](/kornelski)

`[Add missing message](/libjpeg-turbo/libjpeg-turbo/pull/182/commits/852a0193af1393c91c1643c8996434159e224a03 "Add missing message")`

`[852a019](/libjpeg-turbo/libjpeg-turbo/pull/182/commits/852a0193af1393c91c1643c8996434159e224a03)`

[![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=80&u=fb78a517ccc07fb51c4c3cd29c0a2cbaea34e465&v=4)](/pgajdos)

Copy link

### **[pgajdos](/pgajdos)** commented [Oct 12, 2017](#issuecomment-336142138)

| Do I need another commit to fix 1.5.2?  <https://bugzilla.suse.com/show_bug.cgi?id=1062937#c4> <https://bugzilla.suse.com/show_bug.cgi?id=1062937#c5> |
| --- |

All reactions

Sorry, something went wrong.

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=80&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)

Copy link

Contributor

Author

### **[kornelski](/kornelski)** commented [Oct 12, 2017](#issuecomment-336155548)

| I'm not sure if that question was for me, but: this PR fixes the issue in the Suse bugzilla. It should be compatible with 1.5.2 release branch, and probably should be cherry-picked to that branch too. |
| --- |

All reactions

Sorry, something went wrong.

[![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=80&u=fb78a517ccc07fb51c4c3cd29c0a2cbaea34e465&v=4)](/pgajdos)

Copy link

### **[pgajdos](/pgajdos)** commented [Oct 13, 2017](#issuecomment-336376469)

| [@pornel](https://github.com/pornel), apologize I had not been clear.  When I apply this patch to 1.5.2, the command does not crash anymore for the first test case. For the second test case though, it still crashes with the backtrace I referenced. |
| --- |

All reactions

Sorry, something went wrong.

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=80&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)

Copy link

Contributor

Author

### **[kornelski](/kornelski)** commented [Oct 13, 2017](#issuecomment-336387916)

| I see. I'll have a look. |
| --- |

All reactions

Sorry, something went wrong.

[![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=80&u=fb78a517ccc07fb51c4c3cd29c0a2cbaea34e465&v=4)](/pgajdos)

Copy link

### **[pgajdos](/pgajdos)** commented [Oct 13, 2017](#issuecomment-336398411)

| Thanks, let me know if I can help. |
| --- |

All reactions

Sorry, something went wrong.

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=40&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)
[kornelski](/kornelski)
mentioned this pull request
[Oct 13, 2017](#ref-issue-265229207)

[Cropping corrupts dest\_mgr struct
#185](/libjpeg-turbo/libjpeg-turbo/issues/185)

Closed

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=80&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)

Copy link

Contributor

Author

### **[kornelski](/kornelski)** commented [Oct 13, 2017](#issuecomment-336404212)

| [@pgajdos](https://github.com/pgajdos) The second bug is worse. I've opened another issue for it [#185](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/185) |
| --- |

All reactions

Sorry, something went wrong.

[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=80&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)

Copy link

Member

### **[dcommander](/dcommander)** commented [Oct 13, 2017](#issuecomment-336458507)

| Hi, guys. I didn't write the feature in question, and apparently the author (a former Google employee) is now working elsewhere. I have a grant from Mozilla that I can use to look into this, but I need to clear some other things from my plate first. It seems like I'm going to need to really dig into the issue and re-examine some aspects of this feature, and probably design better unit tests to guard against this sort of thing in the future. I'll keep you posted. |
| --- |

All reactions

Sorry, something went wrong.

[![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=80&u=fb78a517ccc07fb51c4c3cd29c0a2cbaea34e465&v=4)](/pgajdos)

Copy link

### **[pgajdos](/pgajdos)** commented [Oct 16, 2017](#issuecomment-336811369)

| Thank you, guys. |
| --- |

All reactions

Sorry, something went wrong.

[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=40&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)
[dcommander](/dcommander)
closed this
in
`[5bc43c7](/libjpeg-turbo/libjpeg-turbo/commit/5bc43c7821df982f65aa1c738f67fbf7cba8bd69)`
[Nov 14, 2017](#event-1340047430)

[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=80&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)

Copy link

Member

### **[dcommander](/dcommander)** commented [Nov 14, 2017](#issuecomment-344135880) â¢ edited Loading

| Your patch was unfortunately insufficient to address all facets of the bug. Now that I have partial image decompression working with GIF output files, I was able to reproduce this bug with all of the various color quantization functions by passing various switches to djpeg. The root cause is that `jpeg_skip_scanlines()` was not properly handling color quantization. It needed to set up a dummy `color_quantize()` function just like it sets up a dummy `color_convert()` function. [5bc43c7](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/5bc43c7821df982f65aa1c738f67fbf7cba8bd69) fixes the issue and also fixes [#185](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/185) the right way, by establishing a new method in the djpeg\_dest\_mgr object that recomputes the buffer dimensions for output formats that work with `-crop`. BMP and RLE still cannot work with `-crop`, unfortunately, because those formats use a whole-image inversion buffer to write the scanlines in bottom-up order. However, having GIF support for the partial image decompression feature is useful, because it makes it easy to reproduce this bug. The following script should complete successfully if the bug is fully fixed:  ``` #!/bin/bash set -e  SRCDIR=.. BUILDDIR=.  for onepass in -onepass ""; do 	for format in gif targa; do 		for dither in fs ordered none; do 			for grayscale in -grayscale ""; do 				echo $BUILDDIR/djpeg -dct int -colors 256 -crop 98x98+12+12 $onepass -$format -dither $dither $grayscale -outfile out$onepass$grayscale-$dither.$format $SRCDIR/testimages/testorig.jpg 				$BUILDDIR/djpeg -dct int -colors 256 -crop 98x98+12+12 $onepass -$format -dither $dither $grayscale -outfile out$onepass$grayscale-$dither.$format $SRCDIR/testimages/testorig.jpg 			done 		done 	done done  cat <<EOF >$BUILDDIR/md5sum.txt 0e36d86afcd4eba7087dcf9764fcc7bc  out-onepass-grayscale-fs.gif 4ebda254d42cbdb29c878f96b5aef3f6  out-onepass-fs.gif c28e92b57a9d63d1f8d32f396389ca29  out-onepass-grayscale-ordered.gif 9f1c31949ed3479907775f4abc6295ec  out-onepass-ordered.gif c28e92b57a9d63d1f8d32f396389ca29  out-onepass-grayscale-none.gif 9a18b6bbb5eeab29cd5404e755268269  out-onepass-none.gif 0c2e1ef486b21853dc670e65f53a364a  out-onepass-grayscale-fs.targa 75d8a0cf3990fec306faed32dcd8957d  out-onepass-fs.targa 82cdc85ca549e741e73a29b507cf0978  out-onepass-grayscale-ordered.targa d8e7b513810034172c4ce5a9e6c6d3d3  out-onepass-ordered.targa 82cdc85ca549e741e73a29b507cf0978  out-onepass-grayscale-none.targa 0201ff3e239a93d12c5d7cafdec594db  out-onepass-none.targa 0e36d86afcd4eba7087dcf9764fcc7bc  out-grayscale-fs.gif e6a7dbbcd3e176f818837b9050e25e15  out-fs.gif c28e92b57a9d63d1f8d32f396389ca29  out-grayscale-ordered.gif e6a7dbbcd3e176f818837b9050e25e15  out-ordered.gif c28e92b57a9d63d1f8d32f396389ca29  out-grayscale-none.gif 741f3cf5fde61737729c13369e5845e3  out-none.gif 0c2e1ef486b21853dc670e65f53a364a  out-grayscale-fs.targa 1337a8c2d91658a10e98f4729cd4717f  out-fs.targa 82cdc85ca549e741e73a29b507cf0978  out-grayscale-ordered.targa 1337a8c2d91658a10e98f4729cd4717f  out-ordered.targa 82cdc85ca549e741e73a29b507cf0978  out-grayscale-none.targa f0e89205504cca725b936a4809b86fcf  out-none.targa EOF  md5sum -c $BUILDDIR/md5sum.txt  echo GREAT SUCCESS!  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=40&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)
[dcommander](/dcommander)
added
[bug](/libjpeg-turbo/libjpeg-turbo/labels/bug)
[fixed](/libjpeg-turbo/libjpeg-turbo/labels/fixed)
labels
[Nov 14, 2017](#event-1340058443)

 [![@kornelski](https://avatars.githubusercontent.com/u/72159?s=40&u=f25bf9f675b806b92a8e5083ce5d0b8f1d7708df&v=4)](/kornelski)
[kornelski](/kornelski)
deleted the
quantnull

branch
[November 14, 2017 13:29](#event-1340851436)

[dcommander](/dcommander)
added a commit
that referenced
this pull request
[Jul 28, 2020](#ref-commit-a46c111)
[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=40&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)

`[Further jpeg_skip_scanlines() fixes](/libjpeg-turbo/libjpeg-turbo/commit/a46c111d9f3642f0ef3819e7298846ccc61869e0 "Further jpeg_skip_scanlines() fixes

- Introduce a partial image decompression regression test script that
  validates the correctness of jpeg_skip_scanlines() and
  jpeg_crop_scanlines() for a variety of cropping regions and libjpeg
  settings.

  This regression test catches the following issues:
  #182, fixed in 5bc43c7821df982f65aa1c738f67fbf7cba8bd69
  #237, fixed in 6e95c08649794f5018608f37250026a45ead2db8
  #244, fixed in 398c1e9acc9b4531edceb3d77da0de5744675052
  #441, fully fixed in this commit

  It does not catch the following issues:
  #194, fixed in 773040f9d949d5f313caf7507abaf4bd5d7ffa12
  #244 (additional segfault), fixed in
       9120a247436e84c0b4eea828cb11e8f665fcde30

- Modify the libjpeg-turbo regression test suite (make test) so that it
  checks for the issue reported in #441 (segfault in
  jpeg_skip_scanlines() when used with 4:2:0 merged upsampling/color
  conversion.)

- Fix issues in jpeg_skip_scanlines() that caused incorrect output with
  h2v2 (4:2:0) merged upsampling/color conversion.  The previous commit
  fixed the segfault reported in #441, but that was a symptom of a
  larger problem.  Because merged 4:2:0 upsampling uses a \"spare row\"
  buffer, it is necessary to allow the upsampler to run when skipping
  rows (fancy 4:2:0 upsampling, which uses context rows, also requires
  this.)  Otherwise, if skipping starts at an odd-numbered row, the
  output image will be incorrect.

- Throw an error if jpeg_skip_scanlines() is called with two-pass color
  quantization enabled.  With two-pass color quantization, the first
  pass occurs within jpeg_start_decompress(), so subsequent calls to
  jpeg_skip_scanlines() interfere with the multipass state and prevent
  the second pass from occurring during subsequent calls to
  jpeg_read_scanlines().")`
â¦

`[a46c111](/libjpeg-turbo/libjpeg-turbo/commit/a46c111d9f3642f0ef3819e7298846ccc61869e0)`

```
- Introduce a partial image decompression regression test script that
  validates the correctness of jpeg_skip_scanlines() and
  jpeg_crop_scanlines() for a variety of cropping regions and libjpeg
  settings.

  This regression test catches the following issues:
  [#182](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/182), fixed in [5bc43c7](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/5bc43c7821df982f65aa1c738f67fbf7cba8bd69)
  [#237](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/237), fixed in [6e95c08](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/6e95c08649794f5018608f37250026a45ead2db8)
  [#244](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/244), fixed in [398c1e9](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/398c1e9acc9b4531edceb3d77da0de5744675052)
  [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441), fully fixed in this commit

  It does not catch the following issues:
  [#194](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/194), fixed in [773040f](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/773040f9d949d5f313caf7507abaf4bd5d7ffa12)
  [#244](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/244) (additional segfault), fixed in
       [9120a24](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/9120a247436e84c0b4eea828cb11e8f665fcde30)

- Modify the libjpeg-turbo regression test suite (make test) so that it
  checks for the issue reported in [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441) (segfault in
  jpeg_skip_scanlines() when used with 4:2:0 merged upsampling/color
  conversion.)

- Fix issues in jpeg_skip_scanlines() that caused incorrect output with
  h2v2 (4:2:0) merged upsampling/color conversion.  The previous commit
  fixed the segfault reported in [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441), but that was a symptom of a
  larger problem.  Because merged 4:2:0 upsampling uses a "spare row"
  buffer, it is necessary to allow the upsampler to run when skipping
  rows (fancy 4:2:0 upsampling, which uses context rows, also requires
  this.)  Otherwise, if skipping starts at an odd-numbered row, the
  output image will be incorrect.

- Throw an error if jpeg_skip_scanlines() is called with two-pass color
  quantization enabled.  With two-pass color quantization, the first
  pass occurs within jpeg_start_decompress(), so subsequent calls to
  jpeg_skip_scanlines() interfere with the multipass state and prevent
  the second pass from occurring during subsequent calls to
  jpeg_read_scanlines().
```

[dcommander](/dcommander)
added a commit
that referenced
this pull request
[Jul 28, 2020](#ref-commit-ab835bc)
[![@dcommander](https://avatars.githubusercontent.com/u/651941?s=40&u=2eb3f0d8b217946bfb7b43fb02676b1d8e817f5b&v=4)](/dcommander)

`[Further jpeg_skip_scanlines() fixes](/libjpeg-turbo/libjpeg-turbo/commit/ab835bc4cc6489e6846a6224d12cfc19d0ea28ab "Further jpeg_skip_scanlines() fixes

- Introduce a partial image decompression regression test script that
  validates the correctness of jpeg_skip_scanlines() and
  jpeg_crop_scanlines() for a variety of cropping regions and libjpeg
  settings.

  This regression test catches the following issues:
  #182, fixed in 5bc43c7821df982f65aa1c738f67fbf7cba8bd69
  #237, fixed in 6e95c08649794f5018608f37250026a45ead2db8
  #244, fixed in 398c1e9acc9b4531edceb3d77da0de5744675052
  #441, fully fixed in this commit

  It does not catch the following issues:
  #194, fixed in 773040f9d949d5f313caf7507abaf4bd5d7ffa12
  #244 (additional segfault), fixed in
       9120a247436e84c0b4eea828cb11e8f665fcde30

- Modify the libjpeg-turbo regression test suite (make test) so that it
  checks for the issue reported in #441 (segfault in
  jpeg_skip_scanlines() when used with 4:2:0 merged upsampling/color
  conversion.)

- Fix issues in jpeg_skip_scanlines() that caused incorrect output with
  h2v2 (4:2:0) merged upsampling/color conversion.  The previous commit
  fixed the segfault reported in #441, but that was a symptom of a
  larger problem.  Because merged 4:2:0 upsampling uses a \"spare row\"
  buffer, it is necessary to allow the upsampler to run when skipping
  rows (fancy 4:2:0 upsampling, which uses context rows, also requires
  this.)  Otherwise, if skipping starts at an odd-numbered row, the
  output image will be incorrect.

- Throw an error if jpeg_skip_scanlines() is called with two-pass color
  quantization enabled.  With two-pass color quantization, the first
  pass occurs within jpeg_start_decompress(), so subsequent calls to
  jpeg_skip_scanlines() interfere with the multipass state and prevent
  the second pass from occurring during subsequent calls to
  jpeg_read_scanlines().")`
â¦

`[ab835bc](/libjpeg-turbo/libjpeg-turbo/commit/ab835bc4cc6489e6846a6224d12cfc19d0ea28ab)`

```
- Introduce a partial image decompression regression test script that
  validates the correctness of jpeg_skip_scanlines() and
  jpeg_crop_scanlines() for a variety of cropping regions and libjpeg
  settings.

  This regression test catches the following issues:
  [#182](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/182), fixed in [5bc43c7](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/5bc43c7821df982f65aa1c738f67fbf7cba8bd69)
  [#237](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/237), fixed in [6e95c08](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/6e95c08649794f5018608f37250026a45ead2db8)
  [#244](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/244), fixed in [398c1e9](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/398c1e9acc9b4531edceb3d77da0de5744675052)
  [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441), fully fixed in this commit

  It does not catch the following issues:
  [#194](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/194), fixed in [773040f](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/773040f9d949d5f313caf7507abaf4bd5d7ffa12)
  [#244](https://github.com/libjpeg-turbo/libjpeg-turbo/pull/244) (additional segfault), fixed in
       [9120a24](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/9120a247436e84c0b4eea828cb11e8f665fcde30)

- Modify the libjpeg-turbo regression test suite (make test) so that it
  checks for the issue reported in [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441) (segfault in
  jpeg_skip_scanlines() when used with 4:2:0 merged upsampling/color
  conversion.)

- Fix issues in jpeg_skip_scanlines() that caused incorrect output with
  h2v2 (4:2:0) merged upsampling/color conversion.  The previous commit
  fixed the segfault reported in [#441](https://github.com/libjpeg-turbo/libjpeg-turbo/issues/441), but that was a symptom of a
  larger problem.  Because merged 4:2:0 upsampling uses a "spare row"
  buffer, it is necessary to allow the upsampler to run when skipping
  rows (fancy 4:2:0 upsampling, which uses context rows, also requires
  this.)  Otherwise, if skipping starts at an odd-numbered row, the
  output image will be incorrect.

- Throw an error if jpeg_skip_scanlines() is called with two-pass color
  quantization enabled.  With two-pass color quantization, the first
  pass occurs within jpeg_start_decompress(), so subsequent calls to
  jpeg_skip_scanlines() interfere with the multipass state and prevent
  the second pass from occurring during subsequent calls to
  jpeg_read_scanlines().
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Flibjpeg-turbo%2Flibjpeg-turbo%2Fpull%2F182)

Reviewers

[![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=40&v=4)](/pgajdos) [pgajdos](/pgajdos)

pgajdos left review comments

[![@dwbuiten](https://avatars.githubusercontent.com/u/1189609?s=40&v=4)](/dwbuiten) [dwbuiten](/dwbuiten)

dwbuiten left review comments

Assignees

No one assigned

Labels

[bug](/libjpeg-turbo/libjpeg-turbo/labels/bug)
[fixed](/libjpeg-turbo/libjpeg-turbo/labels/fixed)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@kornelski](https://avatars.githubusercontent.com/u/72159?s=52&v=4)](/kornelski) [![@dcommander](https://avatars.githubusercontent.com/u/651941?s=52&v=4)](/dcommander) [![@pgajdos](https://avatars.githubusercontent.com/u/4067843?s=52&v=4)](/pgajdos) [![@dwbuiten](https://avatars.githubusercontent.com/u/1189609?s=52&v=4)](/dwbuiten)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canât perform that action at this time.



=== Content from github.com_dbd77034_20250124_161836.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla%2Fmozjpeg%2Fissues%2F268)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla%2Fmozjpeg%2Fissues%2F268)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=mozilla%2Fmozjpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla](/mozilla)
/
**[mozjpeg](/mozilla/mozjpeg)**
Public

* [Notifications](/login?return_to=%2Fmozilla%2Fmozjpeg) You must be signed in to change notification settings
* [Fork
  418](/login?return_to=%2Fmozilla%2Fmozjpeg)
* [Star
   5.5k](/login?return_to=%2Fmozilla%2Fmozjpeg)

* [Code](/mozilla/mozjpeg)
* [Issues
  96](/mozilla/mozjpeg/issues)
* [Pull requests
  1](/mozilla/mozjpeg/pulls)
* [Actions](/mozilla/mozjpeg/actions)
* [Security](/mozilla/mozjpeg/security)
* [Insights](/mozilla/mozjpeg/pulse)

Additional navigation options

* [Code](/mozilla/mozjpeg)
* [Issues](/mozilla/mozjpeg/issues)
* [Pull requests](/mozilla/mozjpeg/pulls)
* [Actions](/mozilla/mozjpeg/actions)
* [Security](/mozilla/mozjpeg/security)
* [Insights](/mozilla/mozjpeg/pulse)

# NULL Pointer Dereference vulneribility in quantize\_ord\_dither function of mozjpegÂ #268

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkOpenOpen[NULL Pointer Dereference vulneribility in quantize\_ord\_dither function of mozjpeg](#top)#268Copy link[![@leonzhao7](https://avatars.githubusercontent.com/u/1237584?u=3ee6e4007f2d8c4c04ca2a2075687e188dce01e1&v=4&size=80)](/leonzhao7)
## Description

[![@leonzhao7](https://avatars.githubusercontent.com/u/1237584?u=3ee6e4007f2d8c4c04ca2a2075687e188dce01e1&v=4&size=48)](/leonzhao7)[leonzhao7](https://github.com/leonzhao7)opened [on Sep 30, 2017](https://github.com/mozilla/mozjpeg/issues/268#issue-261811403)
## Command and argument

djpeg -crop "1x1+16+16" -onepass -dither ordered -dct float -colors 8 -targa -grayscale -outfile o [infile]

## Crash Information

The output of djpeg with address sanitizer enabled

```
./djpeg -crop "1x1+16+16" -onepass -dither ordered -dct float -colors 8 -targa -grayscale -outfile o /root/fuzz/mozjpeg/output/moz-fuzz02/crashes/001-mozjpeg-quantize_ord_dither-536.crash
Corrupt JPEG data: 94 extraneous bytes before marker 0xdd
ASAN:SIGSEGV
=================================================================
==51824==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000001 (pc 0x7fb8a48a9302 bp 0x7ffe5825e380 sp 0x7ffe5825db08 T0)
    #0 0x7fb8a48a9301  (/lib/x86_64-linux-gnu/libc.so.6+0x8f301)
    #1 0x7fb8a4fe7b1e in __asan_memset (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x8cb1e)
    #2 0x7fb8a4cf3736 in jzero_far /root/mozjpeg/jutils.c:132
    #3 0x7fb8a4ce99f7 in quantize_ord_dither /root/mozjpeg/jquant1.c:536
    #4 0x7fb8a4cc2772 in post_process_1pass /root/mozjpeg/jdpostct.c:145
    #5 0x7fb8a4c91f0e in process_data_simple_main /root/mozjpeg/jdmainct.c:311
    #6 0x7fb8a4c6a16c in jpeg_read_scanlines /root/mozjpeg/jdapistd.c:282
    #7 0x404c89 in main /root/mozjpeg/djpeg.c:731
    #8 0x7fb8a483a82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #9 0x4018e8 in _start (/opt/asan/bin/djpeg+0x4018e8)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV ??:0 ??
==51824==ABORTING

```

and the second POC file, i think thay should be a same vulneribility.

```
./djpeg -crop "1x1+16+16" -onepass -dither ordered -dct float -colors 8 -targa -grayscale -outfile o /root/fuzz/mozjpeg/output/moz-fuzz02/crashes/002-mozjpeg-quantize_ord_dither-536.crash
ASAN:SIGSEGV
=================================================================
==43339==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7f7c8450a9ea bp 0x7ffea3850b70 sp 0x7ffea3850b00 T0)
    #0 0x7f7c8450a9e9 in quantize_ord_dither /root/mozjpeg/jquant1.c:536
    #1 0x7f7c844e3772 in post_process_1pass /root/mozjpeg/jdpostct.c:145
    #2 0x7f7c844b2f0e in process_data_simple_main /root/mozjpeg/jdmainct.c:311
    #3 0x7f7c8448b16c in jpeg_read_scanlines /root/mozjpeg/jdapistd.c:282
    #4 0x7f7c8448b307 in read_and_discard_scanlines /root/mozjpeg/jdapistd.c:316
    #5 0x7f7c8448b4d1 in increment_simple_rowgroup_ctr /root/mozjpeg/jdapistd.c:342
    #6 0x7f7c8448c6d4 in jpeg_skip_scanlines /root/mozjpeg/jdapistd.c:504
    #7 0x404bff in main /root/mozjpeg/djpeg.c:729
    #8 0x7f7c8405b82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #9 0x4018e8 in _start (/opt/asan/bin/djpeg+0x4018e8)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /root/mozjpeg/jquant1.c:536 quantize_ord_dither
==43339==ABORTING

```
## POC file

[mozjpeg-quantize\_ord\_dither-crash.zip](https://github.com/mozilla/mozjpeg/files/1346042/mozjpeg-quantize_ord_dither-crash.zip)

## CREDIT

Zhao Liang, Huawei Weiran Labs

## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canât perform that action at this time.


