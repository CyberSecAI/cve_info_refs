=== Content from bugs.launchpad.net_8fab8a1b_20250124_113408.html ===

[Log in / Register](https://bugs.launchpad.net/mahara/%2Bbug/1480329/%2Blogin)

[![](https://launchpadlibrarian.net/302557383/mahara_64x64.png)](https://launchpad.net/mahara)

## [Mahara](https://launchpad.net/mahara)

* [Overview](https://launchpad.net/mahara)
* [Code](https://code.launchpad.net/mahara)
* [Bugs](https://bugs.launchpad.net/mahara)
* [Blueprints](https://blueprints.launchpad.net/mahara)
* [Translations](https://translations.launchpad.net/mahara)
* [Answers](https://answers.launchpad.net/mahara)

# Session key is not checked during file upload

Bug #1480329 reported by
[abdullah](https://launchpad.net/~eye-magicme)
on 2015-07-31

[256](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [Mahara](https://bugs.launchpad.net/mahara) | Fix Released | High | [Aaron Wells](https://launchpad.net/~u-aaronw) | [Mahara 15.10.0](https://launchpad.net/mahara/%2Bmilestone/15.10.0) |
|  | [1.10](https://bugs.launchpad.net/mahara/1.10) | Fix Released | High | Unassigned | [Mahara 1.10.6](https://launchpad.net/mahara/%2Bmilestone/1.10.6) |
|  | [1.9](https://bugs.launchpad.net/mahara/1.9) | Fix Released | High | Unassigned | [Mahara 1.9.8](https://launchpad.net/mahara/%2Bmilestone/1.9.8) |
|  | [15.04](https://bugs.launchpad.net/mahara/15.04) | Fix Released | High | Unassigned | [Mahara 15.04.3](https://launchpad.net/mahara/%2Bmilestone/15.04.3) |
|  | [15.10](https://bugs.launchpad.net/mahara/15.10) | Fix Released | High | [Aaron Wells](https://launchpad.net/~u-aaronw) | [Mahara 15.10.0](https://launchpad.net/mahara/%2Bmilestone/15.10.0) |

### Bug Description

Hi this is Abdullah ,

I found CSRF make user upload files to any group without his know it can be used to attack admins to upload evil files .

PoC :

video

<http://www.youtube.com/watch?v=M-NyrwKBzmw&feature=youtu.be>

the fix :

check sesskey is valid in (groupfiles.php)

I hope put my name in release note .

Are there a CVE for this bug ?

Thanks

Used mahara least version

See [original description](comments/0)

## CVE References

* [2017-1000147](/bugs/cve/2017-1000147 "Mahara 1.9 before 1.9.8 and 1.10 befo...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristina Hoeppner (kris-hoeppner)](https://launchpad.net/~kris-hoeppner) wrote on 2015-07-31: |  |  | [#1](/mahara/%2Bbug/1480329/comments/1) |
| --- | --- | --- | --- |

Hello Abdullah,

Thank you for your report. Our team will review this and get back to you next week with an update.

Cheers

Kristina

Hello Abdullah,
Thank you for your report. Our team will review this and get back to you next week with an update.
Cheers
Kristina

[Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw)
on 2015-08-05

| Changed in mahara: | |
| --- | --- |
| **importance**: | Undecided → High |
| **assignee**: | nobody → Aaron Wells (u-aaronw) |
| **milestone**: | none → 15.10.0 |
| **status**: | New → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw) wrote on 2015-08-05: |  |  | [#2](/mahara/%2Bbug/1480329/comments/2) |
| --- | --- | --- | --- |

I was able to replicate this bug. Essentially the problem is that the filebrowser Pieform element, in the event of a file upload, does all the necessary processing and returns a result message entirely in the pieform->get\_value() stage (via pieform\_element\_filebrowser\_get\_value()). Thus, it never gets to the form validation stage of pieforms, bypassing our normal sesskey check.

This makes a Cross-Site Request Forgery (CSRF) attack possible, which is what Abdullah's video illustrates. The attacker puts together a form that will generate an HTTP request with all the same parameters as Mahara's own file upload process. If they can then trick a logged-in Mahara user into submitting this form in another tab, then they'll cause the user to upload a file of their choice.

With any other form, we include a "sesskey" value in a hidden variable, which matches a randomly generated key stored in the user's session. Then when the form is submitted, we verify that the sesskey that was passed back from the user's browser matches the sesskey in the session. However, because we're not getting to the validation step in the filebrowser upload process, the sesskey is not checked, and thus CSRF is possible.

The code that did this was added in 2009, so this vulnerability is likely present in all current versions of Mahara, and in all places where the filebrowser element is used (not just group files, but also individual files, institution files, and site files). Notably, this means an attacker could upload a file into the Site Files "Public" area, where it would be accessible by logged-out users outside of Mahara.

I was able to replicate this bug. Essentially the problem is that the filebrowser Pieform element, in the event of a file upload, does all the necessary processing and returns a result message entirely in the pieform->get\_value() stage (via pieform\_element\_filebrowser\_get\_value()). Thus, it never gets to the form validation stage of pieforms, bypassing our normal sesskey check.
This makes a Cross-Site Request Forgery (CSRF) attack possible, which is what Abdullah's video illustrates. The attacker puts together a form that will generate an HTTP request with all the same parameters as Mahara's own file upload process. If they can then trick a logged-in Mahara user into submitting this form in another tab, then they'll cause the user to upload a file of their choice.
With any other form, we include a "sesskey" value in a hidden variable, which matches a randomly generated key stored in the user's session. Then when the form is submitted, we verify that the sesskey that was passed back from the user's browser matches the sesskey in the session. However, because we're not getting to the validation step in the filebrowser upload process, the sesskey is not checked, and thus CSRF is possible.
The code that did this was added in 2009, so this vulnerability is likely present in all current versions of Mahara, and in all places where the filebrowser element is used (not just group files, but also individual files, institution files, and site files). Notably, this means an attacker could upload a file into the Site Files "Public" area, where it would be accessible by logged-out users outside of Mahara.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw) wrote on 2015-08-05: |  |  | [#3](/mahara/%2Bbug/1480329/comments/3) |
| --- | --- | --- | --- |

Hi Abdullah,

Thanks for the bug report! Would you like to have your name added to our security researchers wall?

<https://wiki.mahara.org/wiki/Contributors#Security_researchers>

Cheers,

Aaron

Hi Abdullah,
Thanks for the bug report! Would you like to have your name added to our security researchers wall?
https://wiki.mahara.org/wiki/Contributors#Security\_researchers
Cheers,
Aaron

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw) wrote on 2015-08-05: |  |  | [#4](/mahara/%2Bbug/1480329/comments/4) |
| --- | --- | --- | --- |

To replicate:

One way to replicate it is to create a form that will simulate a file upload. An easier way to check that the sesskey is being validated, though, is like this:

1. Log in to Mahara and go to "Content -> Files".

2. Using the Firefox (or Chrome) developer tools, open up a live view of the page's source code.

3. Find the hidden form variable with ID "files\_sesskey".

4. Delete it, or change its value to "wrongsesskey".

5. Upload a file.

Expected result: The process should error out. Depending on how thorough the Javascript involved is, you may see this error message: "Invalid session key"

Actual result: The file upload finishes successfully

To replicate:
One way to replicate it is to create a form that will simulate a file upload. An easier way to check that the sesskey is being validated, though, is like this:
1. Log in to Mahara and go to "Content -> Files".
2. Using the Firefox (or Chrome) developer tools, open up a live view of the page's source code.
3. Find the hidden form variable with ID "files\_sesskey".
4. Delete it, or change its value to "wrongsesskey".
5. Upload a file.
Expected result: The process should error out. Depending on how thorough the Javascript involved is, you may see this error message: "Invalid session key"
Actual result: The file upload finishes successfully

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw) wrote on 2015-08-05: |  |  | [#5](/mahara/%2Bbug/1480329/comments/5) |
| --- | --- | --- | --- |

Patch for this issue: <https://reviews.mahara.org/5050>

Patch for this issue: https://reviews.mahara.org/5050

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [abdullah (eye-magicme)](https://launchpad.net/~eye-magicme) wrote on 2015-08-05: |  |  | [#6](/mahara/%2Bbug/1480329/comments/6) |
| --- | --- | --- | --- |

Hi, thanks for replay

Please add my name when ever are credit

Abdullah Hussam Gazi (<https://twitter.com/Abdulahhusam>)

And please add in release note

Are there CVE for this bug it is affect many version ?

Thanks .

Hi, thanks for replay
Please add my name when ever are credit
Abdullah Hussam Gazi (https://twitter.com/Abdulahhusam)
And please add in release note
Are there CVE for this bug it is affect many version ?
Thanks .

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristina Hoeppner (kris-hoeppner)](https://launchpad.net/~kris-hoeppner) wrote on 2015-08-05: |  |  | [#7](/mahara/%2Bbug/1480329/comments/7) |
| --- | --- | --- | --- |

Hello Abdullah,

I added you to <https://wiki.mahara.org/wiki/Contributors#Mahara_code>

We do always request CVE numbers and will give you credit there once the assignment has been made.

Cheers

Kristina

Hello Abdullah,
I added you to https://wiki.mahara.org/wiki/Contributors#Mahara\_code
We do always request CVE numbers and will give you credit there once the assignment has been made.
Cheers
Kristina

[Kristina Hoeppner (kris-hoeppner)](https://launchpad.net/~kris-hoeppner)
on 2015-08-05

| **summary**: | - CSRF bug+ Session key is not checked during file upload |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [abdullah (eye-magicme)](https://launchpad.net/~eye-magicme) wrote on 2015-08-06: |  |  | [#8](/mahara/%2Bbug/1480329/comments/8) |
| --- | --- | --- | --- |

Thanks please notice me when the CVE number assignment has been made.

Thanks please notice me when the CVE number assignment has been made.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristina Hoeppner (kris-hoeppner)](https://launchpad.net/~kris-hoeppner) wrote on 2015-08-06: |  |  | [#9](/mahara/%2Bbug/1480329/comments/9) |
| --- | --- | --- | --- |

Hello Abdullah,

Once we have the CVE number, we will add it here to the Launchpad bug.

Cheers

Kristina

Hello Abdullah,
Once we have the CVE number, we will add it here to the Launchpad bug.
Cheers
Kristina

[Aaron Wells (u-aaronw)](https://launchpad.net/~u-aaronw)
on 2015-08-19

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristina Hoeppner (kris-hoeppner)](https://launchpad.net/~kris-hoeppner) wrote on 2015-08-19: |  |  | [#10](/mahara/%2Bbug/1480329/comments/10) |
| --- | --- | --- | --- |

Hello Abdullah,

We included a fix for this issue in our latest releases. See <https://mahara.org/interaction/forum/topic.php?id=7334>

Unfortunately, we don't yet have a CVE number assigned. Once we have it, we will add it here in Launchpad as well as on the forum entry.

Cheers

Kristina

Hello Abdullah,
We included a fix for this issue in our latest releases. See https://mahara.org/interaction/forum/topic.php?id=7334
Unfortunately, we don't yet have a CVE number assigned. Once we have it, we will add it here in Launchpad as well as on the forum entry.
Cheers
Kristina

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [abdullah (eye-magicme)](https://launchpad.net/~eye-magicme) wrote on 2015-08-19: |  |  | [#11](/mahara/%2Bbug/1480329/comments/11) |
| --- | --- | --- | --- |

Thank you !

Thank you !

[Herson Cruz (hersoncruz)](https://launchpad.net/~hersoncruz)
on 2017-06-28

| **description**: | updated |
| --- | --- |

[See full activity log](https://bugs.launchpad.net/mahara/%2Bbug/1480329/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/mahara/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/mahara/%2Bbug/1480329/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/mahara/%2Bbug/1480329/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/mahara/%2Bbug/1480329/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
50c26bf
([Get the code!](https://dev.launchpad.net/))


