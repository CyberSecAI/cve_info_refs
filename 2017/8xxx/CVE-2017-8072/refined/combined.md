=== Content from www.kernel.org_ba40ab57_20250125_191844.html ===
commit d2e4b66b4ef24aeecb0cdef7278aa00850461de9
Author: Greg Kroah-Hartman
Date: Thu Feb 9 08:08:40 2017 +0100
Linux 4.9.9
commit f2a0409a08502d64fbe3990354dff5902b08d2fb
Author: Chris Wilson
Date: Wed Sep 21 14:51:08 2016 +0100
drm/i915/execlists: Reset RING registers upon resume
commit bafb2f7d4755bf1571bd5e9a03b97f3fc4fe69ae upstream.
There is a disparity in the context image saved to disk and our own
bookkeeping - that is we presume the RING\_HEAD and RING\_TAIL match our
stored ce->ring->tail value. However, as we emit WA\_TAIL\_DWORDS into the
ring but may not tell the GPU about them, the GPU may be lagging behind
our bookkeeping. Upon hibernation we do not save stolen pages, presuming
that their contents are volatile. This means that although we start
writing into the ring at tail, the GPU starts executing from its HEAD
and there may be some garbage in between and so the GPU promptly hangs
upon resume.
Testcase: igt/gem\_exec\_suspend/basic-S4
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=96526
Signed-off-by: Chris Wilson
Reviewed-by: Joonas Lahtinen
Link: http://patchwork.freedesktop.org/patch/msgid/20160921135108.29574-3-chris@chris-wilson.co.uk
Cc: Eric Blau
Signed-off-by: Greg Kroah-Hartman
commit 72cd604cfd864b06c5a10d2bb139b19825e0fcbc
Author: Michal Hocko
Date: Fri Feb 3 13:13:26 2017 -0800
fs: break out of iomap\_file\_buffered\_write on fatal signals
commit d1908f52557b3230fbd63c0429f3b4b748bf2b6d upstream.
Tetsuo has noticed that an OOM stress test which performs large write
requests can cause the full memory reserves depletion. He has tracked
this down to the following path
\_\_alloc\_pages\_nodemask+0x436/0x4d0
alloc\_pages\_current+0x97/0x1b0
\_\_page\_cache\_alloc+0x15d/0x1a0 mm/filemap.c:728
pagecache\_get\_page+0x5a/0x2b0 mm/filemap.c:1331
grab\_cache\_page\_write\_begin+0x23/0x40 mm/filemap.c:2773
iomap\_write\_begin+0x50/0xd0 fs/iomap.c:118
iomap\_write\_actor+0xb5/0x1a0 fs/iomap.c:190
? iomap\_write\_end+0x80/0x80 fs/iomap.c:150
iomap\_apply+0xb3/0x130 fs/iomap.c:79
iomap\_file\_buffered\_write+0x68/0xa0 fs/iomap.c:243
? iomap\_write\_end+0x80/0x80
xfs\_file\_buffered\_aio\_write+0x132/0x390 [xfs]
? remove\_wait\_queue+0x59/0x60
xfs\_file\_write\_iter+0x90/0x130 [xfs]
\_\_vfs\_write+0xe5/0x140
vfs\_write+0xc7/0x1f0
? syscall\_trace\_enter+0x1d0/0x380
SyS\_write+0x58/0xc0
do\_syscall\_64+0x6c/0x200
entry\_SYSCALL64\_slow\_path+0x25/0x25
the oom victim has access to all memory reserves to make a forward
progress to exit easier. But iomap\_file\_buffered\_write and other
callers of iomap\_apply loop to complete the full request. We need to
check for fatal signals and back off with a short write instead.
As the iomap\_apply delegates all the work down to the actor we have to
hook into those. All callers that work with the page cache are calling
iomap\_write\_begin so we will check for signals there. dax\_iomap\_actor
has to handle the situation explicitly because it copies data to the
userspace directly. Other callers like iomap\_page\_mkwrite work on a
single page or iomap\_fiemap\_actor do not allocate memory based on the
given len.
Fixes: 68a9f5e7007c ("xfs: implement iomap based buffered write path")
Link: http://lkml.kernel.org/r/20170201092706.9966-2-mhocko@kernel.org
Signed-off-by: Michal Hocko
Reported-by: Tetsuo Handa
Reviewed-by: Christoph Hellwig
Cc: Al Viro
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bf9ab22c350d17af861681348273df5420ac182d
Author: Steve Wise
Date: Thu Dec 15 08:09:35 2016 -0800
iw\_cxgb4: set correct FetchBurstMax for QPs
commit b414fa01c31318383ae29d9d23cb9ca4184bbd86 upstream.
The current QP FetchBurstMax value is 256B, which
is incorrect since a WR can exceed that value. The
result being a partial WR fetched by hardware, and
a fatal "bad WR" error posted by the SGE.
So bump the FetchBurstMax to 512B.
Signed-off-by: Steve Wise
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 13363b6988f60be9f75146a52476a5e8d55f503c
Author: Thomas Gleixner
Date: Tue Jan 31 19:03:21 2017 +0100
x86/irq: Make irq activate operations symmetric
commit aaaec6fc755447a1d056765b11b24d8ff2b81366 upstream.
The recent commit which prevents double activation of interrupts unearthed
interesting code in x86. The code (ab)uses irq\_domain\_activate\_irq() to
reconfigure an already activated interrupt. That trips over the prevention
code now.
Fix it by deactivating the interrupt before activating the new configuration.
Fixes: 08d85f3ea99f1 "irqdomain: Avoid activating interrupts more than once"
Reported-and-tested-by: Mike Galbraith
Reported-and-tested-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Cc: Andrey Ryabinin
Cc: Marc Zyngier
Link: http://lkml.kernel.org/r/alpine.DEB.2.20.1701311901580.3457@nanos
Signed-off-by: Greg Kroah-Hartman
commit e02136282296dbc90f3c88b1cc5202ec0d5ed9f1
Author: Marc Zyngier
Date: Tue Jan 17 16:00:48 2017 +0000
irqdomain: Avoid activating interrupts more than once
commit 08d85f3ea99f1eeafc4e8507936190e86a16ee8c upstream.
Since commit f3b0946d629c ("genirq/msi: Make sure PCI MSIs are
activated early"), we can end-up activating a PCI/MSI twice (once
at allocation time, and once at startup time).
This is normally of no consequences, except that there is some
HW out there that may misbehave if activate is used more than once
(the GICv3 ITS, for example, uses the activate callback
to issue the MAPVI command, and the architecture spec says that
"If there is an existing mapping for the EventID-DeviceID
combination, behavior is UNPREDICTABLE").
While this could be worked around in each individual driver, it may
make more sense to tackle the issue at the core level. In order to
avoid getting in that situation, let's have a per-interrupt flag
to remember if we have already activated that interrupt or not.
Fixes: f3b0946d629c ("genirq/msi: Make sure PCI MSIs are activated early")
Reported-and-tested-by: Andre Przywara
Signed-off-by: Marc Zyngier
Link: http://lkml.kernel.org/r/1484668848-24361-1-git-send-email-marc.zyngier@arm.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit c6b0333baea0acbe792c22ac71a04e40e26a8398
Author: Matt Ranostay
Date: Mon Jan 16 18:04:18 2017 -0800
iio: health: max30100: fixed parenthesis around FIFO count check
commit 828f84ee8f84710ea1818b3565add268bcb824c8 upstream.
FIFO was being read every sample after the "almost full" state was
reached. This was due to an incorrect placement of the parenthesis
in the while condition check.
Note - the fixes tag is not actually correct, but the fix in this patch
would also be needed for it to function correctly so we'll go with that
one. Backports should pick up both.
Signed-off-by: Matt Ranostay
Fixes: b74fccad7 ("iio: health: max30100: correct FIFO check condition")
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 12c2fcf6bcf7da2d861ab0fe36550e39dd783ff9
Author: John Brooks
Date: Wed Jan 18 21:50:39 2017 +0000
iio: dht11: Use usleep\_range instead of msleep for start signal
commit 5c113b5e0082e90d2e1c7b12e96a7b8cf0623e27 upstream.
The DHT22 (AM2302) datasheet specifies that the LOW start pulse should not
exceed 20ms. However, observations with an oscilloscope of an RPi Model 2B
(rev 1.1) communicating with a DHT22 sensor showed that the driver was
consistently sending start pulses longer than 20ms:
Kernel 4.7.10-v7+ (n=132):
Minimum pulse length: 20.20ms
Maximum: 29.84ms
Mean: 24.96ms
StDev: 2.82ms
Sensor response rate: 100%
Read success rate: 76%
On kernel 4.8, the start pulse was so long that the sensor would not even
respond 97% of the time:
Kernel 4.8.16-v7+ (n=100):
Minimum pulse length: 30.4ms
Maximum: 74.4ms
Mean: 39.3ms
StDev: 10.2ms
Sensor response rate: 3%
Read success rate: 3%
The driver would return ETIMEDOUT and write log messages like this:
[ 51.430987] dht11 dht11@0: Only 1 signal edges detected
[ 66.311019] dht11 dht11@0: Only 0 signal edges detected
Replacing msleep(18) with usleep\_range(18000, 20000) made the pulse length
sane again and restored responsiveness:
Kernel 4.8.16-v7+ with usleep\_range (n=123):
Minimum pulse length: 18.16ms
Maximum: 20.20ms
Mean: 19.85ms
StDev: 0.51ms
Sensor response rate: 100%
Read success rate: 84%
Signed-off-by: John Brooks
Reviewed-by: Harald Geyer
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 7baa8491d47d5ad70a22481fbea1913e4b1a746a
Author: Alison Schofield
Date: Sat Jan 14 19:51:52 2017 -0800
iio: health: afe4403: retrieve a valid iio\_dev in suspend/resume
commit a5badd1e97e6caeca78ad74191f12fc923c403a8 upstream.
The suspend/resume functions were using dev\_to\_iio\_dev() to get
the iio\_dev. That only works on IIO dev's. Replace it with spi
functions to get the correct iio\_dev.
Signed-off-by: Alison Schofield
Acked-by: Andrew F. Davis
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 5f0ee562605b4290959675830273d5485616d0cd
Author: Alison Schofield
Date: Sat Jan 14 19:52:50 2017 -0800
iio: health: afe4404: retrieve a valid iio\_dev in suspend/resume
commit 802ecfc113df1e15af1d028427cbbe785ae9cc4a upstream.
The suspend/resume functions were using dev\_to\_iio\_dev() to get
the iio\_dev. That only works on IIO dev's. Replace it with i2c
functions to get the correct iio\_dev.
Signed-off-by: Alison Schofield
Acked-by: Andrew F. Davis
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 54d2ccc4003b7ec3378349df62b1642a2a4aa51c
Author: Alison Schofield
Date: Mon Jan 16 11:27:52 2017 -0800
iio: adc: palmas\_gpadc: retrieve a valid iio\_dev in suspend/resume
commit d1aaf20ee655888c227d5137b7a63551f8d15416 upstream.
The suspend/resume functions were using dev\_to\_iio\_dev() to get
the iio\_dev. That only works on IIO dev's. Use dev\_get\_drvdata()
for a platform device to get the correct iio\_dev.
Signed-off-by: Alison Schofield
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit db0e02ef6b821a42f7270ceaa61e800399d0950c
Author: Rui Miguel Silva
Date: Mon Jan 23 16:32:57 2017 +0000
staging: greybus: timesync: validate platform state callback
commit b17c1bba9cec1727451b906d9a0c209774624873 upstream.
When tearingdown timesync, and not in arche platform, the state platform
callback is not initialized. That will trigger the following NULL
dereferencing.
CallTrace:
? gb\_timesync\_platform\_unlock\_bus+0x11/0x20 [greybus]
gb\_timesync\_teardown+0x85/0xc0 [greybus]
gb\_timesync\_svc\_remove+0xab/0x190 [greybus]
gb\_svc\_del+0x29/0x110 [greybus]
gb\_hd\_del+0x14/0x20 [greybus]
ap\_disconnect+0x24/0x60 [gb\_es2]
usb\_unbind\_interface+0x7a/0x2c0
\_\_device\_release\_driver+0x96/0x150
device\_release\_driver+0x1e/0x30
bus\_remove\_device+0xe7/0x130
device\_del+0x116/0x230
usb\_disable\_device+0x97/0x1f0
usb\_disconnect+0x80/0x260
hub\_event+0x5ca/0x10e0
process\_one\_work+0x126/0x3b0
worker\_thread+0x55/0x4c0
? process\_one\_work+0x3b0/0x3b0
kthread+0xc4/0xe0
? kthread\_park+0xb0/0xb0
ret\_from\_fork+0x22/0x30
So, fix that by adding checks before use the callback.
Fixes: 970dc85bd95d ("greybus: timesync: Add timesync core driver")
Signed-off-by: Rui Miguel Silva
Reviewed-by: Viresh Kumar
Reviewed-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 89cc65c1117f8c5a44439706eb2dce51b0491266
Author: Bjørn Mork
Date: Tue Jan 24 10:31:18 2017 +0100
USB: serial: option: add device ID for HP lt2523 (Novatel E371)
commit 5d03a2fd2292e71936c4235885c35ccc3c94695b upstream.
Yet another laptop vendor rebranded Novatel E371.
Signed-off-by: Bjørn Mork
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 12a9c11c2e198ae879a321f8c3b5a2df73f8424f
Author: Vincent Pelletier
Date: Wed Jan 18 00:57:44 2017 +0000
usb: gadget: f\_fs: Assorted buffer overflow checks.
commit 83e526f2a2fa4b2e82b6bd3ddbb26b70acfa8947 upstream.
OS descriptor head, when flagged as provided, is accessed without
checking if it fits in provided buffer. Verify length before access.
Also, there are other places where buffer length it checked
after accessing offsets which are potentially past the end. Check
buffer length before as well to fail cleanly.
Signed-off-by: Vincent Pelletier
Acked-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit e40d15fce9293acc04db76546edc2689780961af
Author: Tony Lindgren
Date: Tue Jan 24 09:18:57 2017 -0600
usb: musb: Fix host mode error -71 regression
commit 407788b51db6f6aab499d02420082f436abf3238 upstream.
Commit 467d5c980709 ("usb: musb: Implement session bit based runtime PM for
musb-core") started implementing musb generic runtime PM support by
introducing devctl register session bit based state control.
This caused a regression where if a USB mass storage device is connected
to a USB hub, we can get:
usb 1-1: reset high-speed USB device number 2 using musb-hdrc
usb 1-1: device descriptor read/64, error -71
usb 1-1.1: new high-speed USB device number 4 using musb-hdrc
This is because before the USB storage device is connected, musb is
in OTG\_STATE\_A\_SUSPEND. And we currently only set need\_finish\_resume
in musb\_stage0\_irq() and the related code calling finish\_resume\_work
in musb\_resume() and musb\_runtime\_resume() never gets called.
To fix the issue, we can call schedule\_delayed\_work() directly in
musb\_stage0\_irq() to have finish\_resume\_work run.
And we should no longer never get interrupts when when suspended.
We have changed musb to no longer need pm\_runtime\_irqsafe().
The need\_finish\_resume flag was added in commit 9298b4aad37e ("usb:
musb: fix device hotplug behind hub") and no longer applies as far
as I can tell. So let's just remove the earlier code that no longer
is needed.
Fixes: 467d5c980709 ("usb: musb: Implement session bit based runtime PM for musb-core")
Reported-by: Bin Liu
Signed-off-by: Tony Lindgren
Signed-off-by: Bin Liu
Signed-off-by: Greg Kroah-Hartman
commit cbd819e7db3a00630e9a0eecd5f3245e937bde98
Author: Lukáš Lalinský
Date: Fri Jan 20 19:46:34 2017 +0100
USB: Add quirk for WORLDE easykey.25 MIDI keyboard
commit d9b2997e4a0a874e452df7cdd7de5a54502bd0aa upstream.
Add a quirk for WORLDE easykey.25 MIDI keyboard (idVendor=0218,
idProduct=0401). The device reports that it has config string
descriptor at index 3, but when the system selects the configuration
and tries to get the description, it returns a -EPROTO error,
the communication restarts and this keeps repeating over and over again.
Not requesting the string descriptor makes the device work correctly.
Relevant info from Wireshark:
[...]
CONFIGURATION DESCRIPTOR
bLength: 9
bDescriptorType: 0x02 (CONFIGURATION)
wTotalLength: 101
bNumInterfaces: 2
bConfigurationValue: 1
iConfiguration: 3
Configuration bmAttributes: 0xc0 SELF-POWERED NO REMOTE-WAKEUP
1... .... = Must be 1: Must be 1 for USB 1.1 and higher
.1.. .... = Self-Powered: This device is SELF-POWERED
..0. .... = Remote Wakeup: This device does NOT support remote wakeup
bMaxPower: 50 (100mA)
[...]
45 0.369104 host 2.38.0 USB 64 GET DESCRIPTOR Request STRING
[...]
URB setup
bmRequestType: 0x80
1... .... = Direction: Device-to-host
.00. .... = Type: Standard (0x00)
...0 0000 = Recipient: Device (0x00)
bRequest: GET DESCRIPTOR (6)
Descriptor Index: 0x03
bDescriptorType: 0x03
Language Id: English (United States) (0x0409)
wLength: 255
46 0.369255 2.38.0 host USB 64 GET DESCRIPTOR Response STRING[Malformed Packet]
[...]
Frame 46: 64 bytes on wire (512 bits), 64 bytes captured (512 bits) on interface 0
USB URB
[Source: 2.38.0]
[Destination: host]
URB id: 0xffff88021f62d480
URB type: URB\_COMPLETE ('C')
URB transfer type: URB\_CONTROL (0x02)
Endpoint: 0x80, Direction: IN
Device: 38
URB bus id: 2
Device setup request: not relevant ('-')
Data: present (0)
URB sec: 1484896277
URB usec: 455031
URB status: Protocol error (-EPROTO) (-71)
URB length [bytes]: 0
Data length [bytes]: 0
[Request in: 45]
[Time from request: 0.000151000 seconds]
Unused Setup Header
Interval: 0
Start frame: 0
Copy of Transfer Flags: 0x00000200
Number of ISO descriptors: 0
[Malformed Packet: USB]
[Expert Info (Error/Malformed): Malformed Packet (Exception occurred)]
[Malformed Packet (Exception occurred)]
[Severity level: Error]
[Group: Malformed]
Signed-off-by: Lukáš Lalinský
Signed-off-by: Greg Kroah-Hartman
commit 4807725aab0bf4ed66e0680f41c7e7666084cb8f
Author: Marcel J.E. Mol
Date: Mon Jan 30 19:26:40 2017 +0100
USB: serial: pl2303: add ATEN device ID
commit d07830db1bdb254e4b50d366010b219286b8c937 upstream.
Seems that ATEN serial-to-usb devices using pl2303 exist with
different device ids. This patch adds a missing device ID so it
is recognised by the driver.
Signed-off-by: Marcel J.E. Mol
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 8bc382a9652bc17277caf2c3d9dad6d0b55bb7db
Author: Aleksander Morgado
Date: Wed Jan 18 21:31:31 2017 +0100
USB: serial: qcserial: add Dell DW5570 QDL
commit 24d615a694d649aa2e167c3f97f62bdad07e3f84 upstream.
The Dell DW5570 is a re-branded Sierra Wireless MC8805 which will by
default boot with vid 0x413c and pid 0x81a3. When triggered QDL download
mode, the device switches to pid 0x81a6 and provides the standard TTY
used for firmware upgrade.
Signed-off-by: Aleksander Morgado
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 0dcbd0aa44e6b2aa725175dd5933cb706fb1e2c5
Author: Radim Krčmář
Date: Wed Feb 1 14:19:53 2017 +0100
KVM: x86: do not save guest-unsupported XSAVE state
commit 00c87e9a70a17b355b81c36adedf05e84f54e10d upstream.
Saving unsupported state prevents migration when the new host does not
support a XSAVE feature of the original host, even if the feature is not
exposed to the guest.
We've masked host features with guest-visible features before, with
4344ee981e21 ("KVM: x86: only copy XSAVE state for the supported
features") and dropped it when implementing XSAVES. Do it again.
Fixes: df1daba7d1cb ("KVM: x86: support XSAVES usage in the host")
Reviewed-by: Paolo Bonzini
Signed-off-by: Radim Krčmář
Signed-off-by: Greg Kroah-Hartman
commit bc05a2e940fe96fbacf879e73139d8a66c39ab8e
Author: Tony Lindgren
Date: Thu Jan 19 08:49:08 2017 -0800
dmaengine: cppi41: Fix oops in cppi41\_runtime\_resume
commit 362f4562466c3b9490e733e06999025638310d4a upstream.
Commit fdea2d09b997 ("dmaengine: cppi41: Add basic PM runtime support")
together with recent MUSB changes allowed USB and DMA on BeagleBone to idle
when no cable is connected. But looks like few corner case issues still
remain.
Looks like just by re-plugging USB cable about ten or so times on BeagleBone
when configured in USB peripheral mode we can get warnings and eventually
trigger an oops in cppi41 DMA:
WARNING: CPU: 0 PID: 14 at drivers/dma/cppi41.c:1154 cppi41\_runtime\_suspend+
x28/0x38 [cppi41]
...
WARNING: CPU: 0 PID: 14 at drivers/dma/cppi41.c:452
push\_desc\_queue+0x94/0x9c [cppi41]
...
Unable to handle kernel NULL pointer dereference at virtual
address 00000104
pgd = c0004000
[00000104] \*pgd=00000000
Internal error: Oops: 805 [#1] SMP ARM
...
[] (cppi41\_runtime\_resume [cppi41]) from []
(\_\_rpm\_callback+0xc0/0x214)
[] (\_\_rpm\_callback) from [] (rpm\_callback+0x20/0x80)
[] (rpm\_callback) from [] (rpm\_resume+0x504/0x78c)
[] (rpm\_resume) from [] (pm\_runtime\_work+0x60/0xa8)
[] (pm\_runtime\_work) from [] (process\_one\_work+0x2b4/0x808)
This is because of a race with runtime PM and cppi41\_dma\_issue\_pending()
as reported by Alexandre Bailon  in earlier
set of patches. Based on mailing list discussions we however came to the
conclusion that a different fix from Alexandre's fix is needed in order
to guarantee that DMA is really active when we try to use it.
To fix the issue, we need to add a driver specific flag as we otherwise
can have -EINPROGRESS state set by runtime PM and can't rely on
pm\_runtime\_active() to tell us when we can use the DMA.
And we need to make sure the DMA transfers get triggered in the queued
order. So let's always queue the transfers, then flush the queue
from both cppi41\_dma\_issue\_pending() and cppi41\_runtime\_resume()
as suggested by Grygorii Strashko  in an
earlier example patch.
For reference, this is also documented in Documentation/power/runtime\_pm.txt
in the example at the end of the file as pointed out by Grygorii Strashko
.
Based on earlier patches from Alexandre Bailon
and Grygorii Strashko  modified based on
testing and what was discussed on the mailing lists.
Fixes: fdea2d09b997 ("dmaengine: cppi41: Add basic PM runtime support")
Cc: Andy Shevchenko
Cc: Bin Liu
Cc: Grygorii Strashko
Cc: Kevin Hilman
Cc: Patrick Titiano
Cc: Sergei Shtylyov
Reported-by: Alexandre Bailon
Signed-off-by: Tony Lindgren
Tested-by: Bin Liu
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 2c2e7fe7c9c5524914772b2d44febbf5b98546d3
Author: Tony Lindgren
Date: Thu Jan 19 08:49:07 2017 -0800
dmaengine: cppi41: Fix runtime PM timeouts with USB mass storage
commit ae4a3e028bb8b59e7cfeb0cc9ef03d885182ce8b upstream.
Commit fdea2d09b997 ("dmaengine: cppi41: Add basic PM runtime support")
added runtime PM support for cppi41, but had corner case issues. Some of
the issues were fixed with commit 098de42ad670 ("dmaengine: cppi41: Fix
unpaired pm runtime when only a USB hub is connected"). That fix however
caused a new regression where we can get error -115 messages with USB on
BeagleBone when connecting a USB mass storage device to a hub.
This is because when connecting a USB mass storage device to a hub, the
initial DMA transfers can take over 200ms to complete and cppi41
autosuspend delay times out.
To fix the issue, we want to implement refcounting for chan\_busy array
that contains the active dma transfers. Increasing the autosuspend delay
won't help as that the delay could be potentially seconds, and it's best
to let the USB subsystem to deal with the timeouts on errors.
The earlier attempt for runtime PM was buggy as the pm\_runtime\_get/put()
calls could get unpaired easily as they did not follow the state of
the chan\_busy array as described in commit 098de42ad670 ("dmaengine:
cppi41: Fix unpaired pm runtime when only a USB hub is connected".
Let's fix the issue by adding pm\_runtime\_get() to where a new transfer
is added to the chan\_busy array, and calls to pm\_runtime\_put() where
chan\_busy array entry is cleared. This prevents any autosuspend timeouts
from happening while dma transfers are active.
Fixes: 098de42ad670 ("dmaengine: cppi41: Fix unpaired pm runtime when
only a USB hub is connected")
Fixes: fdea2d09b997 ("dmaengine: cppi41: Add basic PM runtime support")
Cc: Andy Shevchenko
Cc: Bin Liu
Cc: Grygorii Strashko
Cc: Kevin Hilman
Cc: Patrick Titiano
Cc: Sergei Shtylyov
Signed-off-by: Tony Lindgren
Tested-by: Bin Liu
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit bebb9d75e84d38c7a10fcd4619fb1554a46f4715
Author: Thomas Gleixner
Date: Tue Jan 31 23:58:39 2017 +0100
perf/x86/intel/uncore: Clean up hotplug conversion fallout
commit 1aa6cfd33df492939b0be15ebdbcff1f8ae5ddb6 upstream.
The recent conversion to the hotplug state machine kept two mechanisms from
the original code:
1) The first\_init logic which adds the number of online CPUs in a package
to the refcount. That's wrong because the callbacks are executed for
all online CPUs.
Remove it so the refcounting is correct.
2) The on\_each\_cpu() call to undo box->init() in the error handling
path. That's bogus because when the prepare callback fails no box has
been initialized yet.
Remove it.
Signed-off-by: Thomas Gleixner
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Sebastian Siewior
Cc: Stephane Eranian
Cc: Vince Weaver
Cc: Yasuaki Ishimatsu
Fixes: 1a246b9f58c6 ("perf/x86/intel/uncore: Convert to hotplug state machine")
Link: http://lkml.kernel.org/r/20170131230141.298032324@linutronix.de
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit e6bd712154aaf121bff1791431854886f5983712
Author: Jason Gerecke
Date: Thu Jan 26 09:06:22 2017 -0800
HID: wacom: Fix poor prox handling in 'wacom\_pl\_irq'
commit 282e4637bc1c0b338708bcebd09d31c69abec070 upstream.
Commit 025bcc1 performed cleanup work on the 'wacom\_pl\_irq' function, making
it follow the standards used in the rest of the codebase. The change
unintiontionally allowed the function to send input events from reports
that are not marked as being in prox. This can cause problems as the
report values for X, Y, etc. are not guaranteed to be correct. In
particular, occasionally the tablet will send a report with these values
set to zero. If such a report is received it can caus an unexpected jump
in the XY position.
This patch surrounds more of the processing code with a proximity check,
preventing these zeroed reports from overwriting the current state. To
be safe, only the tool type and ABS\_MISC events should be reported when
the pen is marked as being out of prox.
Fixes: 025bcc1540 ("HID: wacom: Simplify 'wacom\_pl\_irq'")
Signed-off-by: Jason Gerecke
Reviewed-by: Ping Cheng
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit f24bc920612ccc68edb8ff4ee6e117a3e0a52304
Author: Ardinartsev Nikita
Date: Thu Jan 26 16:54:42 2017 +0300
HID: hid-lg: Fix immediate disconnection of Logitech Rumblepad 2
commit 877a021e08ccb6434718c0cc781fdf943c884cc0 upstream.
With NOGET quirk Logitech F510 is now fully workable in dinput mode including
rumble effects (according to fftest).
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=117091
[jkosina@suse.cz: fix patch format]
Signed-off-by: Ardinartsev Nikita
Acked-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 80246551c7d7085f177b52020cd54f8d44c86728
Author: Colin Ian King
Date: Thu Jan 26 17:34:40 2017 +0000
HID: usbhid: Quirk a AMI virtual mouse and keyboard with ALWAYS\_POLL
commit ed9ab4287f96e66340e0390e2c583f2f9110cba0 upstream.
Quirking the following AMI USB device with ALWAYS\_POLL fixes an AMI
virtual keyboard and mouse from not responding and timing out when
it is attached to a ppc64el Power 8 system and when we have some
rapid open/closes on the mouse device.
usb 1-3: new high-speed USB device number 2 using xhci\_hcd
usb 1-3: New USB device found, idVendor=046b, idProduct=ff01
usb 1-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
usb 1-3: Product: Virtual Hub
usb 1-3: Manufacturer: American Megatrends Inc.
usb 1-3: SerialNumber: serial
usb 1-3.3: new high-speed USB device number 3 using xhci\_hcd
usb 1-3.3: New USB device found, idVendor=046b, idProduct=ff31
usb 1-3.3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
usb 1-3.3: Product: Virtual HardDisk Device
usb 1-3.3: Manufacturer: American Megatrends Inc.
usb 1-3.4: new low-speed USB device number 4 using xhci\_hcd
usb 1-3.4: New USB device found, idVendor=046b, idProduct=ff10
usb 1-3.4: New USB device strings: Mfr=1, Product=2, SerialNumber=0
usb 1-3.4: Product: Virtual Keyboard and Mouse
usb 1-3.4: Manufacturer: American Megatrends Inc.
With the quirk I have not been able to trigger the issue with
half an hour of saturation soak testing.
Signed-off-by: Colin Ian King
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 40add19d3897dda97086ec7a73cf4e8daf7c00ee
Author: Johannes Berg
Date: Fri Dec 2 12:03:36 2016 +0100
iwlwifi: mvm: avoid crash on restart w/o reserved queues
commit 03c902bff524e0cf664737a33f2365f7837040bf upstream.
When the firmware restarts in a situation in which any station
has no queue reserved anymore because that queue was used, the
code will crash trying to access the queue\_info array at the
offset 255, which is far too big. Fix this by checking that a
queue is actually reserved before writing its status.
Fixes: 8d98ae6eb0d5 ("iwlwifi: mvm: re-assign old queues after hw restart in dqa mode")
Signed-off-by: Johannes Berg
Signed-off-by: Luca Coelho
Signed-off-by: Greg Kroah-Hartman
commit 97663735a96f0cd7c851bbb8f08cff66d617220c
Author: Jürg Billeter
Date: Mon Oct 10 18:30:01 2016 +0200
iwlwifi: fix double hyphen in MODULE\_FIRMWARE for 8000
commit 7941c59e45f3b6d30e07375e9b6713427e0a9f98 upstream.
Mistakenly, the driver is trying to load the 8000C firmware with an
incorrect name (i.e. with two hyphens where there should be only one)
and that fails. Fix that by removing the hyphen from the format
macro.
Fixes: e1ba684f762b ("iwlwifi: 8000: fix MODULE\_FIRMWARE input")
Signed-off-by: Jürg Billeter
Signed-off-by: Luca Coelho
Signed-off-by: Greg Kroah-Hartman
commit 3d8ec7d2d5f9fdb83617f044ad9bcfa3cf6830b9
Author: Andy Shevchenko
Date: Tue Jan 24 17:28:22 2017 +0200
pinctrl: intel: merrifield: Add missed check in mrfld\_config\_set()
commit 19b26d92dfb70f56440c187a20c49102ab648b97 upstream.
Not every pin can be configured. Add missed check to prevent access
violation.
Fixes: 4e80c8f50574 ("pinctrl: intel: Add Intel Merrifield pin controller support")
Acked-by: Mika Westerberg
Signed-off-by: Andy Shevchenko
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 2cf6c49264e40e395e73fef11f487b10b05548b4
Author: Andy Shevchenko
Date: Thu Jan 26 19:24:08 2017 +0200
pinctrl: baytrail: Debounce register is one per community
commit 1b89970d81bbd52720fc64a3fe9572ee33588363 upstream.
Debounce value is set globally per community. Otherwise user will easily
get a kernel crash when they start using the feature:
BUG: unable to handle kernel paging request at ffffc900003be000
IP: byt\_gpio\_dbg\_show+0xa9/0x430
Make it clear in byt\_gpio\_reg().
Note that this fix just prevents kernel to crash, but doesn't make any
difference to the existing logic. It means the last caller will win the
trade and debounce value will be configured accordingly. The actual
logic fix needs to be thought about and it's not as important as crash
fix. That's why the latter goes separately and right now.
Fixes: 658b476c742f ("pinctrl: baytrail: Add debounce configuration")
Cc: Cristina Ciocan
Signed-off-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Acked-by: Mika Westerberg
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 449d3ecfbd7640dc763dbf333131858ead6c3f11
Author: Michael S. Tsirkin
Date: Fri Feb 3 05:43:52 2017 +0200
Revert "vring: Force use of DMA API for ARM-based systems with legacy devices"
commit 0d5415b489f68b58e1983a53793d25d53098ed4b upstream.
This reverts commit c7070619f3408d9a0dffbed9149e6f00479cf43b.
This has been shown to regress on some ARM systems:
by forcing on DMA API usage for ARM systems, we have inadvertently
kicked open a hornets' nest in terms of cache-coherency. Namely that
unless the virtio device is explicitly described as capable of coherent
DMA by firmware, the DMA APIs on ARM and other DT-based platforms will
assume it is non-coherent. This turns out to cause a big problem for the
likes of QEMU and kvmtool, which generate virtio-mmio devices in their
guest DTs but neglect to add the often-overlooked "dma-coherent"
property; as a result, we end up with the guest making non-cacheable
accesses to the vring, the host doing so cacheably, both talking past
each other and things going horribly wrong.
We are working on a safer work-around.
Fixes: c7070619f340 ("vring: Force use of DMA API for ARM-based systems with legacy devices")
Reported-by: Robin Murphy
Signed-off-by: Will Deacon
Signed-off-by: Michael S. Tsirkin
Acked-by: Marc Zyngier
Signed-off-by: Greg Kroah-Hartman
commit 16f61dee7e7cb378216ff59ffeacf157efad6c82
Author: Rafał Miłecki
Date: Fri Jan 13 12:23:35 2017 +0100
Revert "bcma: init serial console directly from ChipCommon code"
commit 7195439d1d71bc4a6c33cfb57bc669a7cd041041 upstream.
This reverts commit 4c81acab3816 ("bcma: init serial console directly
from ChipCommon code") as it broke IRQ assignment. Getting IRQ with
bcma\_core\_irq helper on SoC requires MIPS core to be set. It happens
\*after\* ChipCommon initialization so we can't do this so early.
This fixes a user reported regression. It wasn't critical as serial was
still somehow working but lack of IRQs was making in unreliable.
Fixes: 4c81acab3816 ("bcma: init serial console directly from ChipCommon code")
Reported-by: Felix Fietkau
Signed-off-by: Rafał Miłecki
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 12f822d23deee45421bf65dc9f5ff0fdcc783701
Author: Douglas Miller
Date: Sat Jan 28 06:42:20 2017 -0600
percpu-refcount: fix reference leak during percpu-atomic transition
commit 966d2b04e070bc040319aaebfec09e0144dc3341 upstream.
percpu\_ref\_tryget() and percpu\_ref\_tryget\_live() should return
"true" IFF they acquire a reference. But the return value from
atomic\_long\_inc\_not\_zero() is a long and may have high bits set,
e.g. PERCPU\_COUNT\_BIAS, and the return value of the tryget routines
is bool so the reference may actually be acquired but the routines
return "false" which results in a reference leak since the caller
assumes it does not need to do a corresponding percpu\_ref\_put().
This was seen when performing CPU hotplug during I/O, as hangs in
blk\_mq\_freeze\_queue\_wait where percpu\_ref\_kill (blk\_mq\_freeze\_queue\_start)
raced with percpu\_ref\_tryget (blk\_mq\_timeout\_work).
Sample stack trace:
\_\_switch\_to+0x2c0/0x450
\_\_schedule+0x2f8/0x970
schedule+0x48/0xc0
blk\_mq\_freeze\_queue\_wait+0x94/0x120
blk\_mq\_queue\_reinit\_work+0xb8/0x180
blk\_mq\_queue\_reinit\_prepare+0x84/0xa0
cpuhp\_invoke\_callback+0x17c/0x600
cpuhp\_up\_callbacks+0x58/0x150
\_cpu\_up+0xf0/0x1c0
do\_cpu\_up+0x120/0x150
cpu\_subsys\_online+0x64/0xe0
device\_online+0xb4/0x120
online\_store+0xb4/0xc0
dev\_attr\_store+0x68/0xa0
sysfs\_kf\_write+0x80/0xb0
kernfs\_fop\_write+0x17c/0x250
\_\_vfs\_write+0x6c/0x1e0
vfs\_write+0xd0/0x270
SyS\_write+0x6c/0x110
system\_call+0x38/0xe0
Examination of the queue showed a single reference (no PERCPU\_COUNT\_BIAS,
and \_\_PERCPU\_REF\_DEAD, \_\_PERCPU\_REF\_ATOMIC set) and no requests.
However, conditions at the time of the race are count of PERCPU\_COUNT\_BIAS + 0
and \_\_PERCPU\_REF\_DEAD and \_\_PERCPU\_REF\_ATOMIC set.
The fix is to make the tryget routines use an actual boolean internally instead
of the atomic long result truncated to a int.
Fixes: e625305b3907 percpu-refcount: make percpu\_ref based on longs instead of ints
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=190751
Signed-off-by: Douglas Miller
Reviewed-by: Jens Axboe
Signed-off-by: Tejun Heo
Fixes: e625305b3907 ("percpu-refcount: make percpu\_ref based on longs instead of ints")
Signed-off-by: Greg Kroah-Hartman
commit 8ee8ff9e2652dc9e79230dfcb3c70d0efbcde493
Author: Rask Ingemann Lambertsen
Date: Sat Jan 21 17:11:43 2017 +0100
regulator: axp20x: AXP806: Fix dcdcb being set instead of dcdce
commit d0e287a401d9acf67b75180b26e2d62b7d482652 upstream.
A typo or copy-paste bug means that the register access intended for
regulator dcdce goes to dcdcb instead. This patch corrects it.
Fixes: 2ca342d391e3 (regulator: axp20x: Support AXP806 variant)
Signed-off-by: Rask Ingemann Lambertsen
Acked-by: Chen-Yu Tsai
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 1594edd9ea0d75ef106bffc23c2b07b509f3301c
Author: Halil Pasic
Date: Mon Jan 30 11:09:36 2017 +0100
vhost: fix initialization for vq->is\_le
commit cda8bba0f99d25d2061c531113c14fa41effc3ae upstream.
Currently, under certain circumstances vhost\_init\_is\_le does just a part
of the initialization job, and depends on vhost\_reset\_is\_le being called
too. For this reason vhost\_vq\_init\_access used to call vhost\_reset\_is\_le
when vq->private\_data is NULL. This is not only counter intuitive, but
also real a problem because it breaks vhost\_net. The bug was introduced to
vhost\_net with commit 2751c9882b94 ("vhost: cross-endian support for
legacy devices"). The symptom is corruption of the vq's used.idx field
(virtio) after VHOST\_NET\_SET\_BACKEND was issued as a part of the vhost
shutdown on a vq with pending descriptors.
Let us make sure the outcome of vhost\_init\_is\_le never depend on the state
it is actually supposed to initialize, and fix virtio\_net by removing the
reset from vhost\_vq\_init\_access.
With the above, there is no reason for vhost\_reset\_is\_le to do just half
of the job. Let us make vhost\_reset\_is\_le reinitialize is\_le.
Signed-off-by: Halil Pasic
Reported-by: Michael A. Tebolt
Reported-by: Dr. David Alan Gilbert
Fixes: commit 2751c9882b94 ("vhost: cross-endian support for legacy devices")
Signed-off-by: Michael S. Tsirkin
Reviewed-by: Greg Kurz
Tested-by: Michael A. Tebolt
Signed-off-by: Greg Kroah-Hartman
commit 04eb7db25bb1bcf4ee1631d1099fc03308929c12
Author: Gabriel Krisman Bertazi
Date: Mon Jan 16 12:23:42 2017 -0200
mmc: sdhci: Ignore unexpected CARD\_INT interrupts
commit 161e6d44a5e2d3f85365cb717d60e363171b39e6 upstream.
One of our kernelCI boxes hanged at boot because a faulty eSDHC device
was triggering spurious CARD\_INT interrupts for SD cards, causing CMD52
reads, which are not allowed for SD devices. This adds a sanity check
to the interruption path, preventing that illegal command from getting
sent if the CARD\_INT interruption should be disabled.
This quirk allows that particular machine to resume boot despite the
faulty hardware, instead of getting hung dealing with thousands of
mishandled interrupts.
Suggested-by: Adrian Hunter
Signed-off-by: Gabriel Krisman Bertazi
Acked-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 1d88791d5ed5dae4ff8cbbf6147e90ff95d92ba9
Author: Tejun Heo
Date: Thu Jan 26 16:47:28 2017 -0500
cgroup: don't online subsystems before cgroup\_name/path() are operational
commit 07cd12945551b63ecb1a349d50a6d69d1d6feb4a upstream.
While refactoring cgroup creation, a5bca2152036 ("cgroup: factor out
cgroup\_create() out of cgroup\_mkdir()") incorrectly onlined subsystems
before the new cgroup is associated with it kernfs\_node. This is fine
for cgroup proper but cgroup\_name/path() depend on the associated
kernfs\_node and if a subsystem makes the new cgroup\_subsys\_state
visible, which they're allowed to after onlining, it can lead to NULL
dereference.
The current code performs cgroup creation and subsystem onlining in
cgroup\_create() and cgroup\_mkdir() makes the cgroup and subsystems
visible afterwards. There's no reason to online the subsystems early
and we can simply drop cgroup\_apply\_control\_enable() call from
cgroup\_create() so that the subsystems are onlined and made visible at
the same time.
Signed-off-by: Tejun Heo
Reported-by: Konstantin Khlebnikov
Fixes: a5bca2152036 ("cgroup: factor out cgroup\_create() out of cgroup\_mkdir()")
Signed-off-by: Greg Kroah-Hartman
commit a150e08704b24311a4d6215aade46691d6a7006a
Author: Oliver Hartkopp
Date: Wed Jan 18 21:30:51 2017 +0100
can: bcm: fix hrtimer/tasklet termination in bcm op removal
commit a06393ed03167771246c4c43192d9c264bc48412 upstream.
When removing a bcm tx operation either a hrtimer or a tasklet might run.
As the hrtimer triggers its associated tasklet and vice versa we need to
take care to mutually terminate both handlers.
Reported-by: Michael Josenhans
Signed-off-by: Oliver Hartkopp
Tested-by: Michael Josenhans
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit a93ae8dccc3c723ed7a629dab37a3392387acd79
Author: Steven Rostedt (VMware)
Date: Mon Jan 30 19:27:10 2017 -0500
tracing: Fix hwlat kthread migration
commit 79c6f448c8b79c321e4a1f31f98194e4f6b6cae7 upstream.
The hwlat tracer creates a kernel thread at start of the tracer. It is
pinned to a single CPU and will move to the next CPU after each period of
running. If the user modifies the migration thread's affinity, it will not
change after that happens.
The original code created the thread at the first instance it was called,
but later was changed to destroy the thread after the tracer was finished,
and would not be created until the next instance of the tracer was
established. The code that initialized the affinity was only called on the
initial instantiation of the tracer. After that, it was not initialized, and
the previous affinity did not match the current newly created one, making
it appear that the user modified the thread's affinity when it did not, and
the thread failed to migrate again.
Fixes: 0330f7aa8ee6 ("tracing: Have hwlat trace migrate across tracing\_cpumask CPUs")
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit b67c7d39bc284776c27eeaefd424046c742b0d93
Author: Michal Hocko
Date: Fri Feb 3 13:13:29 2017 -0800
mm, fs: check for fatal signals in do\_generic\_file\_read()
commit 5abf186a30a89d5b9c18a6bf93a2c192c9fd52f6 upstream.
do\_generic\_file\_read() can be told to perform a large request from
userspace. If the system is under OOM and the reading task is the OOM
victim then it has an access to memory reserves and finishing the full
request can lead to the full memory depletion which is dangerous. Make
sure we rather go with a short read and allow the killed task to
terminate.
Link: http://lkml.kernel.org/r/20170201092706.9966-3-mhocko@kernel.org
Signed-off-by: Michal Hocko
Reviewed-by: Christoph Hellwig
Cc: Tetsuo Handa
Cc: Al Viro
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6cb0497aec810617388dfe674209cd417f509844
Author: Toshi Kani
Date: Fri Feb 3 13:13:23 2017 -0800
base/memory, hotplug: fix a kernel oops in show\_valid\_zones()
commit a96dfddbcc04336bbed50dc2b24823e45e09e80c upstream.
Reading a sysfs "memoryN/valid\_zones" file leads to the following oops
when the first page of a range is not backed by struct page.
show\_valid\_zones() assumes that 'start\_pfn' is always valid for
page\_zone().
BUG: unable to handle kernel paging request at ffffea017a000000
IP: show\_valid\_zones+0x6f/0x160
This issue may happen on x86-64 systems with 64GiB or more memory since
their memory block size is bumped up to 2GiB. [1] An example of such
systems is desribed below. 0x3240000000 is only aligned by 1GiB and
this memory block starts from 0x3200000000, which is not backed by
struct page.
BIOS-e820: [mem 0x0000003240000000-0x000000603fffffff] usable
Since test\_pages\_in\_a\_zone() already checks holes, fix this issue by
extending this function to return 'valid\_start' and 'valid\_end' for a
given range. show\_valid\_zones() then proceeds with the valid range.
[1] 'Commit bdee237c0343 ("x86: mm: Use 2GB memory block size on
large-memory x86-64 systems")'
Link: http://lkml.kernel.org/r/20170127222149.30893-3-toshi.kani@hpe.com
Signed-off-by: Toshi Kani
Cc: Greg Kroah-Hartman
Cc: Zhang Zhen
Cc: Reza Arbab
Cc: David Rientjes
Cc: Dan Williams
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
commit 72f7419610c838abc5e3fde87835a5581e8e368c
Author: Toshi Kani
Date: Fri Feb 3 13:13:20 2017 -0800
mm/memory\_hotplug.c: check start\_pfn in test\_pages\_in\_a\_zone()
commit deb88a2a19e85842d79ba96b05031739ec327ff4 upstream.
Patch series "fix a kernel oops when reading sysfs valid\_zones", v2.
A sysfs memory file is created for each 2GiB memory block on x86-64 when
the system has 64GiB or more memory. [1] When the start address of a
memory block is not backed by struct page, i.e. a memory range is not
aligned by 2GiB, reading its 'valid\_zones' attribute file leads to a
kernel oops. This issue was observed on multiple x86-64 systems with
more than 64GiB of memory. This patch-set fixes this issue.
Patch 1 first fixes an issue in test\_pages\_in\_a\_zone(), which does not
test the start section.
Patch 2 then fixes the kernel oops by extending test\_pages\_in\_a\_zone()
to return valid [start, end).
Note for stable kernels: The memory block size change was made by commit
bdee237c0343 ("x86: mm: Use 2GB memory block size on large-memory x86-64
systems"), which was accepted to 3.9. However, this patch-set depends
on (and fixes) the change to test\_pages\_in\_a\_zone() made by commit
5f0f2887f4de ("mm/memory\_hotplug.c: check for missing sections in
test\_pages\_in\_a\_zone()"), which was accepted to 4.4.
So, I recommend that we backport it up to 4.4.
[1] 'Commit bdee237c0343 ("x86: mm: Use 2GB memory block size on
large-memory x86-64 systems")'
This patch (of 2):
test\_pages\_in\_a\_zone() does not check 'start\_pfn' when it is aligned by
section since 'sec\_end\_pfn' is set equal to 'pfn'. Since this function
is called for testing the range of a sysfs memory file, 'start\_pfn' is
always aligned by section.
Fix it by properly setting 'sec\_end\_pfn' to the next section pfn.
Also make sure that this function returns 1 only when the range belongs
to a zone.
Link: http://lkml.kernel.org/r/20170127222149.30893-2-toshi.kani@hpe.com
Signed-off-by: Toshi Kani
Cc: Andrew Banman
Cc: Reza Arbab
Cc: Greg KH
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9e255997c2e169ba4bca92e6f84324581b28abbe
Author: Rabin Vincent
Date: Fri Jan 13 15:00:16 2017 +0100
cifs: initialize file\_info\_lock
commit 81ddd8c0c5e1cb41184d66567140cb48c53eb3d1 upstream.
Reviewed-by: Jeff Layton
file\_info\_lock is not initalized in initiate\_cifs\_search(), leading to the
following splat after a simple "mount.cifs ... dir && ls dir/":
BUG: spinlock bad magic on CPU#0, ls/486
lock: 0xffff880009301110, .magic: 00000000, .owner: /-1, .owner\_cpu: 0
CPU: 0 PID: 486 Comm: ls Not tainted 4.9.0 #27
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)
ffffc900042f3db0 ffffffff81327533 0000000000000000 ffff880009301110
ffffc900042f3dd0 ffffffff810baf75 ffff880009301110 ffffffff817ae077
ffffc900042f3df0 ffffffff810baff6 ffff880009301110 ffff880008d69900
Call Trace:
[] dump\_stack+0x65/0x92
[] spin\_dump+0x85/0xe0
[] spin\_bug+0x26/0x30
[] do\_raw\_spin\_lock+0xe9/0x130
[] \_raw\_spin\_lock+0x1f/0x30
[] cifs\_closedir+0x4d/0x100
[] \_\_fput+0x5d/0x160
[] \_\_\_\_fput+0xe/0x10
[] task\_work\_run+0x7e/0xa0
[] exit\_to\_usermode\_loop+0x92/0xa0
[] syscall\_return\_slowpath+0x49/0x50
[] entry\_SYSCALL\_64\_fastpath+0xa7/0xa9
Fixes: 3afca265b5f53a0 ("Clarify locking of cifs file and tcon structures and make more granular")
Signed-off-by: Rabin Vincent
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit f0c3a0ac3349146259c235215f474de48b45bd89
Author: Dan Streetman
Date: Fri Feb 3 13:13:09 2017 -0800
zswap: disable changing params if init fails
commit d7b028f56a971a2e4d8d7887540a144eeefcd4ab upstream.
Add zswap\_init\_failed bool that prevents changing any of the module
params, if init\_zswap() fails, and set zswap\_enabled to false. Change
'enabled' param to a callback, and check zswap\_init\_failed before
allowing any change to 'enabled', 'zpool', or 'compressor' params.
Any driver that is built-in to the kernel will not be unloaded if its
init function returns error, and its module params remain accessible for
users to change via sysfs. Since zswap uses param callbacks, which
assume that zswap has been initialized, changing the zswap params after
a failed initialization will result in WARNING due to the param
callbacks expecting a pool to already exist. This prevents that by
immediately exiting any of the param callbacks if initialization failed.
This was reported here:
https://marc.info/?l=linux-mm&m=147004228125528&w=4
And fixes this WARNING:
[ 429.723476] WARNING: CPU: 0 PID: 5140 at mm/zswap.c:503 \_\_zswap\_pool\_current+0x56/0x60
The warning is just noise, and not serious. However, when init fails,
zswap frees all its percpu dstmem pages and its kmem cache. The kmem
cache might be serious, if kmem\_cache\_alloc(NULL, gfp) has problems; but
the percpu dstmem pages are definitely a problem, as they're used as
temporary buffer for compressed pages before copying into place in the
zpool.
If the user does get zswap enabled after an init failure, then zswap
will likely Oops on the first page it tries to compress (or worse, start
corrupting memory).
Fixes: 90b0fc26d5db ("zswap: change zpool/compressor at runtime")
Link: http://lkml.kernel.org/r/20170124200259.16191-2-ddstreet@ieee.org
Signed-off-by: Dan Streetman
Reported-by: Marcin Miroslaw
Cc: Seth Jennings
Cc: Michal Hocko
Cc: Sergey Senozhatsky
Cc: Minchan Kim
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a3d729526f2fd8b9a6ff9f6012f8344cadfd432c
Author: J. Bruce Fields
Date: Tue Jan 31 11:37:50 2017 -0500
svcrpc: fix oops in absence of krb5 module
commit 034dd34ff4916ec1f8f74e39ca3efb04eab2f791 upstream.
Olga Kornievskaia says: "I ran into this oops in the nfsd (below)
(4.10-rc3 kernel). To trigger this I had a client (unsuccessfully) try
to mount the server with krb5 where the server doesn't have the
rpcsec\_gss\_krb5 module built."
The problem is that rsci.cred is copied from a svc\_cred structure that
gss\_proxy didn't properly initialize. Fix that.
[120408.542387] general protection fault: 0000 [#1] SMP
...
[120408.565724] CPU: 0 PID: 3601 Comm: nfsd Not tainted 4.10.0-rc3+ #16
[120408.567037] Hardware name: VMware, Inc. VMware Virtual =
Platform/440BX Desktop Reference Platform, BIOS 6.00 07/02/2015
[120408.569225] task: ffff8800776f95c0 task.stack: ffffc90003d58000
[120408.570483] RIP: 0010:gss\_mech\_put+0xb/0x20 [auth\_rpcgss]
...
[120408.584946] ? rsc\_free+0x55/0x90 [auth\_rpcgss]
[120408.585901] gss\_proxy\_save\_rsc+0xb2/0x2a0 [auth\_rpcgss]
[120408.587017] svcauth\_gss\_proxy\_init+0x3cc/0x520 [auth\_rpcgss]
[120408.588257] ? \_\_enqueue\_entity+0x6c/0x70
[120408.589101] svcauth\_gss\_accept+0x391/0xb90 [auth\_rpcgss]
[120408.590212] ? try\_to\_wake\_up+0x4a/0x360
[120408.591036] ? wake\_up\_process+0x15/0x20
[120408.592093] ? svc\_xprt\_do\_enqueue+0x12e/0x2d0 [sunrpc]
[120408.593177] svc\_authenticate+0xe1/0x100 [sunrpc]
[120408.594168] svc\_process\_common+0x203/0x710 [sunrpc]
[120408.595220] svc\_process+0x105/0x1c0 [sunrpc]
[120408.596278] nfsd+0xe9/0x160 [nfsd]
[120408.597060] kthread+0x101/0x140
[120408.597734] ? nfsd\_destroy+0x60/0x60 [nfsd]
[120408.598626] ? kthread\_park+0x90/0x90
[120408.599448] ret\_from\_fork+0x22/0x30
Fixes: 1d658336b05f "SUNRPC: Add RPC based upcall mechanism for RPCGSS auth"
Cc: Simo Sorce
Reported-by: Olga Kornievskaia
Tested-by: Olga Kornievskaia
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 743146d347f3141cd5a82f4c9aace1790a7537b9
Author: Kinglong Mee
Date: Wed Jan 18 19:04:42 2017 +0800
NFSD: Fix a null reference case in find\_or\_create\_lock\_stateid()
commit d19fb70dd68c4e960e2ac09b0b9c79dfdeefa726 upstream.
nfsd assigns the nfs4\_free\_lock\_stateid to .sc\_free in init\_lock\_stateid().
If nfsd doesn't go through init\_lock\_stateid() and put stateid at end,
there is a NULL reference to .sc\_free when calling nfs4\_put\_stid(ns).
This patch let the nfs4\_stid.sc\_free assignment to nfs4\_alloc\_stid().
Fixes: 356a95ece7aa "nfsd: clean up races in lock stateid searching..."
Signed-off-by: Kinglong Mee
Reviewed-by: Jeff Layton
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 4c953848c95b74def08172b07c04a773071f69ee
Author: Reza Arbab
Date: Wed Jan 25 09:54:33 2017 -0600
powerpc/mm: Use the correct pointer when setting a 2MB pte
commit a0615a16f7d0ceb5804d295203c302d496d8ee91 upstream.
When setting a 2MB pte, radix\_\_map\_kernel\_page() is using the address
ptep = (pte\_t \*)pudp;
Fix this conversion to use pmdp instead. Use pmdp\_ptep() to do this
instead of casting the pointer.
Fixes: 2bfd65e45e87 ("powerpc/mm/radix: Add radix callbacks for early init routines")
Reviewed-by: Aneesh Kumar K.V
Signed-off-by: Reza Arbab
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 8f415333be3a448d9db57a9142fde7efe863432d
Author: Michael Ellerman
Date: Tue Jan 24 16:36:57 2017 +1100
powerpc: Fix build failure with clang due to BUILD\_BUG\_ON()
commit b5fa0f7f88edcde37df1807fdf9ff10ec787a60e upstream.
Anton says: In commit 4db7327194db ("powerpc: Add option to use jump
label for cpu\_has\_feature()") and commit c12e6f24d413 ("powerpc: Add
option to use jump label for mmu\_has\_feature()") we added:
BUILD\_BUG\_ON(!\_\_builtin\_constant\_p(feature))
to cpu\_has\_feature() and mmu\_has\_feature() in order to catch usage
issues (such as cpu\_has\_feature(cpu\_has\_feature(X), which has happened
once in the past). Unfortunately LLVM isn't smart enough to resolve
this, and it errors out.
I work around it in my clang/LLVM builds of the kernel, but I have just
discovered that it causes a lot of issues for the bcc (eBPF) trace tool
(which uses LLVM).
For now just #ifdef it away for clang builds.
Fixes: 4db7327194db ("powerpc: Add option to use jump label for cpu\_has\_feature()")
Fixes: c12e6f24d413 ("powerpc: Add option to use jump label for mmu\_has\_feature()")
Reported-by: Anton Blanchard
Tested-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit bbf69e5197daf5560fa37894e50d943b2065496c
Author: Darren Stevens
Date: Mon Jan 23 19:42:54 2017 +0000
powerpc: Add missing error check to prom\_find\_boot\_cpu()
commit af2b7fa17eb92e52b65f96604448ff7a2a89ee99 upstream.
prom\_init.c calls 'instance-to-package' twice, but the return
is not checked during prom\_find\_boot\_cpu(). The result is then
passed to prom\_getprop(), which could be PROM\_ERROR. Add a return check
to prevent this.
This was found on a pasemi system, where CFE doesn't have a working
'instance-to package' prom call.
Before Commit 5c0484e25ec0 ('powerpc: Endian safe trampoline') the area
around addr 0 was mostly 0's and this doesn't cause a problem. Once the
macro 'FIXUP\_ENDIAN' has been added to head\_64.S, the low memory area
now has non-zero values, which cause the prom\_getprop() call
to hang.
mpe: Also confirmed that under SLOF if 'instance-to-package' did fail
with PROM\_ERROR we would crash in SLOF. So the bug is not specific to
CFE, it's just that other open firmwares don't trigger it because they
have a working 'instance-to-package'.
Fixes: 5c0484e25ec0 ("powerpc: Endian safe trampoline")
Signed-off-by: Darren Stevens
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 73d45909780e7f8632cbc58971c84a67a8622c7a
Author: Gavin Shan
Date: Thu Jan 19 10:10:16 2017 +1100
powerpc/eeh: Fix wrong flag passed to eeh\_unfreeze\_pe()
commit f05fea5b3574a5926c53865eea27139bb40b2f2b upstream.
In \_\_eeh\_clear\_pe\_frozen\_state(), we should pass the flag's value
instead of its address to eeh\_unfreeze\_pe(). The isolated flag is
cleared if no error returned from \_\_eeh\_clear\_pe\_frozen\_state(). We
never observed the error from the function. So the isolated flag should
have been always cleared, no real issue is caused because of the misused
@flag.
This fixes the code by passing the value of @flag to eeh\_unfreeze\_pe().
Fixes: 5cfb20b96f6 ("powerpc/eeh: Emulate EEH recovery for VFIO devices")
Signed-off-by: Gavin Shan
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 4b70d598c2ee1f47871ba12db832fcbbb4adb491
Author: Damien Le Moal
Date: Mon Dec 19 10:17:40 2016 +0900
libata: Fix ATA request sense
commit 2dae99558e86894e9e5dbf097477baaa5eb70134 upstream.
For an ATA device supporting the sense data reporting feature set, a
failed command will trigger the execution of ata\_eh\_request\_sense if
the result task file of the failed command has the ATA\_SENSE bit set
(sense data available bit). ata\_eh\_request\_sense executes the REQUEST
SENSE DATA EXT command to retrieve the sense data of the failed
command. On success of REQUEST SENSE DATA EXT, the ATA\_SENSE bit will
NOT be set (the command succeeded) but ata\_eh\_request\_sense
nevertheless tests the availability of sense data by testing that bit
presence in the result tf of the REQUEST SENSE DATA EXT command. This
leads us to falsely assume that request sense data failed and to the
warning message:
atax.xx: request sense failed stat 50 emask 0
Upon success of REQUEST SENSE DATA EXT, set the ATA\_SENSE bit in the
result task file command so that sense data can be returned by
ata\_eh\_request\_sense.
Signed-off-by: Damien Le Moal
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 6d08607ef35bb8abeb0a2212fbdf85e0af4d5df1
Author: Tejun Heo
Date: Fri Jan 6 11:48:50 2017 -0500
libata: apply MAX\_SEC\_1024 to all CX1-JB\*-HP devices
commit e0edc8c546463f268d41d064d855bcff994c52fa upstream.
Marko reports that CX1-JB512-HP shows the same timeout issues as
CX1-JB256-HP. Let's apply MAX\_SEC\_128 to all devices in the series.
Signed-off-by: Tejun Heo
Reported-by: Marko Koski-Vähälä
Signed-off-by: Greg Kroah-Hartman
commit fc794153c4074dff6487a2d22f1a23246c329bdf
Author: Arvind Yadav
Date: Mon Dec 12 23:13:27 2016 +0530
ata: sata\_mv:- Handle return value of devm\_ioremap.
commit 064c3db9c564cc5be514ac21fb4aa26cc33db746 upstream.
Here, If devm\_ioremap will fail. It will return NULL.
Then hpriv->base = NULL - 0x20000; Kernel can run into
a NULL-pointer dereference. This error check will avoid
NULL pointer dereference.
Signed-off-by: Arvind Yadav
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit b41615aa705626e0fbb5541e4715090370fe8c23
Author: Peter Zijlstra
Date: Thu Jan 26 23:15:08 2017 +0100
perf/core: Fix PERF\_RECORD\_MMAP2 prot/flags for anonymous memory
commit 0b3589be9b98994ce3d5aeca52445d1f5627c4ba upstream.
Andres reported that MMAP2 records for anonymous memory always have
their protection field 0.
Turns out, someone daft put the prot/flags generation code in the file
branch, leaving them unset for anonymous memory.
Reported-by: Andres Freund
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Don Zickus
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: acme@kernel.org
Cc: anton@ozlabs.org
Cc: namhyung@kernel.org
Fixes: f972eb63b100 ("perf: Pass protection and flags bits through mmap2 interface")
Link: http://lkml.kernel.org/r/20170126221508.GF6536@twins.programming.kicks-ass.net
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 3996a91e3bdc04b6e41d93a7de3e5c6b63db5cb3
Author: Peter Zijlstra
Date: Thu Jan 26 16:39:55 2017 +0100
perf/core: Fix use-after-free bug
commit a76a82a3e38c8d3fb6499e3dfaeb0949241ab588 upstream.
Dmitry reported a KASAN use-after-free on event->group\_leader.
It turns out there's a hole in perf\_remove\_from\_context() due to
event\_function\_call() not calling its function when the task
associated with the event is already dead.
In this case the event will have been detached from the task, but the
grouping will have been retained, such that group operations might
still work properly while there are live child events etc.
This does however mean that we can miss a perf\_group\_detach() call
when the group decomposes, this in turn can then lead to
use-after-free.
Fix it by explicitly doing the group detach if its still required.
Reported-by: Dmitry Vyukov
Tested-by: Dmitry Vyukov
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: syzkaller
Fixes: 63b6da39bb38 ("perf: Fix perf\_event\_exit\_task() race")
Link: http://lkml.kernel.org/r/20170126153955.GD6515@twins.programming.kicks-ass.net
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 53bed1f6402563da7cd56cb3d0a97780e091ab73
Author: Ard Biesheuvel
Date: Tue Jan 17 13:46:29 2017 +0000
crypto: arm64/aes-blk - honour iv\_out requirement in CBC and CTR modes
commit 11e3b725cfc282efe9d4a354153e99d86a16af08 upstream.
Update the ARMv8 Crypto Extensions and the plain NEON AES implementations
in CBC and CTR modes to return the next IV back to the skcipher API client.
This is necessary for chaining to work correctly.
Note that for CTR, this is only done if the request is a round multiple of
the block size, since otherwise, chaining is impossible anyway.
Signed-off-by: Ard Biesheuvel
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit b04a39f88cedc1bce345b458e8a9309ce8a2d1ba
Author: Salvatore Benedetto
Date: Fri Jan 13 11:54:08 2017 +0000
crypto: api - Clear CRYPTO\_ALG\_DEAD bit before registering an alg
commit d6040764adcb5cb6de1489422411d701c158bb69 upstream.
Make sure CRYPTO\_ALG\_DEAD bit is cleared before proceeding with
the algorithm registration. This fixes qat-dh registration when
driver is restarted
Signed-off-by: Salvatore Benedetto
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 2eb8f7c4225a90f3266194535adc46b41dfc59e5
Author: Ilia Mirkin
Date: Thu Jan 19 22:56:30 2017 -0500
drm/nouveau/nv1a,nv1f/disp: fix memory clock rate retrieval
commit 24bf7ae359b8cca165bb30742d2b1c03a1eb23af upstream.
Based on the xf86-video-nv code, NFORCE (NV1A) and NFORCE2 (NV1F) have a
different way of retrieving clocks. See the
nv\_hw.c:nForceUpdateArbitrationSettings function in the original code
for how these clocks were accessed.
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=54587
Signed-off-by: Ilia Mirkin
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit bd5cefed1ccc94af1792cb5e07a043881f9a4207
Author: Alastair Bridgewater
Date: Wed Jan 11 15:47:18 2017 -0500
drm/nouveau/disp/gt215: Fix HDA ELD handling (thus, HDMI audio) on gt215
commit d347583a39e2df609a9e40c835f72d3614665b53 upstream.
Store the ELD correctly, not just enough copies of the first byte
to pad out the given ELD size.
Signed-off-by: Alastair Bridgewater
Fixes: 120b0c39c756 ("drm/nv50-/disp: audit and version SOR\_HDA\_ELD method")
Reviewed-by: Ilia Mirkin
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit c9fb422fd93883b65f1bb00e6e9206a5865245fc
Author: Alex Deucher
Date: Fri Jan 27 10:31:52 2017 -0500
drm/amdgpu/si: fix crash on headless asics
commit 57bcd0a6364cd4eaa362d7ff1777e88ddf501602 upstream.
Missing check for crtcs present.
Fixes:
https://bugzilla.kernel.org/show\_bug.cgi?id=193341
https://bugs.freedesktop.org/show\_bug.cgi?id=99387
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 20658b3df8b98cbdc433c824730471160a087afb
Author: Alexander Stein
Date: Mon Jan 30 12:35:28 2017 +0100
pinctrl: baytrail: Add missing spinlock usage in byt\_gpio\_irq\_handler
commit cdca06e4e85974d8a3503ab15709dbbaf90d3dd1 upstream.
According to VLI64 Intel Atom E3800 Specification Update (#329901)
concurrent read accesses may result in returning 0xffffffff and write
accesses may be dropped silently.
To workaround all accesses must be protected by locks.
Signed-off-by: Alexander Stein
Acked-by: Mika Westerberg
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 7396685a1bca323b96fd79b836ae22b7569d7068
Author: Johan Hovold
Date: Mon Jan 30 11:26:39 2017 +0100
HID: cp2112: fix gpio-callback error handling
commit 8e9faa15469ed7c7467423db4c62aeed3ff4cae3 upstream.
In case of a zero-length report, the gpio direction\_input callback would
currently return success instead of an errno.
Fixes: 1ffb3c40ffb5 ("HID: cp2112: make transfer buffers DMA capable")
Signed-off-by: Johan Hovold
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit a18c4584a48931e8048508469bcdb53c6082221a
Author: Johan Hovold
Date: Mon Jan 30 11:26:38 2017 +0100
HID: cp2112: fix sleep-while-atomic
commit 7a7b5df84b6b4e5d599c7289526eed96541a0654 upstream.
A recent commit fixing DMA-buffers on stack added a shared transfer
buffer protected by a spinlock. This is broken as the USB HID request
callbacks can sleep. Fix this up by replacing the spinlock with a mutex.
Fixes: 1ffb3c40ffb5 ("HID: cp2112: make transfer buffers DMA capable")
Signed-off-by: Johan Hovold
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit dfd713307adb8747b47cb7bf6c08cb887b857c43
Author: Max Filippov
Date: Tue Jan 31 18:35:37 2017 -0800
xtensa: fix noMMU build on cores with MMU
commit 4b3e6f2ef3722f1a6a97b6034ed492c1a21fd4ae upstream.
Commit bf15f86b343ed8 ("xtensa: initialize MMU before jumping to reset
vector") calls MMU management functions even when CONFIG\_MMU is not
selected. That breaks noMMU build on cores with MMU.
Don't manage MMU when CONFIG\_MMU is not selected.
Signed-off-by: Max Filippov
Signed-off-by: Greg Kroah-Hartman
commit f2e24dd918189b355a2f7eeafede54778d18172d
Author: Ard Biesheuvel
Date: Wed Feb 1 17:45:02 2017 +0000
efi/fdt: Avoid FDT manipulation after ExitBootServices()
commit c8f325a59cfc718d13a50fbc746ed9b415c25e92 upstream.
Some AArch64 UEFI implementations disable the MMU in ExitBootServices(),
after which unaligned accesses to RAM are no longer supported.
Commit:
abfb7b686a3e ("efi/libstub/arm\*: Pass latest memory map to the kernel")
fixed an issue in the memory map handling of the stub FDT code, but
inadvertently created an issue with such firmware, by moving some
of the FDT manipulation to after the invocation of ExitBootServices().
Given that the stub's libfdt implementation uses the ordinary, accelerated
string functions, which rely on hardware handling of unaligned accesses,
manipulating the FDT with the MMU off may result in alignment faults.
So fix the situation by moving the update\_fdt\_memmap() call into the
callback function invoked by efi\_exit\_boot\_services() right before it
calls the ExitBootServices() UEFI service (which is arguably a better
place for it anyway)
Note that disabling the MMU in ExitBootServices() is not compliant with
the UEFI spec, and carries great risk due to the fact that switching from
cached to uncached memory accesses halfway through compiler generated code
(i.e., involving a stack) can never be done in a way that is architecturally
safe.
Fixes: abfb7b686a3e ("efi/libstub/arm\*: Pass latest memory map to the kernel")
Signed-off-by: Ard Biesheuvel
Tested-by: Riku Voipio
Cc: mark.rutland@arm.com
Cc: linux-efi@vger.kernel.org
Cc: matt@codeblueprint.co.uk
Cc: leif.lindholm@linaro.org
Cc: linux-arm-kernel@lists.infradead.org
Link: http://lkml.kernel.org/r/1485971102-23330-2-git-send-email-ard.biesheuvel@linaro.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit f0c7412edfc117e7792b8b1f5ee201b31cf9dcdb
Author: Jiri Kosina
Date: Fri Jan 27 22:25:52 2017 +0000
x86/efi: Always map the first physical page into the EFI pagetables
commit bf29bddf0417a4783da3b24e8c9e017ac649326f upstream.
Commit:
129766708 ("x86/efi: Only map RAM into EFI page tables if in mixed-mode")
stopped creating 1:1 mappings for all RAM, when running in native 64-bit mode.
It turns out though that there are 64-bit EFI implementations in the wild
(this particular problem has been reported on a Lenovo Yoga 710-11IKB),
which still make use of the first physical page for their own private use,
even though they explicitly mark it EFI\_CONVENTIONAL\_MEMORY in the memory
map.
In case there is no mapping for this particular frame in the EFI pagetables,
as soon as firmware tries to make use of it, a triple fault occurs and the
system reboots (in case of the Yoga 710-11IKB this is very early during bootup).
Fix that by always mapping the first page of physical memory into the EFI
pagetables. We're free to hand this page to the BIOS, as trim\_bios\_range()
will reserve the first page and isolate it away from memory allocators anyway.
Note that just reverting 129766708 alone is not enough on v4.9-rc1+ to fix the
regression on affected hardware, as this commit:
ab72a27da ("x86/efi: Consolidate region mapping logic")
later made the first physical frame not to be mapped anyway.
Reported-by: Hanka Pavlikova
Signed-off-by: Jiri Kosina
Signed-off-by: Matt Fleming
Cc: Ard Biesheuvel
Cc: Borislav Petkov
Cc: Borislav Petkov
Cc: Laura Abbott
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: Vojtech Pavlik
Cc: Waiman Long
Cc: linux-efi@vger.kernel.org
Fixes: 129766708 ("x86/efi: Only map RAM into EFI page tables if in mixed-mode")
Link: http://lkml.kernel.org/r/20170127222552.22336-1-matt@codeblueprint.co.uk
[ Tidied up the changelog and the comment. ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 13e6ef99d23b05807e7f8a72f45e3d8260b61570
Author: Eryu Guan
Date: Thu Dec 1 15:08:37 2016 -0500
ext4: validate s\_first\_meta\_bg at mount time
commit 3a4b77cd47bb837b8557595ec7425f281f2ca1fe upstream.
Ralf Spenneberg reported that he hit a kernel crash when mounting a
modified ext4 image. And it turns out that kernel crashed when
calculating fs overhead (ext4\_calculate\_overhead()), this is because
the image has very large s\_first\_meta\_bg (debug code shows it's
842150400), and ext4 overruns the memory in count\_overhead() when
setting bitmap buffer, which is PAGE\_SIZE.
ext4\_calculate\_overhead():
buf = get\_zeroed\_page(GFP\_NOFS); <=== PAGE\_SIZE buffer
blks = count\_overhead(sb, i, buf);
count\_overhead():
for (j = ext4\_bg\_num\_gdb(sb, grp); j > 0; j--) { <=== j = 842150400
ext4\_set\_bit(EXT4\_B2C(sbi, s++), buf); <=== buffer overrun
count++;
}
This can be reproduced easily for me by this script:
#!/bin/bash
rm -f fs.img
mkdir -p /mnt/ext4
fallocate -l 16M fs.img
mke2fs -t ext4 -O bigalloc,meta\_bg,^resize\_inode -F fs.img
debugfs -w -R "ssv first\_meta\_bg 842150400" fs.img
mount -o loop fs.img /mnt/ext4
Fix it by validating s\_first\_meta\_bg first at mount time, and
refusing to mount if its value exceeds the largest possible meta\_bg
number.
Reported-by: Ralf Spenneberg
Signed-off-by: Eryu Guan
Signed-off-by: Theodore Ts'o
Reviewed-by: Andreas Dilger
Signed-off-by: Greg Kroah-Hartman
commit 610c2b7ff8f6d5cbad76bbe522f7f367d7116b0f
Author: Bjorn Helgaas
Date: Fri Jan 27 15:00:45 2017 -0600
PCI/ASPM: Handle PCI-to-PCIe bridges as roots of PCIe hierarchies
commit 030305d69fc6963c16003f50d7e8d74b02d0a143 upstream.
In a struct pcie\_link\_state, link->root points to the pcie\_link\_state of
the root of the PCIe hierarchy. For the topmost link, this points to
itself (link->root = link). For others, we copy the pointer from the
parent (link->root = link->parent->root).
Previously we recognized that Root Ports originated PCIe hierarchies, but
we treated PCI/PCI-X to PCIe Bridges as being in the middle of the
hierarchy, and when we tried to copy the pointer from link->parent->root,
there was no parent, and we dereferenced a NULL pointer:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000090
IP: [] pcie\_aspm\_init\_link\_state+0x170/0x820
Recognize that PCI/PCI-X to PCIe Bridges originate PCIe hierarchies just
like Root Ports do, so link->root for these devices should also point to
itself.
Fixes: 51ebfc92b72b ("PCI: Enumerate switches below PCI-to-PCIe bridges")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=193411
Link: https://bugzilla.opensuse.org/show\_bug.cgi?id=1022181
Tested-by: lists@ssl-mail.com
Tested-by: Jayachandran C.
Signed-off-by: Bjorn Helgaas
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_fbbc2eaa_20250125_191845.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2017-01-30 11:26:39 +0100 |
| --- | --- | --- |
| committer | Jiri Kosina <jkosina@suse.cz> | 2017-01-31 12:59:33 +0100 |
| commit | [8e9faa15469ed7c7467423db4c62aeed3ff4cae3](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)) | |
| tree | [c02e82adbed28ab857971022fca14ef7ee375b65](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3) | |
| parent | [7a7b5df84b6b4e5d599c7289526eed96541a0654](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7a7b5df84b6b4e5d599c7289526eed96541a0654) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3&id2=7a7b5df84b6b4e5d599c7289526eed96541a0654)) | |
| download | [linux-8e9faa15469ed7c7467423db4c62aeed3ff4cae3.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-8e9faa15469ed7c7467423db4c62aeed3ff4cae3.tar.gz) | |

HID: cp2112: fix gpio-callback error handlingIn case of a zero-length report, the gpio direction\_input callback would
currently return success instead of an errno.
Fixes: 1ffb3c40ffb5 ("HID: cp2112: make transfer buffers DMA capable")
Cc: stable <stable@vger.kernel.org> # 4.9
Signed-off-by: Johan Hovold <johan@kernel.org>
Reviewed-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)

| -rw-r--r-- | [drivers/hid/hid-cp2112.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/hid/hid-cp2112.c?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/hid/hid-cp2112.c b/drivers/hid/hid-cp2112.cindex 3e0b6bad29f200..b22d0f83f8e38a 100644--- a/[drivers/hid/hid-cp2112.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/hid/hid-cp2112.c?id=7a7b5df84b6b4e5d599c7289526eed96541a0654)+++ b/[drivers/hid/hid-cp2112.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/hid/hid-cp2112.c?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3)@@ -213,7 +213,7 @@ static int cp2112\_gpio\_direction\_input(struct gpio\_chip \*chip, unsigned offset)  exit: mutex\_unlock(&dev->lock);- return ret <= 0 ? ret : -EIO;+ return ret < 0 ? ret : -EIO; }  static void cp2112\_gpio\_set(struct gpio\_chip \*chip, unsigned offset, int value) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 18:56:17 +0000



=== Content from github.com_c96d94ef_20250125_191846.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F8e9faa15469ed7c7467423db4c62aeed3ff4cae3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F8e9faa15469ed7c7467423db4c62aeed3ff4cae3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/8e9faa15469ed7c7467423db4c62aeed3ff4cae3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

HID: cp2112: fix gpio-callback error handling

[Browse files](/torvalds/linux/tree/8e9faa15469ed7c7467423db4c62aeed3ff4cae3)
Browse the repository at this point in the history

```
In case of a zero-length report, the gpio direction_input callback would
currently return success instead of an errno.

Fixes: [1ffb3c4](https://github.com/torvalds/linux/commit/1ffb3c40ffb5c51bc39736409b11816c4260218e) ("HID: cp2112: make transfer buffers DMA capable")
Cc: stable <stable@vger.kernel.org>     # 4.9
Signed-off-by: Johan Hovold <johan@kernel.org>
Reviewed-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
```

* Loading branch information

[![@jhovold](https://avatars.githubusercontent.com/u/601896?s=40&v=4)](/jhovold)

[jhovold](/torvalds/linux/commits?author=jhovold "View all commits by jhovold")
authored and
Jiri Kosina
committed
Jan 31, 2017

1 parent
[7a7b5df](/torvalds/linux/commit/7a7b5df84b6b4e5d599c7289526eed96541a0654)

commit 8e9faa1

Showing
**1 changed file**
with
**1 addition**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[drivers/hid/hid-cp2112.c](#diff-c6c42faeb6399f42c10a2cc79066eaba5731287a0651346d65b8f3f0cdf2b4aa "drivers/hid/hid-cp2112.c")

Show comments

[View file](/torvalds/linux/blob/8e9faa15469ed7c7467423db4c62aeed3ff4cae3/drivers/hid/hid-cp2112.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -213,7 +213,7 @@ static int cp2112\_gpio\_direction\_input(struct gpio\_chip \*chip, unsigned offset) |
|  |  |  |
|  |  | exit: |
|  |  | mutex\_unlock(&dev->lock); |
|  |  | return ret <= 0 ? ret : -EIO; |
|  |  | return ret < 0 ? ret : -EIO; |
|  |  | } |
|  |  |  |
|  |  | static void cp2112\_gpio\_set(struct gpio\_chip \*chip, unsigned offset, int value) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8e9faa1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F8e9faa15469ed7c7467423db4c62aeed3ff4cae3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_e0ecfa94_20250125_191844.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](../../../2017/04/17/1) [[thread-next>]](../../../2017/04/17/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20170416202538.GA12165@grsecurity.net>
Date: Sun, 16 Apr 2017 16:25:38 -0400
From: Brad Spengler <spender@...ecurity.net>
To: oss-security@...ts.openwall.com
Subject: Silently (or obliviously) partially-fixed CONFIG_STRICT_DEVMEM bypass

Hi all,

I wanted to provide some small notice of upstream kernel developers silently
or obliviously partially fixing a CONFIG_STRICT_DEVMEM bypass which explicitly has
never been possible in grsecurity in the past 15 years.  I say this because the commit
message makes no mention of this partially fixing a CONFIG_STRICT_DEVMEM bypass (and I
suppose a Secure Boot bypass, but what isn't these days?), and similarly makes no
mentions of the modifications it makes to the write side.  CONFIG_STRICT_DEVMEM exists
to prevent userland from directly modifying kernel memory, yet the kernel will happily
make slab allocations in allowed regions below 1MB.  CONFIG_STRICT_DEVMEM explicitly
allowed both reads and writes to these allocations.  As noted, the commit below doesn't
fix the mmap side.

<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a4866aa812518ed1a37d8ea0c881dc946409de94>

Feel free to look at GRKERNSEC_KMEM code going back to 2002 in our 2.4.20
patch, or when it changed in 2003 for 2.4.21, or this explicit hunk, comment and
all, that's been around ever since CONFIG_STRICT_DEVMEM was added in 2008:

+#ifdef CONFIG_GRKERNSEC_KMEM
+       /* throw out everything else below 1MB */
+       if (pagenr <= 256)
+               return 0;
+#endif

<additional comments/details removed: b76e178e7b24f238ba0dd70104336298f493f0142056a1e5f35c27897369adc6>

While I'm here, some more VMAP_STACK fallout (DoS/potential memory corruption,
adding to the dozen or so posted earlier):
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=67b0503db9c29b04eadfeede6bebbfe5ddad94ef>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=606142af57dad981b78707234cfbd15f9f7b7125>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3f190e3aec212fc8c61e202c51400afa7384d4bc>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=005145378c9ad7575a01b6ce1ba118fb427f583a>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=3b30460c5b0ed762be75a004e924ec3f8711e032>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=c919a3069c775c1c876bec55e00b2305d5125caa>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=5593523f968bc86d42a035c6df47d5e0979b5ace>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=7926aff5c57b577ab0f43364ff0c59d968f6a414>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=2d6a0e9de03ee658a9adc3bfb2f0ca55dff1e478>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7a7b5df84b6b4e5d599c7289526eed96541a0654>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3>

Thanks,
-Brad

Download attachment "[signature.asc](4/1)" of type "application/pgp-signature" (837 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


