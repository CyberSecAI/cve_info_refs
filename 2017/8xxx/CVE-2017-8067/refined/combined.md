=== Content from www.openwall.com_e0ecfa94_20250125_025415.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](../../../2017/04/17/1) [[thread-next>]](../../../2017/04/17/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20170416202538.GA12165@grsecurity.net>
Date: Sun, 16 Apr 2017 16:25:38 -0400
From: Brad Spengler <spender@...ecurity.net>
To: oss-security@...ts.openwall.com
Subject: Silently (or obliviously) partially-fixed CONFIG_STRICT_DEVMEM bypass

Hi all,

I wanted to provide some small notice of upstream kernel developers silently
or obliviously partially fixing a CONFIG_STRICT_DEVMEM bypass which explicitly has
never been possible in grsecurity in the past 15 years.  I say this because the commit
message makes no mention of this partially fixing a CONFIG_STRICT_DEVMEM bypass (and I
suppose a Secure Boot bypass, but what isn't these days?), and similarly makes no
mentions of the modifications it makes to the write side.  CONFIG_STRICT_DEVMEM exists
to prevent userland from directly modifying kernel memory, yet the kernel will happily
make slab allocations in allowed regions below 1MB.  CONFIG_STRICT_DEVMEM explicitly
allowed both reads and writes to these allocations.  As noted, the commit below doesn't
fix the mmap side.

<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a4866aa812518ed1a37d8ea0c881dc946409de94>

Feel free to look at GRKERNSEC_KMEM code going back to 2002 in our 2.4.20
patch, or when it changed in 2003 for 2.4.21, or this explicit hunk, comment and
all, that's been around ever since CONFIG_STRICT_DEVMEM was added in 2008:

+#ifdef CONFIG_GRKERNSEC_KMEM
+       /* throw out everything else below 1MB */
+       if (pagenr <= 256)
+               return 0;
+#endif

<additional comments/details removed: b76e178e7b24f238ba0dd70104336298f493f0142056a1e5f35c27897369adc6>

While I'm here, some more VMAP_STACK fallout (DoS/potential memory corruption,
adding to the dozen or so posted earlier):
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=67b0503db9c29b04eadfeede6bebbfe5ddad94ef>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=606142af57dad981b78707234cfbd15f9f7b7125>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3f190e3aec212fc8c61e202c51400afa7384d4bc>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=005145378c9ad7575a01b6ce1ba118fb427f583a>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=3b30460c5b0ed762be75a004e924ec3f8711e032>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=c919a3069c775c1c876bec55e00b2305d5125caa>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=5593523f968bc86d42a035c6df47d5e0979b5ace>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=7926aff5c57b577ab0f43364ff0c59d968f6a414>
<https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=2d6a0e9de03ee658a9adc3bfb2f0ca55dff1e478>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7a7b5df84b6b4e5d599c7289526eed96541a0654>
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8e9faa15469ed7c7467423db4c62aeed3ff4cae3>

Thanks,
-Brad

Download attachment "[signature.asc](4/1)" of type "application/pgp-signature" (837 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.kernel.org_33fcf562_20250125_025415.html ===
commit 055c0a94117c3c9950ebb7d0c262ae64808bd266
Author: Greg Kroah-Hartman
Date: Fri Apr 21 09:32:55 2017 +0200
Linux 4.10.12
commit e5349c13c7a8bd6e0be0f81f4464fc2edae05d5b
Author: Omar Sandoval
Date: Wed Feb 1 00:02:27 2017 -0800
virtio-console: avoid DMA from stack
commit c4baad50297d84bde1a7ad45e50c73adae4a2192 upstream.
put\_chars() stuffs the buffer it gets into an sg, but that buffer may be
on the stack. This breaks with CONFIG\_VMAP\_STACK=y (for me, it
manifested as printks getting turned into NUL bytes).
Signed-off-by: Omar Sandoval
Signed-off-by: Michael S. Tsirkin
Reviewed-by: Amit Shah
Cc: Ben Hutchings
Cc: Brad Spengler
Signed-off-by: Greg Kroah-Hartman
commit e0116f4d9a9ad5112d315b236c7b3d7036d404d7
Author: Stefan Brüns
Date: Sun Feb 5 12:57:59 2017 -0200
cxusb: Use a dma capable buffer also for reading
commit 3f190e3aec212fc8c61e202c51400afa7384d4bc upstream.
Commit 17ce039b4e54 ("[media] cxusb: don't do DMA on stack")
added a kmalloc'ed bounce buffer for writes, but missed to do the same
for reads. As the read only happens after the write is finished, we can
reuse the same buffer.
As dvb\_usb\_generic\_rw handles a read length of 0 by itself, avoid calling
it using the dvb\_usb\_generic\_read wrapper function.
Signed-off-by: Stefan Brüns
Signed-off-by: Mauro Carvalho Chehab
Cc: Ben Hutchings
Cc: Brad Spengler
Signed-off-by: Greg Kroah-Hartman
commit b1bfb5083bfa79d1400009ac6265bfb5f2c09ec9
Author: Kees Cook
Date: Wed Apr 5 09:39:08 2017 -0700
mm: Tighten x86 /dev/mem with zeroing reads
commit a4866aa812518ed1a37d8ea0c881dc946409de94 upstream.
Under CONFIG\_STRICT\_DEVMEM, reading System RAM through /dev/mem is
disallowed. However, on x86, the first 1MB was always allowed for BIOS
and similar things, regardless of it actually being System RAM. It was
possible for heap to end up getting allocated in low 1MB RAM, and then
read by things like x86info or dd, which would trip hardened usercopy:
usercopy: kernel memory exposure attempt detected from ffff880000090000 (dma-kmalloc-256) (4096 bytes)
This changes the x86 exception for the low 1MB by reading back zeros for
System RAM areas instead of blindly allowing them. More work is needed to
extend this to mmap, but currently mmap doesn't go through usercopy, so
hardened usercopy won't Oops the kernel.
Reported-by: Tommi Rantala
Tested-by: Tommi Rantala
Signed-off-by: Kees Cook
Cc: Brad Spengler
Signed-off-by: Greg Kroah-Hartman
commit 2c4d8f20cc2913d0ab738a491c3d26e09871e701
Author: Thierry Reding
Date: Thu Jan 12 17:07:43 2017 +0100
rtc: tegra: Implement clock handling
commit 5fa4086987506b2ab8c92f8f99f2295db9918856 upstream.
Accessing the registers of the RTC block on Tegra requires the module
clock to be enabled. This only works because the RTC module clock will
be enabled by default during early boot. However, because the clock is
unused, the CCF will disable it at late\_init time. This causes the RTC
to become unusable afterwards. This can easily be reproduced by trying
to use the RTC:
$ hwclock --rtc /dev/rtc1
This will hang the system. I ran into this by following up on a report
by Martin Michlmayr that reboot wasn't working on Tegra210 systems. It
turns out that the rtc-tegra driver's ->shutdown() implementation will
hang the CPU, because of the disabled clock, before the system can be
rebooted.
What confused me for a while is that the same driver is used on prior
Tegra generations where the hang can not be observed. However, as Peter
De Schrijver pointed out, this is because on 32-bit Tegra chips the RTC
clock is enabled by the tegra20\_timer.c clocksource driver, which uses
the RTC to provide a persistent clock. This code is never enabled on
64-bit Tegra because the persistent clock infrastructure does not exist
on 64-bit ARM.
The proper fix for this is to add proper clock handling to the RTC
driver in order to ensure that the clock is enabled when the driver
requires it. All device trees contain the clock already, therefore
no additional changes are required.
Reported-by: Martin Michlmayr
Acked-By Peter De Schrijver
Signed-off-by: Thierry Reding
Signed-off-by: Alexandre Belloni
[bwh: Backported to 4.9: adjust context]
Signed-off-by: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit a16534a3330524c70a580899065d78b0d81c7b5c
Author: Lv Zheng
Date: Fri Jan 20 16:42:48 2017 +0800
ACPI / EC: Use busy polling mode when GPE is not enabled
commit c3a696b6e8f8f75f9f75e556a9f9f6472eae2655 upstream.
When GPE is not enabled, it is not efficient to use the wait polling mode
as it introduces an unexpected scheduler delay.
So before the GPE handler is installed, this patch uses busy polling mode
for all EC(s) and the logic can be applied to non boot EC(s) during the
suspend/resume process.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=191561
Tested-by: Jakobus Schurz
Tested-by: Chen Yu
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 8a73a223fb7062fd825ecddc3eb5b394367a6d7f
Author: Mohit Gambhir
Date: Thu Jan 26 13:12:27 2017 -0500
x86/xen: Fix APIC id mismatch warning on Intel
commit cc272163ea554a97dac180fa8dd6cd54c2810bd1 upstream.
This patch fixes the following warning message seen when booting the
kernel as Dom0 with Xen on Intel machines.
[0.003000] [Firmware Bug]: CPU1: APIC id mismatch. Firmware: 0 APIC: 1]
The code generating the warning in validate\_apic\_and\_package\_id() matches
cpu\_data(cpu).apicid (initialized in init\_intel()->
detect\_extended\_topology() using cpuid) against the apicid returned from
xen\_apic\_read(). Now, xen\_apic\_read() makes a hypercall to retrieve apicid
for the boot cpu but returns 0 otherwise. Hence the warning gets thrown
for all but the boot cpu.
The idea behind xen\_apic\_read() returning 0 for apicid is that the
guests (even Dom0) should not need to know what physical processor their
vcpus are running on. This is because we currently do not have topology
information in Xen and also because xen allows more vcpus than physical
processors. However, boot cpu's apicid is required for loading
xen-acpi-processor driver on AMD machines. Look at following patch for
details:
commit 558daa289a40 ("xen/apic: Return the APIC ID (and version) for CPU
0.")
So to get rid of the warning, this patch modifies
xen\_cpu\_present\_to\_apicid() to return cpu\_data(cpu).apicid instead of
calling xen\_apic\_read().
The warning is not seen on AMD machines because init\_amd() populates
cpu\_data(cpu).apicid by calling hard\_smp\_processor\_id()->xen\_apic\_read()
as opposed to using apicid from cpuid as is done on Intel machines.
Signed-off-by: Mohit Gambhir
Reviewed-by: Juergen Gross
Signed-off-by: Boris Ostrovsky
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit e765ef79fdf3dc6fff0f7a58d3de26ab60c95530
Author: Lee, Chun-Yi
Date: Thu Nov 3 08:18:52 2016 +0800
platform/x86: acer-wmi: setup accelerometer when machine has appropriate notify event
commit 98d610c3739ac354319a6590b915f4624d9151e6 upstream.
The accelerometer event relies on the ACERWMID\_EVENT\_GUID notify.
So, this patch changes the codes to setup accelerometer input device
when detected ACERWMID\_EVENT\_GUID. It avoids that the accel input
device created on every Acer machines.
In addition, patch adds a clearly parsing logic of accelerometer hid
to acer\_wmi\_get\_handle\_cb callback function. It is positive matching
the "SENR" name with "BST0001" device to avoid non-supported hardware.
Reported-by: Bjørn Mork
Cc: Darren Hart
Signed-off-by: Lee, Chun-Yi
[andy: slightly massage commit message]
Signed-off-by: Andy Shevchenko
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 35549ee082855878c38880c81dc929c9fcb57aba
Author: Andy Shevchenko
Date: Mon Jan 16 15:12:26 2017 +0200
ASoC: Intel: select DW\_DMAC\_CORE since it's mandatory
commit ebf79091bf85d9b2270ab29191de9cd3aaf888c5 upstream.
Select DW\_DMAC\_CORE like the rest of glue drivers do, e.g.
drivers/dma/dw/Kconfig.
While here group selectors under SND\_SOC\_INTEL\_HASWELL and
SND\_SOC\_INTEL\_BAYTRAIL.
Make platforms, which are using a common SST firmware driver, to be
dependent on DMADEVICES.
Signed-off-by: Andy Shevchenko
Acked-by: Liam Girdwood
Signed-off-by: Mark Brown
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 765c74b9cc2719d24bdca7ca43d6bfd298109337
Author: Arnd Bergmann
Date: Thu Feb 2 12:36:01 2017 -0200
dvb-usb-v2: avoid use-after-free
commit 005145378c9ad7575a01b6ce1ba118fb427f583a upstream.
I ran into a stack frame size warning because of the on-stack copy of
the USB device structure:
drivers/media/usb/dvb-usb-v2/dvb\_usb\_core.c: In function 'dvb\_usbv2\_disconnect':
drivers/media/usb/dvb-usb-v2/dvb\_usb\_core.c:1029:1: error: the frame size of 1104 bytes is larger than 1024 bytes [-Werror=frame-larger-than=]
Copying a device structure like this is wrong for a number of other reasons
too aside from the possible stack overflow. One of them is that the
dev\_info() call will print the name of the device later, but AFAICT
we have only copied a pointer to the name earlier and the actual name
has been freed by the time it gets printed.
This removes the on-stack copy of the device and instead copies the
device name using kstrdup(). I'm ignoring the possible failure here
as both printk() and kfree() are able to deal with NULL pointers.
Signed-off-by: Arnd Bergmann
Signed-off-by: Mauro Carvalho Chehab
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit ce5fe5a547d8d728914eac148fac37bc0ef0845f
Author: Helge Deller
Date: Sun Apr 16 10:00:14 2017 +0200
parisc: Fix get\_user() for 64-bit value on 32-bit kernel
commit 3f795cef0ecdf9bc980dd058d49bdab4b19af1d3 upstream.
This fixes a bug in which the upper 32-bits of a 64-bit value which is
read by get\_user() was lost on a 32-bit kernel.
While touching this code, split out pre-loading of %sr2 space register
and clean up code indent.
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit aa7ca04fb26cd374e4b9739b9fc070025ea8c490
Author: Herbert Xu
Date: Mon Apr 10 17:15:48 2017 +0800
crypto: lrw - Fix use-after-free on EINPROGRESS
commit 4702bbeefb490e315189636a5588628c1151223d upstream.
When we get an EINPROGRESS completion in lrw, we will end up marking
the request as done and freeing it. This then blows up when the
request is really completed as we've already freed the memory.
Fixes: 700cb3f5fe75 ("crypto: lrw - Convert to skcipher")
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit cb0567fc5114948df953403133944db83999ab48
Author: Herbert Xu
Date: Mon Apr 10 17:27:57 2017 +0800
crypto: ahash - Fix EINPROGRESS notification callback
commit ef0579b64e93188710d48667cb5e014926af9f1b upstream.
The ahash API modifies the request's callback function in order
to clean up after itself in some corner cases (unaligned final
and missing finup).
When the request is complete ahash will restore the original
callback and everything is fine. However, when the request gets
an EBUSY on a full queue, an EINPROGRESS callback is made while
the request is still ongoing.
In this case the ahash API will incorrectly call its own callback.
This patch fixes the problem by creating a temporary request
object on the stack which is used to relay EINPROGRESS back to
the original completion function.
This patch also adds code to preserve the original flags value.
Fixes: ab6bf4e5e5e4 ("crypto: hash - Fix the pointer voodoo in...")
Reported-by: Sabrina Dubroca
Tested-by: Sabrina Dubroca
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 102da3a73f9a5c1551a7eb8003714e7fa18884c7
Author: Herbert Xu
Date: Sat Apr 8 10:02:46 2017 +0800
crypto: xts - Fix use-after-free on EINPROGRESS
commit aa4a829bdaced81e70c215a84ef6595ce8bd4308 upstream.
When we get an EINPROGRESS completion in xts, we will end up marking
the request as done and freeing it. This then blows up when the
request is really completed as we've already freed the memory.
Fixes: f1c131b45410 ("crypto: xts - Convert to skcipher")
Reported-by: Nathan Royce
Reported-by: Krzysztof Kozlowski
Signed-off-by: Herbert Xu
Tested-by: Krzysztof Kozlowski
Signed-off-by: Greg Kroah-Hartman
commit 25308983eda6354815f7f1f6dd01afeef786a876
Author: Herbert Xu
Date: Mon Apr 10 17:59:07 2017 +0800
crypto: algif\_aead - Fix bogus request dereference in completion function
commit e6534aebb26e32fbab14df9c713c65e8507d17e4 upstream.
The algif\_aead completion function tries to deduce the aead\_request
from the crypto\_async\_request argument. This is broken because
the API does not guarantee that the same request will be pased to
the completion function. Only the value of req->data can be used
in the completion function.
This patch fixes it by storing a pointer to sk in areq and using
that instead of passing in sk through req->data.
Fixes: 83094e5e9e49 ("crypto: af\_alg - add async support to...")
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit a0a1e90f5057f69055d880c96257b98035feca71
Author: Namhyung Kim
Date: Mon Apr 17 11:44:27 2017 +0900
ftrace: Fix function pid filter on instances
commit d879d0b8c183aabeb9a65eba91f3f9e3c7e7b905 upstream.
When function tracer has a pid filter, it adds a probe to sched\_switch
to track if current task can be ignored. The probe checks the
ftrace\_ignore\_pid from current tr to filter tasks. But it misses to
delete the probe when removing an instance so that it can cause a crash
due to the invalid tr pointer (use-after-free).
This is easily reproducible with the following:
# cd /sys/kernel/debug/tracing
# mkdir instances/buggy
# echo $$ > instances/buggy/set\_ftrace\_pid
# rmdir instances/buggy
============================================================================
BUG: KASAN: use-after-free in ftrace\_filter\_pid\_sched\_switch\_probe+0x3d/0x90
Read of size 8 by task kworker/0:1/17
CPU: 0 PID: 17 Comm: kworker/0:1 Tainted: G B 4.11.0-rc3 #198
Call Trace:
dump\_stack+0x68/0x9f
kasan\_object\_err+0x21/0x70
kasan\_report.part.1+0x22b/0x500
? ftrace\_filter\_pid\_sched\_switch\_probe+0x3d/0x90
kasan\_report+0x25/0x30
\_\_asan\_load8+0x5e/0x70
ftrace\_filter\_pid\_sched\_switch\_probe+0x3d/0x90
? fpid\_start+0x130/0x130
\_\_schedule+0x571/0xce0
...
To fix it, use ftrace\_clear\_pids() to unregister the probe. As
instance\_rmdir() already updated ftrace codes, it can just free the
filter safely.
Link: http://lkml.kernel.org/r/20170417024430.21194-2-namhyung@kernel.org
Fixes: 0c8916c34203 ("tracing: Add rmdir to remove multibuffer instances")
Cc: Ingo Molnar
Reviewed-by: Masami Hiramatsu
Signed-off-by: Namhyung Kim
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 58bc856c41fb7e986f6bcc70107d5f7efa529d3b
Author: Minchan Kim
Date: Thu Apr 13 14:56:37 2017 -0700
zram: do not use copy\_page with non-page aligned address
commit d72e9a7a93e4f8e9e52491921d99e0c8aa89eb4e upstream.
The copy\_page is optimized memcpy for page-alinged address. If it is
used with non-page aligned address, it can corrupt memory which means
system corruption. With zram, it can happen with
1. 64K architecture
2. partial IO
3. slub debug
Partial IO need to allocate a page and zram allocates it via kmalloc.
With slub debug, kmalloc(PAGE\_SIZE) doesn't return page-size aligned
address. And finally, copy\_page(mem, cmem) corrupts memory.
So, this patch changes it to memcpy.
Actuaully, we don't need to change zram\_bvec\_write part because zsmalloc
returns page-aligned address in case of PAGE\_SIZE class but it's not
good to rely on the internal of zsmalloc.
Note:
When this patch is merged to stable, clear\_page should be fixed, too.
Unfortunately, recent zram removes it by "same page merge" feature so
it's hard to backport this patch to -stable tree.
I will handle it when I receive the mail from stable tree maintainer to
merge this patch to backport.
Fixes: 42e99bd ("zram: optimize memory operations with clear\_page()/copy\_page()")
Link: http://lkml.kernel.org/r/1492042622-12074-2-git-send-email-minchan@kernel.org
Signed-off-by: Minchan Kim
Cc: Sergey Senozhatsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9bf69094c2ad71829ae489284a9bb0f1d6a251a8
Author: Greg Kroah-Hartman
Date: Tue Apr 18 16:16:57 2017 +0200
Revert "MIPS: Lantiq: Fix cascaded IRQ setup"
This reverts commit b576c58331340c87bcf61f1205003a8fdffdff24 which is
commit 6c356eda225e3ee134ed4176b9ae3a76f793f4dd upstream.
It shouldn't have been included in a stable release.
Reported-by: Amit Pundir
Cc: Felix Fietkau
Cc: John Crispin
Cc: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit 1cb293ab023642bc7e37e5a3b3bc7c125b93d08e
Author: Max Bires
Date: Tue Jan 3 08:18:07 2017 -0800
char: lack of bool string made CONFIG\_DEVPORT always on
commit f2cfa58b136e4b06a9b9db7af5ef62fbb5992f62 upstream.
Without a bool string present, using "# CONFIG\_DEVPORT is not set" in
defconfig files would not actually unset devport. This esnured that
/dev/port was always on, but there are reasons a user may wish to
disable it (smaller kernel, attack surface reduction) if it's not being
used. Adding a message here in order to make this user visible.
Signed-off-by: Max Bires
Acked-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
commit ebe4deab5c805a7301e6967d984d01bb8ff58c78
Author: Min He
Date: Thu Apr 6 11:01:45 2017 +0800
drm/i915/gvt: set the correct default value of CTX STATUS PTR
commit a34f83639490a5cc11a9d5c1b3773d4b6eb69a9e upstream.
Fix wrong initial csb read pointer value. This fixes the random
engine timeout issue in guest when guest boots up.
Fixes: 8453d674ae7e ("drm/i915/gvt: vGPU execlist virtualization")
Signed-off-by: Min He
Signed-off-by: Zhenyu Wang
Signed-off-by: Greg Kroah-Hartman
commit 4bf7df7b3bd7b336280a938bf23c108e0bc52579
Author: Steven Rostedt (VMware)
Date: Fri Apr 14 17:45:45 2017 -0400
ftrace: Fix removing of second function probe
commit 82cc4fc2e70ec5baeff8f776f2773abc8b2cc0ae upstream.
When two function probes are added to set\_ftrace\_filter, and then one of
them is removed, the update to the function locations is not performed, and
the record keeping of the function states are corrupted, and causes an
ftrace\_bug() to occur.
This is easily reproducable by adding two probes, removing one, and then
adding it back again.
# cd /sys/kernel/debug/tracing
# echo schedule:traceoff > set\_ftrace\_filter
# echo do\_IRQ:traceoff > set\_ftrace\_filter
# echo \!do\_IRQ:traceoff > /debug/tracing/set\_ftrace\_filter
# echo do\_IRQ:traceoff > set\_ftrace\_filter
Causes:
------------[ cut here ]------------
WARNING: CPU: 2 PID: 1098 at kernel/trace/ftrace.c:2369 ftrace\_get\_addr\_curr+0x143/0x220
Modules linked in: [...]
CPU: 2 PID: 1098 Comm: bash Not tainted 4.10.0-test+ #405
Hardware name: Hewlett-Packard HP Compaq Pro 6300 SFF/339A, BIOS K01 v02.05 05/07/2012
Call Trace:
dump\_stack+0x68/0x9f
\_\_warn+0x111/0x130
? trace\_irq\_work\_interrupt+0xa0/0xa0
warn\_slowpath\_null+0x1d/0x20
ftrace\_get\_addr\_curr+0x143/0x220
? \_\_fentry\_\_+0x10/0x10
ftrace\_replace\_code+0xe3/0x4f0
? ftrace\_int3\_handler+0x90/0x90
? printk+0x99/0xb5
? 0xffffffff81000000
ftrace\_modify\_all\_code+0x97/0x110
arch\_ftrace\_update\_code+0x10/0x20
ftrace\_run\_update\_code+0x1c/0x60
ftrace\_run\_modify\_code.isra.48.constprop.62+0x8e/0xd0
register\_ftrace\_function\_probe+0x4b6/0x590
? ftrace\_startup+0x310/0x310
? debug\_lockdep\_rcu\_enabled.part.4+0x1a/0x30
? update\_stack\_state+0x88/0x110
? ftrace\_regex\_write.isra.43.part.44+0x1d3/0x320
? preempt\_count\_sub+0x18/0xd0
? mutex\_lock\_nested+0x104/0x800
? ftrace\_regex\_write.isra.43.part.44+0x1d3/0x320
? \_\_unwind\_start+0x1c0/0x1c0
? \_mutex\_lock\_nest\_lock+0x800/0x800
ftrace\_trace\_probe\_callback.isra.3+0xc0/0x130
? func\_set\_flag+0xe0/0xe0
? \_\_lock\_acquire+0x642/0x1790
? \_\_might\_fault+0x1e/0x20
? trace\_get\_user+0x398/0x470
? strcmp+0x35/0x60
ftrace\_trace\_onoff\_callback+0x48/0x70
ftrace\_regex\_write.isra.43.part.44+0x251/0x320
? match\_records+0x420/0x420
ftrace\_filter\_write+0x2b/0x30
\_\_vfs\_write+0xd7/0x330
? do\_loop\_readv\_writev+0x120/0x120
? locks\_remove\_posix+0x90/0x2f0
? do\_lock\_file\_wait+0x160/0x160
? \_\_lock\_is\_held+0x93/0x100
? rcu\_read\_lock\_sched\_held+0x5c/0xb0
? preempt\_count\_sub+0x18/0xd0
? \_\_sb\_start\_write+0x10a/0x230
? vfs\_write+0x222/0x240
vfs\_write+0xef/0x240
SyS\_write+0xab/0x130
? SyS\_read+0x130/0x130
? trace\_hardirqs\_on\_caller+0x182/0x280
? trace\_hardirqs\_on\_thunk+0x1a/0x1c
entry\_SYSCALL\_64\_fastpath+0x18/0xad
RIP: 0033:0x7fe61c157c30
RSP: 002b:00007ffe87890258 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: ffffffff8114a410 RCX: 00007fe61c157c30
RDX: 0000000000000010 RSI: 000055814798f5e0 RDI: 0000000000000001
RBP: ffff8800c9027f98 R08: 00007fe61c422740 R09: 00007fe61ca53700
R10: 0000000000000073 R11: 0000000000000246 R12: 0000558147a36400
R13: 00007ffe8788f160 R14: 0000000000000024 R15: 00007ffe8788f15c
? trace\_hardirqs\_off\_caller+0xc0/0x110
---[ end trace 99fa09b3d9869c2c ]---
Bad trampoline accounting at: ffffffff81cc3b00 (do\_IRQ+0x0/0x150)
Fixes: 59df055f1991 ("ftrace: trace different functions with a different tracer")
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 9b35ab51a0b4c636487f4dced18e4b08369d6620
Author: Tyler Baker
Date: Thu Apr 13 15:27:31 2017 -0700
irqchip/irq-imx-gpcv2: Fix spinlock initialization
commit 75eb5e1e7b4edbc8e8f930de59004d21cb46961f upstream.
The raw\_spinlock in the IMX GPCV2 interupt chip is not initialized before
usage. That results in a lockdep splat:
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
Add the missing raw\_spin\_lock\_init() to the setup code.
Fixes: e324c4dc4a59 ("irqchip/imx-gpcv2: IMX GPCv2 driver for wakeup sources")
Signed-off-by: Tyler Baker
Reviewed-by: Fabio Estevam
Cc: jason@lakedaemon.net
Cc: marc.zyngier@arm.com
Cc: shawnguo@kernel.org
Cc: andrew.smirnov@gmail.com
Cc: linux-arm-kernel@lists.infradead.org
Link: http://lkml.kernel.org/r/20170413222731.5917-1-tyler.baker@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit b648679070a93462f7171d8d0e6e620f5bb96cf3
Author: Chen Yu
Date: Sun Apr 9 13:45:16 2017 +0800
cpufreq: Bring CPUs up even if cpufreq\_online() failed
commit c4a3fa261b16858416f1fd7db03a33d7ef5fc0b3 upstream.
There is a report that after commit 27622b061eb4 ("cpufreq: Convert
to hotplug state machine"), the normal CPU offline/online cycle
fails on some platforms.
According to the ftrace result, this problem was triggered on
platforms using acpi-cpufreq as the default cpufreq driver,
and due to the lack of some ACPI freq method (eg. \_PCT),
cpufreq\_online() failed and returned a negative value, so the CPU
hotplug state machine rolled back the CPU online process. Actually,
from the user's perspective, the failure of cpufreq\_online() should
not prevent that CPU from being brought up, although cpufreq might
not work on that CPU.
BTW, during system startup cpufreq\_online() is not invoked via CPU
online but by the cpufreq device creation process, so the APs can be
brought up even though cpufreq\_online() fails in that stage.
This patch ignores the return value of cpufreq\_online/offline() and
lets the cpufreq framework deal with the failure. cpufreq\_online()
itself will do a proper rollback in that case and if \_PCT is missing,
the ACPI cpufreq driver will print a warning if the corresponding
debug options have been enabled.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=194581
Fixes: 27622b061eb4 ("cpufreq: Convert to hotplug state machine")
Reported-and-tested-by: Tomasz Maciej Nowak
Signed-off-by: Chen Yu
Acked-by: Viresh Kumar
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 26052e29d6a262f2d77a3a4307f39517d342b60c
Author: David Wu
Date: Wed Mar 1 19:10:55 2017 +0800
pwm: rockchip: State of PWM clock should synchronize with PWM enabled state
commit a900152b5c29aea8134cc7a4c5db25552b3cd8f7 upstream.
If the PWM was not enabled at U-Boot loader, PWM could not work for
clock always disabled at PWM driver. The PWM clock is enabled at
beginning of pwm\_apply(), but disabled at end of pwm\_apply().
If the PWM was enabled at U-Boot loader, PWM clock is always enabled
unless closed by ATF. The pwm-backlight might turn off the power at
early suspend, should disable PWM clock for saving power consume.
It is important to provide opportunity to enable/disable clock at PWM
driver, the PWM consumer should ensure correct order to call PWM enable
and disable, and PWM driver ensure state of PWM clock synchronized with
PWM enabled state.
Fixes: 2bf1c98aa5a4 ("pwm: rockchip: Add support for atomic update")
Signed-off-by: David Wu
Reviewed-by: Boris Brezillon
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit 96b121b506836dd44408cbe7886def7e584bad57
Author: Markus Marb
Date: Fri Mar 17 23:14:47 2017 +0100
can: ifi: use correct register to read rx status
commit 57c1d4c33e8f7ec90976d79127059c1919cc0651 upstream.
The incorrect offset was used when trying to read the RXSTCMD register.
Signed-off-by: Markus Marb
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 5b750d3c56e378db816bbe89c5d72b912a0849f2
Author: Dan Williams
Date: Fri Apr 7 12:25:52 2017 -0700
libnvdimm: band aid btt vs clear poison locking
commit 4aa5615e080a9855e607accc75b07ab79b252dde upstream.
The following warning results from holding a lane spinlock,
preempt\_disable(), or the btt map spinlock and then trying to take the
reconfig\_mutex to walk the poison list and potentially add new entries.
BUG: sleeping function called from invalid context at kernel/locking/mutex.c:747
in\_atomic(): 1, irqs\_disabled(): 0, pid: 17159, name: dd
[..]
Call Trace:
dump\_stack+0x85/0xc8
\_\_\_might\_sleep+0x184/0x250
\_\_might\_sleep+0x4a/0x90
\_\_mutex\_lock+0x58/0x9b0
? nvdimm\_bus\_lock+0x21/0x30 [libnvdimm]
? \_\_nvdimm\_bus\_badblocks\_clear+0x2f/0x60 [libnvdimm]
? acpi\_nfit\_forget\_poison+0x79/0x80 [nfit]
? \_raw\_spin\_unlock+0x27/0x40
mutex\_lock\_nested+0x1b/0x20
nvdimm\_bus\_lock+0x21/0x30 [libnvdimm]
nvdimm\_forget\_poison+0x25/0x50 [libnvdimm]
nvdimm\_clear\_poison+0x106/0x140 [libnvdimm]
nsio\_rw\_bytes+0x164/0x270 [libnvdimm]
btt\_write\_pg+0x1de/0x3e0 [nd\_btt]
? blk\_queue\_enter+0x30/0x290
btt\_make\_request+0x11a/0x310 [nd\_btt]
? blk\_queue\_enter+0xb7/0x290
? blk\_queue\_enter+0x30/0x290
generic\_make\_request+0x118/0x3b0
As a minimal fix, disable error clearing when the BTT is enabled for the
namespace. For the final fix a larger rework of the poison list locking
is needed.
Note that this is not a problem in the blk case since that path never
calls nvdimm\_clear\_poison().
Fixes: 82bf1037f2ca ("libnvdimm: check and clear poison before writing to pmem")
Cc: Dave Jiang
[jeff: dynamically disable error clearing in the btt case]
Suggested-by: Jeff Moyer
Reviewed-by: Jeff Moyer
Reported-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit f0f306710e243d2b0bb5a84b2c3c9e35762a4d31
Author: Dan Williams
Date: Fri Apr 7 09:47:24 2017 -0700
libnvdimm: fix reconfig\_mutex, mmap\_sem, and jbd2\_handle lockdep splat
commit 0beb2012a1722633515c8aaa263c73449636c893 upstream.
Holding the reconfig\_mutex over a potential userspace fault sets up a
lockdep dependency chain between filesystem-DAX and the libnvdimm ioctl
path. Move the user access outside of the lock.
[ INFO: possible circular locking dependency detected ]
4.11.0-rc3+ #13 Tainted: G W O
-------------------------------------------------------
fallocate/16656 is trying to acquire lock:
(&nvdimm\_bus->reconfig\_mutex){+.+.+.}, at: [] nvdimm\_bus\_lock+0x21/0x30 [libnvdimm]
but task is already holding lock:
(jbd2\_handle){++++..}, at: [] start\_this\_handle+0x104/0x460
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (jbd2\_handle){++++..}:
lock\_acquire+0xbd/0x200
start\_this\_handle+0x16a/0x460
jbd2\_\_journal\_start+0xe9/0x2d0
\_\_ext4\_journal\_start\_sb+0x89/0x1c0
ext4\_dirty\_inode+0x32/0x70
\_\_mark\_inode\_dirty+0x235/0x670
generic\_update\_time+0x87/0xd0
touch\_atime+0xa9/0xd0
ext4\_file\_mmap+0x90/0xb0
mmap\_region+0x370/0x5b0
do\_mmap+0x415/0x4f0
vm\_mmap\_pgoff+0xd7/0x120
SyS\_mmap\_pgoff+0x1c5/0x290
SyS\_mmap+0x22/0x30
entry\_SYSCALL\_64\_fastpath+0x1f/0xc2
-> #1 (&mm->mmap\_sem){++++++}:
lock\_acquire+0xbd/0x200
\_\_might\_fault+0x70/0xa0
\_\_nd\_ioctl+0x683/0x720 [libnvdimm]
nvdimm\_ioctl+0x8b/0xe0 [libnvdimm]
do\_vfs\_ioctl+0xa8/0x740
SyS\_ioctl+0x79/0x90
do\_syscall\_64+0x6c/0x200
return\_from\_SYSCALL\_64+0x0/0x7a
-> #0 (&nvdimm\_bus->reconfig\_mutex){+.+.+.}:
\_\_lock\_acquire+0x16b6/0x1730
lock\_acquire+0xbd/0x200
\_\_mutex\_lock+0x88/0x9b0
mutex\_lock\_nested+0x1b/0x20
nvdimm\_bus\_lock+0x21/0x30 [libnvdimm]
nvdimm\_forget\_poison+0x25/0x50 [libnvdimm]
nvdimm\_clear\_poison+0x106/0x140 [libnvdimm]
pmem\_do\_bvec+0x1c2/0x2b0 [nd\_pmem]
pmem\_make\_request+0xf9/0x270 [nd\_pmem]
generic\_make\_request+0x118/0x3b0
submit\_bio+0x75/0x150
Fixes: 62232e45f4a2 ("libnvdimm: control (ioctl) messages for nvdimm\_bus and nvdimm devices")
Cc: Dave Jiang
Reported-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit e0d47228949e584c5be29b84dfe75bcfafcf8e61
Author: Dan Williams
Date: Tue Apr 4 15:08:36 2017 -0700
libnvdimm: fix blk free space accounting
commit fe514739d8538783749d3ce72f78e5a999ea5668 upstream.
Commit a1f3e4d6a0c3 "libnvdimm, region: update nd\_region\_available\_dpa()
for multi-pmem support" reworked blk dpa (DIMM Physical Address)
accounting to comprehend multiple pmem namespace allocations aliasing
with a given blk-dpa range.
The following call trace is a result of failing to account for allocated
blk capacity.
WARNING: CPU: 1 PID: 2433 at tools/testing/nvdimm/../../../drivers/nvdimm/names
4 size\_store+0x6f3/0x930 [libnvdimm]
nd\_region region5: allocation underrun: 0x0 of 0x1000000 bytes
[..]
Call Trace:
dump\_stack+0x86/0xc3
\_\_warn+0xcb/0xf0
warn\_slowpath\_fmt+0x5f/0x80
size\_store+0x6f3/0x930 [libnvdimm]
dev\_attr\_store+0x18/0x30
If a given blk-dpa allocation does not alias with any pmem ranges then
the full allocation should be accounted as busy space, not the size of
the current pmem contribution to the region.
The thinkos that led to this confusion was not realizing that the struct
resource management is already guaranteeing no collisions between pmem
allocations and blk allocations on the same dimm. Also, we do not try to
support blk allocations in aliased pmem holes.
This patch also fixes a case where the available blk goes negative.
Fixes: a1f3e4d6a0c3 ("libnvdimm, region: update nd\_region\_available\_dpa() for multi-pmem support").
Reported-by: Dariusz Dokupil
Reported-by: Dave Jiang
Reported-by: Vishal Verma
Tested-by: Dave Jiang
Tested-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 66481ca0750da4a019d4aa88c00f72032e3ccc34
Author: Al Viro
Date: Fri Feb 17 20:16:34 2017 -0500
make skb\_copy\_datagram\_msg() et.al. preserve ->msg\_iter on error
commit 3278682123811dd8ef07de5eb701fc4548fcebf2 upstream.
Fixes the mess observed in e.g. rsync over a noisy link we'd been
seeing since last Summer. What happens is that we copy part of
a datagram before noticing a checksum mismatch. Datagram will be
resent, all right, but we want the next try go into the same place,
not after it...
All this family of primitives (copy/checksum and copy a datagram
into destination) is "all or nothing" sort of interface - either
we get 0 (meaning that copy had been successful) or we get an
error (and no way to tell how much had been copied before we ran
into whatever error it had been). Make all of them leave iterator
unadvanced in case of errors - all callers must be able to cope
with that (an error might've been caught before the iterator had
been advanced), it costs very little to arrange, it's safer for
callers and actually fixes at least one bug in said callers.
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit a99a9ff2374ac30fe87c820fca3401d3275f2b79
Author: Al Viro
Date: Fri Feb 17 18:42:24 2017 -0500
new privimitive: iov\_iter\_revert()
commit 27c0e3748e41ca79171ffa3e97415a20af6facd0 upstream.
opposite to iov\_iter\_advance(); the caller is responsible for never
using it to move back past the initial position.
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 939707c50352950243e7fd6e7e088af0db6d51e2
Author: Juergen Gross
Date: Fri Apr 7 17:28:23 2017 +0200
xen, fbfront: fix connecting to backend
commit 9121b15b5628b38b4695282dc18c553440e0f79b upstream.
Connecting to the backend isn't working reliably in xen-fbfront: in
case XenbusStateInitWait of the backend has been missed the backend
transition to XenbusStateConnected will trigger the connected state
only without doing the actions required when the backend has
connected.
Signed-off-by: Juergen Gross
Reviewed-by: Boris Ostrovsky
Signed-off-by: Bartlomiej Zolnierkiewicz
Signed-off-by: Greg Kroah-Hartman
commit 22113847cd117b26bd14316f735af79fc37cb6be
Author: Nicholas Bellinger
Date: Mon Mar 27 16:12:43 2017 -0700
target: Avoid mappedlun symlink creation during lun shutdown
commit 49cb77e297dc611a1b795cfeb79452b3002bd331 upstream.
This patch closes a race between se\_lun deletion during configfs
unlink in target\_fabric\_port\_unlink() -> core\_dev\_del\_lun()
-> core\_tpg\_remove\_lun(), when transport\_clear\_lun\_ref() blocks
waiting for percpu\_ref RCU grace period to finish, but a new
NodeACL mappedlun is added before the RCU grace period has
completed.
This can happen in target\_fabric\_mappedlun\_link() because it
only checks for se\_lun->lun\_se\_dev, which is not cleared until
after transport\_clear\_lun\_ref() percpu\_ref RCU grace period
finishes.
This bug originally manifested as NULL pointer dereference
OOPsen in target\_stat\_scsi\_att\_intr\_port\_show\_attr\_dev() on
v4.1.y code, because it dereferences lun->lun\_se\_dev without
a explicit NULL pointer check.
In post v4.1 code with target-core RCU conversion, the code
in target\_stat\_scsi\_att\_intr\_port\_show\_attr\_dev() no longer
uses se\_lun->lun\_se\_dev, but the same race still exists.
To address the bug, go ahead and set se\_lun>lun\_shutdown as
early as possible in core\_tpg\_remove\_lun(), and ensure new
NodeACL mappedlun creation in target\_fabric\_mappedlun\_link()
fails during se\_lun shutdown.
Reported-by: James Shen
Cc: James Shen
Tested-by: James Shen
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 53204334cca0ac11e58b03365b16c435694c6770
Author: Martin K. Petersen
Date: Tue Apr 4 10:42:30 2017 -0400
scsi: sd: Fix capacity calculation with 32-bit sector\_t
commit 7c856152cb92f8eee2df29ef325a1b1f43161aff upstream.
We previously made sure that the reported disk capacity was less than
0xffffffff blocks when the kernel was not compiled with large sector\_t
support (CONFIG\_LBDAF). However, this check assumed that the capacity
was reported in units of 512 bytes.
Add a sanity check function to ensure that we only enable disks if the
entire reported capacity can be expressed in terms of sector\_t.
Reported-by: Steve Magnani
Cc: Bart Van Assche
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 24c01b369765d88ba50206a3fd02790d98e5c57c
Author: Sawan Chandak
Date: Fri Mar 31 14:37:03 2017 -0700
scsi: qla2xxx: Add fix to read correct register value for ISP82xx.
commit bf6061b17a8d47ef0d9344d3ef576a4ff0edf793 upstream.
Add fix to read correct register value for ISP82xx, during check for
register disconnect.ISP82xx has different base register.
Fixes: a465537ad1a4 ("qla2xxx: Disable the adapter and skip error recovery in case of register disconnect")
Signed-off-by: Sawan Chandak
Signed-off-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 8b30ed56fa89c14f9850438b48fe8a3fa0005e47
Author: Fam Zheng
Date: Tue Mar 28 12:41:26 2017 +0800
scsi: sd: Consider max\_xfer\_blocks if opt\_xfer\_blocks is unusable
commit 6780414519f91c2a84da9baa963a940ac916f803 upstream.
If device reports a small max\_xfer\_blocks and a zero opt\_xfer\_blocks, we
end up using BLK\_DEF\_MAX\_SECTORS, which is wrong and r/w of that size
may get error.
[mkp: tweaked to avoid setting rw\_max twice and added typecast]
Fixes: ca369d51b3e ("block/sd: Fix device-imposed transfer length limits")
Signed-off-by: Fam Zheng
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 01fb9440938af4083e4883a3190980fee8fa7e00
Author: Martin K. Petersen
Date: Fri Mar 17 08:47:14 2017 -0400
scsi: sr: Sanity check returned mode data
commit a00a7862513089f17209b732f230922f1942e0b9 upstream.
Kefeng Wang discovered that old versions of the QEMU CD driver would
return mangled mode data causing us to walk off the end of the buffer in
an attempt to parse it. Sanity check the returned mode sense data.
Reported-by: Kefeng Wang
Tested-by: Kefeng Wang
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit c8270f29214cbbaf4feb2b784ddc75f8d3866eaa
Author: Nicholas Bellinger
Date: Sun Apr 2 13:36:44 2017 -0700
iscsi-target: Drop work-around for legacy GlobalSAN initiator
commit 1c99de981f30b3e7868b8d20ce5479fa1c0fea46 upstream.
Once upon a time back in 2009, a work-around was added to support
the GlobalSAN iSCSI initiator v3.3 for MacOSX, which during login
did not propose nor respond to MaxBurstLength, FirstBurstLength,
DefaultTime2Wait and DefaultTime2Retain keys.
The work-around in iscsi\_check\_proposer\_for\_optional\_reply()
allowed the missing keys to be proposed, but did not require
waiting for a response before moving to full feature phase
operation. This allowed GlobalSAN v3.3 to work out-of-the
box, and for many years we didn't run into login interopt
issues with any other initiators..
Until recently, when Martin tried a QLogic 57840S iSCSI Offload
HBA on Windows 2016 which completed login, but subsequently
failed with:
Got unknown iSCSI OpCode: 0x43
The issue was QLogic MSFT side did not propose DefaultTime2Wait +
DefaultTime2Retain, so LIO proposes them itself, and immediately
transitions to full feature phase because of the GlobalSAN hack.
However, the QLogic MSFT side still attempts to respond to
DefaultTime2Retain + DefaultTime2Wait, even though LIO has set
ISCSI\_FLAG\_LOGIN\_NEXT\_STAGE3 + ISCSI\_FLAG\_LOGIN\_TRANSIT
in last login response.
So while the QLogic MSFT side should have been proposing these
two keys to start, it was doing the correct thing per RFC-3720
attempting to respond to proposed keys before transitioning to
full feature phase.
All that said, recent versions of GlobalSAN iSCSI (v5.3.0.541)
does correctly propose the four keys during login, making the
original work-around moot.
So in order to allow QLogic MSFT to run unmodified as-is, go
ahead and drop this long standing work-around.
Reported-by: Martin Svec
Cc: Martin Svec
Cc: Himanshu Madhani
Cc: Arun Easi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 510152205d41af106d432655fc7ff77f5182eaaa
Author: Nicholas Bellinger
Date: Thu Mar 23 17:19:24 2017 -0700
iscsi-target: Fix TMR reference leak during session shutdown
commit efb2ea770bb3b0f40007530bc8b0c22f36e1c5eb upstream.
This patch fixes a iscsi-target specific TMR reference leak
during session shutdown, that could occur when a TMR was
quiesced before the hand-off back to iscsi-target code
via transport\_cmd\_check\_stop\_to\_fabric().
The reference leak happens because iscsit\_free\_cmd() was
incorrectly skipping the final target\_put\_sess\_cmd() for
TMRs when transport\_generic\_free\_cmd() returned zero because
the se\_cmd->cmd\_kref did not reach zero, due to the missing
se\_cmd assignment in original code.
The result was iscsi\_cmd and it's associated se\_cmd memory
would be freed once se\_sess->sess\_cmd\_map where released,
but the associated se\_tmr\_req was leaked and remained part
of se\_device->dev\_tmr\_list.
This bug would manfiest itself as kernel paging request
OOPsen in core\_tmr\_lun\_reset(), when a left-over se\_tmr\_req
attempted to dereference it's se\_cmd pointer that had
already been released during normal session shutdown.
To address this bug, go ahead and treat ISCSI\_OP\_SCSI\_CMD
and ISCSI\_OP\_SCSI\_TMFUNC the same when there is an extra
se\_cmd->cmd\_kref to drop in iscsit\_free\_cmd(), and use
op\_scsi to signal \_\_iscsit\_free\_cmd() when the former
needs to clear any further iscsi related I/O state.
Reported-by: Rob Millner
Cc: Rob Millner
Reported-by: Chu Yuan Lin
Cc: Chu Yuan Lin
Tested-by: Chu Yuan Lin
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit c100de410c1e09d558f5e2b7af8330a55832b177
Author: Ard Biesheuvel
Date: Tue Apr 4 16:27:44 2017 +0100
efi/fb: Avoid reconfiguration of BAR that covers the framebuffer
commit 55d728a40d368ba80443be85c02e641fc9082a3f upstream.
On UEFI systems, the PCI subsystem is enumerated by the firmware,
and if a graphical framebuffer is exposed via a PCI device, its base
address and size are exposed to the OS via the Graphics Output
Protocol (GOP).
On arm64 PCI systems, the entire PCI hierarchy is reconfigured from
scratch at boot. This may result in the GOP framebuffer address to
become stale, if the BAR covering the framebuffer is modified. This
will cause the framebuffer to become unresponsive, and may in some
cases result in unpredictable behavior if the range is reassigned to
another device.
So add a non-x86 quirk to the EFI fb driver to find the BAR associated
with the GOP base address, and claim the BAR resource so that the PCI
core will not move it.
Signed-off-by: Ard Biesheuvel
Cc: Linus Torvalds
Cc: Matt Fleming
Cc: Peter Jones
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: leif.lindholm@linaro.org
Cc: linux-efi@vger.kernel.org
Cc: lorenzo.pieralisi@arm.com
Fixes: 9822504c1fa5 ("efifb: Enable the efi-framebuffer platform driver ...")
Link: http://lkml.kernel.org/r/20170404152744.26687-3-ard.biesheuvel@linaro.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 6b8a0080915d7eb9969a08bad2adfaf8144a11b5
Author: Cohen, Eugene
Date: Tue Apr 4 16:27:43 2017 +0100
efi/libstub: Skip GOP with PIXEL\_BLT\_ONLY format
commit 540f4c0e894f7e46a66dfa424b16424cbdc12c38 upstream.
The UEFI Specification permits Graphics Output Protocol (GOP) instances
without direct framebuffer access. This is indicated in the Mode structure
with a PixelFormat enumeration value of PIXEL\_BLT\_ONLY. Given that the
kernel does not know how to drive a Blt() only framebuffer (which is only
permitted before ExitBootServices() anyway), we should disregard such
framebuffers when looking for a GOP instance that is suitable for use as
the boot console.
So modify the EFI GOP initialization to not use a PIXEL\_BLT\_ONLY instance,
preventing attempts later in boot to use an invalid screen\_info.lfb\_base
address.
Signed-off-by: Eugene Cohen
[ Moved the Blt() only check into the loop and clarified that Blt() only GOPs are unusable by the kernel. ]
Signed-off-by: Ard Biesheuvel
Cc: Linus Torvalds
Cc: Matt Fleming
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: leif.lindholm@linaro.org
Cc: linux-efi@vger.kernel.org
Cc: lorenzo.pieralisi@arm.com
Fixes: 9822504c1fa5 ("efifb: Enable the efi-framebuffer platform driver ...")
Link: http://lkml.kernel.org/r/20170404152744.26687-2-ard.biesheuvel@linaro.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit ca3e0b6d6b25a605a99c3dd2b5f3c2a06f00c748
Author: Mikulas Patocka
Date: Fri Apr 14 14:15:20 2017 -0400
parisc: fix bugs in pa\_memcpy
commit 409c1b250e30ad0e48b4d15d7319b4e18c046c4f upstream.
The patch 554bfeceb8a22d448cd986fc9efce25e833278a1 ("parisc: Fix access
fault handling in pa\_memcpy()") reimplements the pa\_memcpy function.
Unfortunatelly, it makes the kernel unbootable. The crash happens in the
function ide\_complete\_cmd where memcpy is called with the same source
and destination address.
This patch fixes a few bugs in pa\_memcpy:
\* When jumping to .Lcopy\_loop\_16 for the first time, don't skip the
instruction "ldi 31,t0" (this bug made the kernel unbootable)
\* Use the COND macro when comparing length, so that the comparison is
64-bit (a theoretical issue, in case the length is greater than
0xffffffff)
\* Don't use the COND macro after the "extru" instruction (the PA-RISC
specification says that the upper 32-bits of extru result are undefined,
although they are set to zero in practice)
\* Fix exception addresses in .Lcopy16\_fault and .Lcopy8\_fault
\* Rename .Lcopy\_loop\_4 to .Lcopy\_loop\_8 (so that it is consistent with
.Lcopy8\_fault)
Fixes: 554bfeceb8a2 ("parisc: Fix access fault handling in pa\_memcpy()")
Signed-off-by: Mikulas Patocka
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 87ad80ecdb5c91d1795e73c929b32aabd46ab5c1
Author: Rafael J. Wysocki
Date: Tue Apr 11 00:23:42 2017 +0200
ACPI / scan: Set the visited flag for all enumerated devices
commit f406270bf73d71ea7b35ee3f7a08a44f6594c9b1 upstream.
Commit 10c7e20b2ff3 (ACPI / scan: fix enumeration (visited) flags for
bus rescans) attempted to fix a problem with ACPI-based enumerateion
of I2C/SPI devices, but it forgot to ensure that the visited flag
will be set for all of the other enumerated devices, so fix that.
Fixes: 10c7e20b2ff3 (ACPI / scan: fix enumeration (visited) flags for bus rescans)
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=194885
Reported-and-tested-by: Kevin Locke
Signed-off-by: Rafael J. Wysocki
Reviewed-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit 122c16ccc71b9db339fd94a638695b7c00aea066
Author: Dan Williams
Date: Mon Mar 27 21:53:38 2017 -0700
acpi, nfit, libnvdimm: fix interleave set cookie calculation (64-bit comparison)
commit b03b99a329a14b7302f37c3ea6da3848db41c8c5 upstream.
While reviewing the -stable patch for commit 86ef58a4e35e "nfit,
libnvdimm: fix interleave set cookie calculation" Ben noted:
"This is returning an int, thus it's effectively doing a 32-bit
comparison and not the 64-bit comparison you say is needed."
Update the compare operation to be immune to this integer demotion problem.
Cc: Nicholas Moulin
Fixes: 86ef58a4e35e ("nfit, libnvdimm: fix interleave set cookie calculation")
Reported-by: Ben Hutchings
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 083d30d61a1aef4d28c7d6b273430de20e1c1efe
Author: Thomas Gleixner
Date: Mon Apr 10 17:14:28 2017 +0200
x86/vdso: Plug race between mapping and ELF header setup
commit 6fdc6dd90272ce7e75d744f71535cfbd8d77da81 upstream.
The vsyscall32 sysctl can racy against a concurrent fork when it switches
from disabled to enabled:
arch\_setup\_additional\_pages()
if (vdso32\_enabled)
--> No mapping
sysctl.vsysscall32()
--> vdso32\_enabled = true
create\_elf\_tables()
ARCH\_DLINFO\_IA32
if (vdso32\_enabled) {
--> Add VDSO entry with NULL pointer
Make ARCH\_DLINFO\_IA32 check whether the VDSO mapping has been set up for
the newly forked process or not.
Signed-off-by: Thomas Gleixner
Acked-by: Andy Lutomirski
Cc: Peter Zijlstra
Cc: Mathias Krause
Link: http://lkml.kernel.org/r/20170410151723.602367196@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 90dc1120444f897c4017c38b943ebce0bc510e6d
Author: Mathias Krause
Date: Mon Apr 10 17:14:27 2017 +0200
x86/vdso: Ensure vdso32\_enabled gets set to valid values only
commit c06989da39cdb10604d572c8c7ea8c8c97f3c483 upstream.
vdso\_enabled can be set to arbitrary integer values via the kernel command
line 'vdso32=' parameter or via 'sysctl abi.vsyscall32'.
load\_vdso32() only maps VDSO if vdso\_enabled == 1, but ARCH\_DLINFO\_IA32
merily checks for vdso\_enabled != 0. As a consequence the AT\_SYSINFO\_EHDR
auxiliary vector for the VDSO\_ENTRY is emitted with a NULL pointer which
causes a segfault when the application tries to use the VDSO.
Restrict the valid arguments on the command line and the sysctl to 0 and 1.
Fixes: b0b49f2673f0 ("x86, vdso: Remove compat vdso support")
Signed-off-by: Mathias Krause
Acked-by: Andy Lutomirski
Cc: Peter Zijlstra
Cc: Roland McGrath
Link: http://lkml.kernel.org/r/1491424561-7187-1-git-send-email-minipli@googlemail.com
Link: http://lkml.kernel.org/r/20170410151723.518412863@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit b8cb11e01a7feb5a7136f4881324ebde1a57a2eb
Author: Dan Williams
Date: Thu Apr 6 09:04:31 2017 -0700
x86, pmem: fix broken \_\_copy\_user\_nocache cache-bypass assumptions
commit 11e63f6d920d6f2dfd3cd421e939a4aec9a58dcd upstream.
Before we rework the "pmem api" to stop abusing \_\_copy\_user\_nocache()
for memcpy\_to\_pmem() we need to fix cases where we may strand dirty data
in the cpu cache. The problem occurs when copy\_from\_iter\_pmem() is used
for arbitrary data transfers from userspace. There is no guarantee that
these transfers, performed by dax\_iomap\_actor(), will have aligned
destinations or aligned transfer lengths. Backstop the usage
\_\_copy\_user\_nocache() with explicit cache management in these unaligned
cases.
Yes, copy\_from\_iter\_pmem() is now too big for an inline, but addressing
that is saved for a later patch that moves the entirety of the "pmem
api" into the pmem driver directly.
Fixes: 5de490daec8b ("pmem: add copy\_from\_iter\_pmem() and clear\_pmem()")
Cc:
Cc: Jan Kara
Cc: Jeff Moyer
Cc: Ingo Molnar
Cc: Christoph Hellwig
Cc: "H. Peter Anvin"
Cc: Al Viro
Cc: Thomas Gleixner
Cc: Matthew Wilcox
Reviewed-by: Ross Zwisler
Signed-off-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 1a99658f083d348102ec6d236d192cb5d59908d8
Author: Jiri Olsa
Date: Tue Apr 11 09:14:46 2017 +0200
x86/intel\_rdt: Fix locking in rdtgroup\_schemata\_write()
commit 7f00f388712b29005782bad7e4b25942620f3b9c upstream.
The schemata lock is released before freeing the resource's temporary
tmp\_cbms allocation. That's racy versus another write which allocates and
uses new temporary storage, resulting in memory leaks, freeing in use
memory, double a free or any combination of those.
Move the unlock after the release code.
Fixes: 60ec2440c63d ("x86/intel\_rdt: Add schemata file")
Signed-off-by: Jiri Olsa
Cc: Fenghua Yu
Cc: Peter Zijlstra
Cc: Peter Zijlstra
Cc: Mike Galbraith
Cc: Shaohua Li
Link: http://lkml.kernel.org/r/20170411071446.15241-1-jolsa@kernel.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 565194a4205278d50529c70183acf4a218c95897
Author: Joerg Roedel
Date: Tue Apr 4 18:15:01 2017 +0200
x86/signals: Fix lower/upper bound reporting in compat siginfo
commit cfac6dfa42bddfa9711b20d486e521d1a41ab09f upstream.
Put the right values from the original siginfo into the
userspace compat-siginfo.
This fixes the 32-bit MPX "tabletest" testcase on 64-bit kernels.
Signed-off-by: Joerg Roedel
Acked-by: Dave Hansen
Cc: Andy Lutomirski
Cc: Borislav Petkov
Cc: Borislav Petkov
Cc: Brian Gerst
Cc: Denys Vlasenko
Cc: Dmitry Safonov <0x7f454c46@gmail.com>
Cc: H. Peter Anvin
Cc: Josh Poimboeuf
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Fixes: a4455082dc6f0 ('x86/signals: Add missing signal\_compat code for x86 features')
Link: http://lkml.kernel.org/r/1491322501-5054-1-git-send-email-joro@8bytes.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit c6be568a2f244827f6d24150855dce6dfe8d0afb
Author: Omar Sandoval
Date: Wed Apr 12 16:27:19 2017 +0100
x86/efi: Don't try to reserve runtime regions
commit 6f6266a561306e206e0e31a5038f029b6a7b1d89 upstream.
Reserving a runtime region results in splitting the EFI memory
descriptors for the runtime region. This results in runtime region
descriptors with bogus memory mappings, leading to interesting crashes
like the following during a kexec:
general protection fault: 0000 [#1] SMP
Modules linked in:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 4.11.0-rc1 #53
Hardware name: Wiwynn Leopard-Orv2/Leopard-DDR BW, BIOS LBM05 09/30/2016
RIP: 0010:virt\_efi\_set\_variable()
...
Call Trace:
efi\_delete\_dummy\_variable()
efi\_enter\_virtual\_mode()
start\_kernel()
? set\_init\_arg()
x86\_64\_start\_reservations()
x86\_64\_start\_kernel()
start\_cpu()
...
Kernel panic - not syncing: Fatal exception
Runtime regions will not be freed and do not need to be reserved, so
skip the memmap modification in this case.
Signed-off-by: Omar Sandoval
Signed-off-by: Matt Fleming
Cc: Ard Biesheuvel
Cc: Dave Young
Cc: Linus Torvalds
Cc: Peter Jones
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-efi@vger.kernel.org
Fixes: 8e80632fb23f ("efi/esrt: Use efi\_mem\_reserve() and avoid a kmalloc()")
Link: http://lkml.kernel.org/r/20170412152719.9779-2-matt@codeblueprint.co.uk
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 4ff9e6c2d86bc7dfe12c6621fcb7a1caef8f5d74
Author: Peter Zijlstra
Date: Tue Apr 11 10:10:28 2017 +0200
perf/x86: Avoid exposing wrong/stale data in intel\_pmu\_lbr\_read\_32()
commit f2200ac311302fcdca6556fd0c5127eab6c65a3e upstream.
When the perf\_branch\_entry::{in\_tx,abort,cycles} fields were added,
intel\_pmu\_lbr\_read\_32() wasn't updated to initialize them.
Signed-off-by: Peter Zijlstra (Intel)
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-kernel@vger.kernel.org
Fixes: 135c5612c460 ("perf/x86/intel: Support Haswell/v4 LBR format")
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 535adf24d1a79dd6d03a8a4af2fd16a1109df7b5
Author: Christian Borntraeger
Date: Thu Apr 6 09:51:51 2017 +0200
perf annotate s390: Fix perf annotate error -95 (4.10 regression)
commit 3c1a427954399fd1bda1ee7e1b356f47b61cee74 upstream.
since 4.10 perf annotate exits on s390 with an "unknown error -95".
Turns out that commit 786c1b51844d ("perf annotate: Start supporting
cross arch annotation") added a hard requirement for architecture
support when objdump is used but only provided x86 and arm support.
Meanwhile power was added so lets add s390 as well.
While at it make sure to implement the branch and jump types.
Signed-off-by: Christian Borntraeger
Cc: Andreas Krebbel
Cc: Hendrik Brueckner
Cc: Martin Schwidefsky
Cc: Peter Zijlstra
Cc: linux-s390
Fixes: 786c1b51844 "perf annotate: Start supporting cross arch annotation"
Link: http://lkml.kernel.org/r/1491465112-45819-2-git-send-email-borntraeger@de.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 7869b4078ba9125a406301a4e1c86d5335a43363
Author: Cameron Gutman
Date: Mon Apr 10 20:44:25 2017 -0700
Input: xpad - add support for Razer Wildcat gamepad
commit 5376366886251e2f8f248704adb620a4bc4c0937 upstream.
Signed-off-by: Cameron Gutman
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 3f17ee38a808129f93f8685e6e2c484bdecea25f
Author: Germano Percossi
Date: Fri Apr 7 12:29:38 2017 +0100
CIFS: store results of cifs\_reopen\_file to avoid infinite wait
commit 1fa839b4986d648b907d117275869a0e46c324b9 upstream.
This fixes Continuous Availability when errors during
file reopen are encountered.
cifs\_user\_readv and cifs\_user\_writev would wait for ever if
results of cifs\_reopen\_file are not stored and for later inspection.
In fact, results are checked and, in case of errors, a chain
of function calls leading to reads and writes to be scheduled in
a separate thread is skipped.
These threads will wake up the corresponding waiters once reads
and writes are done.
However, given the return value is not stored, when rc is checked
for errors a previous one (always zero) is inspected instead.
This leads to pending reads/writes added to the list, making
cifs\_user\_readv and cifs\_user\_writev wait for ever.
Signed-off-by: Germano Percossi
Reviewed-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 6e9b6937a9230374378306e952f7f125359c5fa2
Author: Germano Percossi
Date: Fri Apr 7 12:29:36 2017 +0100
CIFS: reconnect thread reschedule itself
commit 18ea43113f5b74a97dd4be9bddbac10d68b1a6ce upstream.
In case of error, smb2\_reconnect\_server reschedule itself
with a delay, to avoid being too aggressive.
Signed-off-by: Germano Percossi
Reviewed-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit d38b12ab7b054912bf2df3d48810f305d2914632
Author: Michel Dänzer
Date: Thu Mar 23 17:53:26 2017 +0900
drm/fb-helper: Allow var->x/yres(\_virtual) < fb->width/height again
commit 12ffed96d4369f086261ba2ee734fa8c932d7f55 upstream.
Otherwise this can also prevent modesets e.g. for switching VTs, when
multiple monitors with different native resolutions are connected.
The depths must match though, so keep the != test for that.
Also update the DRM\_DEBUG output to be slightly more accurate, this
doesn't only affect requests from userspace.
Bugzilla: https://bugs.freedesktop.org/99841
Fixes: 865afb11949e ("drm/fb-helper: reject any changes to the fbdev")
Signed-off-by: Michel Dänzer
Reviewed-by: Daniel Stone
Signed-off-by: Daniel Vetter
Link: http://patchwork.freedesktop.org/patch/msgid/20170323085326.20185-1-michel@daenzer.net
Signed-off-by: Greg Kroah-Hartman
commit e97e515b744857377b328d7aaa1a7278343b0bd7
Author: Wei Yongjun
Date: Wed Apr 12 00:31:16 2017 +0000
drm/etnaviv: fix missing unlock on error in etnaviv\_gpu\_submit()
commit 45abdf35cf82e4270328c7237e7812de960ac560 upstream.
Add the missing unlock before return from function etnaviv\_gpu\_submit()
in the error handling case.
lst: fixed label name.
Fixes: f3cd1b064f11 ("drm/etnaviv: (re-)protect fence allocation with GPU mutex")
Signed-off-by: Wei Yongjun
Signed-off-by: Lucas Stach
Signed-off-by: Greg Kroah-Hartman
commit 3287a46c7829c7c949862bc926cb8dda6756d6a1
Author: Ben Skeggs
Date: Thu Apr 6 10:35:26 2017 +1000
drm/nouveau: initial support (display-only) for GP107
commit da2ba564a6dcf46df4f828624ff55531ff11d5b0 upstream.
Forked from GP106 implementation.
Split out from commit enabling secboot/gr support so that it can be
added to earlier kernels.
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit 2efa4bd3b644f115befbd225f45fce936e19cf2c
Author: Ben Skeggs
Date: Wed Apr 5 18:16:14 2017 +1000
drm/nouveau/kms/nv50: fix double dma\_fence\_put() when destroying plane state
commit 2907e8670b6ef253bffb33bf47fd2182969cf2a0 upstream.
When the atomic support was added to nouveau, the DRM core did not do this.
However, later in the same merge window, a commit (drm/fence: add in-fences
support) was merged that added it, leading to use-after-frees of the fence
object.
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit b6b2448efe6467d4bc8dabb357db120f873ed303
Author: Ben Skeggs
Date: Wed Apr 5 09:12:54 2017 +1000
drm/nouveau/kms/nv50: fix setting of HeadSetRasterVertBlankDmi method
commit d639fbcc102745187f747a21bdcffcf628e174c8 upstream.
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit 8418bb809e559787b2eb6bba7fb3ab728db4b611
Author: Ilia Mirkin
Date: Sat Mar 18 16:23:10 2017 -0400
drm/nouveau/mmu/nv4a: use nv04 mmu rather than the nv44 one
commit f94773b9f5ecd1df7c88c2e921924dd41d2020cc upstream.
The NV4A (aka NV44A) is an oddity in the family. It only comes in AGP
and PCI varieties, rather than a core PCIE chip with a bridge for
AGP/PCI as necessary. As a result, it appears that the MMU is also
non-functional. For AGP cards, the vast majority of the NV4A lineup,
this worked out since we force AGP cards to use the nv04 mmu. However
for PCI variants, this did not work.
Switching to the NV04 MMU makes it work like a charm. Thanks to mwk for
the suggestion. This should be a no-op for NV4A AGP boards, as they were
using it already.
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=70388
Signed-off-by: Ilia Mirkin
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit cc3c096855c6dfaf495ccbef65337379e1e8e53f
Author: Ilia Mirkin
Date: Sat Mar 18 21:53:05 2017 -0400
drm/nouveau/mpeg: mthd returns true on success now
commit 83bce9c2baa51e439480a713119a73d3c8b61083 upstream.
Signed-off-by: Ilia Mirkin
Fixes: 590801c1a3 ("drm/nouveau/mpeg: remove dependence on namedb/engctx lookup")
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit 5de87d225e0864e618326cbc313a856b5a55f1c8
Author: Martin Brandenburg
Date: Fri Apr 14 14:22:41 2017 -0400
orangefs: free superblock when mount fails
commit 1ec1688c5360e14dde4094d6acbf7516bf6db37e upstream.
Otherwise lockdep says:
[ 1337.483798] ================================================
[ 1337.483999] [ BUG: lock held when returning to user space! ]
[ 1337.484252] 4.11.0-rc6 #19 Not tainted
[ 1337.484423] ------------------------------------------------
[ 1337.484626] mount/14766 is leaving the kernel with locks still held!
[ 1337.484841] 1 lock held by mount/14766:
[ 1337.485017] #0: (&type->s\_umount\_key#33/1){+.+.+.}, at: [] sget\_userns+0x2af/0x520
Caught by xfstests generic/413 which tried to mount with the unsupported
mount option dax. Then xfstests generic/422 ran sync which deadlocks.
Signed-off-by: Martin Brandenburg
Acked-by: Mike Marshall
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5f8cde206712fd30be57134b7efd8e7beb6fd542
Author: Minchan Kim
Date: Thu Apr 13 14:56:40 2017 -0700
zsmalloc: expand class bit
commit 85d492f28d056c40629fc25d79f54da618a29dc4 upstream.
Now 64K page system, zsamlloc has 257 classes so 8 class bit is not
enough. With that, it corrupts the system when zsmalloc stores
65536byte data(ie, index number 256) so that this patch increases class
bit for simple fix for stable backport. We should clean up this mess
soon.
index size
0 32
1 288
..
..
204 52256
256 65536
Fixes: 3783689a1 ("zsmalloc: introduce zspage structure")
Link: http://lkml.kernel.org/r/1492042622-12074-3-git-send-email-minchan@kernel.org
Signed-off-by: Minchan Kim
Cc: Sergey Senozhatsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5c7de46108253e925a1f1d49e6e4658e8e8e3bb4
Author: Kirill A. Shutemov
Date: Thu Apr 13 14:56:28 2017 -0700
thp: fix MADV\_DONTNEED vs clear soft dirty race
commit 5b7abeae3af8c08c577e599dd0578b9e3ee6687b upstream.
Yet another instance of the same race.
Fix is identical to change\_huge\_pmd().
See "thp: fix MADV\_DONTNEED vs. numa balancing race" for more details.
Link: http://lkml.kernel.org/r/20170302151034.27829-5-kirill.shutemov@linux.intel.com
Signed-off-by: Kirill A. Shutemov
Cc: Andrea Arcangeli
Cc: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d7847a2203a139af8ac7372a1dfd5d462de47657
Author: Kirill A. Shutemov
Date: Thu Apr 13 14:56:26 2017 -0700
thp: fix MADV\_DONTNEED vs. MADV\_FREE race
commit 58ceeb6bec86d9140f9d91d71a710e963523d063 upstream.
Both MADV\_DONTNEED and MADV\_FREE handled with down\_read(mmap\_sem).
It's critical to not clear pmd intermittently while handling MADV\_FREE
to avoid race with MADV\_DONTNEED:
CPU0: CPU1:
madvise\_free\_huge\_pmd()
pmdp\_huge\_get\_and\_clear\_full()
madvise\_dontneed()
zap\_pmd\_range()
pmd\_trans\_huge(\*pmd) == 0 (without ptl)
// skip the pmd
set\_pmd\_at();
// pmd is re-established
It results in MADV\_DONTNEED skipping the pmd, leaving it not cleared.
It violates MADV\_DONTNEED interface and can result is userspace
misbehaviour.
Basically it's the same race as with numa balancing in
change\_huge\_pmd(), but a bit simpler to mitigate: we don't need to
preserve dirty/young flags here due to MADV\_FREE functionality.
[kirill.shutemov@linux.intel.com: Urgh... Power is special again]
Link: http://lkml.kernel.org/r/20170303102636.bhd2zhtpds4mt62a@black.fi.intel.com
Link: http://lkml.kernel.org/r/20170302151034.27829-4-kirill.shutemov@linux.intel.com
Signed-off-by: Kirill A. Shutemov
Acked-by: Minchan Kim
Cc: Minchan Kim
Cc: Andrea Arcangeli
Cc: Hillf Danton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit e2083153996d6fab0ce78d1e947826af88603951
Author: Xiubo Li
Date: Fri Mar 31 10:35:25 2017 +0800
tcmu: Skip Data-Out blocks before gathering Data-In buffer for BIDI case
commit a5d68ba85801a78c892a0eb8efb711e293ed314b upstream.
For the bidirectional case, the Data-Out buffer blocks will always at
the head of the tcmu\_cmd's bitmap, and before gathering the Data-In
buffer, first of all it should skip the Data-Out ones, or the device
supporting BIDI commands won't work.
Fixed: 26418649eead ("target/user: Introduce data\_bitmap, replace
data\_length/data\_head/data\_tail")
Reported-by: Ilias Tsitsimpis
Tested-by: Ilias Tsitsimpis
Signed-off-by: Xiubo Li
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit acbb93eb7447742789a41b41042479ff8bc71598
Author: Xiubo Li
Date: Mon Mar 27 17:07:41 2017 +0800
tcmu: Fix wrongly calculating of the base\_command\_size
commit abe342a5b4b5aa579f6bf40ba73447c699e6b579 upstream.
The t\_data\_nents and t\_bidi\_data\_nents are the numbers of the
segments, but it couldn't be sure the block size equals to size
of the segment.
For the worst case, all the blocks are discontiguous and there
will need the same number of iovecs, that's to say: blocks == iovs.
So here just set the number of iovs to block count needed by tcmu
cmd.
Tested-by: Ilias Tsitsimpis
Reviewed-by: Mike Christie
Signed-off-by: Xiubo Li
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 1486f834e887928bcdf69f54a8262246c92d8b1f
Author: Xiubo Li
Date: Mon Mar 27 17:07:40 2017 +0800
tcmu: Fix possible overwrite of t\_data\_sg's last iov[]
commit ab22d2604c86ceb01bb2725c9860b88a7dd383bb upstream.
If there has BIDI data, its first iov[] will overwrite the last
iov[] for se\_cmd->t\_data\_sg.
To fix this, we can just increase the iov pointer, but this may
introuduce a new memory leakage bug: If the se\_cmd->data\_length
and se\_cmd->t\_bidi\_data\_sg->length are all not aligned up to the
DATA\_BLOCK\_SIZE, the actual length needed maybe larger than just
sum of them.
So, this could be avoided by rounding all the data lengthes up
to DATA\_BLOCK\_SIZE.
Reviewed-by: Mike Christie
Tested-by: Ilias Tsitsimpis
Reviewed-by: Bryant G. Ly
Signed-off-by: Xiubo Li
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit e8339b9ddfe66d267051a64327b244eec3dceed9
Author: Paul Moore
Date: Mon Apr 10 11:16:59 2017 -0400
audit: make sure we don't let the retry queue grow without bounds
commit 264d509637d95f9404e52ced5003ad352e0f6a26 upstream.
The retry queue is intended to provide a temporary buffer in the case
of transient errors when communicating with auditd, it is not meant
as a long life queue, that functionality is provided by the hold
queue.
This patch fixes a problem identified by Seth where the retry queue
could grow uncontrollably if an auditd instance did not connect to
the kernel to drain the queues. This commit fixes this by doing the
following:
\* Make sure we always call auditd\_reset() if we decide the connection
with audit is really dead. There were some cases in
kauditd\_hold\_skb() where we did not reset the connection, this patch
relocates the reset calls to kauditd\_thread() so all the error
conditions are caught and the connection reset. As a side effect,
this means we could move auditd\_reset() and get rid of the forward
definition at the top of kernel/audit.c.
\* We never checked the status of the auditd connection when
processing the main audit queue which meant that the retry queue
could grow unchecked. This patch adds a call to auditd\_reset()
after the main queue has been processed if auditd is not connected,
the auditd\_reset() call will make sure the retry and hold queues are
correctly managed/flushed so that the retry queue remains reasonable.
Reported-by: Seth Forshee
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 668e2d8924998104f83560073643379bc4b7eccf
Author: Tejun Heo
Date: Thu Mar 16 16:54:24 2017 -0400
cgroup, kthread: close race window where new kthreads can be migrated to non-root cgroups
commit 77f88796cee819b9c4562b0b6b44691b3b7755b1 upstream.
Creation of a kthread goes through a couple interlocked stages between
the kthread itself and its creator. Once the new kthread starts
running, it initializes itself and wakes up the creator. The creator
then can further configure the kthread and then let it start doing its
job by waking it up.
In this configuration-by-creator stage, the creator is the only one
that can wake it up but the kthread is visible to userland. When
altering the kthread's attributes from userland is allowed, this is
fine; however, for cases where CPU affinity is critical,
kthread\_bind() is used to first disable affinity changes from userland
and then set the affinity. This also prevents the kthread from being
migrated into non-root cgroups as that can affect the CPU affinity and
many other things.
Unfortunately, the cgroup side of protection is racy. While the
PF\_NO\_SETAFFINITY flag prevents further migrations, userland can win
the race before the creator sets the flag with kthread\_bind() and put
the kthread in a non-root cgroup, which can lead to all sorts of
problems including incorrect CPU affinity and starvation.
This bug got triggered by userland which periodically tries to migrate
all processes in the root cpuset cgroup to a non-root one. Per-cpu
workqueue workers got caught while being created and ended up with
incorrected CPU affinity breaking concurrency management and sometimes
stalling workqueue execution.
This patch adds task->no\_cgroup\_migration which disallows the task to
be migrated by userland. kthreadd starts with the flag set making
every child kthread start in the root cgroup with migration
disallowed. The flag is cleared after the kthread finishes
initialization by which time PF\_NO\_SETAFFINITY is set if the kthread
should stay in the root cgroup.
It'd be better to wait for the initialization instead of failing but I
couldn't think of a way of implementing that without adding either a
new PF flag, or sleeping and retrying from waiting side. Even if
userland depends on changing cgroup membership of a kthread, it either
has to be synchronized with kthread\_create() or periodically repeat,
so it's unlikely that this would break anything.
v2: Switch to a simpler implementation using a new task\_struct bit
field suggested by Oleg.
Signed-off-by: Tejun Heo
Suggested-by: Oleg Nesterov
Cc: Linus Torvalds
Cc: Andrew Morton
Cc: Peter Zijlstra (Intel)
Cc: Thomas Gleixner
Reported-and-debugged-by: Chris Mason
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_af8ed4bf_20250125_025415.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2017-02-01 00:02:27 -0800 |
| --- | --- | --- |
| committer | Michael S. Tsirkin <mst@redhat.com> | 2017-03-02 01:35:06 +0200 |
| commit | [c4baad50297d84bde1a7ad45e50c73adae4a2192](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)) | |
| tree | [2efdf37fc4b48748d19ed2e3cb8a75908581fd26](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192) | |
| parent | [f889491380582b4ba2981cf0b0d7d6a40fb30ab7](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f889491380582b4ba2981cf0b0d7d6a40fb30ab7) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192&id2=f889491380582b4ba2981cf0b0d7d6a40fb30ab7)) | |
| download | [linux-c4baad50297d84bde1a7ad45e50c73adae4a2192.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-c4baad50297d84bde1a7ad45e50c73adae4a2192.tar.gz) | |

virtio-console: avoid DMA from stackput\_chars() stuffs the buffer it gets into an sg, but that buffer may be
on the stack. This breaks with CONFIG\_VMAP\_STACK=y (for me, it
manifested as printks getting turned into NUL bytes).
Signed-off-by: Omar Sandoval <osandov@fb.com>
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Reviewed-by: Amit Shah <amit.shah@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)

| -rw-r--r-- | [drivers/char/virtio\_console.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/char/virtio_console.c?id=c4baad50297d84bde1a7ad45e50c73adae4a2192) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 2 deletions

| diff --git a/drivers/char/virtio\_console.c b/drivers/char/virtio\_console.cindex 6266c0568e1d0a..e9b7e0b3cabe60 100644--- a/[drivers/char/virtio\_console.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/virtio_console.c?id=f889491380582b4ba2981cf0b0d7d6a40fb30ab7)+++ b/[drivers/char/virtio\_console.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/virtio_console.c?id=c4baad50297d84bde1a7ad45e50c73adae4a2192)@@ -1136,6 +1136,8 @@ static int put\_chars(u32 vtermno, const char \*buf, int count) { struct port \*port; struct scatterlist sg[1];+ void \*data;+ int ret;  if (unlikely(early\_put\_chars)) return early\_put\_chars(vtermno, buf, count);@@ -1144,8 +1146,14 @@ static int put\_chars(u32 vtermno, const char \*buf, int count) if (!port) return -EPIPE; - sg\_init\_one(sg, buf, count);- return \_\_send\_to\_port(port, sg, 1, count, (void \*)buf, false);+ data = kmemdup(buf, count, GFP\_ATOMIC);+ if (!data)+ return -ENOMEM;++ sg\_init\_one(sg, data, count);+ ret = \_\_send\_to\_port(port, sg, 1, count, data, false);+ kfree(data);+ return ret; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 02:52:53 +0000



=== Content from github.com_56371e55_20250125_025416.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fc4baad50297d84bde1a7ad45e50c73adae4a2192)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fc4baad50297d84bde1a7ad45e50c73adae4a2192)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/c4baad50297d84bde1a7ad45e50c73adae4a2192)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

virtio-console: avoid DMA from stack

[Browse files](/torvalds/linux/tree/c4baad50297d84bde1a7ad45e50c73adae4a2192)
Browse the repository at this point in the history

```
put_chars() stuffs the buffer it gets into an sg, but that buffer may be
on the stack. This breaks with CONFIG_VMAP_STACK=y (for me, it
manifested as printks getting turned into NUL bytes).

Signed-off-by: Omar Sandoval <osandov@fb.com>
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Reviewed-by: Amit Shah <amit.shah@redhat.com>
```

* Loading branch information

[![@osandov](https://avatars.githubusercontent.com/u/3682206?s=40&v=4)](/osandov) [![@mstsirkin](https://avatars.githubusercontent.com/u/1062804?s=40&v=4)](/mstsirkin)

[osandov](/torvalds/linux/commits?author=osandov "View all commits by osandov")
authored and
[mstsirkin](/torvalds/linux/commits?author=mstsirkin "View all commits by mstsirkin")
committed
Mar 1, 2017

1 parent
[f889491](/torvalds/linux/commit/f889491380582b4ba2981cf0b0d7d6a40fb30ab7)

commit c4baad5

Showing
**1 changed file**
with
**10 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

12 changes: 10 additions & 2 deletions

12
[drivers/char/virtio\_console.c](#diff-b657496a4cd41e865b419591f6ba1c82ecb5f9f738522f2fb0738f4a3ed67561 "drivers/char/virtio_console.c")

Show comments

[View file](/torvalds/linux/blob/c4baad50297d84bde1a7ad45e50c73adae4a2192/drivers/char/virtio_console.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1136,6 +1136,8 @@ static int put\_chars(u32 vtermno, const char \*buf, int count) |
|  |  | { |
|  |  | struct port \*port; |
|  |  | struct scatterlist sg[1]; |
|  |  | void \*data; |
|  |  | int ret; |
|  |  |  |
|  |  | if (unlikely(early\_put\_chars)) |
|  |  | return early\_put\_chars(vtermno, buf, count); |
| Expand All | | @@ -1144,8 +1146,14 @@ static int put\_chars(u32 vtermno, const char \*buf, int count) |
|  |  | if (!port) |
|  |  | return -EPIPE; |
|  |  |  |
|  |  | sg\_init\_one(sg, buf, count); |
|  |  | return \_\_send\_to\_port(port, sg, 1, count, (void \*)buf, false); |
|  |  | data = kmemdup(buf, count, GFP\_ATOMIC); |
|  |  | if (!data) |
|  |  | return -ENOMEM; |
|  |  |  |
|  |  | sg\_init\_one(sg, data, count); |
|  |  | ret = \_\_send\_to\_port(port, sg, 1, count, data, false); |
|  |  | kfree(data); |
|  |  | return ret; |
|  |  | } |
|  |  |  |
|  |  | /\* |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c4baad5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fc4baad50297d84bde1a7ad45e50c73adae4a2192) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


