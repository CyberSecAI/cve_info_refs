=== Content from github.com_3aae67cc_20250125_224528.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F41624)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F41624)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  696](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  8](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# MutexGuard<T> may be Sync only if T is Sync #41624

 Merged

[bors](/bors)
merged 2 commits into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[RalfJung:mutexguard-sync](/RalfJung/rust/tree/mutexguard-sync "RalfJung/rust:mutexguard-sync")

May 3, 2017

 Merged

# [MutexGuard<T> may be Sync only if T is Sync](#top) #41624

[bors](/bors)
merged 2 commits into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[RalfJung:mutexguard-sync](/RalfJung/rust/tree/mutexguard-sync "RalfJung/rust:mutexguard-sync")

May 3, 2017

[Conversation
30](/rust-lang/rust/pull/41624)
[Commits
2](/rust-lang/rust/pull/41624/commits)
[Checks
0](/rust-lang/rust/pull/41624/checks)
[Files changed](/rust-lang/rust/pull/41624/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![RalfJung](https://avatars.githubusercontent.com/u/330628?s=60&v=4)](/RalfJung)

Copy link

Member

### @RalfJung **[RalfJung](/RalfJung)** commented [Apr 29, 2017](#issue-225241273)

Fixes [#41622](https://github.com/rust-lang/rust/issues/41622)

This is a breaking change. Does that imply any further process?

I am not sure whether I wrote that "compilation must fail"-test correctly, but at least it is passing here with the patch applied. Same for the `since = "1.18.0"`, I just picked it because I had to pick something.

Sorry, something went wrong.

 üéâ
7
 StefanoD, matthieu-m, messense, tikue, tioover, Kobzol, and luisgerhorst reacted with hooray emoji

All reactions

* üéâ
  7 reactions

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&v=4)](/RalfJung)

`[MutexGuard<T> may be Sync only if T is Sync](/rust-lang/rust/pull/41624/commits/998a8777379d8f1cd7b263eff50411ba56f1f9e7 "MutexGuard<T> may be Sync only if T is Sync

Also remove some unnecessary unsafe impl from the tests.")`
 ‚Ä¶

`[998a877](/rust-lang/rust/pull/41624/commits/998a8777379d8f1cd7b263eff50411ba56f1f9e7)`

```
Also remove some unnecessary unsafe impl from the tests.
```

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=40&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)
[rust-highfive](/rust-highfive)
assigned [alexcrichton](/alexcrichton)
[Apr 29, 2017](#event-1063069865)

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=80&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)

Copy link

Collaborator

### **[rust-highfive](/rust-highfive)** commented [Apr 29, 2017](#issuecomment-298153950)

| Thanks for the pull request, and welcome! The Rust team is excited to review your changes, and you should hear from [@alexcrichton](https://github.com/alexcrichton) (or someone else) soon.  If any changes to this PR are deemed necessary, please add them as extra commits. This ensures that the reviewer can see what has changed since they last reviewed the code. Due to the way GitHub handles out-of-date commits, this should also make it reasonably obvious what issues have or haven't been addressed. Large or tricky changes may require several passes of review and changes.  Please see [the contribution instructions](https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md) for more information. |
| --- |

All reactions

Sorry, something went wrong.

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss)
[bluss](/bluss)
added
[relnotes](/rust-lang/rust/labels/relnotes)
Marks issues that should be documented in the release notes of the next release.
[T-libs-api](/rust-lang/rust/labels/T-libs-api)
Relevant to the library API team, which will review and decide on the PR/issue.
labels
[Apr 29, 2017](#event-1063077715)

[![bluss](https://avatars.githubusercontent.com/u/3209739?s=60&v=4)](/bluss)

**[bluss](/bluss)**
reviewed
[Apr 29, 2017](#pullrequestreview-35492334)

 [View reviewed changes](/rust-lang/rust/pull/41624/files/998a8777379d8f1cd7b263eff50411ba56f1f9e7)

[src/libstd/sync/mutex.rs](/rust-lang/rust/pull/41624/files/998a8777379d8f1cd7b263eff50411ba56f1f9e7#diff-c2676acfac3cadf5882730cb9335263be75fc8b2e8d701777757e49f6b360d75)
Outdated

|  |  | impl<'a, T: ?Sized> !marker::Send for MutexGuard<'a, T> {} |
| --- | --- | --- |
|  |  | impl<'a, T: ?Sized> !Send for MutexGuard<'a, T> { } |
|  |  | #[stable(feature = "rust1", since = "1.18.0")] |
|  |  | unsafe impl<'a, T: ?Sized + Sync> Sync for MutexGuard<'a, T> { } |

Copy link

Member

### @bluss **[bluss](/bluss)** [Apr 29, 2017](#discussion_r114049163) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

~~A brief test says that this is not enough to make `T: !Sync ‚Üí MutexGuard<T>: !Sync`

Is a non-sync marker field the best way? Then opt in to Sync for this case.~~

Edit: Ok, sorry, that was of course a too simple test. Seems to work

Sorry, something went wrong.

All reactions

Copy link

Member

### @eddyb **[eddyb](/eddyb)** [Apr 29, 2017](#discussion_r114049333) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

So this is where I was arguing with [@nikomatsakis](https://github.com/nikomatsakis) that the current semantics for positive OIBIT impls don't make sense in terms of how they apply bounds and when, when compared with other impls.

*That is*, I'd expect to see these two impls:

```
impl<'a, T: ?Sized> !Sync for MutexGuard<'a, T> { }
unsafe impl<'a, T: ?Sized + Sync> Sync for MutexGuard<'a, T> { }
```

Carving out a `Sync` subset out of a more general `!Sync` case.

Indeed that is what a `!Sync` marker field would do.

**EDIT**: Okay, so it's not broken but it still bugs me how it's set up.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @RalfJung **[RalfJung](/RalfJung)** [Apr 29, 2017](#discussion_r114050486)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@bluss](https://github.com/bluss): My compile-fail test seems to indicate this works, but I have to admit I don't know enough about OIBITs to say how this is supposed to be done.

[@eddyb](https://github.com/eddyb): I was not sure if that would work; are overlapping impls handed correctly? If they do, sure, I'm happy to change this. I will then also add a test checking that `MutexGuard<i32>` is `Sync`.

Sorry, something went wrong.

All reactions

Copy link

Member

### @bluss **[bluss](/bluss)** [Apr 29, 2017](#discussion_r114050500)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It fooled me, for one. The positive impls are stable though (and the negative ones are not).

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @RalfJung **[RalfJung](/RalfJung)** [Apr 29, 2017](#discussion_r114050535)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@eddyb](https://github.com/eddyb) This doesn't seem to work...

```
error[E0119]: conflicting implementations of trait `core::marker::Sync` for type `sync::mutex::MutexGuard<'_, _>`:
   --> src/libstd/sync/mutex.rs:159:1
    |
157 | impl<'a, T: ?Sized> !Sync for MutexGuard<'a, T> { }
    | --------------------------------------------------- first implementation here
158 | #[stable(feature = "rust1", since = "1.18.0")]
159 | unsafe impl<'a, T: ?Sized + Sync> Sync for MutexGuard<'a, T> { }
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ conflicting implementation for `sync::mutex::MutexGuard<'_, _>`

```

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @RalfJung **[RalfJung](/RalfJung)** [Apr 29, 2017](#discussion_r114050666)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Do you mean "stable" as in "a stable Rust feature" or "stable" as in "preserved by more impls being added elsewhere"?

Sorry, something went wrong.

All reactions

Copy link

Member

### @eddyb **[eddyb](/eddyb)** [Apr 29, 2017](#discussion_r114050880)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

No, it doesn't, but I would expect it to be *the only way* to achieve this result, and this is me trying to remember [@nikomatsakis](https://github.com/nikomatsakis) about a previous discussion on the matter.

Sorry, something went wrong.

All reactions

Copy link

Member

### @bluss **[bluss](/bluss)** [Apr 29, 2017](#discussion_r114051663)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The former, [@RalfJung](https://github.com/RalfJung)

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @withoutboats **[withoutboats](/withoutboats)** [Apr 29, 2017](#discussion_r114060297) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@eddyb](https://github.com/eddyb) I argued the same thing with [@nikomatsakis](https://github.com/nikomatsakis) at RustConf, but he demonstrated an example in which that would result in adding a non-blanket impl of a non-OIBIT being a breaking change, something we've worked very hard to avoid.

In any event we do need an RFC to revise and clarify these rules because they're currently mostly unstated.

Sorry, something went wrong.

All reactions

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Apr 29, 2017](#issuecomment-298160039)

| Travis complains about the `since` value changing. I thought I'd have to change it because this is really a completely different `impl` than the old one. Should I change the `since` to say `1.0.0`? |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=80&v=4)](/alexcrichton)

Copy link

Member

### **[alexcrichton](/alexcrichton)** commented [Apr 29, 2017](#issuecomment-298181660)

| Thanks for catching this [@RalfJung](https://github.com/RalfJung)! I'm personally ahead going ahead and landing this regardless of the breakage. It's (a) a soundness fix and (b) seems unlikely to be relied upon in practice. We've got a lot of runway before this reaches stable to detect regressions and help upstream authors fix the issue. In any case cc @rust-lang/libs for the breakage aspect.  For the tidy error here yeah you can just pick a new feature name that's not "rust1", and it can be something arbitrary. |
| --- |

 üëç
4
 sfackler, bluss, matthieu-m, and leonardo-m reacted with thumbs up emoji

All reactions

* üëç
  4 reactions

Sorry, something went wrong.

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&v=4)](/RalfJung)

`[need to pick a new feature name](/rust-lang/rust/pull/41624/commits/23522f6cabf9fc5803411c3dec4a90c56cc3dab2 "need to pick a new feature name")`

`[23522f6](/rust-lang/rust/pull/41624/commits/23522f6cabf9fc5803411c3dec4a90c56cc3dab2)`

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Apr 29, 2017](#issuecomment-298181893)

| All right, I picked a new feature name (`mutexguard`) and pushed that as a new commit here. |
| --- |

All reactions

Sorry, something went wrong.

[![@carols10cents](https://avatars.githubusercontent.com/u/193874?s=40&v=4)](/carols10cents)
[carols10cents](/carols10cents)
added
the
[S-waiting-on-review](/rust-lang/rust/labels/S-waiting-on-review)
Status: Awaiting review from the assignee but also interested parties.
label
[May 1, 2017](#event-1063912255)

[![@arielb1](https://avatars.githubusercontent.com/u/1830974?s=80&v=4)](/arielb1)

Copy link

Contributor

### **[arielb1](/arielb1)** commented [May 2, 2017](#issuecomment-298580058)

| [@alexcrichton](https://github.com/alexcrichton) - I think this is ready for merge. Friendly ping to keep this on your radar. |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=80&v=4)](/alexcrichton)

Copy link

Member

### **[alexcrichton](/alexcrichton)** commented [May 2, 2017](#issuecomment-298651128)

| Ok it's been a few days so I'm going to r+, but we may still back out and determine a new strategy to land if we discover this causes a number of regressions on crater. Regardless we'll get this in somehow!  [@bors](https://github.com/bors): r+ |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 2, 2017](#issuecomment-298651139)

| üìå Commit [23522f6](https://github.com/rust-lang/rust/commit/23522f6cabf9fc5803411c3dec4a90c56cc3dab2) has been approved by `alexcrichton` |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
added
[S-waiting-on-bors](/rust-lang/rust/labels/S-waiting-on-bors)
Status: Waiting on bors to run and complete tests. Bors will change the label on completion.
and removed
[S-waiting-on-review](/rust-lang/rust/labels/S-waiting-on-review)
Status: Awaiting review from the assignee but also interested parties.
labels
[May 2, 2017](#event-1065650220)

[![@nikomatsakis](https://avatars.githubusercontent.com/u/155238?s=80&u=c09aaff33aa53ea99359e53bef06aa5058ac8d15&v=4)](/nikomatsakis)

Copy link

Contributor

### **[nikomatsakis](/nikomatsakis)** commented [May 2, 2017](#issuecomment-298748373)

| Ordinarily, we would do a crater run first. But I agree this seems like quite the corner case. |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 3, 2017](#issuecomment-298796487)

| ‚åõ Testing commit [23522f6](https://github.com/rust-lang/rust/commit/23522f6cabf9fc5803411c3dec4a90c56cc3dab2) with merge [0634f0a](https://github.com/rust-lang/rust/commit/0634f0a30f94116ee13c16fb1a35c4c92253ab13)... |
| --- |

All reactions

Sorry, something went wrong.

[bors](/bors)
added a commit
that referenced
this pull request
[May 3, 2017](#ref-commit-0634f0a)
[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)

`[Auto merge of](/rust-lang/rust/commit/0634f0a30f94116ee13c16fb1a35c4c92253ab13 "Auto merge of #41624 - RalfJung:mutexguard-sync, r=alexcrichton

MutexGuard<T> may be Sync only if T is Sync

Fixes #41622

This is a breaking change. Does that imply any further process?

I am not sure whether I wrote that \"compilation must fail\"-test correctly, but at least it is passing here with the patch applied. Same for the `since = \"1.18.0\"`, I just picked it because I had to pick something.") [#41624](https://github.com/rust-lang/rust/pull/41624) [- RalfJung:mutexguard-sync, r=alexcrichton](/rust-lang/rust/commit/0634f0a30f94116ee13c16fb1a35c4c92253ab13 "Auto merge of #41624 - RalfJung:mutexguard-sync, r=alexcrichton

MutexGuard<T> may be Sync only if T is Sync

Fixes #41622

This is a breaking change. Does that imply any further process?

I am not sure whether I wrote that \"compilation must fail\"-test correctly, but at least it is passing here with the patch applied. Same for the `since = \"1.18.0\"`, I just picked it because I had to pick something.")`
‚Ä¶

`[0634f0a](/rust-lang/rust/commit/0634f0a30f94116ee13c16fb1a35c4c92253ab13)`

```
MutexGuard<T> may be Sync only if T is Sync

Fixes [#41622](https://github.com/rust-lang/rust/issues/41622)

This is a breaking change. Does that imply any further process?

I am not sure whether I wrote that "compilation must fail"-test correctly, but at least it is passing here with the patch applied. Same for the `since = "1.18.0"`, I just picked it because I had to pick something.
```

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 3, 2017](#issuecomment-298815356)

| ‚òÄÔ∏è Test successful - [status-appveyor](https://ci.appveyor.com/project/rust-lang/rust/build/1.0.3136), [status-travis](https://travis-ci.org/rust-lang/rust/builds/228164552?utm_source=github_status&utm_medium=notification) Approved by: alexcrichton Pushing [0634f0a](https://github.com/rust-lang/rust/commit/0634f0a30f94116ee13c16fb1a35c4c92253ab13) to master... |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)
[bors](/bors)
merged commit [`23522f6`](/rust-lang/rust/commit/23522f6cabf9fc5803411c3dec4a90c56cc3dab2)
into
rust-lang:master

[May 3, 2017](https://github.com/rust-lang/rust/pull/41624#event-1066615130)

[![@pmarcelll](https://avatars.githubusercontent.com/u/1909968?s=80&v=4)](/pmarcelll)

Copy link

Contributor

### **[pmarcelll](/pmarcelll)** commented [May 3, 2017](#issuecomment-298860923)

| I think `since = "1.18.0"` should be `since = "1.19.0"` (1.18 is already in beta). |
| --- |

All reactions

Sorry, something went wrong.

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Jun 9, 2017](#issuecomment-307269801)

| That's right, this will only land with 1.19. Is that a problem? |
| --- |

All reactions

Sorry, something went wrong.

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

### **[bluss](/bluss)** commented [Jun 9, 2017](#issuecomment-307449929) ‚Ä¢ edited Loading

| it's fixed in master, so [nightly docs](https://doc.rust-lang.org/nightly/std/sync/struct.MutexGuard.html) show the correct Rust 1.19 |
| --- |

All reactions

Sorry, something went wrong.

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Jun 9, 2017](#issuecomment-307451174)

| Ah, cool. Actually, it's fixed even in the beta: <https://doc.rust-lang.org/beta/std/sync/struct.MutexGuard.html> |
| --- |

All reactions

Sorry, something went wrong.

[![@strega-nil](https://avatars.githubusercontent.com/u/3479021?s=80&u=7bd8c3667c5009bf9c7ae16d4a2799b131c92ad3&v=4)](/strega-nil)

Copy link

Contributor

### **[strega-nil](/strega-nil)** commented [Jun 10, 2017](#issuecomment-307550768) ‚Ä¢ edited Loading

| hmm. I disagree with this fix. `MutexGuard` should just own a `PhantomData<&mut T>`... that would fix all the problems with it, and would be more correct with other auto traits. I wish I had seen this sooner. |
| --- |

 üëç
2
 Boscop and krdln reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@eddyb](https://avatars.githubusercontent.com/u/77424?s=80&u=799954c3a5044d91fac203dd1860038e86b6533c&v=4)](/eddyb)

Copy link

Member

### **[eddyb](/eddyb)** commented [Jun 10, 2017](#issuecomment-307551262)

| So `&Mutex<T>` is not enough because `T: Send + !Sync` is allowed in a `Mutex`, AFAICT.  But, theoretically, someone could write an unsafe abstraction that *isn't* thread-safe in a `Mutex`, and they might remove `Sync` but keep `Send` because passing it around as an owned value works fine.  The thought of that is rather unsettling, and one more thing to keep in mind about unsafe code. But I am hopeful [@RalfJung](https://github.com/RalfJung)'s and others' work on unsafe correctness will keep us safe in the future. |
| --- |

All reactions

Sorry, something went wrong.

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Jun 10, 2017](#issuecomment-307584252)

| hmm. I disagree with this fix. MutexGuard should just own a PhantomData<&mut T>... that would fix all the problems with it, and would be more correct with other auto traits. I wish I had seen this sooner.  If you mean the fix is to add that field and leave the existing fields unchanged, I disagree. That would restrict `MutexGuard<T>` to be `Sync` only when `T` is *both* `Send` and `Sync`, which is unnecessarily restrictive. That said, a `Mutex` with a non-`Send` `T` seems like a rather pointless exercise, so maybe this doesn't matter.  So &Mutex is not enough because T: Send + !Sync is allowed in a Mutex, AFAICT.  That's right. `Mutex<T>` is `Send + Sync` when `T` is `Send`. No `Sync`-bound on `T` needed. |
| --- |

All reactions

Sorry, something went wrong.

[![@strega-nil](https://avatars.githubusercontent.com/u/3479021?s=80&u=7bd8c3667c5009bf9c7ae16d4a2799b131c92ad3&v=4)](/strega-nil)

Copy link

Contributor

### **[strega-nil](/strega-nil)** commented [Jun 11, 2017](#issuecomment-307612621)

| [@RalfJung](https://github.com/RalfJung) that is a bit weird. It does feel as if `MutexGuard<'a, T>` should be treated exactly like an `&mut T` wrt auto trait impls... :/ |
| --- |

 üëç
1
 Boscop reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=80&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)

Copy link

Member

Author

### **[RalfJung](/RalfJung)** commented [Jun 11, 2017](#issuecomment-307613732)

| Yes, and I agree with that. However, `MutexGuard<T>` also has an `&Mutex<T>` field, which the auto traits also take into account, and which further restricts them. |
| --- |

All reactions

Sorry, something went wrong.

[![@strega-nil](https://avatars.githubusercontent.com/u/3479021?s=80&u=7bd8c3667c5009bf9c7ae16d4a2799b131c92ad3&v=4)](/strega-nil)

Copy link

Contributor

### **[strega-nil](/strega-nil)** commented [Jun 11, 2017](#issuecomment-307649771) ‚Ä¢ edited Loading

| [@RalfJung](https://github.com/RalfJung) right, that's what I'm thinking - this seems like a design flaw with auto traits :/ you can't have a field which isn't taken into account by auto traits. |
| --- |

All reactions

Sorry, something went wrong.

 [![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)
[RalfJung](/RalfJung)
deleted the
mutexguard-sync

branch
[July 15, 2017 18:02](#event-1165357636)

[![@rkjnsn](https://avatars.githubusercontent.com/u/7364197?s=80&v=4)](/rkjnsn)

Copy link

Contributor

### **[rkjnsn](/rkjnsn)** commented [Jul 21, 2017](#issuecomment-316897746)

| Would it make sense for `MutexGuard<T>` to have both `PhantomData<&mut T>` *and* the explicit implementation of `Sync`? The explicit `Sync` implementation would mean it's not overly restrictive, while the `PhantomData` would hopefully make sure that `MutexGuard` doesn't end up improperly implementing any future unsafe auto traits that may be created? |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F41624)

Reviewers

[![@withoutboats](https://avatars.githubusercontent.com/u/9063376?s=40&v=4)](/withoutboats) [withoutboats](/withoutboats)

withoutboats left review comments

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss) [bluss](/bluss)

bluss left review comments

[![@eddyb](https://avatars.githubusercontent.com/u/77424?s=40&v=4)](/eddyb) [eddyb](/eddyb)

eddyb left review comments

Assignees

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton) [alexcrichton](/alexcrichton)

Labels

[relnotes](/rust-lang/rust/labels/relnotes)
Marks issues that should be documented in the release notes of the next release.
[S-waiting-on-bors](/rust-lang/rust/labels/S-waiting-on-bors)
Status: Waiting on bors to run and complete tests. Bors will change the label on completion.
[T-libs-api](/rust-lang/rust/labels/T-libs-api)
Relevant to the library API team, which will review and decide on the PR/issue.

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

13 participants

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=52&v=4)](/RalfJung) [![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=52&v=4)](/rust-highfive) [![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=52&v=4)](/alexcrichton) [![@arielb1](https://avatars.githubusercontent.com/u/1830974?s=52&v=4)](/arielb1) [![@bors](https://avatars.githubusercontent.com/u/3372342?s=52&v=4)](/bors) [![@nikomatsakis](https://avatars.githubusercontent.com/u/155238?s=52&v=4)](/nikomatsakis) [![@pmarcelll](https://avatars.githubusercontent.com/u/1909968?s=52&v=4)](/pmarcelll) [![@bluss](https://avatars.githubusercontent.com/u/3209739?s=52&v=4)](/bluss) [![@strega-nil](https://avatars.githubusercontent.com/u/3479021?s=52&v=4)](/strega-nil) [![@eddyb](https://avatars.githubusercontent.com/u/77424?s=52&v=4)](/eddyb) [![@rkjnsn](https://avatars.githubusercontent.com/u/7364197?s=52&v=4)](/rkjnsn) [![@withoutboats](https://avatars.githubusercontent.com/u/9063376?s=52&v=4)](/withoutboats) [![@carols10cents](https://avatars.githubusercontent.com/u/193874?s=52&v=4)](/carols10cents)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_326481f6_20250125_224526.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F41622)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F41622)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  696](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  9](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

# MutexGuard<Cell<i32>> must not be Sync¬†#41622

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[MutexGuard<Cell<i32>> must not be Sync](#top)#41622Copy linkLabels[I-unsoundIssue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22I-unsound%22)Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness[![@RalfJung](https://avatars.githubusercontent.com/u/330628?u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4&size=80)](/RalfJung)
## Description

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4&size=48)](/RalfJung)[RalfJung](https://github.com/RalfJung)opened [on Apr 29, 2017](https://github.com/rust-lang/rust/issues/41622#issue-225239298)

Right now, `MutexGuard<Cell<i32>>` satisfies the `Sync` bound. That is rather bad, because it lets me write a program that has a data race:

```
use std::sync::Mutex;
use std::cell::Cell;

extern crate rayon;

fn main()
{
    let m = Mutex::new(Cell::new(0));
    let g = m.lock().unwrap();
    {
        rayon::join(
            || { g.set(g.get() + 1); println!("Thread 1: {:?}", g.get()) },
            || { g.set(g.get() + 1); println!("Thread 2: {:?}", g.get()) });
    }
}
```

The `get` and `set` calls in the two threads are unsynchronized (as usual for a `Cell`), and they are racing. This is a soundness bug.

The cause for this is that `MutexGuard<T>` implements `Sync` whenever `T` implements `Send`, which is plain wrong. The fix is to let `MutexGuard<T>` implement `Sync` whenever `T` implements `Sync`. I will submit a PR soon.

üëç27
## Metadata

### Assignees

No one assigned

### Labels

[I-unsoundIssue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22I-unsound%22)Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


