=== Content from sourceware.org_d3f3324d_20250125_194713.html ===


Sourceware Bugzilla – Bug 21786
Stack-buffer-overflow in {coff,coff64}-rs6000.c
Last modified: 2019-01-04 02:05:42 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=21786&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=21786&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 21786**](show_bug.cgi?id=21786)
- Stack-buffer-overflow in {coff,coff64}-rs6000.c

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
Stack-buffer-overflow in {coff,coff64}-rs6000.c

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | binutils | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=binutils "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | binutils ([show other bugs](buglist.cgi?component=binutils&product=binutils&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.30 | |  | | | [Importance](page.cgi?id=fields.html#importance): | P2 normal | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Not yet assigned to anyone | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2017-07-19 01:00 UTC by Ned Williamson | | --- | --- | | Modified: | 2019-01-04 02:05 UTC ([History](show_activity.cgi?id=21786)) | | CC List: | 1 user (show)  nickc | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Host:](page.cgi?id=fields.html#cf_gcchost "A custom Free Text field in this installation of Bugzilla.") |  | | [Target:](page.cgi?id=fields.html#cf_gcctarget "A custom Free Text field in this installation of Bugzilla.") |  | | [Build:](page.cgi?id=fields.html#cf_gccbuild "A custom Free Text field in this installation of Bugzilla.") |  | | [Last reconfirmed:](page.cgi?id=fields.html#cf_reconfirmed_on "A custom Date/Time field in this installation of Bugzilla.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**testcase**](attachment.cgi?id=10269 "View the content of the attachment") (85 bytes, application/octet-stream)  [2017-07-19 01:00 UTC](#attach_10269 "Go to the comment associated with the attachment"), Ned Williamson | [Details](attachment.cgi?id=10269&action=edit) | | [**suggested patch**](attachment.cgi?id=10270 "View the content of the attachment") (617 bytes, patch)  [2017-07-19 01:01 UTC](#attach_10270 "Go to the comment associated with the attachment"), Ned Williamson | [Details](attachment.cgi?id=10270&action=edit) | [Diff](attachment.cgi?id=10270&action=diff) | | [**crash state**](attachment.cgi?id=10271 "View the content of the attachment") (1.09 KB, text/plain)  [2017-07-19 01:02 UTC](#attach_10271 "Go to the comment associated with the attachment"), Ned Williamson | [Details](attachment.cgi?id=10271&action=edit) | | [View All](attachment.cgi?bugid=21786&action=viewall)  [Add an attachment](attachment.cgi?bugid=21786&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=21786&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=21786#c0)  Ned Williamson    2017-07-19 01:00:46 UTC  ``` Created [attachment 10269](attachment.cgi?id=10269 "testcase") [[details]](attachment.cgi?id=10269&action=edit "testcase") testcase  `_bfd_xcoff_read_ar_hdr` and similar functions can call strtol on a string that is not null-terminated, leading to an out of bounds read on the stack. See the attached testcase. ```  [Comment 1](show_bug.cgi?id=21786#c1)  Ned Williamson    2017-07-19 01:01:42 UTC  ``` Created [attachment 10270](attachment.cgi?id=10270&action=diff "suggested patch") [[details]](attachment.cgi?id=10270&action=edit "suggested patch") suggested patch  Here, I attach my suggested patch, fixing all places where I was able to trigger the bug using a variant of the original testcase. ```  [Comment 2](show_bug.cgi?id=21786#c2)  Ned Williamson    2017-07-19 01:02:50 UTC  ``` Created [attachment 10271](attachment.cgi?id=10271 "crash state") [[details]](attachment.cgi?id=10271&action=edit "crash state") crash state  Here is the crashing state when inspecting the crash using ASAN. ```  [Comment 3](show_bug.cgi?id=21786#c3)  Sourceware Commits    2017-07-19 10:08:57 UTC  ``` The master branch has been updated by Nick Clifton <nickc@sourceware.org>:  <https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=29866fa186ee3ebda5242221607dba360b2e541e>  commit 29866fa186ee3ebda5242221607dba360b2e541e Author: Nick Clifton <nickc@redhat.com> Date:   Wed Jul 19 11:07:43 2017 +0100      Fix address violation when attempting to read a corrupt field in a COFF archive header structure.          	[PR 21786](show_bug.cgi?id=21786 "RESOLVED FIXED - Stack-buffer-overflow in {coff,coff64}-rs6000.c")     	* coff-rs6000.c (_bfd_strntol): New function.     	(_bfd_strntoll): New function.     	(GET_VALUE_IN_FIELD): New macro.     	(EQ_VALUE_IN_FIELD): new macro.     	(_bfd_xcoff_slurp_armap): Use new macros.     	(_bfd_xcoff_archive_p): Likewise.     	(_bfd_xcoff_read_ar_hdr): Likewise.     	(_bfd_xcoff_openr_next_archived_file): Likewise.     	(_bfd_xcoff_stat_arch_elt): Likewise. ```  [Comment 4](show_bug.cgi?id=21786#c4)  Nick Clifton    2017-07-19 10:16:13 UTC  ``` Hi Ned,    Thanks for reporting this bug.  Unfortunately the patch you proposed will   not work as the numeric strings in the archive header structure are not   guaranteed to be NUL terminated.  In fact the specification explicitly   states:      16 Archive Member Headers     Each member (linker, longnames, or object-file member) is preceded      by a header.  An archive member header has the following format,      in which each field is an ASCII text string that is left justified     and padded with spaces to the end of the field.  There is no      terminating null character in any of these fields.    This is from "Microsoft Portable Executable and Common Object File    Format Specification Revision 8.3 – February 6, 2013"    So whilst there *might* be a space at the end of the field there definitely   will not be a NUL character.    The alternative is to copy the field into a NUL terminated buffer before   attempting to parse it, and this is what I have done with the patch   recently committed.  As a bonus I also fixed up the places where strtoll   (instead of strtol) should have been used to read 20 character numeric    values.  Cheers   Nick ```  [Comment 5](show_bug.cgi?id=21786#c5)  Ned Williamson    2017-07-19 13:36:56 UTC  ``` Hi Nick, thanks for the great patch! It's much better than the suggested one. Thank you for pointing out the specification.  I did see a crash in coff64-rs6000 as well, so that may need to use the new safe functions. ```  [Comment 6](show_bug.cgi?id=21786#c6)  Sourceware Commits    2017-07-19 15:15:41 UTC  ``` The master branch has been updated by Nick Clifton <nickc@sourceware.org>:  <https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=6c4e7b6bfbc4679f695106de2817ecf02b27c8be>  commit 6c4e7b6bfbc4679f695106de2817ecf02b27c8be Author: Nick Clifton <nickc@redhat.com> Date:   Wed Jul 19 16:14:02 2017 +0100      Extend previous fix to coff-rs6000.c to coff64-rs6000.c          	[PR 21786](show_bug.cgi?id=21786 "RESOLVED FIXED - Stack-buffer-overflow in {coff,coff64}-rs6000.c")     	* coff64-rs6000.c (_bfd_strntol): New function.     	(_bfd_strntoll): New function.     	(GET_VALUE_IN_FIELD): New macro.     	(xcoff64_slurp_armap): Use new macros. ```  [Comment 7](show_bug.cgi?id=21786#c7)  Nick Clifton    2017-07-19 15:16:47 UTC  ``` Hi Ned,  > I did see a crash in coff64-rs6000 as well, so that may need to use the new > safe functions.  Ah - thanks for pointing that out.  I have now checked in an additional patch to cover coff64-rs6000.c.  Cheers   Nick ```  [Comment 8](show_bug.cgi?id=21786#c8)  Sourceware Commits    2017-09-04 15:06:21 UTC  ``` The binutils-2_29-branch branch has been updated by Nick Clifton <nickc@sourceware.org>:  <https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=7e693dd5cede637daf4456a2a8f207be1044c6e8>  commit 7e693dd5cede637daf4456a2a8f207be1044c6e8 Author: Nick Clifton <nickc@redhat.com> Date:   Mon Sep 4 16:04:44 2017 +0100      Import patch from mainline to fix address violations when parsing corrupt COFF binaries          	[PR 21786](show_bug.cgi?id=21786 "RESOLVED FIXED - Stack-buffer-overflow in {coff,coff64}-rs6000.c")     	* coff-rs6000.c (_bfd_strntol): New function.     	(_bfd_strntoll): New function.     	(GET_VALUE_IN_FIELD): New macro.     	(EQ_VALUE_IN_FIELD): new macro.     	(_bfd_xcoff_slurp_armap): Use new macros.     	(_bfd_xcoff_archive_p): Likewise.     	(_bfd_xcoff_read_ar_hdr): Likewise.     	(_bfd_xcoff_openr_next_archived_file): Likewise.     	(_bfd_xcoff_stat_arch_elt): Likewise.     	* coff64-rs6000.c (_bfd_strntol): New function.     	(_bfd_strntoll): New function.     	(GET_VALUE_IN_FIELD): New macro.     	(xcoff64_slurp_armap): Use new macros. ```  [Comment 9](show_bug.cgi?id=21786#c9)  Sourceware Commits    2019-01-04 02:05:42 UTC  ``` The master branch has been updated by Alan Modra <amodra@sourceware.org>:  <https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=677bd4c69d0eda4f2ae635d793f23c0b1413a9e9>  commit 677bd4c69d0eda4f2ae635d793f23c0b1413a9e9 Author: Alan Modra <amodra@gmail.com> Date:   Fri Jan 4 12:18:36 2019 +1030      [PR24061](show_bug.cgi?id=24061 "RESOLVED FIXED - powerpc-ibm-aix-ar sets bogus file permissions when extracting"), powerpc-ibm-aix-ar sets bogus file permissions when extracting          Mode field should be read in octal, all the rest in decimal.  Do so.          	[PR 24061](show_bug.cgi?id=24061 "RESOLVED FIXED - powerpc-ibm-aix-ar sets bogus file permissions when extracting")     	[PR 21786](show_bug.cgi?id=21786 "RESOLVED FIXED - Stack-buffer-overflow in {coff,coff64}-rs6000.c")     	* coff-rs6000.c (GET_VALUE_IN_FIELD): Add base parameter and     	adjust all callers.     	(EQ_VALUE_IN_FIELD): Likewise.     	* coff64-rs6000.c (GET_VALUE_IN_FIELD): Likewise. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=21786)
* - [XML](show_bug.cgi?ctype=xml&id=21786)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=21786)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=21786&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=21786&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


