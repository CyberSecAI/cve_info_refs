=== Content from www.kernel.org_a29cbf5b_20250125_215049.html ===
commit 13df91dbc06ed4323cf8bbc956ec9a0098f1361e
Author: Greg Kroah-Hartman
Date: Thu Jul 27 15:10:39 2017 -0700
Linux 4.12.4
commit baa11d76d15783e132e34957ab9f205373e9b9c5
Author: Wanpeng Li
Date: Sun Jul 9 00:40:28 2017 -0700
sched/cputime: Don't use smp\_processor\_id() in preemptible context
commit 0e4097c3354e2f5a5ad8affd9dc7f7f7d00bb6b9 upstream.
Recent kernels trigger this warning:
BUG: using smp\_processor\_id() in preemptible [00000000] code: 99-trinity/181
caller is debug\_smp\_processor\_id+0x17/0x19
CPU: 0 PID: 181 Comm: 99-trinity Not tainted 4.12.0-01059-g2a42eb9 #1
Call Trace:
dump\_stack+0x82/0xb8
check\_preemption\_disabled()
debug\_smp\_processor\_id()
vtime\_delta()
task\_cputime()
thread\_group\_cputime()
thread\_group\_cputime\_adjusted()
wait\_consider\_task()
do\_wait()
SYSC\_wait4()
do\_syscall\_64()
entry\_SYSCALL64\_slow\_path()
As Frederic pointed out:
| Although those sched\_clock\_cpu() things seem to only matter when the
| sched\_clock() is unstable. And that stability is a condition for nohz\_full
| to work anyway. So probably sched\_clock() alone would be enough.
This patch fixes it by replacing sched\_clock\_cpu() with sched\_clock() to
avoid calling smp\_processor\_id() in a preemptible context.
Reported-by: Xiaolong Ye
Signed-off-by: Wanpeng Li
Cc: Frederic Weisbecker
Cc: Linus Torvalds
Cc: Luiz Capitulino
Cc: Peter Zijlstra
Cc: Rik van Riel
Cc: Thomas Gleixner
Link: http://lkml.kernel.org/r/1499586028-7402-1-git-send-email-wanpeng.li@hotmail.com
[ Prettified the changelog. ]
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit ccb1fe49efed135f58d9cd85600694a75e97d14f
Author: Greg Hackmann
Date: Tue Jul 25 12:42:46 2017 -0700
alarmtimer: don't rate limit one-shot timers
Commit ff86bf0c65f1 ("alarmtimer: Rate limit periodic intervals") sets a
minimum bound on the alarm timer interval. This minimum bound shouldn't
be applied if the interval is 0. Otherwise, one-shot timers will be
converted into periodic ones.
This patch is specific to 4.11.y and 4.12.y. Older -stable trees have a
slightly different patch, and 4.13-rc2 isn't impacted due to a later
refactoring.
Fixes: ff86bf0c65f1 ("alarmtimer: Rate limit periodic intervals")
Reported-by: Ben Fennema
Signed-off-by: Greg Hackmann
Cc: John Stultz
Reviewed-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 2de3bd0323818f5878f6bb6fa3f60ffacbe3aa47
Author: Thomas Gleixner
Date: Tue Jul 11 22:06:24 2017 +0200
smp/hotplug: Replace BUG\_ON and react useful
commit dea1d0f5f1284e3defee4b8484d9fc230686cd42 upstream.
The move of the unpark functions to the control thread moved the BUG\_ON()
there as well. While it made some sense in the idle thread of the upcoming
CPU, it's bogus to crash the control thread on the already online CPU,
especially as the function has a return value and the callsite is prepared
to handle an error return.
Replace it with a WARN\_ON\_ONCE() and return a proper error code.
Fixes: 9cd4f1a4e7a8 ("smp/hotplug: Move unparking of percpu threads to the control CPU")
Rightfully-ranted-at-by: Linux Torvalds
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 8e5772cd2c0aa7e2bc10d29fc45e10b5bfdc795a
Author: Thomas Gleixner
Date: Tue Jul 4 22:20:23 2017 +0200
smp/hotplug: Move unparking of percpu threads to the control CPU
commit 9cd4f1a4e7a858849e889a081a99adff83e08e4c upstream.
Vikram reported the following backtrace:
BUG: scheduling while atomic: swapper/7/0/0x00000002
CPU: 7 PID: 0 Comm: swapper/7 Not tainted 4.9.32-perf+ #680
schedule
schedule\_hrtimeout\_range\_clock
schedule\_hrtimeout
wait\_task\_inactive
\_\_kthread\_bind\_mask
\_\_kthread\_bind
\_\_kthread\_unpark
kthread\_unpark
cpuhp\_online\_idle
cpu\_startup\_entry
secondary\_start\_kernel
He analyzed correctly that a parked cpu hotplug thread of an offlined CPU
was still on the runqueue when the CPU came back online and tried to unpark
it. This causes the thread which invoked kthread\_unpark() to call
wait\_task\_inactive() and subsequently schedule() with preemption disabled.
His proposed workaround was to "make sure" that a parked thread has
scheduled out when the CPU goes offline, so the situation cannot happen.
But that's still wrong because the root cause is not the fact that the
percpu thread is still on the runqueue and neither that preemption is
disabled, which could be simply solved by enabling preemption before
calling kthread\_unpark().
The real issue is that the calling thread is the idle task of the upcoming
CPU, which is not supposed to call anything which might sleep. The moron,
who wrote that code, missed completely that kthread\_unpark() might end up
in schedule().
The solution is simpler than expected. The thread which controls the
hotplug operation is waiting for the CPU to call complete() on the hotplug
state completion. So the idle task of the upcoming CPU can set its state to
CPUHP\_AP\_ONLINE\_IDLE and invoke complete(). This in turn wakes the control
task on a different CPU, which then can safely do the unpark and kick the
now unparked hotplug thread of the upcoming CPU to complete the bringup to
the final target state.
Control CPU AP
bringup\_cpu();
\_\_cpu\_up() ------------>
bringup\_ap();
bringup\_wait\_for\_ap()
wait\_for\_completion();
cpuhp\_online\_idle();
<------------ complete();
unpark(AP->stopper);
unpark(AP->hotplugthread);
while(1)
do\_idle();
kick(AP->hotplugthread);
wait\_for\_completion(); hotplug\_thread()
run\_online\_callbacks();
complete();
Fixes: 8df3e07e7f21 ("cpu/hotplug: Let upcoming cpu bring itself fully up")
Reported-by: Vikram Mulukutla
Signed-off-by: Thomas Gleixner
Acked-by: Peter Zijlstra
Cc: Sebastian Sewior
Cc: Rusty Russell
Cc: Tejun Heo
Cc: Andrew Morton
Link: http://lkml.kernel.org/r/alpine.DEB.2.20.1707042218020.2131@nanos
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 991344678778f93a7a7dfb0f70c2d69a1c1d42d9
Author: Gabriel Krisman Bertazi
Date: Wed Jun 28 18:06:05 2017 -0300
drm/i915: reintroduce VLV/CHV PFI programming power domain workaround
commit 9c75b185274b7766fe69c2e73607c1ed780b284b upstream.
There are still cases on these platforms where an attempt is made to
configure the CDCLK while the power domain is off, like when coming back
from a suspend. So the workaround below is still needed.
This effectively reverts commit 63ff30442519 ("drm/i915: Nuke the
VLV/CHV PFI programming power domain workaround").
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=101517
Suggested-by: Ville Syrjälä
Signed-off-by: Gabriel Krisman Bertazi
Link: http://patchwork.freedesktop.org/patch/msgid/20170628210605.4994-1-krisman@collabora.co.uk
Reviewed-by: Ville Syrjälä
Signed-off-by: Ville Syrjälä
(cherry picked from commit 886015a0ad43c7fc034b23ea4614ba39162f9ddd)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 5c5f5877a18bfc5c61b8ad565b2a5ab6ab1d79e0
Author: sagar.a.kamble@intel.com
Date: Tue Jun 27 23:09:41 2017 +0530
drm/i915: Hold RPM wakelock while initializing OA buffer
commit 04941829b0049d2446c7042ab9686dd057d809a6 upstream.
OA buffer initialization involves access to HW registers to set
the OA base, head and tail. Ensure device is awake while setting
these. With this, all oa.ops are covered under RPM and forcewake
wakelock.
Cc: Lionel Landwerlin
Signed-off-by: Sagar Arun Kamble
Reviewed-by: Lionel Landwerlin
Signed-off-by: Maarten Lankhorst
Link: http://patchwork.freedesktop.org/patch/msgid/1498585181-23048-1-git-send-email-sagar.a.kamble@intel.com
Fixes: d79651522e89c ("drm/i915: Enable i915 perf stream for Haswell OA unit")
(cherry picked from commit 987f8c444aa2c33d98e7030d0c5f0a5325cc84ea)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 76c8933ae213319eacf3aa654ab6b6f4c83fbda1
Author: Chris Wilson
Date: Thu Jun 22 17:02:11 2017 +0100
drm/i915/fbdev: Check for existence of ifbdev->vma before operations
commit 7581d5ca2bb269cfc2ce2d0cb489aac513167f6b upstream.
Commit fabef825626d ("drm/i915: Drop struct\_mutex around frontbuffer
flushes") adds a dependency to ifbdev->vma when flushing the framebufer,
but the checks are only against the existence of the ifbdev->fb and not
against ifbdev->vma. This leaves a window of opportunity where we may
try to operate on the fbdev prior to it being probed (thanks to
asynchronous booting).
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=101534
Fixes: fabef825626d ("drm/i915: Drop struct\_mutex around frontbuffer flushes")
Signed-off-by: Chris Wilson
Cc: Joonas Lahtinen
Cc: Daniel Vetter
Link: http://patchwork.freedesktop.org/patch/msgid/20170622160211.783-1-chris@chris-wilson.co.uk
Reviewed-by: Tvrtko Ursulin
(cherry picked from commit 15727ed0d944ce1dec8b9e1082dd3df29a0fdf44)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit ab78ac460dfbc4c129a10677164abec31deda7f7
Author: Chunyu Hu
Date: Thu Jul 20 18:36:09 2017 +0800
tracing: Fix kmemleak in instance\_rmdir
commit db9108e054700c96322b0f0028546aa4e643cf0b upstream.
Hit the kmemleak when executing instance\_rmdir, it forgot releasing
mem of tracing\_cpumask. With this fix, the warn does not appear any
more.
unreferenced object 0xffff93a8dfaa7c18 (size 8):
comm "mkdir", pid 1436, jiffies 4294763622 (age 9134.308s)
hex dump (first 8 bytes):
ff ff ff ff ff ff ff ff ........
backtrace:
[] kmemleak\_alloc+0x4a/0xa0
[] \_\_kmalloc\_node+0xf1/0x280
[] alloc\_cpumask\_var\_node+0x23/0x30
[] alloc\_cpumask\_var+0xe/0x10
[] instance\_mkdir+0x90/0x240
[] tracefs\_syscall\_mkdir+0x40/0x70
[] vfs\_mkdir+0x109/0x1b0
[] SyS\_mkdir+0xd0/0x100
[] do\_syscall\_64+0x67/0x150
[] return\_from\_SYSCALL\_64+0x0/0x6a
[] 0xffffffffffffffff
Link: http://lkml.kernel.org/r/1500546969-12594-1-git-send-email-chuhu@redhat.com
Fixes: ccfe9e42e451 ("tracing: Make tracing\_cpumask available for all instances")
Signed-off-by: Chunyu Hu
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit f564ff0c792c69569c5fceb896c6eefe2040e625
Author: Sudeep Holla
Date: Fri Jul 14 11:51:48 2017 +0100
PM / Domains: defer dev\_pm\_domain\_set() until genpd->attach\_dev succeeds if present
commit 975e83cfb8dc16e7a2fdc58188c77c0c605876c2 upstream.
If the genpd->attach\_dev or genpd->power\_on fails, genpd\_dev\_pm\_attach
may return -EPROBE\_DEFER initially. However genpd\_alloc\_dev\_data sets
the PM domain for the device unconditionally.
When subsequent attempts are made to call genpd\_dev\_pm\_attach, it may
return -EEXISTS checking dev->pm\_domain without re-attempting to call
attach\_dev or power\_on.
platform\_drv\_probe then attempts to call drv->probe as the return value
-EEXIST != -EPROBE\_DEFER, which may end up in a situation where the
device is accessed without it's power domain switched on.
Fixes: f104e1e5ef57 (PM / Domains: Re-order initialization of generic\_pm\_domain\_data)
Signed-off-by: Sudeep Holla
Acked-by: Ulf Hansson
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 42b81d8977928b39c8a64113f986dac7dc60efa6
Author: Philipp Zabel
Date: Mon Jun 12 17:54:29 2017 +0200
drm/imx: parallel-display: Accept drm\_of\_find\_panel\_or\_bridge failure
commit 799ee2970485dc206c3bf347d6e6827c04d5e4f9 upstream.
The parallel panel driver should continue to work without having an
endpoint linking to an panel in DT for backwards compatibility.
With the recent switch to drm\_of\_find\_panel\_or\_bridge, an absent
panel results in a failure with -ENODEV error return code. To restore
the old behaviour, ignore the -ENODEV return code.
Reported-by: Nikita Yushchenko
Fixes: ebc944613567 ("drm: convert drivers to use drm\_of\_find\_panel\_or\_bridge")
Tested-by: Chris Healy
Signed-off-by: Philipp Zabel
Signed-off-by: Greg Kroah-Hartman
commit 00d803c345ceb58243e2301a37f5f5ee1c493614
Author: Dan Williams
Date: Tue Jul 18 17:49:14 2017 -0700
device-dax: fix sysfs duplicate warnings
commit bbb3be170ac2891526ad07b18af7db226879a8e7 upstream.
Fix warnings of the form...
WARNING: CPU: 10 PID: 4983 at fs/sysfs/dir.c:31 sysfs\_warn\_dup+0x62/0x80
sysfs: cannot create duplicate filename '/class/dax/dax12.0'
Call Trace:
dump\_stack+0x63/0x86
\_\_warn+0xcb/0xf0
warn\_slowpath\_fmt+0x5a/0x80
? kernfs\_path\_from\_node+0x4f/0x60
sysfs\_warn\_dup+0x62/0x80
sysfs\_do\_create\_link\_sd.isra.2+0x97/0xb0
sysfs\_create\_link+0x25/0x40
device\_add+0x266/0x630
devm\_create\_dax\_dev+0x2cf/0x340 [dax]
dax\_pmem\_probe+0x1f5/0x26e [dax\_pmem]
nvdimm\_bus\_probe+0x71/0x120
...by reusing the namespace id for the device-dax instance name.
Now that we have decided that there will never by more than one
device-dax instance per libnvdimm-namespace parent device [1], we can
directly reuse the namepace ids. There are some possible follow-on
cleanups, but those are saved for a later patch to simplify the -stable
backport.
[1]: https://lists.01.org/pipermail/linux-nvdimm/2016-December/008266.html
Fixes: 98a29c39dc68 ("libnvdimm, namespace: allow creation of multiple pmem...")
Cc: Jeff Moyer
Reported-by: Dariusz Dokupil
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 474216905bd995945d82378299cdc96e055c8398
Author: Jan Kara
Date: Thu Jun 22 09:32:49 2017 +0200
reiserfs: Don't clear SGID when inheriting ACLs
commit 6883cd7f68245e43e91e5ee583b7550abf14523f upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by moving posix\_acl\_update\_mode() out of
\_\_reiserfs\_set\_acl() into reiserfs\_set\_acl(). That way the function will
not be called when inheriting ACLs which is what we want as it prevents
SGID bit clearing and the mode has been properly set by
posix\_acl\_create() anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: reiserfs-devel@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 114253ddc745bb72f9cc4342064f0efe2a16f649
Author: Bjorn Andersson
Date: Thu Jun 29 14:46:44 2017 -0700
spmi: Include OF based modalias in device uevent
commit d50daa2af2618dab6d21634e65a5fbcf4ae437d6 upstream.
Include the OF-based modalias in the uevent sent when registering SPMI
devices, so that user space has a chance to autoload the kernel module
for the device.
Tested-by: Rob Clark
Reported-by: Rob Clark
Reviewed-by: Stephen Boyd
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 6c8c343fa75f5ce748bb233c6abe5b038b67637c
Author: Srinivas Pandruvada
Date: Thu Jul 13 15:03:51 2017 -0700
cpufreq: intel\_pstate: Correct the busy calculation for KNL
commit 6e34e1f23d780978da65968327cbba6d7013a73f upstream.
The busy percent calculated for the Knights Landing (KNL) platform
is 1024 times smaller than the correct busy value. This causes
performance to get stuck at the lowest ratio.
The scaling algorithm used for KNL is performance-based, but it still
looks at the CPU load to set the scaled busy factor to 0 when the
load is less than 1 percent. In this case, since the computed load
is 1024x smaller than it should be, the scaled busy factor will
always be 0, irrespective of CPU business.
This needs a fix similar to the turbostat one in commit b2b34dfe4d9a
(tools/power turbostat: KNL workaround for %Busy and Avg\_MHz).
For this reason, add one more callback to processor-specific
callbacks to specify an MPERF multiplier represented by a number of
bit positions to shift the value of that register to the left to
copmensate for its rate difference with respect to the TSC. This
shift value is used during CPU busy calculations.
Fixes: ffb810563c (intel\_pstate: Avoid getting stuck in high P-states when idle)
Reported-and-tested-by: Artem Bityutskiy
Signed-off-by: Srinivas Pandruvada
[ rjw: Changelog ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 5116f5e2e05cf506ee0bdd66740cd63dc725bd49
Author: Stephen Hemminger
Date: Sun Jun 25 12:47:46 2017 -0700
vmbus: re-enable channel tasklet
commit 6463a4571ceefc43908df4b016d8d5d8b8e85357 upstream.
This problem shows up in 4.11 when netvsc driver is removed and reloaded.
The problem is that the channel is closed during module removal and the
tasklet for processing responses is disabled. When module is reloaded
the channel is reopened but the tasklet is marked as disabled.
The fix is to re-enable tasklet at the end of close which gets it back
to the initial state.
The issue is less urgent in 4.12 since network driver now uses NAPI
and not the tasklet; and other VMBUS devices are rarely unloaded/reloaded.
Fixes: dad72a1d2844 ("vmbus: remove hv\_event\_tasklet\_disable/enable")
Signed-off-by: Stephen Hemminger
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Greg Kroah-Hartman
commit 5e87c475152fadf49f9582e99dc5e7a4e77a8650
Author: Prarit Bhargava
Date: Wed May 31 13:32:00 2017 -0400
acpi/nfit: Fix memory corruption/Unregister mce decoder on failure
commit 7e700d2c59e5853c9126642976b4f5768f64c9b3 upstream.
nfit\_init() calls nfit\_mce\_register() on module load. When the module
load fails the nfit mce decoder is not unregistered. The module's
memory is freed leaving the decoder chain referencing junk. This will
cause panics as future registrations will reference the free'd memory.
Unregister the nfit mce decoder on module init failure.
[v2]: register and then unregister mce handler to avoid losing mce events
[v3]: also cleanup nfit workqueue
Fixes: 6839a6d96f4e ("nfit: do an ARS scrub on hitting a latent media error")
Cc: "Rafael J. Wysocki"
Cc: Len Brown
Cc: Vishal Verma
Cc: "Lee, Chun-Yi"
Cc: Linda Knippers
Cc: lszubowi@redhat.com
Acked-by: Jeff Moyer
Signed-off-by: Prarit Bhargava
Reviewed-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 054728d3bbe4a3047e91a4ff4f66298c4baf6462
Author: Christoph Lameter
Date: Wed Jul 12 14:33:11 2017 -0700
kernel/fork.c: virtually mapped stacks: do not disable interrupts
commit 112166f88cf83dd11486cf1818672d42b540865b upstream.
The reason to disable interrupts seems to be to avoid switching to a
different processor while handling per cpu data using individual loads and
stores. If we use per cpu RMV primitives we will not have to disable
interrupts.
Link: http://lkml.kernel.org/r/alpine.DEB.2.20.1705171055130.5898@east.gentwo.org
Signed-off-by: Christoph Lameter
Cc: Andy Lutomirski
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 2541b3c861bc58ac4e01edfa4bb035421ff23501
Author: Nikolay Borisov
Date: Wed Jul 12 14:37:51 2017 -0700
writeback: rework wb\_[dec|inc]\_stat family of functions
commit 3e8f399da490e6ac20a3cfd6aa404c9aa961a9a2 upstream.
Currently the writeback statistics code uses a percpu counters to hold
various statistics. Furthermore we have 2 families of functions - those
which disable local irq and those which doesn't and whose names begin
with double underscore. However, they both end up calling
\_\_add\_wb\_stats which in turn calls percpu\_counter\_add\_batch which is
already irq-safe.
Exploiting this fact allows to eliminated the \_\_wb\_\* functions since
they don't add any further protection than we already have.
Furthermore, refactor the wb\_\* function to call \_\_add\_wb\_stat directly
without the irq-disabling dance. This will likely result in better
runtime of code which deals with modifying the stat counters.
While at it also document why percpu\_counter\_add\_batch is in fact
preempt and irq-safe since at least 3 people got confused.
Link: http://lkml.kernel.org/r/1498029937-27293-1-git-send-email-nborisov@suse.com
Signed-off-by: Nikolay Borisov
Acked-by: Tejun Heo
Reviewed-by: Jan Kara
Cc: Josef Bacik
Cc: Mel Gorman
Cc: Jeff Layton
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 60958be79d5845e2e00f81cd256443e376194b0f
Author: Nikolay Borisov
Date: Tue Jun 20 21:01:20 2017 +0300
percpu\_counter: Rename \_\_percpu\_counter\_add to percpu\_counter\_add\_batch
commit 104b4e5139fe384431ac11c3b8a6cf4a529edf4a upstream.
Currently, percpu\_counter\_add is a wrapper around \_\_percpu\_counter\_add
which is preempt safe due to explicit calls to preempt\_disable. Given
how \_\_ prefix is used in percpu related interfaces, the naming
unfortunately creates the false sense that \_\_percpu\_counter\_add is
less safe than percpu\_counter\_add. In terms of context-safety,
they're equivalent. The only difference is that the \_\_ version takes
a batch parameter.
Make this a bit more explicit by just renaming \_\_percpu\_counter\_add to
percpu\_counter\_add\_batch.
This patch doesn't cause any functional changes.
tj: Minor updates to patch description for clarity. Cosmetic
indentation updates.
Signed-off-by: Nikolay Borisov
Signed-off-by: Tejun Heo
Cc: Chris Mason
Cc: Josef Bacik
Cc: David Sterba
Cc: Darrick J. Wong
Cc: Jan Kara
Cc: Jens Axboe
Cc: linux-mm@kvack.org
Cc: "David S. Miller"
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit fa7333486ea06d0f7c3078449aa9f9e069ef2d50
Author: Jeffrey Hugo
Date: Wed Jun 7 13:18:57 2017 -0600
sched/fair: Fix load\_balance() affinity redo path
commit 65a4433aebe36c8c6abeb69b99ef00274b971c6c upstream.
If load\_balance() fails to migrate any tasks because all tasks were
affined, load\_balance() removes the source CPU from consideration and
attempts to redo and balance among the new subset of CPUs.
There is a bug in this code path where the algorithm considers all active
CPUs in the system (minus the source that was just masked out). This is
not valid for two reasons: some active CPUs may not be in the current
scheduling domain and one of the active CPUs is dst\_cpu. These CPUs should
not be considered, as we cannot pull load from them.
Instead of failing out of load\_balance(), we may end up redoing the search
with no valid CPUs and incorrectly concluding the domain is balanced.
Additionally, if the group\_imbalance flag was just set, it may also be
incorrectly unset, thus the flag will not be seen by other CPUs in future
load\_balance() runs as that algorithm intends.
Fix the check by removing CPUs not in the current domain and the dst\_cpu
from considertation, thus limiting the evaluation to valid remaining CPUs
from which load might be migrated.
Co-authored-by: Austin Christ
Co-authored-by: Dietmar Eggemann
Tested-by: Tyler Baicar
Signed-off-by: Jeffrey Hugo
Acked-by: Peter Zijlstra
Cc: Austin Christ
Cc: Dietmar Eggemann
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: Timur Tabi
Link: http://lkml.kernel.org/r/1496863138-11322-2-git-send-email-jhugo@codeaurora.org
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 8e44a3517763a89e1135024eab12ef3b24819dc0
Author: Wanpeng Li
Date: Thu Jun 29 19:15:11 2017 +0200
sched/cputime: Accumulate vtime on top of nsec clocksource
commit 2a42eb9594a1480b4ead9e036e06ee1290e5fa6d upstream.
Currently the cputime source used by vtime is jiffies. When we cross
a context boundary and jiffies have changed since the last snapshot, the
pending cputime is accounted to the switching out context.
This system works ok if the ticks are not aligned across CPUs. If they
instead are aligned (ie: all fire at the same time) and the CPUs run in
userspace, the jiffies change is only observed on tick exit and therefore
the user cputime is accounted as system cputime. This is because the
CPU that maintains timekeeping fires its tick at the same time as the
others. It updates jiffies in the middle of the tick and the other CPUs
see that update on IRQ exit:
CPU 0 (timekeeper) CPU 1
------------------- -------------
jiffies = N
... run in userspace for a jiffy
tick entry tick entry (sees jiffies = N)
set jiffies = N + 1
tick exit tick exit (sees jiffies = N + 1)
account 1 jiffy as stime
Fix this with using a nanosec clock source instead of jiffies. The
cputime is then accumulated and flushed everytime the pending delta
reaches a jiffy in order to mitigate the accounting overhead.
[ fweisbec: changelog, rebase on struct vtime, field renames, add delta
on cputime readers, keep idle vtime as-is (low overhead accounting),
harmonize clock sources. ]
Suggested-by: Thomas Gleixner
Reported-by: Luiz Capitulino
Tested-by: Luiz Capitulino
Signed-off-by: Wanpeng Li
Signed-off-by: Frederic Weisbecker
Reviewed-by: Thomas Gleixner
Acked-by: Rik van Riel
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Wanpeng Li
Link: http://lkml.kernel.org/r/1498756511-11714-6-git-send-email-fweisbec@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit a1d04e8a110288917a4f4ac14370cb9f06c36500
Author: Frederic Weisbecker
Date: Thu Jun 29 19:15:10 2017 +0200
sched/cputime: Move the vtime task fields to their own struct
commit bac5b6b6b11560f323e71d0ebac4061cfe5f56c0 upstream.
We are about to add vtime accumulation fields to the task struct. Let's
avoid more bloatification and gather vtime information to their own
struct.
Tested-by: Luiz Capitulino
Signed-off-by: Frederic Weisbecker
Reviewed-by: Thomas Gleixner
Acked-by: Rik van Riel
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Wanpeng Li
Link: http://lkml.kernel.org/r/1498756511-11714-5-git-send-email-fweisbec@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 7d546b63c820089b08941ae9e5b63147fad211ee
Author: Frederic Weisbecker
Date: Thu Jun 29 19:15:09 2017 +0200
sched/cputime: Rename vtime fields
commit 60a9ce57e7c5ac1df3a39fb941022bbfa40c0862 upstream.
The current "snapshot" based naming on vtime fields suggests we record
some past event but that's a low level picture of their actual purpose
which comes out blurry. The real point of these fields is to run a basic
state machine that tracks down cputime entry while switching between
contexts.
So lets reflect that with more meaningful names.
Tested-by: Luiz Capitulino
Signed-off-by: Frederic Weisbecker
Reviewed-by: Thomas Gleixner
Acked-by: Rik van Riel
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Wanpeng Li
Link: http://lkml.kernel.org/r/1498756511-11714-4-git-send-email-fweisbec@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 09b43d8df3119e309e8842782f9acf39a9ab4872
Author: Frederic Weisbecker
Date: Thu Jun 29 19:15:08 2017 +0200
sched/cputime: Always set tsk->vtime\_snap\_whence after accounting vtime
commit 9fa57cf5a5c4aed1e45879b335fe433048709327 upstream.
Even though it doesn't have functional consequences, setting
the task's new context state after we actually accounted the pending
vtime from the old context state makes more sense from a review
perspective.
vtime\_user\_exit() is the only function that doesn't follow that rule
and that can bug the reviewer for a little while until he realizes there
is no reason for this special case.
Tested-by: Luiz Capitulino
Signed-off-by: Frederic Weisbecker
Reviewed-by: Thomas Gleixner
Acked-by: Rik van Riel
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Wanpeng Li
Link: http://lkml.kernel.org/r/1498756511-11714-3-git-send-email-fweisbec@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 6bb15a0824ffdae94f60556bb433719d167e2fac
Author: Frederic Weisbecker
Date: Thu Jun 29 19:15:07 2017 +0200
vtime, sched/cputime: Remove vtime\_account\_user()
commit 1c3eda01a79b8e9237d91c52c5a75b20983f47c6 upstream.
It's an unnecessary function between vtime\_user\_exit() and
account\_user\_time().
Tested-by: Luiz Capitulino
Signed-off-by: Frederic Weisbecker
Reviewed-by: Thomas Gleixner
Acked-by: Rik van Riel
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Wanpeng Li
Link: http://lkml.kernel.org/r/1498756511-11714-2-git-send-email-fweisbec@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Mel Gorman
Signed-off-by: Greg Kroah-Hartman
commit 35632493c3547ca8b2a9b469862b89ecd234525f
Author: Jan Kara
Date: Wed Jun 21 15:02:47 2017 +0200
hfsplus: Don't clear SGID when inheriting ACLs
commit 84969465ddc4f8aeb3b993123b571aa01c5f2683 upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by creating \_\_hfsplus\_set\_posix\_acl() function that does
not call posix\_acl\_update\_mode() and use it when inheriting ACLs. That
prevents SGID bit clearing and the mode has been properly set by
posix\_acl\_create() anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 6107c06645d63b13252e7b85669251f10d2bb8f3
Author: Bart Van Assche
Date: Mon Apr 24 15:15:28 2017 -0700
mlx5: Avoid that mlx5\_ib\_sg\_to\_klms() overflows the klms[] array
commit 99975cd4fda52974a767aa44fe0b1a8f74950d9d upstream.
ib\_map\_mr\_sg() can pass an SG-list to .map\_mr\_sg() that is larger
than what fits into a single MR. .map\_mr\_sg() must not attempt to
map more SG-list elements than what fits into a single MR.
Hence make sure that mlx5\_ib\_sg\_to\_klms() does not write outside
the MR klms[] array.
Fixes: b005d3164713 ("mlx5: Add arbitrary sg list support")
Signed-off-by: Bart Van Assche
Reviewed-by: Max Gurtovoy
Cc: Sagi Grimberg
Cc: Leon Romanovsky
Cc: Israel Rukshin
Acked-by: Leon Romanovsky
Reviewed-by: Sagi Grimberg
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 442edd0e17fbf3540eb9491290d00067d16f5db2
Author: Maarten Lankhorst
Date: Mon Jun 26 10:33:49 2017 +0200
drm/i915: Make DP-MST connector info work
commit 50740024bc393b608f7e391ac35e70f33938dd24 upstream.
Commit 9a148a96fc3a ("drm/i915/debugfs: add dp mst info") adds support
for DP-MST to intel\_connector\_info, but forgot to remove the early
return for DP-MST.
Remove it, and print out MST connectors directly.
Fixes: 9a148a96fc3a ("drm/i915/debugfs: add dp mst info")
Cc: Dhinakaran Pandiyan
Cc: Libin Yang
Signed-off-by: Maarten Lankhorst
Link: http://patchwork.freedesktop.org/patch/msgid/20170626083349.24389-1-maarten.lankhorst@linux.intel.com
Reviewed-by: Dhinakaran Pandiyan
(cherry picked from commit 77d1f615c78a73a04254fa2bff07ee9fa27145d9)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 255758f79390097c94c9dc2695991e4662041547
Author: Imre Deak
Date: Wed Jul 19 16:46:32 2017 +0300
drm/mst: Avoid processing partially received up/down message transactions
commit 636c4c3e762b62aa93632c645ca65879285b16e3 upstream.
Currently we may process up/down message transactions containing
uninitialized data. This can happen if there was an error during the
reception of any message in the transaction, but we happened to receive
the last message correctly with the end-of-message flag set.
To avoid this abort the reception of the transaction when the first
error is detected, rejecting any messages until a message with the
start-of-message flag is received (which will start a new transaction).
This is also what the DP 1.4 spec 2.11.8.2 calls for in this case.
In addtion this also prevents receiving bogus transactions without the
first message with the the start-of-message flag set.
v2:
- unchanged
v3:
- git add the part that actually skips messages after an error in
drm\_dp\_sideband\_msg\_build()
Cc: Dave Airlie
Cc: Lyude
Cc: Daniel Vetter
Signed-off-by: Imre Deak
Reviewed-by: Lyude
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20170719134632.13366-1-imre.deak@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 4c5cea159d3f6c5da6f23761e46efc230c81338b
Author: Imre Deak
Date: Wed Jul 19 14:43:29 2017 +0300
drm/mst: Avoid dereferencing a NULL mstb in drm\_dp\_mst\_handle\_up\_req()
commit 7f8b3987da54cb4d41ad2545cd4d7958b9a36bdf upstream.
In case of an unknown broadcast message is sent mstb will remain unset,
so check for this.
Cc: Dave Airlie
Cc: Lyude
Cc: Daniel Vetter
Signed-off-by: Imre Deak
Reviewed-by: Lyude
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20170719114330.26540-3-imre.deak@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 9bacd42b1cc6a52e2ce5f7a69c17e336af69a47d
Author: Imre Deak
Date: Wed Jul 19 14:43:28 2017 +0300
drm/mst: Fix error handling during MST sideband message reception
commit 448421b5e93b9177c5698f0cf6f5e72d2995eeca upstream.
Handle any error due to partial reads, timeouts etc. to avoid parsing
uninitialized data subsequently. Also bail out if the parsing itself
fails.
Cc: Dave Airlie
Cc: Lyude
Cc: Daniel Vetter
Signed-off-by: Imre Deak
Reviewed-by: Lyude
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20170719114330.26540-2-imre.deak@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 47c671637bacd85e201f8734dfd5bc3d24ec2e5d
Author: Ismail, Mustafa
Date: Fri Jul 14 09:41:31 2017 -0500
RDMA/core: Initialize port\_num in qp\_attr
commit a62ab66b13a0f9bcb17b7b761f6670941ed5cd62 upstream.
Initialize the port\_num for iWARP in rdma\_init\_qp\_attr.
Fixes: 5ecce4c9b17b("Check port number supplied by user verbs cmds")
Reviewed-by: Steve Wise
Signed-off-by: Mustafa Ismail
Tested-by: Mike Marciniszyn
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 11e6c231c7d009525f3a99cb1c5b9bb2d894f652
Author: Ismail, Mustafa
Date: Fri Jul 14 09:41:30 2017 -0500
RDMA/uverbs: Fix the check for port number
commit 5a7a88f1b488e4ee49eb3d5b82612d4d9ffdf2c3 upstream.
The port number is only valid if IB\_QP\_PORT is set in the mask.
So only check port number if it is valid to prevent modify\_qp from
failing due to an invalid port number.
Fixes: 5ecce4c9b17b("Check port number supplied by user verbs cmds")
Reviewed-by: Steve Wise
Signed-off-by: Mustafa Ismail
Tested-by: Mike Marciniszyn
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 6823b31afd1091dbf66311f7adc6f44fd53ea514
Author: Yan, Zheng
Date: Thu Jul 6 11:12:21 2017 +0800
ceph: fix race in concurrent readdir
commit 84583cfb973c4313955c6231cc9cb3772d280b15 upstream.
For a large directory, program needs to issue multiple readdir
syscalls to get all dentries. When there are multiple programs
read the directory concurrently. Following sequence of events
can happen.
- program calls readdir with pos = 2. ceph sends readdir request
to mds. The reply contains N1 entries. ceph adds these N1 entries
to readdir cache.
- program calls readdir with pos = N1+2. The readdir is satisfied
by the readdir cache, N2 entries are returned. (Other program
calls readdir in the middle, which fills the cache)
- program calls readdir with pos = N1+N2+2. ceph sends readdir
request to mds. The reply contains N3 entries and it reaches
directory end. ceph adds these N3 entries to the readdir cache
and marks directory complete.
The second readdir call does not update fi->readdir\_cache\_idx.
ceph add the last N3 entries to wrong places.
Signed-off-by: "Yan, Zheng"
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 3002c15f57be5e6cbcc8df55ee49964d9052ae4d
Author: Arnd Bergmann
Date: Sat Jul 15 11:32:08 2017 -0400
staging: lustre: ko2iblnd: check copy\_from\_iter/copy\_to\_iter return code
commit 566e1ce22e04426fa52328b2adcdf1df49acd98e upstream.
We now get a helpful warning for code that calls copy\_{from,to}\_iter
without checking the return value, introduced by commit aa28de275a24
("iov\_iter/hardening: move object size checks to inlined part").
drivers/staging/lustre/lnet/klnds/o2iblnd/o2iblnd\_cb.c: In function 'kiblnd\_send':
drivers/staging/lustre/lnet/klnds/o2iblnd/o2iblnd\_cb.c:1643:2: error: ignoring return value of 'copy\_from\_iter', declared with attribute warn\_unused\_result [-Werror=unused-result]
drivers/staging/lustre/lnet/klnds/o2iblnd/o2iblnd\_cb.c: In function 'kiblnd\_recv':
drivers/staging/lustre/lnet/klnds/o2iblnd/o2iblnd\_cb.c:1744:3: error: ignoring return value of 'copy\_to\_iter', declared with attribute warn\_unused\_result [-Werror=unused-result]
In case we get short copies here, we may get incorrect behavior.
I've added failure handling for both rx and tx now, returning
-EFAULT as expected.
Signed-off-by: Arnd Bergmann
Signed-off-by: James Simmons
Signed-off-by: Greg Kroah-Hartman
commit 6bab0b74fc7ac35870e74ca8ea4f3633ecebeb55
Author: Teddy Wang
Date: Fri Jun 30 21:57:43 2017 +0100
staging: sm750fb: avoid conflicting vesafb
commit 740c433ec35187b45abe08bb6c45a321a791be8e upstream.
If vesafb is enabled in the config then /dev/fb0 is created by vesa
and this sm750 driver gets fb1, fb2. But we need to be fb0 and fb1 to
effectively work with xorg.
So if it has been alloted fb1, then try to remove the other fb0.
In the previous send, why #ifdef is used was asked.
https://lkml.org/lkml/2017/6/25/57
Answered at: https://lkml.org/lkml/2017/6/25/69
Also pasting here for reference.
'Did a quick research into "why".
The patch d8801e4df91e ("x86/PCI: Set IORESOURCE\_ROM\_SHADOW only for the
default VGA device") has started setting IORESOURCE\_ROM\_SHADOW in flags
for a default VGA device and that is being done only for x86.
And so, we will need that #ifdef to check IORESOURCE\_ROM\_SHADOW as that
needs to be checked only for a x86 and not for other arch.'
Signed-off-by: Teddy Wang
Signed-off-by: Sudip Mukherjee
Signed-off-by: Greg Kroah-Hartman
commit 592761a080cacb7e37477dd9bb1eb0a8a8849d97
Author: Ian Abbott
Date: Fri Jun 30 12:02:18 2017 +0100
staging: comedi: ni\_mio\_common: fix AO timer off-by-one regression
commit 15d5193104a457d5151840247e3bce561c42e3e9 upstream.
As reported by Éric Piel on the Comedi mailing list (see
),
the analog output asynchronous commands are running too fast with a
period 50 ns shorter than it should be. This affects all boards with AO
command support that are supported by the "ni\_pcimio", "ni\_atmio", and
"ni\_mio\_cs" drivers.
This is a regression bug introduced by commit 080e6795cba3 ("staging:
comedi: ni\_mio\_common: Cleans up/clarifies ni\_ao\_cmd"), specifically,
this line in `ni\_ao\_cmd\_set\_update()`:
/\* following line: N-1 per STC \*/
ni\_stc\_writel(dev, trigvar - 1, NISTC\_AO\_UI\_LOADA\_REG);
The `trigvar` variable value comes from a call to `ni\_ns\_to\_timer()`
which converts a timer period in nanoseconds to a hardware divisor
value. The function already reduces the divisor by 1 as required by the
hardware, so the above line should not reduce it further by 1. Fix it
by replacing `trigvar` by `trigvar - 1` in the above line, and remove
the misleading comment.
Reported-by: Éric Piel
Fixes: 080e6795cba3 ("staging: comedi: ni\_mio\_common: Cleans up/clarifies ni\_ao\_cmd")
Cc: Éric Piel
Cc: Spencer E. Olson
Signed-off-by: Ian Abbott
Signed-off-by: Greg Kroah-Hartman
commit f49f1f5f65793b18be223d480839e6325cb12346
Author: Michael Gugino
Date: Mon Jul 17 13:29:09 2017 -0400
staging: rtl8188eu: add TL-WN722N v2 support
commit 5a1d4c5dd4eb2f1f8a9b30e61762f3b3b564df70 upstream.
Add support for USB Device TP-Link TL-WN722N v2.
VendorID: 0x2357, ProductID: 0x010c
Signed-off-by: Michael Gugino
Signed-off-by: Greg Kroah-Hartman
commit 964b720f3cead6c0947e519bce7e96b17d3ef1ff
Author: Ingo Molnar
Date: Tue Jul 11 10:56:54 2017 +0200
Revert "perf/core: Drop kernel samples even though :u is specified"
commit 6a8a75f3235724c5941a33e287b2f98966ad14c5 upstream.
This reverts commit cc1582c231ea041fbc68861dfaf957eaf902b829.
This commit introduced a regression that broke rr-project, which uses sampling
events to receive a signal on overflow (but does not care about the contents
of the sample). These signals are critical to the correct operation of rr.
There's been some back and forth about how to fix it - but to not keep
applications in limbo queue up a revert.
Reported-by: Kyle Huey
Acked-by: Kyle Huey
Acked-by: Peter Zijlstra
Cc: Jin Yao
Cc: Vince Weaver
Cc: Linus Torvalds
Cc: Will Deacon
Cc: Arnaldo Carvalho de Melo
Cc: Alexander Shishkin
Cc: Stephane Eranian
Cc: Namhyung Kim
Cc: Jiri Olsa
Link: http://lkml.kernel.org/r/20170628105600.GC5981@leverpostej
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 371e6d8b85ef23665958d84307bc0fddc5a6a867
Author: Alexander Shishkin
Date: Tue Jul 18 14:08:34 2017 +0300
perf/core: Fix scheduling regression of pinned groups
commit 3bda69c1c3993a2bddbae01397d12bfef6054011 upstream.
Vince Weaver reported:
> I was tracking down some regressions in my perf\_event\_test testsuite.
> Some of the tests broke in the 4.11-rc1 timeframe.
>
> I've bisected one of them, this report is about
> tests/overflow/simul\_oneshot\_group\_overflow
> This test creates an event group containing two sampling events, set
> to overflow to a signal handler (which disables and then refreshes the
> event).
>
> On a good kernel you get the following:
> Event perf::instructions with period 1000000
> Event perf::instructions with period 2000000
> fd 3 overflows: 946 (perf::instructions/1000000)
> fd 4 overflows: 473 (perf::instructions/2000000)
> Ending counts:
> Count 0: 946379875
> Count 1: 946365218
>
> With the broken kernels you get:
> Event perf::instructions with period 1000000
> Event perf::instructions with period 2000000
> fd 3 overflows: 938 (perf::instructions/1000000)
> fd 4 overflows: 318 (perf::instructions/2000000)
> Ending counts:
> Count 0: 946373080
> Count 1: 653373058
The root cause of the bug is that the following commit:
487f05e18a ("perf/core: Optimize event rescheduling on active contexts")
erronously assumed that event's 'pinned' setting determines whether the
event belongs to a pinned group or not, but in fact, it's the group
leader's pinned state that matters.
This was discovered by Vince in the test case described above, where two instruction
counters are grouped, the group leader is pinned, but the other event is not;
in the regressed case the counters were off by 33% (the difference between events'
periods), but should be the same within the error margin.
Fix the problem by looking at the group leader's pinning.
Reported-by: Vince Weaver
Tested-by: Vince Weaver
Signed-off-by: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Fixes: 487f05e18a ("perf/core: Optimize event rescheduling on active contexts")
Link: http://lkml.kernel.org/r/87lgnmvw7h.fsf@ashishki-desk.ger.corp.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 74671ea542bedc00cfac73e865c28ebde962d0a6
Author: Jin Yao
Date: Thu Jun 8 14:01:44 2017 +0800
perf annotate: Fix broken arrow at row 0 connecting jmp instruction to its target
commit 80f62589fa52f530cffc50e78c0b5a2ae572d61e upstream.
When the jump instruction is displayed at the row 0 in annotate view,
the arrow is broken. An example:
16.86 │ ┌──je 82
0.01 │ movsd (%rsp),%xmm0
│ movsd 0x8(%rsp),%xmm4
│ movsd 0x8(%rsp),%xmm1
│ movsd (%rsp),%xmm3
│ divsd %xmm4,%xmm0
│ divsd %xmm3,%xmm1
│ movsd (%rsp),%xmm2
│ addsd %xmm1,%xmm0
│ addsd %xmm2,%xmm0
│ movsd %xmm0,(%rsp)
│82: sub $0x1,%ebx
83.03 │ ↑ jne 38
│ add $0x10,%rsp
│ xor %eax,%eax
│ pop %rbx
│ ← retq
The patch increments the row number before checking with 0.
Signed-off-by: Yao Jin
Tested-by: Arnaldo Carvalho de Melo
Cc: Alexander Shishkin
Cc: Andi Kleen
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Peter Zijlstra
Fixes: 944e1abed9e1 ("perf ui browser: Add method to draw up/down arrow line")
Link: http://lkml.kernel.org/r/1496901704-30275-1-git-send-email-yao.jin@linux.intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit b05b92bcf45ec86a02c94aa6f34a0c5eb4179bab
Author: Nicholas Bellinger
Date: Thu Jun 29 22:21:31 2017 -0700
iser-target: Avoid isert\_conn->cm\_id dereference in isert\_login\_recv\_done
commit fce50a2fa4e9c6e103915c351b6d4a98661341d6 upstream.
This patch fixes a NULL pointer dereference in isert\_login\_recv\_done()
of isert\_conn->cm\_id due to isert\_cma\_handler() -> isert\_connect\_error()
resetting isert\_conn->cm\_id = NULL during a failed login attempt.
As per Sagi, we will always see the completion of all recv wrs posted
on the qp (given that we assigned a ->done handler), this is a FLUSH
error completion, we just don't get to verify that because we deref
NULL before.
The issue here, was the assumption that dereferencing the connection
cm\_id is always safe, which is not true since:
commit 4a579da2586bd3b79b025947ea24ede2bbfede62
Author: Sagi Grimberg
Date: Sun Mar 29 15:52:04 2015 +0300
iser-target: Fix possible deadlock in RDMA\_CM connection error
As I see it, we have a direct reference to the isert\_device from
isert\_conn which is the one-liner fix that we actually need like
we do in isert\_rdma\_read\_done() and isert\_rdma\_write\_done().
Reported-by: Andrea Righi
Tested-by: Andrea Righi
Reviewed-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 0cc3c70dcfc1d6a047ebb07529cfbd87adc23e81
Author: Jiang Yi
Date: Sun Jun 25 12:28:50 2017 -0700
target: Fix COMPARE\_AND\_WRITE caw\_sem leak during se\_cmd quiesce
commit 1d6ef276594a781686058802996e09c8550fd767 upstream.
This patch addresses a COMPARE\_AND\_WRITE se\_device->caw\_sem leak,
that would be triggered during normal se\_cmd shutdown or abort
via \_\_transport\_wait\_for\_tasks().
This would occur because target\_complete\_cmd() would catch this
early and do complete\_all(&cmd->t\_transport\_stop\_comp), but since
target\_complete\_ok\_work() or target\_complete\_failure\_work() are
never called to invoke se\_cmd->transport\_complete\_callback(),
the COMPARE\_AND\_WRITE specific callbacks never release caw\_sem.
To address this special case, go ahead and release caw\_sem
directly from target\_complete\_cmd().
(Remove '&& success' from check, to release caw\_sem regardless
of scsi\_status - nab)
Signed-off-by: Jiang Yi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit cb22c668c465aa968ab1e948f98103d12332ed2f
Author: Jan Kara
Date: Tue Jun 13 16:20:25 2017 +0200
udf: Fix deadlock between writeback and udf\_setsize()
commit f2e95355891153f66d4156bf3a142c6489cd78c6 upstream.
udf\_setsize() called truncate\_setsize() with i\_data\_sem held. Thus
truncate\_pagecache() called from truncate\_setsize() could lock a page
under i\_data\_sem which can deadlock as page lock ranks below
i\_data\_sem - e. g. writeback can hold page lock and try to acquire
i\_data\_sem to map a block.
Fix the problem by moving truncate\_setsize() calls from under
i\_data\_sem. It is safe for us to change i\_size without holding
i\_data\_sem as all the places that depend on i\_size being stable already
hold inode\_lock.
Fixes: 7e49b6f2480cb9a9e7322a91592e56a5c85361f5
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 47a493225854537bf98e11502b9dcc25ed634c6b
Author: Jan Kara
Date: Tue Jun 13 15:54:58 2017 +0200
udf: Fix races with i\_size changes during readpage
commit 9795e0e8ac0d6a3ee092f1b555b284b57feef99e upstream.
\_\_udf\_adinicb\_readpage() uses i\_size several times. When truncate
changes i\_size while the function is running, it can observe several
different values and thus e.g. expose uninitialized parts of page to
userspace. Also use i\_size\_read() in the function since it does not hold
inode\_lock. Since i\_size is guaranteed to be small, this cannot really
cause any issues even on 32-bit archs but let's be careful.
Fixes: 9c2fc0de1a6e638fe58c354a463f544f42a90a09
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 9968e8105914ba437b98dd19200092537dfeb23b
Author: NeilBrown
Date: Wed Jul 5 12:22:20 2017 +1000
NFS: only invalidate dentrys that are clearly invalid.
commit cc89684c9a265828ce061037f1f79f4a68ccd3f7 upstream.
Since commit bafc9b754f75 ("vfs: More precise tests in d\_invalidate")
in v3.18, a return of '0' from ->d\_revalidate() will cause the dentry
to be invalidated even if it has filesystems mounted on or it or on a
descendant. The mounted filesystem is unmounted.
This means we need to be careful not to return 0 unless the directory
referred to truly is invalid. So -ESTALE or -ENOENT should invalidate
the directory. Other errors such a -EPERM or -ERESTARTSYS should be
returned from ->d\_revalidate() so they are propagated to the caller.
A particular problem can be demonstrated by:
1/ mount an NFS filesystem using NFSv3 on /mnt
2/ mount any other filesystem on /mnt/foo
3/ ls /mnt/foo
4/ turn off network, or otherwise make the server unable to respond
5/ ls /mnt/foo &
6/ cat /proc/$!/stack # note that nfs\_lookup\_revalidate is in the call stack
7/ kill -9 $! # this results in -ERESTARTSYS being returned
8/ observe that /mnt/foo has been unmounted.
This patch changes nfs\_lookup\_revalidate() to only treat
-ESTALE from nfs\_lookup\_verify\_inode() and
-ESTALE or -ENOENT from ->lookup()
as indicating an invalid inode. Other errors are returned.
Also nfs\_check\_inode\_attributes() is changed to return -ESTALE rather
than -EIO. This is consistent with the error returned in similar
circumstances from nfs\_update\_inode().
As this bug allows any user to unmount a filesystem mounted on an NFS
filesystem, this fix is suitable for stable kernels.
Fixes: bafc9b754f75 ("vfs: More precise tests in d\_invalidate")
Signed-off-by: NeilBrown
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 86eadfc25a845dd8d1cff80557a362ac58f7c607
Author: Olga Kornievskaia
Date: Fri Jun 23 10:26:58 2017 -0400
PNFS fix EACCESS on commit to DS handling
commit a0bc01e0f1fa39702b5244b3bac699bea0d4f413 upstream.
Commit fabbbee0eb0f "PNFS fix fallback to MDS if got error on
commit to DS" moved the pnfs\_set\_lo\_fail() to unhandled errors
which was not correct and lead to a kernel oops on umount.
Instead, fix the original EACCESS on commit to DS error by
getting the new layout and re-doing the IO.
Fixes: fabbbee0eb0f ("PNFS fix fallback to MDS if got error on commit to DS")
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit be7e79fe053e76d385e8f3abe4666a566f3a62cb
Author: Benjamin Coddington
Date: Fri Jun 9 11:03:23 2017 -0400
NFS: Fix initialization of nfs\_page\_array->npages
commit 2eb3aea7d9c43325a12df312adfc7fb25bbd636b upstream.
Commit 8ef9b0b9e1c0 open-coded nfs\_pgarray\_set(), and left out the
initialization of the nfs\_page\_array's npages. This mistake didn't show up
until testing with block layouts, and there shows that all pNFS reads
return -EIO.
Fixes: 8ef9b0b9e1c0 ("NFS: move nfs\_pgarray\_set() to open code")
Signed-off-by: Benjamin Coddington
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 7956cddeaebf7422c9aa949665a7a39cbb2bea0b
Author: NeilBrown
Date: Wed Jul 19 14:05:01 2017 +1000
net/sunrpc/xprt\_sock: fix regression in connection error reporting.
commit 3ffbc1d65583394be12801655781dd2b079ce169 upstream.
Commit 3d4762639dd3 ("tcp: remove poll() flakes when receiving
RST") in v4.12 changed the order in which ->sk\_state\_change()
and ->sk\_error\_report() are called when a socket is shut
down - sk\_state\_change() is now called first.
This causes xs\_tcp\_state\_change() -> xs\_sock\_mark\_closed() ->
xprt\_disconnect\_done() to wake all pending tasked with -EAGAIN.
When the ->sk\_error\_report() callback arrives, it is too late to
pass the error on, and it is lost.
As easy way to demonstrate the problem caused is to try to start
rpc.nfsd while rcpbind isn't running.
nfsd will attempt a tcp connection to rpcbind. A ECONNREFUSED
error is returned, but sunrpc code loses the error and keeps
retrying. If it saw the ECONNREFUSED, it would abort.
To fix this, handle the sk->sk\_err in the TCP\_CLOSE branch of
xs\_tcp\_state\_change().
Fixes: 3d4762639dd3 ("tcp: remove poll() flakes when receiving RST")
Signed-off-by: NeilBrown
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 41509dbadbecd846a597d8d0442dc3b6982f0361
Author: Jason A. Donenfeld
Date: Sat Jun 10 04:59:07 2017 +0200
sunrpc: use constant time memory comparison for mac
commit 15a8b93fd5690de017ce665382ea45e5d61811a4 upstream.
Otherwise, we enable a MAC forgery via timing attack.
Signed-off-by: Jason A. Donenfeld
Cc: "J. Bruce Fields"
Cc: Jeff Layton
Cc: Trond Myklebust
Cc: Anna Schumaker
Cc: linux-nfs@vger.kernel.org
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 8eeee16d7808986327532a5608103f25afbbbb86
Author: Moni Shoua
Date: Tue May 23 10:48:44 2017 +0300
IB/core: Namespace is mandatory input for address resolution
commit bebb2a473a43c8f84a8210687d1cbdde503046d7 upstream.
In function addr\_resolve() the namespace is a required input parameter
and not an output. It is passed later for searching the routing table
and device addresses. Also, it shouldn't be copied back to the caller.
Fixes: 565edd1d5555 ('IB/addr: Pass network namespace as a parameter')
Signed-off-by: Moni Shoua
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit adbb45552715930e206e4a7674e9c6559c2299dc
Author: Vladimir Neyelov
Date: Sun May 21 19:17:31 2017 +0300
IB/iser: Fix connection teardown race condition
commit c8c16d3bae967f1c7af541e8d016e5c51e4f010a upstream.
Under heavy iser target(scst) start/stop stress during login/logout
on iser intitiator side happened trace call provided below.
The function iscsi\_iser\_slave\_alloc iser\_conn pointer could be NULL,
due to the fact that function iscsi\_iser\_conn\_stop can be called before
and free iser connection. Let's protect that flow by introducing global mutex.
BUG: unable to handle kernel paging request at 0000000000001018
IP: [] iscsi\_iser\_slave\_alloc+0x1e/0x50 [ib\_iser]
Call Trace:
? scsi\_alloc\_sdev+0x242/0x300
scsi\_probe\_and\_add\_lun+0x9e1/0xea0
? kfree\_const+0x21/0x30
? kobject\_set\_name\_vargs+0x76/0x90
? \_\_pm\_runtime\_resume+0x5b/0x70
\_\_scsi\_scan\_target+0xf6/0x250
scsi\_scan\_target+0xea/0x100
iscsi\_user\_scan\_session.part.13+0x101/0x130 [scsi\_transport\_iscsi]
? iscsi\_user\_scan\_session.part.13+0x130/0x130 [scsi\_transport\_iscsi]
iscsi\_user\_scan\_session+0x1e/0x30 [scsi\_transport\_iscsi]
device\_for\_each\_child+0x50/0x90
iscsi\_user\_scan+0x44/0x60 [scsi\_transport\_iscsi]
store\_scan+0xa8/0x100
? common\_file\_perm+0x5d/0x1c0
dev\_attr\_store+0x18/0x30
sysfs\_kf\_write+0x37/0x40
kernfs\_fop\_write+0x12c/0x1c0
\_\_vfs\_write+0x18/0x40
vfs\_write+0xb5/0x1a0
SyS\_write+0x55/0xc0
Fixes: 318d311e8f01 ("iser: Accept arbitrary sg lists mapping if the device supports it")
Signed-off-by: Vladimir Neyelov
Signed-off-by: Leon Romanovsky
Reviewed-by: Sagi Grimberg
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 6c0d8c2a408402f2d83a41b141efc2e5e8e604c4
Author: Chen Hong
Date: Sun Jul 2 15:11:10 2017 -0700
Input: i8042 - fix crash at boot time
commit 340d394a789518018f834ff70f7534fc463d3226 upstream.
The driver checks port->exists twice in i8042\_interrupt(), first when
trying to assign temporary "serio" variable, and second time when deciding
whether it should call serio\_interrupt(). The value of port->exists may
change between the 2 checks, and we may end up calling serio\_interrupt()
with a NULL pointer:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
IP: [] \_spin\_lock\_irqsave+0x1f/0x40
PGD 0
Oops: 0002 [#1] SMP
last sysfs file:
CPU 0
Modules linked in:
Pid: 1, comm: swapper Not tainted 2.6.32-358.el6.x86\_64 #1 QEMU Standard PC (i440FX + PIIX, 1996)
RIP: 0010:[] [] \_spin\_lock\_irqsave+0x1f/0x40
RSP: 0018:ffff880028203cc0 EFLAGS: 00010082
RAX: 0000000000010000 RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000282 RSI: 0000000000000098 RDI: 0000000000000050
RBP: ffff880028203cc0 R08: ffff88013e79c000 R09: ffff880028203ee0
R10: 0000000000000298 R11: 0000000000000282 R12: 0000000000000050
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000098
FS: 0000000000000000(0000) GS:ffff880028200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0018 ES: 0018 CR0: 000000008005003b
CR2: 0000000000000050 CR3: 0000000001a85000 CR4: 00000000001407f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process swapper (pid: 1, threadinfo ffff88013e79c000, task ffff88013e79b500)
Stack:
ffff880028203d00 ffffffff813de186 ffffffffffffff02 0000000000000000
 0000000000000000 0000000000000000 0000000000000000 0000000000000098
 ffff880028203d70 ffffffff813e0162 ffff880028203d20 ffffffff8103b8ac
Call Trace:
[] serio\_interrupt+0x36/0xa0
[] i8042\_interrupt+0x132/0x3a0
[] ? kvm\_clock\_read+0x1c/0x20
[] ? kvm\_clock\_get\_cycles+0x9/0x10
[] handle\_IRQ\_event+0x60/0x170
[] ? kvm\_guest\_apic\_eoi\_write+0x44/0x50
[] handle\_edge\_irq+0xde/0x180
[] handle\_irq+0x49/0xa0
[] do\_IRQ+0x6c/0xf0
[] ret\_from\_intr+0x0/0x11
[] ? \_\_do\_softirq+0x73/0x1e0
[] ? hrtimer\_interrupt+0x14b/0x260
[] ? call\_softirq+0x1c/0x30
[] ? do\_softirq+0x65/0xa0
[] ? irq\_exit+0x85/0x90
[] ? smp\_apic\_timer\_interrupt+0x70/0x9b
[] ? apic\_timer\_interrupt+0x13/0x20
To avoid the issue let's change the second check to test whether serio is
NULL or not.
Also, let's take i8042\_lock in i8042\_start() and i8042\_stop() instead of
trying to be overly smart and using memory barriers.
Signed-off-by: Chen Hong
[dtor: take lock in i8042\_start()/i8042\_stop()]
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 165ec230ca5a247d369e7ed60550a089a42ce922
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:15:22 2017 +0100
MIPS: Fix a typo: s/preset/present/ in r2-to-r6 emulation error message
commit 27fe2200dad2de8207a694024a7b9037dff1b280 upstream.
This is a user-visible message, so we want it to be spelled correctly.
Fixes: 5f9f41c474be ("MIPS: kernel: Prepare the JR instruction for emulation on MIPS R6")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16400/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit 9f8928117cce5081a806799d6d09c7b38b4342f6
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:14:12 2017 +0100
MIPS: Send SIGILL for R6 branches in `\_\_compute\_return\_epc\_for\_insn'
commit a60b1a5bf88a250f1a77977c0224e502c901c77b upstream.
Fix:
\* commit 8467ca0122e2 ("MIPS: Emulate the new MIPS R6 branch compact
(BC) instruction"),
\* commit 84fef630127a ("MIPS: Emulate the new MIPS R6 BALC
instruction"),
\* commit 69b9a2fd05a3 ("MIPS: Emulate the new MIPS R6 BEQZC and JIC
instructions"),
\* commit 28d6f93d201d ("MIPS: Emulate the new MIPS R6 BNEZC and JIALC
instructions"),
\* commit c893ce38b265 ("MIPS: Emulate the new MIPS R6 BOVC, BEQC and
BEQZALC instructions")
and send SIGILL rather than returning -SIGILL for R6 branch and jump
instructions. Returning -SIGILL is never correct as the API defines
this function's result upon error to be -EFAULT and a signal actually
issued.
Fixes: 8467ca0122e2 ("MIPS: Emulate the new MIPS R6 branch compact (BC) instruction")
Fixes: 84fef630127a ("MIPS: Emulate the new MIPS R6 BALC instruction")
Fixes: 69b9a2fd05a3 ("MIPS: Emulate the new MIPS R6 BEQZC and JIC instructions")
Fixes: 28d6f93d201d ("MIPS: Emulate the new MIPS R6 BNEZC and JIALC instructions")
Fixes: c893ce38b265 ("MIPS: Emulate the new MIPS R6 BOVC, BEQC and BEQZALC instructions")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16399/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit 4b632ba1ce7e7da15ed03ac25c2dc2c5eabe6cae
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:12:53 2017 +0100
MIPS: Send SIGILL for linked branches in `\_\_compute\_return\_epc\_for\_insn'
commit fef40be6da856afead4177aaa9d869a66fb3381f upstream.
Fix commit 319824eabc3f ("MIPS: kernel: branch: Do not emulate the
branch likelies on MIPS R6") and also send SIGILL rather than returning
-SIGILL for BLTZAL, BLTZALL, BGEZAL and BGEZALL instruction encodings no
longer supported in R6, except where emulated. Returning -SIGILL is
never correct as the API defines this function's result upon error to be
-EFAULT and a signal actually issued.
Fixes: 319824eabc3f ("MIPS: kernel: branch: Do not emulate the branch likelies on MIPS R6")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16398/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit 398cba727d18e84afa7211e6a2d090aee673dcbd
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:09:23 2017 +0100
MIPS: Rename `sigill\_r6' to `sigill\_r2r6' in `\_\_compute\_return\_epc\_for\_insn'
commit 1f4edde422961397cf4470b347958c13c6a740bb upstream.
Use the more accurate `sigill\_r2r6' name for the label used in the case
of sending SIGILL in the absence of the instruction emulator for an
earlier ISA level instruction that has been removed as from the R6 ISA,
so that the `sigill\_r6' name is freed for the situation where an R6
instruction is not supposed to be interpreted, because the executing
processor does not support the R6 ISA.
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16397/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit ba8c4afd162b8921ce146069be65018d82fe0ffd
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:08:29 2017 +0100
MIPS: Send SIGILL for BPOSGE32 in `\_\_compute\_return\_epc\_for\_insn'
commit 7b82c1058ac1f8f8b9f2b8786b1f710a57a870a8 upstream.
Fix commit e50c0a8fa60d ("Support the MIPS32 / MIPS64 DSP ASE.") and
send SIGILL rather than SIGBUS whenever an unimplemented BPOSGE32 DSP
ASE instruction has been encountered in `\_\_compute\_return\_epc\_for\_insn'
as our Reserved Instruction exception handler would in response to an
attempt to actually execute the instruction. Sending SIGBUS only makes
sense for the unaligned PC case, since moved to `\_\_compute\_return\_epc'.
Adjust function documentation accordingly, correct formatting and use
`pr\_info' rather than `printk' as the other exit path already does.
Fixes: e50c0a8fa60d ("Support the MIPS32 / MIPS64 DSP ASE.")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16396/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit d08b3602c71070d4a50a498f8021c4f623b0a61d
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:05:08 2017 +0100
MIPS: math-emu: Prevent wrong ISA mode instruction emulation
commit 13769ebad0c42738831787e27c7c7f982e7da579 upstream.
Terminate FPU emulation immediately whenever an ISA mode switch has been
observed. This is so that we do not interpret machine code in the wrong
mode, for example when a regular MIPS FPU instruction has been placed in
a delay slot of a jump that switches into the MIPS16 mode, as with the
following code (taken from a GCC test suite case):
00400650 :
400650: 3c020100 lui v0,0x100
400654: 03e00008 jr ra
400658: 44c2f800 ctc1 v0,c1\_fcsr
40065c: 00000000 nop
[...]
004012d0 <\_\_libc\_csu\_init>:
4012d0: f000 6a02 li v0,2
4012d4: f150 0b1c la v1,3f9430 <\_DYNAMIC-0x6df0>
4012d8: f400 3240 sll v0,16
4012dc: e269 addu v0,v1
4012de: 659a move gp,v0
4012e0: f00c 64f6 save a0-a2,48,ra,s0-s1
4012e4: 673c move s1,gp
4012e6: f010 9978 lw v1,-32744(s1)
4012ea: d204 sw v0,16(sp)
4012ec: eb40 jalr v1
4012ee: 653b move t9,v1
4012f0: f010 997c lw v1,-32740(s1)
4012f4: f030 9920 lw s1,-32736(s1)
4012f8: e32f subu v1,s1
4012fa: 326b sra v0,v1,2
4012fc: d206 sw v0,24(sp)
4012fe: 220c beqz v0,401318 <\_\_libc\_csu\_init+0x48>
401300: 6800 li s0,0
401302: 99e0 lw a3,0(s1)
401304: 4801 addiu s0,1
401306: 960e lw a2,56(sp)
401308: 4904 addiu s1,4
40130a: 950d lw a1,52(sp)
40130c: 940c lw a0,48(sp)
40130e: ef40 jalr a3
401310: 653f move t9,a3
401312: 9206 lw v0,24(sp)
401314: ea0a cmp v0,s0
401316: 61f5 btnez 401302 <\_\_libc\_csu\_init+0x32>
401318: 6476 restore 48,ra,s0-s1
40131a: e8a0 jrc ra
Here `set\_fast\_math' is called from `40130e' (`40130f' with the ISA bit)
and emulation triggers for the CTC1 instruction. As it is in a jump
delay slot emulation continues from `401312' (`401313' with the ISA
bit). However we have no path to handle MIPS16 FPU code emulation,
because there are no MIPS16 FPU instructions. So the default emulation
path is taken, interpreting a 32-bit word fetched by `get\_user' from
`401313' as a regular MIPS instruction, which is:
401313: f5ea0a92 sdc1 $f10,2706(t7)
This makes the FPU emulator proceed with the supposed SDC1 instruction
and consequently makes the program considered here terminate with
SIGSEGV.
A similar although less severe issue exists with pure-microMIPS
processors in the case where similarly an FPU instruction is emulated in
a delay slot of a register jump that (incorrectly) switches into the
regular MIPS mode. A subsequent instruction fetch from the jump's
target is supposed to cause an Address Error exception, however instead
we proceed with regular MIPS FPU emulation.
For simplicity then, always terminate the emulation loop whenever a mode
change is detected, denoted by an ISA mode bit flip. As from commit
377cb1b6c16a ("MIPS: Disable MIPS16/microMIPS crap for platforms not
supporting these ASEs.") the result of `get\_isa16\_mode' can be hardcoded
to 0, so we need to examine the ISA mode bit by hand.
This complements commit 102cedc32a6e ("MIPS: microMIPS: Floating point
support.") which added JALX decoding to FPU emulation.
Fixes: 102cedc32a6e ("MIPS: microMIPS: Floating point support.")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16393/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit e6f5164e9dc6a74aa6a87d00ac12b36c94072a7c
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:07:34 2017 +0100
MIPS: Fix unaligned PC interpretation in `compute\_return\_epc'
commit 11a3799dbeb620bf0400b1fda5cc2c6bea55f20a upstream.
Fix a regression introduced with commit fb6883e5809c ("MIPS: microMIPS:
Support handling of delay slots.") and defer to `\_\_compute\_return\_epc'
if the ISA bit is set in EPC with non-MIPS16, non-microMIPS hardware,
which will then arrange for a SIGBUS due to an unaligned instruction
reference. Returning EPC here is never correct as the API defines this
function's result to be either a negative error code on failure or one
of 0 and BRANCH\_LIKELY\_TAKEN on success.
Fixes: fb6883e5809c ("MIPS: microMIPS: Support handling of delay slots.")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16395/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit aa55f60181455ddfb6eb10af9ea07aa1879304ea
Author: Maciej W. Rozycki
Date: Fri Jun 16 00:06:19 2017 +0100
MIPS: Actually decode JALX in `\_\_compute\_return\_epc\_for\_insn'
commit a9db101b735a9d49295326ae41f610f6da62b08c upstream.
Complement commit fb6883e5809c ("MIPS: microMIPS: Support handling of
delay slots.") and actually decode the regular MIPS JALX major
instruction opcode, the handling of which has been added with the said
commit for EPC calculation in `\_\_compute\_return\_epc\_for\_insn'.
Fixes: fb6883e5809c ("MIPS: microMIPS: Support handling of delay slots.")
Signed-off-by: Maciej W. Rozycki
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16394/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit af0a820b702bdc65cf5b69a5ad66921ff0f395de
Author: James Hogan
Date: Wed May 31 16:19:48 2017 +0100
MIPS: Save static registers before sysmips
commit 49955d84cd9ccdca5a16a495e448e1a06fad9e49 upstream.
The MIPS sysmips system call handler may return directly from the
MIPS\_ATOMIC\_SET case (mips\_atomic\_set()) to syscall\_exit. This path
restores the static (callee saved) registers, however they won't have
been saved on entry to the system call.
Use the save\_static\_function() macro to create a \_\_sys\_sysmips wrapper
function which saves the static registers before calling sys\_sysmips, so
that the correct static register state is restored by syscall\_exit.
Fixes: f1e39a4a616c ("MIPS: Rewrite sysmips(MIPS\_ATOMIC\_SET, ...) in C with inline assembler")
Signed-off-by: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16149/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit a3628492ad416a430b713803e4a2e74bda3ad079
Author: Maciej W. Rozycki
Date: Sat Jul 8 23:24:44 2017 +0100
MIPS: Fix MIPS I ISA /proc/cpuinfo reporting
commit e5f5a5b06e51a36f6ddf31a4a485358263953a3d upstream.
Correct a commit 515a6393dbac ("MIPS: kernel: proc: Add MIPS R6 support
to /proc/cpuinfo") regression that caused MIPS I systems to show no ISA
levels supported in /proc/cpuinfo, e.g.:
system type : Digital DECstation 2100/3100
machine : Unknown
processor : 0
cpu model : R3000 V2.0 FPU V2.0
BogoMIPS : 10.69
wait instruction : no
microsecond timers : no
tlb\_entries : 64
extra interrupt vector : no
hardware watchpoint : no
isa :
ASEs implemented :
shadow register sets : 1
kscratch registers : 0
package : 0
core : 0
VCED exceptions : not available
VCEI exceptions : not available
and similarly exclude `mips1' from the ISA list for any processors below
MIPSr1. This is because the condition to show `mips1' on has been made
`cpu\_has\_mips\_r1' rather than newly-introduced `cpu\_has\_mips\_1'. Use
the correct condition then.
Fixes: 515a6393dbac ("MIPS: kernel: proc: Add MIPS R6 support to /proc/cpuinfo")
Signed-off-by: Maciej W. Rozycki
Reviewed-by: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16758/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit add5830302906758cc97f01bc1bfa0065d405379
Author: Seunghun Han
Date: Tue Jul 18 18:20:44 2017 +0900
x86/ioapic: Pass the correct data to unmask\_ioapic\_irq()
commit e708e35ba6d89ff785b225cd07dcccab04fa954a upstream.
One of the rarely executed code pathes in check\_timer() calls
unmask\_ioapic\_irq() passing irq\_get\_chip\_data(0) as argument.
That's wrong as unmask\_ioapic\_irq() expects a pointer to the irq data of
interrupt 0. irq\_get\_chip\_data(0) returns NULL, so the following
dereference in unmask\_ioapic\_irq() causes a kernel panic.
The issue went unnoticed in the first place because irq\_get\_chip\_data()
returns a void pointer so the compiler cannot do a type check on the
argument. The code path was added for machines with broken configuration,
but it seems that those machines are either not running current kernels or
simply do not longer exist.
Hand in irq\_get\_irq\_data(0) as argument which provides the correct data.
[ tglx: Rewrote changelog ]
Fixes: 4467715a44cc ("x86/irq: Move irq\_cfg.irq\_2\_pin into io\_apic.c")
Signed-off-by: Seunghun Han
Signed-off-by: Thomas Gleixner
Link: http://lkml.kernel.org/r/1500369644-45767-1-git-send-email-kkamagui@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 464c38d4b9365fb013c568a391a7c89b7148d72a
Author: Seunghun Han
Date: Tue Jul 18 20:03:51 2017 +0900
x86/acpi: Prevent out of bound access caused by broken ACPI tables
commit dad5ab0db8deac535d03e3fe3d8f2892173fa6a4 upstream.
The bus\_irq argument of mp\_override\_legacy\_irq() is used as the index into
the isa\_irq\_to\_gsi[] array. The bus\_irq argument originates from
ACPI\_MADT\_TYPE\_IO\_APIC and ACPI\_MADT\_TYPE\_INTERRUPT items in the ACPI
tables, but is nowhere sanity checked.
That allows broken or malicious ACPI tables to overwrite memory, which
might cause malfunction, panic or arbitrary code execution.
Add a sanity check and emit a warning when that triggers.
[ tglx: Added warning and rewrote changelog ]
Signed-off-by: Seunghun Han
Signed-off-by: Thomas Gleixner
Cc: security@kernel.org
Cc: "Rafael J. Wysocki"
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit e6da6d162ce5b052f4481d4b5d6aee9c94cfd60a
Author: Lv Zheng
Date: Wed Jul 12 11:09:17 2017 +0800
Revert "ACPI / EC: Enable event freeze mode..." to fix a regression
commit 9c40f956ce9b331493347d1b3cb7e384f7dc0581 upstream.
On Lenovo ThinkPad X1 Carbon - the 5th Generation, enabling an earlier
EC event freezing timing causes acpitz-virtual-0 to report a stuck
48C temparature. And with EC firmware revisioned as 1.14, without
reverting back to old EC event freezing timing, the fan still blows
up after a system resume.
This reverts the culprit change so that the regression can be fixed
without upgrading the EC firmware.
Fixes: d30283057ecd (ACPI / EC: Enable event freeze mode to improve event handling)
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=191181#c168
Tested-by: Damjan Georgievski
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 5f4556a4e0d27f651e427e2ab06972d3548a0426
Author: Lv Zheng
Date: Wed Jul 12 11:09:09 2017 +0800
ACPI / EC: Drop EC noirq hooks to fix a regression
commit 662591461c4b9a1e3b9b159dbf37648a585ebaae upstream.
According to bug reports, although the busy polling mode can make
noirq stages execute faster, it causes abnormal fan blowing up after
system resume (see the first link below for a video demonstration)
on Lenovo ThinkPad X1 Carbon - the 5th Generation. The problem can
be fixed by upgrading the EC firmware on that machine.
However, many reporters confirm that the problem can be fixed by
stopping busy polling during suspend/resume and for some of them
upgrading the EC firmware is not an option.
For this reason, drop the noirq stage hooks from the EC driver
to fix the regression.
Fixes: c3a696b6e8f8 (ACPI / EC: Use busy polling mode when GPE is not enabled)
Link: https://youtu.be/9NQ9x-Jm99Q
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=196129
Reported-by: Andreas Lindhe
Tested-by: Gjorgji Jankovski
Tested-by: Damjan Georgievski
Tested-by: Fernando Chaves
Tested-by: Tomislav Ivek
Tested-by: Denis P.
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit cc66888fbf58faf603358db6fe31bc9a03ce0416
Author: Richard Weinberger
Date: Mon Jun 26 13:49:04 2017 +0200
ubifs: Set double hash cookie also for RENAME\_EXCHANGE
commit a6664433d383eeb71cbdeb9aea2c66eeea76e742 upstream.
We developed RENAME\_EXCHANGE and UBIFS\_FLG\_DOUBLE\_HASH more or less in
parallel and this case was forgotten. :-(
Fixes: d63d61c16972 ("ubifs: Implement UBIFS\_FLG\_DOUBLE\_HASH")
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit cd152e6e347c6c6311877e40a75eee37cf00be43
Author: David Gstir
Date: Wed May 17 13:36:16 2017 +0200
ubifs: Don't encrypt special files on creation
commit f34e87f58dabc31eb69f61cf4a79e951d4176743 upstream.
When a new inode is created, we check if the containing folder has a encryption
policy set and inherit that. This should however only be done for regular
files, links and subdirectories. Not for sockes fifos etc.
Fixes: d475a507457b ("ubifs: Add skeleton for fscrypto")
Signed-off-by: David Gstir
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 53f10329dd0e56015ea2d4d839d33b38b3ee68d0
Author: Richard Weinberger
Date: Fri Jun 16 16:21:44 2017 +0200
ubifs: Don't leak kernel memory to the MTD
commit 4acadda74ff8b949c448c0282765ae747e088c87 upstream.
When UBIFS prepares data structures which will be written to the MTD it
ensues that their lengths are multiple of 8. Since it uses kmalloc() the
padded bytes are left uninitialized and we leak a few bytes of kernel
memory to the MTD.
To make sure that all bytes are initialized, let's switch to kzalloc().
Kzalloc() is fine in this case because the buffers are not huge and in
the IO path the performance bottleneck is anyway the MTD.
Fixes: 1e51764a3c2a ("UBIFS: add new flash file system")
Signed-off-by: Richard Weinberger
Reviewed-by: Boris Brezillon
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit caffe745a1e508f2e5840568451eaef101bfa430
Author: Richard Weinberger
Date: Wed May 17 00:20:27 2017 +0200
ubifs: Correctly evict xattr inodes
commit 272eda8298dc82eb411ece82bbb2c62911087b24 upstream.
UBIFS handles extended attributes just like files, as consequence of
that, they also have inodes.
Therefore UBIFS does all the inode machinery also for xattrs. Since new
inodes have i\_nlink of 1, a file or xattr inode will be evicted
if i\_nlink goes down to 0 after an unlink. UBIFS assumes this model also
for xattrs, which is not correct.
One can create a file "foo" with xattr "user.test". By reading
"user.test" an inode will be created, and by deleting "user.test" it
will get evicted later. The assumption breaks if the file "foo", which
hosts the xattrs, will be removed. VFS nor UBIFS does not remove each
xattr via ubifs\_xattr\_remove(), it just removes the host inode from
the TNC and all underlying xattr nodes too and the inode will remain
in the cache and wastes memory.
To solve this problem, remove xattr inodes from the VFS inode cache in
ubifs\_xattr\_remove() to make sure that they get evicted.
Fixes: 1e51764a3c2ac05a ("UBIFS: add new flash file system")
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 012e56c5e4662b6c91db4c0651399a9d83ede77f
Author: Boris Brezillon
Date: Wed May 17 10:47:50 2017 +0200
mtd: nand: tango: Fix incorrect use of SEQIN command
commit a186493237a9d8559997c2f97c33c4716d602fd2 upstream.
SEQIN is supposed to be used when one wants to start programming a page.
What we want here is just to change the column within the page, which is
done with the RNDIN command.
Fixes: 6956e2385a16 ("mtd: nand: add tango NAND flash controller support")
Signed-off-by: Boris Brezillon
Acked-by: Marc Gonzalez
Signed-off-by: Greg Kroah-Hartman
commit 6b7483630f431c8e773f457e6ee87c8844031b71
Author: James Hogan
Date: Thu Jun 29 10:12:34 2017 +0100
MIPS: Negate error syscall return in trace
commit 4f32a39d49b25eaa66d2420f1f03d371ea4cd906 upstream.
The sys\_exit trace event takes a single return value for the system
call, which MIPS passes the value of the $v0 (result) register, however
MIPS returns positive error codes in $v0 with $a3 specifying that $v0
contains an error code. As a result erroring system calls are traced
returning positive error numbers that can't always be distinguished from
success.
Use regs\_return\_value() to negate the error code if $a3 is set.
Fixes: 1d7bf993e073 ("MIPS: ftrace: Add support for syscall tracepoints.")
Signed-off-by: James Hogan
Cc: Steven Rostedt
Cc: Ingo Molnar
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16651/
Acked-by: Steven Rostedt (VMware)
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit f5dc58618d76476591d34d6f7b67b76a7376e730
Author: James Hogan
Date: Wed May 31 16:19:49 2017 +0100
MIPS: Fix mips\_atomic\_set() with EVA
commit 4915e1b043d6286928207b1f6968197b50407294 upstream.
EVA linked loads (LLE) and conditional stores (SCE) should be used on
EVA kernels for the MIPS\_ATOMIC\_SET operation of the sysmips system
call, or else the atomic set will apply to the kernel view of the
virtual address space (potentially unmapped on EVA kernels) rather than
the user view (TLB mapped).
Signed-off-by: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16151/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit e742bca1a23d3fd7c966e569a199304b420a66e1
Author: James Hogan
Date: Wed May 31 16:19:47 2017 +0100
MIPS: Fix mips\_atomic\_set() retry condition
commit 2ec420b26f7b6ff332393f0bb5a7d245f7ad87f0 upstream.
The inline asm retry check in the MIPS\_ATOMIC\_SET operation of the
sysmips system call has been backwards since commit f1e39a4a616c ("MIPS:
Rewrite sysmips(MIPS\_ATOMIC\_SET, ...) in C with inline assembler")
merged in v2.6.32, resulting in the non R10000\_LLSC\_WAR case retrying
until the operation was inatomic, before returning the new value that
was probably just written multiple times instead of the old value.
Invert the branch condition to fix that particular issue.
Fixes: f1e39a4a616c ("MIPS: Rewrite sysmips(MIPS\_ATOMIC\_SET, ...) in C with inline assembler")
Signed-off-by: James Hogan
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/16148/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit 82823554d21b8389c58246b1d8ecb5f06bc0877e
Author: Maarten Lankhorst
Date: Thu Jun 29 13:59:54 2017 +0200
drm/atomic: Add missing drm\_atomic\_state\_clear to atomic\_remove\_fb
commit 4086d90cffb8f48400d51fbab575fe50458512e3 upstream.
All atomic state should be cleared when drm\_modeset\_backoff() is
called, because it drops all locks and the state becomes invalid.
The call to drm\_atomic\_state\_clear was missing in atomic\_remove\_fb,
so add the missing call there.
Signed-off-by: Maarten Lankhorst
Link: http://patchwork.freedesktop.org/patch/msgid/20170629115954.26029-1-maarten.lankhorst@linux.intel.com
Reviewed-by: Daniel Vetter
Fixes: db8f6403e88a ("drm: Convert drm\_framebuffer\_remove to atomic, v4.")
Signed-off-by: Greg Kroah-Hartman
commit 254084986a8a30b2b56979da9ddd32dc211c0b2e
Author: Chuanxiao Dong
Date: Mon Jun 26 15:20:50 2017 +0800
drm/i915/gvt: Fix inconsistent locks holding sequence
commit f16bd3dda2c8bf6699e808cd9cc540cfab10e60e upstream.
There are two kinds of locking sequence.
One is in the thread which is started by vfio ioctl to do
the iommu unmapping. The locking sequence is:
down\_read(&group\_lock) ----> mutex\_lock(&cached\_lock)
The other is in the vfio release thread which will unpin all
the cached pages. The lock sequence is:
mutex\_lock(&cached\_lock) ---> down\_read(&group\_lock)
And, the cache\_lock is used to protect the rb tree of the cache
node and doing vfio unpin doesn't require this lock. Move the
vfio unpin out of the cache\_lock protected region.
v2:
- use for style instead of do{}while(1). (Zhenyu)
Fixes: f30437c5e7bf ("drm/i915/gvt: add KVMGT support")
Signed-off-by: Chuanxiao Dong
Cc: Zhenyu Wang
Signed-off-by: Zhenyu Wang
Signed-off-by: Greg Kroah-Hartman
commit 6dbeea7da557039d234b56045ee6966fd0410900
Author: Robin Murphy
Date: Mon Jun 19 16:41:56 2017 +0100
iommu/arm-smmu: Plumb in new ACPI identifiers
commit 84c24379a783c514e5ff7c8fc8a21cf8d64fd05f upstream.
Revision C of IORT now allows us to identify ARM MMU-401 and the Cavium
ThunderX implementation. Wire them up so that we can probe these models
once firmware starts using the new codes in place of generic ones, and
so that the appropriate features and quirks get enabled when we do.
For the sake of backports and mitigating sychronisation problems with
the ACPICA headers, we'll carry a backup copy of the new definitions
locally for the short term to make life simpler.
Acked-by: Robert Richter
Tested-by: Robert Richter
Signed-off-by: Robin Murphy
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 57c2c7dfa049e5a4ab473b1dee8283f39fc6cafd
Author: Dan Carpenter
Date: Wed Jul 12 10:35:57 2017 +0300
ftrace: Fix uninitialized variable in match\_records()
commit 2e028c4fe12907f226b8221815f16c2486ad3aa7 upstream.
My static checker complains that if "func" is NULL then "clear\_filter"
is uninitialized. This seems like it could be true, although it's
possible something subtle is happening that I haven't seen.
kernel/trace/ftrace.c:3844 match\_records()
error: uninitialized symbol 'clear\_filter'.
Link: http://lkml.kernel.org/r/20170712073556.h6tkpjcdzjaozozs@mwanda
Fixes: f0a3b154bd7 ("ftrace: Clarify code for mod command")
Signed-off-by: Dan Carpenter
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 3ea54f661fe397cba602a69d9d69891dc0ca702a
Author: Marta Rybczynska
Date: Tue Jun 6 13:27:21 2017 +0200
nvme-rdma: remove race conditions from IB signalling
commit 5e599d73c1c1816af07f94ddba879499aa39b43c upstream.
This patch improves the way the RDMA IB signalling is done by using atomic
operations for the signalling variable. This avoids race conditions on
sig\_count.
The signalling interval changes slightly and is now the largest power of
two not larger than queue depth / 2.
ilog() usage idea by Bart Van Assche.
Signed-off-by: Marta Rybczynska
Reviewed-by: Sagi Grimberg
Signed-off-by: Christoph Hellwig
Signed-off-by: Greg Kroah-Hartman
commit 5a5e706f1168ef66cd2a36e3a6460063d9380759
Author: Alex Williamson
Date: Fri Jul 7 15:37:38 2017 -0600
vfio: Remove unnecessary uses of vfio\_container.group\_lock
commit 7f56c30bd0a232822aca38d288da475613bdff9b upstream.
The original intent of vfio\_container.group\_lock is to protect
vfio\_container.group\_list, however over time it's become a crutch to
prevent changes in container composition any time we call into the
iommu driver backend. This introduces problems when we start to have
more complex interactions, for example when a user's DMA unmap request
triggers a notification to an mdev vendor driver, who responds by
attempting to unpin mappings within that request, re-entering the
iommu backend. We incorrectly assume that the use of read-locks here
allow for this nested locking behavior, but a poorly timed write-lock
could in fact trigger a deadlock.
The current use of group\_lock seems to fall into the trap of locking
code, not data. Correct that by removing uses of group\_lock that are
not directly related to group\_list. Note that the vfio type1 iommu
backend has its own mutex, vfio\_iommu.lock, which it uses to protect
itself for each of these interfaces anyway. The group\_lock appears to
be a redundancy for these interfaces and type1 even goes so far as to
release its mutex to allow for exactly the re-entrant code path above.
Reported-by: Chuanxiao Dong
Signed-off-by: Alex Williamson
Acked-by: Alexey Kardashevskiy
Signed-off-by: Greg Kroah-Hartman
commit 9ffc6fc6c2add85e06921f6f26b0204bfc407016
Author: Alex Williamson
Date: Wed Jun 28 13:50:05 2017 -0600
vfio: New external user group/file match
commit 5d6dee80a1e94cc284d03e06d930e60e8d3ecf7d upstream.
At the point where the kvm-vfio pseudo device wants to release its
vfio group reference, we can't always acquire a new reference to make
that happen. The group can be in a state where we wouldn't allow a
new reference to be added. This new helper function allows a caller
to match a file to a group to facilitate this. Given a file and
group, report if they match. Thus the caller needs to already have a
group reference to match to the file. This allows the deletion of a
group without acquiring a new reference.
Signed-off-by: Alex Williamson
Reviewed-by: Eric Auger
Reviewed-by: Paolo Bonzini
Tested-by: Eric Auger
Signed-off-by: Greg Kroah-Hartman
commit 4fb3d76fcac31d2f9423bb8021030ac22bc552ec
Author: Alex Williamson
Date: Mon Jun 19 09:10:32 2017 -0600
vfio: Fix group release deadlock
commit 811642d8d8a82c0cce8dc2debfdaf23c5a144839 upstream.
If vfio\_iommu\_group\_notifier() acquires a group reference and that
reference becomes the last reference to the group, then vfio\_group\_put
introduces a deadlock code path where we're trying to unregister from
the iommu notifier chain from within a callout of that chain. Use a
work\_struct to release this reference asynchronously.
Signed-off-by: Alex Williamson
Reviewed-by: Eric Auger
Tested-by: Eric Auger
Signed-off-by: Greg Kroah-Hartman
commit 72ec4c2f63204a41b4e559940d82f02e981f89e4
Author: Ville Syrjälä
Date: Mon Jun 26 23:30:51 2017 +0300
drm/i915: Disable MSI for all pre-gen5
commit ce3f7163e4ce8fd583dcb36b6ee6b81fd1b419ae upstream.
We have pretty clear evidence that MSIs are getting lost on g4x and
somehow the interrupt logic doesn't seem to recover from that state
even if we try hard to clear the IIR.
Disabling IER around the normal IIR clearing in the irq handler isn't
sufficient to avoid this, so the problem really seems to be further
up the interrupt chain. This should guarantee that there's always
an edge if any IIR bits are set after the interrupt handler is done,
which should normally guarantee that the CPU interrupt is generated.
That approach seems to work perfectly on VLV/CHV, but apparently
not on g4x.
MSI is documented to be broken on 965gm at least. The chipset spec
says MSI is defeatured because interrupts can be delayed or lost,
which fits well with what we're seeing on g4x. Previously we've
already disabled GMBUS interrupts on g4x because somehow GMBUS
manages to raise legacy interrupts even when MSI is enabled.
Since there's such widespread MSI breakahge all over in the pre-gen5
land let's just give up on MSI on these platforms.
Seqno reporting might be negatively affected by this since the legcy
interrupts aren't guaranteed to be ordered with the seqno writes,
whereas MSI interrupts may be? But an occasioanlly missed seqno
seems like a small price to pay for generally working interrupts.
Cc: Diego Viola
Tested-by: Diego Viola
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=101261
Signed-off-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/20170626203051.28480-1-ville.syrjala@linux.intel.com
Reviewed-by: Daniel Vetter
(cherry picked from commit e38c2da01f76cca82b59ca612529b81df82a7cc7)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 7d47d0b933827469b3338607cff56dd8306d0564
Author: Hawking Zhang
Date: Tue Jun 6 16:25:44 2017 +0800
drm/amd/powerplay: fix memory leak in cz\_hwmgr backend
commit b1e8b9c5b19c58e3159c2acc77167f4a4c74621f upstream.
vddc\_dep\_on\_dal\_pwrl is allocated and initialized in cz\_hwmgr\_backend\_init
Thus free the memory in cz\_hwmgr\_backend\_fini
Signed-off-by: Hawking Zhang
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 98cc417e0b95d8cf2baeba5a2159d46be2e0941c
Author: Amir Goldstein
Date: Tue Jul 11 15:58:35 2017 +0300
ovl: fix random return value on mount
commit 8fc646b44385ff0a9853f6590497e43049eeb311 upstream.
On failure to prepare\_creds(), mount fails with a random
return value, as err was last set to an integer cast of
a valid lower mnt pointer or set to 0 if inodes index feature
is enabled.
Reported-by: Dan Carpenter
Fixes: 3fe6e52f0626 ("ovl: override creds with the ones from ...")
Signed-off-by: Amir Goldstein
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit aedd116d5a5993cb5ece0eeecb97f828413e742a
Author: Amir Goldstein
Date: Tue Jul 11 15:58:34 2017 +0300
ovl: mark parent impure on ovl\_link()
commit ea3dad18dc5f778cfd931311a91a9315aa0065a3 upstream.
When linking a file with copy up origin into a new parent, mark the
new parent dir "impure".
Fixes: ee1d6d37b6b8 ("ovl: mark upper dir with type origin entries "impure"")
Signed-off-by: Amir Goldstein
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 6a2c416963bc43ca5513770624b78be80561f800
Author: Dan Carpenter
Date: Mon Jul 17 11:34:23 2017 +0300
serial: sh-sci: Uninitialized variables in sysfs files
commit 4ab3c51e0540ba8464fe34d84cc35821bb77ae92 upstream.
The kstrtol() function returns -ERANGE as well as -EINVAL so these tests
are not enough. It's not a super serious bug, but my static checker
correctly complains that the "r" variable might be used uninitialized.
Fixes: 5d23188a473d ("serial: sh-sci: make RX FIFO parameters tunable via sysfs")
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit bc6ff930b39ce2d5e8d122211b92480564ab0b7e
Author: Dan Carpenter
Date: Mon Jul 17 11:12:38 2017 +0300
serial: st-asc: Potential error pointer dereference
commit 2b01bfaeb41e1563322448d9b392ac924cbf22ef upstream.
It looks like we intended to return an error code here, because we
dereference "ascport->pinctrl" on the next lines.
Fixes: 6929cb00a501 ("serial: st-asc: Read in all Pinctrl states")
Signed-off-by: Dan Carpenter
Acked-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit 893425c7201c6029d855219d14746841c8592cba
Author: Jaegeuk Kim
Date: Tue Jul 11 14:56:49 2017 -0700
f2fs: Don't clear SGID when inheriting ACLs
commit c925dc162f770578ff4a65ec9b08270382dba9e6 upstream.
This patch copies commit b7f8a09f80:
"btrfs: Don't clear SGID when inheriting ACLs" written by Jan.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
Signed-off-by: Jan Kara
Reviewed-by: Chao Yu
Reviewed-by: Jan Kara
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 65483db1a6492c52698c72f7010f83e7fd755e7d
Author: Chao Yu
Date: Fri Jul 7 14:10:15 2017 +0800
f2fs: use spin\_{,un}lock\_irq{save,restore}
commit d1aa245354ae4605d1183f542ed8d45811c439f6 upstream.
generic/361 reports below warning, this is because: once, there is
someone entering into critical region of sbi.cp\_lock, if write\_end\_io.
f2fs\_stop\_checkpoint is invoked from an triggered IRQ, we will encounter
deadlock.
So this patch changes to use spin\_{,un}lock\_irq{save,restore} to create
critical region without IRQ enabled to avoid potential deadlock.
irq event stamp: 83391573
loop: Write error at byte offset 438729728, length 1024.
hardirqs last enabled at (83391573): [] restore\_all+0xf/0x65
hardirqs last disabled at (83391572): [] reschedule\_interrupt+0x30/0x3c
loop: Write error at byte offset 438860288, length 1536.
softirqs last enabled at (83389244): [] \_\_do\_softirq+0x1ae/0x476
softirqs last disabled at (83389237): [] do\_softirq\_own\_stack+0x2c/0x40
loop: Write error at byte offset 438990848, length 2048.
================================
WARNING: inconsistent lock state
4.12.0-rc2+ #30 Tainted: G O
--------------------------------
inconsistent {HARDIRQ-ON-W} -> {IN-HARDIRQ-W} usage.
xfs\_io/7959 [HC1[1]:SC0[0]:HE0:SE1] takes:
(&(&sbi->cp\_lock)->rlock){?.+...}, at: [] f2fs\_stop\_checkpoint+0x1c/0x50 [f2fs]
{HARDIRQ-ON-W} state was registered at:
\_\_lock\_acquire+0x527/0x7b0
lock\_acquire+0xae/0x220
\_raw\_spin\_lock+0x42/0x50
do\_checkpoint+0x165/0x9e0 [f2fs]
write\_checkpoint+0x33f/0x740 [f2fs]
\_\_f2fs\_sync\_fs+0x92/0x1f0 [f2fs]
f2fs\_sync\_fs+0x12/0x20 [f2fs]
sync\_filesystem+0x67/0x80
generic\_shutdown\_super+0x27/0x100
kill\_block\_super+0x22/0x50
kill\_f2fs\_super+0x3a/0x40 [f2fs]
deactivate\_locked\_super+0x3d/0x70
deactivate\_super+0x40/0x60
cleanup\_mnt+0x39/0x70
\_\_cleanup\_mnt+0x10/0x20
task\_work\_run+0x69/0x80
exit\_to\_usermode\_loop+0x57/0x85
do\_fast\_syscall\_32+0x18c/0x1b0
entry\_SYSENTER\_32+0x4c/0x7b
irq event stamp: 1957420
hardirqs last enabled at (1957419): [] \_raw\_spin\_unlock\_irq+0x27/0x50
hardirqs last disabled at (1957420): [] call\_function\_single\_interrupt+0x30/0x3c
softirqs last enabled at (1953784): [] \_\_do\_softirq+0x1ae/0x476
softirqs last disabled at (1953773): [] do\_softirq\_own\_stack+0x2c/0x40
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(&(&sbi->cp\_lock)->rlock);
lock(&(&sbi->cp\_lock)->rlock);
\*\*\* DEADLOCK \*\*\*
2 locks held by xfs\_io/7959:
#0: (sb\_writers#13){.+.+.+}, at: [] vfs\_write+0x16a/0x190
#1: (&sb->s\_type->i\_mutex\_key#16){+.+.+.}, at: [] f2fs\_file\_write\_iter+0x25/0x140 [f2fs]
stack backtrace:
CPU: 2 PID: 7959 Comm: xfs\_io Tainted: G O 4.12.0-rc2+ #30
Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
Call Trace:
dump\_stack+0x5f/0x92
print\_usage\_bug+0x1d3/0x1dd
? check\_usage\_backwards+0xe0/0xe0
mark\_lock+0x23d/0x280
\_\_lock\_acquire+0x699/0x7b0
? \_\_this\_cpu\_preempt\_check+0xf/0x20
? trace\_hardirqs\_off\_caller+0x91/0xe0
lock\_acquire+0xae/0x220
? f2fs\_stop\_checkpoint+0x1c/0x50 [f2fs]
\_raw\_spin\_lock+0x42/0x50
? f2fs\_stop\_checkpoint+0x1c/0x50 [f2fs]
f2fs\_stop\_checkpoint+0x1c/0x50 [f2fs]
f2fs\_write\_end\_io+0x147/0x150 [f2fs]
bio\_endio+0x7a/0x1e0
blk\_update\_request+0xad/0x410
blk\_mq\_end\_request+0x16/0x60
lo\_complete\_rq+0x3c/0x70
\_\_blk\_mq\_complete\_request\_remote+0x11/0x20
flush\_smp\_call\_function\_queue+0x6d/0x120
? debug\_smp\_processor\_id+0x12/0x20
generic\_smp\_call\_function\_single\_interrupt+0x12/0x30
smp\_call\_function\_single\_interrupt+0x25/0x40
call\_function\_single\_interrupt+0x37/0x3c
EIP: \_raw\_spin\_unlock\_irq+0x2d/0x50
EFLAGS: 00000296 CPU: 2
EAX: 00000001 EBX: d2ccc51c ECX: 00000001 EDX: c1aacebd
ESI: 00000000 EDI: 00000000 EBP: c96c9d1c ESP: c96c9d18
DS: 007b ES: 007b FS: 00d8 GS: 0033 SS: 0068
? inherit\_task\_group.isra.98.part.99+0x6b/0xb0
\_\_add\_to\_page\_cache\_locked+0x1d4/0x290
add\_to\_page\_cache\_lru+0x38/0xb0
pagecache\_get\_page+0x8e/0x200
f2fs\_write\_begin+0x96/0xf00 [f2fs]
? trace\_hardirqs\_on\_caller+0xdd/0x1c0
? current\_time+0x17/0x50
? trace\_hardirqs\_on+0xb/0x10
generic\_perform\_write+0xa9/0x170
\_\_generic\_file\_write\_iter+0x1a2/0x1f0
? f2fs\_preallocate\_blocks+0x137/0x160 [f2fs]
f2fs\_file\_write\_iter+0x6e/0x140 [f2fs]
? \_\_lock\_acquire+0x429/0x7b0
\_\_vfs\_write+0xc1/0x140
vfs\_write+0x9b/0x190
SyS\_pwrite64+0x63/0xa0
do\_fast\_syscall\_32+0xa1/0x1b0
entry\_SYSENTER\_32+0x4c/0x7b
EIP: 0xb7786c61
EFLAGS: 00000293 CPU: 2
EAX: ffffffda EBX: 00000003 ECX: 08416000 EDX: 00001000
ESI: 18b24000 EDI: 00000000 EBP: 00000003 ESP: bf9b36b0
DS: 007b ES: 007b FS: 0000 GS: 0033 SS: 007b
Fixes: aaec2b1d1879 ("f2fs: introduce cp\_lock to protect updating of ckpt\_flags")
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit d0f0ccf8f4c246f36ff06c9b409f9cae1630bea6
Author: Jin Qian
Date: Thu Jun 1 11:18:30 2017 -0700
f2fs: sanity check size of nat and sit cache
commit 21d3f8e1c3b7996ce239ab6fa82e9f7a8c47d84d upstream.
Make sure number of entires doesn't exceed max journal size.
Signed-off-by: Jin Qian
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit dca54568b79d67bb736ea9dc272c460d4a488c0b
Author: Damien Le Moal
Date: Fri May 26 17:04:40 2017 +0900
f2fs: Do not issue small discards in LFS mode
commit acfd2810c75b0625897fc119a2d3a9c26cc0e405 upstream.
clear\_prefree\_segments() issues small discards after discarding full
segments. These small discards may not be section aligned, so not zone
aligned on a zoned block device, causing \_\_f2fs\_iissue\_discard\_zone() to fail.
Fix this by not issuing small discards for a volume mounted with the BLKZONED
feature enabled.
Signed-off-by: Damien Le Moal
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 4567789d3343fd56ff5b1afa096634ff89d0d670
Author: Jaegeuk Kim
Date: Wed May 17 10:36:58 2017 -0700
f2fs: try to freeze in gc and discard threads
commit 1d7be2708277edfef95171d52fb65ee26eaa076b upstream.
This allows to freeze gc and discard threads.
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 55df2e68c21714444fc3056c5636531ee9d1bc58
Author: Jin Qian
Date: Mon May 15 10:45:08 2017 -0700
f2fs: sanity check checkpoint segno and blkoff
commit 15d3042a937c13f5d9244241c7a9c8416ff6e82a upstream.
Make sure segno and blkoff read from raw image are valid.
Signed-off-by: Jin Qian
[Jaegeuk Kim: adjust minor coding style]
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 378560b8c2b3560263b6b56a4d5fe8d2b4931f0e
Author: Chao Yu
Date: Fri May 19 23:46:44 2017 +0800
f2fs: wake up all waiters in f2fs\_submit\_discard\_endio
commit e31b98215779e66a490471c6ad886ae231316699 upstream.
There could be more than one waiter waiting discard IO completion, so we
need use complete\_all() instead of complete() in f2fs\_submit\_discard\_endio
to avoid hungtask.
Fixes: ec9895add2c5 ("f2fs: don't hold cmd\_lock during waiting discard
command")
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 9aabcf47906df581f57a9c5b3e617e0c18b3fd7a
Author: Jaegeuk Kim
Date: Tue May 16 13:20:16 2017 -0700
f2fs: load inode's flag from disk
commit 93607124c5450148e592c3d18ac533b4e5f25b8b upstream.
This patch fixes missing inode flag loaded from disk, reported by Tom.
[tom@localhost ~]$ sudo mount /dev/loop0 /mnt/
[tom@localhost ~]$ sudo chown tom:tom /mnt/
[tom@localhost ~]$ touch /mnt/testfile
[tom@localhost ~]$ sudo chattr +i /mnt/testfile
[tom@localhost ~]$ echo test > /mnt/testfile
bash: /mnt/testfile: Operation not permitted
[tom@localhost ~]$ rm /mnt/testfile
rm: cannot remove '/mnt/testfile': Operation not permitted
[tom@localhost ~]$ sudo umount /mnt/
[tom@localhost ~]$ sudo mount /dev/loop0 /mnt/
[tom@localhost ~]$ lsattr /mnt/testfile
----i-------------- /mnt/testfile
[tom@localhost ~]$ echo test > /mnt/testfile
[tom@localhost ~]$ rm /mnt/testfile
[tom@localhost ~]$ sudo umount /mnt/
Reported-by: Tom Yan
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit ac7e0a9e3c7f2aa7f59e6d12869829960f6cbefc
Author: Pavel Shilovsky
Date: Sat Jul 8 14:32:00 2017 -0700
CIFS: Reconnect expired SMB sessions
commit 511c54a2f69195b28afb9dd119f03787b1625bb4 upstream.
According to the MS-SMB2 spec (3.2.5.1.6) once the client receives
STATUS\_NETWORK\_SESSION\_EXPIRED error code from a server it should
reconnect the current SMB session. Currently the client doesn't do
that. This can result in subsequent client requests failing by
the server. The patch adds an additional logic to the demultiplex
thread to identify expired sessions and reconnect them.
Signed-off-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 7350fbef5cfa0e03e9b4a7bd1b4980945946f988
Author: Jan Kara
Date: Mon Jun 26 08:48:18 2017 -0700
xfs: Don't clear SGID when inheriting ACLs
commit 8ba358756aa08414fa9e65a1a41d28304ed6fd7f upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by calling \_\_xfs\_set\_acl() instead of xfs\_set\_acl() when
setting up inode in xfs\_generic\_create(). That prevents SGID bit
clearing and mode is properly set by posix\_acl\_create() anyway. We also
reorder arguments of \_\_xfs\_set\_acl() to match the ordering of
xfs\_set\_acl() to make things consistent.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: Darrick J. Wong
CC: linux-xfs@vger.kernel.org
Signed-off-by: Jan Kara
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Greg Kroah-Hartman
commit d4a0964c5ce2bd46a288234c1edf7eec5da56ade
Author: Corey Minyard
Date: Fri Jun 30 07:18:08 2017 -0500
ipmi:ssif: Add missing unlock in error branch
commit 4495ec6d770e1bca7a04e93ac453ab6720c56c5d upstream.
When getting flags, a response to a different message would
result in a deadlock because of a missing unlock. Add that
unlock and a comment. Found by static analysis.
Reported-by: Dan Carpenter
Signed-off-by: Corey Minyard
Signed-off-by: Greg Kroah-Hartman
commit 65acfd381d4fa5d2dbb328a52db2013b9367e614
Author: Tony Camuso
Date: Mon Jun 19 13:17:33 2017 -0400
ipmi: use rcu lock around call to intf->handlers->sender()
commit cdea46566bb21ce309725a024208322a409055cc upstream.
A vendor with a system having more than 128 CPUs occasionally encounters
the following crash during shutdown. This is not an easily reproduceable
event, but the vendor was able to provide the following analysis of the
crash, which exhibits the same footprint each time.
crash> bt
PID: 0 TASK: ffff88017c70ce70 CPU: 5 COMMAND: "swapper/5"
#0 [ffff88085c143ac8] machine\_kexec at ffffffff81059c8b
#1 [ffff88085c143b28] \_\_crash\_kexec at ffffffff811052e2
#2 [ffff88085c143bf8] crash\_kexec at ffffffff811053d0
#3 [ffff88085c143c10] oops\_end at ffffffff8168ef88
#4 [ffff88085c143c38] no\_context at ffffffff8167ebb3
#5 [ffff88085c143c88] \_\_bad\_area\_nosemaphore at ffffffff8167ec49
#6 [ffff88085c143cd0] bad\_area\_nosemaphore at ffffffff8167edb3
#7 [ffff88085c143ce0] \_\_do\_page\_fault at ffffffff81691d1e
#8 [ffff88085c143d40] do\_page\_fault at ffffffff81691ec5
#9 [ffff88085c143d70] page\_fault at ffffffff8168e188
[exception RIP: unknown or invalid address]
RIP: ffffffffa053c800 RSP: ffff88085c143e28 RFLAGS: 00010206
RAX: ffff88017c72bfd8 RBX: ffff88017a8dc000 RCX: ffff8810588b5ac8
RDX: ffff8810588b5a00 RSI: ffffffffa053c800 RDI: ffff8810588b5a00
RBP: ffff88085c143e58 R8: ffff88017c70d408 R9: ffff88017a8dc000
R10: 0000000000000002 R11: ffff88085c143da0 R12: ffff8810588b5ac8
R13: 0000000000000100 R14: ffffffffa053c800 R15: ffff8810588b5a00
ORIG\_RAX: ffffffffffffffff CS: 0010 SS: 0018
[exception RIP: cpuidle\_enter\_state+82]
RIP: ffffffff81514192 RSP: ffff88017c72be50 RFLAGS: 00000202
RAX: 0000001e4c3c6f16 RBX: 000000000000f8a0 RCX: 0000000000000018
RDX: 0000000225c17d03 RSI: ffff88017c72bfd8 RDI: 0000001e4c3c6f16
RBP: ffff88017c72be78 R8: 000000000000237e R9: 0000000000000018
R10: 0000000000002494 R11: 0000000000000001 R12: ffff88017c72be20
R13: ffff88085c14f8e0 R14: 0000000000000082 R15: 0000001e4c3bb400
ORIG\_RAX: ffffffffffffff10 CS: 0010 SS: 0018
This is the corresponding stack trace
It has crashed because the area pointed with RIP extracted from timer
element is already removed during a shutdown process.
The function is smi\_timeout().
And we think ffff8810588b5a00 in RDX is a parameter struct smi\_info
crash> rd ffff8810588b5a00 20
ffff8810588b5a00: ffff8810588b6000 0000000000000000 .`.X............
ffff8810588b5a10: ffff880853264400 ffffffffa05417e0 .D&S......T.....
ffff8810588b5a20: 24a024a000000000 0000000000000000 .....$.$........
ffff8810588b5a30: 0000000000000000 0000000000000000 ................
ffff8810588b5a30: 0000000000000000 0000000000000000 ................
ffff8810588b5a40: ffffffffa053a040 ffffffffa053a060 @.S.....`.S.....
ffff8810588b5a50: 0000000000000000 0000000100000001 ................
ffff8810588b5a60: 0000000000000000 0000000000000e00 ................
ffff8810588b5a70: ffffffffa053a580 ffffffffa053a6e0 ..S.......S.....
ffff8810588b5a80: ffffffffa053a4a0 ffffffffa053a250 ..S.....P.S.....
ffff8810588b5a90: 0000000500000002 0000000000000000 ................
Unfortunately the top of this area is already detroyed by someone.
But because of two reasonns we think this is struct smi\_info
1) The address included in between ffff8810588b5a70 and ffff8810588b5a80:
are inside of ipmi\_si\_intf.c see crash> module ffff88085779d2c0
2) We've found the area which point this.
It is offset 0x68 of ffff880859df4000
crash> rd ffff880859df4000 100
ffff880859df4000: 0000000000000000 0000000000000001 ................
ffff880859df4010: ffffffffa0535290 dead000000000200 .RS.............
ffff880859df4020: ffff880859df4020 ffff880859df4020 @.Y.... @.Y....
ffff880859df4030: 0000000000000002 0000000000100010 ................
ffff880859df4040: ffff880859df4040 ffff880859df4040 @@.Y....@@.Y....
ffff880859df4050: 0000000000000000 0000000000000000 ................
ffff880859df4060: 0000000000000000 ffff8810588b5a00 .........Z.X....
ffff880859df4070: 0000000000000001 ffff880859df4078 ........x@.Y....
If we regards it as struct ipmi\_smi in shutdown process
it looks consistent.
The remedy for this apparent race is affixed below.
Signed-off-by: Tony Camuso
Signed-off-by: Greg Kroah-Hartman
This was first introduced in 7ea0ed2b5be817 ipmi: Make the
message handler easier to use for SMI interfaces
where some code was moved outside of the rcu\_read\_lock()
and the lock was not added.
Signed-off-by: Corey Minyard
commit 719829d19c0ce215ff9b4f0b76c845bfa8cca64d
Author: Eric Anholt
Date: Mon Apr 10 18:44:13 2017 -0700
drm/etnaviv: Expose our reservation object when exporting a dmabuf.
commit 8555137e26618490cbeb12c243818539875d12f4 upstream.
Without this, polling on the dma-buf (and presumably other devices
synchronizing against our rendering) would return immediately, even
while the BO was busy.
Signed-off-by: Eric Anholt
Cc: Lucas Stach
Cc: Russell King
Cc: Christian Gmeiner
Cc: etnaviv@lists.freedesktop.org
Signed-off-by: Lucas Stach
Signed-off-by: Greg Kroah-Hartman
commit cb5634ea103cfb60994a7acd4129126b01e684bd
Author: John Brooks
Date: Mon Jul 3 14:05:34 2017 -0400
drm/ttm: Fix use-after-free in ttm\_bo\_clean\_mm
commit 8046e1955465e3f24e9154d0f2a2e0a8e3f8dccf upstream.
We unref the man->move fence in ttm\_bo\_clean\_mm() and then call
ttm\_bo\_force\_list\_clean() which waits on it, except the refcount is now
zero so a warning is generated (or worse):
[149492.279301] refcount\_t: increment on 0; use-after-free.
[149492.279309] ------------[ cut here ]------------
[149492.279315] WARNING: CPU: 3 PID: 18726 at lib/refcount.c:150 refcount\_inc+0x2b/0x30
[149492.279315] Modules linked in: vhost\_net vhost tun x86\_pkg\_temp\_thermal crc32\_pclmul ghash\_clmulni\_intel efivarfs amdgpu(
-) i2c\_algo\_bit drm\_kms\_helper syscopyarea sysfillrect sysimgblt fb\_sys\_fops ttm drm
[149492.279326] CPU: 3 PID: 18726 Comm: rmmod Not tainted 4.12.0-rc5-drm-next-4.13-ttmpatch+ #1
[149492.279326] Hardware name: Gigabyte Technology Co., Ltd. Z97X-UD3H-BK/Z97X-UD3H-BK-CF, BIOS F6 06/17/2014
[149492.279327] task: ffff8804ddfedcc0 task.stack: ffffc90008d20000
[149492.279329] RIP: 0010:refcount\_inc+0x2b/0x30
[149492.279330] RSP: 0018:ffffc90008d23c30 EFLAGS: 00010286
[149492.279331] RAX: 000000000000002b RBX: 0000000000000170 RCX: 0000000000000000
[149492.279331] RDX: 0000000000000000 RSI: ffff88051ecccbe8 RDI: ffff88051ecccbe8
[149492.279332] RBP: ffffc90008d23c30 R08: 0000000000000001 R09: 00000000000003ee
[149492.279333] R10: ffffc90008d23bb0 R11: 00000000000003ee R12: ffff88043aaac960
[149492.279333] R13: ffff8805005e28a8 R14: 0000000000000002 R15: ffff88050115e178
[149492.279334] FS: 00007fc540168700(0000) GS:ffff88051ecc0000(0000) knlGS:0000000000000000
[149492.279335] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[149492.279336] CR2: 00007fc3e8654140 CR3: 000000027ba77000 CR4: 00000000001426e0
[149492.279337] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[149492.279337] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[149492.279338] Call Trace:
[149492.279345] ttm\_bo\_force\_list\_clean+0xb9/0x110 [ttm]
[149492.279348] ttm\_bo\_clean\_mm+0x7a/0xe0 [ttm]
[149492.279375] amdgpu\_ttm\_fini+0xc9/0x1f0 [amdgpu]
[149492.279392] amdgpu\_bo\_fini+0x12/0x40 [amdgpu]
[149492.279415] gmc\_v7\_0\_sw\_fini+0x32/0x40 [amdgpu]
[149492.279430] amdgpu\_fini+0x2c9/0x490 [amdgpu]
[149492.279445] amdgpu\_device\_fini+0x58/0x1b0 [amdgpu]
[149492.279461] amdgpu\_driver\_unload\_kms+0x4f/0xa0 [amdgpu]
[149492.279470] drm\_dev\_unregister+0x3c/0xe0 [drm]
[149492.279485] amdgpu\_pci\_remove+0x19/0x30 [amdgpu]
[149492.279487] pci\_device\_remove+0x39/0xc0
[149492.279490] device\_release\_driver\_internal+0x155/0x210
[149492.279491] driver\_detach+0x38/0x70
[149492.279493] bus\_remove\_driver+0x4c/0xa0
[149492.279494] driver\_unregister+0x2c/0x40
[149492.279496] pci\_unregister\_driver+0x21/0x90
[149492.279520] amdgpu\_exit+0x15/0x406 [amdgpu]
[149492.279523] SyS\_delete\_module+0x1a8/0x270
[149492.279525] ? exit\_to\_usermode\_loop+0x92/0xa0
[149492.279528] entry\_SYSCALL\_64\_fastpath+0x13/0x94
[149492.279529] RIP: 0033:0x7fc53fcb68e7
[149492.279529] RSP: 002b:00007ffcfbfaabb8 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[149492.279531] RAX: ffffffffffffffda RBX: 0000563117adb200 RCX: 00007fc53fcb68e7
[149492.279531] RDX: 000000000000000a RSI: 0000000000000800 RDI: 0000563117adb268
[149492.279532] RBP: 0000000000000003 R08: 0000000000000000 R09: 1999999999999999
[149492.279533] R10: 0000000000000883 R11: 0000000000000206 R12: 00007ffcfbfa9ba0
[149492.279533] R13: 0000000000000000 R14: 0000000000000000 R15: 0000563117adb200
[149492.279534] Code: 55 48 89 e5 e8 77 fe ff ff 84 c0 74 02 5d c3 80 3d 40 f2 a4 00 00 75 f5 48 c7 c7 20 3c ca 81 c6 05 30 f2 a4 00 01 e8 91 f0 d7 ff <0f> ff 5d c3 90 55 48 89 fe bf 01 00 00 00 48 89 e5 e8 9f fe ff
[149492.279557] ---[ end trace 2d4e0ffcb66a1016 ]---
Unref the fence \*after\* waiting for it.
v2: Set man->move to NULL after dropping the last ref (Christian König)
Fixes: aff98ba1fdb8 (drm/ttm: wait for eviction in ttm\_bo\_force\_list\_clean)
Signed-off-by: John Brooks
Reviewed-by: Christian König
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 011a0006ae96813b38d5371caebc20c572f4491c
Author: Mario Kleiner
Date: Fri Jul 7 04:57:04 2017 +0200
drm/radeon: Fix eDP for single-display iMac10,1 (v2)
commit 564d8a2cf3abf16575af48bdc3e86e92ee8a617d upstream.
The late 2009, 27 inch Apple iMac10,1 has an
internal eDP display and an external Mini-
Displayport output, driven by a DCE-3.2, RV730
Radeon Mobility HD-4670.
The machine worked fine in a dual-display setup
with eDP panel + externally connected HDMI
or DVI-D digital display sink, connected via
MiniDP to DVI or HDMI adapter.
However, booting the machine single-display with
only eDP panel results in a completely black
display - even backlight powering off, as soon as
the radeon modesetting driver loads.
This patch fixes the single dispay eDP case by
assigning encoders based on dig->linkb, similar
to DCE-4+. While this should not be generally
necessary (Alex: "...atom on normal boards
should be able to handle any mapping."), Apple
seems to use some special routing here.
One remaining problem not solved by this patch
is that an external Minidisplayport->DP sink
does still not work on iMac10,1, whereas external
DVI and HDMI sinks continue to work.
The problem affects at least all tested kernels
since Linux 3.13 - didn't test earlier kernels, so
backporting to stable probably makes sense.
v2: With the original patch from 2016, Alex was worried it
will break other DCE3.2 systems. Use dmi\_match() to
apply this special encoder assignment only for the
Apple iMac 10,1 from late 2009.
Signed-off-by: Mario Kleiner
Cc: Alex Deucher
Cc: Michel Dänzer
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit b123162f81c38cf836880a873a50084e9b49789a
Author: Alex Deucher
Date: Thu May 11 13:14:14 2017 -0400
drm/radeon/ci: disable mclk switching for high refresh rates (v2)
commit ab03d9fe508f4e2914a8f4a9eef1b21051cacd0f upstream.
Even if the vblank period would allow it, it still seems to
be problematic on some cards.
v2: fix logic inversion (Nils)
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=96868
Acked-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit e97b3dc369175bee085af28d756870029a4a13d8
Author: John Brooks
Date: Mon Jul 3 14:05:35 2017 -0400
drm/amdgpu: Don't call amd\_powerplay\_destroy() if we don't have powerplay
commit 7bc7b7777ee0e3b3d995aebaf26a462d5a23e3d7 upstream.
amd\_powerplay\_destroy() expects a handle pointing to a struct pp\_instance.
On chips without PowerPlay, pp\_handle points to a struct amdgpu\_device. The
resulting attempt to kfree() fields of the wrong struct ends in fire:
[ 91.560405] BUG: unable to handle kernel paging request at ffffebe000000620
[ 91.560414] IP: kfree+0x57/0x160
[ 91.560416] PGD 0
[ 91.560416] P4D 0
[ 91.560420] Oops: 0000 [#1] SMP
[ 91.560422] Modules linked in: tun x86\_pkg\_temp\_thermal crc32\_pclmul ghash\_clmulni\_intel efivarfs amdgpu(-) i2c\_algo\_bit drm\_kms\_helper syscopyarea sysfillrect sysimgblt fb\_sys\_fops ttm drm
[ 91.560438] CPU: 6 PID: 3598 Comm: rmmod Not tainted 4.12.0-rc5-drm-next-4.13-ttmpatch+ #1
[ 91.560443] Hardware name: Gigabyte Technology Co., Ltd. Z97X-UD3H-BK/Z97X-UD3H-BK-CF, BIOS F6 06/17/2014
[ 91.560448] task: ffff8805063d6a00 task.stack: ffffc90003400000
[ 91.560451] RIP: 0010:kfree+0x57/0x160
[ 91.560454] RSP: 0018:ffffc90003403cc0 EFLAGS: 00010286
[ 91.560457] RAX: 000077ff80000000 RBX: 00000000000186a0 RCX: 0000000180400035
[ 91.560460] RDX: 0000000180400036 RSI: ffffea001418e740 RDI: ffffea0000000000
[ 91.560463] RBP: ffffc90003403cd8 R08: 000000000639d201 R09: 0000000180400035
[ 91.560467] R10: ffffebe000000600 R11: 0000000000000300 R12: ffff880500530030
[ 91.560470] R13: ffffffffa01e70fc R14: 00000000ffffffff R15: ffff880500530000
[ 91.560473] FS: 00007f7e500c3700(0000) GS:ffff88051ed80000(0000) knlGS:0000000000000000
[ 91.560478] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 91.560480] CR2: ffffebe000000620 CR3: 0000000503103000 CR4: 00000000001406e0
[ 91.560483] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 91.560487] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 91.560489] Call Trace:
[ 91.560530] amd\_powerplay\_destroy+0x1c/0x60 [amdgpu]
[ 91.560558] amdgpu\_pp\_late\_fini+0x44/0x60 [amdgpu]
[ 91.560575] amdgpu\_fini+0x254/0x490 [amdgpu]
[ 91.560593] amdgpu\_device\_fini+0x58/0x1b0 [amdgpu]
[ 91.560610] amdgpu\_driver\_unload\_kms+0x4f/0xa0 [amdgpu]
[ 91.560622] drm\_dev\_unregister+0x3c/0xe0 [drm]
[ 91.560638] amdgpu\_pci\_remove+0x19/0x30 [amdgpu]
[ 91.560643] pci\_device\_remove+0x39/0xc0
[ 91.560648] device\_release\_driver\_internal+0x155/0x210
[ 91.560651] driver\_detach+0x38/0x70
[ 91.560655] bus\_remove\_driver+0x4c/0xa0
[ 91.560658] driver\_unregister+0x2c/0x40
[ 91.560662] pci\_unregister\_driver+0x21/0x90
[ 91.560689] amdgpu\_exit+0x15/0x406 [amdgpu]
[ 91.560694] SyS\_delete\_module+0x1a8/0x270
[ 91.560698] ? exit\_to\_usermode\_loop+0x92/0xa0
[ 91.560702] entry\_SYSCALL\_64\_fastpath+0x13/0x94
[ 91.560705] RIP: 0033:0x7f7e4fc118e7
[ 91.560708] RSP: 002b:00007fff978ca118 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[ 91.560713] RAX: ffffffffffffffda RBX: 000055afe21bc200 RCX: 00007f7e4fc118e7
[ 91.560716] RDX: 000000000000000a RSI: 0000000000000800 RDI: 000055afe21bc268
[ 91.560719] RBP: 0000000000000003 R08: 0000000000000000 R09: 1999999999999999
[ 91.560722] R10: 0000000000000883 R11: 0000000000000206 R12: 00007fff978c9100
[ 91.560725] R13: 0000000000000000 R14: 0000000000000000 R15: 000055afe21bc200
[ 91.560728] Code: 00 00 00 80 ff 77 00 00 48 bf 00 00 00 00 00 ea ff ff 49 01 da 48 0f 42 05 57 33 bd 00 49 01 c2 49 c1 ea 0c 49 c1 e2 06 49 01 fa <49> 8b 42 20 48 8d 78 ff a8 01 4c 0f 45 d7 49 8b 52 20 48 8d 42
[ 91.560759] RIP: kfree+0x57/0x160 RSP: ffffc90003403cc0
[ 91.560761] CR2: ffffebe000000620
[ 91.560765] ---[ end trace 08a9f3cd82223c1d ]---
Fixes: 1c8638024846 (drm/amd/powerplay: refine powerplay interface.)
Signed-off-by: John Brooks
Acked-by: Christian König
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 3738cd036503673e320d7886515ce4c68e7a1bb7
Author: Huang Rui
Date: Thu Jun 29 14:21:49 2017 +0800
drm/amdgpu: fix the memory corruption on S3
commit 67bef0f7908a3a6b10e5a29d8e8c09e27f90c9f8 upstream.
psp->cmd will be used on resume phase, so we can not free it on hw\_init.
Otherwise, a memory corruption will be triggered.
Signed-off-by: Huang Rui
Reviewed-by: Christian König
Tested-by: Xiaojie Yuan
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 9a0b375b0b33b2631331f1e1f3e89265d2d47beb
Author: Tom St Denis
Date: Tue May 23 11:35:22 2017 -0400
drm/amd/amdgpu: Return error if initiating read out of range on vram
commit 9156e723301c0a7a7def4cde820e018ce791b842 upstream.
If you initiate a read that is out of the VRAM address space return
ENXIO instead of 0.
Reads that begin below that point will read upto the VRAM limit as
before.
Signed-off-by: Tom St Denis
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit f64c0826e5c96e649545404067a3d703f8b9089c
Author: Alex Deucher
Date: Fri Jun 30 09:58:34 2017 -0400
drm/amdgpu/cgs: always set reference clock in mode\_info
commit 73cc90798ff765341a1d9c2cfe18153ab231c9bb upstream.
It's relevent regardless of whether there are displays
enabled. Fixes garbage values for ref clock in powerplay
leading to incorrect fan speed reporting when displays
are disabled.
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=101653
Acked-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 2dc1889ebf8501b0edf125e89a30e1cf3744a2a7
Author: Alex Deucher
Date: Thu Jun 29 16:08:49 2017 -0400
drm/amdgpu: fix vblank\_time when displays are off
commit beb3777682d5c296cc15a2a424f5a7a98476def0 upstream.
If the displays are off, set the vblank time to max to make
sure mclk switching is enabled. Avoid mclk getting set
to high when no displays are attached.
bug: https://bugs.freedesktop.org/show\_bug.cgi?id=101528
fixes: 09be4a5219 (drm/amd/powerplay/smu7: add vblank check for mclk switching (v2))
Reviewed-by: Michel Dänzer
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 4a0b18552ce3563c1f4de7abfd09a68c69208413
Author: Alex Deucher
Date: Wed May 31 10:05:04 2017 -0400
drm/amdgpu/gfx8: drop per-APU CU limits
commit 943c05bdb53da273c43ec44eec37c6a70409b5e9 upstream.
Always use the max for the family rather than the per sku limits.
This makes sure the mask is always the max size to avoid reporting
the wrong number of CUs.
Reviewed-by: Alex Xie
Reviewed-by: Andres Rodriguez
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit eee9c161990ffddad5a79d9ab55b71a2eb90d069
Author: Jiri Olsa
Date: Thu Jun 29 11:38:11 2017 +0200
s390/syscalls: Fix out of bounds arguments access
commit c46fc0424ced3fb71208e72bd597d91b9169a781 upstream.
Zorro reported following crash while having enabled
syscall tracing (CONFIG\_FTRACE\_SYSCALLS):
Unable to handle kernel pointer dereference at virtual ...
Oops: 0011 [#1] SMP DEBUG\_PAGEALLOC
SNIP
Call Trace:
([<000000000024d79c>] ftrace\_syscall\_enter+0xec/0x1d8)
[<00000000001099c6>] do\_syscall\_trace\_enter+0x236/0x2f8
[<0000000000730f1c>] sysc\_tracesys+0x1a/0x32
[<000003fffcf946a2>] 0x3fffcf946a2
INFO: lockdep is turned off.
Last Breaking-Event-Address:
[<000000000022dd44>] rb\_event\_data+0x34/0x40
---[ end trace 8c795f86b1b3f7b9 ]---
The crash happens in syscall\_get\_arguments function for
syscalls with zero arguments, that will try to access
first argument (args[0]) in event entry, but it's not
allocated.
Bail out of there are no arguments.
Reported-by: Zorro Lang
Signed-off-by: Jiri Olsa
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit 25b43a867f56eba19c23cae8e296f8dd3b7fe951
Author: Xiao Ni
Date: Wed Jul 5 17:34:04 2017 +0800
Raid5 should update rdev->sectors after reshape
commit b5d27718f38843a74552e9a93d32e2391fd3999f upstream.
The raid5 md device is created by the disks which we don't use the total size. For example,
the size of the device is 5G and it just uses 3G of the devices to create one raid5 device.
Then change the chunksize and wait reshape to finish. After reshape finishing stop the raid
and assemble it again. It fails.
mdadm -CR /dev/md0 -l5 -n3 /dev/loop[0-2] --size=3G --chunk=32 --assume-clean
mdadm /dev/md0 --grow --chunk=64
wait reshape to finish
mdadm -S /dev/md0
mdadm -As
The error messages:
[197519.814302] md: loop1 does not have a valid v1.2 superblock, not importing!
[197519.821686] md: md\_import\_device returned -22
After reshape the data offset is changed. It selects backwards direction in this condition.
In function super\_1\_load it compares the available space of the underlying device with
sb->data\_size. The new data offset gets bigger after reshape. So super\_1\_load returns -EINVAL.
rdev->sectors is updated in md\_finish\_reshape. Then sb->data\_size is set in super\_1\_sync based
on rdev->sectors. So add md\_finish\_reshape in end\_reshape.
Signed-off-by: Xiao Ni
Acked-by: Guoqing Jiang
Signed-off-by: Shaohua Li
Signed-off-by: Greg Kroah-Hartman
commit 47f1b42a07b1e26c2d61a0785559d0f8434110f0
Author: Heinz Mauelshagen
Date: Fri Jun 30 15:45:58 2017 +0200
dm raid: stop using BUG() in \_\_rdev\_sectors()
commit 4d49f1b4a1fcab16b6dd1c79ef14f2b6531d50a6 upstream.
Return 0 rather than BUG() if \_\_rdev\_sectors() fails and catch invalid
rdev size in the constructor.
Reported-by: Hannes Reinecke
Signed-off-by: Heinz Mauelshagen
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit ee31ec07eea961b01f1d6f04a95742035b6a137c
Author: Jan Kara
Date: Wed Jun 21 14:34:15 2017 +0200
ext2: Don't clear SGID when inheriting ACLs
commit a992f2d38e4ce17b8c7d1f7f67b2de0eebdea069 upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by creating \_\_ext2\_set\_acl() function that does not call
posix\_acl\_update\_mode() and use it when inheriting ACLs. That prevents
SGID bit clearing and the mode has been properly set by
posix\_acl\_create() anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: linux-ext4@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 08196c1c964f5af84907092ed62d598637aef49c
Author: Toshi Kani
Date: Fri Jul 7 17:44:26 2017 -0600
libnvdimm: fix badblock range handling of ARS range
commit 4e3f0701f25ab194c5362576b1146a1e6cc6c2e7 upstream.
\_\_add\_badblock\_range() does not account sector alignment when
it sets 'num\_sectors'. Therefore, an ARS error record range
spanning across two sectors is set to a single sector length,
which leaves the 2nd sector unprotected.
Change \_\_add\_badblock\_range() to set 'num\_sectors' properly.
Fixes: 0caeef63e6d2 ("libnvdimm: Add a poison list and export badblocks")
Signed-off-by: Toshi Kani
Reviewed-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit e01c81e80de1f35c93e8d6ed33a5709905a791b9
Author: Vishal Verma
Date: Fri Jun 30 18:32:52 2017 -0600
libnvdimm: fix the clear-error check in nsio\_rw\_bytes
commit 7e5a21dfe5524a85705d3bc7b540c849cc13e9a1 upstream.
A leftover from the 'bandaid' fix that disabled BTT error clearing in
rw\_bytes resulted in an incorrect check. After we converted these checks
over to use the NVDIMM\_IO\_ATOMIC flag, the ndns->claim check was both
redundant, and incorrect. Remove it.
Fixes: 3ae3d67ba705 ("libnvdimm: add an atomic vs process context flag to rw\_bytes")
Cc: Dave Jiang
Cc: Dan Williams
Signed-off-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit c32101126084eac88e0b75465cd25506765915cd
Author: Vishal Verma
Date: Thu Jun 29 16:59:11 2017 -0600
libnvdimm, btt: fix btt\_rw\_page not returning errors
commit c13c43d54f2c6a3be1c675766778ac1ad8dfbfcc upstream.
btt\_rw\_page was not propagating errors frm btt\_do\_bvec, resulting in any
IO errors via the rw\_page path going unnoticed. the pmem driver recently
fixed this in e10624f pmem: fail io-requests to known bad blocks
but same problem in BTT went neglected.
Fixes: 5212e11fde4d ("nd\_btt: atomic sector updates")
Cc: Toshi Kani
Cc: Dan Williams
Cc: Jeff Moyer
Signed-off-by: Vishal Verma
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit e6259c4a46e4782616485a2e94dee1e48c062386
Author: Yasunori Goto
Date: Thu Jun 15 14:04:16 2017 +0900
tools/testing/nvdimm: fix nfit\_test buffer overflow
commit a117699c6c4a4b1b4e90ed51e393590986567cb4 upstream.
The root cause of panic is the num\_pm of nfit\_test1 is wrong.
Though 1 is specified for num\_pm at nfit\_test\_init(), it must be 2,
because nfit\_test1->spa\_set[] array has 2 elements.
Since the array is smaller than expected, the driver breaks other area.
(it is often the link list of devres).
As a result, panic occurs like the following example.
CPU: 4 PID: 2233 Comm: lt-libndctl Tainted: G O 4.12.0-rc1+ #12
RIP: 0010:\_\_list\_del\_entry\_valid+0x6c/0xa0
Call Trace:
release\_nodes+0x76/0x260
devres\_release\_all+0x3c/0x50
device\_release\_driver\_internal+0x159/0x200
device\_release\_driver+0x12/0x20
bus\_remove\_device+0xfd/0x170
device\_del+0x1e8/0x330
platform\_device\_del+0x28/0x90
platform\_device\_unregister+0x12/0x30
nfit\_test\_exit+0x2a/0x93b [nfit\_test]
Signed-off-by: Yasunori Goto
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit d6226fc782f7959d8cb8642c6eb3589dbf65ad01
Author: David Härdeman
Date: Thu Apr 27 17:33:58 2017 -0300
rc-core: fix input repeat handling
commit b2aceb739b5af6a8abc5ea6ab9e6a0409a3b5b1d upstream.
The call to input\_register\_device() needs to take place
before the repeat parameters are set or the input subsystem
repeat handling will be disabled (as was already noted in
the comments in that function).
Signed-off-by: David Härdeman
Signed-off-by: Sean Young
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 735c17ded9fb6cb37c3f92226e063cfbe754c64c
Author: Devin Heitmueller
Date: Sat Sep 20 09:23:44 2014 -0300
cx88: Fix regression in initial video standard setting
commit 4e0973a918b9a42e217093f078e04a61e5dd95a5 upstream.
Setting initial standard at the top of cx8800\_initdev would cause the
first call to cx88\_set\_tvnorm() to return without programming any
registers (leaving the driver saying it's set to NTSC but the hardware
isn't programmed). Even worse, any subsequent attempt to explicitly
set it to NTSC-M will return success but actually fail to program the
underlying registers unless first changing the standard to something
other than NTSC-M.
Set the initial standard later in the process, and make sure the field
is zero at the beginning to ensure that the call always goes through.
This regression was introduced in the following commit:
commit ccd6f1d488e7 ("[media] cx88: move width, height and field to core
struct")
Author: Hans Verkuil
[media] cx88: move width, height and field to core struct
Signed-off-by: Devin Heitmueller
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit dc1e0c2be5519f05b335e05d66a05ad6361ddb57
Author: Marek Marczykowski-Górecki
Date: Mon Jun 26 14:49:46 2017 +0200
x86/xen: allow userspace access during hypercalls
commit c54590cac51db8ab5fd30156bdaba34af915e629 upstream.
Userspace application can do a hypercall through /dev/xen/privcmd, and
some for some hypercalls argument is a pointers to user-provided
structure. When SMAP is supported and enabled, hypervisor can't access.
So, lets allow it.
The same applies to HYPERVISOR\_dm\_op, where additionally privcmd driver
carefully verify buffer addresses.
Signed-off-by: Marek Marczykowski-Górecki
Reviewed-by: Juergen Gross
Signed-off-by: Juergen Gross
Signed-off-by: Greg Kroah-Hartman
commit a2bfc67530653eca8484b393d71b7042efc26e1c
Author: NeilBrown
Date: Mon Jun 5 16:49:39 2017 +1000
md: fix deadlock between mddev\_suspend() and md\_write\_start()
commit cc27b0c78c79680d128dbac79de0d40556d041bb upstream.
If mddev\_suspend() races with md\_write\_start() we can deadlock
with mddev\_suspend() waiting for the request that is currently
in md\_write\_start() to complete the ->make\_request() call,
and md\_write\_start() waiting for the metadata to be updated
to mark the array as 'dirty'.
As metadata updates done by md\_check\_recovery() only happen then
the mddev\_lock() can be claimed, and as mddev\_suspend() is often
called with the lock held, these threads wait indefinitely for each
other.
We fix this by having md\_write\_start() abort if mddev\_suspend()
is happening, and ->make\_request() aborts if md\_write\_start()
aborted.
md\_make\_request() can detect this abort, decrease the ->active\_io
count, and wait for mddev\_suspend().
Reported-by: Nix
Fix: 68866e425be2(MD: no sync IO while suspended)
Signed-off-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Greg Kroah-Hartman
commit 8d73fe66b5a640b793fdf13491b5cac12882be7e
Author: Mikulas Patocka
Date: Wed Jun 7 19:05:31 2017 -0400
md: don't use flush\_signals in userspace processes
commit f9c79bc05a2a91f4fba8bfd653579e066714b1ec upstream.
The function flush\_signals clears all pending signals for the process. It
may be used by kernel threads when we need to prepare a kernel thread for
responding to signals. However using this function for an userspaces
processes is incorrect - clearing signals without the program expecting it
can cause misbehavior.
The raid1 and raid5 code uses flush\_signals in its request routine because
it wants to prepare for an interruptible wait. This patch drops
flush\_signals and uses sigprocmask instead to block all signals (including
SIGKILL) around the schedule() call. The signals are not lost, but the
schedule() call won't respond to them.
Signed-off-by: Mikulas Patocka
Acked-by: NeilBrown
Signed-off-by: Shaohua Li
Signed-off-by: Greg Kroah-Hartman
commit b110a29f98663548bdd190653c4cdfa0f66b8f9a
Author: Dmitry Torokhov
Date: Tue Jul 11 10:02:18 2017 -0700
HID: multitouch: do not blindly set EV\_KEY or EV\_ABS bits
commit 4cf56a89c696e66d10612b43b7e95852611e76c2 upstream.
Now that input core insists on having dev->absinfo when device claims to
generate EV\_ABS in its dev->evbit, we should not be blindly setting that
bit.
The code in question might have been needed before input\_set\_abs\_params()
started setting EV\_ABS in device's evbit, but not anymore, and is now
breaking devices such as SMART SPNL-6075 Touchscreen.
Fixes: 6ecfe51b4082 ("Input: refuse to register absolute devices ...")
Reported-by: Matthias Fend
Tested-by: Matthias Fend
Reviewed-by: Benjamin Tissoires
Signed-off-by: Dmitry Torokhov
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 971443b0d31a8dd28c654696edb7c05ed8d11361
Author: Yoshihiro Shimoda
Date: Wed Jul 19 16:16:55 2017 +0900
usb: renesas\_usbhs: gadget: disable all eps when the driver stops
commit b8b9c974afee685789fcbb191b52d1790be3608c upstream.
A gadget driver will not disable eps immediately when ->disconnect()
is called. But, since this driver assumes all eps stop after
the ->disconnect(), unexpected behavior happens (especially in system
suspend).
So, this patch disables all eps in usbhsg\_try\_stop(). After disabling
eps by renesas\_usbhs driver, since some functions will be called by
both a gadget and renesas\_usbhs driver, renesas\_usbhs driver should
protect uep->pipe. To protect uep->pipe easily, this patch adds a new
lock in struct usbhsg\_uep.
Fixes: 2f98382dc ("usb: renesas\_usbhs: Add Renesas USBHS Gadget")
Signed-off-by: Yoshihiro Shimoda
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit d0cacd6618e8c56e0406d0b61fb1ed8222ca61cc
Author: Yoshihiro Shimoda
Date: Wed Jul 19 16:16:54 2017 +0900
usb: renesas\_usbhs: fix usbhsc\_resume() for !USBHSF\_RUNTIME\_PWCTRL
commit 59a0879a0e17b2e43ecdc5e3299da85b8410d7ce upstream.
This patch fixes an issue that some registers may be not initialized
after resume if the USBHSF\_RUNTIME\_PWCTRL is not set. Otherwise,
if a cable is not connected, the driver will not enable INTENB0.VBSE
after resume. And then, the driver cannot detect the VBUS.
Fixes: ca8a282a5373 ("usb: gadget: renesas\_usbhs: add suspend/resume support")
Signed-off-by: Yoshihiro Shimoda
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit c007b2838322d83f563f3869de39492a3e29292b
Author: Johan Hovold
Date: Wed Jul 12 15:08:39 2017 +0200
USB: cdc-acm: add device-id for quirky printer
commit fe855789d605590e57f9cd968d85ecce46f5c3fd upstream.
Add device-id entry for DATECS FP-2000 fiscal printer needing the
NO\_UNION\_NORMAL quirk.
Reported-by: Anton Avramov
Signed-off-by: Johan Hovold
Acked-by: Oliver Neukum
Signed-off-by: Greg Kroah-Hartman
commit 2aee5d17a575bfebcc19a672a7478f14f186c6d7
Author: Colin Ian King
Date: Thu Jul 6 16:06:32 2017 +0100
usb: storage: return on error to avoid a null pointer dereference
commit 446230f52a5bef593554510302465eabab45a372 upstream.
When us->extra is null the driver is not initialized, however, a
later call to osd200\_scsi\_to\_ata is made that dereferences
us->extra, causing a null pointer dereference. The code
currently detects and reports that the driver is not initialized;
add a return to avoid the subsequent dereference issue in this
check.
Thanks to Alan Stern for pointing out that srb->result needs setting
to DID\_ERROR << 16
Detected by CoverityScan, CID#100308 ("Dereference after null check")
Signed-off-by: Colin Ian King
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 2f110d39a3e049f707c9d7f539b7bc997c83d2ef
Author: Devin Heitmueller
Date: Fri Apr 21 13:28:37 2017 -0300
mxl111sf: Fix driver to use heap allocate buffers for USB messages
commit d90b336f3f652ff0441e631a06236f785581c8f7 upstream.
The recent changes in 4.9 to mandate USB buffers be heap allocated
broke this driver, which was allocating the buffers on the stack.
This resulted in the device failing at initialization.
Introduce dedicated send/receive buffers as part of the state
structure, and add a mutex to protect access to them.
Note: we also had to tweak the API to mxl111sf\_ctrl\_msg to pass
the pointer to the state struct rather than the device, since
we need it inside the function to access the buffers and the
mutex. This patch adjusts the callers to match the API change.
Signed-off-by: Devin Heitmueller
Reported-by: Doug Lung
Cc: Michael Ira Krufky
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 5cc9b698a494827b15f74ef70a31d7911d00e52a
Author: Jiahau Chang
Date: Thu Jul 20 14:48:27 2017 +0300
xhci: Bad Ethernet performance plugged in ASM1042A host
commit 9da5a1092b13468839b1a864b126cacfb72ad016 upstream.
When USB Ethernet is plugged in ASMEDIA ASM1042A xHCI host, bad
performance was manifesting in Web browser use (like download
large file such as ISO image). It is known limitation of
ASM1042A that is not compatible with driver scheduling,
As a workaround we can modify flow control handling of ASM1042A.
The register we modify is changes the behavior
[use quirk bit 28, usleep\_range 40-60us, empty non-pci function -Mathias]
Signed-off-by: Jiahau Chang
Signed-off-by: Ian Pilcher
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 7b7a1f02338d47489dbcbb517aa152f15a50e390
Author: Mathias Nyman
Date: Thu Jul 20 14:48:26 2017 +0300
xhci: Fix NULL pointer dereference when cleaning up streams for removed host
commit 4b895868bb2da60a386a17cde3bf9ecbc70c79f4 upstream.
This off by one in stream\_id indexing caused NULL pointer dereference and
soft lockup on machines with USB attached SCSI devices connected to a
hotpluggable xhci controller.
The code that cleans up pending URBs for dead hosts tried to dereference
a stream ring at the invalid stream\_id 0.
ep->stream\_info->stream\_rings[0] doesn't point to a ring.
Start looping stream\_id from 1 like in all the other places in the driver,
and check that the ring exists before trying to kill URBs on it.
Reported-by: rocko r
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit be67d4afbee8c71628c4220d792c09b46bd4700e
Author: Mathias Nyman
Date: Thu Jul 20 14:48:29 2017 +0300
xhci: fix 20000ms port resume timeout
commit a54408d0a004757789863d74e29c2297edae0b4d upstream.
A uncleared PLC (port link change) bit will prevent furuther port event
interrupts for that port. Leaving it uncleared caused get\_port\_status()
to timeout after 20000ms while waiting to get the final port event
interrupt for resume -> U0 state change.
This is a targeted fix for a specific case where we get a port resume event
racing with xhci resume. The port event interrupt handler notices xHC is
not yet running and bails out early, leaving PLC uncleared.
The whole xhci port resuming needs more attention, but while working on it
it anyways makes sense to always ensure PLC is cleared in get\_port\_status
before setting a new link state and waiting for its completion.
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 01c5b39310da6cbd6c99e7389211b734a69de582
Author: Shu Wang
Date: Thu Jul 20 14:48:31 2017 +0300
xhci: fix memleak in xhci\_run()
commit d6f5f071f1e13cadecf8aef1faa7e5d6fbc9f33b upstream.
Found this issue by kmemleak.
xhci\_run() did not check return val and free command for
xhci\_queue\_vendor\_command()
unreferenced object 0xffff88011c0be500 (size 64):
comm "kworker/0:1", pid 58, jiffies 4294670908 (age 50.420s)
hex dump (first 32 bytes):
backtrace:
[] kmemleak\_alloc+0x4a/0xa0
[] kmem\_cache\_alloc\_trace+0xca/0x1d0
[] xhci\_alloc\_command+0x44/0x130
[] xhci\_run+0x4cc/0x630
[] usb\_add\_hcd+0x3bb/0x950
[] usb\_hcd\_pci\_probe+0x188/0x500
[] xhci\_pci\_probe+0x2c/0x220
[] local\_pci\_probe+0x45/0xa0
[] work\_for\_cpu\_fn+0x14/0x20
[] process\_one\_work+0x149/0x360
[] worker\_thread+0x1d8/0x3c0
[] kthread+0x109/0x140
[] ret\_from\_fork+0x25/0x30
[] 0xffffffffffffffff
Signed-off-by: Shu Wang
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 9c97237c71a73d98464476077e58a37f6359acb0
Author: Peter Chen
Date: Thu Jul 20 14:48:30 2017 +0300
usb: xhci: fix spinlock recursion for USB2 test mode
commit 576d55460e7f209139545a348746c2fcadf61bc3 upstream.
Both xhci\_hub\_control and xhci\_disable\_slot tries to hold spinlock, the
spinlock recursion occurs when enters USB2 test mode. Fix it by unlock
spinlock before calling xhci\_disable\_slot.
Fixes: 0f1d832ed1fb ("usb: xhci: Add port test modes support for usb2")
Signed-off-by: Peter Chen
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 07c79fd97e00a90e26554798c61f45e2db30fc5d
Author: Michael Hernandez
Date: Thu May 18 10:47:47 2017 -0700
PCI/MSI: Ignore affinity if pre/post vector count is more than min\_vecs
commit 6f9a22bc5775d231ab8fbe2c2f3c88e45e3e7c28 upstream.
min\_vecs is the minimum amount of vectors needed to operate in MSI-X mode
which may just include the vectors that don't need affinity.
Disabling affinity settings causes the qla2xxx driver scsi\_add\_host() to fail
when blk\_mq is enabled as the blk\_mq\_pci\_map\_queues() expects affinity masks
on each vector.
Fixes: dfef358bd1be ("PCI/MSI: Don't apply affinity if there aren't enough vectors left")
Signed-off-by: Michael Hernandez
Signed-off-by: Himanshu Madhani
Signed-off-by: Bjorn Helgaas
Reviewed-by: Christoph Hellwig
Signed-off-by: Greg Kroah-Hartman
commit c1ead164ebc2795c4a6b9778e4c697be5f2297ec
Author: Chen Yu
Date: Thu May 25 16:49:07 2017 +0800
PCI/PM: Restore the status of PCI devices across hibernation
commit e60514bd4485c0c7c5a7cf779b200ce0b95c70d6 upstream.
Currently we saw a lot of "No irq handler" errors during hibernation, which
caused the system hang finally:
ata4.00: qc timeout (cmd 0xec)
ata4.00: failed to IDENTIFY (I/O error, err\_mask=0x4)
ata4.00: revalidation failed (errno=-5)
ata4: SATA link up 6.0 Gbps (SStatus 133 SControl 300)
do\_IRQ: 31.151 No irq handler for vector
According to above logs, there is an interrupt triggered and it is
dispatched to CPU31 with a vector number 151, but there is no handler for
it, thus this IRQ will not get acked and will cause an IRQ flood which
kills the system. To be more specific, the 31.151 is an interrupt from the
AHCI host controller.
After some investigation, the reason why this issue is triggered is because
the thaw\_noirq() function does not restore the MSI/MSI-X settings across
hibernation.
The scenario is illustrated below:
1. Before hibernation, IRQ 34 is the handler for the AHCI device, which
is bound to CPU31.
2. Hibernation starts, the AHCI device is put into low power state.
3. All the nonboot CPUs are put offline, so IRQ 34 has to be migrated to
the last alive one - CPU0.
4. After the snapshot has been created, all the nonboot CPUs are brought
up again; IRQ 34 remains bound to CPU0.
5. AHCI devices are put into D0.
6. The snapshot is written to the disk.
The issue is triggered in step 6. The AHCI interrupt should be delivered
to CPU0, however it is delivered to the original CPU31 instead, which
causes the "No irq handler" issue.
Ying Huang has provided a clue that, in step 3 it is possible that writing
to the register might not take effect as the PCI devices have been
suspended.
In step 3, the IRQ 34 affinity should be modified from CPU31 to CPU0, but
in fact it is not. In \_\_pci\_write\_msi\_msg(), if the device is already in
low power state, the low level MSI message entry will not be updated but
cached. During the device restore process after a normal suspend/resume,
pci\_restore\_msi\_state() writes the cached MSI back to the hardware.
But this is not the case for hibernation. pci\_restore\_msi\_state() is not
currently called in pci\_pm\_thaw\_noirq(), although pci\_save\_state() has
saved the necessary PCI cached information in pci\_pm\_freeze\_noirq().
Restore the PCI status for the device during hibernation. Otherwise the
status might be lost across hibernation (for example, settings for MSI,
MSI-X, ATS, ACS, IOV, etc.), which might cause problems during hibernation.
Suggested-by: Ying Huang
Suggested-by: Rafael J. Wysocki
Signed-off-by: Chen Yu
[bhelgaas: changelog]
Signed-off-by: Bjorn Helgaas
Reviewed-by: Rafael J. Wysocki
Cc: Len Brown
Cc: Dan Williams
Cc: Rui Zhang
Cc: Ying Huang
Signed-off-by: Greg Kroah-Hartman
commit 18fc66a885ebda727239742139524146fbaefb34
Author: Shawn Lin
Date: Mon Jul 3 17:21:02 2017 +0800
PCI: rockchip: Use normal register bank for config accessors
commit dc8cca5ef25ac4cb0dfc37467521a759767ff361 upstream.
Rockchip's RC has two banks of registers for the root port: a normal bank
that is strictly compatible with the PCIe spec, and a privileged bank that
can be used to change RO bits of root port registers.
When probing the RC driver, we use the privileged bank to do some basic
setup work as some RO bits are hw-inited to wrong value. But we didn't
change to the normal bank after probing the driver.
This leads to a serious problem when the PME code tries to clear the PME
status by writing PCI\_EXP\_RTSTA\_PME to the register of PCI\_EXP\_RTSTA. Per
PCIe 3.0 spec, section 7.8.14, the PME status bit is RW1C. So the PME code
is doing the right thing to clear the PME status but we find the RC doesn't
clear it but actually setting it to one. So finally the system trap in
pcie\_pme\_work\_fn() as PCI\_EXP\_RTSTA\_PME is true now forever. This issue
can be reproduced by booting kernel with pci=nomsi.
Use the normal register bank for the PCI config accessors. The privileged
bank is used only internally by this driver.
Fixes: e77f847d ("PCI: rockchip: Add Rockchip PCIe controller support")
Signed-off-by: Shawn Lin
Signed-off-by: Bjorn Helgaas
Cc: Jeffy Chen
Cc: Brian Norris
Signed-off-by: Greg Kroah-Hartman
commit 31f8d306b8eb38459370348b3ca2d1d9c07dbf86
Author: Bjorn Helgaas
Date: Fri Aug 19 16:30:25 2016 +0800
PCI: Work around poweroff & suspend-to-RAM issue on Macbook Pro 11
commit 13cfc732160f7bc7e596128ce34cda361c556966 upstream.
Neither soft poweroff (transition to ACPI power state S5) nor
suspend-to-RAM (transition to state S3) works on the Macbook Pro 11,4 and
11,5.
The problem is related to the [mem 0x7fa00000-0x7fbfffff] space. When we
use that space, e.g., by assigning it to the 00:1c.0 Root Port, the ACPI
Power Management 1 Control Register (PM1\_CNT) at [io 0x1804] doesn't work
anymore.
Linux does a soft poweroff (transition to S5) by writing to PM1\_CNT. The
theory about why this doesn't work is:
- The write to PM1\_CNT causes an SMI
- The BIOS SMI handler depends on something in
[mem 0x7fa00000-0x7fbfffff]
- When Linux assigns [mem 0x7fa00000-0x7fbfffff] to the 00:1c.0 Port, it
covers up whatever the SMI handler uses, so the SMI handler no longer
works correctly
Reserve the [mem 0x7fa00000-0x7fbfffff] space so we don't assign it to
anything.
This is voodoo programming, since we don't know what the real conflict is,
but we've failed to find the root cause.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=103211
Tested-by: thejoe@gmail.com
Signed-off-by: Bjorn Helgaas
Cc: Rafael J. Wysocki
Cc: Lukas Wunner
Cc: Chen Yu
Signed-off-by: Greg Kroah-Hartman
commit 2e09bcd1732da525da98c4f419cb79a65564e637
Author: Jon Derrick
Date: Thu Jun 22 09:15:42 2017 -0600
PCI: vmd: Move SRCU cleanup after bus, child device removal
commit 0cb259c47a4df466d641c1f07ae3eccaa9ba3ccb upstream.
Recent \_\_call\_srcu() changes have exposed that we need to cleanup SRCU
structures after pci\_stop\_root\_bus() calls into vmd\_msi\_free().
Fixes: 3906b91844d6 ("PCI: vmd: Use SRCU as a local RCU to prevent delaying global RCU")
Signed-off-by: Jon Derrick
Signed-off-by: Bjorn Helgaas
Acked-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 2614198e88934c9cc5900f4ee2a46a3865e4ea5c
Author: Juergen Gross
Date: Wed Jul 5 16:05:20 2017 +0200
xen/x86: fix cpu hotplug
commit c185ddec54657c145a0c2055e4b87918da24974f upstream.
Commit dc6416f1d711eb4c1726e845d653235dcaae12e1 ("xen/x86: Call
cpu\_startup\_entry(CPUHP\_AP\_ONLINE\_IDLE) from xen\_play\_dead()")
introduced an error leading to a stack overflow of the idle task when
a cpu was brought offline/online many times: by calling
cpu\_startup\_entry() instead of returning at the end of xen\_play\_dead()
do\_idle() would be entered again and again.
Don't use cpu\_startup\_entry(), but cpuhp\_online\_idle() instead allowing
to return from xen\_play\_dead().
Signed-off-by: Juergen Gross
Reviewed-by: Boris Ostrovsky
Signed-off-by: Juergen Gross
Signed-off-by: Greg Kroah-Hartman
commit 4fa26aab699a64f75058f422b5edf41f03eeb333
Author: Madhavan Srinivasan
Date: Tue Jul 11 16:27:49 2017 +0530
powerpc/perf: Fix SDAR\_MODE value for continous sampling on Power9
commit 20dd4c624d25156d5ec3345bbb690b98175ef879 upstream.
In case of continous sampling (non-marked), the code currently
sets MMCRA[SDAR\_MODE] to 0b01 (Update on TLB miss) for Power9 DD1.
On DD2 and later it copies the sdar\_mode value from the event code,
which for most events is 0b00 (No updates).
However we must set a non-zero value for SDAR\_MODE when doing
continuous sampling, so honor the event code, unless it's zero, in
which case we use use 0b01 (Update on TLB miss).
Fixes: 78b4416aa249 ("powerpc/perf: Handle sdar\_mode for marked event in power9")
Signed-off-by: Madhavan Srinivasan
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 27444f6571cd391ea37bd543e077bdf29f35cf07
Author: Benjamin Herrenschmidt
Date: Sat Jul 8 07:45:32 2017 -0500
powerpc/mm/radix: Properly clear process table entry
commit c6bb0b8d426a8cf865ca9c8a532cc3a2927cfceb upstream.
On radix, the process table entry we want to clear when destroying a
context is entry 0, not entry 1. This has no \*immediate\* consequence
on Power9, but it can cause other bugs to become worse.
Fixes: 7e381c0ff618 ("powerpc/mm/radix: Add mmu context handling callback for radix")
Signed-off-by: Benjamin Herrenschmidt
Reviewed-by: Aneesh Kumar K.V
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit e6c8bf1df68fb70564f4ca002c1d83e9b5e57301
Author: Oliver O'Halloran
Date: Thu Jul 6 18:46:43 2017 +1000
powerpc/asm: Mark cr0 as clobbered in mftb()
commit 2400fd822f467cb4c886c879d8ad99feac9cf319 upstream.
The workaround for the CELL timebase bug does not correctly mark cr0 as
being clobbered. This means GCC doesn't know that the asm block changes cr0 and
might leave the result of an unrelated comparison in cr0 across the block, which
we then trash, leading to basically random behaviour.
Fixes: 859deea949c3 ("[POWERPC] Cell timebase bug workaround")
Signed-off-by: Oliver O'Halloran
[mpe: Tweak change log and flag for stable]
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 0b4226798486d45e5a94cbbe81ef01a42ffc61c9
Author: Anton Blanchard
Date: Thu Jun 15 09:46:39 2017 +1000
powerpc: Fix emulation of mfocrf in emulate\_step()
commit 64e756c55aa46fc18fd53e8f3598b73b528d8637 upstream.
From POWER4 onwards, mfocrf() only places the specified CR field into
the destination GPR, and the rest of it is set to 0. The PowerPC AS
from version 3.0 now requires this behaviour.
The emulation code currently puts the entire CR into the destination GPR.
Fix it.
Fixes: 6888199f7fe5 ("[POWERPC] Emulate more instructions in software")
Signed-off-by: Anton Blanchard
Acked-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 9c4614c44e1dcc31599a8d983623878e9c1c9e45
Author: Anton Blanchard
Date: Thu Jun 15 09:46:38 2017 +1000
powerpc: Fix emulation of mcrf in emulate\_step()
commit 87c4b83e0fe234a1f0eed131ab6fa232036860d5 upstream.
The mcrf emulation code was using the CR field number directly as the shift
value, without taking into account that CR fields are numbered from 0-7 starting
at the high bits. That meant it was looking at the CR fields in the reverse
order.
Fixes: cf87c3f6b647 ("powerpc: Emulate icbi, mcrf and conditional-trap instructions")
Signed-off-by: Anton Blanchard
Acked-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 1e605f20580759892d896cd123b6e906f3f35877
Author: Michael Ellerman
Date: Tue Jul 11 22:10:54 2017 +1000
powerpc/64: Fix atomic64\_inc\_not\_zero() to return an int
commit 01e6a61aceb82e13bec29502a8eb70d9574f97ad upstream.
Although it's not documented anywhere, there is an expectation that
atomic64\_inc\_not\_zero() returns a result which fits in an int. This is
the behaviour implemented on all arches except powerpc.
This has caused at least one bug in practice, in the percpu-refcount
code, where the long result from our atomic64\_inc\_not\_zero() was
truncated to an int leading to lost references and stuck systems. That
was worked around in that code in commit 966d2b04e070 ("percpu-refcount:
fix reference leak during percpu-atomic transition").
To the best of my grepping abilities there are no other callers
in-tree which truncate the value, but we should fix it anyway. Because
the breakage is subtle and potentially very harmful I'm also tagging
it for stable.
Code generation is largely unaffected because in most cases the
callers are just using the result for a test anyway. In particular the
case of fget() that was mentioned in commit a6cf7ed5119f
("powerpc/atomic: Implement atomic\*\_inc\_not\_zero") generates exactly
the same code.
Fixes: a6cf7ed5119f ("powerpc/atomic: Implement atomic\*\_inc\_not\_zero")
Noticed-by: Linus Torvalds
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 13f46943f51e2b763a73a19722c9f57afc855f4e
Author: Balbir Singh
Date: Thu Jun 29 03:04:10 2017 +1000
powerpc/mm/radix: Fix execute permissions for interrupt\_vectors
commit 7f6d498ed3354740cfd100e4aa99e388f1a95be7 upstream.
Commit 9abcc981de97 ("powerpc/mm/radix: Only add X for pages
overlapping kernel text") changed the linear mapping on Radix to only
mark the kernel text executable.
However if the kernel is run relocated, for example as a kdump kernel,
then the exception vectors are split from the kernel text, ie. they
remain at real address 0.
We tend to get away with it, because the kernel itself will usually be
below 1G, which means the 1G page at 0-1G is marked executable and
everything works OK. However if the kernel is loaded above 1G, or the
system has less than 1G in total (meaning we can't use a 1G page),
then the exception vectors will not be marked executable and the
kernel will fail to boot.
Fix it by also checking if the address range overlaps the exception
vectors when deciding if we should add PAGE\_KERNEL\_X.
Fixes: 9abcc981de97 ("powerpc/mm/radix: Only add X for pages overlapping kernel text")
Signed-off-by: Balbir Singh
[mpe: Combine with the existing check, rewrite change log]
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit f349607b7aa58801d7b6cdc84a5ca7760d581b2c
Author: Balbir Singh
Date: Thu Jun 29 03:04:07 2017 +1000
powerpc/pseries: Fix passing of pp0 in updatepp() and updateboltedpp()
commit e71ff982ae4c17d176e9f0132157d54973788377 upstream.
Once upon a time there were only two PP (page protection) bits. In ISA
2.03 an additional PP bit was added, but because of the layout of the
HPTE it could not be made contiguous with the existing PP bits.
The result is that we now have three PP bits, named pp0, pp1, pp2,
where pp0 occupies bit 63 of dword 1 of the HPTE and pp1 and pp2
occupy bits 1 and 0 respectively. Until recently Linux hasn't used
pp0, however with the addition of \_PAGE\_KERNEL\_RO we started using it.
The problem arises in the LPAR code, where we need to translate the PP
bits into the argument for the H\_PROTECT hypercall. Currently the code
only passes bits 0-2 of newpp, which covers pp1, pp2 and N (no
execute), meaning pp0 is not passed to the hypervisor at all.
We can't simply pass it through in bit 63, as that would collide with a
different field in the flags argument, as defined in PAPR. Instead we
have to shift it down to bit 8 (IBM bit 55).
Fixes: e58e87adc8bf ("powerpc/mm: Update \_PAGE\_KERNEL\_RO")
Signed-off-by: Balbir Singh
[mpe: Simplify the test, rework change log]
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit cab0b22bfdc5c714c2021035db9da724c631f0b3
Author: Michael Ellerman
Date: Tue Jun 6 15:48:57 2017 +1000
powerpc/mm/radix: Only add X for pages overlapping kernel text
commit 9abcc981de9775659a0f6e4a52a3448ea72e59da upstream.
Currently we map the whole linear mapping with PAGE\_KERNEL\_X. Instead we
should check if the page overlaps the kernel text and only then add
PAGE\_KERNEL\_X.
Note that we still use 1G pages if they're available, so this will
typically still result in a 1G executable page at KERNELBASE. So this fix is
primarily useful for catching stray branches to high linear mapping addresses.
Without this patch, we can execute at 1G in xmon using:
0:mon> m c000000040000000
c000000040000000 00 l
c000000040000000 00000000 01006038
c000000040000004 00000000 2000804e
c000000040000008 00000000 x
0:mon> di c000000040000000
c000000040000000 38600001 li r3,1
c000000040000004 4e800020 blr
0:mon> p c000000040000000
return value is 0x1
After we get a 400 as expected:
0:mon> p c000000040000000
\*\*\* 400 exception occurred
Fixes: 2bfd65e45e87 ("powerpc/mm/radix: Add radix callbacks for early init routines")
Signed-off-by: Michael Ellerman
Reviewed-by: Aneesh Kumar K.V
Acked-by: Balbir Singh
Signed-off-by: Greg Kroah-Hartman
commit db367439b12800221e0aafb0bf11180269fb1a53
Author: Paolo Bonzini
Date: Wed Jul 5 10:30:56 2017 +0200
scsi: virtio\_scsi: always read VPD pages for multiqueue too
commit a680f1d463aeaeb00d22af257a56e111967c2f18 upstream.
Multi-queue virtio-scsi uses a different scsi\_host\_template struct. Add
the .device\_alloc field there, too.
Fixes: 25d1d50e23275e141e3a3fe06c25a99f4c4bf4e0
Cc: David Gibson
Signed-off-by: Paolo Bonzini
Reviewed-by: Fam Zheng
Reviewed-by: Stefan Hajnoczi
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 26e21de7d0e22b6c8c53b60fe49127d1dac53183
Author: Bart Van Assche
Date: Tue May 23 16:48:36 2017 -0700
xen/scsiback: Fix a TMR related use-after-free
commit 9f4ab18ac51dc87345a9cbd2527e6acf7a0a9335 upstream.
scsiback\_release\_cmd() must not dereference se\_cmd->se\_tmr\_req
because that memory is freed by target\_free\_cmd\_mem() before
scsiback\_release\_cmd() is called. Fix this use-after-free by
inlining struct scsiback\_tmr into struct vscsibk\_pend.
Signed-off-by: Bart Van Assche
Reviewed-by: Juergen Gross
Cc: Christoph Hellwig
Cc: Hannes Reinecke
Cc: David Disseldorp
Cc: xen-devel@lists.xenproject.org
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 430c78c7a839c6b750999e197904a35fbff9c94d
Author: Nicholas Bellinger
Date: Fri Jul 7 14:45:49 2017 -0700
iscsi-target: Add login\_keys\_workaround attribute for non RFC initiators
commit 138d351eefb727ab9e41a3dc5f112ceb4f6e59f2 upstream.
This patch re-introduces part of a long standing login workaround that
was recently dropped by:
commit 1c99de981f30b3e7868b8d20ce5479fa1c0fea46
Author: Nicholas Bellinger
Date: Sun Apr 2 13:36:44 2017 -0700
iscsi-target: Drop work-around for legacy GlobalSAN initiator
Namely, the workaround for FirstBurstLength ended up being required by
Mellanox Flexboot PXE boot ROMs as reported by Robert.
So this patch re-adds the work-around for FirstBurstLength within
iscsi\_check\_proposer\_for\_optional\_reply(), and makes the key optional
to respond when the initiator does not propose, nor respond to it.
Also as requested by Arun, this patch introduces a new TPG attribute
named 'login\_keys\_workaround' that controls the use of both the
FirstBurstLength workaround, as well as the two other existing
workarounds for gPXE iSCSI boot client.
By default, the workaround is enabled with login\_keys\_workaround=1,
since Mellanox FlexBoot requires it, and Arun has verified the Qlogic
MSFT initiator already proposes FirstBurstLength, so it's uneffected
by this re-adding this part of the original work-around.
Reported-by: Robert LeBlanc
Cc: Robert LeBlanc
Reviewed-by: Arun Easi
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit bbfbcfa3bc2f29277cf5b25c5d09228518e1d3c3
Author: Bart Van Assche
Date: Fri Jun 2 14:21:52 2017 -0700
scsi: Avoid that scsi\_exit\_rq() triggers a use-after-free
commit 8e6882545d8c06f99e9e117741cc87f3338b0bef upstream.
Dereferencing shost from scsi\_exit\_rq() is not safe because the SCSI
host may already have been freed when scsi\_exit\_rq() is called.
Increasing the shost reference count in scsi\_init\_rq() and dropping that
reference in scsi\_exit\_rq() is nontrivial since scsi\_host\_dev\_release()
may sleep and since scsi\_exit\_rq() may be called from interrupt
context. Since scsi\_exit\_rq() only needs a single bit from shost, copy
that bit into struct scsi\_cmnd.
Reported-by: Scott Bauer
Fixes: e9c787e65c0c ("scsi: allocate scsi\_cmnd structures as part of struct request")
Signed-off-by: Bart Van Assche
Reviewed-by: Christoph Hellwig
Cc: Hannes Reinecke
Cc: Scott Bauer
Cc: Jan Kara
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit d5ec2793a65264c06949fedbeb2582dd93b7f49d
Author: Ewan D. Milne
Date: Tue Jun 27 14:55:58 2017 -0400
scsi: Add STARGET\_CREATED\_REMOVE state to scsi\_target\_state
commit f9279c968c257ee39b0d7bd2571a4d231a67bcc1 upstream.
The addition of the STARGET\_REMOVE state had the side effect of
introducing a race condition that can cause a crash.
scsi\_target\_reap\_ref\_release() checks the starget->state to
see if it still in STARGET\_CREATED, and if so, skips calling
transport\_remove\_device() and device\_del(), because the starget->state
is only set to STARGET\_RUNNING after scsi\_target\_add() has called
device\_add() and transport\_add\_device().
However, if an rport loss occurs while a target is being scanned,
it can happen that scsi\_remove\_target() will be called while the
starget is still in the STARGET\_CREATED state. In this case, the
starget->state will be set to STARGET\_REMOVE, and as a result,
scsi\_target\_reap\_ref\_release() will take the wrong path. The end
result is a panic:
[ 1255.356653] Oops: 0000 [#1] SMP
[ 1255.360154] Modules linked in: x86\_pkg\_temp\_thermal kvm\_intel kvm irqbypass crc32c\_intel ghash\_clmulni\_i
[ 1255.393234] CPU: 5 PID: 149 Comm: kworker/u96:4 Tainted: G W 4.11.0+ #8
[ 1255.401879] Hardware name: Dell Inc. PowerEdge R320/08VT7V, BIOS 2.0.22 11/19/2013
[ 1255.410327] Workqueue: scsi\_wq\_6 fc\_scsi\_scan\_rport [scsi\_transport\_fc]
[ 1255.417720] task: ffff88060ca8c8c0 task.stack: ffffc900048a8000
[ 1255.424331] RIP: 0010:kernfs\_find\_ns+0x13/0xc0
[ 1255.429287] RSP: 0018:ffffc900048abbf0 EFLAGS: 00010246
[ 1255.435123] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
[ 1255.443083] RDX: 0000000000000000 RSI: ffffffff8188d659 RDI: 0000000000000000
[ 1255.451043] RBP: ffffc900048abc10 R08: 0000000000000000 R09: 0000012433fe0025
[ 1255.459005] R10: 0000000025e5a4b5 R11: 0000000025e5a4b5 R12: ffffffff8188d659
[ 1255.466972] R13: 0000000000000000 R14: ffff8805f55e5088 R15: 0000000000000000
[ 1255.474931] FS: 0000000000000000(0000) GS:ffff880616b40000(0000) knlGS:0000000000000000
[ 1255.483959] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1255.490370] CR2: 0000000000000068 CR3: 0000000001c09000 CR4: 00000000000406e0
[ 1255.498332] Call Trace:
[ 1255.501058] kernfs\_find\_and\_get\_ns+0x31/0x60
[ 1255.505916] sysfs\_unmerge\_group+0x1d/0x60
[ 1255.510498] dpm\_sysfs\_remove+0x22/0x60
[ 1255.514783] device\_del+0xf4/0x2e0
[ 1255.518577] ? device\_remove\_file+0x19/0x20
[ 1255.523241] attribute\_container\_class\_device\_del+0x1a/0x20
[ 1255.529457] transport\_remove\_classdev+0x4e/0x60
[ 1255.534607] ? transport\_add\_class\_device+0x40/0x40
[ 1255.540046] attribute\_container\_device\_trigger+0xb0/0xc0
[ 1255.546069] transport\_remove\_device+0x15/0x20
[ 1255.551025] scsi\_target\_reap\_ref\_release+0x25/0x40
[ 1255.556467] scsi\_target\_reap+0x2e/0x40
[ 1255.560744] \_\_scsi\_scan\_target+0xaa/0x5b0
[ 1255.565312] scsi\_scan\_target+0xec/0x100
[ 1255.569689] fc\_scsi\_scan\_rport+0xb1/0xc0 [scsi\_transport\_fc]
[ 1255.576099] process\_one\_work+0x14b/0x390
[ 1255.580569] worker\_thread+0x4b/0x390
[ 1255.584651] kthread+0x109/0x140
[ 1255.588251] ? rescuer\_thread+0x330/0x330
[ 1255.592730] ? kthread\_park+0x60/0x60
[ 1255.596815] ret\_from\_fork+0x29/0x40
[ 1255.600801] Code: 24 08 48 83 42 40 01 5b 41 5c 5d c3 66 66 66 2e 0f 1f 84 00 00 00 00 00 66 66 66 66 90
[ 1255.621876] RIP: kernfs\_find\_ns+0x13/0xc0 RSP: ffffc900048abbf0
[ 1255.628479] CR2: 0000000000000068
[ 1255.632756] ---[ end trace 34a69ba0477d036f ]---
Fix this by adding another scsi\_target state STARGET\_CREATED\_REMOVE
to distinguish this case.
Fixes: f05795d3d771 ("scsi: Add intermediate STARGET\_REMOVE state to scsi\_target\_state")
Reported-by: David Jeffery
Signed-off-by: Ewan D. Milne
Reviewed-by: Laurence Oberman
Tested-by: Laurence Oberman
Reviewed-by: Johannes Thumshirn
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 1dfabed337ad9a44642e2f836701dc9f57afe4c5
Author: Quinn Tran
Date: Fri Jun 2 09:11:53 2017 -0700
scsi: qla2xxx: Allow ABTS, PURX, RIDA on ATIOQ for ISP83XX/27XX
commit 3c4810ffdc8e4f34d387f59baf0abefcfa4ada6a upstream.
Driver added mechanism to move ABTS/PUREX/RIDA mailbox to
ATIO queue as part of commit id 41dc529a4602ac737020f423f84686a81de38e6d
("qla2xxx: Improve RSCN handling in driver").
This patch adds a check to only allow ABTS/PURX/RIDA
to be moved to ATIO Queue for ISP83XX and ISP27XX.
Signed-off-by: Quinn Tran
Signed-off-by: Himanshu Madhani
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 2ced4c4ce3c8801663b9fbd1fa64ce88bb9e94fe
Author: Paolo Bonzini
Date: Wed Jun 21 16:35:46 2017 +0200
scsi: virtio\_scsi: let host do exception handling
commit e72c9a2a67a6400c8ef3d01d4c461dbbbfa0e1f0 upstream.
virtio\_scsi tries to do exception handling after the default 30 seconds
timeout expires. However, it's better to let the host control the
timeout, otherwise with a heavy I/O load it is likely that an abort will
also timeout. This leads to fatal errors like filesystems going
offline.
Disable the 'sd' timeout and allow the host to do exception handling,
following the precedent of the storvsc driver.
Hannes has a proposal to introduce timeouts in virtio, but this provides
an immediate solution for stable kernels too.
[mkp: fixed typo]
Reported-by: Douglas Miller
Cc: "James E.J. Bottomley"
Cc: "Martin K. Petersen"
Cc: Hannes Reinecke
Cc: linux-scsi@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ad8e43cfadd2de6c065eabef2069b83f13e1a4e2
Author: Maurizio Lombardi
Date: Tue Jun 27 11:53:27 2017 +0200
scsi: ses: do not add a device to an enclosure if enclosure\_add\_links() fails.
commit 62e62ffd95539b9220894a7900a619e0f3ef4756 upstream.
The enclosure\_add\_device() function should fail if it can't create the
relevant sysfs links.
Signed-off-by: Maurizio Lombardi
Tested-by: Douglas Miller
Acked-by: James Bottomley
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit adc0157721d07473e1455c669d20fd615373631f
Author: Krzysztof Kozlowski
Date: Wed Jun 28 16:56:20 2017 +0200
PM / Domains: Fix unsafe iteration over modified list of domains
commit a7e2d1bce4c1db471f1cbc0c4666a3112bbf0994 upstream.
of\_genpd\_remove\_last() iterates over list of domains and removes
matching element thus it has to use safe version of list iteration.
Fixes: 17926551c98a (PM / Domains: Add support for removing nested PM domains by provider)
Signed-off-by: Krzysztof Kozlowski
Acked-by: Ulf Hansson
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 01ee0ee75933c106bc8772491fb9d287439e9b5f
Author: Krzysztof Kozlowski
Date: Wed Jun 28 16:56:19 2017 +0200
PM / Domains: Fix unsafe iteration over modified list of domain providers
commit b556b15dc04e9b9b98790f04c21acf5e24f994b2 upstream.
of\_genpd\_del\_provider() iterates over list of domain provides and
removes matching element thus it has to use safe version of list
iteration.
Fixes: aa42240ab254 (PM / Domains: Add generic OF-based PM domain look-up)
Signed-off-by: Krzysztof Kozlowski
Acked-by: Ulf Hansson
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 61461312f0b0eb4e71915efd4c852baa7aa2b4b1
Author: Krzysztof Kozlowski
Date: Wed Jun 28 16:56:18 2017 +0200
PM / Domains: Fix unsafe iteration over modified list of device links
commit c6e83cac3eda5f7dd32ee1453df2f7abb5c6cd46 upstream.
pm\_genpd\_remove\_subdomain() iterates over domain's master\_links list and
removes matching element thus it has to use safe version of list
iteration.
Fixes: f721889ff65a ("PM / Domains: Support for generic I/O PM domains (v8)")
Signed-off-by: Krzysztof Kozlowski
Acked-by: Ulf Hansson
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 5a18ee01953f7185974bb21cac31c424d4fa350d
Author: Peter Rosin
Date: Wed May 31 14:32:33 2017 +0200
ASoC: atmel: tse850: fix off-by-one in the "ANA" enumeration count
commit a00cebf51d5ceed8ba9f6fac5fb189b38cd5a7c2 upstream.
At some point I added the "Low" entry at the beginning of the array
without bumping the enumeration count from 9 to 10. Fix this. While at
it, fix the anti-pattern for the other enumeration (used by MUX{1,2}).
Fixes: aa43112445f0 ("ASoC: atmel: tse850: add ASoC driver for the Axentia TSE-850")
Signed-off-by: Peter Rosin
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 8024384eeb078a79d22494413a4652272bac7ea3
Author: Satish Babu Patakokila
Date: Fri Jun 16 17:33:40 2017 -0700
ASoC: compress: Derive substream from stream based on direction
commit 01b8cedfd0422326caae308641dcadaa85e0ca72 upstream.
Currently compress driver hardcodes direction as playback to get
substream from the stream. This results in getting the incorrect
substream for compressed capture usecase.
To fix this, remove the hardcoding and derive substream based on
the stream direction.
Signed-off-by: Satish Babu Patakokila
Signed-off-by: Banajit Goswami
Acked-By: Vinod Koul
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 1f3fb26751321b592e5d800316e7598e7c4d9d96
Author: Shawn Guo
Date: Sat Jun 17 22:25:28 2017 +0800
ASoC: zx-i2s: flip I2S master/slave mode
commit a205c159f9e2db586a5ea475f4d22fa22e78fed8 upstream.
The SND\_SOC\_DAIFMT\_MASTER bits are defined to specify the master/slave
mode for Codec, not I2S. So the I2S master/slave mode should be flipped
according to SND\_SOC\_DAIFMT\_MASTER bits.
Signed-off-by: Shawn Guo
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 2e74a4f521f9f8df7d3ab4be0806dab25084c20d
Author: Cyrille Pitchen
Date: Fri Jun 23 17:39:16 2017 +0200
spi: atmel: fix corrupted data issue on SAM9 family SoCs
commit 7094576ccdc3acfe1e06a1e2ab547add375baf7f upstream.
This patch disables the use of the DMA for data transfer and forces the
use of PIO transfers instead as a quick fixup to solve the cache aliasing
issue on ARM9 based cores, which embeds a VIVT data cache.
Indeed in the case of VIVT data caches, it is not safe to call dma\_map\_\*()
functions to map buffers for DMA transfers when those buffers have been
allocated by vmalloc() or from any DMA-unsafe area.
Further patches may propose a better solution based on the use of a bounce
buffer at the SPI sub-system level but such solution needs more time to be
discussed. Then the use of DMA transfers could be enabled again to improve
the performances but before that, this patch already solves the issue.
Signed-off-by: Cyrille Pitchen
Acked-by: Nicolas Ferre
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 9317c1d0abe51f5d11ef295b2f94fc91268b56e5
Author: Matwey V Kornilov
Date: Thu Nov 24 13:32:48 2016 +0300
igb: Explicitly select page 0 at initialization
commit 440aeca4b9858248d8f16d724d9fa87a4f65fa33 upstream.
The functions igb\_read\_phy\_reg\_gs40g/igb\_write\_phy\_reg\_gs40g (which were
removed in 2a3cdea) explicitly selected the required page at every phy\_reg
access. Currently, igb\_get\_phy\_id\_82575 relays on the fact that page 0 is
already selected. The assumption is not fulfilled for my Lex 3I380CW
motherboard with integrated dual i211 based gigabit ethernet. This leads to igb
initialization failure and network interfaces are not working:
igb: Intel(R) Gigabit Ethernet Network Driver - version 5.4.0-k
igb: Copyright (c) 2007-2014 Intel Corporation.
igb: probe of 0000:01:00.0 failed with error -2
igb: probe of 0000:02:00.0 failed with error -2
In order to fix it, we explicitly select page 0 before first access to phy
registers.
See also: https://bugzilla.suse.com/show\_bug.cgi?id=1009911
See also: http://www.lex.com.tw/products/pdf/3I380A&3I380CW.pdf
Fixes: 2a3cdea ("igb: Remove GS40G specific defines/functions")
Signed-off-by: Matwey V Kornilov
Tested-by: Aaron Brown
Signed-off-by: Jeff Kirsher
Signed-off-by: Greg Kroah-Hartman
commit 114571a8a2bca1b418dab9b0391c42de521ed753
Author: Filipe Manana
Date: Thu Jul 6 15:31:46 2017 +0100
Btrfs: incremental send, fix invalid memory access
commit 24e52b11e0ca788513b945a87b57cc0522a92933 upstream.
When doing an incremental send, while processing an extent that changed
between the parent and send snapshots and that extent was an inline extent
in the parent snapshot, it's possible to access a memory region beyond
the end of leaf if the inline extent is very small and it is the first
item in a leaf.
An example scenario is described below.
The send snapshot has the following leaf:
leaf 33865728 items 33 free space 773 generation 46 owner 5
fs uuid ab7090d8-dafd-4fb9-9246-723b6d2e2fb7
chunk uuid 2d16478c-c704-4ab9-b574-68bff2281b1f
(...)
item 14 key (335 EXTENT\_DATA 0) itemoff 3052 itemsize 53
generation 36 type 1 (regular)
extent data disk byte 12791808 nr 4096
extent data offset 0 nr 4096 ram 4096
extent compression 0 (none)
item 15 key (335 EXTENT\_DATA 8192) itemoff 2999 itemsize 53
generation 36 type 1 (regular)
extent data disk byte 138170368 nr 225280
extent data offset 0 nr 225280 ram 225280
extent compression 0 (none)
(...)
And the parent snapshot has the following leaf:
leaf 31272960 items 17 free space 17 generation 31 owner 5
fs uuid ab7090d8-dafd-4fb9-9246-723b6d2e2fb7
chunk uuid 2d16478c-c704-4ab9-b574-68bff2281b1f
item 0 key (335 EXTENT\_DATA 0) itemoff 3951 itemsize 44
generation 31 type 0 (inline)
inline extent data size 23 ram\_bytes 613 compression 1 (zlib)
(...)
When computing the send stream, it is detected that the extent of inode
335, at file offset 0, and at fs/btrfs/send.c:is\_extent\_unchanged() we
grab the leaf from the parent snapshot and access the inline extent item.
However, before jumping to the 'out' label, we access the 'offset' and
'disk\_bytenr' fields of the extent item, which should not be done for
inline extents since the inlined data starts at the offset of the
'disk\_bytenr' field and can be very small. For example accessing the
'offset' field of the file extent item results in the following trace:
[ 599.705368] general protection fault: 0000 [#1] PREEMPT SMP
[ 599.706296] Modules linked in: btrfs psmouse i2c\_piix4 ppdev acpi\_cpufreq serio\_raw parport\_pc i2c\_core evdev tpm\_tis tpm\_tis\_core sg pcspkr parport tpm button su$
[ 599.709340] CPU: 7 PID: 5283 Comm: btrfs Not tainted 4.10.0-rc8-btrfs-next-46+ #1
[ 599.709340] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.1-0-gb3ef39f-prebuilt.qemu-project.org 04/01/2014
[ 599.709340] task: ffff88023eedd040 task.stack: ffffc90006658000
[ 599.709340] RIP: 0010:read\_extent\_buffer+0xdb/0xf4 [btrfs]
[ 599.709340] RSP: 0018:ffffc9000665ba00 EFLAGS: 00010286
[ 599.709340] RAX: db73880000000000 RBX: 0000000000000000 RCX: 0000000000000001
[ 599.709340] RDX: ffffc9000665ba60 RSI: db73880000000000 RDI: ffffc9000665ba5f
[ 599.709340] RBP: ffffc9000665ba30 R08: 0000000000000001 R09: ffff88020dc5e098
[ 599.709340] R10: 0000000000001000 R11: 0000160000000000 R12: 6db6db6db6db6db7
[ 599.709340] R13: ffff880000000000 R14: 0000000000000000 R15: ffff88020dc5e088
[ 599.709340] FS: 00007f519555a8c0(0000) GS:ffff88023f3c0000(0000) knlGS:0000000000000000
[ 599.709340] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 599.709340] CR2: 00007f1411afd000 CR3: 0000000235f8e000 CR4: 00000000000006e0
[ 599.709340] Call Trace:
[ 599.709340] btrfs\_get\_token\_64+0x93/0xce [btrfs]
[ 599.709340] ? printk+0x48/0x50
[ 599.709340] btrfs\_get\_64+0xb/0xd [btrfs]
[ 599.709340] process\_extent+0x3a1/0x1106 [btrfs]
[ 599.709340] ? btree\_read\_extent\_buffer\_pages+0x5/0xef [btrfs]
[ 599.709340] changed\_cb+0xb03/0xb3d [btrfs]
[ 599.709340] ? btrfs\_get\_token\_32+0x7a/0xcc [btrfs]
[ 599.709340] btrfs\_compare\_trees+0x432/0x53d [btrfs]
[ 599.709340] ? process\_extent+0x1106/0x1106 [btrfs]
[ 599.709340] btrfs\_ioctl\_send+0x960/0xe26 [btrfs]
[ 599.709340] btrfs\_ioctl+0x181b/0x1fed [btrfs]
[ 599.709340] ? trace\_hardirqs\_on\_caller+0x150/0x1ac
[ 599.709340] vfs\_ioctl+0x21/0x38
[ 599.709340] ? vfs\_ioctl+0x21/0x38
[ 599.709340] do\_vfs\_ioctl+0x611/0x645
[ 599.709340] ? rcu\_read\_unlock+0x5b/0x5d
[ 599.709340] ? \_\_fget+0x6d/0x79
[ 599.709340] SyS\_ioctl+0x57/0x7b
[ 599.709340] entry\_SYSCALL\_64\_fastpath+0x18/0xad
[ 599.709340] RIP: 0033:0x7f51945eec47
[ 599.709340] RSP: 002b:00007ffc21c13e98 EFLAGS: 00000202 ORIG\_RAX: 0000000000000010
[ 599.709340] RAX: ffffffffffffffda RBX: ffffffff81096459 RCX: 00007f51945eec47
[ 599.709340] RDX: 00007ffc21c13f20 RSI: 0000000040489426 RDI: 0000000000000004
[ 599.709340] RBP: ffffc9000665bf98 R08: 00007f519450d700 R09: 00007f519450d700
[ 599.709340] R10: 00007f519450d9d0 R11: 0000000000000202 R12: 0000000000000046
[ 599.709340] R13: ffffc9000665bf78 R14: 0000000000000000 R15: 00007f5195574040
[ 599.709340] ? trace\_hardirqs\_off\_caller+0x43/0xb1
[ 599.709340] Code: 29 f0 49 39 d8 4c 0f 47 c3 49 03 81 58 01 00 00 44 89 c1 4c 01 c2 4c 29 c3 48 c1 f8 03 49 0f af c4 48 c1 e0 0c 4c 01 e8 48 01 c6  a4 31 f6 4$
[ 599.709340] RIP: read\_extent\_buffer+0xdb/0xf4 [btrfs] RSP: ffffc9000665ba00
[ 599.762057] ---[ end trace fe00d7af61b9f49e ]---
This is because the 'offset' field starts at an offset of 37 bytes
(offsetof(struct btrfs\_file\_extent\_item, offset)), has a length of 8
bytes and therefore attemping to read it causes a 1 byte access beyond
the end of the leaf, as the first item's content in a leaf is located
at the tail of the leaf, the item size is 44 bytes and the offset of
that field plus its length (37 + 8 = 45) goes beyond the item's size
by 1 byte.
So fix this by accessing the 'offset' and 'disk\_bytenr' fields after
jumping to the 'out' label if we are processing an inline extent. We
move the reading operation of the 'disk\_bytenr' field too because we
have the same problem as for the 'offset' field explained above when
the inline data is less then 8 bytes. The access to the 'generation'
field is also moved but just for the sake of grouping access to all
the fields.
Fixes: e1cbfd7bf6da ("Btrfs: send, fix file hole not being preserved due to inline extent")
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit 88b4b8154872fb13d320b92bc985debe55ffbb3f
Author: Jan Kara
Date: Thu Jun 22 15:31:07 2017 +0200
btrfs: Don't clear SGID when inheriting ACLs
commit b7f8a09f8097db776b8d160862540e4fc1f51296 upstream.
When new directory 'DIR1' is created in a directory 'DIR0' with SGID bit
set, DIR1 is expected to have SGID bit set (and owning group equal to
the owning group of 'DIR0'). However when 'DIR0' also has some default
ACLs that 'DIR1' inherits, setting these ACLs will result in SGID bit on
'DIR1' to get cleared if user is not member of the owning group.
Fix the problem by moving posix\_acl\_update\_mode() out of
\_\_btrfs\_set\_acl() into btrfs\_set\_acl(). That way the function will not be
called when inheriting ACLs which is what we want as it prevents SGID
bit clearing and the mode has been properly set by posix\_acl\_create()
anyway.
Fixes: 073931017b49d9458aa351605b43a7e34598caef
CC: linux-btrfs@vger.kernel.org
CC: David Sterba
Signed-off-by: Jan Kara
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit dad8a6e14678601ea7d013ca3d745a42f75c4458
Author: Filipe Manana
Date: Tue May 30 05:29:09 2017 +0100
Btrfs: fix invalid extent maps due to hole punching
commit 609805d809733d0c669f21f710bdac308cc63cba upstream.
While punching a hole in a range that is not aligned with the sector size
(currently the same as the page size) we can end up leaving an extent map
in memory with a length that is smaller then the sector size or with a
start offset that is not aligned to the sector size. Both cases are not
expected and can lead to problems. This issue is easily detected
after the patch from commit a7e3b975a0f9 ("Btrfs: fix reported number of
inode blocks"), introduced in kernel 4.12-rc1, in a scenario like the
following for example:
$ mkfs.btrfs -f /dev/sdb
$ mount /dev/sdb /mnt
$ xfs\_io -c "pwrite -S 0xaa -b 100K 0 100K" /mnt/foo
$ xfs\_io -c "fpunch 60K 90K" /mnt/foo
$ xfs\_io -c "pwrite -S 0xbb -b 100K 50K 100K" /mnt/foo
$ xfs\_io -c "pwrite -S 0xcc -b 50K 100K 50K" /mnt/foo
$ umount /mnt
After the unmount operation we can see several warnings emmitted due to
underflows related to space reservation counters:
[ 2837.443299] ------------[ cut here ]------------
[ 2837.447395] WARNING: CPU: 8 PID: 2474 at fs/btrfs/inode.c:9444 btrfs\_destroy\_inode+0xe8/0x27e [btrfs]
[ 2837.452108] Modules linked in: dm\_flakey dm\_mod ppdev parport\_pc psmouse parport sg pcspkr acpi\_cpufreq tpm\_tis tpm\_tis\_core i2c\_piix4 i2c\_core evdev tpm button se
rio\_raw sunrpc loop autofs4 ext4 crc16 jbd2 mbcache btrfs raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c crc32c\_gene
ric raid1 raid0 multipath linear md\_mod sr\_mod cdrom sd\_mod ata\_generic virtio\_scsi ata\_piix libata virtio\_pci virtio\_ring virtio e1000 scsi\_mod floppy
[ 2837.458389] CPU: 8 PID: 2474 Comm: umount Tainted: G W 4.10.0-rc8-btrfs-next-43+ #1
[ 2837.459754] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.1-0-gb3ef39f-prebuilt.qemu-project.org 04/01/2014
[ 2837.462379] Call Trace:
[ 2837.462379] dump\_stack+0x68/0x92
[ 2837.462379] \_\_warn+0xc2/0xdd
[ 2837.462379] warn\_slowpath\_null+0x1d/0x1f
[ 2837.462379] btrfs\_destroy\_inode+0xe8/0x27e [btrfs]
[ 2837.462379] destroy\_inode+0x3d/0x55
[ 2837.462379] evict+0x177/0x17e
[ 2837.462379] dispose\_list+0x50/0x71
[ 2837.462379] evict\_inodes+0x132/0x141
[ 2837.462379] generic\_shutdown\_super+0x3f/0xeb
[ 2837.462379] kill\_anon\_super+0x12/0x1c
[ 2837.462379] btrfs\_kill\_super+0x16/0x21 [btrfs]
[ 2837.462379] deactivate\_locked\_super+0x30/0x68
[ 2837.462379] deactivate\_super+0x36/0x39
[ 2837.462379] cleanup\_mnt+0x58/0x76
[ 2837.462379] \_\_cleanup\_mnt+0x12/0x14
[ 2837.462379] task\_work\_run+0x77/0x9b
[ 2837.462379] prepare\_exit\_to\_usermode+0x9d/0xc5
[ 2837.462379] syscall\_return\_slowpath+0x196/0x1b9
[ 2837.462379] entry\_SYSCALL\_64\_fastpath+0xab/0xad
[ 2837.462379] RIP: 0033:0x7f3ef3e6b9a7
[ 2837.462379] RSP: 002b:00007ffdd0d8de58 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a6
[ 2837.462379] RAX: 0000000000000000 RBX: 0000556f76a39060 RCX: 00007f3ef3e6b9a7
[ 2837.462379] RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000556f76a3f910
[ 2837.462379] RBP: 0000556f76a3f910 R08: 0000556f76a3e670 R09: 0000000000000015
[ 2837.462379] R10: 00000000000006b4 R11: 0000000000000246 R12: 00007f3ef436ce64
[ 2837.462379] R13: 0000000000000000 R14: 0000556f76a39240 R15: 00007ffdd0d8e0e0
[ 2837.519355] ---[ end trace e79345fe24b30b8d ]---
[ 2837.596256] ------------[ cut here ]------------
[ 2837.597625] WARNING: CPU: 8 PID: 2474 at fs/btrfs/extent-tree.c:5699 btrfs\_free\_block\_groups+0x246/0x3eb [btrfs]
[ 2837.603547] Modules linked in: dm\_flakey dm\_mod ppdev parport\_pc psmouse parport sg pcspkr acpi\_cpufreq tpm\_tis tpm\_tis\_core i2c\_piix4 i2c\_core evdev tpm button serio\_raw sunrpc loop autofs4 ext4 crc16 jbd2 mbcache btrfs raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod sr\_mod cdrom sd\_mod ata\_generic virtio\_scsi ata\_piix libata virtio\_pci virtio\_ring virtio e1000 scsi\_mod floppy
[ 2837.659372] CPU: 8 PID: 2474 Comm: umount Tainted: G W 4.10.0-rc8-btrfs-next-43+ #1
[ 2837.663359] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.1-0-gb3ef39f-prebuilt.qemu-project.org 04/01/2014
[ 2837.663359] Call Trace:
[ 2837.663359] dump\_stack+0x68/0x92
[ 2837.663359] \_\_warn+0xc2/0xdd
[ 2837.663359] warn\_slowpath\_null+0x1d/0x1f
[ 2837.663359] btrfs\_free\_block\_groups+0x246/0x3eb [btrfs]
[ 2837.663359] close\_ctree+0x1dd/0x2e1 [btrfs]
[ 2837.663359] ? evict\_inodes+0x132/0x141
[ 2837.663359] btrfs\_put\_super+0x15/0x17 [btrfs]
[ 2837.663359] generic\_shutdown\_super+0x6a/0xeb
[ 2837.663359] kill\_anon\_super+0x12/0x1c
[ 2837.663359] btrfs\_kill\_super+0x16/0x21 [btrfs]
[ 2837.663359] deactivate\_locked\_super+0x30/0x68
[ 2837.663359] deactivate\_super+0x36/0x39
[ 2837.663359] cleanup\_mnt+0x58/0x76
[ 2837.663359] \_\_cleanup\_mnt+0x12/0x14
[ 2837.663359] task\_work\_run+0x77/0x9b
[ 2837.663359] prepare\_exit\_to\_usermode+0x9d/0xc5
[ 2837.663359] syscall\_return\_slowpath+0x196/0x1b9
[ 2837.663359] entry\_SYSCALL\_64\_fastpath+0xab/0xad
[ 2837.663359] RIP: 0033:0x7f3ef3e6b9a7
[ 2837.663359] RSP: 002b:00007ffdd0d8de58 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a6
[ 2837.663359] RAX: 0000000000000000 RBX: 0000556f76a39060 RCX: 00007f3ef3e6b9a7
[ 2837.663359] RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000556f76a3f910
[ 2837.663359] RBP: 0000556f76a3f910 R08: 0000556f76a3e670 R09: 0000000000000015
[ 2837.663359] R10: 00000000000006b4 R11: 0000000000000246 R12: 00007f3ef436ce64
[ 2837.663359] R13: 0000000000000000 R14: 0000556f76a39240 R15: 00007ffdd0d8e0e0
[ 2837.739445] ---[ end trace e79345fe24b30b8e ]---
[ 2837.745595] ------------[ cut here ]------------
[ 2837.746412] WARNING: CPU: 8 PID: 2474 at fs/btrfs/extent-tree.c:5700 btrfs\_free\_block\_groups+0x261/0x3eb [btrfs]
[ 2837.747955] Modules linked in: dm\_flakey dm\_mod ppdev parport\_pc psmouse parport sg pcspkr acpi\_cpufreq tpm\_tis tpm\_tis\_core i2c\_piix4 i2c\_core evdev tpm button serio\_raw sunrpc loop autofs4 ext4 crc16 jbd2 mbcache btrfs raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod sr\_mod cdrom sd\_mod ata\_generic virtio\_scsi ata\_piix libata virtio\_pci virtio\_ring virtio e1000 scsi\_mod floppy
[ 2837.755395] CPU: 8 PID: 2474 Comm: umount Tainted: G W 4.10.0-rc8-btrfs-next-43+ #1
[ 2837.756769] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.1-0-gb3ef39f-prebuilt.qemu-project.org 04/01/2014
[ 2837.758526] Call Trace:
[ 2837.758925] dump\_stack+0x68/0x92
[ 2837.759383] \_\_warn+0xc2/0xdd
[ 2837.759383] warn\_slowpath\_null+0x1d/0x1f
[ 2837.759383] btrfs\_free\_block\_groups+0x261/0x3eb [btrfs]
[ 2837.759383] close\_ctree+0x1dd/0x2e1 [btrfs]
[ 2837.759383] ? evict\_inodes+0x132/0x141
[ 2837.759383] btrfs\_put\_super+0x15/0x17 [btrfs]
[ 2837.759383] generic\_shutdown\_super+0x6a/0xeb
[ 2837.759383] kill\_anon\_super+0x12/0x1c
[ 2837.759383] btrfs\_kill\_super+0x16/0x21 [btrfs]
[ 2837.759383] deactivate\_locked\_super+0x30/0x68
[ 2837.759383] deactivate\_super+0x36/0x39
[ 2837.759383] cleanup\_mnt+0x58/0x76
[ 2837.759383] \_\_cleanup\_mnt+0x12/0x14
[ 2837.759383] task\_work\_run+0x77/0x9b
[ 2837.759383] prepare\_exit\_to\_usermode+0x9d/0xc5
[ 2837.759383] syscall\_return\_slowpath+0x196/0x1b9
[ 2837.759383] entry\_SYSCALL\_64\_fastpath+0xab/0xad
[ 2837.759383] RIP: 0033:0x7f3ef3e6b9a7
[ 2837.759383] RSP: 002b:00007ffdd0d8de58 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a6
[ 2837.759383] RAX: 0000000000000000 RBX: 0000556f76a39060 RCX: 00007f3ef3e6b9a7
[ 2837.759383] RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000556f76a3f910
[ 2837.759383] RBP: 0000556f76a3f910 R08: 0000556f76a3e670 R09: 0000000000000015
[ 2837.759383] R10: 00000000000006b4 R11: 0000000000000246 R12: 00007f3ef436ce64
[ 2837.759383] R13: 0000000000000000 R14: 0000556f76a39240 R15: 00007ffdd0d8e0e0
[ 2837.777063] ---[ end trace e79345fe24b30b8f ]---
[ 2837.778235] ------------[ cut here ]------------
[ 2837.778856] WARNING: CPU: 8 PID: 2474 at fs/btrfs/extent-tree.c:9825 btrfs\_free\_block\_groups+0x348/0x3eb [btrfs]
[ 2837.791385] Modules linked in: dm\_flakey dm\_mod ppdev parport\_pc psmouse parport sg pcspkr acpi\_cpufreq tpm\_tis tpm\_tis\_core i2c\_piix4 i2c\_core evdev tpm button serio\_raw sunrpc loop autofs4 ext4 crc16 jbd2 mbcache btrfs raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod sr\_mod cdrom sd\_mod ata\_generic virtio\_scsi ata\_piix libata virtio\_pci virtio\_ring virtio e1000 scsi\_mod floppy
[ 2837.797711] CPU: 8 PID: 2474 Comm: umount Tainted: G W 4.10.0-rc8-btrfs-next-43+ #1
[ 2837.798594] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.1-0-gb3ef39f-prebuilt.qemu-project.org 04/01/2014
[ 2837.800118] Call Trace:
[ 2837.800515] dump\_stack+0x68/0x92
[ 2837.801015] \_\_warn+0xc2/0xdd
[ 2837.801471] warn\_slowpath\_null+0x1d/0x1f
[ 2837.801698] btrfs\_free\_block\_groups+0x348/0x3eb [btrfs]
[ 2837.801698] close\_ctree+0x1dd/0x2e1 [btrfs]
[ 2837.801698] ? evict\_inodes+0x132/0x141
[ 2837.801698] btrfs\_put\_super+0x15/0x17 [btrfs]
[ 2837.801698] generic\_shutdown\_super+0x6a/0xeb
[ 2837.801698] kill\_anon\_super+0x12/0x1c
[ 2837.801698] btrfs\_kill\_super+0x16/0x21 [btrfs]
[ 2837.801698] deactivate\_locked\_super+0x30/0x68
[ 2837.801698] deactivate\_super+0x36/0x39
[ 2837.801698] cleanup\_mnt+0x58/0x76
[ 2837.801698] \_\_cleanup\_mnt+0x12/0x14
[ 2837.801698] task\_work\_run+0x77/0x9b
[ 2837.801698] prepare\_exit\_to\_usermode+0x9d/0xc5
[ 2837.801698] syscall\_return\_slowpath+0x196/0x1b9
[ 2837.801698] entry\_SYSCALL\_64\_fastpath+0xab/0xad
[ 2837.801698] RIP: 0033:0x7f3ef3e6b9a7
[ 2837.801698] RSP: 002b:00007ffdd0d8de58 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a6
[ 2837.801698] RAX: 0000000000000000 RBX: 0000556f76a39060 RCX: 00007f3ef3e6b9a7
[ 2837.801698] RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000556f76a3f910
[ 2837.801698] RBP: 0000556f76a3f910 R08: 0000556f76a3e670 R09: 0000000000000015
[ 2837.801698] R10: 00000000000006b4 R11: 0000000000000246 R12: 00007f3ef436ce64
[ 2837.801698] R13: 0000000000000000 R14: 0000556f76a39240 R15: 00007ffdd0d8e0e0
[ 2837.818441] ---[ end trace e79345fe24b30b90 ]---
[ 2837.818991] BTRFS info (device sdc): space\_info 1 has 7974912 free, is not full
[ 2837.819830] BTRFS info (device sdc): space\_info total=8388608, used=417792, pinned=0, reserved=0, may\_use=18446744073709547520, readonly=0
What happens in the above example is the following:
1) When punching the hole, at btrfs\_punch\_hole(), the variable tail\_len
is set to 2048 (as tail\_start is 148Kb + 1 and offset + len is 150Kb).
This results in the creation of an extent map with a length of 2Kb
starting at file offset 148Kb, through find\_first\_non\_hole() ->
btrfs\_get\_extent().
2) The second write (first write after the hole punch operation), sets
the range [50Kb, 152Kb[ to delalloc.
3) The third write, at btrfs\_find\_new\_delalloc\_bytes(), sees the extent
map covering the range [148Kb, 150Kb[ and ends up calling
set\_extent\_bit() for the same range, which results in splitting an
existing extent state record, covering the range [148Kb, 152Kb[ into
two 2Kb extent state records, covering the ranges [148Kb, 150Kb[ and
[150Kb, 152Kb[.
4) Finally at lock\_and\_cleanup\_extent\_if\_need(), immediately after calling
btrfs\_find\_new\_delalloc\_bytes() we clear the delalloc bit from the
range [100Kb, 152Kb[ which results in the btrfs\_clear\_bit\_hook()
callback being invoked against the two 2Kb extent state records that
cover the ranges [148Kb, 150Kb[ and [150Kb, 152Kb[. When called against
the first 2Kb extent state, it calls btrfs\_delalloc\_release\_metadata()
with a length argument of 2048 bytes. That function rounds up the length
to a sector size aligned length, so it ends up considering a length of
4096 bytes, and then calls calc\_csum\_metadata\_size() which results in
decrementing the inode's csum\_bytes counter by 4096 bytes, so after
it stays a value of 0 bytes. Then the same happens when
btrfs\_clear\_bit\_hook() is called against the second extent state that
has a length of 2Kb, covering the range [150Kb, 152Kb[, the length is
rounded up to 4096 and calc\_csum\_metadata\_size() ends up being called
to decrement 4096 bytes from the inode's csum\_bytes counter, which
at that time has a value of 0, leading to an underflow, which is
exactly what triggers the first warning, at btrfs\_destroy\_inode().
All the other warnings relate to several space accounting counters
that underflow as well due to similar reasons.
A similar case but where the hole punching operation creates an extent map
with a start offset not aligned to the sector size is the following:
$ mkfs.btrfs -f /dev/sdb
$ mount /dev/sdb /mnt
$ xfs\_io -f -c "fpunch 695K 820K" $SCRATCH\_MNT/bar
$ xfs\_io -c "pwrite -S 0xaa 1008K 307K" $SCRATCH\_MNT/bar
$ xfs\_io -c "pwrite -S 0xbb -b 630K 1073K 630K" $SCRATCH\_MNT/bar
$ xfs\_io -c "pwrite -S 0xcc -b 459K 1068K 459K" $SCRATCH\_MNT/bar
$ umount /mnt
During the unmount operation we get similar traces for the same reasons as
in the first example.
So fix the hole punching operation to make sure it never creates extent
maps with a length that is not aligned to the sector size nor with a start
offset that is not aligned to the sector size, as this breaks all
assumptions and it's a land mine.
Fixes: d77815461f04 ("btrfs: Avoid trucating page or punching hole in a already existed hole.")
Signed-off-by: Filipe Manana
Reviewed-by: Liu Bo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit a88266ef19946afec0a7323d23df5acf821c85fd
Author: Brian Norris
Date: Fri May 12 09:41:58 2017 -0700
mwifiex: fixup error cases in mwifiex\_add\_virtual\_intf()
commit 8535107aa4ef92520cbb9a4739563b389c5f8e2c upstream.
If we fail to add an interface in mwifiex\_add\_virtual\_intf(), we might
hit a BUG\_ON() in the networking code, because we didn't tear things
down properly. Among the problems:
(a) when failing to allocate workqueues, we fail to unregister the
netdev before calling free\_netdev()
(b) even if we do try to unregister the netdev, we're still holding the
rtnl lock, so the device never properly unregistered; we'll be at
state NETREG\_UNREGISTERING, and then hit free\_netdev()'s:
BUG\_ON(dev->reg\_state != NETREG\_UNREGISTERED);
(c) we're allocating some dependent resources (e.g., DFS workqueues)
after we've registered the interface; this may or may not cause
problems, but it's good practice to allocate these before registering
(d) we're not even trying to unwind anything when mwifiex\_send\_cmd() or
mwifiex\_sta\_init\_cmd() fail
To fix these issues, let's:
\* add a stacked set of error handling labels, to keep error handling
consistent and properly ordered (resolving (a) and (d))
\* move the workqueue allocations before the registration (to resolve
(c); also resolves (b) by avoiding error cases where we have to
unregister)
[Incidentally, it's pretty easy to interrupt the alloc\_workqueue() in,
e.g., the following:
iw phy phy0 interface add mlan0 type station
by sending it SIGTERM.]
This bugfix covers commits like commit 7d652034d1a0 ("mwifiex: channel
switch support for mwifiex"), but parts of this bug exist all the way
back to the introduction of dynamic interface handling in commit
93a1df48d224 ("mwifiex: add cfg80211 handlers add/del\_virtual\_intf").
Signed-off-by: Brian Norris
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit ad000510c3b53fa5259aa2260dcb75aac9f56414
Author: Ankit Kumar
Date: Tue May 23 11:16:52 2017 +0530
pstore: Don't warn if data is uncompressed and type is not PSTORE\_TYPE\_DMESG
commit 4a16d1cb245c56e72fd40a28f3cdb394cde4b341 upstream.
commit 9abdcccc3d5f ("pstore: Extract common arguments into structure")
moved record decompression to function. decompress\_record() gets
called without checking type and compressed flag. Warning will be
reported if data is uncompressed. Pstore type PSTORE\_TYPE\_PPC\_OPAL,
PSTORE\_TYPE\_PPC\_COMMON doesn't contain compressed data and warning get
printed part of dmesg.
Partial dmesg log:
[ 35.848914] pstore: ignored compressed record type 6
[ 35.848927] pstore: ignored compressed record type 8
Above warning should not get printed as it is known that data won't be
compressed for above type and it is valid condition.
This patch returns if data is not compressed and print warning only if
data is compressed and type is not PSTORE\_TYPE\_DMESG.
Reported-by: Anton Blanchard
Signed-off-by: Ankit Kumar
Reviewed-by: Mahesh Salgaonkar
Signed-off-by: Kees Cook
Fixes: 9abdcccc3d5f ("pstore: Extract common arguments into structure")
Signed-off-by: Greg Kroah-Hartman
commit 1566e0592c90b141f0e0f881d0103331ec558650
Author: Arnd Bergmann
Date: Thu May 11 13:52:09 2017 +0200
wlcore: fix 64K page support
commit 4a4274bf2dbbd1c7a45be0c89a1687c9d2eef4a0 upstream.
In the stable linux-3.16 branch, I ran into a warning in the
wlcore driver:
drivers/net/wireless/ti/wlcore/spi.c: In function 'wl12xx\_spi\_raw\_write':
drivers/net/wireless/ti/wlcore/spi.c:315:1: error: the frame size of 12848 bytes is larger than 2048 bytes [-Werror=frame-larger-than=]
Newer kernels no longer show the warning, but the bug is still there,
as the allocation is based on the CPU page size rather than the
actual capabilities of the hardware.
This replaces the PAGE\_SIZE macro with the SZ\_4K macro, i.e. 4096 bytes
per buffer.
Signed-off-by: Arnd Bergmann
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit b53b679317b3e5882aee682932f60cabe75e3d2e
Author: Jason A. Donenfeld
Date: Sat Jun 10 04:59:11 2017 +0200
Bluetooth: use constant time memory comparison for secret values
commit 329d82309824ff1082dc4a91a5bbed8c3bec1580 upstream.
This file is filled with complex cryptography. Thus, the comparisons of
MACs and secret keys and curve points and so forth should not add timing
attacks, which could either result in a direct forgery, or, given the
complexity, some other type of attack.
Signed-off-by: Jason A. Donenfeld
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 3f30aa79a3caf3a4364dbbf6da72c2a3c5d3bbaf
Author: Adrian Hunter
Date: Fri May 26 11:17:09 2017 +0300
perf intel-pt: Clear FUP flag on error
commit 6a558f12dbe85437acbdec5e149ea07b5554eced upstream.
Sometimes a FUP packet is associated with a TSX transaction and a flag is
set to indicate that. Ensure that flag is cleared on any error condition
because at that point the decoder can no longer assume it is correct.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-9-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit ea6c25496e94967c41798996f8e3c667df11d0cb
Author: Adrian Hunter
Date: Fri May 26 11:17:08 2017 +0300
perf intel-pt: Use FUP always when scanning for an IP
commit 622b7a47b843c78626f40c1d1aeef8483383fba2 upstream.
The decoder will try to use branch packets to find an IP to start decoding
or to recover from errors. Currently the FUP packet is used only in the
case of an overflow, however there is no reason for that to be a special
case. So just use FUP always when scanning for an IP.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-8-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit c68f8e30d7be490fabfcb9c4201af0ef1691b1fa
Author: Adrian Hunter
Date: Fri May 26 11:17:07 2017 +0300
perf intel-pt: Ensure never to set 'last\_ip' when packet 'count' is zero
commit f952eaceb089b691eba7c4e13686e742a8f26bf5 upstream.
Intel PT uses IP compression based on the last IP. For decoding purposes,
'last IP' is not updated when a branch target has been suppressed, which is
indicated by IPBytes == 0. IPBytes is stored in the packet 'count', so
ensure never to set 'last\_ip' when packet 'count' is zero.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-7-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit d7cccb4b6cffd31c6fce4c980776ff94a6c0bd47
Author: Adrian Hunter
Date: Fri May 26 11:17:06 2017 +0300
perf intel-pt: Fix last\_ip usage
commit ee14ac0ef6827cd6f9a572cc83dd0191ea17812c upstream.
Intel PT uses IP compression based on the last IP. For decoding
purposes, 'last IP' is considered to be reset to zero whenever there is
a synchronization packet (PSB). The decoder wasn't doing that, and was
treating the zero value to mean that there was no last IP, whereas
compression can be done against the zero value. Fix by setting last\_ip
to zero when a PSB is received and keep track of have\_last\_ip.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-6-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit c93c534c8c1d0fbb1f7e1d858b7f9d301a935da4
Author: Adrian Hunter
Date: Fri May 26 11:17:05 2017 +0300
perf intel-pt: Ensure IP is zero when state is INTEL\_PT\_STATE\_NO\_IP
commit ad7167a8cd174ba7d8c0d0ed8d8410521206d104 upstream.
A value of zero is used to indicate that there is no IP. Ensure the
value is zero when the state is INTEL\_PT\_STATE\_NO\_IP.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-5-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 14f2cad1e0a0afe0e62df84bf5c6aa73eded60d7
Author: Adrian Hunter
Date: Fri May 26 11:17:04 2017 +0300
perf intel-pt: Fix missing stack clear
commit 12b7080609097753fd8198cc1daf589be3ec1cca upstream.
The return compression stack must be cleared whenever there is a PSB. Fix
one case where that was not happening.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-4-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 309721dd36c2e7a6b734a14fff924aa011e1f60c
Author: Adrian Hunter
Date: Fri May 26 11:17:03 2017 +0300
perf intel-pt: Improve sample timestamp
commit 3f04d98e972b59706bd43d6cc75efac91f8fba50 upstream.
The decoder uses its current timestamp in samples. Usually that is a
timestamp that has already passed, but in some cases it is a timestamp
for a branch that the decoder is walking towards, and consequently
hasn't reached. Improve that situation by using the pkt\_state to
determine when to use the current or previous timestamp.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-3-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 84c366c6ddae7d55efa20ae526a19b29c68e8aac
Author: Adrian Hunter
Date: Fri May 26 11:17:02 2017 +0300
perf intel-pt: Move decoder error setting into one condition
commit 22c06892332d8916115525145b78e606e9cc6492 upstream.
Move decoder error setting into one condition.
Cc'ed to stable because later fixes depend on it.
Signed-off-by: Adrian Hunter
Cc: Andi Kleen
Link: http://lkml.kernel.org/r/1495786658-18063-2-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit c9270e3728345481b21136731ebd37794b276102
Author: Mateusz Jurczyk
Date: Tue Jun 13 18:44:28 2017 +0200
NFC: Add sockaddr length checks before accessing sa\_family in bind handlers
commit f6a5885fc4d68e7f25ffb42b9d8d80aebb3bacbb upstream.
Verify that the caller-provided sockaddr structure is large enough to
contain the sa\_family field, before accessing it in bind() handlers of the
AF\_NFC socket. Since the syscall doesn't enforce a minimum size of the
corresponding memory region, very short sockaddrs (zero or one byte long)
result in operating on uninitialized memory while referencing .sa\_family.
Signed-off-by: Mateusz Jurczyk
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit e66553a5900b9759fb3574033d3a05ec2ccf98a0
Author: Mateusz Jurczyk
Date: Wed May 24 12:26:20 2017 +0200
nfc: Fix the sockaddr length sanitization in llcp\_sock\_connect
commit 608c4adfcabab220142ee335a2a003ccd1c0b25b upstream.
Fix the sockaddr length verification in the connect() handler of NFC/LLCP
sockets, to compare against the size of the actual structure expected on
input (sockaddr\_nfc\_llcp) instead of its shorter version (sockaddr\_nfc).
Both structures are defined in include/uapi/linux/nfc.h. The fields
specific to the \_llcp extended struct are as follows:
276 \_\_u8 dsap; /\* Destination SAP, if known \*/
277 \_\_u8 ssap; /\* Source SAP to be bound to \*/
278 char service\_name[NFC\_LLCP\_MAX\_SERVICE\_NAME]; /\* Service name URI \*/;
279 size\_t service\_name\_len;
If the caller doesn't provide a sufficiently long sockaddr buffer, these
fields remain uninitialized (and they currently originate from the stack
frame of the top-level sys\_connect handler). They are then copied by
llcp\_sock\_connect() into internal storage (nfc\_llcp\_sock structure), and
could be subsequently read back through the user-mode getsockname()
function (handled by llcp\_sock\_getname()). This would result in the
disclosure of up to ~70 uninitialized bytes from the kernel stack to
user-mode clients capable of creating AFC\_NFC sockets.
Signed-off-by: Mateusz Jurczyk
Acked-by: Kees Cook
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit b6a39af459ca47e69f9de1241538e515450c4725
Author: Mateusz Jurczyk
Date: Wed May 24 12:42:26 2017 +0200
nfc: Ensure presence of required attributes in the activate\_target handler
commit a0323b979f81ad2deb2c8836eab506534891876a upstream.
Check that the NFC\_ATTR\_TARGET\_INDEX and NFC\_ATTR\_PROTOCOLS attributes (in
addition to NFC\_ATTR\_DEVICE\_INDEX) are provided by the netlink client
prior to accessing them. This prevents potential unhandled NULL pointer
dereference exceptions which can be triggered by malicious user-mode
programs, if they omit one or both of these attributes.
Signed-off-by: Mateusz Jurczyk
Acked-by: Kees Cook
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit 36a8a4e98c2258d8834084c836fb50f0aed0fcfe
Author: Johan Hovold
Date: Thu Mar 30 12:15:39 2017 +0200
NFC: nfcmrvl: fix firmware-management initialisation
commit 45dd39b974f6632222dd5cdcbea7358a077ab0b0 upstream.
The nci-device was never deregistered in the event that
fw-initialisation failed.
Fix this by moving the firmware initialisation before device
registration since the firmware work queue should be available before
registering.
Note that this depends on a recent fix that moved device-name
initialisation back to to nci\_allocate\_device() as the
firmware-workqueue name is now derived from the nfc-device name.
Fixes: 3194c6870158 ("NFC: nfcmrvl: add firmware download support")
Cc: Vincent Cuissard
Signed-off-by: Johan Hovold
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit 7b69ecce4d9f8dc7f3d1478956266a88754ea9f1
Author: Johan Hovold
Date: Thu Mar 30 12:15:38 2017 +0200
NFC: nfcmrvl: use nfc-device for firmware download
commit e5834ac22948169bbd7c45996d8d4905edd20f5e upstream.
Use the nfc- rather than phy-device in firmware-management code that
needs a valid struct device.
This specifically fixes a NULL-pointer dereference in
nfcmrvl\_fw\_dnld\_init() during registration when the underlying tty is
one end of a Unix98 pty.
Note that the driver still uses the phy device for any debugging, which
is fine for now.
Fixes: 3194c6870158 ("NFC: nfcmrvl: add firmware download support")
Cc: Vincent Cuissard
Signed-off-by: Johan Hovold
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit 6cb06562945e47a4d538c3d509268994bbb88339
Author: Johan Hovold
Date: Thu Mar 30 12:15:37 2017 +0200
NFC: nfcmrvl: do not use device-managed resources
commit 0cbe40112f42cf5e008f9127f6cd5952ba3946c7 upstream.
This specifically fixes resource leaks in the registration error paths.
Device-managed resources is a bad fit for this driver as devices can be
registered from the n\_nci line discipline. Firstly, a tty may not even
have a corresponding device (should it be part of a Unix98 pty)
something which would lead to a NULL-pointer dereference when
registering resources.
Secondly, if the tty has a class device, its lifetime exceeds that of
the line discipline, which means that resources would leak every time
the line discipline is closed (or if registration fails).
Currently, the devres interface was only being used to request a reset
gpio despite the fact that it was already explicitly freed in
nfcmrvl\_nci\_unregister\_dev() (along with the private data), something
which also prevented the resource leak at close.
Note that the driver treats gpio number 0 as invalid despite it being
perfectly valid. This will be addressed in a follow-up patch.
Fixes: b2fe288eac72 ("NFC: nfcmrvl: free reset gpio")
Fixes: 4a2b947f56b3 ("NFC: nfcmrvl: add chip reset management")
Cc: Vincent Cuissard
Signed-off-by: Johan Hovold
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit 5d714615ca9ac166208832229b14f46f3f515e59
Author: Johan Hovold
Date: Thu Mar 30 12:15:36 2017 +0200
NFC: nfcmrvl\_uart: add missing tty-device sanity check
commit 15e0c59f1535926a939d1df66d6edcf997d7c1b9 upstream.
Make sure to check the tty-device pointer before trying to access the
parent device to avoid dereferencing a NULL-pointer when the tty is one
end of a Unix98 pty.
Fixes: e097dc624f78 ("NFC: nfcmrvl: add UART driver")
Cc: Vincent Cuissard
Signed-off-by: Johan Hovold
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit 3e540b655c0335f917b7bde408acb9459ada2285
Author: Johan Hovold
Date: Thu Mar 30 12:15:35 2017 +0200
NFC: fix broken device allocation
commit 20777bc57c346b6994f465e0d8261a7fbf213a09 upstream.
Commit 7eda8b8e9677 ("NFC: Use IDR library to assing NFC devices IDs")
moved device-id allocation and struct-device initialisation from
nfc\_allocate\_device() to nfc\_register\_device().
This broke just about every nfc-device-registration error path, which
continue to call nfc\_free\_device() that tries to put the device
reference of the now uninitialised (but zeroed) struct device:
kobject: '(null)' (ce316420): is not initialized, yet kobject\_put() is being called.
The late struct-device initialisation also meant that various work
queues whose names are derived from the nfc device name were also
misnamed:
421 root 0 SW< [(null)\_nci\_cmd\_]
422 root 0 SW< [(null)\_nci\_rx\_w]
423 root 0 SW< [(null)\_nci\_tx\_w]
Move the id-allocation and struct-device initialisation back to
nfc\_allocate\_device() and fix up the single call site which did not use
nfc\_free\_device() in its error path.
Fixes: 7eda8b8e9677 ("NFC: Use IDR library to assing NFC devices IDs")
Cc: Samuel Ortiz
Signed-off-by: Johan Hovold
Signed-off-by: Samuel Ortiz
Signed-off-by: Greg Kroah-Hartman
commit bf3d383a38bd10de3202a3de6363d0bd355200ca
Author: Emmanuel Grumbach
Date: Fri May 5 08:51:24 2017 +0300
iwlwifi: mvm: fix the recovery flow while connecting
commit 6b28f9784c394f0692e160f81b07c82cb64af160 upstream.
In BSS mode in the disconnection flow, mac80211 removes
the AP station before the vif is set to unassociated.
Our firmware wants it the other way around: first set
the vif as unassociated, and then remove the AP station.
In order to bridge between those two different behaviors,
iwlmvm doesn't remove the station from the firmware when
mac80211 removes it, but only after the vif is set to
unassociated. The implementation is in
iwl\_mvm\_bss\_info\_changed\_station:
if (assoc state was modified && mvmvif->ap\_sta\_id is VALID
&& assoc state is now UNASSC)
remove\_the\_station\_from\_the\_firmware()
During the recovery flow, mac80211 re-adds the AP station
and then reconfigures the vif. Since the vif is not
associated, and then, we enter the if above (which was
intended to be taken in the disconnection flow only) and
remove the station we just added. This defeats the
recovery flow.
Fix this by not removing the AP station in this flow if
we are in recovery flow.
Signed-off-by: Emmanuel Grumbach
Signed-off-by: Luca Coelho
Signed-off-by: Greg Kroah-Hartman
commit a1b6a2c3592b7a4d2a12b31fc5c4c38706a3f8f9
Author: Miaoqing Pan
Date: Tue Jun 27 17:31:53 2017 +0300
ath9k: fix an invalid pointer dereference in ath9k\_rng\_stop()
commit 07246c115801c27652700e3679bb58661ef7ed65 upstream.
The bug was triggered when do suspend/resuming continuously
on Dell XPS L322X/0PJHXN version 9333 (2013) with kernel
4.12.0-041200rc4-generic. But can't reproduce on DELL
E5440 + AR9300 PCIE chips.
The warning is caused by accessing invalid pointer sc->rng\_task.
sc->rng\_task is not be cleared after kthread\_stop(sc->rng\_task)
be called in ath9k\_rng\_stop(). Because the kthread is stopped
before ath9k\_rng\_kthread() be scheduled.
So set sc->rng\_task to null after kthread\_stop(sc->rng\_task) to
resolve this issue.
WARNING: CPU: 0 PID: 984 at linux/kernel/kthread.c:71 kthread\_stop+0xf1/0x100
CPU: 0 PID: 984 Comm: NetworkManager Not tainted 4.12.0-041200rc4-generic #201706042031
Hardware name: Dell Inc. Dell System XPS L322X/0PJHXN, BIOS A09 05/15/2013
task: ffff950170fdda00 task.stack: ffffa22c01538000
RIP: 0010:kthread\_stop+0xf1/0x100
RSP: 0018:ffffa22c0153b5b0 EFLAGS: 00010246
RAX: ffffffffa6257800 RBX: ffff950171b79560 RCX: 0000000000000000
RDX: 0000000080000000 RSI: 000000007fffffff RDI: ffff9500ac9a9680
RBP: ffffa22c0153b5c8 R08: 0000000000000000 R09: 0000000000000000
R10: ffffa22c0153b648 R11: ffff9501768004b8 R12: ffff9500ac9a9680
R13: ffff950171b79f70 R14: ffff950171b78780 R15: ffff9501749dc018
FS: 00007f0d6bfd5540(0000) GS:ffff95017f200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc190161a08 CR3: 0000000232906000 CR4: 00000000001406f0
Call Trace:
ath9k\_rng\_stop+0x1a/0x20 [ath9k]
ath9k\_stop+0x3b/0x1d0 [ath9k]
drv\_stop+0x33/0xf0 [mac80211]
ieee80211\_stop\_device+0x43/0x50 [mac80211]
ieee80211\_do\_stop+0x4f2/0x810 [mac80211]
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=196043
Reported-by: Giulio Genovese
Tested-by: Giulio Genovese
Signed-off-by: Miaoqing Pan
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit e9fe79bcf1a7f0121fc97b0ac0c80b7878117521
Author: Miaoqing Pan
Date: Tue Jun 27 17:31:51 2017 +0300
ath9k: fix tx99 bus error
commit bde717ab473668377fc65872398a102d40cb2d58 upstream.
The hard coded register 0x9864 and 0x9924 are invalid
for ar9300 chips.
Signed-off-by: Miaoqing Pan
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 33c147af30973b25d04014342e42292bd31f0996
Author: Miaoqing Pan
Date: Tue Jun 27 17:31:49 2017 +0300
ath9k: fix tx99 use after free
commit cf8ce1ea61b75712a154c93e40f2a5af2e4dd997 upstream.
One scenario that could lead to UAF is two threads writing
simultaneously to the "tx99" debug file. One of them would
set the "start" value to true and follow to ath9k\_tx99\_init().
Inside the function it would set the sc->tx99\_state to true
after allocating sc->tx99skb. Then, the other thread would
execute write\_file\_tx99() and call ath9k\_tx99\_deinit().
sc->tx99\_state would be freed. After that, the first thread
would continue inside ath9k\_tx99\_init() and call
r = ath9k\_tx99\_send(sc, sc->tx99\_skb, &txctl);
that would make use of the freed sc->tx99\_skb memory.
Signed-off-by: Miaoqing Pan
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit b0c642732004c5255e716fc6b15343a9a670e7e5
Author: Viresh Kumar
Date: Tue Apr 25 15:57:08 2017 +0530
thermal: cpu\_cooling: Avoid accessing potentially freed structures
commit 289d72afddf83440117c35d864bf0c6309c1d011 upstream.
After the lock is dropped, it is possible that the cpufreq\_dev gets
freed before we call get\_level() and that can cause kernel to crash.
Drop the lock after we are done using the structure.
Fixes: 02373d7c69b4 ("thermal: cpu\_cooling: fix lockdep problems in cpu\_cooling")
Signed-off-by: Viresh Kumar
Reviewed-by: Lukasz Luba
Tested-by: Lukasz Luba
Signed-off-by: Eduardo Valentin
Signed-off-by: Greg Kroah-Hartman
commit b0bc1293bbc03fa7f60b82c3fbdde99375957f6a
Author: Johan Hovold
Date: Tue Jun 6 17:59:03 2017 +0200
thermal: max77620: fix device-node reference imbalance
commit c592fafbdbb6b1279b76a54722d1465ca77e5bde upstream.
The thermal child device reuses the parent MFD-device device-tree node
when registering a thermal zone, but did not take a reference to the
node.
This leads to a reference imbalance, and potential use-after-free, when
the node reference is dropped by the platform-bus device destructor
(once for the child and later again for the parent).
Fix this by dropping any reference already held to a device-tree node
and getting a reference to the parent's node which will be balanced on
reprobe or on platform-device release, whichever comes first.
Note that simply clearing the of\_node pointer on probe errors and on
driver unbind would not allow the use of device-managed resources as
specifically thermal\_zone\_of\_sensor\_unregister() claims that a valid
device-tree node pointer is needed during deregistration (even if it
currently does not seem to use it).
Fixes: ec4664b3fd6d ("thermal: max77620: Add thermal driver for reporting junction temp")
Cc: Laxman Dewangan
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 7c6846307cae4cfe1adc3e6b6b7b7794d6616887
Author: Mauro Carvalho Chehab
Date: Thu May 18 10:40:00 2017 -0300
s5p-jpeg: don't return a random width/height
commit a16e37726c444cbda91e73ed5f742e717bfe866f upstream.
Gcc 7.1 complains about:
drivers/media/platform/s5p-jpeg/jpeg-core.c: In function 's5p\_jpeg\_parse\_hdr.isra.9':
drivers/media/platform/s5p-jpeg/jpeg-core.c:1207:12: warning: 'width' may be used uninitialized in this function [-Wmaybe-uninitialized]
result->w = width;
~~~~~~~~~~^~~~~~~
drivers/media/platform/s5p-jpeg/jpeg-core.c:1208:12: warning: 'height' may be used uninitialized in this function [-Wmaybe-uninitialized]
result->h = height;
~~~~~~~~~~^~~~~~~~
Indeed the code would allow it to return a random value (although
it shouldn't happen, in practice). So, explicitly set both to zero,
just in case.
Acked-by: Andrzej Pietrasiewicz
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 0f2de24938d76900a10a6e9b633661792a5509ad
Author: Arnd Bergmann
Date: Thu May 11 08:46:44 2017 -0300
ir-core: fix gcc-7 warning on bool arithmetic
commit bd7e31bbade02bc1e92aa00d5cf2cee2da66838a upstream.
gcc-7 suggests that an expression using a bitwise not and a bitmask
on a 'bool' variable is better written using boolean logic:
drivers/media/rc/imon.c: In function 'imon\_incoming\_scancode':
drivers/media/rc/imon.c:1725:22: error: '~' on a boolean expression [-Werror=bool-operation]
ictx->pad\_mouse = ~(ictx->pad\_mouse) & 0x1;
^
drivers/media/rc/imon.c:1725:22: note: did you mean to use logical not?
I agree.
Fixes: 21677cfc562a ("V4L/DVB: ir-core: add imon driver")
Signed-off-by: Arnd Bergmann
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit e346433d5ac9f6a484ff40085c4fb5a636703f77
Author: Linus Torvalds
Date: Wed Jul 12 19:25:47 2017 -0700
disable new gcc-7.1.1 warnings for now
commit bd664f6b3e376a8ef4990f87d08271cc2d01ba9a upstream.
I made the mistake of upgrading my desktop to the new Fedora 26 that
comes with gcc-7.1.1.
There's nothing wrong per se that I've noticed, but I now have 1500
lines of warnings, mostly from the new format-truncation warning
triggering all over the tree.
We use 'snprintf()' and friends in a lot of places, and often know that
the numbers are fairly small (ie a controller index or similar), but gcc
doesn't know that, and sees an 'int', and thinks that it could be some
huge number. And then complains when our buffers are not able to fit
the name for the ten millionth controller.
These warnings aren't necessarily bad per se, and we probably want to
look through them subsystem by subsystem, but at least during the merge
window they just mean that I can't even see if somebody is introducing
any \*real\* problems when I pull.
So warnings disabled for now.
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman


=== Content from github.com_ce0f4afc_20250125_215053.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F15d3042a937c13f5d9244241c7a9c8416ff6e82a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F15d3042a937c13f5d9244241c7a9c8416ff6e82a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  438](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/15d3042a937c13f5d9244241c7a9c8416ff6e82a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

f2fs: sanity check checkpoint segno and blkoff

[Browse files](/torvalds/linux/tree/15d3042a937c13f5d9244241c7a9c8416ff6e82a)
Browse the repository at this point in the history

```
Make sure segno and blkoff read from raw image are valid.

Cc: stable@vger.kernel.org
Signed-off-by: Jin Qian <jinqian@google.com>
[Jaegeuk Kim: adjust minor coding style]
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
```

* Loading branch information

Jin Qian
authored and
Jaegeuk Kim
committed
May 16, 2017

1 parent
[2d3e486](/torvalds/linux/commit/2d3e4866dea96b0506395b47bfefb234f2088dac)

commit 15d3042

Showing
**1 changed file**
with
**16 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

16 changes: 16 additions & 0 deletions

16
[fs/f2fs/super.c](#diff-420abc8ef71176f7e34e4e19bc1afdbd2fd43ee88ecea1ac992f4fcb1636b866 "fs/f2fs/super.c")

Show comments

[View file](/torvalds/linux/blob/15d3042a937c13f5d9244241c7a9c8416ff6e82a/fs/f2fs/super.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1521,6 +1521,8 @@ int sanity\_check\_ckpt(struct f2fs\_sb\_info \*sbi) |
|  |  | struct f2fs\_super\_block \*raw\_super = F2FS\_RAW\_SUPER(sbi); |
|  |  | struct f2fs\_checkpoint \*ckpt = F2FS\_CKPT(sbi); |
|  |  | unsigned int ovp\_segments, reserved\_segments; |
|  |  | unsigned int main\_segs, blocks\_per\_seg; |
|  |  | int i; |
|  |  |  |
|  |  | total = le32\_to\_cpu(raw\_super->segment\_count); |
|  |  | fsmeta = le32\_to\_cpu(raw\_super->segment\_count\_ckpt); |
| Expand All | | @@ -1542,6 +1544,20 @@ int sanity\_check\_ckpt(struct f2fs\_sb\_info \*sbi) |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | main\_segs = le32\_to\_cpu(raw\_super->segment\_count\_main); |
|  |  | blocks\_per\_seg = sbi->blocks\_per\_seg; |
|  |  |  |
|  |  | for (i = 0; i < NR\_CURSEG\_NODE\_TYPE; i++) { |
|  |  | if (le32\_to\_cpu(ckpt->cur\_node\_segno[i]) >= main\_segs || |
|  |  | le16\_to\_cpu(ckpt->cur\_node\_blkoff[i]) >= blocks\_per\_seg) |
|  |  | return 1; |
|  |  | } |
|  |  | for (i = 0; i < NR\_CURSEG\_DATA\_TYPE; i++) { |
|  |  | if (le32\_to\_cpu(ckpt->cur\_data\_segno[i]) >= main\_segs || |
|  |  | le16\_to\_cpu(ckpt->cur\_data\_blkoff[i]) >= blocks\_per\_seg) |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | if (unlikely(f2fs\_cp\_error(sbi))) { |
|  |  | f2fs\_msg(sbi->sb, KERN\_ERR, "A bug case: need to run fsck"); |
|  |  | return 1; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `15d3042`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F15d3042a937c13f5d9244241c7a9c8416ff6e82a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugzilla.redhat.com_25cd724b_20250125_215050.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1481149)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1481149)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1481149)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1481149

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1481149**](show_bug.cgi?id=1481149)
(CVE-2017-10663)
- [CVE-2017-10663](https://access.redhat.com/security/cve/CVE-2017-10663) kernel: Missing sanity check for segno and blkoff read

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2017-10663 kernel: Missing sanity check for segno and blkoff read

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED NOTABUG | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2017-10663 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | low | | [Severity:](page.cgi?id=fields.html#bug_severity) | low | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1481153](show_bug.cgi?id=1481153 "CLOSED ERRATA - CVE-2017-10663 kernel: Missing sanity check for segno and blkoff read [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1481154](show_bug.cgi?id=1481154) | | TreeView+ | [depends on](buglist.cgi?bug_id=1481149&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1481149&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2017-08-14 08:39 UTC by Adam Mariš | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-02-17 01:43 UTC ([History](show_activity.cgi?id=1481149)) | | [CC List:](page.cgi?id=fields.html#cclist) | 37 users (show)  agordeev aquini bhu blc dhoward esammons fhrbata gansalmon hkrzesin hwkernel-mgr iboverma ichavero itamar jforbes jkacur jonathan jross jwboyer kernel-maint kernel-mgr labbott lgoncalv lwang madhu.chinakonda matt mchehab mcressma mguzik mlangsdo nmurray pholasek plougher rt-maint rvrbovsk slawomir vdronov williams | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: | The sanity\_check\_ckpt function in fs/f2fs/super.c in the Linux kernel before version 4.12.4 does not validate the blkoff and segno arrays. This allows an unprivileged, local user to cause a system panic and DoS. Due to the nature of the flaw, privilege escalation cannot be fully ruled out, although we believe it is unlikely. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2017-08-27 15:39:55 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1481149#c0)  Adam Mariš    2017-08-14 08:39:08 UTC  ``` The sanity_check_ckpt function in fs/f2fs/super.c in the Linux kernel before 4.12.4 does not validate the blkoff and segno arrays, which allows an unprivileged local user to cause a system panic and DoS. Due to the nature of the flaw, privilege escalation cannot be fully ruled out, although we believe it is unlikely.  References:  <https://source.android.com/security/bulletin/2017-08-01#kernel-components>  <https://sourceforge.net/p/linux-f2fs/mailman/message/35835945/>  Upstream patch:  <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a>   ```  [Comment 1](show_bug.cgi?id=1481149#c1)  Adam Mariš    2017-08-14 08:47:18 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1481153](show_bug.cgi?id=1481153 "CLOSED ERRATA - CVE-2017-10663 kernel: Missing sanity check for segno and blkoff read [fedora-all]")]   ```  [Comment 4](show_bug.cgi?id=1481149#c4)  Vladis Dronov    2017-08-27 15:39:55 UTC  ``` Statement:  This issue does not affect the versions of the Linux kernel as shipped with Red Hat Enterprise Linux 5, 6, 7 and Red Hat Enterprise MRG 2 as the code with the flaw is not built and shipped with the products listed.   ```  [Comment 5](show_bug.cgi?id=1481149#c5)  Justin M. Forbes    2018-01-29 16:30:32 UTC  ``` This was fixed for Fedora with the 4.12.4 stable updates   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1481149&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from twitter.com_cffdf7ee_20250126_121319.html ===



=== Content from twitter.com_8e190c19_20250126_121317.html ===



=== Content from git.kernel.org_c86e7098_20250126_121318.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.13.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b9dd46188edc2f0d1f37328637860bb65a771124)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9dd46188edc2f0d1f37328637860bb65a771124)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9dd46188edc2f0d1f37328637860bb65a771124)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9dd46188edc2f0d1f37328637860bb65a771124)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jin Qian <jinqian@google.com> | 2017-04-25 16:28:48 -0700 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2017-05-02 21:19:48 -0700 |
| commit | [b9dd46188edc2f0d1f37328637860bb65a771124](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9dd46188edc2f0d1f37328637860bb65a771124) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b9dd46188edc2f0d1f37328637860bb65a771124)) | |
| tree | [9476c2adfe493a9b3f91f3e8363a3e269b21cde6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9dd46188edc2f0d1f37328637860bb65a771124) | |
| parent | [a817737e87d506ea7b3983d287b4578c99922d85](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a817737e87d506ea7b3983d287b4578c99922d85) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9dd46188edc2f0d1f37328637860bb65a771124&id2=a817737e87d506ea7b3983d287b4578c99922d85)) | |
| download | [linux-b9dd46188edc2f0d1f37328637860bb65a771124.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b9dd46188edc2f0d1f37328637860bb65a771124.tar.gz) | |

f2fs: sanity check segment countF2FS uses 4 bytes to represent block address. As a result, supported
size of disk is 16 TB and it equals to 16 \* 1024 \* 1024 / 2 segments.
Signed-off-by: Jin Qian <jinqian@google.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9dd46188edc2f0d1f37328637860bb65a771124)

| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=b9dd46188edc2f0d1f37328637860bb65a771124) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/f2fs_fs.h?id=b9dd46188edc2f0d1f37328637860bb65a771124) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 0 deletions

| diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 97c07a5153e968..4cd3bee6775f23 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=a817737e87d506ea7b3983d287b4578c99922d85)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=b9dd46188edc2f0d1f37328637860bb65a771124)@@ -1494,6 +1494,13 @@ static int sanity\_check\_raw\_super(struct f2fs\_sb\_info \*sbi, return 1; } + if (le32\_to\_cpu(raw\_super->segment\_count) > F2FS\_MAX\_SEGMENT) {+ f2fs\_msg(sb, KERN\_INFO,+ "Invalid segment count (%u)",+ le32\_to\_cpu(raw\_super->segment\_count));+ return 1;+ }+ /\* check CP/SIT/NAT/SSA/MAIN\_AREA area boundary \*/ if (sanity\_check\_area\_boundary(sbi, bh)) return 1;diff --git a/include/linux/f2fs\_fs.h b/include/linux/f2fs\_fs.hindex 639cbdf65e2bf7..093549e10ee267 100644--- a/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=a817737e87d506ea7b3983d287b4578c99922d85)+++ b/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=b9dd46188edc2f0d1f37328637860bb65a771124)@@ -302,6 +302,12 @@ struct f2fs\_nat\_block { #define SIT\_ENTRY\_PER\_BLOCK (PAGE\_SIZE / sizeof(struct f2fs\_sit\_entry))  /\*+ \* F2FS uses 4 bytes to represent block address. As a result, supported size of+ \* disk is 16 TB and it equals to 16 \* 1024 \* 1024 / 2 segments.+ \*/+#define F2FS\_MAX\_SEGMENT ((16 \* 1024 \* 1024) / 2)++/\* \* Note that f2fs\_sit\_entry->vblocks has the following bit-field information. \* [15:10] : allocation type such as CURSEG\_XXXX\_TYPE \* [9:0] : valid block count |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-26 12:11:56 +0000



=== Content from source.android.com_0a717605_20250125_215103.html ===


[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

`/`

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어

[Android Code Search](https://cs.android.com/android/platform/superproject/main)
Sign in

* [Documentation](https://source.android.com/docs)

[What's New?](https://source.android.com/docs/whatsnew)

[Getting Started](https://source.android.com/docs/setup)

[Security](https://source.android.com/docs/security)

[Core Topics](https://source.android.com/docs/core)

[Compatibility](https://source.android.com/docs/compatibility)

[Android Devices](https://source.android.com/docs/devices)

[Automotive](https://source.android.com/docs/automotive)

[Reference](https://source.android.com/reference)

[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

* [Docs](/docs)
  + More
  + [What's New?](/docs/whatsnew)
  + [Getting Started](/docs/setup)
  + [Security](/docs/security)
  + [Core Topics](/docs/core)
  + [Compatibility](/docs/compatibility)
  + [Android Devices](/docs/devices)
  + [Automotive](/docs/automotive)
  + [Reference](/reference)
* [Android Code Search](https://cs.android.com/android/platform/superproject/main)

* [Overview](/docs/security)
* Security overview
  + [Secure an Android device](/docs/security/overview)
  + [Kernel security](/docs/security/overview/kernel-security)
  + [App security](/docs/security/overview/app-security)
  + [Implement security](/docs/security/overview/implement)
  + [Updates and resources](/docs/security/overview/updates-resources)
  + [ASPIRE](/docs/security/overview/aspire)
  + [Reports](/docs/security/overview/reports)
  + [Enhancements](/docs/security/enhancements)
  + [Acknowledgements](/docs/security/overview/acknowledgements)
* Android Security Bulletins
  + [Bulletins home](/docs/security/bulletin)
  + [Overview](/docs/security/bulletin/asb-overview)
  + 2025 bulletins
    - [January](/docs/security/bulletin/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/2024-12-01)
    - [November](/docs/security/bulletin/2024-11-01)
    - [October](/docs/security/bulletin/2024-10-01)
    - [September](/docs/security/bulletin/2024-09-01)
    - [August](/docs/security/bulletin/2024-08-01)
    - [July](/docs/security/bulletin/2024-07-01)
    - [June](/docs/security/bulletin/2024-06-01)
    - [May](/docs/security/bulletin/2024-05-01)
    - [April](/docs/security/bulletin/2024-04-01)
    - [March](/docs/security/bulletin/2024-03-01)
    - [February](/docs/security/bulletin/2024-02-01)
    - [January](/docs/security/bulletin/2024-01-01)
    - [Android 15](/docs/security/bulletin/android-15)
  + 2023 bulletins
    - [December](/docs/security/bulletin/2023-12-01)
    - [November](/docs/security/bulletin/2023-11-01)
    - [October](/docs/security/bulletin/2023-10-01)
    - [September](/docs/security/bulletin/2023-09-01)
    - [August](/docs/security/bulletin/2023-08-01)
    - [July](/docs/security/bulletin/2023-07-01)
    - [June](/docs/security/bulletin/2023-06-01)
    - [May](/docs/security/bulletin/2023-05-01)
    - [April](/docs/security/bulletin/2023-04-01)
    - [March](/docs/security/bulletin/2023-03-01)
    - [February](/docs/security/bulletin/2023-02-01)
    - [January](/docs/security/bulletin/2023-01-01)
    - [Android 14](/docs/security/bulletin/android-14)
  + 2022 bulletins
    - [December](/docs/security/bulletin/2022-12-01)
    - [November](/docs/security/bulletin/2022-11-01)
    - [October](/docs/security/bulletin/2022-10-01)
    - [September](/docs/security/bulletin/2022-09-01)
    - [August](/docs/security/bulletin/2022-08-01)
    - [July](/docs/security/bulletin/2022-07-01)
    - [June](/docs/security/bulletin/2022-06-01)
    - [May](/docs/security/bulletin/2022-05-01)
    - [April](/docs/security/bulletin/2022-04-01)
    - [March](/docs/security/bulletin/2022-03-01)
    - [Android 12L](/docs/security/bulletin/android-12l)
    - [February](/docs/security/bulletin/2022-02-01)
    - [January](/docs/security/bulletin/2022-01-01)
    - [Android 13](/docs/security/bulletin/android-13)
    - [Index](/docs/security/bulletin/2022)
  + 2021 bulletins
    - [December](/docs/security/bulletin/2021-12-01)
    - [November](/docs/security/bulletin/2021-11-01)
    - [October](/docs/security/bulletin/2021-10-01)
    - [September](/docs/security/bulletin/2021-09-01)
    - [August](/docs/security/bulletin/2021-08-01)
    - [July](/docs/security/bulletin/2021-07-01)
    - [June](/docs/security/bulletin/2021-06-01)
    - [May](/docs/security/bulletin/2021-05-01)
    - [April](/docs/security/bulletin/2021-04-01)
    - [March](/docs/security/bulletin/2021-03-01)
    - [February](/docs/security/bulletin/2021-02-01)
    - [January](/docs/security/bulletin/2021-01-01)
    - [Android 12](/docs/security/bulletin/android-12)
    - [Index](/docs/security/bulletin/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/2020-12-01)
    - [November](/docs/security/bulletin/2020-11-01)
    - [October](/docs/security/bulletin/2020-10-01)
    - [September](/docs/security/bulletin/2020-09-01)
    - [August](/docs/security/bulletin/2020-08-01)
    - [July](/docs/security/bulletin/2020-07-01)
    - [June](/docs/security/bulletin/2020-06-01)
    - [May](/docs/security/bulletin/2020-05-01)
    - [April](/docs/security/bulletin/2020-04-01)
    - [March](/docs/security/bulletin/2020-03-01)
    - [February](/docs/security/bulletin/2020-02-01)
    - [January](/docs/security/bulletin/2020-01-01)
    - [Android 11](/docs/security/bulletin/android-11)
    - [Index](/docs/security/bulletin/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/2019-12-01)
    - [November](/docs/security/bulletin/2019-11-01)
    - [October](/docs/security/bulletin/2019-10-01)
    - [September](/docs/security/bulletin/2019-09-01)
    - [August](/docs/security/bulletin/2019-08-01)
    - [July](/docs/security/bulletin/2019-07-01)
    - [June](/docs/security/bulletin/2019-06-01)
    - [May](/docs/security/bulletin/2019-05-01)
    - [April](/docs/security/bulletin/2019-04-01)
    - [March](/docs/security/bulletin/2019-03-01)
    - [February](/docs/security/bulletin/2019-02-01)
    - [January](/docs/security/bulletin/2019-01-01)
    - [Android 10](/docs/security/bulletin/android-10)
    - [Index](/docs/security/bulletin/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/2018-12-01)
    - [November](/docs/security/bulletin/2018-11-01)
    - [October](/docs/security/bulletin/2018-10-01)
    - [September](/docs/security/bulletin/2018-09-01)
    - [August](/docs/security/bulletin/2018-08-01)
    - [July](/docs/security/bulletin/2018-07-01)
    - [June](/docs/security/bulletin/2018-06-01)
    - [May](/docs/security/bulletin/2018-05-01)
    - [April](/docs/security/bulletin/2018-04-01)
    - [March](/docs/security/bulletin/2018-03-01)
    - [February](/docs/security/bulletin/2018-02-01)
    - [January](/docs/security/bulletin/2018-01-01)
    - [Index](/docs/security/bulletin/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/2017-12-01)
    - [November](/docs/security/bulletin/2017-11-01)
    - [October](/docs/security/bulletin/2017-10-01)
    - [September](/docs/security/bulletin/2017-09-01)
    - [August](/docs/security/bulletin/2017-08-01)
    - [July](/docs/security/bulletin/2017-07-01)
    - [June](/docs/security/bulletin/2017-06-01)
    - [May](/docs/security/bulletin/2017-05-01)
    - [April](/docs/security/bulletin/2017-04-01)
    - [March](/docs/security/bulletin/2017-03-01)
    - [February](/docs/security/bulletin/2017-02-01)
    - [January](/docs/security/bulletin/2017-01-01)
    - [Index](/docs/security/bulletin/2017)
  + 2016 bulletins
    - [December](/docs/security/bulletin/2016-12-01)
    - [November](/docs/security/bulletin/2016-11-01)
    - [October](/docs/security/bulletin/2016-10-01)
    - [September](/docs/security/bulletin/2016-09-01)
    - [August](/docs/security/bulletin/2016-08-01)
    - [July](/docs/security/bulletin/2016-07-01)
    - [June](/docs/security/bulletin/2016-06-01)
    - [May](/docs/security/bulletin/2016-05-01)
    - [April](/docs/security/bulletin/2016-04-02)
    - [March](/docs/security/bulletin/2016-03-01)
    - [February](/docs/security/bulletin/2016-02-01)
    - [January](/docs/security/bulletin/2016-01-01)
    - [Index](/docs/security/bulletin/2016)
  + 2015 bulletins
    - [December](/docs/security/bulletin/2015-12-01)
    - [November](/docs/security/bulletin/2015-11-01)
    - [October](/docs/security/bulletin/2015-10-01)
    - [September](/docs/security/bulletin/2015-09-01)
    - [August](/docs/security/bulletin/2015-08-01)
    - [Index](/docs/security/bulletin/2015)
  + Pixel/Nexus bulletins
  + [Overview](/docs/security/bulletin/pixel)
  + 2025 bulletins
    - [January](/docs/security/bulletin/pixel/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel/2024-12-01)
    - [November](/docs/security/bulletin/pixel/2024-11-01)
    - [October](/docs/security/bulletin/pixel/2024-10-01)
    - [September](/docs/security/bulletin/pixel/2024-09-01)
    - [August](/docs/security/bulletin/pixel/2024-08-01)
    - [July](/docs/security/bulletin/pixel/2024-07-01)
    - [June](/docs/security/bulletin/pixel/2024-06-01)
    - [May](/docs/security/bulletin/pixel/2024-05-01)
    - [April](/docs/security/bulletin/pixel/2024-04-01)
    - [March](/docs/security/bulletin/pixel/2024-03-01)
    - [February](/docs/security/bulletin/pixel/2024-02-01)
    - [January](/docs/security/bulletin/pixel/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel/2023-12-01)
    - [November](/docs/security/bulletin/pixel/2023-11-01)
    - [October](/docs/security/bulletin/pixel/2023-10-01)
    - [September](/docs/security/bulletin/pixel/2023-09-01)
    - [August](/docs/security/bulletin/pixel/2023-08-01)
    - [July](/docs/security/bulletin/pixel/2023-07-01)
    - [June](/docs/security/bulletin/pixel/2023-06-01)
    - [May](/docs/security/bulletin/pixel/2023-05-01)
    - [April](/docs/security/bulletin/pixel/2023-04-01)
    - [March](/docs/security/bulletin/pixel/2023-03-01)
    - [February](/docs/security/bulletin/pixel/2023-02-01)
    - [January](/docs/security/bulletin/pixel/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/pixel/2022-12-01)
    - [November](/docs/security/bulletin/pixel/2022-11-01)
    - [October](/docs/security/bulletin/pixel/2022-10-01)
    - [September](/docs/security/bulletin/pixel/2022-09-01)
    - [August](/docs/security/bulletin/pixel/2022-08-01)
    - [July](/docs/security/bulletin/pixel/2022-07-01)
    - [June](/docs/security/bulletin/pixel/2022-06-01)
    - [May](/docs/security/bulletin/pixel/2022-05-01)
    - [April](/docs/security/bulletin/pixel/2022-04-01)
    - [March](/docs/security/bulletin/pixel/2022-03-01)
    - [February](/docs/security/bulletin/pixel/2022-02-01)
    - [January](/docs/security/bulletin/pixel/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/pixel/2021-12-01)
    - [November](/docs/security/bulletin/pixel/2021-11-01)
    - [October](/docs/security/bulletin/pixel/2021-10-01)
    - [September](/docs/security/bulletin/pixel/2021-09-01)
    - [August](/docs/security/bulletin/pixel/2021-08-01)
    - [July](/docs/security/bulletin/pixel/2021-07-01)
    - [June](/docs/security/bulletin/pixel/2021-06-01)
    - [May](/docs/security/bulletin/pixel/2021-05-01)
    - [April](/docs/security/bulletin/pixel/2021-04-01)
    - [March](/docs/security/bulletin/pixel/2021-03-01)
    - [February](/docs/security/bulletin/pixel/2021-02-01)
    - [January](/docs/security/bulletin/pixel/2021-01-01)
    - [Index](/docs/security/bulletin/pixel/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/pixel/2020-12-01)
    - [November](/docs/security/bulletin/pixel/2020-11-01)
    - [October](/docs/security/bulletin/pixel/2020-10-01)
    - [September](/docs/security/bulletin/pixel/2020-09-01)
    - [August](/docs/security/bulletin/pixel/2020-08-01)
    - [July](/docs/security/bulletin/pixel/2020-07-01)
    - [June](/docs/security/bulletin/pixel/2020-06-01)
    - [May](/docs/security/bulletin/pixel/2020-05-01)
    - [April](/docs/security/bulletin/pixel/2020-04-01)
    - [March](/docs/security/bulletin/pixel/2020-03-01)
    - [February](/docs/security/bulletin/pixel/2020-02-01)
    - [January](/docs/security/bulletin/pixel/2020-01-01)
    - [Index](/docs/security/bulletin/pixel/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/pixel/2019-12-01)
    - [November](/docs/security/bulletin/pixel/2019-11-01)
    - [October](/docs/security/bulletin/pixel/2019-10-01)
    - [September](/docs/security/bulletin/pixel/2019-09-01)
    - [August](/docs/security/bulletin/pixel/2019-08-01)
    - [July](/docs/security/bulletin/pixel/2019-07-01)
    - [June](/docs/security/bulletin/pixel/2019-06-01)
    - [May](/docs/security/bulletin/pixel/2019-05-01)
    - [April](/docs/security/bulletin/pixel/2019-04-01)
    - [March](/docs/security/bulletin/pixel/2019-03-01)
    - [February](/docs/security/bulletin/pixel/2019-02-01)
    - [January](/docs/security/bulletin/pixel/2019-01-01)
    - [Index](/docs/security/bulletin/pixel/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/pixel/2018-12-01)
    - [November](/docs/security/bulletin/pixel/2018-11-01)
    - [October](/docs/security/bulletin/pixel/2018-10-01)
    - [September](/docs/security/bulletin/pixel/2018-09-01)
    - [August](/docs/security/bulletin/pixel/2018-08-01)
    - [July](/docs/security/bulletin/pixel/2018-07-01)
    - [June](/docs/security/bulletin/pixel/2018-06-01)
    - [May](/docs/security/bulletin/pixel/2018-05-01)
    - [April](/docs/security/bulletin/pixel/2018-04-01)
    - [March](/docs/security/bulletin/pixel/2018-03-01)
    - [February](/docs/security/bulletin/pixel/2018-02-01)
    - [January](/docs/security/bulletin/pixel/2018-01-01)
    - [Index](/docs/security/bulletin/pixel/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/pixel/2017-12-01)
    - [November](/docs/security/bulletin/pixel/2017-11-01)
    - [October](/docs/security/bulletin/pixel/2017-10-01)
    - [Index](/docs/security/bulletin/pixel/2017)
  + Android Automotive
  + [Overview](/docs/security/bulletin/aaos)
  + 2025 bulletins
    - [January](/docs/security/bulletin/aaos/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/aaos/2024-12-01)
    - [November](/docs/security/bulletin/aaos/2024-11-01)
    - [October](/docs/security/bulletin/aaos/2024-10-01)
    - [September](/docs/security/bulletin/aaos/2024-09-01)
    - [August](/docs/security/bulletin/aaos/2024-08-01)
    - [July](/docs/security/bulletin/aaos/2024-07-01)
    - [June](/docs/security/bulletin/aaos/2024-06-01)
    - [May](/docs/security/bulletin/aaos/2024-05-01)
    - [April](/docs/security/bulletin/aaos/2024-04-01)
    - [March](/docs/security/bulletin/aaos/2024-03-01)
    - [February](/docs/security/bulletin/aaos/2024-02-01)
    - [January](/docs/security/bulletin/aaos/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/aaos/2023-12-01)
    - [November](/docs/security/bulletin/aaos/2023-11-01)
    - [October](/docs/security/bulletin/aaos/2023-10-01)
    - [September](/docs/security/bulletin/aaos/2023-09-01)
    - [August](/docs/security/bulletin/aaos/2023-08-01)
    - [July](/docs/security/bulletin/aaos/2023-07-01)
    - [June](/docs/security/bulletin/aaos/2023-06-01)
    - [May](/docs/security/bulletin/aaos/2023-05-01)
    - [April](/docs/security/bulletin/aaos/2023-04-01)
    - [March](/docs/security/bulletin/aaos/2023-03-01)
    - [February](/docs/security/bulletin/aaos/2023-02-01)
    - [January](/docs/security/bulletin/aaos/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/aaos/2022-12-01)
    - [November](/docs/security/bulletin/aaos/2022-11-01)
    - [October](/docs/security/bulletin/aaos/2022-10-01)
    - [September](/docs/security/bulletin/aaos/2022-09-01)
    - [August](/docs/security/bulletin/aaos/2022-08-01)
    - [July](/docs/security/bulletin/aaos/2022-07-01)
    - [June](/docs/security/bulletin/aaos/2022-06-01)
    - [May](/docs/security/bulletin/aaos/2022-05-01)
    - [April](/docs/security/bulletin/aaos/2022-04-01)
    - [March](/docs/security/bulletin/aaos/2022-03-01)
    - [February](/docs/security/bulletin/aaos/2022-02-01)
    - [January](/docs/security/bulletin/aaos/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/aaos/2021-12-01)
    - [November](/docs/security/bulletin/aaos/2021-11-01)
    - [October](/docs/security/bulletin/aaos/2021-10-01)
    - [September](/docs/security/bulletin/aaos/2021-09-01)
    - [August](/docs/security/bulletin/aaos/2021-08-01)
    - [July](/docs/security/bulletin/aaos/2021-07-01)
    - [June](/docs/security/bulletin/aaos/2021-06-01)
    - [May](/docs/security/bulletin/aaos/2021-05-01)
    - [April](/docs/security/bulletin/aaos/2021-04-01)
    - [March](/docs/security/bulletin/aaos/2021-03-01)
    - [February](/docs/security/bulletin/aaos/2021-02-01)
    - [January](/docs/security/bulletin/aaos/2021-01-01)
  + Chromecast
  + [Overview](/docs/security/bulletin/chromecast)
  + 2024 bulletins
    - [December](/docs/security/bulletin/chromecast/2024-12-01)
    - [September](/docs/security/bulletin/chromecast/2024-09-01)
    - [July](/docs/security/bulletin/chromecast/2024-07-01)
    - [March](/docs/security/bulletin/chromecast/2024-03-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/chromecast/2023-12-01)
    - [September](/docs/security/bulletin/chromecast/2023-07-01)
    - [June](/docs/security/bulletin/chromecast/2023-06-01)
    - [April](/docs/security/bulletin/chromecast/2023-04-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/chromecast/2022-12-01)
    - [October](/docs/security/bulletin/chromecast/2022-10-01)
    - [July](/docs/security/bulletin/chromecast/2022-07-01)
  + Wear
  + [Overview](/docs/security/bulletin/wear)
  + 2025 bulletins
    - [January](/docs/security/bulletin/wear/2025/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/wear/2024/2024-12-01)
    - [November](/docs/security/bulletin/wear/2024/2024-11-01)
    - [October](/docs/security/bulletin/wear/2024/2024-10-01)
    - [September](/docs/security/bulletin/wear/2024/2024-09-01)
    - [August](/docs/security/bulletin/wear/2024/2024-08-01)
    - [July](/docs/security/bulletin/wear/2024/2024-07-01)
    - [June](/docs/security/bulletin/wear/2024/2024-06-01)
    - [May](/docs/security/bulletin/wear/2024/2024-05-01)
    - [April](/docs/security/bulletin/wear/2024/2024-04-01)
    - [March](/docs/security/bulletin/wear/2024/2024-03-01)
    - [February](/docs/security/bulletin/wear/2024/2024-02-01)
    - [January](/docs/security/bulletin/wear/2024/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/wear/2023/2023-12-01)
    - [November](/docs/security/bulletin/wear/2023/2023-11-01)
    - [October](/docs/security/bulletin/wear/2023/2023-10-01)
    - [September](/docs/security/bulletin/wear/2023/2023-09-01)
    - [August](/docs/security/bulletin/wear/2023/2023-08-01)
  + Pixel Watch
  + [Overview](/docs/security/bulletin/pixel-watch)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2024-12-01)
    - [August](/docs/security/bulletin/pixel-watch/2024-08-01)
    - [July](/docs/security/bulletin/pixel-watch/2024-07-01)
    - [June](/docs/security/bulletin/pixel-watch/2024-06-01)
    - [May](/docs/security/bulletin/pixel-watch/2024-05-01)
    - [April](/docs/security/bulletin/pixel-watch/2024-04-01)
    - [March](/docs/security/bulletin/pixel-watch/2024-03-01)
    - [February](/docs/security/bulletin/pixel-watch/2024-02-01)
    - [January](/docs/security/bulletin/pixel-watch/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2023/2023-12-01)
    - [September](/docs/security/bulletin/pixel-watch/2023/2023-09-01)
    - [June](/docs/security/bulletin/pixel-watch/2023/2023-06-01)
  + Advisories
  + [Overview](/docs/security/bulletin/advisory)
  + [March 2016](/docs/security/bulletin/advisory/2016-03-18)
* Features
  + [Overview](/docs/security/features)
  + [Application Sandbox](/docs/security/app-sandbox)
  + [OMAPI vendor stable interface](/docs/security/features/open-mobile-api)
  + App signing
    - [Overview](/docs/security/features/apksigning)
    - [APK signature scheme v2](/docs/security/features/apksigning/v2)
    - [APK signature scheme v3](/docs/security/features/apksigning/v3)
    - [APK signature scheme v3.1](/docs/security/features/apksigning/v3-1)
    - [APK signature scheme v4](/docs/security/features/apksigning/v4)
  + Authentication
    - [Overview](/docs/security/features/authentication)
    - [Gatekeeper](/docs/security/features/authentication/gatekeeper)
    - Biometrics
      * [Overview](/docs/security/features/biometric)
      * [Measure biometric security](/docs/security/features/biometric/measure)
      * [Fingerprint HIDL](/docs/security/features/authentication/fingerprint-hal)
      * [Face authentication HIDL](/docs/security/features/biometric/face-authentication)
    - Protected confirmation
      * [Overview](/docs/security/features/protected-confirmation)
      * [Implementation](/docs/security/features/protected-confirmation/implementation)
      * [Design guidelines](/docs/security/features/protected-confirmation/design)
      * [Accessibility](/docs/security/features/protected-confirmation/accessibility)
  + DICE
    - [Overview](/docs/security/features/dice)
    - [Applications of DICE](/docs/security/features/dice/applications-of-dice)
  + Encryption
    - [Overview](/docs/security/features/encryption)
    - [File-based encryption](/docs/security/features/encryption/file-based)
    - [Full-disk encryption](/docs/security/features/encryption/full-disk)
    - [Metadata encryption](/docs/security/features/encryption/metadata)
    - [Enable Adiantum](/docs/security/features/encryption/adiantum)
    - [Hardware-wrapped keys](/docs/security/features/encryption/hw-wrapped-keys)
  + Keystore
    - [Overview](/docs/security/features/keystore)
    - [Features](/docs/security/features/keystore/features)
    - [Key and ID attestation](/docs/security/features/keystore/attestation)
    - [Version binding](/docs/security/features/keystore/version-binding)
    - [Authorization tags](/docs/security/features/keystore/tags)
    - [Functions](/docs/security/features/keystore/implementer-ref)
  + Identity credential
    - [Overview](/docs/security/features/identity-credentials)
  + SELinux
    - [Overview](/docs/security/features/selinux)
    - [Concepts](/docs/security/features/selinux/concepts)
    - [Implementation](/docs/security/features/selinux/implement)
    - [Customization](/docs/security/features/selinux/customize)
    - [Build sepolicy](/docs/security/features/selinux/build)
    - [Compatibility](/docs/security/features/selinux/compatibility)
    - [Validation](/docs/security/features/selinux/validate)
    - [Write policy](/docs/security/features/selinux/device-policy)
    - [Vendor init](/docs/security/features/selinux/vendor-init)
  + Trusty TEE
    - [Overview](/docs/security/features/trusty)
    - [Download and build](/docs/security/features/trusty/download-and-build)
    - [Trusty API reference](/docs/security/features/trusty/trusty-ref)
  + Verified Boot
    - [Overview](/docs/security/features/verifiedboot)
    - [Device state](/docs/security/features/verifiedboot/device-state)
    - [Verify Boot](/docs/security/features/verifiedboot/verified-boot)
    - [Boot flow](/docs/security/features/verifiedboot/boot-flow)
    - [Implement dm-verity](/docs/security/features/verifiedboot/dm-verity)
    - [Verify system\_other partition](/docs/security/features/verifiedboot/verify-system-other-partition)
    - [Reference implementation](/docs/security/features/verifiedboot/avb)
  + Safety Center
    - [Overview](/docs/security/safety-center/overview)
    - [Customize Safety Center](/docs/security/safety-center/customize)
    - [Customize Safety Center UI](/docs/security/safety-center/customize-ui)
    - [Interact with Safety Center](/docs/security/safety-center/interact)
    - [Testing and validation](/docs/security/safety-center/test-requirements)
  + Cellular security
    - [Overview](/docs/security/features/cellular-security/overview)
    - [Disable 2G](/docs/security/features/cellular-security/disable-2g)
  + [Private space](/docs/security/features/private-space)
* Testing
  + [Overview](/docs/security/test/fuzz-sanitize)
  + [Memory safety](/docs/security/test/memory-safety)
  + Arm Memory Tagging Extension
  + [Overview](/docs/security/test/memory-safety/arm-mte)
  + [Bootloader support](/docs/security/test/memory-safety/bootloader-support)
  + [Understand MTE reports](/docs/security/test/memory-safety/mte-reports)
  + [MTE configuration](/docs/security/test/memory-safety/mte-configuration)
  + Sanitizers
  + [Overview](/docs/security/test/sanitizers)
  + [AddressSanitizer](/docs/security/test/asan)
  + [Kernel AddressSanitizer](/docs/security/test/kasan)
  + [Hardware-assisted AddressSanitizer](/docs/security/test/hwasan)
  + [Understand HWASan reports](/docs/security/test/memory-safety/hwasan-reports)
  + [UndefinedBehaviorSanitizer](/docs/security/test/ubsan)
  + Other topics
  + [Control flow integrity](/docs/security/test/cfi)
  + [Kernel control flow integrity](/docs/security/test/kcfi)
  + [Execute-only memory](/docs/security/test/execute-only-memory)
  + [Fuzz with libFuzzer](/docs/security/test/libfuzzer)
  + [GWP-ASan and KFENCE](/docs/security/test/memory-safety/gwp-asan-kfence)
  + [Security Test Suite development kit](/docs/security/test/sts-sdk)
  + [Scudo](/docs/security/test/scudo)
  + [ShadowCallStack](/docs/security/test/shadow-call-stack)
  + [Tagged pointers](/docs/security/test/tagged-pointers)
  + [Zero initialized memory](/docs/security/test/memory-safety/zero-initialized-memory)
* Best practices
  + [Overview](/docs/security/best-practices)
  + [Operational security](/docs/security/best-practices/ops)
  + [System security](/docs/security/best-practices/system)
  + [App security](/docs/security/best-practices/app)
  + [Network security](/docs/security/best-practices/network)
  + [Hardware security](/docs/security/best-practices/hardware)
  + [Privacy security](/docs/security/best-practices/privacy)

* What's new?
* [Release notes](/docs/whatsnew/release-notes)
* [Latest security bulletins](/docs/whatsnew/latest-security-bulletins)
* [Latest Compatibility Definition Document (CDD)](/docs/whatsnew/latest-cdd)
* [Site updates](/docs/whatsnew/site-updates)
* Getting Started
* [About](/docs/setup/about)
* [Start](/docs/setup/start)
* [Download](/docs/setup/download)
* [Build](/docs/setup/build)
* [Test](/docs/setup/test)
* [Create](/docs/setup/create/coding-tasks)
* [Contribute](/docs/setup/contribute)
* [Community](/docs/setup/community/cofc)
* [Tools, build, and related reference](/docs/setup/reference)
* Security
* [Overview](/docs/security/overview)
* [Bulletins](/docs/security/bulletin)
* [Features](/docs/security/features)
* [Testing](/docs/security/test/fuzz-sanitize)
* [Best Practices](/docs/security/best-practices)
* Core Topics
* [Architecture](/docs/core/architecture)
* [Audio](/docs/core/audio)
* [Camera](/docs/core/camera)
* [Connectivity](/docs/core/connect)
* [Data](/docs/core/data)
* [Display](/docs/core/display)
* [Fonts](/docs/core/fonts/custom-font-fallback)
* [Graphics](/docs/core/graphics)
* [Interaction](/docs/core/interaction)
* [Media](/docs/core/media)
* [Performance](/docs/core/perf)
* [Permissions](/docs/core/permissions)
* [Power](/docs/core/power)
* [Runtime](/docs/core/runtime)
* [Settings](/docs/core/settings)
* [Storage](/docs/core/storage)
* [Tests](/docs/core/tests)
* [Updates](/docs/core/ota)
* [Virtualization](/docs/core/virtualization)
* Compatibility
* [Compatibility Definition Document (CDD)](/docs/compatibility/cdd)
* [Compatibility Test Suite (CTS)](/docs/compatibility/cts)
* Android Devices
* [Cuttlefish](/docs/devices/cuttlefish)
* [Enterprise](/docs/devices/admin)
* [TV](/docs/devices/tv)
* Automotive
* [Get Started](/docs/automotive/start/what_automotive)
* [Guidelines for Development](/docs/automotive/guidelines)
* [Development Tools](/docs/automotive/dev-tools)
* [Testing Tools and Infrastructure](/docs/automotive/tools)
* [Release Details](/docs/automotive/start/releases)
* Reference
* [HIDL](/reference/hidl)
* [HAL](/reference/hal)
* [Trade Federation](/reference/tradefed/classes)
* [Security Test Suite](/reference/sts/classes)

* [AOSP](https://source.android.com/)
* [Security](https://source.android.com/docs/security)

# Android Security Bulletin—August 2017

Stay organized with collections

Save and categorize content based on your preferences.

*Published August 7, 2017 | Updated August 23, 2017*

The Android Security Bulletin contains details of security vulnerabilities
affecting Android devices. Security patch levels of August 05, 2017 or later
address all of these issues. Refer to the [Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices) to learn how to check a device's security patch
level.

Partners were notified of the issues described in the bulletin at least a month
ago. Source code patches for these issues have been released to the Android Open
Source Project (AOSP) repository and linked from this bulletin. This bulletin also
includes links to patches outside of AOSP.

The most severe of these issues is a critical security vulnerability in media
framework that could enable a remote attacker using a specially crafted file to
execute arbitrary code within the context of a privileged process. The [severity
assessment](/docs/security/overview/updates-resources#severity) is based on the effect that exploiting the vulnerability would
possibly have on an affected device, assuming the platform and service
mitigations are turned off for development purposes or if successfully bypassed.

We have had no reports of active customer exploitation or abuse of these newly
reported issues. Refer to the [Android and Google Play
Protect mitigations](#mitigations) section for details on the [Android
security platform protections](/docs/security/enhancements) and Google Play Protect, which improve the
security of the Android platform.

We encourage all customers to accept these updates to their devices.

**Note:** Information on the latest over-the-air update (OTA) and
firmware images for Google devices is available in the [Google device updates](#google-device-updates) section.

## Announcements

* This bulletin has two security patch level strings to provide Android
  partners with the flexibility to more quickly fix a subset of vulnerabilities
  that are similar across all Android devices. See [Common questions and answers](#questions) for
  additional information:
  + **2017-08-01**: Partial security patch level string. This
    security patch level string indicates that all issues associated with 2017-08-01
    (and all previous security patch level strings) are addressed.
  + **2017-08-05**: Complete security patch level string. This
    security patch level string indicates that all issues associated with 2017-08-01
    and 2017-08-05 (and all previous security patch level strings) are
    addressed.

## Android and Google Play Protect mitigations

This is a summary of the mitigations provided by the [Android
security platform](/docs/security/enhancements) and service protections such as [Google Play Protect](https://www.android.com/play-protect). These
capabilities reduce the likelihood that security vulnerabilities could be
successfully exploited on Android.

* Exploitation for many issues on Android is made more difficult by
  enhancements in newer versions of the Android platform. We encourage all users
  to update to the latest version of Android where possible.
* The Android security team actively monitors for abuse through [Google Play Protect](https://www.android.com/play-protect) and warns
  users about
  [Potentially
  Harmful Applications](/static/docs/security/reports/Google_Android_Security_PHA_classifications.pdf). Google Play Protect is enabled by default on devices
  with [Google Mobile Services](http://www.android.com/gms), and is
  especially important for users who install apps from outside of Google Play.

## 2017-08-01 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2017-08-01 patch level. Vulnerabilities are
grouped under the component that they affect. There is a description of the
issue and a table with the CVE, associated references, [type of vulnerability](#type), [severity](/docs/security/overview/updates-resources#severity),
and updated AOSP versions (where applicable). When available, we link the public
change that addressed the issue to the bug ID, like the AOSP change list. When
multiple changes relate to a single bug, additional references are linked to
numbers following the bug ID.

### Framework

The most severe vulnerability in this section could enable a local malicious
application using a specially crafted file to execute arbitrary code within the
context of a privileged process.

| CVE | References | Type | Severity | Updated AOSP versions |
| CVE-2017-0712 | [A-37207928](https://android.googlesource.com/platform/frameworks/opt/net/wifi/%2B/e8beda2579d277fb6b27f1792c4ed45c136ee15a) | EoP | Moderate | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |

### Libraries

The most severe vulnerability in this section could enable a remote attacker
using a specially crafted file to execute arbitrary code within the context of
an unprivileged process.

| CVE | References | Type | Severity | Updated AOSP versions |
| CVE-2017-0713 | [A-32096780](https://android.googlesource.com/platform/external/sfntly/%2B/a642e3543a4ffdaaf1456768968ae05a205ed4f4) [[2](https://android.googlesource.com/platform/external/sfntly/%2B/fa6053736808e999483ca0a21fbe16a3075cf2c8)] | RCE | High | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |

### Media framework

The most severe vulnerability in this section could enable a remote attacker
using a specially crafted file to execute arbitrary code within the context of a
privileged process.

| CVE | References | Type | Severity | Updated AOSP versions |
| CVE-2017-0714 | [A-36492637](https://android.googlesource.com/platform/frameworks/av/%2B/26557d832fde349721500b47d51467c046794ae9) | RCE | Critical | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0715 | [A-36998372](https://android.googlesource.com/platform/external/libavc/%2B/676c26e6a2ab3b75ab6e8fdd984547219fc1ceb5) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0716 | [A-37203196](https://android.googlesource.com/platform/external/libmpeg2/%2B/d5f52646974c29e6b7d51230b8ddae0c0a9430dc) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0718 | [A-37273547](https://android.googlesource.com/platform/external/libmpeg2/%2B/327496c59fb280273e23353061980dd72b07de1f) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0719 | [A-37273673](https://android.googlesource.com/platform/external/libmpeg2/%2B/f0afcf1943a1844e2a82ac3c5ab4d49427102cd1) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0720 | [A-37430213](https://android.googlesource.com/platform/external/libhevc/%2B/84732aaa4255955b8fefc39efee9b369181a6861) | RCE | Critical | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0721 | [A-37561455](https://android.googlesource.com/platform/external/libmpeg2/%2B/08a0d1ab6277770babbedab6ce7e7e2481869ad0) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0722 | [A-37660827](https://android.googlesource.com/platform/frameworks/av/%2B/26557d832fde349721500b47d51467c046794ae9) | RCE | Critical | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0723 | [A-37968755](https://android.googlesource.com/platform/external/libavc/%2B/fe5ade4c86e2f5a86eab6c6593981d02f4c1710b) | RCE | Critical | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0745 | [A-37079296](https://android.googlesource.com/platform/frameworks/av/%2B/b6ec3bbba36a3816a936f1e31984529b875b3618) | RCE | Critical | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0724 | [A-36819262](https://android.googlesource.com/platform/external/libmpeg2/%2B/08a0d1ab6277770babbedab6ce7e7e2481869ad0) | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0725 | [A-37627194](https://android.googlesource.com/platform/external/skia/%2B/59372f5412036ce87285e91fd2dd53e37ff990e4) | DoS | High | 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0726 | [A-36389123](https://android.googlesource.com/platform/frameworks/av/%2B/8995285da14e1303ae7357bf8162cbec13e65b68) | DoS | High | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0727 | [A-33004354](https://android.googlesource.com/platform/frameworks/native/%2B/39dfabd43cbe57f92b771c0110a5c2d976b6c44f) | EoP | High | 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0728 | [A-37469795](https://android.googlesource.com/platform/external/libhevc/%2B/314a0d038e6ae24bef80fff0b542965aed78ae96) | DoS | High | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0729 | [A-37710346](https://android.googlesource.com/platform/frameworks/av/%2B/96974782cd914120272a026ebc263dd38098f392) | EoP | High | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0730 | [A-36279112](https://android.googlesource.com/platform/external/libavc/%2B/efd28f6c36d40d0a8dd92f344e1d9a992b315c36) | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0731 | [A-36075363](https://android.googlesource.com/platform/frameworks/av/%2B/c10183960909f074a265c134cd4087785e7d26bf) | EoP | High | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0732 | [A-37504237](https://android.googlesource.com/platform/frameworks/av/%2B/bf153fbedc2333b14e90826d22f08d10e832db29) | EoP | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0733 | [A-38391487](https://android.googlesource.com/platform/frameworks/base/%2B/6f357fd589e115a74aae25b1ac325af6121cdadf) | DoS | High | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0734 | [A-38014992](https://android.googlesource.com/platform/external/libavc/%2B/f6650b34ef27d6da8cdccd42e0f76fe756a9375b) | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0735 | [A-38239864](https://android.googlesource.com/platform/external/libavc/%2B/fe5ade4c86e2f5a86eab6c6593981d02f4c1710b) [[2](https://android.googlesource.com/platform/external/libavc/%2B/490bed0e7dce49296d50bb519348c6a87de8a8ef)] | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0736 | [A-38487564](https://android.googlesource.com/platform/external/libavc/%2B/dfbbb54f14f83d45ad06a91aa76ed8260eb795d5) | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0687 | [A-35583675](https://android.googlesource.com/platform/external/libavc/%2B/17b46beeae7421f76d894f14696ba4db9023287c) | DoS | High | 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0737 | [A-37563942](https://android.googlesource.com/platform/frameworks/av/%2B/77e075ddd6d8cae33832add5225ee8f8c77908f0) | EoP | High | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0805 | [A-37237701](https://android.googlesource.com/platform/frameworks/av/%2B/77e075ddd6d8cae33832add5225ee8f8c77908f0) | EoP | High | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0738 | [A-37563371](https://android.googlesource.com/platform/frameworks/av/%2B/1d919d737b374b98b900c08c9d0c82fe250feb08) [[2](https://android.googlesource.com/platform/hardware/qcom/audio/%2B/234848dd6756c5d636f5a103e51636d60932983c)] | ID | Moderate | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |
| CVE-2017-0739 | [A-37712181](https://android.googlesource.com/platform/external/libhevc/%2B/e6e353a231f746743866d360b88ef8ced367bcb1) | ID | Moderate | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2 |

## 2017-08-05 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2017-08-05 patch level. Vulnerabilities are
grouped under the component that they affect and include details such as the
CVE, associated references, [type of
vulnerability](#type), [severity](/docs/security/overview/updates-resources#severity),
component (where applicable), and updated AOSP versions (where applicable). When
available, we link the public change that addressed the issue to the bug ID,
like the AOSP change list. When multiple changes relate to a single bug,
additional references are linked to numbers following the bug ID.

### Broadcom components

The most severe vulnerability in this section could enable a remote attacker
using a specially crafted file to execute arbitrary code within the context of
an unprivileged process.

| CVE | References | Type | Severity | Component |
| CVE-2017-0740 | A-37168488[\*](#asterisk) B-RB#116402 | RCE | Moderate | Networking driver |

### Kernel components

The most severe vulnerability in this section could enable a local malicious
application to execute arbitrary code within the context of a privileged
process.

| CVE | References | Type | Severity | Component |
| CVE-2017-10661 | A-36266767 [Upstream kernel](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/commit/?id=1e38da300e1e395a15048b0af1e5305bd91402f6) | EoP | High | File system |
| CVE-2017-0750 | A-36817013[\*](#asterisk) | EoP | Moderate | File system |
| CVE-2017-10662 | A-36815012 [Upstream kernel](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/commit/?id=b9dd46188edc2f0d1f37328637860bb65a771124) | EoP | Moderate | File system |
| CVE-2017-10663 | A-36588520 [Upstream kernel](https://sourceforge.net/p/linux-f2fs/mailman/message/35835945/) | EoP | Moderate | File System |
| CVE-2017-0749 | A-36007735[\*](#asterisk) | EoP | Moderate | Linux kernel |

### MediaTek components

The most severe vulnerability in this section could enable a local malicious
application to execute arbitrary code within the context of a privileged
process.

| CVE | References | Type | Severity | Component |
| CVE-2017-0741 | A-32458601[\*](#asterisk) M-ALPS03007523 | EoP | High | GPU driver |
| CVE-2017-0742 | A-36074857[\*](#asterisk) M-ALPS03275524 | EoP | Moderate | Video driver |

### Qualcomm components

The most severe vulnerability in this section could enable a local malicious
application to execute arbitrary code within the context of a privileged
process.

| CVE | References | Type | Severity | Component |
| CVE-2017-0746 | A-35467471[\*](#asterisk) QC-CR#2029392 | EoP | Moderate | IPA driver |
| CVE-2017-0747 | A-32524214[\*](#asterisk) QC-CR#2044821 | EoP | Moderate | Proprietary Component |
| CVE-2017-9678 | A-35258962[\*](#asterisk) QC-CR#2028228 | EoP | Moderate | Video driver |
| CVE-2017-9691 | A-33842910[\*](#asterisk) QC-CR#1116560 | EoP | Moderate | MobiCore driver (Trustonic) |
| CVE-2017-9684 | A-35136547[\*](#asterisk) QC-CR#2037524 | EoP | Moderate | USB driver |
| CVE-2017-9682 | A-36491445[\*](#asterisk) QC-CR#2030434 | ID | Moderate | GPU driver |

## Google device updates

This table contains the security patch level in the latest over-the-air update
(OTA) and firmware images for Google devices. The Google device firmware images
are available on the [Google Developer
site](https://developers.google.com/android/nexus/images).

| Google device | Security patch level |
| --- | --- |
| Pixel / Pixel XL | August 05, 2017 |
| Nexus 5X | August 05, 2017 |
| Nexus 6 | August 05, 2017 |
| Nexus 6P | August 05, 2017 |
| Nexus 9 | August 05, 2017 |
| Nexus Player | August 05, 2017 |
| Pixel C | August 05, 2017 |

Google device updates also contain patches for these security
vulnerabilities, if applicable:

| CVE | References | Type | Severity | Component |
| CVE-2017-0744 | A-34112726[\*](#asterisk) N-CVE-2017-0744 | EoP | Low | Sound driver |
| CVE-2017-9679 | A-35644510[\*](#asterisk) QC-CR#2029409 | ID | Low | SoC driver |
| CVE-2017-9680 | A-35764241[\*](#asterisk) QC-CR#2030137 | ID | Low | SoC driver |
| CVE-2017-0748 | A-35764875[\*](#asterisk) QC-CR#2029798 | ID | Low | Audio driver |
| CVE-2017-9681 | A-36386593[\*](#asterisk) QC-CR#2030426 | ID | Low | Radio driver |
| CVE-2017-9693 | A-36817798[\*](#asterisk) QC-CR#2044820 | ID | Low | Networking driver |
| CVE-2017-9694 | A-36818198[\*](#asterisk) QC-CR#2045470 | ID | Low | Networking driver |
| CVE-2017-0751 | A-36591162[\*](#asterisk) QC-CR#2045061 | EoP | Low | QCE driver |
| CVE-2017-9692 | A-36731152[\*](#asterisk) QC-CR#2021707 | DoS | Low | Graphics driver |

## Acknowledgements

We would like to thank these researchers for their contributions:

| CVEs | Researchers |
| CVE-2017-0741, CVE-2017-0742, CVE-2017-0751 | Baozeng Ding ([@sploving](https://twitter.com/sploving1)), Chengming Yang, and Yang Song of Alibaba Mobile Security Group |
| CVE-2017-9682 | Billy Lau of Android Security |
| CVE-2017-0739 | Dacheng Shao, Hongli Han ([@HexB1n](https://twitter.com/HexB1n)), Mingjian Zhou ([@Mingjian\_Zhou](https://twitter.com/Mingjian_Zhou)), and Xuxian Jiang of [C0RE Team](http://c0reteam.org) |
| CVE-2017-9691, CVE-2017-0744 | Gengjia Chen ([@chengjia4574](https://twitter.com/chengjia4574)) and [pjf](http://weibo.com/jfpan) of IceSword Lab, Qihoo 360 Technology Co. Ltd. |
| CVE-2017-0727 | Guang Gong (龚广) ([@oldfresher](https://twitter.com/oldfresher)) of Alpha Team, Qihoo 360 Technology Co. Ltd. |
| CVE-2017-0737 | Hanxiang Wen, Mingjian Zhou ([@Mingjian\_Zhou](https://twitter.com/Mingjian_Zhou)), and Xuxian Jiang of [C0RE Team](http://c0reteam.org) |
| CVE-2017-0748 | Hao Chen and Guang Gong of Alpha Team of Qihoo 360 Technology Co. Ltd. |
| CVE-2017-0731 | Hongli Han ([@HexB1n](https://twitter.com/HexB1n)), Mingjian Zhou ([@Mingjian\_Zhou](https://twitter.com/Mingjian_Zhou)), and Xuxian Jiang of [C0RE Team](http://c0reteam.org) |
| CVE-2017-9679 | Nathan Crandall ([@natecray](https://twitter.com/natecray)) of Tesla's Product Security Team |
| CVE-2017-0726 | Niky1235 ([@jiych\_guru](https://twitter.com/jiych_guru)) |
| CVE-2017-9684, CVE-2017-9694, CVE-2017-9693, CVE-2017-9681, CVE-2017-0738, CVE-2017-0728 | Pengfei Ding (丁鹏飞), Chenfu Bao (包沉浮), and Lenx Wei (韦韬) of Baidu X-Lab (百度安全实验室) |
| CVE-2017-9680, CVE-2017-0740 | Scott Bauer ([@ScottyBauer1](https://twitter.com/ScottyBauer1)) |
| CVE-2017-0724 | Seven Shen ([@lingtongshen](https://twitter.com/lingtongshen)) of TrendMicro |
| CVE-2017-0732, CVE-2017-0805 | Timothy Becker of CSS Inc. |
| CVE-2017-10661 | Tong Lin (segfault5514@gmail.com), Yuan-Tsung Lo (computernik@gmail.com), and Xuxian Jiang of [C0RE Team](http://c0reteam.org) |
| CVE-2017-0712 | Valerio Costamagna ([@vaio\_co](https://twitter.com/vaio_co)) and Marco Bartoli ([@wsxarcher](https://twitter.com/wsxarcher)) |
| CVE-2017-0716 | Vasily Vasiliev |
| CVE-2017-0750, CVE-2017-0713, CVE-2017-0715, CVE-2017-10662CVE-2017-10663 | V.E.O ([@VYSEa](https://twitter.com/vysea)) of [Mobile Threat Response Team](http://blog.trendmicro.com/trendlabs-security-intelligence/category/mobile/), [Trend Micro](http://www.trendmicro.com) |
| CVE-2017-9678 | Yan Zhou of Eagleye team, SCC, Huawei |
| CVE-2017-0749, CVE-2017-0746 | Yonggang Guo ([@guoygang](https://twitter.com/guoygang)) of IceSword Lab, Qihoo 360 Technology Co. Ltd. |
| CVE-2017-0729 | Yongke Wang of [Tencent's Xuanwu Lab](http://xlab.tencent.com) |
| CVE-2017-0714, CVE-2017-0719, CVE-2017-0718, CVE-2017-0722, CVE-2017-0725, CVE-2017-0720, CVE-2017-0745 | [Zinuo Han](http://weibo.com/ele7enxxh) of Chengdu Security Response Center, Qihoo 360 Technology Co. Ltd. |

## Common questions and answers

This section answers common questions that may occur after reading this
bulletin.

**1. How do I determine if my device is updated to address these issues?**

To learn how to check a device's security patch level, read the instructions on
the [Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices).

* Security patch levels of 2017-08-01 or later address all issues associated
  with the 2017-08-01 security patch level.
* Security patch levels of 2017-08-05 or later address all issues associated
  with the 2017-08-05 security patch level and all previous patch levels.

Device manufacturers that include these updates should set the patch string
level to:

* [ro.build.version.security\_patch]:[2017-08-01]
* [ro.build.version.security\_patch]:[2017-08-05]

**2. Why does this bulletin have two security patch levels?**

This bulletin has two security patch levels so that Android partners have the
flexibility to fix a subset of vulnerabilities that are similar across all
Android devices more quickly. Android partners are encouraged to fix all issues
in this bulletin and use the latest security patch level.

* Devices that use the August 01, 2017 security patch level must include all
  issues associated with that security patch level, as well as fixes for all
  issues reported in previous security bulletins.
* Devices that use the security patch level of August 05, 2017 or newer must
  include all applicable patches in this (and previous) security
  bulletins.

Partners are encouraged to bundle the fixes for all issues they are addressing
in a single update.

**3. What do the entries in the *Type* column mean?**

Entries in the *Type* column of the vulnerability details table reference
the classification of the security vulnerability.

| Abbreviation | Definition |
| RCE | Remote code execution |
| EoP | Elevation of privilege |
| ID | Information disclosure |
| DoS | Denial of service |
| N/A | Classification not available |

**4. What do the entries in the *References* column mean?**

Entries under the *References* column of the vulnerability details table
may contain a prefix identifying the organization to which the reference value
belongs.

| Prefix | Reference |
| A- | Android bug ID |
| QC- | Qualcomm reference number |
| M- | MediaTek reference number |
| N- | NVIDIA reference number |
| B- | Broadcom reference number |

**5. What does a \* next to the Android bug ID in the *References*
column mean?**

Issues that are not publicly available have a [\*](#asterisk) next to the Android bug ID in
the *References* column. The update for that issue is generally contained
in the latest binary drivers for Nexus devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

## Versions

| Version | Date | Notes |
| 1.0 | August 7, 2017 | Bulletin published. |
| 1.1 | August 8, 2017 | Bulletin revised to include AOSP links and acknowledgements. |
| 1.2 | August 14, 2017 | Bulletin revised to add CVE-2017-0687. |
| 1.2 | August 23, 2017 | Bulletin revised to add CVE-2017-0805. |

Content and code samples on this page are subject to the licenses described in the [Content License](/license). Java and OpenJDK are trademarks or registered trademarks of Oracle and/or its affiliates.

Last updated 2024-08-26 UTC.

[[["Easy to understand","easyToUnderstand","thumb-up"],["Solved my problem","solvedMyProblem","thumb-up"],["Other","otherUp","thumb-up"]],[["Missing the information I need","missingTheInformationINeed","thumb-down"],["Too complicated / too many steps","tooComplicatedTooManySteps","thumb-down"],["Out of date","outOfDate","thumb-down"],["Samples / code issue","samplesCodeIssue","thumb-down"],["Other","otherDown","thumb-down"]],["Last updated 2024-08-26 UTC."],[],[]]

* ### Build

  + [Android repository](//android.googlesource.com)
  + [Requirements](/source/requirements)
  + [Downloading](/source/downloading)
  + [Preview binaries](//developers.google.com/android/blobs-preview/)
  + [Factory images](//developers.google.com/android/images/)
  + [Driver binaries](//developers.google.com/android/drivers/)
* ### Connect

  + [@Android on Twitter](//twitter.com/Android/)
  + [@AndroidDev on Twitter](//twitter.com/AndroidDev/)
  + [Android Blog](//blog.google/products/android/)
  + [Google Security Blog](//security.googleblog.com)
  + [Platform on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-platform/)
  + [Building on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-building/)
  + [Porting on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-porting/)
* ### Get help

  + [Android Help Center](//support.google.com/android/)
  + [Pixel Help Center](//support.google.com/pixelphone/)
  + [www.android.com](//www.android.com)
  + [Google Mobile Services](//www.android.com/gms/)
  + [Stack Overflow](//stackoverflow.com/questions/tagged/android-source/)
  + [Issue Tracker](//issuetracker.google.com/issues?q=status:open%20componentid:190923)

* [About Android](/source/)
* [Community](/source/community)
* [Legal](/legal)
* [License](/license)
* [Privacy](//policies.google.com/privacy)
* [Site feedback](//issuetracker.google.com/issues/new?component=191476)
* Manage cookies

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어



=== Content from twitter.com_f623a5ac_20250126_121319.html ===



=== Content from access.redhat.com_b9970354_20250126_121316.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from git.kernel.org_6f8bcd00_20250125_215039.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jin Qian <jinqian@google.com> | 2017-05-15 10:45:08 -0700 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2017-05-16 13:29:39 -0700 |
| commit | [15d3042a937c13f5d9244241c7a9c8416ff6e82a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)) | |
| tree | [6846c1ef913a8c518a0728032f5ad75749e28b21](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a) | |
| parent | [2d3e4866dea96b0506395b47bfefb234f2088dac](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2d3e4866dea96b0506395b47bfefb234f2088dac) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a&id2=2d3e4866dea96b0506395b47bfefb234f2088dac)) | |
| download | [linux-15d3042a937c13f5d9244241c7a9c8416ff6e82a.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-15d3042a937c13f5d9244241c7a9c8416ff6e82a.tar.gz) | |

f2fs: sanity check checkpoint segno and blkoffMake sure segno and blkoff read from raw image are valid.
Cc: stable@vger.kernel.org
Signed-off-by: Jin Qian <jinqian@google.com>
[Jaegeuk Kim: adjust minor coding style]
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)

| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/f2fs/super.c?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 0 deletions

| diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 83355ec4a92cde..397b1e816b3696 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/f2fs/super.c?id=2d3e4866dea96b0506395b47bfefb234f2088dac)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/f2fs/super.c?id=15d3042a937c13f5d9244241c7a9c8416ff6e82a)@@ -1521,6 +1521,8 @@ int sanity\_check\_ckpt(struct f2fs\_sb\_info \*sbi) struct f2fs\_super\_block \*raw\_super = F2FS\_RAW\_SUPER(sbi); struct f2fs\_checkpoint \*ckpt = F2FS\_CKPT(sbi); unsigned int ovp\_segments, reserved\_segments;+ unsigned int main\_segs, blocks\_per\_seg;+ int i;  total = le32\_to\_cpu(raw\_super->segment\_count); fsmeta = le32\_to\_cpu(raw\_super->segment\_count\_ckpt);@@ -1542,6 +1544,20 @@ int sanity\_check\_ckpt(struct f2fs\_sb\_info \*sbi) return 1; } + main\_segs = le32\_to\_cpu(raw\_super->segment\_count\_main);+ blocks\_per\_seg = sbi->blocks\_per\_seg;++ for (i = 0; i < NR\_CURSEG\_NODE\_TYPE; i++) {+ if (le32\_to\_cpu(ckpt->cur\_node\_segno[i]) >= main\_segs ||+ le16\_to\_cpu(ckpt->cur\_node\_blkoff[i]) >= blocks\_per\_seg)+ return 1;+ }+ for (i = 0; i < NR\_CURSEG\_DATA\_TYPE; i++) {+ if (le32\_to\_cpu(ckpt->cur\_data\_segno[i]) >= main\_segs ||+ le16\_to\_cpu(ckpt->cur\_data\_blkoff[i]) >= blocks\_per\_seg)+ return 1;+ }+ if (unlikely(f2fs\_cp\_error(sbi))) { f2fs\_msg(sbi->sb, KERN\_ERR, "A bug case: need to run fsck"); return 1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 21:49:16 +0000


