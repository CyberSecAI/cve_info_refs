=== Content from www.openwall.com_b6a8d31d_20250125_132431.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](5) [[<thread-prev]](../../../2015/02/07/10) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20150208203431.070556C0041@smtpvmsrv1.mitre.org>
Date: Sun,  8 Feb 2015 15:34:31 -0500 (EST)
From: cve-assign@...re.org
To: kseifried@...hat.com
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: kernel: v4l: videobuf: hotfix a bug on multiple calls to mmap() - Linux kernel

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

> <https://bugzilla.redhat.com/show_bug.cgi?id=620629>
>
> not sure if this ever got a cve (or needs one, depends on device perms)

> <http://linuxtv.org/irc/v4l/index.php?date=2010-07-29>
>
> [12:15] <posciak> I see there is no limit on count in v4l2_ext_ctrls
> structure... This has a direct influence on kernel memory allocation
> in do_ioctl2, i.e. userspace could pass big numbers and have kernel
> allocate huge amounts of memory... but since kmalloc won't allocate
> more than a couple of kilobytes, I guess there is not much of a
> problem problem here... just mentioning :)
>
> [12:24] <posciak> I guess introducing a VIDEO_MAX_EXT_CTRLS_SIZE or
> something like that would help, as you mentioned
>
> [12:53] <hverkuil> I thought that that patch was merged. I guess not,
> I'll see if I can make it part of my controller fw patch series. Some
> sort of sanity check there would be welcome.

Use CVE-2010-5321 for the
<https://bugzilla.redhat.com/show_bug.cgi?id=620629#c0> "calling mmap
enough times for the same buffer (offset) resulted in a new memory
allocation by videobuf on each such call and losing the old
allocation, resulting in a leak each time and the system running out
of memory" issue.

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.14 (SunOS)

iQEcBAEBAgAGBQJU18d3AAoJEKllVAevmvms9B4IAKSnHhGpXLNE4kiGhTqj0kdl
n5w6ARNyZJxAEv2FAdtjY79F9E/HakvMNqfx2+VowUEPi1T5G+6xWGYjpe/i7L88
ItCgc/q0nzb1zpUz0jckyrKFmbgtG2I424lGbrIzC74Yx0eGgUtKfz8ERtb+A5wu
wS6Fo+tlmdyK0QUn+h6lopisOY8SgaTbWwuAigUa7iOTSBn+8s/qyuBs47Um7FXy
sV+LJ23fm7YKSQ+2zDDvpPP4rq9LOwXlTN7Ka+MBJ4RHR4fUjeRV+t08wRRbddh8
gYaEAh0RLaiuKMSSm0nV25ZZSWy+A6qY1mcMMmeNWB2NUoaAP9ryEOZkWJym/ZM=
=Rvy1
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_cfefa249_20250125_132433.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffc0a80798576f80ca10b3f6c9c7097f12fd1d64e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffc0a80798576f80ca10b3f6c9c7097f12fd1d64e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[media] v4l: Share code between video\_usercopy and video\_ioctl2

[Browse files](/torvalds/linux/tree/fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)
Browse the repository at this point in the history

```
The two functions are mostly identical. They handle the copy_from_user
and copy_to_user operations related with V4L2 ioctls and call the real
ioctl handler.

Create a __video_usercopy function that implements the core of
video_usercopy and video_ioctl2, and call that function from both.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Hans Verkuil <hverkuil@xs4all.nl>
Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>
```

* Loading branch information

[![@pinchartl](https://avatars.githubusercontent.com/u/281889?s=40&v=4)](/pinchartl)

[pinchartl](/torvalds/linux/commits?author=pinchartl "View all commits by pinchartl")
authored and
Mauro Carvalho Chehab
committed
Mar 21, 2011

1 parent
[9f00eda](/torvalds/linux/commit/9f00edaef8a8741a2d5333676fe9aa23a2a3d2be)

commit fc0a807

Showing
**1 changed file**
with
**11 additions**
and
**98 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

109 changes: 11 additions & 98 deletions

109
[drivers/media/video/v4l2-ioctl.c](#diff-d1836e641286175ab29eb7d6335956901863f505655f378e455b45a531a44e1a "drivers/media/video/v4l2-ioctl.c")

Show comments

[View file](/torvalds/linux/blob/fc0a80798576f80ca10b3f6c9c7097f12fd1d64e/drivers/media/video/v4l2-ioctl.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -294,101 +294,6 @@ void v4l\_printk\_ioctl(unsigned int cmd) |
|  |  | } |
|  |  | EXPORT\_SYMBOL(v4l\_printk\_ioctl); |
|  |  |  |
|  |  | /\* |
|  |  | \* helper function -- handles userspace copying for ioctl arguments |
|  |  | \* Obsolete usercopy function - Should be removed soon |
|  |  | \*/ |
|  |  | long |
|  |  | video\_usercopy(struct file \*file, unsigned int cmd, unsigned long arg, |
|  |  | v4l2\_kioctl func) |
|  |  | { |
|  |  | char sbuf[128]; |
|  |  | void \*mbuf = NULL; |
|  |  | void \*parg = NULL; |
|  |  | long err = -EINVAL; |
|  |  | int is\_ext\_ctrl; |
|  |  | size\_t ctrls\_size = 0; |
|  |  | void \_\_user \*user\_ptr = NULL; |
|  |  |  |
|  |  | is\_ext\_ctrl = (cmd == VIDIOC\_S\_EXT\_CTRLS || cmd == VIDIOC\_G\_EXT\_CTRLS || |
|  |  | cmd == VIDIOC\_TRY\_EXT\_CTRLS); |
|  |  |  |
|  |  | /\* Copy arguments into temp kernel buffer \*/ |
|  |  | switch (\_IOC\_DIR(cmd)) { |
|  |  | case \_IOC\_NONE: |
|  |  | parg = NULL; |
|  |  | break; |
|  |  | case \_IOC\_READ: |
|  |  | case \_IOC\_WRITE: |
|  |  | case (\_IOC\_WRITE | \_IOC\_READ): |
|  |  | if (\_IOC\_SIZE(cmd) <= sizeof(sbuf)) { |
|  |  | parg = sbuf; |
|  |  | } else { |
|  |  | /\* too big to allocate from stack \*/ |
|  |  | mbuf = kmalloc(\_IOC\_SIZE(cmd), GFP\_KERNEL); |
|  |  | if (NULL == mbuf) |
|  |  | return -ENOMEM; |
|  |  | parg = mbuf; |
|  |  | } |
|  |  |  |
|  |  | err = -EFAULT; |
|  |  | if (\_IOC\_DIR(cmd) & \_IOC\_WRITE) |
|  |  | if (copy\_from\_user(parg, (void \_\_user \*)arg, \_IOC\_SIZE(cmd))) |
|  |  | goto out; |
|  |  | break; |
|  |  | } |
|  |  | if (is\_ext\_ctrl) { |
|  |  | struct v4l2\_ext\_controls \*p = parg; |
|  |  |  |
|  |  | /\* In case of an error, tell the caller that it wasn't |
|  |  | a specific control that caused it. \*/ |
|  |  | p->error\_idx = p->count; |
|  |  | user\_ptr = (void \_\_user \*)p->controls; |
|  |  | if (p->count) { |
|  |  | ctrls\_size = sizeof(struct v4l2\_ext\_control) \* p->count; |
|  |  | /\* Note: v4l2\_ext\_controls fits in sbuf[] so mbuf is still NULL. \*/ |
|  |  | mbuf = kmalloc(ctrls\_size, GFP\_KERNEL); |
|  |  | err = -ENOMEM; |
|  |  | if (NULL == mbuf) |
|  |  | goto out\_ext\_ctrl; |
|  |  | err = -EFAULT; |
|  |  | if (copy\_from\_user(mbuf, user\_ptr, ctrls\_size)) |
|  |  | goto out\_ext\_ctrl; |
|  |  | p->controls = mbuf; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\* call driver \*/ |
|  |  | err = func(file, cmd, parg); |
|  |  | if (err == -ENOIOCTLCMD) |
|  |  | err = -EINVAL; |
|  |  | if (is\_ext\_ctrl) { |
|  |  | struct v4l2\_ext\_controls \*p = parg; |
|  |  |  |
|  |  | p->controls = (void \*)user\_ptr; |
|  |  | if (p->count && err == 0 && copy\_to\_user(user\_ptr, mbuf, ctrls\_size)) |
|  |  | err = -EFAULT; |
|  |  | goto out\_ext\_ctrl; |
|  |  | } |
|  |  | if (err < 0) |
|  |  | goto out; |
|  |  |  |
|  |  | out\_ext\_ctrl: |
|  |  | /\* Copy results into user buffer \*/ |
|  |  | switch (\_IOC\_DIR(cmd)) { |
|  |  | case \_IOC\_READ: |
|  |  | case (\_IOC\_WRITE | \_IOC\_READ): |
|  |  | if (copy\_to\_user((void \_\_user \*)arg, parg, \_IOC\_SIZE(cmd))) |
|  |  | err = -EFAULT; |
|  |  | break; |
|  |  | } |
|  |  |  |
|  |  | out: |
|  |  | kfree(mbuf); |
|  |  | return err; |
|  |  | } |
|  |  | EXPORT\_SYMBOL(video\_usercopy); |
|  |  |  |
|  |  | static void dbgbuf(unsigned int cmd, struct video\_device \*vfd, |
|  |  | struct v4l2\_buffer \*p) |
|  |  | { |
| Expand Down  Expand Up | | @@ -2332,8 +2237,9 @@ static int check\_array\_args(unsigned int cmd, void \*parg, size\_t \*array\_size, |
|  |  | return ret; |
|  |  | } |
|  |  |  |
|  |  | long video\_ioctl2(struct file \*file, |
|  |  | unsigned int cmd, unsigned long arg) |
|  |  | long |
|  |  | video\_usercopy(struct file \*file, unsigned int cmd, unsigned long arg, |
|  |  | v4l2\_kioctl func) |
|  |  | { |
|  |  | char sbuf[128]; |
|  |  | void \*mbuf = NULL; |
| Expand Down  Expand Up | | @@ -2395,7 +2301,7 @@ long video\_ioctl2(struct file \*file, |
|  |  | } |
|  |  |  |
|  |  | /\* Handles IOCTL \*/ |
|  |  | err = \_\_video\_do\_ioctl(file, cmd, parg); |
|  |  | err = func(file, cmd, parg); |
|  |  | if (err == -ENOIOCTLCMD) |
|  |  | err = -EINVAL; |
|  |  |  |
| Expand All | | @@ -2422,4 +2328,11 @@ long video\_ioctl2(struct file \*file, |
|  |  | kfree(mbuf); |
|  |  | return err; |
|  |  | } |
|  |  | EXPORT\_SYMBOL(video\_usercopy); |
|  |  |  |
|  |  | long video\_ioctl2(struct file \*file, |
|  |  | unsigned int cmd, unsigned long arg) |
|  |  | { |
|  |  | return video\_usercopy(file, cmd, arg, \_\_video\_do\_ioctl); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(video\_ioctl2); |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `fc0a807`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffc0a80798576f80ca10b3f6c9c7097f12fd1d64e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from git.kernel.org_65006d28_20250125_132431.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Laurent Pinchart <laurent.pinchart@ideasonboard.com> | 2010-07-12 11:09:41 -0300 |
| --- | --- | --- |
| committer | Mauro Carvalho Chehab <mchehab@redhat.com> | 2011-03-21 20:32:41 -0300 |
| commit | [fc0a80798576f80ca10b3f6c9c7097f12fd1d64e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)) | |
| tree | [561546ada442b0fb9df166723d601b1587d3f6b0](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e) | |
| parent | [9f00edaef8a8741a2d5333676fe9aa23a2a3d2be](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9f00edaef8a8741a2d5333676fe9aa23a2a3d2be) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e&id2=9f00edaef8a8741a2d5333676fe9aa23a2a3d2be)) | |
| download | [linux-fc0a80798576f80ca10b3f6c9c7097f12fd1d64e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-fc0a80798576f80ca10b3f6c9c7097f12fd1d64e.tar.gz) | |

[media] v4l: Share code between video\_usercopy and video\_ioctl2The two functions are mostly identical. They handle the copy\_from\_user
and copy\_to\_user operations related with V4L2 ioctls and call the real
ioctl handler.
Create a \_\_video\_usercopy function that implements the core of
video\_usercopy and video\_ioctl2, and call that function from both.
Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Hans Verkuil <hverkuil@xs4all.nl>
Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)

| -rw-r--r-- | [drivers/media/video/v4l2-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/media/video/v4l2-ioctl.c?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e) | 109 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 98 deletions

| diff --git a/drivers/media/video/v4l2-ioctl.c b/drivers/media/video/v4l2-ioctl.cindex 7a720745c3fad1..db6ec3868347b2 100644--- a/[drivers/media/video/v4l2-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/video/v4l2-ioctl.c?id=9f00edaef8a8741a2d5333676fe9aa23a2a3d2be)+++ b/[drivers/media/video/v4l2-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/video/v4l2-ioctl.c?id=fc0a80798576f80ca10b3f6c9c7097f12fd1d64e)@@ -294,101 +294,6 @@ void v4l\_printk\_ioctl(unsigned int cmd) } EXPORT\_SYMBOL(v4l\_printk\_ioctl); -/\*- \* helper function -- handles userspace copying for ioctl arguments- \* Obsolete usercopy function - Should be removed soon- \*/-long-video\_usercopy(struct file \*file, unsigned int cmd, unsigned long arg,- v4l2\_kioctl func)-{- char sbuf[128];- void \*mbuf = NULL;- void \*parg = NULL;- long err = -EINVAL;- int is\_ext\_ctrl;- size\_t ctrls\_size = 0;- void \_\_user \*user\_ptr = NULL;-- is\_ext\_ctrl = (cmd == VIDIOC\_S\_EXT\_CTRLS || cmd == VIDIOC\_G\_EXT\_CTRLS ||- cmd == VIDIOC\_TRY\_EXT\_CTRLS);-- /\* Copy arguments into temp kernel buffer \*/- switch (\_IOC\_DIR(cmd)) {- case \_IOC\_NONE:- parg = NULL;- break;- case \_IOC\_READ:- case \_IOC\_WRITE:- case (\_IOC\_WRITE | \_IOC\_READ):- if (\_IOC\_SIZE(cmd) <= sizeof(sbuf)) {- parg = sbuf;- } else {- /\* too big to allocate from stack \*/- mbuf = kmalloc(\_IOC\_SIZE(cmd), GFP\_KERNEL);- if (NULL == mbuf)- return -ENOMEM;- parg = mbuf;- }-- err = -EFAULT;- if (\_IOC\_DIR(cmd) & \_IOC\_WRITE)- if (copy\_from\_user(parg, (void \_\_user \*)arg, \_IOC\_SIZE(cmd)))- goto out;- break;- }- if (is\_ext\_ctrl) {- struct v4l2\_ext\_controls \*p = parg;-- /\* In case of an error, tell the caller that it wasn't- a specific control that caused it. \*/- p->error\_idx = p->count;- user\_ptr = (void \_\_user \*)p->controls;- if (p->count) {- ctrls\_size = sizeof(struct v4l2\_ext\_control) \* p->count;- /\* Note: v4l2\_ext\_controls fits in sbuf[] so mbuf is still NULL. \*/- mbuf = kmalloc(ctrls\_size, GFP\_KERNEL);- err = -ENOMEM;- if (NULL == mbuf)- goto out\_ext\_ctrl;- err = -EFAULT;- if (copy\_from\_user(mbuf, user\_ptr, ctrls\_size))- goto out\_ext\_ctrl;- p->controls = mbuf;- }- }-- /\* call driver \*/- err = func(file, cmd, parg);- if (err == -ENOIOCTLCMD)- err = -EINVAL;- if (is\_ext\_ctrl) {- struct v4l2\_ext\_controls \*p = parg;-- p->controls = (void \*)user\_ptr;- if (p->count && err == 0 && copy\_to\_user(user\_ptr, mbuf, ctrls\_size))- err = -EFAULT;- goto out\_ext\_ctrl;- }- if (err < 0)- goto out;--out\_ext\_ctrl:- /\* Copy results into user buffer \*/- switch (\_IOC\_DIR(cmd)) {- case \_IOC\_READ:- case (\_IOC\_WRITE | \_IOC\_READ):- if (copy\_to\_user((void \_\_user \*)arg, parg, \_IOC\_SIZE(cmd)))- err = -EFAULT;- break;- }--out:- kfree(mbuf);- return err;-}-EXPORT\_SYMBOL(video\_usercopy);- static void dbgbuf(unsigned int cmd, struct video\_device \*vfd, struct v4l2\_buffer \*p) {@@ -2332,8 +2237,9 @@ static int check\_array\_args(unsigned int cmd, void \*parg, size\_t \*array\_size, return ret; } -long video\_ioctl2(struct file \*file,- unsigned int cmd, unsigned long arg)+long+video\_usercopy(struct file \*file, unsigned int cmd, unsigned long arg,+ v4l2\_kioctl func) { char sbuf[128]; void \*mbuf = NULL;@@ -2395,7 +2301,7 @@ long video\_ioctl2(struct file \*file, }  /\* Handles IOCTL \*/- err = \_\_video\_do\_ioctl(file, cmd, parg);+ err = func(file, cmd, parg); if (err == -ENOIOCTLCMD) err = -EINVAL; @@ -2422,4 +2328,11 @@ out: kfree(mbuf); return err; }+EXPORT\_SYMBOL(video\_usercopy);++long video\_ioctl2(struct file \*file,+ unsigned int cmd, unsigned long arg)+{+ return video\_usercopy(file, cmd, arg, \_\_video\_do\_ioctl);+} EXPORT\_SYMBOL(video\_ioctl2); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 13:23:08 +0000


