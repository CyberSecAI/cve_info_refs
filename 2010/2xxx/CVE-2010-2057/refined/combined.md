=== Content from bugzilla.redhat.com_86d0a1cb_20250125_193346.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D623799)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D623799)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D623799)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 623799

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 623799**](show_bug.cgi?id=623799)
(CVE-2010-2057)
- [CVE-2010-2057](https://access.redhat.com/security/cve/CVE-2010-2057) Apache MyFaces: encrypted view state does not include MAC

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2010-2057 Apache MyFaces: encrypted view state does not include MAC

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED NOTABUG | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2010-2057 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | | TreeView+ | [depends on](buglist.cgi?bug_id=623799&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=623799&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2010-08-12 19:28 UTC by Vincent Danen | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-02-24 22:38 UTC ([History](show_activity.cgi?id=623799)) | | [CC List:](page.cgi?id=fields.html#cclist) | 3 users (show)  djorm fnasser pcheung | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2011-06-27 02:14:54 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=623799#c0)  Vincent Danen    2010-08-12 19:28:26 UTC  ``` Quoting the upstream bug report [1]:  Both myfaces and mojarra only encrypt the state. What is missing is add a message authentication code (MAC) to the encryption to prevent padding oracle attack. The objective is detect if the received view state has been modified and do not process it, throwing ViewExpiredException.  The problem can be solved if users change to server side state saving, because on the view state only a identifier is sent and no changes on the component tree could be done with this configuration.  The proposed solution was add this new web-config params:  org.apache.myfaces.MAC_ALGORITHM : Indicate the algorithm used to calculate the Message Authentication Code that is added to the view state.  org.apache.myfaces.MAC_SECRET : Define the initialization code that are used to initialize the secret key used on the Message Authentication Code algorithm.  org.apache.myfaces.MAC_SECRET.CACHE : If is set to "false", the secret key used for MAC algorithm is not cached. This is used when the returned SecretKey for mac algorithm is not thread safe.  It was unified security configuration in all branches to works the same. That means, it was included in 1.1.x the property org.apache.myfaces.USE_ENCRYPTION.  Now, if an error occur when the state is encrypted/decrypted, a ViewExpiredException is thrown, but the real exception is logged, to hide information that could be useful to non developers.   This was corrected upstream in versions 1.1.8, 1.2.9, and 2.0.1.  It has also been assigned the name [CVE-2010-2057](https://access.redhat.com/security/cve/CVE-2010-2057).  [1] <https://issues.apache.org/jira/browse/MYFACES-2749>  I believe the following is the commit that corrects this flaw, but will need to be verified:  <http://svn.apache.org/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?r1=943327&r2=951801>   ```  [Comment 1](show_bug.cgi?id=623799#c1)  Vincent Danen    2011-04-21 17:35:40 UTC  ``` I'm looking at myfaces-1.1.0 which we have in JBEWS and I don't think we are affected by this.  The only support that StateUtils.java has is for base64-encoding, there are no other encryption-related functionality in this file.  Seems like all of the encryption-related functionality was implemented in the revision _after_ what we have:  <http://svn.apache.org/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?r1=239625&r2=328309>  So this should not affect us.  Can someone confirm?   ```  [Comment 2](show_bug.cgi?id=623799#c2)  Vincent Danen    2011-04-21 17:39:28 UTC  ``` As a followup, there is another issue that was subsequently fixed:  <https://issues.apache.org/jira/browse/MYFACES-2934> (Side-channel timing attack in StateUtils class may still allow padding oracle attack) <http://svn.apache.org/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?r1=951801&r2=1003345>   ```  [Comment 4](show_bug.cgi?id=623799#c4)  David Jorm    2011-06-27 02:14:54 UTC  ``` Statement:  Not vulnerable. This issue did not affect the versions of myfaces as shipped with JBoss Enterprise Web Server.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=623799&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from access.redhat.com_dbeac2cd_20250126_112403.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from issues.apache.org_3a2d94b8_20250126_112402.html ===


[Log in](/jira/login.jsp?os_destination=%2Fbrowse%2FMYFACES-2749)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![ASF JIRA](/jira/s/xd97tr/820010/13pdxe5/_/jira-logo-scaled.png)](https://issues.apache.org/jira/secure/MyJiraHome.jspa)

* [Dashboards](/jira/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/jira/browse/MYFACES "View recent projects and browse a list of projects")
* [Issues](/jira/issues/ "Search for issues and view recent issues")

* [Help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/jira/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/jira/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/jira/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/jira/login.jsp?os_destination=%2Fbrowse%2FMYFACES-2749)

Public signup for this instance is **disabled**. Go to our [Self serve sign up page](https://selfserve.apache.org/jira-account.html) to request an account. Report potential security issues [privately](https://apache.org/security/#reporting-a-vulnerability)

![Uploaded image for project: 'MyFaces Core'](https://issues.apache.org/jira/secure/projectavatar?pid=10600&avatarId=10079)

1. [MyFaces Core](/jira/browse/MYFACES)
2. [MYFACES-2749](/jira/browse/MYFACES-2749)

# Encrypted View State does not include Message Authentication Code (MAC)

[Log In](/jira/login.jsp?os_destination=%2Fbrowse%2FMYFACES-2749 "Log In")Export

XMLWordPrintableJSON
#### Details

* **Type:**
  ![](/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Status:**
  Closed
* **Priority:**
  ![](/jira/images/icons/priorities/major.svg "Major - Major loss of function.") Major
* **Resolution:**
  Fixed
* **Affects Version/s:**
  1.1.7, 1.2.8, 2.0.0
* **Fix Version/s:**
  [1.1.8](/jira/issues/?jql=project+%3D+MYFACES+AND+fixVersion+%3D+1.1.8 "1.1.8 "), [1.2.9](/jira/issues/?jql=project+%3D+MYFACES+AND+fixVersion+%3D+1.2.9 "1.2.9 "), [2.0.1](/jira/issues/?jql=project+%3D+MYFACES+AND+fixVersion+%3D+2.0.1 "2.0.1 ")
* **Component/s:**
  None
* **Labels:**
  None
#### Description

Both myfaces and mojarra only encrypt the state. What is missing is add a message authentication code (MAC) to the encryption to prevent padding oracle attack. The objective is detect if the received view state has been modified and do not process it, throwing ViewExpiredException.

The problem can be solved if users change to server side state saving, because on the view state only a identifier is sent and no changes on the component tree could be done with this configuration.

The proposed solution was add this new web-config params:

org.apache.myfaces.MAC\_ALGORITHM : Indicate the algorithm used to calculate the Message Authentication Code that is added to the view state.

org.apache.myfaces.MAC\_SECRET : Define the initialization code that are used to initialize the secret key used on the Message Authentication Code algorithm.

org.apache.myfaces.MAC\_SECRET.CACHE : If is set to "false", the secret key used for MAC algorithm is not cached. This is used when the returned SecretKey for mac algorithm is not thread safe.

It was unified security configuration in all branches to works the same. That means, it was included in 1.1.x the property org.apache.myfaces.USE\_ENCRYPTION.

Now, if an error occur when the state is encrypted/decrypted, a ViewExpiredException is thrown, but the real exception is logged, to hide information that could be useful to non developers.

#### Attachments

#### Activity

#### People

Assignee:

![lu4242](https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452)
Leonardo Uribe

Reporter:

![lu4242](https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452)
Leonardo Uribe

Votes:
0
Vote for this issue

Watchers:
0
Start watching this issue

#### Dates

Created:

10/Jun/10 20:48

Updated:

30/Apr/18 14:55

Resolved:

10/Jun/10 20:49

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/jira/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/jira/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for Apache Software Foundation. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from svn.apache.org_a25774d5_20250125_193345.html ===


| **[/](/viewvc?view=roots)[[Apache-SVN]](/viewvc/)/[myfaces](/viewvc/myfaces/)/[shared](/viewvc/myfaces/shared/)/[trunk](/viewvc/myfaces/shared/trunk/)/[core](/viewvc/myfaces/shared/trunk/core/)/[src](/viewvc/myfaces/shared/trunk/core/src/)/[main](/viewvc/myfaces/shared/trunk/core/src/main/)/[java](/viewvc/myfaces/shared/trunk/core/src/main/java/)/[org](/viewvc/myfaces/shared/trunk/core/src/main/java/org/)/[apache](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/)/[myfaces](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/)/[shared](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/)/[util](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/)/[StateUtils.java](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?view=log)** |  |
| --- | --- |

[![ViewVC logotype](/vc-static/images/viewvc-logo.png)](http://www.viewvc.org/ "ViewVC Home")
# Diff of /myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java

[![Parent Directory](/vc-static/images/back_small.png) Parent Directory](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/)
| [![Revision Log](/vc-static/images/log.png) Revision Log](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?view=log)
| [![View Patch](/vc-static/images/diff.png) Patch](/viewvc/myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java?r1=943327&r2=951801&view=patch)

###

```
--- myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java	2010/05/11 23:01:16	943327
+++ myfaces/shared/trunk/core/src/main/java/org/apache/myfaces/shared/util/StateUtils.java	2010/06/06 02:08:58	951801
@@ -25,8 +25,10 @@ import java.io.ObjectInputStream;
 import java.io.ObjectOutputStream;
 import java.io.UnsupportedEncodingException;
 import java.security.AccessController;
+import java.security.NoSuchAlgorithmException;
 import java.security.PrivilegedActionException;
 import java.security.PrivilegedExceptionAction;
+import java.util.Arrays;
 import java.util.Random;
 import java.util.logging.Level;
 import java.util.logging.Logger;
@@ -34,10 +36,13 @@ import java.util.zip.GZIPInputStream;
 import java.util.zip.GZIPOutputStream;

 import javax.crypto.Cipher;
+import javax.crypto.KeyGenerator;
+import javax.crypto.Mac;
 import javax.crypto.SecretKey;
 import javax.crypto.spec.IvParameterSpec;
 import javax.crypto.spec.SecretKeySpec;
 import javax.faces.FacesException;
+import javax.faces.application.ViewExpiredException;
 import javax.faces.context.ExternalContext;
 import javax.servlet.ServletContext;

@@ -46,8 +51,9 @@ import org.apache.myfaces.buildtools.mav
 import org.apache.myfaces.shared.util.serial.SerialFactory;

 /**
- * <p>Handles encryption, serialization, compression and encoding.
- *
+ * <p>This Class exposes a handful of methods related to encryption,
+ * compression and serialization of the view state.</p>
+ *
  * <ul>
  * <li>ISO-8859-1 is the character set used.</li>
  * <li>GZIP is used for all compression/decompression.</li>
@@ -55,6 +61,7 @@ import org.apache.myfaces.shared.util.se
  * <li>DES is the default encryption algorithm</li>
  * <li>ECB is the default mode</li>
  * <li>PKCS5Padding is the default padding</li>
+ * <li>HmacSHA1 is the default MAC algorithm</li>
  * <li>The default algorithm can be overridden using the
  * <i>org.apache.myfaces.ALGORITHM</i> parameter</li>
  * <li>The default mode and padding can be overridden using the
@@ -62,6 +69,8 @@ import org.apache.myfaces.shared.util.se
  * <li>This class has not been tested with modes other than ECB and CBC</li>
  * <li>An initialization vector can be specified via the
  * <i>org.apache.myfaces.ALGORITHM.IV</i> parameter</li>
+ * <li>The default MAC algorithm can be overridden using the
+ * <i>org.apache.myfaces.MAC_ALGORITHM</i> parameter</li>
  * </ul>
  *
  * <p>The secret is interpretted as base 64 encoded.  In other
@@ -80,7 +89,6 @@ import org.apache.myfaces.shared.util.se
  * @author Dennis C. Byrne
  * @see org.apache.myfaces.webapp.StartupServletContextListener
  */
-
 public final class StateUtils {

     //private static final Log log = LogFactory.getLog(StateUtils.class);
@@ -93,34 +101,82 @@ public final class StateUtils {

     public static final String INIT_PREFIX = "org.apache.myfaces.";

-    @JSFWebConfigParam(name="org.apache.myfaces.USE_ENCRYPTION",since="1.1")
+    /**
+     * Indicate if the view state is encrypted or not. By default, encryption is enabled.
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.USE_ENCRYPTION",since="1.1",defaultValue="true",expectedValues="true,false")
     public static final String USE_ENCRYPTION = INIT_PREFIX + "USE_ENCRYPTION";

     /**
-     * Used for encrypting view state. Only relevant for client side
-     * state saving. See MyFaces wiki/web site documentation for instructions
-     * on how to configure an application for different encryption strengths.
+     * Defines the secret (Base64 encoded) used to initialize the secret key
+     * for encryption algorithm. See MyFaces wiki/web site documentation
+     * for instructions on how to configure an application for
+     * different encryption strengths.
      */
     @JSFWebConfigParam(name="org.apache.myfaces.SECRET",since="1.1")
     public static final String INIT_SECRET = INIT_PREFIX + "SECRET";

-    @JSFWebConfigParam(name="org.apache.myfaces.ALGORITHM",since="1.1")
+    /**
+     * Indicate the encryption algorithm used for encrypt the view state.
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.ALGORITHM",since="1.1",defaultValue="DES")
     public static final String INIT_ALGORITHM = INIT_PREFIX + "ALGORITHM";
-
+
+    /**
+     * If is set to "false", the secret key used for encryption algorithm is not cached. This is used
+     * when the returned SecretKey for encryption algorithm is not thread safe.
+     */
     @JSFWebConfigParam(name="org.apache.myfaces.SECRET.CACHE",since="1.1")
     public static final String INIT_SECRET_KEY_CACHE = INIT_SECRET + ".CACHE";

+    /**
+     * Defines the initialization vector (Base64 encoded) used for the encryption algorithm
+     */
     @JSFWebConfigParam(name="org.apache.myfaces.ALGORITHM.IV",since="1.1")
     public static final String INIT_ALGORITHM_IV = INIT_ALGORITHM + ".IV";

-    @JSFWebConfigParam(name="org.apache.myfaces.ALGORITHM.PARAMETERS",since="1.1")
+    /**
+     * Defines the default mode and padding used for the encryption algorithm
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.ALGORITHM.PARAMETERS",since="1.1",defaultValue="ECB/PKCS5Padding")
     public static final String INIT_ALGORITHM_PARAM = INIT_ALGORITHM + ".PARAMETERS";

+    /**
+     * Defines the factory class name using for serialize/deserialize the view state returned
+     * by state manager into a byte array. The expected class must implement
+     * org.apache.myfaces.shared.util.serial.SerialFactory interface.
+     */
     @JSFWebConfigParam(name="org.apache.myfaces.SERIAL_FACTORY", since="1.1")
     public static final String SERIAL_FACTORY = INIT_PREFIX + "SERIAL_FACTORY";

-    @JSFWebConfigParam(name="org.apache.myfaces.COMPRESS_STATE_IN_CLIENT",since="1.1")
-    private static final String COMPRESS_STATE_IN_CLIENT = INIT_PREFIX + "COMPRESS_STATE_IN_CLIENT";
+    /**
+     * Indicate if the view state should be compressed before encrypted(optional) and encoded
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.COMPRESS_STATE_IN_CLIENT",since="1.1",defaultValue="false",expectedValues="true,false")
+    public static final String COMPRESS_STATE_IN_CLIENT = INIT_PREFIX + "COMPRESS_STATE_IN_CLIENT";
+
+    public static final String DEFAULT_MAC_ALGORITHM = "HmacSHA1";
+
+    /**
+     * Indicate the algorithm used to calculate the Message Authentication Code that is
+     * added to the view state.
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.MAC_ALGORITHM",defaultValue="HmacSHA1")
+    public static final String INIT_MAC_ALGORITHM = "org.apache.myfaces.MAC_ALGORITHM";
+
+    /**
+     * Define the initialization code that are used to initialize the secret key used
+     * on the Message Authentication Code algorithm
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.MAC_SECRET")
+    public static final String INIT_MAC_SECRET = "org.apache.myfaces.MAC_SECRET";
+
+    /**
+     * If is set to "false", the secret key used for MAC algorithm is not cached. This is used
+     * when the returned SecretKey for mac algorithm is not thread safe.
+     */
+    @JSFWebConfigParam(name="org.apache.myfaces.MAC_SECRET.CACHE")
+    public static final String INIT_MAC_SECRET_KEY_CACHE = "org.apache.myfaces.MAC_SECRET.CACHE";

     /** Utility class, do not instatiate */
     private StateUtils()
@@ -131,8 +187,18 @@ public final class StateUtils {
     private static void testConfiguration(ExternalContext ctx){

         String algorithmParams = ctx.getInitParameter(INIT_ALGORITHM_PARAM);
+
+        if (algorithmParams == null)
+        {
+            algorithmParams = ctx.getInitParameter(INIT_ALGORITHM_PARAM.toLowerCase());
+        }
         String iv = ctx.getInitParameter(INIT_ALGORITHM_IV);

+        if (iv == null)
+        {
+            iv = ctx.getInitParameter(INIT_ALGORITHM_IV.toLowerCase());
+        }
+
         if (algorithmParams != null && algorithmParams.startsWith("CBC") )
         {
             if(iv == null)
@@ -141,7 +207,7 @@ public final class StateUtils {
                                     " but no initialization vector has been set " +
                                     " with " + INIT_ALGORITHM_IV);
         }
-
+
     }

     public static boolean enableCompression(ExternalContext ctx)
@@ -220,7 +286,53 @@ public final class StateUtils {

     public static byte[] encrypt(byte[] insecure, ExternalContext ctx)
     {
-        return symmetric(insecure, ctx, Cipher.ENCRYPT_MODE);
+
+        if (ctx == null)
+            throw new NullPointerException("ExternalContext ctx");
+
+        testConfiguration(ctx);
+
+        SecretKey secretKey = (SecretKey) getSecret(ctx);
+        String algorithm = findAlgorithm(ctx);
+        String algorithmParams = findAlgorithmParams(ctx);
+        byte[] iv = findInitializationVector(ctx);
+
+        SecretKey macSecretKey = (SecretKey) getMacSecret(ctx);
+        String macAlgorithm = findMacAlgorithm(ctx);
+
+        try
+        {
+            // keep local to avoid threading issue
+            Mac mac = Mac.getInstance(macAlgorithm);
+            mac.init(macSecretKey);
+            Cipher cipher = Cipher.getInstance(algorithm + "/" + algorithmParams);
+            if (iv != null)
+            {
+                IvParameterSpec ivSpec = new IvParameterSpec(iv);
+                cipher.init(Cipher.ENCRYPT_MODE, secretKey, ivSpec);
+            }
+            else
+            {
+                cipher.init(Cipher.ENCRYPT_MODE, secretKey);
+            }
+            if (log.isLoggable(Level.FINE))
+            {
+                log.fine("encrypting w/ " + algorithm + "/" + algorithmParams);
+            }
+
+            //EtM Composition Approach
+            int macLenght = mac.getMacLength();
+            byte[] secure = new byte[cipher.getOutputSize(insecure.length)+ macLenght];
+            int secureCount = cipher.doFinal(insecure,0,insecure.length,secure);
+            mac.update(secure, 0, secureCount);
+            mac.doFinal(secure, secureCount);
+
+            return secure;
+        }
+        catch (Exception e)
+        {
+            throw new FacesException(e);
+        }
     }

     public static final byte[] compress(byte[] bytes)
@@ -252,11 +364,14 @@ public final class StateUtils {
     /**
      * This fires during the Restore View phase, restoring state.
      */
-
-    public static final Object reconstruct(String string, ExternalContext ctx){
+    public static final Object reconstruct(String string, ExternalContext ctx)
+    {
         byte[] bytes;
         try
         {
+            if(log.isLoggable(Level.FINE))
+                log.fine("Processing state : "+string);
+
             bytes = string.getBytes(ZIP_CHARSET);
             bytes = decode(bytes);
             if(isSecure(ctx))
@@ -265,9 +380,13 @@ public final class StateUtils {
                 bytes = decompress(bytes);
             return getAsObject(bytes, ctx);
         }
-        catch (UnsupportedEncodingException e)
+        catch (Throwable e)
         {
-            throw new FacesException(e);
+            if (log.isLoggable(Level.SEVERE))
+            {
+                log.log(Level.SEVERE, "View State cannot be reconstructed", e);
+            }
+            return null;
         }
     }

@@ -311,7 +430,65 @@ public final class StateUtils {

     public static byte[] decrypt(byte[] secure, ExternalContext ctx)
     {
-        return symmetric(secure, ctx, Cipher.DECRYPT_MODE);
+        if (ctx == null)
+            throw new NullPointerException("ExternalContext ctx");
+
+        testConfiguration(ctx);
+
+        SecretKey secretKey = (SecretKey) getSecret(ctx);
+        String algorithm = findAlgorithm(ctx);
+        String algorithmParams = findAlgorithmParams(ctx);
+        byte[] iv = findInitializationVector(ctx);
+
+        SecretKey macSecretKey = (SecretKey) getMacSecret(ctx);
+        String macAlgorithm = findMacAlgorithm(ctx);
+
+        try
+        {
+            // keep local to avoid threading issue
+            Mac mac = Mac.getInstance(macAlgorithm);
+            mac.init(macSecretKey);
+            Cipher cipher = Cipher.getInstance(algorithm + "/"
+                    + algorithmParams);
+            if (iv != null)
+            {
+                IvParameterSpec ivSpec = new IvParameterSpec(iv);
+                cipher.init(Cipher.DECRYPT_MODE, secretKey, ivSpec);
+            }
+            else
+            {
+                cipher.init(Cipher.DECRYPT_MODE, secretKey);
+            }
+            if (log.isLoggable(Level.FINE))
+            {
+                log.fine("decrypting w/ " + algorithm + "/" + algorithmParams);
+            }
+
+            //EtM Composition Approach
+            int macLenght = mac.getMacLength();
+            mac.update(secure, 0, secure.length-macLenght);
+            byte[] signedDigestHash = mac.doFinal();
+
+            boolean isMacEqual = true;
+            for (int i = 0; i < signedDigestHash.length; i++)
+            {
+                if (signedDigestHash[i] != secure[secure.length-macLenght+i])
+                {
+                    isMacEqual = false;
+                    break;
+                }
+            }
+            if (!isMacEqual)
+            {
+                throw new ViewExpiredException();
+            }
+
+            return cipher.doFinal(secure, 0, secure.length-macLenght);
+        }
+        catch (Exception e)
+        {
+            throw new FacesException(e);
+        }
     }

     /**
@@ -430,96 +607,27 @@ public final class StateUtils {
     }

     /**
-     * Utility method for generating base 63 encoded strings.
+     * Utility method for generating base 64 encoded strings.
      *
      * @param args
      * @throws UnsupportedEncodingException
      */
-
     public static void main (String[] args) throws UnsupportedEncodingException
     {
         byte[] bytes = encode(args[0].getBytes(ZIP_CHARSET));
           System.out.println(new String(bytes, ZIP_CHARSET));
     }
-
-    private static byte[] symmetric(byte[] data, SecretKey secretKey,
-            String algorithm, String algorithmParams, byte[] iv, int mode){
-
-        try
-        {
-            // keep local to avoid threading issue
-            Cipher cipher = Cipher.getInstance(algorithm + "/"
-                    + algorithmParams);
-            if (iv != null)
-            {
-                IvParameterSpec ivSpec = new IvParameterSpec(iv);
-                cipher.init(mode, secretKey, ivSpec);
-            }
-            else
-            {
-                cipher.init(mode, secretKey);
-            }
-
-            if (log.isLoggable(Level.FINE))
-            {
-
-                String action = mode == Cipher.ENCRYPT_MODE ? "encrypting"
-                        : "decrypting";
-
-                log.fine(action + " w/ " + algorithm + "/" + algorithmParams);
-            }
-
-            return cipher.doFinal(data);
-        }
-        catch (Exception e)
-        {
-            throw new FacesException(e);
-        }
-
-    }
-
-    /**
-     * Pulls configuration data from the context and performs symmetric encryption
-     * or decryption.  If a SecretKey is not located in an application scope level
-     * cache, it is created.
-     *
-     * @param data
-     * @param ctx
-     * @param mode
-     * @return
-     */
-
-    private static byte[] symmetric(byte[] data, ExternalContext ctx, int mode)
-    {
-
-        if (ctx == null)
-            throw new NullPointerException("ExternalContext ctx");
-
-        testConfiguration(ctx);
-
-        String _algorithm = findAlgorithm(ctx);
-        String _algorithmParams = findAlgorithmParams(ctx);
-        byte[] iv = findInitializationVector(ctx);
-
-        Object object = ctx.getApplicationMap().get(INIT_SECRET_KEY_CACHE);
-
-        if( object == null )
-            throw new NullPointerException("Could not find SecretKey in application scope using key '"
-                    + INIT_SECRET_KEY_CACHE + "'");
-
-        if( ! ( object instanceof SecretKey ) )
-            throw new ClassCastException("Did not find an instance of SecretKey "
-                    + "in application scope using the key '" + INIT_SECRET_KEY_CACHE + "'");
-
-        return symmetric(data, (SecretKey)object, _algorithm, _algorithmParams, iv, mode);
-
-    }

     private static byte[] findInitializationVector(ExternalContext ctx) {

         byte[] iv = null;
         String _iv = ctx.getInitParameter(INIT_ALGORITHM_IV);

+        if(_iv == null)
+        {
+            _iv = ctx.getInitParameter(INIT_ALGORITHM_IV.toLowerCase());
+        }
+
         if (_iv != null)
             iv = new Base64().decode(_iv.getBytes());

@@ -532,6 +640,11 @@ public final class StateUtils {

         if (algorithmParams == null)
         {
+            algorithmParams = ctx.getInitParameter(INIT_ALGORITHM_PARAM.toLowerCase());
+        }
+
+        if (algorithmParams == null)
+        {
             algorithmParams = DEFAULT_ALGORITHM_PARAMS;
         }

@@ -545,14 +658,26 @@ public final class StateUtils {

     private static String findAlgorithm(ExternalContext ctx) {

-        return findAlgorithm( ctx.getInitParameter(INIT_ALGORITHM) );
+        String algorithm = ctx.getInitParameter(INIT_ALGORITHM);
+
+        if (algorithm == null)
+        {
+            algorithm = ctx.getInitParameter(INIT_ALGORITHM.toLowerCase());
+        }

+        return findAlgorithm( algorithm );
     }

     private static String findAlgorithm(ServletContext ctx) {
+
+        String algorithm = ctx.getInitParameter(INIT_ALGORITHM);

-        return findAlgorithm( ctx.getInitParameter(INIT_ALGORITHM) );
-
+        if (algorithm == null)
+        {
+            algorithm = ctx.getInitParameter(INIT_ALGORITHM.toLowerCase());
+        }
+
+        return findAlgorithm( algorithm );
     }

     private static String findAlgorithm(String initParam) {
@@ -588,31 +713,285 @@ public final class StateUtils {

         if (log.isLoggable(Level.FINE))
             log.fine("Storing SecretKey @ " + INIT_SECRET_KEY_CACHE);
+
+        // Create and store SecretKey on application scope
+        String cache = ctx.getInitParameter(INIT_SECRET_KEY_CACHE);
+
+        if(cache == null)
+        {
+            cache = ctx.getInitParameter(INIT_SECRET_KEY_CACHE.toLowerCase());
+        }
+
+        if (!"false".equals(cache))
+        {
+            String algorithm = findAlgorithm(ctx);
+            // you want to create this as few times as possible
+            ctx.setAttribute(INIT_SECRET_KEY_CACHE, new SecretKeySpec(findSecret(ctx, algorithm), algorithm));
+        }
+
+        if (log.isLoggable(Level.FINE))
+            log.fine("Storing SecretKey @ " + INIT_MAC_SECRET_KEY_CACHE);

-        // you want to create this as few times as possible
-        ctx.setAttribute(INIT_SECRET_KEY_CACHE, new SecretKeySpec(findSecret(ctx), findAlgorithm(ctx)));
+        String macCache = ctx.getInitParameter(INIT_MAC_SECRET_KEY_CACHE);

+        if(macCache == null)
+        {
+            macCache = ctx.getInitParameter(INIT_MAC_SECRET_KEY_CACHE.toLowerCase());
+        }
+
+        if (!"false".equals(macCache))
+        {
+            String macAlgorithm = findMacAlgorithm(ctx);
+            // init mac secret and algorithm
+            ctx.setAttribute(INIT_MAC_SECRET_KEY_CACHE, new SecretKeySpec(findMacSecret(ctx, macAlgorithm), macAlgorithm));
+        }
+    }
+
+    private static SecretKey getSecret(ExternalContext ctx)
+    {
+        Object secretKey = (SecretKey) ctx.getApplicationMap().get(INIT_SECRET_KEY_CACHE);
+
+        if (secretKey == null)
+        {
+            String cache = ctx.getInitParameter(INIT_SECRET_KEY_CACHE);
+
+            if(cache == null)
+            {
+                cache = ctx.getInitParameter(INIT_SECRET_KEY_CACHE.toLowerCase());
+            }
+
+            if ("false".equals(cache))
+            {
+                // No cache is used. This option is activated
+                String secret = ctx.getInitParameter(INIT_SECRET);
+
+                if (secret == null)
+                {
+                    secret = ctx.getInitParameter(INIT_SECRET.toLowerCase());
+                }
+
+                if (secret == null)
+                {
+                    throw new NullPointerException("Could not find secret using key '" + INIT_SECRET + "'");
+                }
+
+                String algorithm = findAlgorithm(ctx);
+
+                secretKey = new SecretKeySpec(findSecret(ctx, algorithm), algorithm);
+            }
+            else
+            {
+                throw new NullPointerException("Could not find SecretKey in application scope using key '"
+                        + INIT_SECRET_KEY_CACHE + "'");
+            }
+        }
+
+        if( ! ( secretKey instanceof SecretKey ) )
+            throw new ClassCastException("Did not find an instance of SecretKey "
+                    + "in application scope using the key '" + INIT_SECRET_KEY_CACHE + "'");
+
+
+        return (SecretKey) secretKey;
     }

-    private static byte[] findSecret(ServletContext ctx) {
-        String _secret = ctx.getInitParameter(INIT_SECRET);
+    private static byte[] findSecret(ExternalContext ctx, String algorithm)
+    {
+        String secret = ctx.getInitParameter(INIT_SECRET);
+
+        if (secret == null)
+        {
+            secret = ctx.getInitParameter(INIT_SECRET.toLowerCase());
+        }
+
+        return findSecret(secret, algorithm);
+    }
+
+    private static byte[] findSecret(ServletContext ctx, String algorithm)
+    {
+        String secret = ctx.getInitParameter(INIT_SECRET);
+
+        if (secret == null)
+        {
+            secret = ctx.getInitParameter(INIT_SECRET.toLowerCase());
+        }
+
+        return findSecret(secret, algorithm);
+    }
+
+    private static byte[] findSecret(String secret, String algorithm) {
         byte[] bytes = null;

-        if(_secret == null)
+        if(secret == null)
         {
-            int length = 8;
-            bytes = new byte[length];
-            new Random().nextBytes(bytes);
-
-            if(log.isLoggable(Level.FINE))
-                log.fine("generated random password of length " + length);
+            try
+            {
+                KeyGenerator kg = KeyGenerator.getInstance(algorithm);
+                bytes = kg.generateKey().getEncoded();
+
+                if(log.isLoggable(Level.FINE))
+                    log.fine("generated random password of length " + bytes.length);
+            }
+            catch (NoSuchAlgorithmException e)
+            {
+                // Generate random password length 8,
+                int length = 8;
+                bytes = new byte[length];
+                new Random().nextBytes(bytes);
+
+                if(log.isLoggable(Level.FINE))
+                    log.fine("generated random password of length " + length);
+            }
         }
         else
         {
-            bytes = new Base64().decode(_secret.getBytes());
+            bytes = new Base64().decode(secret.getBytes());
         }

         return bytes;
     }

+    private static String findMacAlgorithm(ExternalContext ctx) {
+
+        String algorithm = ctx.getInitParameter(INIT_MAC_ALGORITHM);
+
+        if (algorithm == null)
+        {
+            algorithm = ctx.getInitParameter(INIT_MAC_ALGORITHM.toLowerCase());
+        }
+
+        return findMacAlgorithm( algorithm );
+
+    }
+
+    private static String findMacAlgorithm(ServletContext ctx) {
+
+        String algorithm = ctx.getInitParameter(INIT_MAC_ALGORITHM);
+
+        if (algorithm == null)
+        {
+            algorithm = ctx.getInitParameter(INIT_MAC_ALGORITHM.toLowerCase());
+        }
+
+        return findMacAlgorithm( algorithm );
+
+    }
+
+    private static String findMacAlgorithm(String initParam) {
+
+        if (initParam == null)
+        {
+            initParam = DEFAULT_MAC_ALGORITHM;
+        }
+
+        if (log.isLoggable(Level.FINE))
+        {
+            log.fine("Using algorithm " + initParam);
+        }
+
+        return initParam;
+
+    }
+
+    private static SecretKey getMacSecret(ExternalContext ctx)
+    {
+        Object secretKey = (SecretKey) ctx.getApplicationMap().get(INIT_MAC_SECRET_KEY_CACHE);
+
+        if (secretKey == null)
+        {
+            String cache = ctx.getInitParameter(INIT_MAC_SECRET_KEY_CACHE);
+
+            if(cache == null)
+            {
+                cache = ctx.getInitParameter(INIT_MAC_SECRET_KEY_CACHE.toLowerCase());
+            }
+
+            if ("false".equals(cache))
+            {
+                // No cache is used. This option is activated
+                String secret = ctx.getInitParameter(INIT_MAC_SECRET);
+
+                if (secret == null)
+                {
+                    secret = ctx.getInitParameter(INIT_MAC_SECRET.toLowerCase());
+                }
+
+                if (secret == null)
+                {
+                    throw new NullPointerException("Could not find secret using key '" + INIT_MAC_SECRET + "'");
+                }
+
+                String macAlgorithm = findMacAlgorithm(ctx);
+
+                secretKey = new SecretKeySpec(findMacSecret(ctx, macAlgorithm), macAlgorithm);
+            }
+            else
+            {
+                throw new NullPointerException("Could not find SecretKey in application scope using key '"
+                        + INIT_MAC_SECRET_KEY_CACHE + "'");
+            }
+        }
+
+        if( ! ( secretKey instanceof SecretKey ) )
+            throw new ClassCastException("Did not find an instance of SecretKey "
+                    + "in application scope using the key '" + INIT_MAC_SECRET_KEY_CACHE + "'");
+
+
+        return (SecretKey) secretKey;
+    }
+
+    private static byte[] findMacSecret(ExternalContext ctx, String algorithm)
+    {
+        String secret = ctx.getInitParameter(INIT_MAC_SECRET);
+
+        if (secret == null)
+        {
+            secret = ctx.getInitParameter(INIT_MAC_SECRET.toLowerCase());
+        }
+
+        return findMacSecret(secret, algorithm);
+    }
+
+    private static byte[] findMacSecret(ServletContext ctx, String algorithm)
+    {
+        String secret = ctx.getInitParameter(INIT_MAC_SECRET);
+
+        if (secret == null)
+        {
+            secret = ctx.getInitParameter(INIT_MAC_SECRET.toLowerCase());
+        }
+
+        return findMacSecret(secret, algorithm);
+    }
+
+    private static byte[] findMacSecret(String secret, String algorithm) {
+        byte[] bytes = null;
+
+        if(secret == null)
+        {
+            try
+            {
+                KeyGenerator kg = KeyGenerator.getInstance(algorithm);
+                bytes = kg.generateKey().getEncoded();
+
+                if(log.isLoggable(Level.FINE))
+                    log.fine("generated random mac password of length " + bytes.length);
+            }
+            catch (NoSuchAlgorithmException e)
+            {
+                // Generate random password length 8,
+                int length = 8;
+                bytes = new byte[length];
+                new Random().nextBytes(bytes);
+
+                if(log.isLoggable(Level.FINE))
+                    log.fine("generated random mac password of length " + length);
+            }
+        }
+        else
+        {
+            bytes = new Base64().decode(secret.getBytes());
+        }
+
+        return bytes;
+    }
 }

```

---

| Colored Diff Long Colored Diff Full Colored Diff Unidiff Context Diff Side by Side |  |
| --- | --- |

---

| infrastructure at apache.org | **[ViewVC Help](/vc-static/help_rootview.html)** |
| --- | --- |
| Powered by [ViewVC 1.1.26](http://viewvc.tigris.org/) |  |


