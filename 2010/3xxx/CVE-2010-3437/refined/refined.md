```
Message-ID: <4CA19CDE.6050706@kernel.sg>
Date: Tue, 28 Sep 2010 15:44:30 +0800
From: Eugene Teo <eugeneteo@...nel.sg>
To: oss-security@...ts.openwall.com
CC: "Steven M. Christey" <coley@...us.mitre.org>
Subject: CVE request - kernel: pktcdvd ioctl dev_minor missing range check

As Dan Rosenberg explained in the patch commit: The PKT_CTRL_CMD_STATUS
device ioctl retrieves a pointer to a pktcdvd_device from the global
pkt_devs array. The index into this array is provided directly by the
user and is a signed integer, so the comparison to ensure that it falls
within the bounds of this array will fail when provided with a negative
index.

This can be used to read arbitrary kernel memory or cause a crash due to
an invalid pointer dereference. This can be exploited by users with
permission to open /dev/pktcdvd/control (on many distributions, this is
readable by group "cdrom").
```

**Root cause of vulnerability:** A missing range check on a user-supplied signed integer index when accessing the `pkt_devs` array in the `PKT_CTRL_CMD_STATUS` ioctl of the `pktcdvd` driver.

**Weaknesses/vulnerabilities present:**
  - **Integer Overflow/Underflow:** The signed integer is not checked against the bounds of the array leading to the possibility of a negative index.
  - **Arbitrary Kernel Memory Read:** By providing a crafted negative index, an attacker can cause the kernel to dereference an address outside the valid range of the `pkt_devs` array leading to arbitrary kernel memory being read.
  - **Denial of Service:** A crafted index value can also lead to an invalid pointer dereference, causing a kernel crash.

**Impact of exploitation:**
  - Arbitrary kernel memory disclosure
  - Kernel crash leading to denial of service.

**Attack vectors:**
  - Local attacker, by using the PKT_CTRL_CMD_STATUS ioctl on the `/dev/pktcdvd/control` device.

**Required attacker capabilities/position:**
  - The attacker must have the permission to open `/dev/pktcdvd/control`, which on some systems is readable by the `cdrom` group.

**Additional details:**
- The vulnerability was introduced in kernel version 2.6.10-rc1.
- The vulnerability is present in the `drivers/block/pktcdvd.c` file.
- A fix has been provided by limiting the index.
```
Message-ID: <1862982385.592341285702955007.JavaMail.root@zmail01.collab.prod.int.phx2.redhat.com>
Date: Tue, 28 Sep 2010 15:42:35 -0400 (EDT)
From: Josh Bressers <bressers@...hat.com>
To: oss-security@...ts.openwall.com
Cc: "Steven M. Christey" <coley@...us.mitre.org>
Subject: Re: CVE request - kernel: pktcdvd ioctl dev_minor
 missing range check

Please use CVE-2010-3437
```

This message confirms that the CVE ID CVE-2010-3437 is assigned to this vulnerability.
```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

- ----------------------------------------------------------------------
Debian Security Advisory DSA-2126-1                security@debian.org
<http://www.debian.org/security/>                           dann frazier
November 26, 2010                   <http://www.debian.org/security/faq>
- ----------------------------------------------------------------------

Package        : linux-2.6
Vulnerability  : privilege escalation/denial of service/information leak
Problem type   : local/remote
Debian-specific: no
CVE Id(s)      : CVE-2010-2963 CVE-2010-3067 CVE-2010-3296 CVE-2010-3297
                 CVE-2010-3310 CVE-2010-3432 CVE-2010-3437 CVE-2010-3442
                 CVE-2010-3448 CVE-2010-3477 CVE-2010-3705 CVE-2010-3848
                 CVE-2010-3849 CVE-2010-3850 CVE-2010-3858 CVE-2010-3859
                 CVE-2010-3873 CVE-2010-3874 CVE-2010-3875 CVE-2010-3876
                 CVE-2010-3877 CVE-2010-3880 CVE-2010-4072 CVE-2010-4073
                 CVE-2010-4074 CVE-2010-4078 CVE-2010-4079 CVE-2010-4080
                 CVE-2010-4081 CVE-2010-4083 CVE-2010-4164
Debian Bug(s)  :

Several vulnerabilities have been discovered in the Linux kernel that may lead
to a privilege escalation, denial of service or information leak.  The Common
Vulnerabilities and Exposures project identifies the following problems:
...
CVE-2010-3437

    Dan Rosenberg discovered an issue in the pktcdvd driver. Local users with
    permission to open /dev/pktcdvd/control can obtain the contents of sensitive
    kernel memory or cause a denial of service. By default on Debian systems,
    this access is restricted to members of the group 'cdrom'.
...
For the stable distribution (lenny), this problem has been fixed in version
2.6.26-26lenny1.

We recommend that you upgrade your linux-2.6 and user-mode-linux packages.
```

This Debian Security Advisory confirms the vulnerability and describes it, along with its impact.
```
SUSE Security Announcement
Package: kernel
Announcement ID: SUSE-SA:2011:001
Date: Mon, 03 Jan 2011 15:00:00 +0000
Affected Products: openSUSE 11.3
Vulnerability Type: local privilege escalation, remote denial of service
CVSS v2 Base Score: 7.8 (AV:N/AC:L/Au:N/C:N/I:N/A:C)
SUSE Default Package: yes
Cross-References: CVE-2010-0435, CVE-2010-3067, CVE-2010-3432
CVE-2010-3437, CVE-2010-3442, CVE-2010-3861
CVE-2010-3865, CVE-2010-3874, CVE-2010-4072
CVE-2010-4073, CVE-2010-4078, CVE-2010-4080
CVE-2010-4081, CVE-2010-4082, CVE-2010-4083
CVE-2010-4157, CVE-2010-4158, CVE-2010-4162
CVE-2010-4163, CVE-2010-4164, CVE-2010-4165
CVE-2010-4169, CVE-2010-4175, CVE-2010-4258
CVE-2010-4347
Content of This Advisory:
1) Security Vulnerability Resolved:
Linux kernel security update
Problem Description
...
CVE-2010-3437: A range checking overflow in pktcdvd ioctl was fixed.
...
```
This SUSE Security Announcement confirms the vulnerability and describes the fix.
```
SUSE Security Announcement
Package: kernel
Announcement ID: SUSE-SA:2011:002
Date: Mon, 03 Jan 2011 15:00:00 +0000
Affected Products: openSUSE 11.2
Vulnerability Type: potential local privilege escalation
CVSS v2 Base Score: 6.6 (AV:L/AC:L/Au:N/C:C/I:N/A:C)
SUSE Default Package: yes
Cross-References: CVE-2010-3067, CVE-2010-3437, CVE-2010-3442
CVE-2010-3861, CVE-2010-3865, CVE-2010-3874
CVE-2010-4078, CVE-2010-4080, CVE-2010-4081
CVE-2010-4082, CVE-2010-4157, CVE-2010-4158
CVE-2010-4160, CVE-2010-4162, CVE-2010-4163
CVE-2010-4164, CVE-2010-4165, CVE-2010-4175
CVE-2010-4258
Content of This Advisory:
1) Security Vulnerability Resolved:
Linux kernel security update
Problem Description
...
CVE-2010-3437: A range checking overflow in pktcdvd ioctl was fixed.
...
```

This SUSE Security Announcement also confirms the vulnerability and describes the fix.
```
# Linux Kernel < 2.6.36-rc6 (RedHat / Ubuntu 10.04) - 'pktcdvd' Kernel Memory Disclosure

#### EDB-ID:

###### 15150

#### CVE:

###### [2010-3437](https://nvd.nist.gov/vuln/detail/CVE-2010-3437)

---

**EDB Verified:**

#### Author:

###### [Jon Oberheide](/?author=1507)

#### Type:

###### [local](/?type=local)

---

#### Platform:

###### [Linux](/?platform=linux)

#### Date:

###### 2010-09-29

---

**Vulnerable App:**
...
 * The PKT_CTRL_CMD_STATUS device ioctl retrieves a pointer to a
 * pktcdvd_device from the global pkt_devs array. The index into this
 * array is provided directly by the user and is a signed integer, so the
 * comparison to ensure that it falls within the bounds of this array will
 * fail when provided with a negative index.
...
```
This exploit database entry provides a functional exploit, and details the same root cause as the previous source.
```
SUSE Security Announcement
Package: kernel
Announcement ID: SUSE-SA:2010:060
Date: Tue, 14 Dec 2010 12:00:00 +0000
Affected Products: SLE SDK 10 SP3
SUSE Linux Enterprise Desktop 10 SP3
SUSE Linux Enterprise Server 10 SP3
Vulnerability Type: remote denial of service
CVSS v2 Base Score: 7.8 (AV:N/AC:L/Au:N/C:N/I:N/A:C)
SUSE Default Package: yes
Cross-References: CVE-2010-2226, CVE-2010-2248, CVE-2010-2942
CVE-2010-2946, CVE-2010-3067, CVE-2010-3086
CVE-2010-3310, CVE-2010-3437, CVE-2010-3442
CVE-2010-4072, CVE-2010-4073, CVE-2010-4078
CVE-2010-4080, CVE-2010-4081, CVE-2010-4083
CVE-2010-4157, CVE-2010-4158, CVE-2010-4162
CVE-2010-4164
Content of This Advisory:
1) Security Vulnerability Resolved:
Linux kernel security update
Problem Description
...
CVE-2010-3437: Integer signedness error in the pkt_find_dev_from_minor
function in drivers/block/pktcdvd.c in the Linux kernel before
2.6.36-rc6 allows local users to obtain sensitive information from
kernel memory or cause a denial of service (invalid pointer dereference
and system crash) via a crafted index value in a PKT_CTRL_CMD_STATUS
ioctl call.
...
```
This SUSE Security Advisory also confirms the vulnerability, describes the root cause.
```
SUSE Security Announcement
Package: kernel
Announcement ID: SUSE-SA:2011:004
Date: Fri, 14 Jan 2011 13:00:00 +0000
Affected Products: SUSE Linux Enterprise High Availability Extension 11 SP1
SUSE Linux Enterprise Desktop 11 SP1
SUSE Linux Enterprise Server 11 SP1
Vulnerability Type: local privilege escalation
CVSS v2 Base Score: 7.8 (AV:N/AC:L/Au:N/C:N/I:N/A:C)
SUSE Default Package: yes
Cross-References: CVE-2010-3437, CVE-2010-3861, CVE-2010-3874
CVE-2010-3881, CVE-2010-4072, CVE-2010-4073
CVE-2010-4082, CVE-2010-4083, CVE-2010-4157
CVE-2010-4158, CVE-2010-4160, CVE-2010-4162
CVE-2010-4163, CVE-2010-4164, CVE-2010-4165
CVE-2010-4169, CVE-2010-4175, CVE-2010-4258
Content of This Advisory:
1) Security Vulnerability Resolved:
Linux kernel security problems
Problem Description
...
CVE-2010-3437: A range checking overflow in pktcdvd ioctl was fixed.
...
```
This SUSE Security Advisory again confirms the vulnerability, describes the fix.
```
USN-1000-1: Linux kernel vulnerabilities
...
Dan Rosenberg discovered that the CD driver did not correctly check
parameters. A local attacker could exploit this to read arbitrary kernel
memory, leading to a loss of privacy. ([CVE-2010-3437](/security/CVE-2010-3437))
...
```
This Ubuntu Security Notice confirms the vulnerability and describes the impact.

```
(CVE-2010-3437)
- [CVE-2010-3437](https://access.redhat.com/security/cve/CVE-2010-3437) kernel: pktcdvd ioctl dev_minor missing range check
...
Description of problem:
The PKT_CTRL_CMD_STATUS device ioctl retrieves a pointer to a pktcdvd_device from the global pkt_devs array. The index into this array is provided directly by the user and is a signed integer, so the comparison to ensure that it falls within the bounds of this array will fail when provided with a negative index.
This can be used to read arbitrary kernel memory or cause a crash due to an invalid pointer dereference. This can be exploited by users with permission to open /dev/pktcdvd/control (on many distributions, this is readable by group "cdrom").
Upstream commit: <http://git.kernel.org/linus/252a52aa4fa22a668f019e55b3aac3ff71ec1c29>
```
This Red Hat Bugzilla entry confirms the vulnerability, describes the impact and root cause and links the upstream commit.

```
/*
 * cve-2010-3437.c
 *
 * Linux Kernel < 2.6.36-rc6 pktcdvd Kernel Memory Disclosure
 * Jon Oberheide <jon@oberheide.org>
 * http://jon.oberheide.org
 *
 * Information:
 *
 *   https://bugzilla.redhat.com/show_bug.cgi?id=638085
 *
 *   The PKT_CTRL_CMD_STATUS device ioctl retrieves a pointer to a
 *   pktcdvd_device from the global pkt_devs array.  The index into this
 *   array is provided directly by the user and is a signed integer, so the
 *   comparison to ensure that it falls within the bounds of this array will
 *   fail when provided with a negative index.
 *
 * Usage:
 *
 *   $ gcc cve-2010-3437.c -o cve-2010-3437
 *   $ ./cve-2010-3437
 *   usage: ./cve-2010-3437 <address> <length>
 *   $ ./cve-2010-3437 0xc0102290 64
 *   [+] searching for pkt_devs kernel symbol...
 *   [+] found pkt_devs at 0xc086fcc0
 *   [+] opening pktcdvd device...
 *   [+] calculated dereference address of 0x790070c0
 *   [+] mapping page at 0x79007000 for pktcdvd_device dereference...
 *   [+] setting up fake pktcdvd_device structure...
 *   [+] dumping kmem from 0xc0102290 to 0xc01022d0 via malformed ioctls...
 *   [+] dumping kmem to output...
 *
 *   55 89 e5 0f 1f 44 00 00 8b 48 3c 8b 50 04 8b ...
 *   55 89 e5 57 56 53 0f 1f 44 00 00 89 d3 89 e2 ...
 *
 * Notes:
 *
 *   Pass the desired kernel memory address and dump length as arguments.
 *
 *   We can disclose 4 bytes of arbitrary kernel memory per ioctl call by
 *   specifying a large negative device index, causing the kernel to
 *   dereference to our fake pktcdvd_device structure in userspace and copy
 *   data to userspace from an attacker-controlled address.  Since only 4
 *   bytes of kmem are disclosed per ioctl call, large dump sizes may take a
 *   few seconds.
 *
 *   Tested on Ubuntu Lucid 10.04.  32-bit only for now.
 */
```
This source code confirms that the vulnerability exists, shows a way to exploit it.

```
/*
 * cve-2010-3437.c
 *
 * Linux Kernel < 2.6.36-rc6 pktcdvd Kernel Memory Disclosure
 * Jon Oberheide <jon@oberheide.org>
 * http://jon.oberheide.org
 *
 * Information:
 *
 *   https://bugzilla.redhat.com/show_bug.cgi?id=638085
 *
 *   The PKT_CTRL_CMD_STATUS device ioctl retrieves a pointer to a
 *   pktcdvd_device from the global pkt_devs array.  The index into this
 *   array is provided directly by the user and is a signed integer, so the
 *   comparison to ensure that it falls within the bounds of this array will
 *   fail when provided with a negative index.
 *
 * Usage:
 *
 *   $ gcc cve-2010-3437.c -o cve-2010-3437
 *   $ ./cve-2010-3437
 *   usage: ./cve-2010-3437
 *   $ ./cve-2010-3437 0xc0102290 64
 *   [+] searching for pkt_devs kernel symbol...
 *   [+] found pkt_devs at 0xc08d3a00
 *   [+] searching for mmap_min_addr kernel symbol...
 *   [+] found mmap_min_addr at 0xc08c8c28
 *   [+] mmap_min_addr is 44504 bytes away from pkt_devs
 *   [+] calculated device index of -11126
 *   [+] trying to mmap page at 0x1000 for pktcdvd_device dereference...
 *   [+] trying to mmap page at 0x10000 for pktcdvd_device dereference...
 *   [+] opening pktcdvd device...
 *   [+] dumping kmem from 0xc0102290 to 0xc01022d0 via malformed ioctls...
 *   [+] dumping kmem to output...
 *
 *   55 89 e5 0f 1f 44 00 00 8b 48 3c 8b 50 04 8b ...
 *   55 89 e5 57 56 53 0f 1f 44 00 00 89 d3 89 e2 ...
 *
 * Notes:
 *
 *   Pass the desired kernel memory address and dump length as arguments.
 *
 *   We can disclose 4 bytes of arbitrary kernel memory per ioctl call by
 *   specifying a large negative device index, causing the kernel to
 *   dereference to an attacker-controlled address and copy data to
 *   userspace. Since only 4 bytes of kmem are disclosed per ioctl call,
 *   large dump sizes may take a few seconds.
 *
 *   On 32-bit, it's easy enough to reach a userspace address with the
 *   negative device index. However, 64-bit is a bit trickier, and we need
 *   to bounce through a predictable address in kernel memory that has a
 *   predictable value that is also mmap'able (eg. >= mmap_min_addr). The
 *   best candidate is actually mmap_min_addr itself whose address can be
 *   pulled from available symbols and whose value can be inferred with a
 *   couple mmap guesses (4096, 65536). So we reference the address of
 *   mmap_min_addr in the kernel using the negative device index, which
 *   bounces us to its value in userspace (either 0x1000 or 0x10000), hits
 *   the fake pktcdvd_device structure set up there, and copies 4 bytes from
 *   an arbitrary kernel memory address to userspace.
 *
 *   Tested on Ubuntu Lucid 10.04.
 */

```
This source code is also an exploit for this vulnerability, but it works in 64 bits, by exploiting the mmap_min_addr