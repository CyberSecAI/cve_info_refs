```
Message-ID: <20100921105612.GA5579@openwall.com>
Date: Tue, 21 Sep 2010 14:56:12 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

On Mon, Aug 16, 2010 at 12:05:13PM +0100, Tim Brown wrote:
> Here's another bug where privileged code isn't checking the return value from
> setuid():
>
> <http://sourceforge.net/tracker/?func=detail&aid=3028213&group_id=6663&atid=106663>

This is fixed in Linux-PAM 1.1.2:

<http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=06f882f30092a39a1db867c9744b2ca8d60e4ad6>

The same commit also introduces previously-missing privilege switching
into pam_env and pam_mail.  Unfortunately, this pam_env and pam_mail fix
is incomplete: it only switches the fsuid (should also switch fsgid (or
egid) and groups), and it fails to check the return value from setfsuid()
(doing so would require duplicate calls to setfsuid(), like we do in
libtcb, or switching of euid instead - yet it is desirable).

The pam_env and pam_mail issue was discovered by Sebastian Krahmer of SuSE.

Alexander
```

```
Message-ID: <60269379.244181285095443209.JavaMail.root@zmail01.collab.prod.int.phx2.redhat.com>
Date: Tue, 21 Sep 2010 14:57:23 -0400 (EDT)
From: Josh Bressers <bressers@...hat.com>
To: oss-security@...ts.openwall.com
Cc: coley <coley@...re.org>
Subject: Re: Minor security flaw with pam_xauth

----- "Solar Designer" <solar@...nwall.com> wrote:

> On Mon, Aug 16, 2010 at 12:05:13PM +0100, Tim Brown wrote:
> > Here's another bug where privileged code isn't checking the return
> value from
> > setuid():
> >
> >
> <http://sourceforge.net/tracker/?func=detail&aid=3028213&group_id=6663&atid=106663>
>
> This is fixed in Linux-PAM 1.1.2:
>
> <http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=06f882f30092a39a1db867c9744b2ca8d60e4ad6>
>

Let's use CVE-2010-3316 for the above flaw.

> The same commit also introduces previously-missing privilege switching
> into pam_env and pam_mail.  Unfortunately, this pam_env and pam_mail fix
> is incomplete: it only switches the fsuid (should also switch fsgid (or
> egid) and groups), and it fails to check the return value from setfsuid()
> (doing so would require duplicate calls to setfsuid(), like we do in
> libtcb, or switching of euid instead - yet it is desirable).
>

This one is a bit on the tricky side. I'm going to call it "improper
setfsuid use" so we can use just one CVE instead of two (as the flaws are
related):

Use CVE-2010-3430

Steve, feel free to overrule me if MITRE doesn't like this.

Thanks.

--
    JB
```
```
Message-ID: <Pine.GSO.4.64.1009211508500.21207@faron.mitre.org>
Date: Tue, 21 Sep 2010 15:15:44 -0400 (EDT)
From: "Steven M. Christey" <coley@...us.mitre.org>
To: Josh Bressers <bressers@...hat.com>
cc: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

On Tue, 21 Sep 2010, Josh Bressers wrote:

>> The same commit also introduces previously-missing privilege switching
>> into pam_env and pam_mail.  Unfortunately, this pam_env and pam_mail fix
>> is incomplete: it only switches the fsuid (should also switch fsgid (or
>> egid) and groups), and it fails to check the return value from setfsuid()
>> (doing so would require duplicate calls to setfsuid(), like we do in
>> libtcb, or switching of euid instead - yet it is desirable).
>>
>
> This one is a bit on the tricky side. I'm going to call it "improper
> setfsuid use" so we can use just one CVE instead of two (as the flaws are
> related):
>
> Use CVE-2010-3430

Things get tricky once you get to such low levels of detail, and this is
the area where there's a little bit of wiggle room.  At one level, you
could call it "improper switching of privileges."  Or you could split at
the level of the individual bugs.

One way that helps to clarify such things is: "if I fix X, will Y be
rendered neutral?"  In this case, if you don't switch fsgid/egid and
groups, you still have an unchecked return value that could cause problems
if setfsuid() fails.  The converse also appears true - even if you check
the result to setfsuid, you still run with the wrong group IDs.  (Note
that this "independent bug fix" is actually the opposite of when you merge
things of the same bug type, and this kind of approach will get more and
more complicated as the more-obvious bugs get eliminated from the affected
code).

In this case, I would argue for two CVEs.

- Steve
```
```
Message-ID: <48377916.247941285096927792.JavaMail.root@zmail01.collab.prod.int.phx2.redhat.com>
Date: Tue, 21 Sep 2010 15:22:07 -0400 (EDT)
From: Josh Bressers <bressers@...hat.com>
To: oss-security@...ts.openwall.com
Cc: coley <coley@...re.org>
Subject: Re: Minor security flaw with pam_xauth

----- "Josh Bressers" <bressers@...hat.com> wrote:
>
> > The same commit also introduces previously-missing privilege switching
> > into pam_env and pam_mail.  Unfortunately, this pam_env and pam_mail
> > fix is incomplete: it only switches the fsuid (should also switch fsgid
> > (or egid) and groups), and it fails to check the return value from
> > setfsuid() (doing so would require duplicate calls to setfsuid(), like
> > we do in libtcb, or switching of euid instead - yet it is desirable).
> >
>
> This one is a bit on the tricky side. I'm going to call it "improper
> setfsuid use" so we can use just one CVE instead of two (as the flaws
> are
> related):
>
> Use CVE-2010-3430
>

MITRE votes for two, so here goes:

Let's use CVE-2010-3430 for the missing setfsgid.

Use CVE-2010-3431 for the missing return checks on setfsuid.

Thanks Steve.

--
    JB
```
```
Message-ID: <20100921194903.GA9321@openwall.com>
Date: Tue, 21 Sep 2010 23:49:03 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

On Tue, Sep 21, 2010 at 03:22:07PM -0400, Josh Bressers wrote:
> > > The same commit also introduces previously-missing privilege switching
> > > into pam_env and pam_mail.  Unfortunately, this pam_env and pam_mail
> > > fix is incomplete: it only switches the fsuid (should also switch fsgid
> > > (or egid) and groups), and it fails to check the return value from
> > > setfsuid() (doing so would require duplicate calls to setfsuid(), like
> > > we do in libtcb, or switching of euid instead - yet it is desirable).
...
> Let's use CVE-2010-3430 for the missing setfsgid.

...and the missing setgroups().

> Use CVE-2010-3431 for the missing return checks on setfsuid.

OK.  BTW, I think this is not exploitable on current kernels, at least
not via RLIMIT_NPROC (it does not apply to fsuid), yet it is desirable
to check the return value from such syscalls.

What about the completely missing privilege switching in pre-1.1.2 (the
bug found by Sebastian)?  I don't recall if it already had a CVE id
assigned or not.

Alexander
```
```
Message-ID: <20100924164823.GA21584@openwall.com>
Date: Fri, 24 Sep 2010 20:48:23 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Cc: coley <coley@...re.org>
Subject: Re: Minor security flaw with pam_xauth

On Tue, Sep 21, 2010 at 04:02:47PM -0400, Josh Bressers wrote:
> Since you have the best understanding of these, can you break them down
> with reasonable explanations and I'll assign IDs to whatever still needs
> them?

pam_xauth missing return value checks from setuid() and similar calls,
fixed in Linux-PAM 1.1.2 - CVE-2010-3316

pam_env and pam_mail accessing the target user's files as root (and thus
susceptible to attacks by the user) in Linux-PAM below 1.1.2, partially
fixed in 1.1.2 - no CVE ID mentioned yet

pam_env and pam_mail in Linux-PAM 1.1.2 not switching fsgid (or egid)
and groups when accessing the target user's files (and thus potentially
susceptible to attacks by the user) - CVE-2010-3430

pam_env and pam_mail in Linux-PAM 1.1.2 not checking whether the
setfsuid() calls succeed (no known impact with current Linux kernels,
but poor practice in general) - CVE-2010-3431

Now, in case someone fixes CVE-2010-3430 but fails to add return value
checks for the added calls, we'll need yet another CVE ID for the
partial fix... but I hope this won't happen.

Alexander
```
```
Message-ID: <20100927173613.GM1960@redhat.com>
Date: Mon, 27 Sep 2010 11:36:13 -0600
From: Vincent Danen <vdanen@...hat.com>
To: oss-security@...ts.openwall.com
Cc: coley <coley@...re.org>
Subject: Re: Minor security flaw with pam_xauth

* [2010-09-24 20:48:23 +0400] Solar Designer wrote:

>On Tue, Sep 21, 2010 at 04:02:47PM -0400, Josh Bressers wrote:
>> Since you have the best understanding of these, can you break them down
>> with reasonable explanations and I'll assign IDs to whatever still needs
>> them?
>
>pam_xauth missing return value checks from setuid() and similar calls,
>fixed in Linux-PAM 1.1.2 - CVE-2010-3316
>
>pam_env and pam_mail accessing the target user's files as root (and thus
>susceptible to attacks by the user) in Linux-PAM below 1.1.2, partially
>fixed in 1.1.2 - no CVE ID mentioned yet
>
>pam_env and pam_mail in Linux-PAM 1.1.2 not switching fsgid (or egid)
>and groups when accessing the target user's files (and thus potentially
>susceptible to attacks by the user) - CVE-2010-3430
>
>pam_env and pam_mail in Linux-PAM 1.1.2 not checking whether the
>setfsuid() calls succeed (no known impact with current Linux kernels,
>but poor practice in general) - CVE-2010-3431
>
>Now, in case someone fixes CVE-2010-3430 but fails to add return value
>checks for the added calls, we'll need yet another CVE ID for the
>partial fix... but I hope this won't happen.

These that are partially fixed are fixed in that git commit you noted
previously?

<http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=06f882f30092a39a1db867c9744b2ca8d60e4ad6>

Or are they fixed in different commits?  It looks like they should all
be fixed in that commit, but I want to double-check.

Are there patches available to fully fix these issues?  And are there
patches for 3430 and 3431 yet?  I'm assuming also that those issues have
always existed although you say 'in 1.1.2', but they would affect
earlier versions yet, right?

Thanks for any clarification.  I'm trying to wrap my head around this
and the impact of these issues.  They all strike me as relatively minor
issues, but it is possible that I am missing or misunderstanding
something here.

--
Vincent Danen / Red Hat Security Response Team
```
```
Message-ID: <20100927201729.GB4485@openwall.com>
Date: Tue, 28 Sep 2010 00:17:29 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

On Mon, Sep 27, 2010 at 11:36:13AM -0600, Vincent Danen wrote:
> * [2010-09-24 20:48:23 +0400] Solar Designer wrote:
> >pam_env and pam_mail accessing the target user's files as root (and thus
> >susceptible to attacks by the user) in Linux-PAM below 1.1.2, partially
> >fixed in 1.1.2 - no CVE ID mentioned yet
> >
> >pam_env and pam_mail in Linux-PAM 1.1.2 not switching fsgid (or egid)
> >and groups when accessing the target user's files (and thus potentially
> >susceptible to attacks by the user) - CVE-2010-3430
> >
> >pam_env and pam_mail in Linux-PAM 1.1.2 not checking whether the
> >setfsuid() calls succeed (no known impact with current Linux kernels,
> >but poor practice in general) - CVE-2010-3431
...
> These that are partially fixed are fixed in that git commit you noted
> previously?
>
> <http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=06f882f30092a39a1db867c9744b2ca8d60e4ad6>
>
> Or are they fixed in different commits?  It looks like they should all
> be fixed in that commit, but I want to double-check.

No, they are not fully fixed at all.  We're working on a patch (so you
don't need to).  The commit has the mentioned partial fixes only.

> Are there patches available to fully fix these issues?  And are there
> patches for 3430 and 3431 yet?

This is the same question asked different ways.  We have a patch that
we're reviewing internally.  To be made available soon.

> I'm assuming also that those issues have
> always existed although you say 'in 1.1.2', but they would affect
> earlier versions yet, right?

The original pam_env and pam_mail issues, yes.  The partial fixes, no,
because there were no fixes at all before 1.1.2.

> Thanks for any clarification.  I'm trying to wrap my head around this
> and the impact of these issues.  They all strike me as relatively minor
> issues, but it is possible that I am missing or misunderstanding
> something here.

They're relatively minor because these modules are normally not used.
However, if the modules are used in a PAM stack on a given install, then
the original issues reported against pam_env and pam_mail by Sebastian
become major ones.

Additionally, as mentioned by Sebastian, pam_env's intended behavior is
a security risk (user-provided env vars may affect some services in ways
not expected by the sysadmin).  I am not sure how to deal with that.
Maybe improve the documentation.

Alexander
```
```
Message-ID: <20100927202916.GA4576@openwall.com>
Date: Tue, 28 Sep 2010 00:29:16 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

On Mon, Sep 27, 2010 at 11:44:03AM -0600, Vincent Danen wrote:
> >* [2010-09-24 20:48:23 +0400] Solar Designer wrote:
> >>pam_xauth missing return value checks from setuid() and similar calls,
> >>fixed in Linux-PAM 1.1.2 - CVE-2010-3316
> >>
> >>pam_env and pam_mail accessing the target user's files as root (and thus
> >>susceptible to attacks by the user) in Linux-PAM below 1.1.2, partially
> >>fixed in 1.1.2 - no CVE ID mentioned yet
> >>
> >>pam_env and pam_mail in Linux-PAM 1.1.2 not switching fsgid (or egid)
> >>and groups when accessing the target user's files (and thus potentially
> >>susceptible to attacks by the user) - CVE-2010-3430
> >>
> >>pam_env and pam_mail in Linux-PAM 1.1.2 not checking whether the
> >>setfsuid() calls succeed (no known impact with current Linux kernels,
> >>but poor practice in general) - CVE-2010-3431
...
> Oh, hang on.  Re-read some older messages again trying to grok this and
> it looks like these checks were introduced in 1.1.2, so they would _not_
> affect earlier versions if I'm understanding correctly.

Older versions were "fully vulnerable".  1.1.2 is "partially vulnerable".

> So only 3316 and the second issue without a CVE name affect pre-1.1.2.

Yes, in a sense.

> So what about previous versions that _don't_ have privilege switching in
> pam_env and pam_mail?  Would that require yet another CVE or would the
> addition of privilege switching be considered an enhancement, not a
> security fix?

I think it should be considered a security fix.  Moreover, of these four
issues (if we keep the separation above), the currently-CVE-less is the
most serious one.

Alexander
```
```
Message-ID: <20101003220003.GA23811@altlinux.org>
Date: Mon, 4 Oct 2010 02:00:03 +0400
From: "Dmitry V. Levin" <ldv@...linux.org>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

Hi,

On Fri, Oct 01, 2010 at 04:02:04PM -0600, Vincent Danen wrote:
> * [2010-09-28 00:17:29 +0400] Solar Designer wrote:
> >On Mon, Sep 27, 2010 at 11:36:13AM -0600, Vincent Danen wrote:
> >>* [2010-09-24 20:48:23 +0400] Solar Designer wrote:
> >>>pam_env and pam_mail accessing the target user's files as root (and thus
> >>>susceptible to attacks by the user) in Linux-PAM below 1.1.2, partially
> >>>fixed in 1.1.2 - no CVE ID mentioned yet
> >>>
> >>>pam_env and pam_mail in Linux-PAM 1.1.2 not switching fsgid (or egid)
> >>>and groups when accessing the target user's files (and thus potentially
> >>>susceptible to attacks by the user) - CVE-2010-3430
> >>>
> >>>pam_env and pam_mail in Linux-PAM 1.1.2 not checking whether the
> >>>setfsuid() calls succeed (no known impact with current Linux kernels,
> >>>but poor practice in general) - CVE-2010-3431
[...]
> >>Are there patches available to fully fix these issues?  And are there
> >>patches for 3430 and 3431 yet?
> >
> >This is the same question asked different ways.  We have a patch that
> >we're reviewing internally.  To be made available soon.
>
> Great, looking forward to seeing them.

The patch that fixes CVE-2010-3430 and CVE-2010-3431 was just made public:
<http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=pam_modutil_priv>

Besides that, another two issues have been fixed in pam_xauth after
Linux-PAM 1.1.2 release:

In pam_sm_close_session(), the attempt to unlink cookie file was made
without dropping privileges at all if target uid could not be determined:
<http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=Linux-PAM-1_1_2-3-g05dafc0>

In check_acl(), there were no check that the acl file provided by target
user is a regular file:
<http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=Linux-PAM-1_1_2-2-gffe7058>

--
ldv

Content of type "application/pgp-signature" skipped
```
```
Message-ID: <20101025035006.GA29268@openwall.com>
Date: Mon, 25 Oct 2010 07:50:06 +0400
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: Minor security flaw with pam_xauth

Dmitry has produced a patch against Linux-PAM 1.1.2 with the fixes
mentioned in the quoted message below.

<http://cvsweb.openwall.com/cgi/cvsweb.cgi/Owl/packages/pam/>

This is Linux-PAM-1.1.2-up-20101011.diff (same as the changes made
upstream) and Linux-PAM-1.1.2-owl-Makefile.diff.

We already have this in Owl, documented as follows:

2010/10/18	Package: pam
SECURITY FIX	Severity: none to medium, local, active
Updated to 1.1.2+ snapshot 20101011.  This code revision introduces the
proper privilege switching into pam_env, pam_mail, and pam_xauth.  None
of these modules are in use on default installs of Owl, and they never
were, hence there was no impact for default installs.
References:
<http://www.openwall.com/lists/oss-security/2010/08/16/2>
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3316>
<http://www.openwall.com/lists/oss-security/2010/09/21/3>
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3435>
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3430>
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3431>

I am posting this in case others want to have the issues fixed before
the 1.1.3 release comes out.

Alexander

On Mon, Oct 04, 2010 at 02:00:03AM +0400, Dmitry V. Levin wrote:
> The patch that fixes CVE-2010-3430 and CVE-2010-3431 was just made public:
> <http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=pam_modutil_priv>
>
> Besides that, another two issues have been fixed in pam_xauth after
> Linux-PAM 1.1.2 release:
>
> In pam_sm_close_session(), the attempt to unlink cookie file was made
> without dropping privileges at all if target uid could not be determined:
> <http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=Linux-PAM-1_1_2-3-g05dafc0>
>
> In check_acl(), there were no check that the acl file provided by target
> user is a regular file:
> <http://git.altlinux.org/people/ldv/packages/?p=pam.git;a=commitdiff;h=Linux-PAM-1_1_2-2-gffe7058>
>
>
> --
> ldv
```
```
# Linux-PAM: Multiple vulnerabilities — GLSA **201206-31**

Multiple vulnerabilities have been found in Linux-PAM, allowing
local attackers to possibly gain escalated privileges, cause a Denial of
Service, corrupt data, or obtain sensitive information.

### Affected packages

| Package | **sys-libs/pam** on all architectures |
| --- | --- |
| Affected versions | < **1.1.5** |
| Unaffected versions | >= **1.1.5** |

### Background

Linux-PAM (Pluggable Authentication Modules) is an architecture allowing
the separation of the development of privilege granting software from the
development of secure and appropriate authentication schemes.

### Description

Multiple vulnerabilities have been discovered in Linux-PAM. Please
review the CVE identifiers referenced below for details.

### Impact

A local attacker could use specially crafted files to cause a buffer
overflow, possibly resulting in privilege escalation or Denial of
Service. Furthermore, a local attacker could execute specially crafted
programs or symlink attacks, possibly resulting in data loss or
disclosure of sensitive information.

### Workaround

There is no known workaround at this time.

### Resolution

All Linux-PAM users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=sys-libs/pam-1.1.5"

```

NOTE: This is a legacy GLSA. Updates for all affected architectures are
available since November 25, 2011. It is likely that your system is
already no longer affected by this issue.

### References

* [CVE-2010-3316](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-3316)
* [CVE-2010-3430](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-3430)
* [CVE-2010-3431](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-3431)
* [CVE-2010-3435](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-3435)
* [CVE-2010-3853](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-3853)
* [CVE-2010-4706](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-4706)
* [CVE-2010-4707](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-4707)
* [CVE-2010-4708](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2010-4708)
* [CVE-2011-3148](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2011-3148)
* [CVE-2011-3149](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2011-3149)
```
```
[**Bug 641361**](show_bug.cgi?id=641361)
(CVE-2010-3430, CVE-2010-3431)
- [CVE-2010-3430](https://access.redhat.com/security/cve/CVE-2010-3430) [CVE-2010-3431](https://access.redhat.com/security/cve/CVE-2010-3431) pam: pam\_mail and pam\_env incorrect privilege dropping
[Description](show_bug.cgi?id=641361#c0)  Tomas Hoger    2010-10-08 14:16:04 UTC  ``` The pam_mail and pam_env modules in Linux-PAM before 1.1.2 did not drop privileges before accessing users' files ([CVE-2010-3435](https://access.redhat.com/security/cve/CVE-2010-3435), see [bug #641335](show_bug.cgi?id=641335 "CLOSED ERRATA - CVE-2010-3435 pam: pam_env and pam_mail accessing users' file with root privileges")).  Privilege dropping was added in 1.1.2, but with couple of issues pointed out by Solar Designer:  [http://thread.gmane.org/gmane.comp.security.oss.general/3311/focus=3534](http://thread.gmane.org/gmane.comp.security.oss.general/3311/focus%3D3534)  The code fails to switch fsgid/egid and groups ([CVE-2010-3430](https://access.redhat.com/security/cve/CVE-2010-3430)) and does not check setfsuid() return value ([CVE-2