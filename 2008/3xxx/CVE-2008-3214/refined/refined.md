```
Message-ID: <20080630212319.GE11562@severus.strandboge.com>
Date: Mon, 30 Jun 2008 17:23:19 -0400
From: Jamie Strandboge <jamie@...onical.com>
To: oss-security@...ts.openwall.com
Subject: CVE request for dnsmasq DoS

Hi,

There is a remote DoS in dnsmasq 2.25 (and presumably earlier) that is
fixed in 2.26. Details can be found at [1]. Can we get a CVE assigned
for this?

Jamie Strandboge

[1] [https://bugs.launchpad.net/ubuntu/+source/dnsmasq/+bug/47438](https://bugs.launchpad.net/ubuntu/%2Bsource/dnsmasq/%2Bbug/47438)
```

```
Message-ID: <20080712122807.GD1437@severus.strandboge.com>
Date: Sat, 12 Jul 2008 08:28:07 -0400
From: Jamie Strandboge <jamie@...onical.com>
To: oss-security@...ts.openwall.com
Cc: coley@...us.mitre.org
Subject: Re: CVE request for dnsmasq DoS

(resending as the first one didn't make it to the list)

I finally had time to develop a PoC and confirm this on my own. A client
need only send a DHCPREQUEST for an IP address not on the same network
as dnsmasq. Eg:

1. dnsmasq listening on and giving IP addresses for 192.168.122.0/24
2. client requests IP address on another network, such as 192.168.0.1
3. dnsmasq 2.25 (and presumably earlier) crashes

This can happen in normal operation with roaming users, but can also
happen with a malicious request.
```

```
# Dnsmasq crashes when renewing non-existent lease
Binary package hint: dnsmasq
Dapper ships with version 2.25 of dnsmasq which has the above bug.
I can confirm this :
Jun 4 14:47:01 localhost dnsmasq[5542]: DHCPREQUEST(eth0) 192.168.10.104 00:11:24:35:99:a0
Jun 4 14:47:01 localhost dnsmasq[5542]: DHCPNAK(eth0) 192.168.10.104 00:11:24:35:99:a0 wrong network
Jun 4 14:47:01 localhost kernel: [46803.837739] dnsmasq[5542]: segfault at 0000000000000010 rip 00000000004139d9 rsp 00007fffff

I confirm to:
Starting DNS forwarder and DHCP server: dnsmasqdnsmasq: started, version 2.25 cachesize 150
dnsmasq: compile time options: IPv6 GNU-getopt RTNetlink ISC-leasefile no-DBus I18N
dnsmasq: DHCP, IP range 192.168.1.129 -- 192.168.1.190, lease time 12h
dnsmasq: using local addresses only for domain XXX.XXX
dnsmasq: read /etc/hosts - 13 addresses
dnsmasq: reading /etc/ppp/resolv.conf
dnsmasq: using nameserver X.X.X.X#53
dnsmasq: using nameserver X.X.X.X#53
dnsmasq: using local addresses only for domain XXX.XXX
dnsmasq: DHCPREQUEST(eth0) 192.168.82.148 00:11:24:72:44:d2
dnsmasq: DHCPNAK(eth0) 192.168.82.148 00:11:24:72:44:d2 wrong network
/etc/init.d/dnsmasq: line 49: 11669 Segmentation fault start-stop-daemon --start --quiet --pidfile /var/run/$NAME.pid --exec $DAEMON -- ${MAILHOSTNAME:+ -m $MAILHOSTNAME} ${MAILTARGET:+ -t $MAILTARGET} ${DNSMASQ\_USER:+ -u $DNSMASQ\_USER} ${DNSMASQ\_INTERFACE:+ $DNSMASQ\_INTERFACES} ${DHCP\_LEASE:+ -l $DHCP\_LEASE} ${DOMAIN\_SUFFIX:+ -s $DOMAIN\_SUFFIX} ${RESOLV\_CONF:+ -r $RESOLV\_CONF} ${CACHESIZE:+ -c $CACHESIZE} ${DNSMASQ\_OPTS:+ $DNSMASQ\_OPTS}
 (failed).
```

```
This issue has security implications, you could exploit it to (at least) crash the dnsmasq server.
I backported the fix from dnsmasq 2.26 and tested it OK.
I could not build an easy reproducer, spent a few hours around it but I guess I did not get the broadcast/martian right. Here is how I reproduce it and tested the fix :
Have one machine/VM as a DHCP client, another as DHCP server.
Make sure nobody else (including libvirt-bin !) provides DHCP service on the network the test machines are connected to.
Configure DHCP server on a network A (192.168.123.0/24 for example) to serve addresses there , with small DHCP leases
Start DHCP client so that it gets an address lease on network A (let's say 192.168.123.51)
Reconfigure network and dnsmasq on server so that it now serves a network B (192.168.122.0/24 for example)
Wait for client to try to renew its lease.
Starting at around half lease life it will try several times (and fail) to renew its lease.
At the end of the lease it will broadcast a martian DHCPREQUEST from 192.168.123.51, triggering the crash in dnsmasq :
Jun 24 10:20:28 dapper-test dnsmasq[3482]: DHCPREQUEST(eth0) 192.168.123.51 52:54:00:1a:49:e4
Jun 24 10:20:28 dapper-test dnsmasq[3482]: DHCPNAK(eth0) 192.168.123.51 52:54:00:1a:49:e4 wrong network
Jun 24 10:20:28 dapper-test kernel: [ 1766.784923] dnsmasq[3482]: segfault at 0000000000000010 rip 00000000004139d9 rsp 00007fffffb627c0 error 4
With the fixed version, we get :
Jun 24 10:25:44 dapper-test dnsmasq[3643]: DHCPREQUEST(eth0) 192.168.123.51 52:54:00:1a:49:e4
Jun 24 10:25:44 dapper-test dnsmasq[3643]: DHCPNAK(eth0) 192.168.123.51 52:54:00:1a:49:e4 wrong network
Jun 24 10:25:48 dapper-test dnsmasq[3643]: DHCPDISCOVER(eth0) 52:54:00:1a:49:e4
Jun 24 10:25:48 dapper-test dnsmasq[3643]: DHCPOFFER(eth0) 192.168.122.51 52:54:00:1a:49:e4
Jun 24 10:25:48 dapper-test dnsmasq[3643]: DHCPREQUEST(eth0) 192.168.122.51 52:54:00:1a:49:e4
Jun 24 10:25:48 dapper-test dnsmasq[3643]: DHCPACK(eth0) 192.168.122.51 52:54:00:1a:49:e4 hardy-test
```

```
dnsmasq (2.25-1ubuntu0.1) dapper-security; urgency=low

\* SECURITY UPDATE: crash when renewing a lease from clients that think
    they are on another network can be used as a denial of service attack.
  \* src/rfc2131.c: backport of the dnsmasq 2.26 fix (Fixes LP: [#47438](/bugs/47438))
  \* References
    CVE-2008-3214
```
```
Message-ID: <20080701175753.45B7E14237@faron.mitre.org>
Date: Tue, 1 Jul 2008 17:57:53 -0400 (EDT)
From: "Steven M. Christey" <coley@...us.mitre.org>
To: oss-security@...ts.openwall.com, Jamie Strandboge <jamie@...onical.com>
Subject: Re: CVE request for dnsmasq DoS

On Mon, 30 Jun 2008, Jamie Strandboge wrote:

> Hi,
>
> There is a remote DoS in dnsmasq 2.25 (and presumably earlier) that is
> fixed in 2.26. Details can be found at [1]. Can we get a CVE assigned
> for this?

I'm not sure I fully understand Thierry Carrez' comment about the security
implications of this issue.  It seems like an exploit would require a
malicious DHCP server, in which case isn't DHCP service already
compromised?  If so, then a crash of dnsmasq (null dereference?) doesn't
seem to be any worse than the loss of DHCP itself.

- Steve
```
```
Message-ID: <20080702092351.GE13234@ngolde.de>
Date: Wed, 2 Jul 2008 11:23:51 +0200
From: Nico Golde <oss-security+ml@...lde.de>
To: oss-security@...ts.openwall.com
Subject: Re: CVE request for dnsmasq DoS

Hi Steven,
* Steven M. Christey <coley@...us.mitre.org> [2008-07-02 00:05]:
> On Mon, 30 Jun 2008, Jamie Strandboge wrote:
> > There is a remote DoS in dnsmasq 2.25 (and presumably earlier) that is
> > fixed in 2.26. Details can be found at [1]. Can we get a CVE assigned
> > for this?
>
> I'm not sure I fully understand Thierry Carrez' comment about the security
> implications of this issue.  It seems like an exploit would require a
> malicious DHCP server, in which case isn't DHCP service already
> compromised?  If so, then a crash of dnsmasq (null dereference?) doesn't
> seem to be any worse than the loss of DHCP itself.

Why is a malicious DCHP server needed? As far as I
understood the bug a client that doesn't already have a
lease would just need to send a DHCPREQUEST to refresh its
non-existant lease.
Cheers
Nico
```

**Root cause of vulnerability:**
The vulnerability stems from a flaw in how `dnsmasq` handles DHCPREQUEST messages for IP addresses that are not part of the network it's configured to manage. Specifically, when a client sends a DHCPREQUEST for an IP address outside of the server's defined subnet, a crash is triggered due to a null pointer dereference.

**Weaknesses/vulnerabilities present:**
- Improper handling of DHCP requests from clients on different networks
- Lack of proper input validation to prevent null pointer dereference
- A client can cause a server crash by sending a specific type of DHCP request.

**Impact of exploitation:**
- Denial of Service (DoS): An attacker can crash the `dnsmasq` service by sending a crafted DHCPREQUEST packet. This leads to the unavailability of DHCP and DNS services, disrupting network connectivity for clients relying on `dnsmasq`.

**Attack vectors:**
- A client on the network sends a DHCPREQUEST for an IP address not on the same network as dnsmasq.
- Malicious actor crafting a DHCPREQUEST with an out-of-subnet IP address.

**Required attacker capabilities/position:**
- Network access: The attacker needs to be on the same network segment as the vulnerable `dnsmasq` server.
- DHCP knowledge:  A basic understanding of DHCP protocol, especially the DHCPREQUEST message.
- Ability to send network packets: The attacker needs to be able to send network packets such as using scapy library.