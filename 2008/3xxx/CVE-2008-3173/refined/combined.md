=== Content from kuza55.blogspot.com_ac82a4ea_20250124_211620.html ===


[skip to main](#main)  |
[skip to sidebar](#sidebar)

# [Alex's Corner](http://kuza55.blogspot.com/)

## Friday, February 22, 2008

### Understanding Cookie Security

Whenever anyone decides to talk about XSS, one thing which is sure to pop up is the Same Origin Policy which XSS avoids by being reflected by the server. The Same Origin Policy is the security restriction which make sure that any pages trying to communicate via JavaScript are on the same protocol, domain and port. However this is misleading since it is not the weakest link that browsers have between domains.

The weakest link across domains is (for lack of a better term) the cookie policy which determines which domains can set cookies for which domains and which cookies each domain receives.

## What's in a cookie

The cookies we use have several fields, including these ones I want to talk about:

* Name

* Value

* Domain

* Path

* Expires

First, it must be noticed that the protocol restriction which is explicit in the Same Origin policy is here implicit, since cookies are an extension to HTTP, and so would only be sent for http, however the distinction between http and https is only enforced if the Secure flag is set.

Secondly, unlike the same origin policy, the cookie policy has no restrictions on ports, explicit or implicit.

And furthermore the domain check is not exact. From RFC 2109:
```
   Hosts names can be specified either as an IP address or a FQHN
  string.  Sometimes we compare one host name with another.  Host A's
  name domain-matches host B's if

  * both host names are IP addresses and their host name strings match
    exactly; or

  * both host names are FQDN strings and their host name strings match
    exactly; or

  * A is a FQDN string and has the form NB, where N is a non-empty name
    string, B has the form .B', and B' is a FQDN string.  (So, x.y.com
    domain-matches .y.com but not y.com.)

  Note that domain-match is not a commutative operation: a.b.c.com
  domain-matches .c.com, but not the reverse.
```

Effectively, this means that that any subdomains of a given domain can set, and is sent the cookies for that domain, i.e. news.google.com can set, and is sent the cookies for .google.com. Furthermore a second subdomain, e.g. mail.google.com can also set, and is sent the cookies for .google.com - This effectively means that by setting a cookie for google.com, news.google.com can force the user's browser to send a cookie to mail.google.com.

## Resolving Conflicts

But what if two cookies of the same name should be sent to a given page, e.g. if there is a cookie called "user" set for mail.google.com and .google.com with different values, how does the browser decide which one to send?

RFC 2109 states that the cookie with the more specific path attribute must be sent first, however it does not define how to deal with two cookies which have the same path (e.g. /) but different domains. If such a conflict occurs then most (all?) browsers simply send the older cookie first.

This means that if we want to overwrite a cookie on mail.google.com from the subdomain news.google.com, and the cookie already exists, then we cannot over-write a cookie with the path value of / (or whatever the path value of the existing cookie is), but we can override it for every other path (up to the maximum number of cookies allowed per host; 50 in IE/Firefox 30 in Opera), i.e. if we pick 50 (or 30 if we want to target opera) paths on mail.google.com which encompass the directories and pages we want to overwrite the cookie for, we can simply set 50 /30 separate cookies which are all more specific than the existing cookie.

Technically the spec say that a.b.c.d cannot set a cookie for a.b.c.d or b.c.d only, none of the browsers enforce this since it breaks sites. Also, sites should not be able to set a cookie with a path attribute which would not apply to the current page, but since path boundaries are non-existant in browsers, no-one enforces this restriction either.

## Cross-Site Cooking

When you think about the problem in the above scenario, you end up asking; can I use the same technique to send a cookie from news.com to mail.com? Or some similar scenario where you are going from one privately owned domain to another in a public registry. The RFC spec did foresee this to some degree and came up with the "one dot rule", i.e. that you can't set a cookie for a domain which does not have an embedded dot, e.g. you cannot set a cookie for .com or .net, etc.

What the spec did not foresee is the creation of public registries such as co.uk which do contain an embedded dot. And this is where the fun begins, since there is no easy solution for this, and the RFC has no standard solution, all the browsers pretty much did their own thing.

IE has the least interesting and most restrictive system; you cannot set a cookie for a two letter domain of the form ab.xy or (com|net|org|gov|edu).xy. [Supposedly](http://support.microsoft.com/kb/310676) there is a key in the registry at HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\SpecialDomains which will let you whitelist a domain to allow ab.xy to be set and my registry has the value "lp. rg." for that key, but I haven't been able to set a cookie for ab.pl or ab.rg so go figure.

Opera on the other hand has perhaps the most interesting system of all the browser vendors. Opera does a DNS lookup on the domain you are trying to set a cookie for, and if it finds an A record (i.e. the domain has an IP address associated with it) then you can set a cookie for it. So if ab.xy resolves to an IP then you can set a cookie for it, however this breaks if the TLD resolves, as is the case for co.tv

Firefox 2 seems to have no protections. I was unable to find any protections in the source and was able to get foobar.co.uk to set cookies for .co.uk, so ummm, why does no-one ever mention this? I have no clue....

Firefox 3 on the other hand has a huge list of all the domains for which you cannot set cookies, which you can view online [here](http://mxr.mozilla.org/firefox/source/netwerk/dns/src/effective_tld_names.dat). Hurray for blacklists.....

## Exhausting Cookie Limits

Another interesting aspect of cookies is that there is a limit on how many cookies can be stored, not only per host, but in total, at least in Firefox and Opera. IE doesn't seem to have such a restriction.

In Firefox the global limit is 1000 cookies with 50 per host (1.evil.com and 2.evil.com are different hosts), and on Opera it is 65536 cookies with 30 per host. IE does not seem to have a global limit but does have a host limit of 50 cookies. When you reach the global limit, both browsers go with the RFC recommendation and start deleting cookies.

Both Firefox and Opera simply choose to delete the oldest cookies, and so by setting either 1000 or 65536 cookies depending on the browser, you effectively clear the user's cookie of anything another domain has set.

## Conclusion

By either setting the path attribute to point to more specific pages we can effectively overwrite cookies from other domains that we can set cookies for, which includes all the co.xy domains. Also, if we are attacking Firefox or Opera we can simply delete the existing cookies if we need to force our cookie to be sent to a path for which a cookie is already set (e.g. /).

You may also be able to induce some weird states, if you somehow manage to only delete one cookie where an applicaiton expects two, or similar, but I doubt that would be very exploitable.

Posted by

[kuza55](https://www.blogger.com/profile/03932544559060480887 "author profile")

at

[Friday, February 22, 2008](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_email.gif)](https://www.blogger.com/email-post/23714519/1863497989971540833 "Email Post")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=23714519&postID=1863497989971540833&from=pencil "Edit Post")

Labels:
[HTTP](http://kuza55.blogspot.com/search/label/HTTP),
[Security (All)](http://kuza55.blogspot.com/search/label/Security%20%28All%29),
[Web App Sec](http://kuza55.blogspot.com/search/label/Web%20App%20Sec)

#### 2 comments:

![](//resources.blogblog.com/img/blank.gif "Anonymous")

Anonymous
said...

I believe you would be interested in http://publicsuffix.org/, as it describes how Mozilla is handling the issue with Firefox.

[25 February 2008 at 11:35 pm](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html?showComment=1203942900000#c1812186043002280265 "comment permalink")
[![](https://resources.blogblog.com/img/icon_delete13.gif)](https://www.blogger.com/delete-comment.g?blogID=23714519&postID=1812186043002280265 "Delete Comment")

![](//resources.blogblog.com/img/blank.gif "Anonymous")

Anonymous
said...

Thanks for useful article. Is it secure to delete cookies with this program: [History Cleaner](http://www.historykillerpro.com)?

[20 February 2009 at 11:13 pm](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html?showComment=1235131980000#c8916464780948799947 "comment permalink")
[![](https://resources.blogblog.com/img/icon_delete13.gif)](https://www.blogger.com/delete-comment.g?blogID=23714519&postID=8916464780948799947 "Delete Comment")

[Post a Comment](https://www.blogger.com/comment/fullpage/post/23714519/1863497989971540833)

[Newer Post](http://kuza55.blogspot.com/2008/02/exploiting-logged-out-xss.html "Newer Post")

[Older Post](http://kuza55.blogspot.com/2008/02/csrf-ing-file-upload-fields.html "Older Post")

[Home](http://kuza55.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](http://kuza55.blogspot.com/feeds/1863497989971540833/comments/default)

## About

This blog is primarily a place for me to post my own research, papers and random ideas. Most likely I'm not going to be commenting on things happening in security.

As such it will most likely not be updated very often.

Name: Alex
Alias: kuza55
Email: kuza55@gmail.com

You can also find me on the temporary sla.ckers.org channel:
irc.irchighway.net #slackers

## Web App Sec Blogs

* [ha.ckers.org (RSnake)](http://ha.ckers.org/)
* [Sylvan von Stuppe](http://sylvanvonstuppe.blogspot.com/)
* [Wisec (Stefano Di Paola)](http://www.wisec.it/sectou.php)
* [PHP Security Blog (Stefan Esser)](http://blog.php-security.org/)
* [It's a shampoo world anyway (Martin Johns)](http://shampoo.antville.org/)
* [Jeremiah Grossman's Blog](http://jeremiahgrossman.blogspot.com/)
* [Portswigger](http://blog.portswigger.net/)
* [Mephisto's Mind](http://mephistosmind.blogspot.com/)
* [p42 labs (thornmaker)](http://p42.us/)
* [0x000000 (Ronald van den Heetkamp)](http://www.0x000000.com/)
* [christian's weblog (christ1an)](http://christ1an.blogspot.com/)
* [Web App Security journ(ey)al (Kishor)](http://wasjournal.blogspot.com/)
* [RETURN $ecure; (Kyran)](http://kyran.wordpress.com/)
* [Disenchant's Blog](http://www.disenchant.ch/blog/)

## Security Blogs

* [Taking Network Security to the Streets (Ronald Koh)](http://hackathology.blogspot.com/)
* [Exhaustive Search (Matt Blaze)](http://www.crypto.com/blog/)
* [Adventures of the White Rabbit (tibbar)](http://www.tibbar.org/)

## Ezines

* [Uninformed](http://www.uninformed.org/)
* [.aware](http://www.awarenetwork.org/)
* [Phrack](http://www.phrack.org/)
* [K-1ine](http://www.nettwerked.net/files.html#K1INE)

## Other Sites

* [XSSed (XSS Archive w/ Mirror)](http://www.xssed.com/)
* [Hack In The Box](http://www.hackinthebox.org/)
* [CAcert](http://www.cacert.org/)

## Labels

* [Conferences](http://kuza55.blogspot.com/search/label/Conferences)
  (3)
* [CSRF](http://kuza55.blogspot.com/search/label/CSRF)
  (4)
* [Detection](http://kuza55.blogspot.com/search/label/Detection)
  (8)
* [DNS](http://kuza55.blogspot.com/search/label/DNS)
  (1)
* [Encoding](http://kuza55.blogspot.com/search/label/Encoding)
  (2)
* [Extension Hacking](http://kuza55.blogspot.com/search/label/Extension%20Hacking)
  (3)
* [Firefox](http://kuza55.blogspot.com/search/label/Firefox)
  (16)
* [General Security](http://kuza55.blogspot.com/search/label/General%20Security)
  (12)
* [HTTP](http://kuza55.blogspot.com/search/label/HTTP)
  (9)
* [IE](http://kuza55.blogspot.com/search/label/IE)
  (2)
* [Javascript](http://kuza55.blogspot.com/search/label/Javascript)
  (16)
* [MySpace](http://kuza55.blogspot.com/search/label/MySpace)
  (6)
* [Phishing](http://kuza55.blogspot.com/search/label/Phishing)
  (1)
* [PHP](http://kuza55.blogspot.com/search/label/PHP)
  (5)
* [RCSR](http://kuza55.blogspot.com/search/label/RCSR)
  (3)
* [Security (All)](http://kuza55.blogspot.com/search/label/Security%20%28All%29)
  (67)
* [SSO](http://kuza55.blogspot.com/search/label/SSO)
  (3)
* [Web App Sec](http://kuza55.blogspot.com/search/label/Web%20App%20Sec)
  (58)
* [XSS](http://kuza55.blogspot.com/search/label/XSS)
  (35)

## Blog Archive

* ►
  [2009](http://kuza55.blogspot.com/2009/)
  (1)
  + ►
    [July](http://kuza55.blogspot.com/2009/07/)
    (1)

* ▼
  [2008](http://kuza55.blogspot.com/2008/)
  (17)
  + ►
    [September](http://kuza55.blogspot.com/2008/09/)
    (2)
  + ►
    [August](http://kuza55.blogspot.com/2008/08/)
    (2)
  + ►
    [July](http://kuza55.blogspot.com/2008/07/)
    (4)
  + ►
    [June](http://kuza55.blogspot.com/2008/06/)
    (1)
  + ►
    [April](http://kuza55.blogspot.com/2008/04/)
    (1)
  + ▼
    [February](http://kuza55.blogspot.com/2008/02/)
    (6)
    - [HTTP Range & Request-Range Request Headers](http://kuza55.blogspot.com/2008/02/http-range-request-range-request.html)
    - [Racing to downgrade users to cookie-less authentic...](http://kuza55.blogspot.com/2008/02/racing-to-downgrade-users-to-cookie.html)
    - [Exploiting CSRF Protected XSS](http://kuza55.blogspot.com/2008/02/exploiting-csrf-protected-xss.html)
    - [Exploiting Logged Out XSS Vulnerabilities](http://kuza55.blogspot.com/2008/02/exploiting-logged-out-xss.html)
    - [Understanding Cookie Security](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html)
    - [CSRF-ing File Upload Fields](http://kuza55.blogspot.com/2008/02/csrf-ing-file-upload-fields.html)
  + ►
    [January](http://kuza55.blogspot.com/2008/01/)
    (1)

* ►
  [2007](http://kuza55.blogspot.com/2007/)
  (48)
  + ►
    [October](http://kuza55.blogspot.com/2007/10/)
    (1)
  + ►
    [July](http://kuza55.blogspot.com/2007/07/)
    (2)
  + ►
    [June](http://kuza55.blogspot.com/2007/06/)
    (3)
  + ►
    [May](http://kuza55.blogspot.com/2007/05/)
    (2)
  + ►
    [April](http://kuza55.blogspot.com/2007/04/)
    (4)
  + ►
    [March](http://kuza55.blogspot.com/2007/03/)
    (4)
  + ►
    [February](http://kuza55.blogspot.com/2007/02/)
    (18)
  + ►
    [January](http://kuza55.blogspot.com/2007/01/)
    (14)

* ►
  [2006](http://kuza55.blogspot.com/2006/)
  (17)
  + ►
    [December](http://kuza55.blogspot.com/2006/12/)
    (3)
  + ►
    [November](http://kuza55.blogspot.com/2006/11/)
    (2)
  + ►
    [October](http://kuza55.blogspot.com/2006/10/)
    (5)
  + ►
    [April](http://kuza55.blogspot.com/2006/04/)
    (2)
  + ►
    [March](http://kuza55.blogspot.com/2006/03/)
    (5)

[![who"s online](http://whos.amung.us/widget/xc5b9oga)](http://whos.amung.us/show/xc5b9oga)


