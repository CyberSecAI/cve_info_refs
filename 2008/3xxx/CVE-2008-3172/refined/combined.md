=== Content from kuza55.blogspot.com_ac82a4ea_20250124_181716.html ===


[skip to main](#main)  |
[skip to sidebar](#sidebar)

# [Alex's Corner](http://kuza55.blogspot.com/)

## Friday, February 22, 2008

### Understanding Cookie Security

Whenever anyone decides to talk about XSS, one thing which is sure to pop up is the Same Origin Policy which XSS avoids by being reflected by the server. The Same Origin Policy is the security restriction which make sure that any pages trying to communicate via JavaScript are on the same protocol, domain and port. However this is misleading since it is not the weakest link that browsers have between domains.

The weakest link across domains is (for lack of a better term) the cookie policy which determines which domains can set cookies for which domains and which cookies each domain receives.

## What's in a cookie

The cookies we use have several fields, including these ones I want to talk about:

* Name

* Value

* Domain

* Path

* Expires

First, it must be noticed that the protocol restriction which is explicit in the Same Origin policy is here implicit, since cookies are an extension to HTTP, and so would only be sent for http, however the distinction between http and https is only enforced if the Secure flag is set.

Secondly, unlike the same origin policy, the cookie policy has no restrictions on ports, explicit or implicit.

And furthermore the domain check is not exact. From RFC 2109:
```
   Hosts names can be specified either as an IP address or a FQHN
  string.  Sometimes we compare one host name with another.  Host A's
  name domain-matches host B's if

  * both host names are IP addresses and their host name strings match
    exactly; or

  * both host names are FQDN strings and their host name strings match
    exactly; or

  * A is a FQDN string and has the form NB, where N is a non-empty name
    string, B has the form .B', and B' is a FQDN string.  (So, x.y.com
    domain-matches .y.com but not y.com.)

  Note that domain-match is not a commutative operation: a.b.c.com
  domain-matches .c.com, but not the reverse.
```

Effectively, this means that that any subdomains of a given domain can set, and is sent the cookies for that domain, i.e. news.google.com can set, and is sent the cookies for .google.com. Furthermore a second subdomain, e.g. mail.google.com can also set, and is sent the cookies for .google.com - This effectively means that by setting a cookie for google.com, news.google.com can force the user's browser to send a cookie to mail.google.com.

## Resolving Conflicts

But what if two cookies of the same name should be sent to a given page, e.g. if there is a cookie called "user" set for mail.google.com and .google.com with different values, how does the browser decide which one to send?

RFC 2109 states that the cookie with the more specific path attribute must be sent first, however it does not define how to deal with two cookies which have the same path (e.g. /) but different domains. If such a conflict occurs then most (all?) browsers simply send the older cookie first.

This means that if we want to overwrite a cookie on mail.google.com from the subdomain news.google.com, and the cookie already exists, then we cannot over-write a cookie with the path value of / (or whatever the path value of the existing cookie is), but we can override it for every other path (up to the maximum number of cookies allowed per host; 50 in IE/Firefox 30 in Opera), i.e. if we pick 50 (or 30 if we want to target opera) paths on mail.google.com which encompass the directories and pages we want to overwrite the cookie for, we can simply set 50 /30 separate cookies which are all more specific than the existing cookie.

Technically the spec say that a.b.c.d cannot set a cookie for a.b.c.d or b.c.d only, none of the browsers enforce this since it breaks sites. Also, sites should not be able to set a cookie with a path attribute which would not apply to the current page, but since path boundaries are non-existant in browsers, no-one enforces this restriction either.

## Cross-Site Cooking

When you think about the problem in the above scenario, you end up asking; can I use the same technique to send a cookie from news.com to mail.com? Or some similar scenario where you are going from one privately owned domain to another in a public registry. The RFC spec did foresee this to some degree and came up with the "one dot rule", i.e. that you can't set a cookie for a domain which does not have an embedded dot, e.g. you cannot set a cookie for .com or .net, etc.

What the spec did not foresee is the creation of public registries such as co.uk which do contain an embedded dot. And this is where the fun begins, since there is no easy solution for this, and the RFC has no standard solution, all the browsers pretty much did their own thing.

IE has the least interesting and most restrictive system; you cannot set a cookie for a two letter domain of the form ab.xy or (com|net|org|gov|edu).xy. [Supposedly](http://support.microsoft.com/kb/310676) there is a key in the registry at HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\SpecialDomains which will let you whitelist a domain to allow ab.xy to be set and my registry has the value "lp. rg." for that key, but I haven't been able to set a cookie for ab.pl or ab.rg so go figure.

Opera on the other hand has perhaps the most interesting system of all the browser vendors. Opera does a DNS lookup on the domain you are trying to set a cookie for, and if it finds an A record (i.e. the domain has an IP address associated with it) then you can set a cookie for it. So if ab.xy resolves to an IP then you can set a cookie for it, however this breaks if the TLD resolves, as is the case for co.tv

Firefox 2 seems to have no protections. I was unable to find any protections in the source and was able to get foobar.co.uk to set cookies for .co.uk, so ummm, why does no-one ever mention this? I have no clue....

Firefox 3 on the other hand has a huge list of all the domains for which you cannot set cookies, which you can view online [here](http://mxr.mozilla.org/firefox/source/netwerk/dns/src/effective_tld_names.dat). Hurray for blacklists.....

## Exhausting Cookie Limits

Another interesting aspect of cookies is that there is a limit on how many cookies can be stored, not only per host, but in total, at least in Firefox and Opera. IE doesn't seem to have such a restriction.

In Firefox the global limit is 1000 cookies with 50 per host (1.evil.com and 2.evil.com are different hosts), and on Opera it is 65536 cookies with 30 per host. IE does not seem to have a global limit but does have a host limit of 50 cookies. When you reach the global limit, both browsers go with the RFC recommendation and start deleting cookies.

Both Firefox and Opera simply choose to delete the oldest cookies, and so by setting either 1000 or 65536 cookies depending on the browser, you effectively clear the user's cookie of anything another domain has set.

## Conclusion

By either setting the path attribute to point to more specific pages we can effectively overwrite cookies from other domains that we can set cookies for, which includes all the co.xy domains. Also, if we are attacking Firefox or Opera we can simply delete the existing cookies if we need to force our cookie to be sent to a path for which a cookie is already set (e.g. /).

You may also be able to induce some weird states, if you somehow manage to only delete one cookie where an applicaiton expects two, or similar, but I doubt that would be very exploitable.

Posted by

[kuza55](https://www.blogger.com/profile/03932544559060480887 "author profile")

at

[Friday, February 22, 2008](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_email.gif)](https://www.blogger.com/email-post/23714519/1863497989971540833 "Email Post")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=23714519&postID=1863497989971540833&from=pencil "Edit Post")

Labels:
[HTTP](http://kuza55.blogspot.com/search/label/HTTP),
[Security (All)](http://kuza55.blogspot.com/search/label/Security%20%28All%29),
[Web App Sec](http://kuza55.blogspot.com/search/label/Web%20App%20Sec)

#### 2 comments:

![](//resources.blogblog.com/img/blank.gif "Anonymous")

Anonymous
said...

I believe you would be interested in http://publicsuffix.org/, as it describes how Mozilla is handling the issue with Firefox.

[25 February 2008 at 11:35 pm](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html?showComment=1203942900000#c1812186043002280265 "comment permalink")
[![](https://resources.blogblog.com/img/icon_delete13.gif)](https://www.blogger.com/delete-comment.g?blogID=23714519&postID=1812186043002280265 "Delete Comment")

![](//resources.blogblog.com/img/blank.gif "Anonymous")

Anonymous
said...

Thanks for useful article. Is it secure to delete cookies with this program: [History Cleaner](http://www.historykillerpro.com)?

[20 February 2009 at 11:13 pm](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html?showComment=1235131980000#c8916464780948799947 "comment permalink")
[![](https://resources.blogblog.com/img/icon_delete13.gif)](https://www.blogger.com/delete-comment.g?blogID=23714519&postID=8916464780948799947 "Delete Comment")

[Post a Comment](https://www.blogger.com/comment/fullpage/post/23714519/1863497989971540833)

[Newer Post](http://kuza55.blogspot.com/2008/02/exploiting-logged-out-xss.html "Newer Post")

[Older Post](http://kuza55.blogspot.com/2008/02/csrf-ing-file-upload-fields.html "Older Post")

[Home](http://kuza55.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](http://kuza55.blogspot.com/feeds/1863497989971540833/comments/default)

## About

This blog is primarily a place for me to post my own research, papers and random ideas. Most likely I'm not going to be commenting on things happening in security.

As such it will most likely not be updated very often.

Name: Alex
Alias: kuza55
Email: kuza55@gmail.com

You can also find me on the temporary sla.ckers.org channel:
irc.irchighway.net #slackers

## Web App Sec Blogs

* [ha.ckers.org (RSnake)](http://ha.ckers.org/)
* [Sylvan von Stuppe](http://sylvanvonstuppe.blogspot.com/)
* [Wisec (Stefano Di Paola)](http://www.wisec.it/sectou.php)
* [PHP Security Blog (Stefan Esser)](http://blog.php-security.org/)
* [It's a shampoo world anyway (Martin Johns)](http://shampoo.antville.org/)
* [Jeremiah Grossman's Blog](http://jeremiahgrossman.blogspot.com/)
* [Portswigger](http://blog.portswigger.net/)
* [Mephisto's Mind](http://mephistosmind.blogspot.com/)
* [p42 labs (thornmaker)](http://p42.us/)
* [0x000000 (Ronald van den Heetkamp)](http://www.0x000000.com/)
* [christian's weblog (christ1an)](http://christ1an.blogspot.com/)
* [Web App Security journ(ey)al (Kishor)](http://wasjournal.blogspot.com/)
* [RETURN $ecure; (Kyran)](http://kyran.wordpress.com/)
* [Disenchant's Blog](http://www.disenchant.ch/blog/)

## Security Blogs

* [Taking Network Security to the Streets (Ronald Koh)](http://hackathology.blogspot.com/)
* [Exhaustive Search (Matt Blaze)](http://www.crypto.com/blog/)
* [Adventures of the White Rabbit (tibbar)](http://www.tibbar.org/)

## Ezines

* [Uninformed](http://www.uninformed.org/)
* [.aware](http://www.awarenetwork.org/)
* [Phrack](http://www.phrack.org/)
* [K-1ine](http://www.nettwerked.net/files.html#K1INE)

## Other Sites

* [XSSed (XSS Archive w/ Mirror)](http://www.xssed.com/)
* [Hack In The Box](http://www.hackinthebox.org/)
* [CAcert](http://www.cacert.org/)

## Labels

* [Conferences](http://kuza55.blogspot.com/search/label/Conferences)
  (3)
* [CSRF](http://kuza55.blogspot.com/search/label/CSRF)
  (4)
* [Detection](http://kuza55.blogspot.com/search/label/Detection)
  (8)
* [DNS](http://kuza55.blogspot.com/search/label/DNS)
  (1)
* [Encoding](http://kuza55.blogspot.com/search/label/Encoding)
  (2)
* [Extension Hacking](http://kuza55.blogspot.com/search/label/Extension%20Hacking)
  (3)
* [Firefox](http://kuza55.blogspot.com/search/label/Firefox)
  (16)
* [General Security](http://kuza55.blogspot.com/search/label/General%20Security)
  (12)
* [HTTP](http://kuza55.blogspot.com/search/label/HTTP)
  (9)
* [IE](http://kuza55.blogspot.com/search/label/IE)
  (2)
* [Javascript](http://kuza55.blogspot.com/search/label/Javascript)
  (16)
* [MySpace](http://kuza55.blogspot.com/search/label/MySpace)
  (6)
* [Phishing](http://kuza55.blogspot.com/search/label/Phishing)
  (1)
* [PHP](http://kuza55.blogspot.com/search/label/PHP)
  (5)
* [RCSR](http://kuza55.blogspot.com/search/label/RCSR)
  (3)
* [Security (All)](http://kuza55.blogspot.com/search/label/Security%20%28All%29)
  (67)
* [SSO](http://kuza55.blogspot.com/search/label/SSO)
  (3)
* [Web App Sec](http://kuza55.blogspot.com/search/label/Web%20App%20Sec)
  (58)
* [XSS](http://kuza55.blogspot.com/search/label/XSS)
  (35)

## Blog Archive

* ►
  [2009](http://kuza55.blogspot.com/2009/)
  (1)
  + ►
    [July](http://kuza55.blogspot.com/2009/07/)
    (1)

* ▼
  [2008](http://kuza55.blogspot.com/2008/)
  (17)
  + ►
    [September](http://kuza55.blogspot.com/2008/09/)
    (2)
  + ►
    [August](http://kuza55.blogspot.com/2008/08/)
    (2)
  + ►
    [July](http://kuza55.blogspot.com/2008/07/)
    (4)
  + ►
    [June](http://kuza55.blogspot.com/2008/06/)
    (1)
  + ►
    [April](http://kuza55.blogspot.com/2008/04/)
    (1)
  + ▼
    [February](http://kuza55.blogspot.com/2008/02/)
    (6)
    - [HTTP Range & Request-Range Request Headers](http://kuza55.blogspot.com/2008/02/http-range-request-range-request.html)
    - [Racing to downgrade users to cookie-less authentic...](http://kuza55.blogspot.com/2008/02/racing-to-downgrade-users-to-cookie.html)
    - [Exploiting CSRF Protected XSS](http://kuza55.blogspot.com/2008/02/exploiting-csrf-protected-xss.html)
    - [Exploiting Logged Out XSS Vulnerabilities](http://kuza55.blogspot.com/2008/02/exploiting-logged-out-xss.html)
    - [Understanding Cookie Security](http://kuza55.blogspot.com/2008/02/understanding-cookie-security.html)
    - [CSRF-ing File Upload Fields](http://kuza55.blogspot.com/2008/02/csrf-ing-file-upload-fields.html)
  + ►
    [January](http://kuza55.blogspot.com/2008/01/)
    (1)

* ►
  [2007](http://kuza55.blogspot.com/2007/)
  (48)
  + ►
    [October](http://kuza55.blogspot.com/2007/10/)
    (1)
  + ►
    [July](http://kuza55.blogspot.com/2007/07/)
    (2)
  + ►
    [June](http://kuza55.blogspot.com/2007/06/)
    (3)
  + ►
    [May](http://kuza55.blogspot.com/2007/05/)
    (2)
  + ►
    [April](http://kuza55.blogspot.com/2007/04/)
    (4)
  + ►
    [March](http://kuza55.blogspot.com/2007/03/)
    (4)
  + ►
    [February](http://kuza55.blogspot.com/2007/02/)
    (18)
  + ►
    [January](http://kuza55.blogspot.com/2007/01/)
    (14)

* ►
  [2006](http://kuza55.blogspot.com/2006/)
  (17)
  + ►
    [December](http://kuza55.blogspot.com/2006/12/)
    (3)
  + ►
    [November](http://kuza55.blogspot.com/2006/11/)
    (2)
  + ►
    [October](http://kuza55.blogspot.com/2006/10/)
    (5)
  + ►
    [April](http://kuza55.blogspot.com/2006/04/)
    (2)
  + ►
    [March](http://kuza55.blogspot.com/2006/03/)
    (5)

[![who"s online](http://whos.amung.us/widget/xc5b9oga)](http://whos.amung.us/show/xc5b9oga)



=== Content from bugzilla.mozilla.org_42d00fe7_20250124_181718.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/252342)
* [XML](/show_bug.cgi?ctype=xml&id=252342)

Closed
[Bug 252342](/show_bug.cgi?id=252342)

Opened 21 years ago
Closed 17 years ago

# fix cookie domain checks to not allow .co.uk

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

fix cookie domain checks to not allow .co.uk

## Categories

### (Core :: Networking: Cookies, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20Cookies#Networking%3A%20Cookies)

Networking: Cookies
▾

Core :: Networking: Cookies
A general mechanism which server side connections (such as CGI scripts) can use to both store and retrieve information on the client side of the connection. This refers to HTML cookies; little blobs of data we store and share with sites
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20Cookies)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla1.9alpha8

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: dwitte, Assigned: dwitte)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/a1c33ee327ed209ba819902f4abe5bb4?d=mm&size=40)  [dwitte](/user_profile?user_id=75420)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/a1c33ee327ed209ba819902f4abe5bb4?d=mm&size=40)  [dwitte](/user_profile?user_id=75420)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/608e04ebca94be52b05c003d51d43e07?d=mm&size=40)  [kershaw](/user_profile?user_id=505624)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

55 people

## References

### ( [URL](http://www.wangrepublic.org/daniel/mozilla/prefs/security#p00039 "http://www.wangrepublic.org/daniel/mozilla/prefs/security#p00039") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[385299](/show_bug.cgi?id=385299 "RESOLVED FIXED - use eTLD in cookies (stop sites setting cookies for the entire \".co.uk\" domain)")

[331510](/show_bug.cgi?id=331510 "RESOLVED FIXED - Add knowledge of subdomains to necko (create nsEffectiveTLDService)")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=252342&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=252342)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[66383](/show_bug.cgi?id=66383 "RESOLVED DUPLICATE - Cookies stored from .co.uk top level domain"), [253763](/show_bug.cgi?id=253763 "VERIFIED DUPLICATE - firefox sending cookies to wrong site if the top level domain is a country code."), [256699](/show_bug.cgi?id=256699 "RESOLVED DUPLICATE - Cookies for the originating website option ignored."), [301055](/show_bug.cgi?id=301055 "RESOLVED DUPLICATE - its possible to set cookies scoped to .co.uk domain and read at other .co.uk sites")

[431517](/show_bug.cgi?id=431517 "RESOLVED DUPLICATE - blocking cookies from \"co.uk\" blocks all cookies from \"anydomain.co.uk\"")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[wangrepublic.org/daniel/mozilla/prefs...](http://www.wangrepublic.org/daniel/mozilla/prefs/security#p00039 "http://www.wangrepublic.org/daniel/mozilla/prefs/security#p00039")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[launchpad.net/bugs/44062](https://launchpad.net/bugs/44062 "https://launchpad.net/bugs/44062")

## Details

### (Whiteboard: [sg:low dos][no l10n impact][would take patch])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:low dos][no l10n impact][would take patch]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

16

Bug Flags:

| [asa](/user_profile?user_id=5003) | [blocking1.8b3](#a28582643_5003 "20 years ago") | - |
| --- | --- | --- |
| [asa](/user_profile?user_id=5003) | blocking1.8b3 | - |
| --- | --- | --- |
| [mconnor](/user_profile?user_id=96908) | [blocking1.8b5](#c0 "20 years ago") | - |
| --- | --- | --- |
| [mconnor](/user_profile?user_id=96908) | blocking1.8b5 | - |
| --- | --- | --- |
| [dbaron](/user_profile?user_id=3881) | [blocking1.9](#a64284984_3881 "18 years ago") | - |
| --- | --- | --- |
| [dbaron](/user_profile?user_id=3881) | blocking1.9 | - |
| --- | --- | --- |
| [reed](/user_profile?user_id=159758) | [wanted1.9](#a110121230_159758 "17 years ago") | + |
| --- | --- | --- |
| [reed](/user_profile?user_id=159758) | wanted1.9 | + |
| --- | --- | --- |
| [beltzner](/user_profile?user_id=137548) | [blocking1.8.1](#c0 "18 years ago") | - |
| --- | --- | --- |
| [beltzner](/user_profile?user_id=137548) | blocking1.8.1 | - |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.1.x](#a107916962_1689 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.1.x | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.8.0.7](#a64733436_1689 "18 years ago") | - |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.8.0.7 | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [work in progress patch](/attachment.cgi?id=169106)  [20 years ago](#c32)  [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175)   8.79 KB, patch |  | [Details](/attachment.cgi?id=169106&action=edit) | [Diff](/attachment.cgi?id=169106&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=252342&attachment=169106) |
| --- | --- | --- |
| [Php script to create a bulk of cookies which might produce size-overflows in server requests.](/attachment.cgi?id=224722)  [19 years ago](#c73)  [Lars Schöning](/user_profile?user_id=191529)   381 bytes, text/plain |  | [Details](/attachment.cgi?id=224722&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=252342#c0)• 21 years ago |
|  | |

Title: Multiple Browser Cookie Injection Vulnerabilities
Risk Rating: Moderate
Software: Multiple Web Browsers
Platforms: Unix and Windows
Author: Paul Johnston <paul@westpoint.ltd.uk>
assisted by Richard Moore <rich@westpoint.ltd.uk>
Date: 20 July 2004
Advisory ID#: wp-04-0001
CVE: <pending>
Overview
--------
A design goal for cookies is to "prevent the sharing of session
information between hosts that are in different domains." [1] It appears
current implementations are successful at allowing a domain to keep its
cookies private. However, multiple mechanisms have been discovered for one
domain to inject cookies into another. These could be used to perform
session fixation attacks against web applications. [2]
(14:30:08) Chris:
Cross-Domain Cookie Injection
-----------------------------
Vulnerable: Internet Explorer, Konqueror, Mozilla
By default, cookies are only sent to the host that issued them. There is
an optonal "domain" attribute that overrides this behaviour. For example,
red.example.com could set a cookie with domain=.example.com. This would
then be sent to any host in the .example.com domain.
There is potential for abuse here, consider the case where red.example.com
sets a cookie with domain=.com. In principle this would be sent to any
host in the .com domain. However [1] requires browsers to reject cookies
where:
"The value for the Domain attribute contains no embedded dots"
This prevents a cookie being set with domain=.com. However, this does not
extend to country domains that are split into two parts. For example,
red.example.co.uk could set a cookie with domain=.co.uk and this will be
sent to all hosts in the .co.uk domain. Mozilla follows the RFC exactly
and is vulnerable to this. Konqueror and Internet Explorer have some
further protection, preventing domains of the following forms:
\* Where the 2nd level domain is two or fewer characters, i.e. xx.yy or
x.yy
\* Domains of the form (com|net|mil|org|gov|edu|int).yy
This does prevent .co.uk cross domain cookie injection but does not
protect all domains. For example, the the following .uk domains are
unprotected:
.ltd.uk
.plc.uk
.sch.uk
.nhs.uk
.police.uk
.mod.uk
Interestingly, some old Netscape documentation [3] specifies the following
restriction:
(14:30:29) Chris: "Any domain in the COM, EDU, NET, ORG, GOV, MIL, and INT
categories
requires only two periods; all other domains require at least three
periods."
This is what Opera does. It seems a sensible choice as it tends more
towards "accept only known good input" rather than "reject known bad
input", a principle of secure design.
Example exploitation:
1) <http://example.ltd.uk/> is identified for attack. It uses the "sid"
cookie to hold the session ID.
2) Attacker obtains attacker.ltd.uk domain
3) User is enticed to click link to <http://attacker.ltd.uk/>
4) This site sets the "sid" cookie with domain=.ltd.uk
5) When user logs into example.ltd.uk, they are using a sesion ID known
to the attacker.
6) Attacker now has a logged-in session ID and has compromised the
user's account.
Exploitation is dependent on the user clicking an untrusted link. However,
it is fundamental to the use of the web that we do sometimes click
untrusted links. This attack can happen regardless of the use of SSL.
Cross Security Boundary Cookie Injection
----------------------------------------
Vulnerable: all tested browsers
By default cookies are sent to all ports on the host that issued them,
regardless of whether SSL is in use. There is an optional "secure"
attribute that restricts sending to secure channels. This prevents secure
cookies for leaking out over insecure channels. However, there is no
protection to prevent cookies set over a non-secure channel being
presented on a secure channel. In general to maintain proper boundaries
between security levels, it is necessary to defend against both attacks -
protecting both confidentiality and integrity.
Example exploitation:
1) <https://example.com/> identified for attack, which uses "sid" cookie
as session ID.
2) User is enticed to click link to <http://example.com/>
3) By some mechanism the attacker intercepts this request and sets the
"sid" cookie
4) When user logs into <https://example.com/> they are using a sesion ID
known to the attacker.
5) Attacker now has a logged-in session ID and has compromised the
user's account.
In addition to the user clicking an untrusted link, exploitation is
dependent on the attacker tampering with non-SSL network traffic. This is
a reasonable assumption as the purpose of SSL is to provide security over
an insecure network.

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=252342#c1)• 21 years ago |
|  | |

This is quite well-known, not really new.
And what would be the solution? remember that there are domains like nu.nl. .nl
doesn't use third-level. The opera-assumption or the xx.yy-assumption would not
be cool.

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=252342#c2)• 21 years ago |
|  | |

yeah, this one has been around for yonks.
the whitelist approach seems nice, but it won't work as stated. .nl and .ca are
two examples. i wonder if we can come up with a correct list, or if we should
just ignore this like we've done in the past?

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=252342#c3)• 20 years ago |
|  | |

I don't know of a perfect solution for this, but we could start by creating a
list of domains that use the .co.uk form. By dafault, we would assume the .com
form. This will fix the problem for domain in that list. That is better then no
fix at all.
IF we make it editable using a pref, the user could change the list if there is
a special domain we don't know about yet. Or use nsIPermissionManager :)

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=252342#c4)• 20 years ago |
|  | |

\*\*\* [Bug 253763](/show_bug.cgi?id=253763 "VERIFIED DUPLICATE - firefox sending cookies to wrong site if the top level domain is a country code.") has been marked as a duplicate of this bug. \*\*\*

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=252342#c5)• 20 years ago |
|  | |

as danm mentions in [bug 253763 comment 2](/show_bug.cgi?id=253763#c2 "VERIFIED DUPLICATE - firefox sending cookies to wrong site if the top level domain is a country code."), this was originally filed as [bug 9422](/show_bug.cgi?id=9422 "VERIFIED WONTFIX - Unsafe handling of illegal cookie domain attributes")
many years ago. this bug was wontfixed by reason of a seemingly unrelated
implementation detail. morse argued in [bug 8743 comment 2](/show_bug.cgi?id=8743#c2 "VERIFIED FIXED - Cookie not set error ?") that disallowing sites
from setting cookies more than one domain level superior (per rfc2109), would
help the problem, but he admitted it was just a bandaid. (so it prevents
a.b.co.nz from setting cookies for .co.nz, but not b.co.nz.) with the new cookie
code, the reason for that fix not working is now gone, so we could try
implementing that again. but that will be a separate bug, since it really is
just a band-aid.
mvl's blacklist idea is the best suggestion we've had so far.

|  | [timeless](/user_profile?user_id=15223) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a1061563_15223)• 20 years ago |

Group: security

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=252342#c6)• 20 years ago |
|  | |

I'm quite sure disallowing the setting of cookies more than one level up will
break popular sites. Just a hunch based on seeing sites like
<http://us.f411.mail.yahoo.com> and yet only having yahoo.com and mail.yahoo.com
cookies

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=252342#c7)• 20 years ago |
|  | |

see [bug 253974](/show_bug.cgi?id=253974 "RESOLVED WONTFIX - implement strict domain checks per rfc2109") re strict domain stuff. i agree it's risky, given that we've been
loose in that regard for a long time now...

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a1377397_2687)• 20 years ago |

Flags: blocking-aviary1.0PR+Flags: blocking-aviary1.0+

|  | [Ben Goodger (use ben at mozilla dot org for email)](/user_profile?user_id=5566) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a1719248_5566)• 20 years ago |

Priority: -- → P2

|  | [James Hardy](/user_profile?user_id=37697) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=252342#c8)• 20 years ago |
|  | |

This exploit is being used - by someone, for some unknown purpose. I have
noticed a cookie in my list for .co.uk which is what prompted me to look up this
bug.
I've been thinking about the best way to implement a fix and I think a blacklist
of domains for which it is not permitted to set cookies for is by far the best
idea. It wont break anyone using multilevel domains but will extend the current
block where needed. To reduce the size of the list, we should use regular
expressions. (unless there is a huge performance hit in doing this - but some of
these have hundreds of possible patterns, which could be easily matched)
Examples
========
For any TLDs that have no direct registrations at all in the Second Level Domain
space then the list would simply be :
[^\.]\*\.au
For domains that have both types (.us, .uk etc) more complicated blacklists
would be needed
So for the .us domain, previously the format was
4ld.NamedRegion.2LetterStateCode.us (I believe) - It is now possible to register
directly a 2ld in .us however two letter 2ld domain registrations are not
allowed. the exclusions to be added to the blacklist should therefore be:
[a-z]{2}\.us
[^\.]\*\.[a-z]{2}\.us
The UK's blacklist would be
co\.uk
org\.uk
net\.uk
gov\.uk
ac\.uk
me\.uk
police\.uk
nhs\.uk
ltd\.uk
plc\.uk
sch\.uk
[^\.]\*\.sch\.uk (registrations only in 4th level, 3rd is local authority within
the UK)
so on and so forth.
most of the 247 ccTLDs wont require anything to be added. as for the gTLDs, most
are simple(ish). I am not sure about .name as there are so many potential 2LDs,
however they are opening it up for registration so we couldn't just use a 2ld
block. :S

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=252342#c9)• 20 years ago |
|  | |

dwitte, have we figured out what to do on this one yet. next firefox release is
drawing near...

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=252342#c10)• 20 years ago |
|  | |

yes, i have a broad idea which i'll flesh out here a bit later. i'll be going on
a two-week vacation in a couple of days... i can work on it during that if need
be, but if someone else can take this bug, that'd be rather nice...

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=252342#c11)• 20 years ago |
|  | |

darin's on vacation too, so we are a bit shorted handed for getting this into
the next firefox preview. If there is anyone that could help that would be great.

|  | [Hixie (not reading bugmail)](/user_profile?user_id=4054) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=252342#c12)• 20 years ago |
|  | |

As per my mail to security-group@mozilla.org, if Mozilla wants to coordinate on
this with Opera, the person to e-mail is yngve@opera.com (cc me ian@hixie.ch).
There is a document available that describes how Opera handles this.

|  | [Philip K. Warren](/user_profile?user_id=36238) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=252342#c13)• 20 years ago |
|  | |

From <http://o.bulport.com/index.php?item=55>:
Cookies with "indirectly" illegal domains
It is a bit complicated with unregistered domains such as "specialized" national
ones co.uk, co.jp. How can Opera know if yy.zz is a "specialized" national
domain, suffix for many other registered domains, or is itself an usual
registered domain in national zz domain?
The answer is simple. Opera can use Domain Name Service to check if yy.zz is a
registered domain. If the check fails, Opera assumes yy.zz is "specialized"
national domain.
Thus if site D (www.domD.yy.zz) wants to set a cookie, ordering it to be
accessible to yy.zz, Opera will first check (using Domain Name Service, DNS) if
yy.zz can be contacted on the Internet. If DNS check fails, Opera will accept
the cookie, but will silently restrict the later access to the cookie just to
the site D's server www.domD.yy.zz, instead of allowing it to all servers in the
yy.zz domain.

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=252342#c14)• 20 years ago |
|  | |

I'm not too happy about the dns check. There will be false hits. For example,
exedo.nl doesn't have a dns entry. But it really is just a normal domain.
On the other hand, the regexes for the blacklist are no fun. There will be quite
a lot of those checks for every time a cookie is set. If a list of just some
extension would work, it would be easier.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=252342#c15)• 20 years ago |
|  | |

\*\*\* [Bug 256699](/show_bug.cgi?id=256699 "RESOLVED DUPLICATE - Cookies for the originating website option ignored.") has been marked as a duplicate of this bug. \*\*\*

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=252342#c16)• 20 years ago |
|  | |

this is going to need more work in a longer development cycle to figure out.
darin is working with the opera suggestions and changes should go on the trunk
for site compatibility checkout before landing on a branch. renominate if a
patch becomes available.Flags: blocking-aviary1.0PR-Flags: blocking-aviary1.0PR+Flags: blocking-aviary1.0-Flags: blocking-aviary1.0+

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=252342#c17)• 20 years ago |
|  | |

> darin is working with the opera suggestions...
dveditz and I talked about this some today. Neither of us are altogether happy
with the Opera solution. Major drawbacks: 1) performance penalties resulting
from DNS delays, and 2) it fails in many cases.
The .tv domain is particularly interesting. It seems that if you load
<http://co.tv/>, you get to a site advertizing registration of subdomains of
co.tv. Moreover, .tv is used just like .com by corporations (e.g.,
<http://www.nbc4.tv/>). So, the Opera solution fails for the .tv domain :-(
One solution that dveditz mentioned was to devise a way to inform the server (or
script in the page) of the domain for which a cookie is set. That way, sites
would be able to filter out bogus domain cookies. This could be done using a
new header or by perhaps modifying the Cookie header to expose this information.
We'd also want a new DOM API for exposing the information as well. dveditz
thought it would be ideal if we exposed a list of structures to JS instead of a
simple cookie string like we do for document.cookies. That way JS would not
have to parse out the cookie information.

|  | [Jo Hermans](/user_profile?user_id=29552) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=252342#c18)• 20 years ago |
|  | |

A similar problem has been reported in [bug 28998 comment 83](/show_bug.cgi?id=28998#c83 "RESOLVED FIXED - Proxy: Web Proxy Auto-Discovery Protocol (WPAD)") and below (about
WPAD). That bug suggested to add a whitelist, because an algorithm might be to
difficult.
Note that there's a list of 2nd level domains at
<<http://www.neuhaus.com/domaincheck/domain_list.htm>>, but it's incomplete (ac.be
isn't mentioned for example) and buggy.

|  | [Christian Eyrich](/user_profile?user_id=31357) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=252342#c19)• 20 years ago |
|  | |

> 1) <http://example.ltd.uk/> is identified for attack. It uses the "sid"
> cookie to hold the session ID.
> 2) Attacker obtains attacker.ltd.uk domain
> 3) User is enticed to click link to <http://attacker.ltd.uk/>
> 4) This site sets the "sid" cookie with domain=.ltd.uk
> 5) When user logs into example.ltd.uk, they are using a sesion ID known
> to the attacker.
> 6) Attacker now has a logged-in session ID and has compromised the
> user's account.
What I don't see is how the session ID saved by <http://example.ltd.uk/> to the
"sid" cookie can be read by the attacker. Hasn't the user to visit the attackers
page again while the "sid" cookie contains the session ID and it's still valid?
Besides from this, if a user/page/server sets a cookie to ".ltd.uk" and thus
make it readable to any page/server visited in .ltd.uk, why should the browser
prevent this?
In case an attacker sets this cookie, how can it happen the session ID of
<http://example.ltd.uk/> goes into the ".ltd.uk" cookie? Or if examples session ID
goes into the regular cookie saved with correct (means intended by
<http://example.ltd.uk/>) domain, how can it happen it's read by anyone else in
.ltd.uk?
I tried but didn't get it managed to create such a scenario.
So it's nice to be sure cookies only get set for real servers not for (second
level) TLD's even if the server/page wants to do so. But a real security problem
is only if a cookie gets saved with a domain other than intended.

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=252342#c20)• 20 years ago |
|  | |

Christian:
The point is that the attacker can use this mechanism to affect the user's
interaction with the targeted site. This exploit depends on the attacker
leveraging the way in which cookies are used by a site. Imagine simple cases
where this could be used to change the contents of a virtual shopping cart or
something like that. You can imagine much worse... it all depends on how a site
uses cookies.

|  | [Christian Eyrich](/user_profile?user_id=31357) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=252342#c21)• 20 years ago |
|  | |

(In reply to [comment #20](/show_bug.cgi?id=252342#c20 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> This exploit depends on the attacker leveraging the way in which cookies are
> used by a site. Imagine simple cases where this could be used to change the
> contents of a virtual shopping cart or something like that.
But the attacker can only manipulate/access the content of a cookie with domain=tld.
As long as all other cookies with a hostname in the domain are save, I'd not
agree calling it a vulnerability in the browser.

|  | [M. LaPlante](/user_profile?user_id=92209) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=252342#c22)• 20 years ago |
|  | |

This bug was added to Secunia this morning, and released to their Advisories
mailing list:
<http://secunia.com/advisories/12580/>

|  | [uamjet602](/user_profile?user_id=12908) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=252342#c23)• 20 years ago |
|  | |

(In reply to [comment #19](/show_bug.cgi?id=252342#c19 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> What I don't see is how the session ID saved by <http://example.ltd.uk/> to the
> "sid" cookie can be read by the attacker. Hasn't the user to visit the
attackers
> page again while the "sid" cookie contains the session ID and it's still
valid?
The attacker doesn't have to read the cookie, because he wrote it, so he
already knows what's in it.
You might want to read this for a more thorough explanation:
<http://shiflett.org/articles/security-corner-feb2004>

|  | [MozillaUser](/user_profile?user_id=159974) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=252342#c24)• 20 years ago |
|  | |

The surbl.org project (identification of URLs in email messages for anti spam
purpose) already have a list of 2 levels domains that accept domains at the 3rd
level :
<http://www.surbl.org/two-level-tlds>
This could be used as a speedup for common domains before doing the DNS search.

|  | [TSUDA, Fumika](/user_profile?user_id=134283) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=252342#c25)• 20 years ago |
|  | |

Japanese geographic type domain names (ex. tokyo.jp, osaka.jp) can be
registered by Japanese local public users.
Users register domain to the \*4th level\*, not the 3rd level.
In this case, the 3rd level is a cities, wards, towns, and villages name.
For example, EXAMPLE.chiyoda.tokyo.jp.
Chiyoda is name of town in Tokyo.
Therefore, limiting Cookie to 2 level domain still has problem.
But limiting Cookie to 3 level domain has problem, too.
Prefectural offices etc. use the 3rd level domain.
(ex. METRO.tokyo.jp, PREF.osaka.jp)

|  | [Daniel Wang](/user_profile?user_id=57481) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=252342#c26)• 20 years ago |
|  | |

Dan Witte, a little bit help here. We had "network.cookies.strictDomain", and
you requested it to be removed ([bug 223617](/show_bug.cgi?id=223617 "RESOLVED FIXED - [cookies] remove support for network.cookies.strictDomains pref")). Now you want something similar?
CC'ing security@mozilla.org, since there's an actual security advisory about
this: <http://secunia.com/advisories/12580/>

|  | [Daniel Wang](/user_profile?user_id=57481) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a12438843_57481)• 20 years ago |

URL: [http://www.wangrepublic.org/daniel/mo...](http://www.wangrepublic.org/daniel/mozilla/prefs/security#p00039)

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=252342#c27)• 20 years ago |
|  | |

(In reply to [comment #26](/show_bug.cgi?id=252342#c26 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> Dan Witte, a little bit help here. We had "network.cookies.strictDomain", and
> you requested it to be removed ([bug 223617](/show_bug.cgi?id=223617 "RESOLVED FIXED - [cookies] remove support for network.cookies.strictDomains pref")). Now you want something similar?
No. Originally, the check that pref controlled was implemented for RFC2109
compliance, but it broke sites. That's why it was made a pref, disabled by
default - which isn't really useful for enhancing user privacy. Since we
couldn't enable the check without breaking sites again, the whole thing was
pretty much useless, and it was removed a while ago - mostly for the sake of
code cleanup.
This is a different situation - we're trying to find a more practical way of
solving the problem of cookies being set for TLD's. We want this to be something
enabled by default and not controlled by a pref (ideally).
> CC'ing security@mozilla.org, since there's an actual security advisory about
> this: <http://secunia.com/advisories/12580/>
That's the advisory I posted in [comment 0](/show_bug.cgi?id=252342#c0 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk")... this problem isn't new (it's been
around for years), and it's pretty well known.

|  | [info](/user_profile?user_id=174863) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=252342#c28)• 20 years ago |
|  | |

A "power" user, who cares more for security than for Yahoo Mail, needs only a
very simple pref (about:config) that would prevent these cookies right now.
I can write this simple patch with some help (which files i do need to patch).

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=252342#c29)• 20 years ago |
|  | |

You are looking for [bug 253974](/show_bug.cgi?id=253974 "RESOLVED WONTFIX - implement strict domain checks per rfc2109"). (and that won't fix this issue, since
domain.co.uk can still set cookies for .co.uk, like www.domain.com can set for
domain.com)

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=252342#c30)• 20 years ago |
|  | |

I'm working on a patch that does the blacklist approach. In a list, you can have
".co.uk" to say that cookies for co.uk should be blocked. Also, you can have
"\*.nz" to say that all second leven .nz domains should not get any cookies. (but
cookies for a.b.nz will still work ofcourse)
And i made a special case for .us. If there are other complex domains, we can
special case those as well.
I'm not sure what to do with .jp. Specify that any .jp domain can't set a cookie
for a parent domain?
technical question: where should that file with the list live?
$appdir/defaults/necko?

|  | [TSUDA, Fumika](/user_profile?user_id=134283) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=252342#c31)• 20 years ago |
|  | |

(In reply to [comment #30](/show_bug.cgi?id=252342#c30 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> I'm not sure what to do with .jp. Specify that any .jp domain can't set a cookie
> for a parent domain?
.jp domain can set cookies for 2nd level domain.
For example, <http://www.ntt.jp/> can set for ".ntt.jp" cookie.
Ofcourse, cannot set for ".jp".
But following domains must not be able to set cookie to 2nd level.
ad.jp ac.jp co.jp go.jp or.jp ne.jp gr.jp ed.jp lg.jp
And following geographic type domain domains must not be able to
set for 2nd and 3rd level.
hokkaido.jp aomori.jp iwate.jp miyagi.jp akita.jp yamagata.jp
fukushima.jp ibaraki.jp tochigi.jp gunma.jp saitama.jp chiba.jp
tokyo.jp kanagawa.jp niigata.jp toyama.jp ishikawa.jp fukui.jp
yamanashi.jp nagano.jp gifu.jp shizuoka.jp aichi.jp mie.jp
shiga.jp kyoto.jp osaka.jp hyogo.jp nara.jp wakayama.jp
tottori.jp shimane.jp okayama.jp hiroshima.jp yamaguchi.jp
tokushima.jp kagawa.jp ehime.jp kochi.jp fukuoka.jp saga.jp
nagasaki.jp kumamoto.jp oita.jp miyazaki.jp kagoshima.jp
okinawa.jp sapporo.jp sendai.jp yokohama.jp kawasaki.jp
nagoya.jp kobe.jp kitakyushu.jp
For example, <http://www.city.shinagawa.tokyo.jp/> can set a cookie
for ".city.shinagawa.tokyo.jp". But must not be able to set for
".shinagawa.tokyo.jp", ".tokyo.jp" and ".jp".
Exceptionally, only following domains should be able to set cookies
for 3rd level.
metro.tokyo.jp
pref.hokkaido.jp pref.aomori.jp pref.iwate.jp pref.miyagi.jp
pref.akita.jp pref.yamagata.jp pref.fukushima.jp pref.ibaraki.jp
pref.tochigi.jp pref.gunma.jp pref.saitama.jp pref.chiba.jp
pref.kanagawa.jp pref.niigata.jp pref.toyama.jp pref.ishikawa.jp
pref.fukui.jp pref.yamanashi.jp pref.nagano.jp pref.gifu.jp
pref.shizuoka.jp pref.aichi.jp pref.mie.jp pref.shiga.jp
pref.kyoto.jp pref.osaka.jp pref.hyogo.jp pref.nara.jp
pref.wakayama.jp pref.tottori.jp pref.shimane.jp pref.okayama.jp
pref.hiroshima.jp pref.yamaguchi.jp pref.tokushima.jp pref.kagawa.jp
pref.ehime.jp pref.kochi.jp pref.fukuoka.jp pref.saga.jp
pref.nagasaki.jp pref.kumamoto.jp pref.oita.jp pref.miyazaki.jp
pref.kagoshima.jp pref.okinawa.jp
city.sapporo.jp city.sendai.jp city.saitama.jp city.chiba.jp
city.yokohama.jp city.kawasaki.jp city.nagoya.jp city.kyoto.jp
city.osaka.jp city.kobe.jp city.hiroshima.jp city.kitakyushu.jp
city.fukuoka.jp
(Additionally, city.shizuoka.jp will start in Apr 2005.)
For example, the site "<http://www.metro.tokyo.jp/>" should be allowed to
set a cookie for ".metro.tokyo.jp". Ofcource, It's not allowed to set
for ".tokyo.jp." and ".jp".
If it says simply, "GEOGRAPHIC.jp" cannot set a cookie to the 2nd and the 3rd
level. However, "(metro|pref|city).GEOGRAPHIC.jp" can set a cookie to the 3rd
level. "XX.jp" cannot set a cookie to the 2nd level. The other ".jp" can set a
cookie to the 2nd level.
The above "XX" are "ad, ac, co, go, or, ne, gr, ed, or lg".
The above "GEOGRAPHIC" are "hokkaido, aomori, ... kitakyushu".

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=252342#c32)• 20 years ago |
|  | |

Attached patch

[work in progress patch](attachment.cgi?id=169106&action=diff)
— [Details](attachment.cgi?id=169106&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=252342&attachment=169106)

Patch shows what i have now. It needs cleanup, like a sane location for the
list file, an actual list, .jp checks, etc. But the basic checks are there.
darin, dwitte: Does this look like a reasonable approach?

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a13114198_23175)• 20 years ago |

Assignee: dwitte → mvlStatus: NEW → ASSIGNED

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=252342#c33)• 20 years ago |
|  | |

(In reply to [comment #17](/show_bug.cgi?id=252342#c17 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> One solution that dveditz mentioned was to devise a way to inform the server (or
> script in the page) of the domain for which a cookie is set. That way, sites
> would be able to filter out bogus domain cookies.
This would mean that all sites have to fix their scripts. That is not wrong, but
will take a long time. In the mean time, we can do our part by taking the black
list approach i suggested, so that we will catch most cases. It won't catch
everything (geocities.com comes to mind), but it will help.
> This could be done using a
> new header or by perhaps modifying the Cookie header to expose this information.
set-cookie2 seems to already allow that. No need to invent something new. from
rfc2965:
cookie = "Cookie:" cookie-version 1\*((";" | ",") cookie-value)
cookie-value = NAME "=" VALUE [";" path] [";" domain] [";" port]
So you can pass the domain part. (hmm, i now see they re-used the cookie:
header. that seems to make it hard to parse. is is a version1 or version2 cookie?)
I don't know how this interacts with the dom. document.cookie2?

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=252342#c34)• 20 years ago |
|  | |

Interesting. I didn't realize that Set-Cookie2 already had a provision for
this. That's nice, but I wish they had just named the new request header
Cookie2 :-(
I agree that we'd need to expose a DOM API for this as well.
Anyways, my theory was that anything we do might break legitimate cookie usage.
Afterall, consider "co.tv" which is an actual web server providing information
about getting a ".co.tv" domain. How would the blacklist solution work with
this? I'm also not too crazy about shipping with a default blacklist since that
implies a static web. What happens when new TLDs get created or change?

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=252342#c35)• 20 years ago |
|  | |

Instead of always blocking a domain in the blacklist, we could say that cookies
for those domains are always host cookies. Only co.tv can set cookies for co.tv,
and those cookies will only get send back to co.tv.
I agree that shipping a list is static, but that's why i want most of in in a
seperate file. That could be updated using the extension mechanism if needed. I
don't think it is taht bad. domain systems usually change slowly. (after all, we
also ship with a static list of certificates)
My main point is that relying on the website authors to fix their scripts will
take ages. There must be something we can do in the meantime to fix most cases.

|  | [logan](/user_profile?user_id=33984) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=252342#c36)• 20 years ago |
|  | |

Would a special exception be made for www.co.tv? www-?\d+ is somewhat common as
well, but I don't think you'd want to go crazy. 'course if co.tv has some kindof
checkout on secure.co.tv rather than www, you'd have problems..

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=252342#c37)• 20 years ago |
|  | |

Re [comment 31](/show_bug.cgi?id=252342#c31 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"): I am speechless. No wonder we can't get this fixed.
mvl: what kind of perf impact is this likely to have? footpring bloat?
The problem is that a simple browser is being asked to know all the complex (and
changing) arbitrary political/semantic domain rules in order to protect sites.
But in fact, each site is only concerned that the cookies it gets back are the
ones it set and wants to have which would seem to be a much simpler problem.
Re [comment 33](/show_bug.cgi?id=252342#c33 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"): rfc2109 also supports domain and path in the Cookie header, and
predates the Cookie2 spec (by the same authors). Do HTTP servers support the
full syntax? Even if so, web-app frameworks likely do not expose the info :-(
And in any case, scripts inside the webapp can't protect themselves short of
extensions to document.cookie, but DOM extensions are only going to work in our
browser unless we can get buy-in from other makers.
But here, for discussion purposes:
turn document.cookie into an associative array.
document.cookie.toString() returns the current string (compatibility)
document.cookie[name] returns a cookieValue object
cookieValue.toString() returns the cookie value (convenience)
otherwise, you can get value, domain, path, secure etc attributes
I should note that a similar injection attack can be performed using "/" paths
on a shared server (e.g. an ISP where all sites are www.isp.com/~member/).
What servers process the full syntax from rfc2109 (1997, predates the cookie2 spec)?

|  | [Ian Tommins ('thelem')](/user_profile?user_id=5619) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=252342#c38)• 20 years ago |
|  | |

RE: [comment 31](/show_bug.cgi?id=252342#c31 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk") and [comment 37](/show_bug.cgi?id=252342#c37 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk")
Up to now, this bug has discussed official domains such as \*.uk and \*.jp, which
is is possible (if hard) to blacklist against. However, a blacklist cannot take
account of services such as <http://www.dyndns.org/> and <http://www.new.net/h> that
allow people to create their own subdomains to domain names that they own.
This is a bug in the standard that should have been fixed long ago.

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=252342#c39)• 20 years ago |
|  | |

Re [comment 33](/show_bug.cgi?id=252342#c33 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"), a version 2 cookie header will begin "Cookie:2;" or similar... so
it seems you can distinguish between them.
Re [comment 37](/show_bug.cgi?id=252342#c37 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"), it would be nice to make the domain/path info available... I
suppose sites that really care about this can start using it, but that's not
going to have any immediate effect on anything until IE follows suit, right? The
domain/path info would definitely be much nicer than having a blacklist, if that
info were used serverside.
The goal of preventing TLD cookies here was not to solve the above problem
completely, but just to mitigate it - injection attacks within a site domain
will be much less frequent than within an entire TLD, and for sites that care
about these things (e.g. banks) it will solve the problem completely, since they
can trust their domain.
darin, dveditz, do you see any alternatives we can implement that will have an
immediate effect here, if blacklisting is unacceptable? Do you think that
exposing domain/path information will be sufficient?

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=252342#c40)• 20 years ago |
|  | |

I think that:
1) the standard has a major hole in it that cannot be fixed by the browser alone.
2) we should give servers the tools necessary to patch this hole.
3) then servers that care will patch the hole.
If a side-effect of this is that sites can better protect their users' privacy &
security when they navigate with Mozilla-based browsers, then so be it! ;-)
Moreover, as we know, this is not a new security issue. This has been known
about for years. Therefore, I'm not sure that attempting an ad-hoc, partial
browser-only fix is worth the effort. IMO, it would be better to implement a
solution that will solve the problem well in the long-term.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=252342#c41)• 20 years ago |
|  | |

Go forth and blacklist, there's probably a reasonable enough set we can agree
are invalid. I despair at the Japanese list, though, and quake in fear something
like it catches on world-wide. Does any browser, except maybe Opera with their
DNS check, support the japanese exclusions correctly?
But what are the perf and footprint hits?
In the long run, though, it would be better to provide tools to let sites look
after themselves. No matter where we draw the line you're always going to be
able to find a case where A.legit can cause mischief for B.legit's cookies, but
other X .legit and Y.legit do purposefully share cookies.
my associative array idea might not fly, it's legit to have two cookies of the
same name set at different domains and/or paths. Order is important, too, so a
site can grab the one set at the closest level. On the other hand, every case I
can think of wants only the one we present first, maybe we'd get thanks for
simplifying the process :-). Might have to go with a plain array where .name is
one of the object properties. Or as long as the .toString() presents the
current list with duplicates maybe that's good enough and the associative array
works.
If we extend cookie details to document.cookie we should also do something with
cookie headers (like rfc2109?) so server apps can likewise protect themselves.
The proposed syntax is as good as any I suppose, but will easily double the
amount of cookie information being sent down the pipe with each request. Are
"old" servers really likely to handle cookies with the name $domain fine as
asserted in the spec? Seems like that might give grief to perl programs if
misused in just the right ways.Target Milestone: --- → mozilla1.8alpha2

|  | [Jacek Piskozub](/user_profile?user_id=22464) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=252342#c42)• 20 years ago |
|  | |

> No matter where we draw the line you're always going to be
> able to find a case where A.legit can cause mischief for B.legit's cookies,
> but other X .legit and Y.legit do purposefully share cookies.
Well, the fact that X and Y purposefully share cookies needs not mean that I
want to show my X cookies to Y.

|  | [Ian Tommins ('thelem')](/user_profile?user_id=5619) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=252342#c43)• 20 years ago |
|  | |

I just thought of a domain worse than .jp - .name.
You used to be able to register names as firstname.surname.name, now you just
register fullname.name. To support this correctly on a blacklist you would need
the full, current list of \*.surname.name addresses.

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=252342#c44)• 20 years ago |
|  | |

regarding performance: i loaded the list from [comment 24](/show_bug.cgi?id=252342#c24 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk") using the patch i
attached, an measured how long the code i added to check the domain took. I only
measured worst case, that is where the domain isn't in the list. It took about
100usec per cookie set. (order of magnitude only)
So if one page tries to set 100 cookies, loading it will take 10msec longer. Is
that acceptable?
For memory footprint, it will be a little bit of code plus the size of the list.
The list i loaded is 7kb. This can all be in one memory block, no need for
malloc overhead. So a total of less then 10kb of memory.

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=252342#c45)• 20 years ago |
|  | |

I did the same test with binary serach instead of just walking the list, and it
now only takes 3usec per cookie. So you need 300 cookies on one page to have
1msec pageload hit. I think that is acceptable.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=252342#c46)• 20 years ago |
|  | |

Due to historical browser restrictions of 20 cookies per site I'd be extremely
surprised to ever see 40 or more (20 host, 20 domain) in a real life case. Your
performance numbers sound great.
Jacek Piskozub writes in [comment 42](/show_bug.cgi?id=252342#c42 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk")
>> but other X .legit and Y.legit do purposefully share cookies.
>
>Well, the fact that X and Y purposefully share cookies needs not mean that I
>want to show my X cookies to Y.
Then you want an option to disallow domain cookies, which is not this bug and
will break most large/complex/commercial sites on the web. Once you allow domain
cookies there is no legitimate set of rules that can be implemented on the
browser that can account for how humans will subdivide various domains into
cooperative and independent parts.
Ian Thomas writes in [comment 43](/show_bug.cgi?id=252342#c43 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk")
> I just thought of a domain worse than .jp - .name.
Another example that shows we'll never solve this solely on the browser side.
Let's get a reasonable blacklist going based on the currently known web (this
bug) and then also provide a mechanism for future sites to be able to protect
themselves by being able to check the origin of a cookie. It looks like Apache
has support for both rfc2109 and rfc2965 style cookies, but defaults to
Netscape-style.

|  | [alex](/user_profile?user_id=130514) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=252342#c47)• 20 years ago |
|  | |

What about when a site is on a blacklist or is not deep enough a dialouge appears:
"'me.com' is trying to set a cookie about you. (cookie text from prefs) This
cookie looks like it is being set for a larger area than a website, ie, a
country or town or village, this could be malisiously exploited. Would you like
to accept this cookie?"
"Yes","No","Yes, but alert me to when it is read"

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=252342#c48)• 20 years ago |
|  | |

No. That moves the problem to the user to solve. It makes browsing annoying
(dialogs are bad)

|  | [alex](/user_profile?user_id=130514) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=252342#c49)• 20 years ago |
|  | |

So what about the bar at the top, like for popup windows?

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=252342#c50)• 20 years ago |
|  | |

Still bad. It just says: 'we don't know how to fix his. So you, the user, should
fix it for us'

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=252342#c51)• 20 years ago |
|  | |

(In reply to [comment #50](/show_bug.cgi?id=252342#c50 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> Still bad. It just says: 'we don't know how to fix his. So you, the user, should
> fix it for us'
Forgive me... but isn't that the point of much of the discussion here :P?
Besides a whitelist, it \*does\* seem like no one quite knows how to fix this.
And, imho as well as apparently Alex's, I'd rather be able to fix it myself than
have it not fixed at all.
Not to at all imply I don't think this should be automatically fixed. Indeed,
it would be nice if that can be done. But, if not, I don't see how it would be
that bad for just cookies set for /\...\...$/ domains or something such -
because those sites are uncommon, but as described above it's not \*perfect\*.
Seems like a good compromise to me, if there's no perfect solution.
But alas, it looks like this is going to sit until someone comes up with an all
around perfect solution, or in other words (imho) never.
-[Unknown]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a18911832_1689)• 20 years ago |

Flags: blocking1.8b2?Flags: blocking-aviary1.1?

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=252342#c52)• 20 years ago |
|  | |

(In reply to [comment #51](/show_bug.cgi?id=252342#c51 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> (In reply to [comment #50](/show_bug.cgi?id=252342#c50 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> Forgive me... but isn't that the point of much of the discussion here :P?
Yes, we don't know how to fix it. So the user really has no clue what to do. So
moving the problem to him won't solve a thing.
Anyway, i'm not going to have time to turn the proposed patch into something
workable this before 1.8b2.

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a20214516_23175)• 20 years ago |

Assignee: mvl → darinStatus: ASSIGNED → NEW

|  | [Asa Dotzler [:asa]](/user_profile?user_id=5003) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a25649649_5003)• 20 years ago |

Flags: blocking1.8b3?Flags: blocking1.8b2?Flags: blocking1.8b2-Flags: blocking-aviary1.0PR-Flags: blocking-aviary1.0-

|  | [Asa Dotzler [:asa]](/user_profile?user_id=5003) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a28582643_5003)• 20 years ago |

Flags: blocking1.8b4?Flags: blocking1.8b3?Flags: blocking1.8b3-Flags: blocking1.8b2-

|  | [Max M](/user_profile?user_id=207836) |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=252342#c53)• 20 years ago |
|  | |

I know nothing about programming, but why don't you just make it block anything
starting with a period. No domain names have periods at the end of it.
example:
Block
.com
.co.uk
.abcd.yyy.xx
excetera
dont block
abcd.co.uk
yyyyaaaa.com
excetera

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=252342#c54)• 20 years ago |
|  | |

(In reply to [comment #53](/show_bug.cgi?id=252342#c53 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> I know nothing about programming, but why don't you just make it block anything
> starting with a period. No domain names have periods at the end of it.
Because setting a cookie on ".example.org" makes it available to
"www.example.org", "example.org", and "sub1.example.org". This is invaluable to
dynamic sites which make usage of subdomains.
The problem is simply that Mozilla currently doesn't see the difference between
".example.org" and ".co.uk" (which is reasonable, but definitely a problem...)
-[Unknown]

|  | [Jo Hermans](/user_profile?user_id=29552) |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=252342#c55)• 20 years ago |
|  | |

(In reply to [comment #53](/show_bug.cgi?id=252342#c53 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> I know nothing about programming, but why don't you just make it block anything
> starting with a period. No domain names have periods at the end of it.
>
That's not true. A FQDN (fully qualified domain name) has a period at the right
end. But 99.99% of all DNS names omit it, and many applications (mistakingly)
don't even accept this format.
And to counter your agument about blocking anything starting with a period, I
quote from RFC2965 :
Domain=value
OPTIONAL. The value of the Domain attribute specifies the domain
for which the cookie is valid. If an explicitly specified value
does not start with a dot, the user agent supplies a leading dot.

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a30496028_7044)• 20 years ago |

Whiteboard: [no l10n impact]

|  | [Asa Dotzler [:asa]](/user_profile?user_id=5003) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a30766774_5003)• 20 years ago |

Flags: blocking1.8b4?Flags: blocking1.8b4+Flags: blocking-aviary1.1?

|  | [Mike Connor [:mconnor]](/user_profile?user_id=96908) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=252342#c56)• 20 years ago |
|  | |

This isn't going to happen in the b4 timeframe, not without a lot of testing and
possible breaking of legitimate sites. Punt to 1.9a1 per conversation with
dwitte. Blocking 1.9a1 so we get this figured out and in early enough to let
issues bubble up.Flags: blocking1.9a1+Flags: blocking1.8b4-Flags: blocking1.8b4+

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=252342#c57)• 20 years ago |
|  | |

(In reply to [comment #52](/show_bug.cgi?id=252342#c52 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> (In reply to [comment #51](/show_bug.cgi?id=252342#c51 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> > (In reply to [comment #50](/show_bug.cgi?id=252342#c50 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> > Forgive me... but isn't that the point of much of the discussion here :P?
>
> Yes, we don't know how to fix it. So the user really has no clue what to do. So
> moving the problem to him won't solve a thing.
I'm not sure I understand. I get this message when going to SourceForge:
You have requested an encrypted page that contains some unencrypted information.
Information that you see or enter on this page could easily be read by a third
party.
That seems like \*exactly\* the same idea. Imagine a message like this:
The page you have requested is trying to set a cookie to for the website at
"co.uk". If this is not the website you expected, it may be an attempt to
compromise your security.
[X] Block suspicious cookies without asking me.
And, still, only people browsing short (..\...) domain names will ever see this
message. Yes, it exposes that the software is, after all, not omnipotent... but
so do other messages and questions it contains, at times.
In either case, I'd rather have the alert than no protection at all. A question
about the cookie might be bad form, but isn't it worse to do nothing? I can
just imagine if IE didn't even ask you for ActiveX installs, and did them all
silently.
\*shudders.\*
-[Unknown]

|  | [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=252342#c58)• 20 years ago |
|  | |

> That seems like \*exactly\* the same idea.
No, it is totally different. unecrypted element on a https page can be valid,
and often is. A cookie for .co.uk is never valid. A cookie for .nu.nl is always
valid. From [comment 32](/show_bug.cgi?id=252342#c32 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"), a cookie for hokkaido.jp is never valid. So even the two
letter check often fails.
> [X] Block suspicious cookies without asking me.
How do you know a cookie is suspicious? And why not just block it, if you the
app know the cookie is no good?
But I'm not going to discuss this any further. There is a suggested patch,
somebody can take it and finish it (yes, even you can) Lets waste the next few
comments on the patch, instead of discussing when this will be fixed and other
non-productive comments.

|  | [kagenoyoake](/user_profile?user_id=208611) |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=252342#c59)• 20 years ago |
|  | |

I have no idea how firefox is programmed (though at some point i would like to
learn) however would it be possible to use more than one list?
For example, FF could check if the something.jp cookie is invalid only if it
ends in .jp, and the same with if it ends in .uk, that way each time a list
would need loading it would both load a shorter list, and do so less often.

|  | [David Baron :dbaron: (⌚️UTC-4, no longer working on Mozilla)](/user_profile?user_id=3881) |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=252342#c60)• 20 years ago |
|  | |

\*\*\* [Bug 301055](/show_bug.cgi?id=301055 "RESOLVED DUPLICATE - its possible to set cookies scoped to .co.uk domain and read at other .co.uk sites") has been marked as a duplicate of this bug. \*\*\*

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=252342#c61)• 20 years ago |
|  | |

This is low on my priority list. If someone wants to fix this bug, then please
feel free to take ownership of it.Keywords: [helpwanted](/buglist.cgi?keywords=helpwanted&resolution=---)Target Milestone: mozilla1.8alpha2 → Future

|  | [Mike Mason](/user_profile?user_id=194782) |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=252342#c62)• 20 years ago |
|  | |

(In reply to [comment #61](/show_bug.cgi?id=252342#c61 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> This is low on my priority list. If someone wants to fix this bug, then please
> feel free to take ownership of it.
That is unfortunate since this is listed as a vulernability at Secunia. This
may seem to be a minor issue to a developer, however, from a marketing and
end-user's perspective any security vulerability is very important.

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=252342#c63)• 20 years ago |
|  | |

The problem is with the cookie specification. Web sites can work around this
problem (as they have for years) by using cookies properly. Moreover, I know of
no complete, browser-only solution to this problem short of the white-listing
proposed above. Do you? White-lists of domain names are difficult to manage
and maintain across deployed browsers. What happens when a new ccTLD or gTLD is
added to the DNS system? How do existing Mozilla browsers cope? What is the
process?

|  | [Bradley Baetz (:bbaetz)](/user_profile?user_id=29274) |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=252342#c64)• 19 years ago |
|  | |

Dupe of 66383, FWIW

|  | [Gervase Markham [:gerv]](/user_profile?user_id=9911) |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=252342#c65)• 19 years ago |
|  | |

\*\*\* This bug has been marked as a duplicate of [66383](/show_bug.cgi?id=66383 "RESOLVED DUPLICATE - Cookies stored from .co.uk top level domain") \*\*\*Status: NEW → RESOLVEDClosed: 19 years agoResolution: --- → DUPLICATE

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=252342#c66)• 19 years ago |
|  | |

the two bugs are dupes, but this certainly isn't wontfix - it's just waiting for the right solution, which we may now have. things have changed a lot from 2001.
you can dupe the other way if you want, but please leave this one openStatus: RESOLVED → REOPENEDResolution: DUPLICATE → ---

|  | [OstGote!](/user_profile?user_id=51898) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=252342#c67)• 19 years ago |
|  | |

\*\*\* [Bug 66383](/show_bug.cgi?id=66383 "RESOLVED DUPLICATE - Cookies stored from .co.uk top level domain") has been marked as a duplicate of this bug. \*\*\*

|  | [Salvatore](/user_profile?user_id=233587) |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=252342#c68)• 19 years ago |
|  | |

Would it make more sense to allow a site say foo.bar.com to have access to change/read/delete cookies in all subdomains, and all domains above it. i.e.:
...\*.\*.foo.bar.com.
.foo.bar.com.
.bar.com.
.com.
this would stop the need to deal handle special rules for domains like: .co.uk.
foo.co.uk could set cookies in the .co.uk. domain if wanted, and bar.co.uk. could read those, but only a fool developer at foo.co.uk would expect his cookies to be safe at that level. then also all of his subdomains would be able to read and set cookies. I believe this would solve the problems brought up by this issue.

|  | [Jo Hermans](/user_profile?user_id=29552) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=252342#c69)• 19 years ago |
|  | |

(In reply to [comment #68](/show_bug.cgi?id=252342#c68 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> foo.co.uk could set cookies in the .co.uk. domain if wanted, and bar.co.uk.
> could read those, but only a fool developer at foo.co.uk would expect his
> cookies to be safe at that level. then also all of his subdomains would be able
> to read and set cookies. I believe this would solve the problems brought up by
> this issue.
>
This is what this bug is all about. foo.co.uk should NOT be allowed to set cookies in the co.uk domain. Ever.

|  | [Salvatore](/user_profile?user_id=233587) |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=252342#c70)• 19 years ago |
|  | |

I don't see why setting cookies in the .co.uk. domain is a problem. I only see a problem if one is able to set cookies for other subdomain. i.e. foo.co.uk. setting cookies for bar.co.uk. If bar.co.uk is getting cookies from .co.uk., then they are poor web developers. I don't think the browser should make state that one cannot set cookies in .co.uk. just not set them for other subdomains.
If you look at the original Advisory that this bug seems to be associated with; the problem is a matter of trying to keep cookies private to a domain. I believe my suggestion would maintain privacies of those domains involved and only allow for sites themselves to make mistakes. If they choose to implement poor practices the browser should not be held accountable.
Essentially, if you have foo.co.uk. and you did not want someone who owns bar.co.uk. reading your cookies, those cookies should be set to foo.co.uk. and not .co.uk.
Then again I could be totally missing the point, in which case I値l let this go.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 71](/show_bug.cgi?id=252342#c71)• 19 years ago |
|  | |

(In reply to [comment #70](/show_bug.cgi?id=252342#c70 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> I don't see why setting cookies in the .co.uk. domain is a problem. I only see
> a problem if one is able to set cookies for other subdomain.
The problem is that web-apps only see the cookies, not the domain on which the cookie is set, so it can't distinguish between a legit foo.co.uk cookie and one set by an impostor. (the Cookie2 spec resolves this)

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a52790560_20048)• 19 years ago |

Depends on: [331510](/show_bug.cgi?id=331510 "RESOLVED FIXED - Add knowledge of subdomains to necko (create nsEffectiveTLDService)")

|  | [Lars Schöning](/user_profile?user_id=191529) |  |
| --- | --- | --- |
| [Comment 72](/show_bug.cgi?id=252342#c72)• 19 years ago |
|  | |

Wouldn't in any case blacklisting be necessary? The autonomous solution with Cookie2 would resolve any security problems; however it would be possible to make large ranges of pages unavailable to the user.
The issue is that the maximum data contained in 40 cookies is quite sufficient to produce a 400 Bad Request error for exceeded header length on many servers. For instance if example.co.uk would set up to 40 cookies of length 255 for .co.uk this could make a large set of pages in the .co.uk area unavailable to the user as many servers just wouldn't handle http requests of that size.
Obviously this would be easy to resolve by the user (deleting the cookies), but I am not sure about how many people would actually think about the cookies as an issue in first place.

|  | [Lars Schöning](/user_profile?user_id=191529) |  |
| --- | --- | --- |
| [Comment 73](/show_bug.cgi?id=252342#c73)• 19 years ago |
|  | |

Attached file
[Php script to create a bulk of cookies which might produce size-overflows in server requests.](attachment.cgi?id=224722)
— [Details](attachment.cgi?id=224722&action=edit)

|  | [Lars Schöning](/user_profile?user_id=191529) |  |
| --- | --- | --- |
| [Comment 74](/show_bug.cgi?id=252342#c74)• 19 years ago |
|  | |

I created a test case which, if called twice or so will on most servers produce a 400 Bad Request response because of size limit exceed. I tested this on an open \*.ath.cx domain. After calling it most of .ath.cx domains (found over google) were producing the mentioned error in firefox, other browsers with other cookies stored obviously wheren't affected.

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a59350145_20048)• 19 years ago |

Status: REOPENED → ASSIGNEDTarget Milestone: Future → mozilla1.9alpha

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 75](/show_bug.cgi?id=252342#c75)• 19 years ago |
|  | |

(In reply to [comment #72](/show_bug.cgi?id=252342#c72 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> Wouldn't in any case blacklisting be necessary?
Yes, that's why this bug remains open (and more specifically, [bug 331510](/show_bug.cgi?id=331510 "RESOLVED FIXED - Add knowledge of subdomains to necko (create nsEffectiveTLDService)"))

|  | [Lars Schöning](/user_profile?user_id=191529) |  |
| --- | --- | --- |
| [Comment 76](/show_bug.cgi?id=252342#c76)• 19 years ago |
|  | |

Comment on [attachment 224722](/attachment.cgi?id=224722 "Php script to create a bulk of cookies which might produce size-overflows in server requests.") [[details]](/attachment.cgi?id=224722&action=edit "Php script to create a bulk of cookies which might produce size-overflows in server requests.")
Php script to create a bulk of cookies which might produce size-overflows in server requests.
<?
for ( $i = 0; $i < 20; $i ++ )
setcookie
(
$i . rand(),
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" .
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" ,
time () + 1 \* 60 \* 60,
"/",
".ath.cx"
);
?>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 77](/show_bug.cgi?id=252342#c77)• 19 years ago |
|  | |

attachments can't be edited.
we believe you, it's easy to reproduce by manually injecting cookies using javascript (using the Shell from www.squarefree.com, or the Firebug extension, etc).

|  | [David Baron :dbaron: (⌚️UTC-4, no longer working on Mozilla)](/user_profile?user_id=3881) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a64284984_3881)• 18 years ago |

Flags: blocking1.9-Whiteboard: [no l10n impact] → [no l10n impact][wanted-1.9]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a64733436_1689)• 18 years ago |

Flags: blocking1.8.0.7?Whiteboard: [no l10n impact][wanted-1.9] → [sg:low dos][no l10n impact][wanted-1.9]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 78](/show_bug.cgi?id=252342#c78)• 18 years ago |
|  | |

It would be really nice to get a fix in 1.5.0.x, but not realistic until someone's trying to fix it in Firefox 2 and the trunk.Flags: blocking1.8.1?Flags: blocking1.8.0.7?Flags: blocking1.8.0.7-

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 79](/show_bug.cgi?id=252342#c79)• 18 years ago |
|  | |

181 drivers adding our voices to the "gee, yeah, would be nice, not going to block on it, though" chorus.Flags: blocking1.8.1? → blocking1.8.1-Whiteboard: [sg:low dos][no l10n impact][wanted-1.9] → [sg:low dos][no l10n impact][wanted-1.9][would take patch]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 80](/show_bug.cgi?id=252342#c80)• 18 years ago |
|  | |

Please reconsider for FF2. This long-standing bug could be easily solved if [bug 331510](/show_bug.cgi?id=331510 "RESOLVED FIXED - Add knowledge of subdomains to necko (create nsEffectiveTLDService)") is checked in.Flags: blocking1.8.1- → blocking1.8.1?

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 81](/show_bug.cgi?id=252342#c81)• 18 years ago |
|  | |

Not blocking, but we would take a patch. Note that [bug 331510](/show_bug.cgi?id=331510 "RESOLVED FIXED - Add knowledge of subdomains to necko (create nsEffectiveTLDService)") doesn't have a data file, so it wouldn't actually fix the problem yet.Flags: blocking1.8.1? → blocking1.8.1-

|  | [Mikhail Simvulidy](/user_profile?user_id=277939) |  |
| --- | --- | --- |
| [Comment 82](/show_bug.cgi?id=252342#c82)• 18 years ago |
|  | |

I think the only secure solution to this problem is to allow setting cookies to the current domain, port and connection type (HTTP/HTTPS) only (and strip out "domain" and "secure" flags from requests). This could break a few sites, but site owners could work around it.
There are thousands of second level domains that offer free subdomains for just anyone such as dyndns.com. You will NEVER determine all of those.
Otherwise we have to use HTTP Basic authentication instead of cookies everywhere.
And what about document.domain? I think it is very bad that john.freedomain.com can control <iframe src="<http://freedomain.com/>" />. The only solution now is to always redirect from freedomain.com to www.freedomain.com...
P.S. It is terrible that anything in the internet (not only web) is insecure by design...

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 83](/show_bug.cgi?id=252342#c83)• 18 years ago |
|  | |

(In reply to [comment #82](/show_bug.cgi?id=252342#c82 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> I think the only secure solution to this problem is to allow setting cookies to
> the current domain, port and connection type (HTTP/HTTPS) only (and strip out
> "domain" and "secure" flags from requests). This could break a few sites, but
> site owners could work around it.
That would completely break sites like Google, Yahoo!, and countless others, which set a login cookie to "google.com" and then use that cookie on other domains, such as "maps.google.com", "mail.google.com", "movies.yahoo.com", etc., etc.
There would not be any workaround for that. The only way would be to use the same domain "www.google.com" for every part of the site - which is not always practical (ex. when the separate domains point to servers in different physical locations.)
I personally think a much better solution is either at the HTTP header level or, even better, the DNS level. Some provision in DNS to communicate permissions seems most logical, e.g. in a TXT record. This would be accessible before the request is sent, cache-able, and reasonably efficient.
Example: the \_\_security.google.com might be set to 2 (.google.com), while \_\_security.dnsalias.net might be 3 (.example.dnsalias.net).
Thus putting the effective TLD in DNS (where they can be determined by other parties, which negates your NEVER.) That said, I guess the question is whether queries are performed for each part - \_\_security.co.uk, \_\_security.yahoo.co.uk, \_\_security.movies.yahoo.co.uk, etc.
Even so, the effective TLD solution is simple and effective for the greater part of the current problems without causing any false positives.
-[Unknown]

|  | [Mikhail Simvulidy](/user_profile?user_id=277939) |  |
| --- | --- | --- |
| [Comment 84](/show_bug.cgi?id=252342#c84)• 18 years ago |
|  | |

(In reply to [comment #83](/show_bug.cgi?id=252342#c83 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> There would not be any workaround for that. The only way would be to use the
> same domain "www.google.com" for every part of the site - which is not always
> practical (ex. when the separate domains point to servers in different physical
> locations.)
I think usage of one domain per company is always better just because there is no need to buy multiple SSL certificates.
If they need authorization for others servers, why just not to enter password on each server? And I see workaround: they could make an iframe, in which they can do POST's with form.submit() to each server (servers view referrers to determine should they authorize request or not).
> I personally think a much better solution is either at the HTTP header level
> or, even better, the DNS level. Some provision in DNS to communicate
> permissions seems most logical, e.g. in a TXT record. This would be accessible
> before the request is sent, cache-able, and reasonably efficient.
Just remember that DNS is untrusted. DNS cache server owner can modify any record. And communication between client and DNS is not secure. It meens that we can't use it for SSL.
But about HTTP headers: there is a workaround you could add "; issued=<https://www.bank.com/>" parameter for cookies so server could check whether should it accept or not.
But I think it is incorrect solution to the problem because most web-programmers will not know that they should check additional cookie parameters. Just as now they don't know what is Cross-site request forgery (XSRF). It is easier to make companies like Google rewrite their webapps so they could work using one domain (or post to other domains inside an iframe) than to make people rewrite \_all\_ web sites and intranet portals to make them secure.

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 85](/show_bug.cgi?id=252342#c85)• 18 years ago |
|  | |

(In reply to [comment #84](/show_bug.cgi?id=252342#c84 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> If they need authorization for others servers, why just not to enter password
> on each server? And I see workaround: they could make an iframe, in which they
> can do POST's with form.submit() to each server (servers view referrers to
> determine should they authorize request or not).
Because users hate having to enter it for each server. Consider something like Yahoo! Mail: I happen to be on us.f802.mail.yahoo.com. Should I seriously have to log in for that specific hostname when I'm already logged into Yahoo! (which happens at login.yahoo.com)?
It simply is not practical to say "well, they should all be on one hostname." Look again. That's us.f802 - knowing Yahoo!, it's not impossible that they have 802+ mail servers clustering their users' mail accounts. Different physical machines, maybe even in different data centers at times.
It would be ridiculous (although this would be an available workaround for some uses) to create an iframe, set document.domain everywhere, and proxy cookies through the iframe. Assuming document.domain doesn't affect cookies.
I don't think you realize just how many websites this would break. Especially due to "www.example.tld" vs. "example.tld". It would affect a lot of sites. You are asking for \_all\_ web sites to be rewritten.
> Just remember that DNS is untrusted. DNS cache server owner can modify any
> record. And communication between client and DNS is not secure. It meens that
> we can't use it for SSL.
Sorry, but it's used for everything. I'm not saying it's trustworthy, but if your A record is wrong it won't help you much to have other records correct. If I am able to poison your A record for "dnsalias.net", then I can get to the cookies for it regardless.
Security is nice, but the boat will sink and everyone will move back to IE if users are completely ignored in its name - when other, better ways are possible where everyone can win.
-[Unknown]

|  | [Mikhail Simvulidy](/user_profile?user_id=277939) |  |
| --- | --- | --- |
| [Comment 86](/show_bug.cgi?id=252342#c86)• 18 years ago |
|  | |

(In reply to [comment #85](/show_bug.cgi?id=252342#c85 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> It simply is not practical to say "well, they should all be on one hostname."
> Look again. That's us.f802 - knowing Yahoo!, it's not impossible that they
> have 802+ mail servers clustering their users' mail accounts. Different
> physical machines, maybe even in different data centers at times.
If you need load balancing, please read about Round Robin DNS (for multiple datacenters) and about IPVS (single datacenter). In case of SSL multiple machines with one domain name even can share one certificate.
> Sorry, but it's used for everything. I'm not saying it's trustworthy, but if
> your A record is wrong it won't help you much to have other records correct.
> If I am able to poison your A record for "dnsalias.net", then I can get to the
> cookies for it regardless.
In case of SSL only genuine server should accept cookie. But what is now? Please read "Cross Security Boundary Cookie Injection" on this page.
> Security is nice, but the boat will sink and everyone will move back to IE if
> users are completely ignored in its name - when other, better ways are possible
> where everyone can win.
Now most IT people only think about how to create something faster, but not better or securer. But I hope they will change their mind...

|  | [Unknown W. Brackets](/user_profile?user_id=114666) |  |
| --- | --- | --- |
| [Comment 87](/show_bug.cgi?id=252342#c87)• 18 years ago |
|  | |

(In reply to [comment #86](/show_bug.cgi?id=252342#c86 "RESOLVED FIXED - fix cookie domain checks to not allow .co.uk"))
> If you need load balancing, please read about Round Robin DNS (for multiple
> datacenters) and about IPVS (single datacenter). In case of SSL multiple
> machines with one domain name even can share one certificate.
Indeed, using round-robin or low TTL DNS is very important. But clustering and load balancing are entirely different things. I really have not mentioned anything about SSL.
> In case of SSL only genuine server should accept cookie. But what is now?
> Please read "Cross Security Boundary Cookie Injection" on this page.
Again, SSL is not my primary concern. In fact, to talk about it for the first time, I do agree that sending cookies set with the "secure" flag to only the same hostname makes nothing but complete sense. In the case of secure cookies, I completely and totally agree with you.
It is on non-secure, non-SSL cookies that I am primarily talking about. Most people don't use secure cookies, or even SSL. They should, and I'm not validating the reality, just stating it.
> Now most IT people only think about how to create something faster, but not
> better or securer. But I hope they will change their mind...
That is an unfortunate truth, with programming becoming more and more blue collar. It's no longer about quality, but instead about quantity. Even so, it's not impossible to achieve security in a clean, maintainable, and easy way. This is the best guarantee it will be actual security - if it is difficult, it just means people will find another (wrong) way.
Again, I am only stating reality, not validating it.
At this point, I think I'm going to respond to any further discourse via email. I think we've moved to the edges of this bug's subject.
-[Unknown]

|  | [Darin Fisher](/user_profile?user_id=20048) |  |
| --- | --- | --- |
| [Comment 88](/show_bug.cgi?id=252342#c88)• 18 years ago |
|  | |

-> reassign to default ownerAssignee: darin.moz → nobodyStatus: ASSIGNED → NEW

|  | [Mike Connor [:mconnor]](/user_profile?user_id=96908) |  |
| --- | --- | --- |
| [Comment 89](/show_bug.cgi?id=252342#c89)• 18 years ago |
|  | |

dwitte's been promising to fix this under his "will work for steak" plan.Assignee: nobody → dwitteFlags: blocking1.9a1+Target Milestone: mozilla1.9alpha1 → mozilla1.8.1beta1

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a92055855_75420)• 18 years ago |

Depends on: [385299](/show_bug.cgi?id=385299 "RESOLVED FIXED - use eTLD in cookies (stop sites setting cookies for the entire \".co.uk\" domain)")

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 90](/show_bug.cgi?id=252342#c90)• 18 years ago |
|  | |

this will be fixed once the etld patch lands. not going to happen for alpha, but hopefully for beta.Keywords: [helpwanted](/buglist.cgi?keywords=helpwanted&resolution=---)Priority: P2 → --Target Milestone: mozilla1.8.1beta1 → mozilla1.9beta1

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 91](/show_bug.cgi?id=252342#c91)• 17 years ago |
|  | |

somewhat amusing... what IE does:
<http://therealcrisp.xs4all.nl/blog/2007/02/12/ie-and-2-letter-domain-names/>

|  | [dwitte@gmail.com](/user_profile?user_id=75420)  Assignee |  |
| --- | --- | --- |
| [Comment 92](/show_bug.cgi?id=252342#c92)• 17 years ago |
|  | |

fixed per [bug 385299](/show_bug.cgi?id=385299 "RESOLVED FIXED - use eTLD in cookies (stop sites setting cookies for the entire \".co.uk\" domain)").Status: NEW → RESOLVEDClosed: 19 years ago → 17 years agoResolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a107916962_1689)• 17 years ago |

Flags: wanted1.8.1.x+

|  | [Reed Loden [:reed]](/user_profile?user_id=159758) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a110121230_159758)• 17 years ago |

Flags: wanted1.9+Whiteboard: [sg:low dos][no l10n impact][wanted-1.9][would take patch] → [sg:low dos][no l10n impact][would take patch]

|  | [Launchpad](/user_profile?user_id=363145) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=252342#a194475194_363145)• 14 years ago |

See Also: → <https://launchpad.net/bugs/44062>
You need to [log in](/show_bug.cgi?id=252342&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Michiel van Leeuwen (email: mvl+moz@)](/user_profile?user_id=23175)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


