=== Content from bugzilla.mozilla.org_788d71e8_20250125_161900.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/408076)
* [XML](/show_bug.cgi?ctype=xml&id=408076)

Closed
[Bug 408076](/show_bug.cgi?id=408076)
(CVE-2008-0420)

Opened 17 years ago
Closed 17 years ago

# out of bounds read in BMP decoder can lead to information disclosure

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

out of bounds read in BMP decoder can lead to information disclosure

## Categories

### (Core :: Graphics: ImageLib, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20ImageLib#Graphics%3A%20ImageLib)

Graphics: ImageLib
▾

Core :: Graphics: ImageLib
ImageLib decodes GIF, JPEG and PNG images, and provides the decoded data to the Compositor for display. If Firefox or Seamonkey can display an image when loaded separately from the page, ImageLib is working, and the actual imaging bug exists elsewhere within Firefox or Seamonkey.

Examples of appropriate bugs: PNG gAMA chunk ignored; Crashes on GIF w/corrupted frame(merr-01.gif); or PNGs and JPEGs aren't displayed on FreeBSD.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20ImageLib&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20ImageLib&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20ImageLib)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla1.9beta3

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: Gavin, Assigned: Gavin)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/08de945228403cb0598d5906e2407a7d?d=mm&size=40)  [Gavin](/user_profile?user_id=103593)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/08de945228403cb0598d5906e2407a7d?d=mm&size=40)  [Gavin](/user_profile?user_id=103593)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/0646a42110a02dd585f200f270716852?d=mm&size=40)  [tnikkel](/user_profile?user_id=255010)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

15 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [sg:moderate] fix in bug 408256. coordinate disclosure with other vendors, see comment 10)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2008-0420

[Keywords:](/describekeywords.cgi)

[fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---),
[privacy](/buglist.cgi?keywords=privacy&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---),
[verified1.8.1.12](/buglist.cgi?keywords=verified1.8.1.12&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:moderate] fix in bug 408256. coordinate disclosure with other vendors, see comment 10

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [mtschrep](/user_profile?user_id=210162) | [blocking1.9](#c8 "17 years ago") | + |
| --- | --- | --- |
| [mtschrep](/user_profile?user_id=210162) | blocking1.9 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.8.1.12](#a12185_1689 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.8.1.12 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.1.x](#a12185_1689 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.1.x | + |
| --- | --- | --- |
| [caillon](/user_profile?user_id=32335) | [blocking1.8.0.next](#c0 "17 years ago") | + |
| --- | --- | --- |
| [caillon](/user_profile?user_id=32335) | blocking1.8.0.next | + |
| --- | --- | --- |
| [Waldo](/user_profile?user_id=83595) | [in-testsuite](#a134304_83595 "17 years ago") | ? |
| --- | --- | --- |
| [Waldo](/user_profile?user_id=83595) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files, 4 obsolete files)

| [provided code](/attachment.cgi?id=292779)  [17 years ago](#c1)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   2.65 KB, text/plain |  | [Details](/attachment.cgi?id=292779&action=edit) |
| --- | --- | --- |
| [test image](/attachment.cgi?id=292780)  [17 years ago](#c2)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   103 bytes, image/bmp |  | [Details](/attachment.cgi?id=292780&action=edit) |
| [test image](/attachment.cgi?id=292782)  [17 years ago](#c4)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   103 bytes, image/png |  | [Details](/attachment.cgi?id=292782&action=edit) |
| [zipped image](/attachment.cgi?id=292784)  [17 years ago](#c6)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   421 bytes, application/java-archive |  | [Details](/attachment.cgi?id=292784&action=edit) |
| [modified testcase](/attachment.cgi?id=292786)  [17 years ago](#c7)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   976 bytes, text/html |  | [Details](/attachment.cgi?id=292786&action=edit) |
| [possible (incorrect) patch](/attachment.cgi?id=292914)  [17 years ago](#c9)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   8.36 KB, patch |  | [Details](/attachment.cgi?id=292914&action=edit) | [Diff](/attachment.cgi?id=292914&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292914) |
| [better possible patch](/attachment.cgi?id=292916)  [17 years ago](#c11)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   8.50 KB, patch |  | [Details](/attachment.cgi?id=292916&action=edit) | [Diff](/attachment.cgi?id=292916&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292916) |
| [patch](/attachment.cgi?id=292931)  [17 years ago](#c14)  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)   1.38 KB, patch | dveditz : [review+](#c22 "17 years ago")  pavlov : [superreview+](#a96576_5756 "17 years ago")  caillon : [approval1.8.0.next+](#c0 "17 years ago") | [Details](/attachment.cgi?id=292931&action=edit) | [Diff](/attachment.cgi?id=292931&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=408076#c0)• 17 years ago |
|  | |

Full credit goes to Michael Skladnikiewicz, who reported this to security@mozilla.org in an email with subject "Mozilla Firefox 2.0.0.11, 3.0b2pre and prior Remote Information Disclosure". His initial email is quoted below.
-------------------------------------------
Hi,
(credit: Gynvael Coldwind // Vexillium with help from udevd and porneL
(I didn't know about <canvas> ;D))
OK, Here is how it goes.
Firefox has a problem in handling 8bit BMP files.
The BMP format has a field in the BITMAPINFOHEADER named biClrUsed, the
field says how many colors does the palette contain. If this field is 0,
then 256 color pallet is used. When this field is not 0, the palette has
the given number of colors.
Now this is how it goes in Firefox:
1. Firefox allocates 256 \* sizeof(RGB) for the palette
2. It copies the biClrUsed colors from the BMP file
Well, what is missing is:
1a. memset(pallete, 0, 256 \* sizeof(RGB)
The palette still contains old data from the heap.
Now, we take a BMP file sized 256x1x8 with biClrUser = 0, and fill the
bitmap with gradient, from 0 to 255:
00 01 02 03 04 05 ... and so on
When displayed, the BMP file looks chaotic, and in fact it contains the
palette copied to the screen.
Here is where HTML 5.0 comes in and <canvas>. You can imagine the
rest... But I'll write it anyway. You can create a HTML/javascript that
copies the image from img to a canvas and then gets it data and, for
example using a form, posts it to some remote server.
This has been tested and it works. There is a PoC exploit in the bottom.
The harvested data contains mainly trash, but there are also parts of
other websites, parts of java scripts, even parts of favorites. Well, if
there are also cookies and passwords in heap, then they are also reachable.
I've attached also the scripts and the leak.bmp bitmap.
This will be posted on bugtraq as soon as a fixed version of FireFox is
released.
Please check also Thunderbird for this issue (I didn't check).
Best regards,
Looking forward to Your reply,
Michael "Gynvael Coldwind" Skladnikiewicz
Team Vexillium
HispasecFlags: blocking1.9?Flags: blocking1.8.1.12?

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=408076#c1)• 17 years ago |
|  | |

Attached file
[provided code](attachment.cgi?id=292779)
— [Details](attachment.cgi?id=292779&action=edit)

This is the code that Michael provided in his initial report.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=408076#c2)• 17 years ago |
|  | |

Attached image
[test image](attachment.cgi?id=292780) (obsolete)
— [Details](attachment.cgi?id=292780&action=edit)

This is the example image Michael provided in his initial email.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=408076#c3)• 17 years ago |
|  | |

Follow-up email from Michael:
------------------------------------
Hello again,
Since I didn't receive any reply from You, I digged a little into the FF
code to provide You with additional information.
First of all, I was mistaking - it is not a missing memset function,
it's a boundary condition error.
In file mozilla\modules\libpr0n\decoders\bmp\nsBMPDecoder.cpp
Function ProcessData:
Line 260:
if (mBIH.bpp <= 8) {
mNumColors = 1 << mBIH.bpp;
if (mBIH.colors && mBIH.colors < mNumColors)
mNumColors = mBIH.colors;
mColors = new colorTable[mNumColors];
if (!mColors)
return NS\_ERROR\_OUT\_OF\_MEMORY;
}
Line 403:
case 8:
while (lpos > 0) {
SetPixel(d, \*p, mColors);
--lpos;
++p;
}
break;
There is a check missing - \*p should be checked against mNumColors.
In a malformed BMP file the \*p will be equal to or greater then
mNumColors, what causes one of two things:
1. Remote DoS - FF crashes when mColors[\*p] reaches over the Heap's end
(this happens mostly on Windows XP, it hasn't happen on Vista nor Linux)
2. Remote Information Disclosure (using <canvas> and javascript,
information from the heap residing after the mColors can be copied -
I've written you a mail about this).
Looking forward to your reply.
G.C.

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a689_11608)• 17 years ago |

Keywords: [testcase](/buglist.cgi?keywords=testcase&resolution=---)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a884_103593)• 17 years ago |

[Attachment #292780](/attachment.cgi?id=292780&action=edit "test image") -
Attachment mime type: image/png → image/bmp

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=408076#c4)• 17 years ago |
|  | |

Attached image
[test image](attachment.cgi?id=292782) (obsolete)
— [Details](attachment.cgi?id=292782&action=edit)

For some reason the test image I uploaded previously doesn't seem to work. Trying again.
[Attachment #292780](/attachment.cgi?id=292780&action=edit "test image") -
Attachment is obsolete: true

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=408076#c5)• 17 years ago |
|  | |

Comment on [attachment 292782](/attachment.cgi?id=292782 "test image") [[details]](/attachment.cgi?id=292782&action=edit "test image")
test image
Strange, for some reason Bugzilla (or Firefox) is modifying the attachment when I upload it. It's 314 bytes locally.
[Attachment #292782](/attachment.cgi?id=292782&action=edit "test image") -
Attachment is obsolete: true

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=408076#c6)• 17 years ago |
|  | |

Attached file
[zipped image](attachment.cgi?id=292784)
— [Details](attachment.cgi?id=292784&action=edit)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a1844_103593)• 17 years ago |

[Attachment #292784](/attachment.cgi?id=292784&action=edit "zipped image") -
Attachment mime type: application/zip → application/java-archive

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=408076#c7)• 17 years ago |
|  | |

Attached file
[modified testcase](attachment.cgi?id=292786)
— [Details](attachment.cgi?id=292786&action=edit)

This is a testcase based on the example code provided by Michael.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a12185_1689)• 17 years ago |

Flags: wanted1.8.1.x+Flags: blocking1.8.1.12?Flags: blocking1.8.1.12+Keywords: [privacy](/buglist.cgi?keywords=privacy&resolution=---)Whiteboard: [sg:moderate]

|  | [Mike Schroepfer](/user_profile?user_id=210162) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=408076#c8)• 17 years ago |
|  | |

Yep - we should fix - any takers? :-)Flags: blocking1.9? → blocking1.9+

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=408076#c9)• 17 years ago |
|  | |

Attached patch

[possible (incorrect) patch](attachment.cgi?id=292914&action=diff) (obsolete)
— [Details](attachment.cgi?id=292914&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292914)

I'm not really familiar with this code, but this patch seems to fix the bug. mNumColors is calculated based on either mBIH.bpp or mBIH.colors (which comes from the image), and then we never check whether the image data conforms to that range of colors. The only obvious way to do this was to do it in SetPixel as we're decoding the data - perhaps not optimal, but I don't see a better way.
This uses color at index 0 if the passed-in color is outside the range of mNumColors - that's probably still not safe, because it looks like mColors' initialization depends entirely on the image data which could again be corrupt. With the given test image the 0 color appears to be black, which matches what I see when I open the image in IE (IE doesn't fail to load the image).

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=408076#c10)• 17 years ago |
|  | |

Safari and Opera (shipping versions on Windows) also seem to have this bug. I'll look into filing bugs on them as well.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=408076#c11)• 17 years ago |
|  | |

Attached patch

[better possible patch](attachment.cgi?id=292916&action=diff) (obsolete)
— [Details](attachment.cgi?id=292916&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292916)

This one just uses black (0,0,0) for invalid pixels, rather than relying on mColors. I suppose the question to answer is whether it's possible to produce a BMP file that doesn't initialize mColors (at <http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/modules/libpr0n/decoders/bmp/nsBMPDecoder.cpp&rev=1.37&mark=303-327#303> ) - if it is, then there's still the possibility of reading uninitialized memory, even with this patch. Hoping someone who knows more can comment.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a45909_103593)• 17 years ago |

[Attachment #292916](/attachment.cgi?id=292916&action=edit "better possible patch") -
Attachment is patch: true
[Attachment #292916](/attachment.cgi?id=292916&action=edit "better possible patch") -
Attachment mime type: application/octet-stream → text/plain

|  | [Alfred Kayser](/user_profile?user_id=35547) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=408076#c12)• 17 years ago |
|  | |

The patch itself looks good.
There is no way to not have mColors uninitialized in the range 0 < mNumColors, as the parser always reads 3\*mNumColors bytes from the image data.
But there could be an easier way to safeguard this:
1. Allocate always a mColors table for 8-bit, so with 256 entries, even if mNumColors < 256
2. To always clear the whole table to 0 (using memset(mColors, 0, 256\*sizeof(colorTable))
In this way the SetPixel doesn't need to check the boundary (as Idx is a PRUint8 and thus always between 0 and 255)

|  | [Gynvael Coldwind](/user_profile?user_id=295790) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=408076#c13)• 17 years ago |
|  | |

Hi,
Imho Alfred Kayser's idea would be better (faster, and still safe).
However, Gavin Sharp's patch is still correct, it fixes the issue.
Regards,
Michael 'Gynvael Coldwind' Skladnikiewicz

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=408076#c14)• 17 years ago |
|  | |

Attached patch

[patch](attachment.cgi?id=292931&action=diff)
— [Details](attachment.cgi?id=292931&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931)

You're right Alfred, that is a better fix.Assignee: nobody → gavin.sharp
[Attachment #292914](/attachment.cgi?id=292914&action=edit "possible (incorrect) patch") -
Attachment is obsolete: true
[Attachment #292916](/attachment.cgi?id=292916&action=edit "better possible patch") -
Attachment is obsolete: trueStatus: NEW → ASSIGNED
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: superreview?(pavlov)
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: review?(alfredkayser)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a59717_103593)• 17 years ago |

Priority: -- → P1Target Milestone: --- → mozilla1.9 M11

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=408076#c15)• 17 years ago |
|  | |

The ICO decoder doesn't have this bug because it always uses the maximum value for mNumColors based on mBIH.bpp.

|  | [Alfred Kayser](/user_profile?user_id=35547) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=408076#c16)• 17 years ago |
|  | |

Actually this patch won't fix the reported problem completely.
In the current code mNumColors is set to "1 << mBIH.bpp",
assuming that the color table is large enough to cover all possible pixel values for resp. 1, 4 and 8 bpp (note that MSDN also says that the colormap could be used for bpp's 16 and 32...)
But, as the report in [comment #1](/show_bug.cgi?id=408076#c1 "RESOLVED FIXED - out of bounds read in BMP decoder can lead to information disclosure") says, the actual number of colorvalues in the table in the file is specified by biClrUser (if not zero)
MSDN: "biClrUser specifies the number of color indexes in the color table that are actually used by the bitmap. If this value is zero, the bitmap uses the maximum number of colors corresponding to the value of the biBitCount member for the compression mode specified by biCompression.
If biClrUsed is nonzero and the biBitCount member is less than 16, the biClrUsed member specifies the actual number of colors the graphics engine or device driver accesses.".
So, what actually needs to happen is that the mColors table is allocated according to bpp (as the pixel values coming from the image data are garanteed to be 1, 4 or 8 bit wide), but the decoder need to check for biClrUsed !=0 and in that case, only read that number colors from the file, and clear the table for the rest.
Note, that this is probably not really a security issue, as the decoder will now try to always read 256 color entries for the table, even if biClrUsed is < 256, resulting in using some of the actual image data itself for the colortable, and then the image data is itself will be not complete. So, the image will look like garbage, but one will not be able address any uninitialized values in the colortable... (but keep the 'security-sensitive' flag if really needed...).
So, now at least the colortable cleared and sane, but the reading of the image is not completely perfect.
P.s., the example code set biClrUsed to 'i', which is probably '256' given the code above? This is strange??Priority: P1 → --Target Milestone: mozilla1.9 M11 → ---

|  | [Alfred Kayser](/user_profile?user_id=35547) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=408076#c17)• 17 years ago |
|  | |

Comment on [attachment 292931](/attachment.cgi?id=292931 "patch") [[details]](/attachment.cgi?id=292931&action=edit "patch") [[diff]](/attachment.cgi?id=292931&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931)
patch
Need to add check for biClrUsed value !=0.
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: review?(alfredkayser) → review-

|  | [Alfred Kayser](/user_profile?user_id=35547) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=408076#c18)• 17 years ago |
|  | |

Tip:
Instead of:
mNumColors = 1 << mBIH.bpp;
if (mBIH.colors && mBIH.colors < mNumColors)
mNumColors = mBIH.colors;
mColors = new PRUint32[mNumColors];
if (!mColors)
return NS\_ERROR\_OUT\_OF\_MEMORY;
memset(mColors, 0, 256 \* sizeof(colorTable));
Do:
mNumColors = 1 << mBIH.bpp;
mColors = new PRUint32[mNumColors];
if (!mColors)
return NS\_ERROR\_OUT\_OF\_MEMORY;
memset(mColors, 0, mNumColors \* sizeof(colorTable));
if (mBIH.colors && mBIH.colors < mNumColors)
mNumColors = mBIH.colors;
As noted before, the index is never more than allowed by the 'bpp', but mBIH.colors can specify a smaller table. In the proposed way we allocate and clear the table according to bpp, and only read values according to mBIH.colors (if non-zero).

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=408076#c19)• 17 years ago |
|  | |

Comment on [attachment 292931](/attachment.cgi?id=292931 "patch") [[details]](/attachment.cgi?id=292931&action=edit "patch") [[diff]](/attachment.cgi?id=292931&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931)
patch
(In reply to [comment #18](/show_bug.cgi?id=408076#c18 "RESOLVED FIXED - out of bounds read in BMP decoder can lead to information disclosure"))
> In the proposed way we allocate and clear the table according to bpp, and only
> read values according to mBIH.colors (if non-zero).
My current patch already does that... it doesn't change the value of mNumColors, which is what we use to determine how many color entries to read. It merely changes how much memory we allocate to hold any potential color values, and zeroes it to ensure no UMR.
I don't understand your other comment, it sounds like a spec compliance issue that was pre-existing and is unrelated to this bug.
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: review- → review?(alfredkayser)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=408076#c20)• 17 years ago |
|  | |

(In reply to [comment #16](/show_bug.cgi?id=408076#c16 "RESOLVED FIXED - out of bounds read in BMP decoder can lead to information disclosure"))
> So, what actually needs to happen is that the mColors table is allocated
> according to bpp (as the pixel values coming from the image data are garanteed
> to be 1, 4 or 8 bit wide), but the decoder need to check for biClrUsed !=0 and
> in that case, only read that number colors from the file, and clear the table
> for the rest.
That's already what happens... biClrUsed is mBIH.colors, and we use it to set mNumColors with and without my patch.
I could tweak my patch to allocate only bpp\*8 colorTable entries, rather than the maximum of 256, if that's what you're concerned about.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=408076#c21)• 17 years ago |
|  | |

Michael Skladnikiewicz writes in mail to security@m.o.:
A very similar bug has been found in another vendors browser. Would it
be possible not to disclose any information about this bug until both
Firefox devs and the other vendors devs fix the issues ?
No doubt meaning what Gavin noted in [comment 10](/show_bug.cgi?id=408076#c10 "RESOLVED FIXED - out of bounds read in BMP decoder can lead to information disclosure") so I unhid that comment.
Whiteboard: [sg:moderate] → [sg:moderate] coordinate disclosure with other vendors, see comment 10

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=408076#c22)• 17 years ago |
|  | |

Comment on [attachment 292931](/attachment.cgi?id=292931 "patch") [[details]](/attachment.cgi?id=292931&action=edit "patch") [[diff]](/attachment.cgi?id=292931&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931)
patch
I also wrote a patch for this yesterday. Initially I also tried checking against mNumColors all the time and also came around to using a fixed-size table.
We could go with Alfred's suggestion of a variable sized table based on bpp, but the amount of memory saved is miniscule and simpler is better.
r=dveditz
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: review?(alfredkayser) → review+

|  | [Stuart Parmenter](/user_profile?user_id=5756) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a96576_5756)• 17 years ago |

[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: superreview?(pavlov) → superreview+

|  | [Alfred Kayser](/user_profile?user_id=35547) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=408076#c24)• 17 years ago |
|  | |

Just for the record, I am ok with the patch. It is the safest (in terms of protection and in terms of minimum impact) way, and won't harm that much.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=408076#c25)• 17 years ago |
|  | |

Thanks Alfred.
I landed this patch with a comment pointing to [bug 408256](/show_bug.cgi?id=408256 "VERIFIED FIXED - Use a constant-size buffer in BMP decoder to reduce fragmentation") to avoid pointing out that this was a security fix to malicious people watching Bonsai.
This is now fixed on the trunk:
mozilla/modules/libpr0n/decoders/bmp/nsBMPDecoder.cpp 1.38Status: ASSIGNED → RESOLVEDClosed: 17 years agoResolution: --- → FIXED

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=408076#c26)• 17 years ago |
|  | |

Branch approval (for Firefox 2.0.0.12) will also be tracked in that bug.Priority: -- → P1Target Milestone: --- → mozilla1.9 M11

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a134304_83595)• 17 years ago |

Flags: in-testsuite?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=408076#c27)• 17 years ago |
|  | |

fix in [bug 408256](/show_bug.cgi?id=408256 "VERIFIED FIXED - Use a constant-size buffer in BMP decoder to reduce fragmentation") checked into the branchKeywords: [fixed1.8.1.12](/buglist.cgi?keywords=fixed1.8.1.12&resolution=---)Whiteboard: [sg:moderate] coordinate disclosure with other vendors, see comment 10 → [sg:moderate] fix in bug 408256. coordinate disclosure with other vendors, see comment 10

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=408076#c28)• 17 years ago |
|  | |

Gavin, do I need to host this testcase elsewhere since your uploaded image is zipped?

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=408076#c29)• 17 years ago |
|  | |

(In reply to [comment #28](/show_bug.cgi?id=408076#c28 "RESOLVED FIXED - out of bounds read in BMP decoder can lead to information disclosure"))
> Gavin, do I need to host this testcase elsewhere since your uploaded image is
> zipped?
No, the image is there only to be used in the modified testcase - it's linked to directly using a jar: URI. All you need to do to verify is load the "modified testcase" ([attachment 292786](/attachment.cgi?id=292786 "modified testcase") [[details]](/attachment.cgi?id=292786&action=edit "modified testcase")) multiple times, and make sure you always see a solid black line and that the textbox contains all zeroes, rather than random colors/numbers.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=408076#c30)• 17 years ago |
|  | |

And that is, indeed, what I see. Thanks.
Verified in branch with Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.12pre) Gecko/2008011803 BonEcho/2.0.0.12pre.Keywords: [fixed1.8.1.12](/buglist.cgi?keywords=fixed1.8.1.12&resolution=---) → [verified1.8.1.12](/buglist.cgi?keywords=verified1.8.1.12&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=408076#c31)• 17 years ago |
|  | |

Any word from Apple or Opera on a fix date? I guess we shouldn't publish an advisory for 2.0.0.12 until we hear back.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a4947815_1689)• 17 years ago |

Alias: CVE-2008-0420

|  | [Gynvael Coldwind](/user_profile?user_id=295790) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=408076#c33)• 17 years ago |
|  | |

Guess it's 16 Feb, so You can publish it. I'll throw a bug description on bugtraq later today.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=408076#c34)• 17 years ago |
|  | |

unhiding bug, Gynvael Coldwind // Vexillium have released their advisory (and mention both Opera and Safari, so no need to scrub comments).Group: security

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a7193364_103593)• 17 years ago |

Flags: blocking1.8.0.15?

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a7772967_32335)• 17 years ago |

Flags: blocking1.8.0.15? → blocking1.8.0.15+

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=408076#a7801136_103593)• 17 years ago |

[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: approval1.8.0.15?

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=408076#c35)• 17 years ago |
|  | |

Comment on [attachment 292931](/attachment.cgi?id=292931 "patch") [[details]](/attachment.cgi?id=292931&action=edit "patch") [[diff]](/attachment.cgi?id=292931&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=408076&attachment=292931)
patch
a=caillon for the 1.8.0.15 branch
[Attachment #292931](/attachment.cgi?id=292931&action=edit "patch") -
Flags: approval1.8.0.15? → approval1.8.0.15+

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=408076#c36)• 17 years ago |
|  | |

Tested and landed on the 1.8.0 branch (still had an old build lying around!)Keywords: [fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)  Assignee |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=408076#c37)• 17 years ago |
|  | |

mozilla/modules/libpr0n/decoders/bmp/nsBMPDecoder.cpp 1.29.12.1
You need to [log in](/show_bug.cgi?id=408076&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from securityreason.com_2c51a29d_20250125_161858.html ===


---

# Security check:

Captcha. You know what to do. (CXSECURITYIDS)

---


