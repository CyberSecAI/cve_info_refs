=== Content from bugtraq.ru_e370fb64_20250124_161440.html ===


| информационная безопасность без паники и всерьез [**подробно о проекте**](/about/)[Rambler's Top100](http://top100.rambler.ru/top100/) | | [За кого нас держат?](/cgi-bin/bq.mcgi?id=87)[Сетевые кракеры и правда о деле Левина](/cgi-bin/bq.mcgi?id=130)[Страшный баг в Windows](/cgi-bin/bq.mcgi?id=89) | |
| --- | --- | --- | --- |
|  |  |
| | [BugTraq.Ru](//bugtraq.ru/) | | --- |   | |

 [Русский BugTraq](/) | | | [Анализ криптографических сетевых...](//bugtraq.ru/library/crypto/tls.html "Анализ криптографических сетевых протоколов транспортного уровня")  [Модель надежности двухузлового...](//bugtraq.ru/library/internals/dualnodecluster.html "Модель надежности двухузлового кластера высокой готовности")  [Специальные марковские модели надежности...](//bugtraq.ru/library/internals/markovspecialraid.html "Специальные марковские модели надежности отказоустойчивых систем хранения данных") |  | [С наступающим](//bugtraq.ru/rsn/archive/2024/12/01.html "С наступающим")  [Microsoft обещает радикально усилить...](//bugtraq.ru/rsn/archive/2024/11/01.html "Microsoft обещает радикально усилить безопасность Windows в следующем году")  [Ядро Linux избавляется от российских...](//bugtraq.ru/rsn/archive/2024/10/03.html "Ядро Linux избавляется от российских мейнтейнеров") | | --- | --- | --- | || | [главная](//bugtraq.ru/) |  | [обзор](//bugtraq.ru/review/) |  | [RSN](//bugtraq.ru/rsn/) |  | [блог](//bugtraq.ru/lj/) |  | [библиотека](//bugtraq.ru/library/) |  | [закон](//bugtraq.ru/law/) |  | [бред](//bugtraq.ru/bred/) |  | [форум](//bugtraq.ru/forum/) |  | [dnet](//bugtraq.ru/dnet/) |  | [о проекте](//bugtraq.ru/about/) |  |  | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | | |
| [bugtraq.ru](/) / [форум](/forum/) / [programming](/cgi-bin/forum.mcgi?type=sb&b=2) | | | Имя | Пароль |  | |

| |  |  |  | | --- | --- | --- | | [ФОРУМ](/forum/) | |  | |  | |  | |  | |  | |  | [все доски](/cgi-bin/forum.mcgi?type=sb) |  | |  | [FAQ](/cgi-bin/forum.mcgi?type=faq) |  | |  | [IRC](/cgi-bin/forum.mcgi?type=irc) |  | |  | [новые сообщения](/cgi-bin/forum.mcgi?type=sn) |  | |  | |  | |  | [site updates](/cgi-bin/forum.mcgi?type=sb&b=17) |  | |  | [guestbook](/cgi-bin/forum.mcgi?type=sb&b=14) |  | |  | [beginners](/cgi-bin/forum.mcgi?type=sb&b=20) |  | |  | [sysadmin](/cgi-bin/forum.mcgi?type=sb&b=16) |  | |  | [programming](/cgi-bin/forum.mcgi?type=sb&b=2) |  | | [operating systems](/cgi-bin/forum.mcgi?type=sb&b=21) | |  | | [theory](/cgi-bin/forum.mcgi?type=sb&b=15) | |  | | [web building](/cgi-bin/forum.mcgi?type=sb&b=19) | |  | | [software](/cgi-bin/forum.mcgi?type=sb&b=5) | |  | | [hardware](/cgi-bin/forum.mcgi?type=sb&b=7) | |  | | [networking](/cgi-bin/forum.mcgi?type=sb&b=4) | |  | | [law](/cgi-bin/forum.mcgi?type=sb&b=13) | |  | | [hacking](/cgi-bin/forum.mcgi?type=sb&b=6) | |  | | [gadgets](/cgi-bin/forum.mcgi?type=sb&b=9) | |  | | [job](/cgi-bin/forum.mcgi?type=sb&b=10) | |  | | [dnet](/cgi-bin/forum.mcgi?type=sb&b=1) | |  | | [humor](/cgi-bin/forum.mcgi?type=sb&b=18) | |  | | [miscellaneous](/cgi-bin/forum.mcgi?type=sb&b=8) | |  | | [scrap](/cgi-bin/forum.mcgi?type=sb&b=12) | |  | |  | |  | | [регистрация](/cgi-bin/forum.mcgi?type=register) | |  | |  | |  |      **Легенда:**    новое сообщение   закрытая нитка   новое сообщение   в закрытой нитке   старое сообщение | * Напоминаю, что масса вопросов по функционированию форума снимается после прочтения [его описания](//bugtraq.ru/cgi-bin/forum.mcgi?type=sm).* Новичкам также крайне полезно ознакомиться с [данным документом](//bugtraq.ru/forum/faq/general/smart-questions.html).  | **BSOD в win32k.sys** *02.11.08 08:03*  Число просмотров: 36272 Автор: Killer{R} <Dmitry> Статус: Elderman  | <["чистая" ссылка](/forum/full/2008/programming/152274.html)> |  | | --- | --- | | | --- | --- | --- | | Предисловие: привет amirul ;) Давече дописывал тут одну свою фриварную тулзу (HKM) и напоролся на бсод, вызываемый юзермодным кодом без админских прав. workaround от бсода я придумал, ибо негоже мелкой тулзе винду убивать, но сам бсод - есть баг микрософтовский. И вот относительно минимальный, исключительно юзермодный код, которым он воспроизводится: Готовый проект для VC6 (с откомпиленными бинарями) можно скачать тут: <http://slil.ru/26296017> Исходники, а то долго рассказывать что код делает: hookproc.dll: ``` ,  BOOL APIENTRY DllMain( HANDLE hModule,                         DWORD  ul_reason_for_call,                         LPVOID lpReserved 					 ) {     return TRUE; }  extern "C" __declspec(dllexport) LRESULT CALLBACK DummyHookProc(int nCode, WPARAM wParam,LPARAM lParam) {     ::Sleep(0);     return ::CallNextHookEx(0, nCode, wParam, lParam); }   ``` ---, launch.exe: ``` ,  extern "C" __declspec(dllimport) LRESULT CALLBACK DummyHookProc(int nCode, WPARAM wParam,LPARAM lParam); HANDLE g_stop_event = CreateEvent(NULL, TRUE, FALSE, NULL);   DWORD CALLBACK WinThreadProc(PVOID p) {     TCHAR name[32];     if (p)         wsprintf(name, "desk_%x", p);     else         wsprintf(name, "default");     HDESK desk = ::CreateDesktop(name, 0, 0, 0, GENERIC_ALL, 0);     HDESK old_desk = ::GetThreadDesktop(::GetCurrentThreadId());     ::SetThreadDesktop(desk);      for(int i=0; i<8; i++)     {         CreateWindow(TEXT("STATIC"), TEXT("dummy"),              WS_VISIBLE, 10, i*30, 200, 30, 0, 0, 0, 0);     }     MSG msg;     while (1)      {          ::GetMessage(&msg, NULL, 0, 0);         ::TranslateMessage(&msg);          ::DispatchMessage(&msg);      }     ::SetThreadDesktop(old_desk);     ::CloseDesktop(desk);     return 0; }  DWORD CALLBACK ThreadProc(PVOID p) {     TCHAR name[32];     if (p)         wsprintf(name, "desk_%x", p);     else         wsprintf(name, "default");          HDESK desk = ::CreateDesktop(name, 0, 0, 0, GENERIC_ALL, 0);     ::SwitchDesktop(desk);     ::Sleep(0);     HDESK old_desk = ::GetThreadDesktop(::GetCurrentThreadId());     ::SetThreadDesktop(desk);     HINSTANCE dll = ::GetModuleHandle(TEXT("HOOKPROC.dll"));     HHOOK hk1 = ::SetWindowsHookEx(WH_MOUSE, DummyHookProc, dll, 0);     HHOOK hk2 = ::SetWindowsHookEx(WH_CALLWNDPROC, DummyHookProc, dll, 0);     HHOOK hk3 = ::SetWindowsHookEx(WH_CALLWNDPROCRET, DummyHookProc, dll, 0);     HHOOK hk4 = ::SetWindowsHookEx(WH_GETMESSAGE, DummyHookProc, dll, 0);          for (;;)     {         MSG msg;         while (::PeekMessage(&msg, NULL, 0, 0, PM_REMOVE))          {              ::TranslateMessage(&msg);              ::DispatchMessage(&msg);          }                  if (::MsgWaitForMultipleObjects(1, &g_stop_event,              FALSE, INFINITE, QS_ALLINPUT) == WAIT_OBJECT_0)         {             break;         }     }     ::SwitchDesktop(old_desk);     ::Sleep(0);      ::UnhookWindowsHookEx(hk1);     ::UnhookWindowsHookEx(hk2);     ::UnhookWindowsHookEx(hk3);     ::UnhookWindowsHookEx(hk4); 	::PostMessage(HWND_BROADCAST, WM_NULL, 0, 0); 	::SendNotifyMessage(HWND_BROADCAST, WM_NULL, 0, 0);     ::SetThreadDesktop(old_desk);     ::CloseDesktop(desk);     return 0;  }  int APIENTRY WinMain(HINSTANCE hInstance,                      HINSTANCE hPrevInstance,                      LPSTR     lpCmdLine,                      int       nCmdShow) {      int i;     for(i=0; i<4; i++)     {         ::CloseHandle(::CreateThread(NULL, 0, WinThreadProc, (LPVOID)i, 0, NULL));     }      ::Sleep(1000);;     while((::GetAsyncKeyState(VK_ESCAPE)&32768)==0)     {         for(i=0; i<4; i++)         {             HANDLE trd = ::CreateThread(NULL, 0, ThreadProc, (LPVOID)i, 0, NULL);             ::Sleep(500);             ::SetEvent(g_stop_event);             ::WaitForSingleObject(trd, INFINITE);             ::ResetEvent(g_stop_event);             ::CloseHandle(trd);         }     }  	return 0; }   ``` ---, BSOD'ятся или жестко зависают в течении нескольких минут работы проги 2к3 на одноядерном атлоне, и Vista x86 на двухядерном интеле. Стек бсода с висты: ```  ChildEBP RetAddr  Args to Child               8f5ac728 81e835a0 0000008e c0000005 97915cd3 nt!KeBugCheckEx+0x1e 8f5acaf8 81ea563a 8f5acb14 00000000 8f5acb68 nt!KiDispatchException+0x1a9 8f5acb60 81ea55ee 8f5acc5c 97915cd3 badb0d00 nt!CommonDispatchException+0x4a (FPO: [0,20,0]) 8f5acb80 81f02215 0000000b 948f53f0 00000000 nt!KiExceptionExit+0x186 8f5acc5c 97991dad 15e02058 00000000 00000000 nt!EtwTraceContextSwap+0x14a 8f5acc78 979d9b8b 00000000 00000000 00000000 win32k!xxxCallNextHookEx+0x35 (FPO: [Non-Fpo]) 8f5acccc 979166ed fbe024f0 00000005 00000000 win32k!fnHkINLPCWPEXSTRUCT+0x5d (FPO: [Non-Fpo]) 8f5acce8 9793d674 fbe024f0 00000005 00000000 win32k!NtUserfnDWORD+0x27 (FPO: [Non-Fpo]) 8f5acd20 81ea4a7a 005d00bc 00000005 00000000 win32k!NtUserMessageCall+0xc6 (FPO: [Non-Fpo]) 8f5acd20 77549a94 005d00bc 00000005 00000000 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 8f5acd44) 06ecea5c 76b48871 76b70b70 005d00bc 00000005 ntdll!KiFastSystemCallRet (FPO: [0,0,0]) 06ecea60 76b70b70 005d00bc 00000005 00000000 USER32!NtUserMessageCall+0xc (FPO: [Non-Fpo])*WARNING: Unable to verify checksum for hookproc.dll*ERROR: Symbol file could not be found.  Defaulted to export symbols for hookproc.dll -  06ecea90 1000102f 00000000 00000000 00000000 USER32!CallNextHookEx+0x10b (FPO: [Non-Fpo]) WARNING: Stack unwind information not available. Following frames may be wrong. 06ecead8 76b929ff 00040000 00000000 06eceaf0 hookproc!DummyHookProc+0x1f 06eceb00 76b50a65 084124f0 00000005 00000000 USER32!fnHkINLPCWPSTRUCTA+0x4f (FPO: [Non-Fpo]) 06eceb28 775499ce 06eceb40 00000018 06ecf208 USER32!__fnDWORD+0x24 (FPO: [Non-Fpo]) 06eceb54 76b43cf7 76b43b94 00000088 06ecee80 ntdll!KiUserCallbackDispatcher+0x2e (FPO: [0,0,0]) 06eceb58 76b43b94 00000088 06ecee80 06eceba8 USER32!NtUserCreateWindowEx+0xc (FPO: [Non-Fpo]) 06ecedfc 76b43cc3 00000088 06ecee80 06ecee94 USER32!VerNtUserCreateWindowEx+0x1ac (FPO: [Non-Fpo]) 06eceea8 76b43d9a 00000088 6ff5239c 06ecee94 USER32!_CreateWindowEx+0x1f9 (FPO: [Non-Fpo])  ``` --- |   | |  | <[programming](/cgi-bin/forum.mcgi?type=sb&b=2)> | [Поиск](/cgi-bin/forum.mcgi?type=search) | | --- | --- | --- | |  | * **BSOD в win32k.sys** - **Killer{R}** *02.11.08 08:03 [36272]*   + [Вроде ответили, что форварднули куда надо.](/cgi-bin/forum.mcgi?type=sb&b=2&m=152303) - **amirul** *04.11.08 09:33 [10559]*     - [А ктото говорил что не было ошибок в вин32к ;)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152307) - **Killer{R}** *04.11.08 11:18 [10454]*       * [Ну тогда мне выдали 2. Это третья](/cgi-bin/forum.mcgi?type=sb&b=2&m=152308) - **amirul** *04.11.08 11:36 [6967]*         + [Проблема такого кода в том что его модифицировать опасно...](/cgi-bin/forum.mcgi?type=sb&b=2&m=152309) - **Killer{R}** *04.11.08 11:50 [6244]*           - (!) [Согласен](/cgi-bin/forum.mcgi?type=sb&b=2&m=152313) - **amirul** *04.11.08 21:34 [8420]*+ [И тебе привет :-)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152276) - **amirul** *02.11.08 10:04 [5753]*       - [На работе проверил на ХР и Висте х64. ХР вроде не...](/cgi-bin/forum.mcgi?type=sb&b=2&m=152291 "На работе проверил на ХР и Висте х64. ХР вроде не падает а...") - **Killer{R}** *03.11.08 15:25 [4491]*         * [Есть репродюс на висте и одной из последних сборок вин7 :-)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152293) - **amirul** *03.11.08 21:58 [4508]*           + [может, в рассылку багтрака? :)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152294) **(-)**  - **Killer{R}** *03.11.08 22:11 [4317]*             - [Можно и туда. По моему вполне себе новость. Но реш...](/cgi-bin/forum.mcgi?type=sb&b=2&m=152295 "Можно и туда. По моему вполне себе новость. Но решение за dl-ем :-)") **(-)**  - **amirul** *03.11.08 22:28 [4382]*               * [легко, если это будет сформулировано словами :)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152296) - **dl** *03.11.08 22:59 [3961]*                 + [Примерно такими? :)](/cgi-bin/forum.mcgi?type=sb&b=2&m=152298) - **Killer{R}** *03.11.08 23:35 [4306]*                   - [вполне, спасибо; запостил](/cgi-bin/forum.mcgi?type=sb&b=2&m=152300) **(-)**  - **dl** *04.11.08 01:16 [3871]*+ [Предположительно изза race condition с потоком который...](/cgi-bin/forum.mcgi?type=sb&b=2&m=152297) - **Killer{R}** *03.11.08 23:08 [4090]* | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Рейтинг@Mail.ru      [Rambler's Top100](http://top100.rambler.ru/top100/)   [Рейтинг@Mail.ru](http://top.mail.ru/jump?from=186533) |  |

| [Copyright © 2001-2025 Dmitry Leonov](/about/#copyright) | Page build time: 0 s | Design: Vadim Derkach |
| --- | --- | --- |


