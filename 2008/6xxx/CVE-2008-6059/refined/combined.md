=== Content from trac.webkit.org_83a454e4_20250124_211131.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Change](/changeset/38418/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp "Changeset 38418 for trunk/WebCore/xml/XMLHttpRequest.cpp")
* [Next Change](/changeset/38680/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp "Changeset 38680 for trunk/WebCore/xml/XMLHttpRequest.cpp") →

---

# Changeset [38566](/changeset/38566/webkit "Show full changeset") in webkit for [trunk/WebCore/xml/XMLHttpRequest.cpp](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Nov 18, 2008, 10:23:02 AM
([16 years](/timeline?from=2008-11-18T10%3A23%3A02-08%3A00&precision=second "See timeline at Nov 18, 2008, 10:23:02 AM") ago)
Author:
Darin Adler
Message:

WebCore:

2008-11-18 Darin Adler <Darin Adler>

> Reviewed by Alexey Proskuryakov.

* first cut at [​https://bugs.webkit.org/show\_bug.cgi?id=10957](https://bugs.webkit.org/show_bug.cgi?id=10957)
  <rdar://problem/5516594> please add support for HTTP-only cookies

> Test: http/tests/xmlhttprequest/get-dangerous-headers.html

> No test for HTTP-only support in JavaScript yet, since the Mac and Win changes
>
> require an updated CFNetwork.

* platform/mac/CookieJar.mm:
  (WebCore::isHTTPOnly): Added.
  (WebCore::filterCookies): Added.
  (WebCore::cookies): Use filterCookies to prevent getting HTTP-only cookies.
  (WebCore::setCookies): Use filterCookies to prevent setting HTTP-only cookies.

* platform/network/win/CookieJarCFNetWin.cpp:
  (WebCore::isHTTPOnly): Added.
  (WebCore::filterCookies): Added.
  (WebCore::setCookies): Use filterCookies to prevent getting HTTP-only cookies.
  (WebCore::cookies): Use filterCookies to prevent getting HTTP-only cookies.

* xml/XMLHttpRequest.cpp:
  (WebCore::isSetCookieHeader): Added.
  (WebCore::XMLHttpRequest::getAllResponseHeaders): Hide Set-Cookie headers from
  clients that don't have local-resource privileges.
  (WebCore::XMLHttpRequest::getResponseHeader): Ditto.

* clean soup-specific details out of shared cookie jar header

* platform/CookieJar.h: Removed the soup-specific parts of this.
* platform/network/soup/CookieJarSoup.cpp: Changed to include
  CookieJarSoup.h. Tweaked implementation a bit to handle UTF-8 better.
* platform/network/soup/CookieJarSoup.h: Added. Has the Soup-specified
  part of CookieJar.h.
* platform/network/soup/ResourceHandleSoup.cpp: Changed to include
  CookieJarSoup.h.

LayoutTests:

2008-11-18 Darin Adler <Darin Adler>

> Reviewed by Alexey Proskuryakov.

* add a test for XMLHttpRequest Set-Cookie blocking

* http/tests/xmlhttprequest/access-control-basic-whitelist-response-headers-expected.txt:
  Updated since we now log attempts to get headers that are not allowed cross-domain to the console.
* http/tests/xmlhttprequest/get-dangerous-headers-expected.txt: Added.
* http/tests/xmlhttprequest/get-dangerous-headers.html: Added.
* http/tests/xmlhttprequest/resources/get-set-cookie.cgi: Tweak script a bit.

File:

1 edited

* [trunk/WebCore/xml/XMLHttpRequest.cpp](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566 "Show entry in browser")
  (modified)
  ([5 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/WebCore/xml/XMLHttpRequest.cpp](/changeset/38566/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp "Show the changeset 38566 restricted to trunk/WebCore/xml/XMLHttpRequest.cpp")

  | [r38418](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38418#L167 "Show revision 38418 of this file in browser") | [r38566](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566#L167 "Show revision 38566 of this file in browser") |  |
  | --- | --- | --- |
  | 167 | 167 | } |
  | 168 | 168 |  |
  |  | 169 | static bool isSetCookieHeader(const String& name) |
  |  | 170 | { |
  |  | 171 | return equalIgnoringCase(name, "set-cookie") || equalIgnoringCase(name, "set-cookie2"); |
  |  | 172 | } |
  |  | 173 |  |
  | 169 | 174 | XMLHttpRequest::XMLHttpRequest(Document\* doc) |
  | 170 | 175 | : ActiveDOMObject(doc, this) |
  | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38418#L841) | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566#L846) |  |
  | 841 | 846 | m\_mimeTypeOverride = override; |
  | 842 | 847 | } |
  | 843 |  |  |
  |  | 848 |  |
  |  | 849 | static void reportUnsafeUsage(Document\* document, const String& message) |
  |  | 850 | { |
  |  | 851 | if (!document) |
  |  | 852 | return; |
  |  | 853 | Frame\* frame = document->frame(); |
  |  | 854 | if (!frame) |
  |  | 855 | return; |
  |  | 856 | // It's not good to report the bad usage without indicating what source line it came from. |
  |  | 857 | // We should pass additional parameters so we can tell the console where the mistake occurred. |
  |  | 858 | frame->domWindow()->console()->addMessage(JSMessageSource, ErrorMessageLevel, message, 1, String()); |
  |  | 859 | } |
  |  | 860 |  |
  | 844 | 861 | void XMLHttpRequest::setRequestHeader(const String& name, const String& value, ExceptionCode& ec) |
  | 845 | 862 | { |
  | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38418#L862) | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566#L879) |  |
  | 862 | 879 | // A privileged script (e.g. a Dashboard widget) can set any headers. |
  | 863 | 880 | if (!document()->securityOrigin()->canLoadLocalResources() && !isSafeRequestHeader(name)) { |
  | 864 |  | if (document() && document()->frame()) |
  | 865 |  | document()->frame()->domWindow()->console()->addMessage(JSMessageSource, ErrorMessageLevel, "Refused to set unsafe header \"" + name + "\"", 1, String()); |
  |  | 881 | reportUnsafeUsage(document(), "Refused to set unsafe header \"" + name + "\""); |
  | 866 | 882 | return; |
  | 867 | 883 | } |
  | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38418#L890) | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566#L906) |  |
  | 890 | 906 |  |
  | 891 | 907 | Vector<UChar> stringBuilder; |
  | 892 |  | ~~String separator(": ");~~ |
  | 893 | 908 |  |
  | 894 | 909 | HTTPHeaderMap::const\_iterator end = m\_response.httpHeaderFields().end(); |
  | 895 | 910 | for (HTTPHeaderMap::const\_iterator it = m\_response.httpHeaderFields().begin(); it!= end; ++it) { |
  |  | 911 | // Hide Set-Cookie header fields from the XMLHttpRequest client for these reasons: |
  |  | 912 | //     1) If the client did have access to the fields, then it could read HTTP-only |
  |  | 913 | //        cookies; those cookies are supposed to be hidden from scripts. |
  |  | 914 | //     2) There's no known harm in hiding Set-Cookie header fields entirely; we don't |
  |  | 915 | //        know any widely used technique that requires access to them. |
  |  | 916 | //     3) Firefox has implemented this policy. |
  |  | 917 | if (isSetCookieHeader(it->first) && !document()->securityOrigin()->canLoadLocalResources()) |
  |  | 918 | continue; |
  |  | 919 |  |
  | 896 | 920 | if (!m\_sameOriginRequest && !isOnAccessControlResponseHeaderWhitelist(it->first)) |
  | 897 | 921 | continue; |
  | 898 | 922 |  |
  | 899 | 923 | stringBuilder.append(it->first.characters(), it->first.length()); |
  | 900 |  | stringBuilder.append(separator.characters(), separator.length()); |
  |  | 924 | stringBuilder.append(':'); |
  |  | 925 | stringBuilder.append(' '); |
  | 901 | 926 | stringBuilder.append(it->second.characters(), it->second.length()); |
  | 902 |  | stringBuilder.append(~~(UChar)~~'\r'); |
  | 903 |  | stringBuilder.append(~~(UChar)~~'\n'); |
  |  | 927 | stringBuilder.append('\r'); |
  |  | 928 | stringBuilder.append('\n'); |
  | 904 | 929 | } |
  | 905 | 930 |  |
  | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38418#L917) | […](/browser/webkit/trunk/WebCore/xml/XMLHttpRequest.cpp?rev=38566#L942) |  |
  | 917 | 942 | return ""; |
  | 918 | 943 |  |
  | 919 |  | if (!m\_sameOriginRequest && !isOnAccessControlResponseHeaderWhitelist(name)) |
  |  | 944 | // See comment in getAllResponseHeaders above. |
  |  | 945 | if (isSetCookieHeader(name) && !document()->securityOrigin()->canLoadLocalResources()) { |
  |  | 946 | reportUnsafeUsage(document(), "Refused to get unsafe header \"" + name + "\""); |
  | 920 | 947 | return ""; |
  |  | 948 | } |
  |  | 949 |  |
  |  | 950 | if (!m\_sameOriginRequest && !isOnAccessControlResponseHeaderWhitelist(name)) { |
  |  | 951 | reportUnsafeUsage(document(), "Refused to get unsafe header \"" + name + "\""); |
  |  | 952 | return ""; |
  |  | 953 | } |
  | 921 | 954 |  |
  | 922 | 955 | return m\_response.httpHeaderField(name); |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=38566)
* [Zip Archive](?format=zip&new=38566)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.webkit.org_9b272909_20250124_211133.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=10957&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[10957](show_bug.cgi?id=10957)

HttpOnly Cookie Option
```
https://bugs.webkit.org/show_bug.cgi?id=10957
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
HttpOnly Cookie Option

Robert Sesek

[Reported](show_bug.cgi?id=10957#c0)
2006-09-20 17:25:34 PDT

In the web development arena, HttpOnly cookies have become quite the buzz. It basically disallows JavaScript access to a cookie when it is sent with the HttpOnly flag. Currently only IE supports it, but Firefox is looking into it. I think it'd be very helpful to have (especially since PHP 5.2 will now support it--meaning lots of developers will use it). I've linked to Microsoft's spec on the flag.

| Attachments | | |
| --- | --- | --- |
| [**test case (for http/tests/security)**](attachment.cgi?id=17845 "View the content of the attachment") (423 bytes, application/octet-stream)  [2007-12-11 08:30 PST](#attach_17845 "Go to the comment associated with the attachment"), Alexey Proskuryakov | *no flags* | [Details](attachment.cgi?id=17845&action=edit) |
| [**patch; someone needs to help me make more regression tests**](attachment.cgi?id=25220 "View the content of the attachment") (16.76 KB, patch)  [2008-11-17 10:19 PST](#attach_25220 "Go to the comment associated with the attachment"), Darin Adler | *no flags* | [Details](attachment.cgi?id=25220&action=edit)[Formatted Diff](attachment.cgi?id=25220&action=prettypatch)[Diff](attachment.cgi?id=25220&action=diff) |
| [**patch**](attachment.cgi?id=25222 "View the content of the attachment") (23.44 KB, patch)  [2008-11-17 12:25 PST](#attach_25222 "Go to the comment associated with the attachment"), Darin Adler | ap: review+ | [Details](attachment.cgi?id=25222&action=edit)[Formatted Diff](attachment.cgi?id=25222&action=prettypatch)[Diff](attachment.cgi?id=25222&action=diff) |
| [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=10957&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=10957&action=enter) *proposed patch, testcase, etc.* | | |

Alexey Proskuryakov

[Comment 1](show_bug.cgi?id=10957#c1)
2006-09-20 21:51:19 PDT

Mozilla bug: <<https://bugzilla.mozilla.org/show_bug.cgi?id=178993>>.

Alexey Proskuryakov

[Comment 2](show_bug.cgi?id=10957#c2)
2007-12-11 08:28:42 PST

This is now implemented in Firefox 2 and Opera 9.5.
This looks like a pretty important feature to me, but we need support from underlying system frameworks to implement it. A request to add such support is tracked by <rdar://problem/4154226>.

Alexey Proskuryakov

[Comment 3](show_bug.cgi?id=10957#c3)
2007-12-11 08:30:33 PST

Created [attachment 17845](attachment.cgi?id=17845 "test case (for http/tests/security)") [[details]](attachment.cgi?id=17845&action=edit "test case (for http/tests/security)")
test case (for http/tests/security)

David Kilzer (:ddkilzer)

[Comment 4](show_bug.cgi?id=10957#c4)
2007-12-12 06:19:28 PST

<rdar://problem/5642992>

Jim Manico

[Comment 5](show_bug.cgi?id=10957#c5)
2008-03-25 23:28:33 PDT

Safari is the last browser to lack HttpOnly support. I for one think it's a critical need to bring Safari's browser security in line with the rest of the industry.

Jim Manico

[Comment 6](show_bug.cgi?id=10957#c6)
2008-03-27 18:47:04 PDT

(from Robert)
The problem isn't entirely with WebKit itself, but with the underlying implementation of HTTP. Safari uses CFNetwork on the mac to parse HTTP headers into objects. Unfortunately, this code isn't public, and it's this code that needs to be changed in order for HTTPOnly to be implemented. While preventing DOM/JavaScript access to cookies needs to be done in the WebKit source, until the underlying network implementation is updated to parse the HTTPOnly flag, there's no way this is possible.
So in short, Apple is blocking this bug from being fixed. Once they update CFNetwork, progress on this patch can be made. Until then, no dice. I recommend you file a bug in RadarWeb if you're interested in getting HTTPOnly/CFNetwork done.

Alexey Proskuryakov

[Comment 7](show_bug.cgi?id=10957#c7)
2008-03-27 23:52:03 PDT

As mentioned above, there is already a Radar bug filed about this (which was closed as a duplicate of <rdar://problem/4154226>). As always, you are welcome to file another bug, citing your specific use case; please include this original bug number if you decide to file it, to ensure that it is handled right when screening.

Jim Manico

[Comment 8](show_bug.cgi?id=10957#c8)
2008-03-28 01:01:20 PDT

(In reply to [comment #7](show_bug.cgi?id=10957#c7))
> As mentioned above, there is already a Radar bug filed about this (which was
> closed as a duplicate of <rdar://problem/4154226>). As always, you are welcome
> to file another bug, citing your specific use case; please include this
> original bug number if you decide to file it, to ensure that it is handled
> right when screening.
>
Alex, my apologies. I'm not certain how to access rdar://problem/5642992 - is there an Internet facing URL for this problem, or is rdar for Apple employees only?

Alexey Proskuryakov

[Comment 9](show_bug.cgi?id=10957#c9)
2008-03-28 01:36:57 PDT

The latter is correct - it's only accessible to Apple folks.

Jim Manico

[Comment 10](show_bug.cgi?id=10957#c10)
2008-03-28 10:11:50 PDT

So, a closed source proprietary library is blocking an open source project from adding a key security feature that the rest of the browser industry supports? I smell a rat. It might be at rdar but it sure sounds "off the radar" to me.

Robert Sesek

[Comment 11](show_bug.cgi?id=10957#c11)
2008-04-01 05:55:32 PDT

Apple isn't the only company we're waiting on to get HttpOnly support. Qt/Trolltech is also lacking HttpOnly support in QNetworkCookie. I filed [bug #205188](show_bug.cgi?id=205188 "RESOLVED FIXED - [Clipboard API] Sanitize HTML and image data written using clipboard.write") with them to get QNetworkCookie::isHttpOnly() added.

Jim Manico

[Comment 12](show_bug.cgi?id=10957#c12)
2008-04-01 22:58:56 PDT

Robert, thank you very kindly for taking to time to submit a bug to Qt/Trolltech.

Robert Sesek

[Comment 13](show_bug.cgi?id=10957#c13)
2008-04-07 06:24:16 PDT

Here's the public issue for Qt: <http://trolltech.com/developer/task-tracker/index_html?id=206125&method=entry>

Jim Manico

[Comment 14](show_bug.cgi?id=10957#c14)
2008-05-22 12:33:59 PDT

The Java EE Servlet 3.0 spec now includes support for the HttpOnly cookie. This is just more evidence that HttpOnly is becoming a widespread non-MS standard and is worthy of Safari support.

Darin Adler

[Comment 15](show_bug.cgi?id=10957#c15)
2008-05-22 12:35:37 PDT

It should definitely be supported by Safari!
I'm not sure why having a WebKit bug report open for this is helpful, though. It's not something handled by WebKit, and adding this to the CFNetwork library used on Mac OS X won't require any WebKit code changes.

Jim Manico

[Comment 16](show_bug.cgi?id=10957#c16)
2008-05-22 12:40:57 PDT

Thank you Darin! I'm grateful that someone at Apple agrees that we need HttpOnly support in Safari. Safari is the last holdout - Opera, IE and FireFox all support HttpOnly!
Will the trolltech issue posted in [comment #13](show_bug.cgi?id=10957#c13) cover this issue? Of is there another place we can post a bug?

Darin Adler

[Comment 17](show_bug.cgi?id=10957#c17)
2008-05-22 12:43:38 PDT

(In reply to [comment #16](show_bug.cgi?id=10957#c16))
> Thank you Darin! I'm grateful that someone at Apple agrees that we need
> HttpOnly support in Safari. Safari is the last holdout - Opera, IE and FireFox
> all support HttpOnly!
>
> Will the trolltech issue posted in [comment #13](show_bug.cgi?id=10957#c13) cover this issue? Of is there
> another place we can post a bug?
It's actually [comment #7](show_bug.cgi?id=10957#c7) that covers the Safari issue. What Alexey said is exactly right.

Robert Sesek

[Comment 18](show_bug.cgi?id=10957#c18)
2008-05-22 13:13:56 PDT

(In reply to [comment #15](show_bug.cgi?id=10957#c15))
> I'm not sure why having a WebKit bug report open for this is helpful, though.
> It's not something handled by WebKit, and adding this to the CFNetwork library
> used on Mac OS X won't require any WebKit code changes.
I think a code change to the WebCore/platform still needs to be made. Looking at the various CookieJar classes, it looks like it will be up to WebCore to disregard HttpOnly cookies -- they will still be passed to us from the underlying network layer. So I do think this bug needs to be open; however, maybe the component should be changed to WebCore?
(In reply to [comment #16](show_bug.cgi?id=10957#c16))
> Will the trolltech issue posted in [comment #13](show_bug.cgi?id=10957#c13) cover this issue? Of is there
> another place we can post a bug?
Trolltech fixed this for the upcoming v4.5 of Qt. I'm currently working on compiling Qt and testing a patch I have made for the Qt-backed WebKit.

Darin Adler

[Comment 19](show_bug.cgi?id=10957#c19)
2008-05-22 13:20:33 PDT

(In reply to [comment #18](show_bug.cgi?id=10957#c18))
> I think a code change to the WebCore/platform still needs to be made. Looking
> at the various CookieJar classes, it looks like it will be up to WebCore to
> disregard HttpOnly cookies -- they will still be passed to us from the
> underlying network layer.
I see. You're right -- it might turn out that way. Another design would be to have HttpOnly cookies entirely invisible to the old API and add new API that allows clients to see them. I guess we won't know what's required until this gets implemented by the networking layer.

Robert Sesek

[Comment 20](show_bug.cgi?id=10957#c20)
2008-05-22 13:51:33 PDT

(In reply to [comment #19](show_bug.cgi?id=10957#c19))
> (In reply to [comment #18](show_bug.cgi?id=10957#c18))
> > I think a code change to the WebCore/platform still needs to be made. Looking
> > at the various CookieJar classes, it looks like it will be up to WebCore to
> > disregard HttpOnly cookies -- they will still be passed to us from the
> > underlying network layer.
>
> I see. You're right -- it might turn out that way. Another design would be to
> have HttpOnly cookies entirely invisible to the old API and add new API that
> allows clients to see them. I guess we won't know what's required until this
> gets implemented by the networking layer.
>
Looking at Qt's implementation in the 4.5 snapshot, you get all the cookies and then have to call isHttpOnly() on QNetworkCookie to figure out whether or not you keep it in the CookieJar.

Alexey Proskuryakov

[Comment 21](show_bug.cgi?id=10957#c21)
2008-07-07 22:15:57 PDT

Something else that will need to be done at WebCore level is filtering out HttpOnly cookies from XMLHttpRequest getResponseHeader results.

Alexey Proskuryakov

[Comment 22](show_bug.cgi?id=10957#c22)
2008-07-07 22:17:02 PDT

See also: <https://bugzilla.mozilla.org/show_bug.cgi?id=380418>

Jim Manico

[Comment 23](show_bug.cgi?id=10957#c23)
2008-07-08 12:38:15 PDT

<http://www.owasp.org/index.php/HTTPOnly> is also a great reference. Complete implementation includes read and write prevention though document.cookie, as well prevention of reading or writing the session cookie via a XMLHTTPRequest.

Jim Manico

[Comment 24](show_bug.cgi?id=10957#c24)
2008-07-08 12:39:19 PDT

Let me correct that:
<http://www.owasp.org/index.php/HTTPOnly> is also a great reference. Complete
implementation includes read and write prevention of HttpOnly cookies though document.cookie, as well as prevention of reading or writing HttpOnly cookies via a XMLHTTPRequest.

Darin Adler

[Comment 25](show_bug.cgi?id=10957#c25)
2008-11-17 09:38:30 PST

(In reply to [comment #24](show_bug.cgi?id=10957#c24))
> <http://www.owasp.org/index.php/HTTPOnly> is also a great reference. Complete
> implementation includes read and write prevention of HttpOnly cookies though
> document.cookie, as well as prevention of reading or writing HttpOnly cookies
> via a XMLHTTPRequest.
That page doesn't mention prevention of writing HttpOnly cookies vis XMLHttpRequest. Should that really be prevented? Does any browser currently do that?

Darin Adler

[Comment 26](show_bug.cgi?id=10957#c26)
2008-11-17 10:19:33 PST

Created [attachment 25220](attachment.cgi?id=25220&action=diff "patch; someone needs to help me make more regression tests") [[details]](attachment.cgi?id=25220&action=edit "patch; someone needs to help me make more regression tests")
patch; someone needs to help me make more regression tests

Darin Adler

[Comment 27](show_bug.cgi?id=10957#c27)
2008-11-17 10:21:22 PST

Loose ends that need to be resolved:
1) include test cases in the patch
2) figure out how to compile the CFNetwork version
3) [optional] add implementations for other platforms that have HTTP-only support in the networking layers (e.g. Qt)

Darin Adler

[Comment 28](show_bug.cgi?id=10957#c28)
2008-11-17 12:25:17 PST

Created [attachment 25222](attachment.cgi?id=25222&action=diff "patch") [[details]](attachment.cgi?id=25222&action=edit "patch")
patch
Windows side is not compiled or tested yet.

Jim Manico

[Comment 29](show_bug.cgi?id=10957#c29)
2008-11-17 18:03:12 PST

Sorry, my mistake.
I was referring to preventing XMLHTTPRequest access to set-cookie and set-cookie2 response headers - for HTTPOnly cookies.
There is no need to prevent write prevention via XMLHTTPRequest response headers. (no such thing)

Jim Manico

[Comment 30](show_bug.cgi?id=10957#c30)
2008-11-17 18:08:12 PST

Actually, the HttpOnly RFC working group says:
When the server sends a Set-Cookie or Set-Cookie2 header with the HTTPOnly flag set, the client should:
(1) Prevent client-side scripts from reading Cookie or Cookie2 values
(2) Prevent client-side scripts from writing Cookie or Cookie2 values
(3) Prevent client-side scripts from reading Set-Cookie or Set-Cookie2 response headers (via XHR)
(4) Prevent client-side scripts from writing Cookie or Cookie2 request headers (via XHR)
Let me get more info and post back asap.

Adam Barth

[Comment 31](show_bug.cgi?id=10957#c31)
2008-11-17 18:47:23 PST

> Actually, the HttpOnly RFC working group says:
It would be useful to test the behavior of Firefox and Internet Explorer to make sure we have identical semantics.
In some sense, it is impossible to prevent writes because the script could always exhaust the browser's cookie store and then add a new non-HTTPOnly versions of the cookie.

Jim Manico

[Comment 32](show_bug.cgi?id=10957#c32)
2008-11-17 20:03:38 PST

> In some sense, it is impossible to prevent writes because the script could
> always exhaust the browser's cookie store and then add a new non-HTTPOnly
> versions of the cookie.
(From Bill Cory)
That is an interesting problem. They're referring to the hard limit that governs the number of cookies a site can have stored on the browser -- there's a limit to prevent a malicious site from filling up your hard drive with numerous cookies. So for most browsers, the limit is 20 cookies max, and when a browser receives cookie #21, it will discard the least used (or oldest?). This talks a bit about it:
<http://www.cookiecentral.com/faq/#2.5>
So if an attacker sets 20 cookies, they can force the HTTPOnly-protected cookie out of the cookie store, then set a non-HTTPOnly cookie.
It would be tempting to change the browser behavior to NOT bump out existing cookies when the cookie store is full, but that would then allow an attacker to populate the store with bogus cookies, and wouldn't allow the legitimate website to set any additional cookies (a cookie DoS attack of sorts). Of course, the server could just iterate through the cookies and cause the bogus ones to expire, but it's not ideal.
One solution might be that HTTPOnly cookies can't be bumped out of the cookie store. Another solution might be that the Cookie header sent to the server somehow identifies the cookies that are HTTPOnly, which would allow the server to detect tampering (or two headers, one for regular cookies and one for HTTPOnly cookies).
Or other ideas?
The spec should probably state that the HTTPOnly flag can only be set by the server via a Set-Cookie or Set-Cookie2 header -- scripts are not allowed to set the flag or modify the incoming Set-Cookie/2 header.

Adam Barth

[Comment 33](show_bug.cgi?id=10957#c33)
2008-11-17 21:47:26 PST

> (From Bill Cory)
I really wouldn't be that concerned about it. Secure cookies have all the same problems and IMHO are more critical to secure. Playing with the eviction strategy is very fragile and hard to get right. Altering the Cookie header is unlikely to succeed (there have already been several failed attempts for Secure cookies). In any case, it's not clear to me what attack you're trying to prevent.

Alexey Proskuryakov

[Comment 34](show_bug.cgi?id=10957#c34)
2008-11-18 06:04:46 PST

Comment on [attachment 25222](attachment.cgi?id=25222&action=diff "patch") [[details]](attachment.cgi?id=25222&action=edit "patch")
patch
> - // <rdar://problem/5632883> On 10.5, NSHTTPCookieStorage would happily store an empty cookie, which would be sent as "Cookie: =".
> + // <rdar://problem/5632883> On 10.5, NSHTTPCookieStorage would happily store an empty cookie,
You removed "happily" elsewhere, but not here :-)
> Index: WebCore/platform/network/soup/CookieJarSoup.h
> +#include <wtf/Platform.h>
Why is this include needed? I think that we rely on cpp files to include config.h, which includes Platform.h.
> + return reinterpret\_cast<IsHTTPOnlyFunction>(GetProcAddress(GetModuleHandleA("CFNetwork"), "CFHTTPCookieIsHTTPOnly"));
Just to confirm: weak linking doesn't work with MSVC and/or CFNetwork.dll, correct?
> + frame->domWindow()->console()->addMessage(JSMessageSource, ErrorMessageLevel, message, 1, String());
I really wish we could get rid of these source-less error messages everywhere, but this patch is obviously not when it should be done.
> + if (isSetCookieHeader(name) && !document()->securityOrigin()->canLoadLocalResources()) {
> + reportUnsafeUsage(document(), "Refused to get unsafe header \"" + name + "\"");
I think this could have a comment explaining why we are doing this (which is that we need to filter out HTTPOnly cookies, but that's hard, and Firefox trunk also doesn't try to). Similarly, it may be better to explicitly test for HTTPOnly cookies being hidden from XHR, or at least to explain that some failures of the test are not catastrophic.
r=me, assuming this builds and works on Windows.

Darin Adler

[Comment 35](show_bug.cgi?id=10957#c35)
2008-11-18 09:23:31 PST

(In reply to [comment #34](show_bug.cgi?id=10957#c34))
> You removed "happily" elsewhere, but not here :-)
Will do.
> > Index: WebCore/platform/network/soup/CookieJarSoup.h
> > +#include <wtf/Platform.h>
>
> Why is this include needed? I think that we rely on cpp files to include
> config.h, which includes Platform.h.
I guess it's not.
> > + return reinterpret\_cast<IsHTTPOnlyFunction>(GetProcAddress(GetModuleHandleA("CFNetwork"), "CFHTTPCookieIsHTTPOnly"));
>
> Just to confirm: weak linking doesn't work with MSVC and/or CFNetwork.dll,
> correct?
Weak linking might work, but it's more complicated to get that right with project files changes and such, so I'd prefer to do it this way.
> > + frame->domWindow()->console()->addMessage(JSMessageSource, ErrorMessageLevel, message, 1, String());
>
> I really wish we could get rid of these source-less error messages everywhere,
> but this patch is obviously not when it should be done.
I'd love to hear more about how to fix that.
> > + if (isSetCookieHeader(name) && !document()->securityOrigin()->canLoadLocalResources()) {
> > + reportUnsafeUsage(document(), "Refused to get unsafe header \"" + name + "\"");
>
> I think this could have a comment explaining why we are doing this (which is
> that we need to filter out HTTPOnly cookies, but that's hard, and Firefox trunk
> also doesn't try to). Similarly, it may be better to explicitly test for
> HTTPOnly cookies being hidden from XHR, or at least to explain that some
> failures of the test are not catastrophic.
I believe that hiding the Set-Cookie header field entirely is a design decision and not just a compromise. I don't think we'd want to undo this later even if someone donated code to filter out the HTTP-only cookies. However, I'm not an expert in this area, so perhaps my belief is wrong.

Darin Adler

[Comment 36](show_bug.cgi?id=10957#c36)
2008-11-18 09:27:57 PST

(In reply to [comment #30](show_bug.cgi?id=10957#c30))
> (1) Prevent client-side scripts from reading Cookie or Cookie2 values
> (2) Prevent client-side scripts from writing Cookie or Cookie2 values
Roughly speaking, I believe these are prevented by the changes my patch makes to the CookieJar implementations for the Foundation and CFNetwork networking layers. Other ports will have to do similar changes.
> (3) Prevent client-side scripts from reading Set-Cookie or Set-Cookie2 response
> headers (via XHR)
This is prevented by code added to XMLHttpRequest in my patch.
> (4) Prevent client-side scripts from writing Cookie or Cookie2 request headers
> (via XHR)
This was already impossible with TOT WebKit because those header field names are not on the white list in isSafeRequestHeader.

Alexey Proskuryakov

[Comment 37](show_bug.cgi?id=10957#c37)
2008-11-18 09:32:43 PST

> I believe that hiding the Set-Cookie header field entirely is a design decision
> and not just a compromise. I don't think we'd want to undo this later even if
> someone donated code to filter out the HTTP-only cookies.
What worries me is that nothing (apart from svn log) will speak about the rationale for this behavior - neither code comments, not tests, really. I do not have an opinion on whether this is a final solution (more likely, it is).

Darin Adler

[Comment 38](show_bug.cgi?id=10957#c38)
2008-11-18 09:35:02 PST

(In reply to [comment #37](show_bug.cgi?id=10957#c37))
> What worries me is that nothing (apart from svn log) will speak about the
> rationale for this behavior - neither code comments, not tests, really. I do
> not have an opinion on whether this is a final solution (more likely, it is).
Oh, sorry, I wasn't clear. I do intend to add a comment based on your remarks!

Darin Adler

[Comment 39](show_bug.cgi?id=10957#c39)
2008-11-18 10:49:55 PST

<http://trac.webkit.org/changeset/38566>
We can use new separate bugs to track any problems with the implementation. Testing the Mac port and CFNetwork-based Windows port implementation will be limited to people with the new CFNetwork version on their computer.

Jim Manico

[Comment 40](show_bug.cgi?id=10957#c40)
2008-11-18 21:15:10 PST

> In any case, it's not clear to me what attack you're trying to
> prevent.
(From Bil Cory)
Cookie eviction allows an attacker to remove legitimate cookies, it also allows an attacker to replace legitimate cookies with their own -- most useful for session fixation attacks.
If only a server can create HTTPOnly cookies, and HTTPOnly cookies can never be evicted, then it would prevent a cookie eviction attack. The cookie will still expire at some point, or the server can update the cookie to remove the HTTPOnly flag, and/or set the cookie to immediately expire, so control over the cookie is kept with the server.

Jim Manico

[Comment 41](show_bug.cgi?id=10957#c41)
2008-12-21 05:14:46 PST

Can you please make sure your patch includes protection from both Set-Cookie and Set-Cookie2 per the suggestion of the HTTPOnly working group document, entry A-2? <http://docs.google.com/View?docid=dxxqgkd_0cvcqhsdw>
-- (WebCore::XMLHttpRequest::getAllResponseHeaders): Hide Set-Cookie headers from
28 clients that don't have local-resource privileges.
++ (WebCore::XMLHttpRequest::getAllResponseHeaders): Hide Set-Cookie and Set-Cookie2 headers, in a case insensitive way, from 28 clients that don't have local-resource privileges.

Darin Adler

[Comment 42](show_bug.cgi?id=10957#c42)
2008-12-21 10:01:54 PST

(In reply to [comment #41](show_bug.cgi?id=10957#c41))
> Can you please make sure your patch includes protection from both Set-Cookie
> and Set-Cookie2 per the suggestion of the HTTPOnly working group document,
> entry A-2?
Jim, I'm not sure what "make sure" means in your request. The patch does include what you're asking for. The patch is <<http://trac.webkit.org/changeset/38566>>. A relevant function is:
static bool isSetCookieHeader(const String& name)
{
return equalIgnoringCase(name, "set-cookie") || equalIgnoringCase(name, "set-cookie2");
}
Is there something specific you're worried about?

Jim Manico

[Comment 43](show_bug.cgi?id=10957#c43)
2008-12-21 23:12:44 PST

> Jim, I'm not sure what "make sure" means in your request.
The code you submitted covers that request. I was looking at what I think are just the function comments, which did not seem to address set-cookie2
(WebCore::XMLHttpRequest::getAllResponseHeaders): Hide Set-Cookie headers
from 28 clients that don't have local-resource privileges.
Sorry for the hassle.

Michael Gilbert

[Comment 44](show_bug.cgi?id=10957#c44)
2009-04-26 15:24:18 PDT

Hello, we are looking at whether we need to adopt these patches in debian stable, which includes webkit 1.0.1 dated 2008-06-15; well before revision 38566. Looking at the code, it looks like these fixes primarily apply to the windows- and mac-specific cookie handling with some clean-up of the libsoup code (but nothing soup-related specifically fixed).
Note that the version of webkit in stable does not make use of libsoup, so does that mean that it is falling back on the windows-specific cookie handling? Note also that this version appears to pass the regression test attached.
Also, could libsoup itself be vulnerable to these problems, and if so have there any patches been issued?
Please let me know if you think that we need to adopt these patches.

Note
You need to
[log in](show_bug.cgi?id=10957&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Enhancement

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 420+ |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Mac

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |OS X 10.4

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |WebKit Misc.

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Darin Adler

Reported

2006-09-20 17:25 PDT

Modified

2011-04-27 10:27 PDT
[History](show_activity.cgi?id=10957)

CC List

7
users
Show

abarth
ap
collinj
darin
jim
priyajeet.hora
sam

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
 [http://msdn.microsoft.com/workshop/author/dhtml/httponly\_cookies.asp |](http://msdn.microsoft.com/workshop/author/dhtml/httponly_cookies.asp)

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |InRadar

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

Flags
ddkilzer:
CloneForRadar+

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |
None

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=10957)
* [XML](show_bug.cgi?ctype=xml&id=10957)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=10957)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)


