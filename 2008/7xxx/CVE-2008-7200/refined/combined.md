=== Content from cvs.schmorp.de_4e92afc9_20250124_214155.html ===
17:23:15  schmorp: I've noticed that artifact armor generation will not copy over attacktype and
dam. I've found that line 1421 of deliantra/server/common/treasure.C prevents
modification of dam on items that have no dam, such as non-weapons
17:25:50  I have no clue why attacktype isn't being added
Deliantra MORPG Server, Maps and Archetypes ChangeLog.
Version numbers sort like decimal numbers.
TODO: trap disarming/finding very little/constant experience?
TODO: golem survives "longer" now - too long?
TODO: clean up skill handling in kill\_object.
TODO: mining experience
TODO: highest cpu users: stand\_in\_light (object \*op), get\_map\_flags, blocked\_link, path\_to\_player
TODO: reload\_settings
TODO: thawer should not next()
TODO: pet experience is, rarely, given to the wrong skill (e.g. mining)
TODO: 2010-05-21 02:48:16.4562 D victim {cnt:109581,uuid:<1.858befa27>,name:"ice",flags:[0,8,103],type:23}(on /whalingoutpost/misc/icecavern1@8+43) (-21) already dead in hit\_player()
TODO: jumping, maybe dimdoor works wonders with earthwalls in between.
TODO: cats dimdoor, invoke charm => watch Log-1
TODO: fountain magic power and shop magic powre potions are different, also, potions are not identified
TODO: identify doesn't merge
TOOD: apply should only apply one stack items
TODO: fixed random maps, e.g. for buildings
TODO: fix rando maps - wallstyle includes piers? random exitstyle is teleporters?
TODO: 2010-07-26 23:16:17.5863 W Can't call method "skip\_block" on an undefined value at /opt/deliantra-server/share/deliantra-server/cf.pm line 2136.
when trying to load a map that apparently could not been saved during chargen.
TODO: 2010-10-12 00:46:54.9727 E place\_special\_exit: undefined hole type 4
TODO: 2010-10-12 00:05:52.3436 E object refering to nonexistant archetype 'ability\_fire'.
TODO: 2011-08-13 23:21:15.7242 E Treasurelist mage\_hound did not generate a valid entry in summon\_object
TODO: partially transparent, yellow ground(?): wall/bulletwall/bul\_wall\_\*.x11.32x32.png
TODO: op->failmsgf ("You lack the proper attunement to cast %s!", &spell\_ob->name); <- why for moving bsall spells? check if caster is player?
TODO: potionimp/stat potion descriptrions
TODO: 22:29:37 -server:#cf- Scara chats: schmorp: i'm trying to get a clue about the tarot and the meaning of the
TODO: sepharoth, it goes like this: philosophical salt equals "Gunas" (Subconsciousness), philosophical
TODO: sulfur equals "Rajas" (Activity) and philosphical mercury equals "Sattva" (Superconsciousness) or
TODO: the sepharoth "Kether"
TODO: "illegal" access to mlab via town portal in zealots house near mlab tavern
TODO: only store face checksums in C++, store everything else in perl
TODO: the motd command is missin
TODO: cast create missile's argument should be documented and should work for bolts as well, example:
if I use 'cast create missile bolt, it would create bolts (+4) and if I use
'cast create missile bolt Fire, it would create bolts of Fire. 'cast create
missile Fire bolt would be invalid. These changes should be reflected in the
spell's description.
TODO: bowmode threewide (and possibly others) might not properly respect movetype
and arrows might end up in places where they shouldn't, e.g. on top of see-through
walls.
TODO: Allow players to forget spells in the testing server - this makes spell testing and iteration simpler.
TODO: cspm spell arg
TODO: holy symbol of great virtue in shops has item power 3, as artifatc from thaumathurgy it has 4
- temporary workaround for an optimiser bug in gcc 10, optimising out
memsets used to zero-initialize memory.
- (arch) extend experience table to level 120, as a player reached level 115
three times.
- (arch) tanning bench size increased form 350kg to 4000kg to accomodate
gaelotrolls.
- (maps) remove random workbench under house in darcap, fix exit and add random
reading to dragonslib map, modify zealots house in mlab/tavern.map to remove
illegal mlab access (ephraim).
- (maps) make some containers unstackable that erroneously stackable.
- (maps) fix a lot of bogus money/diamond converters in mlab.
- (arch) platinum to gold converter was broken in 2008 and paid out
one gold for one platinum only. mea culpa.
- recipe change: cure blindless potion now takes madman's eye.
- detect stackable containers at load time and make each stack a single item
(reported by Saiapatsu).
- (ipo) corrected "you'Ve got mail" message at login.
- refactored the anim frames/facing macros/methods to range check and avoid
crashes due to corrupted face numbers (e.g. in T\_MATCH).
- fix possible animation update bug in hole animations.
- fix gate closing not updating the animation bug.
- do not allow runes to be cast into inaccessible areas (reported by Saiapatsu).
- last remaining BUG (that showed up in the logs for the last years) has
been fixed: monsters would snatch arrows/thrown\_objs out of the air without
stopping them, causing BUG: arrow had no map. Fixed by marking shot arrows,
bolts and thrown objects as NO\_PICK temporarily.
- since binutils/gcc/etc. conspired to break static archives, converted the server
binary build into non-recursive Makefiles without static archives. hell, automake
is certainly not ready for non-recursive makes, what a hack :()
- use c++11 headers in preference to tr1 ones.
- fix odr violation: struct point.
- make the code warnigns-clean, for some definition of warnings.
- port to g++ 6.
- implement keep\_suffix meta for cfutil, so files keep their extension.
- built-in webserver uses improved content-type detection and uses charset utf-8
by default.
- do proper etag caching for resources in http server.
- fix webserver 304 response, which contained entity-headers, confusing squid.
- potentially fix a bug where ob->contr is non-null while ob->contr->ob is null,
causing a segfault.
- change DIRX/DIRY macros to take a diretcion as argument, and use them instead of
directly referencing freearr\_[xy], as the latter is used alot more often then
DIRX/DIRY, and this allows us to change freearr\_[xy].
- tentative port to C++ 17.
- fix a potential bug with packet << (const char \*)0.
- add COPYING.Other.
- include libecb and decore compiler.h and other places in preference to it.
- include ska's flat\_hash\_map and use it instead of unordered\_map/set.
- use c++11 variadic templates in include/callback.h, get rid of callback.pl.
- level 0 experience valuew as uninitialised. all these years.
- run the shstr garbage collector regularly, not only after intern ().
- fixed minor undefined behaviour that was unlikely to result in problems.
- don't log runtime errors for invalid regexes for the maps command.
- (maps) fix elmex school and heaven wall/check\_inv move\_block values.
- (arch) reduce acidpriest and snitchangel experience by 90%, as per
discussion with our resident lvl 115 player ap\_po.
- players at max level would have their experience halved when gaining
exp because the difference to the next level would be negative
(reported by ap\_po).
- player-only teleporters (EXIT\_PATH set) will trry to teleport
the player above them, instead of the first object they find and failing
if it's not a player.
3.1 Wed Nov 16 23:17:11 CET 2016
- convert to blitz++ 0.10 and later (also requiring c++ 11).
- port to perl 5.18 and newer.
- switch to xz compressed archives as only dist method.
- upgrade to automake 1.15.
- (maps) hopefully fix tobias' tower.
- (maps) hopefully fix healing potion vendor in arena entrance.
- (arch) fixed an error in the Gnarg scale mail artifact.
- it was possible to unapply or half-unapply cursed items in many
cases, which confused players and also player state. fixed.
- (arch) remove curse now works more liek idnetify in that it uncurses
some items. also, no longer uncurses spells or other invisibles.
- (arch) remove curse and identify now treta the marked tiem first.
- creators no longer identify objects that shouldn't be identified
(such as money, which won't stack afterwards).
- (maps) the shady rogue in goths can unapply cursed items for you.
- (maps) implement a wilderness town portal.
- (arch) set proper(?) int values for all monsters.
- (maps) fire5.map could destroy players.
- (maps) fix pet arena pit/arena entrace and exits.
- clear the spell's applied flag when inscribing scrolls, to make the
scrolls mergeable.
- redo all build material faces from scratch.
- dropall without arguments now drops all containers.
- use blitz++ for vector maths (new dependency).
- only match archetype names in artifact allowed names.
- new command "bumpmsg" that triggers the bump-into-wall messages.
- altars with match expressions did not work properly.
- use last\_sp not cursed/damned flags in remove\_curse/damnation spells.
- god enemy race check fixed ("god detests your race").
- gods erroneously allowed any kind of worshipping race, even
ones they hate.
- use same default config in code as on gameserver.deliantra.net.
- Pod::POM 0.26 and higher actually interpret =encoding, which broke
our parser.
- generate slightly more special exits and avoid warning.
- applying a glowing crystal now gives status messages.
- fix a memleak in the random map generator.
- rework the random map parameter passing a bit to be extendable.
- (random maps) use a nonrecursive algorithm to generate mazes,
also, improve the quality of the mazes (no longer will the edges
almost always form a passage) and add two new types - "rooms"
and "braided".
- implement --unique option to reset command.
- (random maps) add new "cave" layout, which is much more ...
cave-like.
- (random maps) new layout style "castle" that generates straighish,
rogue-ish maps.
- (random maps) new layout style "multiple" that simply mixes multiple
different styles in different areas.
- roguelike maps sometimes had dead ends due to symmetry settings.
- rewrite layout management in the random map generator from the
ground up.
- fix bug in tausworthe rng initialisation.
- switched to the faster and hopefully better quality gfsr{24,55} random
number generator, the same algorithm that freeciv apparently uses.
- replace unreachable walls in random maps by "blocked", which saves
memory and imho looks nicer.
- (arch) fix samhlaidh archetype.
- fix the "archname" match special function.
- add kensler ("better gradient noise") functins, as well as fBm
and other fractal algorithms.
- one can no longer emote to logged-out players.
- (maps) /pup\_land/nurnberg/storehouse quest was fixed, the potatoe
sacks fit on a tile again.
- (arch) fixed message of improve wisdom scroll.
- (arch) move glyph/magicmap/visibility into .faceinfo files,
support background colour for text clients.
- (arch) improve automatic name from archname generation.
- implement faceset 2, colour + utf-8 glyph, for text-based clients.
- support resist\_xxx, body\_xxx\_info and body\_xxx\_used specials in
match expressions.
- don't cause an error if a monster tries to cast magic mapping.
- sometimes a special exit wasn't placed when it should have been.
- make newmapcmd mandatory, remove support for map0/map1.
- require EV 4.00.
- made wording of "use\_skill jeweler analyze" a bit more precise.
- add perlxsi.c to cleanfiles.
- (arch) made speed potions easier for now.
- the server didn't properly initialise all client skill slots,
no known impact.
- clean up unused settings, introduce DELIANTRA\_DATADIR.
- (arch) added potion of fortitude to resist fear for the jeweler skill.
- (arch, maps) move worldmap gridmap data to arch/res/ and implement
a generic table/matrix/palette converter to cfutil.
- avoid crash in describe\_item when a power crystal has maxsp=0 (as used,
apparently, in the brewery map).
- do not endlessly loop when an optional extension cannot be loaded.
- remove limits of 000..999 from worldmap coordinates, support negative
coordinates and introduce z-layers - deliantra is now 3d, in yet another
sense.
- move "the worldmap" to ext/map-world-classic.ext and make ext/map-world.ext
handle generic "world map areas".
- dropped micrpather again - we'll do our own implementation when we need it.
- added is\_quad flag.
- (arch) added quad archetypes.
- made the pickaxe mining tool remove quad walls and floors.
- move key\_values into their own class, simplifiying lots of code and
making it possible to use kv pairs easily for maps and other objects as well.
- get rid of get\_archetype, finally.
- maps no longer get activated when loading, only when a player is "near" them.
- maps can now be swapped (not loaded), active and inactive, other states
have been removed, and the map "intelligently" changes between active/inactive.
- new variable $cf::SERVER\_TICK, also rename pticks in C++ to server\_tick.
- remove legacy fly\_on/off, flying, walk\_on/off and no\_pass attributes.
- server now enforces width/height matches between tiled maps.
- fix some off-by-one bugs that presumably created empty rectangles
for unordered map walks - which should not cause any real issues.
- increase face hashlen to 5 octets from 4, to avoid a collision.
- fix output-rate limiting - min/max now use the first argument for the type,
as all other similar macros - might cause other breakage...
- cfutil no longer creates split tiles multiple times due to a
off-by-one bug in comparing mtimes.
- cfutil now supports type: prefix to derive faces from other faces, which
is used for all build materials currently.
- require imagemagick >= 6.6.
- fixed possible crash due to broken initialisation order of shstr and
freed\_map, thanks go to Jonathan Neuschäfer for spotting this!
- fix the brace command.
- implement refcnt\_buf.
- avoid std::string to store facedata, use refcnt\_buf instead, for a 20kb
codesize decrease. wow.
- removed version 1 ext/exti command support.
- store meta information in faceinfo->meta unless prepended or empty.
- new extension, ota\_update, for online updates of the game client.
- implement a simpler config value system for extensions that allows
config updates without a reload.
- fix a segfault in reload\_perl due to perl 5.12's gv management changes.
- make pick\_lock work over map boundaries, and fix a crash while we are
at it.
- make nekosan more disease-resistant.
- new event "infect".
- setup protocol packet now supports JSONOBJECT syntax.
- implement simple web server, currently to serve facedata for the html5
client.
- sort faces by name in the server to improve caching locality in clients.
- actually prune face checksums (exp\_table's checksum was too long).
- add skill\_info and spell\_paths resources to enable caching the info
and removing another command.
- send completion info to the client.
- assume all clients support the deliantra protocol extensions and allow
fxix/extcmd and other protocol "extensions" before setup.
- implement flash-policy-file server on server socket, to allow flash clients
to connect.
- implement exti doclet request to request documentation,
currently for commands only.
- created nickmon extension to monitor nicks.
- ix now keeps a copy of the face data while sending, in case the
face changes.
- do not allocate memory for empty refcnt\_bufs.
- when faces change, invalidate all clients, not just clients with matching
faceset, as faceset only applies to tile resources.
- remove dependency on Time::HiRes.
- move face data to disk, and load it on each and every access. this saves
250mb ram on load, and 130mb ram in general, and only reduces the http
server hot cache throughput for faces from ~24000 to ~18000 requests/s
on my system. this should make it possible to add a lot more media files
in the future, and reduces the memory footprint by the server from 180mb
to 60mb ram.
- create food/missile will now fail when the mapspace limits are exceeded.
- pod processing could deadlock because the child process might try
to get a lock.
- removed support for ncom packets.
- remove drawinfo packets from the server (use msg instead).
- skill objects now have their documentation in the msg slot.
- no longer allow prefix match when matching spells, spells names must
now be written fully.
- avoid a deadlock when the incloader is called to load an in-memory
file in a child process.
- implement spellmon v2 protocol - no spell message.
- remove ability to cast/invoke seplls by "count".
- the "may" mechanism now supports uuids in addition to nicknames.
- implement dm/dmhide in terms of the "may" mechanism, so dm
players must now be configured by adding may\_command\_dm: ["uuid..."]
to the config.
- remove nowiz command.
- change dm hiding - hidden status is no longer respected by spells etc.,
it only affects information commands. use observe instead.
- automatically send fx for all changed faces, not just for visible tiles.
- fix g++-4.7/c++ incompatibilities in noise.h, and work around similar
problems in blitz++.
- catch sigfpe in the same way as sigsegv.
3.0 Sat May 29 23:30:57 CEST 2010
- (maps, arch) complete revamping of the transport routes - all cities are
now easily reachable, at a price.
- (maps) the mana fountain now has a ratelimit of 30 potions per hour.
- (maps) added (navar) gravedigger, that buys players gravestones.
- (maps) added the rathouse quest for the shockwave spell in navar
(by Dustfinger).
- (maps) fixed bad floor tile in navar apartment.
- made (wizard) look\_at show also uuids.
- added cf::object::find\_object\_uuid (::find\_object already exists!).
- (maps) added new apartment, made by LinuxLemoner.
- (maps) added quest for the mining skill scroll to valleynoy.
- (maps) added greedy highlevel book shop to heaven town.
- (arch) added sounds: zombie death, book reading, inscription.
- (arch) made the hill giants loose more body parts.
- (arch, maps) added black unicorn horn, required to access mlab hell.
- (arch) increased the (possible) number of arrows/bolts found in shops
and made them a bit more expensive.
- (maps) add more glory hole treasure styles.
- (maps, arch) add "hollow" variants of cave\d tiles, and use them
in a select number of mlab maps.
- (maps) the library should be less of a death trap now.
- (maps) exits no longer point to auto-apply exits, most affected
maps now have proper doors or a similar solution.
- (arch) jumping skill has now physical attacktype.
- (maps) fixed nurnberg/reception/fire5 to match new style torches.
- enter\_map did not normalise the map coordinates when the destination
space is blocked, causing badness and freezes for the player.
- when applying containers, server checks for the key on activate
and also allows players to unapply active containers they don't have
a key for.
- moved formulae, attackmess, artifacts, exp\_table, materials and
races files to arch, where they belong (exp\_table is no longer in
confdir but in datadir now!).
- jeweler and sound config files are now normal datafiles as well.
- quit\_character was causing a runtime exception, causing it to not
work since 2.93.
- entering a map will now respect move\_on and other effects,
except for auto-apply exits :/
- only talk to the items on the nearest mapspace, or, of there
are none, to the player, not ALL items in vicinity.
- do not update the floorbox while running, to avoid big item
updates that cost network bandwidth and processing power.
- diseases could reduce a monsters speed to MIN\_ACTIVE\_SPEED, which
caused overflows causing monsters to become living deads.
- unapply weapons and armour before trying to improve it.
- teach the random map generator the ability to read ".rmg" files
that specify which actual style map to generate, and use it for
the default decorstyle to avoid inappropriate maps to be used.
- support (with some limitations) multiple different skills with the
same subtype.
- fix "nekosan duplication" bug - map swap out was not atomic,
so nekosan could end up beign saved AND escaped to another map.
- show invisible no longer makes magic mouths visible.
- move\_type changes (spells, skills etc.) now will correctly
take move\_on/move\_off into account (e.g. buttons).
- display (exit) or (random map) in client for those objects.
- removed (useless) spell damage columns from spell info and replace
it by effective casting level - clients > 2.10 required to display
properly.
- building of levers/doors works again for all kinds of floors.
- the player can now withdraw and deposit all the available money.
- (maps) fix the apartment shop (japan => 吾妻) and add descriptions for
steinwandstadt/celvear.
- (maps) added /goodies map (goto \*idkfa) with stuff useful for testing.
- (arch,maps,code) rebalanced value of spellbooks greatly. it's now
mostly based on the spell's level in the spellbook.
- the music scheduler did not properly send new music on region
changes.
- (maps) fix some map regions and the region tree.
- the server will now be more picky when parsing the regions file.
- do not rely on chosen\_skill in calc\_alch\_danger.
- improve editor support protocol slightly, provide workarounds for 2.10
clients.
- follow has been rewritten to be, hopefully, more robust.
- follow mode will not be aborted when the follower tries to move.
- tcp.ext didn't unbind in reloads.
- map-tags.ext didn't properly close the database on reloads.
- cfutil skips .-directories when scanning.
- build.ext prevents players from building on other player's maps.
- rent.ext allows the dm to enter anytime.
- NPC\_Dialogue adds a new predefined variable, $map.
- new "build" event hook.
- get rid of archetype min/max values except max\_x (which should go, too).
- added fix\_generated\_item and cf::object::generate to XS interface.
- no longer use uppercase identifiers for saving anywhere, but support
them on loading, for old playerfiles and maps.
- removed is\_legal\_2ways\_exit - this is apparently dead code, and
would be handled differently nowadays anyway.
- random map .meta were not being expired at all.
- replace move\_ob/move\_object functiony by the equivalent move method.
- update to automake 1.10.
- invitation to maps with unagressive and friendly monsters doesn't
require level 4 anymore.
- do not let update\_stats muck with the chosen\_skill anymore.
- monsters now rotate through all skills (in chosen\_skill).
- fix lots of path-related buffer overflows in the random map generator.
- detect/sense curse/magic will no longer work on items that don't
need identify.
- added detect mineral vein spell.
- support "wall overlays" in the random map generator - not very generic,
used by minable veins.
- (maps) relocated jeweler town to another directoy.
- (arch) implement mining pickaxes and mining skill.
- (arch) add missing stonebig\_club archetype from cfextended.
- jeweler skill doesn't diminish input values anymore.
- jeweler skill is harder to level now, but in exchange item power
of the output is only 1/5th (instead of 1/3rd) of ring level.
- jeweler skill adds the makers name (currently not visible) to the
generated ring/amulet.
- generate most constants for perl automatically.
- properly check for weapon name prefix ("Ragnarok's sword").
- when player dies, restore his food to at least 200.
- support multiple inheritance for arch sources (inherit a,b,c).
- switch to storable-n-format for facedata, for better interoperability.
- implement generic "ranged" item framework (pickaxe, fishing rod).
- the singing skill actually respects the direction now.
- oratory and singing now require a direction.
- use\_skill now requires that you can actually apply the skill tool.
- do not invoke perl on every user command anymore by providing
a command and an unknown\_command event.
- move mark, run, run\_stop, fire and fire\_stop commands back from
perl to C++, for speed reasons (basically undo patchset 1304).
- add a client\_destroy event, so we don't have to hook the
attachable destroy event (which is called much more often).
- removed (unused) FLOOR object type.
- fix erroneous change\_abil messages for rods (and other types).
- remove include/commands.h and server/c\_new.C, and refactor
all into server/commands.C.
- save and restore combat/ranged/current slot for players.
- the server now batches item's face/fx commands, as opposed
to sending one fx per item - helps mostly at connect and
with floorbox updates.
- implemented ext::player\_env::play\_music\_once $who->contr, "km/...".
- the random map generator now supports selecting difficult for
more style categories than just monsters (all except fountains
apparently).
- object serialiser no longer creates empty "owner" references.
- make sure failed castings take some time, too, to avoid being
smitten by your god.
- many more failmsgs and help texts.
- support log suspension/resumption, e.g. for defragmenting.
- stop thrown objects when their speed goes too low.
- log the number of unique logins seen every minute in a compact
format (for statistics).
- do not send delitem for players.
- support static scalar data members properly in genacc now.
- implement "simple" freelist management for objects.
- recycle object counts now - to support longer uptimes.
- got rid of the dreaded write\_parameters\_to\_string (666 chars omitted)
function (and yes, 666 is exact!).
- random map generator results should now be fully repeatable.
- fixed possible crash bug in build code.
- rename find\_marked\_object to ->mark and speed up.
- player movers properly destroy themselves when used up, instead
of leaking.
- do not show msg for unidentified objects that need identification.
- convert formulae/bookarch/settings file parser to thawer framework.
- finally get rid of fgets (..., thawer) and use a much cleaner
next\_line method.
- use nicer file format for exp\_table and attackmess
(more like other resource files).
- make parse errors during server startup fatal.
- properly initialise all maptile values in constructor.
- improved {link} map.
- optional unloadable extensions will not lead to an endless loop.
- server will cleanly autorestart when running out of protocol IDs.
- use faster and slightly more exact find\_dir\_2 replacement.
- building listening books is possible again.
- (maps, arch) added archetype for building instructions and replaced
the copies of the instructions in the maps with it.
- (arch) made the spark shower spell available in shops.
- don't create a second LOGIN event on character creation.
- correctly generate "You paid xyz" message in shops.
- the shop menu now also displays the (approx) value of the item.
- added a 'password' command, to let DMs change the password of players
more conveniently.
- correctly save shopitems string, to avoid parse error when reading
saved maps.
- logging now differentiates between logging levels better.
- speed up get\_typedata.
- fix deadlock problem during server shutdown/reload.
- make ext/checkrusage "more" non-blocking.
- use common::sense for extensions.
- work around a 50.10.0 utf8 caching bug.
- correctly try to load tiled maps in adjacent\_map, might fix
"no relation to target" bugs.
- try to load (pure-)perl modules asynchronously, warn about
modules being loaded from the mainloop, pre-load some more
core modules so perl doesn't do it later on.
- pre-load many of the files perl might load on it's own e.g. when
compiling regexes.
- make exp\_table and materials file reloadable.
- made reload\_config non-blocking.
- the seen command called (blocking) stat() instead of aio\_stat,
causing server freezes.
- store unhashed password, to prepare for safer authentication.
- do not log connections from the local host, to help a local
watchdog.
- fix summon freeze at map borders.
- support @group syntax and music config file for music face lists.
- run post\_init jobs in parallel, they might do I/O.
- avoid apply conversion for converters.
2.93 Sat Feb 13 15:52:36 CET 2010
- (maps) fix travel to valdor and back.
- do no longer by default eval map cod ein safe compartments
(this can be re-enabled using the safe\_eval config option).
- (maps) fix an apparent crash bug caused by broken generstors
in lorak.
- fix data corruption issues caused by recursive calls to
unordered\_mapwalk - now every caller must provide its own
buffer.
- (maps) improve tindervale maps slightly.
- (arch) considerably decrease slag ex price.
- (arch) fix filth archetype.
- extension dependency resolve was completely broken.
- multipart objects would cause save\_throw\_object to crash - it
now acts on the head only.
- do not try to connect to an irc server unless explicitly configured.
- do not expect decltype() to be available in gcc 4.4.
- extended the safe perl environment by loops.
- (arch) fix "armless cook" facings.
- the "experience table" resource item did not have a proper
hash associated with it, so updates could not be detected.
- fixed poison traps in doors.
- player->killer\_name did not properly flag the name as unicode.
- aggressively mark many more methods as utf8 or octet-expecting,
and provide a non-destructive SvPVutf8 variant.
- do not allow dragon players to change their title via the settings.
- ratelimited jeweler skill nugget conversion.
- under high load, the server stopped swapping out to make
the server more responsive, but making it impossible to reduce
the load by... swapping out. slot queuing will now always make
some progress.
- improve the quality of the load-avg calculation.
- (maps) fixed quest npc in jeweler dungeon quest.
- don't fail to write the runtime file if the temporary already exists.
- ipo.ext no longer uses (synchronous) CFDB, stores mail directly at
player now.
- rewrote hiscore code from scratch to use async I/O, store uuid and
timestamp and use a tab in the client to increase awareness.
- npc dialog setflag/setsatte now check for defined'ness, so
setflag 0 is possible.
- make install now deletes old extensions, to ease upgrades in the
deliantra vm.
2.92 Thu Dec 24 04:51:56 CET 2009
- the destruction spell could/would corrupt server memory quite often.
- logging in only fixed the combat slot when the palyer was loaded from
disk, not when it already was in memory.
- cede in wait\_for\_tick\* when the tivck is inhibited hopefully
avoiding livelock during high-load emergency saves.
- logging in did not properly unapply all skills.
- (maps) make the invite quest marking much more obvious.
- (arch) fix warrior archetype names.
- map prefetching never prefetch upwards.
- wizpass no longer makes you non-blocking.
- (maps) add light to some of the special maps, add troll
map.
2.91 Mon Nov 30 10:18:09 CET 2009
- (maps) add gorokh\_final mapset from crossfire.
- (maps) block most vault-type mlab locations, open up
imperial converters for anybody to use.
- (maps, arch) replace all permanent stat potions by random
variants.
- (maps) spread gorokh demon styles more evenly over 1..100.
- TRIGGER events got passed a garbage pointer instead of a
real player object on player changes.
- diseases and maybe other things could sometimes reduce the speed
to below MIN\_ACTIVE\_SPEED, deactivating the monster and causing
much grief.
- speed\_left randomisation was, apparently, totally broken.
- introduce FLAG\_RANDOM\_SPEED instead of using the sign bit
of the speed slot internally and in map save files. among other
things, this gets rid of all the abs (speed) calls.
- reduce map file save files by using abridged keywords aliases.
- shop specialisation calculation was totally broken.
- nrof/itemcount/volume limits when dropping to the floor are
now enforced.
- fix magic mapping, which only worked for inate spell casting.
- godgiven items will now be explicitly described as such.
- (arch) dded a quiver of bolts.
- materialnames would change "randomly" on every load, only
set the material when the materialname was not set before.
- balancing change, halve rod recharge speed (instead
of 4.8s, the standard rods now recharge in ~10s. not a solution,
but still.
- reduce cpu time used for map saving by >>50% by avoiding
the costly flag-checking loop in most cases and using a simple
repeat-cache for speed\_left.
- always delay stats update for players on insert/remove till
next tick/command, which saves a lot of cpu cycles on drop/take.
- add hint about havign to run to attach unaggressive npcs.
- pet monster level was not displayed correctly in "showpets index".
- clean up floating point conversions and many similar nitpicks.
- fix hanuk altar.
- overhaul material system to be much faster, and having less bugs, but
still having a lot of cruft :/.
- add marble shop floor.
- move gcc specifics to new file include/compiler.h.
- unrecognised cfpod directives could cause undefined behaviour.
- added boes' marble shop to steinwandstadt.
- pad mapspace to power-of two size for speed/codesize/cache gains.
- optimise mapspace updates.
- cache volume/items per mapspace.
- use fabs, min and max consistently (surprisingly for a code size
decrease).
- fixed a small uncleanlieness in item converters, which might
have led to weird item multiplications.
- store hash value in shstr, not used by anything, but doesn't use much memory.
- fixed crash bug in learn\_spell command.
- enhanced output of the mapinfo command.
- remove all traces of FLAG\_NO\_FIX\_PLAYER.
- avoid sv\_derived\_from calls (lots of hash lookups) when converting
from perl to c++.
- implemented least\_significand\_bit and for\_all\_bits\_sparse\_32 utilities
and use it in some "inner" loops.
- rename flags to attachable\_flags to avoid confusion :=).
- fixed jeweler experience output to not be floating point.
- added lock/unlock commands, thanks for the patch go to Shawn Robinson!
- (arch, maps) introduce inactive\_shop\_floor and fix some shops with it.
- try to prefetch memory inside process\_objects, which can give
enourmous speed gains.
- make some small optimisation to the process\_objects loop.
- move facedata chksum calculation into cfutil, make server more flexible
handling different chksum lengths.
- check for hash collisions in cfutil.
- reduce face checksum size from 6 to 4 bytes.
- don't crash when a map uses empty sound/sound\_destroy/face.
- removed weather-specific attributes.
- fixed genkeywords dependency.
- do not clear "randomitems" slot for world underlays.
- use "sl" as short-hand for speed\_left in save-files, just to make them
smaller.
- in general, don't crash on value-less resource file lines
anymore, due to get\_str never returning a 0-pointer.
- code cleanup in move\_symptom.
- removed arch\_to\_object (replaced it by ->instance ()).
2.90 Sat Nov 7 15:06:06 CET 2009
- some Andrew Madloch wanted, despite being specifically told
multiple times that the Deliantra parts additions are under AGPL,
lock up the source code of the server within his company.
some reorganisations have been done to the sourcecode to make
it clearer that this violates the Affero GPL. Help to keep
Deliantra free software even for the coming generations
and be wary of the promises of Andrew Madloch, he has nothing
good in mind for free software.
- clarify which files of the server are 100% AGPL.
- minor reorganisation, move some GPL code into other files.
- implement viewpoint (which is like observe, but only for the map,
not stats etc.).
- replace magic mapping overlay by a flying bird exposing area
on the worldmap (ext/magic\_mapping.ext).
- @find in npc dialog was useless as the vairbale wasn't accessible.
- @find results in npc dialogue is now stored in $find.
- (maps) add lostwages and lorak (valdor/varsia) from cfextended.
- (maps, server) add lostwages and celvear apartments to rent system.
- (maps) closed guild houses, this is not scalable, ask your friendly
dm instead.
- (maps) add town portal to celvear.
- (maps, arch) add troll canyon, pygmy forest, elven moon and temple of justice
mapsets from crossfire, together with associated archetypes.
- (maps) add extended region descriptions for some regions from crossfire.
- (maps) define a new whalingoutpost region.
- (maps, arch) add all changes to mlab between 2006-08-01 and 2009-10-28,
and most archetypes that go with them (without stoning and swallow effects),
casino tokens and stock certificates are also missing.
- (maps, arch) add a number of minor maps from crossfire to scorn, navar
and santo dominion.
- (maps, arch) added gotischerbereich from cfextended, and some archetypes
to go with them. also adjusted archetypes to be more korrekt "gotisch".
- doors/containers can now use "match ..." expressions for the slaying field.
- properly close client-side dialogue when the player is teleported away.
- map-tags did not properly close it's database tables or wait
for a quiescent state, causing memory corruption on reload.
- support "stat.xyz" accessor in match expressions.
- skip /styles and /editor directories in cf::map::static\_maps.
- implement ->send\_big\_packet and use it in ext\_msg (among other things, this
fixes long answers from npc dialogue).
- connected magic mouths no longer spill to Log-1, but use the examine tab.
- (arch) change marker archetypes to not remove "marker" forces anymore
and to not add a "put your code here" force needlessly.
- (arch) fix or improve many plurals.
- markers do no longer add a force if the slaying field is unset.
- sped up search-items implementation, but it's still horrible.
- (maps) bigchests are now properly non-unique, per\_player and no\_reset.
- editor\_folder can now be used to override whatever cfutil sets, and was
used to reogianise the illogical arch tree a bit.
- (maps) import most map names from crossfire.
- nuke image\_sums/image\_info subcommands from the protocol.
- fly\_high movement gives better los, ignoring blocksview.
- the addexp command should now honour skill names with spaces.
- (arch) add nuke from cfextended to avoid a crash.
- (arch) added many more buildable marble floors.
- major namespace cleanup: save 45kb by making functions static
that were unnecessarily global.
2.82 Sat Oct 24 03:50:17 CEST 2009
- fixed a classical and exploitable stack buffer overflow in the gsay command.
- fix a memory buffer overflow in the book code.
- add @check, @find npc dialogue commands.
- (maps) add a number of town interiors.
- (maps) add tindervale the fireborn capitol from cfextended.
- (maps) add celvear area from cfextended.
- (server,arch) add a number of inscribables, show their capacity in hint.
- (server,maps) fix bug causing some library books not to be chained down,
cause Scorn/Navar libraries not to have inscribable books.
- (maps) fix bug causing the Greyshield and Greysword to have
inappropriate item power.
- (maps) fix intwell balancing issue.
- improve the look of generated books.
- make slag no\_drop so it can't be dropped from the cauldron.
- fix bug where players could bypass no\_drop by putting items in containers.
- consecutive commands arriving at the same time in the server would be
corrupted if the length was >255.
- support sub-matches in () inside match expressions, not just conditions.
- got rid of motd/rules/news code in C++ part, move motd to it's own tab
and perl.
- implemented new "match" type that combines both check\_inv and pedestal
functionality (and more) inside the same object using the match expressions.
- create simpler match expression compiles in many common cases.
- reduce object size by removing obsolete "seen\_by" member.
- removed the rather broken make\_list\_like utility function, taking advantage
of the new dynbuf::splice function (which gave an unexpected net win
in code size...).
- the server will no longer complain (and subtly fail) when an object
being removed from a map causes another object to get removed.
- banish strncpy from the server, speed up and simplify sending item
descriptions to the client considerably.
- add new "in head" set modifier for matches.
- new BLOCKED\_MOVE event added.
- mapscript archetype now has activate\_on\_xxx true by default, as similar
connected elements.
- (maps) imported all styles from cfextended except
floorstyles/land\_plots and monsterstyles.
- (arch) imported gem treasurelists and archetypes from cfextended.
- don't crash when treasure lists are empty / supply new empty
treasurelist for randomitems when none can be found.
- implement cf::map::static\_maps and use it in map-tags.ext.
- fix a bug in map-tag scanning when moving tags.
- (deliantra.net) improve watchdog to now check both listening ports
for a reaction.
- implement new "loadall" map loading command, purely for debugging.
2.81 Mon Oct 12 20:00:18 CEST 2009
- display spell description for spellbooks, rods, wands, potion and scrolls,
but not horns (to make them more useful for content-creators).
- fix a number of bugs in check\_move\_on: 1) it didn't update the flags
2) it skipped spell effects and 3) it didn't handle the case where
and object was destroyed while iterating over it correctly. all this
allowed players to sometimes walk onto spaces they should not be able to
walk on.
- fix an exploit where inscription/marking runes could execute arbitrary code.
- examining an object now dumps the serialised object form when the user
is a wizard (wizlook).
- altars no longer accept unpaid items.
- party spells didn't work all that well.
- added complex object matching framework (cf::match), and make altars
and pedestals use it.
- identified skill-tools show what skill they grant.
- display the duration of change\_ability spells when examining them
(missing: protection spells, but they are a hack...).
- improve effectiveness of special foods created by woodsman skill,
adding more variety to the different mushrooms.
- fix a minor cfpod formatting bug.
- do not talk about the hintmode so much - die-hards are expected to find
the hintmode setting on the settings page.
- IPO no longer lies about prices; prices tweaked.
- clarified that all deliantra-specific parts are under the Affero GPL.
- enable the object loader to also dump archetypes.
- (maps) fix guild teleporters to Pupland Terminal.
- (maps) put the trapdoor above the floor in sisters/necro\_ruins1.
- force the initial face when loading an object that is time-animated
or a monster, so it does not have to be specified anymore.
- fix a bug where recasting an ability changing spell could shorten
its remaining duration.
- fix pedestal and floor building with builder.
- fix RUNATT attack mode, which was broken before (used e.g. by mice).
- fix a broken bow-related speed optimisation by using splay - speed
up splay operations as well.
- use NDI\_CLEAR for the body command, and make it use observe.
- implement introspection data for C++ classes (%REFLECT).
- (arch) add name\_pl fields and documentation for building materials.
- (maps) random fountains no longer generate permanent stat increases.
- fix transmutation alchemy.
- speed up many frequently-invoked C->perl callbacks.
- added complex object matching framework, to be used in altars and the like.
- switch to YAML::XS from YAML.
2.80 Tue Sep 15 20:22:31 CEST 2009
- fix the "screen stays black on login" bug and remove debug instrumentation
that ultimately was not helpful to catch it :)
- split outer\_env into outer\_env and outer\_env\_self, and fix
all callers to use either one or the other, as appropriate. This
fixes the (rather fragile) light spell, maybe others.
- fixed an overflow and exploit in the bank/payment code.
- fixed a bug in the jeweler quest and added the 'Tome of Jewelery'
to explain the skill a bit more.
- removed a buggy check for zero attacktype. So that we might find
the real bugs in the archs/maps/objects.
- Fixed enabling torches with lighters.
- (maps) Added Heaven Town region.
- (arch+maps) Fixed & normalized warriors on map
/quests/peterm/CTower/Barracks.
- fix the light spell (and possibly diseases and other lights).
- (arch) The clawing skill didn't have the physical attacktype.
- (maps) make the greenway accessible again - this bug was introduced
a long time ago, and similar cases are still to be found in the maps.
- make the socket\_timeout configurable in the code (but not yet for users).
- earth wall health bar is now correct.
2.79 Tue Jul 28 00:56:36 CEST 2009
- IO::AIO chaged to using eventfd internally - updated server to not
freeze with IO::AIO anymore due this change.
- avoid a crash when a player tries to apply a lighter.
- allow a spell argument for dimension door.
- move shop item listing and some otherstuff into the info tab.
- avoid crashes when non-players cast party spells.
- fix a crash in get\_spell\_by\_name (for learn\_spell).
- added pyromancer class with graphics (by Job Vranish).
- small improvement of the number of potions in shops
(by Job Vranish).
- added a few party spells (by Job Vranish).
- use a common message dynbuf.
- destroying tear down objects will now use the full hp range
for animation and will only destroy/lastframe when hp < 0.
- allow monsters to use earth to dust.
- use manhattan distance for get\_rangevector\_from\_mapcoord, just as
in get\_rangevector.
- los updates now correctly take tiled maps into account.
- do los updates even on maps without darkness.
- fixed quiver of holding bolts to be able to hold bolts.
- upgrade to IO::AIO 3.21.
- fixed show invisible, to show objects of type CONTAINER.
- properly catching exceptions from callback in irc.ext.
- fixed a potentially hazardous bug in cfpod regarding Z<>.
- (maps) fixed npc dialog in /pup\_land/nurnberg/reception/reception.
- (arch) added hint about usage to Slag Ex.
- (maps) /darcap/quest/water sea1 tile are now passable by players,
like the rest.
- (maps) added /heaven/gem\_shop by Boes.
- (arch+maps) added rate limited converter and adjusted
/elmex/mana\_fountain.
- store arrow->slaying in custom\_name, to get rid of the spellarg slot.
- reduce size of casting\_time, move\_status, attack\_movement,
last\_heal and last\_sp slots, squeezing some more space out of struct
object, also declare expmul as constant 1.0, as it isn't used
anywhere.
2.78 Sun Apr 5 20:04:29 CEST 2009
- fixed bug in alchemy, where finding the right object for enhancements
didn't work.
- aggressively merge spell effects and do not allow more than 5 spell
effects (w.r.t. put\_more) per mapspace, to give the server a chance
to survive a hundred deathsheads.
- correctly clear op->env when inserting onto map, this was a potentially
disastrous bug of unfortunately unknown proportions...
- fix cone-spell symmetry that was broken for direction 8.
- use gender-neutral place descriptions for invite.
- (arch) new faces for alchemist class, wizard class and quetzalcoatl race.
Thanks go to Lisa Larsen!
- remove support for colour reducing 32x32 images (no cfclient support
anymore).
- actually mention the literacy level when it is too low to learn the spell.
- use better dependency tracking for include/keyword.h.
- add accept-invitation and suicide to the list of asynchronous commands,
so it is possible to invite somebody out of some stck-till-death traps,
or simply to commit suicide.
- replace the "ignoring delayed commands" message by something more useful
(cf. cunning gnome freezeing issue).
- various fixes for weapon improvements.
- fixed small bug with handling connect errors in the IRC gateway.
- support T and G sequences in cfpod.
2.77 Sun Feb 1 16:30:48 CET 2009
- convert me command from per-map to chat, which makes more sense, also
document it.
- more than one spellbooks of same class can now be given
in class selection.
- adjusted the starting\_spell.trs treasure list to the recent
spell rebalancements.
- the IRC gateway filters IRC colors now.
2.76 Sat Jan 17 08:36:51 CET 2009
- (arch) fix quiver of Holding Bolts.
- applying unpaid items will now examine them.
- add "What" column to body command, showing items in that slot.
- redesigned and rebalanced lamps and torches.
- add "..." to item names that have been shortened.
- fixed "assign" function that squeezes strings into fixed length.
- add cursed effect to lamps and (some) torches.
- fixed bad assigned crafting skills and their tools.
2.75 Fri Jan 9 16:13:30 CET 2009
- rebalanced lighting w.r.t. outdoor, darkness and see\_in\_dark.
- fix a bug in the nimbus extension that allowed players to cheat.
- make monster smell logic dependent on their wisdom stat.
- put the death reason into a separate tab.
- converted "connected" slot to string, cleanly got rid of some ugly
hacks such as the path\_attuned hack.
- introduce shstr\_tmp for fast temporary shstr passing.
- replace one-at-a-time hash by faster than smaller FNV-1a hash
when hashing strings.
- sanitized alchemy-like skills and cauldrons to check earlier
whether the right cauldron is used.
- considerably optimise shared string implementation by
making its null value a compiletime constant.
- use shared string matching insteafd of strcmp in a lot of places,
as well as using shstr\_cmp to pass shared stringsa round efficiently,
for lots of code size savings.
- monsters which breed new monsters shouldn't breed new monsters when
they are sleeping: generators now check for the sleeping flag.
- tell gcc not to excessively inline some perl interface functions.
- remove marking rune length limit.
- fix formatting of cfpod when a verbatim block was following
a single newline.
- move resistances, statistics and showpets command output into tabs.
- implement map scripts that can replace the boulder logic without
having to write extensions.
2.74 Mon Dec 29 15:23:38 CET 2008
- fix a longstanding bug that teared multipart monsters
at map boundaries apart.
- temporarily make permanently invisible player visible when
he/she makes noise.
- fix being able to see through walls a bit.
- improve look at output.
- completely replaced the line of sight algorithm with a variant
of spiral fov capable of visibility grades and arbitrary
shadow angles, that uses less memory and less code.
- the new los code supports arbitrary map rectangles and loosens
other restrictions of the old code, supporting further optimisations.
- update los if blocksview-objects are inserted in a map, not just when
removed (e.g. for summon fog).
- permanent invisibility doesn't make immune against making noise:
implement a noise system that allows monsters to locate the player
when he/she makes noise.
- implement a primitive smell system that monsters can use to track
players.
- create bomb now also works when casted by door traps.
- (arch) new torch graphics.
- (maps) considerably soften the subway spider.
- (maps) made the portgate of navar safe ground, to protect
the guards from being killed by players.
- (maps) lots of tweaks in and around scorn.
- (maps) use special non-blocksview jungle, mountain and
darkforest freely on the worldmap, to get gradual sight obstacles
instead of total blackout in those areas.
- no maximum darkness for outdoor maps anymore.
- add more hints, fix some messages.
- fix a bug: firing rods should tell you something about them.
- make light additive even within players.
- darken xrays effect a bit.
- improve handling of los changes when inserting or removing
objects, not perfect yet.
- make map darkness signed (formerly unsigned) to allow
ambient lighting and centrally manage darkness as an offset.
- revamped, fixed and documented the server calendrics, also
tell users the current time and data, to improve awareness.
- implement proper wizlook flag and handling of wizlook, instead
of dumbly just clearing los once.
- speed up los code - it's now about 2-3 times as fast as the old one,
and has a smaller runtime variance.
- daylight/nightfall can now increase/decrease past the natural limit,
making them actually useful.
- see\_in\_dark now increases the viewing radius by 3.
- implement a fast tiled map iterator and use it in LOS for a 20%
speedup, as well as in many other places.
- remove support for extended map infos - these are not used
by the deliantra client and removing them gives us a 10% speedup
when sending map changes.
- remove most gcfclient and other client bug workarounds, as well
as now obsolete protocol versions, simplying the code.
- optimise and simplify generation of random numbers.
- correctly provide a non-zero default density for materials, to
avoid crashes, fix other bugs in the material handling code.
- fix volume calculations.
- fix cfpod parsing when multiple verbatim blocks were separated by
newlines.
- increase monster detection radius from wis/5 to wis/3.
- remove old pickup modes.
- remove obsolete disarm and search commands (search wasn't working
anyways).
- fix a crash when an npc applied a sign.
2.73 Thu Dec 18 20:56:31 CET 2008
- this release is assumed to be very stable.
- (maps) radically redesigned and improved tutorial.
- directional casting no longer immediately removes the invisible effect.
- magic ears now trigger when used inside the NPC dialogue.
- fix overflow in lighting calculations.
- negative glow radii can no longer cause total darkness.
- allow lookat on spaces where we only barely see, as opposed to
only maximally-lit ones.
- class selection has been reworked completely and their documentation corrected.
- swashbucklers got the oratory skill now.
- jump skill was fixed to adhere to all the flags a mapspace has got.
- (maps) small fix w.r.t. magic ear in /scorn/houses/wizz.entry
- fix deadlock in Jeweler::improve\_ring\_by\_plan.
- use Coro::SemaphoreSet instead of our own lock management
(which was probably broken, too).
- support negative glow radii during daytime, too.
- use circular, not rectangular, viewing area.
- use minimum viewing distance of 2 in outdoor maps.
- negative glow is stronger than viewing area or lamps.
- (arch) new darkness spell face.
2.72 Thu Dec 4 22:20:19 CET 2008
- (maps) completely redesigned scorn.
- "cast light" now works on oneself.
- bump max light radius to 9, rewrote glow lighting calculations, fix
negative glow radii again (they were totally broken before).
- the "worldmaps sometimes are black" bug is finally fixed.
- the "player objects are referenced in \_GENxx globals" bug has finally
been fixed, by not relying on buggy perl internals when serialising.
- fixed a long standing bug in the anvil converters in armour shops.
- items shops weren't interested in don't vanish anymore, and are given
back to the player.
- attuned/repell and spell base level system reworked.
- rewrote skill cache (last\_skill\_ob) system and usage - might
be less erratic now.
- refuse to write the uuid file if the uuid is zero
(to avoid writing it in early crashes).
- pathsync the directory after saving a file for added slowdown^Wsafety.
- speed up emergency\_save by not syncing every file separately.
- no longer reattach perl to every object on reload, it's slow, and no longer
necessary since we don't nuke stashes anymore.
- do not bootstrap perl from the commandline args, use separate eval for
better error reporting.
- fix a crash when pushing cone spells met ice attacks.
- pre-cache perl extension files on reload to speed up the reload.
- speed up map refresh in server a bit.
- refactored drop code and fixed some programming errors in it.
- fixed small regression in 'Slag Ex' potion extension.
- fixed a bug where some objects couldn't cross map tile boundaries.
- fixed a bug with weight update of the player, the client showed -0.0
as the current weight of the inventory.
- (arch) the dragonbreath spell is level 12 again, but the high level spell
dragonfire has been introduced for the non-dragon players.
- remove unused "tooltype", "start\_holding" object slots.
- change "weapontype" object slot to uint8.
- convert "hide" object slot into flag.
- reorder object members for better locality of reference and codesize
decrease.
- correct rounding in lerp, add lerp\_rd, lerp\_ru.
- fix a crash when no skill could be found when killing amonster.
- fix a small memleak that would eat one pointer on the perl stack for
every completed aio operation.
- perl mapspace acessor methods now normalise (handle tiled maps)
and update mapspaces if necessary.
2.71 Tue Sep 23 07:02:23 CEST 2008
- removed all command line parsing, only env variables are supported
anymore.
- region-specific monsters will now once more be on the worldmap.
- fix a disastrous "memleak" where temporary memory allocations
would grow out of bounds.
- server now writes a pidfile and makes sure its alter ego is killed.
- fixed a double-escaping bug in the pod-parser.
- rewrote the cfpod parser in C++.
- hintmode moved to C++, players need to re-set their hintmode if
they dislike "show".
- fix RIP inscription.
- bump login name length from 18 to 20 char max.
- correctly support gender in emotes.
- correctly support gender in the death messages.
- correctly generate death messages for players only when they really die,
with increased information.
- fix a bug in the dynbuf code that could potentially lead to crashes
and data corruption (but apparently was never triggered).
- close the $ENV{LOCKUTIL\_LOCK\_FD} fd if in the env, for lockutil.
- make sure Compress::LZF acquires the storable lock, might fix some
data corruption bug.
- tweak coredumping/monitoring a bit.
- completely redid server initialisation to hopefully avoid rare races.
- do not crash in the loader when an inventory object could not be loaded
(from a corrupted file).
- redid skills command to send output to proper channel.
- object->map is no longer refcounting.
- add FLAG\_DEBUG for internal debugging.
- add NDI\_VERBATIM flag to send\_msg.
- add perl backtraces to logBacktrace-initiated backtraces.
- player->exists is no longer a sync\_job.
- split login.ext's player scheduler into
it's own player-scheduler.ext extension.
2.7 Sun Sep 7 16:32:03 CEST 2008
- require perl 5.10.
- make nrof signed, so that code that checks for underflow actually works.
- swap player and observed count's on the map when observing.
- add (mostly untested) mapspace perl class and accessors.
- re-"calibrate" value/weight autopickup to be silver/kg >= pickup\*100.
- fix a crash in cast\_bless (restoration et al.) when no target
could be found.
- pits now have a configurable "random spread" range and default
to a radius of two now.
- rewrite pay\_player\_arch.
- use a more stable perl\_reload implementation.
- do not use Symbol::delete\_package (causes crashes after perl-reload),
use our own, safer, clear\_package instead.
- when asynchronously dumping core, close all file handles to allow
the server to restart concurrently.
- improve the cfpod parser to generate proper xml from proper cfpod
sequences, without double-encoding. it should be faster, too.
- the above fixes wrong display of help tetx and many other issues.
- use lzf and frag packets for large messages for clients supporting them
(0.9976+), use it for long books and other messages.
- eradicate listen command and corresponding code.
- eradicate logs command.
- let the client log into the server log, used for crash backtraces.
- fixed rods/wands/etc. with randomitem spells on maps, but broke
old style spell objects with the spell magic bullet.
- (arch) fixed skill less rods in the archetypes
2.61 Sun Aug 3 17:59:50 CEST 2008
- made jeweler workbench larger and some other minor map
changes in jeweler town.
- fixed wrong item handling in jeweler skill code.
- (arch) use a special "key\_random\_map" for random map keys
that are used up.
- fix a crash when the player who was observed has logged out long
enough for his region/map to be gone.
- port to g++-4.3's incompatible tr1 changes.
- add some missing dependencies.
- log to /var/log/deliantra/ by default.
- hack observe code to enable smooth movmenet when observing.
2.6 Sun Jul 20 18:58:08 CEST 2008
- (maps) extension of the jeweler quest/skill/town
- correctly move gsay to the party channel.
- fix a crash when animate weapon was used in some areas.
- fixed unnecessary identification of by converters created objects.
- (maps) tutorial now contains clues about chatting and talking
with NPCs.
- (arch) dragon scales got proper type now
- object::decrease would sometimes cause container weights to
be wrong, this has been fixed.
- do not send time updates for newly-seen items.
- thawing an icecube will once more drop its contents to the ground.
- fix cone spells etc. going through walls sometimes.
- fix a weight update bug that sometimes left containers
with wrong weights.
- added auto\_apply event and extension for shop tiles.
- work around get\_map\_flags invoking perl and switching the stack.
- make sure the map is loaded when using a town portal return.
- fixed a bug with caching of sp/grace/food points for spells
where healing spells didn't cost any grace.
- fix starvation kill reason.
- fix pk killer name message.
- don't let people apply signs with @match.
- add support for berkeley db 4.7 (the new BDB module also fixes
what seems to be the biggets memleak in the server).
2.56 Wed Jun 4 10:50:40 CEST 2008
- require Coro 4.73 which contains an important performance-bugfix.
- use anyevent to manage listen ports (this enables IPv6 support).
- server supports ipv6 client connections now.
- use newly-available Coro::AnyEvent.
- get rid of the AnyEvent::AIO watcher, start the event thread earlier
to let it handle AIO requests.
2.55 Sat May 24 19:52:52 CEST 2008
- avoid newmap commands when crossing tiled map boundaries. this speeds up
processing considerably (especially in the client) and reduces data transfers
(saves roughly 1kb each crossing in typical configs). works even with gcfclient.
- (arch) fix typo in ixalovh treasurelist causing empty\_archetypes to appear.
- (map) fixed npc dialogue in pup\_land/s\_f/special.
- bugfix: fix a crash when a player casts a swarm spell and then logs out
(swarm spells now stay in the player's inventory).
- bugfix: when unapplying skills also remove them from the range/combat slots.
- bugfix: do not merge items whose archetype name merges, use the
archetype \*archname\* (chairs of different facings were merged).
- bugfix: fix a potential crash issue in find\_object\_name (not used
normally).
- bugfix: locked doors cannot be bashed down by magical means
(destruction, magic missile etc.).
- swarm spells without a direction now use various spiral patterns
instead of being fully random.
- update AnyEvent API to 3.4 and above.
2.54 Thu May 8 22:01:22 CEST 2008
- change floorbox item ordering to enable more efficient protocol and to
stay in sync with the 0.9971 client update which also reverses ordering.
- bugfix: the jumping skill now gives experience for jumping
and for attacking monsters. it also takes about one second to do a jump.
- bugfix: players couldn't starve in 2.53 :(
- bugfix: correctly send the client a del\_spell when a spell gets removed.
- bugfix: spell effects like word of recall are removed on death.
- bugfix: fix a crash when objects with treasure on top (ground...)
were created outside a map.
- bugfix: couldn't apply inventory items when levitating, but ground items
(fixed by reversing the logic).
- bugfix: fixed a mismatched '"' in the debugging description of objects
- bugfix: the random map generator no longer leaks key objects.
- bugfix: support random maps >127x127.
- (maps) fixed the death certificate system in nimbus.
- (maps) rebalance onefang, build a road to onefang, temporarily closed zorn.
- (arch) the material 'wood' was undefined, it's now a burnable material.
- (arch) give ball lightning a real name.
- (arch) fixed material of bones (was 'wood', is now 'bone')
- support cfpod in ex replies (client item tooltips).
- unapply item in range slow when readying a spell.
- bugfix: account for rounding errors in weight updates.
- remove synchronous mkdir in chargen\_race\_done.
- fix per-race starting maps.
- check hiscore on suicide and quit as well.
- tell players when they are starving.
- get rid of costly object\_from\_name conversion for altar effects.
- fix map difficulty calculation for generators.
- slightly more intelligent handling of "is\_animated" flag.
- support no\_drop map header flag (before it was only available internally).
- make random-map-generated keys crumble after one hour, use more unique slaying.
2.53 Sun May 4 17:32:48 CEST 2008
- bugfix: custom skill settings were not saved by the server.
- bugfix: remove did not actually remove items from the inventory, leaving
ghost items.
- bugfix: properly update items identified on the ground.
- bugfix: use localtime\_r in the logger thread.
- bugfix: player starvation will now give the correct kill reason.
- bugfix: archetype reloads could crash the server.
- bugfix: the mailscrolls are now correctly handed out even when the destination
player is not logged in.
- bugfix: make list\_logins non-blocking (glaring oversight). this caused the lag at
server startup.
- bugfix: fix the door surround check in the random map generator.
- (maps) fix heaven quest difficulty progression.
- (maps) fix some random map styles.
- dropping items a shop is not interested in won't sell them anymore.
- rods and horns with a too low maximum charge allow now at least one discharge.
- implement kill & death statistics.
- random map preparation is no longer synchronous.
- rewrite find\_style in perl, no longer does synchronous I/O.
- improve random map specials placement.
- make the killer a real object pointer instead of a string, improved
kill reason messages.
- take advantage of new aio\_close and aio\_chmod.
- implement archetype::get, object::deep\_clone and update callers.
- change\_abil is much faster.
- update the floorbox more often to work around the reverses item order
display in clients.
- cleaned up object copying by encapsulating it to a single place.
- add hints to the invite messages.
- rewrote key<->value pair handling.
- use an independent random number generator for the random map generator.
2.52 Thu Apr 24 11:47:19 CEST 2008
- completely automate the item add/delete on remove/insert. this should fix
all "ghost" item bugs caused by sloppy coding, as sloppy coding is now correct :)
- completely automate the weight handling, should fix all weight
accounting bugs caused by sloppy coding, as sloppy coding is now correct :)
- reloading archetypes while a user was in the character creation phase
could crash the server.
- fix a nontrivial number of cases of code commented similar
to "is this really correct?", as many of those cases are now handles
automatically by lower level code.
- replace many ad-hoc checks for client visibility by object::visible\_to,
should result in broader applicability of functions using it.
- merge items with different arch pointers refering to the same arch
(due to archetype reloads).
- refactored the object remove/insert functions and most related
functions (decrease, split, merge\_ob etc.).
- make it compile better on freebsd (reported by pippijn).
- removed GT\_UPDATE\_INV (no longer applicable).
- fix the longstanding "container stays open" bug.
- improved floorbox updating to be incremental and other protocol
optimisations.
- get rid of update\_after\_inventory\_change and only do update stats
for weight once/tick/player at max.
- rewrite party commands, use party channel.
2.51 Sun Apr 20 21:27:37 CEST 2008
- properly link against libgthread as that is needed to make the slice
allocator thread-safe.
- support perls not compiled with 64 bit support (though this is not a
recommended configuration) (reported by Samuel Gondouin).
- always put godgiven items into the player inventory, never any containers.
- (maps, arch) the scorn go club was founded!
- (arch) do no longer support player abilities, they didn't work anyways.
- (arch) the alchemy spell is now of the alchemy spell school, which
became a real spell-class.
- (arch) the alchemist class now get an alchemy spell book for new characters.
- (arch) considerably strengthened spark shower and destruction.
- match archetypes by name, not by ptr, in treasure.C, this makes archetypes
finally reloadable at runtime.
- changed archetype loading algorithm to only require one pass and
use delayed resolving of references.
- examine command now uses the examine infobox.
- implement an "incremental garbage collector" for archetypes.
- enable slice allocator again.
- implement optional free memory poisoning.
2.5 Wed Apr 16 15:06:53 CEST 2008
- the two handed weapon skill can no longer be used as unarmed combat
skill.
- append [drop xxx coins] to altar/trigger\_altar/identify\_table/converter
names (also update all maps to use money instead of coins).
- add uuid accessors to perl.
- add coin names and archetype accessors to perl.
- fix runtime uuid file format to use "." instead of ",".
- change perl extensions to not use hardcoded coins and values.
- write uuids asynchronously (no hiccups due to uuid writes)
and be more parsimonous of uuid usage by the exact value out on exit.
- write log messages in another thread, removing another sync point.
- support multi-line log messages in a nicer way.
- be more portable w.r.t. uuids and format specifiers everywhere.
- fix a minor memleak in the random map generator.
- some parts of the random map generator are not coroutine-safe,
so only call it "single-threaded".
- major cleanup of memory management in random map generator.
- slight refactoring of the random map generator, faster too.
- solve the "slice\_alloc becomes negative" mystery - no allocation bug,
bookkeeping bug.
- work around "player is on active list" problem by deactivating player
after loading.
- garbage collect shstr's more evenly and adaptively only when
there have in fact been allocations.
- fix object::insert to do as documented and insert into the env
if necessary.
- fix cf::map::unique\_maps.
- fix nrof overflow check in can\_merge\_slow.
- fix converter code to handle >31 bit values.
- added support for the player\_sold flag
- converters no longer accept unpaid items.
- canonicalize random map meta files for better unification.
2.43 Sun Apr 6 20:35:29 CEST 2008
- work around a glibc bug that causes calloc to return non-zero memory
when mlockall has been used.
- pass environment to perl\_sys\_init3, as required by newer perls.
- use separate thread for ticker timing (and more in the future).
this greatly increases timing accuracy and gets rid of an enourmous
number of gettimeofday calls.
- use a separate thread to signal aio completion, for lower latency.
- require Coro 4.47, which fixes a data corruption bug with its C API.
2.42 Sat Mar 15 12:05:21 CET 2008
- rebalanced default experience table to be more exponential
and much easier up to level ~40, then moderately harder.
- change attuned/repelled level boni to +-8 from +-2.
- use SvUPGRADE to avoid exception in sv\_upgrade with perl 5.10.
- do not exit on reload/load errors but properly cleanup.
- fix a 32 bit uncleanlyness in the slice debugging wrapper.
2.41 Fri Jan 25 13:15:37 CET 2008
- get rid of YAML::Syck, it's too buggy and misparses many files
(this fixes the jeweler skill).
- back-to-back perl\_reloads don't freeze the ticker anymore.
- convert cfutil from Event to EV (forgot to do this earlier...).
- move tombstone to real map if player died due to cave-in (even if
it has reset, which is better than putting it on the savebed, also as
proof that the player didn't use a savebed).
2.4 Sun Jan 13 13:41:29 CET 2008
- work around perl bug in configure perl module version check.
- fix bug in golem move code that would cause a crash at tiling borders.
- fix a freeze bug when looking for an arrow in the inventory.
- fix a bug in animate\_weapon, causing a crash.
- no longer exit when a coroutine throws an exception.
- fix a potential double free bug (nicely exploited by g++ 4.2).
- fix the " is nuts" message.
- fix an exception at logout due to the json\_coder being gone.
- upgrade to EV version 2.0 API.
- when players don't apply a savebed correctly but stand above one,
do not move or kill them.
- implement client-side settings page in playerbook (0.9963+ required).
- implement generic framework for server-side resource files.
- implement resource file update event.
- hook experience table update into the framework.
- move jeweler.yaml to resources (arch/).
- switch from Crossfire to Deliantra perl module.
- implement json2json arch filter.
- implement widget protocol version 2, support for ui templates.
- mapinfo is now handled fully asynchronously.
- ext/irc: also log irc messages.
- ext/schmorplog: write user stat files asynchronously.
2.32 Sun Dec 2 18:11:01 CET 2007
- limited the number of items that can be picked up and dropped
as temporary measurement against bad performance or dropping things
(this lead to long freezes and triggered the watchdog).
- improved the performance of the drop command a bit.
- switch from Event to EV for higher performance, easier usage,
less bugs...
- updated to release version of the gnu affero license.
2.31 Sun Nov 11 17:26:28 CET 2007
- more thoroughly rename the binaries, contact addresses.
- update the copyrights.
- avoid backtraces due to old spells on some maps, sometimes causing
crashes.
- fix a problem where facedata wasn't initialised to zero properly,
potentially causing crashes.
- assign weapons on user load time, not login-time, avoiding
crashes.
2.3 Sat Oct 27 11:22:38 CEST 2007
- fixed an important bug that caused passwords to be forgotten.
- implement \*tag destinations for goto, slaying etc. and use it
in some of the maps.
- bigworldised many maps (islands as in pupland and aldwulf),
which is now trivial to do.
- removed all traces of the old (and never working) plug-in interface
(70kb code less on amd64).
- improve/tune scheduling priorities.
- fix some freezing bugs.
- fix a memory corruption problem in dynbuf.printf.
- use channels for chat and many informational commands.
- improved the tutorial.
- create missile is now fixed.
- race fields must now contain archetypes.
- jumping skill now works as advertised.
2.2 Tue Sep 11 15:41:24 CEST 2007
- relicense under the gnu affero license.
- new inscription skill, can only inscribe INSCRIBABLE items.
- implement server-side framework for generic resources.
- use resource framework for server-provided ambient
music.
- save object owners (players only atm).
- replace limited sound api with server-provided sound effects.
- new sc (sound control) protocol command.
- improve fxix protocol to include types.
- exactly fill tcp segments, if possible.
- output-rate is now an upper limit, the server will automatically
(and quite perfectly) adjust to the network conditions, ensuring
low latency even during bulk transfers (music, images, sounds etc.).
- implement server-side widgets (i.e. client widgets controlled
in the server side). this will allow future expansion without
having to upgrade clients.
- implement a (artwork) world map with realtime player position
tracking.
- new and more efficient extcmd (server still supports old extcmd
protocol).
- fixed lots of underflow/overflow bugs in diseases and general stats
calcluation that could be easily exploited by users.
- rebalanced diseases to spread more naturally/evenly.
- completely asynchronous map loading even for tiled maps.
- replace simple messaging protocol with channels carrying metadata
(similar to message types, but more directed at the user).
- reduce command processing latency by a whopping 120ms by
reordering some processing steps inside the server. this directly
reduces lag by 120ms.
- actually send spell faces to the client.
- implement player genders.
- unclean logout/login results in: nothing if map hasn't reset,
otherwise return to savebed and possible kill if the log-out
was for too long.
- fast socket-dead detection (kick player after 8 seconds without ack).
- greatly reduce the cpu time needed to draw maps \_again\_.
- archetypes are now subclasses of objects.
- rebalanced shop greed and approval functions to be more realistic
(and likely match the actual intention).
- implement "crossfire pod" format for messages, with working bold,
italic, gender-specific text, paragraphs etc.
- implemented hint framework, players can opt to receive hints.
- implemented (long) book framework, added some books from the cf wiki.
- implement generic message framework that uses xml, utf8 for the client
protocol and is capable of transmitting generic meta information.
- implement (in a suboptimal way) per-player instantiated maps.
- replace the nexus by a per-player tutorial map that teaches stuff
better than the newbie house.
- fix the magicmap colours.
- optimise map update even more by removing unneeded code and checks.
- decouple map and stats update from pl->ob and use pl->observe instead.
- implement observe command.
- major speed up in map refresh by replacing most get\_map\_from\_coord
calls with a simple comparison.
- fix a latent crossfire bug that could crash the server because the
map refresh did not update the mapspace.
- support custom keys for regions and maps, regions are now
refcount-managed.
- allow worldmap overlays anywhere in the 000..999 range.
- new system to acquire time slices for background jobs, to reduce
jitter.
- semi-persistent object-referencing framework (currently only players
supported).
- dependency tracking for perl extensions.
- new slag-ex extension for cleaning cauldrons.
- fix invoke result processing.
- there are even less i/o syncpoints in the server now.
- added map-tags extension that scans all maps for object tags
and records them in the database (not used yet).
- metaserver 2 support.
- many more bugfixes and minor optimisations.
2.1 Sun May 27 04:21:29 CEST 2007
- optimised event invocation (non-wanted events can now be
skipped with 4-5 inlined instructions).
- complete rewrite of town\_portal: it now creates a portal
to the "nearest" town only, travel is only possible
to the town and back, anybody can use it (also removes
one of the remaining syncpoints in the server).
- complete rewrite of the range/attack skill slot system:
there are now two slots, one for combat, one for ranged
attacks.
- introduce the concept of a current weapon (either a ranged
or a combat weapon/skill/tool) and switch between them as
needed.
- rewrite bow code so bows get more useful: apply damage,
attacktype and other stats to the arrows and treat
bows as weapons. also rebalance the missile weapons skill
so its damage increases with level.
- rewrite the complete player speed logic: weapon\_speed now
works as documented and there are no unnatural speed boosts.
- implement a utility - cfutil - that simplifies arch and map
installation, replacing the old collect scripts and
simplying deployment by scaling and cutting faces as required.
- simplify the map protocol extensively by taking advantage
of missing bigfaces, speeding up map generation immensely.
- implement inherit keyword allowing archetypes to inherit from
other archetypes.
- rationalise archetype, region and treasurelist file format
into a single file format and make them reloadable asynchronously.
- make the worldmap, facedata (smoothing, faces, magicmap)
reloadable at runtime.
- implement 64x64 faceset support.
- implement fxixsx protocol that saves
a lot of bandwidth over the old image/face/smooth packets
and allows images > packetsize, incremental and background
transfers.
- implement a bandwidth-saving smoothing protocol that works
on a face basis as opposed to a mapspace basis.
- the server can now rate-limit image uploads to not exceed
a certain (client-configurable) speed while guarenteeing full
freedom of movement.
- implement new ex command to request item descriptions.
- implement new msg command for in-game messages with meta
information (using xml).
- enforce utf-8 for all text messages.
- added micropather (not used yet).
- many, many bugfixes.
2.0 Tue Mar 6 15:22:53 CET 2007
- make coroapi accessible to cf+.
- moved map handling logic completely to perl
- per player maps are now marked in the map
- maps are saved completely differently now,
and much more often.
- rewrote map header parser and writer, to be much faster.
- maps and players are now (in the average case) loaded
and saved completely asynchronously, I/O contention will no
longer freeze the server.
- players and maps can be loaded anytime, without the player
being logged in.
- automatically generate method interfaces for perl from headers
- unbundled freezethaw
- mostly rewrote common/map.C
- completely rewrite server/swap.C
- introduced "runtime", the CCT clock (corrected crossfire time) :)
- introduced new keyword for map files: file\_format\_version (integer, server version: 0)
- better message for apply failures due to applymode
- removed most all of the weather code
- unified logging to stderr and file
- too many minor changes to document

