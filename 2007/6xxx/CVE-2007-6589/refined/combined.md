=== Content from www.vupen.com_8d901868_20250125_074152.html ===

[![](/__ovh/common/img/logo-white.png)](https://www.ovhcloud.com/)

![](/__ovh/common/img/icon-traffic-cone.png)

# Site en construction

![](/__ovh/common/img/shadow.png)

Besoin d'assistance ou d'informations ?

[![](/__ovh/common/img/icon-book.png)
Guides](https://docs.ovh.com/fr/hosting/ "Guides")
[![](/__ovh/common/img/icon-speech-bubble.png)
Forum](https://community.ovh.com/ "Forum")
[![](/__ovh/common/img/icon-user-support.png)
Contact](https://help.ovhcloud.com/fr/ "Contact")
[![](/__ovh/common/img/icon-app-gear.png)
Espace Client](https://www.ovh.com/manager/ "Espace Client")

© Copyright 1999 [OVHcloud](https://www.ovhcloud.com/)

v1v2v3v4v5v6v7v8v9v10v11v12v13v14v15v16v17v18v19v20v21v22v23v24v25v26v27v28v29v30v31v32v33v34v35v36v37v38v39v40v41v42v43v44v45v46v47v48v49v50v51v52v53v54v55v56v57v58v59v60v61v62v63v64v65v66v67v68v69v70

u1u2u3u4u5u6u7u8u9u10u11u12u13u14u15u16u17u18u19u20u21u22u23u24u25u26u27u28u29u30u31u32u33u34u35u36u37u38u39u40u41u42u43u44u45u46u47u48u49u50u51u52u53u54u55u56u57u58u59u60u61u62u63u64u65u66u67u68u69

p1p2p3p4p5p6p7p8p9p10p11p12p13p14p15p16p17p18p19p20p21p22p23p24p25p26p27p28p29p30p31p32p33p34p35p36p37p38p39p40p41p42p43p44p45p46p47p48p49p50p51p52p53p54p55p56p57p58p59p60p61p62p63p64

e1e2e3e4e5e6e7e8e9e10e11e12e13e14e15e16e17e18e19e20e21e22e23e24e25e26e27e28e29e30e31e32e33e34e35e36e37e38e39e40e41e42e43e44e45e46e47e48e49e50e51e52e53

n1n2n3n4n5n6n7n8n9n10n11n12n13n14n15n16n17n18n19n20n21n22n23n24n25n26n27n28n29n30n31n32n33n34n35n36n37n38n39n40n41n42n43n44n45n46n47n48n49n50n51n52n53n54n55n56n57n58n59n60n61n62

---

c1c2c3c4c5c6c7c8c9c10c11c12c13c14c15c16c17c18c19c20c21c22c23c24c25c26c27c28c29c30c31c32c33c34c35c36c37c38c39c40c41c42c43c44c45c46c47c48c49c50c51

o1o2o3o4o5o6o7o8o9o10o11o12o13o14o15o16o17o18o19o20o21o22o23o24o25o26o27o28o29o30o31o32o33o34o35o36o37o38o39o40o41o42o43o44o45o46o47o48o49o50o51o52o53o54o55o56o57o58o59o60o61o62o63

m1m2m3m4m5m6m7m8m9m10m11m12m13m14m15m16m17m18m19m20m21m22m23m24m25m26m27m28m29m30m31m32m33m34m35m36m37m38m39m40m41m42m43m44m45m46m47m48m49m50m51m52m53m54m55m56m57m58m59m60m61



=== Content from www.mozilla.org_1fc26739_20250125_074152.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2007-37

## jar: URI scheme XSS hazard

Announced
November 26, 2007
Reporter
Jesse Ruderman, Petko D. Petkov, beford.org
Impact
High
Products
Firefox, SeaMonkey
Fixed in

* Firefox 2.0.0.10
* SeaMonkey 1.1.7

### Description

The `jar:` URI scheme was introduced as a mechanism to support
digitally signed web pages, enabling web sites to load pages packaged
in zip archives containing signatures in java-archive format.

**Jesse Ruderman** and **Petko D. Petkov**
point out this means that sites that allow users to upload binary
content in zip format are effectively allowing users to install
web pages on their site, and these can be used to perform Cross-Site
Scripting (XSS) attacks.

The blogger at **beford.org** noted that redirects
confused Mozilla browsers about the true source of the `jar:`
content: the content was wrongly considered to originate with the
redirecting site rather than the actual source. This meant that an XSS
attack could be mounted against any site with an open redirect even
if it didn't allow uploads. A published proof-of-concept demonstrates
stealing the GMail contact list of users logged-in to GMail.

Support for the jar: URI scheme has been restricted
to files served with a `Content-Type` header of
`application/java-archive` or `application/x-jar`.
Web applications that require signed pages must make sure their .jar
archives are served with this Content-Type. Sites that allow users
to upload binary files should make sure they do not allow these files
to have one of these two MIME types.

### References

* <https://bugzilla.mozilla.org/show_bug.cgi?id=369814>
* <https://bugzilla.mozilla.org/show_bug.cgi?id=403331>
* [CVE-2007-5947](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-5947)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.2/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_05018fdc_20250125_074156.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/369814)
* [XML](/show_bug.cgi?ctype=xml&id=369814)

Closed
[Bug 369814](/show_bug.cgi?id=369814)
(jarxss)

Opened 18 years ago
Closed 17 years ago

# jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site

## Categories

### (Core :: Networking: JAR, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20JAR#Networking%3A%20JAR)

Networking: JAR
▾

Core :: Networking: JAR
For bugs relating to the jar protocol handler, .jar file
handling, and .jar directory browsing.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20JAR&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20JAR&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20JAR)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla1.9beta2

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jruderman, Assigned: dcamp)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/086ecffaf8ddbcd18bcc73f6d9aea898?d=mm&size=40)  [dcamp](/user_profile?user_id=265995)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d2dc9227eafcd0ec5ba3712ee4f19b75?d=mm&size=40)  [jruderman](/user_profile?user_id=11608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/608e04ebca94be52b05c003d51d43e07?d=mm&size=40)  [kershaw](/user_profile?user_id=505624)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

55 people

## References

### (Depends on 1 open bug, URL )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[405571](/show_bug.cgi?id=405571 "NEW - stuck throbber with blocked jar loads"), [jarxss2](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects"), [405643](/show_bug.cgi?id=405643 "RESOLVED WONTFIX - can't add attachments with domino web access, \"Domino web access error\""), [405676](/show_bug.cgi?id=405676 "RESOLVED FIXED - error pages busted again (netError.dtd out-of-sync again)"), [407303](/show_bug.cgi?id=407303 "RESOLVED FIXED - Getting \"Unsafe File Type\" error when accessing a site that does not exist."), [508369](/show_bug.cgi?id=508369 "RESOLVED FIXED - mochitest-plain: intermittent \"test_bug369814.html | iframes.html loaded from view-source jar type (or from non-jar type), pref disabled: should block a suspicious JAR load\"")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[403552](/show_bug.cgi?id=403552 "RESOLVED FIXED - Version/config bumps for FF2.0.0.10 release")

[xss](/show_bug.cgi?id=301375 "RESOLVED INCOMPLETE - [meta] Ideas for mitigating XSS holes in web sites")

Dependency [tree](/showdependencytree.cgi?id=369814&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=369814)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

jar:http://www.squarefree.com/bug3698...

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [sg:high] XSS against sites that allow uploads of files such as images - looking for new networking owner)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

jarxss

[Keywords:](/describekeywords.cgi)

[arch](/buglist.cgi?keywords=arch&resolution=---),
[dev-doc-complete](/buglist.cgi?keywords=dev-doc-complete&resolution=---),
[fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---),
[fixed1.8.1.10](/buglist.cgi?keywords=fixed1.8.1.10&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:high] XSS against sites that allow uploads of files such as images - looking for new networking owner

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

2

Bug Flags:

| [benjamin](/user_profile?user_id=7044) | [blocking1.9](#a1164441_7044 "18 years ago") | + |
| --- | --- | --- |
| [benjamin](/user_profile?user_id=7044) | blocking1.9 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.8.1.10](#c33 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.8.1.10 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.1.x](#c8 "18 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.1.x | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.8.0.14](#c137 "17 years ago") | - |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.8.0.14 | - |
| --- | --- | --- |
| [caillon](/user_profile?user_id=32335) | [blocking1.8.0.next](#c0 "17 years ago") | + |
| --- | --- | --- |
| [caillon](/user_profile?user_id=32335) | blocking1.8.0.next | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.0.x](#c8 "18 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.0.x | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (16 files, 8 obsolete files)

| [first stab](/attachment.cgi?id=287901)  [17 years ago](#c39)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   6.99 KB, patch |  | [Details](/attachment.cgi?id=287901&action=edit) | [Diff](/attachment.cgi?id=287901&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=287901) |
| --- | --- | --- |
| [v2](/attachment.cgi?id=288030)  [17 years ago](#c43)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   5.49 KB, patch |  | [Details](/attachment.cgi?id=288030&action=edit) | [Diff](/attachment.cgi?id=288030&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288030) |
| [v3](/attachment.cgi?id=288233)  [17 years ago](#c55)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   5.43 KB, patch | bzbarsky : [review+](#c56 "17 years ago") | [Details](/attachment.cgi?id=288233&action=edit) | [Diff](/attachment.cgi?id=288233&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288233) |
| [testcase for comment 57](/attachment.cgi?id=288383)  [17 years ago](#c59)  [Daniel Veditz [:dveditz]](/user_profile?user_id=1689)   397 bytes, application/zip |  | [Details](/attachment.cgi?id=288383&action=edit) |
| [v4](/attachment.cgi?id=288428)  [17 years ago](#c65)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   8.25 KB, patch | bzbarsky : [review+](#c66 "17 years ago")  dveditz : [superreview+](#c67 "17 years ago") | [Details](/attachment.cgi?id=288428&action=edit) | [Diff](/attachment.cgi?id=288428&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288428) |
| [naming fixes](/attachment.cgi?id=288536)  [17 years ago](#c70)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   8.43 KB, patch |  | [Details](/attachment.cgi?id=288536&action=edit) | [Diff](/attachment.cgi?id=288536&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288536) |
| [branch patch](/attachment.cgi?id=288538)  [17 years ago](#c71)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   17.03 KB, patch |  | [Details](/attachment.cgi?id=288538&action=edit) | [Diff](/attachment.cgi?id=288538&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288538) |
| [block inherited loads from unsafe docshells](/attachment.cgi?id=288598)  [17 years ago](#c79)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   3.26 KB, patch | bzbarsky : [review+](#c81 "17 years ago") | [Details](/attachment.cgi?id=288598&action=edit) | [Diff](/attachment.cgi?id=288598&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288598) |
| [inherited loads v2](/attachment.cgi?id=288609)  [17 years ago](#c82)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   5.99 KB, patch | dveditz : [superreview+](#c90 "17 years ago") | [Details](/attachment.cgi?id=288609&action=edit) | [Diff](/attachment.cgi?id=288609&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288609) |
| [test cases](/attachment.cgi?id=288615)  [17 years ago](#c83)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   606 bytes, application/zip |  | [Details](/attachment.cgi?id=288615&action=edit) |
| [new branch patch](/attachment.cgi?id=288623)  [17 years ago](#c88)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   21.29 KB, patch | dveditz : [approval1.8.1.10+](#c94 "17 years ago") | [Details](/attachment.cgi?id=288623&action=edit) | [Diff](/attachment.cgi?id=288623&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288623) |
| [this is jar file - add !/tar1.html to open](/attachment.cgi?id=288634)  [17 years ago](#c91)  [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768)   282 bytes, image/jpeg |  | [Details](/attachment.cgi?id=288634&action=edit) |
| [this is jar file - add !/mid.html](/attachment.cgi?id=288662)  [17 years ago](#c97)  [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768)   234 bytes, image/jpeg |  | [Details](/attachment.cgi?id=288662&action=edit) |
| [this is jar file - add !/flash3.swf](/attachment.cgi?id=288666)  [17 years ago](#c98)  [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768)   2.76 KB, application/octet-stream |  | [Details](/attachment.cgi?id=288666&action=edit) |
| [newer branch patch](/attachment.cgi?id=288695)  [17 years ago](#c101)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   9.78 KB, patch | bzbarsky : [review+](#c102 "17 years ago")  dveditz : [superreview-](#c106 "17 years ago")  dveditz : [approval1.8.1.10-](#c106 "17 years ago") | [Details](/attachment.cgi?id=288695&action=edit) | [Diff](/attachment.cgi?id=288695&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288695) |
| [use the malformedURI error page on the branch](/attachment.cgi?id=288772)  [17 years ago](#c104)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   2.48 KB, patch | dveditz : [superreview+](#c105 "17 years ago")  dveditz : [approval1.8.1.10+](#c105 "17 years ago") | [Details](/attachment.cgi?id=288772&action=edit) | [Diff](/attachment.cgi?id=288772&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288772) |
| [trunk patch with tests](/attachment.cgi?id=289040)  [17 years ago](#c112)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   34.84 KB, patch | bzbarsky : [review+](#c114 "17 years ago")  dveditz : [superreview+](#c129 "17 years ago")  beltzner : [ui-review+](#c130 "17 years ago") | [Details](/attachment.cgi?id=289040&action=edit) | [Diff](/attachment.cgi?id=289040&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040) |
| [zipfile for mochitest](/attachment.cgi?id=289041)  [17 years ago](#c113)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   1.28 KB, application/zip |  | [Details](/attachment.cgi?id=289041&action=edit) |
| [valid.jar](/attachment.cgi?id=289242)  [17 years ago](#c119)  [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768)   158 bytes, application/java-archive |  | [Details](/attachment.cgi?id=289242&action=edit) |
| [the circle may be rotating in the 3rd window](/attachment.cgi?id=289243)  [17 years ago](#c120)  [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768)   396 bytes, text/html |  | [Details](/attachment.cgi?id=289243&action=edit) |
| [test updates](/attachment.cgi?id=290297)  [17 years ago](#c126)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   8.53 KB, patch | bzbarsky : [review+](#c128 "17 years ago") | [Details](/attachment.cgi?id=290297&action=edit) | [Diff](/attachment.cgi?id=290297&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=290297) |
| [test fixes for bug 392567](/attachment.cgi?id=290344)  [17 years ago](#c134)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   2.81 KB, patch |  | [Details](/attachment.cgi?id=290344&action=edit) | [Diff](/attachment.cgi?id=290344&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=290344) |
| [1.8.1\_combined (as reference)](/attachment.cgi?id=306279)  [17 years ago](#c138)  [Alexander Sack](/user_profile?user_id=113760)   19.06 KB, patch |  | [Details](/attachment.cgi?id=306279&action=edit) | [Diff](/attachment.cgi?id=306279&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=306279) |
| [same for 1.8.0 patch](/attachment.cgi?id=306280)  [17 years ago](#c139)  [Alexander Sack](/user_profile?user_id=113760)   14.84 KB, patch | caillon : [approval1.8.0.next+](#c0 "17 years ago") | [Details](/attachment.cgi?id=306280&action=edit) | [Diff](/attachment.cgi?id=306280&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=306280) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=369814#c0)• 18 years ago |
|  | |

Any site that allows image uploads (e.g. avatar images) without binary content sniffing is likely to be vulnerable to XSS (in Gecko browsers only) as a result. An attacker would only have to upload a malicious zip file to the site and get users to follow a jar: link.
Possible fixes:
\* Refuse to open zip file contents with jar: unless the file has a mime type appropriate for zips, such as application/zip.
\* Make jar: not be considered same-origin with the rest of the hosting domain, but only with other contents of the jar.
\* Both of the above.

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=369814#c1)• 18 years ago |
|  | |

This URL demonstrates "XSS" using a jar file served as image/png:
jar:[http://www.squarefree.com/bug369814/xss/test.png!/test.html](http://www.squarefree.com/bug369814/xss/test.png%21/test.html)URL: jar:http://www.squarefree.com/bug3698...

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=369814#c2)• 18 years ago |
|  | |

> \* Refuse to open zip file contents with jar: unless the file has a mime type
I like this one, if it doesn't break existing sites too much...
The other one is actually kinda hard. Esp. on branches. And I'm not sure it wouldn't break sites even more. :(

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=369814#c3)• 18 years ago |
|  | |

There are also sites that let users upload zips (in order to share their contents), but probably fewer.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=369814#c4)• 18 years ago |
|  | |

Yeah, good point. :(
So for branch the change is actually simple to change this behavior, at first glance -- just modify the nsIJARURI code in SecurityCompareURIs somehow. Probably to just get the zip file URI and do an Equals() check on it? Not sure what that would break, offhand....
For trunk, what do you think of making it so <http://foo> subsumes jar:<http://foo> but not vice versa or something?
That would mean you could reach into the jar, but it couldn't reach out.

|  | [David Baron :dbaron: (⌚️UTC-4, no longer working on Mozilla)](/user_profile?user_id=3881) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=369814#c5)• 18 years ago |
|  | |

We should probably accept at least application/x-java-archive and application/zip (which are in /etc/mime.types on FC6), and probably do some research to look for other legitimate MIME types. Some searching on Google turns up application/java-archive, application/x-jar, application/x-zip-compressed, application/x-compressed, and multipart/x-zip, although I didn't look very hard.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=369814#c6)• 18 years ago |
|  | |

Also the XPInstall type.
Note also that if we enforce the type we'll need to force the "jar" extension to be associated with one of these types no matter what our OS settings say...

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a7301_11608)• 18 years ago |

Whiteboard: [sg:moderate] XSS against sites that allow uploads of files such as images

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=369814#c7)• 18 years ago |
|  | |

Wow, that sucks. On the one hand our current behavior makes perfect logical and useful sense, and on the other what web site is going to be expecting to have to defend against this?
What "existing sites" are we going to break, maybe a few experimental Firefox-only demos at best? We can afford to neuter this harshly if we have to (but it makes me sad).
This is not unlike the issues raised by [bug 255107](/show_bug.cgi?id=255107 "RESOLVED FIXED - Prevent data: URLs from being used for XSS")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=369814#c8)• 18 years ago |
|  | |

But much less likely to have entrenched uses we might break.Flags: wanted1.8.1.x+Flags: wanted1.8.0.x+Flags: blocking1.9?Flags: blocking1.8.1.3?Flags: blocking1.8.0.11?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=369814#c9)• 18 years ago |
|  | |

> What "existing sites" are we going to break,
If anything breaks, it'll be intranet applications for the most part, I suspect. That's the logical place to use it, and I've seen a number of newsgroup questions along those lines.
For trunk, we plan to use jar: for the offline web app stuff, as I understand. But that's trunk.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=369814#c10)• 18 years ago |
|  | |

You don't have to use jar: for that, you could use moz-offline: which maps to the same thing but only works on local files, or whatever other special properties you need. And if it's for offline apps, it shouldn't need to reach into frames that are on-line.

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=369814#c11)• 18 years ago |
|  | |

For offline apps, we are using jar: URLs that point to remote files, not local files, and we definitely need them to be same-origin with regular http: frames from the same domain. There's no such thing as "online" or "offline" frames, just frames that happen to be served from the offline cache, which does not change their security status. The same-origin security model is not changed at all for offline apps.

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=369814#c12)• 18 years ago |
|  | |

So I'd favour Jesse's first option, except that I'm afraid that if a server serves all .jar files with type application/zip, there may be a myriad of ways for an untrusted user to get unsanitized .jar files onto the server.
Here's another option: create a new MIME type, say application/x-sanitized-jar. jar: loads of resources with that MIME type are considered same-domain with the inner URL. jar: loads that see other MIME types are considered same-domain with other resources from the same jar only.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=369814#c13)• 18 years ago |
|  | |

I'd also like to point out that thinking in terms of "same-domain" is not the best approach for trunk. It'll get us in trouble; we should be thinking in terms of what subsumes (or does not subsume) what.
Come to think of it, same for branch -- the "is same domain" check on branch is asymmetric.

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=369814#c14)• 18 years ago |
|  | |

OK sure. So rephrase to say that we want to be able to have jar: URLs have the same principal as their inner URL, possibly conditional on the server return application/x-sanitized-jar as I mentioned above.

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a1164441_7044)• 18 years ago |

Flags: blocking1.9? → blocking1.9+

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a1164727_7044)• 18 years ago |

Whiteboard: [sg:moderate] XSS against sites that allow uploads of files such as images → [sg:moderate] XSS against sites that allow uploads of files such as images - looking for new networking owner

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=369814#c15)• 18 years ago |
|  | |

What do people think about the option in [comment #12](/show_bug.cgi?id=369814#c12 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")? We really need to settle this soon before offline apps start using this in the wild.

|  | [Brendan Eich [:brendan]](/user_profile?user_id=1214) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=369814#c16)• 18 years ago |
|  | |

A new MIME type is warranted. Is any name including "sanitized" the best one? Naming, yay.
/be

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=369814#c17)• 18 years ago |
|  | |

That seems reasonable to me. So basically in those cases the jar channel would give itself the principal from its inner channel/URI instead of what it does now?
Andthen we make nsScriptSecurityManager::SecurityCompareURIs treat jar: URIs asymmetrically on branch? And something more interesting on trunk?

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=369814#c18)• 18 years ago |
|  | |

I'm not really sure how the implementation of this stuff works, but from my quick look at the code, and knowing that you're almost always right --- sure :-).

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=369814#c19)• 18 years ago |
|  | |

Hum. How does access control to WHATWG storage and cookies work? They're based on domain so I think non-sanitized JARs will just have to be prevented from accessing them. And I don't know how hard that would be. Maybe we should just disable remote jar: loads completely unless the MIME type is application/x-sanitized-jar.
If we were to just go with Jesse's proposal #1, what kind of risks would we face? I'm not sure if my concern in [comment #12](/show_bug.cgi?id=369814#c12 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") (and [comment #3](/show_bug.cgi?id=369814#c3 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")) is valid. Presumably sites have to be careful about what types they allow users to upload, but I have no idea what sort of checks people really use.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=369814#c20)• 18 years ago |
|  | |

> Hum. How does access control to WHATWG storage and cookies work?
WHATWG storage uses the jar's inner URI. document.cookie looks like it doesn't work really well for jar:.
What we could do is just disallow access to DOM storage from jar:s that aren't application/x-sanitized-jar.
> Maybe we should just disable remote jar: loads completely unless the MIME type
> is application/x-sanitized-jar
If we hardcoded .jar files to get that type, we \_could\_, I guess. But it'd definitely completely break all existing consumers of signed jars, and those exist for sure.

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=369814#c21)• 18 years ago |
|  | |

(In reply to [comment #20](/show_bug.cgi?id=369814#c20 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> What we could do is just disallow access to DOM storage from jar:s that aren't
> application/x-sanitized-jar.
We could do that, but running around patching access checks here and there doesn't give me a good feeling.
> > Maybe we should just disable remote jar: loads completely unless the MIME type
> > is application/x-sanitized-jar
>
> If we hardcoded .jar files to get that type, we \_could\_, I guess. But it'd
> definitely completely break all existing consumers of signed jars, and those
> exist for sure.
Hmm, and making an exception for signed jars would bring us back to the possibility of using XSS attacks via signed jars. But who uses remote signed jars with the jar: protocol?
It sure would be nice if we could just get away with requiring jar: inner URIs to have application/zip or other known-good MIME type...

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=369814#c22)• 18 years ago |
|  | |

> We could do that, but running around patching access checks here and there
> doesn't give me a good feeling.
Well... Right now DOM storage has explicit code to dig into jar:s. We'd just remove that code. ;)
> But who uses remote signed jars with the jar: protocol?
Anyone who wants to use enablePrivilege, pretty much. Intranet apps are probably the most common use case. We get questions about this in newsgroups not infrequently, so those folks would be the ones to really ask. ;)
> It sure would be nice if we could just get away with requiring jar: inner URIs
> to have application/zip or other known-good MIME type...
Like I said in [comment 3](/show_bug.cgi?id=369814#c3 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"), I'm in favor.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a2898367_1689)• 18 years ago |

Assignee: nobody → dveditzFlags: blocking1.8.1.4?Flags: blocking1.8.1.4+Flags: blocking1.8.0.12?Flags: blocking1.8.0.12+Whiteboard: [sg:moderate] XSS against sites that allow uploads of files such as images - looking for new networking owner → [sg:high] XSS against sites that allow uploads of files such as images - looking for new networking owner

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a4234397_1689)• 18 years ago |

Keywords: [arch](/buglist.cgi?keywords=arch&resolution=---)

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a5244245_103593)• 18 years ago |

OS: Mac OS X → AllHardware: PC → All

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=369814#c23)• 18 years ago |
|  | |

Any such change needs more baking time on trunk, not making 1.8.1.4Flags: blocking1.8.1.5+Flags: blocking1.8.1.4+Flags: blocking1.8.0.13+Flags: blocking1.8.0.12+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a7744362_1689)• 18 years ago |

Target Milestone: --- → mozilla1.9alpha6

|  | [Mike Connor [:mconnor]](/user_profile?user_id=96908) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=369814#c24)• 18 years ago |
|  | |

punting remaining a6 bugs to b1, all of these shipped in a5, so we're at least no worse off by doing so.Target Milestone: mozilla1.9alpha6 → mozilla1.9beta1

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a13024961_1689)• 18 years ago |

Flags: blocking1.8.1.5+ → blocking1.8.1.6+

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a13528086_83595)• 18 years ago |

Assignee: dveditz → jwalden+bmo

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a15514029_1689)• 17 years ago |

Flags: blocking1.8.0.13+ → blocking1.8.0.14+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a20280891_1689)• 17 years ago |

Flags: blocking1.8.1.8+ → blocking1.8.1.9+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=369814#c25)• 17 years ago |
|  | |

M8 is in the past and probably off people's radar. Moving to next upcoming milestone.Target Milestone: mozilla1.9 M8 → mozilla1.9 M9

|  | [Damon Sicore (:damons)](/user_profile?user_id=269330) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=369814#c26)• 17 years ago |
|  | |

Is this a beta blocker?

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=369814#c27)• 17 years ago |
|  | |

I don't think so, for a non-public, non-remote-code-execution bug, although I just might not be familiar enough with the requirements for blocking.
Also, I suspect bonsai watchers will be able to figure out pretty quickly exactly what hole a patch here fixes (i.e. the technical overhead to understanding the code/patch is low, and its purpose can't easily be obscured), so this probably needs to be fixed on branch and trunk in a fairly small window, and I'm not going to be able to fix this in time for the next branch release.

|  | [Damon Sicore (:damons)](/user_profile?user_id=269330) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=369814#c28)• 17 years ago |
|  | |

OK. I'm moving this to the next release. Please let me know if anyone objects.Target Milestone: mozilla1.9 M9 → mozilla1.9 M10

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=369814#c29)• 17 years ago |
|  | |

pdp discovered this bug independently and disclosed it:
<http://www.gnucitizen.org/blog/web-mayhem-firefoxs-jar-protocol-issues>
Group: security

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23426389_180188)• 17 years ago |

Priority: -- → P1

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=369814#c30)• 17 years ago |
|  | |

Unless this can wait until Friday at the earliest, someone else should take this from me, as I can't really justify devoting the necessary time to it until then.

|  | [Giorgio Maone [:ma1]](/user_profile?user_id=151994) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=369814#c31)• 17 years ago |
|  | |

FYI, Latest NoScript development build (disclosed today, after pdp's post) takes a quite drastic but reasonable (considering the behavior of other browsers) measure about this issue.
JAR resources can still be loaded as images, applet classes and the like, but they cannot be loaded as documents.
A regexp-based whitelist is maintained in the "NoScript Options|Advanced|JAR" panel in order to allow specific intranet applications to behave like they always did.
<http://noscript.net/getit#direct>

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=369814#c32)• 17 years ago |
|  | |

dcamp taking per discussion on IRCAssignee: jwalden+bmo → dcamp

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23487773_1689)• 17 years ago |

Alias: jarxss

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=369814#c33)• 17 years ago |
|  | |

This can be blocked in nsDocShell::GetAllowJavascript() by disallowing scripts when the document comes from a JAR channel and doesn't meet some criteria for "OK for scripting".
If we want to use the MIME type of the archive itself we will need to expose that on nsIJarChannel. Intranet apps that use signed code will have to make sure their apps use one of the standard .jar MIME types "application/java-archive" or "application/x-jar" (these do not appear to be defined by default in Apache so any use should be intentional). Since Java applets can "phone home" no one is going to allow the uploading of true unvetted jar files to a host that is at risk of XSS.
An alternate approach would be to only allow scripting from a whitelisted domain. This means we'd have to write whitelisting UI (an infobar at least) and worry that users will incorrectly decide which domains are OK to host .jars (most of them won't have the knowledge or context to know what decision they're making). Or else we bury the whitelist in which case we're just breaking signed sites and dumping a huge tech support load on the intranet IT depts.
Can we disable signed-app support entirely for Firefox 3 or Mozilla2? If sites need to do privileged things have users install an addon. The current system is a big series of "whatever" buttons thrown at the user.Flags: blocking1.8.1.11+ → blocking1.8.1.10+

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=369814#c34)• 17 years ago |
|  | |

I would like to remove support for netscape.securitymanager.enablePrivilege, but I don't think that will affect this bug in particular: it can be useful (and has been done) to ship an entire normal-privilege app as a JAR file, because it ensure cache consistency and can be downloaded as a unit, among other reasons.
So I think we should definitely try to preserve ordinary scripting from JARs served as application/java-archive and application/x-jar

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=369814#c35)• 17 years ago |
|  | |

(In reply to [comment #33](/show_bug.cgi?id=369814#c33 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> This can be blocked in nsDocShell::GetAllowJavascript() by disallowing scripts
> when the document comes from a JAR channel and doesn't meet some criteria for
> "OK for scripting".
I wonder if it would it be sufficient to just return a null principal from the JAR channel if it doesn't meet these criteria?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=369814#c36)• 17 years ago |
|  | |

Right now, any unsigned jar returns a null principal. Whereupon the page gets a principal based on the jar: URI. Then there is inner URI magic that happens.
dveditz and I did discuss making that magic not happen when the jar fails those criteria. That is, having the jar just not be same-origin with the site it's on. We'd also have to fix all the code that manually checks for jar: URIs and gets the host (and doesn't go through the principal!): cookies, permission manager, that sort of thing.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=369814#c37)• 17 years ago |
|  | |

right now an unsigned jar returns nsnull as its owner, it does not return a nsNullPrincipal. If it did it would not get a principal based on its inner URI later on.
I'm not in favor though, I don't have much confidence we can root out all the code that uses the document URI rather than the principal.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=369814#c38)• 17 years ago |
|  | |

Oh, hmm. "null principal" is kinda ambiguous... ;)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=369814#c39)• 17 years ago |
|  | |

Attached patch

[first stab](attachment.cgi?id=287901&action=diff) (obsolete)
— [Details](attachment.cgi?id=287901&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=287901)

This patch disallows javascript on docshells viewing documents loaded from JAR channels, unless the JAR file came from the local filesystem or was served with application/java-archive or application/x-jar.
[Attachment #287901](/attachment.cgi?id=287901&action=edit "first stab") -
Flags: review?(bzbarsky)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23564087_265995)• 17 years ago |

[Attachment #287901](/attachment.cgi?id=287901&action=edit "first stab") -
Flags: review?(dveditz)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=369814#c40)• 17 years ago |
|  | |

Comment on [attachment 287901](/attachment.cgi?id=287901 "first stab") [[details]](/attachment.cgi?id=287901&action=edit "first stab") [[diff]](/attachment.cgi?id=287901&action=diff "first stab") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=287901)
first stab
nsIAllowScriptsChannel only seems to be able to forbid scripts, right?
I think it's worth thinking about interface docs here (that is, describing which channels should implement this interface); that might lead to a better name for it too.
> if (mJarFile) {
>+ mAllowScripts = PR\_TRUE;
I see nothing preventing reuse of a jar: channel, in which case on the second time around it'll end up with mAllowScripts = true...
I suggest nulling out mJarFile (and resetting mAllowScripts?) up front in AsyncOpen and Open.
>+ if (channel) {
>+ nsCAutoString contentType;
>+ channel->GetContentType(contentType);
>+
>+ if (contentType == NS\_LITERAL\_CSTRING("application/java-archive") ||
>+ contentType == NS\_LITERAL\_CSTRING("application/x-jar")) {
>+ mAllowScripts = PR\_TRUE;
Ignoring for the moment that the check should just use EqualsLiteral(), this doesn't seem right. If the server is HTTP/0.9 (and hence doesn't send back a type), we'll guess a type ourselves. And then we can easily guess one of those types.
Same thing would happen for non-HTTP jar: URIs, though that wouldn't be as big a problem, because a non-HTTP URI would not be same-origin with an HTTP site...
What behavior do we actually want in those cases?

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=369814#c41)• 17 years ago |
|  | |

(In reply to [comment #40](/show_bug.cgi?id=369814#c40 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> Ignoring for the moment that the check should just use EqualsLiteral(), this
> doesn't seem right. If the server is HTTP/0.9 (and hence doesn't send back a
> type), we'll guess a type ourselves. And then we can easily guess one of those
> types.
We could strip LOAD\_CALL\_CONTENT\_SNIFFERS from the load flags for the inner
channel. We don't ever use the sniffed content type from the JAR channel.
We probably want to do that regardless of how we deal with non-http channels.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=369814#c42)• 17 years ago |
|  | |

> We could strip LOAD\_CALL\_CONTENT\_SNIFFERS
That wouldn't help, because HTTP \_always\_ provides a content type, event if it doesn't call content sniffers. Content sniffers can \_override\_ the server type, but if there is no server type we will always invoke the unknown decoder.
I agree that we should probably not call content sniffers on the underlying channel for jar:, though.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=369814#c43)• 17 years ago |
|  | |

Attached patch

[v2](attachment.cgi?id=288030&action=diff) (obsolete)
— [Details](attachment.cgi?id=288030&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288030)

\* I ended up just moving denyScripts into nsIJARChannel instead of its own interface.
\* Clear the LOAD\_CALL\_CONTENT\_SNIFFERS flag when fetching the JAR.
\* Use GetResponseHeader() on http channels.
\* Clear mJARFile/mDenyScripts in Open/AsyncOpen.
[Attachment #287901](/attachment.cgi?id=287901&action=edit "first stab") -
Attachment is obsolete: true
[Attachment #288030](/attachment.cgi?id=288030&action=edit "v2") -
Flags: review?(bzbarsky)
[Attachment #287901](/attachment.cgi?id=287901&action=edit "first stab") -
Flags: review?(dveditz)
[Attachment #287901](/attachment.cgi?id=287901&action=edit "first stab") -
Flags: review?(bzbarsky)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=369814#c44)• 17 years ago |
|  | |

(In reply to [comment #40](/show_bug.cgi?id=369814#c40 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> doesn't seem right. If the server is HTTP/0.9 (and hence doesn't send back a
> type), we'll guess a type ourselves. And then we can easily guess one of
> those types.
What do we use to guess, anything more than the extension? As a first pass I'd think that if a site allows a .jar extension we can guess it's intended to be active content (either an actual java-archive or a Mozilla thing).
We don't want to sniff the actual content looking for the PKZIP magic number, though. That would re-enable what we're trying to prevent.
> Same thing would happen for non-HTTP jar: URIs, though that wouldn't be as big
> a problem, because a non-HTTP URI would not be same-origin with an HTTP site...
As far as cookies are concerned they would be. Probably DOM storage as well (we treat them as super-cookies) and the password manager. But not truly same-origin for purposes of viewing frames and such.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=369814#c45)• 17 years ago |
|  | |

Didn't care for the name, but one advantage of a separate iface is that we could put it on other types of channels in the future that may have similar concerns. For example, would we want to block scripts on file: uris rather than attempt to limit the access of such scripts (be more like IE)?
I guess until we think of an actual case where we'd want this on another type of channel we can leave it on nsIJarChannel (which was my first thought anyway).

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=369814#c46)• 17 years ago |
|  | |

> What do we use to guess, anything more than the extension?
In general, the data and the extension. At the moment, I suspect it ends up being just the extension, except maybe for file:// URIs.
> We don't want to sniff the actual content looking for the PKZIP magic number,
Well, eventually we do... but I think at that point we probably want to detect the file as an application/zip file.
I'll try to review this tonight.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=369814#c47)• 17 years ago |
|  | |

Comment on [attachment 288030](/attachment.cgi?id=288030 "v2") [[details]](/attachment.cgi?id=288030&action=edit "v2") [[diff]](/attachment.cgi?id=288030&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288030)
v2
Why'd you switch from "allow" to "deny" scripts? Means you have to switch the sense of things when testing it, making the code more verbose.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=369814#c48)• 17 years ago |
|  | |

(In reply to [comment #47](/show_bug.cgi?id=369814#c47 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> (From update of [attachment 288030](/attachment.cgi?id=288030 "v2") [[details]](/attachment.cgi?id=288030&action=edit "v2") [[diff]](/attachment.cgi?id=288030&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288030))
> Why'd you switch from "allow" to "deny" scripts? Means you have to switch the
> sense of things when testing it, making the code more verbose.
Well as bz pointed out, this can't really Allow scripts when they wouldn't be allowed, only Deny them when they would otherwise be allowed. But I don't particularly mind either way..

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=369814#c49)• 17 years ago |
|  | |

Comment on [attachment 288030](/attachment.cgi?id=288030 "v2") [[details]](/attachment.cgi?id=288030&action=edit "v2") [[diff]](/attachment.cgi?id=288030&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288030)
v2
>+++ b/docshell/base/nsDocShell.cpp
>+ if (NS\_FAILED(jarChannel->GetDenyScripts(&deny)) || deny) {
>+ \*aAllowJavascript = PR\_FALSE;
>+ return NS\_OK;
>+ }
I'd replace that block with:
\*aAllowJavascript = NS\_SUCCEEDED(jarChannel->GetDenyScripts(&deny)) &&
!deny;
>+++ b/modules/libjar/nsJARChannel.cpp
>@@ -703,9 +722,27 @@ nsJARChannel::OnDownloadComplete(nsIDown
>+ if (httpChannel) {
>+ httpChannel->GetResponseHeader(NS\_LITERAL\_CSTRING("Content-Type"),
>+ contentType);
If we're getting the header, I have two questions:
1) Is it still OK to do a case-sensitive comparison?
2) Is it OK to ignore the fact that there might be params in the header?
>+ if (contentType.EqualsLiteral("application/java-archive") ||
>+ contentType.EqualsLiteral("application/x-jar")) {
>+ mDenyScripts = PR\_FALSE;
How about:
mDenyScripts = !contentType.EqualsLiteral(...) &&
!contentType.EqualsLiteral(...);
?
> PRBool mIsPending;
>+ PRBool mDenyScripts;
It's probably PRPackedBool time here, by the way.

|  | [Michal Zalewski](/user_profile?user_id=253619) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=369814#c50)• 17 years ago |
|  | |

Guys,
Please note that the vulnerability is more severe and more difficult to mitigate than initially indicated; it does not require the attacked site to host a malicious JAR file, as the security context is not properly updated on 302 redirects, as discovered here:
<http://blog.beford.org/?p=8>
...and as such, it affects a good part of web.
I can't help but notice that this is strangely reminiscent of my discovery of wyciwyg: redirect behavior that led to same-origin policy bypass and content spoofing (see [bug 387333](/show_bug.cgi?id=387333 "VERIFIED FIXED - [FIX]unauthorized access to wyciwyg:// documents possible")), and perhaps indicative of a need to audit and fix redirect handling once and for all protocols, to mitigate the impact of future flaws.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=369814#c51)• 17 years ago |
|  | |

> as the security context is not properly updated on 302 redirects
You mean if a site has an open redirector it has a problem? Of course such a site has problems in general...
In any case, we should certainly improve that on our end. I've filed [bug 403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects") on that.
> audit and fix redirect handling once and for all protocols
There are two aspects to redirect handling:
1) Is it OK to redirect?
2) What should happen when the redirect happens?
Your wyciwyg: was an instance of point 1. That's been fully fixed on trunk; any protocol can easily specify whether it's OK to redirect to it, and all the in-tree ones do.
Point 2 is somewhat more complicated, because it depends on what the caller is doing with the HTTP channel. It needs to be handled on a case-by-case basis.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23723437_1689)• 17 years ago |

Depends on: [jarxss2](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects")

|  | [Michal Zalewski](/user_profile?user_id=253619) |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=369814#c52)• 17 years ago |
|  | |

Boris,
Yes; open or partly open redirectors are common, and I would guess that most of the top 500 most popular sites on the Web have some. Far fewer sites allow arbitrary files to be uploaded with no filtering, so this probably means the bug should be considered a bit more significant, hence my note.
I also don't think there are any particular inherent security "problems in general" with redirectors - other than the human-assisted possibility of link-based phishing, of course - so I would not dismiss this as a site design error; 302 behavior on jar: handling could not be reasonably anticipated by any web developer as a legitimate caveat for URL redirection.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=369814#c53)• 17 years ago |
|  | |

> other than the human-assisted possibility of link-based phishing, of course
Yeah, that's the key problem. ;)

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=369814#c54)• 17 years ago |
|  | |

xss in a sandbox via mime overriding is possible this way:
<link rel='stylesheet' href='style.jpg'></link>
style.jpg:
p:before {content: url('javascript:throw this');}
another strangeness is:
<object type='text/html' data='html.jpg'></object>
html.jpg isn't parsed as html but
page info | media shows object of type 'text/html'

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=369814#c55)• 17 years ago |
|  | |

Attached patch

[v3](attachment.cgi?id=288233&action=diff) (obsolete)
— [Details](attachment.cgi?id=288233&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288233)

uses NS\_ParseContentType() on the raw header, fixed other nits.
[Attachment #288030](/attachment.cgi?id=288030&action=edit "v2") -
Attachment is obsolete: true
[Attachment #288233](/attachment.cgi?id=288233&action=edit "v3") -
Flags: review?(bzbarsky)
[Attachment #288030](/attachment.cgi?id=288030&action=edit "v2") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=369814#c56)• 17 years ago |
|  | |

Comment on [attachment 288233](/attachment.cgi?id=288233 "v3") [[details]](/attachment.cgi?id=288233&action=edit "v3") [[diff]](/attachment.cgi?id=288233&action=diff "v3") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288233)
v3
Looks great. Thanks for doing this!
[Attachment #288233](/attachment.cgi?id=288233&action=edit "v3") -
Flags: review?(bzbarsky) → review+

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=369814#c57)• 17 years ago |
|  | |

> mDenyScripts = !contentType.EqualsLiteral("application/java-archive") &&
!contentType.EqualsLiteral("application/x-jar");
not sure this is effective in all cases.
assuming html in jar with bad content type, does any of these work:
1.
<meta http-equiv="Refresh" content="0;URL=data:text/html;,<script>alert(4)</script>">
2.
<object data="data:text/html;,<script>alert('obj')</script>"></object>
<iframe src="data:text/html;,vv<script>alert('ifr')</script>"></iframe>
3.
<applet code="Clock1" archive="clock.jpg"></applet>
java is active content and probably the java way of |open browser
window| may work
as an additional test |data:text/html| may be replaced with
|javascript| and |<script>| removed

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23894207_265995)• 17 years ago |

[Attachment #288233](/attachment.cgi?id=288233&action=edit "v3") -
Flags: superreview?

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=369814#c58)• 17 years ago |
|  | |

Comment on [attachment 288233](/attachment.cgi?id=288233 "v3") [[details]](/attachment.cgi?id=288233&action=edit "v3") [[diff]](/attachment.cgi?id=288233&action=diff "v3") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288233)
v3
So actually this patch will break for jar:jar:[http://foo.com/bad.odf!/bad.jar!/test.html](http://foo.com/bad.odf%21/bad.jar%21/test.html) if there's a .jar->application/java-archive mapping in the mime database. I'll cook up a new patch...
[Attachment #288233](/attachment.cgi?id=288233&action=edit "v3") -
Attachment is obsolete: true
[Attachment #288233](/attachment.cgi?id=288233&action=edit "v3") -
Flags: superreview?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=369814#c59)• 17 years ago |
|  | |

Attached file
[testcase for comment 57](attachment.cgi?id=288383)
— [Details](attachment.cgi?id=288383&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23911651_1689)• 17 years ago |

[Attachment #288383](/attachment.cgi?id=288383&action=edit "testcase for comment 57") -
Attachment filename: bug369814c57.jar → bug369814c57.zip

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23911753_1689)• 17 years ago |

[Attachment #288383](/attachment.cgi?id=288383&action=edit "testcase for comment 57") -
Attachment filename: bug369814c57.zip → bug369814c57.jar
[Attachment #288383](/attachment.cgi?id=288383&action=edit "testcase for comment 57") -
Attachment mime type: application/octet-stream → application/zip

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=369814#c60)• 17 years ago |
|  | |

testcase for [comment 57](/show_bug.cgi?id=369814#c57 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") (1 & 2, not applets)
jar:<https://bugzilla.mozilla.org/attachment.cgi?id=288383!/bug369814c57.html>
The object and iframe issues are fine, the meta refresh can still run scripts. Dave is going to disable meta redirects on the jar docshell similarly to how he's blocking scripts.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=369814#c61)• 17 years ago |
|  | |

Hmm. It's odd that object/iframe don't run script. I would expect them to be able to...

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=369814#c62)• 17 years ago |
|  | |

nsScriptSecurityManager::CanExecuteScript() checks parent docshells, I imagine that's preventing it object/iframes from working.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=369814#c63)• 17 years ago |
|  | |

And we really ought to disable plugins on the docshell, too. Flash and Java can do raw sockets even if they can't get cookies from the page. I don't know what you could do that's bad, but better safe than sorry.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=369814#c64)• 17 years ago |
|  | |

Maybe we should just refuse to unpack the jar?
It's a nice feature to be able to glance at zipfile contents and all, but there's a lot to potentially get wrong here...

|  | [John O'Duinn [:joduinn] (please use "needinfo?" flag)](/user_profile?user_id=279345) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23919352_279345)• 17 years ago |

Blocks: [403552](/show_bug.cgi?id=403552 "RESOLVED FIXED - Version/config bumps for FF2.0.0.10 release")

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=369814#c65)• 17 years ago |
|  | |

Attached patch

[v4](attachment.cgi?id=288428&action=diff) (obsolete)
— [Details](attachment.cgi?id=288428&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288428)

New version:
\* Only trusts http and jar inner channels when checking remote loads, and propagates denyScripts from inner jar channels.
\* Disables javascript, plugins, and metaredirects if loaded from an unsafe content type type, but...
\* Disables loading entirely from unsafe content types by default (can be changed with a pref)
[Attachment #288428](/attachment.cgi?id=288428&action=edit "v4") -
Flags: superreview?(dveditz)
[Attachment #288428](/attachment.cgi?id=288428&action=edit "v4") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=369814#c66)• 17 years ago |
|  | |

Comment on [attachment 288428](/attachment.cgi?id=288428 "v4") [[details]](/attachment.cgi?id=288428&action=edit "v4") [[diff]](/attachment.cgi?id=288428&action=diff "v4") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288428)
v4
>+++ b/modules/libjar/nsIJARChannel.idl
>+ readonly attribute boolean denyScripts;
Could also call this isUnsafe, to mirror what docshell does with it (and update the comments, member/variable names in nsJARChannel, etc). Either way is fine by me, really.
>+++ b/modules/libpref/src/init/all.js
>+// If false, remove JAR files that are served with a content type other than
s/remove/remote/
With that nit, looks great. Thanks for doing this!
[Attachment #288428](/attachment.cgi?id=288428&action=edit "v4") -
Flags: review?(bzbarsky) → review+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=369814#c67)• 17 years ago |
|  | |

Comment on [attachment 288428](/attachment.cgi?id=288428 "v4") [[details]](/attachment.cgi?id=288428&action=edit "v4") [[diff]](/attachment.cgi?id=288428&action=diff "v4") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288428)
v4
Looks great, works great. Even with the pref on it now passes the redirect case.
>+pref("jar.open-bad-types", false);
My only nit was the pref name (as we talked about on IRC). rather than start a new top-level pref namespace please use either security. or network., and "unsafe" might be better than "bad".
[Attachment #288428](/attachment.cgi?id=288428&action=edit "v4") -
Flags: superreview?(dveditz) → superreview+

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=369814#c68)• 17 years ago |
|  | |

is v4 a trunk patch?
fails for me:
Hunk #8 FAILED at 750.
1 out of 9 hunks FAILED -- saving rejects to file
modules/libjar/nsJARChannel.cpp.rej

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=369814#c69)• 17 years ago |
|  | |

since can't apply the patch atm this may be worth testing:
<a href="<http://SARWAR/>" target="st">click 1st</a><br>
<a href="javascript:alert(document.body.innerHTML)" target="st">click 2nd</a><br>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a23983429_1689)• 17 years ago |

Whiteboard: [sg:high] XSS against sites that allow uploads of files such as images - looking for new networking owner → [sg:high] [need 1.8 patch] XSS against sites that allow uploads of files such as images - looking for new networking owner

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=369814#c70)• 17 years ago |
|  | |

Attached patch

[naming fixes](attachment.cgi?id=288536&action=diff) (obsolete)
— [Details](attachment.cgi?id=288536&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288536)

[Attachment #288428](/attachment.cgi?id=288428&action=edit "v4") -
Attachment is obsolete: true

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 71](/show_bug.cgi?id=369814#c71)• 17 years ago |
|  | |

Attached patch

[branch patch](attachment.cgi?id=288538&action=diff) (obsolete)
— [Details](attachment.cgi?id=288538&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288538)

[Attachment #288538](/attachment.cgi?id=288538&action=edit "branch patch") -
Flags: approval1.8.1.10?

|  | [İsmail Dönmez](/user_profile?user_id=222207) |  |
| --- | --- | --- |
| [Comment 72](/show_bug.cgi?id=369814#c72)• 17 years ago |
|  | |

(In reply to [comment #71](/show_bug.cgi?id=369814#c71 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> Created an attachment (id=288538) [details]
> branch patch
>
Doesn't apply to Firefox 2.0.0.9, got
Hunk #8 FAILED at 707.
1 out of 8 hunks FAILED -- saving rejects to file modules/libjar/nsJARChannel.cpp.rej

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 73](/show_bug.cgi?id=369814#c73)• 17 years ago |
|  | |

The trunk and branch patches both depend on the patches in 403331.

|  | [İsmail Dönmez](/user_profile?user_id=222207) |  |
| --- | --- | --- |
| [Comment 74](/show_bug.cgi?id=369814#c74)• 17 years ago |
|  | |

(In reply to [comment #73](/show_bug.cgi?id=369814#c73 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> The trunk and branch patches both depend on the patches in 403331.
Thanks, it applies fine now.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 75](/show_bug.cgi?id=369814#c75)• 17 years ago |
|  | |

(In reply to [comment #69](/show_bug.cgi?id=369814#c69 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> since can't apply the patch atm this may be worth testing:
> <a href="<http://SARWAR/>" target="st">click 1st</a><br>
> <a href="javascript:alert(document.body.innerHTML)" target="st">click
> 2nd</a><br>
This in fact isn't blocked as it should be (if you have the network.jar.open-unsafe-types pref set)
Maybe we should disallow retargeted loads from unsafe channels?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 76](/show_bug.cgi?id=369814#c76)• 17 years ago |
|  | |

I'm not quite sure what the problem [comment 69](/show_bug.cgi?id=369814#c69 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") brings up is. You click on the first link. You're no longer on the jar: page. Then what?

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 77](/show_bug.cgi?id=369814#c77)• 17 years ago |
|  | |

The first link opens a new window. The second link targets a javascript: load in the new window, inheriting the principal from the first window, but not its unsafe channel.
Disallowing retargeted loads isn't enough. <a href="data:text/html,<script>..."> will also inherit the security context but not the unsafe channel.
I'm working on a patch that blocks loads in a docshell viewing an unsafe channel that would inherit the security context from that unsafe channel. Does that make sense?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 78](/show_bug.cgi?id=369814#c78)• 17 years ago |
|  | |

Yeah, I guess. I really wish we could disable script/plugins/redirects on a per-nsIPrincipal basis or something.
Perhaps we should get a followup bug filed on having a way to do this? If we don't for 1.9, we definitely should for 2.0.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 79](/show_bug.cgi?id=369814#c79)• 17 years ago |
|  | |

Attached patch

[block inherited loads from unsafe docshells](attachment.cgi?id=288598&action=diff) (obsolete)
— [Details](attachment.cgi?id=288598&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288598)

[Attachment #288598](/attachment.cgi?id=288598&action=edit "block inherited loads from unsafe docshells") -
Flags: review?(bzbarsky)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 80](/show_bug.cgi?id=369814#c80)• 17 years ago |
|  | |

(In reply to [comment #79](/show_bug.cgi?id=369814#c79 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> Created an attachment (id=288598) [details]
> block inherited loads from unsafe docshells
>
Hrm, it might be nicer to inherit ChannelIsUnsafe like AllowJavascript etc. rather than walking the tree in InternalLoad.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 81](/show_bug.cgi?id=369814#c81)• 17 years ago |
|  | |

Comment on [attachment 288598](/attachment.cgi?id=288598 "block inherited loads from unsafe docshells") [[details]](/attachment.cgi?id=288598&action=edit "block inherited loads from unsafe docshells") [[diff]](/attachment.cgi?id=288598&action=diff "block inherited loads from unsafe docshells") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288598)
block inherited loads from unsafe docshells
More context would have been really nice when reviewing this, for what it's worth.
>+++ b/docshell/base/nsDocShell.cpp
>@@ -6585,6 +6584,25 @@ nsDocShell::InternalLoad(nsIURI \* aURI,
<sigh>. This bothers me, but I guess it's the best we can do... This really does depend on script being disabled, though, since there's no guarantee that |this| is where the load originated (e.g. in the cases when a principal was passed in).
>+ if (itemDocShell &&
>+ NS\_SUCCEEDED(itemDocShell->GetChannelIsUnsafe(&isUnsafe)) &&
>+ isUnsafe) {
if (itemDocShell &&
(NS\_FAILED(itemDocShell->GetChannelIsUnsafe(&isUnsafe) ||
isUnsafe)) {
>+ return NS\_ERROR\_FAILURE;
How about NS\_ERROR\_DOM\_SECURITY\_ERR or some such? For that matter, I forgot to mention that about the earlier patch; it had some NS\_ERROR\_FAILUREs where a better error code could be used.
>+++ b/docshell/base/nsIDocShell.idl
You need to change the IID here.
With those changes, r=bzbarsky
Please make sure to get regression tests for all the various aspects of this bug at least attached to the bug if not checked in with the patch, ok?
[Attachment #288598](/attachment.cgi?id=288598&action=edit "block inherited loads from unsafe docshells") -
Flags: review?(bzbarsky) → review+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 82](/show_bug.cgi?id=369814#c82)• 17 years ago |
|  | |

Attached patch

[inherited loads v2](attachment.cgi?id=288609&action=diff) (obsolete)
— [Details](attachment.cgi?id=288609&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288609)

bumps uuid and returns NS\_ERROR\_DOM\_SECURITY\_ERR.
[Attachment #288598](/attachment.cgi?id=288598&action=edit "block inherited loads from unsafe docshells") -
Attachment is obsolete: true
[Attachment #288609](/attachment.cgi?id=288609&action=edit "inherited loads v2") -
Flags: superreview?(dveditz)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 83](/show_bug.cgi?id=369814#c83)• 17 years ago |
|  | |

Attached file
[test cases](attachment.cgi?id=288615)
— [Details](attachment.cgi?id=288615&action=edit)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 84](/show_bug.cgi?id=369814#c84)• 17 years ago |
|  | |

jar:<https://bugzilla.mozilla.org/attachment.cgi?id=288615!/bug369814.html> includes various attempts to get around the unsafe jars

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 85](/show_bug.cgi?id=369814#c85)• 17 years ago |
|  | |

I was thinking something more like a mochitest diff that can be easily checked in the day this bug is opened up....

|  | [Reed Loden [:reed]](/user_profile?user_id=159758) |  |
| --- | --- | --- |
| [Comment 86](/show_bug.cgi?id=369814#c86)• 17 years ago |
|  | |

(In reply to [comment #85](/show_bug.cgi?id=369814#c85 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> I was thinking something more like a mochitest diff that can be easily checked
> in the day this bug is opened up....
Uh, you know this bug is public now, right?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 87](/show_bug.cgi?id=369814#c87)• 17 years ago |
|  | |

Ah, indeed. In which case, please land the tests with the patch!

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 88](/show_bug.cgi?id=369814#c88)• 17 years ago |
|  | |

Attached patch

[new branch patch](attachment.cgi?id=288623&action=diff)
— [Details](attachment.cgi?id=288623&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288623)

New branch patch incorporates both trunk patches from this bug, including nit fixes.
I'll get the mochitests written up tomorrow.
[Attachment #288538](/attachment.cgi?id=288538&action=edit "branch patch") -
Attachment is obsolete: true
[Attachment #288623](/attachment.cgi?id=288623&action=edit "new branch patch") -
Flags: approval1.8.1.10?
[Attachment #288538](/attachment.cgi?id=288538&action=edit "branch patch") -
Flags: approval1.8.1.10?

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 89](/show_bug.cgi?id=369814#c89)• 17 years ago |
|  | |

so this patch doesn't prevent against covert form in a jar posting using user's
cookie - in this case the referer will be correct (the buzz word is 'session
riding' or CSRF)?
btw, in the testcases one click probably may be saved via <frameset> and
<frame>.
will try to hit this more if i manage to apply the patch with the hidden
dependency.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 90](/show_bug.cgi?id=369814#c90)• 17 years ago |
|  | |

Comment on [attachment 288609](/attachment.cgi?id=288609 "inherited loads v2") [[details]](/attachment.cgi?id=288609&action=edit "inherited loads v2") [[diff]](/attachment.cgi?id=288609&action=diff "inherited loads v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288609)
inherited loads v2
sr=dveditz
[Attachment #288609](/attachment.cgi?id=288609&action=edit "inherited loads v2") -
Flags: superreview?(dveditz) → superreview+

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 91](/show_bug.cgi?id=369814#c91)• 17 years ago |
|  | |

Attached image
[this is jar file - add !/tar1.html to open](attachment.cgi?id=288634)
— [Details](attachment.cgi?id=288634&action=edit)

hm, after applying the patch, can't see any html inside jar with malformed content type.
is this on purpose?
attached is jar

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 92](/show_bug.cgi?id=369814#c92)• 17 years ago |
|  | |

link to tar1.jpg:
jar:<https://bugzilla.mozilla.org/attachment.cgi?id=288634!/tar1.html>
works before the patch, no html after the patch

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 93](/show_bug.cgi?id=369814#c93)• 17 years ago |
|  | |

(In reply to [comment #91](/show_bug.cgi?id=369814#c91 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> hm, after applying the patch, can't see any html inside jar with malformed
> content type. is this on purpose?
Yes, see [comment 64](/show_bug.cgi?id=369814#c64 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") and [comment 65](/show_bug.cgi?id=369814#c65 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"). Paranoia about how easily you found holes in the initial approach ([comment 57](/show_bug.cgi?id=369814#c57 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")) led to an outright ban. You can set a pref to enable sanitized content on archives with "unsafe" types.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 94](/show_bug.cgi?id=369814#c94)• 17 years ago |
|  | |

Comment on [attachment 288623](/attachment.cgi?id=288623 "new branch patch") [[details]](/attachment.cgi?id=288623&action=edit "new branch patch") [[diff]](/attachment.cgi?id=288623&action=diff "new branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288623)
new branch patch
approved for 1.8.1.10, a=dveditz
Applied and tested a bit, works great on all the existing testcases.
[Attachment #288623](/attachment.cgi?id=288623&action=edit "new branch patch") -
Flags: approval1.8.1.10? → approval1.8.1.10+

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 95](/show_bug.cgi?id=369814#c95)• 17 years ago |
|  | |

(In reply to [comment #93](/show_bug.cgi?id=369814#c93 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> (In reply to [comment #91](/show_bug.cgi?id=369814#c91 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> > hm, after applying the patch, can't see any html inside jar with malformed
> > content type. is this on purpose?
>
> Yes, see [comment 64](/show_bug.cgi?id=369814#c64 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") and [comment 65](/show_bug.cgi?id=369814#c65 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"). Paranoia about how easily you found holes
> in the initial approach ([comment 57](/show_bug.cgi?id=369814#c57 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")) led to an outright ban. You can set a pref
> to enable sanitized content on archives with "unsafe" types.
>
this seems nice. this particular case is very hard to secure correctly - it seems to need a lot of kludges, so better kill the functionality.

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 96](/show_bug.cgi?id=369814#c96)• 17 years ago |
|  | |

with
network.jar.open-unsafe-types = true
middle clicking on <a href="javascript:..."> executes js with null document.domain

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 97](/show_bug.cgi?id=369814#c97)• 17 years ago |
|  | |

Attached image
[this is jar file - add !/mid.html](attachment.cgi?id=288662)
— [Details](attachment.cgi?id=288662&action=edit)

testcase for middle click when ...unsafe = true

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 98](/show_bug.cgi?id=369814#c98)• 17 years ago |
|  | |

Attached file
[this is jar file - add !/flash3.swf](attachment.cgi?id=288666)
— [Details](attachment.cgi?id=288666&action=edit)

when ...unsafe=true at least the flash plugin works via:
jar:[http://SEVER/flash3.bin!/flash3.swf](http://SEVER/flash3.bin%21/flash3.swf)

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 99](/show_bug.cgi?id=369814#c99)• 17 years ago |
|  | |

shouldn't an error page be displayed for jar with bad content type?
typing jar:... into location bar leaves the old page but changes location.href

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 100](/show_bug.cgi?id=369814#c100)• 17 years ago |
|  | |

> shouldn't an error page be displayed for jar with bad content type?
Yes. We should use an error code docshell recognizes, or add one to docshell's list...

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 101](/show_bug.cgi?id=369814#c101)• 17 years ago |
|  | |

Attached patch

[newer branch patch](attachment.cgi?id=288695&action=diff)
— [Details](attachment.cgi?id=288695&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288695)

So I'm going to suggest we land something like this on the branch, disabling the feature on unsafe mime types without a pref. I don't think it's worth holding up that release to get everything right in case the pref is set.
On trunk it's probably worth putting something like this in sooner rather than later, and then opening a new bug to restore the pref (possibly dependent on the per-nsIPrincipal blocking bz mentioned in [comment 78](/show_bug.cgi?id=369814#c78 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site").)
From what I understand we can't add strings (and therefore useful error pages) on the branch, so I chose the malformedURI as the least bad option of the existing error pages. For a trunk patch I'll put together a new set of error page strings.
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: superreview?(dveditz)
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 102](/show_bug.cgi?id=369814#c102)• 17 years ago |
|  | |

Comment on [attachment 288695](/attachment.cgi?id=288695 "newer branch patch") [[details]](/attachment.cgi?id=288695&action=edit "newer branch patch") [[diff]](/attachment.cgi?id=288695&action=diff "newer branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288695)
newer branch patch
Looks reasonable
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: review?(bzbarsky) → review+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 103](/show_bug.cgi?id=369814#c103)• 17 years ago |
|  | |

Comment on [attachment 288623](/attachment.cgi?id=288623 "new branch patch") [[details]](/attachment.cgi?id=288623&action=edit "new branch patch") [[diff]](/attachment.cgi?id=288623&action=diff "new branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288623)
new branch patch
Checked the approved patch into the 1.8 branch

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 104](/show_bug.cgi?id=369814#c104)• 17 years ago |
|  | |

Attached patch

[use the malformedURI error page on the branch](attachment.cgi?id=288772&action=diff)
— [Details](attachment.cgi?id=288772&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288772)

The patch that was checked in didn't have the error page, here's a patch for that.
[Attachment #288772](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") -
Flags: approval1.8.1.10?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 105](/show_bug.cgi?id=369814#c105)• 17 years ago |
|  | |

Comment on [attachment 288772](/attachment.cgi?id=288772 "use the malformedURI error page on the branch") [[details]](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") [[diff]](/attachment.cgi?id=288772&action=diff "use the malformedURI error page on the branch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288772)
use the malformedURI error page on the branch
sr=dveditz
approved for 1.8.1.10, a=dveditz
[Attachment #288772](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") -
Flags: superreview+
[Attachment #288772](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") -
Flags: approval1.8.1.10?
[Attachment #288772](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") -
Flags: approval1.8.1.10+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 106](/show_bug.cgi?id=369814#c106)• 17 years ago |
|  | |

Comment on [attachment 288695](/attachment.cgi?id=288695 "newer branch patch") [[details]](/attachment.cgi?id=288695&action=edit "newer branch patch") [[diff]](/attachment.cgi?id=288695&action=diff "newer branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288695)
newer branch patch
We don't need to rip jar: support out totally for developers. We've done our best, but if there are remaining issues when a user flips an "unsafe" pref that's a relatively low concern.
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: superreview?(dveditz)
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: superreview-
[Attachment #288695](/attachment.cgi?id=288695&action=edit "newer branch patch") -
Flags: approval1.8.1.10-

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 107](/show_bug.cgi?id=369814#c107)• 17 years ago |
|  | |

Comment on [attachment 288772](/attachment.cgi?id=288772 "use the malformedURI error page on the branch") [[details]](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") [[diff]](/attachment.cgi?id=288772&action=diff "use the malformedURI error page on the branch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288772)
use the malformedURI error page on the branch
landed the error page patch on branch

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 108](/show_bug.cgi?id=369814#c108)• 17 years ago |
|  | |

jar:<https://bugzilla.mozilla.org/attachment.cgi?id=288662!/mid.html> is not an issue. Even in a regular HTML page if you middle-click on a javascript: link it's opened up in a new blank context and doesn't inherit the owner. (This in fact annoys tons of people as lots of sites use javascript: links for tracking and popup content, and middle-clicking just gets you a blank tab.)
jar:<https://bugzilla.mozilla.org/attachment.cgi?id=288666!/flash3.swf> runs the plugin content if you manually flip the pref to "unsafe", but a jar'd web page containing embed/object/applet tags does not run the plugin content.
That's safe enough for Firefox 2.0.0.10 since this pref is off. We also need to investigate what origin that content would have.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a24101593_1689)• 17 years ago |

Keywords: [fixed1.8.1.10](/buglist.cgi?keywords=fixed1.8.1.10&resolution=---)Whiteboard: [sg:high] [need 1.8 patch] XSS against sites that allow uploads of files such as images - looking for new networking owner → [sg:high] XSS against sites that allow uploads of files such as images - looking for new networking owner

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 109](/show_bug.cgi?id=369814#c109)• 17 years ago |
|  | |

Jesse or others with some expertise with this area, can you verify that this is fixed in the RC1 for Firefox 2.0.0.10 (<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2.0.0.10-candidates/rc1/>)?

|  | [Matej Spiller-Muys](/user_profile?user_id=124699) |  |
| --- | --- | --- |
| [Comment 110](/show_bug.cgi?id=369814#c110)• 17 years ago |
|  | |

2.0.0.10-rc1 broke our web application. We have an xpcom application and our web application is using it from the javascript. We are using a signed jar to get UniversalXPConnect privilege. And now we are getting Permission denied to get property Window.IsFrameLoaded. Even after enabling network.jar.open-unsafe-types it does not work (even though javascript error is gone).

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 111](/show_bug.cgi?id=369814#c111)• 17 years ago |
|  | |

Using network.jar.open-unsafe-types will open the jar:, but will not run any script in it. For a web application, you want to be sure you're sending the jar file with either the application/java-archive MIME type or the application/x-jar MIME type. Once you do that, things should work fine.
Daniel, we really need to advertise that in the run-up to 2.0.0.10. At the very least we should have a devmo article, and possibly some posts on the developer blog and to .announce?

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 112](/show_bug.cgi?id=369814#c112)• 17 years ago |
|  | |

Attached patch

[trunk patch with tests](attachment.cgi?id=289040&action=diff)
— [Details](attachment.cgi?id=289040&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040)

Here's a collected patch for the trunk, incorporating the two previous patches (the main one and the unsafe-loads patch), adding an error page, and adding a test case.
beltzner, can you check the strings in the error page?
[Attachment #288536](/attachment.cgi?id=288536&action=edit "naming fixes") -
Attachment is obsolete: true
[Attachment #288609](/attachment.cgi?id=288609&action=edit "inherited loads v2") -
Attachment is obsolete: true
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: ui-review?(beltzner)
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: superreview?(dveditz)
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: review?(bzbarsky)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 113](/show_bug.cgi?id=369814#c113)• 17 years ago |
|  | |

Attached file
[zipfile for mochitest](attachment.cgi?id=289041)
— [Details](attachment.cgi?id=289041&action=edit)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 114](/show_bug.cgi?id=369814#c114)• 17 years ago |
|  | |

Comment on [attachment 289040](/attachment.cgi?id=289040 "trunk patch with tests") [[details]](/attachment.cgi?id=289040&action=edit "trunk patch with tests") [[diff]](/attachment.cgi?id=289040&action=diff "trunk patch with tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040)
trunk patch with tests
Patch looks ok.
I have some issues with the test. Why use a timeout (fragile!) instead of observing events? It'll lead to bizarre orange if the test machine is under load. Also, might be good to use EventUtils.js instead of reimplementing click event stuff. And it'd be great if the test reset the pref to the value it had at test start when it finishes.
I haven't read the test in detail, and it mostly looks fine, but those three jumped out at me.
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: review?(bzbarsky) → review+

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 115](/show_bug.cgi?id=369814#c115)• 17 years ago |
|  | |

We still need someone to verify this in the 2.0.0.10 RC1.
This is not an area of expertise for me so I'm not much use here.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 116](/show_bug.cgi?id=369814#c116)• 17 years ago |
|  | |

All right. I ran the test cases in [comment 108](/show_bug.cgi?id=369814#c108 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") (after figuring out what it looked like in FF 2.0.0.9). Neither of these two work in 2.0.0.10. Both give an error page stating that the address isn't valid. Is any more verification necessary for this?
Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.10) Gecko/2007111504 Firefox/2.0.0.10

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 117](/show_bug.cgi?id=369814#c117)• 17 years ago |
|  | |

seems fixed according to my tests.
kinda strange sign is after a failed jar load, the dotted rotating circle in upper right corner keeps rotating

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 118](/show_bug.cgi?id=369814#c118)• 17 years ago |
|  | |

That shouldn't be happening! Is that on trunk or branch?

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 119](/show_bug.cgi?id=369814#c119)• 17 years ago |
|  | |

Attached file
[valid.jar](attachment.cgi?id=289242)
— [Details](attachment.cgi?id=289242&action=edit)

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 120](/show_bug.cgi?id=369814#c120)• 17 years ago |
|  | |

Attached file
[the circle may be rotating in the 3rd window](attachment.cgi?id=289243)
— [Details](attachment.cgi?id=289243&action=edit)

|  | [georgi - hopefully not receiving bugspam](/user_profile?user_id=23768) |  |
| --- | --- | --- |
| [Comment 121](/show_bug.cgi?id=369814#c121)• 17 years ago |
|  | |

(In reply to [comment #118](/show_bug.cgi?id=369814#c118 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> That shouldn't be happening! Is that on trunk or branch?
>
assuming you mean a rotating circle.
don't have trunk with the latest patch at the moment.
on latest linux branch the attachment:
<https://bugzilla.mozilla.org/attachment.cgi?id=289243>
gives a rotating circle after the 3rd click.
on macosx have mixed results - the circle in 2nd window is rotating, but restarting the fox may be needed.
may be a race unrelated to this bug.
initially found it from location bar.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 122](/show_bug.cgi?id=369814#c122)• 17 years ago |
|  | |

Yeah, I can reproduce that on branch... That seems wrong.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 123](/show_bug.cgi?id=369814#c123)• 17 years ago |
|  | |

(In reply to [comment #114](/show_bug.cgi?id=369814#c114 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> (From update of [attachment 289040](/attachment.cgi?id=289040 "trunk patch with tests") [[details]](/attachment.cgi?id=289040&action=edit "trunk patch with tests") [[diff]](/attachment.cgi?id=289040&action=diff "trunk patch with tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040))
> Patch looks ok.
>
> I have some issues with the test. Why use a timeout (fragile!) instead of
> observing events?
In some cases there aren't really any events to observe. Blocked refreshes and inherited-principal loads are just dropped without any events, and I don't get a load event for the error page.
In my local copy I've changed the simple case (the iframe load) to use load events, and waited for the load event before doing the timeout in some cases (to at least reduce the amount of work we're waiting for). I'd welcome suggestions for fixing the other ones.
> It'll lead to bizarre orange if the test machine is under
> load.
It won't lead to unexpected orange, but it can lead to greens where there shouldn't be. All these tests are of the form "wait for the child page to try to poke us, fail if it does so". If the timer hits early, we'll lose pokes. Which is arguably worse :/
>Also, might be good to use EventUtils.js instead of reimplementing click
> event stuff. And it'd be great if the test reset the pref to the value it had
> at test start when it finishes.
Fixed in my local copy.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 124](/show_bug.cgi?id=369814#c124)• 17 years ago |
|  | |

> Blocked refreshes and inherited-principal loads are just dropped without any
> events
That's true... OK.
> and I don't get a load event for the error page.
Hmm. That keeps coming up. We should be firing pageshow at least. Is there a bug on this?
If we can't eliminate all polling, then we can't eliminate all polling. Eliminating as much as we can is great; thank you for doing that!

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 125](/show_bug.cgi?id=369814#c125)• 17 years ago |
|  | |

(In reply to [comment #124](/show_bug.cgi?id=369814#c124 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> > and I don't get a load event for the error page.
>
> Hmm. That keeps coming up. We should be firing pageshow at least. Is there a
> bug on this?
I'm not getting a pageshow either.
[Bug 285055](/show_bug.cgi?id=285055 "NEW - consider loading error pages without LOAD_BACKGROUND") seems to cover this.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 126](/show_bug.cgi?id=369814#c126)• 17 years ago |
|  | |

Attached patch

[test updates](attachment.cgi?id=290297&action=diff)
— [Details](attachment.cgi?id=290297&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=290297)

this is just the test updates. I added an optional window argument to sendMouseEvent(), but I could add a sendMouseEventToWindow() instead if you'd like.
[Attachment #290297](/attachment.cgi?id=290297&action=edit "test updates") -
Flags: review?(bzbarsky)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a25125037_265995)• 17 years ago |

[Attachment #290297](/attachment.cgi?id=290297&action=edit "test updates") -
Attachment is patch: true
[Attachment #290297](/attachment.cgi?id=290297&action=edit "test updates") -
Attachment mime type: application/octet-stream → text/plain

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 127](/show_bug.cgi?id=369814#c127)• 17 years ago |
|  | |

> [Bug 285055](/show_bug.cgi?id=285055 "NEW - consider loading error pages without LOAD_BACKGROUND") seems to cover this.
I'm not sure it does. I thought we fired pageshow independently of the background/foreground business.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 128](/show_bug.cgi?id=369814#c128)• 17 years ago |
|  | |

Comment on [attachment 290297](/attachment.cgi?id=290297 "test updates") [[details]](/attachment.cgi?id=290297&action=edit "test updates") [[diff]](/attachment.cgi?id=290297&action=diff "test updates") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=290297)
test updates
Looks great
[Attachment #290297](/attachment.cgi?id=290297&action=edit "test updates") -
Flags: review?(bzbarsky) → review+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 129](/show_bug.cgi?id=369814#c129)• 17 years ago |
|  | |

Comment on [attachment 289040](/attachment.cgi?id=289040 "trunk patch with tests") [[details]](/attachment.cgi?id=289040&action=edit "trunk patch with tests") [[diff]](/attachment.cgi?id=289040&action=diff "trunk patch with tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040)
trunk patch with tests
>+unsafeContentType=The page you are trying to view cannot be shown because it is contained in an archive file that may not be safe to open. Please contact the website owners to inform them of this problem.
The message is much more specific than "unsafeContentType" might lead someone to believe. Either make the message more generic or the property more specific (unsafeJarContentType).
A generic message might be useful in the future so the next firedrill doesn't have to fall back on the malformed URI error :-)
"The page you are trying to view cannot be shown due to its Content-Type. Please contact the website owners to inform them of this problem." (btw don't leave two spaces after a period in web text.)
This is merely a suggestion, if you want to land as-is it's not that wrong.
sr=dveditz
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: superreview?(dveditz) → superreview+

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 130](/show_bug.cgi?id=369814#c130)• 17 years ago |
|  | |

Comment on [attachment 289040](/attachment.cgi?id=289040 "trunk patch with tests") [[details]](/attachment.cgi?id=289040&action=edit "trunk patch with tests") [[diff]](/attachment.cgi?id=289040&action=diff "trunk patch with tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=289040)
trunk patch with tests
>+unsafeContentType=The page you are trying to view cannot be shown because it is contained in an archive file that may not be safe to open. Please contact the website owners to inform them of this problem.
- as dveditz says, remove the double space
- s/archive file/file type/ to cover dveditz's other comment without getting into content-type terminology
> <!ENTITY contentEncodingError.longDesc "
>+<ul>
>+ <li>Please contact the website owners to inform them of this problem.</li>
>+</ul>
>+">
>+<!ENTITY unsafeContentType.title "Unsafe Content Type">
>+<!ENTITY unsafeContentType.longDesc "
> <ul>
> <li>Please contact the website owners to inform them of this problem.</li>
> </ul>
> ">
- s/Content/File/ in the unsafeContentType.title
with those comments, ui-r=beltzner
[Attachment #289040](/attachment.cgi?id=289040&action=edit "trunk patch with tests") -
Flags: ui-review?(beltzner) → ui-review+

|  | [Takeshi Nishimura](/user_profile?user_id=182696) |  |
| --- | --- | --- |
| [Comment 131](/show_bug.cgi?id=369814#c131)• 17 years ago |
|  | |

Please update your www.mozilla.org's MIME types.
Ex. <http://www.mozilla.org/projects/security/components/signed-script-demo.jar>
(filed in [Bug 358436](/show_bug.cgi?id=358436 "RESOLVED FIXED - signed script example doesn't work (must be loaded from https, but check that the location is http:)")).

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a25142681_265995)• 17 years ago |

Depends on: [405571](/show_bug.cgi?id=405571 "NEW - stuck throbber with blocked jar loads")

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 132](/show_bug.cgi?id=369814#c132)• 17 years ago |
|  | |

Filed [bug 405571](/show_bug.cgi?id=405571 "NEW - stuck throbber with blocked jar loads") about the stuck spinner.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 133](/show_bug.cgi?id=369814#c133)• 17 years ago |
|  | |

Checking in browser/locales/en-US/chrome/overrides/appstrings.properties;
/cvsroot/mozilla/browser/locales/en-US/chrome/overrides/appstrings.properties,v <-- appstrings.properties
new revision: 1.10; previous revision: 1.9
done
Checking in browser/locales/en-US/chrome/overrides/netError.dtd;
/cvsroot/mozilla/browser/locales/en-US/chrome/overrides/netError.dtd,v <-- netError.dtd
new revision: 1.14; previous revision: 1.13
done
Checking in docshell/base/Makefile.in;
/cvsroot/mozilla/docshell/base/Makefile.in,v <-- Makefile.in
new revision: 1.66; previous revision: 1.65
done
Checking in docshell/base/nsDocShell.cpp;
/cvsroot/mozilla/docshell/base/nsDocShell.cpp,v <-- nsDocShell.cpp
new revision: 1.871; previous revision: 1.870
done
Checking in docshell/base/nsIDocShell.idl;
/cvsroot/mozilla/docshell/base/nsIDocShell.idl,v <-- nsIDocShell.idl
new revision: 1.95; previous revision: 1.94
done
Checking in docshell/base/nsWebShell.cpp;
/cvsroot/mozilla/docshell/base/nsWebShell.cpp,v <-- nsWebShell.cpp
new revision: 1.698; previous revision: 1.697
done
Checking in docshell/resources/content/netError.xhtml;
/cvsroot/mozilla/docshell/resources/content/netError.xhtml,v <-- netError.xhtml
new revision: 1.26; previous revision: 1.25
done
Checking in docshell/test/Makefile.in;
/cvsroot/mozilla/docshell/test/Makefile.in,v <-- Makefile.in
new revision: 1.9; previous revision: 1.8
done
RCS file: /cvsroot/mozilla/docshell/test/[bug369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site").zip,v
done
Checking in docshell/test/[bug369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site").zip;
/cvsroot/mozilla/docshell/test/[bug369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site").zip,v <-- [bug369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site").zip
initial revision: 1.1
done
RCS file: /cvsroot/mozilla/docshell/test/test\_bug369814.html,v
done
Checking in docshell/test/test\_bug369814.html;
/cvsroot/mozilla/docshell/test/test\_bug369814.html,v <-- test\_bug369814.html
initial revision: 1.1
done
Checking in dom/locales/en-US/chrome/appstrings.properties;
/cvsroot/mozilla/dom/locales/en-US/chrome/appstrings.properties,v <-- appstrings.properties
new revision: 1.7; previous revision: 1.6
done
Checking in dom/locales/en-US/chrome/netError.dtd;
/cvsroot/mozilla/dom/locales/en-US/chrome/netError.dtd,v <-- netError.dtd
new revision: 1.14; previous revision: 1.13
done
Checking in modules/libjar/nsIJARChannel.idl;
/cvsroot/mozilla/modules/libjar/nsIJARChannel.idl,v <-- nsIJARChannel.idl
new revision: 1.8; previous revision: 1.7
done
Checking in modules/libjar/nsJARChannel.cpp;
/cvsroot/mozilla/modules/libjar/nsJARChannel.cpp,v <-- nsJARChannel.cpp
new revision: 1.127; previous revision: 1.126
done
Checking in modules/libjar/nsJARChannel.h;
/cvsroot/mozilla/modules/libjar/nsJARChannel.h,v <-- nsJARChannel.h
new revision: 1.47; previous revision: 1.46
done
Checking in modules/libpref/src/init/all.js;
/cvsroot/mozilla/modules/libpref/src/init/all.js,v <-- all.js
new revision: 3.706; previous revision: 3.705
done
Checking in netwerk/base/public/nsNetError.h;
/cvsroot/mozilla/netwerk/base/public/nsNetError.h,v <-- nsNetError.h
new revision: 1.12; previous revision: 1.11
done
Checking in testing/mochitest/tests/SimpleTest/EventUtils.js;
/cvsroot/mozilla/testing/mochitest/tests/SimpleTest/EventUtils.js,v <-- EventUtils.js
new revision: 1.5; previous revision: 1.4
done
Status: NEW → RESOLVEDClosed: 17 years agoResolution: --- → FIXED

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 134](/show_bug.cgi?id=369814#c134)• 17 years ago |
|  | |

Attached patch

[test fixes for bug 392567](attachment.cgi?id=290344&action=diff)
— [Details](attachment.cgi?id=290344&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=290344)

After this patch we no longer trust data: uris as inner jar channels (noted in [comment 65](/show_bug.cgi?id=369814#c65 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")), which broke the test case for 392567. I checked in this patch to fix the breakage (it breaks that data uri into a separate jar file to be loaded over http)

|  | [Chris Lawson (gone)](/user_profile?user_id=169237) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a25197898_169237)• 17 years ago |

Depends on: [405676](/show_bug.cgi?id=405676 "RESOLVED FIXED - error pages busted again (netError.dtd out-of-sync again)")

|  | [Smokey Ardisson (offline for a while; not following bugs - do not email)](/user_profile?user_id=155027) |  |
| --- | --- | --- |
| [Comment 135](/show_bug.cgi?id=369814#c135)• 17 years ago |
|  | |

Until someone figures out a way to ship a default branding package and an override system (see most of the discussion in [bug 302309](/show_bug.cgi?id=302309 "RESOLVED INCOMPLETE - Embedded applications still need their own branding for netError.xhtml")), any of these dtds that people want to use branding in are going to be forked across the tree.
When making these sorts of changes (adding/changing entities), it would be helpful if folks making the changes would check across the tree for other copies of the files and make the equivalent changes or cc someone from the other app(s)--you can cc me for Camino--since not having the changes will break functionality in those apps. Right now I believe Camino is the only app besides Firefox to have any forked dtd/properties files, but I've seen some discussion about SeaMonkey starting to do this as well.
I'm mentioning this here not to fault Dave, but simply because there are a good number of relevant people cc'd here and I want to raise awareness just a little bit (some developers are already making changes to all copies of the files across the tree, and that's great!).

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a25279355_103593)• 17 years ago |

Depends on: [405643](/show_bug.cgi?id=405643 "RESOLVED WONTFIX - can't add attachments with domino web access, \"Domino web access error\"")

|  | [Volkmar Kostka](/user_profile?user_id=215446) |  |
| --- | --- | --- |
| [Comment 136](/show_bug.cgi?id=369814#c136)• 17 years ago |
|  | |

I'm not sure if this is really related to this bug fix but if someone can take a look here:
<http://forums.mozillazine.org/viewtopic.php?t=607422>
It broke on .10 .
In short the OP loads a jar archive in an iframe and can not access it when using localhost as domain but can when using the real computer name.
If i understood it right the jar is still accessed through localhost so it seems to be on a different domain but it works.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 137](/show_bug.cgi?id=369814#c137)• 17 years ago |
|  | |

Not necessary for Thunderbird 1.5.0.x, possibly wanted for any vendor 1.8.0.x browser release but would have to be weighed against the various web sites this fix broke.Flags: blocking1.8.0.15?Flags: blocking1.8.0.14-Flags: blocking1.8.0.14+

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a26100017_20209)• 17 years ago |

Depends on: [407303](/show_bug.cgi?id=407303 "RESOLVED FIXED - Getting \"Unsafe File Type\" error when accessing a site that does not exist.")

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a32442811_32335)• 17 years ago |

Flags: blocking1.8.0.15? → blocking1.8.0.15+

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 138](/show_bug.cgi?id=369814#c138)• 17 years ago |
|  | |

Attached patch

[1.8.1\_combined (as reference)](attachment.cgi?id=306279&action=diff)
— [Details](attachment.cgi?id=306279&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=306279)

what went in: combined patch of [attachment 288623](/attachment.cgi?id=288623 "new branch patch") [[details]](/attachment.cgi?id=288623&action=edit "new branch patch") [[diff]](/attachment.cgi?id=288623&action=diff "new branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288623) and [attachment 288772](/attachment.cgi?id=288772 "use the malformedURI error page on the branch") [[details]](/attachment.cgi?id=288772&action=edit "use the malformedURI error page on the branch") [[diff]](/attachment.cgi?id=288772&action=diff "use the malformedURI error page on the branch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=288772)

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 139](/show_bug.cgi?id=369814#c139)• 17 years ago |
|  | |

Attached patch

[same for 1.8.0 patch](attachment.cgi?id=306280&action=diff)
— [Details](attachment.cgi?id=306280&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=306280)

caillon, please approve
[Attachment #306280](/attachment.cgi?id=306280&action=edit "same for 1.8.0 patch") -
Flags: approval1.8.0.15?

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a33215427_113760)• 17 years ago |

[Attachment #306279](/attachment.cgi?id=306279&action=edit "1.8.1_combined (as reference)") -
Attachment description: 1.8.1\_combined (for review) → 1.8.1\_combined (as reference)

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Comment 140](/show_bug.cgi?id=369814#c140)• 17 years ago |
|  | |

Comment on [attachment 306280](/attachment.cgi?id=306280 "same for 1.8.0 patch") [[details]](/attachment.cgi?id=306280&action=edit "same for 1.8.0 patch") [[diff]](/attachment.cgi?id=306280&action=diff "same for 1.8.0 patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=369814&attachment=306280)
same for 1.8.0 patch
a=caillon for 1.8.0.15
[Attachment #306280](/attachment.cgi?id=306280&action=edit "same for 1.8.0 patch") -
Flags: approval1.8.0.15? → approval1.8.0.15+

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Comment 141](/show_bug.cgi?id=369814#c141)• 17 years ago |
|  | |

patch committed to 1.8.0Keywords: [fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---)

|  | [Taka](/user_profile?user_id=223897) |  |
| --- | --- | --- |
| [Comment 142](/show_bug.cgi?id=369814#c142)• 17 years ago |
|  | |

There is a problem with the fix. It seems to have broken my application. See
<http://forums.mozillazine.org/viewtopic.php?f=25&t=717295>
It leaves me quite desperate, I reported the same issue with FF 2.0.0.10 (which was quickly followed up with 2.0.0.11 in which there were no problems) and with FF 3.0.
I got no useful responses (if any) so far.

|  | [Samuel Sidler (old account; do not CC)](/user_profile?user_id=190622) |  |
| --- | --- | --- |
| [Comment 143](/show_bug.cgi?id=369814#c143)• 17 years ago |
|  | |

(In reply to [comment #142](/show_bug.cgi?id=369814#c142 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"))
> There is a problem with the fix. It seems to have broken my application. See
> <http://forums.mozillazine.org/viewtopic.php?f=25&t=717295>
Please file a new bug for this. CC me.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 144](/show_bug.cgi?id=369814#c144)• 17 years ago |
|  | |

[Comment 142](/show_bug.cgi?id=369814#c142 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") is about [bug 434544](/show_bug.cgi?id=434544 "RESOLVED WONTFIX - Cross Scripting between signed and unsigned Web Pages broke") as far as I can tell, not about this bug.

|  | [Nickolay\_Ponomarev](/user_profile?user_id=126404) |  |
| --- | --- | --- |
| [Comment 145](/show_bug.cgi?id=369814#c145)• 16 years ago |
|  | |

The "Unsafe File Type" error message should be documented on developer.mozilla.org:
1) suggested way of fixing the site (using one of the "safe" content types)
2) ways for user to work around the problem (setting the pref)
Right now the first hit on google for the full message is a useless thread on mozillazine: <http://forums.mozillazine.org/viewtopic.php?f=38&t=744495>Keywords: [dev-doc-needed](/buglist.cgi?keywords=dev-doc-needed&resolution=---)

|  | [Serge Gautherie (:sgautherie)](/user_profile?user_id=49577) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=369814#a78424584_49577)• 15 years ago |

Depends on: [508369](/show_bug.cgi?id=508369 "RESOLVED FIXED - mochitest-plain: intermittent \"test_bug369814.html | iframes.html loaded from view-source jar type (or from non-jar type), pref disabled: should block a suspicious JAR load\"")

|  | [Eric Shepherd [:sheppy]](/user_profile?user_id=241123) |  |
| --- | --- | --- |
| [Comment 146](/show_bug.cgi?id=369814#c146)• 15 years ago |
|  | |

Is there anyone that understands this well that can write up a quick explanation of it?

|  | [Eric Shepherd [:sheppy]](/user_profile?user_id=241123) |  |
| --- | --- | --- |
| [Comment 147](/show_bug.cgi?id=369814#c147)• 15 years ago |
|  | |

Now documented; see:
<https://developer.mozilla.org/en/Security_and_the_jar_protocol>
<https://developer.mozilla.org/en/Security_in_Firefox_2#Security_improved_for_the_jar.3a_protocol>
Let me know (or go ahead and edit) if there are any issues with wording or accuracy. I did my best to interpret what Waldo told me in IRC today.Keywords: [dev-doc-needed](/buglist.cgi?keywords=dev-doc-needed&resolution=---) → [dev-doc-complete](/buglist.cgi?keywords=dev-doc-complete&resolution=---)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 148](/show_bug.cgi?id=369814#c148)• 14 years ago |
|  | |

> block inherited loads from unsafe docshells
For what it's worth, the patch did NOT block those. And the test was buggy, so did not catch that when running in the harness. It \_did\_ catch the problem when run standalone.... I'll fix this in [bug 508369](/show_bug.cgi?id=508369 "RESOLVED FIXED - mochitest-plain: intermittent \"test_bug369814.html | iframes.html loaded from view-source jar type (or from non-jar type), pref disabled: should block a suspicious JAR load\"").
You need to [log in](/show_bug.cgi?id=369814&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Dave Camp (:dcamp)](/user_profile?user_id=265995)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_ce530fbc_20250125_074157.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/403331)
* [XML](/show_bug.cgi?ctype=xml&id=403331)

Closed
[Bug 403331](/show_bug.cgi?id=403331)
(jarxss2)

Opened 17 years ago
Closed 17 years ago

# Sort out jar: behavior on HTTP redirects

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Sort out jar: behavior on HTTP redirects

## Categories

### (Core :: Networking: JAR, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20JAR#Networking%3A%20JAR)

Networking: JAR
▾

Core :: Networking: JAR
For bugs relating to the jar protocol handler, .jar file
handling, and .jar directory browsing.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20JAR&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20JAR&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20JAR)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

major

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: bzbarsky, Assigned: dcamp)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/086ecffaf8ddbcd18bcc73f6d9aea898?d=mm&size=40)  [dcamp](/user_profile?user_id=265995)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [bzbarsky](/user_profile?user_id=20209)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/608e04ebca94be52b05c003d51d43e07?d=mm&size=40)  [kershaw](/user_profile?user_id=505624)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

24 people

## References

### ( URL )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[405570](/show_bug.cgi?id=405570 "RESOLVED FIXED - replace redirects in test for bug 403331")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[jarxss](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"), [403552](/show_bug.cgi?id=403552 "RESOLVED FIXED - Version/config bumps for FF2.0.0.10 release")

Dependency [tree](/showdependencytree.cgi?id=403331&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=403331)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

jar:http://groups.google.com/searchhi...

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: fixed1.8.0.15, verified1.8.1.10, Whiteboard: [sg:high])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

jarxss2

[Keywords:](/describekeywords.cgi)

[fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---),
[verified1.8.1.10](/buglist.cgi?keywords=verified1.8.1.10&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:high]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [mtschrep](/user_profile?user_id=210162) | [blocking1.9](#a196183_210162 "17 years ago") | + |
| --- | --- | --- |
| [mtschrep](/user_profile?user_id=210162) | blocking1.9 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.8.1.10](#c1 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.8.1.10 | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.1.x](#c1 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.1.x | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.0.x](#c1 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.0.x | + |
| --- | --- | --- |
| [dcamp](/user_profile?user_id=265995) | [in-testsuite](#c35 "17 years ago") | + |
| --- | --- | --- |
| [dcamp](/user_profile?user_id=265995) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files, 6 obsolete files)

| [v1](/attachment.cgi?id=288232)  [17 years ago](#c3)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   2.56 KB, patch |  | [Details](/attachment.cgi?id=288232&action=edit) | [Diff](/attachment.cgi?id=288232&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288232) |
| --- | --- | --- |
| [v2](/attachment.cgi?id=288351)  [17 years ago](#c6)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   1.91 KB, patch | bzbarsky : [review-](#c10 "17 years ago")  dveditz : [superreview+](#c7 "17 years ago") | [Details](/attachment.cgi?id=288351&action=edit) | [Diff](/attachment.cgi?id=288351&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288351) |
| [now with cloneWithJarFile](/attachment.cgi?id=288396)  [17 years ago](#c11)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   3.80 KB, patch |  | [Details](/attachment.cgi?id=288396&action=edit) | [Diff](/attachment.cgi?id=288396&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288396) |
| [let's make that cloneWithJARFile](/attachment.cgi?id=288404)  [17 years ago](#c12)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   3.80 KB, patch |  | [Details](/attachment.cgi?id=288404&action=edit) | [Diff](/attachment.cgi?id=288404&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288404) |
| [right patch this time](/attachment.cgi?id=288405)  [17 years ago](#c13)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   3.80 KB, patch | bzbarsky : [review+](#c14 "17 years ago") | [Details](/attachment.cgi?id=288405&action=edit) | [Diff](/attachment.cgi?id=288405&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288405) |
| [clone the uri in cloneWithJARFile()](/attachment.cgi?id=288448)  [17 years ago](#c15)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   4.18 KB, patch | dveditz : [superreview+](#c16 "17 years ago") | [Details](/attachment.cgi?id=288448&action=edit) | [Diff](/attachment.cgi?id=288448&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288448) |
| [branch patch](/attachment.cgi?id=288472)  [17 years ago](#c17)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   7.44 KB, patch | dveditz : [approval1.8.1.10+](#c18 "17 years ago")  asac : [approval1.8.0.next+](#c0 "17 years ago") | [Details](/attachment.cgi?id=288472&action=edit) | [Diff](/attachment.cgi?id=288472&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288472) |
| [original testcase, with "safe" mime type](/attachment.cgi?id=288940)  [17 years ago](#c24)  [Daniel Veditz [:dveditz]](/user_profile?user_id=1689)   445 bytes, application/java-archive |  | [Details](/attachment.cgi?id=288940&action=edit) |
| [verification testcase (try again)](/attachment.cgi?id=288946)  [17 years ago](#c26)  [Daniel Veditz [:dveditz]](/user_profile?user_id=1689)   725 bytes, application/java-archive |  | [Details](/attachment.cgi?id=288946&action=edit) |
| [mochitest](/attachment.cgi?id=289416)  [17 years ago](#c30)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   6.21 KB, patch | Waldo : [review+](#c31 "17 years ago") | [Details](/attachment.cgi?id=289416&action=edit) | [Diff](/attachment.cgi?id=289416&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=289416) |
| [updated mochitests](/attachment.cgi?id=290325)  [17 years ago](#c32)  [Dave Camp (:dcamp)](/user_profile?user_id=265995)   5.98 KB, patch | bzbarsky : [review+](#c33 "17 years ago") | [Details](/attachment.cgi?id=290325&action=edit) | [Diff](/attachment.cgi?id=290325&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=290325) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=403331#c0)• 17 years ago |
|  | |

[Bug 369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") points out that jar: doesn't update its principal (or URI, for that matter) when an HTTP redirect happens. Arguably, it should.
The simplest thing to do here seems to be to replace the "jar file" URI with the post-load URI that the channel loading the jar file ends up with (using NS\_GetFinalChannelURI). Then everything else should Just Work, I think.
Does that make sense?Flags: blocking1.9?Flags: blocking1.8.1.10?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=403331#c1)• 17 years ago |
|  | |

Split off from [bug 369814 comment 50](/show_bug.cgi?id=369814#c50 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") and 51, issue originally posted at <http://blog.beford.org/?p=8> where the example jar:<http://groups.google.com/searchhistory/url?url=http://beford.org/stuff/htm.jar!/htm.htm> can read your Google contacts
This works on trunk and 1.8 branch.
This blocks [bug 369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site"). A solution that depends on MIME type to decide the site intended to host active content is completely defeated if a 3rd party attacker can supply the content and headers.Blocks: [jarxss](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site")URL: <http://blog.beford.org/?p=8>Flags: wanted1.8.1.x+Flags: wanted1.8.0.x+Flags: blocking1.8.1.10?Flags: blocking1.8.1.10+Whiteboard: [sg:high]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=403331#a2255_1689)• 17 years ago |

Alias: jarxss2

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=403331#c2)• 17 years ago |
|  | |

dcamp, do you want to give this a shot? Or should I do it?
We probably need to update our URI when the jar file finishes loading, make sure our originalURI is correct as needed, and set our LOAD\_REPLACE flag on the basis of the underlying channel.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=403331#c3)• 17 years ago |
|  | |

Attached patch

[v1](attachment.cgi?id=288232&action=diff) (obsolete)
— [Details](attachment.cgi?id=288232&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288232)

Assignee: nobody → dcampStatus: NEW → ASSIGNED
[Attachment #288232](/attachment.cgi?id=288232&action=edit "v1") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=403331#c4)• 17 years ago |
|  | |

Comment on [attachment 288232](/attachment.cgi?id=288232 "v1") [[details]](/attachment.cgi?id=288232&action=edit "v1") [[diff]](/attachment.cgi?id=288232&action=diff "v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288232)
v1
>+++ b/modules/libjar/nsIJARURI.idl
>+ attribute nsIURI JARFile;
This really bothers me. I don't think we want people doing that in general. Could we instead add a method here to "clone with new jar file" or something? Seems safer.
The rest looks great.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=403331#a138899_1689)• 17 years ago |

Summary: Sort our jar: behavior on HTTP redirects → Sort out jar: behavior on HTTP redirects

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=403331#c5)• 17 years ago |
|  | |

I'm with bz, better to create a new JARURI. and call SetOriginalURI() on the old one, don't hack out that part of the code.
You can get the Entry from the original URI, and then compose that together with the new base URI.
This is going to propagate up in a nested jar:, right?

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=403331#c6)• 17 years ago |
|  | |

Attached patch

[v2](attachment.cgi?id=288351&action=diff) (obsolete)
— [Details](attachment.cgi?id=288351&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288351)

This version composes a new URI from the new inner URI and the existing Entry.
[Attachment #288232](/attachment.cgi?id=288232&action=edit "v1") -
Attachment is obsolete: true
[Attachment #288351](/attachment.cgi?id=288351&action=edit "v2") -
Flags: superreview?(dveditz)
[Attachment #288351](/attachment.cgi?id=288351&action=edit "v2") -
Flags: review?(bzbarsky)
[Attachment #288232](/attachment.cgi?id=288232&action=edit "v1") -
Flags: review?(bzbarsky)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=403331#c7)• 17 years ago |
|  | |

Comment on [attachment 288351](/attachment.cgi?id=288351 "v2") [[details]](/attachment.cgi?id=288351&action=edit "v2") [[diff]](/attachment.cgi?id=288351&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288351)
v2
Works fine, but I'd rather see a single newSpec.Assign( ... + ...)
just to cut down on the number of string mallocs and copies.
sr=dveditz with that change
[Attachment #288351](/attachment.cgi?id=288351&action=edit "v2") -
Flags: superreview?(dveditz) → superreview+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=403331#c8)• 17 years ago |
|  | |

handy nested-jar test link
jar:jar:[http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm\_toolbar-2.0-fx.xpi!/chrome/qmtoolbar.jar!/content/qmtoolbar.js](http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm_toolbar-2.0-fx.xpi%21/chrome/qmtoolbar.jar%21/content/qmtoolbar.js)
same with a redirect:
jar:jar:<http://groups.google.com/searchhistory/url?url=http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm_toolbar-2.0-fx.xpi!/chrome/qmtoolbar.jar!/content/qmtoolbar.js>

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=403331#c9)• 17 years ago |
|  | |

Any reason not to make some of those testcases into mochitests and commit them when the patch goes in? I can't think of any.Flags: in-testsuite?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=403331#c10)• 17 years ago |
|  | |

Comment on [attachment 288351](/attachment.cgi?id=288351 "v2") [[details]](/attachment.cgi?id=288351&action=edit "v2") [[diff]](/attachment.cgi?id=288351&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288351)
v2
I really do think we should do what I suggested: have a method on nsIJARURI that creates a "clone with different jar file" thing. That way you don't end up serializing and reparsing nsIURI objects (which is what this patch ends up doing). That is, all the clone method would do is create an nsJARURI, set its mJARFile to the passed-in URI, set its mJAREntry to a clone of our mJAREntry, and return the whole thing as an nsIJARURI.
[Attachment #288351](/attachment.cgi?id=288351&action=edit "v2") -
Flags: review?(bzbarsky) → review-

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=403331#c11)• 17 years ago |
|  | |

Attached patch

[now with cloneWithJarFile](attachment.cgi?id=288396&action=diff) (obsolete)
— [Details](attachment.cgi?id=288396&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288396)

[Attachment #288351](/attachment.cgi?id=288351&action=edit "v2") -
Attachment is obsolete: true
[Attachment #288396](/attachment.cgi?id=288396&action=edit "now with cloneWithJarFile") -
Flags: review?(bzbarsky)

|  | [Mike Schroepfer](/user_profile?user_id=210162) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=403331#a196183_210162)• 17 years ago |

Flags: blocking1.9? → blocking1.9+Priority: -- → P1

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=403331#c12)• 17 years ago |
|  | |

Attached patch

[let's make that cloneWithJARFile](attachment.cgi?id=288404&action=diff) (obsolete)
— [Details](attachment.cgi?id=288404&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288404)

[Attachment #288396](/attachment.cgi?id=288396&action=edit "now with cloneWithJarFile") -
Attachment is obsolete: true
[Attachment #288404](/attachment.cgi?id=288404&action=edit "let's make that cloneWithJARFile") -
Flags: review?(bzbarsky)
[Attachment #288396](/attachment.cgi?id=288396&action=edit "now with cloneWithJarFile") -
Flags: review?(bzbarsky)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=403331#c13)• 17 years ago |
|  | |

Attached patch

[right patch this time](attachment.cgi?id=288405&action=diff) (obsolete)
— [Details](attachment.cgi?id=288405&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288405)

sorry to vomit all over everyone's bugmail
[Attachment #288404](/attachment.cgi?id=288404&action=edit "let's make that cloneWithJARFile") -
Attachment is obsolete: true
[Attachment #288405](/attachment.cgi?id=288405&action=edit "right patch this time") -
Flags: review?(bzbarsky)
[Attachment #288404](/attachment.cgi?id=288404&action=edit "let's make that cloneWithJARFile") -
Flags: review?(bzbarsky)

|  | [John O'Duinn [:joduinn] (please use "needinfo?" flag)](/user_profile?user_id=279345) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=403331#a197729_279345)• 17 years ago |

Blocks: [403552](/show_bug.cgi?id=403552 "RESOLVED FIXED - Version/config bumps for FF2.0.0.10 release")

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=403331#c14)• 17 years ago |
|  | |

Comment on [attachment 288405](/attachment.cgi?id=288405 "right patch this time") [[details]](/attachment.cgi?id=288405&action=edit "right patch this time") [[diff]](/attachment.cgi?id=288405&action=diff "right patch this time") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288405)
right patch this time
>+++ b/modules/libjar/nsJARChannel.cpp
>+ rv = channel->GetURI(getter\_AddRefs(innerURI));
I think you want to clone this and then NS\_TryToSetImmutable the clone, and use that immutable clone as the inner URI... Otherwise you'll pretty seriously regress performance on signed jar stuff (because every single security check will clone URIs).
>+++ b/modules/libjar/nsJARURI.cpp
>+nsJARURI::CloneWithJARFile(nsIURI \*jarFile, nsIJARURI \*\*result)
This should return error if (!jarFile).
With those two nits, this looks wonderful. r=bzbarsky
[Attachment #288405](/attachment.cgi?id=288405&action=edit "right patch this time") -
Flags: review?(bzbarsky) → review+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=403331#c15)• 17 years ago |
|  | |

Attached patch

[clone the uri in cloneWithJARFile()](attachment.cgi?id=288448&action=diff)
— [Details](attachment.cgi?id=288448&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288448)

[Attachment #288405](/attachment.cgi?id=288405&action=edit "right patch this time") -
Attachment is obsolete: true

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=403331#c16)• 17 years ago |
|  | |

Comment on [attachment 288448](/attachment.cgi?id=288448 "clone the uri in cloneWithJARFile()") [[details]](/attachment.cgi?id=288448&action=edit "clone the uri in cloneWithJARFile()") [[diff]](/attachment.cgi?id=288448&action=diff "clone the uri in cloneWithJARFile()") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288448)
clone the uri in cloneWithJARFile()
sr=dveditz
Will need a separate 1.8-branch version due to the interface change, unless you want to go with [attachment 288351](/attachment.cgi?id=288351 "v2") [[details]](/attachment.cgi?id=288351&action=edit "v2") [[diff]](/attachment.cgi?id=288351&action=diff "v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288351) for the 1.8 branch.
[Attachment #288448](/attachment.cgi?id=288448&action=edit "clone the uri in cloneWithJARFile()") -
Flags: superreview+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=403331#c17)• 17 years ago |
|  | |

Attached patch

[branch patch](attachment.cgi?id=288472&action=diff)
— [Details](attachment.cgi?id=288472&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288472)

[Attachment #288472](/attachment.cgi?id=288472&action=edit "branch patch") -
Flags: approval1.8.1.10?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=403331#c18)• 17 years ago |
|  | |

Comment on [attachment 288472](/attachment.cgi?id=288472 "branch patch") [[details]](/attachment.cgi?id=288472&action=edit "branch patch") [[diff]](/attachment.cgi?id=288472&action=diff "branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288472)
branch patch
approved for 1.8.1.10, a=dveditz for release-drivers
[Attachment #288472](/attachment.cgi?id=288472&action=edit "branch patch") -
Flags: approval1.8.1.10? → approval1.8.1.10+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=403331#c19)• 17 years ago |
|  | |

Checked in on the branch:
Checking in nsIJARURI.idl;
/cvsroot/mozilla/modules/libjar/nsIJARURI.idl,v <-- nsIJARURI.idl
new revision: 1.5.28.1; previous revision: 1.5
done
Checking in nsJARChannel.cpp;
/cvsroot/mozilla/modules/libjar/nsJARChannel.cpp,v <-- nsJARChannel.cpp
new revision: 1.116.2.2; previous revision: 1.116.2.1
done
Checking in nsJARURI.cpp;
/cvsroot/mozilla/modules/libjar/nsJARURI.cpp,v <-- nsJARURI.cpp
new revision: 1.51.12.1; previous revision: 1.51
done
Checking in nsJARURI.h;
/cvsroot/mozilla/modules/libjar/nsJARURI.h,v <-- nsJARURI.h
new revision: 1.18.12.1; previous revision: 1.18
done
Keywords: [fixed1.8.1.10](/buglist.cgi?keywords=fixed1.8.1.10&resolution=---)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=403331#c20)• 17 years ago |
|  | |

Boris, can you verify that this is fixed in the 2.0.0.10 RC1 (<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2.0.0.10-candidates/rc1/>) aka 1.8.1.10?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=403331#c21)• 17 years ago |
|  | |

I have no idea how to do that short of writing my own tests for it... I doubt I'll be able to do that soon enough to be useful.

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=403331#c22)• 17 years ago |
|  | |

Trying with 2.0.0.10-rc1:
jar:<http://groups.google.com/searchhistory/url?url=http://beford.org/stuff/htm.jar!/htm.htm>
properly updates the url to jar:[http://beford.org/stuff/htm.jar!/htm.htm](http://beford.org/stuff/htm.jar%21/htm.htm)
jar:jar:<http://groups.google.com/searchhistory/url?url=http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm_toolbar-2.0-fx.xpi!/chrome/qmtoolbar.jar!/content/qmtoolbar.js> properly updates the url to jar:jar:[http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm\_toolbar-2.0-fx.xpi!/chrome/qmtoolbar.jar!/content/qmtoolbar.js](http://releases.mozilla.org/pub/mozilla.org/addons/1000/qm_toolbar-2.0-fx.xpi%21/chrome/qmtoolbar.jar%21/content/qmtoolbar.js)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=403331#c23)• 17 years ago |
|  | |

Someone with a throw-away gmail account could add a contact or two and try the original PoC from [comment 1](/show_bug.cgi?id=403331#c1 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=403331#c24)• 17 years ago |
|  | |

Attached file
[original testcase, with "safe" mime type](attachment.cgi?id=288940) (obsolete)
— [Details](attachment.cgi?id=288940&action=edit)

Sorry, that's naive... the fix for [bug 369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") would stop the original PoC regardless of whether we fixed this one. Should work served here with the correct MIME-type to be served as a "we know this is active content" file.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=403331#c25)• 17 years ago |
|  | |

I'm trying to parse this last remark, Dan. Does this mean that the new attached test case should reproduce the bug here or not?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=403331#c26)• 17 years ago |
|  | |

Attached file
[verification testcase (try again)](attachment.cgi?id=288946)
— [Details](attachment.cgi?id=288946&action=edit)

[Attachment #288940](/attachment.cgi?id=288940&action=edit "original testcase, with \"safe\" mime type") -
Attachment is obsolete: true

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=403331#c27)• 17 years ago |
|  | |

Here's a locally-hosted testcase that can be used for verification. The MIME-type is set to one that the fix for [bug 369814](/show_bug.cgi?id=369814 "RESOLVED FIXED - jar: protocol is an XSS hazard due to ignoring mime type and being considered same-origin with hosting site") will allow to run scripts.
Steps to reproduce:
1. Sign in to GMail
1a. add contacts if you don't have any
2. load the link below:
jar:<http://groups.google.com/searchhistory/url?url=https://bugzilla.mozilla.org/attachment.cgi?id=288946!/jar.html>
Actual results in 1.8.1.9: Jar-Jar taunts you and lists your contacts
Expected results: blank page, security error in js console
(NB: if you get an error page something's wrong with the test)
URL: <http://blog.beford.org/?p=8> → jar:http://groups.google.com/searchhi...

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=403331#c28)• 17 years ago |
|  | |

You don't even need a GMail account or be signed in to test this: if you see Jar-Jar then you've seen the bug. Jar-Jar is drawn in the XMLdoc onload, and we won't even try to load that doc if we think we're somewhere other than Google. The PoC attack may not succeed unless you're logged on to GMail but the bug we're fixing is visible regardless.
In a fixed version you should get a blank page as mentioned in [comment 27](/show_bug.cgi?id=403331#c27 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects")
If at some point Google blocks this redirect it will break the testcase. Verify that the redirect still works (such as by demonstrating the bug in a vulnerable version for comparison purposes) before declaring a blank page as an indicator that the bug remains fixed.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=403331#c29)• 17 years ago |
|  | |

This is verified1.8.1.10. Running a 2.0.0.9 build with a gmail account that I made, I can see Jar Jar. If I run this in 2.0.0.10 RC1, I get a blank page.
Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.10) Gecko/2007111504 Firefox/2.0.0.10Keywords: [fixed1.8.1.10](/buglist.cgi?keywords=fixed1.8.1.10&resolution=---) → [verified1.8.1.10](/buglist.cgi?keywords=verified1.8.1.10&resolution=---)

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=403331#c30)• 17 years ago |
|  | |

Attached patch

[mochitest](attachment.cgi?id=289416&action=diff)
— [Details](attachment.cgi?id=289416&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=289416)

[Attachment #289416](/attachment.cgi?id=289416&action=edit "mochitest") -
Flags: review?(jwalden+bmo)

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=403331#c31)• 17 years ago |
|  | |

Comment on [attachment 289416](/attachment.cgi?id=289416 "mochitest") [[details]](/attachment.cgi?id=289416&action=edit "mochitest") [[diff]](/attachment.cgi?id=289416&action=diff "mochitest") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=289416)
mochitest
>diff -r b274e2ac8fcf modules/libjar/test/mochitest/test\_bug403331.html
>+ // We need network.jar.open-unsafe-types because the test server might not
>+ // serve jars with the right content type.
You should add a [bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip^headers^ file containing "Content-Type: application/x-jar" to force the desired type; see also:
<http://developer.mozilla.org/en/docs/Mochitest#How_do_I_change_the_HTTP_headers_or_status_sent_with_a_file_used_in_a_Mochitest.3F>
>diff -r b274e2ac8fcf testing/mochitest/server.js
>+ server.registerPathHandler("/redirect", redirect);
File a bug to remove these changes after [bug 401649](/show_bug.cgi?id=401649 "RESOLVED FIXED - JS CGI support in httpd.js") lands, please, and mark the dependency?
With those changes this looks fine.
[Attachment #289416](/attachment.cgi?id=289416&action=edit "mochitest") -
Flags: review?(jwalden+bmo) → review+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=403331#c32)• 17 years ago |
|  | |

Attached patch

[updated mochitests](attachment.cgi?id=290325&action=diff)
— [Details](attachment.cgi?id=290325&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=290325)

[Attachment #290325](/attachment.cgi?id=290325&action=edit "updated mochitests") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Reporter |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=403331#c33)• 17 years ago |
|  | |

Comment on [attachment 290325](/attachment.cgi?id=290325 "updated mochitests") [[details]](/attachment.cgi?id=290325&action=edit "updated mochitests") [[diff]](/attachment.cgi?id=290325&action=diff "updated mochitests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=290325)
updated mochitests
>+++ b/modules/libjar/test/mochitest
>+ testFrame.src = "jar:<http://example.org:80/redirect?http://localhost:8888/tests/modules/libjar/test/mochitest/bug403331.zip!/test.html>";
>+ testFrame.onload = function() {
I'd probably set onload before setting src myself.
>+ ok(item.textContent == "testcontents", "Should be able to access the child document");
And I'd use is() here, no ok().
>+ } catch (e) {
For what it's worth, an uncaught JS exception makes a mochitest fail anyway. If you want the more informative message here that's fine, but if you want to you could take the try/catch out altogether.
r=bzbarsky with the is() nit; either way on the other stuff.
[Attachment #290325](/attachment.cgi?id=290325&action=edit "updated mochitests") -
Flags: review?(bzbarsky) → review+

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=403331#c34)• 17 years ago |
|  | |

Checking in modules/libjar/nsIJARURI.idl;
/cvsroot/mozilla/modules/libjar/nsIJARURI.idl,v <-- nsIJARURI.idl
new revision: 1.8; previous revision: 1.7
done
Checking in modules/libjar/nsJARChannel.cpp;
/cvsroot/mozilla/modules/libjar/nsJARChannel.cpp,v <-- nsJARChannel.cpp
new revision: 1.126; previous revision: 1.125
done
Checking in modules/libjar/nsJARURI.cpp;
/cvsroot/mozilla/modules/libjar/nsJARURI.cpp,v <-- nsJARURI.cpp
new revision: 1.57; previous revision: 1.56
done
Checking in modules/libjar/test/Makefile.in;
/cvsroot/mozilla/modules/libjar/test/Makefile.in,v <-- Makefile.in
new revision: 1.3; previous revision: 1.2
done
RCS file: /cvsroot/mozilla/modules/libjar/test/mochitest/Makefile.in,v
done
Checking in modules/libjar/test/mochitest/Makefile.in;
/cvsroot/mozilla/modules/libjar/test/mochitest/Makefile.in,v <-- Makefile.in
initial revision: 1.1
done
RCS file: /cvsroot/mozilla/modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip,v
done
Checking in modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip;
/cvsroot/mozilla/modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip,v <-- [bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip
initial revision: 1.1
done
RCS file: /cvsroot/mozilla/modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip^headers^,v
done
Checking in modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip^headers^;
/cvsroot/mozilla/modules/libjar/test/mochitest/[bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip^headers^,v <-- [bug403331](/show_bug.cgi?id=403331 "RESOLVED FIXED - Sort out jar: behavior on HTTP redirects").zip^headers^
initial revision: 1.1
done
RCS file: /cvsroot/mozilla/modules/libjar/test/mochitest/test\_bug403331.html,v
done
Checking in modules/libjar/test/mochitest/test\_bug403331.html;
/cvsroot/mozilla/modules/libjar/test/mochitest/test\_bug403331.html,v <-- test\_bug403331.html
initial revision: 1.1
done
Checking in testing/mochitest/server.js;
/cvsroot/mozilla/testing/mochitest/server.js,v <-- server.js
new revision: 1.21; previous revision: 1.20
done
Status: ASSIGNED → RESOLVEDClosed: 17 years agoResolution: --- → FIXED

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=403331#a1420426_265995)• 17 years ago |

Depends on: [405570](/show_bug.cgi?id=405570 "RESOLVED FIXED - replace redirects in test for bug 403331")

|  | [Dave Camp (:dcamp)](/user_profile?user_id=265995)  Assignee |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=403331#c35)• 17 years ago |
|  | |

Filed [bug 405570](/show_bug.cgi?id=405570 "RESOLVED FIXED - replace redirects in test for bug 403331") about the upcoming testing changes.
I also bumped the uuid of nsIJARURI before committing.
Flags: in-testsuite? → in-testsuite+

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=403331#c36)• 17 years ago |
|  | |

Comment on [attachment 288472](/attachment.cgi?id=288472 "branch patch") [[details]](/attachment.cgi?id=288472&action=edit "branch patch") [[diff]](/attachment.cgi?id=288472&action=diff "branch patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=403331&attachment=288472)
branch patch
a=asac for 1.8.0.15
[Attachment #288472](/attachment.cgi?id=288472&action=edit "branch patch") -
Flags: approval1.8.0.15+

|  | [Christopher Aillon (sabbatical, not receiving bugmail)](/user_profile?user_id=32335) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=403331#c37)• 17 years ago |
|  | |

Fix committed to the 1.8.0 branchKeywords: [fixed1.8.0.15](/buglist.cgi?keywords=fixed1.8.0.15&resolution=---)
You need to [log in](/show_bug.cgi?id=403331&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Dave Camp (:dcamp)](/user_profile?user_id=265995)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


