=== Content from docs.microsoft.com_5076d28e_20250125_072552.html ===

[Skip to main content](#main)

This browser is no longer supported.

Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.

[Download Microsoft Edge](https://go.microsoft.com/fwlink/p/?LinkID=2092881 )
[More info about Internet Explorer and Microsoft Edge](https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge)

Table of contents

Exit focus mode

Read in English

Save

Table of contentsRead in English

Save

Add to plan
[Edit](https://github.com/MicrosoftDocs/security-updates/blob/live/security-updates/SecurityBulletins/2002/ms02-051.md "Edit This Document")

---

#### Share via

Facebook
x.com
LinkedIn
Email

---

Print

Table of contents

* Article
* 03/01/2023
* 6 contributors

Feedback

## In this article

Security Bulletin

# Microsoft Security Bulletin MS02-051 - Moderate

## Cryptographic Flaw in RDP Protocol can Lead to Information Disclosure (Q324380)

Published: September 18, 2002

**Version:** 1.0

**Originally posted:** September 18, 2002

#### Summary

**Who should read this bulletin:**
System administrators who operate terminal servers using MicrosoftÂ® WindowsÂ® 2000, or Windows XP users who have enabled Remote Desktop.

**Impact of vulnerability:**
Two vulnerabilities: information disclosure, denial of service.

**Maximum Severity Rating:**
Moderate.

**Recommendation:**
Administrators of Windows 2000 terminal servers and Windows XP users who have enabled Remote Desktop should apply the patch.

**Affected Software:**

* Microsoft Windows 2000
* Microsoft Windows XP

### General Information

## Technical details

**Technical description:**

The Remote Data Protocol (RDP) provides the means by which Windows systems can provide remote terminal sessions to clients. The protocol transmits information regarding a terminal sessions' keyboard, mouse and video to the remote client, and is used by Terminal Services in Windows NT 4.0 and Windows 2000, and by Remote Desktop in Windows XP. Two security vulnerabilities, both of which are eliminated by this patch, have been discovered in various RDP implementations.

The first involves how session encryption is implemented in certain versions of RDP. All RDP implementations allow the data in an RDP session to be encrypted. However, in the versions in Windows 2000 and Windows XP, the checksums of the plaintext session data are sent without being encrypted themselves. An attacker who was able to eavesdrop on and record an RDP session could conduct a straightforward cryptanalytic attack against the checksums and recover the session traffic.

The second involves how the RDP implementation in Windows XP handles data packets that are malformed in a particular way. Upon receiving such packets, the Remote Desktop service would fail, and with it would fail the operating system. It would not be necessary for an attacker to authenticate to an affected system in order to deliver packets of this type to an affected system.

**Mitigating factors:**

Cryptographic Flaw in RDP Protocol:

* An attacker would need the ability to capture an RDP session in order to exploit this vulnerability. In most cases, this would require that the attacker have physical access to the network media.
* Because encryption keys are negotiated on a per-session basis, a successful attack would allow an attacker to decrypt only a single session and not multiple sessions. Thus, the attacker would need to conduct a separate cryptanalytic attack against each session he or she wished to compromise.

Denial of Service in Remote Desktop:

* Remote Desktop service in Windows XP is not enabled by default.
* Even if Remote Desktop service were enabled, a successful attack would require that the attacker be able to deliver packets to the Remote Desktop port on an affected system. Customers who block port 3389 at the firewall would be protected against attempts to exploit this vulnerability. (By default Internet Connection Firewall does block port 3389).

**Severity Rating:**

|  | Internet Servers | Intranet Servers | Client Systems |
| --- | --- | --- | --- |
| **Cryptographic Flaw in RDP Protocol** | Moderate | Moderate | Moderate |
| **Denial of Service in Remote Desktop** | None | None | Moderate |

The above [assessment](https://technet.microsoft.com/security/bulletin/rating) is based on the types of systems affected by the vulnerability, their typical deployment patterns, and the effect that exploiting the vulnerability would have on them. Successfully exploiting the encryption vulnerability requires the attacker to have access to the network media; the denial of service vulnerability only affects Windows XP systems, and only if Remote Desktop Sharing has been enabled.

**Vulnerability identifier:**

* Weak Encryption in RDP Protocol:[CVE-CAN-2002-0863](https://cve.mitre.org/cgi-bin/cvename.cgi?name=can-2002-0863)
* Denial of Service in Remote Desktop:[CVE-CAN-2002-0864](https://cve.mitre.org/cgi-bin/cvename.cgi?name=can-2002-0864)

**Tested Versions:**

Microsoft tested Windows NT 4.0 Terminal Services Edition, Windows 2000 and Windows XP to assess whether they are affected by these vulnerabilities. Previous versions are no longer [supported](https://support.microsoft.com/directory/discontinue.asp), and may or may not be affected by these vulnerabilities.

## Frequently asked questions

**What vulnerabilities are eliminated by this patch?**

This patch eliminates two vulnerabilities affecting the implementation of the RDP protocol:

* The first involves a cryptographic flaw affecting the Windows 2000 and Windows XP implementations.
* The second involves denial of service vulnerability affecting the Windows XP implementation only.

**What is the RDP protocol?**

[Remote Desktop Protocol](https://www.microsoft.com/windowsxp/using/networking/security/winfirewall.mspx) is a networking protocol that supports remote Windows terminal sessions between a client and a server. It transmit all of the information usually associated with a local console session - keystrokes, video and mouse data, and so forth - across a network, allowing users to have full, interactive logon sessions with remote systems. Microsoft Knowledge Base article [Q186607](https://support.microsoft.com/default.aspx?scid=kb;en-us;q186607) provides detailed technical information about the protocol.

**In which Microsoft products is RDP implemented?**

In general, RDP is the underlying protocol for Windows features that allow remote desktop sessions. For instance:

* Windows NT 4.0, Terminal Server Edition implements RDP 4.0.
* Terminal Services in Windows 2000 implements RDP 5.0
* [Remote Desktop Sharing](https://www.microsoft.com/windowsxp/using/mobility/getstarted/remoteintro.mspx) in Windows XP implements RDP 5.1

**Are RDP sessions enabled by default in Windows?**

RDP sessions are enabled by default in Windows NT 4.0, Terminal Server Edition, but not in any other version of Windows. (Please note, however, that neither of these vulnerabilities occur in Windows NT 4.0 Terminal Server Edition).

**Cryptographic Flaw in RDP Protocol (CAN-2002-0863):**

**What's the scope of first vulnerability?**

This vulnerability could enable an attacker to read the contents of an encrypted RDP session, thereby compromising any data within it. This could include information such as usernames and passwords, as well as any data the user entered into an application or which an application displayed for the user.
To exploit the vulnerability, the attacker would need the ability to eavesdrop on and record an RDP session. In most cases, this would require the attacker to have physical access to the network media itself. It would also require the attacker to have the technical ability to mount a cryptanalytic attack on the recorded data (the attack is, however, straightforward). Only the RDP implementations in Windows 2000 and Windows XP are affected.

**What causes the vulnerability?**

The vulnerability results because, although session data is encrypted in RDP 5.0 (the version that ships with Windows 2000) and RDP 5.1 (the version that ships with Windows XP), the checksums of the session data are not.

**What is RDP Encryption?**

Because RDP packets can sometimes be sent across uncontrolled or untrusted networks like the Internet or an extranet, [RDP](https://msdn2.microsoft.com/library/aa383015) encrypts the data in a remote session using the RC4 cryptoalgorithm. In versions prior to Windows XP, the server administrator could select the key size to use; in Windows XP, all sessions are protected using 128-bit key.
The vulnerability, however, has nothing to do with the cryptoalgorithm used by RDP, nor with the key size. Instead, it results because of an implementation error involving the handling of checksum data.

**What is checksum data?**

Checksums are frequently used in networking applications as a way of detecting and correcting errors that occur during transmission. Before one computer sends a data packet, it performs a mathematical operation on the data, and sends the result of the operation along with the data itself. Upon receiving the data and checksum, the other computer performs the same mathematical operation on the data it received, and confirms that the result matches what it received. If they match, it's a good indicator that the data wasn't corrupted in transit.

**What's wrong with the way checksums are handled in encrypted RDP sessions?**

The checksums, like the session data itself, should be encrypted. However, in the Windows 2000 and Windows XP implementations of RDP, they aren't. The session data is encrypted, but before it's encrypted a checksum is calculated - and that checksum is sent in plaintext.

**Why does this constitute a security vulnerability? After all, the checksums aren't the same as the session data, they're just information about the session data.**
True, but there are straightforward cryptanalytic techniques that would enable an attacker to recover the session data from the checksums. Having broken the encryption, the attacker would be able to see the user's entire RDP session. Any information - from the information the user entered at the keyboard, to the movements of his or her mouse, to the information displayed on the screen - could be read.

**How could an attacker exploit this vulnerability?**

To exploit this vulnerability, an attacker would first have to have the means to capture a user's encrypted network traffic, most likely through the use of a network packet tracer. This is an important point, because in most cases it would require the attacker to have physical access to the network cabling that carries the session data.
Having captured the data, the attacker would need to subject it to a cryptanalytic attack in order to "crack" the encryption on the session data. This would require some technical knowledge about the RDP data format and cryptanalytic techniques, but these are not insurmountable hurdles.

**If an attacker managed to decrypt one session, would that make it easier to decrypt future ones?**

No. Unique session keys are negotiated at the start of every RDP session, so each attempt to compromise a session would need to start from scratch.

**Does the vulnerability affect Windows NT 4.0?**

No. Only the RDP implementations in Windows 2000 and Windows XP are affected.

**What does the patch do?**

The patch eliminates the vulnerability by encrypting the checksums as well as the session data.

**Denial of Service in Remote Desktop (CAN-2002-0864):**

**What's the scope of the second vulnerability?**

This is a [denial of service](https://technet.microsoft.com/security/bulletin/glossary) vulnerability. An attacker who successfully exploited this vulnerability could cause a system hosting remote sessions to fail, with the loss of any unsaved data.
This vulnerability only affects Windows XP, but even then, the affected feature is not enabled by default. Even if it were enabled, an attacker would need the ability to deliver data to an affected system in order to exploit the vulnerability, so users who have observed normal firewalling precautions would not at risk from Internet-based attacks.

**What causes the vulnerability?**

The vulnerability results because of a flaw in the way RDP 5.1 (the version implemented in Windows XP) handles certain types of invalid data packets. Instead of handling them gracefully, RDP - and with the operating system itself - would fail upon processing them.

**What's wrong with the way the RDP implementation in Windows XP handles the invalid data involved in the vulnerability?**

By design, RDP should always check the validity of all incoming data packets before trying to act upon them. However, the RDP implementation in Windows XP doesn't check for one particular type of flaw in the incoming packets. Because of this, it would be possible to create a packet that, when processed, would create a series of failures that would culminate in the failure of the operating system itself.

**What could an attacker do via this vulnerability?**

An attacker could cause a Windows XP system to fail, if it's been configured to allow Remote Desktop sessions. The operator would need to reboot the machine in order to restore normal service.

**Who could exploit the vulnerability?**

Any user who could deliver the specific type of packets involved in this vulnerability to an affected Windows XP system could exploit it.

**Are default installations of Windows XP affected by the vulnerability?**

No. Remote Desktop Service does not run by default.

**I don't know if I've enabled Remote Desktop. How can I tell?**

Select Start, then Control Panel, then System. In the System Properties dialog, select the Remote tab, and inspect the checkbox in the Remote Desktop section. If it's selected, Remote Desktop is enabled; if it's not, Remote Desktop is disabled.

**Would the attacker need to be able to establish a Remote Desktop session in order to exploit this vulnerability?**

No. The attacker would only need to send the correct set of packets to the correct port.

**Could the vulnerability be exploited from the Internet?**

It depends on whether the attacker were able to deliver packets to the port on which RDP operates, port 3389. If standard best practices have been followed, this port will be blocked at the firewall. (For instance, this port is blocked by default by [Internet Connection Firewall](https://www.microsoft.com/windowsxp/using/networking/security/winfirewall.mspx)).

**Could a user inadvertently exploit this vulnerability?**

No. The specific series of packets needed to cause the server to fail cannot be generated as part of a normal Remote Desktop session.

**What does the patch do?**

The patch addresses the vulnerability by ensuring that the Remote Desktop service handles malformed packets gracefully.

## Patch availability

**Download locations for this patch**

* Windows 2000:

  [https://www.microsoft.com/download/details.aspx?FamilyId=C9A38D45-5145-4844-B62E-C69D32AC929B&displaylang;=en](https://www.microsoft.com/download/details.aspx?familyid=c9a38d45-5145-4844-b62e-c69d32ac929b&displaylang;=en)
* Windows XP:

  [https://www.microsoft.com/download/details.aspx?FamilyId=84FC577D-F2D5-47B8-AB98-77BA7501B00B&displaylang;=en](https://www.microsoft.com/download/details.aspx?familyid=84fc577d-f2d5-47b8-ab98-77ba7501b00b&displaylang;=en)
* Windows XP 64 bit Edition:

  [https://www.microsoft.com/download/details.aspx?FamilyId=97945A5D-DB0B-40F8-9A2E-DE93CBB5CB3A&displaylang;=en](https://www.microsoft.com/download/details.aspx?familyid=97945a5d-db0b-40f8-9a2e-de93cbb5cb3a&displaylang;=en)

#### Additional information about this patch

**Installation platforms:**

* The patch for Windows 2000 can be installed on systems running Windows 2000 [Service Pack 2](https://www.microsoft.com/windows2000/downloads/servicepacks/sp2/default.mspx) or Windows 2000 [Service Pack 3](https://www.microsoft.com/windows2000/downloads/servicepacks/sp3/default.mspx).
* The patch for Windows XP can be installed on systems running Windows XP Gold.

**Inclusion in future service packs:**

* The fix for this issue will be included in Windows 2000 Service Pack 4.
* The fix for this issue is included in Windows XP Service Pack 1.

**Reboot needed:** Yes

**Patch can be uninstalled:** Yes

**Superseded patches:** None.

**Verifying patch installation:** Windows 2000:

* To verify that the patch has been installed on the machine, confirm that the following registry key has been created on the machine:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows 2000\SP4\Q324380.
* To verify the individual files, use the date/time and version information provided in the following registry key:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows 2000\SP4\Q324380\Filelist

Windows XP:

* To verify that the patch has been installed on the machine, confirm that the following registry key has been created on the machine:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows XP\SP1\Q324380.
* To verify the individual files, use the date/time and version information provided in the following registry key:

  HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Updates\Windows XP\SP1\Q324380\Filelist.

**Caveats:**

None

**Localization:**

Localized versions of this patch are available at the locations discussed in "Patch Availability".

**Obtaining other security patches:**

Patches for other security issues are available from the following locations:

* Security patches are available from the [Microsoft Download Center](https://go.microsoft.com/fwlink/?linkid=21129), and can be most easily found by doing a keyword search for "security\_patch".
* Patches for consumer platforms are available from the [WindowsUpdate](https://windowsupdate.microsoft.com/) web site

#### Other information:

**Support:**

* Microsoft Knowledge Base article Q324380 discusses this issue and will be available approximately 24 hours after the release of this bulletin. Knowledge Base articles can be found on the [Microsoft Online Support](https://support.microsoft.com/?scid=fh;en-us;kbhowto) web site.
* Technical support is available from [Microsoft Product Support Services](https://support.microsoft.com/directory/question.asp?sd=gn&fr;=0). There is no charge for support calls associated with security patches.

**Security Resources:** The [Microsoft TechNet Security](https://www.microsoft.com/technet/security/default.mspx) Web Site provides additional information about security in Microsoft products.

**Disclaimer:**

The information provided in the Microsoft Knowledge Base is provided "as is" without warranty of any kind. Microsoft disclaims all warranties, either express or implied, including the warranties of merchantability and fitness for a particular purpose. In no event shall Microsoft Corporation or its suppliers be liable for any damages whatsoever including direct, indirect, incidental, consequential, loss of business profits or special damages, even if Microsoft Corporation or its suppliers have been advised of the possibility of such damages. Some states do not allow the exclusion or limitation of liability for consequential or incidental damages so the foregoing limitation may not apply.

**Revisions:**

* V1.0 (September 18, 2002): Bulletin Created.

*Built at 2014-04-18T13:49:36Z-07:00*

---

## Additional resources

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025
## Additional resources

### In this article

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025



=== Content from www.kb.cert.org_dd362a20_20250125_072551.html ===


search

menu

icon-carat-right

cmu-wordmark

* ×
* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

[[Carnegie Mellon University](https://www.cmu.edu)](https://www.cmu.edu/)

# [Software Engineering Institute](https://www.sei.cmu.edu/)

## CERT Coordination Center

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* Current:  VU#865833

## Microsoft Windows Remote Desktop Protocol (RDP) uses weak algorithm for encrypting packets

#### Vulnerability Note VU#865833

Original Release Date: 2002-12-06 | Last Revised: 2002-12-06

---

### Overview

[Microsoft Windows Remote Desktop Protocol (RDP)](http://www.microsoft.com/windows2000/techinfo/howitworks/terminal/rdpfandp.asp) uses a weak algorithm for encrypting packets.

### Description

| Microsoft [describes](http://www.microsoft.com/windows2000/docs/rdpfandp.doc) RDP as follows.  RDP is based on, and is an extension of, the T.120 protocol family standards. It is a multichannel-capable protocol that allows for separate virtual channels for carrying device communication and presentation data from the server, as well as encrypted client mouse and keyboard data.Microsoft's implementation of RDP does not encrypt the checksums of the session data. Therefore, a determined attacker could apply cryptanalytic techniques to recover encrypted session traffic. Note that Microsoft has [listed](http://www.microsoft.com/technet/treeview/default.asp?url=/technet/security/bulletin/MS02-051.asp) the following mitigating factors:An attacker would need the ability to capture an RDP session in order to exploit this vulnerability. In most cases, this would require that the attacker have physical access to the network media.Because encryption keys are negotiated on a per-session basis, a successful attack would allow an attacker to decrypt only a single session and not multiple sessions. Thus, the attacker would need to conduct a separate cryptanalytic attack against each session he or she wished to compromise. |
| --- |

### Impact

| A remote attacker could apply cryptanalytic techniques to recover encrypted session traffic. |
| --- |

### Solution

| Apply a patch. |
| --- |

### Vendor Information

865833
Filter by status:
All
Affected
Not Affected
Unknown

Filter by content:
 Additional information available

 Sort by:
Status
Alphabetical

Expand all

**Javascript is disabled. Click [here](/vuls/vendor/VU%23865833/) to view vendors.**
### [Microsoft Corporation](#IAFY-5GKM7G) Affected

Updated:  December 06, 2002

### Status

Affected

### Vendor Statement

See <http://www.microsoft.com/technet/treeview/default.asp?url=/technet/security/bulletin/MS02-051.asp>

### Vendor Information

The vendor has not provided us with any further information regarding this vulnerability.

### Addendum

The CERT/CC has no additional comments at this time.

If you have feedback, comments, or additional information about this vulnerability, please send us email.

### CVSS Metrics

| Group | Score | Vector |
| --- | --- | --- |
| Base |  |  |
| Temporal |  |  |
| Environmental |  |  |

### References

* <http://www.microsoft.com/technet/treeview/default.asp?url=/technet/security/bulletin/MS02-051.asp>
* <http://msdn.microsoft.com/library/en-us/termserv/termserv/using_terminal_services_virtual_channels.asp>
* <http://www.microsoft.com/windows2000/techinfo/howitworks/terminal/rdpfandp.asp>
* <http://link.springer.de/link/service/series/0558/bibs/2139/21390310.htm>
* <http://www.ietf.org/rfc/rfc2104.txt>
### Acknowledgements

Ben Cohen & Pete Chown of Skygate Technology Ltd. discovered this vulnerability.

This document was written by Ian A Finlay.

### Other Information

| **CVE IDs:** | [CVE-2002-0863](http://web.nvd.nist.gov/vuln/detail/CVE-2002-0863) |
| --- | --- |
| **Severity Metric:** | 6.30 |
| **Date Public:** | 2002-09-18 |
| **Date First Published:** | 2002-12-06 |
| **Date Last Updated:** | 2002-12-06 18:57 UTC |
| **Document Revision:** | 16 |

* [About vulnerability notes](https://vuls.cert.org/confluence/display/VIN/Vulnerability%2BNote%2BHelp)
* Contact us about this vulnerability
* [Provide a vendor statement](https://vuls.cert.org/confluence/display/VIN/Case%2BHandling#CaseHandling-Givingavendorstatusandstatement)

Sponsored by [CISA.](https://www.cisa.gov/cybersecurity)

 [Download PGP Key](https://vuls.cert.org/confluence/pages/viewpage.action?pageId=25985026)

[Read CERT/CC Blog](https://insights.sei.cmu.edu/cert/)

[Learn about Vulnerability Analysis](https://www.sei.cmu.edu/research-capabilities/all-work/display.cfm?customel_datapageid_4050=21304)

Carnegie Mellon University

Software Engineering Institute

4500 Fifth Avenue

Pittsburgh, PA 15213-2612

412-268-5800

[Office Locations](http://www.sei.cmu.edu/locations/index.cfm) | [Additional Sites Directory](http://www.sei.cmu.edu/additional-sites-directory/index.cfm) | [Legal](https://vuls.cert.org/confluence/display/VIN/VINCE%2BCode%2Bof%2BConduct#VINCECodeofConduct-TermsofUse) | [Privacy Notice](https://www.sei.cmu.edu/legal/privacy-notice/index.cfm) | [CMU Ethics Hotline](https://www.cmu.edu/hr/ethics-hotline/) | [www.sei.cmu.edu](http://www.sei.cmu.edu)

Â©2022 Carnegie Mellon University

[Contact SEI](https://www.sei.cmu.edu/contact-us/)
#### Contact CERT/CC

 412-268-5800



=== Content from marc.info_700e4072_20250125_072450.html ===

```
[[prev in list](?l=bugtraq&m=103237101602429&w=2)] [[next in list](?l=bugtraq&m=103236103021270&w=2)] [prev in thread] [[next in thread](?l=bugtraq&m=103254242103763&w=2)]
List:       [bugtraq](?l=bugtraq&r=1&w=2)
Subject:    [Microsoft Windows Terminal Services vulnerabilities](?t=103236186000006&r=1&w=2)
From:       [Ben Cohen <bc () skygate ! co ! uk>](?a=103235768700003&r=1&w=2)
Date:       [2002-09-18 11:39:03](?l=bugtraq&r=1&w=2&b=200209)
[Download RAW [message](?l=bugtraq&m=103236181522253&q=mbox) or [body](?l=bugtraq&m=103236181522253&q=raw)]

I have just installed Windows XP Pro SP1 and found that the two
vulnerabilities announced earlier in the week have been addressed.

"Microsoft Windows XP Remote Desktop denial of service" is fixed.

"Microsoft Windows Remote Desktop Protocol checksum and keystroke" is
partially fixed:  Microsoft have altered the protocol to revert to the RDP
4.0 style input packet.  This is a hack rather than a good solution
because it doesn't fix the checksum leakage problem, and it increases
bandwidth again.  Unfortunately, the proper solution would require the
encryption layer of the protocol to be redesigned.

Ben Cohen
Software Developer
Skygate Technology Ltd.

[[prev in list](?l=bugtraq&m=103237101602429&w=2)] [[next in list](?l=bugtraq&m=103236103021270&w=2)] [prev in thread] [[next in thread](?l=bugtraq&m=103254242103763&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from marc.info_dcb23bf0_20250125_072450.html ===

```
[[prev in list](?l=bugtraq&m=103235745116592&w=2)] [[next in list](?l=bugtraq&m=103234265701977&w=2)] [prev in thread] [next in thread]
List:       [bugtraq](?l=bugtraq&r=1&w=2)
Subject:    Microsoft Windows Remote Desktop Protocol checksum and keystroke
From:       [Ben Cohen <bc () skygate ! co ! uk>](?a=103235768700003&r=1&w=2)
Date:       [2002-09-16 8:52:00](?l=bugtraq&r=1&w=2&b=200209)
[Download RAW [message](?l=bugtraq&m=103235960119404&q=mbox) or [body](?l=bugtraq&m=103235960119404&q=raw)]

Vulnerable

All versions of Microsoft Windows using encrypted RDP are vulnerable to
the checksum vulnerability.  The following versions are also vulnerable to
the keystroke vulnerability:

Microsoft Windows XP Professional
Microsoft Windows 2000 Server
Microsoft Windows 2000 Advanced Server
Microsoft Windows .NET Standard Server Beta 3

Background

A design mistake in Microsoft's Remote Desktop Protocol (RDP) leaks
information about the contents of encrypted packets through their
checksums, since packets with the same plaintext have matching checksums.

A form of input packet used in version 5.0 of the protocol allows an
attacker to watch the network traffic from an encrypted session and work
out what keystrokes a user makes.  Further, it is then possible for the
attacker to manipulate subsequent keystrokes sent across the network.

Checksum vulnerability

When RDP has encryption enabled, packets are first encrypted using RC4,
then an 8 byte HMAC checksum of the plaintext is prepended to the
cyphertext.  The encryption key for RC4 is refreshed every 4096 packets,
but the HMAC key is apparently not changed during the session.  Note that
the checksum relies only on the packet length, the packet contents and the
HMAC key; if a packet with identical contents is sent twice, the two
checksums will be the same, potentially leaking information if the same
packet is sent repeatedly.  This is known as encrypt-then-authenticate,
and it is clearly a general design flaw in RDP.  (This problem is further
discussed in Hugo Krawczyk's paper.)

This leakage can be observed in the RDP 5.0 style of input packets (which
leads to the keystroke vulnerability below).  Other examples include the
same rendering operation being sent multiple times, for example to make a
cursor flash; and Terminal Services Client's device redirection, such as
identical data repeatedly transmitted from the serial port.  Plugins using
Microsoft's Terminal Services Virtual Channels are also vulnerable.

Keystroke vulnerability

In RDP 4.0, input events are sent with a unique timestamp as specified in
the T.128 standard; this packet is then framed using lower level protocols
T.125 and T.123 and transmitted using TCP.  (T.125 is used by Microsoft's
RDP Virtual Channel API to multiplex other data such as audio and printing
across the same connection.)  With this many protocol layers, a single key
press requires a packet 56 bytes long to be transmitted over TCP, which is
inefficient.

In RDP 5.0 Microsoft added an abbreviated way to specify common commands
including input events.  These packets start 0x84 (and other values)
rather than 0x03 which is used to start T.123.  Encryption is done in the
same way, but only the key code and key event type (press, repeat or
release) is sent -- there is no timestamp -- so the packets are now only
12 bytes long.

Therefore the checksum is the same for each key event type for the same
key.  This only fails when the client concatenates input events into a
single packet but this is uncommon.  This reasoning does not apply to RDP
4.0 input packets because a timestamp is sent so the packet contents and
therefore the checksum will change.

Here is an example taken from a real session:

Client to server:
84   0c   c5 db ec cd 6c 7e 31 6c   47 a2

Client to server:
84   0c   ef 6a bb 01 21 b0 c3 c6   f6 e5

...

Client to server:
84   0c   c5 db ec cd 6c 7e 31 6c   c1 0a

Client to server:
84   0c   ef 6a bb 01 21 b0 c3 c6   fe bd

...

Client to server:
84   0c   c5 db ec cd 6c 7e 31 6c   8e 41

Client to server:
84   0c   ef 6a bb 01 21 b0 c3 c6   22 f8

The first byte (0x84) shows that these are RDP 5.0 style packets, not
T.123. The second shows the length (i.e., the packets are 0x0c bytes
long).  The next 8 bytes are the HMAC checksum, and the last two are the
encrypted packet contents for the input event.

Since the two pairs of checksums match, the same thing was being sent in
each case.  Indeed, the same key had been pressed several times, although
it isn't possible to tell which key it was from the data given above.
Given a larger dump of session data it would be possible to make a good
guess for which key each checksum corresponds to by looking at the
frequencies and ordering of the different checksums; this is simply a
mono-alphabetic substitution cipher on the scan code plus key event type.
This knowledge could then be used to work out what the user types, and the
attacker might then be able to capture the user's passwords.

(Data from packets which do not start "84 0c" are a different type or
length so can be ignored.  Apparently the only packets of that length sent
by the client are key events.)

Pete Chown pointed out that this is also subject to a substitution attack
since the attacker now knows enough to be able to change a key input event
to another one.  Suppose the user presses "A" and the attacker wants a "B"
key press to be sent instead.  The attacker knows that the checksum and
the plaintext for each of these two events.  Since the cypher is RC4 and
the plaintext for the events are the same, the desired cyphertext is
obtained from XORing the "A" press plaintext and then XORing the "B" press
plaintext.  So the substitution is made simply by swapping the "A" press
checksum with the "B" press checksum, and replacing the cyphertext.

Workaround

Use the Microsoft Terminal Services Client version 4.0, rather than later
versions of Terminal Services Client or the Advanced Terminal Services
Client.  This only cures the keystroke vulnerability and does not address
the problem for multiple packets with the same contents.

References

The Order of Encryption and Authentication for Protecting Communications
(or: How Secure is SSL?), Hugo Krawczyk,
<http://link.springer.de/link/service/series/0558/bibs/2139/21390310.htm>

Section 8.18 from T.128 Multipoint application sharing, Series T:
Terminals for telematic services, ITU-T.

T.125 Multipoint communication service protocol specification, Series T:
Terminals for telematic services, ITU-T.

T.123 Network-specific data protocol stacks for multimedia conferencing,
Series T: Terminals for telematic services, ITU-T (also RFCs 905 and 1006)

Using Terminal Services Virtual Channels, MSDN Platform SDK: Terminal
Services,
<http://msdn.microsoft.com/library/en-us/termserv/termserv/>
                         using_terminal_services_virtual_channels.asp

HMAC: Keyed-Hashing for Message Authentication, RFC 2104,
<http://www.ietf.org/rfc/rfc2104.txt>

Microsoft was notified on 16 April 2002.

Credits

Ben Cohen
Software Developer
ben.cohen@skygate.co.uk

Pete Chown
Chief Security Consultant
pete.chown@skygate.co.uk

Skygate Technology Ltd.
<http://www.skygate.co.uk/>
+44 (0)20 8542 7856

[[prev in list](?l=bugtraq&m=103235745116592&w=2)] [[next in list](?l=bugtraq&m=103234265701977&w=2)] [prev in thread] [next in thread]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)


