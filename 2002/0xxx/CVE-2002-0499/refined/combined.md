=== Content from www.cs.helsinki.fi_d390b11a_20250124_170742.html ===

# [PATCH] d\_path() truncation

**Jirka Kosina** (*jikos@jikos.cz*)

*Mon, 1 Apr 2002 04:49:10 +0200 (CEST)*

* **Messages sorted by:** [[ date ]](date.html#54)[[ thread ]](index.html#54)[[ subject ]](subject.html#54)[[ author ]](author.html#54)
  * **Next message:** [Andrea Arcangeli: "Re: -aa VM splitup"](0055.html)* **Previous message:** [Andrew Morton: "Re: -aa VM splitup"](0053.html)

---

Hi,

As I've noticed, there isn't fixed the d\_path() long name truncation

vulnerability

(<http://cert.uni-stuttgart.de/archive/bugtraq/2002/03/msg00384.html>) in

2.4.x up to 2.4.19-pre5 (correct me if I'm wrong).

IMHO this trivial patch fixes it (patch against 2.4.18, no idea about

2.2.x kernels, should be similar?) - instead of truncating the path with

no error, caller gets ENAMETOOLONG.

I'm sorry if I've missed something.

Kind regards,

Jirka Kosina.

--- linux/fs/dcache.c.orig Mon Feb 25 20:38:08 2002

+++ linux/fs/dcache.c Mon Apr 1 04:16:45 2002

@@ -977,14 +977,17 @@

parent = dentry->d\_parent;

namelen = dentry->d\_name.len;

buflen -= namelen + 1;

- if (buflen < 0)

- break;

+ if (buflen < 0){

+ retval = ERR\_PTR(-ENAMETOOLONG);

+ goto out;

+ }

end -= namelen;

memcpy(end, dentry->d\_name.name, namelen);

\*--end = '/';

retval = end;

dentry = parent;

}

+out:

return retval;

global\_root:

namelen = dentry->d\_name.len;

@@ -993,6 +996,8 @@

retval -= namelen-1; /\* hit the slash \*/

memcpy(retval, dentry->d\_name.name, namelen);

}

+ else

+ retval = ERR\_PTR(-ENAMETOOLONG);

return retval;

}

@@ -1042,8 +1047,11 @@

spin\_unlock(&dcache\_lock);

error = -ERANGE;

+

+ if (cwd == ERR\_PTR(-ENAMETOOLONG)) error = -ENAMETOOLONG;

+

len = PAGE\_SIZE + page - cwd;

- if (len <= size) {

+ if (len <= size && error != -ENAMETOOLONG) {

error = len;

if (copy\_to\_user(buf, cwd, len))

error = -EFAULT;

-

To unsubscribe from this list: send the line "unsubscribe linux-kernel" in

the body of a message to majordomo@vger.kernel.org

More majordomo info at <http://vger.kernel.org/majordomo-info.html>

Please read the FAQ at <http://www.tux.org/lkml/>

---

* **Next message:** [Andrea Arcangeli: "Re: -aa VM splitup"](0055.html)* **Previous message:** [Andrew Morton: "Re: -aa VM splitup"](0053.html)


