=== Content from github.com_851249c7_20250126_120354.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Commit

[Permalink](/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid overflowing allocation size in CallMalloc()

[Browse files](/ned14/nedmalloc/tree/1a759756639ab7543b650a10c2d77a0ffc7a2000)
Browse the repository at this point in the history

```
The wraparound could happen if USE_MAGIC_HEADERS is enabled.
```

* Loading branch information

[![@xiw](https://avatars.githubusercontent.com/u/801567?s=40&v=4)](/xiw)

[xiw](/ned14/nedmalloc/commits?author=xiw "View all commits by xiw")
committed
Apr 14, 2012

1 parent
[2965eca](/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1)

commit 1a75975

Showing
**1 changed file**
with
**5 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[nedmalloc.c](#diff-01b9066e81cc5b2441bd11ec6e2ddbbeb5d7b6bec1c38883124d62587e3dd759 "nedmalloc.c")

Show comments

[View file](/ned14/nedmalloc/blob/1a759756639ab7543b650a10c2d77a0ffc7a2000/nedmalloc.c)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -328,7 +328,11 @@ static FORCEINLINE NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*CallMalloc(void \* |
|  |  | #if USE\_MAGIC\_HEADERS |
|  |  | size\_t \_alignment=alignment; |
|  |  | size\_t \*\_ret=0; |
|  |  | size+=alignment+3\*sizeof(size\_t); |
|  |  | size\_t bytes=size+alignment+3\*sizeof(size\_t); |
|  |  | /\* Avoid addition overflow. \*/ |
|  |  | if(bytes<size) |
|  |  | return 0; |
|  |  | size=bytes; |
|  |  | \_alignment=0; |
|  |  | #endif |
|  |  | #if USE\_ALLOCATOR==0 |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1a75975`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d1e10c8b_20250125_212450.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faosp-mirror%2Fplatform_bionic%2Fcommit%2F7f5aa4f35e23fd37425b3a5041737cdf58f87385)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faosp-mirror%2Fplatform_bionic%2Fcommit%2F7f5aa4f35e23fd37425b3a5041737cdf58f87385)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=aosp-mirror%2Fplatform_bionic)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Nov 8, 2023. It is now read-only.

[aosp-mirror](/aosp-mirror)
/
**[platform\_bionic](/aosp-mirror/platform_bionic)**
Public mirror

mirrored from <https://android.googlesource.com/platform/bionic.git>

* [Notifications](/login?return_to=%2Faosp-mirror%2Fplatform_bionic) You must be signed in to change notification settings
* [Fork
  372](/login?return_to=%2Faosp-mirror%2Fplatform_bionic)
* [Star
   607](/login?return_to=%2Faosp-mirror%2Fplatform_bionic)

* [Code](/aosp-mirror/platform_bionic)
* [Pull requests
  0](/aosp-mirror/platform_bionic/pulls)
* [Actions](/aosp-mirror/platform_bionic/actions)
* [Security](/aosp-mirror/platform_bionic/security)
* [Insights](/aosp-mirror/platform_bionic/pulse)

Additional navigation options

* [Code](/aosp-mirror/platform_bionic)
* [Pull requests](/aosp-mirror/platform_bionic/pulls)
* [Actions](/aosp-mirror/platform_bionic/actions)
* [Security](/aosp-mirror/platform_bionic/security)
* [Insights](/aosp-mirror/platform_bionic/pulse)

## Commit

[Permalink](/aosp-mirror/platform_bionic/commit/7f5aa4f35e23fd37425b3a5041737cdf58f87385)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

bionic: fix integer overflows in chk\_malloc(), leak\_malloc(), and lea…

[Browse files](/aosp-mirror/platform_bionic/tree/7f5aa4f35e23fd37425b3a5041737cdf58f87385)
Browse the repository at this point in the history

```
…k_memalign()

The allocation size in chk_malloc(), leak_malloc(), and leak_memalign()
functions may be rounded up to a small value, leading to buffer overflows.
The code only runs in debugging mode.

This patch complements commit [6f04a0f](https://github.com/aosp-mirror/platform_bionic/commit/6f04a0f4c72acff80dad04828cb69ef67fa609d1) ([CVE-2009-0607](https://github.com/advisories/GHSA-cv5g-5rc7-m952 "CVE-2009-0607")).

Change-Id: Id899bcd2bcd2ea2205e5753c433390710032dc83
Signed-off-by: Xi Wang <xi.wang@gmail.com>
```

* Loading branch information

[![@xiw](https://avatars.githubusercontent.com/u/801567?s=40&v=4)](/xiw) [![@enh-google](https://avatars.githubusercontent.com/u/53129816?s=40&v=4)](/enh-google)

[xiw](/aosp-mirror/platform_bionic/commits?author=xiw "View all commits by xiw")
authored and
[enh-google](/aosp-mirror/platform_bionic/commits?author=enh-google "View all commits by enh-google")
committed
May 7, 2012

1 parent
[73a6566](/aosp-mirror/platform_bionic/commit/73a6566da337db50cfc73c369d774ac1905a30c2)

commit 7f5aa4f

Showing
**1 changed file**
with
**25 additions**
and
**12 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

37 changes: 25 additions & 12 deletions

37
[libc/bionic/malloc\_debug\_leak.c](#diff-38563084280b221e42ff74fd4d2d0fdbfc137f3ba3abb683e405ebc69c653d9b "libc/bionic/malloc_debug_leak.c")

Show comments

[View file](/aosp-mirror/platform_bionic/blob/7f5aa4f35e23fd37425b3a5041737cdf58f87385/libc/bionic/malloc_debug_leak.c)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,26 +25,26 @@ |
|  |  | \* OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF |
|  |  | \* SUCH DAMAGE. |
|  |  | \*/ |
|  |  |  |
|  |  | #include <dlfcn.h> |
|  |  | #include <errno.h> |
|  |  | #include <fcntl.h> |
|  |  | #include <pthread.h> |
|  |  | #include <stdarg.h> |
|  |  | #include <stddef.h> |
|  |  | #include <stdint.h> |
|  |  | #include <stdio.h> |
|  |  | #include <arpa/inet.h> |
|  |  | #include <sys/socket.h> |
|  |  | #include <stdlib.h> |
|  |  | #include <string.h> |
|  |  | #include <unistd.h> |
|  |  | #include <errno.h> |
|  |  | #include <stddef.h> |
|  |  | #include <stdarg.h> |
|  |  | #include <fcntl.h> |
|  |  | #include <unwind.h> |
|  |  | #include <dlfcn.h> |
|  |  |  |
|  |  | #include <sys/socket.h> |
|  |  | #include <sys/un.h> |
|  |  | #include <arpa/inet.h> |
|  |  | #include <sys/select.h> |
|  |  | #include <sys/types.h> |
|  |  | #include <sys/socket.h> |
|  |  | #include <sys/system\_properties.h> |
|  |  | #include <sys/types.h> |
|  |  | #include <sys/un.h> |
|  |  |  |
|  |  | #include "dlmalloc.h" |
|  |  | #include "logd.h" |
| Expand Down  Expand Up | | @@ -372,7 +372,11 @@ static int chk\_mem\_check(void\* mem, |
|  |  |  |
|  |  | void\* chk\_malloc(size\_t bytes) |
|  |  | { |
|  |  | char\* buffer = (char\*)dlmalloc(bytes + CHK\_OVERHEAD\_SIZE); |
|  |  | size\_t size = bytes + CHK\_OVERHEAD\_SIZE; |
|  |  | if (size < bytes) { // Overflow. |
|  |  | return NULL; |
|  |  | } |
|  |  | uint8\_t\* buffer = (uint8\_t\*) dlmalloc(size); |
|  |  | if (buffer) { |
|  |  | memset(buffer, CHK\_SENTINEL\_VALUE, bytes + CHK\_OVERHEAD\_SIZE); |
|  |  | size\_t offset = dlmalloc\_usable\_size(buffer) - sizeof(size\_t); |
| Expand Down  Expand Up | | @@ -505,7 +509,12 @@ void\* leak\_malloc(size\_t bytes) |
|  |  | // 1. allocate enough memory and include our header |
|  |  | // 2. set the base pointer to be right after our header |
|  |  |  |
|  |  | void\* base = dlmalloc(bytes + sizeof(AllocationEntry)); |
|  |  | size\_t size = bytes + sizeof(AllocationEntry); |
|  |  | if (size < bytes) { // Overflow. |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | void\* base = dlmalloc(size); |
|  |  | if (base != NULL) { |
|  |  | pthread\_mutex\_lock(&gAllocationsMutex); |
|  |  |  |
| Expand Down  Expand Up | | @@ -615,6 +624,10 @@ void\* leak\_memalign(size\_t alignment, size\_t bytes) |
|  |  | // we will align by at least MALLOC\_ALIGNMENT bytes |
|  |  | // and at most alignment-MALLOC\_ALIGNMENT bytes |
|  |  | size\_t size = (alignment-MALLOC\_ALIGNMENT) + bytes; |
|  |  | if (size < bytes) { // Overflow. |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | void\* base = leak\_malloc(size); |
|  |  | if (base != NULL) { |
|  |  | intptr\_t ptr = (intptr\_t)base; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7f5aa4f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faosp-mirror%2Fplatform_bionic%2Fcommit%2F7f5aa4f35e23fd37425b3a5041737cdf58f87385) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from kqueue.org_0b37f494_20250125_212443.html ===

[kqueue.org](/)

[About](/about/)

# Memory allocator security revisited

Mar 5, 2012
•
Xi Wang

C/C++ 101:

* What does `malloc(n)` return if `n` is a big number (e.g., `-1` or `SIZE_MAX`)?
* What does `calloc(n, size)` return if `n` and `size` are big numbers?
* What does `new T[n]` return if `n` is a big number (assuming `-fno-exception`)?

I believe everyone expects the answer `NULL` for all the questions,
as `NULL` is used to indicate out of memory.
Unfortunately, in reality many memory allocators break (or used to
break) these expectations, which could lead to memory corruption and
security vulnerabilities, especially if the allocation size
can be controlled by an adversary.

Here goes a summary of some known and unknown vulnerabilities
(notably multiplication, rounding, and pointer overflows)
in popular memory allocators.

## GLIBC malloc

An infamous multiplication overflow used to exist in the `calloc`
implementation in GNU libc and Microsoft’s C runtime, as detailed
in
[RUS-CERT Advisory 2002-08:02](https://seclists.org/bugtraq/2002/Aug/91).
This overflow vulnerability can be easily misused to mount buffer
overflow attacks. It was
[fixed](http://sourceware.org/git/?p=glibc.git;a=commit;h=0950889b810736fe7ad340a13a5ecf76672e1a84)
in GLIBC in 2002.

## Hoard

I cannot find the revision log of the [Hoard](http://www.hoard.org/)
allocator, so it’s hard to say what vulnerabilities it used to have.
Though it’s easy to exploit the current version (3.8) via a rounding
overflow. Below is the buggy code snippet in `tlab.h`.

```
// ThreadLocalAllocationBuffer::malloc(size_t sz)
sz = align (sz); // (sz + (sizeof(double) - 1)) & ~(sizeof(double) - 1);
// Get memory from the local heap,
// and deduct that amount from the local heap bytes counter.
if (sz <= LargestObject) {
  int c = getSizeClass (sz);
  void * ptr = _localHeap(c).get();
  if (ptr) {
    assert (_localHeapBytes >= sz);
    _localHeapBytes -= sz;
    assert (getSize(ptr) >= sz);
    return ptr;
  }
}

```

When `sz` is `(size_t)-1`, a big value, the `align` call overflows
and rounds `sz` up to 0. Thus, `malloc(-1)` is basically `malloc(0)`,
which could lead to a buffer overflow.

Hoard’s `calloc` implementation is also vulnerable to multiplication
overflow. With glibc Hoard is injected via `__malloc_hook`,
and its `calloc` won’t be used. However, the vulnerability can
be triggered on platforms that do not use glibc, such as Mac OS X.

## jemalloc

The [jemalloc](http://www.canonware.com/jemalloc/) allocator is
used by the libc of FreeBSD and NetBSD, as well as Mozilla Firefox.

It used to have the `calloc` multiplication overflow vulnerability.
The bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=161263) in 2006.

A rounding overflow bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=167872)
in 2007.

Another interesting signedness bug was
[fixed](http://svnweb.freebsd.org/base?diff_format=l&view=revision&revision=178645)
in 2008. Below is the simplified code snippet in `jemalloc.c`.

```
/* chunk_alloc_dss(size_t size) */
/* assert(size != 0);                    */
/* assert((size & chunksize_mask) == 0); */
intptr_t incr;
void *ret;

/* Get the current end of the DSS. */
dss_max = sbrk(0);

/*
 * Calculate how much padding is necessary to
 * chunk-align the end of the DSS.
 */
incr = (intptr_t)size - (intptr_t)CHUNK_ADDR2OFFSET(dss_max);
if (incr == (intptr_t)size)
    ret = dss_max;
else {
    ret = (void *)((intptr_t)dss_max + incr);
    incr += size;
}

sbrk(incr);
return (ret);

```

Note that `size` is unsigned and `incr` is signed.
When `size` is big enough, `incr` is misinterpreted as negative
and causes the `sbrk` system call to shrink the memory.

## Bionic malloc

Bionic, the Android libc, is derived from the BSD libc. When
`libc.debug.malloc` is set, allocation calls will be rerouted to
its own debugging library.

Again, the debugging library had `calloc` multiplication overflows
([CVE-2009-0607](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-0607)).

Also, its `malloc` implementation still has multiple rounding
overflows, at least in in `chk_malloc` and `leak_malloc`.

Hope that no production phone ships the debugging library.

## TCMalloc

Google’s [TCMalloc](http://goog-perftools.sourceforge.net/doc/tcmalloc.html)
repeated the `calloc` multiplication overflow bug and got it
[fixed](http://code.google.com/p/gperftools/source/detail?r=15&path=/trunk/src/tcmalloc.cc)
in 2005.

I didn’t spot any serious rounding issues in TCMalloc,
but just a slip in `ReportLargeAlloc`:
the error message says “tcmalloc: large alloc *0* bytes == (nil)”
given `malloc(-1)`, because the size to be output overflows.

## APR pool

[APR pool](http://apr.apache.org/docs/apr/group__apr__pools.html) is
developed for the Apache web server. It is also adopted by other
projects such as Subversion. The interface is similar to
allocate-and-free allocators, but takes one extra parameter specifying
which pool to allocate from.

APR pool had a series of interesting pointer arithmetic fixes,
listed as follows.

In Aug 2002, the sanity check `p + size < q` was
[changed](http://svn.apache.org/viewvc?view=revision&revision=63806)
to `size < q - p`, where
the two pointers `p` (i.e., `node->first_evail`) and `q` (i.e.,
`node->endp`) point to the start and the end of a memory block,
respectively.

```
-    endp = node->first_avail + size;
-    if (endp < node->endp) {
+    if (size < node->endp - node->first_avail) {

```

Over a month later (Sep 2002), the check was
[reverted](http://svn.apache.org/viewvc?view=revision&revision=63887)
to `p + size < q`.

```
-    if (size < node->endp - node->first_avail) {
+    if (node->first_avail + size < node->endp) {

```

One week later (Oct 2002), the check was again
[changed](http://svn.apache.org/viewvc?view=revision&revision=63894)
to `size < q - p`.

```
-    if (node->first_avail + size < node->endp) {
+    if (size < (apr_size_t)(node->endp - node->first_avail)) {

```

After over five years (Apr 2008), the check was
[revised](http://svn.apache.org/viewvc?view=revision&revision=645436)
to `size <= q - p` with an off-by-one fix.

```
+/* Returns the amount of free space in the given node. */
+#define node_free_space(node_) ((apr_size_t)(node_->endp - node_->first_avail))
...
-    if (size < (apr_size_t)(node->endp - node->first_avail)) {
+    if (size <= node_free_space(node)) {

```

Here `p + size < q` is more dangerous than `size < q - p`. One obvious
reason is that `p + size` could wrap around to a small pointer given
a big `size`, while the latter check doesn’t have the pointer
overflow issue.

But how about adding a wrap check `p + size < p`? A subtle
problem is that pointer overflow (or more precisely, out-of-bounds
pointer) is undefined in C, which means that the compiler can do
anything to the wrap check `p + size < p`, such as optimizing it
away ([VU#162289](http://www.kb.cert.org/vuls/id/162289)).
I tried to compile the wrap check using GCC 4.6 and Clang 3.0 on x86:
it’s optimized as extracting the sign of `size`, without even looking
at the value of `p`.

```
movl	8(%esp), %eax
shrl	$31, %eax
ret

```

The size rounding vulnerability was also discovered and fixed in APR pool
([CVE-2009-2412](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-2412))
in 2009.

## boost::pool

[Boost Pool](http://www.boost.org/libs/pool/) has the multiplication overflow
issue in its `ordered_malloc` implementation.

```
template <typename UserAllocator>
void * pool<UserAllocator>::ordered_malloc(const size_type n)
{
  const size_type partition_size = alloc_size();
  const size_type total_req_size = n * requested_size;
  const size_type num_chunks = total_req_size / partition_size +
      ((total_req_size % partition_size) ? true : false);

  void * ret = store().malloc_n(num_chunks, partition_size);
  ...
]

```

We can see that `total_req_size` may wrap around to a small number
given a big `n`.

## Boehm GC

[Boehm GC](http://www.hpl.hp.com/personal/Hans_Boehm/gc/) is probably
the most popular open-source garbage collector. It provides C
allocation calls and overloads the C++ `new` operator.

Boehm GC’s `calloc` implementation, in both `malloc.c` and its
[documentation](http://www.hpl.hp.com/personal/Hans_Boehm/gc/leak.html),
simply redirects `calloc(n, size)` to `GC_MALLOC((n) * (size))`,
thus is vulnerable to multiplication overflow.

It also has the size rounding vulnerability, so `GC_MALLOC(-1)`
doesn’t return a null pointer either.

## Safe by Design

Some allocators are designed to be used in “safe”
environment. For example, LLVM’s `BumpPtrAllocator`
doesn’t consider out-of-memory or overflow issues.

[kLIBC](http://git.kernel.org/?p=libs/klibc/klibc.git;a=blob;f=usr/klibc/calloc.c;hb=HEAD) is another example.

```
/* FIXME: This should look for multiplication overflow */

void *calloc(size_t nmemb, size_t size)
{
	void *ptr;

	size *= nmemb;
	ptr = malloc(size);
	if (ptr)
		memset(ptr, 0, size);

	return ptr;
}

```
## Compiler

The C++ array allocation `new T[n]` has a potential integer overflow
vulnerability if `n` is not limited correctly, which could lead to
a buffer overflow. This is similar to `calloc(n, sizeof(T))`.

The code generated by GCC simply calculates the
allocation size as `n * sizeof(T)` without any overflow checks,
though GCC developers have been
[discussing the problem](http://gcc.gnu.org/bugzilla/show_bug.cgi?id=19351)
for a long time.

Clang
[generates “safe” code](http://blog.llvm.org/2011/05/what-every-c-programmer-should-know_21.html)
that defends against integer overflow attacks, via setting the
allocation size to -1 if any multiplication overflow happens. This
implies an assumption that the underlying allocator must return a
null pointer given a large size. As we have seen, this assumption
doesn’t hold well in practice.

[Subscribe](/feed.xml)



=== Content from www.openwall.com_ac36f5f6_20250125_212445.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2012/06/04/6) [[next>]](2) [[thread-next>]](../../../2012/06/07/9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <36617FD3-6265-4329-9138-6203268449D1@gmail.com>
Date: Tue, 5 Jun 2012 01:54:17 -0400
From: Xi Wang <xi.wang@...il.com>
To: oss-security@...ts.openwall.com
Subject: memory allocator upstream patches

Hi,

I would like to share some upstream patches of two specific types
of memory allocator vulnerabilities.

* malloc(n) size overflow.

Consider the following code pattern.

	n = read_from_input();
	p = malloc(n);
	if (p)
		memcpy(p, input_buffer, n);

Some malloc() implementations internally perform alignment/padding
for a large n, and the allocation size wraps around to a small
integer.  That means they would allocate a smaller buffer than
expected, leading to buffer overflow.

* calloc(n, size) size overflow.

Some calloc() implementations don't check for n * size multiplication
overflow, and would allocate a smaller buffer than expected,
leading to buffer overflow.

The two types of vulnerabilities can be easily reproduced using
malloc(-1) and calloc(BIG-VALUE, BIG-VALUE).  If the return values
are non-null, the implementations are likely to be problematic.

See a more complete list at:

<http://kqueue.org/blog/2012/03/05/memory-allocator-security-revisited/>

Below are some recent upstream fixes.

Boehm-Demers-Weiser GC (libgc)
==============================

malloc() size overflow, upstream patch (revised by the developers):

<https://github.com/ivmai/bdwgc/commit/be9df82919960214ee4b9d3313523bff44fd99e1>

The bug in mallocx.c was found by Ivan Maidanski.

calloc() size overflow, upstream patch (revised by the developers):

<https://github.com/ivmai/bdwgc/commit/e10c1eb9908c2774c16b3148b30d2f3823d66a9a>
<https://github.com/ivmai/bdwgc/commit/6a93f8e5bcad22137f41b6c60a1c7384baaec2b3>
<https://github.com/ivmai/bdwgc/commit/83231d0ab5ed60015797c3d1ad9056295ac3b2bb>

bionic (Android libc)
=====================

malloc() size overflow, upstream patch (revised by the developers):

<https://github.com/android/platform_bionic/commit/7f5aa4f35e23fd37425b3a5041737cdf58f87385>

NB: this vulnerability could only be triggered in debug mode, the
same as CVE-2009-0607, calloc() size overflow.

nedmalloc
=========

malloc() size overflow, upstream patch:

<https://github.com/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000>

calloc() size overflow, upstream patch:

<https://github.com/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1>

Hoard
=====

<http://www.hoard.org/>

malloc() size overflow, confirmed by the developers via email in
this March, no upstream patch available (since 3.8).

calloc() size overflow, which should only happen on non-glibc
platforms (e.g., Mac OS X).  It has not been confirmed by the
developers, but one can easily reproduce it.

boost::pool
===========

ordered_malloc() (similar to calloc()) size overflow, upstream patch:

<https://svn.boost.org/trac/boost/changeset/78326>

- xi
```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_bec6d3ac_20250125_212447.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](12) [[next>]](../../../2012/06/08/1) [[<thread-prev]](9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <4FD0FD34.2050201@redhat.com>
Date: Thu, 07 Jun 2012 13:12:52 -0600
From: Kurt Seifried <kseifried@...hat.com>
To: oss-security@...ts.openwall.com
CC: Xi Wang <xi.wang@...il.com>, boost@...ts.boost.org, emery@...umass.edu,
        ivmai@...l.ru, webmaster2@...prod.com
Subject: Re: memory allocator upstream patches

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 06/04/2012 11:54 PM, Xi Wang wrote:
> Hi,
>
> I would like to share some upstream patches of two specific types
> of memory allocator vulnerabilities.
>
> * malloc(n) size overflow.
>
> Consider the following code pattern.
>
> 	n = read_from_input();
> 	p = malloc(n);
> 	if (p)
> 		memcpy(p, input_buffer, n);
>
> Some malloc() implementations internally perform alignment/padding
> for a large n, and the allocation size wraps around to a small
> integer.  That means they would allocate a smaller buffer than
> expected, leading to buffer overflow.
>
> * calloc(n, size) size overflow.
>
> Some calloc() implementations don't check for n * size multiplication
> overflow, and would allocate a smaller buffer than expected,
> leading to buffer overflow.
>
> The two types of vulnerabilities can be easily reproduced using
> malloc(-1) and calloc(BIG-VALUE, BIG-VALUE).  If the return values
> are non-null, the implementations are likely to be problematic.
>
> See a more complete list at:
>
> <http://kqueue.org/blog/2012/03/05/memory-allocator-security-revisited/>
>
> Below are some recent upstream fixes.
>
>
> Boehm-Demers-Weiser GC (libgc)
> ==============================
>
> malloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/ivmai/bdwgc/commit/be9df82919960214ee4b9d3313523bff44fd99e1>
>
> The bug in mallocx.c was found by Ivan Maidanski.
>
> calloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/ivmai/bdwgc/commit/e10c1eb9908c2774c16b3148b30d2f3823d66a9a>
>
<https://github.com/ivmai/bdwgc/commit/6a93f8e5bcad22137f41b6c60a1c7384baaec2b3>
>
<https://github.com/ivmai/bdwgc/commit/83231d0ab5ed60015797c3d1ad9056295ac3b2bb>

<https://github.com/ivmai/bdwgc/blob/master/malloc.c>
<https://github.com/ivmai/bdwgc/blob/master/mallocx.c>

Please use CVE-2012-2673 for this issue

> bionic (Android libc)
> =====================
>
> malloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/android/platform_bionic/commit/7f5aa4f35e23fd37425b3a5041737cdf58f87385>
>
> NB: this vulnerability could only be triggered in debug mode, the
> same as CVE-2009-0607, calloc() size overflow.

<https://github.com/android/platform_bionic/blob/master/libc/bionic/malloc_debug_leak.c>

Please use CVE-2012-2674 for this issue

> nedmalloc
> =========
>
> malloc() size overflow, upstream patch:
>
>
<https://github.com/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000>
>
> calloc() size overflow, upstream patch:
>
>
<https://github.com/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1>

<https://github.com/ned14/nedmalloc/blob/master/nedmalloc.c>

Please use CVE-2012-2675 for this issue

> Hoard
> =====
>
> <http://www.hoard.org/>
>
> malloc() size overflow, confirmed by the developers via email in
> this March, no upstream patch available (since 3.8).
>
> calloc() size overflow, which should only happen on non-glibc
> platforms (e.g., Mac OS X).  It has not been confirmed by the
> developers, but one can easily reproduce it.

hoard-38/src/tlab.h

Please use CVE-2012-2676 for this issue

> boost::pool
> ===========
>
> ordered_malloc() (similar to calloc()) size overflow, upstream patch:
>
> <https://svn.boost.org/trac/boost/changeset/78326>

<http://www.boost.org/doc/libs/1_49_0/boost/pool/poolfwd.hpp>

Please use CVE-2012-2677 for this issue

> - xi

- --
Kurt Seifried Red Hat Security Response Team (SRT)
PGP: 0x5E267993 A90B F995 7350 148F 66BF 7554 160D 4553 5E26 7993

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.12 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <http://enigmail.mozdev.org/>

iQIcBAEBAgAGBQJP0P00AAoJEBYNRVNeJnmTegUP/RzPWBuDk5uc5VX7GfNwl2bV
Tj6vK8eR3PqC0eWZ9J84Ak1Rr/sArq7+eF2jQzB2y5nazrvq8+CbLG45+aG/tc/k
/s1WgQlPf0/cSdG5KtXqQAot/DNwBr91gzPiXzLhH4VriglZkmyYnQoatUq7qg+X
95dlGcDiA9MZBs8/Y9hffUQpT6A59RBR1Js/wIuKxgVuvR6FHr5K6kT8ugj7u5n6
4gsvpL16rpAqUtaDrbrYS/E1wde0X4X++mwdMe+Qnjh4ZmVINPcF845QMmPUKKzN
ub2q/aibzI3c7UxHVW6yPO4kY14dWHQIJkIB4r6nPNkUlkHEsCageMYqUA+iK8d8
/c0xbUjEk6Lq9mWjduHCTdXxgSJcZRl5+v64qAAkGXn2Iry1t0LxLUvQagyG/YYl
laYogHq57jS7gl5bWnPNRFiWo5/zS5n7t6F+T2s98Oly9guNTOZXqe3bzHkJDBO3
Wcv6GNZ+awN0XVLHgBIzky5LCDHbCQrjr/JZvD55HNt9gCmsJzgg0C4iXda86hUd
+yLPQ7tzPIXaruco5GdBh24k6pHuvXfUoeIitRHdb/a1lUqY+9Prcrn0/uC9O6H9
i6RZ7Oki4mE4LBOWP4C/2CxR87tqNmMv2/NKvlMhBVM7IdIxtinXHmwZZGS2aywo
/9xo9gM88fT2SmjREZu3
=Zv9/
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


