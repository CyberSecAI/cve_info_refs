=== Content from www.openwall.com_5929f818_20250125_062943.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](7) [[next>]](9) [[thread-next>]](9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20120418192811.GO8020@outflux.net>
Date: Wed, 18 Apr 2012 12:28:11 -0700
From: Kees Cook <keescook@...omium.org>
To: oss-security@...ts.openwall.com
Subject: CVE request: Xorg input device format string flaw

Hello,

Adding an input device with a malicious name can trigger a format
string flaw in Xorg's logging subsystem. For builds of Xorg lacking
-D_FORTIFY_SOURCE=2 (or 32-bit systems lacking the fix to fortify[1])
this can lead to arbitrary code execution as the Xorg user, usually
root. When built with fortify, this is a denial of service, since Xorg
will abort.

Proposed solution patch series can be found here:
    1/4 <http://patchwork.freedesktop.org/patch/10000/>
    2/4 <http://patchwork.freedesktop.org/patch/9998/>
    3/4 <http://patchwork.freedesktop.org/patch/9999/>
    4/4 <http://patchwork.freedesktop.org/patch/10001/>

-Kees

[1] <http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=7c1f4834d398163d1ac8101e35e9c36fc3176e6e>

--
Kees Cook
Chrome OS Security

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_c5793ff4_20250125_062944.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2012/04/18/10) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <4F8F5DCD.600@redhat.com>
Date: Wed, 18 Apr 2012 18:35:25 -0600
From: Kurt Seifried <kseifried@...hat.com>
To: oss-security@...ts.openwall.com
CC: Kees Cook <keescook@...omium.org>
Subject: Re: CVE request: Xorg input device format string flaw

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 04/18/2012 02:37 PM, Kees Cook wrote:
> On Wed, Apr 18, 2012 at 1:23 PM, Kurt Seifried
> <kseifried@...hat.com> wrote:
>> On 04/18/2012 01:28 PM, Kees Cook wrote:
>>> Hello,
>>>
>>> Adding an input device with a malicious name can trigger a
>>> format string flaw in Xorg's logging subsystem. For builds of
>>> Xorg lacking -D_FORTIFY_SOURCE=2 (or 32-bit systems lacking the
>>> fix to fortify[1]) this can lead to arbitrary code execution as
>>> the Xorg user, usually root. When built with fortify, this is a
>>> denial of service, since Xorg will abort.
>>>
>>> Proposed solution patch series can be found here: 1/4
>>> <http://patchwork.freedesktop.org/patch/10000/> 2/4
>>> <http://patchwork.freedesktop.org/patch/9998/> 3/4
>>> <http://patchwork.freedesktop.org/patch/9999/> 4/4
>>> <http://patchwork.freedesktop.org/patch/10001/>
>>>
>>> -Kees
>>>
>>> [1]
>>> <http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=7c1f4834d398163d1ac8101e35e9c36fc3176e6e>
>>
>>
>>>
So
>>>
>> are you asking for just the device name issue covered in
>>
>> <http://patchwork.freedesktop.org/patch/10001/>

Please use CVE-2012-2118 for this issue (Xorg device name logging
format string).

> Yeah, but I wanted to point to the entire patch series, since that
> fix, I think, depends on pieces from the others.
>
> -Kees

Ok, it's just that some of them have other somewhat security sounding
issues (I haven't looked in depth though, was hoping you had).

- --
Kurt Seifried Red Hat Security Response Team (SRT)
PGP: 0x5E267993 A90B F995 7350 148F 66BF 7554 160D 4553 5E26 7993

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.12 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <http://enigmail.mozdev.org/>

iQIcBAEBAgAGBQJPj13NAAoJEBYNRVNeJnmTcg8P/0nmtqjjZpKKWfHK4vdcPtut
6Ue/W0/QqDJi2riiB+4pe4QEezK5X27QmsH4pfqEWuk/0ykF9Dj1MKae3/bhT2wg
zem/cKRHnS3/iprqWZrHhfvPoIi1oSl8nvjJImjfCMUGi1gZhdZDTYqP4MLbtvG7
+4TbWzeSxxDlOhW6iM70qIbxjuB1guh3DE1pjICjKev9GvfzU6vTkoYYGvq3ZFUQ
warDFqYo1PxOVcWj96JCIQMpywr5vBIypg3ZmTVVWZgfRiE0Ub/1fstaICK0E9IV
n+C9PNxwUOPGLAo+X1Mpj5kC7QutPvJ4zyOSHZBBFmUlW2arcXhC08MJb+zO/aXd
+kqzPnVWEuemqtfAbpELDYoKils5V1PG2ZNgd6rbabg6LHW795Db1UtGjvrU9Wb9
YZgcD+yA3VqCdwHHSPY/w8ek3BUSQmR7jveAI7ZLdnMPdgV070hMkA8PxRhI7So2
h3Riv2ySBH22ejZwNAJ0A18T7wBEn0u+KEvt7v91NwG5tLDtSBn7Kk+kvo2BvBz5
6o3rh7GOFTPOR49wyMaUNHTN5C+LmcSY9mGYxX+mpJLZU68fn43YFbdWu2kRagQ0
7OQSCg2ycXaR8bhtsudMuUCbWMgKo+Snvd2KCNE6AbCEyMnMDjvztff9Vpe7pCaZ
iWjfpsj6EXWwvgQzebg5
=TT32
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from patchwork.freedesktop.org_da67fcb3_20250125_062943.html ===

Toggle navigation

[Patchwork](/)
[X.org (DEPRECATED - USE GITLAB)](/project/Xorg/series/)

* [Series](/project/Xorg/series/)
* [Patches](/project/Xorg/patches/)
* [Bundles](/project/Xorg/bundles/)
* [About this project](/project/Xorg/)
* [All projects](/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

# [4/4] os/log: refactor logging

Submitted by [Daniel Kurtz](/project/Xorg/list/?submitter=875) on April 18, 2012, 9:51 a.m.
## Details

| Message ID | 1334742713-26570-5-git-send-email-djkurtz@chromium.org |
| --- | --- |
| State | Accepted |
| Commit | c91d00e0f330b9de604068e1bfcb0a307096434f |
| Headers | show ``` Return-Path: <xorg-devel-bounces+patchwork=annarchy.freedesktop.org@lists.x.org> X-Original-To: patchwork@annarchy.freedesktop.org Delivered-To: patchwork@annarchy.freedesktop.org Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177]) 	by annarchy.freedesktop.org (Postfix) with ESMTP id A25B264B5F 	for <patchwork@annarchy.freedesktop.org>; 	Wed, 18 Apr 2012 02:54:29 -0700 (PDT) Received: from gabe.freedesktop.org (localhost [127.0.0.1]) 	by gabe.freedesktop.org (Postfix) with ESMTP id 908B3A0B02 	for <patchwork@annarchy.freedesktop.org>; 	Wed, 18 Apr 2012 02:54:29 -0700 (PDT) X-Original-To: xorg-devel@lists.x.org Delivered-To: xorg-devel@lists.x.org Received: from mail-qa0-f74.google.com (mail-qa0-f74.google.com 	[209.85.216.74]) 	by gabe.freedesktop.org (Postfix) with ESMTP id 8422CA0B0F 	for <xorg-devel@lists.x.org>; Wed, 18 Apr 2012 02:51:59 -0700 (PDT) Received: by qabg24 with SMTP id g24so41430qab.3 	for <xorg-devel@lists.x.org>; Wed, 18 Apr 2012 02:51:57 -0700 (PDT) X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; 	d=google.com; s=20120113; 	h=from:to:cc:subject:date:message-id:x-mailer:in-reply-to:references 	:x-gm-message-state; 	bh=5HyndLRDdLzuv7KSn9aP+wQCscNdGEopM79k6A/Hi+I=; 	b=VJ4SFf8oLTirNJ8vxIzuY6SMF+/uSuQsB38zVmRqC9CM/tUIq3CviVGfIWc58w+huD 	FOPUGrE3awXru9KA6GkmaVfvrhBc+qvJqw29aSRAsxJS7EFVOLvuFVmslMvIsZs4Hfy3 	vXFQmRGzrSU/KesZNHiDRUzDgoGr3LqQW8DIdrAIvHQlbaZnWMPY6xjGjS6bmYRAsjsO 	0MKdMV8kTGMQRUFLK6qyxAZAcUA8tzaEkewxf0pLAW/Xv0pmpV0Xpao6qf3SsWJH5bHg 	7cudTSrdE94kd82wiImbZ2WkOiSydfzGuaOU/gdEKhOYWqFjJkydhnJY5nBT73ygQeMc 	TWKw== Received: by 10.236.155.102 with SMTP id i66mr2010544yhk.9.1334742717902; 	Wed, 18 Apr 2012 02:51:57 -0700 (PDT) Received: by 10.236.155.102 with SMTP id i66mr2010532yhk.9.1334742717817; 	Wed, 18 Apr 2012 02:51:57 -0700 (PDT) Received: from wpzn3.hot.corp.google.com (216-239-44-65.google.com 	[216.239.44.65]) by gmr-mx.google.com with ESMTPS id 	a33si9351848anp.2.2012.04.18.02.51.57 	(version=TLSv1/SSLv3 cipher=AES128-SHA); 	Wed, 18 Apr 2012 02:51:57 -0700 (PDT) Received: from puck.tpe.corp.google.com (puck.tpe.corp.google.com 	[172.30.210.35]) 	by wpzn3.hot.corp.google.com (Postfix) with ESMTP id 688E2100052; 	Wed, 18 Apr 2012 02:51:57 -0700 (PDT) Received: by puck.tpe.corp.google.com (Postfix, from userid 116377) 	id A932D80A20; Wed, 18 Apr 2012 17:51:56 +0800 (CST) From: Daniel Kurtz <djkurtz@chromium.org> To: xorg-devel@lists.x.org Subject: [PATCH 4/4] os/log: refactor logging Date: Wed, 18 Apr 2012 17:51:53 +0800 Message-Id: <1334742713-26570-5-git-send-email-djkurtz@chromium.org> X-Mailer: git-send-email 1.7.7.3 In-Reply-To: <1334742713-26570-1-git-send-email-djkurtz@chromium.org> References: <1334742713-26570-1-git-send-email-djkurtz@chromium.org> X-Gm-Message-State: ALoCoQmq69kH2dP4U8cMhFpx+oL7Yh4iHFJkmCGEAs8enJmFI4xcLWKGblXxQVSWsm1hIi2GNfW9rLqGGI3vpNMg6O3U2wF9z/H1UhBZDdk7TmZaIpt0pYcFwGoJZbJ6szZxICBIRll0dwL6S/HMvHDesjcaAPupAPfLU/4JtLHV+D+2f5huR9w= Cc: Daniel Kurtz <djkurtz@chromium.org> X-BeenThere: xorg-devel@lists.x.org X-Mailman-Version: 2.1.11 Precedence: list List-Id: "X.Org development list" <xorg-devel.lists.x.org> List-Unsubscribe: <http://lists.x.org/mailman/options/xorg-devel>, 	<mailto:xorg-devel-request@lists.x.org?subject=unsubscribe> List-Archive: <http://lists.x.org/archives/xorg-devel> List-Post: <mailto:xorg-devel@lists.x.org> List-Help: <mailto:xorg-devel-request@lists.x.org?subject=help> List-Subscribe: <http://lists.x.org/mailman/listinfo/xorg-devel>, 	<mailto:xorg-devel-request@lists.x.org?subject=subscribe> MIME-Version: 1.0 Content-Type: text/plain; charset="us-ascii" Content-Transfer-Encoding: 7bit Sender: xorg-devel-bounces+patchwork=annarchy.freedesktop.org@lists.x.org Errors-To: xorg-devel-bounces+patchwork=annarchy.freedesktop.org@lists.x.org  ``` |

**Not browsing as part of any series.**

## Commit Message

[Daniel Kurtz](/project/Xorg/list/?submitter=875)
April 18, 2012, 9:51 a.m.
```

It is not safe to ever use an arbitrary (possibly user supplied) string as
part of the format for a *sprintf() call.

For example:
  1. Name a Bluetooth keyboard "%n%n%n%n%n%n%n%n"
  2. Pair it with a computer running X and try to use it
  3. X is not happy when trying to do the following in xf86-input-evdev:
     xf86IDrvMsg(pInfo, X_CONFIG, "Device: \"%s\"\n", device);
     because LogVHdrMessageVerb() has put the %n from the device name
     into a format string.

Instead, build up a log message in place by appending successive formatted
strings by sncprintf'ing to the end of the previous.
Signed-off-by: Daniel Kurtz <djkurtz@chromium.org>
---
 os/log.c |   97 +++++++++++++++++++++++++++++--------------------------------
 1 files changed, 46 insertions(+), 51 deletions(-)

```
## Patch hide | [download patch](/patch/10001/raw/) | [download mbox](/patch/10001/mbox/)

```

diff --git a/os/log.c b/os/log.c
index 36378e4..2c13c1a 100644
--- a/os/log.c
+++ b/os/log.c
@@ -268,36 +268,19 @@  LogSetParameter(LogParameter param, int value)
 }

 /* This function does the actual log message writes. */
-
-void
-LogVWrite(int verb, const char *f, va_list args)
+static void
+LogSWrite(int verb, const char *buf, size_t len, Bool end_line)
 {
-    static char tmpBuffer[1024];
-    int len = 0;
     static Bool newline = TRUE;

-    if (verb > logFileVerbosity && verb > logVerbosity)
-        return;
-
-    /*
-     * Since a va_list can only be processed once, write the string to a
-     * buffer, and then write the buffer out to the appropriate output
-     * stream(s).
-     */
-    if (verb < 0 || logFileVerbosity >= verb || logVerbosity >= verb) {
-        len = Xvscnprintf(tmpBuffer, sizeof(tmpBuffer), f, args);
-        /* If message is truncated, terminate with '\n' */
-        if (sizeof(tmpBuffer) - len == 1)
-            tmpBuffer[len - 1] = '\n';
-    }
-    if ((verb < 0 || logVerbosity >= verb) && len > 0)
-        fwrite(tmpBuffer, len, 1, stderr);
-    if ((verb < 0 || logFileVerbosity >= verb) && len > 0) {
+    if (verb < 0 || logVerbosity >= verb)
+        fwrite(buf, len, 1, stderr);
+    if (verb < 0 || logFileVerbosity >= verb) {
         if (logFile) {
             if (newline)
                 fprintf(logFile, "[%10.3f] ", GetTimeInMillis() / 1000.0);
-            newline = (tmpBuffer[len - 1] == '\n');
-            fwrite(tmpBuffer, len, 1, logFile);
+            newline = end_line;
+            fwrite(buf, len, 1, logFile);
             if (logFlush) {
                 fflush(logFile);
 #ifndef WIN32
@@ -315,13 +298,19 @@  LogVWrite(int verb, const char *f, va_list args)
                     FatalError("realloc() failed while saving log messages\n");
             }
             bufferUnused -= len;
-            memcpy(saveBuffer + bufferPos, tmpBuffer, len);
+            memcpy(saveBuffer + bufferPos, buf, len);
             bufferPos += len;
         }
     }
 }

 void
+LogVWrite(int verb, const char *f, va_list args)
+{
+    return LogVMessageVerb(X_NONE, verb, f, args);
+}
+
+void
 LogWrite(int verb, const char *f, ...)
 {
     va_list args;
@@ -376,22 +365,28 @@  void
 LogVMessageVerb(MessageType type, int verb, const char *format, va_list args)
 {
     const char *type_str;
-    char tmpFormat[1024];
-    const char *new_format;
+    char buf[1024];
+    const size_t size = sizeof(buf);
+    Bool newline;
+    size_t len = 0;

     type_str = LogMessageTypeVerbString(type, verb);
     if (!type_str)
         return;

-    /* if type_str is not "", prepend it and ' ', to format */
-    if (type_str[0] == '\0')
-        new_format = format;
-    else {
-        new_format = tmpFormat;
-        snprintf(tmpFormat, sizeof(tmpFormat), "%s %s", type_str, format);
-    }
+    /* if type_str is not "", prepend it and ' ', to message */
+    if (type_str[0] != '\0')
+        len += Xscnprintf(&buf[len], size - len, "%s ", type_str);
+
+    if (size - len > 1)
+        len += Xvscnprintf(&buf[len], size - len, format, args);
+
+    /* Force '\n' at end of truncated line */
+    if (size - len == 1)
+        buf[len - 1] = '\n';

-    LogVWrite(verb, new_format, args);
+    newline = (buf[len - 1] == '\n');
+    LogSWrite(verb, buf, len, newline);
 }

 /* Log message with verbosity level specified. */
@@ -421,31 +416,31 @@  LogVHdrMessageVerb(MessageType type, int verb, const char *msg_format,
                    va_list msg_args, const char *hdr_format, va_list hdr_args)
 {
     const char *type_str;
-    char tmpFormat[1024];
-    char *tmpFormat_end = &tmpFormat[sizeof(tmpFormat)];
-    char *p;
-    int left;
+    char buf[1024];
+    const size_t size = sizeof(buf);
+    Bool newline;
+    size_t len = 0;

     type_str = LogMessageTypeVerbString(type, verb);
     if (!type_str)
         return;

-    /* if type_str != "", copy it and ' ' to tmpFormat; set p after ' ' */
-    p = tmpFormat;
+    /* if type_str is not "", prepend it and ' ', to message */
     if (type_str[0] != '\0')
-        p += snprintf(tmpFormat, sizeof(tmpFormat), "%s ", type_str);
+        len += Xscnprintf(&buf[len], size - len, "%s ", type_str);
+
+    if (hdr_format && size - len > 1)
+        len += Xvscnprintf(&buf[len], size - len, hdr_format, hdr_args);

-    /* append as much of hdr as fits after type_str (if there was one) */
-    left = tmpFormat_end - p;
-    if (left > 1)
-        p += vsnprintf(p, left, hdr_format, hdr_args);
+    if (msg_format && size - len > 1)
+        len += Xvscnprintf(&buf[len], size - len, msg_format, msg_args);

-    /* append as much of msg_format as will fit after hdr */
-    left = tmpFormat_end - p;
-    if (left > 1)
-        snprintf(p, left, "%s", msg_format);
+    /* Force '\n' at end of truncated line */
+    if (size - len == 1)
+        buf[len - 1] = '\n';

-    LogVWrite(verb, tmpFormat, msg_args);
+    newline = (buf[len - 1] == '\n');
+    LogSWrite(verb, buf, len, newline);
 }

 void

```
## Comments

[Peter Hutterer](/project/Xorg/list/?submitter=11)
[May 3, 2012, 3:38 a.m.](#comment_22012)
```

On Wed, Apr 18, 2012 at 05:51:53PM +0800, Daniel Kurtz wrote:
> It is not safe to ever use an arbitrary (possibly user supplied) string as
> part of the format for a *sprintf() call.
>
> For example:
>   1. Name a Bluetooth keyboard "%n%n%n%n%n%n%n%n"
>   2. Pair it with a computer running X and try to use it
>   3. X is not happy when trying to do the following in xf86-input-evdev:
>      xf86IDrvMsg(pInfo, X_CONFIG, "Device: \"%s\"\n", device);
>      because LogVHdrMessageVerb() has put the %n from the device name
>      into a format string.
>
> Instead, build up a log message in place by appending successive formatted
> strings by sncprintf'ing to the end of the previous.
>
> Signed-off-by: Daniel Kurtz <djkurtz@chromium.org>

verified and all 4 merged, thanks. took me a while to find the actual issue
because I was looking in the wrong place. for the archives: The culprit here
was not the user-supplied format string but rather xf86IDrvMsg using the
device's name, assembling a format string in the form of
    <driver>: <name>: message
i.e.
    "evdev: %n%n%n%n: Device \"%s\"\n"
and using that as format string to LogVWrite.

Cheers,
  Peter
> ---
>  os/log.c |   97 +++++++++++++++++++++++++++++--------------------------------
>  1 files changed, 46 insertions(+), 51 deletions(-)
>
> diff --git a/os/log.c b/os/log.c
> index 36378e4..2c13c1a 100644
> --- a/os/log.c
> +++ b/os/log.c
> @@ -268,36 +268,19 @@ LogSetParameter(LogParameter param, int value)
>  }
>
>  /* This function does the actual log message writes. */
> -
> -void
> -LogVWrite(int verb, const char *f, va_list args)
> +static void
> +LogSWrite(int verb, const char *buf, size_t len, Bool end_line)
>  {
> -    static char tmpBuffer[1024];
> -    int len = 0;
>      static Bool newline = TRUE;
>
> -    if (verb > logFileVerbosity && verb > logVerbosity)
> -        return;
> -
> -    /*
> -     * Since a va_list can only be processed once, write the string to a
> -     * buffer, and then write the buffer out to the appropriate output
> -     * stream(s).
> -     */
> -    if (verb < 0 || logFileVerbosity >= verb || logVerbosity >= verb) {
> -        len = Xvscnprintf(tmpBuffer, sizeof(tmpBuffer), f, args);
> -        /* If message is truncated, terminate with '\n' */
> -        if (sizeof(tmpBuffer) - len == 1)
> -            tmpBuffer[len - 1] = '\n';
> -    }
> -    if ((verb < 0 || logVerbosity >= verb) && len > 0)
> -        fwrite(tmpBuffer, len, 1, stderr);
> -    if ((verb < 0 || logFileVerbosity >= verb) && len > 0) {
> +    if (verb < 0 || logVerbosity >= verb)
> +        fwrite(buf, len, 1, stderr);
> +    if (verb < 0 || logFileVerbosity >= verb) {
>          if (logFile) {
>              if (newline)
>                  fprintf(logFile, "[%10.3f] ", GetTimeInMillis() / 1000.0);
> -            newline = (tmpBuffer[len - 1] == '\n');
> -            fwrite(tmpBuffer, len, 1, logFile);
> +            newline = end_line;
> +            fwrite(buf, len, 1, logFile);
>              if (logFlush) {
>                  fflush(logFile);
>  #ifndef WIN32
> @@ -315,13 +298,19 @@ LogVWrite(int verb, const char *f, va_list args)
>                      FatalError("realloc() failed while saving log messages\n");
>              }
>              bufferUnused -= len;
> -            memcpy(saveBuffer + bufferPos, tmpBuffer, len);
> +            memcpy(saveBuffer + bufferPos, buf, len);
>              bufferPos += len;
>          }
>      }
>  }
>
>  void
> +LogVWrite(int verb, const char *f, va_list args)
> +{
> +    return LogVMessageVerb(X_NONE, verb, f, args);
> +}
> +
> +void
>  LogWrite(int verb, const char *f, ...)
>  {
>      va_list args;
> @@ -376,22 +365,28 @@ void
>  LogVMessageVerb(MessageType type, int verb, const char *format, va_list args)
>  {
>      const char *type_str;
> -    char tmpFormat[1024];
> -    const char *new_format;
> +    char buf[1024];
> +    const size_t size = sizeof(buf);
> +    Bool newline;
> +    size_t len = 0;
>
>      type_str = LogMessageTypeVerbString(type, verb);
>      if (!type_str)
>          return;
>
> -    /* if type_str is not "", prepend it and ' ', to format */
> -    if (type_str[0] == '\0')
> -        new_format = format;
> -    else {
> -        new_format = tmpFormat;
> -        snprintf(tmpFormat, sizeof(tmpFormat), "%s %s", type_str, format);
> -    }
> +    /* if type_str is not "", prepend it and ' ', to message */
> +    if (type_str[0] != '\0')
> +        len += Xscnprintf(&buf[len], size - len, "%s ", type_str);
> +
> +    if (size - len > 1)
> +        len += Xvscnprintf(&buf[len], size - len, format, args);
> +
> +    /* Force '\n' at end of truncated line */
> +    if (size - len == 1)
> +        buf[len - 1] = '\n';
>
> -    LogVWrite(verb, new_format, args);
> +    newline = (buf[len - 1] == '\n');
> +    LogSWrite(verb, buf, len, newline);
>  }
>
>  /* Log message with verbosity level specified. */
> @@ -421,31 +416,31 @@ LogVHdrMessageVerb(MessageType type, int verb, const char *msg_format,
>                     va_list msg_args, const char *hdr_format, va_list hdr_args)
>  {
>      const char *type_str;
> -    char tmpFormat[1024];
> -    char *tmpFormat_end = &tmpFormat[sizeof(tmpFormat)];
> -    char *p;
> -    int left;
> +    char buf[1024];
> +    const size_t size = sizeof(buf);
> +    Bool newline;
> +    size_t len = 0;
>
>      type_str = LogMessageTypeVerbString(type, verb);
>      if (!type_str)
>          return;
>
> -    /* if type_str != "", copy it and ' ' to tmpFormat; set p after ' ' */
> -    p = tmpFormat;
> +    /* if type_str is not "", prepend it and ' ', to message */
>      if (type_str[0] != '\0')
> -        p += snprintf(tmpFormat, sizeof(tmpFormat), "%s ", type_str);
> +        len += Xscnprintf(&buf[len], size - len, "%s ", type_str);
> +
> +    if (hdr_format && size - len > 1)
> +        len += Xvscnprintf(&buf[len], size - len, hdr_format, hdr_args);
>
> -    /* append as much of hdr as fits after type_str (if there was one) */
> -    left = tmpFormat_end - p;
> -    if (left > 1)
> -        p += vsnprintf(p, left, hdr_format, hdr_args);
> +    if (msg_format && size - len > 1)
> +        len += Xvscnprintf(&buf[len], size - len, msg_format, msg_args);
>
> -    /* append as much of msg_format as will fit after hdr */
> -    left = tmpFormat_end - p;
> -    if (left > 1)
> -        snprintf(p, left, "%s", msg_format);
> +    /* Force '\n' at end of truncated line */
> +    if (size - len == 1)
> +        buf[len - 1] = '\n';
>
> -    LogVWrite(verb, tmpFormat, msg_args);
> +    newline = (buf[len - 1] == '\n');
> +    LogSWrite(verb, buf, len, newline);
>  }
>
>  void
> --
> 1.7.7.3
>

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/)
patch tracking system | [about patchwork](/help/about/)


