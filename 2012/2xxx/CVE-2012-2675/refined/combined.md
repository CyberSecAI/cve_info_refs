=== Content from www.openwall.com_ac36f5f6_20250125_045347.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2012/06/04/6) [[next>]](2) [[thread-next>]](../../../2012/06/07/9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <36617FD3-6265-4329-9138-6203268449D1@gmail.com>
Date: Tue, 5 Jun 2012 01:54:17 -0400
From: Xi Wang <xi.wang@...il.com>
To: oss-security@...ts.openwall.com
Subject: memory allocator upstream patches

Hi,

I would like to share some upstream patches of two specific types
of memory allocator vulnerabilities.

* malloc(n) size overflow.

Consider the following code pattern.

	n = read_from_input();
	p = malloc(n);
	if (p)
		memcpy(p, input_buffer, n);

Some malloc() implementations internally perform alignment/padding
for a large n, and the allocation size wraps around to a small
integer.  That means they would allocate a smaller buffer than
expected, leading to buffer overflow.

* calloc(n, size) size overflow.

Some calloc() implementations don't check for n * size multiplication
overflow, and would allocate a smaller buffer than expected,
leading to buffer overflow.

The two types of vulnerabilities can be easily reproduced using
malloc(-1) and calloc(BIG-VALUE, BIG-VALUE).  If the return values
are non-null, the implementations are likely to be problematic.

See a more complete list at:

<http://kqueue.org/blog/2012/03/05/memory-allocator-security-revisited/>

Below are some recent upstream fixes.

Boehm-Demers-Weiser GC (libgc)
==============================

malloc() size overflow, upstream patch (revised by the developers):

<https://github.com/ivmai/bdwgc/commit/be9df82919960214ee4b9d3313523bff44fd99e1>

The bug in mallocx.c was found by Ivan Maidanski.

calloc() size overflow, upstream patch (revised by the developers):

<https://github.com/ivmai/bdwgc/commit/e10c1eb9908c2774c16b3148b30d2f3823d66a9a>
<https://github.com/ivmai/bdwgc/commit/6a93f8e5bcad22137f41b6c60a1c7384baaec2b3>
<https://github.com/ivmai/bdwgc/commit/83231d0ab5ed60015797c3d1ad9056295ac3b2bb>

bionic (Android libc)
=====================

malloc() size overflow, upstream patch (revised by the developers):

<https://github.com/android/platform_bionic/commit/7f5aa4f35e23fd37425b3a5041737cdf58f87385>

NB: this vulnerability could only be triggered in debug mode, the
same as CVE-2009-0607, calloc() size overflow.

nedmalloc
=========

malloc() size overflow, upstream patch:

<https://github.com/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000>

calloc() size overflow, upstream patch:

<https://github.com/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1>

Hoard
=====

<http://www.hoard.org/>

malloc() size overflow, confirmed by the developers via email in
this March, no upstream patch available (since 3.8).

calloc() size overflow, which should only happen on non-glibc
platforms (e.g., Mac OS X).  It has not been confirmed by the
developers, but one can easily reproduce it.

boost::pool
===========

ordered_malloc() (similar to calloc()) size overflow, upstream patch:

<https://svn.boost.org/trac/boost/changeset/78326>

- xi
```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_f5f8a67b_20250126_060549.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Commit

[Permalink](/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid overflowing allocation size in calloc()

[Browse files](/ned14/nedmalloc/tree/2965eca30c408c13473c4146a9d47d547d288db1)
Browse the repository at this point in the history

* Loading branch information

[![@xiw](https://avatars.githubusercontent.com/u/801567?s=40&v=4)](/xiw)

[xiw](/ned14/nedmalloc/commits?author=xiw "View all commits by xiw")
committed
Apr 14, 2012

1 parent
[9333e50](/ned14/nedmalloc/commit/9333e50534e64dca1576fc54705613a81c510aa7)

commit 2965eca

Showing
**1 changed file**
with
**6 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

8 changes: 6 additions & 2 deletions

8
[nedmalloc.c](#diff-01b9066e81cc5b2441bd11ec6e2ddbbeb5d7b6bec1c38883124d62587e3dd759 "nedmalloc.c")

Show comments

[View file](/ned14/nedmalloc/blob/2965eca30c408c13473c4146a9d47d547d288db1/nedmalloc.c)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2018,8 +2018,12 @@ NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedpmalloc(nedpool \*p, size\_t size) |
|  |  | } |
|  |  | NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedpcalloc(nedpool \*p, size\_t no, size\_t size) THROWSPEC |
|  |  | { |
|  |  | unsigned flags=NEDMALLOC\_FORCERESERVE(p, 0, no\*size); |
|  |  | return nedpmalloc2(p, size\*no, 0, M2\_ZERO\_MEMORY|flags); |
|  |  | size\_t bytes=no\*size; |
|  |  | /\* Avoid multiplication overflow. \*/ |
|  |  | if(size && no!=bytes/size) |
|  |  | return 0; |
|  |  | unsigned flags=NEDMALLOC\_FORCERESERVE(p, 0, bytes); |
|  |  | return nedpmalloc2(p, bytes, 0, M2\_ZERO\_MEMORY|flags); |
|  |  | } |
|  |  | NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedprealloc(nedpool \*p, void \*mem, size\_t size) THROWSPEC |
|  |  | { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2965eca`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_383a289b_20250125_045349.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fblob%2Fmaster%2FReadme.html)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fblob%2Fmaster%2FReadme.html)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Files

 master
## Breadcrumbs

1. [nedmalloc](/ned14/nedmalloc/tree/master)
/
# Readme.html

Copy path Blame  Blame
## Latest commit

## History

[History](/ned14/nedmalloc/commits/master/Readme.html)706 lines (701 loc) · 44.5 KB master
## Breadcrumbs

1. [nedmalloc](/ned14/nedmalloc/tree/master)
/
# Readme.html

Top
## File metadata and controls

* Code
* Blame

706 lines (701 loc) · 44.5 KB[Raw](https://github.com/ned14/nedmalloc/raw/refs/heads/master/Readme.html)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706﻿<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
<head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><title>nedalloc Readme</title><style type="text/css"><!--body { text-align: justify;}h1, h2, h3, h4, h5, h6 { margin-bottom: -0.5em;}h1 { text-align: center;}h2 { text-decoration: underline; margin-bottom: -0.25em;}p { margin-top: 0.5em; margin-bottom: 0.5em;}ul li, ol li { margin-top: 0.2em; margin-bottom: 0.2em;}dl { margin-left: 2em;}dl dt { font-weight: bold;}dt + dd { margin-bottom: 1em;}.gitcommit { font-family: "Courier New", Courier, monospace; font-size: smaller;}--></style></head>
<body>
<div style="text-align: center"> <h1 style="text-decoration: underline">nedalloc v1.10 beta 4 (?)</h1> <h2 style="text-decoration: none;">by Niall Douglas</h2> <p>Web site: <a href="http://www.nedprod.com/programs/portable/nedmalloc/">http://www.nedprod.com/programs/portable/nedmalloc/</a></p> <p>Trunk build status: <a href="https://travis-ci.org/ned14/nedmalloc"><img style="vertical-align:middle;border:none" src="https://travis-ci.org/ned14/nedmalloc.png?branch=master"/></a></p> <hr /></div><p>Enclosed is nedalloc, an alternative malloc implementation for multiple threads without lock contention based on <a href="http://g.oswego.edu/" target="\_blank">dlmalloc</a> v2.8.4 and a specialised user mode page allocator (Windows Vista or later only). It has the following features:</p><ol> <li>A per-thread small block cache for maximum CPU scalability.</li> <li>A per-thread arena to minimise lock contention.</li> <li>The ability to patch Windows binaries to replace the C memory allocation  API malloc, realloc(), free() et al such that by simply inserting nedmalloc.dll  into a process one realises performance improvements without recompilation.</li> <li>On POSIX, it knows how to talk to valgrind so you can track memory  corruption and/or memory leaks.</li> <li>A unique user mode page allocator implementation which delivers O(1) scaling  for blocks of any size, including an O(1) very fast realloc(). Improves medium  sized block (~1Mb) allocation speeds by about 25 times on current hardware.  Requires Windows Vista or later only, and requires Administrator privileges  as well as either UAC disabled or a UAC prompt at the start of each program  run.</li> <li>A malloc v2 API which enables considerable improvements in efficiency by allowing client code to better inform the allocator on what (not) to do.</li> <li>An enhanced C++ STL allocator implementation to enable super-fast std::vector&lt;&gt; <strong>[unfinished]</strong></li></ol><p>It is licensed under the<a href="http://www.boost.org/LICENSE\_1\_0.txt" target="\_blank">Boost Software License</a> which basically means you can do anything you like with it. This does not apply to the malloc.c.h file which remains copyright to others. Commercial support is available from <a href="http://www.nedproductions.biz/" target="\_blank">ned Productions Limited</a>.</p><p>It has been tested on win32 (x86), win64 (x64), Linux (x64), FreeBSD (x64) and Apple Mac OS X (x86). It works very well on all of these and is very significantly faster than the system allocator on Windows XP and FreeBSD &lt;v7. If you are using &gt;= 10.6 Apple Mac OS X or you are on Windows 7 or later then you probably won&#39;t see much improvement without modifying your source to use the v2 malloc API (and kudos to Apple and Microsoft for adopting excellent allocators).</p><p>The user mode page allocator returns jaw dropping real world performance improvements but requires running the process as the superuser. Without, it still offers sizeable gains on all older operating systems and through the v2 malloc API modest gains on all very recent operating systems, especially in these situations:</p><ol> <li>If you are repeatedly extending large vector arrays, you will see a LARGE  improvement if you use the address space reservation features.</li> <li>If you do a lot of work with 16 byte aligned vectors e.g. SSE or AVX vector  arrays, you will find the v2 malloc API a godsend.</li></ol><p style="text-decoration: underline"><strong>Table of Contents: </strong></p><ol style="list-style-type: upper-alpha; position: relative; margin-top: -0.5em;"> <li><a href="#touse">How to use</a><ul style="list-style-type: none; margin-left: 0; padding-left: 0"> <li>A1. <a href="#CPPAPI">The C++ API</a></li> <li>A2. <a href="#v2mallocAPI">The v2 malloc C API</a></li> </ul> </li> <li><a href="#notes">Notes</a><ul style="list-style-type: none; margin-left: 0; padding-left: 0"> <li>B1. <a href="#memorybloat">Memory Bloating</a></li> <li>B2. <a href="#memoryleaks">Memory Leakage</a></li> <li>B3. <a href="#threadcache">The Threadcache</a></li> <li>B4. <a href="#largepages">Large Page support</a></li> <li>B5. <a href="#logger">Memory operation logging</a></li> <li>B6. <a href="#windowsonly">Windows-only features</a></li> </ul> </li> <li><a href="#speedcomparisons">Speed Comparisons</a></li> <li><a href="#troubleshooting">Troubleshooting</a></li> <li><a href="#changelog">Changelog</a></li></ol><h2><a name="touse">A. To use:</a></h2><p>The quickest way is to drop nedmalloc.h, nedmalloc.c and malloc.c.h into your project. Call nedmalloc(), nedcalloc(), nedrealloc() and nedfree() instead of your normal allocator, or nedpmalloc(), nedpcalloc(), nedprealloc() and nedpfree() if you want to segment your memory usage into pools. Make sure that you call neddisablethreadcache() for every pool you use on thread exit, and don&#39;t forget neddisablethreadcache(0) for the system pool if necessary. Run and enjoy!</p><p>To test, compile <a href="test.c">test.c</a> (C) and <a href="test.cpp">test.cpp</a> (C++). Both will run a comparison between your system allocator and nedalloc and tell you how much faster nedalloc is. They also serve as examples of usage.</p><p>If you&#39;d like nedalloc as a Windows DLL or POSIX ELF shared object, the easiest thing to do is to use <a href="http://www.scons.org/" target="\_blank">scons</a> which comes with a myriad of build options listed using scons -h. <b>If you want to build some MSVC project files for use with Microsoft Visual Studio</b> then what you do is (i) install <a href="http://www.python.org/" target="\_blank">python</a> (ii) install <a href="http://www.scons.org/" target="\_blank">scons</a> (iii) open a Visual Studio Command Box for the Visual Studio you wish to use via Start Menu =&gt; Programs =&gt; Microsoft Visual Studio XXXX =&gt; Visual Studio Tools =&gt; Visual Studio XXXX Command Prompt (iv) change directory to the nedmalloc directory (e.g. by dragging in its folder) (v) type &quot;!MakeMSVCProjs&quot; and hit Return. Note that for Visual Studio 2008 and later support you need scons v2.1 or later.</p><p>nedalloc comes with two new memory allocator APIs: one is for C++, and the other is for C. <strong>Full documentation</strong> for all nedalloc&#39;s APIs and features is provided in the enclosed <a href="nedalloc.chm">nedalloc.chm</a> which is in Microsoft HTML Help format (Linux and Apple Mac OS X will happily read this format too). If you don&#39;t want to use the CHM documentation, <a href="nedmalloc.h">nedmalloc.h</a> is extensively commented with <a href="http://www.doxygen.org/" target="\_blank">doxygen markup</a>.</p><h3><a name="CPPAPI">A1: The C++ API:</a></h3><p>For the v1.10 release which was generously sponsored by<a href="http://www.ara.com/" target="\_blank">Applied Research Associates (USA)</a>, a C++ metaprogrammed STL allocator was designed which makes use of advanced nedalloc features to remedy many of the long standing problems and inefficiencies caused by C++&#39;s traditional over-fondness for copying things. While its implementation is complex, usage is extremely easy - simply supply nedallocator&lt;&gt; as the custom allocator to STL container classes.</p><p>As nedmalloc can do even better for vector extension, nedmalloc.h also contains a nedvector&lt;&gt; implementation which is the standard STL vector&lt;&gt; implementation except that it makes use of the non-relocating facilities of realloc2() (see below). This allows nedvector&lt;&gt; to not need to overallocate memory (most STL vector&lt;&gt; implementations will overallocate by 50%) which saves a lot of memory as well as <strong>completely avoiding array copy construction</strong> which make std::vector&lt;&gt;::resize() so very, very slow.</p><p>Even without nedalloc&#39;s major speed improvements as a simple C style allocator, the improvements to the C++ memory infrastructure alone can generate huge performance gains.</p><h3><a name="v2mallocAPI">A2: The v2 malloc C API:</a></h3><p><strong>[Note: This API will be completely replaced in v1.2]</strong></p><p>For the v1.10 release which was generously sponsored by<a href="http://www.ara.com/" target="\_blank">Applied Research Associates (USA)</a>, a new general purpose allocator API was designed which is intended to remedy many of the long standing problems and inefficiencies introduced by the ISO C allocator API. Internally nedalloc&#39;s implementations of nedmalloc(), nedcalloc(), nedmemalign() and nedrealloc() all call into this API:</p><ul> <li><code>void\* malloc2(size\_t bytes, size\_t alignment, unsigned flags)</code></li> <li><code>void\* realloc2(void\* mem, size\_t bytes, size\_t alignment, unsigned  flags)</code></li></ul><p>If nedmalloc.h is being included by C++ code, the alignment and flags parameters default to zero which makes the new API identical to the old API (roll on the introduction of default parameters to C!). The ability for realloc2() to take an alignment is<em>particularly</em> useful for extending aligned vector arrays such as SSE/AVX vector arrays. Hitherto SSE/AVX vector code had to jump through all sorts of unpleasant hoops to maintain alignment during array extension :(.</p><p>The flags supported include the ability to zero memory, to prevent realloc2() from moving a memory block, to force mmap() to be used from the beginning (useful when you know an array will be repeatedly extended) and to cause malloc2() to reserve additional address space after the allocation such that a realloc2() up to that reserved space will be very quick. On 32 bit Windows and Linux this reservation costs no address space in your process, so using it will NOT cause premature address space exhaustion.</p><p>You should note that realloc()&#39;s thunk to realloc2() defaults the flags to M2\_RESERVE\_MULT(8) i.e. if realloc() needs to allocate a block larger than mmap\_threshold, it will also reserve eight times the address space of that allocation in order to make future realloc()&#39;s up to that point much faster. This catches the vast majority of situations where large arrays are repeatedly extended.</p><h2><a name="notes">B. Notes:</a></h2><p>If you want the very latest version of this allocator, get it from the TnFOX GIT repository at either of (both are identical mirrors):</p><ul> <li> <a href="git://nedmalloc.git.sourceforge.net/gitroot/nedmalloc/nedmalloc">git://nedmalloc.git.sourceforge.net/gitroot/nedmalloc/nedmalloc</a></li> <li><a href="git://github.com/ned14/nedmalloc.git">git://github.com/ned14/nedmalloc.git</a></li></ul><p>IF YOU THINK YOU HAVE FOUND A BUG, PLEASE CHECK ONE OF THESE REPOS FIRST BEFORE REPORTING IT!</p><h3><a name="memorybloat">B1: Memory Bloating</a></h3><p>Because of how nedalloc allocates an mspace per thread, it <em>can</em> cause severe bloating of memory usage under certain allocation patterns. You can substantially reduce this wastage by setting DEFAULTMAXTHREADSINPOOL or the threads parameter to nedcreatepool() to a fraction of the number of threads which would normally be in a pool at once. This will reduce bloating at the cost of an increase in lock contention, with DEFAULTMAXTHREADSINPOOL=1 removing almost all bloating. If the block sizes typically allocated are less than THREADCACHEMAX, locking is avoided 90-99% of the time and if most of your allocations are below this value, you can safely set DEFAULTMAXTHREADSINPOOL or even MAXTHREADSINPOOL to one.</p><p>If you have LOTS of threads you may find that the threadcache held per thread is causing memory bloating. You can call nedtrimthreadcache() to trim the cache in a thread when you know that it won&#39;t be doing memory allocation (e.g. just before going to sleep), or alternatively you can set THREADCACHEMAXFREESPACE to something smaller than its default of 1Mb.</p><p>Lastly, some people find that memory is not returned to the system when they think it ought to be. dlmalloc only returns free memory to the system when there is DEFAULT\_TRIM\_THRESHOLD (default=2Mb) free in a mspace, and it only checks how much there is free outside the topmost segment every MAX\_RELEASE\_CHECK\_RATE free()&#39;s. In other words, if your program very rapidly deallocates an awful lot of memory and then does not call free() for some time thereafter, dlmalloc will not release memory to the system. Generally in any real world code scenario free() will be called fairly frequently, and if not then you can always force release using nedmalloc\_trim().</p><h3><a name="memoryleaks">B2: Memory Leakage</a></h3><p>You will suffer memory leakage unless you call neddisablethreadcache() per pool for every thread which exits (unless you are using nedalloc from its DLL on Windows). This is because nedalloc cannot portably know when a thread exits and thus when its thread cache can be returned for use by other code. Don&#39;t forget pool zero, the system pool. On some POSIX threads implementations there exists a pthread\_atexit() which registers a termination handler for thread exit - if you don&#39;t have one of these then you&#39;ll have to do it manually.</p><p>Equally if you use nedalloc from a dynamically loaded DLL or shared object which you later kick out of memory, you will leak memory if you don&#39;t disable all thread caches for all pools (as per the preceding paragraph), destroy all thread pools using neddestroypool() and destroy the system pool using neddestroysyspool().</p><h3><a name="threadcache">B3: The Threadcache</a></h3><p>For C++ type allocation patterns (where the same small sizes of memory are regularly allocated and deallocated as objects are created and destroyed), the threadcache always benefits performance as it will cache all malloc/free allocations under THREADCACHEMAX in size. If however your allocation patterns are different, searching the threadcache may significantly slow down your code - as a rule of thumb, if cache utilisation is below 80% (see the source for neddisablethreadcache() for how to enable debug printing in release mode) then you should disable the thread cache for that thread. You can compile out the threadcache code by setting THREADCACHEMAX to zero.</p><h3><a name="largepages">B4: Large Page support</a></h3><p>For some applications defining ENABLE\_LARGE\_PAGES can give a 10-15% performance increase by having nedalloc allocate using large pages only (which are 2Mb on x86/x64). Large pages take much less space in the TLB cache and can greatly benefit programs with a large working set, particularly on 64 bit systems.</p><p>Support for large pages is limited to Linux and Windows. On Linux one must employ the libhugetlbfs library anyway as this is the &quot;official&quot; form of large page support, and setting it up and configuring it involves mounting a special hugetlbfs filing system. dlmalloc does not require a dependency on the libhugetlbfs headers, rather it searches for the library in the current process and if not found it silently disables support.</p><p>On Windows, large page support is only implemented on Windows Server 2003/Vista or later and they are only permitted to be allocated by users holding the &quot;Lock pages in memory&quot; local security setting which is DISABLED by default. Furthermore, the process using nedalloc must hold the SeLockMemoryPrivilege privilege. If you are using the DLL then the DLL attempts to enable the SeLockMemoryPrivilege during initialisation - therefore if you are not using the DLL you will have to do this manually yourself. As with Linux support, if at any stage large pages cannot be allocated, then dlmalloc silently disables support - this allows one binary to function correctly in any environment. <strong>Note that on Windows</strong> if your process allocates a lot of memory at once when the machine has been running for an extended period, then the whole computer may hang for several seconds as the Windows kernel copies memory around in order to coalesce a large page. This is a problem with the Windows kernel and its VM design, not nedmalloc! If you would like to see how large pages ought to be implemented, research how FreeBSD implemented them.</p><h3><a name="logger">B5: Memory operation logging</a></h3><p>It is often very useful to have a log of the memory operations which an application performs - you would be amazed at the inefficiencies in memory usage that this can reveal. nedalloc contains a very fast memory operation logger which keeps a per-thread log of selected operations, including an optional stack backtrace. On pool destruction, or nedflushlogs(), nedalloc will write out the log as a Comma Separated Value format file which can be loaded into applications such as Excel for analysis.</p><p>To use, define ENABLE\_LOGGING to the bitmask of enum LogEntryType items in which you are interested, so 0xffffffff would log absolutely everything. The macro NEDMALLOC\_TESTLOGENTRY, whose default is (ENABLE\_LOGGING &amp; logentrytype), is then used to determine which items should be logged. You can also enable stack backtracing on MSVC and GCC using NEDMALLOC\_STACKBACKTRACEDEPTH.</p><h3><a name="windowsonly">B6: Windows-only features</a></h3><p>If you are running on Windows, there are quite a few extra options available thanks to work generously sponsored by<a href="http://www.ara.com/" target="\_blank">Applied Research Associates (USA)</a>:</p><dl> <dt>Automatic threadcache cleanup and log output</dt> <dd>If you build nedalloc as a DLL and link that into your application, then  the DLL can trap thread exits in your application and call neddisablethreadcache()  on all currently existing nedpool&#39;s for you. On process exit, the DLL will also  call nedflushlogs() for you on all still extant nedpool&#39;s.</dd> <dt>Replacing the system allocator in the whole process</dt> <dd> <p>If you define REPLACE\_SYSTEM\_ALLOCATOR when building the DLL then the DLL  will replace <em>most</em> usage of the MSVCRT allocator (release MSVCRT,<strong>  not</strong> debug MSVCRTD)<strong> </strong>within any process it is loaded  into with nedalloc&#39;s routines instead, whilst remaining able to handle the odd  free() of a MSVCRT allocated block allocated during CRT init. This very conveniently  allows you to simply link with the nedalloc DLL and your application magically  now uses it with no code changes required, and because the MSVC implementation  of operators new and delete both call malloc() and free() it also covers all  C++ code. The following code is suggested:</p> <code>#pragma comment(lib, &quot;nedmalloc.lib&quot;)</code> <p>This asks the linker to link against nedmalloc.lib during linking - without  this pragma the linker will generally leave out nedmalloc as there are no explicitly  imported routines that it understands. This auto-patching feature can also be  combined with <a href="http://research.microsoft.com/en-us/projects/detours/" target="\_blank"> Microsoft&#39;s Detours</a> to run any arbitrary application using nedalloc instead  of the system allocator:</p> <code>withdll /d:nedmalloc.dll program.exe</code> <p>For those not able to use Microsoft Detours, there is an enclosed unsupported/nedmalloc\_loader  program which does one variant of the same thing. It may or may not be useful  to you - it is not intended to be maintained, and it probably doesn&#39;t work on  newer systems.</p> <p>The reason that only the release MSVCRT not the debug MSVCRTD is patched  is twofold: (i) usually one <em>wants</em> the debug heap in debug builds so  it does memory corruption checking and reports memory leaks and (ii) the MSVC  CRT actually implements operator new and malloc using a completely different  implementation based on the Windows kernel HeapAlloc() function and it does  a lot of hoop jumping to handle mismatching CRT versions and lots of other stuff.  You can enable patching of the debug memory allocation functions in winpatcher.c  by uncommenting the relevant lines.</p> </dd> <dt>User mode page allocation</dt> <dd>The user mode page allocator is a user space implementation of kernel memory  page allocation made possible by misusing the Address Windowing Extensions (AWE)  provided by newer versions of Microsoft Windows. AWE allows - with a bit of  persuasion - direct control of the Memory Management Unit of the CPU, thus allowing  memory pages to be arbitrarily remapped from one address to another. The user  mode page allocator can therefore allocate memory in microseconds by simply  mapping it into where it needs to be, or it can realloc() gigabytes of memory  from its old location into a new bigger space in microseconds. This O(1) scaling  gives processes running on the user mode page allocator an <strong>unholy</strong>  speed increase which gets exponentially better the larger the data set.<br /> <br /> Want to know more in lots of detail? Here are two academic papers on the topic: <ol> <li>Douglas, N, (2011-May), '<a href="http://arxiv.org/abs/1105.1815">User Mode Memory Page Management: An old idea applied anew to the memory wall problem</a>', ArXiv e-prints, vol: 1105.1815.</li> <li>Douglas, N, (2011-May), '<a href="http://arxiv.org/abs/1105.1811">User Mode Memory Page Allocation: A Silver Bullet For Memory Allocation?</a>', ArXiv e-prints, vol: 1105.1811.</li> </ol> </dd></dl><h2><a name="speedcomparisons">C. Speed comparisons:</a></h2><p>See Benchmarks.xls for details.</p><p>The enclosed test.c can do one of two things: it can be a torture test which mostly hammers realloc() or it can be a pure speed test which sticks to simple malloc() and free(). If you enable C++ mode, half of the allocation sizes will be a two power multiple less than 512 bytes (to mimic C++ stack instantiated objects) which are extremely common in C++ code.</p><p>The torture test is designed to mercilessly work realloc() which is the most complex and complete code path in any memory allocator. Most allocators have<strong>very</strong> poor realloc() performance - not so nedalloc which makes use of mremap() support on Linux and Windows. Even without mremap() support nedalloc&#39;s realloc() tends to be significantly faster than any standard allocator.</p><p>The speed test is designed to be a representative synthetic memory allocator test where most allocations follow a stack pattern. It works by randomly mixing allocations with frees with sizes being a random value less than 16Kb. </p><p>The C++ test.cpp simply benchmarks how much difference nedalloc::nedallocatorise&lt;&gt; makes to std::vector&lt;&gt; performance, particularly the performance of push\_back(), pop\_back() and vector assignment all of which are very common in real world code. As you will see, the STL - even with C++0x move constructor support - does not perform anywhere close to nedalloc&#39;s version which achieves its gains by simply avoiding copy and move construction completely.</p><p>The real world code results are from Tn&#39;s TestIO benchmark. This is a heavily multithreaded and memory intensive benchmark with a lot of branching and other stuff modern processors don&#39;t like so much. As you&#39;ll note, the test doesn&#39;t show the benefits of the threadcache mostly due to the saturation of the memory bus being the limiting factor.</p><h2><a name="troubleshooting">D. Troubleshooting:</a></h2><p>I get a quite a few bug reports about code not working properly under nedalloc. I do not wish to sound presumptuous, however in an overwhelming majority of cases the problem is in your application code and not nedalloc (see below for all the bugs reported and fixed since 2006). Some of the largest corporations and IT deployments in the world use nedalloc pre-v1.10, and pre-v1.10 has been very heavily stress tested on everything from 32 processor SMP clusters right through to root DNS servers, ATM machine networks and embedded operating systems requiring a very high uptime. The v1.10 release adds a LOT of new code and features, and hence there are quite likely a lot of new bugs in the new code.</p><p>In particular, just because it just happens to appear to work under the system allocator does not mean that your application is not riddled with memory corruption and non-ANSI usage of the API! And usually<strong> this is not your code&#39;s fault, but rather it is usually the third party libraries being used which sadly often include system libraries</strong>.</p><p>Even though debugging an application for memory errors is a true black art made possible only with a great deal of patience, intuition and skill, here is a checklist for things to do before reporting a bug in nedalloc:</p><ol> <li>Make SURE you try nedalloc from GIT HEAD. For around six months of 2007  I kept getting the same report of a bug long fixed in GIT HEAD.</li> <li>Make SURE you try nedalloc v1.06. If it works in v1.06 but isn&#39;t working  in nedalloc &gt;= v1.10, then it&#39;s probably a bug in the new code (please report  it to me!)</li> <li>Make use of nedalloc&#39;s internal debug routines. Try turning on full sanity  checks by #define FULLSANITYCHECKS 1. Also make use of all the assertion checking  performed when DEBUG is defined as 1. A lot of bug reports are made before running  under a debug build where an assertion trip clearly showed the problem. Lastly,  try changing the thread cache by #defining THREADCACHEMAX - this fundamentally  changes how the memory allocator behaves: if everything is fine with the thread  cache fully on or fully off, then this strongly suggests the source of your  problem.</li> <li>Make SURE you are matching allocations and frees belonging to nedalloc if  you are not defining REPLACE\_SYSTEM\_ALLOCATOR. Attempting to free a block not  allocated by nedalloc will end badly, similarly passing one of nedalloc&#39;s blocks  to another allocator will likely also end badly. I have inserted as many assertion  and debug checks for this possibility as I can think of (further suggestions  are welcome), but no system can ever be watertight. If you&#39;re using C++, make  use of the C++ nedallocatorise API provided or else use some form of strong  template type system to have the compiler guarantee membership of a memory pointer  - see <a href="http://www.boost.org/" target="\_blank">the Boost libraries</a>,  or indeed <a href="http://www.nedprod.com/TnFOX/" target="\_blank">my own TnFOX  portability toolkit</a>.</li> <li>If you&#39;re still having problems, or more likely your code runs absolutely  fine under debug builds but trips up under release which suggests a timing bug,  it is time to deploy heavyweight tools. Under Linux, you should use <a href="http://valgrind.org/" target="\_blank">valgrind</a>. Under Windows,  there is an excellent commercial tool called <a href="http://www.glowcode.com/" target="\_blank">Glowcode</a>. Any programming  team serious on quality should ALWAYS run their projects through these tools  before each and every release anyway - you would be amazed at what you miss  during all other testing.</li> <li>Lastly, in the worst case scenario, consider hiring in a memory debugging  expert. There are quite a few on the market and they often are authors of memory  allocators. <a href="http://www.malloc.de/en/" target="\_blank">Wolfram Gloger  (the author of ptmalloc) provides consulting services</a>. <a href="http://www.nedproductions.biz/" target="\_blank">My own consulting company  ned Productions Limited</a> may be able to provide such a service depending  on our current workload.</li></ol><p>I hope that these tips help. And I urge anyone considering simply dropping back to the system allocator as a quick fix to reconsider: squashing memory bugs often brings with it <strong>significant</strong> extra benefits in performance and reliability. It may cost what appears to be a lot extra now, but it usually will save itself many times its cost over the next few years. I know of one large multinational corporation who <strong>saved hundreds of millions of dollars</strong> due to the debugging of their system software performed when trying to get it working with nedalloc - they found one bug in nedalloc but over a hundred in their own code, and in the process improved performance <strong>threefold</strong> which saved an expensive hardware upgrade and deployment. The conclusion can only be that fixing memory bugs now tends to be worth it in the long run.</p><h2><a name="changelog">E. ChangeLog:</a></h2><h3>v1.10 beta 4 ?:</h3><ul> <li><span class="gitcommit">[master 726d9c7]</span> Fixed memory corruption introduced when creating more than two nedpool's (issue #7). Thanks to mxmauro for reporting this.</li> <li><span class="gitcommit">[master c191ea9]</span> Merged dlmalloc v2.8.6.</li> <li><span class="gitcommit">[master 06f1c70]</span> Added support for clang,  plus fixed up some compile errors in C++11.</li> <li><span class="gitcommit">[master 8f8256c]</span> Added support for  valgrind instrumentation so valgrind can track programs using nedmalloc.</li> <li><span class="gitcommit">[master 69825ca]</span> Fixed issue #8 where  memory allocated via the independent\_\*() functions was being incorrectly  identified as system allocated. Thanks to Geri for reporting this.</li> <li><span class="gitcommit">[master a6a0dec]</span> Fixed issue #10 where  a failure to allocate memory on POSIX was not being trapped correctly. Thanks to btaudul for reporting this.</li> <li><span class="gitcommit">[master a559f9e]</span> Fixed issue #12 where  RTLD\_DEFAULT was undefined. Replaced this code entirely with new code which parses /proc/meminfo for huge page size. Thanks to Geri for reporting this.</li> <li><span class="gitcommit">[master 9119158]</span> Added Travis CI build bot support to nedalloc, testing gcc, clang and clang static analyser.</li> <li><span class="gitcommit">[master xxxxxxx]</span> Fixed issue #14 where  nedalloc was using is\_pod&lt;&gt; instead of is\_trivially\_copyable&lt;&gt;. Thanks to JustSid for reporting this.</li></ul><h3>v1.10 beta 3 17th July 2012:</h3><ul> <li><span class="gitcommit">[master 5f26c1a]</span> Due to a bug introduced in sha 7a9dd5c (17th April 2010), nedmalloc has never allocated more than a single mspace when using the system pool. This effectively had disabled concurrency for any allocation &gt; THREADCACHEMAX (8Kb) which no doubt made nedmalloc v1.10 betas 1 and 2 appear no faster than system allocators. My thanks to the eagle eyes of Gavin Lambert for spotting this.</li></ul><h3>v1.10 beta 2 10th July 2012:</h3><ul> <li><span class="gitcommit">[master 51ab2a2]</span> scons now tests for C++0x support before turning it on and tries multiple libraries for clock\_gettime() rather than assuming it lives in librt. This ought to fix miscompilation on Mac OS X. Thanks to Robert D. Blanchet Jr. for reporting this.</li> <li><span class="gitcommit">[master b2c3517]</span> Mac defines malloc\_size to be const void \*ptr, not void \*ptr</li> <li><span class="gitcommit">[master 9333e50]</span> Updated to use the new O(1) Cfind(rounds=1) feature in nedtries</li> <li><span class="gitcommit">[master 54c7e44]</span> Avoid overflowing allocation size. Thanks to Xi Wang for supplying a patch fixing this.</li> <li><span class="gitcommit">[master 5b614a0]</span> Removed \_\_try1 and \_\_finally1 from MinGW support as x64 target no longer supports SEH. Thanks to Geri for reporting this.</li> <li><span class="gitcommit">[master 48f1aa9]</span> Tidied up bitrot which  had broken compilation due to mismatched #if...#endif.</li></ul><h3>v1.10 beta 1 19th May 2011:</h3><ul> <li><span class="gitcommit">[master 89f1806]</span> Moved from SVN to GIT. Bumped  version to v1.10 as new ARA contract will involve significant further improvements  mainly centering around realloc() performance.</li> <li><span class="gitcommit">[master 254fe7c]</span> Added nedmemsize() for API  compatibility with other allocators. Added DEFAULTMAXTHREADSINPOOL and set it  to FOUR which is a BREAKING CHANGE from previous versions of nedalloc (which  set it to 16).</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 97d1420]</span> Added win32mremap()  implementation.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 8a1001e]</span> Significantly  improved test.c with new test options TESTCPLUSPLUS, BLOCKSIZE, TESTTYPE and  MAXMEMORY.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 7ea606d]</span> Implemented  two variants of direct mremap() on Windows, one using file mappings and the  other using over-reservation. The former is used on 32 bit and the latter on  64 bit.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 26ff9a7]</span> Added the  malloc2() interface to nedalloc.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 5bc5d97]</span> Rewrote  Readme.txt to become Readme.html which makes it much clearer to read.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc 2efa595]</span> Added doxygen  markup to nedmalloc.h and a first go at a policy driven STL allocator class.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc d851bde]</span> Added a  CHM documenting the nedalloc API.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc dbd3991]</span> Added a  fast malloc operations logger which outputs a CSV log on process exit.</li> <li><span class="gitcommit">[nedmalloc\_fast\_realloc d6a8585]</span> Added stack  backtracing to the logger.</li> <li><span class="gitcommit">[master c7ea06d]</span> Finished user mode page  allocator, so merged nedmalloc\_fast\_realloc branch.</li> <li><span class="gitcommit">[master 9a8800f]</span> Fixed small bug which was  preventing the windows patcher from correctly finding the proper MSVCRT.</li> <li><span class="gitcommit">[master 37c58b1]</span> Fixed leak of mutexes when  using pthread or win32 mutexs as locks. Thanks to Gavin Lambert for reporting  this.</li> <li><span class="gitcommit">[master f67e284]</span> Fixed nedflushlogs() not  actually flushing data and/or causing a segfault. Thanks to Roman Tatkin for  reporting this.</li> <li><span class="gitcommit">[master 1324bf3]</span> Finally got round to retiring  the MSVC project files as they were sources of never ending hassle due to being  out of sync with the SConstruct config. Rebuilt scons build system to be fully  compatible with MSVC instead (long overdue!)</li> <li><span class="gitcommit">[master 068494e]</span> As the release of v1.10  RC1 approaches, fixed a long standing problem with the binary patcher where  multiple MSVCRT versions in the process weren&#39;t handled - everything was sent  to one MSVCRT only, and needless to say that sorta worked sometimes and sometimes  not. Now when nedmalloc passes a foreign block to the system allocator, it runs  a stack backtrace to figure out what MSVCRT in the process it ought to pass  it to. It&#39;s slow, but fixes a very common segfault on process exit on VS2010.</li> <li><span class="gitcommit">[master 4cca52c]</span> Very embarrassingly, nedmalloc  has been severely but unpredictably broken on POSIX for over a year now when built with DEBUG defined.  This was turning on DEFAULT\_GRANULARITY\_ALIGNED whose POSIX implementation  was causing random segfaults so mysterious that neither gdb nor valgrind  could pick them up - in other words, the very worst kind of memory  corruption: undetectable, untraceable and undebuggable. I only found them  myself due to a recent bug report for TnFOX on POSIX where due to luck, very  recent Linux kernels just happened by pure accident to cause this bug to  manifest itself as preventing process init right at the very start - so  early that no debugger could attach. After over a week of trial &amp; error I  narrowed it down to being somewhere in nedmalloc, then having something to  do with DEBUG being defined or not, then two hours ago the eureka moment  arrived and I quite literally did a jig around the room in joy. Problem is  now fixed thank the heavens!!!</li> <li><span class="gitcommit">[master 3d55a01]</span> Fixed a problem where the binary patcher was early outing too soon and therefore failing to patch all the binaries properly. It would seem that the Microsoft linker doesn't sort the import table like I had thought it did - I would guess it sorts per DLL location, otherwise is unsorted. Thanks to Roman Tatkin for reporting this bug.</li> <li><span class="gitcommit">[master 6c74071]</span> Added override of \_GNU\_SOURCE for when HAVE\_MREMAP is auto-detected. Thanks to Maxim Zakharov for reporting this issue.</li> <li><span class="gitcommit">[master dee2d27]</span> Marked off the v2 malloc API as deprecated in preparation for beta release. Updated CHM documentation.</li></ul><h3>v1.06 beta 2 21st March 2010:</h3><ul> <li>{ 1153 } Added detection of whether host process is using MSVCRT or MSVCRTD  and the fixing up of which runtime tolerant nedalloc should use if nedalloc  was linked differently. This ought to save a great deal of hassle later on by  preventing failed-to-RTM user bug reports :)</li> <li>{ 1154 } Fixed nedalloc trying to use MLOCK\_T even when USE\_LOCKS=0. Thanks  to Ariel Manzur for reporting this.</li> <li>{ 1155 } Fixed USE\_SPIN\_LOCKS=0 not compiling on Windows.</li> <li>{ 1157 } Fixed bug where foreign blocks entering the threadcache weren&#39;t  being marked as such, thus typically causing a segfault on process exit.</li> <li>{ 1158 } Fixed compilation problems on mingw. Thanks to Amanieu d&#39;Antras  for reporting these.</li> <li>{ 1159 } Released as beta2.</li></ul><h3>v1.06 beta 1 13th January 2010:</h3><ul> <li>{ 1079 } Fixed misdeclaration of struct mallinfo as C++ type. Thanks to  James Mansion for reporting this.</li> <li>{ 1082 } Fixed dlmalloc bug which caused header corruption to mmap() allocations  when running under multiple threads.</li> <li>{ 1088 } Fixed assertion failure for nedblksize() with latest dlmalloc.  Thanks to Anteru for reporting this.</li> <li>{ 1088 } Added neddestroysyspool(). Thanks to Lars Wehmeyer for suggesting  this.</li> <li>{ 1088 } Fixed thread id high bit set bug causing SIGABRT on Mac OS X. Thanks  to Chris Dillman for reporting this.</li> <li>{ 1094 } Integrated dlmalloc v2.8.4 final.</li> <li>{ 1095 } Added nedtrimthreadcache(). Thanks to Hayim Hendeles for suggesting  this.</li> <li>{ 1095 } Fixed silly assertion of null pointer dereference. Thanks to Ullrich  Heinemann for reporting this.</li> <li>{ 1096 } Fixed lots of level 4 warnings on MSVC. Thanks to Anteru for suggesting  this.</li> <li>{ 1098 } Improved non-nedalloc block detection to 6.25% probability of being  wrong. Thanks to Applied Research Associates for sponsoring this.</li> <li>{ 1099 } Added USE\_MAGIC\_HEADERS which allows nedalloc to handle freeing  a system allocated block. Added USE\_ALLOCATOR which allows the changing of which  backend allocator to use (with choices between the system allocator and dlmalloc  - choosing the system allocator is intended for debug situations only e.g. valgrind).  Thanks to Applied Research Associates for sponsoring this.</li> <li>{ 1105 } Added ability to build nedalloc as a DLL. Added support for a run  time PE binary patcher which can patch all usage of the system allocator replacing  it with nedalloc. Thanks to Applied Research Associates for sponsoring this.</li> <li>{ 1108 } Added patcher loader which can load any arbitrary program injecting  the nedalloc DLL which then patches in its replacement for the system allocator.  Doesn&#39;t work on all programs, but does on most e.g. Microsoft Word. Thanks to  Applied Research Associates for sponsoring this.</li> <li>{ 1116 } Finished debugging and optimising the latest additions to the codebase.  The patcher now works well on x64 as well as x86. Added support for large pages  on Windows. Thanks to Applied Research Associates for sponsoring this.</li> <li>{ 1125 } Added nedpoollist() which returns a snapshot of the nedpool&#39;s currently  existing. The Windows DLL thread exit code now disables the thread cache for  all currently existing nedpool&#39;s. Thanks to Applied Research Associates for  sponsoring this.</li> <li>{ 1126 } Added ENABLE\_TOLERANT\_NEDMALLOC which allows nedalloc to recognise  system allocator blocks and to do the right thing with them.</li> <li>{ 1139 } Added link time code generation support for Windows builds. This  currently has zero performance improvement on x64 (on MSVC9) but can add 15%  to x86 performance (on MSVC9). Also added scons SConstruct and SConscript files.</li></ul><h3>v1.05 15th June 2008:</h3><ul> <li>{ 1042 } Added error check for TLSSET() and TLSFREE() macros. Thanks to  Markus Elfring for reporting this.</li> <li>{ 1043 } Fixed a segfault when freeing memory allocated using nedindependent\_comalloc().  Thanks to Pavel Vozenilek for reporting this.</li></ul><h3>v1.04 14th July 2007:</h3><ul> <li>Fixed a bug with the new optimised implementation that failed to lock on  a realloc under certain conditions.</li> <li>Fixed lack of thread synchronisation in InitPool() causing pool corruption.</li> <li>Fixed a memory leak of thread cache contents on disabling. Thanks to Earl  Chew for reporting this.</li> <li>Added a sanity check for freed blocks being valid.</li> <li>Reworked test.c into being a torture test.</li> <li>Fixed GCC assembler optimisation misspecification.</li></ul><h3>v1.04alpha\_svn915 7th October 2006:</h3><ul> <li>Fixed failure to unlock thread cache list if allocating a new list failed.  Thanks to Dmitry Chichkov for reporting this. Futher thanks to Aleksey Sanin.</li> <li>Fixed realloc(0, &lt;size&gt;) segfaulting. Thanks to Dmitry Chichkov for reporting  this.</li> <li>Made config defines #ifndef so they can be overriden by the build system.  Thanks to Aleksey Sanin for suggesting this.</li> <li>Fixed deadlock in nedprealloc() due to unnecessary locking of preferred  thread mspace when mspace\_realloc() always uses the original block&#39;s mspace  anyway. Thanks to Aleksey Sanin for reporting this.</li> <li>Made some speed improvements by hacking mspace\_malloc() to no longer lock  its mspace, thus allowing the recursive mutex implementation to be removed with  an associated speed increase. Thanks to Aleksey Sanin for suggesting this.</li> <li>Fixed a bug where allocating mspaces overran its max limit. Thanks to Aleksey  Sanin for reporting this.</li></ul><h3>v1.03 10th July 2006:</h3><ul> <li>Fixed memory corruption bug in threadcache code which only appeared with  &gt;4 threads and in heavy use of the threadcache.</li></ul><h3>v1.02 15th May 2006:</h3><ul> <li>Integrated dlmalloc v2.8.4, fixing the win32 memory release problem and  improving performance still further. Speed is now up to twice the speed of v1.01  (average is 67% faster).</li> <li>Fixed win32 critical section implementation. Thanks to Pavel Kuznetsov for  reporting this.</li> <li>Wasn&#39;t locking mspace if all mspaces were locked. Thanks to Pavel Kuznetsov  for reporting this.</li> <li>Added Apple Mac OS X support.</li></ul><h3>v1.01 24th February 2006:</h3><ul> <li>Fixed multiprocessor scaling problems by removing sources of cache sloshing.</li> <li>Earl Chew &lt;earl\_chew &lt;at&gt; agilent &lt;dot&gt; com&gt; sent patches for the following: <ol> <li>size2binidx() wasn&#39;t working for default code path (non x86).</li> <li>Fixed failure to release mspace lock under certain circumstances which  caused a deadlock.</li> </ol> </li></ul><h3>v1.00 1st January 2006:</h3><ul> <li>First release</li></ul>
</body>
</html>

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from kqueue.org_0b37f494_20250125_045347.html ===

[kqueue.org](/)

[About](/about/)

# Memory allocator security revisited

Mar 5, 2012
•
Xi Wang

C/C++ 101:

* What does `malloc(n)` return if `n` is a big number (e.g., `-1` or `SIZE_MAX`)?
* What does `calloc(n, size)` return if `n` and `size` are big numbers?
* What does `new T[n]` return if `n` is a big number (assuming `-fno-exception`)?

I believe everyone expects the answer `NULL` for all the questions,
as `NULL` is used to indicate out of memory.
Unfortunately, in reality many memory allocators break (or used to
break) these expectations, which could lead to memory corruption and
security vulnerabilities, especially if the allocation size
can be controlled by an adversary.

Here goes a summary of some known and unknown vulnerabilities
(notably multiplication, rounding, and pointer overflows)
in popular memory allocators.

## GLIBC malloc

An infamous multiplication overflow used to exist in the `calloc`
implementation in GNU libc and Microsoft’s C runtime, as detailed
in
[RUS-CERT Advisory 2002-08:02](https://seclists.org/bugtraq/2002/Aug/91).
This overflow vulnerability can be easily misused to mount buffer
overflow attacks. It was
[fixed](http://sourceware.org/git/?p=glibc.git;a=commit;h=0950889b810736fe7ad340a13a5ecf76672e1a84)
in GLIBC in 2002.

## Hoard

I cannot find the revision log of the [Hoard](http://www.hoard.org/)
allocator, so it’s hard to say what vulnerabilities it used to have.
Though it’s easy to exploit the current version (3.8) via a rounding
overflow. Below is the buggy code snippet in `tlab.h`.

```
// ThreadLocalAllocationBuffer::malloc(size_t sz)
sz = align (sz); // (sz + (sizeof(double) - 1)) & ~(sizeof(double) - 1);
// Get memory from the local heap,
// and deduct that amount from the local heap bytes counter.
if (sz <= LargestObject) {
  int c = getSizeClass (sz);
  void * ptr = _localHeap(c).get();
  if (ptr) {
    assert (_localHeapBytes >= sz);
    _localHeapBytes -= sz;
    assert (getSize(ptr) >= sz);
    return ptr;
  }
}

```

When `sz` is `(size_t)-1`, a big value, the `align` call overflows
and rounds `sz` up to 0. Thus, `malloc(-1)` is basically `malloc(0)`,
which could lead to a buffer overflow.

Hoard’s `calloc` implementation is also vulnerable to multiplication
overflow. With glibc Hoard is injected via `__malloc_hook`,
and its `calloc` won’t be used. However, the vulnerability can
be triggered on platforms that do not use glibc, such as Mac OS X.

## jemalloc

The [jemalloc](http://www.canonware.com/jemalloc/) allocator is
used by the libc of FreeBSD and NetBSD, as well as Mozilla Firefox.

It used to have the `calloc` multiplication overflow vulnerability.
The bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=161263) in 2006.

A rounding overflow bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=167872)
in 2007.

Another interesting signedness bug was
[fixed](http://svnweb.freebsd.org/base?diff_format=l&view=revision&revision=178645)
in 2008. Below is the simplified code snippet in `jemalloc.c`.

```
/* chunk_alloc_dss(size_t size) */
/* assert(size != 0);                    */
/* assert((size & chunksize_mask) == 0); */
intptr_t incr;
void *ret;

/* Get the current end of the DSS. */
dss_max = sbrk(0);

/*
 * Calculate how much padding is necessary to
 * chunk-align the end of the DSS.
 */
incr = (intptr_t)size - (intptr_t)CHUNK_ADDR2OFFSET(dss_max);
if (incr == (intptr_t)size)
    ret = dss_max;
else {
    ret = (void *)((intptr_t)dss_max + incr);
    incr += size;
}

sbrk(incr);
return (ret);

```

Note that `size` is unsigned and `incr` is signed.
When `size` is big enough, `incr` is misinterpreted as negative
and causes the `sbrk` system call to shrink the memory.

## Bionic malloc

Bionic, the Android libc, is derived from the BSD libc. When
`libc.debug.malloc` is set, allocation calls will be rerouted to
its own debugging library.

Again, the debugging library had `calloc` multiplication overflows
([CVE-2009-0607](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-0607)).

Also, its `malloc` implementation still has multiple rounding
overflows, at least in in `chk_malloc` and `leak_malloc`.

Hope that no production phone ships the debugging library.

## TCMalloc

Google’s [TCMalloc](http://goog-perftools.sourceforge.net/doc/tcmalloc.html)
repeated the `calloc` multiplication overflow bug and got it
[fixed](http://code.google.com/p/gperftools/source/detail?r=15&path=/trunk/src/tcmalloc.cc)
in 2005.

I didn’t spot any serious rounding issues in TCMalloc,
but just a slip in `ReportLargeAlloc`:
the error message says “tcmalloc: large alloc *0* bytes == (nil)”
given `malloc(-1)`, because the size to be output overflows.

## APR pool

[APR pool](http://apr.apache.org/docs/apr/group__apr__pools.html) is
developed for the Apache web server. It is also adopted by other
projects such as Subversion. The interface is similar to
allocate-and-free allocators, but takes one extra parameter specifying
which pool to allocate from.

APR pool had a series of interesting pointer arithmetic fixes,
listed as follows.

In Aug 2002, the sanity check `p + size < q` was
[changed](http://svn.apache.org/viewvc?view=revision&revision=63806)
to `size < q - p`, where
the two pointers `p` (i.e., `node->first_evail`) and `q` (i.e.,
`node->endp`) point to the start and the end of a memory block,
respectively.

```
-    endp = node->first_avail + size;
-    if (endp < node->endp) {
+    if (size < node->endp - node->first_avail) {

```

Over a month later (Sep 2002), the check was
[reverted](http://svn.apache.org/viewvc?view=revision&revision=63887)
to `p + size < q`.

```
-    if (size < node->endp - node->first_avail) {
+    if (node->first_avail + size < node->endp) {

```

One week later (Oct 2002), the check was again
[changed](http://svn.apache.org/viewvc?view=revision&revision=63894)
to `size < q - p`.

```
-    if (node->first_avail + size < node->endp) {
+    if (size < (apr_size_t)(node->endp - node->first_avail)) {

```

After over five years (Apr 2008), the check was
[revised](http://svn.apache.org/viewvc?view=revision&revision=645436)
to `size <= q - p` with an off-by-one fix.

```
+/* Returns the amount of free space in the given node. */
+#define node_free_space(node_) ((apr_size_t)(node_->endp - node_->first_avail))
...
-    if (size < (apr_size_t)(node->endp - node->first_avail)) {
+    if (size <= node_free_space(node)) {

```

Here `p + size < q` is more dangerous than `size < q - p`. One obvious
reason is that `p + size` could wrap around to a small pointer given
a big `size`, while the latter check doesn’t have the pointer
overflow issue.

But how about adding a wrap check `p + size < p`? A subtle
problem is that pointer overflow (or more precisely, out-of-bounds
pointer) is undefined in C, which means that the compiler can do
anything to the wrap check `p + size < p`, such as optimizing it
away ([VU#162289](http://www.kb.cert.org/vuls/id/162289)).
I tried to compile the wrap check using GCC 4.6 and Clang 3.0 on x86:
it’s optimized as extracting the sign of `size`, without even looking
at the value of `p`.

```
movl	8(%esp), %eax
shrl	$31, %eax
ret

```

The size rounding vulnerability was also discovered and fixed in APR pool
([CVE-2009-2412](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-2412))
in 2009.

## boost::pool

[Boost Pool](http://www.boost.org/libs/pool/) has the multiplication overflow
issue in its `ordered_malloc` implementation.

```
template <typename UserAllocator>
void * pool<UserAllocator>::ordered_malloc(const size_type n)
{
  const size_type partition_size = alloc_size();
  const size_type total_req_size = n * requested_size;
  const size_type num_chunks = total_req_size / partition_size +
      ((total_req_size % partition_size) ? true : false);

  void * ret = store().malloc_n(num_chunks, partition_size);
  ...
]

```

We can see that `total_req_size` may wrap around to a small number
given a big `n`.

## Boehm GC

[Boehm GC](http://www.hpl.hp.com/personal/Hans_Boehm/gc/) is probably
the most popular open-source garbage collector. It provides C
allocation calls and overloads the C++ `new` operator.

Boehm GC’s `calloc` implementation, in both `malloc.c` and its
[documentation](http://www.hpl.hp.com/personal/Hans_Boehm/gc/leak.html),
simply redirects `calloc(n, size)` to `GC_MALLOC((n) * (size))`,
thus is vulnerable to multiplication overflow.

It also has the size rounding vulnerability, so `GC_MALLOC(-1)`
doesn’t return a null pointer either.

## Safe by Design

Some allocators are designed to be used in “safe”
environment. For example, LLVM’s `BumpPtrAllocator`
doesn’t consider out-of-memory or overflow issues.

[kLIBC](http://git.kernel.org/?p=libs/klibc/klibc.git;a=blob;f=usr/klibc/calloc.c;hb=HEAD) is another example.

```
/* FIXME: This should look for multiplication overflow */

void *calloc(size_t nmemb, size_t size)
{
	void *ptr;

	size *= nmemb;
	ptr = malloc(size);
	if (ptr)
		memset(ptr, 0, size);

	return ptr;
}

```
## Compiler

The C++ array allocation `new T[n]` has a potential integer overflow
vulnerability if `n` is not limited correctly, which could lead to
a buffer overflow. This is similar to `calloc(n, sizeof(T))`.

The code generated by GCC simply calculates the
allocation size as `n * sizeof(T)` without any overflow checks,
though GCC developers have been
[discussing the problem](http://gcc.gnu.org/bugzilla/show_bug.cgi?id=19351)
for a long time.

Clang
[generates “safe” code](http://blog.llvm.org/2011/05/what-every-c-programmer-should-know_21.html)
that defends against integer overflow attacks, via setting the
allocation size to -1 if any multiplication overflow happens. This
implies an assumption that the underlying allocator must return a
null pointer given a large size. As we have seen, this assumption
doesn’t hold well in practice.

[Subscribe](/feed.xml)



=== Content from github.com_851249c7_20250125_045350.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Commit

[Permalink](/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid overflowing allocation size in CallMalloc()

[Browse files](/ned14/nedmalloc/tree/1a759756639ab7543b650a10c2d77a0ffc7a2000)
Browse the repository at this point in the history

```
The wraparound could happen if USE_MAGIC_HEADERS is enabled.
```

* Loading branch information

[![@xiw](https://avatars.githubusercontent.com/u/801567?s=40&v=4)](/xiw)

[xiw](/ned14/nedmalloc/commits?author=xiw "View all commits by xiw")
committed
Apr 14, 2012

1 parent
[2965eca](/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1)

commit 1a75975

Showing
**1 changed file**
with
**5 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[nedmalloc.c](#diff-01b9066e81cc5b2441bd11ec6e2ddbbeb5d7b6bec1c38883124d62587e3dd759 "nedmalloc.c")

Show comments

[View file](/ned14/nedmalloc/blob/1a759756639ab7543b650a10c2d77a0ffc7a2000/nedmalloc.c)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -328,7 +328,11 @@ static FORCEINLINE NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*CallMalloc(void \* |
|  |  | #if USE\_MAGIC\_HEADERS |
|  |  | size\_t \_alignment=alignment; |
|  |  | size\_t \*\_ret=0; |
|  |  | size+=alignment+3\*sizeof(size\_t); |
|  |  | size\_t bytes=size+alignment+3\*sizeof(size\_t); |
|  |  | /\* Avoid addition overflow. \*/ |
|  |  | if(bytes<size) |
|  |  | return 0; |
|  |  | size=bytes; |
|  |  | \_alignment=0; |
|  |  | #endif |
|  |  | #if USE\_ALLOCATOR==0 |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1a75975`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F1a759756639ab7543b650a10c2d77a0ffc7a2000) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f5f8a67b_20250125_045351.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Commit

[Permalink](/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid overflowing allocation size in calloc()

[Browse files](/ned14/nedmalloc/tree/2965eca30c408c13473c4146a9d47d547d288db1)
Browse the repository at this point in the history

* Loading branch information

[![@xiw](https://avatars.githubusercontent.com/u/801567?s=40&v=4)](/xiw)

[xiw](/ned14/nedmalloc/commits?author=xiw "View all commits by xiw")
committed
Apr 14, 2012

1 parent
[9333e50](/ned14/nedmalloc/commit/9333e50534e64dca1576fc54705613a81c510aa7)

commit 2965eca

Showing
**1 changed file**
with
**6 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

8 changes: 6 additions & 2 deletions

8
[nedmalloc.c](#diff-01b9066e81cc5b2441bd11ec6e2ddbbeb5d7b6bec1c38883124d62587e3dd759 "nedmalloc.c")

Show comments

[View file](/ned14/nedmalloc/blob/2965eca30c408c13473c4146a9d47d547d288db1/nedmalloc.c)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2018,8 +2018,12 @@ NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedpmalloc(nedpool \*p, size\_t size) |
|  |  | } |
|  |  | NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedpcalloc(nedpool \*p, size\_t no, size\_t size) THROWSPEC |
|  |  | { |
|  |  | unsigned flags=NEDMALLOC\_FORCERESERVE(p, 0, no\*size); |
|  |  | return nedpmalloc2(p, size\*no, 0, M2\_ZERO\_MEMORY|flags); |
|  |  | size\_t bytes=no\*size; |
|  |  | /\* Avoid multiplication overflow. \*/ |
|  |  | if(size && no!=bytes/size) |
|  |  | return 0; |
|  |  | unsigned flags=NEDMALLOC\_FORCERESERVE(p, 0, bytes); |
|  |  | return nedpmalloc2(p, bytes, 0, M2\_ZERO\_MEMORY|flags); |
|  |  | } |
|  |  | NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedprealloc(nedpool \*p, void \*mem, size\_t size) THROWSPEC |
|  |  | { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2965eca`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fcommit%2F2965eca30c408c13473c4146a9d47d547d288db1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_bec6d3ac_20250125_045347.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](12) [[next>]](../../../2012/06/08/1) [[<thread-prev]](9) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <4FD0FD34.2050201@redhat.com>
Date: Thu, 07 Jun 2012 13:12:52 -0600
From: Kurt Seifried <kseifried@...hat.com>
To: oss-security@...ts.openwall.com
CC: Xi Wang <xi.wang@...il.com>, boost@...ts.boost.org, emery@...umass.edu,
        ivmai@...l.ru, webmaster2@...prod.com
Subject: Re: memory allocator upstream patches

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 06/04/2012 11:54 PM, Xi Wang wrote:
> Hi,
>
> I would like to share some upstream patches of two specific types
> of memory allocator vulnerabilities.
>
> * malloc(n) size overflow.
>
> Consider the following code pattern.
>
> 	n = read_from_input();
> 	p = malloc(n);
> 	if (p)
> 		memcpy(p, input_buffer, n);
>
> Some malloc() implementations internally perform alignment/padding
> for a large n, and the allocation size wraps around to a small
> integer.  That means they would allocate a smaller buffer than
> expected, leading to buffer overflow.
>
> * calloc(n, size) size overflow.
>
> Some calloc() implementations don't check for n * size multiplication
> overflow, and would allocate a smaller buffer than expected,
> leading to buffer overflow.
>
> The two types of vulnerabilities can be easily reproduced using
> malloc(-1) and calloc(BIG-VALUE, BIG-VALUE).  If the return values
> are non-null, the implementations are likely to be problematic.
>
> See a more complete list at:
>
> <http://kqueue.org/blog/2012/03/05/memory-allocator-security-revisited/>
>
> Below are some recent upstream fixes.
>
>
> Boehm-Demers-Weiser GC (libgc)
> ==============================
>
> malloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/ivmai/bdwgc/commit/be9df82919960214ee4b9d3313523bff44fd99e1>
>
> The bug in mallocx.c was found by Ivan Maidanski.
>
> calloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/ivmai/bdwgc/commit/e10c1eb9908c2774c16b3148b30d2f3823d66a9a>
>
<https://github.com/ivmai/bdwgc/commit/6a93f8e5bcad22137f41b6c60a1c7384baaec2b3>
>
<https://github.com/ivmai/bdwgc/commit/83231d0ab5ed60015797c3d1ad9056295ac3b2bb>

<https://github.com/ivmai/bdwgc/blob/master/malloc.c>
<https://github.com/ivmai/bdwgc/blob/master/mallocx.c>

Please use CVE-2012-2673 for this issue

> bionic (Android libc)
> =====================
>
> malloc() size overflow, upstream patch (revised by the developers):
>
>
<https://github.com/android/platform_bionic/commit/7f5aa4f35e23fd37425b3a5041737cdf58f87385>
>
> NB: this vulnerability could only be triggered in debug mode, the
> same as CVE-2009-0607, calloc() size overflow.

<https://github.com/android/platform_bionic/blob/master/libc/bionic/malloc_debug_leak.c>

Please use CVE-2012-2674 for this issue

> nedmalloc
> =========
>
> malloc() size overflow, upstream patch:
>
>
<https://github.com/ned14/nedmalloc/commit/1a759756639ab7543b650a10c2d77a0ffc7a2000>
>
> calloc() size overflow, upstream patch:
>
>
<https://github.com/ned14/nedmalloc/commit/2965eca30c408c13473c4146a9d47d547d288db1>

<https://github.com/ned14/nedmalloc/blob/master/nedmalloc.c>

Please use CVE-2012-2675 for this issue

> Hoard
> =====
>
> <http://www.hoard.org/>
>
> malloc() size overflow, confirmed by the developers via email in
> this March, no upstream patch available (since 3.8).
>
> calloc() size overflow, which should only happen on non-glibc
> platforms (e.g., Mac OS X).  It has not been confirmed by the
> developers, but one can easily reproduce it.

hoard-38/src/tlab.h

Please use CVE-2012-2676 for this issue

> boost::pool
> ===========
>
> ordered_malloc() (similar to calloc()) size overflow, upstream patch:
>
> <https://svn.boost.org/trac/boost/changeset/78326>

<http://www.boost.org/doc/libs/1_49_0/boost/pool/poolfwd.hpp>

Please use CVE-2012-2677 for this issue

> - xi

- --
Kurt Seifried Red Hat Security Response Team (SRT)
PGP: 0x5E267993 A90B F995 7350 148F 66BF 7554 160D 4553 5E26 7993

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.12 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <http://enigmail.mozdev.org/>

iQIcBAEBAgAGBQJP0P00AAoJEBYNRVNeJnmTegUP/RzPWBuDk5uc5VX7GfNwl2bV
Tj6vK8eR3PqC0eWZ9J84Ak1Rr/sArq7+eF2jQzB2y5nazrvq8+CbLG45+aG/tc/k
/s1WgQlPf0/cSdG5KtXqQAot/DNwBr91gzPiXzLhH4VriglZkmyYnQoatUq7qg+X
95dlGcDiA9MZBs8/Y9hffUQpT6A59RBR1Js/wIuKxgVuvR6FHr5K6kT8ugj7u5n6
4gsvpL16rpAqUtaDrbrYS/E1wde0X4X++mwdMe+Qnjh4ZmVINPcF845QMmPUKKzN
ub2q/aibzI3c7UxHVW6yPO4kY14dWHQIJkIB4r6nPNkUlkHEsCageMYqUA+iK8d8
/c0xbUjEk6Lq9mWjduHCTdXxgSJcZRl5+v64qAAkGXn2Iry1t0LxLUvQagyG/YYl
laYogHq57jS7gl5bWnPNRFiWo5/zS5n7t6F+T2s98Oly9guNTOZXqe3bzHkJDBO3
Wcv6GNZ+awN0XVLHgBIzky5LCDHbCQrjr/JZvD55HNt9gCmsJzgg0C4iXda86hUd
+yLPQ7tzPIXaruco5GdBh24k6pHuvXfUoeIitRHdb/a1lUqY+9Prcrn0/uC9O6H9
i6RZ7Oki4mE4LBOWP4C/2CxR87tqNmMv2/NKvlMhBVM7IdIxtinXHmwZZGS2aywo
/9xo9gM88fT2SmjREZu3
=Zv9/
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_7f9b9d59_20250126_060553.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fblob%2Fmaster%2Fnedmalloc.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fned14%2Fnedmalloc%2Fblob%2Fmaster%2Fnedmalloc.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ned14%2Fnedmalloc)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 15, 2019. It is now read-only.

[ned14](/ned14)
/
**[nedmalloc](/ned14/nedmalloc)**
Public archive

* [Notifications](/login?return_to=%2Fned14%2Fnedmalloc) You must be signed in to change notification settings
* [Fork
  76](/login?return_to=%2Fned14%2Fnedmalloc)
* [Star
   402](/login?return_to=%2Fned14%2Fnedmalloc)

* [Code](/ned14/nedmalloc)
* [Issues
  4](/ned14/nedmalloc/issues)
* [Pull requests
  0](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects
  0](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

Additional navigation options

* [Code](/ned14/nedmalloc)
* [Issues](/ned14/nedmalloc/issues)
* [Pull requests](/ned14/nedmalloc/pulls)
* [Actions](/ned14/nedmalloc/actions)
* [Projects](/ned14/nedmalloc/projects)
* [Wiki](/ned14/nedmalloc/wiki)
* [Security](/ned14/nedmalloc/security)
* [Insights](/ned14/nedmalloc/pulse)

## Files

 master
## Breadcrumbs

1. [nedmalloc](/ned14/nedmalloc/tree/master)
/
# nedmalloc.c

Copy path Blame  Blame
## Latest commit

## History

[History](/ned14/nedmalloc/commits/master/nedmalloc.c)2275 lines (2201 loc) · 69.5 KB master
## Breadcrumbs

1. [nedmalloc](/ned14/nedmalloc/tree/master)
/
# nedmalloc.c

Top
## File metadata and controls

* Code
* Blame

2275 lines (2201 loc) · 69.5 KB[Raw](https://github.com/ned14/nedmalloc/raw/refs/heads/master/nedmalloc.c)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\* Alternative malloc implementation for multiple threads withoutlock contention based on dlmalloc. (C) 2005-2012 Niall Douglas
Boost Software License - Version 1.0 - August 17th, 2003
Permission is hereby granted, free of charge, to any person or organizationobtaining a copy of the software and accompanying documentation covered bythis license (the "Software") to use, reproduce, display, distribute,execute, and transmit the Software, and to prepare derivative works of theSoftware, and to permit third-parties to whom the Software is furnished todo so, all subject to the following:
The copyright notices in the Software and this entire statement, includingthe above license grant, this restriction and the following disclaimer,must be included in all copies of the Software, in whole or in part, andall derivative works of the Software, unless such copies or derivativeworks are solely in the form of machine-executable object code generated bya source language processor.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS ORIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENTSHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLEFOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHERDEALINGS IN THE SOFTWARE.\*/
#if 0 /\* Effectively makes nedmalloc = dlmalloc \*/#define THREADCACHEMAX 0#define DEFAULT\_GRANULARITY 65536#define DEFAULTMAXTHREADSINPOOL 1#endif
#ifdef \_MSC\_VER/\* Enable full aliasing on MSVC \*//\*#pragma optimize("a", on)\*//\*#pragma optimize("g", off)\*/
#pragma warning(push)#pragma warning(disable:4100) /\* unreferenced formal parameter \*/#pragma warning(disable:4127) /\* conditional expression is constant \*/#pragma warning(disable:4232) /\* address of dllimport is not static, identity not guaranteed \*/#pragma warning(disable:4706) /\* assignment within conditional expression \*/
#define \_CRT\_SECURE\_NO\_WARNINGS 1 /\* Don't care about MSVC warnings on POSIX functions \*/#include <stdio.h>#define fopen(f, m) \_fsopen((f), (m), 0x40/\*\_SH\_DENYNO\*/) /\* Have Windows let other programs view the log file as it is written \*/#ifndef UNICODE#define UNICODE /\* Turn on windows unicode support \*/#endif#else#include <stdio.h>#endif
/\*#define NEDMALLOC\_DEBUG 1\*//\*#define ENABLE\_LOGGING 7#define NEDMALLOC\_TESTLOGENTRY(tc, np, type, mspace, size, mem, alignment, flags, returned) (((type)&ENABLE\_LOGGING)&&((size)>16\*1024))#define NEDMALLOC\_STACKBACKTRACEDEPTH 16\*//\*#define NEDMALLOC\_FORCERESERVE(p, mem, size) (((size)>=(256\*1024)) ? M2\_RESERVE\_MULT(8) : 0)\*//\*#define WIN32\_DIRECT\_USE\_FILE\_MAPPINGS 0\*/
/\*#define NEDMALLOC\_DEBUG 1\*/
/\*#define FULLSANITYCHECKS\*/
/\*#define FORCEINLINE\*/
/\* There is only support for the user mode page allocator on Windows at present \*/#if !defined(ENABLE\_USERMODEPAGEALLOCATOR)#define ENABLE\_USERMODEPAGEALLOCATOR 0#endif
/\* If link time code generation is on, don't force or prevent inlining \*/#if defined(\_MSC\_VER) && defined(NEDMALLOC\_DLL\_EXPORTS)#define FORCEINLINE#define NOINLINE#endif
#include "nedmalloc.h"#include <errno.h>#ifdef HAVE\_VALGRIND#include <valgrind/valgrind.h>#include <valgrind/memcheck.h>#endif#if defined(WIN32) #include <malloc.h>#else #if defined(\_\_cplusplus)extern "C" #elseextern #endif #if defined(\_\_linux\_\_) || defined(\_\_FreeBSD\_\_)/\* Sadly we can't include <malloc.h> as it causes a redefinition error \*/size\_t malloc\_usable\_size(void \*); #elif defined(\_\_APPLE\_\_) #if TARGET\_OS\_IPHONE #include <malloc/malloc.h> #else #include <malloc.h> #endif #else #error Do not know what to do here #endif#endif
#if USE\_ALLOCATOR==1 #define MSPACES 1 #define ONLY\_MSPACES 1#endif#define USE\_DL\_PREFIX 1#define USE\_RECURSIVE\_LOCKS 1#ifndef USE\_LOCKS #define USE\_LOCKS 1#endif#define FOOTERS 1 /\* Need to enable footers so frees lock the right mspace \*/#define INSECURE 0 /\* nedblkmstate works a lot better with magic enabled \*/#ifndef NEDMALLOC\_DEBUG #if defined(DEBUG) || defined(\_DEBUG) #define NEDMALLOC\_DEBUG 1 #else #define NEDMALLOC\_DEBUG 0 #endif#endif/\* We need to consistently define DEBUG=0|1, \_DEBUG and NDEBUG for dlmalloc \*/#if !defined(DEBUG) && !defined(NDEBUG) #ifdef \_\_GNUC\_\_ #warning DEBUG may not be defined but without NDEBUG being defined allocator will run with assert checking! Define NDEBUG to run at full speed. #elif defined(\_MSC\_VER) #pragma message(\_\_FILE\_\_ ": WARNING: DEBUG may not be defined but without NDEBUG being defined allocator will run with assert checking! Define NDEBUG to run at full speed.") #endif#endif#undef DEBUG#undef \_DEBUG#if NEDMALLOC\_DEBUG #define \_DEBUG #define DEBUG 1#else #define DEBUG 0#endif#ifdef NDEBUG /\* Disable assert checking on release builds \*/ #undef DEBUG #undef \_DEBUG#endif/\* The default of 64Kb means we spend too much time kernel-side \*/#ifndef DEFAULT\_GRANULARITY #define DEFAULT\_GRANULARITY (1\*1024\*1024) #if DEBUG #define DEFAULT\_GRANULARITY\_ALIGNED #endif#endif/\*#define USE\_SPIN\_LOCKS 0\*/
#if ENABLE\_USERMODEPAGEALLOCATORextern int OSHavePhysicalPageSupport(void);extern void \*userpage\_malloc(size\_t toallocate, unsigned flags);extern int userpage\_free(void \*mem, size\_t size);extern void \*userpage\_realloc(void \*mem, size\_t oldsize, size\_t newsize, int flags, unsigned flags2);
#define USERPAGE\_TOPDOWN (M2\_CUSTOM\_FLAGS\_BEGIN<<0)#define USERPAGE\_NOCOMMIT (M2\_CUSTOM\_FLAGS\_BEGIN<<1)
/\* This can provide a very significant speed boost \*/#undef MMAP\_CLEARS#define MMAP\_CLEARS 0
#define MUNMAP(h, a, s) (!OSHavePhysicalPageSupport() ? MUNMAP\_DEFAULT((h), (a), (s)) : userpage\_free((a), (s)))#define MMAP(s, f) (!OSHavePhysicalPageSupport() ? MMAP\_DEFAULT((s)) : userpage\_malloc((s), (f)))#define MREMAP(addr, osz, nsz, mv) (!OSHavePhysicalPageSupport() ? MREMAP\_DEFAULT((addr), (osz), (nsz), (mv)) : userpage\_realloc((addr), (osz), (nsz), (mv), 0))#define DIRECT\_MMAP(h, s, f) (!OSHavePhysicalPageSupport() ? DIRECT\_MMAP\_DEFAULT((h), (s), (f)) : userpage\_malloc((s), (f)|USERPAGE\_TOPDOWN))#define DIRECT\_MREMAP(h, a, os, ns, f, f2) (!OSHavePhysicalPageSupport() ? DIRECT\_MREMAP\_DEFAULT((h), (a), (os), (ns), (f), (f2)) : userpage\_realloc((a), (os), (ns), (f), (f2)|USERPAGE\_TOPDOWN))
/\*#undef MREMAP#define MREMAP(addr, osz, nsz, mv) (!OSHavePhysicalPageSupport() ? MREMAP\_DEFAULT((addr), (osz), (nsz), (mv)) : MFAIL)\*//\*#undef DIRECT\_MREMAP#define DIRECT\_MREMAP(h, a, os, ns, f, f2) (!OSHavePhysicalPageSupport() ? DIRECT\_MREMAP\_DEFAULT((h), (a), (os), (ns), (f), (f2)) : MFAIL)\*/
#endif#include "malloc.c.h"#ifdef NDEBUG /\* Disable assert checking on release builds \*/ #undef DEBUG#endif
/\* The default number of threads allowed into a pool at once \*/#ifndef DEFAULTMAXTHREADSINPOOL#define DEFAULTMAXTHREADSINPOOL 4#endif/\* The maximum size to be allocated from the thread cache \*/#ifndef THREADCACHEMAX#define THREADCACHEMAX 8192#elif THREADCACHEMAX && !defined(THREADCACHEMAXBINS) #ifdef \_\_GNUC\_\_ #warning If you are changing THREADCACHEMAX, do you also need to change THREADCACHEMAXBINS=(topbitpos(THREADCACHEMAX)-4)? #elif defined(\_MSC\_VER) #pragma message(\_\_FILE\_\_ ": WARNING: If you are changing THREADCACHEMAX, do you also need to change THREADCACHEMAXBINS=(topbitpos(THREADCACHEMAX)-4)?") #endif#endif/\* The maximum concurrent threads in a pool possible \*/#ifndef MAXTHREADSINPOOL#define MAXTHREADSINPOOL 16#endif/\* The maximum number of threadcaches which can be allocated \*/#ifndef THREADCACHEMAXCACHES#define THREADCACHEMAXCACHES 256#endif#ifndef THREADCACHEMAXBINS#if 0/\* The number of cache entries for finer grained bins. This is (topbitpos(THREADCACHEMAX)-4)\*2 \*/#define THREADCACHEMAXBINS ((13-4)\*2)#else/\* The number of cache entries. This is (topbitpos(THREADCACHEMAX)-4) \*/#define THREADCACHEMAXBINS (13-4)#endif#endif/\* Point at which the free space in a thread cache is garbage collected \*/#ifndef THREADCACHEMAXFREESPACE#define THREADCACHEMAXFREESPACE (1024\*1024)#endif/\* NEDMALLOC\_FORCERESERVE is used to force malloc2 flags for normal malloc, calloc et al \*/#ifndef NEDMALLOC\_FORCERESERVE#define NEDMALLOC\_FORCERESERVE(p, mem, size) 0#endif/\* ENABLE\_LOGGING is a bitmask of what events to log \*/#if ENABLE\_LOGGING#ifndef NEDMALLOC\_LOGFILE#define NEDMALLOC\_LOGFILE "nedmalloc.csv"#endif#endif/\* NEDMALLOC\_TESTLOGENTRY returns non-zero if the entry should be logged \*/#ifndef NEDMALLOC\_TESTLOGENTRY#define NEDMALLOC\_TESTLOGENTRY(tc, np, type, mspace, size, mem, alignment, flags, returned) ((type)&ENABLE\_LOGGING)#endif/\* NEDMALLOC\_STACKBACKTRACEDEPTH has the logger store a stack backtrace per logged item. Slow! \*/#ifndef NEDMALLOC\_STACKBACKTRACEDEPTH#define NEDMALLOC\_STACKBACKTRACEDEPTH 0#endif#if NEDMALLOC\_STACKBACKTRACEDEPTH#include "Dbghelp.h"#include "psapi.h"#pragma comment(lib, "dbghelp.lib")#pragma comment(lib, "psapi.lib")#endif#define NM\_FLAGS\_MASK (M2\_FLAGS\_MASK&~M2\_ZERO\_MEMORY)
#if USE\_LOCKS#ifdef WIN32 #define TLSVAR DWORD #define TLSALLOC(k) (\*(k)=TlsAlloc(), TLS\_OUT\_OF\_INDEXES==\*(k)) #define TLSFREE(k) (!TlsFree(k)) #define TLSGET(k) TlsGetValue(k) #define TLSSET(k, a) (!TlsSetValue(k, a)) #ifdef DEBUGstatic LPVOID ChkedTlsGetValue(DWORD idx){ LPVOID ret=TlsGetValue(idx); assert(S\_OK==GetLastError()); return ret;} #undef TLSGET #define TLSGET(k) ChkedTlsGetValue(k) #endif#else #define TLSVAR pthread\_key\_t #define TLSALLOC(k) pthread\_key\_create(k, 0) #define TLSFREE(k) pthread\_key\_delete(k) #define TLSGET(k) pthread\_getspecific(k) #define TLSSET(k, a) pthread\_setspecific(k, a)#endif#else /\* Probably if you're not using locks then you don't want ANY pthread stuff at all \*/ #define TLSVAR void \* #define TLSALLOC(k) (\*k=0) #define TLSFREE(k) (k=0) #define TLSGET(k) k #define TLSSET(k, a) (k=a, 0)#endif
#if ENABLE\_USERMODEPAGEALLOCATOR#include "usermodepageallocator.c"#endif
#if defined(\_\_cplusplus)#if !defined(NO\_NED\_NAMESPACE)namespace nedalloc {#elseextern "C" {#endif#endif
#if USE\_ALLOCATOR==0static void \*unsupported\_operation(const char \*opname) THROWSPEC{ fprintf(stderr, "nedmalloc: The operation %s is not supported under this build configuration\n", opname); abort(); return 0;}static size\_t mspacecounter=(size\_t) 0xdeadbeef;#endif#ifndef ENABLE\_FAST\_HEAP\_DETECTIONstatic void \*RESTRICT leastusedaddress;static size\_t largestusedblock;#endif/\* Used to redirect system allocator ops if needed \*/extern void \*(\*sysmalloc)(size\_t);extern void \*(\*syscalloc)(size\_t, size\_t);extern void \*(\*sysrealloc)(void \*, size\_t);extern void (\*sysfree)(void \*);extern size\_t (\*sysblksize)(void \*);
#if !defined(REPLACE\_SYSTEM\_ALLOCATOR) || (!defined(\_MSC\_VER) && !defined(\_\_MINGW32\_\_))void \*(\*sysmalloc)(size\_t)=malloc;void \*(\*syscalloc)(size\_t, size\_t)=calloc;void \*(\*sysrealloc)(void \*, size\_t)=realloc;void (\*sysfree)(void \*)=free;size\_t (\*sysblksize)(void \*)=#if defined(\_MSC\_VER) || defined(\_\_MINGW32\_\_) /\* This is the MSVCRT equivalent \*/ \_msize;#elif defined(\_\_linux\_\_) || defined(\_\_FreeBSD\_\_) /\* This is the glibc/ptmalloc2/dlmalloc/BSD equivalent. \*/ malloc\_usable\_size;#elif defined(\_\_APPLE\_\_) /\* This is the Apple BSD libc equivalent. \*/ (size\_t (\*)(void \*)) malloc\_size;#else#error Cannot tolerate the memory allocator of an unknown system!#endif#else/\* Remove the MSVCRT dependency on the memory functions \*/void \*(\*sysmalloc)(size\_t);void \*(\*syscalloc)(size\_t, size\_t);void \*(\*sysrealloc)(void \*, size\_t);void (\*sysfree)(void \*);size\_t (\*sysblksize)(void \*);#endif
static FORCEINLINE NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*CallMalloc(void \*RESTRICT mspace, size\_t size, size\_t alignment, unsigned flags) THROWSPEC{ void \*RESTRICT ret=0;#if USE\_MAGIC\_HEADERS size\_t \_alignment=alignment; size\_t \*\_ret=0; size\_t bytes=size+alignment+3\*sizeof(size\_t); /\* Avoid addition overflow. \*/ if(bytes<size) return 0; size=bytes; \_alignment=0;#endif#if USE\_ALLOCATOR==0 ret=(flags & M2\_ZERO\_MEMORY) ? syscalloc(1, size) : sysmalloc(size); /\* magic headers takes care of alignment \*/#elif USE\_ALLOCATOR==1 ret=mspace\_malloc2((mstate) mspace, size, alignment, flags);#ifdef HAVE\_VALGRIND if(ret) VALGRIND\_MEMPOOL\_ALLOC(mspace, ret, size);#endif#ifndef ENABLE\_FAST\_HEAP\_DETECTION if(ret) { mchunkptr p=mem2chunk(ret); size\_t truesize=chunksize(p) - overhead\_for(p); if(!leastusedaddress || (void \*)((mstate) mspace)->least\_addr<leastusedaddress) leastusedaddress=(void \*)((mstate) mspace)->least\_addr; if(!largestusedblock || truesize>largestusedblock) largestusedblock=(truesize+mparams.page\_size) & ~(mparams.page\_size-1); }#endif#endif if(!ret) return 0;#if DEBUG if(flags & M2\_ZERO\_MEMORY) { const char \*RESTRICT n; for(n=(const char \*)ret; n<(const char \*)ret+size; n++) { assert(!\*n); } }#endif#if USE\_MAGIC\_HEADERS \_ret=(size\_t \*) ret; ret=(void \*)(\_ret+3); if(alignment) ret=(void \*)(((size\_t) ret+alignment-1)&~(alignment-1)); for(; \_ret<(size\_t \*)ret-2; \_ret++) \*\_ret=\*(size\_t \*)"NEDMALOC"; \_ret[0]=(size\_t) mspace; \_ret[1]=size-3\*sizeof(size\_t);#endif return ret;}
static FORCEINLINE NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*CallRealloc(void \*RESTRICT mspace, void \*RESTRICT mem, int isforeign, size\_t oldsize, size\_t newsize, size\_t alignment, unsigned flags) THROWSPEC{ void \*RESTRICT ret=0;#if USE\_MAGIC\_HEADERS mstate oldmspace=0; size\_t \*\_ret=0, \*\_mem=(size\_t \*) mem-3;#endif if(isforeign) { /\* Transfer \*/#if USE\_MAGIC\_HEADERS assert(\_mem[0]!=\*(size\_t \*) "NEDMALOC");#endif if((ret=CallMalloc(mspace, newsize, alignment, flags))) {#if defined(DEBUG) printf("\*\*\* nedmalloc frees system allocated block %p\n", mem);#endif memcpy(ret, mem, oldsize<newsize ? oldsize : newsize); sysfree(mem); } return ret; }#if USE\_MAGIC\_HEADERS assert(\_mem[0]==\*(size\_t \*) "NEDMALOC"); newsize+=3\*sizeof(size\_t); oldmspace=(mstate) \_mem[1]; assert(oldsize>=\_mem[2]); for(; \*\_mem==\*(size\_t \*) "NEDMALOC"; \*\_mem--=\*(size\_t \*) "nedmaloc"); mem=(void \*)(++\_mem);#endif#if USE\_ALLOCATOR==0 ret=sysrealloc(mem, newsize);#elif USE\_ALLOCATOR==1 ret=mspace\_realloc2((mstate) mspace, mem, newsize, alignment, flags);#ifdef HAVE\_VALGRIND if(ret) VALGRIND\_MEMPOOL\_CHANGE(mspace, mem, ret, newsize);#endif#ifndef ENABLE\_FAST\_HEAP\_DETECTION if(ret) { mchunkptr p=mem2chunk(ret); size\_t truesize=chunksize(p) - overhead\_for(p); if(!leastusedaddress || (void \*)((mstate) mspace)->least\_addr<leastusedaddress) leastusedaddress=(void \*)((mstate) mspace)->least\_addr; if(!largestusedblock || truesize>largestusedblock) largestusedblock=(truesize+mparams.page\_size) & ~(mparams.page\_size-1); }#endif#endif if(!ret) { /\* Put it back the way it was \*/#if USE\_MAGIC\_HEADERS for(; \*\_mem==0; \*\_mem++=\*(size\_t \*) "NEDMALOC");#endif return 0; }#if USE\_MAGIC\_HEADERS \_ret=(size\_t \*) ret; ret=(void \*)(\_ret+3); for(; \_ret<(size\_t \*)ret-2; \_ret++) \*\_ret=\*(size\_t \*) "NEDMALOC"; \_ret[0]=(size\_t) mspace; \_ret[1]=newsize-3\*sizeof(size\_t);#endif return ret;}
static FORCEINLINE void CallFree(void \*RESTRICT mspace, void \*RESTRICT mem, int isforeign) THROWSPEC{#if USE\_MAGIC\_HEADERS mstate oldmspace=0; size\_t \*\_mem=(size\_t \*) mem-3, oldsize=0;#endif if(isforeign) {#if USE\_MAGIC\_HEADERS assert(\_mem[0]!=\*(size\_t \*) "NEDMALOC");#endif#if defined(DEBUG) printf("\*\*\* nedmalloc frees system allocated block %p\n", mem);#endif sysfree(mem); return; }#if USE\_MAGIC\_HEADERS assert(\_mem[0]==\*(size\_t \*) "NEDMALOC"); oldmspace=(mstate) \_mem[1]; oldsize=\_mem[2]; for(; \*\_mem==\*(size\_t \*) "NEDMALOC"; \*\_mem--=\*(size\_t \*) "nedmaloc"); mem=(void \*)(++\_mem);#endif#if USE\_ALLOCATOR==0 sysfree(mem);#elif USE\_ALLOCATOR==1#ifdef HAVE\_VALGRIND { void \*m=mspace ? mspace : get\_mstate\_for(mem2chunk(mem)); mspace\_free((mstate) mspace, mem); VALGRIND\_MEMPOOL\_FREE(m, mem); /\* Mark the first two pointers in the newly freed block as used (linked list of freed blocks) \*/ VALGRIND\_MAKE\_MEM\_DEFINED(mem, 2\*sizeof(void \*)); }#else mspace\_free((mstate) mspace, mem);#endif#endif}
static NEDMALLOCNOALIASATTR mstate nedblkmstate(void \*RESTRICT mem) THROWSPEC{ if(mem) {#if USE\_MAGIC\_HEADERS size\_t \*\_mem=(size\_t \*) mem-3; if(\_mem[0]==\*(size\_t \*) "NEDMALOC") { return (mstate) \_mem[1]; } else return 0;#else#if USE\_ALLOCATOR==0 /\* Fail everything \*/ return 0;#elif USE\_ALLOCATOR==1#ifdef ENABLE\_FAST\_HEAP\_DETECTION#ifdef WIN32 /\* On Windows for RELEASE both x86 and x64 the NT heap precedes each block with an eight byte header which looks like: normal: 4 bytes of size, 4 bytes of [char < 64, char < 64, char < 64 bit 0 always set, char random ] mmaped: 4 bytes of size 4 bytes of [zero, zero, 0xb, zero ]
 On Windows for DEBUG both x86 and x64 the preceding four bytes is always 0xfdfdfdfd (no man's land). \*/#pragma pack(push, 1) struct \_HEAP\_ENTRY { USHORT Size; USHORT PreviousSize; UCHAR Cookie; /\* SegmentIndex \*/ UCHAR Flags; /\* always bit 0 (HEAP\_ENTRY\_BUSY). bit 1=(HEAP\_ENTRY\_EXTRA\_PRESENT), bit 2=normal block (HEAP\_ENTRY\_FILL\_PATTERN), bit 3=mmap block (HEAP\_ENTRY\_VIRTUAL\_ALLOC). Bit 4 (HEAP\_ENTRY\_LAST\_ENTRY) could be set \*/ UCHAR UnusedBytes; UCHAR SmallTagIndex; /\* fastbin index. Always one of 0x02, 0x03, 0x04 < 0x80 \*/ } \*RESTRICT he=((struct \_HEAP\_ENTRY \*) mem)-1;#pragma pack(pop) unsigned int header=((unsigned int \*)mem)[-1], mask1=0x8080E100, result1, mask2=0xFFFFFF06, result2; result1=header & mask1; /\* Positive testing for NT heap \*/ result2=header & mask2; /\* Positive testing for dlmalloc \*/ if(result1==0x00000100 && result2!=0x00000102) { /\* This is likely a NT heap block \*/ return 0; }#endif#ifdef \_\_linux\_\_ /\* On Linux glibc uses ptmalloc2 (really dlmalloc) just as we do, but prev\_foot contains rubbish when the preceding block is allocated because ptmalloc2 finds the local mstate by rounding the ptr down to the nearest megabyte. It's like dlmalloc with FOOTERS disabled. \*/ mchunkptr p=mem2chunk(mem); mstate fm=get\_mstate\_for(p); /\* If it's a ptmalloc2 block, fm is likely to be some crazy value \*/ if(!is\_aligned(fm)) return 0; if((size\_t)mem-(size\_t)fm>=(size\_t)1<<(SIZE\_T\_BITSIZE-1)) return 0; if(ok\_magic(fm)) return fm; else return 0; if(1) { }#endif else { mchunkptr p=mem2chunk(mem); mstate fm=get\_mstate\_for(p); assert(ok\_magic(fm)); /\* If this fails, someone tried to free a block twice \*/ if(ok\_magic(fm)) return fm; }#else /\* ENABLE\_FAST\_HEAP\_DETECTION \*/#ifdef WIN32#ifdef \_MSC\_VER \_\_try#else#if ENABLE\_TOLERANT\_NEDMALLOC#error Lack of SEH support makes nedmalloc unreliable with foreign memory blocks. Make sure ENABLE\_TOLERANT\_NEDMALLOC is turned off!#endif#endif /\* defined(\_MSC\_VER) \*/#elif ENABLE\_TOLERANT\_NEDMALLOC#warning nedmalloc is unreliable with foreign memory blocks, so make sure you really want ENABLE\_TOLERANT\_NEDMALLOC turned on!#endif { /\* We try to return zero here if it isn't one of our own blocks, however the current block annotation scheme used by dlmalloc makes it impossible to be absolutely sure of avoiding a segfault.
 mchunkptr->prev\_foot = mem-(2\*size\_t) = mstate ^ mparams.magic for PRECEDING block; mchunkptr->head = mem-(1\*size\_t) = 8 multiple size of this block with bottom three bits = FLAG\_BITS FLAG\_BITS = bit 0 is CINUSE (currently in use unless is mmap), bit 1 is PINUSE (previous block currently in use unless mmap), bit 2 is UNUSED and currently is always zero. \*/ register void \*RESTRICT leastusedaddress\_=leastusedaddress; /\* Cache these to avoid register reloading \*/ register size\_t largestusedblock\_=largestusedblock; if(!is\_aligned(mem)) return 0; /\* Would fail very rarely as all allocators return aligned blocks \*/ if(mem<leastusedaddress\_) return 0; /\* Simple but effective \*/ { mchunkptr p=mem2chunk(mem); mstate fm=0; int ismmapped=is\_mmapped(p); if((!ismmapped && !is\_inuse(p)) || (p->head & FLAG4\_BIT)) return 0; /\* Reduced uncertainty by 0.5^2 = 25.0% \*/ /\* size should never exceed largestusedblock \*/ if(chunksize(p)-overhead\_for(p)>largestusedblock\_) return 0; /\* Reduced uncertainty by a minimum of 0.5^3 = 12.5%, maximum 0.5^16 = 0.0015% \*/ /\* Having sanity checked prev\_foot and head, check next block \*/ if(!ismmapped && (!next\_pinuse(p) || (next\_chunk(p)->head & FLAG4\_BIT))) return 0; /\* Reduced uncertainty by 0.5^5 = 3.13% or 0.5^18 = 0.00038% \*/#if 0 /\* If previous block is free, check that its next block pointer equals us \*/ if(!ismmapped && !pinuse(p)) if(next\_chunk(prev\_chunk(p))!=p) return 0; /\* We could start comparing prev\_foot's for similarity but it starts getting slow. \*/#endif fm = get\_mstate\_for(p); if(!is\_aligned(fm) || (void \*)fm<leastusedaddress\_) return 0;#if 0 /\* See if mem is lower in memory than mem \*/ if((size\_t)mem-(size\_t)fm>=(size\_t)1<<(SIZE\_T\_BITSIZE-1)) return 0;#endif assert(ok\_magic(fm)); /\* If this fails, someone tried to free a block twice \*/ if(ok\_magic(fm)) return fm; } }#ifdef WIN32#ifdef \_MSC\_VER \_\_except(1) { }#endif#endif /\* WIN32 \*/#endif /\* ENABLE\_FAST\_HEAP\_DETECTION \*/#endif /\* USE\_ALLOCATOR \*/#endif /\* USE\_MAGIC\_HEADERS \*/ } return 0;}NEDMALLOCNOALIASATTR size\_t nedblksize(int \*RESTRICT isforeign, void \*RESTRICT mem, unsigned flags) THROWSPEC{ if(mem) { if(isforeign) \*isforeign=1;#if USE\_MAGIC\_HEADERS { size\_t \*\_mem=(size\_t \*) mem-3; if(\_mem[0]==\*(size\_t \*) "NEDMALOC") { mstate mspace=(mstate) \_mem[1]; size\_t size=\_mem[2]; if(isforeign) \*isforeign=0; return size; } }#elif USE\_ALLOCATOR==1 if((flags & NM\_SKIP\_TOLERANCE\_CHECKS) || nedblkmstate(mem)) { mchunkptr p=mem2chunk(mem); if(isforeign) \*isforeign=0; return chunksize(p)-overhead\_for(p); }#ifdef DEBUG else { int a=1; /\* Set breakpoints here if needed \*/ }#endif#endif#if defined(ENABLE\_TOLERANT\_NEDMALLOC) || USE\_ALLOCATOR==0 return sysblksize(mem);#endif } return 0;}NEDMALLOCNOALIASATTR size\_t nedmemsize(void \*RESTRICT mem) THROWSPEC { return nedblksize(0, mem, 0); }
NEDMALLOCNOALIASATTR void nedsetvalue(void \*v) THROWSPEC { nedpsetvalue((nedpool \*) 0, v); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedmalloc(size\_t size) THROWSPEC { return nedpmalloc((nedpool \*) 0, size); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedcalloc(size\_t no, size\_t size) THROWSPEC { return nedpcalloc((nedpool \*) 0, no, size); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedrealloc(void \*mem, size\_t size) THROWSPEC { return nedprealloc((nedpool \*) 0, mem, size); }NEDMALLOCNOALIASATTR void nedfree(void \*mem) THROWSPEC { nedpfree((nedpool \*) 0, mem); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedmemalign(size\_t alignment, size\_t bytes) THROWSPEC { return nedpmemalign((nedpool \*) 0, alignment, bytes); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedmalloc2(size\_t size, size\_t alignment, unsigned flags) THROWSPEC { return nedpmalloc2((nedpool \*) 0, size, alignment, flags); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \* nedrealloc2(void \*mem, size\_t size, size\_t alignment, unsigned flags) THROWSPEC { return nedprealloc2((nedpool \*) 0, mem, size, alignment, flags); }NEDMALLOCNOALIASATTR void nedfree2(void \*mem, unsigned flags) THROWSPEC { nedpfree2((nedpool \*) 0, mem, flags); }NEDMALLOCNOALIASATTR struct nedmallinfo nedmallinfo(void) THROWSPEC { return nedpmallinfo((nedpool \*) 0); }NEDMALLOCNOALIASATTR int nedmallopt(int parno, int value) THROWSPEC { return nedpmallopt((nedpool \*) 0, parno, value); }NEDMALLOCNOALIASATTR int nedmalloc\_trim(size\_t pad) THROWSPEC { return nedpmalloc\_trim((nedpool \*) 0, pad); }void nedmalloc\_stats() THROWSPEC { nedpmalloc\_stats((nedpool \*) 0); }NEDMALLOCNOALIASATTR size\_t nedmalloc\_footprint() THROWSPEC { return nedpmalloc\_footprint((nedpool \*) 0); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*\*nedindependent\_calloc(size\_t elemsno, size\_t elemsize, void \*\*chunks) THROWSPEC { return nedpindependent\_calloc((nedpool \*) 0, elemsno, elemsize, chunks); }NEDMALLOCNOALIASATTR NEDMALLOCPTRATTR void \*\*nedindependent\_comalloc(size\_t elems, size\_t \*sizes, void \*\*chunks) THROWSPEC { return nedpindependent\_comalloc((nedpool \*) 0, elems, sizes, chunks); }
#ifdef WIN32typedef unsigned \_\_int64 timeCount;static timeCount GetTimestamp(){ static LARGE\_INTEGER ticksPerSec; static double scalefactor; static timeCount baseCount; LARGE\_INTEGER val; timeCount ret; if(!scalefactor) { if(QueryPerformanceFrequency(&ticksPerSec)) scalefactor=ticksPerSec.QuadPart/1000000000000.0; else scalefactor=1; } if(!QueryPerformanceCounter(&val)) return (timeCount) GetTickCount() \* 1000000000; ret=(timeCount) (val.QuadPart/scalefactor); if(!baseCount) baseCount=ret; return ret-baseCount;}#else#include <sys/time.h>
typedef unsigned long long timeCount;static timeCount GetTimestamp(){ static timeCount baseCount; timeCount ret;#ifdef CLOCK\_MONOTONIC struct timespec ts; clock\_gettime(CLOCK\_MONOTONIC, &ts); ret=((timeCount) ts.tv\_sec\*1000000000000LL)+ts.tv\_nsec\*1000LL;#else struct timeval tv; gettimeofday(&tv, 0); ret=((timeCount) tv.tv\_sec\*1000000000000LL)+tv.tv\_usec\*1000000LL;#endif if(!baseCount) baseCount=ret; return ret-baseCount;}#endif
/\* Set ENABLE\_LOGGING to an AND mask of which of these you want tolog, so set it to 0xffffffff for everything \*/typedef enum LogEntryType\_t{ LOGENTRY\_MALLOC =(1<<0), LOGENTRY\_REALLOC =(1<<1), LOGENTRY\_FREE =(1<<2),
 LOGENTRY\_THREADCACHE\_MALLOC =(1<<3), LOGENTRY\_THREADCACHE\_FREE =(1<<4), LOGENTRY\_THREADCACHE\_CLEAN =(1<<5),
 LOGENTRY\_POOL\_MALLOC =(1<<6), LOGENTRY\_POOL\_REALLOC =(1<<7), LOGENTRY\_POOL\_FREE =(1<<8)} LogEntryType;#if NEDMALLOC\_STACKBACKTRACEDEPTHtypedef struct StackFrameType\_t{ void \*pc; char module[64]; char functname[256]; char file[96]; int lineno;} StackFrameType;#endiftypedef struct logentry\_t{ timeCount timestamp; nedpool \*np; LogEntryType type; int mspace; size\_t size; void \*mem; size\_t alignment; unsigned flags; void \*returned;#if NEDMALLOC\_STACKBACKTRACEDEPTH StackFrameType stack[NEDMALLOC\_STACKBACKTRACEDEPTH];#endif} logentry;static const char \*LogEntryTypeStrings[]={ "LOGENTRY\_MALLOC", "LOGENTRY\_REALLOC", "LOGENTRY\_FREE",
 "LOGENTRY\_THREADCACHE\_MALLOC", "LOGENTRY\_THREADCACHE\_FREE", "LOGENTRY\_THREADCACHE\_CLEAN",
 "LOGENTRY\_POOL\_MALLOC", "LOGENTRY\_POOL\_REALLOC", "LOGENTRY\_POOL\_FREE", "\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*"};
struct threadcacheblk\_t;typedef struct threadcacheblk\_t threadcacheblk;struct threadcacheblk\_t{ /\* Keep less than 32 bytes as sizeof(threadcacheblk) is the minimum allocation size \*/#ifdef FULLSANITYCHECKS unsigned int magic;#endif int isforeign; unsigned int lastUsed; size\_t size; threadcacheblk \*RESTRICT next, \*RESTRICT prev;};typedef struct threadcache\_t{#ifdef FULLSANITYCHECKS unsigned int magic1;#endif int mymspace; /\* Last mspace entry this thread used \*/ long threadid; unsigned int mallocs, frees, successes;#if ENABLE\_LOGGING logentry \*logentries, \*logentriesptr, \*logentriesend;#endif size\_t freeInCache; /\* How much free space is stored in this cache \*/ threadcacheblk \*RESTRICT bins[(THREADCACHEMAXBINS+1)\*2];#ifdef FULLSANITYCHECKS unsigned int magic2;#endif} threadcache;struct nedpool\_t{#if USE\_LOCKS MLOCK\_T mutex;#endif void \*uservalue; int threads; /\* Max entries in m to use \*/ threadcache \*RESTRICT caches[THREADCACHEMAXCACHES]; TLSVAR mycache; /\* Thread cache for this thread. 0 for unset, negative for use mspace-1 directly, otherwise is cache-1 \*/ mstate m[MAXTHREADSINPOOL+1]; /\* mspace entries for this pool \*/};static nedpool syspool;
#if ENABLE\_LOGGING#if NEDMALLOC\_STACKBACKTRACEDEPTH#if defined(WIN32) && defined(\_MSC\_VER)#define COPY\_STRING(d, s, maxlen) { size\_t len=strlen(s); len=(len>maxlen) ? maxlen-1 : len; memcpy(d, s, len); d[len]=0; }
#pragma optimize("g", off)static int ExceptionFilter(unsigned int code, struct \_EXCEPTION\_POINTERS \*ep, CONTEXT \*ct) THROWSPEC{ \*ct=\*ep->ContextRecord; return EXCEPTION\_EXECUTE\_HANDLER;}
static DWORD64 \_\_stdcall GetModBase(HANDLE hProcess, DWORD64 dwAddr) THROWSPEC{ DWORD64 modulebase; // Try to get the module base if already loaded, otherwise load the module modulebase=SymGetModuleBase64(hProcess, dwAddr); if(modulebase) return modulebase; else { MEMORY\_BASIC\_INFORMATION stMBI ; if ( 0 != VirtualQueryEx ( hProcess, (LPCVOID)(size\_t)dwAddr, &stMBI, sizeof(stMBI))) { int n; DWORD dwPathLen=0, dwNameLen=0 ; TCHAR szFile[ MAX\_PATH ], szModuleName[ MAX\_PATH ] ; MODULEINFO mi={0}; dwPathLen = GetModuleFileName ( (HMODULE) stMBI.AllocationBase , szFile, MAX\_PATH ); dwNameLen = GetModuleBaseName (hProcess, (HMODULE) stMBI.AllocationBase , szModuleName, MAX\_PATH ); for(n=dwNameLen; n>0; n--) { if(szModuleName[n]=='.') { szModuleName[n]=0; break; } } if(!GetModuleInformation(hProcess, (HMODULE) stMBI.AllocationBase, &mi, sizeof(mi))) { //fxmessage("WARNING: GetModuleInformation() returned error code %d\n", GetLastError()); } if(!SymLoadModule64 ( hProcess, NULL, (PSTR)( (dwPathLen) ? szFile : 0), (PSTR)( (dwNameLen) ? szModuleName : 0), (DWORD64) mi.lpBaseOfDll, mi.SizeOfImage)) { //fxmessage("WARNING: SymLoadModule64() returned error code %d\n", GetLastError()); } //fxmessage("%s, %p, %x, %x\n", szFile, mi.lpBaseOfDll, mi.SizeOfImage, (DWORD) mi.lpBaseOfDll+mi.SizeOfImage); modulebase=SymGetModuleBase64(hProcess, dwAddr); return modulebase; } } return 0;}
extern HANDLE sym\_myprocess;extern VOID (WINAPI \*RtlCaptureContextAddr)(PCONTEXT);extern void DeinitSym(void) THROWSPEC;static void DoStackWalk(logentry \*p) THROWSPEC{ int i,i2; HANDLE mythread=(HANDLE) GetCurrentThread(); STACKFRAME64 sf={ 0 }; CONTEXT ct={ 0 }; if(!sym\_myprocess) { DWORD symopts; DuplicateHandle(GetCurrentProcess(), GetCurrentProcess(), GetCurrentProcess(), &sym\_myprocess, 0, FALSE, DUPLICATE\_SAME\_ACCESS); symopts=SymGetOptions(); SymSetOptions(symopts /\*| SYMOPT\_DEFERRED\_LOADS\*/ | SYMOPT\_LOAD\_LINES); SymInitialize(sym\_myprocess, NULL, TRUE); atexit(DeinitSym); } ct.ContextFlags=CONTEXT\_FULL;
 // Use RtlCaptureContext() if we have it as it saves an exception throw if((VOID (WINAPI \*)(PCONTEXT)) -1==RtlCaptureContextAddr) RtlCaptureContextAddr=(VOID (WINAPI \*)(PCONTEXT)) GetProcAddress(GetModuleHandle(L"kernel32"), "RtlCaptureContext"); if(RtlCaptureContextAddr) RtlCaptureContextAddr(&ct); else { // This is nasty, but it works \_\_try { int \*foo=0; \*foo=78; } \_\_except (ExceptionFilter(GetExceptionCode(), GetExceptionInformation(), &ct)) { } }
 sf.AddrPC.Mode=sf.AddrStack.Mode=sf.AddrFrame.Mode=AddrModeFlat;#if !(defined(\_M\_AMD64) || defined(\_M\_X64)) sf.AddrPC.Offset =ct.Eip; sf.AddrStack.Offset=ct.Esp; sf.AddrFrame.Offset=ct.Ebp;#else sf.AddrPC.Offset =ct.Rip; sf.AddrStack.Offset=ct.Rsp; sf.AddrFrame.Offset=ct.Rbp; // maybe Rdi?#endif for(i2=0; i2<NEDMALLOC\_STACKBACKTRACEDEPTH; i2++) { IMAGEHLP\_MODULE64 ihm={ sizeof(IMAGEHLP\_MODULE64) }; char temp[MAX\_PATH+sizeof(IMAGEHLP\_SYMBOL64)]; IMAGEHLP\_SYMBOL64 \*ihs; IMAGEHLP\_LINE64 ihl={ sizeof(IMAGEHLP\_LINE64) }; DWORD64 offset; if(!StackWalk64(#if !(defined(\_M\_AMD64) || defined(\_M\_X64)) IMAGE\_FILE\_MACHINE\_I386,#else IMAGE\_FILE\_MACHINE\_AMD64,#endif sym\_myprocess, mythread, &sf, &ct, NULL, SymFunctionTableAccess64, GetModBase, NULL)) break; if(0==sf.AddrPC.Offset) break; i=i2; if(i) // Skip first entry relating to this function { DWORD lineoffset=0; p->stack[i-1].pc=(void \*)(size\_t) sf.AddrPC.Offset; if(SymGetModuleInfo64(sym\_myprocess, sf.AddrPC.Offset, &ihm)) { char \*leaf; leaf=strrchr(ihm.ImageName, '\\'); if(!leaf) leaf=ihm.ImageName-1; COPY\_STRING(p->stack[i-1].module, leaf+1, sizeof(p->stack[i-1].module)); } else strcpy(p->stack[i-1].module, "<unknown>"); //fxmessage("WARNING: SymGetModuleInfo64() returned error code %d\n", GetLastError()); memset(temp, 0, MAX\_PATH+sizeof(IMAGEHLP\_SYMBOL64)); ihs=(IMAGEHLP\_SYMBOL64 \*) temp; ihs->SizeOfStruct=sizeof(IMAGEHLP\_SYMBOL64); ihs->Address=sf.AddrPC.Offset; ihs->MaxNameLength=MAX\_PATH;
 if(SymGetSymFromAddr64(sym\_myprocess, sf.AddrPC.Offset, &offset, ihs)) { COPY\_STRING(p->stack[i-1].functname, ihs->Name, sizeof(p->stack[i-1].functname)); if(strlen(p->stack[i-1].functname)<sizeof(p->stack[i-1].functname)-8) { sprintf(strchr(p->stack[i-1].functname, 0), " +0x%x", offset); } } else strcpy(p->stack[i-1].functname, "<unknown>"); if(SymGetLineFromAddr64(sym\_myprocess, sf.AddrPC.Offset, &lineoffset, &ihl)) { char \*leaf; p->stack[i-1].lineno=ihl.LineNumber;
 leaf=strrchr(ihl.FileName, '\\'); if(!leaf) leaf=ihl.FileName-1; COPY\_STRING(p->stack[i-1].file, leaf+1, sizeof(p->stack[i-1].file)); } else strcpy(p->stack[i-1].file, "<unknown>"); } }}#pragma optimize("g", on)#elsestatic void DoStackWalk(logentry \*p) THROWSPEC{ void \*backtr[NEDMALLOC\_STACKBACKTRACEDEPTH]; size\_t size; char \*\*strings; size\_t i2; size=backtrace(backtr, NEDMALLOC\_STACKBACKTRACEDEPTH); strings=backtrace\_symbols(backtr, size); for(i2=0; i2<size; i2++) { // Format can be <file path>(<mangled symbol>+0x<offset>) [<pc>] // or can be <file path> [<pc>] int start=0, end=strlen(strings[i2]), which=0, idx;[View remainder of file in raw view](https://github.com/ned14/nedmalloc/raw/refs/heads/master/nedmalloc.c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


