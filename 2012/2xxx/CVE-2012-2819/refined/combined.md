=== Content from code.google.com_22133be6_20250126_060848.html ===



=== Content from trac.webkit.org_d96a853c_20250125_045912.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/118409/webkit "Changeset 118409")
* [Next Changeset](/changeset/118411/webkit "Changeset 118411") →

---

# Changeset 118410 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
May 24, 2012, 1:39:12 PM
([13 years](/timeline?from=2012-05-24T13%3A39%3A12-07%3A00&precision=second "See timeline at May 24, 2012, 1:39:12 PM") ago)
Author:
kbr@google.com
Message:

Merge 117191 - Assertion failure running Mozilla's WebGL performance regression tests

[​https://bugs.webkit.org/show\_bug.cgi?id=85942](https://bugs.webkit.org/show_bug.cgi?id=85942)

Reviewed by Stephen White.

Fixed incorrect assumptions about source formats and buffer sizes

when uploading to floating-point textures. Added code paths

supporting the necessary conversions.

Tests have been added to the WebGL conformance suite which cover

these new code paths; they verify uploads of HTMLCanvasElement,

HTMLImageElement, HTMLVideoElement, and ImageData to

floating-point textures. However, because floating-point texture

support is optional, and generally only supported on bots which

run with real GPUs and not in virtual machines, it isn't feasible

to incorporate these tests as layout tests.

Ran the new WebGL conformance tests in Chromium on Linux; all

pass.

* platform/graphics/GraphicsContext3D.cpp:

(WebCore::GraphicsContext3D::extractImageData):

Properly compute size of destination buffer.

(WebCore):

Add pack/unpack routines for converting RGBA8/BGRA8 to floating point.

(WebCore::doFloatingPointPacking):

Support RGBA8 and BGRA8 source formats.

(WebCore::isFloatingPointSource):

Factored out logic for assertions.

(WebCore::GraphicsContext3D::packPixels):

Generalized assertions and logic.

* platform/graphics/cairo/GraphicsContext3DCairo.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/cg/GraphicsContext3DCG.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/qt/GraphicsContext3DQt.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/skia/GraphicsContext3DSkia.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

TBR=​kbr@google.com

Review URL: [​https://chromiumcodereview.appspot.com/10444013](https://chromiumcodereview.appspot.com/10444013)

Location:
[branches/chromium/1132/Source/WebCore/platform/graphics](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics?rev=118410)
Files:

5 edited

* [GraphicsContext3D.cpp](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410 "Show entry in browser")
  (modified)
  ([12 diffs](#file0 "Show differences"))
* [cairo/GraphicsContext3DCairo.cpp](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=118410 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [cg/GraphicsContext3DCG.cpp](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=118410 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [qt/GraphicsContext3DQt.cpp](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=118410 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [skia/GraphicsContext3DSkia.cpp](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=118410 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp](/changeset/118410/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp "Show the changeset 118410 restricted to branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp")

  | [r114992](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L201 "Show revision 114992 of this file in browser") | [r118410](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L201 "Show revision 118410 of this file in browser") |  |
  | --- | --- | --- |
  | 201 | 201 | int width = imageData->width(); |
  | 202 | 202 | int height = imageData->height(); |
  | 203 |  | int dataBytes = width \* height \* 4; |
  | 204 |  | data.resize(dataBytes); |
  |  | 203 |  |
  |  | 204 | unsigned int packedSize; |
  |  | 205 | // Output data is tightly packed (alignment == 1). |
  |  | 206 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 207 | return false; |
  |  | 208 | data.resize(packedSize); |
  |  | 209 |  |
  | 205 | 210 | if (!packPixels(imageData->data()->data(), |
  | 206 | 211 | SourceFormatRGBA8, |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L705) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L710) |  |
  | 705 | 710 | } |
  | 706 | 711 |  |
  |  | 712 | void unpackOneRowOfRGBA8ToRGBA32F(const uint8\_t\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 713 | { |
  |  | 714 | const float scaleFactor = 1.0f / 255.0f; |
  |  | 715 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 716 | destination[0] = source[0] \* scaleFactor; |
  |  | 717 | destination[1] = source[1] \* scaleFactor; |
  |  | 718 | destination[2] = source[2] \* scaleFactor; |
  |  | 719 | destination[3] = source[3] \* scaleFactor; |
  |  | 720 | source += 4; |
  |  | 721 | destination += 4; |
  |  | 722 | } |
  |  | 723 | } |
  |  | 724 |  |
  |  | 725 | void unpackOneRowOfBGRA8ToRGBA32F(const uint8\_t\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 726 | { |
  |  | 727 | const float scaleFactor = 1.0f / 255.0f; |
  |  | 728 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 729 | destination[0] = source[2] \* scaleFactor; |
  |  | 730 | destination[1] = source[1] \* scaleFactor; |
  |  | 731 | destination[2] = source[0] \* scaleFactor; |
  |  | 732 | destination[3] = source[3] \* scaleFactor; |
  |  | 733 | source += 4; |
  |  | 734 | destination += 4; |
  |  | 735 | } |
  |  | 736 | } |
  |  | 737 |  |
  | 707 | 738 | void unpackOneRowOfRGB32FToRGBA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 708 | 739 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1063) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1094) |  |
  | 1063 | 1094 | } |
  | 1064 | 1095 |  |
  |  | 1096 | void packOneRowOfRGBA32FToRGB32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1097 | { |
  |  | 1098 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1099 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1100 | destination[0] = source[0] \* scaleFactor; |
  |  | 1101 | destination[1] = source[1] \* scaleFactor; |
  |  | 1102 | destination[2] = source[2] \* scaleFactor; |
  |  | 1103 | source += 4; |
  |  | 1104 | destination += 3; |
  |  | 1105 | } |
  |  | 1106 | } |
  |  | 1107 |  |
  |  | 1108 | // Used only during RGBA8 or BGRA8 -> floating-point uploads. |
  |  | 1109 | void packOneRowOfRGBA32FToRGBA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1110 | { |
  |  | 1111 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1112 | destination[0] = source[0]; |
  |  | 1113 | destination[1] = source[1]; |
  |  | 1114 | destination[2] = source[2]; |
  |  | 1115 | destination[3] = source[3]; |
  |  | 1116 | source += 4; |
  |  | 1117 | destination += 4; |
  |  | 1118 | } |
  |  | 1119 | } |
  |  | 1120 |  |
  | 1065 | 1121 | void packOneRowOfRGBA32FToRGBA32FPremultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 1066 | 1122 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1076) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1132) |  |
  | 1076 | 1132 | } |
  | 1077 | 1133 |  |
  |  | 1134 | void packOneRowOfRGBA32FToRGBA32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1135 | { |
  |  | 1136 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1137 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1138 | destination[0] = source[0] \* scaleFactor; |
  |  | 1139 | destination[1] = source[1] \* scaleFactor; |
  |  | 1140 | destination[2] = source[2] \* scaleFactor; |
  |  | 1141 | destination[3] = source[3]; |
  |  | 1142 | source += 4; |
  |  | 1143 | destination += 4; |
  |  | 1144 | } |
  |  | 1145 | } |
  |  | 1146 |  |
  | 1078 | 1147 | void packOneRowOfRGBA32FToA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 1079 | 1148 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1104) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1173) |  |
  | 1104 | 1173 | } |
  | 1105 | 1174 |  |
  |  | 1175 | void packOneRowOfRGBA32FToR32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1176 | { |
  |  | 1177 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1178 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1179 | destination[0] = source[0] \* scaleFactor; |
  |  | 1180 | source += 4; |
  |  | 1181 | destination += 1; |
  |  | 1182 | } |
  |  | 1183 | } |
  | 1106 | 1184 |  |
  | 1107 | 1185 | void packOneRowOfRGBA32FToRA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1120) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1198) |  |
  | 1120 | 1198 | float scaleFactor = source[3]; |
  | 1121 | 1199 | destination[0] = source[0] \* scaleFactor; |
  | 1122 |  | destination[1] = scaleFactor; |
  |  | 1200 | destination[1] = source[3]; |
  |  | 1201 | source += 4; |
  |  | 1202 | destination += 2; |
  |  | 1203 | } |
  |  | 1204 | } |
  |  | 1205 |  |
  |  | 1206 | void packOneRowOfRGBA32FToRA32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1207 | { |
  |  | 1208 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1209 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1210 | destination[0] = source[0] \* scaleFactor; |
  |  | 1211 | destination[1] = source[3]; |
  | 1123 | 1212 | source += 4; |
  | 1124 | 1213 | destination += 2; |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1368) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1457) |  |
  | 1368 | 1457 | switch (sourceDataFormat) { |
  | 1369 | 1458 | case GraphicsContext3D::SourceFormatRGBA8: { |
  |  | 1459 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<uint8\_t>(width, 4, sourceUnpackAlignment); |
  |  | 1460 | doUnpackingAndPacking<uint8\_t, float, float>(static\_cast<const uint8\_t\*>(sourceData), unpackOneRowOfRGBA8ToRGBA32F, width, height, sourceElementsPerRow, destinationData, rowPackingFunc, destinationElementsPerPixel); |
  |  | 1461 | break; |
  |  | 1462 | } |
  |  | 1463 | case GraphicsContext3D::SourceFormatBGRA8: { |
  |  | 1464 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<uint8\_t>(width, 4, sourceUnpackAlignment); |
  |  | 1465 | doUnpackingAndPacking<uint8\_t, float, float>(static\_cast<const uint8\_t\*>(sourceData), unpackOneRowOfBGRA8ToRGBA32F, width, height, sourceElementsPerRow, destinationData, rowPackingFunc, destinationElementsPerPixel); |
  |  | 1466 | break; |
  |  | 1467 | } |
  |  | 1468 | case GraphicsContext3D::SourceFormatRGBA32F: { |
  | 1370 | 1469 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<float>(width, 4, sourceUnpackAlignment); |
  | 1371 | 1470 | const float\* source = static\_cast<const float\*>(sourceData); |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1404) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1503) |  |
  | 1404 | 1503 | } |
  | 1405 | 1504 |  |
  |  | 1505 |  |
  |  | 1506 | #if !ASSERT\_DISABLED |
  |  | 1507 | static bool isFloatingPointSource(GraphicsContext3D::SourceDataFormat format) |
  |  | 1508 | { |
  |  | 1509 | switch (format) { |
  |  | 1510 | case GraphicsContext3D::SourceFormatRGBA32F: |
  |  | 1511 | case GraphicsContext3D::SourceFormatRGB32F: |
  |  | 1512 | case GraphicsContext3D::SourceFormatRA32F: |
  |  | 1513 | case GraphicsContext3D::SourceFormatR32F: |
  |  | 1514 | case GraphicsContext3D::SourceFormatA32F: |
  |  | 1515 | return true; |
  |  | 1516 | default: |
  |  | 1517 | return false; |
  |  | 1518 | } |
  |  | 1519 | } |
  |  | 1520 | #endif |
  |  | 1521 |  |
  | 1406 | 1522 | bool GraphicsContext3D::packPixels(const uint8\_t\* sourceData, |
  | 1407 | 1523 | GraphicsContext3D::SourceDataFormat sourceDataFormat, |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1540) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1656) |  |
  | 1540 | 1656 | case FLOAT: { |
  | 1541 | 1657 | // OpenGL ES, and therefore WebGL, require that the format and |
  | 1542 |  | // internalformat be identical, which implies that the source and |
  | 1543 |  | // destination formats will both be floating-point in this branch -- at |
  | 1544 |  | // least, until WebKit supports floating-point image formats natively. |
  | 1545 |  | ASSERT(sourceDataFormat == SourceFormatRGBA32F || sourceDataFormat == SourceFormatRGB32F |
  | 1546 |  | || sourceDataFormat == SourceFormatRA32F || sourceDataFormat == SourceFormatR32F |
  | 1547 |  | || sourceDataFormat == SourceFormatA32F); |
  | 1548 |  | // Because WebKit doesn't use floating-point color channels for anything |
  | 1549 |  | // internally, there's no chance we have to do a (lossy) unmultiply |
  | 1550 |  | // operation. |
  | 1551 |  | ASSERT(alphaOp == AlphaDoNothing || alphaOp == AlphaDoPremultiply); |
  |  | 1658 | // internalformat be identical. This means that whenever the |
  |  | 1659 | // developer supplies an ArrayBufferView on this code path, |
  |  | 1660 | // the source data will be in a floating-point format. |
  |  | 1661 | // |
  |  | 1662 | // The only time the source data will not be floating-point is |
  |  | 1663 | // when uploading a DOM element or ImageData as a |
  |  | 1664 | // floating-point texture. Only RGBA8 and BGRA8 are handled in |
  |  | 1665 | // this case. |
  |  | 1666 | ASSERT(isFloatingPointSource(sourceDataFormat) |
  |  | 1667 | || sourceDataFormat == SourceFormatRGBA8 |
  |  | 1668 | || sourceDataFormat == SourceFormatBGRA8); |
  |  | 1669 | // When uploading a canvas into a floating-point texture, |
  |  | 1670 | // unmultiplication may be necessary. |
  |  | 1671 | ASSERT((alphaOp == AlphaDoNothing || alphaOp == AlphaDoPremultiply) |
  |  | 1672 | || !isFloatingPointSource(sourceDataFormat)); |
  | 1552 | 1673 | // For the source formats with an even number of channels (RGBA32F, |
  | 1553 | 1674 | // RA32F) it is guaranteed that the pixel data is tightly packed because |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1571) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1692) |  |
  | 1571 | 1692 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGB32FPremultiply, 3); |
  | 1572 | 1693 | break; |
  | 1573 |  | default: |
  | 1574 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1694 | case AlphaDoUnmultiply: |
  |  | 1695 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGB32FUnmultiply, 3); |
  |  | 1696 | break; |
  | 1575 | 1697 | } |
  | 1576 | 1698 | break; |
  | 1577 | 1699 | case RGBA: |
  | 1578 |  | // AlphaDoNothing is handled above with fast path. |
  | 1579 |  | ASSERT(alphaOp == AlphaDoPremultiply); |
  | 1580 |  | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FPremultiply, 4); |
  |  | 1700 | // AlphaDoNothing for RGBA32F -> RGBA is handled above with fast path. |
  |  | 1701 | ASSERT(alphaOp != AlphaDoNothing || sourceDataFormat != SourceFormatRGBA32F); |
  |  | 1702 | switch (alphaOp) { |
  |  | 1703 | case AlphaDoNothing: |
  |  | 1704 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32F, 4); |
  |  | 1705 | break; |
  |  | 1706 | case AlphaDoPremultiply: |
  |  | 1707 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FPremultiply, 4); |
  |  | 1708 | break; |
  |  | 1709 | case AlphaDoUnmultiply: |
  |  | 1710 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FUnmultiply, 4); |
  |  | 1711 | break; |
  |  | 1712 | } |
  | 1581 | 1713 | break; |
  | 1582 | 1714 | case ALPHA: |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1597) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1729) |  |
  | 1597 | 1729 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToR32FPremultiply, 1); |
  | 1598 | 1730 | break; |
  | 1599 |  | default: |
  | 1600 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1731 | case AlphaDoUnmultiply: |
  |  | 1732 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToR32FUnmultiply, 1); |
  |  | 1733 | break; |
  | 1601 | 1734 | } |
  | 1602 | 1735 | break; |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=114992#L1612) | […](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=118410#L1745) |  |
  | 1612 | 1745 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRA32FPremultiply, 2); |
  | 1613 | 1746 | break; |
  | 1614 |  | default: |
  | 1615 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1747 | case AlphaDoUnmultiply: |
  |  | 1748 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRA32FUnmultiply, 2); |
  |  | 1749 | break; |
  | 1616 | 1750 | } |
  | 1617 | 1751 | break; |
* ## [branches/chromium/1132/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp](/changeset/118410/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp "Show the changeset 118410 restricted to branches/chromium/1132/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp")

  | [r115385](/browser/webkit/trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=115385#L186 "Show revision 115385 of this file in browser") | [r118410](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=118410#L186 "Show revision 118410 of this file in browser") |  |
  | --- | --- | --- |
  | 186 | 186 | } |
  | 187 | 187 |  |
  | 188 |  | outputVector.resize(width \* height \* 4); |
  |  | 188 | unsigned int packedSize; |
  |  | 189 | // Output data is tightly packed (alignment == 1). |
  |  | 190 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 191 | return false; |
  |  | 192 | outputVector.resize(packedSize); |
  |  | 193 |  |
  | 189 | 194 | return packPixels(cairo\_image\_surface\_get\_data(imageSurface.get()), SourceFormatBGRA8, |
  | 190 | 195 | width, height, srcUnpackAlignment, format, type, alphaOp, outputVector.data()); |
* ## [branches/chromium/1132/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp](/changeset/118410/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp "Show the changeset 118410 restricted to branches/chromium/1132/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp")

  | [r95901](/browser/webkit/trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=95901#L241 "Show revision 95901 of this file in browser") | [r118410](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=118410#L241 "Show revision 118410 of this file in browser") |  |
  | --- | --- | --- |
  | 241 | 241 | return false; |
  | 242 | 242 | const UInt8\* rgba = CFDataGetBytePtr(pixelData.get()); |
  | 243 |  | outputVector.resize(width \* height \* 4); |
  |  | 243 |  |
  |  | 244 | unsigned int packedSize; |
  |  | 245 | // Output data is tightly packed (alignment == 1). |
  |  | 246 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 247 | return false; |
  |  | 248 | outputVector.resize(packedSize); |
  |  | 249 |  |
  | 244 | 250 | unsigned int srcUnpackAlignment = 0; |
  | 245 | 251 | size\_t bytesPerRow = CGImageGetBytesPerRow(cgImage); |
* ## [branches/chromium/1132/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp](/changeset/118410/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp "Show the changeset 118410 restricted to branches/chromium/1132/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp")

  | [r113733](/browser/webkit/trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=113733#L1615 "Show revision 113733 of this file in browser") | [r118410](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=118410#L1615 "Show revision 118410 of this file in browser") |  |
  | --- | --- | --- |
  | 1615 | 1615 | if (premultiplyAlpha) |
  | 1616 | 1616 | neededAlphaOp = AlphaDoPremultiply; |
  | 1617 |  | outputVector.resize(nativeImage.byteCount()); |
  |  | 1617 |  |
  |  | 1618 | unsigned int packedSize; |
  |  | 1619 | // Output data is tightly packed (alignment == 1). |
  |  | 1620 | if (computeImageSizeInBytes(format, type, image->width(), image->height(), 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 1621 | return false; |
  |  | 1622 | outputVector.resize(packedSize); |
  |  | 1623 |  |
  | 1618 | 1624 | return packPixels(nativeImage.bits(), SourceFormatBGRA8, image->width(), image->height(), 0, format, type, neededAlphaOp, outputVector.data()); |
  | 1619 | 1625 | } |
* ## [branches/chromium/1132/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp](/changeset/118410/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp "Show the changeset 118410 restricted to branches/chromium/1132/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp")

  | [r95901](/browser/webkit/trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=95901#L80 "Show revision 95901 of this file in browser") | [r118410](/browser/webkit/branches/chromium/1132/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=118410#L80 "Show revision 118410 of this file in browser") |  |
  | --- | --- | --- |
  | 80 | 80 | SkAutoLockPixels lock(skiaImageRef); |
  | 81 | 81 | ASSERT(skiaImageRef.rowBytes() == skiaImageRef.width() \* 4); |
  | 82 |  | outputVector.resize(skiaImageRef.rowBytes() \* skiaImageRef.height()); |
  |  | 82 | unsigned int packedSize; |
  |  | 83 | // Output data is tightly packed (alignment == 1). |
  |  | 84 | if (computeImageSizeInBytes(format, type, skiaImageRef.width(), skiaImageRef.height(), 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 85 | return false; |
  |  | 86 | outputVector.resize(packedSize); |
  | 83 | 87 | return packPixels(reinterpret\_cast<const uint8\_t\*>(skiaImageRef.getPixels()), |
  | 84 | 88 | SK\_B32\_SHIFT ? SourceFormatRGBA8 : SourceFormatBGRA8, |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=118410)
* [Zip Archive](?format=zip&new=118410)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from googlechromereleases.blogspot.com_dd879c0b_20250125_045823.html ===


![](https://ad.doubleclick.net/ddm/activity/src=2542116;type=gblog;cat=googl0;ord=1?)

[![](https://www.gstatic.com/images/branding/googlelogo/2x/googlelogo_color_284x96dp.png)](https://chromereleases.googleblog.com/)
[## Chrome Releases](/.)

Release updates from the Chrome team

## [Stable Channel Update](https://chromereleases.googleblog.com/2012/06/stable-channel-update_26.html "Stable Channel Update")

Tuesday, June 26, 2012

**The Google Chrome team is happy to announce the arrival of Chrome 20 (20.0.1132.43) to the Stable Channel for Windows, Mac, Linux, and Chrome Frame.

Security fixes and rewards:

Please see [the Chromium security page](http://sites.google.com/a/chromium.org/dev/Home/chromium-security) for more detail. Note that the referenced bugs may be kept private until a majority of our users are up to date with the fix.**

* **[[118633](https://code.google.com/p/chromium/issues/detail?id=118633)] Low CVE-2012-2815: Leak of iframe fragment id. Credit to Elie Bursztein of Google.**
* **[Windows only] [[119150](https://code.google.com/p/chromium/issues/detail?id=119150)] [[119250](https://code.google.com/p/chromium/issues/detail?id=119250)] High CVE-2012-2816: Prevent sandboxed processes interfering with each other. Credit to Google Chrome Security Team (Justin Schuh).**
* **[$1000] [[120222](https://code.google.com/p/chromium/issues/detail?id=120222)] High CVE-2012-2817: Use-after-free in table section handling. Credit to miaubiz.**
* **[$1000] [[120944](https://code.google.com/p/chromium/issues/detail?id=120944)] High CVE-2012-2818: Use-after-free in counter layout. Credit to miaubiz.**
* **[[120977](https://code.google.com/p/chromium/issues/detail?id=120977)] High CVE-2012-2819: Crash in texture handling. Credit to Ken “gets” Russell of the Chromium development community.**
* **[[121926](https://code.google.com/p/chromium/issues/detail?id=121926)] Medium CVE-2012-2820: Out-of-bounds read in SVG filter handling. Credit to Atte Kettunen of OUSPG.**
* **[[122925](https://code.google.com/p/chromium/issues/detail?id=122925)] Medium CVE-2012-2821: Autofill display problem. Credit to “simonbrown60”.**
* **[various] Medium CVE-2012-2822: Misc. lower severity OOB read issues in PDF. Credit to awesome ASAN and various Googlers (Kostya Serebryany, Evgeniy Stepanov, Mateusz Jurczyk, Gynvael Coldwind).**
* **[$1000] [[124356](https://code.google.com/p/chromium/issues/detail?id=124356)] High CVE-2012-2823: Use-after-free in SVG resource handling. Credit to miaubiz.**
* **[$1000] [[125374](https://code.google.com/p/chromium/issues/detail?id=125374)] High CVE-2012-2824: Use-after-free in SVG painting. Credit to miaubiz.**
* **[[128688](https://code.google.com/p/chromium/issues/detail?id=128688)] Medium CVE-2012-2826: Out-of-bounds read in texture conversion. Credit to Google Chrome Security Team (Inferno).**
* **[Mac only] [[129826](https://code.google.com/p/chromium/issues/detail?id=129826)] Low CVE-2012-2827: Use-after-free in Mac UI. Credit to the Chromium development community (Dharani Govindan).**
* **[[129857](https://code.google.com/p/chromium/issues/detail?id=129857)] High CVE-2012-2828: Integer overflows in PDF. Credit to Mateusz Jurczyk of Google Security Team **with contributions by Gynvael Coldwind of Google Security Team** and Google Chrome Security Team (Chris Evans).**
* **[$1000] [[129947](https://code.google.com/p/chromium/issues/detail?id=129947)] High CVE-2012-2829: Use-after-free in first-letter handling. Credit to miaubiz.**
* **[$1000] [[129951](https://code.google.com/p/chromium/issues/detail?id=129951)] High CVE-2012-2830: Wild pointer in array value setting. Credit to miaubiz.**
* **[Windows only] [[130276](https://code.google.com/p/chromium/issues/detail?id=130276)] Low CVE-2012-2764: Unqualified load of metro DLL. Credit to Moshe Zioni of Comsec Consulting.**
* **[$1000] [[130356](https://code.google.com/p/chromium/issues/detail?id=130356)] High CVE-2012-2831: Use-after-free in SVG reference handling. Credit to miaubiz.**
* **[[131553](https://code.google.com/p/chromium/issues/detail?id=131553)] High CVE-2012-2832: Uninitialized pointer in PDF image codec. Credit to Mateusz Jurczyk of Google Security Team **with contributions by Gynvael Coldwind of Google Security Team**.**
* **[[132156](https://code.google.com/p/chromium/issues/detail?id=132156)] High CVE-2012-2833: Buffer overflow in PDF JS API. Credit to Mateusz Jurczyk of Google Security Team.**
* **[$1000] [[132779](https://code.google.com/p/chromium/issues/detail?id=132779)] High CVE-2012-2834: Integer overflow in Matroska container. Credit to Jüri Aedla.**

 **And some additional rewards for issues with a wider scope than Chrome:**

*** [$500] [[127417](https://code.google.com/p/chromium/issues/detail?id=127417)] Medium CVE-2012-2825: Wild read in XSL handling. Credit to Nicholas Gregoire.
* [64-bit Linux only] [$3000] [[129930](https://code.google.com/p/chromium/issues/detail?id=129930)] High CVE-2012-2807: Integer overflows in libxml. Credit to Jüri Aedla.**
**Many of the above bugs were detected using [AddressSanitizer](http://code.google.com/p/address-sanitizer/wiki/AddressSanitizer).

We’d also like to thank Arthur Gerkis, Atte Kettunen of OUSPG and miaubiz for working with us during the development cycle and preventing security regressions from ever reaching the stable channel. Various additional rewards were issued for this awesomeness.

Full details about what changes are in this release are available in the [SVN revision log](http://build.chromium.org/f/chromium/perf/dashboard/ui/changelog.html?url=/trunk/src&range=129376:135598&mode=html).  Interested in hopping on the stable channel?  [Find out how](http://dev.chromium.org/getting-involved/dev-channel).  If you find a new issue, please let us know by [filing a bug](http://new.crbug.com/).

Dharani Govindan
Google Chrome**

![Share on Twitter](https://www.gstatic.com/images/icons/material/system/2x/post_twitter_black_24dp.png)

![Share on Facebook](https://www.gstatic.com/images/icons/material/system/2x/post_facebook_black_24dp.png)

[Google](https://plus.google.com/112374322230920073195)
Labels:

[Stable updates](https://chromereleases.googleblog.com/search/label/Stable%20updates)

[**](https://chromereleases.googleblog.com/)
[**](https://chromereleases.googleblog.com/2012/06/chrome-for-android-out-of-beta.html "Newer Post")

[**](https://chromereleases.googleblog.com/2012/06/dev-channel-updates-for-chromebooks_26.html "Older Post")

![](data:image/png;base64...)
## Labels

**

* [Admin Console](https://chromereleases.googleblog.com/search/label/Admin%20Console)
  43
* [Android WebView](https://chromereleases.googleblog.com/search/label/Android%20WebView)
  19
* [Beta](https://chromereleases.googleblog.com/search/label/Beta)
  21
* [Beta update](https://chromereleases.googleblog.com/search/label/Beta%20update)
  4
* [Beta updates](https://chromereleases.googleblog.com/search/label/Beta%20updates)
  2037
* [chrome](https://chromereleases.googleblog.com/search/label/chrome)
  15
* [Chrome Dev for Android](https://chromereleases.googleblog.com/search/label/Chrome%20Dev%20for%20Android)
  135
* [Chrome for Android](https://chromereleases.googleblog.com/search/label/Chrome%20for%20Android)
  964
* [Chrome for iOS](https://chromereleases.googleblog.com/search/label/Chrome%20for%20iOS)
  388
* [Chrome for Meetings](https://chromereleases.googleblog.com/search/label/Chrome%20for%20Meetings)
  5
* [Chrome OS](https://chromereleases.googleblog.com/search/label/Chrome%20OS)
  1150
* [Chrome OS Flex](https://chromereleases.googleblog.com/search/label/Chrome%20OS%20Flex)
  24
* [Chrome OS Management](https://chromereleases.googleblog.com/search/label/Chrome%20OS%20Management)
  12
* [Chromecast Update](https://chromereleases.googleblog.com/search/label/Chromecast%20Update)
  6
* [ChromeOS](https://chromereleases.googleblog.com/search/label/ChromeOS)
  217
* [ChromeOS Flex](https://chromereleases.googleblog.com/search/label/ChromeOS%20Flex)
  213
* [Desktop Update](https://chromereleases.googleblog.com/search/label/Desktop%20Update)
  1133
* [dev update](https://chromereleases.googleblog.com/search/label/dev%20update)
  266
* [Dev updates](https://chromereleases.googleblog.com/search/label/Dev%20updates)
  1518
* [Early Stable Updates](https://chromereleases.googleblog.com/search/label/Early%20Stable%20Updates)
  50
* [Extended Stable updates](https://chromereleases.googleblog.com/search/label/Extended%20Stable%20updates)
  134
* [Flash Player update](https://chromereleases.googleblog.com/search/label/Flash%20Player%20update)
  5
* [Flex](https://chromereleases.googleblog.com/search/label/Flex)
  1
* [Hangouts Meet hardware](https://chromereleases.googleblog.com/search/label/Hangouts%20Meet%20hardware)
  5
* [LTS](https://chromereleases.googleblog.com/search/label/LTS)
  91
* [stable](https://chromereleases.googleblog.com/search/label/stable)
  11
* [Stable updates](https://chromereleases.googleblog.com/search/label/Stable%20updates)
  1260

**
## Archive

**

* **

  **
  [2025](https://chromereleases.googleblog.com/2025/)

  + [Jan](https://chromereleases.googleblog.com/2025/01/)

* **

  **
  [2024](https://chromereleases.googleblog.com/2024/)

  + [Dec](https://chromereleases.googleblog.com/2024/12/)
  + [Nov](https://chromereleases.googleblog.com/2024/11/)
  + [Oct](https://chromereleases.googleblog.com/2024/10/)
  + [Sep](https://chromereleases.googleblog.com/2024/09/)
  + [Aug](https://chromereleases.googleblog.com/2024/08/)
  + [Jul](https://chromereleases.googleblog.com/2024/07/)
  + [Jun](https://chromereleases.googleblog.com/2024/06/)
  + [May](https://chromereleases.googleblog.com/2024/05/)
  + [Apr](https://chromereleases.googleblog.com/2024/04/)
  + [Mar](https://chromereleases.googleblog.com/2024/03/)
  + [Feb](https://chromereleases.googleblog.com/2024/02/)
  + [Jan](https://chromereleases.googleblog.com/2024/01/)

* **

  **
  [2023](https://chromereleases.googleblog.com/2023/)

  + [Dec](https://chromereleases.googleblog.com/2023/12/)
  + [Nov](https://chromereleases.googleblog.com/2023/11/)
  + [Oct](https://chromereleases.googleblog.com/2023/10/)
  + [Sep](https://chromereleases.googleblog.com/2023/09/)
  + [Aug](https://chromereleases.googleblog.com/2023/08/)
  + [Jul](https://chromereleases.googleblog.com/2023/07/)
  + [Jun](https://chromereleases.googleblog.com/2023/06/)
  + [May](https://chromereleases.googleblog.com/2023/05/)
  + [Apr](https://chromereleases.googleblog.com/2023/04/)
  + [Mar](https://chromereleases.googleblog.com/2023/03/)
  + [Feb](https://chromereleases.googleblog.com/2023/02/)
  + [Jan](https://chromereleases.googleblog.com/2023/01/)

* **

  **
  [2022](https://chromereleases.googleblog.com/2022/)

  + [Dec](https://chromereleases.googleblog.com/2022/12/)
  + [Nov](https://chromereleases.googleblog.com/2022/11/)
  + [Oct](https://chromereleases.googleblog.com/2022/10/)
  + [Sep](https://chromereleases.googleblog.com/2022/09/)
  + [Aug](https://chromereleases.googleblog.com/2022/08/)
  + [Jul](https://chromereleases.googleblog.com/2022/07/)
  + [Jun](https://chromereleases.googleblog.com/2022/06/)
  + [May](https://chromereleases.googleblog.com/2022/05/)
  + [Apr](https://chromereleases.googleblog.com/2022/04/)
  + [Mar](https://chromereleases.googleblog.com/2022/03/)
  + [Feb](https://chromereleases.googleblog.com/2022/02/)
  + [Jan](https://chromereleases.googleblog.com/2022/01/)

* **

  **
  [2021](https://chromereleases.googleblog.com/2021/)

  + [Dec](https://chromereleases.googleblog.com/2021/12/)
  + [Nov](https://chromereleases.googleblog.com/2021/11/)
  + [Oct](https://chromereleases.googleblog.com/2021/10/)
  + [Sep](https://chromereleases.googleblog.com/2021/09/)
  + [Aug](https://chromereleases.googleblog.com/2021/08/)
  + [Jul](https://chromereleases.googleblog.com/2021/07/)
  + [Jun](https://chromereleases.googleblog.com/2021/06/)
  + [May](https://chromereleases.googleblog.com/2021/05/)
  + [Apr](https://chromereleases.googleblog.com/2021/04/)
  + [Mar](https://chromereleases.googleblog.com/2021/03/)
  + [Feb](https://chromereleases.googleblog.com/2021/02/)
  + [Jan](https://chromereleases.googleblog.com/2021/01/)

* **

  **
  [2020](https://chromereleases.googleblog.com/2020/)

  + [Dec](https://chromereleases.googleblog.com/2020/12/)
  + [Nov](https://chromereleases.googleblog.com/2020/11/)
  + [Oct](https://chromereleases.googleblog.com/2020/10/)
  + [Sep](https://chromereleases.googleblog.com/2020/09/)
  + [Aug](https://chromereleases.googleblog.com/2020/08/)
  + [Jul](https://chromereleases.googleblog.com/2020/07/)
  + [Jun](https://chromereleases.googleblog.com/2020/06/)
  + [May](https://chromereleases.googleblog.com/2020/05/)
  + [Apr](https://chromereleases.googleblog.com/2020/04/)
  + [Mar](https://chromereleases.googleblog.com/2020/03/)
  + [Feb](https://chromereleases.googleblog.com/2020/02/)
  + [Jan](https://chromereleases.googleblog.com/2020/01/)

* **

  **
  [2019](https://chromereleases.googleblog.com/2019/)

  + [Dec](https://chromereleases.googleblog.com/2019/12/)
  + [Nov](https://chromereleases.googleblog.com/2019/11/)
  + [Oct](https://chromereleases.googleblog.com/2019/10/)
  + [Sep](https://chromereleases.googleblog.com/2019/09/)
  + [Aug](https://chromereleases.googleblog.com/2019/08/)
  + [Jul](https://chromereleases.googleblog.com/2019/07/)
  + [Jun](https://chromereleases.googleblog.com/2019/06/)
  + [May](https://chromereleases.googleblog.com/2019/05/)
  + [Apr](https://chromereleases.googleblog.com/2019/04/)
  + [Mar](https://chromereleases.googleblog.com/2019/03/)
  + [Feb](https://chromereleases.googleblog.com/2019/02/)
  + [Jan](https://chromereleases.googleblog.com/2019/01/)

* **

  **
  [2018](https://chromereleases.googleblog.com/2018/)

  + [Dec](https://chromereleases.googleblog.com/2018/12/)
  + [Nov](https://chromereleases.googleblog.com/2018/11/)
  + [Oct](https://chromereleases.googleblog.com/2018/10/)
  + [Sep](https://chromereleases.googleblog.com/2018/09/)
  + [Aug](https://chromereleases.googleblog.com/2018/08/)
  + [Jul](https://chromereleases.googleblog.com/2018/07/)
  + [Jun](https://chromereleases.googleblog.com/2018/06/)
  + [May](https://chromereleases.googleblog.com/2018/05/)
  + [Apr](https://chromereleases.googleblog.com/2018/04/)
  + [Mar](https://chromereleases.googleblog.com/2018/03/)
  + [Feb](https://chromereleases.googleblog.com/2018/02/)
  + [Jan](https://chromereleases.googleblog.com/2018/01/)

* **

  **
  [2017](https://chromereleases.googleblog.com/2017/)

  + [Dec](https://chromereleases.googleblog.com/2017/12/)
  + [Nov](https://chromereleases.googleblog.com/2017/11/)
  + [Oct](https://chromereleases.googleblog.com/2017/10/)
  + [Sep](https://chromereleases.googleblog.com/2017/09/)
  + [Aug](https://chromereleases.googleblog.com/2017/08/)
  + [Jul](https://chromereleases.googleblog.com/2017/07/)
  + [Jun](https://chromereleases.googleblog.com/2017/06/)
  + [May](https://chromereleases.googleblog.com/2017/05/)
  + [Apr](https://chromereleases.googleblog.com/2017/04/)
  + [Mar](https://chromereleases.googleblog.com/2017/03/)
  + [Feb](https://chromereleases.googleblog.com/2017/02/)
  + [Jan](https://chromereleases.googleblog.com/2017/01/)

* **

  **
  [2016](https://chromereleases.googleblog.com/2016/)

  + [Dec](https://chromereleases.googleblog.com/2016/12/)
  + [Nov](https://chromereleases.googleblog.com/2016/11/)
  + [Oct](https://chromereleases.googleblog.com/2016/10/)
  + [Sep](https://chromereleases.googleblog.com/2016/09/)
  + [Aug](https://chromereleases.googleblog.com/2016/08/)
  + [Jul](https://chromereleases.googleblog.com/2016/07/)
  + [Jun](https://chromereleases.googleblog.com/2016/06/)
  + [May](https://chromereleases.googleblog.com/2016/05/)
  + [Apr](https://chromereleases.googleblog.com/2016/04/)
  + [Mar](https://chromereleases.googleblog.com/2016/03/)
  + [Feb](https://chromereleases.googleblog.com/2016/02/)
  + [Jan](https://chromereleases.googleblog.com/2016/01/)

* **

  **
  [2015](https://chromereleases.googleblog.com/2015/)

  + [Dec](https://chromereleases.googleblog.com/2015/12/)
  + [Nov](https://chromereleases.googleblog.com/2015/11/)
  + [Oct](https://chromereleases.googleblog.com/2015/10/)
  + [Sep](https://chromereleases.googleblog.com/2015/09/)
  + [Aug](https://chromereleases.googleblog.com/2015/08/)
  + [Jul](https://chromereleases.googleblog.com/2015/07/)
  + [Jun](https://chromereleases.googleblog.com/2015/06/)
  + [May](https://chromereleases.googleblog.com/2015/05/)
  + [Apr](https://chromereleases.googleblog.com/2015/04/)
  + [Mar](https://chromereleases.googleblog.com/2015/03/)
  + [Feb](https://chromereleases.googleblog.com/2015/02/)
  + [Jan](https://chromereleases.googleblog.com/2015/01/)

* **

  **
  [2014](https://chromereleases.googleblog.com/2014/)

  + [Dec](https://chromereleases.googleblog.com/2014/12/)
  + [Nov](https://chromereleases.googleblog.com/2014/11/)
  + [Oct](https://chromereleases.googleblog.com/2014/10/)
  + [Sep](https://chromereleases.googleblog.com/2014/09/)
  + [Aug](https://chromereleases.googleblog.com/2014/08/)
  + [Jul](https://chromereleases.googleblog.com/2014/07/)
  + [Jun](https://chromereleases.googleblog.com/2014/06/)
  + [May](https://chromereleases.googleblog.com/2014/05/)
  + [Apr](https://chromereleases.googleblog.com/2014/04/)
  + [Mar](https://chromereleases.googleblog.com/2014/03/)
  + [Feb](https://chromereleases.googleblog.com/2014/02/)
  + [Jan](https://chromereleases.googleblog.com/2014/01/)

* **

  **
  [2013](https://chromereleases.googleblog.com/2013/)

  + [Dec](https://chromereleases.googleblog.com/2013/12/)
  + [Nov](https://chromereleases.googleblog.com/2013/11/)
  + [Oct](https://chromereleases.googleblog.com/2013/10/)
  + [Sep](https://chromereleases.googleblog.com/2013/09/)
  + [Aug](https://chromereleases.googleblog.com/2013/08/)
  + [Jul](https://chromereleases.googleblog.com/2013/07/)
  + [Jun](https://chromereleases.googleblog.com/2013/06/)
  + [May](https://chromereleases.googleblog.com/2013/05/)
  + [Apr](https://chromereleases.googleblog.com/2013/04/)
  + [Mar](https://chromereleases.googleblog.com/2013/03/)
  + [Feb](https://chromereleases.googleblog.com/2013/02/)
  + [Jan](https://chromereleases.googleblog.com/2013/01/)

* **

  **
  [2012](https://chromereleases.googleblog.com/2012/)

  + [Dec](https://chromereleases.googleblog.com/2012/12/)
  + [Nov](https://chromereleases.googleblog.com/2012/11/)
  + [Oct](https://chromereleases.googleblog.com/2012/10/)
  + [Sep](https://chromereleases.googleblog.com/2012/09/)
  + [Aug](https://chromereleases.googleblog.com/2012/08/)
  + [Jul](https://chromereleases.googleblog.com/2012/07/)
  + [Jun](https://chromereleases.googleblog.com/2012/06/)
  + [May](https://chromereleases.googleblog.com/2012/05/)
  + [Apr](https://chromereleases.googleblog.com/2012/04/)
  + [Mar](https://chromereleases.googleblog.com/2012/03/)
  + [Feb](https://chromereleases.googleblog.com/2012/02/)
  + [Jan](https://chromereleases.googleblog.com/2012/01/)

* **

  **
  [2011](https://chromereleases.googleblog.com/2011/)

  + [Dec](https://chromereleases.googleblog.com/2011/12/)
  + [Nov](https://chromereleases.googleblog.com/2011/11/)
  + [Oct](https://chromereleases.googleblog.com/2011/10/)
  + [Sep](https://chromereleases.googleblog.com/2011/09/)
  + [Aug](https://chromereleases.googleblog.com/2011/08/)
  + [Jul](https://chromereleases.googleblog.com/2011/07/)
  + [Jun](https://chromereleases.googleblog.com/2011/06/)
  + [May](https://chromereleases.googleblog.com/2011/05/)
  + [Apr](https://chromereleases.googleblog.com/2011/04/)
  + [Mar](https://chromereleases.googleblog.com/2011/03/)
  + [Feb](https://chromereleases.googleblog.com/2011/02/)
  + [Jan](https://chromereleases.googleblog.com/2011/01/)

* **

  **
  [2010](https://chromereleases.googleblog.com/2010/)

  + [Dec](https://chromereleases.googleblog.com/2010/12/)
  + [Nov](https://chromereleases.googleblog.com/2010/11/)
  + [Oct](https://chromereleases.googleblog.com/2010/10/)
  + [Sep](https://chromereleases.googleblog.com/2010/09/)
  + [Aug](https://chromereleases.googleblog.com/2010/08/)
  + [Jul](https://chromereleases.googleblog.com/2010/07/)
  + [Jun](https://chromereleases.googleblog.com/2010/06/)
  + [May](https://chromereleases.googleblog.com/2010/05/)
  + [Apr](https://chromereleases.googleblog.com/2010/04/)
  + [Mar](https://chromereleases.googleblog.com/2010/03/)
  + [Feb](https://chromereleases.googleblog.com/2010/02/)
  + [Jan](https://chromereleases.googleblog.com/2010/01/)

* **

  **
  [2009](https://chromereleases.googleblog.com/2009/)

  + [Dec](https://chromereleases.googleblog.com/2009/12/)
  + [Nov](https://chromereleases.googleblog.com/2009/11/)
  + [Oct](https://chromereleases.googleblog.com/2009/10/)
  + [Sep](https://chromereleases.googleblog.com/2009/09/)
  + [Aug](https://chromereleases.googleblog.com/2009/08/)
  + [Jul](https://chromereleases.googleblog.com/2009/07/)
  + [Jun](https://chromereleases.googleblog.com/2009/06/)
  + [May](https://chromereleases.googleblog.com/2009/05/)
  + [Apr](https://chromereleases.googleblog.com/2009/04/)
  + [Mar](https://chromereleases.googleblog.com/2009/03/)
  + [Feb](https://chromereleases.googleblog.com/2009/02/)
  + [Jan](https://chromereleases.googleblog.com/2009/01/)

* **

  **
  [2008](https://chromereleases.googleblog.com/2008/)

  + [Dec](https://chromereleases.googleblog.com/2008/12/)
  + [Nov](https://chromereleases.googleblog.com/2008/11/)
  + [Oct](https://chromereleases.googleblog.com/2008/10/)
  + [Sep](https://chromereleases.googleblog.com/2008/09/)

Give us feedback in our
 [Product Forums](http://support.google.com/bin/static.py?hl=en&page=portal_groups.cs).

[![](data:image/png;base64...)](//www.google.com/)

* [Google](//www.google.com/)
* [Privacy](//www.google.com/policies/privacy/)
* [Terms](//www.google.com/policies/terms/)



=== Content from code.google.com_d61a6969_20250125_045821.html ===



=== Content from trac.webkit.org_c724be57_20250125_045848.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/117190/webkit "Changeset 117190")
* [Next Changeset](/changeset/117192/webkit "Changeset 117192") →

---

# Changeset 117191 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
May 15, 2012, 5:00:52 PM
([13 years](/timeline?from=2012-05-15T17%3A00%3A52-07%3A00&precision=second "See timeline at May 15, 2012, 5:00:52 PM") ago)
Author:
kbr@google.com
Message:

Assertion failure running Mozilla's WebGL performance regression tests

[​https://bugs.webkit.org/show\_bug.cgi?id=85942](https://bugs.webkit.org/show_bug.cgi?id=85942)

Reviewed by Stephen White.

Fixed incorrect assumptions about source formats and buffer sizes

when uploading to floating-point textures. Added code paths

supporting the necessary conversions.

Tests have been added to the WebGL conformance suite which cover

these new code paths; they verify uploads of HTMLCanvasElement,

HTMLImageElement, HTMLVideoElement, and ImageData to

floating-point textures. However, because floating-point texture

support is optional, and generally only supported on bots which

run with real GPUs and not in virtual machines, it isn't feasible

to incorporate these tests as layout tests.

Ran the new WebGL conformance tests in Chromium on Linux; all

pass.

* platform/graphics/GraphicsContext3D.cpp:

(WebCore::GraphicsContext3D::extractImageData):

Properly compute size of destination buffer.

(WebCore):

Add pack/unpack routines for converting RGBA8/BGRA8 to floating point.

(WebCore::doFloatingPointPacking):

Support RGBA8 and BGRA8 source formats.

(WebCore::isFloatingPointSource):

Factored out logic for assertions.

(WebCore::GraphicsContext3D::packPixels):

Generalized assertions and logic.

* platform/graphics/cairo/GraphicsContext3DCairo.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/cg/GraphicsContext3DCG.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/qt/GraphicsContext3DQt.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

* platform/graphics/skia/GraphicsContext3DSkia.cpp:

(WebCore::GraphicsContext3D::getImageData):

Properly compute size of destination buffer.

Location:
[trunk/Source/WebCore](/browser/webkit/trunk/Source/WebCore?rev=117191)
Files:

6 edited

* [ChangeLog](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=117191 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [platform/graphics/GraphicsContext3D.cpp](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191 "Show entry in browser")
  (modified)
  ([12 diffs](#file1 "Show differences"))
* [platform/graphics/cairo/GraphicsContext3DCairo.cpp](/browser/webkit/trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=117191 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [platform/graphics/cg/GraphicsContext3DCG.cpp](/browser/webkit/trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=117191 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [platform/graphics/qt/GraphicsContext3DQt.cpp](/browser/webkit/trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=117191 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [platform/graphics/skia/GraphicsContext3DSkia.cpp](/browser/webkit/trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=117191 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/Source/WebCore/ChangeLog](/changeset/117191/webkit/trunk/Source/WebCore/ChangeLog "Show the changeset 117191 restricted to trunk/Source/WebCore/ChangeLog")

  | [r117190](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=117190#L1 "Show revision 117190 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=117191#L1 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2012-05-15  Kenneth Russell  <kbr@google.com> |
  |  | 2 |  |
  |  | 3 | Assertion failure running Mozilla's WebGL performance regression tests |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=85942 |
  |  | 5 |  |
  |  | 6 | Reviewed by Stephen White. |
  |  | 7 |  |
  |  | 8 | Fixed incorrect assumptions about source formats and buffer sizes |
  |  | 9 | when uploading to floating-point textures. Added code paths |
  |  | 10 | supporting the necessary conversions. |
  |  | 11 |  |
  |  | 12 | Tests have been added to the WebGL conformance suite which cover |
  |  | 13 | these new code paths; they verify uploads of HTMLCanvasElement, |
  |  | 14 | HTMLImageElement, HTMLVideoElement, and ImageData to |
  |  | 15 | floating-point textures. However, because floating-point texture |
  |  | 16 | support is optional, and generally only supported on bots which |
  |  | 17 | run with real GPUs and not in virtual machines, it isn't feasible |
  |  | 18 | to incorporate these tests as layout tests. |
  |  | 19 |  |
  |  | 20 | Ran the new WebGL conformance tests in Chromium on Linux; all |
  |  | 21 | pass. |
  |  | 22 |  |
  |  | 23 | \* platform/graphics/GraphicsContext3D.cpp: |
  |  | 24 | (WebCore::GraphicsContext3D::extractImageData): |
  |  | 25 | Properly compute size of destination buffer. |
  |  | 26 |  |
  |  | 27 | (WebCore): |
  |  | 28 | Add pack/unpack routines for converting RGBA8/BGRA8 to floating point. |
  |  | 29 |  |
  |  | 30 | (WebCore::doFloatingPointPacking): |
  |  | 31 | Support RGBA8 and BGRA8 source formats. |
  |  | 32 |  |
  |  | 33 | (WebCore::isFloatingPointSource): |
  |  | 34 | Factored out logic for assertions. |
  |  | 35 |  |
  |  | 36 | (WebCore::GraphicsContext3D::packPixels): |
  |  | 37 | Generalized assertions and logic. |
  |  | 38 |  |
  |  | 39 | \* platform/graphics/cairo/GraphicsContext3DCairo.cpp: |
  |  | 40 | (WebCore::GraphicsContext3D::getImageData): |
  |  | 41 | Properly compute size of destination buffer. |
  |  | 42 |  |
  |  | 43 | \* platform/graphics/cg/GraphicsContext3DCG.cpp: |
  |  | 44 | (WebCore::GraphicsContext3D::getImageData): |
  |  | 45 | Properly compute size of destination buffer. |
  |  | 46 |  |
  |  | 47 | \* platform/graphics/qt/GraphicsContext3DQt.cpp: |
  |  | 48 | (WebCore::GraphicsContext3D::getImageData): |
  |  | 49 | Properly compute size of destination buffer. |
  |  | 50 |  |
  |  | 51 | \* platform/graphics/skia/GraphicsContext3DSkia.cpp: |
  |  | 52 | (WebCore::GraphicsContext3D::getImageData): |
  |  | 53 | Properly compute size of destination buffer. |
  |  | 54 |  |
  | 1 | 55 | 2012-05-15  James Robinson  <jamesr@chromium.org> |
  | 2 | 56 |  |
* ## [trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp](/changeset/117191/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp "Show the changeset 117191 restricted to trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp")

  | [r116198](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L201 "Show revision 116198 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L201 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  | 201 | 201 | int width = imageData->width(); |
  | 202 | 202 | int height = imageData->height(); |
  | 203 |  | int dataBytes = width \* height \* 4; |
  | 204 |  | data.resize(dataBytes); |
  |  | 203 |  |
  |  | 204 | unsigned int packedSize; |
  |  | 205 | // Output data is tightly packed (alignment == 1). |
  |  | 206 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 207 | return false; |
  |  | 208 | data.resize(packedSize); |
  |  | 209 |  |
  | 205 | 210 | if (!packPixels(imageData->data()->data(), |
  | 206 | 211 | SourceFormatRGBA8, |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L705) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L710) |  |
  | 705 | 710 | } |
  | 706 | 711 |  |
  |  | 712 | void unpackOneRowOfRGBA8ToRGBA32F(const uint8\_t\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 713 | { |
  |  | 714 | const float scaleFactor = 1.0f / 255.0f; |
  |  | 715 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 716 | destination[0] = source[0] \* scaleFactor; |
  |  | 717 | destination[1] = source[1] \* scaleFactor; |
  |  | 718 | destination[2] = source[2] \* scaleFactor; |
  |  | 719 | destination[3] = source[3] \* scaleFactor; |
  |  | 720 | source += 4; |
  |  | 721 | destination += 4; |
  |  | 722 | } |
  |  | 723 | } |
  |  | 724 |  |
  |  | 725 | void unpackOneRowOfBGRA8ToRGBA32F(const uint8\_t\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 726 | { |
  |  | 727 | const float scaleFactor = 1.0f / 255.0f; |
  |  | 728 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 729 | destination[0] = source[2] \* scaleFactor; |
  |  | 730 | destination[1] = source[1] \* scaleFactor; |
  |  | 731 | destination[2] = source[0] \* scaleFactor; |
  |  | 732 | destination[3] = source[3] \* scaleFactor; |
  |  | 733 | source += 4; |
  |  | 734 | destination += 4; |
  |  | 735 | } |
  |  | 736 | } |
  |  | 737 |  |
  | 707 | 738 | void unpackOneRowOfRGB32FToRGBA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 708 | 739 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1063) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1094) |  |
  | 1063 | 1094 | } |
  | 1064 | 1095 |  |
  |  | 1096 | void packOneRowOfRGBA32FToRGB32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1097 | { |
  |  | 1098 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1099 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1100 | destination[0] = source[0] \* scaleFactor; |
  |  | 1101 | destination[1] = source[1] \* scaleFactor; |
  |  | 1102 | destination[2] = source[2] \* scaleFactor; |
  |  | 1103 | source += 4; |
  |  | 1104 | destination += 3; |
  |  | 1105 | } |
  |  | 1106 | } |
  |  | 1107 |  |
  |  | 1108 | // Used only during RGBA8 or BGRA8 -> floating-point uploads. |
  |  | 1109 | void packOneRowOfRGBA32FToRGBA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1110 | { |
  |  | 1111 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1112 | destination[0] = source[0]; |
  |  | 1113 | destination[1] = source[1]; |
  |  | 1114 | destination[2] = source[2]; |
  |  | 1115 | destination[3] = source[3]; |
  |  | 1116 | source += 4; |
  |  | 1117 | destination += 4; |
  |  | 1118 | } |
  |  | 1119 | } |
  |  | 1120 |  |
  | 1065 | 1121 | void packOneRowOfRGBA32FToRGBA32FPremultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 1066 | 1122 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1076) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1132) |  |
  | 1076 | 1132 | } |
  | 1077 | 1133 |  |
  |  | 1134 | void packOneRowOfRGBA32FToRGBA32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1135 | { |
  |  | 1136 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1137 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1138 | destination[0] = source[0] \* scaleFactor; |
  |  | 1139 | destination[1] = source[1] \* scaleFactor; |
  |  | 1140 | destination[2] = source[2] \* scaleFactor; |
  |  | 1141 | destination[3] = source[3]; |
  |  | 1142 | source += 4; |
  |  | 1143 | destination += 4; |
  |  | 1144 | } |
  |  | 1145 | } |
  |  | 1146 |  |
  | 1078 | 1147 | void packOneRowOfRGBA32FToA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | 1079 | 1148 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1104) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1173) |  |
  | 1104 | 1173 | } |
  | 1105 | 1174 |  |
  |  | 1175 | void packOneRowOfRGBA32FToR32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1176 | { |
  |  | 1177 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1178 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1179 | destination[0] = source[0] \* scaleFactor; |
  |  | 1180 | source += 4; |
  |  | 1181 | destination += 1; |
  |  | 1182 | } |
  |  | 1183 | } |
  | 1106 | 1184 |  |
  | 1107 | 1185 | void packOneRowOfRGBA32FToRA32F(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1120) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1198) |  |
  | 1120 | 1198 | float scaleFactor = source[3]; |
  | 1121 | 1199 | destination[0] = source[0] \* scaleFactor; |
  | 1122 |  | destination[1] = scaleFactor; |
  |  | 1200 | destination[1] = source[3]; |
  |  | 1201 | source += 4; |
  |  | 1202 | destination += 2; |
  |  | 1203 | } |
  |  | 1204 | } |
  |  | 1205 |  |
  |  | 1206 | void packOneRowOfRGBA32FToRA32FUnmultiply(const float\* source, float\* destination, unsigned int pixelsPerRow) |
  |  | 1207 | { |
  |  | 1208 | for (unsigned int i = 0; i < pixelsPerRow; ++i) { |
  |  | 1209 | float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f; |
  |  | 1210 | destination[0] = source[0] \* scaleFactor; |
  |  | 1211 | destination[1] = source[3]; |
  | 1123 | 1212 | source += 4; |
  | 1124 | 1213 | destination += 2; |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1368) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1457) |  |
  | 1368 | 1457 | switch (sourceDataFormat) { |
  | 1369 | 1458 | case GraphicsContext3D::SourceFormatRGBA8: { |
  |  | 1459 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<uint8\_t>(width, 4, sourceUnpackAlignment); |
  |  | 1460 | doUnpackingAndPacking<uint8\_t, float, float>(static\_cast<const uint8\_t\*>(sourceData), unpackOneRowOfRGBA8ToRGBA32F, width, height, sourceElementsPerRow, destinationData, rowPackingFunc, destinationElementsPerPixel); |
  |  | 1461 | break; |
  |  | 1462 | } |
  |  | 1463 | case GraphicsContext3D::SourceFormatBGRA8: { |
  |  | 1464 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<uint8\_t>(width, 4, sourceUnpackAlignment); |
  |  | 1465 | doUnpackingAndPacking<uint8\_t, float, float>(static\_cast<const uint8\_t\*>(sourceData), unpackOneRowOfBGRA8ToRGBA32F, width, height, sourceElementsPerRow, destinationData, rowPackingFunc, destinationElementsPerPixel); |
  |  | 1466 | break; |
  |  | 1467 | } |
  |  | 1468 | case GraphicsContext3D::SourceFormatRGBA32F: { |
  | 1370 | 1469 | unsigned int sourceElementsPerRow = computeSourceElementsPerRow<float>(width, 4, sourceUnpackAlignment); |
  | 1371 | 1470 | const float\* source = static\_cast<const float\*>(sourceData); |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1404) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1503) |  |
  | 1404 | 1503 | } |
  | 1405 | 1504 |  |
  |  | 1505 |  |
  |  | 1506 | #if !ASSERT\_DISABLED |
  |  | 1507 | static bool isFloatingPointSource(GraphicsContext3D::SourceDataFormat format) |
  |  | 1508 | { |
  |  | 1509 | switch (format) { |
  |  | 1510 | case GraphicsContext3D::SourceFormatRGBA32F: |
  |  | 1511 | case GraphicsContext3D::SourceFormatRGB32F: |
  |  | 1512 | case GraphicsContext3D::SourceFormatRA32F: |
  |  | 1513 | case GraphicsContext3D::SourceFormatR32F: |
  |  | 1514 | case GraphicsContext3D::SourceFormatA32F: |
  |  | 1515 | return true; |
  |  | 1516 | default: |
  |  | 1517 | return false; |
  |  | 1518 | } |
  |  | 1519 | } |
  |  | 1520 | #endif |
  |  | 1521 |  |
  | 1406 | 1522 | bool GraphicsContext3D::packPixels(const uint8\_t\* sourceData, |
  | 1407 | 1523 | GraphicsContext3D::SourceDataFormat sourceDataFormat, |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1540) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1656) |  |
  | 1540 | 1656 | case FLOAT: { |
  | 1541 | 1657 | // OpenGL ES, and therefore WebGL, require that the format and |
  | 1542 |  | // internalformat be identical, which implies that the source and |
  | 1543 |  | // destination formats will both be floating-point in this branch -- at |
  | 1544 |  | // least, until WebKit supports floating-point image formats natively. |
  | 1545 |  | ASSERT(sourceDataFormat == SourceFormatRGBA32F || sourceDataFormat == SourceFormatRGB32F |
  | 1546 |  | || sourceDataFormat == SourceFormatRA32F || sourceDataFormat == SourceFormatR32F |
  | 1547 |  | || sourceDataFormat == SourceFormatA32F); |
  | 1548 |  | // Because WebKit doesn't use floating-point color channels for anything |
  | 1549 |  | // internally, there's no chance we have to do a (lossy) unmultiply |
  | 1550 |  | // operation. |
  | 1551 |  | ASSERT(alphaOp == AlphaDoNothing || alphaOp == AlphaDoPremultiply); |
  |  | 1658 | // internalformat be identical. This means that whenever the |
  |  | 1659 | // developer supplies an ArrayBufferView on this code path, |
  |  | 1660 | // the source data will be in a floating-point format. |
  |  | 1661 | // |
  |  | 1662 | // The only time the source data will not be floating-point is |
  |  | 1663 | // when uploading a DOM element or ImageData as a |
  |  | 1664 | // floating-point texture. Only RGBA8 and BGRA8 are handled in |
  |  | 1665 | // this case. |
  |  | 1666 | ASSERT(isFloatingPointSource(sourceDataFormat) |
  |  | 1667 | || sourceDataFormat == SourceFormatRGBA8 |
  |  | 1668 | || sourceDataFormat == SourceFormatBGRA8); |
  |  | 1669 | // When uploading a canvas into a floating-point texture, |
  |  | 1670 | // unmultiplication may be necessary. |
  |  | 1671 | ASSERT((alphaOp == AlphaDoNothing || alphaOp == AlphaDoPremultiply) |
  |  | 1672 | || !isFloatingPointSource(sourceDataFormat)); |
  | 1552 | 1673 | // For the source formats with an even number of channels (RGBA32F, |
  | 1553 | 1674 | // RA32F) it is guaranteed that the pixel data is tightly packed because |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1571) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1692) |  |
  | 1571 | 1692 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGB32FPremultiply, 3); |
  | 1572 | 1693 | break; |
  | 1573 |  | default: |
  | 1574 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1694 | case AlphaDoUnmultiply: |
  |  | 1695 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGB32FUnmultiply, 3); |
  |  | 1696 | break; |
  | 1575 | 1697 | } |
  | 1576 | 1698 | break; |
  | 1577 | 1699 | case RGBA: |
  | 1578 |  | // AlphaDoNothing is handled above with fast path. |
  | 1579 |  | ASSERT(alphaOp == AlphaDoPremultiply); |
  | 1580 |  | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FPremultiply, 4); |
  |  | 1700 | // AlphaDoNothing for RGBA32F -> RGBA is handled above with fast path. |
  |  | 1701 | ASSERT(alphaOp != AlphaDoNothing || sourceDataFormat != SourceFormatRGBA32F); |
  |  | 1702 | switch (alphaOp) { |
  |  | 1703 | case AlphaDoNothing: |
  |  | 1704 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32F, 4); |
  |  | 1705 | break; |
  |  | 1706 | case AlphaDoPremultiply: |
  |  | 1707 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FPremultiply, 4); |
  |  | 1708 | break; |
  |  | 1709 | case AlphaDoUnmultiply: |
  |  | 1710 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRGBA32FUnmultiply, 4); |
  |  | 1711 | break; |
  |  | 1712 | } |
  | 1581 | 1713 | break; |
  | 1582 | 1714 | case ALPHA: |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1597) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1729) |  |
  | 1597 | 1729 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToR32FPremultiply, 1); |
  | 1598 | 1730 | break; |
  | 1599 |  | default: |
  | 1600 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1731 | case AlphaDoUnmultiply: |
  |  | 1732 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToR32FUnmultiply, 1); |
  |  | 1733 | break; |
  | 1601 | 1734 | } |
  | 1602 | 1735 | break; |
  | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=116198#L1612) | […](/browser/webkit/trunk/Source/WebCore/platform/graphics/GraphicsContext3D.cpp?rev=117191#L1745) |  |
  | 1612 | 1745 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRA32FPremultiply, 2); |
  | 1613 | 1746 | break; |
  | 1614 |  | default: |
  | 1615 |  | ASSERT\_NOT\_REACHED(); |
  |  | 1747 | case AlphaDoUnmultiply: |
  |  | 1748 | doFloatingPointPacking(sourceData, sourceDataFormat, width, height, sourceUnpackAlignment, destination, packOneRowOfRGBA32FToRA32FUnmultiply, 2); |
  |  | 1749 | break; |
  | 1616 | 1750 | } |
  | 1617 | 1751 | break; |
* ## [trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp](/changeset/117191/webkit/trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp "Show the changeset 117191 restricted to trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp")

  | [r115385](/browser/webkit/trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=115385#L186 "Show revision 115385 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp?rev=117191#L186 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  | 186 | 186 | } |
  | 187 | 187 |  |
  | 188 |  | outputVector.resize(width \* height \* 4); |
  |  | 188 | unsigned int packedSize; |
  |  | 189 | // Output data is tightly packed (alignment == 1). |
  |  | 190 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 191 | return false; |
  |  | 192 | outputVector.resize(packedSize); |
  |  | 193 |  |
  | 189 | 194 | return packPixels(cairo\_image\_surface\_get\_data(imageSurface.get()), SourceFormatBGRA8, |
  | 190 | 195 | width, height, srcUnpackAlignment, format, type, alphaOp, outputVector.data()); |
* ## [trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp](/changeset/117191/webkit/trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp "Show the changeset 117191 restricted to trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp")

  | [r95901](/browser/webkit/trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=95901#L241 "Show revision 95901 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp?rev=117191#L241 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  | 241 | 241 | return false; |
  | 242 | 242 | const UInt8\* rgba = CFDataGetBytePtr(pixelData.get()); |
  | 243 |  | outputVector.resize(width \* height \* 4); |
  |  | 243 |  |
  |  | 244 | unsigned int packedSize; |
  |  | 245 | // Output data is tightly packed (alignment == 1). |
  |  | 246 | if (computeImageSizeInBytes(format, type, width, height, 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 247 | return false; |
  |  | 248 | outputVector.resize(packedSize); |
  |  | 249 |  |
  | 244 | 250 | unsigned int srcUnpackAlignment = 0; |
  | 245 | 251 | size\_t bytesPerRow = CGImageGetBytesPerRow(cgImage); |
* ## [trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp](/changeset/117191/webkit/trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp "Show the changeset 117191 restricted to trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp")

  | [r113733](/browser/webkit/trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=113733#L1615 "Show revision 113733 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp?rev=117191#L1615 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  | 1615 | 1615 | if (premultiplyAlpha) |
  | 1616 | 1616 | neededAlphaOp = AlphaDoPremultiply; |
  | 1617 |  | outputVector.resize(nativeImage.byteCount()); |
  |  | 1617 |  |
  |  | 1618 | unsigned int packedSize; |
  |  | 1619 | // Output data is tightly packed (alignment == 1). |
  |  | 1620 | if (computeImageSizeInBytes(format, type, image->width(), image->height(), 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 1621 | return false; |
  |  | 1622 | outputVector.resize(packedSize); |
  |  | 1623 |  |
  | 1618 | 1624 | return packPixels(nativeImage.bits(), SourceFormatBGRA8, image->width(), image->height(), 0, format, type, neededAlphaOp, outputVector.data()); |
  | 1619 | 1625 | } |
* ## [trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp](/changeset/117191/webkit/trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp "Show the changeset 117191 restricted to trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp")

  | [r95901](/browser/webkit/trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=95901#L80 "Show revision 95901 of this file in browser") | [r117191](/browser/webkit/trunk/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp?rev=117191#L80 "Show revision 117191 of this file in browser") |  |
  | --- | --- | --- |
  | 80 | 80 | SkAutoLockPixels lock(skiaImageRef); |
  | 81 | 81 | ASSERT(skiaImageRef.rowBytes() == skiaImageRef.width() \* 4); |
  | 82 |  | outputVector.resize(skiaImageRef.rowBytes() \* skiaImageRef.height()); |
  |  | 82 | unsigned int packedSize; |
  |  | 83 | // Output data is tightly packed (alignment == 1). |
  |  | 84 | if (computeImageSizeInBytes(format, type, skiaImageRef.width(), skiaImageRef.height(), 1, &packedSize, 0) != GraphicsContext3D::NO\_ERROR) |
  |  | 85 | return false; |
  |  | 86 | outputVector.resize(packedSize); |
  | 83 | 87 | return packPixels(reinterpret\_cast<const uint8\_t\*>(skiaImageRef.getPixels()), |
  | 84 | 88 | SK\_B32\_SHIFT ? SourceFormatRGBA8 : SourceFormatBGRA8, |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=117191)
* [Zip Archive](?format=zip&new=117191)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.webkit.org_acfab4a9_20250125_045913.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=85942&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[85942](show_bug.cgi?id=85942)

Assertion failure running Mozilla's WebGL performance regression tests
```
https://bugs.webkit.org/show_bug.cgi?id=85942
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
Assertion failure running Mozilla's WebGL performance regression tests

Kenneth Russell

[Reported](show_bug.cgi?id=85942#c0)
2012-05-08 18:28:47 PDT

While running Mozilla's WebGL performance regression tests from <http://hg.mozilla.org/users/bjacob_mozilla.com/webgl-perf-tests/raw-file/tip/webgl-performance-tests.html> in a debug build of WebKit (reproduced here in Chromium), the following assertion is hit:
ASSERT(sourceDataFormat == SourceFormatRGBA32F || sourceDataFormat == SourceFormatRGB32F...
in:
#0 0x00007f12af6201e3 in WebCore::GraphicsContext3D::packPixels (
this=0x7f129d75c5c0, sourceData=0x7f12988f3000 "4(",
sourceDataFormat=WebCore::GraphicsContext3D::SourceFormatBGRA8,
width=1024, height=1024, sourceUnpackAlignment=0, destinationFormat=6407,
destinationType=5126,
alphaOp=WebCore::GraphicsContext3D::AlphaDoUnmultiply,
destinationData=0x7f129b0b0000)
at ../../third\_party/WebKit/Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1545
#1 0x00007f12af6c5d2a in WebCore::GraphicsContext3D::getImageData (
this=0x7f129d75c5c0, image=0x7f129e03d780, format=6407, type=5126,
premultiplyAlpha=false, ignoreGammaAndColorProfile=false, outputVector=...)
at ../../third\_party/WebKit/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp:86
#2 0x00007f12af61cbdc in WebCore::GraphicsContext3D::extractImageData (
this=0x7f129d75c5c0, image=0x7f129e03d780, format=6407, type=5126,
flipY=false, premultiplyAlpha=false, ignoreGammaAndColorProfile=false,
data=...)
at ../../third\_party/WebKit/Source/WebCore/platform/graphics/GraphicsContext3D.cpp:173
#3 0x00007f12ad9a4685 in WebCore::WebGLRenderingContext::texSubImage2DImpl (
this=0x7f129dfe8580, target=3553, level=0, xoffset=0, yoffset=0,
format=6407, type=5126, image=0x7f129e03d780, flipY=false,
premultiplyAlpha=false, ec=@0x7fff26b6181c: 0)
at ../../third\_party/WebKit/Source/WebCore/html/canvas/WebGLRenderingContext.cpp:3725
#4 0x00007f12ad9a4d93 in WebCore::WebGLRenderingContext::texSubImage2D (
this=0x7f129dfe8580, target=3553, level=0, xoffset=0, yoffset=0,
format=6407, type=5126, canvas=0x7f129e041400, ec=@0x7fff26b6181c: 0)
at ../../third\_party/WebKit/Source/WebCore/html/canvas/WebGLRenderingContext.cpp:3809
This test suite is testing operations such as uploading an HTMLCanvasElement via texImage2D to a format and type of RGB and FLOAT. These code paths haven't been tested and are missing in the current code.

| Attachments | | |
| --- | --- | --- |
| [**Patch**](attachment.cgi?id=141540 "View the content of the attachment") (19.18 KB, patch)  [2012-05-11 18:20 PDT](#attach_141540 "Go to the comment associated with the attachment"), Kenneth Russell | *no flags* | [Details](attachment.cgi?id=141540&action=edit)[Formatted Diff](attachment.cgi?id=141540&action=prettypatch)[Diff](attachment.cgi?id=141540&action=diff) |
| [**Patch for landing**](attachment.cgi?id=142030 "View the content of the attachment") (19.20 KB, patch)  [2012-05-15 12:42 PDT](#attach_142030 "Go to the comment associated with the attachment"), Kenneth Russell | *no flags* | [Details](attachment.cgi?id=142030&action=edit)[Formatted Diff](attachment.cgi?id=142030&action=prettypatch)[Diff](attachment.cgi?id=142030&action=diff) |
| [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=85942&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=85942&action=enter) *proposed patch, testcase, etc.* | | |

Kenneth Russell

[Comment 1](show_bug.cgi?id=85942#c1)
2012-05-11 18:20:57 PDT

Created [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch")
Patch

James Robinson

[Comment 2](show_bug.cgi?id=85942#c2)
2012-05-11 18:28:18 PDT

Comment on [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch")
Patch
Can we add the tests that verify this behavior at the same time as the code change, or is that infeasible?

Kenneth Russell

[Comment 3](show_bug.cgi?id=85942#c3)
2012-05-12 17:01:52 PDT

(In reply to [comment #2](show_bug.cgi?id=85942#c2))
> (From update of [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch"))
> Can we add the tests that verify this behavior at the same time as the code change, or is that infeasible?
It's not feasible. These tests run only on bots with real GPUS, not virtual machines or (generally) headless bots. They will be run on Chromium's GPU waterfall so there will be some automated coverage, though downstream rather than on webkit.org.

Stephen White

[Comment 4](show_bug.cgi?id=85942#c4)
2012-05-14 07:07:47 PDT

Comment on [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=141540&action=review>
OK. r=me
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:715
> + const float scaleFactor = 1.0f / 255.0f;
Nit: this could be hoisted out of the loop.
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:728
> + const float scaleFactor = 1.0f / 255.0f;
Same here.
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1099
> + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
Might be clearer as
float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f;
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1137
> + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
Same here.
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1178
> + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
Same here.
> Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1209
> + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
Same here.

James Robinson

[Comment 5](show_bug.cgi?id=85942#c5)
2012-05-14 10:10:40 PDT

(In reply to [comment #3](show_bug.cgi?id=85942#c3))
> (In reply to [comment #2](show_bug.cgi?id=85942#c2))
> > (From update of [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch") [details])
> > Can we add the tests that verify this behavior at the same time as the code change, or is that infeasible?
>
> It's not feasible. These tests run only on bots with real GPUS, not virtual machines or (generally) headless bots. They will be run on Chromium's GPU waterfall so there will be some automated coverage, though downstream rather than on webkit.org.
If we can't get that test, can we at least add a test in this patch?

Kenneth Russell

[Comment 6](show_bug.cgi?id=85942#c6)
2012-05-15 12:42:46 PDT

Created [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing")
Patch for landing

Kenneth Russell

[Comment 7](show_bug.cgi?id=85942#c7)
2012-05-15 12:43:11 PDT

(In reply to [comment #4](show_bug.cgi?id=85942#c4))
> (From update of [attachment 141540](attachment.cgi?id=141540&action=diff "Patch") [[details]](attachment.cgi?id=141540&action=edit "Patch"))
> View in context: <https://bugs.webkit.org/attachment.cgi?id=141540&action=review>
>
> OK. r=me
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:715
> > + const float scaleFactor = 1.0f / 255.0f;
>
> Nit: this could be hoisted out of the loop.
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:728
> > + const float scaleFactor = 1.0f / 255.0f;
>
> Same here.
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1099
> > + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
>
> Might be clearer as
> float scaleFactor = source[3] ? 1.0f / source[3] : 1.0f;
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1137
> > + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
>
> Same here.
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1178
> > + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
>
> Same here.
>
> > Source/WebCore/platform/graphics/GraphicsContext3D.cpp:1209
> > + float scaleFactor = 1.0f / (source[3] ? source[3] : 1.0f);
>
> Same here.
Thanks for your review. Cleanups applied in patch for landing.

James Robinson

[Comment 8](show_bug.cgi?id=85942#c8)
2012-05-15 12:44:39 PDT

Comment on [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing")
Patch for landing
Absolutely no test at all? How is anyone else supposed to patch this code without regressing this behavior?

Kenneth Russell

[Comment 9](show_bug.cgi?id=85942#c9)
2012-05-15 12:48:43 PDT

(In reply to [comment #8](show_bug.cgi?id=85942#c8))
> (From update of [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing"))
> Absolutely no test at all? How is anyone else supposed to patch this code without regressing this behavior?
Regressions will be caught by developers running the WebGL conformance tests locally on their machine, or in automated fashion on the Chromium GPU waterfall. We could add GPU bots to test these code paths on build.webkit.org. This is a lot of work however and should not block fixing of an issue for which tests exist in a canonical place (even if they aren't, unfortunately, layout tests).

Stephen White

[Comment 10](show_bug.cgi?id=85942#c10)
2012-05-15 12:57:02 PDT

(In reply to [comment #9](show_bug.cgi?id=85942#c9))
> (In reply to [comment #8](show_bug.cgi?id=85942#c8))
> > (From update of [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing") [details])
> > Absolutely no test at all? How is anyone else supposed to patch this code without regressing this behavior?
>
> Regressions will be caught by developers running the WebGL conformance tests locally on their machine, or in automated fashion on the Chromium GPU waterfall. We could add GPU bots to test these code paths on build.webkit.org. This is a lot of work however and should not block fixing of an issue for which tests exist in a canonical place (even if they aren't, unfortunately, layout tests).
Is the issue lack of (guaranteed) support for FP32 texture formats? Does the current version of Mesa on Chrome's DRT support them? If so, could we turn them into layout tests, and simply mark them as Skipped on non-Chrome platforms? Or just put the tests in platform/chromium? If not, presumably a newer version of Mesa supports FP32, and we can just chuck it in the "do this after Mesa upgrade" bucket.

Kenneth Russell

[Comment 11](show_bug.cgi?id=85942#c11)
2012-05-15 13:18:32 PDT

(In reply to [comment #10](show_bug.cgi?id=85942#c10))
> (In reply to [comment #9](show_bug.cgi?id=85942#c9))
> > (In reply to [comment #8](show_bug.cgi?id=85942#c8))
> > > (From update of [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing") [details] [details])
> > > Absolutely no test at all? How is anyone else supposed to patch this code without regressing this behavior?
> >
> > Regressions will be caught by developers running the WebGL conformance tests locally on their machine, or in automated fashion on the Chromium GPU waterfall. We could add GPU bots to test these code paths on build.webkit.org. This is a lot of work however and should not block fixing of an issue for which tests exist in a canonical place (even if they aren't, unfortunately, layout tests).
>
> Is the issue lack of (guaranteed) support for FP32 texture formats? Does the current version of Mesa on Chrome's DRT support them? If so, could we turn them into layout tests, and simply mark them as Skipped on non-Chrome platforms? Or just put the tests in platform/chromium? If not, presumably a newer version of Mesa supports FP32, and we can just chuck it in the "do this after Mesa upgrade" bucket.
Yes, the primary issue is that there are no webkit.org bots (even the Chromium bots) that would be able to reliably run these tests. I do agree that we should aim to run them, and have filed [https://bugs.webkit.org/show\_bug.cgi?id=86516](show_bug.cgi?id=86516 "RESOLVED DUPLICATE - Add layout tests for OES_texture_float") to track this issue.

James Robinson

[Comment 12](show_bug.cgi?id=85942#c12)
2012-05-15 13:23:13 PDT

I see, I wasn't aware of that restriction.

WebKit Review Bot

[Comment 13](show_bug.cgi?id=85942#c13)
2012-05-15 17:00:10 PDT

Comment on [attachment 142030](attachment.cgi?id=142030&action=diff "Patch for landing") [[details]](attachment.cgi?id=142030&action=edit "Patch for landing")
Patch for landing
Clearing flags on attachment: 142030
Committed [r117191](https://commits.webkit.org/r117191): <<http://trac.webkit.org/changeset/117191>>

WebKit Review Bot

[Comment 14](show_bug.cgi?id=85942#c14)
2012-05-15 17:00:14 PDT

All reviewed patches have been landed. Closing bug.

Andy Estes

[Comment 15](show_bug.cgi?id=85942#c15)
2012-05-23 16:13:03 PDT

What (if any) is the symptom of this bug in release builds?

Kenneth Russell

[Comment 16](show_bug.cgi?id=85942#c16)
2012-05-23 16:28:18 PDT

(In reply to [comment #15](show_bug.cgi?id=85942#c15))
> What (if any) is the symptom of this bug in release builds?
In Chrome the renderer process crashes -- the heap is corrupted by writing beyond the end of a WTF::Vector, TCMalloc catches the corruption and crashes. I didn't test in Safari.

Andy Estes

[Comment 17](show_bug.cgi?id=85942#c17)
2012-05-23 16:45:29 PDT

<rdar://problem/11520387>

Note
You need to
[log in](show_bug.cgi?id=85942&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Normal

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 528+ (Nightly build) |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |All

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |All

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |WebGL

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Kenneth Russell

Reported

2012-05-08 18:28 PDT

Modified

2012-05-23 16:45 PDT
[History](show_activity.cgi?id=85942)

CC List

7
users
Show

aestes
dino
gman
jamesr
senorblanco
webkit.review.bot
zmo

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |InRadar

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

[86515](show_bug.cgi?id=86515 "RESOLVED CONFIGURATION CHANGED - Incorporate Mozilla's improved texture format conversion code")

Dependencies
[tree](showdependencytree.cgi?id=85942&hide_resolved=1)[graph](showdependencygraph.cgi?id=85942)

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |
None

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=85942)
* [XML](show_bug.cgi?ctype=xml&id=85942)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=85942)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)



=== Content from code.google.com_7d2e993c_20250126_060847.html ===



=== Content from chromiumcodereview.appspot.com_ce1711ef_20250125_045914.html ===


Keyboard Shortcuts

---

| |  | File | | --- | --- | | u **:** | up to issue | | j / k **:** | jump to file after / before current file | | J / K **:** | jump to next file with a comment after / before current file | |  | Side-by-side diff | | i **:** | toggle intra-line diffs | | e **:** | expand all comments | | c **:** | collapse all comments | | s **:** | toggle showing all comments | | n / p **:** | next / previous diff chunk or comment | | N / P **:** | next / previous comment | | <Up> / <Down> **:** | next / previous line | | |  | Issue | | --- | --- | | u **:** | up to list of issues | | j / k **:** | jump to patch after / before current patch | | o / <Enter> **:** | open current patch in side-by-side view | | i **:** | open current patch in unified diff view | |  | |  | Issue List | | j / k **:** | jump to issue after / before current issue | | o / <Enter> **:** | open current issue | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

![](/static/chromium-24.png) Chromium Code Reviews
**chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)**
|
Please choose your nickname with
[Settings](/settings)
|
[Help](http://code.google.com/p/rietveld/wiki/CodeReviewHelp)
|
[Chromium Project](http://www.chromium.org/)
|
[Gerrit Changes](https://chromium-review.googlesource.com/dashboard/self?polygerrit=1)
|
[Sign out](https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/10444013%252526ust%25253D1608670488589077%252526usg%25253DAFQjCNFSYhgWmVS8Q8gfXpyA_7O4YUjGlw%26service%3Dah)

(53)

[Issues](/)
[Search](/search)

[My Issues](/mine)
|
[Starred](/starred)

[Open](/all?closed=0)
|
[Closed](/all?closed=1)
|
[All](/all)

## Issue [10444013](/10444013/): Merge 117191 - Assertion failure running Mozilla's WebGL performance regression tests (Closed)

| **Created:** 8 years, 7 months ago by [Ken Russell (switch to Gerrit)](/user/Ken%20Russell%20%28switch%20to%20Gerrit%29)  **Modified:** 8 years, 7 months ago  **Reviewers:** [Ken Russell (Google)](/user/Ken%20Russell%20%28Google%29)  **CC:** chromium-reviews  **Base URL:** http://svn.webkit.org/repository/webkit/branches/chromium/1132/  **Visibility:** Public.  [**More Reviews**](/search?repo_guid=268f45cc-cd09-0410-ab3c-d52691b4dbfc "Find reviews for the same repository ID - 268f45cc-cd09-0410-ab3c-d52691b4dbfc") | DescriptionMerge 117191 - Assertion failure running Mozilla's WebGL performance regression tests <https://bugs.webkit.org/show_bug.cgi?id=85942> Reviewed by Stephen White. Fixed incorrect assumptions about source formats and buffer sizes when uploading to floating-point textures. Added code paths supporting the necessary conversions. Tests have been added to the WebGL conformance suite which cover these new code paths; they verify uploads of HTMLCanvasElement, HTMLImageElement, HTMLVideoElement, and ImageData to floating-point textures. However, because floating-point texture support is optional, and generally only supported on bots which run with real GPUs and not in virtual machines, it isn't feasible to incorporate these tests as layout tests. Ran the new WebGL conformance tests in Chromium on Linux; all pass. \* platform/graphics/GraphicsContext3D.cpp: (WebCore::GraphicsContext3D::extractImageData): Properly compute size of destination buffer. (WebCore): Add pack/unpack routines for converting RGBA8/BGRA8 to floating point. (WebCore::doFloatingPointPacking): Support RGBA8 and BGRA8 source formats. (WebCore::isFloatingPointSource): Factored out logic for assertions. (WebCore::GraphicsContext3D::packPixels): Generalized assertions and logic. \* platform/graphics/cairo/GraphicsContext3DCairo.cpp: (WebCore::GraphicsContext3D::getImageData): Properly compute size of destination buffer. \* platform/graphics/cg/GraphicsContext3DCG.cpp: (WebCore::GraphicsContext3D::getImageData): Properly compute size of destination buffer. \* platform/graphics/qt/GraphicsContext3DQt.cpp: (WebCore::GraphicsContext3D::getImageData): Properly compute size of destination buffer. \* platform/graphics/skia/GraphicsContext3DSkia.cpp: (WebCore::GraphicsContext3D::getImageData): Properly compute size of destination buffer. TBR=kbr@google.com Committed: <https://src.chromium.org/viewvc/chrome?view=rev&revision=118410> [Patch Set 1 #](/10444013/#ps1) *Created:* 8 years, 7 months ago  Download [[raw]](/download/issue10444013_1.diff "Patchset in text format") [[tar.bz2]](/tarball/10444013/1 "Tarball containing the original and patched files")   |  | | Unified diffs | Side-by-side diffs | Delta from patch set | Stats (*+181 lines, -26 lines*) | | | Patch | | --- | --- | --- | --- | --- | --- | --- | --- | --- | |  | M | [Source/WebCore/platform/graphics/GraphicsContext3D.cpp](/10444013/patch/1/2) | [View](/10444013/diff/1/Source/WebCore/platform/graphics/GraphicsContext3D.cpp) |  | 12 chunks | +156 lines, -22 lines | 0 comments | [Download](/download/issue10444013_1_2.diff "Download patch for Source/WebCore/platform/graphics/GraphicsContext3D.cpp") | |  | M | [Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp](/10444013/patch/1/3) | [View](/10444013/diff/1/Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp) |  | 1 chunk | +6 lines, -1 line | 0 comments | [Download](/download/issue10444013_1_3.diff "Download patch for Source/WebCore/platform/graphics/cairo/GraphicsContext3DCairo.cpp") | |  | M | [Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp](/10444013/patch/1/4) | [View](/10444013/diff/1/Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp) |  | 1 chunk | +7 lines, -1 line | 0 comments | [Download](/download/issue10444013_1_4.diff "Download patch for Source/WebCore/platform/graphics/cg/GraphicsContext3DCG.cpp") | |  | M | [Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp](/10444013/patch/1/5) | [View](/10444013/diff/1/Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp) |  | 1 chunk | +7 lines, -1 line | 0 comments | [Download](/download/issue10444013_1_5.diff "Download patch for Source/WebCore/platform/graphics/qt/GraphicsContext3DQt.cpp") | |  | M | [Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp](/10444013/patch/1/6) | [View](/10444013/diff/1/Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp) |  | 1 chunk | +5 lines, -1 line | 0 comments | [Download](/download/issue10444013_1_6.diff "Download patch for Source/WebCore/platform/graphics/skia/GraphicsContext3DSkia.cpp") |   Messages*Total messages: 1 (0 generated)* Expand Messages | Collapse Messages  | **Ken Russell (switch to Gerrit)** | |  | | --- | | 8 years, 7 months ago (2012-05-24 20:37:11 UTC) [#1](#msg1) | | --- | --- | --- | --- |     Expand Messages | Collapse Messages |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

**Issue 10444013: Merge 117191 - Assertion failure running Mozilla's WebGL performance regression tests
(Closed)**

Created 8 years, 7 months ago by Ken Russell (switch to Gerrit)

Modified 8 years, 7 months ago

Reviewers: Ken Russell (Google)

Base URL: http://svn.webkit.org/repository/webkit/branches/chromium/1132/

Comments: 0
[![Powered by Google App Engine](/static/appengine-noborder-120x30.gif)](http://code.google.com/appengine/)

This is Rietveld [408576698](http://code.google.com/p/rietveld/source/list)


