=== Content from marc.info_40ec72b2_20250125_072248.html ===

```
[[prev in list](?l=linux-netdev&m=134522316825614&w=2)] [[next in list](?l=linux-netdev&m=134522422925985&w=2)] [prev in thread] [next in thread]
List:       [linux-netdev](?l=linux-netdev&r=1&w=2)
Subject:    [PATCH 0/2] netlink patches
From:       [pablo () netfilter ! org](?a=129478840900007&r=1&w=2)
Date:       [2012-08-17 17:22:27](?l=linux-netdev&r=1&w=2&b=201208)
Message-ID: [1345224149-5946-1-git-send-email-pablo () netfilter ! org](?i=1345224149-5946-1-git-send-email-pablo%20()%20netfilter%20!%20org)
[Download RAW [message](?l=linux-netdev&m=134522422125983&q=mbox) or [body](?l=linux-netdev&m=134522422125983&q=raw)]

From: Pablo Neira Ayuso <pablo@netfilter.org>

Hi,

The following two patches contain one update to replace
netlink_set_nonroot and one RFC to resolve possible Netlink
spoofing from the kernel itself by disabling one of the Netlink
features (please, read [PATCH 2/2] for details).

The first patch removes the netlink_set_nonroot to use the recently
added struct netlink_kernel_cfg passed to netlink_kernel_create.

The second tries to address netlink spoofing for non-root processes
from the kernel while disabling the ability of two processes to
communicate. Yes, this may be controversial I guess.

Specifically for the second patch, please, let me know if I'm
missing anything that makes me reach bogus conclusions in the RFC
patch.

Thanks!

Pablo Neira Ayuso (2):
  netlink: kill netlink_set_nonroot
  [RFC] netlink: fix possible spoofing from non-root processes

 include/linux/netlink.h    |    9 ++++-----
 lib/kobject_uevent.c       |    2 +-
 net/core/rtnetlink.c       |    2 +-
 net/netlink/af_netlink.c   |   21 ++++++++-------------
 net/netlink/genetlink.c    |    3 +--
 security/selinux/netlink.c |    2 +-
 6 files changed, 16 insertions(+), 23 deletions(-)

--
1.7.10.4

--
To unsubscribe from this list: send the line "unsubscribe netdev" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  <http://vger.kernel.org/majordomo-info.html>
[[prev in list](?l=linux-netdev&m=134522316825614&w=2)] [[next in list](?l=linux-netdev&m=134522422925985&w=2)] [prev in thread] [next in thread]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from git.kernel.org_15b569f5_20250125_072247.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2012-08-23 02:09:11 +0000 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2012-08-24 13:36:09 -0400 |
| commit | [20e1db19db5d6b9e4e83021595eab0dc8f107bef](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)) | |
| tree | [8d02b7602a959dabd45a8b9eaddd9fab95ec658f](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef) | |
| parent | [bd4242dfe85470b9caecbd049310518f9b9e3f14](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bd4242dfe85470b9caecbd049310518f9b9e3f14) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef&id2=bd4242dfe85470b9caecbd049310518f9b9e3f14)) | |
| download | [linux-20e1db19db5d6b9e4e83021595eab0dc8f107bef.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-20e1db19db5d6b9e4e83021595eab0dc8f107bef.tar.gz) | |

netlink: fix possible spoofing from non-root processesNon-root user-space processes can send Netlink messages to other
processes that are well-known for being subscribed to Netlink
asynchronous notifications. This allows ilegitimate non-root
process to send forged messages to Netlink subscribers.
The userspace process usually verifies the legitimate origin in
two ways:
a) Socket credentials. If UID != 0, then the message comes from
some ilegitimate process and the message needs to be dropped.
b) Netlink portID. In general, portID == 0 means that the origin
of the messages comes from the kernel. Thus, discarding any
message not coming from the kernel.
However, ctnetlink sets the portID in event messages that has
been triggered by some user-space process, eg. conntrack utility.
So other processes subscribed to ctnetlink events, eg. conntrackd,
know that the event was triggered by some user-space action.
Neither of the two ways to discard ilegitimate messages coming
from non-root processes can help for ctnetlink.
This patch adds capability validation in case that dst\_pid is set
in netlink\_sendmsg(). This approach is aggressive since existing
applications using any Netlink bus to deliver messages between
two user-space processes will break. Note that the exception is
NETLINK\_USERSOCK, since it is reserved for netlink-to-netlink
userspace communication.
Still, if anyone wants that his Netlink bus allows netlink-to-netlink
userspace, then they can set NL\_NONROOT\_SEND. However, by default,
I don't think it makes sense to allow to use NETLINK\_ROUTE to
communicate two processes that are sending no matter what information
that is not related to link/neighbouring/routing. They should be using
NETLINK\_USERSOCK instead for that.
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)

| -rw-r--r-- | [net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/netlink/af_netlink.c?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/netlink/af\_netlink.c b/net/netlink/af\_netlink.cindex 1445d73533ed13..527023823b5c5e 100644--- a/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=bd4242dfe85470b9caecbd049310518f9b9e3f14)+++ b/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=20e1db19db5d6b9e4e83021595eab0dc8f107bef)@@ -1373,7 +1373,8 @@ static int netlink\_sendmsg(struct kiocb \*kiocb, struct socket \*sock, dst\_pid = addr->nl\_pid; dst\_group = ffs(addr->nl\_groups); err = -EPERM;- if (dst\_group && !netlink\_capable(sock, NL\_NONROOT\_SEND))+ if ((dst\_group || dst\_pid) &&+ !netlink\_capable(sock, NL\_NONROOT\_SEND)) goto out; } else { dst\_pid = nlk->dst\_pid;@@ -2147,6 +2148,7 @@ static void \_\_init netlink\_add\_usersock\_entry(void) rcu\_assign\_pointer(nl\_table[NETLINK\_USERSOCK].listeners, listeners); nl\_table[NETLINK\_USERSOCK].module = THIS\_MODULE; nl\_table[NETLINK\_USERSOCK].registered = 1;+ nl\_table[NETLINK\_USERSOCK].nl\_nonroot = NL\_NONROOT\_SEND;  netlink\_table\_ungrab(); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 07:21:24 +0000



=== Content from marc.info_da090d8b_20250125_072249.html ===

```
[[prev in list](?l=linux-netdev&m=134522422925985&w=2)] [[next in list](?l=linux-netdev&m=134522737727418&w=2)] [prev in thread] [[next in thread](?l=linux-netdev&m=134542879600533&w=2)]
List:       [linux-netdev](?l=linux-netdev&r=1&w=2)
Subject:    [[PATCH 2/2] [RFC] netlink: fix possible spoofing from non-root processes](?t=134522431200002&r=1&w=2)
From:       [pablo () netfilter ! org](?a=129478840900007&r=1&w=2)
Date:       [2012-08-17 17:22:29](?l=linux-netdev&r=1&w=2&b=201208)
Message-ID: [1345224149-5946-3-git-send-email-pablo () netfilter ! org](?i=1345224149-5946-3-git-send-email-pablo%20()%20netfilter%20!%20org)
[Download RAW [message](?l=linux-netdev&m=134522422925986&q=mbox) or [body](?l=linux-netdev&m=134522422925986&q=raw)]

From: Pablo Neira Ayuso <pablo@netfilter.org>

Non-root user-space processes can send netlink messages to other
processes that are well-known for being subscribed to Netlink
asynchronous notifications. This allows ilegitimate non-root
process to send forged messages to them.

This is usually fixed by checking for Netlink portID in the
message receival path of the user-space process. In general,
portID == 0 means that the origin of the messages comes from the
kernel. Thus, discarding any message not coming from the kernel.
This is true for rtnetlink.

However, ctnetlink sets the portID in event messages that has
been triggered by some user-space process, eg. conntrack utility.
So other processes subscribed to ctnetlink events, eg. conntrackd,
know that the event was triggered by some user-space action.

This patch adds capability validation in case that dst_pid is set
in netlink_sendmsg(). This approach is aggressive since any existing
application using any of the Netlink busses to deliver messages
between two user-space processes will break.

[ I don't know any FOSS program making use of Netlink to communicate
  to processes, please, let me know if I'm missing anyone important ]

Anyway, if we want to ensure full backward compatibility, a new
version of this patch including NL_CFG_F_NONROOT_SEND flags need
to be set in all kernel subsystems. However, I don't think it
makes sense to use NETLINK_ROUTE to communicate two processes
that are sending no matter what information that is not related
to link/neighbouring/routing?

Still, if someone wants to make use of Netlink for this, eg.
I remember people willing to implement D-BUS over Netlink,
then we can reserve some Netlink bus explicitly for this and
set NL_CFG_F_NONROOT_SEND to it.

Not related to this, but I noticed that some existing well-known
user-space programs set SO_PASSCRED to obtain credentials while
trying to solve this. But they do it wrong, since they misinterpret
credentials containing pid == 0 as "yes, this message is really
coming from the kernel". So those programs will be also happy
that if this patch gets in, since it will fix spoofing for them.

Reported-by: Florian Weimer <fweimer@redhat.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
---
 net/netlink/af_netlink.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/net/netlink/af_netlink.c b/net/netlink/af_netlink.c
index d04f923..758993f 100644
--- a/net/netlink/af_netlink.c
+++ b/net/netlink/af_netlink.c
@@ -1373,7 +1373,8 @@ static int netlink_sendmsg(struct kiocb *kiocb, struct socket *sock,
 		dst_pid = addr->nl_pid;
 		dst_group = ffs(addr->nl_groups);
 		err =  -EPERM;
-		if (dst_group && !netlink_capable(sock, NL_CFG_F_NONROOT_SEND))
+		if ((dst_group || dst_pid) &&
+		    !netlink_capable(sock, NL_CFG_F_NONROOT_SEND))
 			goto out;
 	} else {
 		dst_pid = nlk->dst_pid;
--
1.7.10.4

--
To unsubscribe from this list: send the line "unsubscribe netdev" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  <http://vger.kernel.org/majordomo-info.html>
[[prev in list](?l=linux-netdev&m=134522422925985&w=2)] [[next in list](?l=linux-netdev&m=134522737727418&w=2)] [prev in thread] [[next in thread](?l=linux-netdev&m=134542879600533&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from bugzilla.redhat.com_c4c49143_20250125_072314.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D848949)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D848949)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D848949)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 848949

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 848949**](show_bug.cgi?id=848949)
(CVE-2012-6689)
- [CVE-2012-6689](https://access.redhat.com/security/cve/CVE-2012-6689) libmnl: incorrect validation of netlink message origin allows attackers to spoof netlink messages

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2012-6689 libmnl: incorrect validation of netlink message origin allows a...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2012-6689 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [851148](show_bug.cgi?id=851148 "CLOSED NOTABUG - libmnl: provide an API to detect Netlink spoofing") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [848952](show_bug.cgi?id=848952) | | TreeView+ | [depends on](buglist.cgi?bug_id=848949&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=848949&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2012-08-16 22:26 UTC by Vincent Danen | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2020-06-17 06:18 UTC ([History](show_activity.cgi?id=848949)) | | [CC List:](page.cgi?id=fields.html#cclist) | 17 users (show)  acaringi bhu bmasney brdeoliv dhoward dvlasenk fhrbata fweimer hkrzesin jshortt jstancek kernel-mgr nmurray ptalbert rvrbovsk security-response-team twoerner | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2015-02-08 09:16:49 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=848949#c0)  Vincent Danen    2012-08-16 22:26:29 UTC  ``` Florian Weimer of the Red Hat Product Security Team discovere that the mnl_nlmsg_portid_ok() function in libmnl 1.0.3 and earlier did not correctly validate the origin of a Netlink message, allowing local attackers to spoof Netlink messages, with context-dependent consequences.   ```  [Comment 1](show_bug.cgi?id=848949#c1)  Vincent Danen    2012-08-20 22:52:06 UTC  ``` This is currently being discussed here:  <http://marc.info/?l=linux-netdev&m=134522422125983>  but in the capacity of the kernel, not libmnl.   ```  [Comment 3](show_bug.cgi?id=848949#c3)  Florian Weimer    2015-02-08 09:16:49 UTC  ``` This was fixed in the kernel, see [bug 851968](show_bug.cgi?id=851968).   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=848949&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from www.kernel.org_555c9f4c_20250125_072312.html ===
commit 6a84d5503f13803c7b91f79d8ae0ecca25361ac9
Author: Greg Kroah-Hartman
Date: Tue Oct 2 10:43:38 2012 -0700
Linux 3.5.5
commit b3109b3c87de5f6d98d8418c5f1931d9d2609ae0
Author: Will Deacon
Date: Fri Jul 13 19:15:40 2012 +0100
ARM: 7467/1: mutex: use generic xchg-based implementation for ARMv6+
commit a76d7bd96d65fa5119adba97e1b58d95f2e78829 upstream.
The open-coded mutex implementation for ARMv6+ cores suffers from a
severe lack of barriers, so in the uncontended case we don't actually
protect any accesses performed during the critical section.
Furthermore, the code is largely a duplication of the ARMv6+ atomic\_dec
code but optimised to remove a branch instruction, as the mutex fastpath
was previously inlined. Now that this is executed out-of-line, we can
reuse the atomic access code for the locking (in fact, we use the xchg
code as this produces shorter critical sections).
This patch uses the generic xchg based implementation for mutexes on
ARMv6+, which introduces barriers to the lock/unlock operations and also
has the benefit of removing a fair amount of inline assembly code.
Acked-by: Arnd Bergmann
Acked-by: Nicolas Pitre
Reported-by: Shan Kang
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 56015aefc7a036e7a6156a2b5b3eb6e975354e86
Author: Dan Carpenter
Date: Sun Sep 23 19:33:55 2012 +0300
vmwgfx: corruption in vmw\_event\_fence\_action\_create()
commit 68c4fce737c4b963e336435f225621dc21138397 upstream.
We don't allocate enough data for this struct. As soon as we start
modifying event->event on the next lines, then we're going beyond the
end of the memory we allocated.
Signed-off-by: Dan Carpenter
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit d1757408bfe3adca81ff1c88fcb2d578864f8e9d
Author: Jani Nikula
Date: Wed Aug 29 14:08:42 2012 +0300
drm/i915: only enable sdvo hotplug irq if needed
commit fcbc50da7753b210b4442ca9abc4efbd4e481f6e upstream.
Avoid constant wakeups caused by noisy irq lines when we don't even care
about the irq. This should be particularly useful for i945g/gm where the
hotplug has been disabled:
commit 768b107e4b3be0acf6f58e914afe4f337c00932b
Author: Daniel Vetter
Date: Fri May 4 11:29:56 2012 +0200
drm/i915: disable sdvo hotplug on i945g/gm
v2: While at it, remove the bogus hotplug\_active read, and do not mask
hotplug\_active[0] before checking whether the irq is needed, per discussion
with Daniel on IRC.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=38442
Tested-by: Dominik Köppl
Signed-off-by: Jani Nikula
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit 6ae8e8788b2d284b0af01e1e4f67e3d22b0161b9
Author: Dave Airlie
Date: Tue Sep 25 16:17:43 2012 +1000
drm/udl: limit modes to the sku pixel limits.
commit 3a75885848996baab5276ff37ebf7295c3c753f0 upstream.
Otherwise when X starts we commonly get a black screen scanning
out nothing, its wierd dpms on/off from userspace brings it back,
With this on F18, multi-seat works again with my 1920x1200 monitor
which is above the sku limit for the device I have.
Reviewed-by: Alex Deucher
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 94270e68d318d1d2a1654804512815999adc4b55
Author: NeilBrown
Date: Thu Sep 27 12:35:21 2012 +1000
md/raid10: fix "enough" function for detecting if array is failed.
commit 80b4812407c6b1f66a4f2430e69747a13f010839 upstream.
The 'enough' function is written to work with 'near' arrays only
in that is implicitly assumes that the offset from one 'group' of
devices to the next is the same as the number of copies.
In reality it is the number of 'near' copies.
So change it to make this number explicit.
This bug makes it possible to run arrays without enough drives
present, which is dangerous.
It is appropriate for an -stable kernel, but will almost certainly
need to be modified for some of them.
Reported-by: Jakub Husák
Signed-off-by: NeilBrown
Signed-off-by: Greg Kroah-Hartman
commit fa0dd16bd04e36a10c3e271732d349f869b4f2c0
Author: Roland Stigge
Date: Thu Sep 20 10:48:03 2012 +0200
gpio-lpc32xx: Fix value handling of gpio\_direction\_output()
commit b1268d3737c6316016026245eef276eda6b0a621 upstream.
For GPIOs of gpio-lpc32xx, gpio\_direction\_output() ignores the value argument
(initial value of output). This patch fixes this by setting the level
accordingly.
Signed-off-by: Roland Stigge
Acked-by: Alexandre Pereira da Silva
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit ae4c274366793c3c963f569ef624a0300d855627
Author: Mark Brown
Date: Wed Sep 26 11:57:30 2012 +0100
ASoC: wm2000: Correct register size
commit d0e12f3ff3472cbd8f52d3c0e6ee07a841787c40 upstream.
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit fc093debd67b1618e8fa4bd93b625c23388bcf92
Author: Daniel Mack
Date: Thu Sep 27 10:26:01 2012 +0200
ALSA: snd-usb: fix next\_packet\_size calls for pause case
commit 8dce30c89113e314d29d3b8f362aadff8087fccb upstream.
Also fix the calls to next\_packet\_size() for the pause case. This was
missed in 245baf983 ("ALSA: snd-usb: fix calls to next\_packet\_size").
Signed-off-by: Daniel Mack
Reviewed-by: Takashi Iwai
Reported-and-tested-by: Christian Tefzer
[ Taking directly because Takashi is on vacation - Linus ]
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5a7de1b5ec4d3eaabc9d596207f40c2b5f82b723
Author: Alan Stern
Date: Wed Sep 26 13:09:53 2012 -0400
USB: Fix race condition when removing host controllers
commit 0d00dc2611abbe6ad244d50569c2ee82ce42846c upstream.
This patch (as1607) fixes a race that can occur if a USB host
controller is removed while a process is reading the
/sys/kernel/debug/usb/devices file.
The usb\_device\_read() routine uses the bus->root\_hub pointer to
determine whether or not the root hub is registered. The is not a
valid test, because the pointer is set before the root hub gets
registered and remains set even after the root hub is unregistered and
deallocated. As a result, usb\_device\_read() or usb\_device\_dump() can
access freed memory, causing an oops.
The patch changes the test to use the hcd->rh\_registered flag, which
does get set and cleared at the appropriate times. It also makes sure
to hold the usb\_bus\_list\_lock mutex while setting the flag, so that
usb\_device\_read() will become aware of new root hubs as soon as they
are registered.
Signed-off-by: Alan Stern
Reported-by: Don Zickus
Signed-off-by: Greg Kroah-Hartman
commit f3d26f1be9179d422223d2f33d647d5459c984e3
Author: Joachim Eastwood
Date: Sun Sep 23 22:56:00 2012 +0200
USB: ohci-at91: fix null pointer in ohci\_hcd\_at91\_overcurrent\_irq
commit 01bb6501779ed0b6dc6c55be34b49eaa6306fdd8 upstream.
Fixes the following NULL pointer dereference:
[ 7.740000] ohci\_hcd: USB 1.1 'Open' Host Controller (OHCI) Driver
[ 7.810000] Unable to handle kernel NULL pointer dereference at virtual address 00000028
[ 7.810000] pgd = c3a38000
[ 7.810000] [00000028] \*pgd=23a8c831, \*pte=00000000, \*ppte=00000000
[ 7.810000] Internal error: Oops: 17 [#1] PREEMPT ARM
[ 7.810000] Modules linked in: ohci\_hcd(+) regmap\_i2c snd\_pcm usbcore snd\_page\_alloc at91\_cf snd\_timer pcmcia\_rsrc snd soundcore gpio\_keys regmap\_spi pcmcia\_core usb\_common nls\_base
[ 7.810000] CPU: 0 Not tainted (3.6.0-rc6-mpa+ #264)
[ 7.810000] PC is at \_\_gpio\_to\_irq+0x18/0x40
[ 7.810000] LR is at ohci\_hcd\_at91\_overcurrent\_irq+0x24/0xb4 [ohci\_hcd]
[ 7.810000] pc : [] lr : [] psr: 40000093
[ 7.810000] sp : c3a11c40 ip : c3a11c50 fp : c3a11c4c
[ 7.810000] r10: 00000000 r9 : c02dcd6e r8 : fefff400
[ 7.810000] r7 : 00000000 r6 : c02cc928 r5 : 00000030 r4 : c02dd168
[ 7.810000] r3 : c02e7350 r2 : ffffffea r1 : c02cc928 r0 : 00000000
[ 7.810000] Flags: nZcv IRQs off FIQs on Mode SVC\_32 ISA ARM Segment user
[ 7.810000] Control: c000717f Table: 23a38000 DAC: 00000015
[ 7.810000] Process modprobe (pid: 285, stack limit = 0xc3a10270)
[ 7.810000] Stack: (0xc3a11c40 to 0xc3a12000)
[ 7.810000] 1c40: c3a11c6c c3a11c50 bf08f694 c01392cc c3a11c84 c2c38b00 c3806900 00000030
[ 7.810000] 1c60: c3a11ca4 c3a11c70 c0051264 bf08f680 c3a11cac c3a11c80 c003e764 c3806900
[ 7.810000] 1c80: c2c38b00 c02cb05c c02cb000 fefff400 c3806930 c3a11cf4 c3a11cbc c3a11ca8
[ 7.810000] 1ca0: c005142c c005123c c3806900 c3805a00 c3a11cd4 c3a11cc0 c0053f24 c00513e4
[ 7.810000] 1cc0: c3a11cf4 00000030 c3a11cec c3a11cd8 c005120c c0053e88 00000000 00000000
[ 7.810000] 1ce0: c3a11d1c c3a11cf0 c00124d0 c00511e0 01400000 00000001 00000012 00000000
[ 7.810000] 1d00: ffffffff c3a11d94 00000030 00000000 c3a11d34 c3a11d20 c005120c c0012438
[ 7.810000] 1d20: c001dac4 00000012 c3a11d4c c3a11d38 c0009b08 c00511e0 c00523fc 60000013
[ 7.810000] 1d40: c3a11d5c c3a11d50 c0008510 c0009ab4 c3a11ddc c3a11d60 c0008eb4 c00084f0
[ 7.810000] 1d60: 00000000 00000030 00000000 00000080 60000013 bf08f670 c3806900 c2c38b00
[ 7.810000] 1d80: 00000030 c3806930 00000000 c3a11ddc c3a11d88 c3a11da8 c0054190 c00523fc
[ 7.810000] 1da0: 60000013 ffffffff c3a11dec c3a11db8 00000000 c2c38b00 bf08f670 c3806900
[ 7.810000] 1dc0: 00000000 00000080 c02cc928 00000030 c3a11e0c c3a11de0 c0052764 c00520d8
[ 7.810000] 1de0: c3a11dfc 00000000 00000000 00000002 bf090f61 00000004 c02cc930 c02cc928
[ 7.810000] 1e00: c3a11e4c c3a11e10 bf090978 c005269c bf090f61 c02cc928 bf093000 c02dd170
[ 7.810000] 1e20: c3a11e3c c02cc930 c02cc930 bf0911d0 bf0911d0 bf093000 c3a10000 00000000
[ 7.810000] 1e40: c3a11e5c c3a11e50 c0155b7c bf090808 c3a11e7c c3a11e60 c0154690 c0155b6c
[ 7.810000] 1e60: c02cc930 c02cc964 bf0911d0 c3a11ea0 c3a11e9c c3a11e80 c015484c c01545e8
[ 7.810000] 1e80: 00000000 00000000 c01547e4 bf0911d0 c3a11ec4 c3a11ea0 c0152e58 c01547f4
[ 7.810000] 1ea0: c381b88c c384ab10 c2c10540 bf0911d0 00000000 c02d7518 c3a11ed4 c3a11ec8
[ 7.810000] 1ec0: c01544c0 c0152e0c c3a11efc c3a11ed8 c01536cc c01544b0 bf091075 c3a11ee8
[ 7.810000] 1ee0: bf049af0 bf09120c bf0911d0 00000000 c3a11f1c c3a11f00 c0154e9c c0153628
[ 7.810000] 1f00: bf049af0 bf09120c 000ae190 00000000 c3a11f2c c3a11f20 c0155f58 c0154e04
[ 7.810000] 1f20: c3a11f44 c3a11f30 bf093054 c0155f1c 00000000 00006a4f c3a11f7c c3a11f48
[ 7.810000] 1f40: c0008638 bf093010 bf09120c 000ae190 00000000 c00093c4 00006a4f bf09120c
[ 7.810000] 1f60: 000ae190 00000000 c00093c4 00000000 c3a11fa4 c3a11f80 c004fdc4 c000859c
[ 7.810000] 1f80: c3a11fa4 000ae190 00006a4f 00016eb8 000ad018 00000080 00000000 c3a11fa8
[ 7.810000] 1fa0: c0009260 c004fd58 00006a4f 00016eb8 000ae190 00006a4f 000ae100 00000000
[ 7.810000] 1fc0: 00006a4f 00016eb8 000ad018 00000080 000adba0 000ad208 00000000 000ad3d8
[ 7.810000] 1fe0: beaf7ae8 beaf7ad8 000172b8 b6e4e940 20000010 000ae190 00000000 00000000
[ 7.810000] Backtrace:
[ 7.810000] [] (\_\_gpio\_to\_irq+0x0/0x40) from [] (ohci\_hcd\_at91\_overcurrent\_irq+0x24/0xb4 [ohci\_hcd])
[ 7.810000] [] (ohci\_hcd\_at91\_overcurrent\_irq+0x0/0xb4 [ohci\_hcd]) from [] (handle\_irq\_event\_percpu+0x38/0x1a8)
[ 7.810000] r6:00000030 r5:c3806900 r4:c2c38b00
[ 7.810000] [] (handle\_irq\_event\_percpu+0x0/0x1a8) from [] (handle\_irq\_event+0x58/0x7c)
[ 7.810000] [] (handle\_irq\_event+0x0/0x7c) from [] (handle\_simple\_irq+0xac/0xd8)
[ 7.810000] r5:c3805a00 r4:c3806900
[ 7.810000] [] (handle\_simple\_irq+0x0/0xd8) from [] (generic\_handle\_irq+0x3c/0x48)
[ 7.810000] r4:00000030
[ 7.810000] [] (generic\_handle\_irq+0x0/0x48) from [] (gpio\_irq\_handler+0xa8/0xfc)
[ 7.810000] r4:00000000
[ 7.810000] [] (gpio\_irq\_handler+0x0/0xfc) from [] (generic\_handle\_irq+0x3c/0x48)
[ 7.810000] [] (generic\_handle\_irq+0x0/0x48) from [] (handle\_IRQ+0x64/0x88)
[ 7.810000] r4:00000012
[ 7.810000] [] (handle\_IRQ+0x0/0x88) from [] (at91\_aic\_handle\_irq+0x30/0x38)
[ 7.810000] r5:60000013 r4:c00523fc
[ 7.810000] [] (at91\_aic\_handle\_irq+0x0/0x38) from [] (\_\_irq\_svc+0x34/0x60)
[ 7.810000] Exception stack(0xc3a11d60 to 0xc3a11da8)
[ 7.810000] 1d60: 00000000 00000030 00000000 00000080 60000013 bf08f670 c3806900 c2c38b00
[ 7.810000] 1d80: 00000030 c3806930 00000000 c3a11ddc c3a11d88 c3a11da8 c0054190 c00523fc
[ 7.810000] 1da0: 60000013 ffffffff
[ 7.810000] [] (\_\_setup\_irq+0x0/0x458) from [] (request\_threaded\_irq+0xd8/0x134)
[ 7.810000] [] (request\_threaded\_irq+0x0/0x134) from [] (ohci\_hcd\_at91\_drv\_probe+0x180/0x41c [ohci\_hcd])
[ 7.810000] [] (ohci\_hcd\_at91\_drv\_probe+0x0/0x41c [ohci\_hcd]) from [] (platform\_drv\_probe+0x20/0x24)
[ 7.810000] [] (platform\_drv\_probe+0x0/0x24) from [] (driver\_probe\_device+0xb8/0x20c)
[ 7.810000] [] (driver\_probe\_device+0x0/0x20c) from [] (\_\_driver\_attach+0x68/0x88)
[ 7.810000] r7:c3a11ea0 r6:bf0911d0 r5:c02cc964 r4:c02cc930
[ 7.810000] [] (\_\_driver\_attach+0x0/0x88) from [] (bus\_for\_each\_dev+0x5c/0x9c)
[ 7.810000] r6:bf0911d0 r5:c01547e4 r4:00000000
[ 7.810000] [] (bus\_for\_each\_dev+0x0/0x9c) from [] (driver\_attach+0x20/0x28)
[ 7.810000] r7:c02d7518 r6:00000000 r5:bf0911d0 r4:c2c10540
[ 7.810000] [] (driver\_attach+0x0/0x28) from [] (bus\_add\_driver+0xb4/0x22c)
[ 7.810000] [] (bus\_add\_driver+0x0/0x22c) from [] (driver\_register+0xa8/0x144)
[ 7.810000] r7:00000000 r6:bf0911d0 r5:bf09120c r4:bf049af0
[ 7.810000] [] (driver\_register+0x0/0x144) from [] (platform\_driver\_register+0x4c/0x60)
[ 7.810000] r7:00000000 r6:000ae190 r5:bf09120c r4:bf049af0
[ 7.810000] [] (platform\_driver\_register+0x0/0x60) from [] (ohci\_hcd\_mod\_init+0x54/0x8c [ohci\_hcd])
[ 7.810000] [] (ohci\_hcd\_mod\_init+0x0/0x8c [ohci\_hcd]) from [] (do\_one\_initcall+0xac/0x174)
[ 7.810000] r4:00006a4f
[ 7.810000] [] (do\_one\_initcall+0x0/0x174) from [] (sys\_init\_module+0x7c/0x1a0)
[ 7.810000] [] (sys\_init\_module+0x0/0x1a0) from [] (ret\_fast\_syscall+0x0/0x2c)
[ 7.810000] r7:00000080 r6:000ad018 r5:00016eb8 r4:00006a4f
[ 7.810000] Code: e24cb004 e59f3028 e1a02000 e7930180 (e5903028)
[ 7.810000] ---[ end trace 85aa37ed128143b5 ]---
[ 7.810000] Kernel panic - not syncing: Fatal exception in interrupt
Commit 6fffb77c (USB: ohci-at91: fix PIO handling in relation with number of
ports) started setting unused pins to EINVAL. But this exposed a bug in the
ohci\_hcd\_at91\_overcurrent\_irq function where the gpio was used without being
checked to see if it is valid.
This patches fixed the issue by adding the gpio valid check.
Signed-off-by: Joachim Eastwood
Signed-off-by: Greg Kroah-Hartman
commit 6b8b3d7b9720603433f7ab99a114a2f3e1453c71
Author: Marc Kleine-Budde
Date: Wed Sep 12 14:58:03 2012 +0300
usb: chipidea: cleanup dma\_pool if udc\_start() fails
commit ad6b1b97fe8504957d017cd6e4168cac8903d3f3 upstream.
If udc\_start() fails the qh\_pool dma-pool cannot be closed because
it's still in use. This patch factors out the dma\_pool\_free() loop
into destroy\_eps() and calls it in the error path of udc\_start(),
too.
Reviewed-by: Richard Zhao
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
[mkl: backport to v3.5]
Signed-off-by: Marc Kleine-Budde
commit b739070c21f7279c4e508d4af7c5752b345966cb
Author: Marc Kleine-Budde
Date: Wed Sep 12 14:58:02 2012 +0300
usb: chipidea: udc: fix error path in udc\_start()
commit c9d1f947a85e38b6dded469470c95ed62430cb3f upstream.
This patch fixes the error path of udc\_start(). Now NULL is used to
unset the peripheral with otg\_set\_peripheral().
Cc: stable
Reviewed-by: Richard Zhao
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
commit 647aac2b3cc4016aeb62b0952e90065fdff595ea
Author: Tejun Heo
Date: Thu Jul 19 13:52:53 2012 -0700
kthread\_worker: reimplement flush\_kthread\_work() to allow freeing the work item being executed
commit 46f3d976213452350f9d10b0c2780c2681f7075b upstream.
kthread\_worker provides minimalistic workqueue-like interface for
users which need a dedicated worker thread (e.g. for realtime
priority). It has basic queue, flush\_work, flush\_worker operations
which mostly match the workqueue counterparts; however, due to the way
flush\_work() is implemented, it has a noticeable difference of not
allowing work items to be freed while being executed.
While the current users of kthread\_worker are okay with the current
behavior, the restriction does impede some valid use cases. Also,
removing this difference isn't difficult and actually makes the code
easier to understand.
This patch reimplements flush\_kthread\_work() such that it uses a
flush\_work item instead of queue/done sequence numbers.
Signed-off-by: Tejun Heo
Cc: Colin Cross
Signed-off-by: Greg Kroah-Hartman
commit 164743c183e486910153252ab3429f4bbea994af
Author: Tejun Heo
Date: Thu Jul 19 13:52:53 2012 -0700
kthread\_worker: reorganize to prepare for flush\_kthread\_work() reimplementation
commit 9a2e03d8ed518a61154f18d83d6466628e519f94 upstream.
Make the following two non-functional changes.
\* Separate out insert\_kthread\_work() from queue\_kthread\_work().
\* Relocate struct kthread\_flush\_work and kthread\_flush\_work\_fn()
definitions above flush\_kthread\_work().
v2: Added lockdep\_assert\_held() in insert\_kthread\_work() as suggested
by Andy Walls.
Signed-off-by: Tejun Heo
Acked-by: Andy Walls
Cc: Colin Cross
Signed-off-by: Greg Kroah-Hartman
commit e116de8f0cba1231b545eb982d1f73be68dacd38
Author: Stanislav Kinsbursky
Date: Tue Jul 3 16:46:41 2012 +0400
NFSd: set nfsd\_serv to NULL after service destruction
commit 57c8b13e3cd0f94944c9691ce7f58e5fcef8a12d upstream.
In nfsd\_destroy():
if (destroy)
svc\_shutdown\_net(nfsd\_serv, net);
svc\_destroy(nfsd\_server);
svc\_shutdown\_net(nfsd\_serv, net) calls nfsd\_last\_thread(), which sets
nfsd\_serv to NULL, causing a NULL dereference on the following line.
Signed-off-by: Stanislav Kinsbursky
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit ea8c40cf20877a61e211853e0425bc808344e881
Author: Stanislav Kinsbursky
Date: Tue Jul 3 16:46:41 2012 +0400
NFSd: introduce nfsd\_destroy() helper
commit 19f7e2ca44dfc3c1b3f499fc46801f98d403500f upstream.
Signed-off-by: Stanislav Kinsbursky
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 398f3001cf89e55b06ada5072df5f9da0137c9c4
Author: Seth Forshee
Date: Wed Aug 8 08:27:03 2012 -0500
irq\_remap: disable IRQ remapping if any IOAPIC lacks an IOMMU
commit 32ab31e01e2def6f48294d872d9bb42573aae00f upstream.
The ACPI tables in the Macbook Air 5,1 define a single IOAPIC with id 2,
but the only remapping unit described in the DMAR table matches id 0.
Interrupt remapping fails as a result, and the kernel panics with the
message "timer doesn't work through Interrupt-remapped IO-APIC."
To fix this, check each IOAPIC for a corresponding IOMMU. If an IOMMU is
not found, do not allow IRQ remapping to be enabled.
v2: Move check to parse\_ioapics\_under\_ir(), raise log level to KERN\_ERR,
and add FW\_BUG to the log message
v3: Skip check if IOMMU doesn't support interrupt remapping and remove
existing check that the IOMMU count equals the IOAPIC count
Acked-by: Suresh Siddha
Signed-off-by: Seth Forshee
Acked-by: Yinghai Lu
Signed-off-by: Joerg Roedel
Acked-by: Cho, Yu-Chen
Signed-off-by: Greg Kroah-Hartman
commit 4320e705bd7b6e17f72bfec17dfb5d035af8af2f
Author: Bjørn Mork
Date: Thu Aug 23 12:13:58 2012 +0200
net: qmi\_wwan: new devices: UML290 and K5006-Z
commit 10cbc1d97a7c7f9ae862fffe27b771ef0da9c461 upstream.
Newer firmware versions for the Pantech UML290 use a different
subclass ID. The Windows driver match on both IDs, so we do
that as well.
The ZTE (Vodafone) K5006-Z is a new device.
Signed-off-by: Bjørn Mork
Cc: Dan Williams
Cc: Thomas Schäfer
[bmork: backported to 3.4: use driver whitelisting]
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fa7b0bb7ae256dbe58d46da2f906060482cb7928
Author: Bjørn Mork
Date: Thu Aug 23 12:13:57 2012 +0200
net: qmi\_wwan: add Sierra Wireless devices
commit 9b469a60d68b13c288d5c3fc23de29d9d482dbe6 upstream.
Add 6 new devices and one modified device, based on
information from laptop vendor Windows drivers.
Sony provides a driver with two new devices using
a Gobi 2k+ layout (1199:68a5 and 1199:68a9). The
Sony driver also adds a non-standard QMI/net
interface to the already supported 1199:9011
Gobi device. We do not know whether this is an
alternate interface number or an additional
interface which might be present, but that doesn't
really matter.
Lenovo provides a driver supporting 4 new devices:
- MC7770 (1199:901b) with standard Gobi 2k+ layout
- MC7700 (0f3d:68a2) with layout similar to MC7710
- MC7750 (114f:68a2) with layout similar to MC7710
- EM7700 (1199:901c) with layout similar to MC7710
Note regaring the three devices similar to MC7710:
The Windows drivers only support interface #8 on these
devices. The MC7710 can support QMI/net functions on
interface #19 and #20 as well, and this driver is
verified to work on interface #19 (a firmware bug is
suspected to prevent #20 from working).
We do not enable these additional interfaces until they
either show up in a Windows driver or are verified to
work in some other way. Therefore limiting the new
devices to interface #8 for now.
[bmork: backported to 3.4: use driver whitelisting]
Signed-off-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c7d4d1577bac1050e43358e8c435289ae3c08c35
Author: Bjørn Mork
Date: Thu Jul 12 01:18:26 2012 +0000
net: qmi\_wwan: add ZTE MF821D
commit db8dacf953a70274172236957a4b97d4fdb376f0 upstream.
Sold by O2 (telefonica germany) under the name "LTE4G"
Tested-by: Thomas Schäfer
Signed-off-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 19fa18a644a6303d49295d921e651b7e19a3a75f
Author: Trond Myklebust
Date: Wed Aug 22 16:08:17 2012 -0400
NFS: Fix Oopses in nfs\_lookup\_revalidate and nfs4\_lookup\_revalidate
[Fixed upstream as part of 0b728e1911c, but that's a much larger patch,
this is only the nfs portion backported as needed.]
Fix the following Oops in 3.5.1:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000038
IP: [] nfs\_lookup\_revalidate+0x2d/0x480 [nfs]
PGD 337c63067 PUD 0
Oops: 0000 [#1] SMP
CPU 5
Modules linked in: nfs fscache nfsd lockd nfs\_acl auth\_rpcgss sunrpc af\_packet binfmt\_misc cpufreq\_conservative cpufreq\_userspace cpufreq\_powersave dm\_mod acpi\_cpufreq mperf coretemp gpio\_ich kvm\_intel joydev kvm ioatdma hid\_generic igb lpc\_ich i7core\_edac edac\_core ptp serio\_raw dca pcspkr i2c\_i801 mfd\_core sg pps\_core usbhid crc32c\_intel microcode button autofs4 uhci\_hcd ttm drm\_kms\_helper drm i2c\_algo\_bit sysimgblt sysfillrect syscopyarea ehci\_hcd usbcore usb\_common scsi\_dh\_rdac scsi\_dh\_emc scsi\_dh\_hp\_sw scsi\_dh\_alua scsi\_dh edd fan ata\_piix thermal processor thermal\_sys
Pid: 30431, comm: java Not tainted 3.5.1-2-default #1 Supermicro X8DTT/X8DTT
RIP: 0010:[] [] nfs\_lookup\_revalidate+0x2d/0x480 [nfs]
RSP: 0018:ffff8801b418bd38 EFLAGS: 00010292
RAX: 00000000fffffff6 RBX: ffff88032016d800 RCX: 0000000000000020
RDX: ffffffff00000000 RSI: 0000000000000000 RDI: ffff8801824a7b00
RBP: ffff8801b418bdf8 R08: 7fffff0034323030 R09: fffffffff04c03ed
R10: ffff8801824a7b00 R11: 0000000000000002 R12: ffff8801824a7b00
R13: ffff8801824a7b00 R14: 0000000000000000 R15: ffff8803201725d0
FS: 00002b53a46cb700(0000) GS:ffff88033fc20000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000038 CR3: 000000020a426000 CR4: 00000000000007e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process java (pid: 30431, threadinfo ffff8801b418a000, task ffff8801b5d20600)
Stack:
ffff8801b418be44 ffff88032016d800 ffff8801b418bdf8 0000000000000000
ffff8801824a7b00 ffff8801b418bdd7 ffff8803201725d0 ffffffff8116a9c0
ffff8801b5c38dc0 0000000000000007 ffff88032016d800 0000000000000000
Call Trace:
[] lookup\_dcache+0x80/0xe0
[] \_\_lookup\_hash+0x23/0x90
[] lookup\_one\_len+0xc5/0x100
[] nfs\_sillyrename+0xe3/0x210 [nfs]
[] vfs\_unlink.part.25+0x7f/0xe0
[] do\_unlinkat+0x1ac/0x1d0
[] system\_call\_fastpath+0x16/0x1b
[<00002b5348b5f527>] 0x2b5348b5f526
Code: ec 38 b8 f6 ff ff ff 4c 89 64 24 18 4c 89 74 24 28 49 89 fc 48 89 5c 24 08 48 89 6c 24 10 49 89 f6 4c 89 6c 24 20 4c 89 7c 24 30  46 38 40 0f 85 d1 00 00 00 e8 c4 c4 df e0 48 8b 58 30 49 89
RIP [] nfs\_lookup\_revalidate+0x2d/0x480 [nfs]
RSP
CR2: 0000000000000038
---[ end trace 845113ed191985dd ]---
This Oops affects 3.5 kernels and older, and is due to lookup\_one\_len()
calling down to the dentry revalidation code with a NULL pointer
to struct nameidata.
It is fixed upstream by commit 0b728e1911c (stop passing nameidata \*
to ->d\_revalidate())
Reported-by: Richard Ems
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 40324cd9f8c247f5be4114d5721c1bb66965c172
Author: Andreas Schwab
Date: Sat Jun 9 15:58:56 2012 +0200
sound/aoa: Adapt to new i2c probing scheme
commit 26b0d14106954ae46d2f4f7eec3481828a210f7d upstream.
The i2c-powermac driver now creates the i2c devices properly
from the device-tree, including workarounds for broken or
missing device-tree bits, so let's just use the normal probe
methods and get rid of the hand made device creation code.
Signed-off-by: Andreas Schwab
Signed-off-by: Benjamin Herrenschmidt
Cc: Elimar Riesebieter
Cc: Michel Dänzer
Signed-off-by: Greg Kroah-Hartman
commit a07d6f9f4536af97bcb0d387d7280b1f4568b109
Author: Benjamin Herrenschmidt
Date: Mon Jun 18 12:00:50 2012 +1000
i2c/powermac: Improve detection of devices from device-tree
commit 3a3dd0186f619b74e61e6f29dddcaf59af7d3cac upstream.
This patch adds a number of workarounds for broken Apple device-trees
mostly around sound chips. It handles creating the missing audio codec
devices and works around various issues with missing addresses or
missing compatible properties.
Signed-off-by: Benjamin Herrenschmidt
Cc: Michel Dänzer
Cc: Elimar Riesebieter
Signed-off-by: Greg Kroah-Hartman
commit a122873c3232b60cfbbd58ab58c906926dba7dc0
Author: Keshava Munegowda
Date: Fri Jul 20 15:13:35 2012 +0530
OMAP: USB : Fix the EHCI enumeration and core retention issue
commit 872c495dd0f9d1f48814a8ee80c2c7b3b7c3b4d9 upstream.
This commit 354ab8567ae3107a8cbe7228c3181990ba598aac titled
"Fix OMAP EHCI suspend/resume failure (i693)" is causing
the usb hub and device detection fails in beagle XM
causeing NFS not functional. This affects the core retention too.
The same commit logic needs to be revisted adhering to hwmod and
device tree framework.
for now, this commit id 354ab8567ae3107a8cbe7228c3181990ba598aac
titled "Fix OMAP EHCI suspend/resume failure (i693)" reverted.
This patch is validated on BeagleXM with NFS support over
usb ethernet and USB mass storage and other device detection.
Signed-off-by: Keshava Munegowda
Acked-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit a93689e1da5687e462363fde567e9b7abd570124
Author: Darren Hart
Date: Tue Jun 19 14:00:18 2012 -0700
pch\_uart: Add eg20t\_port lock field, avoid recursive spinlocks
commit 2588aba002d14e938c2f56d299ecf3e7ce1302a5 upstream.
pch\_uart\_interrupt() takes priv->port.lock which leads to two recursive
spinlock calls if low\_latency==1 or CONFIG\_PREEMPT\_RT\_FULL=y (one
otherwise):
pch\_uart\_interrupt
spin\_lock\_irqsave(priv->port.lock, flags)
case PCH\_UART\_IID\_RDR\_TO (data ready)
handle\_rx\_to
push\_rx
tty\_port\_tty\_get
spin\_lock\_irqsave(&port->lock, flags) <--- already hold this lock
...
tty\_flip\_buffer\_push
...
flush\_to\_ldisc
spin\_lock\_irqsave(&tty->buf.lock)
spin\_lock\_irqsave(&tty->buf.lock)
disc->ops->receive\_buf(tty, char\_buf)
n\_tty\_receive\_buf
tty->ops->flush\_chars()
uart\_flush\_chars
uart\_start
spin\_lock\_irqsave(&port->lock) <--- already hold this lock
Avoid this by using a dedicated lock to protect the eg20t\_port structure
and IO access to its membase. This is more consistent with the 8250
driver. Ensure priv->lock is always take prior to priv->port.lock when
taken at the same time.
V2: Remove inadvertent whitespace change.
V3: Account for oops\_in\_progress for the private lock in
pch\_console\_write().
Note: Like the 8250 driver, if a printk is introduced anywhere inside
the pch\_console\_write() critical section, the kernel will hang
on a recursive spinlock on the private lock. The oops case is
handled by using a trylock in the oops\_in\_progress case.
Signed-off-by: Darren Hart
CC: Tomoya MORINAGA
CC: Feng Tang
CC: Alexander Stein
Acked-by: Alan Cox
Signed-off-by: Greg Kroah-Hartman
commit 8e518b46f7552d53be920c9b0415784fe0172e9d
Author: Timur Tabi
Date: Mon Jul 23 15:43:32 2012 -0500
powerpc/85xx: p1022ds: fix DIU/LBC switching with NAND enabled
commit 896c01cb4bb3cfc2c0ea9873fa7a9f8bd0a7c8d8 upstream.
In order for indirect mode on the PIXIS to work properly, both chip selects
need to be set to GPCM mode, otherwise writes to the chip select base
addresses will not actually post to the local bus -- they'll go to the
NAND controller instead. Therefore, we need to set BR0 and BR1 to GPCM
mode before switching to indirect mode.
Signed-off-by: Timur Tabi
Signed-off-by: Kumar Gala
Signed-off-by: Greg Kroah-Hartman
commit 769f1c1a00de9a155cd905000943ed336500cee4
Author: Timur Tabi
Date: Fri Jul 13 14:28:42 2012 -0500
powerpc/85xx: p1022ds: disable the NAND flash node if video is enabled
commit 6269f2584a359766f53005c676daff8aee60cbed upstream.
The Freescale P1022 has a unique pin muxing "feature" where the DIU video
controller's video signals are muxed with 24 of the local bus address signals.
When the DIU is enabled, the bulk of the local bus is disabled, preventing
access to memory-mapped devices like NAND flash and the pixis FPGA.
Therefore, if the DIU is going to be enabled, then memory-mapped devices on
the localbus, like NAND flash, need to be disabled.
This patch is similar to "powerpc/85xx: p1022ds: disable the NOR flash node
if video is enabled", except that it disables the NAND flash node instead.
This PIXIS node needs to remain enabled because it is used by platform code
to switch into indirect mode.
Signed-off-by: Timur Tabi
Signed-off-by: Kumar Gala
Signed-off-by: Greg Kroah-Hartman
commit 774093a4f9b16c74f3ffb264314a798528786ff6
Author: Tomoya MORINAGA
Date: Fri Jul 6 17:19:43 2012 +0900
pch\_uart: Fix parity setting issue
commit 38bd2a1ac736901d1cf4971c78ef952ba92ef78b upstream.
Parity Setting value is reverse.
E.G. In case of setting ODD parity, EVEN value is set.
This patch inverts "if" condition.
Signed-off-by: Tomoya MORINAGA
Acked-by: Alan Cox
Signed-off-by: Greg Kroah-Hartman
commit 775436806eb348affdc7693341b0f23ed8147ebd
Author: Tomoya MORINAGA
Date: Fri Jul 6 17:19:42 2012 +0900
pch\_uart: Fix rx error interrupt setting issue
commit 9539dfb7ac1c84522fe1f79bb7dac2990f3de44a upstream.
Rx Error interrupt(E.G. parity error) is not enabled.
So, when parity error occurs, error interrupt is not occurred.
As a result, the received data is not dropped.
This patch adds enable/disable rx error interrupt code.
Signed-off-by: Tomoya MORINAGA
Acked-by: Alan Cox
Signed-off-by: Greg Kroah-Hartman
commit ca6be9203a58f70e7489e14ff8a5af162276b049
Author: Alan Cox
Date: Mon Jul 2 18:51:38 2012 +0100
pch\_uart: Fix missing break for 16 byte fifo
commit 9bc03743fff0770dc5a5324ba92e67cc377f16ca upstream.
Otherwise we fall back to the wrong value.
Reported-by:
Resolves-bug: https://bugzilla.kernel.org/show\_bug.cgi?id=44091
Signed-off-by: Alan Cox
Signed-off-by: Tomoya MORINAGA
Signed-off-by: Greg Kroah-Hartman
commit 1b80cf03c46f5fab17df853930ffadd02aacf11e
Author: Douglas Bagnall
Date: Fri Jul 6 23:27:57 2012 -0300
media: Avoid sysfs oops when an rc\_dev's raw device is absent
commit 720bb6436ff30fccad05cf5bdf961ea5b1f5686d upstream.
For some reason, when the lirc daemon learns that a usb remote control
has been unplugged, it wants to read the sysfs attributes of the
disappearing device. This is useful for uncovering transient
inconsistencies, but less so for keeping the system running when such
inconsistencies exist.
Under some circumstances (like every time I unplug my dvb stick from
my laptop), lirc catches an rc\_dev whose raw event handler has been
removed (presumably by ir\_raw\_event\_unregister), and proceeds to
interrogate the raw protocols supported by the NULL pointer.
This patch avoids the NULL dereference, and ignores the issue of how
this state of affairs came about in the first place.
Version 2 incorporates changes recommended by Mauro Carvalho Chehab
(-ENODEV instead of -EINVAL, and a signed-off-by).
Signed-off-by: Douglas Bagnall
Signed-off-by: Mauro Carvalho Chehab
Cc: Herton Ronaldo Krzesinski
Signed-off-by: Greg Kroah-Hartman
commit 4eb34389b35064542b62099a14a51a43cf49598c
Author: John Stultz
Date: Tue Sep 11 14:56:21 2012 -0400
time: Move ktime\_t overflow checking into timespec\_valid\_strict
commit cee58483cf56e0ba355fdd97ff5e8925329aa936 upstream.
Andreas Bombe reported that the added ktime\_t overflow checking added to
timespec\_valid in commit 4e8b14526ca7 ("time: Improve sanity checking of
timekeeping inputs") was causing problems with X.org because it caused
timeouts larger then KTIME\_T to be invalid.
Previously, these large timeouts would be clamped to KTIME\_MAX and would
never expire, which is valid.
This patch splits the ktime\_t overflow checking into a new
timespec\_valid\_strict function, and converts the timekeeping codes
internal checking to use this more strict function.
Reported-and-tested-by: Andreas Bombe
Cc: Zhouping Liu
Cc: Ingo Molnar
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Signed-off-by: John Stultz
Signed-off-by: Linus Torvalds
Signed-off-by: John Stultz
Signed-off-by: Greg Kroah-Hartman
commit 4e64f897ce0d333d574143c0a23b1299d6137b4a
Author: John Stultz
Date: Tue Sep 11 14:56:20 2012 -0400
time: Avoid making adjustments if we haven't accumulated anything
commit bf2ac312195155511a0f79325515cbb61929898a upstream.
If update\_wall\_time() is called and the current offset isn't large
enough to accumulate, avoid re-calling timekeeping\_adjust which may
change the clock freq and can cause 1ns inconsistencies with
CLOCK\_REALTIME\_COARSE/CLOCK\_MONOTONIC\_COARSE.
Signed-off-by: John Stultz
Cc: Prarit Bhargava
Cc: Ingo Molnar
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1345595449-34965-5-git-send-email-john.stultz@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: John Stultz
Signed-off-by: Greg Kroah-Hartman
commit 7df3d033efb005c6018512933078566cd6f49463
Author: John Stultz
Date: Tue Sep 11 14:56:19 2012 -0400
time: Improve sanity checking of timekeeping inputs
commit 4e8b14526ca7fb046a81c94002c1c43b6fdf0e9b upstream.
Unexpected behavior could occur if the time is set to a value large
enough to overflow a 64bit ktime\_t (which is something larger then the
year 2262).
Also unexpected behavior could occur if large negative offsets are
injected via adjtimex.
So this patch improves the sanity check timekeeping inputs by
improving the timespec\_valid() check, and then makes better use of
timespec\_valid() to make sure we don't set the time to an invalid
negative value or one that overflows ktime\_t.
Note: This does not protect from setting the time close to overflowing
ktime\_t and then letting natural accumulation cause the overflow.
Reported-by: CAI Qian
Reported-by: Sasha Levin
Signed-off-by: John Stultz
Cc: Peter Zijlstra
Cc: Prarit Bhargava
Cc: Zhouping Liu
Cc: Ingo Molnar
Link: http://lkml.kernel.org/r/1344454580-17031-1-git-send-email-john.stultz@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: John Stultz
Signed-off-by: Greg Kroah-Hartman
commit 25d97e9ecea68839ac7d55e8ccd381111254bfb2
Author: Jarod Wilson
Date: Mon Jun 4 13:05:24 2012 -0300
media: lirc\_sir: make device registration work
commit 4b71ca6bce8fab3d08c61bf330e781f957934ae1 upstream.
For one, the driver device pointer needs to be filled in, or the lirc core
will refuse to load the driver. And we really need to wire up all the
platform\_device bits. This has been tested via the lirc sourceforge tree
and verified to work, been sitting there for months, finally getting
around to sending it. :\
Signed-off-by: Jarod Wilson
Signed-off-by: Mauro Carvalho Chehab
CC: Josh Boyer
Signed-off-by: Greg Kroah-Hartman
commit 4f83989550ace0aa91464051cbaddc10e1b85778
Author: Peter Zijlstra
Date: Fri Jun 22 13:36:05 2012 +0200
sched: Fix race in task\_group()
commit 8323f26ce3425460769605a6aece7a174edaa7d1 upstream.
Stefan reported a crash on a kernel before a3e5d1091c1 ("sched:
Don't call task\_group() too many times in set\_task\_rq()"), he
found the reason to be that the multiple task\_group()
invocations in set\_task\_rq() returned different values.
Looking at all that I found a lack of serialization and plain
wrong comments.
The below tries to fix it using an extra pointer which is
updated under the appropriate scheduler locks. Its not pretty,
but I can't really see another way given how all the cgroup
stuff works.
Reported-and-tested-by: Stefan Bader
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/r/1340364965.18025.71.camel@twins
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 589e9fa686c2a02b48a36057c9ba5a7327059074
Author: Daniel J Blueman
Date: Mon Jul 23 12:22:37 2012 +0800
libata: Prevent interface errors with Seagate FreeAgent GoFlex
commit c531077f40abc9f2129c4c83a30b3f8d6ce1c0e7 upstream.
When using my Seagate FreeAgent GoFlex eSATAp external disk enclosure,
interface errors are always seen until 1.5Gbps is negotiated [1]. This
occurs using any disk in the enclosure, and when the disk is connected
directly with a generic passive eSATAp cable, we see stable 3Gbps
operation as expected.
Blacklist 3Gbps mode to avoid dataloss and the ~30s delay bus reset
and renegotiation incurs.
Signed-off-by: Daniel J Blueman
Signed-off-by: Jeff Garzik
Signed-off-by: Greg Kroah-Hartman
commit ac6519ad79a7553efcb335d85fec6f0b4ce89454
Author: Weiping Pan
Date: Mon Jul 23 10:37:48 2012 +0800
rds: set correct msg\_namelen
commit 06b6a1cf6e776426766298d055bb3991957d90a7 upstream.
Jay Fenlason (fenlason@redhat.com) found a bug,
that recvfrom() on an RDS socket can return the contents of random kernel
memory to userspace if it was called with a address length larger than
sizeof(struct sockaddr\_in).
rds\_recvmsg() also fails to set the addr\_len paramater properly before
returning, but that's just a bug.
There are also a number of cases wher recvfrom() can return an entirely bogus
address. Anything in rds\_recvmsg() that returns a non-negative value but does
not go through the "sin = (struct sockaddr\_in \*)msg->msg\_name;" code path
at the end of the while(1) loop will return up to 128 bytes of kernel memory
to userspace.
And I write two test programs to reproduce this bug, you will see that in
rds\_server, fromAddr will be overwritten and the following sock\_fd will be
destroyed.
Yes, it is the programmer's fault to set msg\_namelen incorrectly, but it is
better to make the kernel copy the real length of address to user space in
such case.
How to run the test programs ?
I test them on 32bit x86 system, 3.5.0-rc7.
1 compile
gcc -o rds\_client rds\_client.c
gcc -o rds\_server rds\_server.c
2 run ./rds\_server on one console
3 run ./rds\_client on another console
4 you will see something like:
server is waiting to receive data...
old socket fd=3
server received data from client:data from client
msg.msg\_namelen=32
new socket fd=-1067277685
sendmsg()
: Bad file descriptor
/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* rds\_client.c \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
int main(void)
{
int sock\_fd;
struct sockaddr\_in serverAddr;
struct sockaddr\_in toAddr;
char recvBuffer[128] = "data from client";
struct msghdr msg;
struct iovec iov;
sock\_fd = socket(AF\_RDS, SOCK\_SEQPACKET, 0);
if (sock\_fd < 0) {
perror("create socket error\n");
exit(1);
}
memset(&serverAddr, 0, sizeof(serverAddr));
serverAddr.sin\_family = AF\_INET;
serverAddr.sin\_addr.s\_addr = inet\_addr("127.0.0.1");
serverAddr.sin\_port = htons(4001);
if (bind(sock\_fd, (struct sockaddr\*)&serverAddr, sizeof(serverAddr)) < 0) {
perror("bind() error\n");
close(sock\_fd);
exit(1);
}
memset(&toAddr, 0, sizeof(toAddr));
toAddr.sin\_family = AF\_INET;
toAddr.sin\_addr.s\_addr = inet\_addr("127.0.0.1");
toAddr.sin\_port = htons(4000);
msg.msg\_name = &toAddr
msg.msg\_namelen = sizeof(toAddr);
msg.msg\_iov = &iov
msg.msg\_iovlen = 1;
msg.msg\_iov->iov\_base = recvBuffer;
msg.msg\_iov->iov\_len = strlen(recvBuffer) + 1;
msg.msg\_control = 0;
msg.msg\_controllen = 0;
msg.msg\_flags = 0;
if (sendmsg(sock\_fd, &msg, 0) == -1) {
perror("sendto() error\n");
close(sock\_fd);
exit(1);
}
printf("client send data:%s\n", recvBuffer);
memset(recvBuffer, '\0', 128);
msg.msg\_name = &toAddr
msg.msg\_namelen = sizeof(toAddr);
msg.msg\_iov = &iov
msg.msg\_iovlen = 1;
msg.msg\_iov->iov\_base = recvBuffer;
msg.msg\_iov->iov\_len = 128;
msg.msg\_control = 0;
msg.msg\_controllen = 0;
msg.msg\_flags = 0;
if (recvmsg(sock\_fd, &msg, 0) == -1) {
perror("recvmsg() error\n");
close(sock\_fd);
exit(1);
}
printf("receive data from server:%s\n", recvBuffer);
close(sock\_fd);
return 0;
}
/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* rds\_server.c \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
int main(void)
{
struct sockaddr\_in fromAddr;
int sock\_fd;
struct sockaddr\_in serverAddr;
unsigned int addrLen;
char recvBuffer[128];
struct msghdr msg;
struct iovec iov;
sock\_fd = socket(AF\_RDS, SOCK\_SEQPACKET, 0);
if(sock\_fd < 0) {
perror("create socket error\n");
exit(0);
}
memset(&serverAddr, 0, sizeof(serverAddr));
serverAddr.sin\_family = AF\_INET;
serverAddr.sin\_addr.s\_addr = inet\_addr("127.0.0.1");
serverAddr.sin\_port = htons(4000);
if (bind(sock\_fd, (struct sockaddr\*)&serverAddr, sizeof(serverAddr)) < 0) {
perror("bind error\n");
close(sock\_fd);
exit(1);
}
printf("server is waiting to receive data...\n");
msg.msg\_name = &fromAddr
/\*
\* I add 16 to sizeof(fromAddr), ie 32,
\* and pay attention to the definition of fromAddr,
\* recvmsg() will overwrite sock\_fd,
\* since kernel will copy 32 bytes to userspace.
\*
\* If you just use sizeof(fromAddr), it works fine.
\* \*/
msg.msg\_namelen = sizeof(fromAddr) + 16;
/\* msg.msg\_namelen = sizeof(fromAddr); \*/
msg.msg\_iov = &iov
msg.msg\_iovlen = 1;
msg.msg\_iov->iov\_base = recvBuffer;
msg.msg\_iov->iov\_len = 128;
msg.msg\_control = 0;
msg.msg\_controllen = 0;
msg.msg\_flags = 0;
while (1) {
printf("old socket fd=%d\n", sock\_fd);
if (recvmsg(sock\_fd, &msg, 0) == -1) {
perror("recvmsg() error\n");
close(sock\_fd);
exit(1);
}
printf("server received data from client:%s\n", recvBuffer);
printf("msg.msg\_namelen=%d\n", msg.msg\_namelen);
printf("new socket fd=%d\n", sock\_fd);
strcat(recvBuffer, "--data from server");
if (sendmsg(sock\_fd, &msg, 0) == -1) {
perror("sendmsg()\n");
close(sock\_fd);
exit(1);
}
}
close(sock\_fd);
return 0;
}
Signed-off-by: Weiping Pan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d039ed8264695916335c639d8de77c3b1ff18e71
Author: Li Zhong
Date: Tue Jul 24 15:02:49 2012 -0700
Fix a dead loop in async\_synchronize\_full()
[Fixed upstream by commits 2955b47d2c1983998a8c5915cb96884e67f7cb53 and
a4683487f90bfe3049686fc5c566bdc1ad03ace6 from Dan Williams, but they are much
more intrusive than this tiny fix, according to Andrew - gregkh]
This patch tries to fix a dead loop in async\_synchronize\_full(), which
could be seen when preemption is disabled on a single cpu machine.
void async\_synchronize\_full(void)
{
do {
async\_synchronize\_cookie(next\_cookie);
} while (!list\_empty(&async\_running) || !
list\_empty(&async\_pending));
}
async\_synchronize\_cookie() calls async\_synchronize\_cookie\_domain() with
&async\_running as the default domain to synchronize.
However, there might be some works in the async\_pending list from other
domains. On a single cpu system, without preemption, there is no chance
for the other works to finish, so async\_synchronize\_full() enters a dead
loop.
It seems async\_synchronize\_full() wants to synchronize all entries in
all running lists(domains), so maybe we could just check the entry\_count
to know whether all works are finished.
Currently, async\_synchronize\_cookie\_domain() expects a non-NULL running
list ( if NULL, there would be NULL pointer dereference ), so maybe a
NULL pointer could be used as an indication for the functions to
synchronize all works in all domains.
Reported-by: Paul E. McKenney
Signed-off-by: Li Zhong
Tested-by: Paul E. McKenney
Tested-by: Christian Kujau
Cc: Andrew Morton
Cc: Dan Williams
Cc: Christian Kujau
Cc: Andrew Morton
Cc: Cong Wang
Signed-off-by: Greg Kroah-Hartman
commit a7afc1629143b046165e5e304056b47a9942e876
Author: Vinicius Costa Gomes
Date: Thu Aug 23 21:32:44 2012 -0300
Bluetooth: Fix sending a HCI Authorization Request over LE links
commit d8343f125710fb596f7a88cd756679f14f4e77b9 upstream.
In the case that the link is already in the connected state and a
Pairing request arrives from the mgmt interface, hci\_conn\_security()
would be called but it was not considering LE links.
Reported-by: João Paulo Rechi Vita
Signed-off-by: Vinicius Costa Gomes
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 257f3932617fa8019b779f6fa0d327c50885ff8a
Author: Vinicius Costa Gomes
Date: Thu Aug 23 21:32:43 2012 -0300
Bluetooth: Change signature of smp\_conn\_security()
commit cc110922da7e902b62d18641a370fec01a9fa794 upstream.
To make it clear that it may be called from contexts that may not have
any knowledge of L2CAP, we change the connection parameter, to receive
a hci\_conn.
This also makes it clear that it is checking the security of the link.
Signed-off-by: Vinicius Costa Gomes
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 222616daa324e7a7c911d8f513181417b55ba2df
Author: Andre Guedes
Date: Wed Aug 1 20:34:15 2012 -0300
Bluetooth: Fix use-after-free bug in SMP
commit 61a0cfb008f57ecf7eb28ee762952fb42dc15d15 upstream.
If SMP fails, we should always cancel security\_timer delayed work.
Otherwise, security\_timer function may run after l2cap\_conn object
has been freed.
This patch fixes the following warning reported by ODEBUG:
WARNING: at lib/debugobjects.c:261 debug\_print\_object+0x7c/0x8d()
Hardware name: Bochs
ODEBUG: free active (active state 0) object type: timer\_list hint: delayed\_work\_timer\_fn+0x0/0x27
Modules linked in: btusb bluetooth
Pid: 440, comm: kworker/u:2 Not tainted 3.5.0-rc1+ #4
Call Trace:
[] ? free\_obj\_work+0x4a/0x7f
[] warn\_slowpath\_common+0x7e/0x97
[] warn\_slowpath\_fmt+0x41/0x43
[] debug\_print\_object+0x7c/0x8d
[] ? \_\_queue\_work+0x241/0x241
[] debug\_check\_no\_obj\_freed+0x92/0x159
[] slab\_free\_hook+0x6f/0x77
[] ? l2cap\_conn\_del+0x148/0x157 [bluetooth]
[] kfree+0x59/0xac
[] l2cap\_conn\_del+0x148/0x157 [bluetooth]
[] l2cap\_recv\_frame+0xa77/0xfa4 [bluetooth]
[] ? trace\_hardirqs\_on\_caller+0x112/0x1ad
[] l2cap\_recv\_acldata+0xe2/0x264 [bluetooth]
[] hci\_rx\_work+0x235/0x33c [bluetooth]
[] ? process\_one\_work+0x126/0x2fe
[] process\_one\_work+0x185/0x2fe
[] ? process\_one\_work+0x126/0x2fe
[] ? lock\_acquired+0x1b5/0x1cf
[] ? le\_scan\_work+0x11d/0x11d [bluetooth]
[] ? spin\_lock\_irq+0x9/0xb
[] worker\_thread+0xcf/0x175
[] ? rescuer\_thread+0x175/0x175
[] kthread+0x95/0x9d
[] kernel\_threadi\_helper+0x4/0x10
[] ? retint\_restore\_args+0x13/0x13
[] ? flush\_kthread\_worker+0xdb/0xdb
[] ? gs\_change+0x13/0x13
This bug can be reproduced using hctool lecc or l2test tools and
bluetoothd not running.
Signed-off-by: Andre Guedes
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit d601ddf0e5050fcdb2b1db1a9120cf0a9412817b
Author: Henrik Rydberg
Date: Sat Aug 25 19:28:06 2012 +0200
Bluetooth: Add support for Apple vendor-specific devices
commit 1fa6535faf055cd71311ab887e94fc234f04ee18 upstream.
As pointed out by Gustavo and Marcel, all Apple-specific Broadcom
devices seen so far have the same interface class, subclass and
protocol numbers. This patch adds an entry which matches all of them,
using the new USB\_VENDOR\_AND\_INTERFACE\_INFO() macro.
In particular, this patch adds support for the MacBook Pro Retina
(05ac:8286), which is not in the present list.
Signed-off-by: Henrik Rydberg
Tested-by: Shea Levy
Acked-by: Marcel Holtmann
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 765488029cc1735004acc06d6913ffe705c64c58
Author: Gustavo Padovan
Date: Mon Aug 6 15:36:49 2012 -0300
Bluetooth: Use USB\_VENDOR\_AND\_INTERFACE() for Broadcom devices
commit 92c385f46b30f4954e9dd2d2005c12d233b479ea upstream.
Many Broadcom devices has a vendor specific devices class, with this rule
we match all existent and future controllers with this behavior.
We also remove old rules to that matches product id for Broadcom devices.
Tested-by: John Hommel
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit bd1a42b3a30d2f2ffd7787efb5e60a5e914eead6
Author: Yevgeniy Melnichuk
Date: Tue Aug 7 19:48:10 2012 +0530
Bluetooth: Add support for Sony Vaio T-Series
commit bc21fde2d549d1cb1ebef04016eb7affa43bb5c1 upstream.
Add Sony Vaio T-Series Bluetooth Module( 0x489:0xE036) to
the blacklist of btusb module and add it to the ath3k module.
output of cat /sys/kernel/debug/usb/devices
T: Bus=01 Lev=02 Prnt=02 Port=01 Cnt=01 Dev#= 5 Spd=12 MxCh= 0
D: Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0489 ProdID=e036 Rev= 0.02
S: Manufacturer=Atheros Communications
S: Product=Bluetooth USB Host Controller
S: SerialNumber=Alaska Day 2006
C:\* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=1ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 64 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 64 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
Signed-off-by: Yevgeniy Melnichuk
Signed-off-by: Mohammed Shafi Shajakhan
Acked-by: Marcel Holtmann
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 456f44935e59a39ba6e4af1d73b1a4f348a47cd2
Author: Peng Chen
Date: Wed Aug 1 10:11:59 2012 +0800
Bluetooth: add support for atheros 0489:e057
commit 2096ae6ca647302d50a68aa36cb66a00e7dfac70 upstream.
Add support for the AR3012 chip found on Fioxconn.
usb-devices shows:
T: Bus=06 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 44 Spd=12 MxCh= 0
D: Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0489 ProdID=e057 Rev= 0.02
C:\* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
I:\* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=81(I) Atr=03(Int.) MxPS= 16 Ivl=1ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 64 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 64 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 0 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 0 Ivl=1ms
I: If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 9 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 9 Ivl=1ms
I: If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 17 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 17 Ivl=1ms
I: If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 25 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 25 Ivl=1ms
I: If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 33 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 33 Ivl=1ms
I: If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
E: Ad=83(I) Atr=01(Isoc) MxPS= 49 Ivl=1ms
E: Ad=03(O) Atr=01(Isoc) MxPS= 49 Ivl=1ms
Signed-off-by: Peng Chen
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 8d40b94545d1013830872f68f81d72557149ae97
Author: Manoj Iyer
Date: Tue Jul 10 14:07:38 2012 -0500
Bluetooth: btusb: Add vendor specific ID (0a5c:21f4) BCM20702A0
commit 61c964ba1748e984cb232b431582815899bf10fe upstream.
Patch adds support for BCM20702A0 device id (0a5c:21f4).
usb-devices after patch was applied:
T: Bus=03 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 2 Spd=12 MxCh= 0
D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0a5c ProdID=21f4 Rev=01.12
S: Manufacturer=Broadcom Corp
S: Product=BCM20702A0
S: SerialNumber=E4D53DF154D6
C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=btusb
I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=btusb
I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
usb-devices before patch was applied:
T: Bus=03 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 2 Spd=12 MxCh= 0
D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0a5c ProdID=21f4 Rev=01.12
S: Manufacturer=Broadcom Corp
S: Product=BCM20702A0
S: SerialNumber=E4D53DF154D6
C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
Signed-off-by: Manoj Iyer
Tested-by: Chris Gagnon
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit cc534755ea9ee245424864d5b049a5202deff854
Author: Ping Cheng
Date: Tue Jun 12 00:14:12 2012 -0700
Input: wacom - rearrange type enum
commit ea2e60244573a9204c8cee9b4fb181106784c617 upstream.
So we can simplify a few type related if statements
Also fixes https://bugzilla.kernel.org/show\_bug.cgi?id=46821
Signed-off-by: Ping Cheng
Acked-by: Chris Bagwell
Reviewed-by: Jason Gerecke
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 4bb04e1b2eafc36c4cb5d36259911247e67f0ca7
Author: Ping Cheng
Date: Tue Jul 24 23:54:11 2012 -0700
Input: wacom - add support to Cintiq 22HD
commit d838c644fea603eb24811333c6e2cf4f9722bf10 upstream.
Signed-off-by: Ping Cheng
Signed-off-by: Dmitry Torokhov
Cc: Joseph Salisbury
Signed-off-by: Greg Kroah-Hartman
commit 814b1489d0e0d0d869f3d675fb791478370de9d3
Author: Lai Jiangshan
Date: Sun Sep 2 00:28:19 2012 +0800
workqueue: UNBOUND -> REBIND morphing in rebind\_workers() should be atomic
commit 96e65306b81351b656835c15931d1d237b252f27 upstream.
The compiler may compile the following code into TWO write/modify
instructions.
worker->flags &= ~WORKER\_UNBOUND;
worker->flags |= WORKER\_REBIND;
so the other CPU may temporarily see worker->flags which doesn't have
either WORKER\_UNBOUND or WORKER\_REBIND set and perform local wakeup
prematurely.
Fix it by using single explicit assignment via ACCESS\_ONCE().
Because idle workers have another WORKER\_NOT\_RUNNING flag, this bug
doesn't exist for them; however, update it to use the same pattern for
consistency.
tj: Applied the change to idle workers too and updated comments and
patch description a bit.
Signed-off-by: Lai Jiangshan
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 63bd905214a37724dce79131461366d16a6397db
Author: Richard Cochran
Date: Thu Sep 20 19:11:12 2012 +0000
gianfar: fix phc index build failure
commit 28889b7e7818342f6c254e27b9b2c68702ab867a upstream.
This patch fixes a build failure introduced in commit 66636287
("gianfar: Support the get\_ts\_info ethtool method."). Not only was a
global variable inconsistently named, but also it was not exported as
it should have been.
This fix is also needed in stable version 3.5.
Signed-off-by: Richard Cochran
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 679663e954700404017a781250f7fd8e749b3529
Author: Johannes Berg
Date: Tue Aug 21 18:57:10 2012 +0200
iwlwifi: fix flow handler debug code
commit 94543a8d4fb302817014981489f15cb3b92ec3c2 upstream.
iwl\_dbgfs\_fh\_reg\_read() can cause crashes and/or
BUG\_ON in slub because the ifdefs are wrong, the
code in iwl\_dump\_fh() should use DEBUGFS, not
DEBUG to protect the buffer writing code.
Also, while at it, clean up the arguments to the
function, some code and make it generally safer.
Reported-by: Benjamin Herrenschmidt
Signed-off-by: Johannes Berg
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit cf7516923d7ee975b21a1ea633f6a9c65fef66e3
Author: Johannes Berg
Date: Tue Aug 21 18:57:11 2012 +0200
iwlwifi: protect SRAM debugfs
commit 4fc79db178f0a0ede479b4713e00df2d106028b3 upstream.
If the device is not started, we can't read its
SRAM and attempting to do so will cause issues.
Protect the debugfs read.
Signed-off-by: Johannes Berg
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 54abcfeb2ce031f864b8a8c574333446af335c3c
Author: Emmanuel Grumbach
Date: Tue Sep 18 19:48:59 2012 +0200
iwlwifi: don't double free the interrupt in failure path
commit a7be50b7e30f9d77cb059a7ffdb781bb0fb92eba upstream.
When the driver can't get the HW ready, we would release
the interrupt twice which made the kernel complain loudly.
Reported-by: Brian Cockrell
Tested-by: Brian Cockrell
Signed-off-by: Emmanuel Grumbach
Signed-off-by: Johannes Berg
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 0bcaf42e89b5be757bf4ffc4063411c8ebe40e06
Author: Maxim Levitsky
Date: Tue Aug 14 02:22:07 2012 +0300
drm/nv86/fifo: suspend fix
commit 2064db725cc6d4ea19a24c138bc37939b63e3ae6 upstream.
This fix is a backport from the reworked nouveau driver. It masks off the
engines we're not expecting to use before attempting a channel kickoff.
Signed-off-by: Maxim Levitsky
Signed-off-by: Ben Skeggs
Cc: Sven Joachim
Signed-off-by: Greg Kroah-Hartman
commit edec121abe8f51e14d328dfc893ae704567f4466
Author: Chris Wilson
Date: Sat Sep 15 09:41:57 2012 +0100
drm/i915: Reduce a pin-leak BUG into a WARN
commit 7e81a42e341a4f15d76624b7c02ffb21b085b56f upstream.
Pin-leaks persist and we get the perennial bug reports of machine
lockups to the BUG\_ON(pin\_count==MAX). If we instead loudly report that
the object cannot be pinned at that time it should prevent the driver from
locking up, and hopefully restore a semblance of working whilst still
leaving us a OOPS to debug.
Signed-off-by: Chris Wilson
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit be1454d861fd19352590c9dfb1523e4612ac79bb
Author: Wang Xingchao
Date: Thu Sep 13 07:43:22 2012 +0800
drm/i915: HDMI - Clear Audio Enable bit for Hot Plug
commit b98b60167279df3acac9422c3c9820d9ebbcf9fb upstream.
Clear Audio Enable bit to trigger unsolicated event to notify Audio
Driver part the HDMI hot plug change. The patch fixed the bug when
remove HDMI cable the bit was not cleared correctly.
In intel\_hdmi\_dpms(), if intel\_hdmi->has\_audio been true, the "Audio enable bit" will
be set to trigger unsolicated event to notify Alsa driver the change.
intel\_hdmi->has\_audio will be reset to false from intel\_hdmi\_detect() after
remove the hdmi cable, here's debug log:
[ 187.494153] [drm:output\_poll\_execute], [CONNECTOR:17:HDMI-A-1] status updated from 1 to 2
[ 187.525349] [drm:intel\_hdmi\_detect], HDMI: has\_audio = 0
so when comes back to intel\_hdmi\_dpms(), the "Audio enable bit" will not be cleared. And this
cause the eld infomation and pin presence doesnot update accordingly in alsa driver side.
This patch will also trigger unsolicated event to alsa driver to notify the hot plug event:
[ 187.853159] ALSA sound/pci/hda/patch\_hdmi.c:772 HDMI hot plug event: Codec=3 Pin=5 Presence\_Detect=0 ELD\_Valid=1
[ 187.853268] ALSA sound/pci/hda/patch\_hdmi.c:990 HDMI status: Codec=3 Pin=5 Presence\_Detect=0 ELD\_Valid=0
Signed-off-by: Wang Xingchao
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit b8291fe24ce3c4ba59e1b046641d1e471af4cf31
Author: Daniel Vetter
Date: Tue Sep 11 12:37:55 2012 +0200
drm/i915: enable lvds pin pairs before dpll on gen2
commit 5b5896e4e1f353ef3dbc4e4e9ee44d53ccf105d7 upstream.
Otherwise things migt not work too well.
Breakage introduced in
commit eb1cbe4848b01f9f073064377875bc7d71eb401b
Author: Daniel Vetter
Date: Wed Mar 28 23:12:16 2012 +0200
drm/i915: split PLL update code out of i9xx\_crtc\_mode\_set
Reviewed-by: Jesse Barnes
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit eb87978823e46ea55759534011f2e2c16eac2a2b
Author: Daniel Vetter
Date: Sun Sep 9 11:54:16 2012 +0200
drm/i915: set the right gen3 flip\_done mode also at resume
commit 974a3b0f9f05b748fe11f1afc31efc32aa5160cb upstream.
Currently we've only frobbed this bit at irq\_init time, but did
not restore it at resume time. Move it to the gen3 clock gating
function to fix this.
Notice while reading through code.
Reviewed-by: Chris Wilson
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit 0dad2cd60e63c523e0968b159facabda6ce23fb8
Author: Dave Airlie
Date: Fri Sep 14 13:28:23 2012 +1000
drm/nouveau: fix booting with plymouth + dumb support
commit 610bd7da160f76f1644ecb4cd7f39511b49a22cc upstream.
We noticed a plymouth bug on Fedora 18, and I then
noticed this stupid thinko, fixing it fixed the problem
with plymouth.
Acked-by: Ben Skeggs
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 576fb84aaf06b3293667ea511c71b0e701651f9e
Author: Christian König
Date: Thu Sep 13 10:33:47 2012 +0200
drm/radeon: make 64bit fences more robust v3
commit f492c171a38d77fc13a8998a0721f2da50835224 upstream.
Only increase the higher 32bits if we really detect a wrap around.
v2: instead of increasing the higher 32bits just use the higher
32bits from the last emitted fence.
v3: also use last emitted fence value as upper limit.
The intention of this patch is to make fences as robust as
they where before introducing 64bit fences. This is
necessary because on older systems it looks like the fence
value gets corrupted on initialization.
Fixes:
https://bugs.freedesktop.org/show\_bug.cgi?id=51344
Should also fix:
https://bugs.freedesktop.org/show\_bug.cgi?id=54129
https://bugs.freedesktop.org/show\_bug.cgi?id=54662
https://bugzilla.redhat.com/show\_bug.cgi?id=846505
https://bugzilla.redhat.com/show\_bug.cgi?id=845639
3.5 needs a separate patch due to changes in the
fence code. Will send that out separately.
Signed-off-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit eefc86d74b3e70ae4d478a2a1bebb16a90a63061
Author: Alex Deucher
Date: Wed Aug 29 19:48:26 2012 -0400
drm/radeon: fix dig encoder selection on DCE61
commit 41fa54377057ab38bc3e08ebb46168a7daf2e63b upstream.
Was using the DCE41 code which was wrong. Fixes
blank displays on a number of Trinity systems.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 22c4c520ca2685c66fc74fbfce144411fe01fbae
Author: Jerome Glisse
Date: Tue Aug 28 16:50:22 2012 -0400
drm/radeon: force dma32 to fix regression rs4xx,rs6xx,rs740
commit 4a2b6662c3632176b4fdf012243dd3751367bf1f upstream.
It seems some of those IGP dislike non dma32 page despite what
documentation says. Fix regression since we allowed non dma32
pages. It seems it only affect some revision of those IGP chips
as we don't know which one just force dma32 for all of them.
https://bugzilla.redhat.com/show\_bug.cgi?id=785375
Signed-off-by: Jerome Glisse
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 33159fb77f79d5852ed5daca00ccfe3d444c07f2
Author: Alex Deucher
Date: Tue Aug 21 19:06:21 2012 -0400
drm/radeon: don't disable plls that are in use by other crtcs
commit 4e58591c8961b3e31709313f75819f2eec06e322 upstream.
Some plls are shared for DP.
Signed-off-by: Alex Deucher
Reviewed-by: Michel Dänzer
Signed-off-by: Greg Kroah-Hartman
commit b56c58b6bb015741b54ad1aa5abd46db274ac0a1
Author: Alex Deucher
Date: Mon Aug 20 11:06:21 2012 -0400
drm/radeon: convert radeon vfct code to use acpi\_get\_table\_with\_size
commit 7c3906d04a4587dceaa78cc1ae6b14e6454ee02a upstream.
Allows us to verify the table size.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 56422e822e5829a9822abd786efc6acfa59bc94f
Author: Xu, Anhua
Date: Mon Aug 13 03:08:33 2012 +0000
drm/i915: fix wrong order of parameters in port checking functions
commit b70ad586162609141f0aa9eb34790f31a8954f89 upstream.
Wrong order of parameters passed-in when calling hdmi/adpa
/lvds\_pipe\_enabled(), 2nd and 3rd parameters are reversed.
This bug was indroduced by
commit 1519b9956eb4b4180fa3f47c73341463cdcfaa37
Author: Keith Packard
Date: Sat Aug 6 10:35:34 2011 -0700
drm/i915: Fix PCH port pipe select in CPT disable paths
The reachable tag for this commit is v3.1-rc1-3-g1519b99
Signed-off-by: Anhua Xu
Reviewed-by: Chris Wilson
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=44876
Tested-by: Daniel Schroeder
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit bf903695675047612f52b260545a1e9c9438c08b
Author: Alex Deucher
Date: Fri Aug 24 18:21:21 2012 -0400
drm/radeon/atom: powergating fixes for DCE6
commit c205b232a64fed6d26edd7e40985b396de99a27f upstream.
Power gating is per crtc pair, but the powergating registers
should be called individually. The hw handles power up/down
properly. The pair is powered up if either crtc in the pair
is powered up and the pair is not powered down until both
crtcs in the pair are powered down. This simplifies
programming and should save additional power as the previous
code never actually power gated the crtc pair.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 76a271deba25e001c25a5e24420838506858e426
Author: Alex Deucher
Date: Wed Aug 22 09:54:56 2012 -0400
drm/radeon/atom: rework DIG modesetting on DCE3+
commit 8d1af57ae3c4458ed0de93ef97f388dd1b3239c7 upstream.
The ordering is important and the current drm code
wasn't cutting it for modern DIG encoders. We need
to have information about crtc before setting up
the encoders so I've shifted the ordering a bit.
Probably we'll need a full rework akin to danvet's
recent intel patchs. This patch fixes numerous
issues with DP bridge chips and makes link training
much more reliable.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit df6a5ea44759e88b7c025704cd9cb6a6e64188a4
Author: Ben Skeggs
Date: Mon Aug 27 16:22:49 2012 +1000
drm/nvc0/copy: check PUNITS to determine which copy engines are disabled
commit 14f0458a41e033dee31ba605137419385c03fc78 upstream.
On some Fermi chipsets (NVCE particularly) PCOPY1 doesn't exist. And if
what I've seen on Kepler is true of Fermi too, chipsets of the same type
can have different PCOPY units available.
This should fix a v3.5 regression reported by a number of people effecting
suspend/resume on NVC8/NVCE chipsets.
Signed-off-by: Ben Skeggs
Signed-off-by: Greg Kroah-Hartman
commit 01949a3b2bdbccdeee3e35f047c15eac76e2c940
Author: Jakob Bornecrantz
Date: Thu Aug 16 08:29:03 2012 +0000
drm: Check for invalid cursor flags
commit 7c4eaca4162d0b5ad4fb39f974d7ffd71b9daa09 upstream.
Signed-off-by: Jakob Bornecrantz
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 985e9e0c17ed6aabccc895a68b6202e763746367
Author: AceLan Kao
Date: Wed Jul 4 15:20:14 2012 +0800
asus-nb-wmi: add some video toggle keys
commit 3766054fff4af1b58a1440a284907887f4d2e8be upstream.
There are some new video switch keys that used by newer machines.
0xA0 - SDSP HDMI only
0xA1 - SDSP LCD + HDMI
0xA2 - SDSP CRT + HDMI
0xA3 - SDSP TV + HDMI
But in Linux, there is no suitable userspace application to handle this,
so, mapping them all to KEY\_SWITCHVIDEOMODE.
Signed-off-by: AceLan Kao
Signed-off-by: Matthew Garrett
Cc: Tim Gardner
Signed-off-by: Greg Kroah-Hartman
commit 345f1f9cea2fda5e2444fdcbc620487fca7033df
Author: Paul Menzel
Date: Wed Aug 8 23:12:19 2012 +0200
drm: Add EDID\_QUIRK\_FORCE\_REDUCED\_BLANKING for ASUS VW222S
commit 6f33814bd4d9cfe76033a31b1c0c76c960cd8e4b upstream.
Connecting an ASUS VW222S [1] over VGA a garbled screen is shown with
vertical stripes in the top half.
In commit bc42aabc [2]
commit bc42aabc6a01b92b0f961d65671564e0e1cd7592
Author: Adam Jackson
Date: Wed May 23 16:26:54 2012 -0400
drm/edid/quirks: ViewSonic VA2026w
Adam Jackson added the quirk `EDID\_QUIRK\_FORCE\_REDUCED\_BLANKING` which
is also needed for this ASUS monitor.
All log files and output from `xrandr` is included in the referenced
Bugzilla report #17629.
Please note that this monitor only has a VGA (D-Sub) connector [1].
[1] http://www.asus.com/Display/LCD\_Monitors/VW222S/
[2] http://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git;a=commit;h=bc42aabc6a01b92b0f961d65671564e0e1cd7592
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=17629
Signed-off-by: Paul Menzel
Cc:
Cc: Adam Jackson
Cc: Ian Pilcher
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit c5fc64113b5ecc359fe1a005e7c531d25733e7f5
Author: Corentin Chary
Date: Mon Aug 20 23:01:51 2012 +0200
asus-laptop: HRWS/HWRS typo
commit 8871e99f89b7d7b1ea99de550eea2a56273f42ab upstream.
Resolves-bug: https://bugzilla.kernel.org/show\_bug.cgi?id=24222
Signed-off-by: Corentin Chary
Signed-off-by: Matthew Garrett
Signed-off-by: Greg Kroah-Hartman
commit 0d642614af34400285a252b1458f5d42b438185c
Author: Daniel Vetter
Date: Wed Aug 15 10:41:45 2012 +0200
drm/i915: use hsw rps tuning values everywhere on gen6+
commit 1ee9ae3244c4789f3184c5123f3b2d7e405b3f4c upstream.
James Bottomley reported [1] a massive power regression, due to the
enabling of semaphores by default in 3.5. A workaround for him is to
again disable semaphores. And indeed, his system has a very hard time
to enter rc6 with semaphores enabled.
Ben Widawsky run around with a kill-a-watt a lot and noticed:
- There are indeed a few rare systems that seem to have a hard time
entering rc6 when desktop-idle.
- One machine, The Indestructible Toshiba regressed in this behaviour
between 3.5 and 3.6 in a merge commit! So rc6 behaviour with the
current setting seems to be highly timing dependent and not robust
at all.
- The behaviour James reported wrt semaphores seems to be a freak
timing thing that only happens on his specific machine, confirming
that enabling semaphores shouldn't reduce rc6 residency.
Now furthermore the Google ChromeOS guys reported [2] a while ago that
at least on some machines a simply a blinking cursor can keep the gpu
turbo at the highest frequency. This is because the current rps limits
used on snb/ivb are highly asymmetric.
On the theory that gpu turbo and rc6 tuning values are related, we've
tried whether the much saner looking (since much less asymmetric) rps
tuning values used for hsw would also help entering rc6 more robustly.
And it seems to mostly work, and we don't really have the resources to
through-roughly tune things in any better way: The values from the
ChromeOS ppl seem to fare a bit worse for James' machine, so I guess
we better stick with something vpg (the gpu hw/windows group)
provided, hoping that they've done their jobs.
Reference[1]: http://lists.freedesktop.org/archives/dri-devel/2012-July/025675.html
Reference[2]: http://lists.freedesktop.org/archives/intel-gfx/2012-July/018692.html
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=53393
Tested-by: Ben Widawsky
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit efb269742ee6b7a7f929054fde8bfaa4ccb3f0de
Author: Jani Nikula
Date: Mon Aug 13 13:22:35 2012 +0300
drm/i915: fall back to bit-banging if GMBUS fails in CRT EDID reads
commit f1a2f5b7c5f0941d23eef0a095c0b99bf8d051e6 upstream.
GMBUS was enabled over bit-banging as the default in commits:
commit c3dfefa0a6d235bd465309e12f4c56ea16e71111
Author: Daniel Vetter
Date: Tue Feb 14 22:37:25 2012 +0100
drm/i915: reenable gmbus on gen3+ again
and
commit 0fb3f969c8683505fb7323c06bf8a999a5a45a15
Author: Daniel Vetter
Date: Fri Mar 2 19:38:30 2012 +0100
drm/i915: enable gmbus on gen2
Unfortunately, GMBUS seems to fail on some CRT displays. Add a bit-banging
fallback to CRT EDID reads.
LKML-Reference: <201207251020.47637.maciej.rutecki@gmail.com>
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=45881
Signed-off-by: Jani Nikula
Tested-by: Alex Ferrando
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit d3e3373115a6472419fb84663e99ce52f8e77cfa
Author: Jani Nikula
Date: Mon Aug 13 13:22:34 2012 +0300
drm/i915: extract connector update from intel\_ddc\_get\_modes() for reuse
commit 4eab81366465aedcfd26de960c595bc03599c09f upstream.
Refactor the connector update part of intel\_ddc\_get\_modes() into a separate
intel\_connector\_update\_modes() function for reuse. No functional changes.
Signed-off-by: Jani Nikula
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=45881
Tested-by: Alex Ferrando
Signed-off-by: Daniel Vetter
Signed-off-by: Greg Kroah-Hartman
commit 38eda0433d5af9bb2655e7a4ca3c9bc9c0515112
Author: Christian König
Date: Mon Aug 20 15:38:47 2012 +0200
drm/radeon: init lockup timeout on ring init
commit 48c0ac9911839daf188e4a0b6b132ac31050a241 upstream.
Reset the lockup timeout on ring (re-)initialisation.
Otherwise we get error messages like this on gpu resets:
[ 1559.949177] radeon 0000:01:00.0: GPU lockup CP stall for more than 1482270msec
Signed-off-by: Christian König
Reviewed-by: Michel Dänzer
Signed-off-by: Greg Kroah-Hartman
commit bfbccc4db370e1225644973b470a85f497d8bee3
Author: Tvrtko Ursulin
Date: Mon Aug 20 15:16:04 2012 +0100
drm/radeon/kms: extend the Fujitsu D3003-S2 board connector quirk to cover later silicon stepping
commit 52e9b39d9a89ae33662596bd30e62dd56bddbe73 upstream.
There is a more recent APU stepping with a new PCI ID
shipping in the same board by Fujitsu which needs the
same quirk to correctly mark the back plane connectors.
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 01edc881f64ff092978f333a5328e18a988f180b
Author: David Lamparter
Date: Thu Aug 16 15:45:20 2012 -0400
drm/radeon: implement ACPI VFCT vbios fetch (v3)
commit 268ba0a99f89a84dc5eb312470896113d0709c74 upstream.
This is required for pure UEFI systems. The vbios is stored
in ACPI rather than at the legacy vga location.
Fixes:
https://bugs.freedesktop.org/show\_bug.cgi?id=26891
V2: fix #ifdefs as per Greg's comments
V3: fix it harder
Signed-off-by: Alex Deucher
Reviewed-by: Jerome Glisse
Signed-off-by: Greg Kroah-Hartman
commit 5f54f145719f453dccc73304cd427096bf7b806c
Author: Alex Deucher
Date: Thu Aug 16 15:39:09 2012 -0400
drm/radeon: split ATRM support out from the ATPX handler (v3)
commit c61e2775873f603148e8e998a938721b7d222d24 upstream.
There are systems that use ATRM, but not ATPX.
Fixes:
https://bugs.freedesktop.org/show\_bug.cgi?id=41265
V2: fix #ifdefs as per Greg's comments
V3: fix it harder
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 209568409a933a4041d0fd47992c10e53473fb0e
Author: Jerome Glisse
Date: Mon Aug 6 12:32:21 2012 -0400
drm/radeon: fence virtual address and free it once idle v4
commit e43b5ec05afdc232be25aa481315035c1888d389 upstream.
Virtual address need to be fenced to know when we can safely remove it.
This patch also properly clear the pagetable. Previously it was
serouisly broken.
Kernel 3.5/3.4 need a similar patch but adapted for difference in mutex locking.
v2: For to update pagetable when unbinding bo (don't bailout if
bo\_va->valid is true).
v3: Add kernel 3.5/3.4 comment.
v4: Fix compilation warnings.
Signed-off-by: Jerome Glisse
Reviewed-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 02472191d07a0af5cad86c9f9ea406c8c2918395
Author: Alex Deucher
Date: Tue Aug 21 18:52:56 2012 -0400
drm/radeon/ss: use num\_crtc rather than hardcoded 6
commit 5317670692f61675394db2eb6713484b67383750 upstream.
When checking if a pll is in use.
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit b8a7171e7540553e48707f5d1a98cf824a66bcce
Author: Jerome Glisse
Date: Fri Aug 17 14:40:04 2012 -0400
drm/radeon: avoid turning off spread spectrum for used pll
commit 5efcc76c13a745f98e7b6604d6aca49761be1970 upstream.
If spread spectrum is enabled and in use for a given pll we
should not turn it off as it will lead to turning off display
for crtc that use the pll (this behavior was observed on chelsea
edp).
Signed-off-by: Jerome Glisse
Reviewed-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 7e9b8a5333503decc32e04c910068eca4e4ec6c2
Author: Dave Airlie
Date: Tue Aug 21 16:29:47 2012 +1000
fbcon: fix race condition between console lock and cursor timer (v1.1)
commit d8636a2717bb3da2a7ce2154bf08de90bb8c87b0 upstream.
So we've had a fair few reports of fbcon handover breakage between
efi/vesafb and i915 surface recently, so I dedicated a couple of
days to finding the problem.
Essentially the last thing we saw was the conflicting framebuffer
message and that was all.
So after much tracing with direct netconsole writes (printks
under console\_lock not so useful), I think I found the race.
Thread A (driver load) Thread B (timer thread)
unbind\_con\_driver -> |
bind\_con\_driver -> |
vc->vc\_sw->con\_deinit -> |
fbcon\_deinit -> |
console\_lock() |
| |
| fbcon\_flashcursor timer fires
| console\_lock() <- blocked for A
|
|
fbcon\_del\_cursor\_timer ->
del\_timer\_sync
(BOOM)
Of course because all of this is under the console lock,
we never see anything, also since we also just unbound the active
console guess what we never see anything.
Hopefully this fixes the problem for anyone seeing vesafb->kms
driver handoff.
v1.1: add comment suggestion from Alan.
Signed-off-by: Dave Airlie
Acked-by: Alan Cox
Tested-by: Josh Boyer
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0d9ed3f9251d5222d6abf0f938207fb8f02659d6
Author: Robin Holt
Date: Tue Aug 21 16:16:02 2012 -0700
drivers/misc/sgi-xp/xpc\_uv.c: SGI XPC fails to load when cpu 0 is out of IRQ resources
commit 7838f994b4fceff24c343f4e26a6cf4393869579 upstream.
On many of our larger systems, CPU 0 has had all of its IRQ resources
consumed before XPC loads. Worst cases on machines with multiple 10
GigE cards and multiple IB cards have depleted the entire first socket
of IRQs.
This patch makes selecting the node upon which IRQs are allocated (as
well as all the other GRU Message Queue structures) specifiable as a
module load param and has a default behavior of searching all nodes/cpus
for an available resources.
[akpm@linux-foundation.org: fix build: include cpu.h and module.h]
Signed-off-by: Robin Holt
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 70581c172679ca0a29da01c6bb40577c804476da
Author: Rafael J. Wysocki
Date: Wed Aug 15 21:32:04 2012 +0200
PM / Runtime: Check device PM QoS setting before "no callbacks" check
commit 55d7ec4520e86d735d178c15d7df33d507bd43c6 upstream.
If \_\_dev\_pm\_qos\_read\_value(dev) returns a negative value,
rpm\_suspend() should return -EPERM for dev even if its
power.no\_callbacks flag is set. For this to happen, the device's
power.no\_callbacks flag has to be checked after the PM QoS check,
so move the PM QoS check to rpm\_check\_suspend\_allowed() (this will
make it cover idle notifications as well as runtime suspend too).
Signed-off-by: Rafael J. Wysocki
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 7bdf66e37d4350195de86c8e44540627550a00d9
Author: Rafael J. Wysocki
Date: Wed Aug 15 21:31:55 2012 +0200
PM / Runtime: Clear power.deferred\_resume on success in rpm\_suspend()
commit 58a34de7b1a920d287d17d2ca08bc9aaf7e6d35b upstream.
The power.deferred\_resume can only be set if the runtime PM status
of device is RPM\_SUSPENDING and it should be cleared after its
status has been changed, regardless of whether or not the runtime
suspend has been successful. However, it only is cleared on
suspend failure, while it may remain set on successful suspend and
is happily leaked to rpm\_resume() executed in that case.
That shouldn't happen, so if power.deferred\_resume is set in
rpm\_suspend() after the status has been changed to RPM\_SUSPENDED,
clear it before calling rpm\_resume(). Then, it doesn't need to be
cleared before changing the status to RPM\_SUSPENDING any more,
because it's always cleared after the status has been changed to
either RPM\_SUSPENDED (on success) or RPM\_ACTIVE (on failure).
Signed-off-by: Rafael J. Wysocki
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 30c575314dda6c51307ee06df67ae2fc44794d11
Author: Rafael J. Wysocki
Date: Wed Aug 15 21:31:45 2012 +0200
PM / Runtime: Fix rpm\_resume() return value for power.no\_callbacks set
commit 7f321c26c04807834fef4c524d2b21573423fc74 upstream.
For devices whose power.no\_callbacks flag is set, rpm\_resume()
should return 1 if the device's parent is already active, so that
the callers of pm\_runtime\_get() don't think that they have to wait
for the device to resume (asynchronously) in that case (the core
won't queue up an asynchronous resume in that case, so there's
nothing to wait for anyway).
Modify the code accordingly (and make sure that an idle notification
will be queued up on success, even if 1 is to be returned).
Signed-off-by: Rafael J. Wysocki
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 342c666ccbce089f1c34fc7bcbf35df834af2cf0
Author: Atsushi Nemoto
Date: Tue Aug 21 16:16:10 2012 -0700
drivers/rtc/rtc-rs5c348.c: fix hour decoding in 12-hour mode
commit 7dbfb315b2aaef0a115765946bf3026d074c33a7 upstream.
Correct the offset by subtracting 20 from tm\_hour before taking the
modulo 12.
[ "Why 20?" I hear you ask. Or at least I did.
Here's the reason why: RS5C348\_BIT\_PM is 32, and is - stupidly -
included in the RS5C348\_HOURS\_MASK define. So it's really subtracting
out that bit to get "hour+12". But then because it does things modulo
12, it needs to add the 12 in again afterwards anyway.
This code is confused. It would be much clearer if RS5C348\_HOURS\_MASK
just didn't include the RS5C348\_BIT\_PM bit at all, then it wouldn't
need to do the silly subtract either.
Whatever. It's all just math, the end result is the same. - Linus ]
Reported-by: James Nute
Tested-by: James Nute
Signed-off-by: Atsushi Nemoto
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4a74b60aa6551430ed6e700568199f50eca67028
Author: Suresh Siddha
Date: Tue Jul 31 10:29:14 2012 -0700
x86, avx: don't use avx instructions with "noxsave" boot param
commit c6fd893da927c6cefb2ece22402765379921a834 upstream.
Clear AVX, AVX2 features along with clearing XSAVE feature bits,
as part of the parsing "noxsave" parameter.
Fixes the kernel boot panic with "noxsave" boot parameter.
We could have checked cpu\_has\_osxsave along with cpu\_has\_avx etc, but Peter
mentioned clearing the feature bits will be better for uses like
static\_cpu\_has() etc.
Signed-off-by: Suresh Siddha
Link: http://lkml.kernel.org/r/1343755754.2041.2.camel@sbsiddha-desk.sc.intel.com
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 9ad3eca2bd7f1a10d59816ae8262877d265d0f6f
Author: Will Deacon
Date: Fri Aug 10 15:22:09 2012 +0100
mutex: Place lock in contended state after fastpath\_lock failure
commit 0bce9c46bf3b15f485d82d7e81dabed6ebcc24b1 upstream.
ARM recently moved to asm-generic/mutex-xchg.h for its mutex
implementation after the previous implementation was found to be missing
some crucial memory barriers. However, this has revealed some problems
running hackbench on SMP platforms due to the way in which the
MUTEX\_SPIN\_ON\_OWNER code operates.
The symptoms are that a bunch of hackbench tasks are left waiting on an
unlocked mutex and therefore never get woken up to claim it. This boils
down to the following sequence of events:
Task A Task B Task C Lock value
0 1
1 lock() 0
2 lock() 0
3 spin(A) 0
4 unlock() 1
5 lock() 0
6 cmpxchg(1,0) 0
7 contended() -1
8 lock() 0
9 spin(C) 0
10 unlock() 1
11 cmpxchg(1,0) 0
12 unlock() 1
At this point, the lock is unlocked, but Task B is in an uninterruptible
sleep with nobody to wake it up.
This patch fixes the problem by ensuring we put the lock into the
contended state if we fail to acquire it on the fastpath, ensuring that
any blocked waiters are woken up when the mutex is released.
Signed-off-by: Will Deacon
Cc: Arnd Bergmann
Cc: Chris Mason
Cc: Ingo Molnar
Reviewed-by: Nicolas Pitre
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/n/tip-6e9lrw2avczr0617fzl5vqb8@git.kernel.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 19aaa209bfd9f6afbad8605e891f1aaf727c31ca
Author: Dirk Behme
Date: Fri Aug 31 10:02:47 2012 +0200
tty: serial: imx: don't reinit clock in imx\_setup\_ufcr()
commit 7be0670f7b9198382938a03ff3db7f47ef6b4780 upstream.
Remove the clock configuration from imx\_setup\_ufcr(). This
isn't needed here and will cause garbage output if done.
To be be sure that we only touch the bits we want (TXTL and RXTL)
we have to mask out all other bits of the UFCR register. Add
one non-existing bit macro for this, too (bit 6, DCEDTE on i.MX6).
Signed-off-by: Dirk Behme
CC: Shawn Guo
CC: Sascha Hauer
CC: Troy Kisky
CC: Xinyu Chen
Acked-by: Shawn Guo
Signed-off-by: Greg Kroah-Hartman
commit 34d4dda865d8174f4a437f313c457c42a8fa9535
Author: Xinyu Chen
Date: Mon Aug 27 09:36:51 2012 +0200
tty: serial: imx: console write routing is unsafe on SMP
commit 9ec1882df244c4ee1baa692676fef5e8b0f5487d upstream.
The console feature's write routing is unsafe on SMP with
the startup/shutdown call.
There could be several consumers of the console
\* the kernel printk
\* the init process using /dev/kmsg to call printk to show log
\* shell, which open /dev/console and write with sys\_write()
The shell goes into the normal uart open/write routing,
but the other two go into the console operations.
The open routing calls imx serial startup, which will write USR1/2
register without any lock and critical with imx\_console\_write call.
Add a spin\_lock for startup/shutdown/console\_write routing.
This patch is a port from Freescale's Android kernel.
Signed-off-by: Xinyu Chen
Tested-by: Dirk Behme
CC: Sascha Hauer
Acked-by: Shawn Guo
Signed-off-by: Greg Kroah-Hartman
commit 5871ff53f3cd0968ef2fa86e43cea64f65ebca81
Author: Moiz Sonasath
Date: Wed Sep 5 08:34:26 2012 +0300
usb: host: xhci: fix compilation error for non-PCI based stacks
commit 296365781903226a3fb8758901eaeec09d2798e4 upstream.
For non PCI-based stacks, this function call
usb\_disable\_xhci\_ports(to\_pci\_dev(hcd->self.controller));
made from xhci\_shutdown is not applicable.
Ideally, we wouldn't have any PCI-specific code on
a generic driver such as the xHCI stack, but it looks
like we should just stub usb\_disable\_xhci\_ports() out
for non-PCI devices.
[ balbi@ti.com: slight improvement to commit log ]
This patch should be backported to kernels as old as 3.0, since the
commit it fixes (e95829f474f0db3a4d940cae1423783edd966027 "xhci: Switch
PPT ports to EHCI on shutdown.") was marked for stable.
Signed-off-by: Moiz Sonasath
Signed-off-by: Ruchika Kharwar
Signed-off-by: Felipe Balbi
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit dc89785d7528f237b0db9272696a7ef48af35026
Author: Manoj Iyer
Date: Wed Aug 22 11:53:18 2012 -0500
xhci: Recognize USB 3.0 devices as superspeed at powerup
commit 29d214576f936db627ff62afb9ef438eea18bcd2 upstream.
On Intel Panther Point chipset USB 3.0 devices show up as
high-speed devices on powerup, but after an s3 cycle they are
correctly recognized as SuperSpeed. At powerup switch the port
to xHCI so that USB 3.0 devices are correctly recognized.
BugLink: http://bugs.launchpad.net/bugs/1000424
This patch should be backported to kernels as old as 3.0, that contain
commit ID 69e848c2090aebba5698a1620604c7dccb448684 "Intel xhci: Support
EHCI/xHCI port switching."
Signed-off-by: Manoj Iyer
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 81b16bdce56ffb9db6027acb6b54df6c397da465
Author: Matthew Garrett
Date: Tue Aug 14 16:44:49 2012 -0400
xhci: Make handover code more robust
commit e955a1cd086de4d165ae0f4c7be7289d84b63bdc upstream.
My test platform (Intel DX79SI) boots reliably under BIOS, but frequently
crashes when booting via UEFI. I finally tracked this down to the xhci
handoff code. It seems that reads from the device occasionally just return
0xff, resulting in xhci\_find\_next\_cap\_offset generating a value that's
larger than the resource region. We then oops when attempting to read the
value. Sanity checking that value lets us avoid the crash.
I've no idea what's causing the underlying problem, and xhci still doesn't
actually \*work\* even with this, but the machine at least boots which will
probably make further debugging easier.
This should be backported to kernels as old as 2.6.31, that contain the
commit 66d4eadd8d067269ea8fead1a50fe87c2979a80d "USB: xhci: BIOS handoff
and HW initialization."
Signed-off-by: Matthew Garrett
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit c6f58d9e9d68b8b622073ad5ee1a80f0f02a0316
Author: Dan Carpenter
Date: Mon Aug 13 19:57:03 2012 +0300
xhci: Fix a logical vs bitwise AND bug
commit 052c7f9ffb0e95843e75448d02664459253f9ff8 upstream.
The intent was to test whether the flag was set.
This patch should be backported to stable kernels as old as 3.0, since
it fixes a bug in commit e95829f474f0db3a4d940cae1423783edd966027 "xhci:
Switch PPT ports to EHCI on shutdown.", which was marked for stable.
Signed-off-by: Dan Carpenter
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 5ebe93346ca0356975854c33d50cc8c0266c7537
Author: Ruchika Kharwar
Date: Fri Aug 10 09:58:30 2012 +0300
usb: host: xhci-plat: use ioremap\_nocache
commit 319acdfc064169023cd9ada5085b434fbcdacec2 upstream.
Use the ioremap\_nocache variant of the ioremap API in
order to make sure our memory will be marked uncachable.
This patch should be backported to kernels as old as 3.4, that contain
the commit 3429e91a661e1f383aecc86c6bbcf65afb15c892 "usb: host: xhci:
add platform driver support".
Signed-off-by: Ruchika Kharwar
Signed-off-by: Felipe Balbi
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 5d4a9f02165d6495dd02659ef506d48ff9a49a08
Author: Keng-Yu Lin
Date: Fri Aug 10 01:39:23 2012 +0800
Intel xhci: Only switch the switchable ports
commit a96874a2a92feaef607ddd3137277a788cb927a6 upstream.
With a previous patch to enable the EHCI/XHCI port switching, it switches
all the available ports.
The assumption is not correct because the BIOS may expect some ports
not switchable by the OS.
There are two more registers that contains the information of the switchable
and non-switchable ports.
This patch adds the checking code for the two register so that only the
switchable ports are altered.
This patch should be backported to kernels as old as 3.0, that contain
commit ID 69e848c2090aebba5698a1620604c7dccb448684 "Intel xhci: Support
EHCI/xHCI port switching."
Signed-off-by: Keng-Yu Lin
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit fa97b7e16f405a544972386709a1d2bf60b8b832
Author: Alexis R. Cortes
Date: Fri Aug 3 14:00:27 2012 -0500
usb: host: xhci: Fix Compliance Mode on SN65LVPE502CP Hardware
commit 71c731a296f1b08a3724bd1b514b64f1bda87a23 upstream.
This patch is intended to work around a known issue on the
SN65LVPE502CP USB3.0 re-driver that can delay the negotiation
between a device and the host past the usual handshake timeout.
If that happens on the first insertion, the host controller
port will enter in Compliance Mode and NO port status event will
be generated (as per xHCI Spec) making impossible to detect this
event by software. The port will remain in compliance mode until
a warm reset is applied to it.
As a result of this, the port will seem "dead" to the user and no
device connections or disconnections will be detected.
For solving this, the patch creates a timer which polls every 2
seconds the link state of each host controller's port (this
by reading the PORTSC register) and recovers the port by issuing a
Warm reset every time Compliance mode is detected.
If a xHC USB3.0 port has previously entered to U0, the compliance
mode issue will NOT occur only until system resumes from
sleep/hibernate, therefore, the compliance mode timer is stopped
when all xHC USB 3.0 ports have entered U0. The timer is initialized
again after each system resume.
Since the issue is being caused by a piece of hardware, the timer
will be enabled ONLY on those systems that have the SN65LVPE502CP
installed (this patch uses DMI strings for detecting those systems)
therefore making this patch to act as a quirk (XHCI\_COMP\_MODE\_QUIRK
has been added to the xhci stack).
This patch applies for these systems:
Vendor: Hewlett-Packard. System Models: Z420, Z620 and Z820.
This patch should be backported to kernels as old as 3.2, as that was
the first kernel to support warm reset. The kernels will need to
contain both commit 10d674a82e553cb8a1f41027bb3c3e309b3f6804 "USB: When
hot reset for USB3 fails, try warm reset" and commit
8bea2bd37df08aaa599aa361a9f8b836ba98e554 "usb: Add support for root hub
port status CAS". The first patch add warm reset support, and the
second patch modifies the USB core to issue a warm reset when the port
is in compliance mode.
Signed-off-by: Alexis R. Cortes
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 3463944f5e02edcf804f2838e4b9f149c4f3d342
Author: Sergei Poselenov
Date: Sun Sep 2 13:14:32 2012 +0400
rt2800usb: Added rx packet length validity check
commit efd5d6b03bd9c9e0df646c56fb5f4f3e25e5c1ac upstream.
On our system (ARM Cortex-M3 SOC running linux-2.6.33)
frequent crashes were observed in the rt2800usb module
because of the invalid length of the received packet (3392,
46920...). This patch adds the sanity check on the packet
legth. Also, changed WARNING to ERROR in rt2x00lib\_rxdone()
so that the bad packet condition would be noticed.
The fix was tested on the latest compat-wireless-3.5.1-1-snpc.
Signed-off-by: Sergei Poselenov
Acked-by: Ivo van Doorn
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 00f008d4f31bf349279c52efb109bc62d1c93acc
Author: Alan Stern
Date: Tue Sep 4 10:41:02 2012 -0400
USB: add device quirk for Joss Optical touchboard
commit 92fc7a8b0f20bdb243c706daf42658e8e0cd2ef0 upstream.
This patch (as1604) adds a CONFIG\_INTF\_STRINGS quirk for the Joss
infrared touchboard device. The device doesn't like to be asked for
its interface strings.
Signed-off-by: Alan Stern
Reported-by: adam ?
Signed-off-by: Greg Kroah-Hartman
commit 994f290171f0018246612b9cfd890a184d7dd7a6
Author: Nicolas Ferre
Date: Wed Aug 29 11:49:18 2012 +0200
USB: ohci-at91: fix PIO handling in relation with number of ports
commit 6fffb77c8393151b0cf8cef1b9c2ba90587dd2e8 upstream.
If the number of ports present on the SoC/board is not the maximum
and that the platform data is not filled with all data, there is
an easy way to mess the PIO setup for this interface.
This quick fix addresses mis-configuration in USB host platform data
that is common in at91 boards since commit 0ee6d1e (USB: ohci-at91:
change maximum number of ports) that did not modified the associatd
board files.
Reported-by: Klaus Falkner
Signed-off-by: Nicolas Ferre
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 3185f2bc212f82e8237f613adb9469359e413233
Author: Bjørn Mork
Date: Mon Sep 10 22:17:34 2012 +0200
USB: cdc-wdm: fix wdm\_find\_device\* return value
commit 6a44886899ef8cc396e230e492e6a56a883889f3 upstream.
A logic error made the wdm\_find\_device\* functions
return a bogus pointer into static data instead of
the intended NULL no matching device was found.
Signed-off-by: Bjørn Mork
Cc: Oliver Neukum
Signed-off-by: Greg Kroah-Hartman
commit 1e210fa515c902c869bcd27679ae305b468a73f5
Author: Kishon Vijay Abraham I
Date: Tue Aug 21 14:56:16 2012 +0530
usb: dwc3: core: fix incorrect usage of resource pointer
commit 066618bc350cc6035c3a0fc559a8ac02f55785a9 upstream.
Populate the resources for xhci afresh instead of directly using the
\*struct resource\* of core. \*resource\* structure has parent, sibling,
child pointers which should be filled only by resource API's. By
directly using the \*resource\* pointer of core in xhci, these parent,
sibling, child pointers are already populated even before
\*platform\_device\_add\* causing side effects.
Reported-by: Ruchika Kharwar
Tested-by: Moiz Sonasath
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 543ab2172cd454c46231762331abd24a90a272b0
Author: Pratyush Anand
Date: Fri Aug 10 13:42:16 2012 +0530
usb: dwc3: ep0: correct cache sync issue in case of ep0\_bounced
commit 0416e494ce7dc84e2719bc9fb7daecb330476074 upstream.
In case of ep0 out, if length is not aligned to maxpacket size then we use
dwc->ep\_bounce\_addr for dma transfer and not request->dma. Since, we have
alreday done memcpy from dwc->ep0\_bounce to request->buf, so we do not need to
issue cache sync function. In fact, cache sync function will bring wrong data
in request->buf from request->dma in this scenario.
So, cache sync function must not be executed in case of ep0 bounced.
Signed-off-by: Pratyush Anand
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 08e95568e5ad2bf0b73d589ce0bd675438fd2842
Author: Michael Grzeschik
Date: Wed Sep 12 14:58:04 2012 +0300
usb: chipidea: udc: don't stall endpoint if request list is empty in isr\_tr\_complete\_low
commit db89960e50f45274c07dc60926b5a49489b8a7a0 upstream.
When attaching an imx28 or imx53 in USB gadget mode to a Windows host and
starting a rndis connection we see this message every 4-10 seconds:
g\_ether gadget: high speed config #2: RNDIS
Analysis shows that each time this message is printed, the rndis connection is
re-establish due to a reset because of a stalled endpoint (ep 0, dir 1). The
endpoint is stalled because the reqeust complete bit on that endpoint is set,
but in isr\_tr\_complete\_low() the endpoint request list (mEp->qh.queue) is
empty.
This patch removed this check, because the code doesn't take the following
situation into account:
The loop over all endpoints in isr\_tr\_complete\_handler() will call ep\_nuke() on
both ep0/dir0 and ep/dir1 in the first loop. Pending reqeusts will be flushed
and completed here. There seems to be a race condition, the request is nuked,
but the request complete bit will be set, too. The subsequent check (in
ep0/dir1's loop cycle) for endpoint request list (mEp->qh.queue) empty will
fail.
Both other mainline chipidea drivers (mv\_udc\_core.c and fsl\_udc\_core.c) don't
have this check.
Signed-off-by: Michael Grzeschik
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
commit 9a3855f7b0b7e47bb77db5f1e1000c68ae549cc6
Author: Michael Grzeschik
Date: Wed Sep 12 14:58:00 2012 +0300
usb: chipidea: udc: fix setup of endpoint maxpacket size
commit 7f67c38bdcb6d8bce02e10521fbf1618b586319f upstream.
This patch changes the setup of the endpoint maxpacket size. All non control
endpoints are initialized with an undefined ((unsigned short)~0) maxpacket
size. The maxpacket size of Endpoint 0 will be kept at CTRL\_PAYLOAD\_MAX.
Some gadget drivers check for the maxpacket size before they enable the
endpoint, which leads to a wrong state in these drivers.
Signed-off-by: Michael Grzeschik
Acked-by: Felipe Balbi
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
commit 2f83444297c8221497145cd26746099610a7d6f8
Author: Éric Piel
Date: Tue Sep 4 17:25:06 2012 +0200
USB: ftdi-sio: add support for more Physik Instrumente devices
commit dafc4f7be1a556ca3868d343c00127728b397068 upstream.
Commit b69cc672052540 added support for the E-861. After acquiring a C-867, I
realised that every Physik Instrumente's device has a different PID. They are
listed in the Windows device driver's .inf file. So here are all PIDs for the
current (and probably future) USB devices from Physik Instrumente.
Compiled, but only actually tested on the E-861 and C-867.
Signed-off-by: Éric Piel
Signed-off-by: Greg Kroah-Hartman
commit 5ab6aa6c9dacb16168b090899f4e140081280e96
Author: Bjørn Mork
Date: Mon Sep 10 12:01:05 2012 +0200
USB: ftdi\_sio: do not claim CDC ACM function
commit f08dea734844aa42ec57c229b0b73b3d7d21f810 upstream.
The Microchip vid:pid 04d8:000a is used for their CDC ACM
demo firmware application. This is a device with a single
function conforming to the CDC ACM specification and with
the intention of demonstrating CDC ACM class firmware and
driver interaction. The demo is used on a number of
development boards, and may also be used unmodified by
vendors using Microchip hardware.
Some vendors have re-used this vid:pid for other types of
firmware, emulating FTDI chips. Attempting to continue to
support such devices without breaking class based
applications that by matching on interface
class/subclass/proto being ff/ff/00. I have no information
about the actual device or interface descriptors, but this
will at least make the proper CDC ACM devices work again.
Anyone having details of the offending device's descriptors
should update this entry with the details.
Reported-by: Florian Wöhrl
Reported-by: Xiaofan Chen
Cc: Alan Cox
Cc: Bruno Thomsen
Signed-off-by: Bjørn Mork
Signed-off-by: Greg Kroah-Hartman
commit 142bfa4fc78d70ff5fc05bca734e230c334e6235
Author: Horst Schirmeier
Date: Fri Aug 31 00:00:28 2012 +0200
USB: ftdi\_sio: PID for NZR SEM 16+ USB
commit 26a538b9ea2a3ee10dafc0068f0560dfd7b7ba37 upstream.
This adds the USB PID for the NZR SEM 16+ USB energy monitor device
. It works perfectly with the GPL software on
.
Signed-off-by: Horst Schirmeier
Signed-off-by: Greg Kroah-Hartman
commit f49b5d4530ef3b1ccc34473ccdb84dd48be2aa0d
Author: Pavankumar Kondeti
Date: Fri Sep 7 11:23:28 2012 +0530
EHCI: Update qTD next pointer in QH overlay region during unlink
commit 3d037774b42ed677f699b1dce7d548d55f4e4c2b upstream.
There is a possibility of QH overlay region having reference to a stale
qTD pointer during unlink.
Consider an endpoint having two pending qTD before unlink process begins.
The endpoint's QH queue looks like this.
qTD1 --> qTD2 --> Dummy
To unlink qTD2, QH is removed from asynchronous list and Asynchronous
Advance Doorbell is programmed. The qTD1's next qTD pointer is set to
qTD2'2 next qTD pointer and qTD2 is retired upon controller's doorbell
interrupt. If QH's current qTD pointer points to qTD1, transfer overlay
region still have reference to qTD2. But qtD2 is just unlinked and freed.
This may cause EHCI system error. Fix this by updating qTD next pointer
in QH overlay region with the qTD next pointer of the current qTD.
Signed-off-by: Pavankumar Kondeti
Acked-by: Alan Stern
Signed-off-by: Greg Kroah-Hartman
commit 84efc564e8839d601c0656cab9c9fbe1c621ea7e
Author: Weston Andros Adamson
Date: Thu Sep 6 15:54:27 2012 -0400
NFS: return error from decode\_getfh in decode open
commit 01913b49cf1dc6409a07dd2a4cc6af2e77f3c410 upstream.
If decode\_getfh failed, nfs4\_xdr\_dec\_open would return 0 since the last
decode\_\* call must have succeeded.
Signed-off-by: Weston Andros Adamson
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 5b1b2f56616a89659cd132ef4e20267b45c6535a
Author: Trond Myklebust
Date: Tue Sep 4 11:05:07 2012 -0400
NFS: Fix a problem with the legacy binary mount code
commit 872ece86ea5c367aa92f44689c2d01a1c767aeb3 upstream.
Apparently, am-utils is still using the legacy binary mountdata interface,
and is having trouble parsing /proc/mounts due to the 'port=' field being
incorrectly set.
The following patch should fix up the regression.
Reported-by: Marius Tolzmann
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 7566f7007c8734ebcbb4cb125b159ca1b7563c74
Author: Trond Myklebust
Date: Mon Sep 3 14:56:02 2012 -0400
NFS: Fix the initialisation of the readdir 'cookieverf' array
commit c3f52af3e03013db5237e339c817beaae5ec9e3a upstream.
When the NFS\_COOKIEVERF helper macro was converted into a static
inline function in commit 99fadcd764 (nfs: convert NFS\_\*(inode)
helpers to static inline), we broke the initialisation of the
readdir cookies, since that depended on doing a memset with an
argument of 'sizeof(NFS\_COOKIEVERF(inode))' which therefore
changed from sizeof(be32 cookieverf[2]) to sizeof(be32 \*).
At this point, NFS\_COOKIEVERF seems to be more of an obfuscation
than a helper, so the best thing would be to just get rid of it.
Also see: https://bugzilla.kernel.org/show\_bug.cgi?id=46881
Reported-by: Andi Kleen
Reported-by: David Binderman
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 3d8c4fe7165af0406de34cc835993f06f5ae7268
Author: Gertjan van Wingerde
Date: Fri Aug 31 19:22:11 2012 +0200
rt2x00: Fix rfkill polling prior to interface start.
commit a396e10019eaf3809b0219c966865aaafec12630 upstream.
We need to program the rfkill switch GPIO pin direction to input at
device initialization time, not only when the interface is brought up.
Doing this only when the interface is brought up could lead to rfkill
detecting the switch is turned on erroneously and inability to create
the interface and bringing it up.
Reported-and-tested-by: Andreas Messer
Signed-off-by: Gertjan van Wingerde
Acked-by: Ivo Van Doorn
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 1ef41fe91382703c960a6f906c72e0baeb8442bf
Author: Gertjan van Wingerde
Date: Fri Aug 31 19:22:10 2012 +0200
rt2x00: Fix word size of rt2500usb MAC\_CSR19 register.
commit 6ced58a5dbb94dbfbea1b33ca3c56d1e929cd548 upstream.
The register is 16 bits wide, not 32.
Signed-off-by: Gertjan van Wingerde
Acked-by: Ivo Van Doorn
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit a77399badc9091734c3d8ebdd2230d91e53e05ab
Author: Gertjan van Wingerde
Date: Fri Aug 31 19:22:09 2012 +0200
rt2x00: Identify ASUS USB-N53 device.
commit 177ef8360fabdc49ff08d2598c06e7f7a36b53e3 upstream.
This is an RT3572 based device.
Signed-off-by: Maximilian Engelhardt
Signed-off-by: Gertjan van Wingerde
Acked-by: Ivo Van Doorn
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit feec4959301512e10e4291c2cfbe4a26c399828e
Author: Nicolas Ferre
Date: Tue Sep 11 17:21:45 2012 +0200
dmaengine: at\_hdmac: check that each sg data length is non-null
commit c456797681db814f4f5b36909e8e94047bf53d9c upstream.
Avoid the construction of a malformed DMA request sent to
the DMA controller.
Log message is for debug only because this condition is unlikely to
append and may only trigger at driver development time.
Signed-off-by: Nicolas Ferre
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit f102108bd4b5bb05dbfe39ea5af709d4aa537368
Author: Nicolas Ferre
Date: Tue Sep 11 17:21:44 2012 +0200
dmaengine: at\_hdmac: fix comment in atc\_prep\_slave\_sg()
commit c618a9be0e8c0f36baee2560860a0118a428fb26 upstream.
s/dma\_memcpy/slave\_sg/ and it is sg length that we are
talking about.
Signed-off-by: Nicolas Ferre
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 466307f8c4a8db558e743ea08696e1ef35c5bf52
Author: Sachin Kamat
Date: Mon Sep 17 15:20:23 2012 +0530
DMA: PL330: Check the pointer returned by kzalloc
commit 61c6e7531d3b66b33187b8cdd700fd8ab93ffd62 upstream.
kzalloc could return NULL. Hence add a check to avoid
NULL pointer dereference.
Signed-off-by: Sachin Kamat
Acked-by: Jassi Brar
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 91ca7fa056484366b1d6ccbe94c4526d0b4b0186
Author: Sachin Kamat
Date: Mon Sep 17 15:20:22 2012 +0530
DMA: PL330: Fix potential NULL pointer dereference in pl330\_submit\_req()
commit 2e2c682becb20416c140aa0d6d3137b51a5c76da upstream.
'r->cfg' is being checked for NULL. However, it is dereferenced
in the previous statements. Thus moving those statements within
the check.
Signed-off-by: Sachin Kamat
Acked-by: Jassi Brar
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 475d145745db51eea5d153307b2db7f8e6954ebb
Author: Luis R. Rodriguez
Date: Fri Sep 14 15:36:57 2012 -0700
cfg80211: fix possible circular lock on reg\_regdb\_search()
commit a85d0d7f3460b1a123b78e7f7e39bf72c37dfb78 upstream.
When call\_crda() is called we kick off a witch hunt search
for the same regulatory domain on our internal regulatory
database and that work gets kicked off on a workqueue, this
is done while the cfg80211\_mutex is held. If that workqueue
kicks off it will first lock reg\_regdb\_search\_mutex and
later cfg80211\_mutex but to ensure two CPUs will not contend
against cfg80211\_mutex the right thing to do is to have the
reg\_regdb\_search() wait until the cfg80211\_mutex is let go.
The lockdep report is pasted below.
cfg80211: Calling CRDA to update world regulatory domain
======================================================
[ INFO: possible circular locking dependency detected ]
3.3.8 #3 Tainted: G O
-------------------------------------------------------
kworker/0:1/235 is trying to acquire lock:
(cfg80211\_mutex){+.+...}, at: [<816468a4>] set\_regdom+0x78c/0x808 [cfg80211]
but task is already holding lock:
(reg\_regdb\_search\_mutex){+.+...}, at: [<81646828>] set\_regdom+0x710/0x808 [cfg80211]
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (reg\_regdb\_search\_mutex){+.+...}:
[<800a8384>] lock\_acquire+0x60/0x88
[<802950a8>] mutex\_lock\_nested+0x54/0x31c
[<81645778>] is\_world\_regdom+0x9f8/0xc74 [cfg80211]
-> #1 (reg\_mutex#2){+.+...}:
[<800a8384>] lock\_acquire+0x60/0x88
[<802950a8>] mutex\_lock\_nested+0x54/0x31c
[<8164539c>] is\_world\_regdom+0x61c/0xc74 [cfg80211]
-> #0 (cfg80211\_mutex){+.+...}:
[<800a77b8>] \_\_lock\_acquire+0x10d4/0x17bc
[<800a8384>] lock\_acquire+0x60/0x88
[<802950a8>] mutex\_lock\_nested+0x54/0x31c
[<816468a4>] set\_regdom+0x78c/0x808 [cfg80211]
other info that might help us debug this:
Chain exists of:
cfg80211\_mutex --> reg\_mutex#2 --> reg\_regdb\_search\_mutex
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(reg\_regdb\_search\_mutex);
lock(reg\_mutex#2);
lock(reg\_regdb\_search\_mutex);
lock(cfg80211\_mutex);
\*\*\* DEADLOCK \*\*\*
3 locks held by kworker/0:1/235:
#0: (events){.+.+..}, at: [<80089a00>] process\_one\_work+0x230/0x460
#1: (reg\_regdb\_work){+.+...}, at: [<80089a00>] process\_one\_work+0x230/0x460
#2: (reg\_regdb\_search\_mutex){+.+...}, at: [<81646828>] set\_regdom+0x710/0x808 [cfg80211]
stack backtrace:
Call Trace:
[<80290fd4>] dump\_stack+0x8/0x34
[<80291bc4>] print\_circular\_bug+0x2ac/0x2d8
[<800a77b8>] \_\_lock\_acquire+0x10d4/0x17bc
[<800a8384>] lock\_acquire+0x60/0x88
[<802950a8>] mutex\_lock\_nested+0x54/0x31c
[<816468a4>] set\_regdom+0x78c/0x808 [cfg80211]
Reported-by: Felix Fietkau
Tested-by: Felix Fietkau
Signed-off-by: Luis R. Rodriguez
Reviewed-by: Johannes Berg
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 8c1d6b74e6c442c47dbc1849da9587574cb10e6c
Author: Ira W. Snyder
Date: Tue Sep 11 15:58:15 2012 -0700
can: janz-ican3: fix support for older hardware revisions
commit e21093ef6fb4cbecdf926102286dbe280ae965db upstream.
The Revision 1.0 Janz CMOD-IO Carrier Board does not have support for
the reset registers. To support older hardware, the code is changed to
use the hardware reset register on the Janz VMOD-ICAN3 hardware itself.
Signed-off-by: Ira W. Snyder
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit af22fdf400b6d4e7721d01166b88996e456fd55f
Author: Marc Kleine-Budde
Date: Wed Sep 19 14:58:45 2012 +0200
can: ti\_hecc: fix oops during rmmod
commit ab04c8bd423edb03e2148350a091836c196107fc upstream.
This patch fixes an oops which occurs when unloading the driver, while the
network interface is still up. The problem is that first the io mapping is
teared own, then the CAN device is unregistered, resulting in accessing the
hardware's iomem:
[ 172.744232] Unable to handle kernel paging request at virtual address c88b0040
[ 172.752441] pgd = c7be4000
[ 172.755645] [c88b0040] \*pgd=87821811, \*pte=00000000, \*ppte=00000000
[ 172.762207] Internal error: Oops: 807 [#1] PREEMPT ARM
[ 172.767517] Modules linked in: ti\_hecc(-) can\_dev
[ 172.772430] CPU: 0 Not tainted (3.5.0alpha-00037-g3554cc0 #126)
[ 172.778961] PC is at ti\_hecc\_close+0xb0/0x100 [ti\_hecc]
[ 172.784423] LR is at \_\_dev\_close\_many+0x90/0xc0
[ 172.789123] pc : [] lr : [] psr: 60000013
[ 172.789123] sp : c5c1de68 ip : 00040081 fp : 00000000
[ 172.801025] r10: 00000001 r9 : c5c1c000 r8 : 00100100
[ 172.806457] r7 : c5d0a48c r6 : c5d0a400 r5 : 00000000 r4 : c5d0a000
[ 172.813232] r3 : c88b0000 r2 : 00000001 r1 : c5d0a000 r0 : c5d0a000
[ 172.820037] Flags: nZCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment user
[ 172.827423] Control: 10c5387d Table: 87be4019 DAC: 00000015
[ 172.833404] Process rmmod (pid: 600, stack limit = 0xc5c1c2f0)
[ 172.839447] Stack: (0xc5c1de68 to 0xc5c1e000)
[ 172.843994] de60: bf00c6b8 c5c1dec8 c5d0a000 c5d0a000 00200200 c033be58
[ 172.852478] de80: c5c1de44 c5c1dec8 c5c1dec8 c033bf2c c5c1de90 c5c1de90 c5d0a084 c5c1de44
[ 172.860992] dea0: c5c1dec8 c033c098 c061d3dc c5d0a000 00000000 c05edf28 c05edb34 c000d724
[ 172.869476] dec0: 00000000 c033c2f8 c5d0a084 c5d0a084 00000000 c033c370 00000000 c5d0a000
[ 172.877990] dee0: c05edb00 c033c3b8 c5d0a000 bf00d3ac c05edb00 bf00d7c8 bf00d7c8 c02842dc
[ 172.886474] df00: c02842c8 c0282f90 c5c1c000 c05edb00 bf00d7c8 c0283668 bf00d7c8 00000000
[ 172.894989] df20: c0611f98 befe2f80 c000d724 c0282d10 bf00d804 00000000 00000013 c0068a8c
[ 172.903472] df40: c5c538e8 685f6974 00636365 c61571a8 c5cb9980 c61571a8 c6158a20 c00c9bc4
[ 172.911987] df60: 00000000 00000000 c5cb9980 00000000 c5cb9980 00000000 c7823680 00000006
[ 172.920471] df80: bf00d804 00000880 c5c1df8c 00000000 000d4267 befe2f80 00000001 b6d90068
[ 172.928985] dfa0: 00000081 c000d5a0 befe2f80 00000001 befe2f80 00000880 b6d90008 00000008
[ 172.937469] dfc0: befe2f80 00000001 b6d90068 00000081 00000001 00000000 befe2eac 00000000
[ 172.945983] dfe0: 00000000 befe2b18 00023ba4 b6e6addc 60000010 befe2f80 a8e00190 86d2d344
[ 172.954498] [] (ti\_hecc\_close+0xb0/0x100 [ti\_hecc]) from [] (\_\_dev\_\_registered\_many+0xc0/0x2a0)
[ 172.984161] [] (rollback\_registered\_many+0xc0/0x2a0) from [] (rollback\_registered+0x20/0x30)
[ 172.994750] [] (rollback\_registered+0x20/0x30) from [] (unregister\_netdevice\_queue+0x68/0x98)
[ 173.005401] [] (unregister\_netdevice\_queue+0x68/0x98) from [] (unregister\_netdev+0x18/0x20)
[ 173.015899] [] (unregister\_netdev+0x18/0x20) from [] (ti\_hecc\_remove+0x60/0x80 [ti\_hecc])
[ 173.026245] [] (ti\_hecc\_remove+0x60/0x80 [ti\_hecc]) from [] (platform\_drv\_remove+0x14/0x18)
[ 173.036712] [] (platform\_drv\_remove+0x14/0x18) from [] (\_\_device\_release\_driver+0x7c/0xbc)
Tested-by: Jan Luebbe
Cc: Anant Gole
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 428230a6fdf3ffc710d055e1af112e719c735be3
Author: Søren Holm
Date: Mon Sep 17 21:50:57 2012 +0000
asix: Support DLink DUB-E100 H/W Ver C1
commit ed3770a9cd5764a575b83810ea679bbff2b03082 upstream.
Signed-off-by: Søren Holm
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit aa1915bfa2141edf04caf9d1cee48e46d93bae2b
Author: Larry Finger
Date: Tue Sep 11 11:11:13 2012 -0500
rtlwifi: rtl8192ce: Log message that B\_CUT device may not work
commit 022e1d0680c7b4366017393417b8758be5abcee8 upstream.
There are a number of problems that occur for the latest version
of the Realtek RTL8188CE device with the in-kernel driver. These
include selection of the wrong firmware, and system lockup. A full
fix is known, but is too invasive for inclusion in stable. This patch
fixes the problem with loading the wrong firmware, and logs a message
that the device may not work for kernels 3.6 and older.
Signed-off-by: Larry Finger
Cc: Anisse Astier
Cc: Li Chaoming
Tested-by: Anisse Astier
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit a7286d61084143f84267380bfb540c8ab9d4a2d7
Author: Robert Richter
Date: Wed Jul 25 19:12:45 2012 +0200
perf/x86/ibs: Check syscall attribute flags
commit bad9ac2d7f878a31cf1ae8c1ee3768077d222bcb upstream.
Current implementation simply ignores attribute flags. Thus, there is
no notification to userland of unsupported features. Check syscall's
attribute flags to let userland know if a feature is supported by the
kernel. This is also needed to distinguish between future kernels what
might support a feature.
Signed-off-by: Robert Richter
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/r/20120910093018.GO8285@erda.amd.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 78dc73459b6368ed7c2dedb7ea273f33d87fac2a
Author: Jovi Zhang
Date: Wed Aug 22 10:34:08 2012 +0800
MIPS: mm: Add compound tail page \_mapcount when mapped
commit af89fa3986b9d034a286544ab1ed95096496a2f9 upstream.
See commit b6999b191 which did the same modification for x86's mm/gup,
Quote from commit b6999b191:
"If compound pages are used and the page is a
tail page, gup\_huge\_pmd() increases \_mapcount to record tail page are
mapped while gup\_huge\_pud does not do that."
[ralf@linux-mips.org: fixed rejects caused by the original patch getting
linewrapped.]
Signed-off-by: Jovi Zhang
Cc: Youquan Song
Cc: Andi Kleen
Patchwork: https://patchwork.linux-mips.org/patch/4291/
Signed-off-by: Ralf Baechle
Signed-off-by: Greg Kroah-Hartman
commit 83d4a1078de4231ffbd4f0caddc3a5b404f49df6
Author: Anisse Astier
Date: Wed Sep 19 11:10:48 2012 -0700
Input: i8042 - disable mux on Toshiba C850D
commit 8669cf6793bb38307a30fb6b9565ddc8840ebd3f upstream.
On Toshiba Satellite C850D, the touchpad and the keyboard might randomly
not work at boot. Preventing MUX mode activation solves this issue.
Signed-off-by: Anisse Astier
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 18f48bf4f50fa66d5dfcb2d3a225a2648db9796c
Author: Wen Congyang
Date: Thu Sep 20 14:04:47 2012 +0800
tracing: Don't call page\_to\_pfn() if page is NULL
commit 85f2a2ef1d0ab99523e0b947a2b723f5650ed6aa upstream.
When allocating memory fails, page is NULL. page\_to\_pfn() will
cause the kernel panicked if we don't use sparsemem vmemmap.
Link: http://lkml.kernel.org/r/505AB1FF.8020104@cn.fujitsu.com
Acked-by: Mel Gorman
Cc: Frederic Weisbecker
Cc: Ingo Molnar
Cc: Andrew Morton
Reviewed-by: Minchan Kim
Signed-off-by: Wen Congyang
Signed-off-by: Steven Rostedt
Signed-off-by: Greg Kroah-Hartman
commit cfa259e003d1d7a3ecca5b30b7d1361838c7dbe3
Author: Matthew Leach
Date: Tue Sep 11 17:56:57 2012 +0100
ARM: 7532/1: decompressor: reset SCTLR.TRE for VMSA ARMv7 cores
commit e1e5b7e4251c7538ca08c2c5545b0c2fbd8a6635 upstream.
This patch zeroes the SCTLR.TRE bit prior to setting the mapping as
cacheable for ARMv7 cores in the decompressor, ensuring that the
memory region attributes are obtained from the C and B bits, not from
the page tables.
Cc: Nicolas Pitre
Reviewed-by: Will Deacon
Signed-off-by: Matthew Leach
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit dd2b53aed0496eca6f309ed39502a0dddf1a05ef
Author: Fabio Estevam
Date: Sun Sep 16 22:28:35 2012 -0300
ARM: imx: armadillo5x0: Fix illegal register access
commit 35495173e1df621dff0e9a244accbe32cd28a98f upstream.
Since commit eb92044eb (ARM i.MX3: Make ccm base address a variable )
it is necessary to pass the CCM register base as a variable.
Fix the CCM register access in mach-armadillo5x0 by passing mx3\_ccm\_base and
avoid illegal accesses.
Also applies to v3.5
Reported-by: Arnd Bergmann
Signed-off-by: Fabio Estevam
Acked-by: Arnd Bergmann
Signed-off-by: Sascha Hauer
Signed-off-by: Greg Kroah-Hartman
commit c13bdc66baf034b40cac9d7637dbff48783e012d
Author: Toshi Kani
Date: Mon Aug 27 12:52:24 2012 -0600
hpwdt: Fix kdump issue in hpwdt
commit 308b135e4fcc00c80c07e0e04e7afa8edf78583c upstream.
kdump can be interrupted by watchdog timer when the timer is left
activated on the crash kernel. Changed the hpwdt driver to disable
watchdog timer at boot-time. This assures that watchdog timer is
disabled until /dev/watchdog is opened, and prevents watchdog timer
to be left running on the crash kernel.
Signed-off-by: Toshi Kani
Tested-by: Lisa Mitchell
Signed-off-by: Thomas Mingarelli
Signed-off-by: Wim Van Sebroeck
Signed-off-by: Greg Kroah-Hartman
commit 8bf0fbfae17c8444de42b5de64bda9ac8dad0ad7
Author: Mark Salter
Date: Mon Sep 24 17:17:38 2012 -0700
c/r: prctl: fix build error for no-MMU case
commit be8cfc4af15cf611dfeb66a1fb5df43d5f1e280a upstream.
Commit 1ad75b9e1628 ("c/r: prctl: add minimal address test to
PR\_SET\_MM") added some address checking to prctl\_set\_mm() used by
checkpoint-restore. This causes a build error for no-MMU systems:
kernel/sys.c: In function 'prctl\_set\_mm':
kernel/sys.c:1868:34: error: 'mmap\_min\_addr' undeclared (first use in this function)
The test for mmap\_min\_addr doesn't make a lot of sense for no-MMU code
as noted in commit 6e1415467614 ("NOMMU: Optimise away the
{dac\_,}mmap\_min\_addr tests").
This patch defines mmap\_min\_addr as 0UL in the no-MMU case so that the
compiler will optimize away tests for "addr < mmap\_min\_addr".
Signed-off-by: Mark Salter
Reviewed-by: Cyrill Gorcunov
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 2f5c31b0f2b8c6bfb004e24aef80c1df75452001
Author: Andrzej Kaczmarek
Date: Wed Aug 29 10:02:09 2012 +0200
Bluetooth: mgmt: Fix enabling LE while powered off
commit 562fcc246ebe31ade6e1be08585673b9b2785498 upstream.
When new BT USB adapter is plugged in it's configured while still being powered
off (HCI\_AUTO\_OFF flag is set), thus Set LE will only set dev\_flags but won't
write changes to controller. As a result it's not possible to start device
discovery session on LE controller as it uses interleaved discovery which
requires LE Supported Host flag in extended features.
This patch ensures HCI Write LE Host Supported is sent when Set Powered is
called to power on controller and clear HCI\_AUTO\_OFF flag.
Signed-off-by: Andrzej Kaczmarek
Acked-by: Johan Hedberg
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit ca7efbe83d037083693cecb27ea275646340cefa
Author: Vinicius Costa Gomes
Date: Fri Sep 14 16:34:46 2012 -0300
Bluetooth: Fix not removing power\_off delayed work
commit 78c04c0bf52360dc2f7185e99c8e9aa05d73ae5a upstream.
For example, when a usb reset is received (I could reproduce it
running something very similar to this[1] in a loop) it could be
that the device is unregistered while the power\_off delayed work
is still scheduled to run.
Backtrace:
WARNING: at lib/debugobjects.c:261 debug\_print\_object+0x7c/0x8d()
Hardware name: To Be Filled By O.E.M.
ODEBUG: free active (active state 0) object type: timer\_list hint: delayed\_work\_timer\_fn+0x0/0x26
Modules linked in: nouveau mxm\_wmi btusb wmi bluetooth ttm coretemp drm\_kms\_helper
Pid: 2114, comm: usb-reset Not tainted 3.5.0bt-next #2
Call Trace:
[] ? free\_obj\_work+0x57/0x91
[] warn\_slowpath\_common+0x7e/0x97
[] warn\_slowpath\_fmt+0x41/0x43
[] debug\_print\_object+0x7c/0x8d
[] ? \_\_queue\_work+0x259/0x259
[] ? debug\_check\_no\_obj\_freed+0x6f/0x1b5
[] debug\_check\_no\_obj\_freed+0x98/0x1b5
[] ? bt\_host\_release+0x10/0x1e [bluetooth]
[] kfree+0x90/0xe6
[] bt\_host\_release+0x10/0x1e [bluetooth]
[] device\_release+0x4a/0x7e
[] kobject\_release+0x11d/0x154
[] kobject\_put+0x4a/0x4f
[] put\_device+0x12/0x14
[] hci\_free\_dev+0x22/0x26 [bluetooth]
[] btusb\_disconnect+0x96/0x9f [btusb]
[] usb\_unbind\_interface+0x57/0x106
[] \_\_device\_release\_driver+0x83/0xd6
[] device\_release\_driver+0x20/0x2d
[] usb\_driver\_release\_interface+0x44/0x7b
[] usb\_forced\_unbind\_intf+0x45/0x4e
[] usb\_reset\_device+0xa6/0x12e
[] usbdev\_do\_ioctl+0x319/0xe20
[] ? avc\_has\_perm\_flags+0xc9/0x12e
[] ? avc\_has\_perm\_flags+0x25/0x12e
[] ? do\_page\_fault+0x31e/0x3a1
[] usbdev\_ioctl+0x9/0xd
[] vfs\_ioctl+0x21/0x34
[] do\_vfs\_ioctl+0x408/0x44b
[] ? file\_has\_perm+0x76/0x81
[] sys\_ioctl+0x51/0x76
[] system\_call\_fastpath+0x16/0x1b
[1] http://cpansearch.perl.org/src/DPAVLIN/Biblio-RFID-0.03/examples/usbreset.c
Signed-off-by: Vinicius Costa Gomes
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 8c5aef4e6205321a9811caa9f69b9f42dd79317c
Author: Andrzej Kaczmarek
Date: Wed Aug 29 10:02:08 2012 +0200
Bluetooth: mgmt: Fix enabling SSP while powered off
commit 3d1cbdd6aefff711bcf389fdabc4af9bc22e8201 upstream.
When new BT USB adapter is plugged in it's configured while still being powered
off (HCI\_AUTO\_OFF flag is set), thus Set SSP will only set dev\_flags but won't
write changes to controller. As a result remote devices won't use Secure Simple
Pairing with our device due to SSP Host Support flag disabled in extended
features and may also reject SSP attempt from our side (with possible fallback
to legacy pairing).
This patch ensures HCI Write Simple Pairing Mode is sent when Set Powered is
called to power on controller and clear HCI\_AUTO\_OFF flag.
Signed-off-by: Andrzej Kaczmarek
Acked-by: Johan Hedberg
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 7c0bd09175067fdd190ebe8b2e6757d9d9cb7efe
Author: Wang Sen
Date: Mon Jul 30 14:25:06 2012 +0800
SCSI: scsi: virtio-scsi: Fix address translation failure of HighMem pages used by sg list
commit 27e99ade81368e6fdda3212bff9345177cf9e57a upstream.
When using the commands below to write some data to a virtio-scsi LUN of the
QEMU guest(32-bit) with 1G physical memory(qemu -m 1024), the qemu will crash.
# sudo mkfs.ext4 /dev/sdb (/dev/sdb is the virtio-scsi LUN.)
# sudo mount /dev/sdb /mnt
# dd if=/dev/zero of=/mnt/file bs=1M count=1024
In current implementation, sg\_set\_buf is called to add buffers to sg list which
is put into the virtqueue eventually. But if there are some HighMem pages in
table->sgl you can not get virtual address by sg\_virt. So, sg\_virt(sg\_elem) may
return NULL value. This will cause QEMU exit when virtqueue\_map\_sg is called
in QEMU because an invalid GPA is passed by virtqueue.
Two solutions are discussed here:
http://lkml.indiana.edu/hypermail/linux/kernel/1207.3/00675.html
Finally, value assignment approach was adopted because:
Value assignment creates a well-formed scatterlist, because the termination
marker in source sg\_list has been set in blk\_rq\_map\_sg(). The last entry of the
source sg\_list is just copied to the the last entry in destination list. Note
that, for now, virtio\_ring does not care about the form of the scatterlist and
simply processes the first out\_num + in\_num consecutive elements of the sg[]
array.
I have tested the patch on my workstation. QEMU would not crash any more.
Signed-off-by: Wang Sen
Acked-by: Paolo Bonzini
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit 3e9ca240ff7e18983868f4861cbbfbfff3ff7868
Author: Stephen M. Cameron
Date: Fri Sep 14 16:34:25 2012 -0500
SCSI: hpsa: fix handling of protocol error
commit 256d0eaac87da1e993190846064f339f4c7a63f5 upstream.
If a command status of CMD\_PROTOCOL\_ERR is received, this
information should be conveyed to the SCSI mid layer, not
dropped on the floor. CMD\_PROTOCOL\_ERR may be received
from the Smart Array for any commands destined for an external
RAID controller such as a P2000, or commands destined for tape
drives or CD/DVD-ROM drives, if for instance a cable is
disconnected. This mostly affects multipath configurations, as
disconnecting a cable on a non-multipath configuration is not
going to do anything good regardless of whether CMD\_PROTOCOL\_ERR
is handled correctly or not. Not handling CMD\_PROTOCOL\_ERR
correctly in a multipath configaration involving external RAID
controllers may cause data corruption, so this is quite a serious
bug. This bug should not normally cause a problem for direct
attached disk storage.
Signed-off-by: Stephen M. Cameron
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit 5fea3ffaf810a8a27c651d36930436176b0cf3ae
Author: Eddie Wai
Date: Tue Aug 21 10:35:53 2012 -0700
SCSI: bnx2i: Fixed NULL ptr deference for 1G bnx2 Linux iSCSI offload
commit d6532207116307eb7ecbfa7b9e02c53230096a50 upstream.
This patch fixes the following kernel panic invoked by uninitialized fields
in the chip initialization for the 1G bnx2 iSCSI offload.
One of the bits in the chip initialization is being used by the latest
firmware to control overflow packets. When this control bit gets enabled
erroneously, it would ultimately result in a bad packet placement which would
cause the bnx2 driver to dereference a NULL ptr in the placement handler.
This can happen under certain stress I/O environment under the Linux
iSCSI offload operation.
This change only affects Broadcom's 5709 chipset.
Unable to handle kernel NULL pointer dereference at 0000000000000008 RIP:
[] :bnx2:bnx2\_poll\_work+0xd0d/0x13c5
Pid: 0, comm: swapper Tainted: G ---- 2.6.18-333.el5debug #2
RIP: 0010:[] [] :bnx2:bnx2\_poll\_work+0xd0d/0x13c5
RSP: 0018:ffff8101b575bd50 EFLAGS: 00010216
RAX: 0000000000000005 RBX: ffff81007c5fb180 RCX: 0000000000000000
RDX: 0000000000000ffc RSI: 00000000817e8000 RDI: 0000000000000220
RBP: ffff81015bbd7ec0 R08: ffff8100817e9000 R09: 0000000000000000
R10: ffff81007c5fb180 R11: 00000000000000c8 R12: 000000007a25a010
R13: 0000000000000000 R14: 0000000000000005 R15: ffff810159f80558
FS: 0000000000000000(0000) GS:ffff8101afebc240(0000) knlGS:0000000000000000
CS: 0010 DS: 0018 ES: 0018 CR0: 000000008005003b
CR2: 0000000000000008 CR3: 0000000000201000 CR4: 00000000000006a0
Process swapper (pid: 0, threadinfo ffff8101b5754000, task ffff8101afebd820)
Stack: 000000000000000b ffff810159f80000 0000000000000040 ffff810159f80520
ffff810159f80500 00cf00cf8008e84b ffffc200100939e0 ffff810009035b20
0000502900000000 000000be00000001 ffff8100817e7810 00d08101b575bea8
Call Trace:
 [] show\_schedstat+0x1c2/0x25b
[] :bnx2:bnx2\_poll+0xf6/0x231
[] net\_rx\_action+0xac/0x1b1
[] \_\_do\_softirq+0x89/0x133
[] call\_softirq+0x1c/0x28
[] do\_softirq+0x2c/0x7d
[] do\_IRQ+0xee/0xf7
[] ret\_from\_intr+0x0/0xa
 [] acpi\_processor\_idle\_simple+0x1c5/0x341
[] acpi\_processor\_idle\_simple+0x182/0x341
[] acpi\_processor\_idle\_simple+0x0/0x341
[] cpu\_idle+0x95/0xb8
[] start\_secondary+0x479/0x488
Signed-off-by: Eddie Wai
Reviewed-by: Mike Christie
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit 727f6b2f3e047848cff1ad6c043eb95da93c8c95
Author: sreekanth.reddy@lsi.com
Date: Wed Aug 22 16:55:13 2012 +0530
SCSI: mpt2sas: Fix for issue - Unable to boot from the drive connected to HBA
commit 10cce6d8b5af0b32bc4254ae4a28423a74c0921c upstream.
This patch checks whether HBA is SAS2008 B0 controller.
if it is a SAS2008 B0 controller then it use IO-APIC interrupt instead of MSIX,
as SAS2008 B0 controller doesn't support MSIX interrupts.
[jejb: fix whitespace problems]
Signed-off-by: Sreekanth Reddy
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit e4134110803b08c03f051a1c7379474f28ebec83
Author: James Bottomley
Date: Thu Jun 21 07:50:02 2012 +0000
SCSI: lpfc: fix problems with -Werror
commit 4bdd03e61b7a5c4c6bc2b25d46fcd491788fdfb3 upstream.
Commit d38bd3aef ("Add -Werror compilation flag") is causing build breakage
with random gcc incarnations. These look like gcc problems, but we shouldn't
break the build because of a bad gcc. Fix this by adding a make flag
WARNINGS\_BECOME\_ERRORS=1
which is the same as aic7xxx uses so ordinarily the build doesn't use -Werror
Reported-by: Fengguang Wu
Cc: Alex Iannicelli
Cc: James Smart
Cc: Jonathan Nieder
Cc: Mike Pagano
Signed-off-by: James Bottomley
commit 18e140c64679d53fe0952b12fd9bd01df1e8d29d
Author: Hante Meuleman
Date: Tue Sep 11 21:16:48 2012 +0200
brcmfmac: Fix big endian host configuration data.
commit e020a83d0942a5aceac35986500c9834efc8707d upstream.
Fixes big endian host configuration parameters.
Reviewed-by: Arend Van Spriel
Signed-off-by: Hante Meuleman
Signed-off-by: Arend van Spriel
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit ae3853800b6604f73ac07c5e766593b5605529f2
Author: Hante Meuleman
Date: Tue Sep 11 21:16:47 2012 +0200
brcmfmac: fix big endian bug in i-scan.
commit ed205b361956c96e0d8c09a8c9135a6a79cd9541 upstream.
ssid len is 32 bit and needs endian conversion for big endian systems.
Signed-off-by: Hante Meuleman
Signed-off-by: Arend van Spriel
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit e2d0b03cd7cb264258e7473a4a3ef72f48752999
Author: Eliad Peller
Date: Tue Sep 4 17:44:45 2012 +0300
mac80211: clear bssid on auth/assoc failure
commit 3d2abdfdf14f4d6decc2023708211e19b096f4ca upstream.
ifmgd->bssid wasn't cleared properly in some
auth/assoc failure cases, causing mac80211 and
the low-level driver to go out of sync.
Clear ifmgd->bssid on failure, and notify the driver.
Signed-off-by: Eliad Peller
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 2306783b6e793e80943656e8238b5a367428ee8e
Author: Santiago Leon
Date: Tue Sep 4 14:41:37 2012 +0000
ibmveth: Fix alignment of rx queue bug
commit d90c92fee89ccd75ef2646f3bde0b4c0450666c3 upstream.
This patch fixes a bug found by Nish Aravamudan
(https://lkml.org/lkml/2012/5/15/220) where the driver is not following
the spec (it is not aligning the rx buffer on a 16-byte boundary) and the
hypervisor aborts the registration, making the device unusable.
The fix follows BenH's recommendation (https://lkml.org/lkml/2012/7/20/461)
to replace the kmalloc+map for a single call to dma\_alloc\_coherent()
because that function always aligns to a 16-byte boundary.
The stable trees will run into this bug whenever the rx buffer kmalloc call
returns something not aligned on a 16-byte boundary.
Signed-off-by: Santiago Leon
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5a899124734999d85d0b23371a367d92cfb82ee2
Author: Bjørn Mork
Date: Sun Sep 2 22:26:18 2012 +0000
net: usbnet: fix softirq storm on suspend
commit 85e87870fa18ec9f5df98e2d3b48f3699560a570 upstream.
Suspending an open usbnet device results in constant
rescheduling of usbnet\_bh.
commit 65841fd5 "usbnet: handle remote wakeup asap"
refactored the usbnet\_bh code to allow sharing the
urb allocate and submit code with usbnet\_resume. In
this process, a test for, and immediate return on,
ENOLINK from rx\_submit was unintentionally dropped.
The rx queue will not grow if rx\_submit fails,
making usbnet\_bh reschedule itself. This results
in a softirq storm if the error is persistent.
rx\_submit translates the usb\_submit\_urb error
EHOSTUNREACH into ENOLINK, so this is an expected
and persistent error for a suspended device. The
old code tested for this condition and avoided
rescheduling. Putting this test back.
Signed-off-by: Bjørn Mork
Cc: Ming Lei
Cc: Oliver Neukum
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 623678ee75bbe765b6688ff05f0a435e959fa016
Author: Dave Airlie
Date: Tue Aug 28 01:53:54 2012 +0000
vmwgfx: add dumb ioctl support
commit 5e1782d224c79b26ab7d5c31e3f87657000714fb upstream.
Testing and works with the -modesetting driver,
Reviewed-by: Jakob Bornecrantz
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 3e151dc53628c447f196e96808cf7b9eab17a027
Author: Jeff Layton
Date: Tue Sep 18 14:21:01 2012 -0400
cifs: fix return value in cifsConvertToUTF16
commit c73f693989d7a7d99ec66a7065295a0c93d0b127 upstream.
This function returns the wrong value, which causes the callers to get
the length of the resulting pathname wrong when it contains non-ASCII
characters.
This seems to fix https://bugzilla.samba.org/show\_bug.cgi?id=6767
Reported-by: Baldvin Kovacs
Reported-and-Tested-by: Nicolas Lefebvre
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit bd4af90712fa632c5feae6f0afc8378833fce601
Author: Nestor Lopez Casado
Date: Fri Sep 21 12:21:34 2012 +0200
HID: Fix logitech-dj: missing Unifying device issue
commit 596264082f10dd4a567c43d4526b2f54ac5520bc upstream.
This patch fixes an issue introduced after commit 4ea5454203d991ec
("HID: Fix race condition between driver core and ll-driver").
After that commit, hid-core discards any incoming packet that arrives while
hid driver's probe function is being executed.
This broke the enumeration process of hid-logitech-dj, that must receive
control packets in-band with the mouse and keyboard packets. Discarding mouse
or keyboard data at the very begining is usually fine, but it is not the case
for control packets.
This patch forces a re-enumeration of the paired devices when a packet arrives
that comes from an unknown device.
Based on a patch originally written by Benjamin Tissoires.
Signed-off-by: Nestor Lopez Casado
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 1607e7b7045c1dbd5072c6aabde7d9159ca39356
Author: Alan Cox
Date: Tue Sep 4 15:10:08 2012 +0100
dj: memory scribble in logi\_dj
commit 8a55ade76551e3927b4e41ee9e7751875d18bc25 upstream.
Allocate a structure not a pointer to it !
Signed-off-by: Alan Cox
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9304b81bd45689d9fac80ce689a36841aefeba33
Author: Guenter Roeck
Date: Tue Sep 11 13:43:17 2012 -0700
hwmon: (ad7314) Add 'name' sysfs attribute
commit 3ceefe4319636d89d4bdf40dca9471970f942e4f upstream.
The 'name' sysfs attribute is mandatory for hwmon devices, but was missing
in this driver.
Cc: Jonathan Cameron
Signed-off-by: Guenter Roeck
Acked-by: Jean Delvare
Acked-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 3aa7516bf06846d00b0f93f10e466dcfc7d95cce
Author: Guenter Roeck
Date: Tue Sep 11 13:39:08 2012 -0700
hwmon: (ads7871) Add 'name' sysfs attribute
commit 4e21f4eaa49f78d3e977e316514c941053871c76 upstream.
The 'name' sysfs attribute is mandatory for hwmon devices, but was missing
in this driver.
Cc: Paul Thomas
Signed-off-by: Guenter Roeck
Acked-by: Jean Delvare
Acked-by: Paul Thomas
Signed-off-by: Greg Kroah-Hartman
commit b0c2ca340080d3f918cc69c8cc7516ccd85f2799
Author: Andreas Herrmann
Date: Sun Sep 23 20:27:32 2012 +0200
hwmon: (fam15h\_power) Tweak runavg\_range on resume
commit 5f0ecb907deb1e6f28071ee3bd568903b9da1be4 upstream.
The quirk introduced with commit
00250ec90963b7ef6678438888f3244985ecde14 (hwmon: fam15h\_power: fix
bogus values with current BIOSes) is not only required during driver
load but also when system resumes from suspend. The BIOS might set the
previously recommended (but unsuitable) initilization value for the
running average range register during resume.
Signed-off-by: Andreas Herrmann
Tested-by: Andreas Hartmann
Signed-off-by: Jean Delvare
Signed-off-by: Greg Kroah-Hartman
commit 3c362fb1c80ded1b396d9f2fabfdbe6632ec9120
Author: Konrad Rzeszutek Wilk
Date: Fri Aug 17 10:22:37 2012 -0400
xen/boot: Disable NUMA for PV guests.
commit 8d54db795dfb1049d45dc34f0dddbc5347ec5642 upstream.
The hypervisor is in charge of allocating the proper "NUMA" memory
and dealing with the CPU scheduler to keep them bound to the proper
NUMA node. The PV guests (and PVHVM) have no inkling of where they
run and do not need to know that right now. In the future we will
need to inject NUMA configuration data (if a guest spans two or more
NUMA nodes) so that the kernel can make the right choices. But those
patches are not yet present.
In the meantime, disable the NUMA capability in the PV guest, which
also fixes a bootup issue. Andre says:
"we see Dom0 crashes due to the kernel detecting the NUMA topology not
by ACPI, but directly from the northbridge (CONFIG\_AMD\_NUMA).
This will detect the actual NUMA config of the physical machine, but
will crash about the mismatch with Dom0's virtual memory. Variation of
the theme: Dom0 sees what it's not supposed to see.
This happens with the said config option enabled and on a machine where
this scanning is still enabled (K8 and Fam10h, not Bulldozer class)
We have this dump then:
NUMA: Warning: node ids are out of bound, from=-1 to=-1 distance=10
Scanning NUMA topology in Northbridge 24
Number of physical nodes 4
Node 0 MemBase 0000000000000000 Limit 0000000040000000
Node 1 MemBase 0000000040000000 Limit 0000000138000000
Node 2 MemBase 0000000138000000 Limit 00000001f8000000
Node 3 MemBase 00000001f8000000 Limit 0000000238000000
Initmem setup node 0 0000000000000000-0000000040000000
NODE\_DATA [000000003ffd9000 - 000000003fffffff]
Initmem setup node 1 0000000040000000-0000000138000000
NODE\_DATA [0000000137fd9000 - 0000000137ffffff]
Initmem setup node 2 0000000138000000-00000001f8000000
NODE\_DATA [00000001f095e000 - 00000001f0984fff]
Initmem setup node 3 00000001f8000000-0000000238000000
Cannot find 159744 bytes in node 3
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: [] \_\_alloc\_bootmem\_node+0x43/0x96
Pid: 0, comm: swapper Not tainted 3.3.6 #1 AMD Dinar/Dinar
RIP: e030:[] [] \_\_alloc\_bootmem\_node+0x43/0x96
.. snip..
[] sparse\_early\_usemaps\_alloc\_node+0x64/0x178
[] sparse\_init+0xe4/0x25a
[] paging\_init+0x13/0x22
[] setup\_arch+0x9c6/0xa9b
[] ? printk+0x3c/0x3e
[] start\_kernel+0xe5/0x468
[] x86\_64\_start\_reservations+0xba/0xc1
[] ? xen\_setup\_runstate\_info+0x2c/0x36
[] xen\_start\_kernel+0x565/0x56c
"
so we just disable NUMA scanning by setting numa\_off=1.
Reported-and-Tested-by: Andre Przywara
Acked-by: Andre Przywara
Signed-off-by: Konrad Rzeszutek Wilk
Signed-off-by: Greg Kroah-Hartman
commit 91101fc0dc638cc70981b4d065240c2b87353049
Author: Konrad Rzeszutek Wilk
Date: Wed Sep 19 08:30:55 2012 -0400
xen/boot: Disable BIOS SMP MP table search.
commit bd49940a35ec7d488ae63bd625639893b3385b97 upstream.
As the initial domain we are able to search/map certain regions
of memory to harvest configuration data. For all low-level we
use ACPI tables - for interrupts we use exclusively ACPI \_PRT
(so DSDT) and MADT for INT\_SRC\_OVR.
The SMP MP table is not used at all. As a matter of fact we do
not even support machines that only have SMP MP but no ACPI tables.
Lets follow how Moorestown does it and just disable searching
for BIOS SMP tables.
This also fixes an issue on HP Proliant BL680c G5 and DL380 G6:
9f->100 for 1:1 PTE
Freeing 9f-100 pfn range: 97 pages freed
1-1 mapping on 9f->100
.. snip..
e820: BIOS-provided physical RAM map:
Xen: [mem 0x0000000000000000-0x000000000009efff] usable
Xen: [mem 0x000000000009f400-0x00000000000fffff] reserved
Xen: [mem 0x0000000000100000-0x00000000cfd1dfff] usable
.. snip..
Scan for SMP in [mem 0x00000000-0x000003ff]
Scan for SMP in [mem 0x0009fc00-0x0009ffff]
Scan for SMP in [mem 0x000f0000-0x000fffff]
found SMP MP-table at [mem 0x000f4fa0-0x000f4faf] mapped at [ffff8800000f4fa0]
(XEN) mm.c:908:d0 Error getting mfn 100 (pfn 5555555555555555) from L1 entry 0000000000100461 for l1e\_owner=0, pg\_owner=0
(XEN) mm.c:4995:d0 ptwr\_emulate: could not get\_page\_from\_l1e()
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: [] xen\_set\_pte\_init+0x66/0x71
. snip..
Pid: 0, comm: swapper Not tainted 3.6.0-rc6upstream-00188-gb6fb969-dirty #2 HP ProLiant BL680c G5
.. snip..
Call Trace:
[] \_\_early\_ioremap+0x18a/0x248
[] ? printk+0x48/0x4a
[] early\_ioremap+0x13/0x15
[] get\_mpc\_size+0x2f/0x67
[] smp\_scan\_config+0x10c/0x136
[] default\_find\_smp\_config+0x36/0x5a
[] setup\_arch+0x5b3/0xb5b
[] ? printk+0x48/0x4a
[] start\_kernel+0x90/0x390
[] x86\_64\_start\_reservations+0x131/0x136
[] xen\_start\_kernel+0x65f/0x661
(XEN) Domain 0 crashed: 'noreboot' set - not rebooting.
which is that ioremap would end up mapping 0xff using \_PAGE\_IOMAP
(which is what early\_ioremap sticks as a flag) - which meant
we would get MFN 0xFF (pte ff461, which is OK), and then it would
also map 0x100 (b/c ioremap tries to get page aligned request, and
it was trying to map 0xf4fa0 + PAGE\_SIZE - so it mapped the next page)
as \_PAGE\_IOMAP. Since 0x100 is actually a RAM page, and the \_PAGE\_IOMAP
bypasses the P2M lookup we would happily set the PTE to 1000461.
Xen would deny the request since we do not have access to the
Machine Frame Number (MFN) of 0x100. The P2M[0x100] is for example
0x80140.
Fixes-Oracle-Bugzilla: https://bugzilla.oracle.com/bugzilla/show\_bug.cgi?id=13665
Acked-by: Jan Beulich
Signed-off-by: Konrad Rzeszutek Wilk
Signed-off-by: Greg Kroah-Hartman
commit 927766ff00c2f45847b77c9732c2e130313e0d0e
Author: Stefano Stabellini
Date: Wed Sep 12 12:44:30 2012 +0100
xen/m2p: do not reuse kmap\_op->dev\_bus\_addr
commit 2fc136eecd0c647a6b13fcd00d0c41a1a28f35a5 upstream.
If the caller passes a valid kmap\_op to m2p\_add\_override, we use
kmap\_op->dev\_bus\_addr to store the original mfn, but dev\_bus\_addr is
part of the interface with Xen and if we are batching the hypercalls it
might not have been written by the hypervisor yet. That means that later
on Xen will write to it and we'll think that the original mfn is
actually what Xen has written to it.
Rather than "stealing" struct members from kmap\_op, keep using
page->index to store the original mfn and add another parameter to
m2p\_remove\_override to get the corresponding kmap\_op instead.
It is now responsibility of the caller to keep track of which kmap\_op
corresponds to a particular page in the m2p\_override (gntdev, the only
user of this interface that passes a valid kmap\_op, is already doing that).
Reported-and-Tested-By: Sander Eikelenboom
Signed-off-by: Stefano Stabellini
Signed-off-by: Konrad Rzeszutek Wilk
Signed-off-by: Greg Kroah-Hartman
commit 8534c2b953b7ac2f54a025c62d3057d67f72a888
Author: qiuxishi
Date: Mon Sep 17 14:09:24 2012 -0700
memory hotplug: fix section info double registration bug
commit f14851af0ebb32745c6c5a2e400aa0549f9d20df upstream.
There may be a bug when registering section info. For example, on my
Itanium platform, the pfn range of node0 includes the other nodes, so
other nodes' section info will be double registered, and memmap's page
count will equal to 3.
node0: start\_pfn=0x100, spanned\_pfn=0x20fb00, present\_pfn=0x7f8a3, => 0x000100-0x20fc00
node1: start\_pfn=0x80000, spanned\_pfn=0x80000, present\_pfn=0x80000, => 0x080000-0x100000
node2: start\_pfn=0x100000, spanned\_pfn=0x80000, present\_pfn=0x80000, => 0x100000-0x180000
node3: start\_pfn=0x180000, spanned\_pfn=0x80000, present\_pfn=0x80000, => 0x180000-0x200000
free\_all\_bootmem\_node()
register\_page\_bootmem\_info\_node()
register\_page\_bootmem\_info\_section()
When hot remove memory, we can't free the memmap's page because
page\_count() is 2 after put\_page\_bootmem().
sparse\_remove\_one\_section()
free\_section\_usemap()
free\_map\_bootmem()
put\_page\_bootmem()
[akpm@linux-foundation.org: add code comment]
Signed-off-by: Xishi Qiu
Signed-off-by: Jiang Liu
Acked-by: Mel Gorman
Cc: "Luck, Tony"
Cc: Yasuaki Ishimatsu
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 39a9f8fe2d179b708c0f46f7a1fbee19b390843c
Author: Jianguo Wu
Date: Mon Sep 17 14:08:56 2012 -0700
mm/ia64: fix a memory block size bug
commit 05cf96398e1b6502f9e191291b715c7463c9d5dd upstream.
I found following definition in include/linux/memory.h, in my IA64
platform, SECTION\_SIZE\_BITS is equal to 32, and MIN\_MEMORY\_BLOCK\_SIZE
will be 0.
#define MIN\_MEMORY\_BLOCK\_SIZE (1 << SECTION\_SIZE\_BITS)
Because MIN\_MEMORY\_BLOCK\_SIZE is int type and length of 32bits,
so MIN\_MEMORY\_BLOCK\_SIZE(1 << 32) will will equal to 0.
Actually when SECTION\_SIZE\_BITS >= 31, MIN\_MEMORY\_BLOCK\_SIZE will be wrong.
This will cause wrong system memory infomation in sysfs.
I think it should be:
#define MIN\_MEMORY\_BLOCK\_SIZE (1UL << SECTION\_SIZE\_BITS)
And "echo offline > memory0/state" will cause following call trace:
kernel BUG at mm/memory\_hotplug.c:885!
sh[6455]: bugcheck! 0 [1]
Pid: 6455, CPU 0, comm: sh
psr : 0000101008526030 ifs : 8000000000000fa4 ip : [] Not tainted (3.6.0-rc1)
ip is at offline\_pages+0x210/0xee0
Call Trace:
show\_stack+0x80/0xa0
show\_regs+0x640/0x920
die+0x190/0x2c0
die\_if\_kernel+0x50/0x80
ia64\_bad\_break+0x3d0/0x6e0
ia64\_native\_leave\_kernel+0x0/0x270
offline\_pages+0x210/0xee0
alloc\_pages\_current+0x180/0x2a0
Signed-off-by: Jianguo Wu
Signed-off-by: Jiang Liu
Cc: "Luck, Tony"
Reviewed-by: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 23cffc536a2f396e1e752527460d545e816ee654
Author: Benoît Locher
Date: Mon Aug 27 15:02:45 2012 +0200
can: mcp251x: avoid repeated frame bug
commit cab32f39dcc5b35db96497dc0a026b5dea76e4e7 upstream.
The MCP2515 has a silicon bug causing repeated frame transmission, see section
5 of MCP2515 Rev. B Silicon Errata Revision G (March 2007).
Basically, setting TXBnCTRL.TXREQ in either SPI mode (00 or 11) will eventually
cause the bug. The workaround proposed by Microchip is to use mode 00 and send
a RTS command on the SPI bus to initiate the transmission.
Signed-off-by: Benoît Locher
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 3da7f1ade823595e37e37bca09d9d9f24c945e9a
Author: Karsten Keil
Date: Thu Sep 13 04:36:20 2012 +0000
mISDN: Fix wrong usage of flush\_work\_sync while holding locks
commit 4b921eda53366b319602351ff4d7256fafa4bd1b upstream.
It is a bad idea to hold a spinlock and call flush\_work\_sync.
Move the workqueue cleanup outside the spinlock and use cancel\_work\_sync,
on closing the channel this seems to be the more correct function.
Remove the never used and constant return value of mISDN\_freebchannel.
Signed-off-by: Karsten Keil
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dff9a4f031d1804f41b0f45c53543284b93548df
Author: Alan Cox
Date: Wed Sep 12 10:05:04 2012 +0000
gma500: Fix regression on Oaktrail devices
commit 26df641eac05abe1a3276eea441359b4d1120816 upstream.
The register map patches didn't set one value for the GMA600 which
means the Fujitsu Q550 dies on boot with the GMA500 driver enabled.
Add the map entry so we don't read from the device MMIO + 0 by mistake.
Signed-off-by: Alan Cox
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 900404e5d201d0a6d2806f615b41e939713d55db
Author: Charles Wang
Date: Mon Aug 20 16:02:33 2012 +0800
sched: Add missing call to calc\_load\_exit\_idle()
commit 749c8814f08f12baa4a9c2812a7c6ede7d69507d upstream.
Azat Khuzhin reported high loadavg in Linux v3.6
After checking the upstream scheduler code, I found Peter's commit:
5167e8d5417b sched/nohz: Rewrite and fix load-avg computation -- again
not fully applied, missing the call to calc\_load\_exit\_idle().
After that idle exit in sampling window will always be calculated
to non-idle, and the load will be higher than normal.
This patch adds the missing call to calc\_load\_exit\_idle().
Signed-off-by: Charles Wang
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/r/1345449754-27130-1-git-send-email-muming.wq@gmail.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 7f1adf647e76af1c5108b12b2e17331f69565d38
Author: Guenter Roeck
Date: Tue Sep 11 08:22:14 2012 -0700
hwmon: (ina2xx) Fix word size register read and write operations
commit 080b98e9ab30734bda2f1b8b33cd55a4c4ef406a upstream.
The driver uses be16\_to\_cpu and cpu\_to\_be16 to convert data in SMBus word
operations from chip to host byte order. However, the data passed from and to
the SMBus word API functions is in host byte order, not in chip byte order.
Conversion should therefore use swab16 instead of be16 to change the byte order.
Replace driver internal word conversion functions with SMBus API functions to
solve the problem.
Signed-off-by: Guenter Roeck
Acked-by: Jean Delvare
Signed-off-by: Greg Kroah-Hartman
commit bc080eed5c61471ab1204b70bf7efe22c5181087
Author: Guenter Roeck
Date: Tue Jun 19 08:00:00 2012 -0700
hwmon: (twl4030-madc-hwmon) Initialize uninitialized structure elements
commit 73d7c119255615a26070f9d6cdb722a166a29015 upstream.
twl4030\_madc\_conversion uses do\_avg and type structure elements of
twl4030\_madc\_request. Initialize structure to avoid random operation.
Fix for: Coverity CID 200794 Uninitialized scalar variable.
Cc: Keerthy
Signed-off-by: Guenter Roeck
Acked-by: Jean Delvare
Acked-by: Keerthy
Signed-off-by: Greg Kroah-Hartman
commit 1a63a2a60287396a16c43c844913f59e01e9e0ce
Author: Kevin Hilman
Date: Mon Sep 17 14:09:17 2012 -0700
drivers/rtc/rtc-twl.c: ensure all interrupts are disabled during probe
commit 8dcebaa9a0ae8a0487f4342f3d56d2cb1c980860 upstream.
On some platforms, bootloaders are known to do some interesting RTC
programming. Without going into the obscurities as to why this may be
the case, suffice it to say the the driver should not make any
assumptions about the state of the RTC when the driver loads. In
particular, the driver probe should be sure that all interrupts are
disabled until otherwise programmed.
This was discovered when finding bursty I2C traffic every second on
Overo platforms. This I2C overhead was keeping the SoC from hitting
deep power states. The cause was found to be the RTC firing every
second on the I2C-connected TWL PMIC.
Special thanks to Felipe Balbi for suggesting to look for a rogue driver
as the source of the I2C traffic rather than the I2C driver itself.
Special thanks to Steve Sakoman for helping track down the source of the
continuous RTC interrups on the Overo boards.
Signed-off-by: Kevin Hilman
Cc: Felipe Balbi
Tested-by: Steve Sakoman
Cc: Alessandro Zummo
Tested-by: Shubhrajyoti Datta
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 69a9b3628594b74d481a4e4f4e96a2b9141d853a
Author: Li Haifeng
Date: Mon Sep 17 14:09:21 2012 -0700
mm/page\_alloc: fix the page address of higher page's buddy calculation
commit 0ba8f2d59304dfe69b59c034de723ad80f7ab9ac upstream.
The heuristic method for buddy has been introduced since commit
43506fad21ca ("mm/page\_alloc.c: simplify calculation of combined index
of adjacent buddy lists"). But the page address of higher page's buddy
was wrongly calculated, which will lead page\_is\_buddy to fail for ever.
IOW, the heuristic method would be disabled with the wrong page address
of higher page's buddy.
Calculating the page address of higher page's buddy should be based
higher\_page with the offset between index of higher page and index of
higher page's buddy.
Signed-off-by: Haifeng Li
Signed-off-by: Gavin Shan
Reviewed-by: Michal Hocko
Cc: KyongHo Cho
Cc: Mel Gorman
Cc: Minchan Kim
Cc: Johannes Weiner
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ab04daac5dbe4fd2d1a3152d2dd850fbd3ab94bb
Author: Dylan Reid
Date: Sat Sep 1 01:38:19 2012 -0700
ASoC: samsung dma - Don't indicate support for pause/resume.
commit 57b2d68863f281737d8596cb3d76d89d9cc54fd8 upstream.
The pause and resume operations indicate that the stream can be
un-paused/resumed from the exact location they were paused/suspended.
This is not true for this driver, the pause and suspend triggers share
the same code path with stop, they flush all pending DMA transfers.
This drops all pending samples. The pause\_release/resume triggers are
the same as start, except that prepare won't be called beforehand,
nothing will be enqueued to the DMA engine and nothing will happen (no
audio). Removing the pause flag will let apps know that it isn't
supported. Removing the resume flag will cause user space to call
prepare and start instead of resume, so audio will continue playing when
the system wakes up.
Before removing the pause and resume flags, I tested this on an exynos
5250, using 'aplay -i'. Pause/un-pause leads to silence followed by a
write error. Suspend/resume testing led to the same result. Removing
the two flags fixes suspend/resume (since snd\_pcm\_prepare is called
again). And leads to a proper reporting of pause not supported.
Signed-off-by: Dylan Reid
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit ea11e00964349c413950b0fe0d45422f92a9dd49
Author: Paul Clements
Date: Mon Sep 17 14:09:02 2012 -0700
nbd: clear waiting\_queue on shutdown
commit fded4e090c60100d709318896c79816d68d5b47d upstream.
Fix a serious but uncommon bug in nbd which occurs when there is heavy
I/O going to the nbd device while, at the same time, a failure (server,
network) or manual disconnect of the nbd connection occurs.
There is a small window between the time that the nbd\_thread is stopped
and the socket is shutdown where requests can continue to be queued to
nbd's internal waiting\_queue. When this happens, those requests are
never completed or freed.
The fix is to clear the waiting\_queue on shutdown of the nbd device, in
the same way that the nbd request queue (queue\_head) is already being
cleared.
Signed-off-by: Paul Clements
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0177d47e166d716789e3fb5b58cfddf451ab8998
Author: NeilBrown
Date: Wed Sep 19 12:52:30 2012 +1000
md/raid5: fix calculate of 'degraded' when a replacement becomes active.
commit e5c86471f933608db5d43679f84cb4346c32033e upstream.
When a replacement device becomes active, we mark the device that it
replaces as 'faulty' so that it can subsequently get removed.
However 'calc\_degraded' only pays attention to the primary device, not
the replacement, so the array appears to become degraded, which is
wrong.
So teach 'calc\_degraded' to consider any replacement if a primary
device is faulty.
This is suitable for -stable as an incorrect 'degraded' value can
confuse md and could lead to data corruption.
This is only relevant for 3.3 and later.
Reported-by: Robin Hill
Reported-by: John Drescher
Signed-off-by: NeilBrown
Signed-off-by: Greg Kroah-Hartman
commit 71a5d69e4007fd336672f052f98730fa383fe49b
Author: NeilBrown
Date: Wed Sep 19 12:54:22 2012 +1000
md: make sure metadata is updated when spares are activated or removed.
commit 6dafab6b1383e912cd252fa809570b484eb6e0dc upstream.
It isn't always necessary to update the metadata when spares are
removed as the presence-or-not of a spare isn't really important to
the integrity of an array.
Also activating a spare doesn't always require updating the metadata
as the update on 'recovery-completed' is usually sufficient.
However the introduction of 'replacement' devices have made these
transitions sometimes more important. For example the 'Replacement'
flag isn't cleared until the original device is removed, so we need
to ensure a metadata update after that 'spare' is removed.
So set MD\_CHANGE\_DEVS whenever a spare is activated or removed, to
complement the current situation where it is set when a spare is added
or a device is failed (or a number of other less common situations).
This is suitable for -stable as out-of-data metadata could lead
to data corruption.
This is only relevant for 3.3 and later 9when 'replacement' as
introduced.
Signed-off-by: NeilBrown
Signed-off-by: Greg Kroah-Hartman
commit f75a855c75feb7ca747c505c714973741b5c2920
Author: NeilBrown
Date: Sat Aug 18 09:51:42 2012 +1000
md/raid10: fix problem with on-stack allocation of r10bio structure.
commit e0ee778528bbaad28a5c69d2e219269a3a096607 upstream.
A 'struct r10bio' has an array of per-copy information at the end.
This array is declared with size [0] and r10bio\_pool\_alloc allocates
enough extra space to store the per-copy information depending on the
number of copies needed.
So declaring a 'struct r10bio on the stack isn't going to work. It
won't allocate enough space, and memory corruption will ensue.
So in the two places where this is done, declare a sufficiently large
structure and use that instead.
The two call-sites of this bug were introduced in 3.4 and 3.5
so this is suitable for both those kernels. The patch will have to
be modified for 3.4 as it only has one bug.
Reported-by: Ivan Vasilyev
Tested-by: Ivan Vasilyev
Signed-off-by: NeilBrown
Signed-off-by: Greg Kroah-Hartman
commit 3ed7a69d881a940185cebab49e22f7d5daa0767f
Author: NeilBrown
Date: Thu Aug 16 16:46:12 2012 +1000
md: Don't truncate size at 4TB for RAID0 and Linear
commit 667a5313ecd7308d79629c0738b0db588b0b0a4e upstream.
commit 27a7b260f71439c40546b43588448faac01adb93
md: Fix handling for devices from 2TB to 4TB in 0.90 metadata.
changed 0.90 metadata handling to truncated size to 4TB as that is
all that 0.90 can record.
However for RAID0 and Linear, 0.90 doesn't need to record the size, so
this truncation is not needed and causes working arrays to become too small.
So avoid the truncation for RAID0 and Linear
This bug was introduced in 3.1 and is suitable for any stable kernels
from then onwards.
As the offending commit was tagged for 'stable', any stable kernel
that it was applied to should also get this patch. That includes
at least 2.6.32, 2.6.33 and 3.0. (Thanks to Ben Hutchings for
providing that list).
Signed-off-by: Neil Brown
Signed-off-by: Greg Kroah-Hartman
commit df4d11d1581f21352b2a727c2a62ede4f0aa48b7
Author: Dmitry Kasatkin
Date: Wed Sep 12 13:26:55 2012 +0300
digsig: add hash size comparision on signature verification
commit bc01637a80f5b670bd70a0279d3f93fa8de1c96d upstream.
When pkcs\_1\_v1\_5\_decode\_emsa() returns without error and hash sizes do
not match, hash comparision is not done and digsig\_verify\_rsa() returns
no error. This is a bug and this patch fixes it.
The bug was introduced in v3.3 by commit b35e286a640f ("lib/digsig:
pkcs\_1\_v1\_5\_decode\_emsa cleanup").
Signed-off-by: Dmitry Kasatkin
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 99c9bffe490072ec4a1b72bc7ca7c6c7048e2c9b
Author: Mel Gorman
Date: Sun Aug 19 14:41:03 2012 +1200
Redefine ATOMIC\_INIT and ATOMIC64\_INIT to drop the casts
commit 67a806d9499353fabd5b5ff07337f3aa88a1c3ba upstream.
The following build error occurred during an alpha build:
net/core/sock.c:274:36: error: initializer element is not constant
Dave Anglin says:
> Here is the line in sock.i:
>
> struct static\_key memalloc\_socks = ((struct static\_key) { .enabled =
> ((atomic\_t) { (0) }) });
The above line contains two compound literals. It also uses a designated
initializer to initialize the field enabled. A compound literal is not a
constant expression.
The location of the above statement isn't fully clear, but if a compound
literal occurs outside the body of a function, the initializer list must
consist of constant expressions.
Signed-off-by: Mel Gorman
Signed-off-by: Fengguang Wu
Signed-off-by: Michael Cree
Acked-by: Matt Turner
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3d822616ca81881d8c19d0b473e79ba241c700de
Author: Markus Trippelsdorf
Date: Sat Aug 18 18:35:51 2012 -0600
dyndbg: fix for SOH in logging messages
commit ebdc82899ec5ed35af1c79ed6a4eeda69dad9b90 upstream.
commit af7f2158fde was done against master, and clashed with structured
logging's change of KERN\_LEVEL to SOH.
Bisected and fixed by Markus Trippelsdorf.
Reported-by: Markus Trippelsdorf
Signed-off-by: Jim Cromie
Cc: Linus Torvalds
Cc: Andrew Morton
Cc: Jason Baron
Signed-off-by: Greg Kroah-Hartman
commit ff525db26bb2ec9a78ab50f9ef943e13e95f90b2
Author: Bjørn Mork
Date: Sun Sep 2 15:41:34 2012 +0200
kobject: fix oops with "input0: bad kobj\_uevent\_env content in show\_uevent()"
commit 60e233a56609fd963c59e99bd75c663d63fa91b6 upstream.
Fengguang Wu  writes:
> After the \_\_devinit\* removal series, I can still get kernel panic in
> show\_uevent(). So there are more sources of bug..
>
> Debug patch:
>
> @@ -343,8 +343,11 @@ static ssize\_t show\_uevent(struct device
> goto out;
>
> /\* copy keys to file \*/
> - for (i = 0; i < env->envp\_idx; i++)
> + dev\_err(dev, "uevent %d env[%d]: %s/.../%s\n", env->buflen, env->envp\_idx, top\_kobj->name, dev->kobj.name);
> + for (i = 0; i < env->envp\_idx; i++) {
> + printk(KERN\_ERR "uevent %d env[%d]: %s\n", (int)count, i, env->envp[i]);
> count += sprintf(&buf[count], "%s\n", env->envp[i]);
> + }
>
> Oops message, the env[] is again not properly initilized:
>
> [ 44.068623] input input0: uevent 61 env[805306368]: input0/.../input0
> [ 44.069552] uevent 0 env[0]: (null)
This is a completely different CONFIG\_HOTPLUG problem, only
demonstrating another reason why CONFIG\_HOTPLUG should go away. I had a
hard time trying to disable it anyway ;-)
The problem this time is lots of code assuming that a call to
add\_uevent\_var() will guarantee that env->buflen > 0. This is not true
if CONFIG\_HOTPLUG is unset. So things like this end up overwriting
env->envp\_idx because the array index is -1:
if (add\_uevent\_var(env, "MODALIAS="))
return -ENOMEM;
len = input\_print\_modalias(&env->buf[env->buflen - 1],
sizeof(env->buf) - env->buflen,
dev, 0);
Don't know what the best action is, given that there seem to be a \*lot\*
of this around the kernel. This patch "fixes" the problem for me, but I
don't know if it can be considered an appropriate fix.
[ It is the correct fix for now, for 3.7 forcing CONFIG\_HOTPLUG to
always be on is the longterm fix, but it's too late for 3.6 and older
kernels to resolve this that way - gregkh ]
Reported-by: Fengguang Wu
Signed-off-by: Bjørn Mork
Tested-by: Fengguang Wu
Signed-off-by: Greg Kroah-Hartman
commit 0143215fec6628fbc3045f5b179fad44838c5988
Author: Alan Cox
Date: Tue Sep 4 16:07:18 2012 +0100
ahci: Add alternate identifier for the 88SE9172
commit 17c60c6b763cb5b83b0185e7d38d01d18e55a05a upstream.
This can also appear as 0x9192. Reported in bugzilla and confirmed with the
board documentation for these boards.
Resolves-bug: https://bugzilla.kernel.org/show\_bug.cgi?id=42970
Signed-off-by: Alan Cox
Signed-off-by: Jeff Garzik
Signed-off-by: Greg Kroah-Hartman
commit c3d2a5eb91f00d4d16ccc1871a7e1dbf759e54bd
Author: Sebastian Andrzej Siewior
Date: Fri Jul 20 20:34:25 2012 +0200
usb: gadget: at91udc: Don't check for ep->ep.desc
commit f3bb8e63a8ee0398dffe412e774d8801db7e1bf1 upstream.
Earlier we used to check for ep->ep.desc to figure out if this ep has
already been enabled and if so, abort.
Ido Shayevitz removed the usb\_endpoint\_descriptor from private udc
structure 5a6506f00 ("usb: gadget: Update at91\_udc to use
usb\_endpoint\_descriptor inside the struct usb\_ep") but did not fix up
the ep\_enable condition because \_now\_ the member is always true and we
can't check if this ep is enabled twice.
Cc: Ido Shayevitz
Tested-by: Fabio Porcedda
Tested-by: Mario Isidoro
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit bdee0b397af9199d78bbbb1d3d3fd20140b8777e
Author: Sebastian Andrzej Siewior
Date: Fri Jul 20 20:34:24 2012 +0200
usb: gadget: at91udc: don't overwrite driver data
commit 8b7dda554cf61e87523dee412eaf598f8646bd79 upstream.
The driver was converted to the new start/stop interface in f3d8bf34c2
("usb: gadget: at91\_udc: convert to new style start/stop interface").
I overlooked that the driver is overwritting the private data which is
used by the composite framework. The udc driver doesn't read it, it is
only written here.
Tested-by: Fabio Porcedda
Tested-by: Mario Isidoro
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 0fd97e46e63c94bb532922850f381ced90c77e71
Author: Sebastian Andrzej Siewior
Date: Sun Aug 19 21:54:59 2012 +0200
usb: gadget: dummy\_hcd: add support for USB\_DT\_BOS on rh
commit 3b9c1c5ba7a95caae8440ea47308496b14f7301a upstream.
Without a reply for USB\_DT\_BOS the USB3 mode does not work since
448b6eb1 ("USB: Make sure to fetch the BOS desc for roothubs.).
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit f5da200019dab1a1763f8361fdfd94389bf7f37a
Author: Sebastian Andrzej Siewior
Date: Sun Aug 19 21:54:58 2012 +0200
usb: gadget: dummy\_hcd: fixup error probe path
commit 1b68a4ca2d038addb7314211d122fb6d7002b38b upstream.
If USB2 host controller probes fine but USB3 does not then we don't
remove the USB controller properly and lock up the system while the HUB
code will try to enumerate the USB2 controller and access memory which
is no longer available in case the dummy\_hcd was compiled as a module.
This is a problem since 448b6eb1 ("USB: Make sure to fetch the BOS desc
for roothubs.) if used in USB3 mode because dummy does not provide this
descriptor and explodes later.
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit ed60c28a0c7861e2c5df2a985c11f757564b66a9
Author: Michael Grzeschik
Date: Wed Sep 12 14:58:01 2012 +0300
usb: chipidea: udc: add pullup fuction, needed by the uvc gadget
commit c0a48e6c75f2ac190d812bea5fc339696e434c2e upstream.
Add function to physicaly enable or disable of pullup connection on the USB-D+
line. The uvc gaget will fail, if this function is not implemented.
Signed-off-by: Michael Grzeschik
Acked-by: Felipe Balbi
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
commit 032fe3671c1efa8218ea28f145b62c16ad720960
Author: Robert Richter
Date: Thu Jul 19 18:28:26 2012 +0200
oprofile, s390: Fix uninitialized memory access when writing to oprofilefs
commit 81ff3478d9ba7f0b48b0abef740e542fd83adf79 upstream.
If oprofilefs\_ulong\_from\_user() is called with count equals zero, \*val
remains unchanged. Depending on the implementation it might be
uninitialized. Fixing users of oprofilefs\_ulong\_ from\_user().
We missed these s390 changes with:
913050b oprofile: Fix uninitialized memory access when writing to writing to oprofilefs
Signed-off-by: Robert Richter
Signed-off-by: Greg Kroah-Hartman
commit e3b569c5ff1573af7db3ea362e67e5d24ac97344
Author: Ian Chen
Date: Wed Aug 29 15:05:36 2012 +0900
mmc: card: Skip secure erase on MoviNAND; causes unrecoverable corruption.
commit 3550ccdb9d8d350e526b809bf3dd92b550a74fe1 upstream.
For several MoviNAND eMMC parts, there are known issues with secure
erase and secure trim. For these specific MoviNAND devices, we skip
these operations.
Specifically, there is a bug in the eMMC firmware that causes
unrecoverable corruption when the MMC is erased with MMC\_CAP\_ERASE
enabled.
References:
http://forum.xda-developers.com/showthread.php?t=1644364
https://plus.google.com/111398485184813224730/posts/21pTYfTsCkB#111398485184813224730/posts/21pTYfTsCkB
Signed-off-by: Ian Chen
Reviewed-by: Namjae Jeon
Acked-by: Jaehoon Chung
Reviewed-by: Linus Walleij
Signed-off-by: Chris Ball
Signed-off-by: Greg Kroah-Hartman
commit 30545f24d99ae348670402ccc193381f7e591857
Author: Ludovic Desroches
Date: Tue Jul 24 11:42:04 2012 +0200
mmc: atmel-mci: not busy flag has also to be used for read operations
commit 077d40731edc90ee9dedf63249034c8cd5f694ce upstream.
Even if the datasheet says that the not busy flag has to be used only
for write operations, it's false except for version lesser than v2xx.
Not waiting on the not busy flag for read operations can cause the
controller to hang-up during the initialization of some SD cards
with DMA after the first CMD6 -- the next command is sent too early.
Signed-off-by: Ludovic Desroches
Signed-off-by: Chris Ball
Signed-off-by: Greg Kroah-Hartman
commit 1a9422ec45b63e7d6703b5b668a750039956ba09
Author: Shawn Guo
Date: Wed Aug 22 23:10:01 2012 +0800
mmc: sdhci-esdhc: break out early if clock is 0
commit 74f330bceaa7b88d06062e1cac3d519a3dfc041e upstream.
Since commit 30832ab56 ("mmc: sdhci: Always pass clock request value
zero to set\_clock host op") was merged, esdhc\_set\_clock starts hitting
"if (clock == 0)" where ESDHC\_SYSTEM\_CONTROL has been operated. This
causes SDHCI card-detection function being broken. Fix the regression
by moving "if (clock == 0)" above ESDHC\_SYSTEM\_CONTROL operation.
Signed-off-by: Shawn Guo
Signed-off-by: Chris Ball
Signed-off-by: Greg Kroah-Hartman
commit 3dd2bf1c4b2f5feed0486d706f6020ce78ffb93c
Author: Lauri Hintsala
Date: Tue Jul 17 17:16:10 2012 +0300
mmc: mxs-mmc: fix deadlock caused by recursion loop
commit fc108d24d3a6da63576a460e122fa1df0cbdea20 upstream.
Release the lock before mmc\_signal\_sdio\_irq is called by
mxs\_mmc\_enable\_sdio\_irq.
Backtrace:
[ 65.470000] =============================================
[ 65.470000] [ INFO: possible recursive locking detected ]
[ 65.470000] 3.5.0-rc5 #2 Not tainted
[ 65.470000] ---------------------------------------------
[ 65.470000] ksdioirqd/mmc0/73 is trying to acquire lock:
[ 65.470000] (&(&host->lock)->rlock#2){-.-...}, at: [] mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc]
[ 65.470000]
[ 65.470000] but task is already holding lock:
[ 65.470000] (&(&host->lock)->rlock#2){-.-...}, at: [] mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc]
[ 65.470000]
[ 65.470000] other info that might help us debug this:
[ 65.470000] Possible unsafe locking scenario:
[ 65.470000]
[ 65.470000] CPU0
[ 65.470000] ----
[ 65.470000] lock(&(&host->lock)->rlock#2);
[ 65.470000] lock(&(&host->lock)->rlock#2);
[ 65.470000]
[ 65.470000] \*\*\* DEADLOCK \*\*\*
[ 65.470000]
[ 65.470000] May be due to missing lock nesting notation
[ 65.470000]
[ 65.470000] 1 lock held by ksdioirqd/mmc0/73:
[ 65.470000] #0: (&(&host->lock)->rlock#2){-.-...}, at: [] mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc]
[ 65.470000]
[ 65.470000] stack backtrace:
[ 65.470000] [] (unwind\_backtrace+0x0/0xf4) from [] (\_\_lock\_acquire+0x14f8/0x1b98)
[ 65.470000] [] (\_\_lock\_acquire+0x14f8/0x1b98) from [] (lock\_acquire+0xa0/0x108)
[ 65.470000] [] (lock\_acquire+0xa0/0x108) from [] (\_raw\_spin\_lock\_irqsave+0x48/0x5c)
[ 65.470000] [] (\_raw\_spin\_lock\_irqsave+0x48/0x5c) from [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc])
[ 65.470000] [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc]) from [] (mxs\_mmc\_enable\_sdio\_irq+0xc8/0xdc [mxs\_mmc])
[ 65.470000] [] (mxs\_mmc\_enable\_sdio\_irq+0xc8/0xdc [mxs\_mmc]) from [] (sdio\_irq\_thread+0x1bc/0x274)
[ 65.470000] [] (sdio\_irq\_thread+0x1bc/0x274) from [] (kthread+0x8c/0x98)
[ 65.470000] [] (kthread+0x8c/0x98) from [] (kernel\_thread\_exit+0x0/0x8)
[ 65.470000] BUG: spinlock lockup suspected on CPU#0, ksdioirqd/mmc0/73
[ 65.470000] lock: 0xc3358724, .magic: dead4ead, .owner: ksdioirqd/mmc0/73, .owner\_cpu: 0
[ 65.470000] [] (unwind\_backtrace+0x0/0xf4) from [] (do\_raw\_spin\_lock+0x100/0x144)
[ 65.470000] [] (do\_raw\_spin\_lock+0x100/0x144) from [] (\_raw\_spin\_lock\_irqsave+0x50/0x5c)
[ 65.470000] [] (\_raw\_spin\_lock\_irqsave+0x50/0x5c) from [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc])
[ 65.470000] [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xdc [mxs\_mmc]) from [] (mxs\_mmc\_enable\_sdio\_irq+0xc8/0xdc [mxs\_mmc])
[ 65.470000] [] (mxs\_mmc\_enable\_sdio\_irq+0xc8/0xdc [mxs\_mmc]) from [] (sdio\_irq\_thread+0x1bc/0x274)
[ 65.470000] [] (sdio\_irq\_thread+0x1bc/0x274) from [] (kthread+0x8c/0x98)
[ 65.470000] [] (kthread+0x8c/0x98) from [] (kernel\_thread\_exit+0x0/0x8)
Reported-by: Attila Kinali
Signed-off-by: Lauri Hintsala
Acked-by: Shawn Guo
Signed-off-by: Chris Ball
Signed-off-by: Greg Kroah-Hartman
commit f58f96c17afa66e4f67b3711c0d28ba30d97edbd
Author: Lauri Hintsala
Date: Tue Jul 17 17:16:09 2012 +0300
mmc: mxs-mmc: fix deadlock in SDIO IRQ case
commit 1af36b2a993dddfa3d6860ec4879c9e8abc9b976 upstream.
Release the lock before mmc\_signal\_sdio\_irq is called by mxs\_mmc\_irq\_handler.
Backtrace:
[ 79.660000] =============================================
[ 79.660000] [ INFO: possible recursive locking detected ]
[ 79.660000] 3.4.0-00009-g3e96082-dirty #11 Not tainted
[ 79.660000] ---------------------------------------------
[ 79.660000] swapper/0 is trying to acquire lock:
[ 79.660000] (&(&host->lock)->rlock#2){-.....}, at: [] mxs\_mmc\_enable\_sdio\_irq+0x18/0xd4
[ 79.660000]
[ 79.660000] but task is already holding lock:
[ 79.660000] (&(&host->lock)->rlock#2){-.....}, at: [] mxs\_mmc\_irq\_handler+0x1c/0xe8
[ 79.660000]
[ 79.660000] other info that might help us debug this:
[ 79.660000] Possible unsafe locking scenario:
[ 79.660000]
[ 79.660000] CPU0
[ 79.660000] ----
[ 79.660000] lock(&(&host->lock)->rlock#2);
[ 79.660000] lock(&(&host->lock)->rlock#2);
[ 79.660000]
[ 79.660000] \*\*\* DEADLOCK \*\*\*
[ 79.660000]
[ 79.660000] May be due to missing lock nesting notation
[ 79.660000]
[ 79.660000] 1 lock held by swapper/0:
[ 79.660000] #0: (&(&host->lock)->rlock#2){-.....}, at: [] mxs\_mmc\_irq\_handler+0x1c/0xe8
[ 79.660000]
[ 79.660000] stack backtrace:
[ 79.660000] [] (unwind\_backtrace+0x0/0xf4) from [] (\_\_lock\_acquire+0x1948/0x1d48)
[ 79.660000] [] (\_\_lock\_acquire+0x1948/0x1d48) from [] (lock\_acquire+0xe0/0xf8)
[ 79.660000] [] (lock\_acquire+0xe0/0xf8) from [] (\_raw\_spin\_lock\_irqsave+0x44/0x58)
[ 79.660000] [] (\_raw\_spin\_lock\_irqsave+0x44/0x58) from [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xd4)
[ 79.660000] [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xd4) from [] (mxs\_mmc\_irq\_handler+0xd4/0xe8)
[ 79.660000] [] (mxs\_mmc\_irq\_handler+0xd4/0xe8) from [] (handle\_irq\_event\_percpu+0x70/0x254)
[ 79.660000] [] (handle\_irq\_event\_percpu+0x70/0x254) from [] (handle\_irq\_event+0x3c/0x5c)
[ 79.660000] [] (handle\_irq\_event+0x3c/0x5c) from [] (handle\_level\_irq+0x90/0x110)
[ 79.660000] [] (handle\_level\_irq+0x90/0x110) from [] (generic\_handle\_irq+0x38/0x50)
[ 79.660000] [] (generic\_handle\_irq+0x38/0x50) from [] (handle\_IRQ+0x30/0x84)
[ 79.660000] [] (handle\_IRQ+0x30/0x84) from [] (\_\_irq\_svc+0x38/0x60)
[ 79.660000] [] (\_\_irq\_svc+0x38/0x60) from [] (default\_idle+0x2c/0x40)
[ 79.660000] [] (default\_idle+0x2c/0x40) from [] (cpu\_idle+0x64/0xcc)
[ 79.660000] [] (cpu\_idle+0x64/0xcc) from [] (start\_kernel+0x244/0x2c8)
[ 79.660000] BUG: spinlock lockup on CPU#0, swapper/0
[ 79.660000] lock: c398cb2c, .magic: dead4ead, .owner: swapper/0, .owner\_cpu: 0
[ 79.660000] [] (unwind\_backtrace+0x0/0xf4) from [] (do\_raw\_spin\_lock+0xf0/0x144)
[ 79.660000] [] (do\_raw\_spin\_lock+0xf0/0x144) from [] (\_raw\_spin\_lock\_irqsave+0x4c/0x58)
[ 79.660000] [] (\_raw\_spin\_lock\_irqsave+0x4c/0x58) from [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xd4)
[ 79.660000] [] (mxs\_mmc\_enable\_sdio\_irq+0x18/0xd4) from [] (mxs\_mmc\_irq\_handler+0xd4/0xe8)
[ 79.660000] [] (mxs\_mmc\_irq\_handler+0xd4/0xe8) from [] (handle\_irq\_event\_percpu+0x70/0x254)
[ 79.660000] [] (handle\_irq\_event\_percpu+0x70/0x254) from [] (handle\_irq\_event+0x3c/0x5c)
[ 79.660000] [] (handle\_irq\_event+0x3c/0x5c) from [] (handle\_level\_irq+0x90/0x110)
[ 79.660000] [] (handle\_level\_irq+0x90/0x110) from [] (generic\_handle\_irq+0x38/0x50)
[ 79.660000] [] (generic\_handle\_irq+0x38/0x50) from [] (handle\_IRQ+0x30/0x84)
[ 79.660000] [] (handle\_IRQ+0x30/0x84) from [] (\_\_irq\_svc+0x38/0x60)
[ 79.660000] [] (\_\_irq\_svc+0x38/0x60) from [] (default\_idle+0x2c/0x40)
[ 79.660000] [] (default\_idle+0x2c/0x40) from [] (cpu\_idle+0x64/0xcc)
[ 79.660000] [] (cpu\_idle+0x64/0xcc) from [] (start\_kernel+0x244/0x2c8)
Signed-off-by: Lauri Hintsala
Acked-by: Shawn Guo
Signed-off-by: Chris Ball
Signed-off-by: Greg Kroah-Hartman
commit b681c4bcca83cf7b580896907deefbbc4de1f368
Author: Aaron Lu
Date: Fri Sep 14 20:54:44 2012 +0200
ACPI / PM: Use KERN\_DEBUG when no power resources are found
commit f25b70613c048ceb1df052576fda03321ebf41cf upstream.
commit a606dac368eed5696fb38e16b1394f1d049c09e9 adds support to link
devices which have \_PRx, if a device does not have \_PRx, a warning
message will be printed.
This commit is for ZPODD on Intel ZPODD capable platforms, on other
platforms, it has no problem if there is no power resource for this
device, so a warning here is not appropriate, change it to debug.
Reported-by: Borislav Petkov
Signed-off-by: Aaron Lu
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit af01caedb95f2503ee5778f17d315240743f2921
Author: Lin Ming
Date: Fri Sep 14 00:26:33 2012 +0200
ACPI / PM: Fix resource\_lock dead lock in acpi\_power\_on\_device
commit 40bf66ec9791f1452b90b82aadc3b6e6aee201f5 upstream.
Commit 0090def("ACPI: Add interface to register/unregister device
to/from power resources") used resource\_lock to protect the devices list
that relies on power resource. It caused a mutex dead lock, as below
acpi\_power\_on ---> lock resource\_lock
\_\_acpi\_power\_on
acpi\_power\_on\_device
acpi\_power\_get\_inferred\_state
acpi\_power\_get\_list\_state ---> lock resource\_lock
This patch adds a new mutex "devices\_lock" to protect the devices list
and calls acpi\_power\_on\_device in acpi\_power\_on, instead of
\_\_acpi\_power\_on, after the resource\_lock is released.
[rjw: Changed data type of a boolean variable to bool.]
Signed-off-by: Lin Ming
Signed-off-by: Aaron Lu
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 0926f480e6a22c9705c762134efcc30ea0d05c2a
Author: Rafael J. Wysocki
Date: Fri Sep 14 00:26:24 2012 +0200
ACPI / PM: Infer parent power state from child if unknown, v2
commit 8f7412a792bc989d1bddd3c802282eec09456d57 upstream.
It turns out that there are ACPI BIOSes defining device objects with
\_PSx and without either \_PSC or \_PRx. For devices corresponding to
those ACPI objetcs \_\_acpi\_bus\_get\_power() returns ACPI\_STATE\_UNKNOWN
and their initial power states are regarded as unknown as a result.
If such a device is a parent of another power-manageable device, the
child cannot be put into a low-power state through ACPI, because
\_\_acpi\_bus\_set\_power() refuses to change power states of devices
whose parents' power states are unknown.
To work around this problem, observe that the ACPI power state of
a device cannot be higher-power (lower-number) than the power state
of its parent. Thus, if the device's \_PSC method or the
configuration of its power resources indicates that the device is
in D0, the device's parent has to be in D0 as well. Consequently,
if the parent's power state is unknown when we've just learned that
its child's power state is D0, we can safely set the parent's
power.state field to ACPI\_STATE\_D0.
Tested-by: Aaron Lu
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 19f8467b6bfdb13b3c235a0ebab98cc5a342a066
Author: Al Viro
Date: Mon Aug 20 14:59:25 2012 +0100
perf\_event: Switch to internal refcount, fix race with close()
commit a6fa941d94b411bbd2b6421ffbde6db3c93e65ab upstream.
Don't mess with file refcounts (or keep a reference to file, for
that matter) in perf\_event. Use explicit refcount of its own
instead. Deal with the race between the final reference to event
going away and new children getting created for it by use of
atomic\_long\_inc\_not\_zero() in inherit\_event(); just have the
latter free what it had allocated and return NULL, that works
out just fine (children of siblings of something doomed are
created as singletons, same as if the child of leader had been
created and immediately killed).
Signed-off-by: Al Viro
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/r/20120820135925.GG23464@ZenIV.linux.org.uk
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit dc2878098a0b35fd463fa86283265ac73dca5738
Author: Stephen Warren
Date: Fri Aug 24 21:20:15 2012 -0600
sound: tegra\_alc5632: remove HP detect GPIO inversion
commit c921928661eda599d73a6a86e58bdd5aecfa18cb upstream.
Both the schematics and practical testing show that the HP detect GPIO
is high when the headphones are plugged in. Hence, the snd\_soc\_jack\_gpio
should not specify to invert the signal.
Signed-off-by: Stephen Warren
Acked-by: Andrey Danin
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 546e54d4776683c34a1d52ee6ebbbfa7d9aa63c3
Author: Francesco Ruggeri
Date: Thu Sep 13 15:03:37 2012 -0700
fs/proc: fix potential unregister\_sysctl\_table hang
commit 6bf6104573482570f7103d3e5ddf9574db43a363 upstream.
The unregister\_sysctl\_table() function hangs if all references to its
ctl\_table\_header structure are not dropped.
This can happen sometimes because of a leak in proc\_sys\_lookup():
proc\_sys\_lookup() gets a reference to the table via lookup\_entry(), but
it does not release it when a subsequent call to sysctl\_follow\_link()
fails.
This patch fixes this leak by making sure the reference is always
dropped on return.
See also commit 076c3eed2c31 ("sysctl: Rewrite proc\_sys\_lookup
introducing find\_entry and lookup\_entry") which reorganized this code in
3.4.
Tested in Linux 3.4.4.
Signed-off-by: Francesco Ruggeri
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 038f1e830f681524b724d1a10bf1909c5f55606b
Author: Bjørn Mork
Date: Tue Sep 11 09:40:31 2012 +0200
USB: option: replace ZTE K5006-Z entry with vendor class rule
commit ba9edaa468869a8cea242a411066b0f490751798 upstream.
Fix the ZTE K5006-Z entry so that it actually matches anything
commit f1b5c997 USB: option: add ZTE K5006-Z
added a device specific entry assuming that the device would use
class/subclass/proto == ff/ff/ff like other ZTE devices. It
turns out that ZTE has started using vendor specific subclass
and protocol codes:
T: Bus=01 Lev=01 Prnt=01 Port=03 Cnt=01 Dev#= 4 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs= 1
P: Vendor=19d2 ProdID=1018 Rev= 0.00
S: Manufacturer=ZTE,Incorporated
S: Product=ZTE LTE Technologies MSM
S: SerialNumber=MF821Vxxxxxxx
C:\* #Ifs= 5 Cfg#= 1 Atr=c0 MxPwr=500mA
I:\* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=86 Prot=10 Driver=(none)
E: Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=02 Prot=05 Driver=(none)
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=02 Prot=01 Driver=(none)
E: Ad=83(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=06 Prot=00 Driver=qmi\_wwan
E: Ad=85(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
E: Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 4 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
E: Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=87(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
We do not have any information on how ZTE intend to use these
codes, but let us assume for now that the 3 sets matching
serial functions in the K5006-Z always will identify a serial
function in a ZTE device.
Cc: Thomas Schäfer
Signed-off-by: Bjørn Mork
Signed-off-by: Greg Kroah-Hartman
commit a559090fc00d465b8e96e839da61fd3e05b27bcf
Author: Ian Abbott
Date: Fri Aug 31 20:41:29 2012 +0100
staging: comedi: das08: Correct AI encoding for das08jr-16-ao
commit e6391a182865efc896cb2a8d79e07b7ac2f45b48 upstream.
The element of `das08\_boards[]` for the 'das08jr-16-ao' board has the
`ai\_encoding` member set to `das08\_encode12`. It should be set to
`das08\_encode16` same as the 'das08jr/16' board. After all, this board
has 16-bit AI resolution.
The description of the A/D LSB register at offset 0 seems incorrect in
the user manual "cio-das08jr-16-ao.pdf" as it implies that the AI
resolution is only 12 bits. The diagrams of the A/D LSB and MSB
registers show 15 data bits and a sign bit, which matches what the
software expects for the `das08\_encode16` AI encoding method.
Signed-off-by: Ian Abbott
Signed-off-by: Greg Kroah-Hartman
commit b3dfef38737262a1d46231f19b4a9be235a20d2f
Author: Ian Abbott
Date: Fri Aug 31 20:41:30 2012 +0100
staging: comedi: das08: Correct AO output for das08jr-16-ao
commit 61ed59ed09e6ad2b8395178ea5ad5f653bba08e3 upstream.
Don't zero out bits 15..12 of the data value in `das08jr\_ao\_winsn()` as
that knobbles the upper three-quarters of the output range for the
'das08jr-16-ao' board.
Signed-off-by: Ian Abbott
Signed-off-by: Greg Kroah-Hartman
commit 1a272a3cbd65bd8bd3b5ced8fe14840269252062
Author: Ian Abbott
Date: Mon Sep 3 16:39:38 2012 +0100
staging: comedi: amplc\_pci224: Fix PCI ref count
commit cadf84bfeb80e216fde328d357fe856160157d2c upstream.
When attaching a PCI device manually via the comedi driver `attach` hook
(`pci224\_attach()`) (called by the comedi core for the
`COMEDI\_DEVCONFIG` ioctl), its reference count is incremented in the
`for\_each\_pci\_dev` loop (in `pci224\_find\_pci\_dev()`). It is decremented
when the `detach` hook (`pci224\_detach()`) is called to detach the
device. However, when the PCI device is attached automatically via the
`attach\_pci` hook (`pci224\_attach\_pci()`, called at probe time via
`comedi\_pci\_auto\_config()`) it's reference count is not incremented so
there will be an unmatched decrement when detaching the device.
Increment the PCI device reference count in `pci224\_attach\_pci()` to
correct the mismatch.
Once support for manual configuration has been removed from this driver,
the calls to `pci\_dev\_get()` and `pci\_dev\_put()` can be removed.
Signed-off-by: Ian Abbott
Signed-off-by: Greg Kroah-Hartman
commit 5d1405acad9e459eeb11644a752660accab5946d
Author: Eric Dumazet
Date: Mon Sep 10 21:22:11 2012 +0200
staging: r8712u: fix bug in r8712\_recv\_indicatepkt()
commit abf02cfc179bb4bd30d05f582d61b3b8f429b813 upstream.
64bit arches have a buggy r8712u driver, let's fix it.
skb->tail must be set properly or network stack behavior is undefined.
Addresses https://bugzilla.redhat.com/show\_bug.cgi?id=847525
Addresses https://bugzilla.kernel.org/show\_bug.cgi?id=45071
Signed-off-by: Eric Dumazet
Cc: Dave Jones
Acked-by: Larry Finger
Signed-off-by: Greg Kroah-Hartman
commit bc6f2e80304f2d520fd2f6d57b643f1e4f077be9
Author: Malcolm Priestley
Date: Wed Aug 29 23:08:21 2012 +0100
staging: vt6656: [BUG] - Failed connection, incorrect endian.
commit aa209eef3ce8419ff2926c2fa944dfbfb5afbacb upstream.
Hi,
This patch fixes a bug with driver failing to negotiate a connection.
The bug was traced to commit
203e4615ee9d9fa8d3506b9d0ef30095e4d5bc90
staging: vt6656: removed custom definitions of Ethernet packet types
In that patch, definitions in include/linux/if\_ether.h replaced ones
in tether.h which had both big and little endian definitions.
include/linux/if\_ether.h only refers to big endian values, cpu\_to\_be16
should be used for the correct endian architectures.
Signed-off-by: Malcolm Priestley
Signed-off-by: Greg Kroah-Hartman
commit 7b1ad160f6932d0934fcab5b34bd51620b3fe23f
Author: Seth Jennings
Date: Wed Aug 29 16:58:45 2012 -0500
staging: zcache: fix cleancache race condition with shrinker
commit 6d7d9798ad5c97ee4e911dd070dc12dc5ae55bd0 upstream.
This patch fixes a race condition that results in memory
corruption when using cleancache.
The race exists between the zcache shrinker handler,
shrink\_zcache\_memory() and cleancache\_get\_page().
In most cases, the shrinker will both evict a zbpg
from its buddy list and flush it from tmem before a
cleancache\_get\_page() occurs on that page. A subsequent
cleancache\_get\_page() will fail in the tmem layer.
In the rare case that two occur together and the
cleancache\_get\_page() path gets through the tmem
layer before the shrinker path can flush tmem,
zbud\_decompress() does a check to see if the zbpg is a
"zombie", i.e. not on a buddy list, which means the shrinker
is in the process of reclaiming it. If the zbpg is a zombie,
zbud\_decompress() returns -EINVAL.
However, this return code is being ignored by the caller,
zcache\_pampd\_get\_data\_and\_free(), which results in the
caller of cleancache\_get\_page() thinking that the page has
been properly retrieved when it has not.
This patch modifies zcache\_pampd\_get\_data\_and\_free() to
convey the failure up the stack so that the caller of
cleancache\_get\_page() knows the page retrieval failed.
This needs to be applied to stable trees as well.
zcache-main.c was named zcache.c before v3.1, so
I'm not sure how you want to handle trees earlier
than that.
Signed-off-by: Seth Jennings
Reviewed-by: Konrad Rzeszutek Wilk
Reviewed-by: Minchan Kim
Signed-off-by: Greg Kroah-Hartman
commit def222114749513b41e047851a98bffdf6dfd2e2
Author: Christopher Brannon
Date: Sat Jun 16 16:55:20 2012 -0500
Staging: speakup: fix an improperly-declared variable.
commit 4ea418b8b2fa8a70d0fcc8231b65e67b3a72984b upstream.
A local static variable was declared as a pointer to a string
constant. We're assigning to the underlying memory, so it
needs to be an array instead.
Signed-off-by: Christopher Brannon
Signed-off-by: Greg Kroah-Hartman
commit fd7e78f57986f831eb0530e6c191eef9982781c3
Author: Takashi Iwai
Date: Thu Sep 20 07:44:11 2012 +0200
ALSA: hda - Workaround for silent output on VAIO Z with ALC889
commit e427c2375646789ecd0ccaef1a1e41458559ab2d upstream.
On recent kernels, Realtek codec parser tries to optimize the routing
aggressively and take the headphone output as primary at first. This
caused a regression on VAIO Z with ALC889, the silent output from the
speaker.
The problem seems that the speaker pin must be connected to the first
DAC (0x02) on this machine by some reason although the codec itself
advertises the flexible routing with any DACs.
This patch adds a fix-up for choosing the speaker pin as the primary
so that the right DAC is assigned on this device.
Reported-and-tested-by: Adam Williamson
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3b536d48a7ac408ed9c448e524ad6de22dd1b466
Author: Matteo Frigo
Date: Wed Sep 12 10:12:06 2012 -0400
ALSA: ice1724: Use linear scale for AK4396 volume control.
commit 3737e2be505d872bf2b3c1cd4151b2d2b413d7b5 upstream.
The AK4396 DAC has a linear-scale attentuator, but
sound/pci/ice1712/prodigy\_hifi.c used a log scale instead, which is
not quite right. This patch restores the correct scale, borrowing
from the ak4396 code in sound/pci/oxygen/oxygen.c.
Signed-off-by: Matteo Frigo
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 31b03dea1f35abfc97d0a005b6652344d2a856c5
Author: Takashi Iwai
Date: Mon Sep 10 09:39:31 2012 +0200
ALSA: hda - Fix Oops at codec reset/reconfig
commit 07dc59f0988cb54fd87bd373b3b27eb2401dd811 upstream.
snd\_hda\_codec\_reset() calls restore\_pincfgs() where the codec is
powered up again, which eventually tries to resume and initialize via
the callbacks of the codec. However, it's the place just after codec
free callback, thus no codec callbacks should be called after that.
On a codec like CS4206, it results in Oops due to the access in init
callback.
This patch fixes the issue by clearing the codec callbacks properly
after freeing codec.
Reported-by: Daniel J Blueman
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ea026e7f8bde9b0906137b06a70b22d706d3c0c5
Author: Takashi Iwai
Date: Thu Sep 6 14:58:00 2012 +0200
ALSA: usb-audio: Fix bogus error messages for delay accounting
commit 1213a205f9ed27d97de3d5bed28fb085ef4853e2 upstream.
The recent fix for the missing fine delayed time adjustment gives
strange error messages at each start of the playback stream, such as
delay: estimated 0, actual 352
delay: estimated 353, actual 705
These come from the sanity check in retire\_playback\_urb(). Before the
stream is activated via start\_endpoints(), a few silent packets have
been already sent. And at this point the delay account is still in
the state as if the new packets are just queued, so the driver gets
confused and spews the bogus error messages.
For fixing the issue, we just need to check whether the received
packet is valid, whether it's zero sized or not.
Reported-by: Markus Trippelsdorf
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ffe018be7b6f3b423654d64980b1b1119bfc3fda
Author: Takashi Iwai
Date: Thu Sep 6 10:10:11 2012 +0200
ALSA: hda - Fix missing Master volume for STAC9200/925x
commit ab548d2dba63ba947287965e525cc02a15d9853d upstream.
With the commit [2faa3bf: ALSA: hda - Rewrite the mute-LED hook with
vmaster hook in patch\_sigmatel.c], the former Master volume control
was converted to PCM. This was supposed to be covered by the vmaster
control. But due to the lack of "PCM" slave definition, this didn't
happen properly. The patch fixes the missing entry.
Reported-by: Andrew Shadura
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3278d2dabeb899922faf4069861e150f72f28bc1
Author: Russell King
Date: Sat Aug 25 09:03:15 2012 +0100
ARM: Fix ioremap() of address zero
commit a849088aa1552b1a28eea3daff599ee22a734ae3 upstream.
Murali Nalajala reports a regression that ioremapping address zero
results in an oops dump:
Unable to handle kernel paging request at virtual address fa200000
pgd = d4f80000
[fa200000] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 0 Tainted: G W (3.4.0-g3b5f728-00009-g638207a #13)
PC is at msm\_pm\_config\_rst\_vector\_before\_pc+0x8/0x30
LR is at msm\_pm\_boot\_config\_before\_pc+0x18/0x20
pc : [] lr : [] psr: a0000093
sp : c0837ef0 ip : cfe00000 fp : 0000000d
r10: da7efc17 r9 : 225c4278 r8 : 00000006
r7 : 0003c000 r6 : c085c824 r5 : 00000001 r4 : fa101000
r3 : fa200000 r2 : c095080c r1 : 002250fc r0 : 00000000
Flags: NzCv IRQs off FIQs on Mode SVC\_32 ISA ARM Segment kernel
Control: 10c5387d Table: 25180059 DAC: 00000015
[] (msm\_pm\_config\_rst\_vector\_before\_pc+0x8/0x30) from [] (msm\_pm\_boot\_config\_before\_pc+0x18/0x20)
[] (msm\_pm\_boot\_config\_before\_pc+0x18/0x20) from [] (msm\_pm\_power\_collapse+0x410/0xb04)
[] (msm\_pm\_power\_collapse+0x410/0xb04) from [] (arch\_idle+0x294/0x3e0)
[] (arch\_idle+0x294/0x3e0) from [] (default\_idle+0x18/0x2c)
[] (default\_idle+0x18/0x2c) from [] (cpu\_idle+0x90/0xe4)
[] (cpu\_idle+0x90/0xe4) from [] (rest\_init+0x88/0xa0)
[] (rest\_init+0x88/0xa0) from [] (start\_kernel+0x3a8/0x40c)
Code: c0704256 e12fff1e e59f2020 e5923000 (e5930000)
This is caused by the 'reserved' entries which we insert (see
19b52abe3c5d7 - ARM: 7438/1: fill possible PMD empty section gaps)
which get matched for physical address zero.
Resolve this by marking these reserved entries with a different flag.
Tested-by: Murali Nalajala
Acked-by: Nicolas Pitre
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 9c7911680824e4aa89bf5247ffae0e38bf5c45bb
Author: Fabio Estevam
Date: Mon Aug 20 09:39:22 2012 -0300
ARM: clk-imx35: Fix SSI clock registration
commit 48540058612786d365602f3324ed97f9071092de upstream.
SSI block has two types of clock:
ipg: bus clock, the clock needed for accessing registers.
per: peripheral clock, the clock needed for generating the bit rate.
Currently SSI driver only supports slave mode and only need to handle
the ipg clock, because the peripheral clock comes from the master codec.
Only register the ipg clock and do not register the peripheral clock for ssi.
Signed-off-by: Fabio Estevam
Tested-by: Mark Brown
Signed-off-by: Sascha Hauer
Signed-off-by: Greg Kroah-Hartman
commit b8e2903a1a8da1565e6825cac6e8a7a6a8b0c4b6
Author: Fabio Estevam
Date: Sun Aug 19 14:05:59 2012 -0300
ARM: clk-imx25: Fix SSI clock registration
commit 912bfe76528c287bc4812521b8d53366954b39a5 upstream.
SSI block has two types of clock:
ipg: bus clock, the clock needed for accessing registers.
per: peripheral clock, the clock needed for generating the bit rate.
Currently SSI driver only supports slave mode and only need to handle
the ipg clock, because the peripheral clock comes from the master codec.
Only register the ipg clock and do not register the peripheral clock for ssi.
Signed-off-by: Fabio Estevam
Signed-off-by: Sascha Hauer
Signed-off-by: Greg Kroah-Hartman
commit 60d75eff5b41399b9a367874aef33d9f7355c50f
Author: Igor Grinberg
Date: Tue Aug 28 01:26:14 2012 +0300
ARM: OMAP: timer: obey the !CONFIG\_OMAP\_32K\_TIMER
commit 45caae74d238ef6583e9402cb8c550cc0b0f7dbd upstream.
Currently, omap2\_sync32k\_clocksource\_init() function initializes the 32K
timer as the system clock source regardless of the CONFIG\_OMAP\_32K\_TIMER
setting.
Fix this by providing a default implementation for
!CONFIG\_OMAP\_32K\_TIMER case.
Signed-off-by: Igor Grinberg
Reviewed-by: Paul Walmsley
Acked-by: Santosh Shilimkar
Signed-off-by: Tony Lindgren
Signed-off-by: Greg Kroah-Hartman
commit 6c77ffffb6a2174d83430e4301098eec75a4e214
Author: Dae S. Kim
Date: Fri Aug 31 02:00:51 2012 +0200
Staging: Android alarm: IOCTL command encoding fix
commit 6bd4a5d96c08dc2380f8053b1bd4f879f55cd3c9 upstream.
Fixed a bug. Data was being written to user space using an IOCTL
command encoded with \_IOC\_WRITE access mode.
Signed-off-by: Dae S. Kim
Signed-off-by: Greg Kroah-Hartman
commit 7951bef55a24041c91377ee67ad06a361aea42d0
Author: Russell King
Date: Fri Sep 7 18:22:28 2012 +0100
ARM: 7527/1: uaccess: explicitly check \_\_user pointer when !CPU\_USE\_DOMAINS
commit 8404663f81d212918ff85f493649a7991209fa04 upstream.
The {get,put}\_user macros don't perform range checking on the provided
\_\_user address when !CPU\_HAS\_DOMAINS.
This patch reworks the out-of-line assembly accessors to check the user
address against a specified limit, returning -EFAULT if is is out of
range.
[will: changed get\_user register allocation to match put\_user]
[rmk: fixed building on older ARM architectures]
Reported-by: Catalin Marinas
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit c11bc85ae982aba3e1cb85a7e9ff6c4a53d5ea2c
Author: Will Deacon
Date: Fri Sep 7 18:21:44 2012 +0100
ARM: 7526/1: traps: send SIGILL if get\_user fails on undef handling path
commit 2b2040af0b64cd93e5d4df2494c4486cf604090d upstream.
get\_user may fail to load from the provided \_\_user address due to an
unhandled fault generated by the access.
In the case of the undefined instruction trap, this results in failure
to load the faulting instruction, in which case we should send SIGILL to
the task rather than continue with potentially uninitialised data.
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit c8dcc7a99a88d7e5249cd20ff0532098738d7a27
Author: David Brown
Date: Tue Sep 4 21:36:37 2012 +0100
ARM: 7513/1: Make sure dtc is built before running it
commit 70b0476a2394de4f4e32e0b67288d80ff71ca963 upstream.
'make dtbs' in a clean tree will try running the dtc before actually
building it. Make these rules depend upon the scripts to build it.
Signed-off-by: David Brown
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 0b8bc8a2d1e5f5fcd19c90aece2712bdd86b5c2d
Author: Will Deacon
Date: Fri Aug 24 15:20:59 2012 +0100
ARM: 7501/1: decompressor: reset ttbcr for VMSA ARMv7 cores
commit dbece45894d3ab1baac15a96dc4e1e8e23f64a93 upstream.
When enabling the MMU for ARMv7 CPUs, the decompressor does not touch
the ttbcr register, assuming that it will be zeroed (N == 0, EAE == 0).
Given that only EAE is defined as 0 for non-secure copies of the
register (and a bootloader such as kexec may leave it set to 1 anyway),
we should ensure that we reset the register ourselves before turning on
the MMU.
This patch zeroes TTBCR.EAE and TTBCR.N prior to enabling the MMU for
ARMv7 cores in the decompressor, configuring us exclusively for 32-bit
translation tables via TTBR0.
Acked-by: Nicolas Pitre
Signed-off-by: Matthew Leach
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 868e5529c2686befc556cca687069bea4d426326
Author: Will Deacon
Date: Thu Aug 16 18:55:44 2012 +0100
ARM: 7496/1: hw\_breakpoint: don't rely on dfsr to show watchpoint access type
commit bf8801145c01ab600f8df66e8c879ac642fa5846 upstream.
From ARM debug architecture v7.1 onwards, a watchpoint exception causes
the DFAR to be updated with the faulting data address. However, DFSR.WnR
takes an UNKNOWN value and therefore cannot be used in general to
determine the access type that triggered the watchpoint.
This patch forbids watchpoints without an overflow handler from
specifying a specific access type (load/store). Those with overflow
handlers must be able to handle false positives potentially triggered by
a watchpoint of a different access type on the same address. For
SIGTRAP-based handlers (i.e. ptrace), this should have no impact.
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 613401671e4b54a5814c49c8c81917fcb3435292
Author: Paolo Bonzini
Date: Wed Sep 5 17:09:14 2012 +0200
target: simplify code around transport\_get\_sense\_data
commit 27a2709912ac19c755d34c79fe11994b0bf8082b upstream.
The error conditions in transport\_get\_sense\_data are superfluous
and complicate the code unnecessarily:
\* SCF\_TRANSPORT\_TASK\_SENSE is checked in the caller;
\* it's simply part of the invariants of dev->transport->get\_sense\_buffer
that it must be there if transport\_complete ever returns 1, and that
it must not return NULL. Besides, the entire callback will disappear
with the next patch.
\* similarly in the caller we can expect that sense data is only sent
for non-zero cmd->scsi\_status.
Signed-off-by: Paolo Bonzini
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 42740e446939b3e4c9b4798950371c87f483c6f6
Author: Nicholas Bellinger
Date: Thu Aug 16 15:33:10 2012 -0700
target: Fix ->data\_length re-assignment bug with SCSI overflow
commit 4c054ba63ad47ef244cfcfa1cea38134620a5bae upstream.
This patch fixes a long-standing bug with SCSI overflow handling
where se\_cmd->data\_length was incorrectly being re-assigned to
the larger CDB extracted allocation length, resulting in a number
of fabric level errors that would end up causing a session reset
in most cases. So instead now:
- Only re-assign se\_cmd->data\_length durining UNDERFLOW (to use the
smaller value)
- Use existing se\_cmd->data\_length for OVERFLOW (to use the smaller
value)
This fix has been tested with the following CDB to generate an
SCSI overflow:
sg\_raw -r512 /dev/sdc 28 0 0 0 0 0 0 0 9 0
Tested using iscsi-target, tcm\_qla2xxx, loopback and tcm\_vhost fabric
ports. Here is a bit more detail on each case:
- iscsi-target: Bug with open-iscsi with overflow, sg\_raw returns
-3584 bytes of data.
- tcm\_qla2xxx: Working as expected, returnins 512 bytes of data
- loopback: sg\_raw returns CHECK\_CONDITION, from overflow rejection
in transport\_generic\_map\_mem\_to\_cmd()
- tcm\_vhost: Same as loopback
Reported-by: Roland Dreier
Cc: Roland Dreier
Cc: Christoph Hellwig
Cc: Boaz Harrosh
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 4c1f9c2ac4d937c0be1dfa936431aedddea18b3a
Author: Tyler Hicks
Date: Thu Sep 13 12:00:56 2012 -0700
eCryptfs: Copy up attributes of the lower target inode after rename
commit 8335eafc2859e1a26282bef7c3d19f3d68868b8a upstream.
After calling into the lower filesystem to do a rename, the lower target
inode's attributes were not copied up to the eCryptfs target inode. This
resulted in the eCryptfs target inode staying around, rather than being
evicted, because i\_nlink was not updated for the eCryptfs inode. This
also meant that eCryptfs didn't do the final iput() on the lower target
inode so it stayed around, as well. This would result in a failure to
free up space occupied by the target file in the rename() operation.
Both target inodes would eventually be evicted when the eCryptfs
filesystem was unmounted.
This patch calls fsstack\_copy\_attr\_all() after the lower filesystem
does its ->rename() so that important inode attributes, such as i\_nlink,
are updated at the eCryptfs layer. ecryptfs\_evict\_inode() is now called
and eCryptfs can drop its final reference on the lower inode.
http://launchpad.net/bugs/561129
Signed-off-by: Tyler Hicks
Tested-by: Colin Ian King
Signed-off-by: Greg Kroah-Hartman
commit 1f985249b885070551c839be0612cfaf0f1ad81c
Author: Amerigo Wang
Date: Sat Aug 18 07:02:20 2012 +0000
netconsole: remove a redundant netconsole\_target\_put()
commit 72d3eb13b5c0abe7d63efac41f39c5b644c7bbaa upstream.
This netconsole\_target\_put() is obviously redundant, and it
causes a kernel segfault when removing a bridge device which has
netconsole running on it.
This is caused by:
commit 8d8fc29d02a33e4bd5f4fa47823c1fd386346093
Author: Amerigo Wang
Date: Thu May 19 21:39:10 2011 +0000
netpoll: disable netpoll when enslave a device
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dcfbe9a59979e9e48dae79bd3525d10c71b9fe50
Author: Miklos Szeredi
Date: Mon Sep 17 22:31:38 2012 +0200
vfs: dcache: use DCACHE\_DENTRY\_KILLED instead of DCACHE\_DISCONNECTED in d\_kill()
commit b161dfa6937ae46d50adce8a7c6b12233e96e7bd upstream.
IBM reported a soft lockup after applying the fix for the rename\_lock
deadlock. Commit c83ce989cb5f ("VFS: Fix the nfs sillyrename regression
in kernel 2.6.38") was found to be the culprit.
The nfs sillyrename fix used DCACHE\_DISCONNECTED to indicate that the
dentry was killed. This flag can be set on non-killed dentries too,
which results in infinite retries when trying to traverse the dentry
tree.
This patch introduces a separate flag: DCACHE\_DENTRY\_KILLED, which is
only set in d\_kill() and makes try\_to\_ascend() test only this flag.
IBM reported successful test results with this patch.
Signed-off-by: Miklos Szeredi
Cc: Trond Myklebust
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a89e4f5934b734f1fa24eb0013a3a32158ee1a8b
Author: Linus Torvalds
Date: Fri Sep 14 14:48:21 2012 -0700
vfs: make O\_PATH file descriptors usable for 'fstat()'
commit 55815f70147dcfa3ead5738fd56d3574e2e3c1c2 upstream.
We already use them for openat() and friends, but fstat() also wants to
be able to use O\_PATH file descriptors. This should make it more
directly comparable to the O\_SEARCH of Solaris.
Note that you could already do the same thing with "fstatat()" and an
empty path, but just doing "fstat()" directly is simpler and faster, so
there is no reason not to just allow it directly.
See also commit 332a2e1244bd, which did the same thing for fchdir, for
the same reasons.
Reported-by: ольга крыжановская
Cc: Al Viro
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 739b195387af0cea560925daa550b3ebca923642
Author: Stephen M. Cameron
Date: Fri Sep 14 16:35:10 2012 -0500
cciss: fix handling of protocol error
commit 2453f5f992717251cfadab6184fbb3ec2f2e8b40 upstream.
If a command completes with a status of CMD\_PROTOCOL\_ERR, this
information should be conveyed to the SCSI mid layer, not dropped
on the floor. Unlike a similar bug in the hpsa driver, this bug
only affects tape drives and CD and DVD ROM drives in the cciss
driver, and to induce it, you have to disconnect (or damage) a
cable, so it is not a very likely scenario (which would explain
why the bug has gone undetected for the last 10 years.)
Signed-off-by: Stephen M. Cameron
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 452310ee930ccdf7ddb267279e56f2472ec7d163
Author: Tejun Heo
Date: Tue Sep 18 14:24:59 2012 -0700
cpufreq/powernow-k8: workqueue user shouldn't migrate the kworker to another CPU
commit 6889125b8b4e09c5e53e6ecab3433bed1ce198c9 upstream.
powernowk8\_target() runs off a per-cpu work item and if the
cpufreq\_policy->cpu is different from the current one, it migrates the
kworker to the target CPU by manipulating current->cpus\_allowed. The
function migrates the kworker back to the original CPU but this is
still broken. Workqueue concurrency management requires the kworkers
to stay on the same CPU and powernowk8\_target() ends up triggerring
BUG\_ON(rq != this\_rq()) in try\_to\_wake\_up\_local() if it contends on
fidvid\_mutex and sleeps.
It is unclear why this bug is being reported now. Duncan says it
appeared to be a regression of 3.6-rc1 and couldn't reproduce it on
3.5. Bisection seemed to point to 63d95a91 "workqueue: use @pool
instead of @gcwq or @cpu where applicable" which is an non-functional
change. Given that the reproduce case sometimes took upto days to
trigger, it's easy to be misled while bisecting. Maybe something made
contention on fidvid\_mutex more likely? I don't know.
This patch fixes the bug by using work\_on\_cpu() instead if @pol->cpu
isn't the same as the current one. The code assumes that
cpufreq\_policy->cpu is kept online by the caller, which Rafael tells
me is the case.
stable: ed48ece27c ("workqueue: reimplement work\_on\_cpu() using
system\_wq") should be applied before this; otherwise, the
behavior could be horrible.
Signed-off-by: Tejun Heo
Reported-by: Duncan <1i5t5.duncan@cox.net>
Tested-by: Duncan <1i5t5.duncan@cox.net>
Cc: Rafael J. Wysocki
Cc: Andreas Herrmann
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=47301
Signed-off-by: Greg Kroah-Hartman
commit a88ff36aef1f343074151a58926c5290e6c82b1e
Author: Tejun Heo
Date: Tue Sep 18 12:48:43 2012 -0700
workqueue: reimplement work\_on\_cpu() using system\_wq
commit ed48ece27cd3d5ee0354c32bbaec0f3e1d4715c3 upstream.
The existing work\_on\_cpu() implementation is hugely inefficient. It
creates a new kthread, execute that single function and then let the
kthread die on each invocation.
Now that system\_wq can handle concurrent executions, there's no
advantage of doing this. Reimplement work\_on\_cpu() using system\_wq
which makes it simpler and way more efficient.
stable: While this isn't a fix in itself, it's needed to fix a
workqueue related bug in cpufreq/powernow-k8. AFAICS, this
shouldn't break other existing users.
Signed-off-by: Tejun Heo
Acked-by: Jiri Kosina
Cc: Linus Torvalds
Cc: Bjorn Helgaas
Cc: Len Brown
Cc: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 2ae5c3271419d2f294b2caf00aed7ac1f50760a6
Author: Jesse Gross
Date: Fri May 25 11:29:30 2012 -0700
openvswitch: Reset upper layer protocol info on internal devices.
[ Upstream commit 7fe99e2d434eafeac0c57b279a77e5de39212636 ]
It's possible that packets that are sent on internal devices (from
the OVS perspective) have already traversed the local IP stack.
After they go through the internal device, they will again travel
through the IP stack which may get confused by the presence of
existing information in the skb. The problem can be observed
when switching between namespaces. This clears out that information
to avoid problems but deliberately leaves other metadata alone.
This is to provide maximum flexibility in chaining together OVS
and other Linux components.
Signed-off-by: Jesse Gross
Signed-off-by: Greg Kroah-Hartman
commit a1c5f84b226548a62f9a78d491d777a8f1dbd5c6
Author: Jaccon Bastiaansen
Date: Mon Aug 27 11:53:51 2012 +0000
cs89x0 : packet reception not working
[ Upstream commit b72c200975a4ed579dbf3353019e19528745a29a ]
The RxCFG register of the CS89x0 could be configured incorrectly
(because of misplaced parentheses), resulting in the disabling
of packet reception.
Signed-off-by: Jaccon Bastiaansen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 06d3f370de6bf23d93629329255d3778641d6d02
Author: Yuval Mintz
Date: Sun Aug 26 00:35:45 2012 +0000
bnx2x: fix 57840\_MF pci id
[ Upstream commit 5c879d2094946081af934739850c7260e8b25d3c ]
Commit c3def943c7117d42caaed3478731ea7c3c87190e have added support for
new pci ids of the 57840 board, while failing to change the obsolete value
in 'pci\_ids.h'.
This patch does so, allowing the probe of such devices.
Signed-off-by: Yuval Mintz
Signed-off-by: Eilon Greenstein
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d7648ad12f80e2790b7479945538fd8850e76eae
Author: Francesco Ruggeri
Date: Fri Aug 24 07:38:35 2012 +0000
net: ipv4: ipmr\_expire\_timer causes crash when removing net namespace
[ Upstream commit acbb219d5f53821b2d0080d047800410c0420ea1 ]
When tearing down a net namespace, ipv4 mr\_table structures are freed
without first deactivating their timers. This can result in a crash in
run\_timer\_softirq.
This patch mimics the corresponding behaviour in ipv6.
Locking and synchronization seem to be adequate.
We are about to kfree mrt, so existing code should already make sure that
no other references to mrt are pending or can be created by incoming traffic.
The functions invoked here do not cause new references to mrt or other
race conditions to be created.
Invoking del\_timer\_sync guarantees that ipmr\_expire\_timer is inactive.
Both ipmr\_expire\_process (whose completion we may have to wait in
del\_timer\_sync) and mroute\_clean\_tables internally use mfc\_unres\_lock
or other synchronizations when needed, and they both only modify mrt.
Tested in Linux 3.4.8.
Signed-off-by: Francesco Ruggeri
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 25a29dec42e8c89e3de2e5d3a8f3e246f3640d06
Author: xeb@mail.ru
Date: Fri Aug 24 01:07:38 2012 +0000
l2tp: avoid to use synchronize\_rcu in tunnel free function
[ Upstream commit 99469c32f79a32d8481f87be0d3c66dad286f4ec ]
Avoid to use synchronize\_rcu in l2tp\_tunnel\_free because context may be
atomic.
Signed-off-by: Dmitry Kozlov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 440de22d93f91d12eb351692b64a349a80668e91
Author: Claudiu Manoil
Date: Thu Aug 23 21:46:25 2012 +0000
gianfar: fix default tx vlan offload feature flag
[ Upstream commit e2c53be223aca36cf93eb6a0f6bafa079e78f52b ]
Commit -
"b852b72 gianfar: fix bug caused by
87c288c6e9aa31720b72e2bc2d665e24e1653c3e"
disables by default (on mac init) the hw vlan tag insertion.
The "features" flags were not updated to reflect this, and
"ethtool -K" shows tx-vlan-offload to be "on" by default.
Cc: Sebastian Poehn
Signed-off-by: Claudiu Manoil
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e6bd493b9fa829986c9221e0ea507ff53ce9e068
Author: Ben Hutchings
Date: Wed Aug 15 18:09:15 2012 +0100
sfc: Fix reporting of IPv4 full filters through ethtool
[ Upstream commit ac70b2e9a13423b5efa0178e081936ce6979aea5 ]
ETHTOOL\_GRXCLSRULE returns filters for a TCP/IPv4 or UDP/IPv4 4-tuple
with source and destination swapped.
Signed-off-by: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 1d7b926e92f37be1a45ada2c3bdce9970a53cb93
Author: Yuchung Cheng
Date: Thu Aug 23 07:05:17 2012 +0000
tcp: fix cwnd reduction for non-sack recovery
[ Upstream commit 7c4a56fec379ac0d7754e0d4da6a7361f1a4fe64 ]
The cwnd reduction in fast recovery is based on the number of packets
newly delivered per ACK. For non-sack connections every DUPACK
signifies a packet has been delivered, but the sender mistakenly
skips counting them for cwnd reduction.
The fix is to compute newly\_acked\_sacked after DUPACKs are accounted
in sacked\_out for non-sack connections.
Signed-off-by: Yuchung Cheng
Acked-by: Nandita Dukkipati
Acked-by: Neal Cardwell
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2dfd8abf6c1f5ec34730dc72f2c4a4f31c6b8dc6
Author: Pablo Neira Ayuso
Date: Thu Aug 23 02:09:11 2012 +0000
netlink: fix possible spoofing from non-root processes
[ Upstream commit 20e1db19db5d6b9e4e83021595eab0dc8f107bef ]
Non-root user-space processes can send Netlink messages to other
processes that are well-known for being subscribed to Netlink
asynchronous notifications. This allows ilegitimate non-root
process to send forged messages to Netlink subscribers.
The userspace process usually verifies the legitimate origin in
two ways:
a) Socket credentials. If UID != 0, then the message comes from
some ilegitimate process and the message needs to be dropped.
b) Netlink portID. In general, portID == 0 means that the origin
of the messages comes from the kernel. Thus, discarding any
message not coming from the kernel.
However, ctnetlink sets the portID in event messages that has
been triggered by some user-space process, eg. conntrack utility.
So other processes subscribed to ctnetlink events, eg. conntrackd,
know that the event was triggered by some user-space action.
Neither of the two ways to discard ilegitimate messages coming
from non-root processes can help for ctnetlink.
This patch adds capability validation in case that dst\_pid is set
in netlink\_sendmsg(). This approach is aggressive since existing
applications using any Netlink bus to deliver messages between
two user-space processes will break. Note that the exception is
NETLINK\_USERSOCK, since it is reserved for netlink-to-netlink
userspace communication.
Still, if anyone wants that his Netlink bus allows netlink-to-netlink
userspace, then they can set NL\_NONROOT\_SEND. However, by default,
I don't think it makes sense to allow to use NETLINK\_ROUTE to
communicate two processes that are sending no matter what information
that is not related to link/neighbouring/routing. They should be using
NETLINK\_USERSOCK instead for that.
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7d34ab836a0130db7643b55eb8713726ef704b52
Author: Eric Dumazet
Date: Tue Aug 21 06:21:17 2012 +0000
af\_netlink: force credentials passing [CVE-2012-3520]
[ Upstream commit e0e3cea46d31d23dc40df0a49a7a2c04fe8edfea ]
Pablo Neira Ayuso discovered that avahi and
potentially NetworkManager accept spoofed Netlink messages because of a
kernel bug. The kernel passes all-zero SCM\_CREDENTIALS ancillary data
to the receiver if the sender did not provide such data, instead of not
including any such data at all or including the correct data from the
peer (as it is the case with AF\_UNIX).
This bug was introduced in commit 16e572626961
(af\_unix: dont send SCM\_CREDENTIALS by default)
This patch forces passing credentials for netlink, as
before the regression.
Another fix would be to not add SCM\_CREDENTIALS in
netlink messages if not provided by the sender, but it
might break some programs.
With help from Florian Weimer & Petr Matousek
This issue is designated as CVE-2012-3520
Signed-off-by: Eric Dumazet
Cc: Petr Matousek
Cc: Florian Weimer
Cc: Pablo Neira Ayuso
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c182b9556632ce565dc7ecbb49759334628f75bb
Author: Eric Leblond
Date: Thu Aug 16 22:02:58 2012 +0000
af\_packet: don't emit packet on orig fanout group
[ Upstream commit c0de08d04215031d68fa13af36f347a6cfa252ca ]
If a packet is emitted on one socket in one group of fanout sockets,
it is transmitted again. It is thus read again on one of the sockets
of the fanout group. This result in a loop for software which
generate packets when receiving one.
This retransmission is not the intended behavior: a fanout group
must behave like a single socket. The packet should not be
transmitted on a socket if it originates from a socket belonging
to the same fanout group.
This patch fixes the issue by changing the transmission check to
take fanout group info account.
Reported-by: Aleksandr Kotov
Signed-off-by: Eric Leblond
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d8c8c1837a00c6da2522add7297af65166a23306
Author: Mathias Krause
Date: Wed Aug 15 11:31:57 2012 +0000
net: fix info leak in compat dev\_ifconf()
[ Upstream commit 43da5f2e0d0c69ded3d51907d9552310a6b545e8 ]
The implementation of dev\_ifconf() for the compat ioctl interface uses
an intermediate ifc structure allocated in userland for the duration of
the syscall. Though, it fails to initialize the padding bytes inserted
for alignment and that for leaks four bytes of kernel stack. Add an
explicit memset(0) before filling the structure to avoid the info leak.
Signed-off-by: Mathias Krause
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit deec7451985732043ec92eb3925ba4f08df8a5d9
Author: Mathias Krause
Date: Wed Aug 15 11:31:56 2012 +0000
ipvs: fix info leak in getsockopt(IP\_VS\_SO\_GET\_TIMEOUT)
[ Upstream commit 2d8a041b7bfe1097af21441cb77d6af95f4f4680 ]
If at least one of CONFIG\_IP\_VS\_PROTO\_TCP or CONFIG\_IP\_VS\_PROTO\_UDP is
not set, \_\_ip\_vs\_get\_timeouts() does not fully initialize the structure
that gets copied to userland and that for leaks up to 12 bytes of kernel
stack. Add an explicit memset(0) before passing the structure to
\_\_ip\_vs\_get\_timeouts() to avoid the info leak.
Signed-off-by: Mathias Krause
Cc: Wensong Zhang
Cc: Simon Horman
Cc: Julian Anastasov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 303490bccf35e44a4ea722e272d97843e71018e7
Author: Mathias Krause
Date: Wed Aug 15 11:31:55 2012 +0000
dccp: fix info leak via getsockopt(DCCP\_SOCKOPT\_CCID\_TX\_INFO)
[ Upstream commit 7b07f8eb75aa3097cdfd4f6eac3da49db787381d ]
The CCID3 code fails to initialize the trailing padding bytes of struct
tfrc\_tx\_info added for alignment on 64 bit architectures. It that for
potentially leaks four bytes kernel stack via the getsockopt() syscall.
Add an explicit memset(0) before filling the structure to avoid the
info leak.
Signed-off-by: Mathias Krause
Cc: Gerrit Renker
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9f89763e8240edf8014e51513c9aba649f878c1b
Author: Mathias Krause
Date: Wed Aug 15 11:31:53 2012 +0000
llc: fix info leak via getsockname()
[ Upstream commit 3592aaeb80290bda0f2cf0b5456c97bfc638b192 ]
The LLC code wrongly returns 0, i.e. "success", when the socket is
zapped. Together with the uninitialized uaddrlen pointer argument from
sys\_getsockname this leads to an arbitrary memory leak of up to 128
bytes kernel stack via the getsockname() syscall.
Return an error instead when the socket is zapped to prevent the info
leak. Also remove the unnecessary memset(0). We don't directly write to
the memory pointed by uaddr but memcpy() a local structure at the end of
the function that is properly initialized.
Signed-off-by: Mathias Krause
Cc: Arnaldo Carvalho de Melo
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7e0a12a954e7171a68ef653cfa618d579446f9e2
Author: Mathias Krause
Date: Wed Aug 15 11:31:52 2012 +0000
l2tp: fix info leak via getsockname()
[ Upstream commit 04d4fbca1017c11381e7d82acea21dd741e748bc ]
The L2TP code for IPv6 fails to initialize the l2tp\_unused member of
struct sockaddr\_l2tpip6 and that for leaks two bytes kernel stack via
the getsockname() syscall. Initialize l2tp\_unused with 0 to avoid the
info leak.
Signed-off-by: Mathias Krause
Cc: James Chapman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2f6904ae94cb070bc8339bc27a75cf8bc76cca03
Author: Mathias Krause
Date: Wed Aug 15 11:31:51 2012 +0000
Bluetooth: L2CAP - Fix info leak via getsockname()
[ Upstream commit 792039c73cf176c8e39a6e8beef2c94ff46522ed ]
The L2CAP code fails to initialize the l2\_bdaddr\_type member of struct
sockaddr\_l2 and the padding byte added for alignment. It that for leaks
two bytes kernel stack via the getsockname() syscall. Add an explicit
memset(0) before filling the structure to avoid the info leak.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1b84eed8535a609ac3e62ef5c7baa7900592ec29
Author: Mathias Krause
Date: Wed Aug 15 11:31:50 2012 +0000
Bluetooth: RFCOMM - Fix info leak via getsockname()
[ Upstream commit 9344a972961d1a6d2c04d9008b13617bcb6ec2ef ]
The RFCOMM code fails to initialize the trailing padding byte of struct
sockaddr\_rc added for alignment. It that for leaks one byte kernel stack
via the getsockname() syscall. Add an explicit memset(0) before filling
the structure to avoid the info leak.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a194d08d452a87b194f9d61b30f2bd87d2cb1836
Author: Mathias Krause
Date: Wed Aug 15 11:31:49 2012 +0000
Bluetooth: RFCOMM - Fix info leak in ioctl(RFCOMMGETDEVLIST)
[ Upstream commit f9432c5ec8b1e9a09b9b0e5569e3c73db8de432a ]
The RFCOMM code fails to initialize the two padding bytes of struct
rfcomm\_dev\_list\_req inserted for alignment before copying it to
userland. Additionally there are two padding bytes in each instance of
struct rfcomm\_dev\_info. The ioctl() that for disclosures two bytes plus
dev\_num times two bytes uninitialized kernel heap memory.
Allocate the memory using kzalloc() to fix this issue.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 352e3a79d7885339ea18c4bad77d4508616fa61c
Author: Mathias Krause
Date: Wed Aug 15 11:31:48 2012 +0000
Bluetooth: RFCOMM - Fix info leak in getsockopt(BT\_SECURITY)
[ Upstream commit 9ad2de43f1aee7e7274a4e0d41465489299e344b ]
The RFCOMM code fails to initialize the key\_size member of struct
bt\_security before copying it to userland -- that for leaking one
byte kernel stack. Initialize key\_size with 0 to avoid the info
leak.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d7b7aa589ccc3eed017f3b01f2f83004d47bdd85
Author: Mathias Krause
Date: Wed Aug 15 11:31:47 2012 +0000
Bluetooth: HCI - Fix info leak via getsockname()
[ Upstream commit 3f68ba07b1da811bf383b4b701b129bfcb2e4988 ]
The HCI code fails to initialize the hci\_channel member of struct
sockaddr\_hci and that for leaks two bytes kernel stack via the
getsockname() syscall. Initialize hci\_channel with 0 to avoid the
info leak.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 054a7f491ba6d54f5dec06546a628eacbef63592
Author: Mathias Krause
Date: Wed Aug 15 11:31:46 2012 +0000
Bluetooth: HCI - Fix info leak in getsockopt(HCI\_FILTER)
[ Upstream commit e15ca9a0ef9a86f0477530b0f44a725d67f889ee ]
The HCI code fails to initialize the two padding bytes of struct
hci\_ufilter before copying it to userland -- that for leaking two
bytes kernel stack. Add an explicit memset(0) before filling the
structure to avoid the info leak.
Signed-off-by: Mathias Krause
Cc: Marcel Holtmann
Cc: Gustavo Padovan
Cc: Johan Hedberg
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0b74fc6398bae63b2051c8e047399ef7d4215545
Author: Mathias Krause
Date: Wed Aug 15 11:31:45 2012 +0000
atm: fix info leak via getsockname()
[ Upstream commit 3c0c5cfdcd4d69ffc4b9c0907cec99039f30a50a ]
The ATM code fails to initialize the two padding bytes of struct
sockaddr\_atmpvc inserted for alignment. Add an explicit memset(0)
before filling the structure to avoid the info leak.
Signed-off-by: Mathias Krause
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dd94f3759a698eea2c27c2b3c2df931ad94a619a
Author: Mathias Krause
Date: Wed Aug 15 11:31:44 2012 +0000
atm: fix info leak in getsockopt(SO\_ATMPVC)
[ Upstream commit e862f1a9b7df4e8196ebec45ac62295138aa3fc2 ]
The ATM code fails to initialize the two padding bytes of struct
sockaddr\_atmpvc inserted for alignment. Add an explicit memset(0)
before filling the structure to avoid the info leak.
Signed-off-by: Mathias Krause
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 754c665f51b31b43c2399f693b3a54e47cbcef7b
Author: Ben Hutchings
Date: Tue Aug 14 08:54:51 2012 +0000
ipv6: addrconf: Avoid calling netdevice notifiers with RCU read-side lock
[ Upstream commit 4acd4945cd1e1f92b20d14e349c6c6a52acbd42d ]
Cong Wang reports that lockdep detected suspicious RCU usage while
enabling IPV6 forwarding:
[ 1123.310275] ===============================
[ 1123.442202] [ INFO: suspicious RCU usage. ]
[ 1123.558207] 3.6.0-rc1+ #109 Not tainted
[ 1123.665204] -------------------------------
[ 1123.768254] include/linux/rcupdate.h:430 Illegal context switch in RCU read-side critical section!
[ 1123.992320]
[ 1123.992320] other info that might help us debug this:
[ 1123.992320]
[ 1124.307382]
[ 1124.307382] rcu\_scheduler\_active = 1, debug\_locks = 0
[ 1124.522220] 2 locks held by sysctl/5710:
[ 1124.648364] #0: (rtnl\_mutex){+.+.+.}, at: [] rtnl\_trylock+0x15/0x17
[ 1124.882211] #1: (rcu\_read\_lock){.+.+.+}, at: [] rcu\_lock\_acquire+0x0/0x29
[ 1125.085209]
[ 1125.085209] stack backtrace:
[ 1125.332213] Pid: 5710, comm: sysctl Not tainted 3.6.0-rc1+ #109
[ 1125.441291] Call Trace:
[ 1125.545281] [] lockdep\_rcu\_suspicious+0x109/0x112
[ 1125.667212] [] rcu\_preempt\_sleep\_check+0x45/0x47
[ 1125.781838] [] \_\_might\_sleep+0x1e/0x19b
[...]
[ 1127.445223] [] call\_netdevice\_notifiers+0x4a/0x4f
[...]
[ 1127.772188] [] dev\_disable\_lro+0x32/0x6b
[ 1127.885174] [] dev\_forward\_change+0x30/0xcb
[ 1128.013214] [] addrconf\_forward\_change+0x85/0xc5
[...]
addrconf\_forward\_change() uses RCU iteration over the netdev list,
which is unnecessary since it already holds the RTNL lock. We also
cannot reasonably require netdevice notifier functions not to sleep.
Reported-by: Cong Wang
Signed-off-by: Ben Hutchings
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 464485ee5310a8cb7265bef3002769e0871accbb
Author: danborkmann@iogearbox.net
Date: Fri Aug 10 22:48:54 2012 +0000
af\_packet: remove BUG statement in tpacket\_destruct\_skb
[ Upstream commit 7f5c3e3a80e6654cf48dfba7cf94f88c6b505467 ]
Here's a quote of the comment about the BUG macro from asm-generic/bug.h:
Don't use BUG() or BUG\_ON() unless there's really no way out; one
example might be detecting data structure corruption in the middle
of an operation that can't be backed out of. If the (sub)system
can somehow continue operating, perhaps with reduced functionality,
it's probably not BUG-worthy.
If you're tempted to BUG(), think again: is completely giving up
really the \*only\* solution? There are usually better options, where
users don't need to reboot ASAP and can mostly shut down cleanly.
In our case, the status flag of a ring buffer slot is managed from both sides,
the kernel space and the user space. This means that even though the kernel
side might work as expected, the user space screws up and changes this flag
right between the send(2) is triggered when the flag is changed to
TP\_STATUS\_SENDING and a given skb is destructed after some time. Then, this
will hit the BUG macro. As David suggested, the best solution is to simply
remove this statement since it cannot be used for kernel side internal
consistency checks. I've tested it and the system still behaves /stable/ in
this case, so in accordance with the above comment, we should rather remove it.
Signed-off-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b5db88321043909060745304c1e485a6a2839d31
Author: Alexey Khoroshilov
Date: Wed Aug 8 00:33:25 2012 +0000
net/core: Fix potential memory leak in dev\_set\_alias()
[ Upstream commit 7364e445f62825758fa61195d237a5b8ecdd06ec ]
Do not leak memory by updating pointer with potentially NULL realloc return value.
Found by Linux Driver Verification project (linuxtesting.org).
Signed-off-by: Alexey Khoroshilov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9c939ce5216a7f4a604985c6b20ab92081b19848
Author: Gao feng
Date: Tue Aug 7 00:23:11 2012 +0000
pptp: lookup route with the proper net namespace
[ Upstream commit 08252b32311c3fa84219ad794d640af7399b5485 ]
pptp always use init\_net as the net namespace to lookup
route, this will cause route lookup failed in container.
because we already set the correct net namespace to struct
sock in pptp\_create,so fix this by using sock\_net(sk) to
replace &init\_net.
Signed-off-by: Gao feng
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9e6c806a75a3d41b9eeca6b88e9e86d300a8badc
Author: Wu Fengguang
Date: Thu Aug 2 23:10:01 2012 +0000
isdnloop: fix and simplify isdnloop\_init()
[ Upstream commit 77f00f6324cb97cf1df6f9c4aaeea6ada23abdb2 ]
Fix a buffer overflow bug by removing the revision and printk.
[ 22.016214] isdnloop-ISDN-driver Rev 1.11.6.7
[ 22.097508] isdnloop: (loop0) virtual card added
[ 22.174400] Kernel panic - not syncing: stack-protector: Kernel stack is corrupted in: ffffffff83244972
[ 22.174400]
[ 22.436157] Pid: 1, comm: swapper Not tainted 3.5.0-bisect-00018-gfa8bbb1-dirty #129
[ 22.624071] Call Trace:
[ 22.720558] [] ? CallcNew+0x56/0x56
[ 22.815248] [] panic+0x110/0x329
[ 22.914330] [] ? isdnloop\_init+0xaf/0xb1
[ 23.014800] [] ? CallcNew+0x56/0x56
[ 23.090763] [] \_\_stack\_chk\_fail+0x2b/0x30
[ 23.185748] [] isdnloop\_init+0xaf/0xb1
Signed-off-by: Fengguang Wu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e1568974b371812e0eaab98ed39ab864715adb76
Author: Hiroaki SHIMODA
Date: Fri Aug 3 19:57:52 2012 +0900
net\_sched: gact: Fix potential panic in tcf\_gact().
[ Upstream commit 696ecdc10622d86541f2e35cc16e15b6b3b1b67e ]
gact\_rand array is accessed by gact->tcfg\_ptype whose value
is assumed to less than MAX\_RAND, but any range checks are
not performed.
So add a check in tcf\_gact\_init(). And in tcf\_gact(), we can
reduce a branch.
Signed-off-by: Hiroaki SHIMODA
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b541db6330465eae0032d46d7d67ca7e0e1047e2
Author: Ben Hutchings
Date: Mon Jul 30 16:11:42 2012 +0000
tcp: Apply device TSO segment limit earlier
[ Upstream commit 1485348d2424e1131ea42efc033cbd9366462b01 ]
Cache the device gso\_max\_segs in sock::sk\_gso\_max\_segs and use it to
limit the size of TSO skbs. This avoids the need to fall back to
software GSO for local TCP senders.
Signed-off-by: Ben Hutchings
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 867079ce16beefdd834b6f0182def0277f52a2a7
Author: Ben Hutchings
Date: Mon Jul 30 15:57:44 2012 +0000
sfc: Fix maximum number of TSO segments and minimum TX queue size
[ Upstream commit 7e6d06f0de3f74ca929441add094518ae332257c ]
Currently an skb requiring TSO may not fit within a minimum-size TX
queue. The TX queue selected for the skb may stall and trigger the TX
watchdog repeatedly (since the problem skb will be retried after the
TX reset). This issue is designated as CVE-2012-3412.
Set the maximum number of TSO segments for our devices to 100. This
should make no difference to behaviour unless the actual MSS is less
than about 700. Increase the minimum TX queue size accordingly to
allow for 2 worst-case skbs, so that there will definitely be space
to add an skb after we wake a queue.
To avoid invalidating existing configurations, change
efx\_ethtool\_set\_ringparam() to fix up values that are too small rather
than returning -EINVAL.
Signed-off-by: Ben Hutchings
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 525e07b8b6f18aec949c9f68672a0a3e3d8c38b1
Author: Ben Hutchings
Date: Mon Jul 30 15:57:00 2012 +0000
net: Allow driver to limit number of GSO segments per skb
[ Upstream commit 30b678d844af3305cda5953467005cebb5d7b687 ]
A peer (or local user) may cause TCP to use a nominal MSS of as little
as 88 (actual MSS of 76 with timestamps). Given that we have a
sufficiently prodigious local sender and the peer ACKs quickly enough,
it is nevertheless possible to grow the window for such a connection
to the point that we will try to send just under 64K at once. This
results in a single skb that expands to 861 segments.
In some drivers with TSO support, such an skb will require hundreds of
DMA descriptors; a substantial fraction of a TX ring or even more than
a full ring. The TX queue selected for the skb may stall and trigger
the TX watchdog repeatedly (since the problem skb will be retried
after the TX reset). This particularly affects sfc, for which the
issue is designated as CVE-2012-3412.
Therefore:
1. Add the field net\_device::gso\_max\_segs holding the device-specific
limit.
2. In netif\_skb\_features(), if the number of segments is too high then
mask out GSO features to force fall back to software GSO.
Signed-off-by: Ben Hutchings
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5a67d241014549fbfa31825e2eb99f9df0d8d13e
Author: Eric Dumazet
Date: Sun Jul 29 20:52:21 2012 +0000
codel: refine one condition to avoid a nul rec\_inv\_sqrt
[ Upstream commit 2359a47671fc4fb0fe5e9945f76c2cb10792c0f8 ]
One condition before codel\_Newton\_step() was not good if
we never left the dropping state for a flow. As a result
rec\_inv\_sqrt was 0, instead of the ~0 initial value.
codel control law was then set to a very aggressive mode, dropping
many packets before reaching 'target' and recovering from this problem.
To keep codel\_vars\_init() as efficient as possible, refine
the condition to make sure rec\_inv\_sqrt initial value is correct
Many thanks to Anton Mich for discovering the issue and suggesting
a fix.
Reported-by: Anton Mich
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from access.redhat.com_ff368756_20250126_071144.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.openwall.com_68e69f61_20250125_072313.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](9) [[next>]](11) [[<thread-prev]](../../../2015/02/10/4) [[thread-next>]](../../../2015/02/27/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20150222185410.GA10851@pisco.westfalen.local>
Date: Sun, 22 Feb 2015 19:54:10 +0100
From: Moritz Muehlenhoff <jmm@...ian.org>
To: oss-security@...ts.openwall.com
Cc: Assign a CVE Identifier <cve-assign@...re.org>
Subject: Re: libmnl: incorrect validation of netlink message
 origin allows attackers to spoof netlink messages

On Tue, Feb 10, 2015 at 12:13:50PM +0100, Florian Weimer wrote:
> On 02/07/2015 12:40 AM, Kurt Seifried wrote:
> > <https://bugzilla.redhat.com/show_bug.cgi?id=848949>
> >
> > this may warrant a cve
>
> It was blamed on the kernel and fixed there:
>
>   <<http://marc.info/?l=linux-netdev&m=134582981424588>>

MITRE, can you please assign a CVE ID for the kernel, then?

This was fixed in 3.6 with
<http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=20e1db19db5d6b9e4e83021595eab0dc8f107be>\f

Cheers,
        Moritz

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_264bc63e_20250125_072315.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F20e1db19db5d6b9e4e83021595eab0dc8f107bef)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F20e1db19db5d6b9e4e83021595eab0dc8f107bef)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/20e1db19db5d6b9e4e83021595eab0dc8f107bef)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

netlink: fix possible spoofing from non-root processes

[Browse files](/torvalds/linux/tree/20e1db19db5d6b9e4e83021595eab0dc8f107bef)
Browse the repository at this point in the history

```
Non-root user-space processes can send Netlink messages to other
processes that are well-known for being subscribed to Netlink
asynchronous notifications. This allows ilegitimate non-root
process to send forged messages to Netlink subscribers.

The userspace process usually verifies the legitimate origin in
two ways:

a) Socket credentials. If UID != 0, then the message comes from
   some ilegitimate process and the message needs to be dropped.

b) Netlink portID. In general, portID == 0 means that the origin
   of the messages comes from the kernel. Thus, discarding any
   message not coming from the kernel.

However, ctnetlink sets the portID in event messages that has
been triggered by some user-space process, eg. conntrack utility.
So other processes subscribed to ctnetlink events, eg. conntrackd,
know that the event was triggered by some user-space action.

Neither of the two ways to discard ilegitimate messages coming
from non-root processes can help for ctnetlink.

This patch adds capability validation in case that dst_pid is set
in netlink_sendmsg(). This approach is aggressive since existing
applications using any Netlink bus to deliver messages between
two user-space processes will break. Note that the exception is
NETLINK_USERSOCK, since it is reserved for netlink-to-netlink
userspace communication.

Still, if anyone wants that his Netlink bus allows netlink-to-netlink
userspace, then they can set NL_NONROOT_SEND. However, by default,
I don't think it makes sense to allow to use NETLINK_ROUTE to
communicate two processes that are sending no matter what information
that is not related to link/neighbouring/routing. They should be using
NETLINK_USERSOCK instead for that.

Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
```

* Loading branch information

[![@ummakynes](https://avatars.githubusercontent.com/u/46745220?s=40&v=4)](/ummakynes) [![@davem330](https://avatars.githubusercontent.com/u/1053866?s=40&v=4)](/davem330)

[ummakynes](/torvalds/linux/commits?author=ummakynes "View all commits by ummakynes")
authored and
[davem330](/torvalds/linux/commits?author=davem330 "View all commits by davem330")
committed
Aug 24, 2012

1 parent
[bd4242d](/torvalds/linux/commit/bd4242dfe85470b9caecbd049310518f9b9e3f14)

commit 20e1db1

Showing
**1 changed file**
with
**3 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

4 changes: 3 additions & 1 deletion

4
[net/netlink/af\_netlink.c](#diff-c17101867ac82e3be8bfb1e4c2d54360561fb7f2ae6a304dd0bbf12076e9d898 "net/netlink/af_netlink.c")

Show comments

[View file](/torvalds/linux/blob/20e1db19db5d6b9e4e83021595eab0dc8f107bef/net/netlink/af_netlink.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1373,7 +1373,8 @@ static int netlink\_sendmsg(struct kiocb \*kiocb, struct socket \*sock, |
|  |  | dst\_pid = addr->nl\_pid; |
|  |  | dst\_group = ffs(addr->nl\_groups); |
|  |  | err = -EPERM; |
|  |  | if (dst\_group && !netlink\_capable(sock, NL\_NONROOT\_SEND)) |
|  |  | if ((dst\_group || dst\_pid) && |
|  |  | !netlink\_capable(sock, NL\_NONROOT\_SEND)) |
|  |  | goto out; |
|  |  | } else { |
|  |  | dst\_pid = nlk->dst\_pid; |
| Expand Down  Expand Up | | @@ -2147,6 +2148,7 @@ static void \_\_init netlink\_add\_usersock\_entry(void) |
|  |  | rcu\_assign\_pointer(nl\_table[NETLINK\_USERSOCK].listeners, listeners); |
|  |  | nl\_table[NETLINK\_USERSOCK].module = THIS\_MODULE; |
|  |  | nl\_table[NETLINK\_USERSOCK].registered = 1; |
|  |  | nl\_table[NETLINK\_USERSOCK].nl\_nonroot = NL\_NONROOT\_SEND; |
|  |  |  |
|  |  | netlink\_table\_ungrab(); |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `20e1db1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F20e1db19db5d6b9e4e83021595eab0dc8f107bef) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


