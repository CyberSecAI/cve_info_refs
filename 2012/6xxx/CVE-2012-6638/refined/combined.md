=== Content from www.kernel.org_8530a095_20250125_031204.html ===
commit f1e79c6abb1e5420fb35e9e8a634efec9fc9ba96
Author: Ben Hutchings
Date: Wed Jul 25 04:11:50 2012 +0100
Linux 3.2.24
commit 5a270d169895de9529e2a9a2e610d6aa7e217cef
Author: Ryan Bourgeois
Date: Tue Jul 10 09:43:33 2012 -0700
HID: add support for 2012 MacBook Pro Retina
commit b2e6ad7dfe26aac5bf136962d0b11d180b820d44 upstream.
Add support for the 15'' MacBook Pro Retina. The keyboard is
the same as recent models.
The patch needs to be synchronized with the bcm5974 patch for
the trackpad - as usual.
Patch originally written by clipcarl (forums.opensuse.org).
[rydberg@euromail.se: Amended mouse ignore lines]
Signed-off-by: Ryan Bourgeois
Signed-off-by: Henrik Rydberg
Acked-by: Jiri Kosina
Signed-off-by: Dmitry Torokhov
Signed-off-by: Ben Hutchings
commit a090e29a85d5d654848c5d564a7445fdf0e04bf2
Author: Yuri Khan
Date: Wed Jul 11 22:12:31 2012 -0700
Input: xpad - add Andamiro Pump It Up pad
commit e76b8ee25e034ab601b525abb95cea14aa167ed3 upstream.
I couldn't find the vendor ID in any of the online databases, but this
mat has a Pump It Up logo on the top side of the controller compartment,
and a disclaimer stating that Andamiro will not be liable on the bottom.
Signed-off-by: Yuri Khan
Signed-off-by: Dmitry Torokhov
Signed-off-by: Ben Hutchings
commit e30e7f7dfdaff81816662f074920afedc9b9bed9
Author: Ilia Katsnelson
Date: Wed Jul 11 00:54:20 2012 -0700
Input: xpad - add signature for Razer Onza Tournament Edition
commit cc71a7e899cc6b2ff41e1be48756782ed004d802 upstream.
Signed-off-by: Ilia Katsnelson
Signed-off-by: Dmitry Torokhov
Signed-off-by: Ben Hutchings
commit 6cfcea9befbd9740e856674e43fdbdf01c0b36bc
Author: Yuri Khan
Date: Wed Jul 11 00:49:18 2012 -0700
Input: xpad - handle all variations of Mad Catz Beat Pad
commit 3ffb62cb9ac2430c2504c6ff9727d0f2476ef0bd upstream.
The device should be handled by xpad driver instead of generic HID driver.
Signed-off-by: Yuri Khan
Acked-by: Jiri Kosina
Signed-off-by: Dmitry Torokhov
Signed-off-by: Ben Hutchings
commit f7ca712ade543ecad0e37b0758f77eb0a84c2a40
Author: Henrik Rydberg
Date: Tue Jul 10 09:43:57 2012 -0700
Input: bcm5974 - Add support for 2012 MacBook Pro Retina
commit 3dde22a98e94eb18527f0ff0068fb2fb945e58d4 upstream.
Add support for the 15'' MacBook Pro Retina model (MacBookPro10,1).
Patch originally written by clipcarl (forums.opensuse.org).
Signed-off-by: Henrik Rydberg
Signed-off-by: Dmitry Torokhov
Signed-off-by: Ben Hutchings
commit cbcdb622dcf9254668a18a31c4df97c170f86a7a
Author: Eric W. Biederman
Date: Mon Jul 9 10:51:45 2012 +0000
bonding: Manage /proc/net/bonding/ entries from the netdev events
commit a64d49c3dd504b685f9742a2f3dcb11fb8e4345f upstream.
It was recently reported that moving a bonding device between network
namespaces causes warnings from /proc. It turns out after the move we
were trying to add and to remove the /proc/net/bonding entries from the
wrong network namespace.
Move the bonding /proc registration code into the NETDEV\_REGISTER and
NETDEV\_UNREGISTER events where the proc registration and unregistration
will always happen at the right time.
Signed-off-by: "Eric W. Biederman"
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit 78d40a34b2e35e675b11185e2ff6bd8e9e5145b2
Author: Eric W. Biederman
Date: Mon Jul 9 10:52:43 2012 +0000
bonding: debugfs and network namespaces are incompatible
commit 96ca7ffe748bf91f851e6aa4479aa11c8b1122ba upstream.
The bonding debugfs support has been broken in the presence of network
namespaces since it has been added. The debugfs support does not handle
multiple bonding devices with the same name in different network
namespaces.
I haven't had any bug reports, and I'm not interested in getting any.
Disable the debugfs support when network namespaces are enabled.
Signed-off-by: "Eric W. Biederman"
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit b5ff5ad1b9299fccc11c801764fa23ca696161cf
Author: Deepak Sikri
Date: Sun Jul 8 21:14:45 2012 +0000
stmmac: Fix for nfs hang on multiple reboot
commit 8e83989106562326bfd6aaf92174fe138efd026b upstream.
It was observed that during multiple reboots nfs hangs. The status of
receive descriptors shows that all the descriptors were in control of
CPU, and none were assigned to DMA.
Also the DMA status register confirmed that the Rx buffer is
unavailable.
This patch adds the fix for the same by adding the memory barriers to
ascertain that the all instructions before enabling the Rx or Tx DMA are
completed which involves the proper setting of the ownership bit in DMA
descriptors.
Signed-off-by: Deepak Sikri
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit 91256cf4a1df58edad1147dd619d5bc50a1748dd
Author: Davide Gerhard
Date: Mon Jun 25 09:04:47 2012 +0200
ipheth: add support for iPad
commit 6de0298ec9c1edaf330b71b57346241ece8f3346 upstream.
This adds support for the iPad to the ipheth driver.
(product id = 0x129a)
Signed-off-by: Davide Gerhard
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit db4fd57ab669f33ca6ef67e9f0c8074906073726
Author: Rafael J. Wysocki
Date: Tue May 29 21:21:07 2012 +0200
ACPI / PM: Make acpi\_pm\_device\_sleep\_state() follow the specification
commit dbe9a2edd17d843d80faf2b99f20a691c1853418 upstream.
The comparison between the system sleep state being entered
and the lowest system sleep state the given device may wake up
from in acpi\_pm\_device\_sleep\_state() is reversed, because the
specification (ACPI 5.0) says that for wakeup to work:
"The sleeping state being entered must be less than or equal to the
power state declared in element 1 of the \_PRW object."
In other words, the state returned by \_PRW is the deepest
(lowest-power) system sleep state the device is capable of waking up
the system from.
Moreover, acpi\_pm\_device\_sleep\_state() also should check if the
wakeup capability is supported through ACPI, because in principle it
may be done via native PCIe PME, for example, in which case \_SxW
should not be evaluated.
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Ben Hutchings
commit 03d200117c06fde714344f8f4f0301f609959b53
Author: Tyler Hicks
Date: Tue Jun 12 11:17:01 2012 -0700
eCryptfs: Properly check for O\_RDONLY flag before doing privileged open
commit 9fe79d7600497ed8a95c3981cbe5b73ab98222f0 upstream.
If the first attempt at opening the lower file read/write fails,
eCryptfs will retry using a privileged kthread. However, the privileged
retry should not happen if the lower file's inode is read-only because a
read/write open will still be unsuccessful.
The check for determining if the open should be retried was intended to
be based on the access mode of the lower file's open flags being
O\_RDONLY, but the check was incorrectly performed. This would cause the
open to be retried by the privileged kthread, resulting in a second
failed open of the lower file. This patch corrects the check to
determine if the open request should be handled by the privileged
kthread.
Signed-off-by: Tyler Hicks
Reported-by: Dan Carpenter
Acked-by: Dan Carpenter
Signed-off-by: Ben Hutchings
commit b8b1e1ea3fa0b1de9a5eead6bab0c563617b9a2b
Author: Tyler Hicks
Date: Mon Jun 11 10:21:34 2012 -0700
eCryptfs: Fix lockdep warning in miscdev operations
commit 60d65f1f07a7d81d3eb3b91fc13fca80f2fdbb12 upstream.
Don't grab the daemon mutex while holding the message context mutex.
Addresses this lockdep warning:
ecryptfsd/2141 is trying to acquire lock:
(&ecryptfs\_msg\_ctx\_arr[i].mux){+.+.+.}, at: [] ecryptfs\_miscdev\_read+0x143/0x470 [ecryptfs]
but task is already holding lock:
(&(\*daemon)->mux){+.+...}, at: [] ecryptfs\_miscdev\_read+0x21c/0x470 [ecryptfs]
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&(\*daemon)->mux){+.+...}:
[] lock\_acquire+0x9d/0x220
[] \_\_mutex\_lock\_common+0x5a/0x4b0
[] mutex\_lock\_nested+0x44/0x50
[] ecryptfs\_send\_miscdev+0x97/0x120 [ecryptfs]
[] ecryptfs\_send\_message+0x134/0x1e0 [ecryptfs]
[] ecryptfs\_generate\_key\_packet\_set+0x2fe/0xa80 [ecryptfs]
[] ecryptfs\_write\_metadata+0x108/0x250 [ecryptfs]
[] ecryptfs\_create+0x130/0x250 [ecryptfs]
[] vfs\_create+0xb4/0x120
[] do\_last+0x8c5/0xa10
[] path\_openat+0xd9/0x460
[] do\_filp\_open+0x42/0xa0
[] do\_sys\_open+0xf8/0x1d0
[] sys\_open+0x21/0x30
[] system\_call\_fastpath+0x16/0x1b
-> #0 (&ecryptfs\_msg\_ctx\_arr[i].mux){+.+.+.}:
[] \_\_lock\_acquire+0x1bf8/0x1c50
[] lock\_acquire+0x9d/0x220
[] \_\_mutex\_lock\_common+0x5a/0x4b0
[] mutex\_lock\_nested+0x44/0x50
[] ecryptfs\_miscdev\_read+0x143/0x470 [ecryptfs]
[] vfs\_read+0xb3/0x180
[] sys\_read+0x4d/0x90
[] system\_call\_fastpath+0x16/0x1b
Signed-off-by: Tyler Hicks
Signed-off-by: Ben Hutchings
commit 4d5a83a81b462742fca6e592b4841f52dc68ec83
Author: Tyler Hicks
Date: Mon Jun 11 09:24:11 2012 -0700
eCryptfs: Gracefully refuse miscdev file ops on inherited/passed files
commit 8dc6780587c99286c0d3de747a2946a76989414a upstream.
File operations on /dev/ecryptfs would BUG() when the operations were
performed by processes other than the process that originally opened the
file. This could happen with open files inherited after fork() or file
descriptors passed through IPC mechanisms. Rather than calling BUG(), an
error code can be safely returned in most situations.
In ecryptfs\_miscdev\_release(), eCryptfs still needs to handle the
release even if the last file reference is being held by a process that
didn't originally open the file. ecryptfs\_find\_daemon\_by\_euid() will not
be successful, so a pointer to the daemon is stored in the file's
private\_data. The private\_data pointer is initialized when the miscdev
file is opened and only used when the file is released.
https://launchpad.net/bugs/994247
Signed-off-by: Tyler Hicks
Reported-by: Sasha Levin
Tested-by: Sasha Levin
Signed-off-by: Ben Hutchings
commit 391493aea95c02174396051e5ed3296325c131ee
Author: Pavel Vasilyev
Date: Tue Jun 5 00:02:05 2012 -0400
ACPI sysfs.c strlen fix
commit 9f132652d94c96476b0b0a8caf0c10e96ab10fa8 upstream.
Current code is ignoring the last character of "enable" and "disable"
in comparisons.
https://bugzilla.kernel.org/show\_bug.cgi?id=33732
Signed-off-by: Len Brown
Signed-off-by: Ben Hutchings
commit 8e65352dd2b452e53eb5821af449b4750ac8e35d
Author: Zhang Rui
Date: Mon Feb 20 14:20:06 2012 +0800
ACPI, x86: fix Dell M6600 ACPI reboot regression via DMI
commit 76eb9a30db4bc8fd172f9155247264b5f2686d7b upstream.
Dell Precision M6600 is known to require PCI reboot, so add it to
the reboot blacklist in pci\_reboot\_dmi\_table[].
https://bugzilla.kernel.org/show\_bug.cgi?id=42749
cc: x86@kernel.org
Signed-off-by: Zhang Rui
Signed-off-by: Len Brown
Signed-off-by: Ben Hutchings
commit 80aa998e8260479a3c6bcaee28a961d7be2ba8dd
Author: Feng Tang
Date: Mon Jun 4 15:00:06 2012 +0800
ACPI: Add a quirk for "AMILO PRO V2030" to ignore the timer overriding
commit b939c2acf1dc42b08407ef5174f2e8d6f43dd5ea upstream.
commit f6b54f083cc66cf9b11d2120d8df3c2ad4e0836d upstream.
This is the 2nd part of fix for kernel bugzilla 40002:
"IRQ 0 assigned to VGA"
https://bugzilla.kernel.org/show\_bug.cgi?id=40002
The root cause is the buggy FW, whose ACPI tables assign the GSI 16
to 2 irqs 0 and 16(VGA), and the VGA is the right owner of GSI 16.
So add a quirk to ignore the irq0 overriding GSI 16 for the
FUJITSU SIEMENS AMILO PRO V2030 platform will solve this issue.
Reported-and-tested-by: Szymon Kowalczyk
Signed-off-by: Feng Tang
Signed-off-by: Len Brown
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit d6f34925144b450a5a962ca8c3cbde1a38d60fc0
Author: Feng Tang
Date: Mon Jun 4 15:00:05 2012 +0800
ACPI: Remove one board specific WARN when ignoring timer overriding
commit 5752cdb805ff89942d99d12118e2844e7db34df8 upstream.
commit 7f68b4c2e158019c2ec494b5cfbd9c83b4e5b253 upstream.
Current WARN msg is only for the ati\_ixp4x0 board, while this function
is used by mulitple platforms. So this one board specific warning
is not appropriate any more.
Signed-off-by: Feng Tang
Signed-off-by: Len Brown
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit 51d5aa75ce4380a55714282a717fde81cce33c35
Author: Feng Tang
Date: Mon Jun 4 15:00:04 2012 +0800
ACPI: Make acpi\_skip\_timer\_override cover all source\_irq==0 cases
commit ae10ccdc3093486f8c2369d227583f9d79f628e5 upstream.
Currently when acpi\_skip\_timer\_override is set, it only cover the
(source\_irq == 0 && global\_irq == 2) cases. While there is also
platform which need use this option and its global\_irq is not 2.
This patch will extend acpi\_skip\_timer\_override to cover all
timer overriding cases as long as the source irq is 0.
This is the first part of a fix to kernel bug bugzilla 40002:
"IRQ 0 assigned to VGA"
https://bugzilla.kernel.org/show\_bug.cgi?id=40002
Reported-and-tested-by: Szymon Kowalczyk
Signed-off-by: Feng Tang
Signed-off-by: Len Brown
Signed-off-by: Ben Hutchings
commit 73a3346556281fd56f39f0a9475249e5039d8807
Author: Eric Dumazet
Date: Thu Jun 14 06:42:44 2012 +0000
net: remove skb\_orphan\_try()
commit 62b1a8ab9b3660bb820d8dfe23148ed6cda38574 upstream.
Orphaning skb in dev\_hard\_start\_xmit() makes bonding behavior
unfriendly for applications sending big UDP bursts : Once packets
pass the bonding device and come to real device, they might hit a full
qdisc and be dropped. Without orphaning, the sender is automatically
throttled because sk->sk\_wmemalloc reaches sk->sk\_sndbuf (assuming
sk\_sndbuf is not too big)
We could try to defer the orphaning adding another test in
dev\_hard\_start\_xmit(), but all this seems of little gain,
now that BQL tends to make packets more likely to be parked
in Qdisc queues instead of NIC TX ring, in cases where performance
matters.
Reverts commits :
fc6055a5ba31 net: Introduce skb\_orphan\_try()
87fd308cfc6b net: skb\_tx\_hash() fix relative to skb\_orphan\_try()
and removes SKBTX\_DRV\_NEEDS\_SK\_REF flag
Reported-and-bisected-by: Jean-Michel Hautbois
Signed-off-by: Eric Dumazet
Tested-by: Oliver Hartkopp
Acked-by: Oliver Hartkopp
Signed-off-by: David S. Miller
[bwh: Backported to 3.2:
- Adjust context
- SKBTX\_WIFI\_STATUS is not defined]
Signed-off-by: Ben Hutchings
commit dcf42d8ca45ca2009ead5cfae84c1c0de0a0af72
Author: Eric Dumazet
Date: Wed Jun 13 09:45:16 2012 +0000
bnx2x: fix panic when TX ring is full
commit bc14786a100cc6a81cd060e8031ec481241b418c upstream.
There is a off by one error in the minimal number of BD in
bnx2x\_start\_xmit() and bnx2x\_tx\_int() before stopping/resuming tx queue.
A full size GSO packet, with data included in skb->head really needs
(MAX\_SKB\_FRAGS + 4) BDs, because of bnx2x\_tx\_split()
This error triggers if BQL is disabled and heavy TCP transmit traffic
occurs.
bnx2x\_tx\_split() definitely can be called, remove a wrong comment.
Reported-by: Tomas Hruby
Signed-off-by: Eric Dumazet
Cc: Eilon Greenstein
Cc: Yaniv Rosner
Cc: Merav Sicron
Cc: Tom Herbert
Cc: Robert Evans
Cc: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit caac50847fd87dcc587181e3af3bd0aebf49964e
Author: Eric Dumazet
Date: Tue Jun 12 23:50:04 2012 +0000
bnx2x: fix checksum validation
commit d6cb3e41386f20fb0777d0b59a2def82c65d37f7 upstream.
bnx2x driver incorrectly sets ip\_summed to CHECKSUM\_UNNECESSARY on
encapsulated segments. TCP stack happily accepts frames with bad
checksums, if they are inside a GRE or IPIP encapsulation.
Our understanding is that if no IP or L4 csum validation was done by the
hardware, we should leave ip\_summed as is (CHECKSUM\_NONE), since
hardware doesn't provide CHECKSUM\_COMPLETE support in its cqe.
Then, if IP/L4 checksumming was done by the hardware, set
CHECKSUM\_UNNECESSARY if no error was flagged.
Patch based on findings and analysis from Robert Evans
Signed-off-by: Eric Dumazet
Cc: Eilon Greenstein
Cc: Yaniv Rosner
Cc: Merav Sicron
Cc: Tom Herbert
Cc: Robert Evans
Cc: Willem de Bruijn
Acked-by: Eilon Greenstein
Signed-off-by: David S. Miller
[bwh: Backported to 3.2: adjust context, indentation]
Signed-off-by: Ben Hutchings
commit fc6fc50e4d74eb0f4f4c8a07b33d2a797a29082f
Author: Devendra Naga
Date: Thu May 31 01:51:20 2012 +0000
r8169: call netif\_napi\_del at errpaths and at driver unload
commit ad1be8d345416a794dea39761a374032aa471a76 upstream.
when register\_netdev fails, the init'ed NAPIs by netif\_napi\_add must be
deleted with netif\_napi\_del, and also when driver unloads, it should
delete the NAPI before unregistering netdevice using unregister\_netdev.
Signed-off-by: Devendra Naga
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit 1803c9c9746dd5cd524d6499ca24cbb4eacffa37
Author: Nadav Har'El
Date: Mon Feb 27 15:07:29 2012 +0200
vhost: don't forget to schedule()
commit d550dda192c1bd039afb774b99485e88b70d7cb8 upstream.
This is a tiny, but important, patch to vhost.
Vhost's worker thread only called schedule() when it had no work to do, and
it wanted to go to sleep. But if there's always work to do, e.g., the guest
is running a network-intensive program like netperf with small message sizes,
schedule() was \*never\* called. This had several negative implications (on
non-preemptive kernels):
1. Passing time was not properly accounted to the "vhost" process (ps and
top would wrongly show it using zero CPU time).
2. Sometimes error messages about RCU timeouts would be printed, if the
core running the vhost thread didn't schedule() for a very long time.
3. Worst of all, a vhost thread would "hog" the core. If several vhost
threads need to share the same core, typically one would get most of the
CPU time (and its associated guest most of the performance), while the
others hardly get any work done.
The trivial solution is to add
if (need\_resched())
schedule();
After doing every piece of work. This will not do the heavy schedule() all
the time, just when the timer interrupt decided a reschedule is warranted
(so need\_resched returns true).
Thanks to Abel Gordon for this patch.
Signed-off-by: Nadav Har'El
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit 51326e07490692aa9049e2952bae36fc5824a63d
Author: Andreas Schwab
Date: Fri Dec 9 11:35:08 2011 +0000
powerpc: Fix wrong divisor in usecs\_to\_cputime
commit 9f5072d4f63f28d30d343573830ac6c85fc0deff upstream.
Commit d57af9b (taskstats: use real microsecond granularity for CPU times)
renamed msecs\_to\_cputime to usecs\_to\_cputime, but failed to update all
numbers on the way. This causes nonsensical cpu idle/iowait values to be
displayed in /proc/stat (the only user of usecs\_to\_cputime so far).
This also renames \_\_cputime\_msec\_factor to \_\_cputime\_usec\_factor, adapting
its value and using it directly in cputime\_to\_usecs instead of doing two
multiplications.
Signed-off-by: Andreas Schwab
Acked-by: Anton Blanchard
Signed-off-by: Benjamin Herrenschmidt
Signed-off-by: Ben Hutchings
commit 0ad70925ab61c308d669d93f02c7bf1974a5158f
Author: Thomas Gleixner
Date: Mon Jul 16 12:50:42 2012 -0400
timekeeping: Add missing update call in timekeeping\_resume()
This is a backport of 3e997130bd2e8c6f5aaa49d6e3161d4d29b43ab0
The leap second rework unearthed another issue of inconsistent data.
On timekeeping\_resume() the timekeeper data is updated, but nothing
calls timekeeping\_update(), so now the update code in the timer
interrupt sees stale values.
This has been the case before those changes, but then the timer
interrupt was using stale data as well so this went unnoticed for quite
some time.
Add the missing update call, so all the data is consistent everywhere.
Reported-by: Andreas Schwab
Reported-and-tested-by: "Rafael J. Wysocki"
Reported-and-tested-by: Martin Steigerwald
Cc: LKML
Cc: Linux PM list
Cc: John Stultz
Cc: Ingo Molnar
Cc: Peter Zijlstra ,
Cc: Prarit Bhargava
Signed-off-by: Thomas Gleixner
Signed-off-by: John Stultz
Signed-off-by: Linus Torvalds
[John Stultz: Backported to 3.2]
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 7b9a231293995c1211d254a38d60f21980ed5d07
Author: John Stultz
Date: Tue Jul 10 18:43:25 2012 -0400
hrtimer: Update hrtimer base offsets each hrtimer\_interrupt
commit 5baefd6d84163443215f4a99f6a20f054ef11236 upstream.
The update of the hrtimer base offsets on all cpus cannot be made
atomically from the timekeeper.lock held and interrupt disabled region
as smp function calls are not allowed there.
clock\_was\_set(), which enforces the update on all cpus, is called
either from preemptible process context in case of do\_settimeofday()
or from the softirq context when the offset modification happened in
the timer interrupt itself due to a leap second.
In both cases there is a race window for an hrtimer interrupt between
dropping timekeeper lock, enabling interrupts and clock\_was\_set()
issuing the updates. Any interrupt which arrives in that window will
see the new time but operate on stale offsets.
So we need to make sure that an hrtimer interrupt always sees a
consistent state of time and offsets.
ktime\_get\_update\_offsets() allows us to get the current monotonic time
and update the per cpu hrtimer base offsets from hrtimer\_interrupt()
to capture a consistent state of monotonic time and the offsets. The
function replaces the existing ktime\_get() calls in hrtimer\_interrupt().
The overhead of the new function vs. ktime\_get() is minimal as it just
adds two store operations.
This ensures that any changes to realtime or boottime offsets are
noticed and stored into the per-cpu hrtimer base structures, prior to
any hrtimer expiration and guarantees that timers are not expired early.
Signed-off-by: John Stultz
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Link: http://lkml.kernel.org/r/1341960205-56738-8-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Ben Hutchings
commit ec5806bcd08281a86e05b8e4eaf2f377bc8e5b24
Author: Thomas Gleixner
Date: Tue Jul 10 18:43:24 2012 -0400
timekeeping: Provide hrtimer update function
This is a backport of f6c06abfb3972ad4914cef57d8348fcb2932bc3b
To finally fix the infamous leap second issue and other race windows
caused by functions which change the offsets between the various time
bases (CLOCK\_MONOTONIC, CLOCK\_REALTIME and CLOCK\_BOOTTIME) we need a
function which atomically gets the current monotonic time and updates
the offsets of CLOCK\_REALTIME and CLOCK\_BOOTTIME with minimalistic
overhead. The previous patch which provides ktime\_t offsets allows us
to make this function almost as cheap as ktime\_get() which is going to
be replaced in hrtimer\_interrupt().
Signed-off-by: Thomas Gleixner
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Signed-off-by: John Stultz
Link: http://lkml.kernel.org/r/1341960205-56738-7-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
[John Stultz: Backported to 3.2]
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit d6a2a0400e36bcd2892272995a65b4bca029220f
Author: Thomas Gleixner
Date: Tue Jul 10 18:43:23 2012 -0400
hrtimers: Move lock held region in hrtimer\_interrupt()
commit 196951e91262fccda81147d2bcf7fdab08668b40 upstream.
We need to update the base offsets from this code and we need to do
that under base->lock. Move the lock held region around the
ktime\_get() calls. The ktime\_get() calls are going to be replaced with
a function which gets the time and the offsets atomically.
Signed-off-by: Thomas Gleixner
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Signed-off-by: John Stultz
Link: http://lkml.kernel.org/r/1341960205-56738-6-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Ben Hutchings
commit a105e023adf852c9847e1fe7f0bc151ce0339914
Author: Thomas Gleixner
Date: Tue Jul 10 18:43:21 2012 -0400
timekeeping: Maintain ktime\_t based offsets for hrtimers
This is a backport of 5b9fe759a678e05be4937ddf03d50e950207c1c0
We need to update the hrtimer clock offsets from the hrtimer interrupt
context. To avoid conversions from timespec to ktime\_t maintain a
ktime\_t based representation of those offsets in the timekeeper. This
puts the conversion overhead into the code which updates the
underlying offsets and provides fast accessible values in the hrtimer
interrupt.
Signed-off-by: Thomas Gleixner
Signed-off-by: John Stultz
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Link: http://lkml.kernel.org/r/1341960205-56738-4-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
[John Stultz: Backported to 3.2]
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 8a1ba973a23bd94a4ce34ffa543bf0e0d4ec13ff
Author: John Stultz
Date: Tue Jul 10 18:43:20 2012 -0400
timekeeping: Fix leapsecond triggered load spike issue
This is a backport of 4873fa070ae84a4115f0b3c9dfabc224f1bc7c51
The timekeeping code misses an update of the hrtimer subsystem after a
leap second happened. Due to that timers based on CLOCK\_REALTIME are
either expiring a second early or late depending on whether a leap
second has been inserted or deleted until an operation is initiated
which causes that update. Unless the update happens by some other
means this discrepancy between the timekeeping and the hrtimer data
stays forever and timers are expired either early or late.
The reported immediate workaround - $ data -s "`date`" - is causing a
call to clock\_was\_set() which updates the hrtimer data structures.
See: http://www.sheeri.com/content/mysql-and-leap-second-high-cpu-and-fix
Add the missing clock\_was\_set() call to update\_wall\_time() in case of
a leap second event. The actual update is deferred to softirq context
as the necessary smp function call cannot be invoked from hard
interrupt context.
Signed-off-by: John Stultz
Reported-by: Jan Engelhardt
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Link: http://lkml.kernel.org/r/1341960205-56738-3-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 3c910e7e46810c73e21196867b7ec63d58a0a45c
Author: John Stultz
Date: Tue Jul 10 18:43:19 2012 -0400
hrtimer: Provide clock\_was\_set\_delayed()
commit f55a6faa384304c89cfef162768e88374d3312cb upstream.
clock\_was\_set() cannot be called from hard interrupt context because
it calls on\_each\_cpu().
For fixing the widely reported leap seconds issue it is necessary to
call it from hard interrupt context, i.e. the timer tick code, which
does the timekeeping updates.
Provide a new function which denotes it in the hrtimer cpu base
structure of the cpu on which it is called and raise the hrtimer
softirq. We then execute the clock\_was\_set() notificiation from
softirq context in run\_hrtimer\_softirq(). The hrtimer softirq is
rarely used, so polling the flag there is not a performance issue.
[ tglx: Made it depend on CONFIG\_HIGH\_RES\_TIMERS. We really should get
rid of all this ifdeffery ASAP ]
Signed-off-by: John Stultz
Reported-by: Jan Engelhardt
Reviewed-by: Ingo Molnar
Acked-by: Peter Zijlstra
Acked-by: Prarit Bhargava
Link: http://lkml.kernel.org/r/1341960205-56738-2-git-send-email-johnstul@us.ibm.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Ben Hutchings
commit b19f4db486601885ee4c40665f4e8509ec65b4d5
Author: Thomas Gleixner
Date: Sun Nov 13 23:19:49 2011 +0000
time: Move common updates to a function
This is a backport of cc06268c6a87db156af2daed6e96a936b955cc82
[John Stultz: While not a bugfix itself, it allows following fixes
to backport in a more straightforward manner.]
CC: Thomas Gleixner
CC: Eric Dumazet
CC: Richard Cochran
Signed-off-by: Thomas Gleixner
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 09e66e8d71833a897a82ec18484b388e729b6548
Author: John Stultz
Date: Wed May 30 10:54:57 2012 -0700
timekeeping: Fix CLOCK\_MONOTONIC inconsistency during leapsecond
This is a backport of fad0c66c4bb836d57a5f125ecd38bed653ca863a
which resolves a bug the previous commit.
Commit 6b43ae8a61 (ntp: Fix leap-second hrtimer livelock) broke the
leapsecond update of CLOCK\_MONOTONIC. The missing leapsecond update to
wall\_to\_monotonic causes discontinuities in CLOCK\_MONOTONIC.
Adjust wall\_to\_monotonic when NTP inserted a leapsecond.
Reported-by: Richard Cochran
Signed-off-by: John Stultz
Tested-by: Richard Cochran
Link: http://lkml.kernel.org/r/1338400497-12420-1-git-send-email-john.stultz@linaro.org
Signed-off-by: Thomas Gleixner
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 76117661ce2f9ecf7f969a4aeafd1c74802deae7
Author: Richard Cochran
Date: Thu Apr 26 14:11:32 2012 +0200
ntp: Correct TAI offset during leap second
commit dd48d708ff3e917f6d6b6c2b696c3f18c019feed upstream.
When repeating a UTC time value during a leap second (when the UTC
time should be 23:59:60), the TAI timescale should not stop. The kernel
NTP code increments the TAI offset one second too late. This patch fixes
the issue by incrementing the offset during the leap second itself.
Signed-off-by: Richard Cochran
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit a57ccabee60519dd90051266c00d038055b93878
Author: John Stultz
Date: Tue Jul 17 03:05:14 2012 -0400
ntp: Fix leap-second hrtimer livelock
This is a backport of 6b43ae8a619d17c4935c3320d2ef9e92bdeed05d
This should have been backported when it was commited, but I
mistook the problem as requiring the ntp\_lock changes
that landed in 3.4 in order for it to occur.
Unfortunately the same issue can happen (with only one cpu)
as follows:
do\_adjtimex()
write\_seqlock\_irq(&xtime\_lock);
process\_adjtimex\_modes()
process\_adj\_status()
ntp\_start\_leap\_timer()
hrtimer\_start()
hrtimer\_reprogram()
tick\_program\_event()
clockevents\_program\_event()
ktime\_get()
seq = req\_seqbegin(xtime\_lock); [DEADLOCK]
This deadlock will no always occur, as it requires the
leap\_timer to force a hrtimer\_reprogram which only happens
if its set and there's no sooner timer to expire.
NOTE: This patch, being faithful to the original commit,
introduces a bug (we don't update wall\_to\_monotonic),
which will be resovled by backporting a following fix.
Original commit message below:
Since commit 7dffa3c673fbcf835cd7be80bb4aec8ad3f51168 the ntp
subsystem has used an hrtimer for triggering the leapsecond
adjustment. However, this can cause a potential livelock.
Thomas diagnosed this as the following pattern:
CPU 0 CPU 1
do\_adjtimex()
spin\_lock\_irq(&ntp\_lock);
process\_adjtimex\_modes(); timer\_interrupt()
process\_adj\_status(); do\_timer()
ntp\_start\_leap\_timer(); write\_lock(&xtime\_lock);
hrtimer\_start(); update\_wall\_time();
hrtimer\_reprogram(); ntp\_tick\_length()
tick\_program\_event() spin\_lock(&ntp\_lock);
clockevents\_program\_event()
ktime\_get()
seq = req\_seqbegin(xtime\_lock);
This patch tries to avoid the problem by reverting back to not using
an hrtimer to inject leapseconds, and instead we handle the leapsecond
processing in the second\_overflow() function.
The downside to this change is that on systems that support highres
timers, the leap second processing will occur on a HZ tick boundary,
(ie: ~1-10ms, depending on HZ) after the leap second instead of
possibly sooner (~34us in my tests w/ x86\_64 lapic).
This patch applies on top of tip/timers/core.
CC: Sasha Levin
CC: Thomas Gleixner
Reported-by: Sasha Levin
Diagnoised-by: Thomas Gleixner
Tested-by: Sasha Levin
Cc: Prarit Bhargava
Cc: Thomas Gleixner
Cc: Linux Kernel
Signed-off-by: John Stultz
Signed-off-by: Ben Hutchings
commit 9f1e3e0f9fae973747e113848f9a9d0a2e1867f9
Author: Mikulas Patocka
Date: Fri Jul 20 14:25:07 2012 +0100
dm raid1: set discard\_zeroes\_data\_unsupported
commit 7c8d3a42fe1c58a7e8fd3f6a013e7d7b474ff931 upstream.
We can't guarantee that REQ\_DISCARD on dm-mirror zeroes the data even if
the underlying disks support zero on discard. So this patch sets
ti->discard\_zeroes\_data\_unsupported.
For example, if the mirror is in the process of resynchronizing, it may
happen that kcopyd reads a piece of data, then discard is sent on the
same area and then kcopyd writes the piece of data to another leg.
Consequently, the data is not zeroed.
The flag was made available by commit 983c7db347db8ce2d8453fd1d89b7a4bb6920d56
(dm crypt: always disable discard\_zeroes\_data).
Signed-off-by: Mikulas Patocka
Signed-off-by: Alasdair G Kergon
Signed-off-by: Ben Hutchings
commit 0409d1635121277180269f8294ced70214cbd837
Author: Mikulas Patocka
Date: Fri Jul 20 14:25:03 2012 +0100
dm raid1: fix crash with mirror recovery and discard
commit 751f188dd5ab95b3f2b5f2f467c38aae5a2877eb upstream.
This patch fixes a crash when a discard request is sent during mirror
recovery.
Firstly, some background. Generally, the following sequence happens during
mirror synchronization:
- function do\_recovery is called
- do\_recovery calls dm\_rh\_recovery\_prepare
- dm\_rh\_recovery\_prepare uses a semaphore to limit the number
simultaneously recovered regions (by default the semaphore value is 1,
so only one region at a time is recovered)
- dm\_rh\_recovery\_prepare calls \_\_rh\_recovery\_prepare,
\_\_rh\_recovery\_prepare asks the log driver for the next region to
recover. Then, it sets the region state to DM\_RH\_RECOVERING. If there
are no pending I/Os on this region, the region is added to
quiesced\_regions list. If there are pending I/Os, the region is not
added to any list. It is added to the quiesced\_regions list later (by
dm\_rh\_dec function) when all I/Os finish.
- when the region is on quiesced\_regions list, there are no I/Os in
flight on this region. The region is popped from the list in
dm\_rh\_recovery\_start function. Then, a kcopyd job is started in the
recover function.
- when the kcopyd job finishes, recovery\_complete is called. It calls
dm\_rh\_recovery\_end. dm\_rh\_recovery\_end adds the region to
recovered\_regions or failed\_recovered\_regions list (depending on
whether the copy operation was successful or not).
The above mechanism assumes that if the region is in DM\_RH\_RECOVERING
state, no new I/Os are started on this region. When I/O is started,
dm\_rh\_inc\_pending is called, which increases reg->pending count. When
I/O is finished, dm\_rh\_dec is called. It decreases reg->pending count.
If the count is zero and the region was in DM\_RH\_RECOVERING state,
dm\_rh\_dec adds it to the quiesced\_regions list.
Consequently, if we call dm\_rh\_inc\_pending/dm\_rh\_dec while the region is
in DM\_RH\_RECOVERING state, it could be added to quiesced\_regions list
multiple times or it could be added to this list when kcopyd is copying
data (it is assumed that the region is not on any list while kcopyd does
its jobs). This results in memory corruption and crash.
There already exist bypasses for REQ\_FLUSH requests: REQ\_FLUSH requests
do not belong to any region, so they are always added to the sync list
in do\_writes. dm\_rh\_inc\_pending does not increase count for REQ\_FLUSH
requests. In mirror\_end\_io, dm\_rh\_dec is never called for REQ\_FLUSH
requests. These bypasses avoid the crash possibility described above.
These bypasses were improperly implemented for REQ\_DISCARD when
the mirror target gained discard support in commit
5fc2ffeabb9ee0fc0e71ff16b49f34f0ed3d05b4 (dm raid1: support discard).
In do\_writes, REQ\_DISCARD requests is always added to the sync queue and
immediately dispatched (even if the region is in DM\_RH\_RECOVERING). However,
dm\_rh\_inc and dm\_rh\_dec is called for REQ\_DISCARD resusts. So it violates the
rule that no I/Os are started on DM\_RH\_RECOVERING regions, and causes the list
corruption described above.
This patch changes it so that REQ\_DISCARD requests follow the same path
as REQ\_FLUSH. This avoids the crash.
Reference: https://bugzilla.redhat.com/837607
Signed-off-by: Mikulas Patocka
Signed-off-by: Alasdair G Kergon
Signed-off-by: Ben Hutchings
commit 4060625241ce9236e16174b45fbb452bb5d846d1
Author: Boaz Harrosh
Date: Fri Jun 8 02:02:30 2012 +0300
pnfs-obj: Fix \_\_r4w\_get\_page when offset is beyond i\_size
commit c999ff68029ebd0f56ccae75444f640f6d5a27d2 upstream.
It is very common for the end of the file to be unaligned on
stripe size. But since we know it's beyond file's end then
the XOR should be preformed with all zeros.
Old code used to just read zeros out of the OSD devices, which is a great
waist. But what scares me more about this situation is that, we now have
pages attached to the file's mapping that are beyond i\_size. I don't
like the kind of bugs this calls for.
Fix both birds, by returning a global zero\_page, if offset is beyond
i\_size.
TODO:
Change the API to ->\_\_r4w\_get\_page() so a NULL can be
returned without being considered as error, since XOR API
treats NULL entries as zero\_pages.
[Bug since 3.2. Should apply the same way to all Kernels since]
Signed-off-by: Boaz Harrosh
[bwh: Backported to 3.2: adjust for lack of wdata->header]
Signed-off-by: Ben Hutchings
commit 0ab51e8bbf2466f4426142773be0095ad0137848
Author: Boaz Harrosh
Date: Fri Jun 8 05:29:40 2012 +0300
pnfs-obj: don't leak objio\_state if ore\_write/read fails
commit 9909d45a8557455ca5f8ee7af0f253debc851f1a upstream.
[Bug since 3.2 Kernel]
Signed-off-by: Boaz Harrosh
Signed-off-by: Ben Hutchings
commit 3e17c16b921d72d121393b618bfe92992c8f3d1c
Author: Boaz Harrosh
Date: Fri Jun 8 04:30:40 2012 +0300
ore: Remove support of partial IO request (NFS crash)
commit 62b62ad873f2accad9222a4d7ffbe1e93f6714c1 upstream.
Do to OOM situations the ore might fail to allocate all resources
needed for IO of the full request. If some progress was possible
it would proceed with a partial/short request, for the sake of
forward progress.
Since this crashes NFS-core and exofs is just fine without it just
remove this contraption, and fail.
TODO:
Support real forward progress with some reserved allocations
of resources, such as mem pools and/or bio\_sets
[Bug since 3.2 Kernel]
CC: Benny Halevy
Signed-off-by: Boaz Harrosh
Signed-off-by: Ben Hutchings
commit c7003a9e7062f9b5233c4a80c8eec19eae30d171
Author: Boaz Harrosh
Date: Fri Jun 8 01:19:07 2012 +0300
ore: Fix NFS crash by supporting any unaligned RAID IO
commit 9ff19309a9623f2963ac5a136782ea4d8b5d67fb upstream.
In RAID\_5/6 We used to not permit an IO that it's end
byte is not stripe\_size aligned and spans more than one stripe.
.i.e the caller must check if after submission the actual
transferred bytes is shorter, and would need to resubmit
a new IO with the remainder.
Exofs supports this, and NFS was supposed to support this
as well with it's short write mechanism. But late testing has
exposed a CRASH when this is used with none-RPC layout-drivers.
The change at NFS is deep and risky, in it's place the fix
at ORE to lift the limitation is actually clean and simple.
So here it is below.
The principal here is that in the case of unaligned IO on
both ends, beginning and end, we will send two read requests
one like old code, before the calculation of the first stripe,
and also a new site, before the calculation of the last stripe.
If any "boundary" is aligned or the complete IO is within a single
stripe. we do a single read like before.
The code is clean and simple by splitting the old \_read\_4\_write
into 3 even parts:
1.\_read\_4\_write\_first\_stripe
2. \_read\_4\_write\_last\_stripe
3. \_read\_4\_write\_execute
And calling 1+3 at the same place as before. 2+3 before last
stripe, and in the case of all in a single stripe then 1+2+3
is preformed additively.
Why did I not think of it before. Well I had a strike of
genius because I have stared at this code for 2 years, and did
not find this simple solution, til today. Not that I did not try.
This solution is much better for NFS than the previous supposedly
solution because the short write was dealt with out-of-band after
IO\_done, which would cause for a seeky IO pattern where as in here
we execute in order. At both solutions we do 2 separate reads, only
here we do it within a single IO request. (And actually combine two
writes into a single submission)
NFS/exofs code need not change since the ORE API communicates the new
shorter length on return, what will happen is that this case would not
occur anymore.
hurray!!
[Stable this is an NFS bug since 3.2 Kernel should apply cleanly]
Signed-off-by: Boaz Harrosh
Signed-off-by: Ben Hutchings
commit 10f26f99904373a9cc5e7913ab581991cd4c5940
Author: Artem Bityutskiy
Date: Sat Jul 14 14:33:09 2012 +0300
UBIFS: fix a bug in empty space fix-up
commit c6727932cfdb13501108b16c38463c09d5ec7a74 upstream.
UBIFS has a feature called "empty space fix-up" which is a quirk to work-around
limitations of dumb flasher programs. Namely, of those flashers that are unable
to skip NAND pages full of 0xFFs while flashing, resulting in empty space at
the end of half-filled eraseblocks to be unusable for UBIFS. This feature is
relatively new (introduced in v3.0).
The fix-up routine (fixup\_free\_space()) is executed only once at the very first
mount if the superblock has the 'space\_fixup' flag set (can be done with -F
option of mkfs.ubifs). It basically reads all the UBIFS data and metadata and
writes it back to the same LEB. The routine assumes the image is pristine and
does not have anything in the journal.
There was a bug in 'fixup\_free\_space()' where it fixed up the log incorrectly.
All but one LEB of the log of a pristine file-system are empty. And one
contains just a commit start node. And 'fixup\_free\_space()' just unmapped this
LEB, which resulted in wiping the commit start node. As a result, some users
were unable to mount the file-system next time with the following symptom:
UBIFS error (pid 1): replay\_log\_leb: first log node at LEB 3:0 is not CS node
UBIFS error (pid 1): replay\_log\_leb: log error detected while replaying the log at LEB 3:0
The root-cause of this bug was that 'fixup\_free\_space()' wrongly assumed
that the beginning of empty space in the log head (c->lhead\_offs) was known
on mount. However, it is not the case - it was always 0. UBIFS does not store
in it the master node and finds out by scanning the log on every mount.
The fix is simple - just pass commit start node size instead of 0 to
'fixup\_leb()'.
Signed-off-by: Artem Bityutskiy
Reported-by: Iwo Mergler
Tested-by: Iwo Mergler
Reported-by: James Nute
Signed-off-by: Ben Hutchings
commit dc9391958a838458732358a7f29d78dda7774c65
Author: David Daney
Date: Thu Jul 19 09:11:14 2012 +0200
MIPS: Properly align the .data..init\_task section.
commit 7b1c0d26a8e272787f0f9fcc5f3e8531df3b3409 upstream.
Improper alignment can lead to unbootable systems and/or random
crashes.
[ralf@linux-mips.org: This is a lond standing bug since
6eb10bc9e2deab06630261cd05c4cb1e9a60e980 (kernel.org) rsp.
c422a10917f75fd19fa7fe070aaaa23e384dae6f (lmo) [MIPS: Clean up linker script
using new linker script macros.] so dates back to 2.6.32.]
Signed-off-by: David Daney
Cc: linux-mips@linux-mips.org
Patchwork: https://patchwork.linux-mips.org/patch/3881/
Signed-off-by: Ralf Baechle
Signed-off-by: Ben Hutchings
commit 987e84543bedce6d0e7ae8d986bb2f6e2cc31e53
Author: NeilBrown
Date: Thu Jul 19 15:59:18 2012 +1000
md/raid1: close some possible races on write errors during resync
commit 58e94ae18478c08229626daece2fc108a4a23261 upstream.
commit 4367af556133723d0f443e14ca8170d9447317cb
md/raid1: clear bad-block record when write succeeds.
Added a 'reschedule\_retry' call possibility at the end of
end\_sync\_write, but didn't add matching code at the end of
sync\_request\_write. So if the writes complete very quickly, or
scheduling makes it seem that way, then we can miss rescheduling
the request and the resync could hang.
Also commit 73d5c38a9536142e062c35997b044e89166e063b
md: avoid races when stopping resync.
Fix a race condition in this same code in end\_sync\_write but didn't
make the change in sync\_request\_write.
This patch updates sync\_request\_write to fix both of those.
Patch is suitable for 3.1 and later kernels.
Reported-by: Alexander Lyakas
Original-version-by: Alexander Lyakas
Signed-off-by: NeilBrown
Signed-off-by: Ben Hutchings
commit 068bd5de42ebc3a2aa2ef876614d7c7d11c79f6d
Author: NeilBrown
Date: Thu Jul 19 15:59:18 2012 +1000
md: avoid crash when stopping md array races with closing other open fds.
commit a05b7ea03d72f36edb0cec05e8893803335c61a0 upstream.
md will refuse to stop an array if any other fd (or mounted fs) is
using it.
When any fs is unmounted of when the last open fd is closed all
pending IO will be flushed (e.g. sync\_blockdev call in \_\_blkdev\_put)
so there will be no pending IO to worry about when the array is
stopped.
However in order to send the STOP\_ARRAY ioctl to stop the array one
must first get and open fd on the block device.
If some fd is being used to write to the block device and it is closed
after mdadm open the block device, but before mdadm issues the
STOP\_ARRAY ioctl, then there will be no last-close on the md device so
\_\_blkdev\_put will not call sync\_blockdev.
If this happens, then IO can still be in-flight while md tears down
the array and bad things can happen (use-after-free and subsequent
havoc).
So in the case where do\_md\_stop is being called from an open file
descriptor, call sync\_block after taking the mutex to ensure there
will be no new openers.
This is needed when setting a read-write device to read-only too.
Reported-by: majianpeng
Signed-off-by: NeilBrown
Signed-off-by: Ben Hutchings
commit e23f455279bab00dcd73e8dd26c5f262dd1e3cc2
Author: Aaditya Kumar
Date: Tue Jul 17 15:48:07 2012 -0700
mm: fix lost kswapd wakeup in kswapd\_stop()
commit 1c7e7f6c0703d03af6bcd5ccc11fc15d23e5ecbe upstream.
Offlining memory may block forever, waiting for kswapd() to wake up
because kswapd() does not check the event kthread->should\_stop before
sleeping.
The proper pattern, from Documentation/memory-barriers.txt, is:
--- waker ---
event\_indicated = 1;
wake\_up\_process(event\_daemon);
--- sleeper ---
for (;;) {
set\_current\_state(TASK\_UNINTERRUPTIBLE);
if (event\_indicated)
break;
schedule();
}
set\_current\_state() may be wrapped by:
prepare\_to\_wait();
In the kswapd() case, event\_indicated is kthread->should\_stop.
=== offlining memory (waker) ===
kswapd\_stop()
kthread\_stop()
kthread->should\_stop = 1
wake\_up\_process()
wait\_for\_completion()
=== kswapd\_try\_to\_sleep (sleeper) ===
kswapd\_try\_to\_sleep()
prepare\_to\_wait()
.
.
schedule()
.
.
finish\_wait()
The schedule() needs to be protected by a test of kthread->should\_stop,
which is wrapped by kthread\_should\_stop().
Reproducer:
Do heavy file I/O in background.
Do a memory offline/online in a tight loop
Signed-off-by: Aaditya Kumar
Acked-by: KOSAKI Motohiro
Reviewed-by: Minchan Kim
Acked-by: Mel Gorman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 61c0f23450473cda9d2d784ea778361095d50bc3
Author: Jeff Layton
Date: Fri Jul 6 07:09:42 2012 -0400
cifs: always update the inode cache with the results from a FIND\_\*
commit cd60042cc1392e79410dc8de9e9c1abb38a29e57 upstream.
When we get back a FIND\_FIRST/NEXT result, we have some info about the
dentry that we use to instantiate a new inode. We were ignoring and
discarding that info when we had an existing dentry in the cache.
Fix this by updating the inode in place when we find an existing dentry
and the uniqueid is the same.
Reported-and-Tested-by: Andrew Bartlett
Reported-by: Bill Robertson
Reported-by: Dion Edwards
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Ben Hutchings
commit 8e1e19fe1940b5b438273e92036964b1230b6766
Author: Jeff Layton
Date: Wed Jul 11 09:09:35 2012 -0400
cifs: on CONFIG\_HIGHMEM machines, limit the rsize/wsize to the kmap space
commit 3ae629d98bd5ed77585a878566f04f310adbc591 upstream.
We currently rely on being able to kmap all of the pages in an async
read or write request. If you're on a machine that has CONFIG\_HIGHMEM
set then that kmap space is limited, sometimes to as low as 512 slots.
With 512 slots, we can only support up to a 2M r/wsize, and that's
assuming that we can get our greedy little hands on all of them. There
are other users however, so it's possible we'll end up stuck with a
size that large.
Since we can't handle a rsize or wsize larger than that currently, cap
those options at the number of kmap slots we have. We could consider
capping it even lower, but we currently default to a max of 1M. Might as
well allow those luddites on 32 bit arches enough rope to hang
themselves.
A more robust fix would be to teach the send and receive routines how
to contend with an array of pages so we don't need to marshal up a kvec
array at all. That's a fairly significant overhaul though, so we'll need
this limit in place until that's ready.
Reported-by: Jian Li
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Ben Hutchings
commit 1edae5d5207b5c11e734a465fd0d8618952f74b4
Author: Roland Dreier
Date: Mon Jul 16 17:10:17 2012 -0700
target: Fix range calculation in WRITE SAME emulation when num blocks == 0
commit 1765fe5edcb83f53fc67edeb559fcf4bc82c6460 upstream.
When NUMBER OF LOGICAL BLOCKS is 0, WRITE SAME is supposed to write
all the blocks from the specified LBA through the end of the device.
However, dev->transport->get\_blocks(dev) (perhaps confusingly) returns
the last valid LBA rather than the number of blocks, so the correct
number of blocks to write starting with lba is
dev->transport->get\_blocks(dev) - lba + 1
(nab: Backport roland's for-3.6 patch to for-3.5)
Signed-off-by: Roland Dreier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Ben Hutchings
commit 6154c5bc1f1c0e02dd41bd96300c63e137bdee51
Author: Roland Dreier
Date: Mon Jul 16 15:17:10 2012 -0700
target: Clean up returning errors in PR handling code
commit d35212f3ca3bf4fb49d15e37f530c9931e2d2183 upstream.
- instead of (PTR\_ERR(file) < 0) just use IS\_ERR(file)
- return -EINVAL instead of EINVAL
- all other error returns in target\_scsi3\_emulate\_pr\_out() use
"goto out" -- get rid of the one remaining straight "return."
Signed-off-by: Roland Dreier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Ben Hutchings
commit 9729de799b03fd6141e1b248f063575a531f8f00
Author: Anders Kaseorg
Date: Sun Jul 15 17:14:25 2012 -0400
fifo: Do not restart open() if it already found a partner
commit 05d290d66be6ef77a0b962ebecf01911bd984a78 upstream.
If a parent and child process open the two ends of a fifo, and the
child immediately exits, the parent may receive a SIGCHLD before its
open() returns. In that case, we need to make sure that open() will
return successfully after the SIGCHLD handler returns, instead of
throwing EINTR or being restarted. Otherwise, the restarted open()
would incorrectly wait for a second partner on the other end.
The following test demonstrates the EINTR that was wrongly thrown from
the parent’s open(). Change .sa\_flags = 0 to .sa\_flags = SA\_RESTART
to see a deadlock instead, in which the restarted open() waits for a
second reader that will never come. (On my systems, this happens
pretty reliably within about 5 to 500 iterations. Others report that
it manages to loop ~forever sometimes; YMMV.)
#include
#include
#include
#include
#include
#include
#include
#include
#define CHECK(x) do if ((x) == -1) {perror(#x); abort();} while(0)
void handler(int signum) {}
int main()
{
struct sigaction act = {.sa\_handler = handler, .sa\_flags = 0};
CHECK(sigaction(SIGCHLD, &act, NULL));
CHECK(mknod("fifo", S\_IFIFO | S\_IRWXU, 0));
for (;;) {
int fd;
pid\_t pid;
putc('.', stderr);
CHECK(pid = fork());
if (pid == 0) {
CHECK(fd = open("fifo", O\_RDONLY));
\_exit(0);
}
CHECK(fd = open("fifo", O\_WRONLY));
CHECK(close(fd));
CHECK(waitpid(pid, NULL, 0));
}
}
This is what I suspect was causing the Git test suite to fail in
t9010-svn-fe.sh:
http://bugs.debian.org/678852
Signed-off-by: Anders Kaseorg
Reviewed-by: Jonathan Nieder
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 60d448613a4cf0b8e70c0d16abc6a6baf31ab9b5
Author: Mark Rustad
Date: Fri Jul 13 18:18:04 2012 -0700
tcm\_fc: Fix crash seen with aborts and large reads
commit 3cc5d2a6b9a2fd1bf024aa5e52dd22961eecaf13 upstream.
This patch fixes a crash seen when large reads have their exchange
aborted by either timing out or being reset. Because the exchange
abort results in the seq pointer being set to NULL, because the
sequence is no longer valid, it must not be dereferenced. This
patch changes the function ft\_get\_task\_tag to return ~0 if it is
unable to get the tag for this reason. Because the get\_task\_tag
interface provides no means of returning an error, this seems
like the best way to fix this issue at the moment.
Signed-off-by: Mark Rustad
Signed-off-by: Nicholas Bellinger
Signed-off-by: Ben Hutchings
commit df4372866de83261b79bf7af24c058649ed0f2eb
Author: Tushar Dave
Date: Thu Jul 12 08:56:56 2012 +0000
e1000e: Correct link check logic for 82571 serdes
commit d0efa8f23a644f7cb7d1f8e78dd9a223efa412a3 upstream.
SYNCH bit and IV bit of RXCW register are sticky. Before examining these bits,
RXCW should be read twice to filter out one-time false events and have correct
values for these bits. Incorrect values of these bits in link check logic can
cause weird link stability issues if auto-negotiation fails.
Reported-by: Dean Nelson
Signed-off-by: Tushar Dave
Reviewed-by: Bruce Allan
Tested-by: Jeff Pieper
Signed-off-by: Jeff Kirsher
Signed-off-by: Ben Hutchings
commit 154f4399c91b93519cd4a0ba0eceb21ced26c241
Author: Emmanuel Grumbach
Date: Wed Jul 4 13:59:08 2012 +0200
iwlegacy: don't mess up the SCD when removing a key
commit b48d96652626b315229b1b82c6270eead6a77a6d upstream.
When we remove a key, we put a key index which was supposed
to tell the fw that we are actually removing the key. But
instead the fw took that index as a valid index and messed
up the SRAM of the device.
This memory corruption on the device mangled the data of
the SCD. The impact on the user is that SCD queue 2 got
stuck after having removed keys.
Reported-by: Paul Bolle
Signed-off-by: Emmanuel Grumbach
Signed-off-by: Stanislaw Gruszka
Signed-off-by: John W. Linville
[bwh: Backported to 3.2: adjust filename, context and variable name]
Signed-off-by: Ben Hutchings
commit c9d907ded47a70b9cd66a39aa09dbce24c363ffa
Author: Stanislaw Gruszka
Date: Wed Jul 4 13:20:20 2012 +0200
iwlegacy: always monitor for stuck queues
commit c2ca7d92ed4bbd779516beb6eb226e19f7f7ab0f upstream.
This is iwlegacy version of:
commit 342bbf3fee2fa9a18147e74b2e3c4229a4564912
Author: Johannes Berg
Date: Sun Mar 4 08:50:46 2012 -0800
iwlwifi: always monitor for stuck queues
If we only monitor while associated, the following
can happen:
- we're associated, and the queue stuck check
runs, setting the queue "touch" time to X
- we disassociate, stopping the monitoring,
which leaves the time set to X
- almost 2s later, we associate, and enqueue
a frame
- before the frame is transmitted, we monitor
for stuck queues, and find the time set to
X, although it is now later than X + 2000ms,
so we decide that the queue is stuck and
erroneously restart the device
Signed-off-by: Stanislaw Gruszka
Signed-off-by: John W. Linville
[bwh: Backported to 3.2: adjust filename, function and variable names]
Signed-off-by: Ben Hutchings
commit 042083036e9d93fe1984e93b5e852c176e7fa0b5
Author: Stanislaw Gruszka
Date: Wed Jul 4 13:10:02 2012 +0200
rt2x00usb: fix indexes ordering on RX queue kick
commit efd821182cec8c92babef6e00a95066d3252fda4 upstream.
On rt2x00\_dmastart() we increase index specified by Q\_INDEX and on
rt2x00\_dmadone() we increase index specified by Q\_INDEX\_DONE. So entries
between Q\_INDEX\_DONE and Q\_INDEX are those we currently process in the
hardware. Entries between Q\_INDEX and Q\_INDEX\_DONE are those we can
submit to the hardware.
According to that fix rt2x00usb\_kick\_queue(), as we need to submit RX
entries that are not processed by the hardware. It worked before only
for empty queue, otherwise was broken.
Note that for TX queues indexes ordering are ok. We need to kick entries
that have filled skb, but was not submitted to the hardware, i.e.
started from Q\_INDEX\_DONE and have ENTRY\_DATA\_PENDING bit set.
From practical standpoint this fixes RX queue stall, usually reproducible
in AP mode, like for example reported here:
https://bugzilla.redhat.com/show\_bug.cgi?id=828824
Reported-and-tested-by: Franco Miceli
Reported-and-tested-by: Tom Horsley
Signed-off-by: Stanislaw Gruszka
Signed-off-by: John W. Linville
Signed-off-by: Ben Hutchings
commit e0dc11cd5466e1a433dde19ed0222dc08d9b8338
Author: Cloud Ren
Date: Tue Jul 3 16:51:48 2012 +0000
atl1c: fix issue of transmit queue 0 timed out
commit b94e52f62683dc0b00c6d1b58b80929a078c0fd5 upstream.
some people report atl1c could cause system hang with following
kernel trace info:
---------------------------------------
WARNING: at.../net/sched/sch\_generic.c:258 dev\_watchdog+0x1db/0x1d0()
...
NETDEV WATCHDOG: eth0 (atl1c): transmit queue 0 timed out
...
---------------------------------------
This is caused by netif\_stop\_queue calling when cable Link is down.
So remove netif\_stop\_queue, because link\_watch will take it over.
Signed-off-by: xiong
Signed-off-by: Cloud Ren
Signed-off-by: David S. Miller
[bwh: Backported to 3.2: adjust context]
Signed-off-by: Ben Hutchings
commit 023f9dff8c3f00dffb38f5185493df46d251c9f8
Author: Takashi Iwai
Date: Mon Jun 25 15:07:17 2012 +0200
intel\_ips: blacklist HP ProBook laptops
commit 88ca518b0bb4161e5f20f8a1d9cc477cae294e54 upstream.
intel\_ips driver spews the warning message
"ME failed to update for more than 1s, likely hung"
at each second endlessly on HP ProBook laptops with IronLake.
As this has never worked, better to blacklist the driver for now.
Signed-off-by: Takashi Iwai
Signed-off-by: Matthew Garrett
Signed-off-by: Ben Hutchings
commit 1885f653e200137b46671a61ca321ab2356821b7
Author: Michal Kazior
Date: Fri Jun 8 10:55:44 2012 +0200
cfg80211: check iface combinations only when iface is running
commit f8cdddb8d61d16a156229f0910f7ecfc7a82c003 upstream.
Don't validate interface combinations on a stopped
interface. Otherwise we might end up being able to
create a new interface with a certain type, but
won't be able to change an existing interface
into that type.
This also skips some other functions when
interface is stopped and changing interface type.
Signed-off-by: Michal Kazior
Signed-off-by: Johannes Berg
Signed-off-by: Ben Hutchings
commit 6ed6791a1697afcb1615b4252d0c304a743b5f4d
Author: Bojan Smojver
Date: Sun Apr 29 22:42:06 2012 +0200
PM / Hibernate: Hibernate/thaw fixes/improvements
commit 5a21d489fd9541a4a66b9a500659abaca1b19a51 upstream.
1. Do not allocate memory for buffers from emergency pools, unless
absolutely required. Do not warn about and do not retry non-essential
failed allocations.
2. Do not check the amount of free pages left on every single page
write, but wait until one map is completely populated and then check.
3. Set maximum number of pages for read buffering consistently, instead
of inadvertently depending on the size of the sector type.
4. Fix copyright line, which I missed when I submitted the hibernation
threading patch.
5. Dispense with bit shifting arithmetic to improve readability.
6. Really recalculate the number of pages required to be free after all
allocations have been done.
7. Fix calculation of pages required for read buffering. Only count in
pages that do not belong to high memory.
Signed-off-by: Bojan Smojver
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Ben Hutchings
commit bce3ff4945779822c2d778ac29011d5eecc7330a
Author: Samuel Ortiz
Date: Thu May 10 19:45:51 2012 +0200
NFC: Export nfc.h to userland
commit dbd4fcaf8d664fab4163b1f8682e41ad8bff3444 upstream.
The netlink commands and attributes, along with the socket structure
definitions need to be exported.
Signed-off-by: Samuel Ortiz
Signed-off-by: John W. Linville
Signed-off-by: Ben Hutchings
commit 8f2c5a741019b7ed10643040fe72e6152ee16ed6
Author: Dave Jones
Date: Fri Jul 13 13:35:36 2012 -0400
Remove easily user-triggerable BUG from generic\_setlease
commit 8d657eb3b43861064d36241e88d9d61c709f33f0 upstream.
This can be trivially triggered from userspace by passing in something unexpected.
kernel BUG at fs/locks.c:1468!
invalid opcode: 0000 [#1] SMP
RIP: 0010:generic\_setlease+0xc2/0x100
Call Trace:
\_\_vfs\_setlease+0x35/0x40
fcntl\_setlease+0x76/0x150
sys\_fcntl+0x1c6/0x810
system\_call\_fastpath+0x1a/0x1f
Signed-off-by: Dave Jones
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 631a86fc5ceb30586f87e5fb9cb7827c8c10f570
Author: Jeff Moyer
Date: Thu Jul 12 09:43:14 2012 -0400
block: fix infinite loop in \_\_getblk\_slow
commit 91f68c89d8f35fe98ea04159b9a3b42d0149478f upstream.
Commit 080399aaaf35 ("block: don't mark buffers beyond end of disk as
mapped") exposed a bug in \_\_getblk\_slow that causes mount to hang as it
loops infinitely waiting for a buffer that lies beyond the end of the
disk to become uptodate.
The problem was initially reported by Torsten Hilbrich here:
https://lkml.org/lkml/2012/6/18/54
and also reported independently here:
http://www.sysresccd.org/forums/viewtopic.php?f=13&t=4511
and then Richard W.M. Jones and Marcos Mello noted a few separate
bugzillas also associated with the same issue. This patch has been
confirmed to fix:
https://bugzilla.redhat.com/show\_bug.cgi?id=835019
The main problem is here, in \_\_getblk\_slow:
for (;;) {
struct buffer\_head \* bh;
int ret;
bh = \_\_find\_get\_block(bdev, block, size);
if (bh)
return bh;
ret = grow\_buffers(bdev, block, size);
if (ret < 0)
return NULL;
if (ret == 0)
free\_more\_memory();
}
\_\_find\_get\_block does not find the block, since it will not be marked as
mapped, and so grow\_buffers is called to fill in the buffers for the
associated page. I believe the for (;;) loop is there primarily to
retry in the case of memory pressure keeping grow\_buffers from
succeeding. However, we also continue to loop for other cases, like the
block lying beond the end of the disk. So, the fix I came up with is to
only loop when grow\_buffers fails due to memory allocation issues
(return value of 0).
The attached patch was tested by myself, Torsten, and Rich, and was
found to resolve the problem in call cases.
Signed-off-by: Jeff Moyer
Reported-and-Tested-by: Torsten Hilbrich
Tested-by: Richard W.M. Jones
Reviewed-by: Josh Boyer
[ Jens is on vacation, taking this directly - Linus ]
--
Stable Notes: this patch requires backport to 3.0, 3.2 and 3.3.
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 3bbc9e1917b93542c0da222e06496f37d1e82182
Author: Todd Poynor
Date: Fri Jul 13 15:30:48 2012 +0900
ARM: SAMSUNG: fix race in s3c\_adc\_start for ADC
commit 8265981bb439f3ecc5356fb877a6c2a6636ac88a upstream.
Checking for adc->ts\_pend already claimed should be done with the
lock held.
Signed-off-by: Todd Poynor
Acked-by: Ben Dooks
Signed-off-by: Kukjin Kim
Signed-off-by: Ben Hutchings
commit eb42f93d7f329d7ff24d99975ce144f01b1990fb
Author: Jean Delvare
Date: Thu Jul 12 22:47:37 2012 +0200
hwmon: (it87) Preserve configuration register bits on init
commit 41002f8dd5938d5ad1d008ce5bfdbfe47fa7b4e8 upstream.
We were accidentally losing one bit in the configuration register on
device initialization. It was reported to freeze one specific system
right away. Properly preserve all bits we don't explicitly want to
change in order to prevent that.
Reported-by: Stevie Trujillo
Signed-off-by: Jean Delvare
Reviewed-by: Guenter Roeck
Signed-off-by: Ben Hutchings
commit 51954298d48d86e5b7b11c9aeab316a407a039e9
Author: Thomas Renninger
Date: Thu Jul 12 12:24:33 2012 +0200
cpufreq / ACPI: Fix not loading acpi-cpufreq driver regression
commit c4686c71a9183f76e3ef59098da5c098748672f6 upstream.
Commit d640113fe80e45ebd4a5b420b introduced a regression on SMP
systems where the processor core with ACPI id zero is disabled
(typically should be the case because of hyperthreading).
The regression got spread through stable kernels.
On 3.0.X it got introduced via 3.0.18.
Such platforms may be rare, but do exist.
Look out for a disabled processor with acpi\_id 0 in dmesg:
ACPI: LAPIC (acpi\_id[0x00] lapic\_id[0x10] disabled)
This problem has been observed on a:
HP Proliant BL280c G6 blade
This patch restricts the introduced workaround to platforms
with nr\_cpu\_ids <= 1.
Signed-off-by: Thomas Renninger
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Ben Hutchings
commit 3501ec357a73226d2b3c1bd204d97926f61b3eae
Author: Bob Liu
Date: Wed Jul 11 14:02:35 2012 -0700
fs: ramfs: file-nommu: add SetPageUptodate()
commit fea9f718b3d68147f162ed2d870183ce5e0ad8d8 upstream.
There is a bug in the below scenario for !CONFIG\_MMU:
1. create a new file
2. mmap the file and write to it
3. read the file can't get the correct value
Because
sys\_read() -> generic\_file\_aio\_read() -> simple\_readpage() -> clear\_page()
which causes the page to be zeroed.
Add SetPageUptodate() to ramfs\_nommu\_expand\_for\_mapping() so that
generic\_file\_aio\_read() do not call simple\_readpage().
Signed-off-by: Bob Liu
Cc: Hugh Dickins
Cc: David Howells
Cc: Geert Uytterhoeven
Cc: Greg Ungerer
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit d1d5b31c0f73da39cc084af6240601543763f99d
Author: Benoît Thébaudeau
Date: Wed Jul 11 14:02:32 2012 -0700
drivers/rtc/rtc-mxc.c: fix irq enabled interrupts warning
commit b59f6d1febd6cbe9fae4589bf72da0ed32bc69e0 upstream.
Fixes
WARNING: at irq/handle.c:146 handle\_irq\_event\_percpu+0x19c/0x1b8()
irq 25 handler mxc\_rtc\_interrupt+0x0/0xac enabled interrupts
Modules linked in:
(unwind\_backtrace+0x0/0xf0) from (warn\_slowpath\_common+0x4c/0x64)
(warn\_slowpath\_common+0x4c/0x64) from (warn\_slowpath\_fmt+0x30/0x40)
(warn\_slowpath\_fmt+0x30/0x40) from (handle\_irq\_event\_percpu+0x19c/0x1b8)
(handle\_irq\_event\_percpu+0x19c/0x1b8) from (handle\_irq\_event+0x28/0x38)
(handle\_irq\_event+0x28/0x38) from (handle\_level\_irq+0x80/0xc4)
(handle\_level\_irq+0x80/0xc4) from (generic\_handle\_irq+0x24/0x38)
(generic\_handle\_irq+0x24/0x38) from (handle\_IRQ+0x30/0x84)
(handle\_IRQ+0x30/0x84) from (avic\_handle\_irq+0x2c/0x4c)
(avic\_handle\_irq+0x2c/0x4c) from (\_\_irq\_svc+0x40/0x60)
Exception stack(0xc050bf60 to 0xc050bfa8)
bf60: 00000001 00000000 003c4208 c0018e20 c050a000 c050a000 c054a4c8 c050a000
bf80: c05157a8 4117b363 80503bb4 00000000 01000000 c050bfa8 c0018e2c c000e808
bfa0: 60000013 ffffffff
(\_\_irq\_svc+0x40/0x60) from (default\_idle+0x1c/0x30)
(default\_idle+0x1c/0x30) from (cpu\_idle+0x68/0xa8)
(cpu\_idle+0x68/0xa8) from (start\_kernel+0x22c/0x26c)
Signed-off-by: Benoît Thébaudeau
Cc: Alessandro Zummo
Cc: Sascha Hauer
Acked-by: Uwe Kleine-König
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit e13d6560aa9799d9720afea1480093166f6e767a
Author: David Rientjes
Date: Wed Jul 11 14:02:13 2012 -0700
mm, thp: abort compaction if migration page cannot be charged to memcg
commit 4bf2bba3750f10aa9e62e6949bc7e8329990f01b upstream.
If page migration cannot charge the temporary page to the memcg,
migrate\_pages() will return -ENOMEM. This isn't considered in memory
compaction however, and the loop continues to iterate over all
pageblocks trying to isolate and migrate pages. If a small number of
very large memcgs happen to be oom, however, these attempts will mostly
be futile leading to an enormous amout of cpu consumption due to the
page migration failures.
This patch will short circuit and fail memory compaction if
migrate\_pages() returns -ENOMEM. COMPACT\_PARTIAL is returned in case
some migrations were successful so that the page allocator will retry.
Signed-off-by: David Rientjes
Acked-by: Mel Gorman
Cc: Minchan Kim
Cc: Kamezawa Hiroyuki
Cc: Rik van Riel
Cc: Andrea Arcangeli
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 5eb695db655214b28a44040db35c43178541bcc8
Author: Luis Henriques
Date: Wed Jul 11 14:02:10 2012 -0700
ocfs2: fix NULL pointer dereference in \_\_ocfs2\_change\_file\_space()
commit a4e08d001f2e50bb8b3c4eebadcf08e5535f02ee upstream.
As ocfs2\_fallocate() will invoke \_\_ocfs2\_change\_file\_space() with a NULL
as the first parameter (file), it may trigger a NULL pointer dereferrence
due to a missing check.
Addresses http://bugs.launchpad.net/bugs/1006012
Signed-off-by: Luis Henriques
Reported-by: Bret Towe
Tested-by: Bret Towe
Cc: Sunil Mushran
Acked-by: Joel Becker
Acked-by: Mark Fasheh
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 0906d248e8fddbd583fe4dd15631f4c2be2eb3b4
Author: Jiang Liu
Date: Wed Jul 11 14:01:52 2012 -0700
memory hotplug: fix invalid memory access caused by stale kswapd pointer
commit d8adde17e5f858427504725218c56aef90e90fc7 upstream.
kswapd\_stop() is called to destroy the kswapd work thread when all memory
of a NUMA node has been offlined. But kswapd\_stop() only terminates the
work thread without resetting NODE\_DATA(nid)->kswapd to NULL. The stale
pointer will prevent kswapd\_run() from creating a new work thread when
adding memory to the memory-less NUMA node again. Eventually the stale
pointer may cause invalid memory access.
An example stack dump as below. It's reproduced with 2.6.32, but latest
kernel has the same issue.
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: [] exit\_creds+0x12/0x78
PGD 0
Oops: 0000 [#1] SMP
last sysfs file: /sys/devices/system/memory/memory391/state
CPU 11
Modules linked in: cpufreq\_conservative cpufreq\_userspace cpufreq\_powersave acpi\_cpufreq microcode fuse loop dm\_mod tpm\_tis rtc\_cmos i2c\_i801 rtc\_core tpm serio\_raw pcspkr sg tpm\_bios igb i2c\_core iTCO\_wdt rtc\_lib mptctl iTCO\_vendor\_support button dca bnx2 usbhid hid uhci\_hcd ehci\_hcd usbcore sd\_mod crc\_t10dif edd ext3 mbcache jbd fan ide\_pci\_generic ide\_core ata\_generic ata\_piix libata thermal processor thermal\_sys hwmon mptsas mptscsih mptbase scsi\_transport\_sas scsi\_mod
Pid: 7949, comm: sh Not tainted 2.6.32.12-qiuxishi-5-default #92 Tecal RH2285
RIP: 0010:exit\_creds+0x12/0x78
RSP: 0018:ffff8806044f1d78 EFLAGS: 00010202
RAX: 0000000000000000 RBX: ffff880604f22140 RCX: 0000000000019502
RDX: 0000000000000000 RSI: 0000000000000202 RDI: 0000000000000000
RBP: ffff880604f22150 R08: 0000000000000000 R09: ffffffff81a4dc10
R10: 00000000000032a0 R11: ffff880006202500 R12: 0000000000000000
R13: 0000000000c40000 R14: 0000000000008000 R15: 0000000000000001
FS: 00007fbc03d066f0(0000) GS:ffff8800282e0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b
CR2: 0000000000000000 CR3: 000000060f029000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process sh (pid: 7949, threadinfo ffff8806044f0000, task ffff880603d7c600)
Stack:
ffff880604f22140 ffffffff8103aac5 ffff880604f22140 ffffffff8104d21e
ffff880006202500 0000000000008000 0000000000c38000 ffffffff810bd5b1
0000000000000000 ffff880603d7c600 00000000ffffdd29 0000000000000003
Call Trace:
\_\_put\_task\_struct+0x5d/0x97
kthread\_stop+0x50/0x58
offline\_pages+0x324/0x3da
memory\_block\_change\_state+0x179/0x1db
store\_mem\_state+0x9e/0xbb
sysfs\_write\_file+0xd0/0x107
vfs\_write+0xad/0x169
sys\_write+0x45/0x6e
system\_call\_fastpath+0x16/0x1b
Code: ff 4d 00 0f 94 c0 84 c0 74 08 48 89 ef e8 1f fd ff ff 5b 5d 31 c0 41 5c c3 53 48 8b 87 20 06 00 00 48 89 fb 48 8b bf 18 06 00 00 <8b> 00 48 c7 83 18 06 00 00 00 00 00 00 f0 ff 0f 0f 94 c0 84 c0
RIP exit\_creds+0x12/0x78
RSP
CR2: 0000000000000000
[akpm@linux-foundation.org: add pglist\_data.kswapd locking comments]
Signed-off-by: Xishi Qiu
Signed-off-by: Jiang Liu
Acked-by: KAMEZAWA Hiroyuki
Acked-by: KOSAKI Motohiro
Acked-by: Mel Gorman
Acked-by: David Rientjes
Reviewed-by: Minchan Kim
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit 88153b5ca6da2602bac3f4185d9732f1547b8480
Author: Alan Stern
Date: Mon Jul 9 11:09:21 2012 -0400
PCI: EHCI: fix crash during suspend on ASUS computers
commit dbf0e4c7257f8d684ec1a3c919853464293de66e upstream.
Quite a few ASUS computers experience a nasty problem, related to the
EHCI controllers, when going into system suspend. It was observed
that the problem didn't occur if the controllers were not put into the
D3 power state before starting the suspend, and commit
151b61284776be2d6f02d48c23c3625678960b97 (USB: EHCI: fix crash during
suspend on ASUS computers) was created to do this.
It turned out this approach messed up other computers that didn't have
the problem -- it prevented USB wakeup from working. Consequently
commit c2fb8a3fa25513de8fedb38509b1f15a5bbee47b (USB: add
NO\_D3\_DURING\_SLEEP flag and revert 151b61284776be2) was merged; it
reverted the earlier commit and added a whitelist of known good board
names.
Now we know the actual cause of the problem. Thanks to AceLan Kao for
tracking it down.
According to him, an engineer at ASUS explained that some of their
BIOSes contain a bug that was added in an attempt to work around a
problem in early versions of Windows. When the computer goes into S3
suspend, the BIOS tries to verify that the EHCI controllers were first
quiesced by the OS. Nothing's wrong with this, but the BIOS does it
by checking that the PCI COMMAND registers contain 0 without checking
the controllers' power state. If the register isn't 0, the BIOS
assumes the controller needs to be quiesced and tries to do so. This
involves making various MMIO accesses to the controller, which don't
work very well if the controller is already in D3. The end result is
a system hang or memory corruption.
Since the value in the PCI COMMAND register doesn't matter once the
controller has been suspended, and since the value will be restored
anyway when the controller is resumed, we can work around the BIOS bug
simply by setting the register to 0 during system suspend. This patch
(as1590) does so and also reverts the second commit mentioned above,
which is now unnecessary.
In theory we could do this for every PCI device. However to avoid
introducing new problems, the patch restricts itself to EHCI host
controllers.
Finally the affected systems can suspend with USB wakeup working
properly.
Reference: https://bugzilla.kernel.org/show\_bug.cgi?id=37632
Reference: https://bugzilla.kernel.org/show\_bug.cgi?id=42728
Based-on-patch-by: AceLan Kao
Signed-off-by: Alan Stern
Tested-by: Dâniel Fraga
Tested-by: Javier Marcet
Tested-by: Andrey Rahmatullin
Tested-by: Oleksij Rempel
Tested-by: Pavel Pisa
Acked-by: Bjorn Helgaas
Acked-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit 33c050f877ba0d95c43a2bc81f3e6870fa8b0a6b
Author: NeilBrown
Date: Mon Jul 9 11:34:13 2012 +1000
md/raid1: fix use-after-free bug in RAID1 data-check code.
commit 2d4f4f3384d4ef4f7c571448e803a1ce721113d5 upstream.
This bug has been present ever since data-check was introduce
in 2.6.16. However it would only fire if a data-check were
done on a degraded array, which was only possible if the array
has 3 or more devices. This is certainly possible, but is quite
uncommon.
Since hot-replace was added in 3.3 it can happen more often as
the same condition can arise if not all possible replacements are
present.
The problem is that as soon as we submit the last read request, the
'r1\_bio' structure could be freed at any time, so we really should
stop looking at it. If the last device is being read from we will
stop looking at it. However if the last device is not due to be read
from, we will still check the bio pointer in the r1\_bio, but the
r1\_bio might already be free.
So use the read\_targets counter to make sure we stop looking for bios
to submit as soon as we have submitted them all.
This fix is suitable for any -stable kernel since 2.6.16.
Reported-by: Arnold Schulz
Signed-off-by: NeilBrown
[bwh: Backported to 3.2: no doubling of conf->raid\_disks; we don't have
hot-replace support]
Signed-off-by: Ben Hutchings
commit cb480c94c8e89014cdb54201a413bf9d36f6cd41
Author: Dan Williams
Date: Fri Jun 22 10:52:34 2012 -0700
libsas: fix taskfile corruption in sas\_ata\_qc\_fill\_rtf
commit 6ef1b512f4e6f936d89aa20be3d97a7ec7c290ac upstream.
fill\_result\_tf() grabs the taskfile flags from the originating qc which
sas\_ata\_qc\_fill\_rtf() promptly overwrites. The presence of an
ata\_taskfile in the sata\_device makes it tempting to just copy the full
contents in sas\_ata\_qc\_fill\_rtf(). However, libata really only wants
the fis contents and expects the other portions of the taskfile to not
be touched by ->qc\_fill\_rtf. To that end store a fis buffer in the
sata\_device and use ata\_tf\_from\_fis() like every other ->qc\_fill\_rtf()
implementation.
Reported-by: Praveen Murali
Tested-by: Praveen Murali
Signed-off-by: Dan Williams
Signed-off-by: James Bottomley
[bwh: Backported to 3.2: adjust context]
Signed-off-by: Ben Hutchings
commit 1e1cdddbadc5f3044882127f3931a19f48b1a69b
Author: Shinya Kuribayashi
Date: Sat Jul 7 13:37:42 2012 +0300
hwspinlock/core: use global ID to register hwspinlocks on multiple devices
commit 476a7eeb60e70ddab138e7cb4bc44ef5ac20782e upstream.
Commit 300bab9770 (hwspinlock/core: register a bank of hwspinlocks in a
single API call, 2011-09-06) introduced 'hwspin\_lock\_register\_single()'
to register numerous (a bank of) hwspinlock instances in a single API,
'hwspin\_lock\_register()'.
At which time, 'hwspin\_lock\_register()' accidentally passes 'local IDs'
to 'hwspin\_lock\_register\_single()', despite that ...\_single() requires
'global IDs' to register hwspinlocks.
We have to convert into global IDs by supplying the missing 'base\_id'.
Signed-off-by: Shinya Kuribayashi
[ohad: fix error path of hwspin\_lock\_register, too]
Signed-off-by: Ohad Ben-Cohen
Signed-off-by: Ben Hutchings
commit c4c5d62cb86eedb8aa4b87b2b8ae9f2b909b0b5b
Author: Santosh Nayak
Date: Sat Jun 23 07:59:54 2012 -0300
dvb-core: Release semaphore on error path dvb\_register\_device()
commit 82163edcdfa4eb3d74516cc8e9f38dd3d039b67d upstream.
There is a missing "up\_write()" here. Semaphore should be released
before returning error value.
Signed-off-by: Santosh Nayak
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Ben Hutchings
commit f01e43b25ec9d9b682ed5204bb9077bafdbb7abc
Author: Herton Ronaldo Krzesinski
Date: Wed May 16 16:21:52 2012 -0300
mtd: nandsim: don't open code a do\_div helper
commit 596fd46268634082314b3af1ded4612e1b7f3f03 upstream.
We don't need to open code the divide function, just use div\_u64 that
already exists and do the same job. While this is a straightforward
clean up, there is more to that, the real motivation for this.
While building on a cross compiling environment in armel, using gcc
4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu5), I was getting the following build
error:
ERROR: "\_\_aeabi\_uldivmod" [drivers/mtd/nand/nandsim.ko] undefined!
After investigating with objdump and hand built assembly version
generated with the compiler, I narrowed \_\_aeabi\_uldivmod as being
generated from the divide function. When nandsim.c is built with
-fno-inline-functions-called-once, that happens when
CONFIG\_DEBUG\_SECTION\_MISMATCH is enabled, the do\_div optimization in
arch/arm/include/asm/div64.h doesn't work as expected with the open
coded divide function: even if the do\_div we are using doesn't have a
constant divisor, the compiler still includes the else parts of the
optimized do\_div macro, and translates the divisions there to use
\_\_aeabi\_uldivmod, instead of only calling \_\_do\_div\_asm -> \_\_do\_div64 and
optimizing/removing everything else out.
So to reproduce, gcc 4.6 plus CONFIG\_DEBUG\_SECTION\_MISMATCH=y and
CONFIG\_MTD\_NAND\_NANDSIM=m should do it, building on armel.
After this change, the compiler does the intended thing even with
-fno-inline-functions-called-once, and optimizes out as expected the
constant handling in the optimized do\_div on arm. As this also avoids a
build issue, I'm marking for Stable, as I think is applicable for this
case.
Signed-off-by: Herton Ronaldo Krzesinski
Acked-by: Nicolas Pitre
Signed-off-by: Artem Bityutskiy
Signed-off-by: David Woodhouse
Signed-off-by: Ben Hutchings
commit ec299e27c68a3481017762def2e5f2f73d9ac43c
Author: Bjørn Mork
Date: Mon Jul 2 10:33:14 2012 +0200
USB: cdc-wdm: fix lockup on error in wdm\_read
commit b086b6b10d9f182cd8d2f0dcfd7fd11edba93fc9 upstream.
Clear the WDM\_READ flag on empty reads to avoid running
forever in an infinite tight loop, causing lockups:
Jul 1 21:58:11 nemi kernel: [ 3658.898647] qmi\_wwan 2-1:1.2: Unexpected error -71
Jul 1 21:58:36 nemi kernel: [ 3684.072021] BUG: soft lockup - CPU#0 stuck for 23s! [qmi.pl:12235]
Jul 1 21:58:36 nemi kernel: [ 3684.072212] CPU 0
Jul 1 21:58:36 nemi kernel: [ 3684.072355]
Jul 1 21:58:36 nemi kernel: [ 3684.072367] Pid: 12235, comm: qmi.pl Tainted: P O 3.5.0-rc2+ #13 LENOVO 2776LEG/2776LEG
Jul 1 21:58:36 nemi kernel: [ 3684.072383] RIP: 0010:[] [] spin\_unlock\_irq+0x8/0xc [cdc\_wdm]
Jul 1 21:58:36 nemi kernel: [ 3684.072388] RSP: 0018:ffff88022dca1e70 EFLAGS: 00000282
Jul 1 21:58:36 nemi kernel: [ 3684.072393] RAX: ffff88022fc3f650 RBX: ffffffff811c56f7 RCX: 00000001000ce8c1
Jul 1 21:58:36 nemi kernel: [ 3684.072398] RDX: 0000000000000010 RSI: 000000000267d810 RDI: ffff88022fc3f650
Jul 1 21:58:36 nemi kernel: [ 3684.072403] RBP: ffff88022dca1eb0 R08: ffffffffa063578e R09: 0000000000000000
Jul 1 21:58:36 nemi kernel: [ 3684.072407] R10: 0000000000000008 R11: 0000000000000246 R12: 0000000000000002
Jul 1 21:58:36 nemi kernel: [ 3684.072412] R13: 0000000000000246 R14: ffffffff00000002 R15: ffff8802281d8c88
Jul 1 21:58:36 nemi kernel: [ 3684.072418] FS: 00007f666a260700(0000) GS:ffff88023bc00000(0000) knlGS:0000000000000000
Jul 1 21:58:36 nemi kernel: [ 3684.072423] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Jul 1 21:58:36 nemi kernel: [ 3684.072428] CR2: 000000000270d9d8 CR3: 000000022e865000 CR4: 00000000000007f0
Jul 1 21:58:36 nemi kernel: [ 3684.072433] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
Jul 1 21:58:36 nemi kernel: [ 3684.072438] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Jul 1 21:58:36 nemi kernel: [ 3684.072444] Process qmi.pl (pid: 12235, threadinfo ffff88022dca0000, task ffff88022ff76380)
Jul 1 21:58:36 nemi kernel: [ 3684.072448] Stack:
Jul 1 21:58:36 nemi kernel: [ 3684.072458] ffffffffa063592e 0000000100020000 ffff88022fc3f650 ffff88022fc3f6a8
Jul 1 21:58:36 nemi kernel: [ 3684.072466] 0000000000000200 0000000100000000 000000000267d810 0000000000000000
Jul 1 21:58:36 nemi kernel: [ 3684.072475] 0000000000000000 ffff880212cfb6d0 0000000000000200 ffff880212cfb6c0
Jul 1 21:58:36 nemi kernel: [ 3684.072479] Call Trace:
Jul 1 21:58:36 nemi kernel: [ 3684.072489] [] ? wdm\_read+0x1a0/0x263 [cdc\_wdm]
Jul 1 21:58:36 nemi kernel: [ 3684.072500] [] ? vfs\_read+0xa1/0xfb
Jul 1 21:58:36 nemi kernel: [ 3684.072509] [] ? alarm\_setitimer+0x35/0x64
Jul 1 21:58:36 nemi kernel: [ 3684.072517] [] ? sys\_read+0x45/0x6e
Jul 1 21:58:36 nemi kernel: [ 3684.072525] [] ? system\_call\_fastpath+0x16/0x1b
Jul 1 21:58:36 nemi kernel: [ 3684.072557] Code: <66> 66 90 c3 83 ff ed 89 f8 74 16 7f 06 83 ff a1 75 0a c3 83 ff f4
The WDM\_READ flag is normally cleared by wdm\_int\_callback
before resubmitting the read urb, and set by wdm\_in\_callback
when this urb returns with data or an error. But a crashing
device may cause both a read error and cancelling all urbs.
Make sure that the flag is cleared by wdm\_read if the buffer
is empty.
We don't clear the flag on errors, as there may be pending
data in the buffer which should be processed. The flag will
instead be cleared on the next wdm\_read call.
Signed-off-by: Bjørn Mork
Acked-by: Oliver Neukum
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit 8d8052f842113d653a0129ed78a1ebdb7dfb62dd
Author: Gaosen Zhang
Date: Thu Jul 5 21:49:00 2012 +0800
USB: option: Add MEDIATEK product ids
commit aacef9c561a693341566a6850c451ce3df68cb9a upstream.
Signed-off-by: Gaosen Zhang
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit c3bc4100aadffb067a9e7fa96c3ed03a34e238ff
Author: Bjørn Mork
Date: Mon Jul 2 19:53:55 2012 +0200
USB: option: add ZTE MF60
commit 8e16e33c168a6efd0c9f7fa9dd4c1e1db9a74553 upstream.
Switches into a composite device by ejecting the initial
driver CD. The four interfaces are: QCDM, AT, QMI/wwan
and mass storage. Let this driver manage the two serial
interfaces:
T: Bus=02 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 28 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs= 1
P: Vendor=19d2 ProdID=1402 Rev= 0.00
S: Manufacturer=ZTE,Incorporated
S: Product=ZTE WCDMA Technologies MSM
S: SerialNumber=xxxxx
C:\* #Ifs= 4 Cfg#= 1 Atr=c0 MxPwr=500mA
I:\* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
E: Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi\_wwan
E: Ad=83(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:\* If#= 3 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
E: Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
Signed-off-by: Bjørn Mork
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Ben Hutchings
commit d9a5888a4162d8e06eb909d31cbe5c779c8b67dc
Author: Peter Zijlstra
Date: Fri Jun 22 15:52:09 2012 +0200
sched/nohz: Rewrite and fix load-avg computation -- again
commit 5167e8d5417bf5c322a703d2927daec727ea40dd upstream.
Thanks to Charles Wang for spotting the defects in the current code:
- If we go idle during the sample window -- after sampling, we get a
negative bias because we can negate our own sample.
- If we wake up during the sample window we get a positive bias
because we push the sample to a known active period.
So rewrite the entire nohz load-avg muck once again, now adding
copious documentation to the code.
Reported-and-tested-by: Doug Smythies
Reported-and-tested-by: Charles Wang
Signed-off-by: Peter Zijlstra
Cc: Linus Torvalds
Cc: Andrew Morton
Link: http://lkml.kernel.org/r/1340373782.18025.74.camel@twins
[ minor edits ]
Signed-off-by: Ingo Molnar
[bwh: Backported to 3.2: adjust filenames, context]
Signed-off-by: Ben Hutchings
commit 43fc6bce37ff39ab5010afadf1ea86e7cc9c2b37
Author: Mark Brown
Date: Sat Jun 9 11:07:56 2012 +0800
gpiolib: wm8994: Pay attention to the value set when enabling as output
commit 8cd578b6e28693f357867a77598a88ef3deb6b39 upstream.
Not paying attention to the value being set is a bad thing because it
means that we'll not set the hardware up to reflect what was requested.
Not setting the hardware up to reflect what was requested means that the
caller won't get the results they wanted.
Signed-off-by: Mark Brown
Signed-off-by: Linus Walleij
Signed-off-by: Ben Hutchings
commit db46b26cf3a124bd5beb357e48c0e2ea6e2f1725
Author: Stanislaw Ledwon
Date: Mon Jun 18 15:20:00 2012 +0200
usb: Add support for root hub port status CAS
commit 8bea2bd37df08aaa599aa361a9f8b836ba98e554 upstream.
The host controller port status register supports CAS (Cold Attach
Status) bit. This bit could be set when USB3.0 device is connected
when system is in Sx state. When the system wakes to S0 this port
status with CAS bit is reported and this port can't be used by any
device.
When CAS bit is set the port should be reset by warm reset. This
was not supported by xhci driver.
The issue was found when pendrive was connected to suspended
platform. The link state of "Compliance Mode" was reported together
with CAS bit. This link state was also not supported by xhci and
core/hub.c.
The CAS bit is defined only for xhci root hub port and it is
not supported on regular hubs. The link status is used to force
warm reset on port. Make the USB core issue a warm reset when port
is in ether the 'inactive' or 'compliance mode'. Change the xHCI driver
to report 'compliance mode' when the CAS is set. This force warm reset
on the root hub port.
This patch should be backported to stable kernels as old as 3.2, that
contain the commit 10d674a82e553cb8a1f41027bb3c3e309b3f6804 "USB: When
hot reset for USB3 fails, try warm reset."
Signed-off-by: Stanislaw Ledwon
Signed-off-by: Sarah Sharp
Acked-by: Andiry Xu
Signed-off-by: Ben Hutchings
commit f2d391c109ecc377d55f7865ac8ea26ac8921ab7
Author: Joerg Roedel
Date: Thu Jun 21 14:52:40 2012 +0200
iommu/amd: Initialize dma\_ops for hotplug and sriov devices
commit ac1534a55d1e87d59a21c09c570605933b551480 upstream.
When a device is added to the system at runtime the AMD
IOMMU driver initializes the necessary data structures to
handle translation for it. But it forgets to change the
per-device dma\_ops to point to the AMD IOMMU driver. So
mapping actually never happens and all DMA accesses end in
an IO\_PAGE\_FAULT. Fix this.
Reported-by: Stefan Assmann
Signed-off-by: Joerg Roedel
[bwh: Backported to 3.2:
- Adjust context
- Use global iommu\_pass\_through; there is no per-device pass\_through]
Signed-off-by: Ben Hutchings
commit f17963661759dfde573f9d7993cf5aa5a97057c3
Author: Shuah Khan
Date: Wed Jun 6 10:50:06 2012 -0600
iommu/amd: Fix missing iommu\_shutdown initialization in passthrough mode
commit f2f12b6fc032c7b1419fd6db84e2868b5f05a878 upstream.
The iommu\_shutdown callback is not initialized when the AMD
IOMMU driver runs in passthrough mode. Fix that by moving
the callback initialization before the check for
passthrough mode.
Signed-off-by: Shuah Khan
Signed-off-by: Joerg Roedel
[bwh: Backported to 3.2: adjust context]
Signed-off-by: Ben Hutchings
commit 11a5b0b59b9b38e71fa45bd9739a6f4ffa8ce61a
Author: Jason Baron
Date: Wed Apr 25 16:01:47 2012 -0700
epoll: clear the tfile\_check\_list on -ELOOP
commit 13d518074a952d33d47c428419693f63389547e9 upstream.
An epoll\_ctl(,EPOLL\_CTL\_ADD,,) operation can return '-ELOOP' to prevent
circular epoll dependencies from being created. However, in that case we
do not properly clear the 'tfile\_check\_list'. Thus, add a call to
clear\_tfile\_check\_list() for the -ELOOP case.
Signed-off-by: Jason Baron
Reported-by: Yurij M. Plotnikov
Cc: Nelson Elhage
Cc: Davide Libenzi
Tested-by: Alexandra N. Kossovsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Ben Hutchings
commit f45c9a6eec20cd712421c442785e7a4e9215a230
Author: Jan Kara
Date: Fri Jun 15 12:52:46 2012 +0200
scsi: Silence unnecessary warnings about ioctl to partition
commit 6d9359280753d2955f86d6411047516a9431eb51 upstream.
Sometimes, warnings about ioctls to partition happen often enough that they
form majority of the warnings in the kernel log and users complain. In some
cases warnings are about ioctls such as SG\_IO so it's not good to get rid of
the warnings completely as they can ease debugging of userspace problems
when ioctl is refused.
Since I have seen warnings from lots of commands, including some proprietary
userspace applications, I don't think disallowing the ioctls for processes
with CAP\_SYS\_RAWIO will happen in the near future if ever. So lets just
stop warning for processes with CAP\_SYS\_RAWIO for which ioctl is allowed.
CC: Paolo Bonzini
CC: James Bottomley
CC: linux-scsi@vger.kernel.org
Acked-by: Paolo Bonzini
Signed-off-by: Jan Kara
Signed-off-by: Jens Axboe
[bwh: Backported to 3.2: use ENOTTY, not ENOIOCTLCMD]
Signed-off-by: Ben Hutchings
commit 0f3cbc35d2097d2c655789dd4996e7b87bdb5d34
Author: Avi Kivity
Date: Sun Apr 22 17:02:11 2012 +0300
KVM: Fix buffer overflow in kvm\_set\_irq()
commit f2ebd422f71cda9c791f76f85d2ca102ae34a1ed upstream.
kvm\_set\_irq() has an internal buffer of three irq routing entries, allowing
connecting a GSI to three IRQ chips or on MSI. However setup\_routing\_entry()
does not properly enforce this, allowing three irqchip routes followed by
an MSI route to overflow the buffer.
Fix by ensuring that an MSI entry is added to an empty list.
Signed-off-by: Avi Kivity
Signed-off-by: Ben Hutchings
commit 1be535a022a9c0b9a55cab2993ee29e05c4ead0b
Author: Jason Wang
Date: Wed May 2 11:42:15 2012 +0800
macvtap: zerocopy: validate vectors before building skb
commit b92946e2919134ebe2a4083e4302236295ea2a73 upstream.
There're several reasons that the vectors need to be validated:
- Return error when caller provides vectors whose num is greater than UIO\_MAXIOV.
- Linearize part of skb when userspace provides vectors grater than MAX\_SKB\_FRAGS.
- Return error when userspace provides vectors whose total length may exceed
- MAX\_SKB\_FRAGS \* PAGE\_SIZE.
Signed-off-by: Jason Wang
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit cc64214d05941d09bb9f80051a1949a7223b8ab7
Author: Jason Wang
Date: Wed May 2 11:42:06 2012 +0800
macvtap: zerocopy: set SKBTX\_DEV\_ZEROCOPY only when skb is built successfully
commit 01d6657b388438def19c8baaea28e742b6ed32ec upstream.
Current the SKBTX\_DEV\_ZEROCOPY is set unconditionally after
zerocopy\_sg\_from\_iovec(), this would lead NULL pointer when macvtap
fails to build zerocopy skb because destructor\_arg was not
initialized. Solve this by set this flag after the skb were built
successfully.
Signed-off-by: Jason Wang
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit e9214638ead441c15b48f40c3b459aede77c2662
Author: Jason Wang
Date: Wed May 2 11:41:58 2012 +0800
macvtap: zerocopy: put page when fail to get all requested user pages
commit 02ce04bb3d28c3333231f43bca677228dbc686fe upstream.
When get\_user\_pages\_fast() fails to get all requested pages, we could not use
kfree\_skb() to free it as it has not been put in the skb fragments. So we need
to call put\_page() instead.
Signed-off-by: Jason Wang
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit 14180f501e674f1bbe352d37c962ede4d8f679d4
Author: Jason Wang
Date: Wed May 2 11:41:44 2012 +0800
macvtap: zerocopy: fix truesize underestimation
commit 4ef67ebedffa44ed9939b34708ac2fee06d2f65f upstream.
As the skb fragment were pinned/built from user pages, we should
account the page instead of length for truesize.
Signed-off-by: Jason Wang
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit c1b5b21b540f22a8e008d30545c044a6c949b47b
Author: Jason Wang
Date: Wed May 2 11:41:30 2012 +0800
macvtap: zerocopy: fix offset calculation when building skb
commit 3afc9621f15701c557e60f61eba9242bac2771dd upstream.
This patch fixes the offset calculation when building skb:
- offset1 were used as skb data offset not vector offset
- reset offset to zero only when we advance to next vector
Signed-off-by: Jason Wang
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Ben Hutchings
commit 9046e979413d3a05057ae9995cebf93eed24f80c
Author: Trond Myklebust
Date: Wed Feb 8 13:39:15 2012 -0500
NFSv4: Further reduce the footprint of the idmapper
commit 685f50f9188ac1e8244d0340a9d6ea36b6136cec upstream.
Don't allocate the legacy idmapper tables until we actually need
them.
Signed-off-by: Trond Myklebust
Reviewed-by: Jeff Layton
[bwh: Backported to 3.2: adjust context in nfs\_idmap\_delete()]
Signed-off-by: Ben Hutchings
commit 805292ea678d4855d1f12db5f1c1d1444b92d9d7
Author: Trond Myklebust
Date: Tue Feb 7 14:59:05 2012 -0500
NFSv4: Reduce the footprint of the idmapper
commit d073e9b541e1ac3f52d72c3a153855d9a9ee3278 upstream.
Instead of pre-allocating the storage for all the strings, we can
significantly reduce the size of that table by doing the allocation
when we do the downcall.
Signed-off-by: Trond Myklebust
Reviewed-by: Jeff Layton
[bwh: Backported to 3.2: adjust context in nfs\_idmap\_delete()]
Signed-off-by: Ben Hutchings
commit 8fc536fc7a502841b732edfc6d5a66f3c138132d
Author: David Gibson
Date: Wed Mar 21 16:34:12 2012 -0700
hugepages: fix use after free bug in "quota" handling
commit 90481622d75715bfcb68501280a917dbfe516029 upstream.
hugetlbfs\_{get,put}\_quota() are badly named. They don't interact with the
general quota handling code, and they don't much resemble its behaviour.
Rather than being about maintaining limits on on-disk block usage by
particular users, they are instead about maintaining limits on in-memory
page usage (including anonymous MAP\_PRIVATE copied-on-write pages)
associated with a particular hugetlbfs filesystem instance.
Worse, they work by having callbacks to the hugetlbfs filesystem code from
the low-level page handling code, in particular from free\_huge\_page().
This is a layering violation of itself, but more importantly, if the
kernel does a get\_user\_pages() on hugepages (which can happen from KVM
amongst others), then the free\_huge\_page() can be delayed until after the
associated inode has already been freed. If an unmount occurs at the
wrong time, even the hugetlbfs superblock where the "quota" limits are
stored may have been freed.
Andrew Barry proposed a patch to fix this by having hugepages, instead of
storing a pointer to their address\_space and reaching the superblock from
there, had the hugepages store pointers directly to the superblock,
bumping the reference count as appropriate to avoid it being freed.
Andrew Morton rejected that version, however, on the grounds that it made
the existing layering violation worse.
This is a reworked version of Andrew's patch, which removes the extra, and
some of the existing, layering violation. It works by introducing the
concept of a hugepage "subpool" at the lower hugepage mm layer - that is a
finite logical pool of hugepages to allocate from. hugetlbfs now creates
a subpool for each filesystem instance with a page limit set, and a
pointer to the subpool gets added to each allocated hugepage, instead of
the address\_space pointer used now. The subpool has its own lifetime and
is only freed once all pages in it \_and\_ all other references to it (i.e.
superblocks) are gone.
subpools are optional - a NULL subpool pointer is taken by the code to
mean that no subpool limits are in effect.
Previous discussion of this bug found in: "Fix refcounting in hugetlbfs
quota handling.". See: https://lkml.org/lkml/2011/8/11/28 or
http://marc.info/?l=linux-mm&m=126928970510627&w=1
v2: Fixed a bug spotted by Hillf Danton, and removed the extra parameter to
alloc\_huge\_page() - since it already takes the vma, it is not necessary.
Signed-off-by: Andrew Barry
Signed-off-by: David Gibson
Cc: Hugh Dickins
Cc: Mel Gorman
Cc: Minchan Kim
Cc: Hillf Danton
Cc: Paul Mackerras
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
[bwh: Backported to 3.2: adjust context to apply after commit
c50ac050811d6485616a193eb0f37bfbd191cc89 'hugetlb: fix resv\_map leak in
error path', backported in 3.2.20]
Signed-off-by: Ben Hutchings
commit 42bc7c990b1a040fbfc94b8cad7fd8f626040b51
Author: Ben Hutchings
Date: Wed Jan 4 21:22:51 2012 -0500
ext4: Report max\_batch\_time option correctly
commit 1d526fc91bea04ee35b7599bf8b82f86c0aaf46c upstream.
Currently the value reported for max\_batch\_time is really the
value of min\_batch\_time.
Reported-by: Russell Coker
Signed-off-by: Ben Hutchings
commit 3116aea632aa83185953d9ca52d216dd524cb845
Author: William Dauchy
Date: Wed Mar 14 12:32:04 2012 +0100
NFSv4: Rate limit the state manager for lock reclaim warning messages
commit 96dcadc2fdd111dca90d559f189a30c65394451a upstream.
Adding rate limit on `Lock reclaim failed` messages since it could fill
up system logs
Signed-off-by: William Dauchy
Signed-off-by: Trond Myklebust
[bwh: Backported to 3.2: add the 'NFS:' prefix at the same time]
Signed-off-by: Ben Hutchings
commit 1c095fd3e95b6edf46016ac77ad78a61522ce8ed
Author: Eldad Zack
Date: Sun Apr 22 00:48:04 2012 +0200
brcmsmac: "INTERMEDIATE but not AMPDU" only when tracing
commit 6ead629b27269c553c9092c47cd8f5ab0309ee3b upstream.
I keep getting the following messages on the log buffer:
[ 2167.097507] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2281.331305] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2281.332539] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2329.876605] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2329.877354] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2462.280756] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
[ 2615.651689] ieee80211 phy0: brcms\_c\_dotxstatus: INTERMEDIATE but not AMPDU
From the code comment I understand that this something that can -
and does, quite frequently - happen.
Signed-off-by: Eldad Zack
Acked-by: Franky Lin
Signed-off-by: John W. Linville
Signed-off-by: Ben Hutchings
commit 3838461c8d7479c84129c2744a3fab53e269e340
Author: Lucas De Marchi
Date: Tue Jan 17 14:50:51 2012 -0200
kbuild: do not check for ancient modutils tools
commit 620c231c7a7f48745094727bb612f6321cfc8844 upstream.
scripts/depmod.sh checks for the output of '-V' expecting that it has
module-init-tools in it. It's a hack to prevent users from using
modutils instead of module-init-tools, that only works with 2.4.x
kernels. This however prints an annoying warning for kmod tool, that is
currently replacing module-init-tools.
Rather than putting another check for kmod's version, just remove it
since users of 2.4.x kernel are unlikely to upgrade to 3.x, and if they
do, let depmod fail in that case because they should know what they are
doing.
Signed-off-by: Lucas De Marchi
Acked-by: WANG Cong
Acked-By: Kay Sievers
Signed-off-by: Michal Marek
Signed-off-by: Ben Hutchings
commit 1e084e62f89d60c15dc4fc282a68309e793daa1b
Author: Eugeni Dodonov
Date: Thu Feb 23 23:57:06 2012 -0200
drm/i915: fix operator precedence when enabling RC6p
commit c0e2ee1bc0cf82eec89e26b7afe7e4db0561b7d9 upstream.
As noticed by Torsten Kaiser, the operator precedence can play tricks with
us here.
CC: Dave Airlie
Signed-off-by: Eugeni Dodonov
Signed-off-by: Jesse Barnes
Signed-off-by: Ben Hutchings
commit c90a4d1a113285fedbab465d2fd398f31c294170
Author: Eugeni Dodonov
Date: Tue Feb 14 11:44:48 2012 -0200
drm/i915: do not enable RC6p on Sandy Bridge
commit 1c8ecf80fdee4e7b23a9e7da7ff9bd59ba2dcf96 upstream.
With base on latest findings, RC6p seems to be respondible for RC6-related
issues on Sandy Bridge platform. To work-around those issues, the previous
solution was to completely disable RC6 on Sandy Bridge for the past few
releases, even if plain RC6 was not giving any issues.
What this patch does is preventing RC6p from being enabled on Sandy Bridge
even if users enable RC6 via a kernel parameter. So it won't change the
defaults in any way, but will ensure that if users do enable RC6 manually
it won't break their machines by enabling this extra state.
Proper fix for this (enabling specific RC6 states according to the GPU
generation) were proposed for the -next kernel, but we are too late in the
release process now to pick such changes.
Acked-by: Keith Packard
Signed-off-by: Eugeni Dodonov
Signed-off-by: Jesse Barnes
Signed-off-by: Ben Hutchings
commit e31a54c572423d13f14a904b87a41c93a011af78
Author: Stanislav Yakovlev
Date: Tue Apr 10 21:44:47 2012 -0400
net/wireless: ipw2x00: add supported cipher suites to wiphy initialization
commit a141e6a0097118bb35024485f1faffc0d9042f5c upstream.
Driver doesn't report its supported cipher suites through cfg80211
interface. It still uses wext interface and probably will not work
through nl80211, but will at least correctly advertise supported
features.
Bug was reported by Omar Siam.
https://bugzilla.kernel.org/show\_bug.cgi?id=43049
Signed-off-by: Stanislav Yakovlev
Signed-off-by: John W. Linville
Signed-off-by: Ben Hutchings
commit e6a46daaf4287c4b6dc00d19868aa8e9f160eb5b
Author: Stanislaw Gruszka
Date: Wed May 16 11:06:21 2012 +0200
rtl8187: ->brightness\_set can not sleep
commit 0fde0a8cfd0ede7f310d6a681c8e5a7cb3e32406 upstream.
Fix:
BUG: sleeping function called from invalid context at kernel/workqueue.c:2547
in\_atomic(): 1, irqs\_disabled(): 0, pid: 629, name: wpa\_supplicant
2 locks held by wpa\_supplicant/629:
#0: (rtnl\_mutex){+.+.+.}, at: [] rtnl\_lock+0x14/0x20
#1: (&trigger->leddev\_list\_lock){.+.?..}, at: [] led\_trigger\_event+0x21/0x80
Pid: 629, comm: wpa\_supplicant Not tainted 3.3.0-0.rc3.git5.1.fc17.i686
Call Trace:
[] \_\_might\_sleep+0x126/0x1d0
[] wait\_on\_work+0x2c/0x1d0
[] \_\_cancel\_work\_timer+0x6a/0x120
[] cancel\_delayed\_work\_sync+0x10/0x20
[] rtl8187\_led\_brightness\_set+0x82/0xf0 [rtl8187]
[] led\_trigger\_event+0x5c/0x80
[] ieee80211\_led\_radio+0x1d/0x40 [mac80211]
[] ieee80211\_stop\_device+0x13/0x230 [mac80211]
Removing \_sync is ok, because if led\_on work is currently running
it will be finished before led\_off work start to perform, since
they are always queued on the same mac80211 local->workqueue.
Bugzilla: https://bugzilla.redhat.com/show\_bug.cgi?id=795176
Signed-off-by: Stanislaw Gruszka
Acked-by: Larry Finger
Acked-by: Hin-Tak Leung
Signed-off-by: John W. Linville
Signed-off-by: Ben Hutchings
commit 3aa9b60af8f3bc95ad279ebfac202abf97ade173
Author: Matt Carlson
Date: Thu Jun 7 12:56:54 2012 +0000
tg3: Apply short DMA frag workaround to 5906
commit b7abee6ef888117f92db370620ebf116a38e3f4d upstream.
5906 devices also need the short DMA fragment workaround. This patch
makes the necessary change.
Signed-off-by: Matt Carlson
Tested-by: Christian Kujau
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit e6364fb003c0bc98c5fcde51aac6fd3b6a1337c3
Author: Eric Dumazet
Date: Fri Dec 2 23:41:42 2011 +0000
tcp: drop SYN+FIN messages
commit fdf5af0daf8019cec2396cdef8fb042d80fe71fa upstream.
Denys Fedoryshchenko reported that SYN+FIN attacks were bringing his
linux machines to their limits.
Dont call conn\_request() if the TCP flags includes SYN flag
Reported-by: Denys Fedoryshchenko
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Ben Hutchings
commit c0159c780e8d42309d04e83271986274d3880826
Author: Shaohua Li
Date: Tue Jul 3 15:57:19 2012 +1000
raid5: delayed stripe fix
commit fab363b5ff502d1b39ddcfec04271f5858d9f26e upstream.
There isn't locking setting STRIPE\_DELAYED and STRIPE\_PREREAD\_ACTIVE bits, but
the two bits have relationship. A delayed stripe can be moved to hold list only
when preread active stripe count is below IO\_THRESHOLD. If a stripe has both
the bits set, such stripe will be in delayed list and preread count not 0,
which will make such stripe never leave delayed list.
Signed-off-by: Shaohua Li
Signed-off-by: NeilBrown
Signed-off-by: Ben Hutchings
commit 60b179a2ff59ad09e8217e9dd7266fb23a080ded
Author: Corentin Chary
Date: Sat Nov 26 11:00:10 2011 +0100
samsung-laptop: make the dmi check less strict
commit 3be324a94df0c3f032178d04549dbfbf6cccb09a upstream.
This enable the driver for everything that look like
a laptop and is from vendor "SAMSUNG ELECTRONICS CO., LTD.".
Note that laptop supported by samsung-q10 seem to have a different
vendor strict.
Also remove every log output until we know that we have a SABI interface
(except if the driver is forced to load, or debug is enabled).
Keeping a whitelist of laptop with a model granularity is something that can't
work without close vendor cooperation (and we don't have that).
Signed-off-by: Corentin Chary
Acked-by: Greg Kroah-Hartman
Signed-off-by: Matthew Garrett
[bwh: Backported to 3.2:
- Adjust context
- Drop changes relating to ACPI video]
Signed-off-by: Ben Hutchings


=== Content from bugzilla.redhat.com_7b078e3b_20250125_031206.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D826702)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D826702)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D826702)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 826702

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 826702**](show_bug.cgi?id=826702)
(CVE-2012-2663)
- [CVE-2012-2663](https://access.redhat.com/security/cve/CVE-2012-2663) iptables: --syn flag bypass

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2012-2663 iptables: --syn flag bypass

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2012-2663 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [879100](show_bug.cgi?id=879100) | | TreeView+ | [depends on](buglist.cgi?bug_id=826702&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=826702&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2012-05-30 19:45 UTC by Kurt Seifried | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2022-07-25 16:29 UTC ([History](show_activity.cgi?id=826702)) | | [CC List:](page.cgi?id=fields.html#cclist) | 20 users (show)  agordeev anton arozansk avaddara dhoward fhrbata fweimer gbarros john.haxby kernel-mgr lwang plougher pmatouse ppandit sforsber steve.beattie tgraf vcizek wnefal+redhatbugzilla yohmura | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2014-03-10 12:39:45 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=826702#c0)  Kurt Seifried    2012-05-30 19:45:29 UTC  ``` Originally reported as a DoS related issue:  <http://git.kernel.org/?p=linux/kernel/git/davem/net-next.git;a=commitdiff;h=fdf5af0daf8019cec2396cdef8fb042d80fe71fa>  Denys Fedoryshchenko reported that SYN+FIN attacks were bringing his linux machines to their limits.  Dont call conn_request() if the TCP flags includes SYN flag  ---  This issue also allows bypass of --syn rules in iptables:  <http://www.spinics.net/lists/netfilter-devel/msg21248.html>  Unfortunately, with current stable Linux kernel release (as well as with most of the previous versions) blocking TCP packets with the SYN bit set and the ACK,RST and FIN bits cleared won't prevent incoming TCP connections.  It should be noted that the combination of SYN+FIN in a TCP-IP packet is generally "illegal" and serves no legitimate purpose.   ```  [Comment 2](show_bug.cgi?id=826702#c2)  Kurt Seifried    2012-05-30 20:09:42 UTC  ``` The -m state --state NEW rules do not appear to be bypassed by the combination of SYN+FIN, so a potential workaround is to use rules such as:  -A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j DROP  to control access rather than rules such as:  -A INPUT -p tcp --syn --dport 22 -j DROP   ```  [Comment 3](show_bug.cgi?id=826702#c3)  Florian Weimer    2012-05-31 07:59:20 UTC  ``` Older kernels will accept SYN+FIN because they have remnants of T/TCP support (see RFCs 1379, 1644; RFC 6247 moved them to HISTORIC for security issues).  We went over this when in 2002, it was discovered that the Cisco IOS "established" ACL keyword would let segments with SYN+RST flags pass, which would be interpreted as plain SYN by some stacks (including Linux), thus bypassing the packet filter.  ([CVE-2002-2438](https://access.redhat.com/security/cve/CVE-2002-2438), as discussed on oss-security.)  At that time, we did not feel comfortable with outlowing the Linux SYN+FIN behavior, even though it was clearly known at that time (e.g., <<http://cert.uni-stuttgart.de/ticker/article.php?mid=1006>>, it's German, sorry).  Obviously, the Internet has moved on since then.  My actual concern here is that the proposed change only moves the goalposts.  We discard a crafted packet earlier.  The next time, attackers will use a flag combination which gets past the initial filter, and the impact of the attack will be similar to what happened before.   ```  [Comment 5](show_bug.cgi?id=826702#c5)  Kurt Seifried    2012-05-31 17:39:27 UTC  ``` To clarify: this CVE was meant for the syn+fin processing vulnerability in iptables, not the Linux Kernel.   ```  [Comment 18](show_bug.cgi?id=826702#c18)  Petr Matousek    2014-03-10 12:39:45 UTC  ``` Statement:  This issue does affect Red Hat Enterprise Linux 5 and 6.  The risks in breaking compatability associated with fixing this flaw outweigh the benefits of the fix, therefore Red Hat does not plan to fix this flaw in Red Hat Enterprise Linux 5 and 6.  Please note that the remote DoS issue in the way how Linux kernel treats SYN+FIN flags set is being handled under different CVE, [CVE-2012-6638](https://access.redhat.com/security/cve/CVE-2012-6638), and is planned to be fixed in all affected Red Hat Enterprise Linux releases.   ```  [Comment 19](show_bug.cgi?id=826702#c19)  Petr Matousek    2014-03-10 12:43:13 UTC  ``` Mitigation:  Instead of --syn use --tcp-flags SYN,RST,ACK SYN in your rulesets in case you want to also match packets with both SYN+FIN flags set.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=826702&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from access.redhat.com_f78a640c_20250126_054043.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from github.com_c8af8932_20250125_031207.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffdf5af0daf8019cec2396cdef8fb042d80fe71fa)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffdf5af0daf8019cec2396cdef8fb042d80fe71fa)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/fdf5af0daf8019cec2396cdef8fb042d80fe71fa)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

tcp: drop SYN+FIN messages

[Browse files](/torvalds/linux/tree/fdf5af0daf8019cec2396cdef8fb042d80fe71fa)
Browse the repository at this point in the history

```
Denys Fedoryshchenko reported that SYN+FIN attacks were bringing his
linux machines to their limits.

Dont call conn_request() if the TCP flags includes SYN flag

Reported-by: Denys Fedoryshchenko <denys@visp.net.lb>
Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
```

* Loading branch information

[![@davem330](https://avatars.githubusercontent.com/u/1053866?s=40&v=4)](/davem330)

Eric Dumazet
authored and
[davem330](/torvalds/linux/commits?author=davem330 "View all commits by davem330")
committed
Dec 4, 2011

1 parent
[78a8a36](/torvalds/linux/commit/78a8a36fe0b2cee5a0a7360107815cbcad5b4003)

commit fdf5af0

Showing
**1 changed file**
with
**2 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[net/ipv4/tcp\_input.c](#diff-0d3389ce2dcd134567fb4d6fa05c89016f7922a044391ef933f79cd265edc4d3 "net/ipv4/tcp_input.c")

Show comments

[View file](/torvalds/linux/blob/fdf5af0daf8019cec2396cdef8fb042d80fe71fa/net/ipv4/tcp_input.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5811,6 +5811,8 @@ int tcp\_rcv\_state\_process(struct sock \*sk, struct sk\_buff \*skb, |
|  |  | goto discard; |
|  |  |  |
|  |  | if (th->syn) { |
|  |  | if (th->fin) |
|  |  | goto discard; |
|  |  | if (icsk->icsk\_af\_ops->conn\_request(sk, skb) < 0) |
|  |  | return 1; |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `fdf5af0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ffdf5af0daf8019cec2396cdef8fb042d80fe71fa) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


