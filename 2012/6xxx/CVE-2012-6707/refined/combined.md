=== Content from core.trac.wordpress.org_eaccebbc_20250126_005129.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Make WordPress Core](https://make.wordpress.org/core/)

* [Blog](https://make.wordpress.org/core/)
* [Handbook](https://make.wordpress.org/core/handbook/)
* [Tickets](https://make.wordpress.org/core/reports/)
* [Components](https://make.wordpress.org/core/components/)
* [Browse Source](https://core.trac.wordpress.org/browser "Browse Source")
* [Trac Timeline](https://core.trac.wordpress.org/timeline "Trac Timeline")
* [Create a New Ticket](https://login.wordpress.org/?redirect_to=https://core.trac.wordpress.org/newticket "Create a New Ticket")

Search:

* [Login](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fcore.trac.wordpress.org%2Fticket%2F21022)
* [Notifications](https://make.wordpress.org/core/notifications/)

## Context Navigation

* ← [Previous Ticket](/ticket/21021 "Ticket #21021")
* [Next Ticket](/ticket/21023 "Ticket #21023") →

---

Opened [13 years ago](/timeline?from=2012-06-20T01%3A34%3A26Z&precision=second "See timeline at 06/20/2012 01:34:26 AM")

Last modified [2 days ago](/timeline?from=2025-01-23T21%3A09%3A40Z&precision=second "See timeline at 01/23/2025 09:09:40 PM")

## [#21022](/ticket/21022) [accepted](/query?status=accepted) [enhancement](/query?status=!closed&type=enhancement)

# Use bcrypt for password hashing; updating old hashes

| Reported by: | [th23's profile](https://profiles.wordpress.org/th23) [th23](/query?status=!closed&reporter=th23) | Owned by: | [johnbillion's profile](https://profiles.wordpress.org/johnbillion) [johnbillion](/query?status=!closed&owner=johnbillion) |
| --- | --- | --- | --- |
| Milestone: | [6.8](/milestone/6.8 "No date set") | Priority: | [normal](/query?status=!closed&priority=normal) |
| Severity: | [normal](/query?status=!closed&severity=normal) | Version: | [3.4](/query?status=!closed&version=3.4) |
| Component: | [Security](/query?status=!closed&component=Security) | Keywords: | [has-patch](/query?status=!closed&keywords=~has-patch) [needs-testing](/query?status=!closed&keywords=~needs-testing) [has-unit-tests](/query?status=!closed&keywords=~has-unit-tests) |
| Focuses: |  | Cc: |  |

### Description [(last modified by SergeyBiryukov)](/ticket/21022?action=diff&version=125 "2020-08-01 19:05:47.887663+00:00")

Hi,

following recent discussions on password security and how to best prevent any hackers can leverage password table they might have got I looked into the phpass used for WordPress.

While I in principle understand why WordPress uses the compatibility mode of it, I would like to see some flexibility for those who don't need the compatibility.

Thus I would propose to change in wp-includes/pluggable.php all occurances of

```
$wp_hasher = new PasswordHash(8, true);

```

to

```
$wp_hasher = new PasswordHash(8, apply_filters('phpass_compatibility_mode', true));

```

This would allow users to easily change via plugin from the "not so secure" compatibility mode (only salted MD5) of phpass to a more secure setting (bcrypt) in case no compatibility with other applications is required.

The plugin changing the encryption methog could then as easy as

```
function phpass_bcrypt() {
	return false;
}
add_filter('phpass_compatibility_mode', 'phpass_bcrypt');

```

### Attachments (4)

[use\_bcrypt.diff](/attachment/ticket/21022/use_bcrypt.diff "View attachment")[​](/raw-attachment/ticket/21022/use_bcrypt.diff "Download") (1.8 KB) - added by harrym [12 years ago](/timeline?from=2012-11-07T19%3A34%3A16Z&precision=second "See timeline at 11/07/2012 07:34:16 PM").

Patch to use bcrypt by default

[21022.2.diff](/attachment/ticket/21022/21022.2.diff "View attachment")[​](/raw-attachment/ticket/21022/21022.2.diff "Download") (2.8 KB) - added by iandunn [11 years ago](/timeline?from=2014-02-22T07%3A49%3A27Z&precision=second "See timeline at 02/22/2014 07:49:27 AM").

Updates a few more calls to PasswordHash()

[21022.3.diff](/attachment/ticket/21022/21022.3.diff "View attachment")[​](/raw-attachment/ticket/21022/21022.3.diff "Download") (19.6 KB) - added by tomdxw [8 years ago](/timeline?from=2016-09-27T19%3A03%3A16Z&precision=second "See timeline at 09/27/2016 07:03:16 PM").

Use bcrypt where possible, upgrade portable hashes, show error message when downgrading to < PHP 5.3.7

[21022.4.diff](/attachment/ticket/21022/21022.4.diff "View attachment")[​](/raw-attachment/ticket/21022/21022.4.diff "Download") (14.0 KB) - added by bgermann [6 years ago](/timeline?from=2019-05-03T10%3A22%3A59Z&precision=second "See timeline at 05/03/2019 10:22:59 AM").

Use password\_hash instead of phpass

Download all attachments as: [.zip](/zip-attachment/ticket/21022/)

Oldest first

Newest first

Threaded

Show comments

Show property changes

### Change History (221)

### [#1](#comment:1) [@scribu](https://profiles.wordpress.org/scribu) [13 years](/timeline?from=2012-06-20T03%3A30%3A55Z&precision=second "See timeline at 06/20/2012 03:30:55 AM") ago

I'm wondering if this would be better as a wp-config.php constant, since it's not something that you would want random plugins to mess with.

### [#2](#comment:2) [@scribu](https://profiles.wordpress.org/scribu) [13 years](/timeline?from=2012-06-20T03%3A32%3A19Z&precision=second "See timeline at 06/20/2012 03:32:19 AM") ago

There's also the fact that these functions are already pluggable, which means they can be replaced wholesale by a plugin.

Last edited [13 years ago](/timeline?from=2012-06-20T03%3A36%3A51Z&precision=second "See timeline at 06/20/2012 03:36:51 AM")
by scribu
([previous](/ticket/21022?cversion=0&cnum_hist=2#comment:2))
([diff](/ticket/21022?action=comment-diff&cnum=2&version=1))

### [#3](#comment:3) [@JustinSainton](https://profiles.wordpress.org/justinsainton) [13 years](/timeline?from=2012-06-20T04%3A14%3A01Z&precision=second "See timeline at 06/20/2012 04:14:01 AM") ago

+1 for constant.

### [#4](#comment:4) [@th23](https://profiles.wordpress.org/th23) [13 years](/timeline?from=2012-06-20T04%3A18%3A34Z&precision=second "See timeline at 06/20/2012 04:18:34 AM") ago

Support the constant as well.

Have seen the pluggability and actually went down that road for now, however I don't think it the best way to require replacing the whole 2 functions just for changing that setting.

### [#5](#comment:5) [@toscho](https://profiles.wordpress.org/toscho) [13 years](/timeline?from=2012-06-20T09%3A22%3A38Z&precision=second "See timeline at 06/20/2012 09:22:38 AM") ago

* **Cc**
  *info@…* added

What is the difference between a plugin defining a constant and a plugin using a filter?

### [#6](#comment:6) [@scribu](https://profiles.wordpress.org/scribu) [13 years](/timeline?from=2012-06-20T09%3A25%3A34Z&precision=second "See timeline at 06/20/2012 09:25:34 AM") ago

The difference is that a second plugin can't redefine the constant. Also, it would be good if the constant was always set, either in wp-config.php by the user or before loading plugins, by WordPress.

### [#7](#comment:7) [@nacin](https://profiles.wordpress.org/nacin) [13 years](/timeline?from=2012-06-20T15%3A03%3A42Z&precision=second "See timeline at 06/20/2012 03:03:42 PM") ago

As much as I hate pluggable functions, this is *precisely* what they're good for. I'd rather see a plugin override both methods than a filter or a constant. (Have you seen [​http://codex.wordpress.org/Editing\_wp-config.php](http://codex.wordpress.org/Editing_wp-config.php)? Let's not add something to that page that could seriously screw up your install.)

Also, for what it's worth, a plugin can simply do `$wp_hasher = new PasswordHash(8, false);` before WordPress does. No need for plugging, or hooking, or defining.

### [#8](#comment:8) [@jammycakes](https://profiles.wordpress.org/jammycakes) [12 years](/timeline?from=2012-10-28T09%3A22%3A16Z&precision=second "See timeline at 10/28/2012 09:22:16 AM") ago

IMO, bcrypt needs to be made the default, out of the box option on all systems that support it. The idea that WordPress admins should have to go hunting for a plugin or tweak configuration options to do this scares me, simply because most of them won't unless (a) they are well versed in web security, (b) they know that WordPress uses a weak alternative by default, and (c) they consider it to be an issue worth worrying about.

People often underestimate the seriousness of MD5 and the SHA-\* algorithms being "less secure." They aren't just less secure: thanks to developments in password cracking in the past few years using GPU- and FPGA- based software, they are **totally useless.** Programs such as oclHashCat even have an option specifically to crack passwords in WordPress databases -- and the rate at which they can do so is terrifying. If you're not making a strong password hashing algorithm the default, out of the box option, you're exposing your users to unacceptable and unnecessary risk.

For what it's worth, you can do this without breaking backwards compatibility. It should be possible to include some code that can identify which algorithm you're using, and you can upgrade your users' passwords to the new option when they log in. You would also need to be able to do this if you wanted to increase the work factor passed into bcrypt every so often to allow for improvements in cracking technology.

(For reference, see the original "just use bcrypt" article: [​http://codahale.com/how-to-safely-store-a-password/](http://codahale.com/how-to-safely-store-a-password/))

Last edited [12 years ago](/timeline?from=2012-10-28T09%3A25%3A21Z&precision=second "See timeline at 10/28/2012 09:25:21 AM")
by jammycakes
([previous](/ticket/21022?cversion=1&cnum_hist=8#comment:8))
([diff](/ticket/21022?action=comment-diff&cnum=8&version=2))

### [#9](#comment:9) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T19%3A31%3A01Z&precision=second "See timeline at 11/07/2012 07:31:01 PM") ago

+1 for switching the default. I think someone moving from new PHP to old PHP and finding their site is:

* unlikely
* easily resolved by resetting your account password

And the normal upgrade path (where someone has lots of MD5 passwords and then starts using bcrypt) is a non-issue as PHPass will detect whatever algo was used and react appropriately.

I've just discovered this ticket having already written a plugin (!) that makes this change, if anyone wants to give it a go ([​https://github.com/dxw/wp\_bcrypt/archive/master.zip](https://github.com/dxw/wp_bcrypt/archive/master.zip)).

I think this should just be changed in the core though.

### [#10](#comment:10) follow-up: [↓ 17](#comment:17) [@Otto42](https://profiles.wordpress.org/otto42) [12 years](/timeline?from=2012-11-07T19%3A32%3A57Z&precision=second "See timeline at 11/07/2012 07:32:57 PM") ago

PHPass actually checks for the existence of CRYPT\_BLOWFISH and then CRYPT\_EXT\_DES support, and uses the best method available when the $portable\_hashes argument is set to false, falling back to MD5 otherwise. Thus, there's no downside to simply always using false here.

Now that we're on PHP 5.3 for core, every PHP install should have CRYPT\_BLOWFISH, but even if it's strangely compiled without it, PHPass will continue to work.

My vote is for simply removing the "true" from the $portable\_hashes argument altogether. We don't need it, it's more secure without it, and honestly it doesn't even need to be a configurable option.

### [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T19%3A34%3A16Z&precision=second "See timeline at 11/07/2012 07:34:16 PM") ago

* **Attachment**
  [*use\_bcrypt.diff*](/attachment/ticket/21022/use_bcrypt.diff)[​](/raw-attachment/ticket/21022/use_bcrypt.diff "Download")
  added

Patch to use bcrypt by default

### [#11](#comment:11) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T19%3A35%3A32Z&precision=second "See timeline at 11/07/2012 07:35:32 PM") ago

* **Keywords**
  *has-patch* added

I added a patch against trunk.

### [#12](#comment:12) [@dd32](https://profiles.wordpress.org/dd32) [12 years](/timeline?from=2012-11-07T19%3A38%3A34Z&precision=second "See timeline at 11/07/2012 07:38:34 PM") ago

> Now that we're on PHP 5.3 for core, every PHP install should have CRYPT\_BLOWFISH, but even if it's strangely compiled without it, PHPass will continue to work.

We still require [​PHP 5.2.4](http://core.trac.wordpress.org/browser/trunk/wp-includes/version.php#L23).

### [#13](#comment:13) [@Otto42](https://profiles.wordpress.org/otto42) [12 years](/timeline?from=2012-11-07T19%3A41%3A00Z&precision=second "See timeline at 11/07/2012 07:41:00 PM") ago

Fair enough, but regardless, PHPass is backward compatible on it's own. There's no downside to letting it use non-portable hashes. Worst case is you move a site from one server to another that doesn't have bcrypt and you have to reset your passwords.

### [#14](#comment:14) follow-up: [↓ 15](#comment:15) [@nacin](https://profiles.wordpress.org/nacin) [12 years](/timeline?from=2012-11-07T19%3A42%3A05Z&precision=second "See timeline at 11/07/2012 07:42:05 PM") ago

Enforcing portable hashes means that they are *portable*. A change like this could make deployments more difficult.

### [#15](#comment:15) in reply to: [↑ 14](#comment:14) [@Otto42](https://profiles.wordpress.org/otto42) [12 years](/timeline?from=2012-11-07T19%3A43%3A55Z&precision=second "See timeline at 11/07/2012 07:43:55 PM") ago

Replying to [nacin](/ticket/21022#comment:14 "Comment 14"):

> Enforcing portable hashes means that they are *portable*. A change like this could make deployments more difficult.

If you're deploying between systems running largely different versions of PHP, yes. Pretty thin case, seems to me.

### [#16](#comment:16) follow-up: [↓ 65](#comment:65) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T19%3A49%3A21Z&precision=second "See timeline at 11/07/2012 07:49:21 PM") ago

Yes. I agree with Otto.

Switching to bcrypt as the default will only affect a very small number of people (if any) who go from a newer version of PHP to an older one.

In any other case, PHPass figures out what to do.

Does anyone know how you can check for PHP feature X in PHP version Y? Can't find old versions of the manual anywhere and the current version says crypt has been supported since PHP 4, and CRYPT\_BLOWFISH since 5.3, but doesn't say when CRYPT\_EXT\_DES was introduced.

### [#17](#comment:17) in reply to: [↑ 10](#comment:10) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [12 years](/timeline?from=2012-11-07T20%3A12%3A42Z&precision=second "See timeline at 11/07/2012 08:12:42 PM") ago

This seems like something best switched over once PHP 5.3 is the required version. Otherwise there is a risk that someone needs to move a site from a server running one version of PHP supported by WordPress, but on moving to another server with a version of PHP supported then it may break due to the password hashing algorithm being missing.

PHPPass doesn't seem to be inherently insecure in itself, so there is no urgent need to change. Moving eventually is obviously a good idea, but I'm not convinced that now is the appropriate time.

Immediate solution ... bump the PHP requirement to 5.3 ;)

### [#18](#comment:18) follow-ups: [↓ 19](#comment:19) [↓ 20](#comment:20) [@westi](https://profiles.wordpress.org/westi) [12 years](/timeline?from=2012-11-07T20%3A48%3A01Z&precision=second "See timeline at 11/07/2012 08:48:01 PM") ago

I think we should do this, and I think we should make the password re-encrypting code upgrade to a bcrypted password on login like we do for md5.

### [#19](#comment:19) in reply to: [↑ 18](#comment:18) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [12 years](/timeline?from=2012-11-07T21%3A12%3A26Z&precision=second "See timeline at 11/07/2012 09:12:26 PM") ago

Replying to [westi](/ticket/21022#comment:18 "Comment 18"):

> I think we should do this, and I think we should make the password re-encrypting code upgrade to a bcrypted password on login like we do for md5.

Dang. I hadn't thought of forcing the upgrade like that. That would solve most migration problems since most people would automatically receive a new password hash seamlessly anyway.

EDIT: I think I had too much tequila before posting this. Re-encrypting makes the problem worse, not better. Your idea is still a good one, as it forces the newer/better encryption to be used, just not for the reasons I suggested when I posted this comment.

Last edited [12 years ago](/timeline?from=2012-11-07T22%3A08%3A47Z&precision=second "See timeline at 11/07/2012 10:08:47 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=0&cnum_hist=19#comment:19))
([diff](/ticket/21022?action=comment-diff&cnum=19&version=1))

### [#20](#comment:20) in reply to: [↑ 18](#comment:18) ; follow-up: [↓ 21](#comment:21) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T21%3A33%3A16Z&precision=second "See timeline at 11/07/2012 09:33:16 PM") ago

Replying to [ryanhellyer](/ticket/21022#comment:17 "Comment 17"):

> Otherwise there is a risk that someone needs to move a site from a server running one version of PHP supported by WordPress, but on moving to another server with a version of PHP supported then it may break due to the password hashing algorithm being missing.

Surely this risk is minute? You'd have to move from a server running 5.3.x to one running 5.2.x. And it's trivially solvable by changing your password.

What's involved in increasing the requirement from 5.2 to 5.3? That feels non-trivial.

Replying to [westi](/ticket/21022#comment:18 "Comment 18"):

> I think we should do this, and I think we should make the password re-encrypting code upgrade to a bcrypted password on login like we do for md5.

That's exactly what the plugin does (linked above) although I didn't include that in the patch. Happy to resubmit if it's looking likely to be accepted?

By "this" did you mean wait for 5.3 or change it now?

### [#21](#comment:21) in reply to: [↑ 20](#comment:20) ; follow-ups: [↓ 22](#comment:22) [↓ 23](#comment:23) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [12 years](/timeline?from=2012-11-07T22%3A03%3A54Z&precision=second "See timeline at 11/07/2012 10:03:54 PM") ago

Replying to [harrym](/ticket/21022#comment:20 "Comment 20"):

> Surely this risk is minute? You'd have to move from a server running 5.3.x to one running 5.2.x. And it's trivially solvable by changing your password.

I run a few sites with many thousands of logged in users. Forcing them to all upgrade their passwords at once would be quite problematic. It's fairly unlikely we'd ever downgrade the server during a move like that of course, but you never know what sort of weird things people might do without realising the ramifications until afterwards.

> What's involved in increasing the requirement from 5.2 to 5.3? That feels non-trivial.

That's more of a political question I guess. Changing it is physically trivial, but judging by how hard it was to move from PHP 4 to 5.2 I'm guessing having the requirements change will not be so trivial.

Last edited [12 years ago](/timeline?from=2012-11-07T22%3A06%3A19Z&precision=second "See timeline at 11/07/2012 10:06:19 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=0&cnum_hist=21#comment:21))
([diff](/ticket/21022?action=comment-diff&cnum=21&version=1))

### [#22](#comment:22) in reply to: [↑ 21](#comment:21) ; follow-up: [↓ 32](#comment:32) [@nacin](https://profiles.wordpress.org/nacin) [12 years](/timeline?from=2012-11-07T22%3A10%3A57Z&precision=second "See timeline at 11/07/2012 10:10:57 PM") ago

Replying to [harrym](/ticket/21022#comment:20 "Comment 20"):

> What's involved in increasing the requirement from 5.2 to 5.3? That feels non-trivial.

Only 31% of WordPress installs run 5.3. I don't see this happening before 2014.

### [#23](#comment:23) in reply to: [↑ 21](#comment:21) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-07T23%3A15%3A16Z&precision=second "See timeline at 11/07/2012 11:15:16 PM") ago

* **Keywords**
  *has-patch* removed

Replying to [ryanhellyer](/ticket/21022#comment:21 "Comment 21"):

> I run a few sites with many thousands of logged in users. Forcing them to all upgrade their passwords at once would be quite problematic.

That seems fair enough.

Replying to [nacin](/ticket/21022#comment:22 "Comment 22"):

> Replying to [harrym](/ticket/21022#comment:20 "Comment 20"):
>
>
> > What's involved in increasing the requirement from 5.2 to 5.3? That feels non-trivial.
>
> Only 31% of WordPress installs run 5.3. I don't see this happening before 2014.

Wow. I'm surprised it's that low.

So it sounds like switching the default is not likely to happen soon. Given that:

* It's going to be a while before the default can be changed
* A third of installs could immediately benefit

Can we reconsider making a define to control portability?

Happy to resubmit a patch if it's a goer, including the hash upgrade on login.

### [#24](#comment:24) follow-up: [↓ 25](#comment:25) [@rmccue](https://profiles.wordpress.org/rmccue) [12 years](/timeline?from=2012-11-08T14%3A05%3A34Z&precision=second "See timeline at 11/08/2012 02:05:34 PM") ago

* **Keywords**
  *2nd-opinion* *punt* added; *dev-feedback* removed

duck\_ and I discussed this on IRC, especially with regard to the current cost factor of 8 in PHPass. On my local box, hashing 1k passwords takes ~2s, giving ~2ms per password. This should probably be bumped up slightly. The upcoming [​password hashing API](https://wiki.php.net/rfc/password_hash) in PHP 5.5 uses [​10](https://github.com/php/php-src/blob/master/ext/standard/php_password.h#L33) as the cost, and we might want to switch to using that too. There's a [​compatibility library](https://github.com/ircmaxell/password_compat).

Note that the compat library requires PHP 5.3.7+, since "PHP prior to 5.3.7 contains a security issue with its BCRYPT implementation"; duck\_ noted [​the relevant crypt\_blowfish update](http://www.openwall.com/lists/announce/2011/06/21/1) and [​the bug description](http://www.openwall.com/lists/oss-security/2011/06/20/2):

> The majority of hashes (but not all of them) for passwords containing characters with the 8th bit set are incompatible with OpenBSD's (really nasty, but no security impact here).

> What's worse, approximately 3 in 16 passwords containing a single character with the 8th bit set have 1 to 3 characters immediately preceding the 8-bit character ignored. With more than one character with the 8th bit set, things may be even worse.

> Thus, those passwords may be much easier to crack than expected.

i.e. With non-ASCII characters, there are severe security issues.

Due to the above bug, I don't think we should be switching to bcrypt on by default until we require PHP 5.3.7+, which is not for a while. I'm going to recommend punting for now, but I'd like a second opinion before I do.

---

Replying to [jammycakes](/ticket/21022#comment:8 "Comment 8"):

> People often underestimate the seriousness of MD5 and the SHA-\* algorithms being "less secure." They aren't just less secure: thanks to developments in password cracking in the past few years using GPU- and FPGA- based software, they are **totally useless.** Programs such as oclHashCat even have an option specifically to crack passwords in WordPress databases -- and the rate at which they can do so is terrifying. If you're not making a strong password hashing algorithm the default, out of the box option, you're exposing your users to unacceptable and unnecessary risk.

If that's the case, I think we should increase the cost factor ASAP (which is backwards compatible, since it's stored in the salt IIRC).

Replying to [harrym](/ticket/21022#comment:23 "Comment 23"):

> Wow. I'm surprised it's that low.

Check [​http://wordpress.org/about/stats/](http://wordpress.org/about/stats/) for slightly more detail.

### [#25](#comment:25) in reply to: [↑ 24](#comment:24) [@westi](https://profiles.wordpress.org/westi) [12 years](/timeline?from=2012-11-08T14%3A15%3A08Z&precision=second "See timeline at 11/08/2012 02:15:08 PM") ago

Replying to [rmccue](/ticket/21022#comment:24 "Comment 24"):

> duck\_ and I discussed this on IRC, especially with regard to the current cost factor of 8 in PHPass. On my local box, hashing 1k passwords takes ~2s, giving ~2ms per password. This should probably be bumped up slightly. The upcoming [​password hashing API](https://wiki.php.net/rfc/password_hash) in PHP 5.5 uses [​10](https://github.com/php/php-src/blob/master/ext/standard/php_password.h#L33) as the cost, and we might want to switch to using that too. There's a [​compatibility library](https://github.com/ircmaxell/password_compat).
>
>
> Note that the compat library requires PHP 5.3.7+, since "PHP prior to 5.3.7 contains a security issue with its BCRYPT implementation"; duck\_ noted [​the relevant crypt\_blowfish update](http://www.openwall.com/lists/announce/2011/06/21/1) and [​the bug description](http://www.openwall.com/lists/oss-security/2011/06/20/2):
>
>
> > The majority of hashes (but not all of them) for passwords containing characters with the 8th bit set are incompatible with OpenBSD's (really nasty, but no security impact here).
>
> > What's worse, approximately 3 in 16 passwords containing a single character with the 8th bit set have 1 to 3 characters immediately preceding the 8-bit character ignored. With more than one character with the 8th bit set, things may be even worse.
>
> > Thus, those passwords may be much easier to crack than expected.
>
> i.e. With non-ASCII characters, there are severe security issues.
>
>
> Due to the above bug, I don't think we should be switching to bcrypt on by default until we require PHP 5.3.7+, which is not for a while. I'm going to recommend punting for now, but I'd like a second opinion before I do.
>
>
> ---
>
> Replying to [jammycakes](/ticket/21022#comment:8 "Comment 8"):
>
>
> > People often underestimate the seriousness of MD5 and the SHA-\* algorithms being "less secure." They aren't just less secure: thanks to developments in password cracking in the past few years using GPU- and FPGA- based software, they are **totally useless.** Programs such as oclHashCat even have an option specifically to crack passwords in WordPress databases -- and the rate at which they can do so is terrifying. If you're not making a strong password hashing algorithm the default, out of the box option, you're exposing your users to unacceptable and unnecessary risk.
>
> If that's the case, I think we should increase the cost factor ASAP (which is backwards compatible, since it's stored in the salt IIRC).
>
>
> Replying to [harrym](/ticket/21022#comment:23 "Comment 23"):
>
>
> > Wow. I'm surprised it's that low.
>
> Check [​http://wordpress.org/about/stats/](http://wordpress.org/about/stats/) for slightly more detail.

I think it would be nice to see if we can modify WP's behaviour to use bcrypt where we can soon, but probably not for 3.5.

We should probably target this investigation for 3.6-early with a view to backporting into the 3.5 branch as well.

For now I think that pluggable function replacement is better plugin implementation than a filter for enabling bcrypt on sites where it is safe to do so.

### [#26](#comment:26) follow-up: [↓ 27](#comment:27) [@harrym](https://profiles.wordpress.org/harrym) [12 years](/timeline?from=2012-11-08T14%3A35%3A37Z&precision=second "See timeline at 11/08/2012 02:35:37 PM") ago

* **Keywords**
  *dev-feedback* added

+1 for increasing the cost factor. Jammycakes is absolutely right, and the factor is indeed stored along with the salt. There are no compatibility issues involved there.

We do regular password audits for our clients - breaking WordPress password hashes isn't even slightly difficult. We can try >20k candidates per second, and that's on a fairly pedestrian office machine. Custom rigs with multiple GPUs can do hundreds of thousands of attempts per second. This is not a minor problem!

Can we have dev-feedback on making the use of portable hashes a configurable option, via a define?

I see no reason why people shouldn't be able to customise this behaviour in wp-config if they're aware of the tradeoffs.

### [#27](#comment:27) in reply to: [↑ 26](#comment:26) ; follow-ups: [↓ 29](#comment:29) [↓ 30](#comment:30) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [12 years](/timeline?from=2012-11-08T15%3A09%3A09Z&precision=second "See timeline at 11/08/2012 03:09:09 PM") ago

Even at 100 billion attempts per second, it would still take over 1000 years to crack a password with only 12 characters in it, and that's assuming only numbers and English characters. So 100,000 attempts per second doesn't seem like anything worth worrying about.

The situation in which that could be a problem, is when users use horrendously insecure passwords. Moving to a more secure hash will unfortunately not stop users from choosing a password of 123abc which would still be trivial to crack, even with bCrypt. So perhaps an alternative solution to this is to implement a minimum password strength system like the following plugin?

[​http://www.itsananderson.com/plugins/minimum-password-strength/](http://www.itsananderson.com/plugins/minimum-password-strength/)

I have seen multiple sites "hacked" due to insecure passwords. Passwords like "password", "letmein" and "admin" appear to be scarily common. Since implementing that plugin, I haven't see any examples of this occurring thankfully. Implementing it seems like it would get to the core of the problem a little more directly and effectively than changing the hashing algorithm.

Last edited [12 years ago](/timeline?from=2012-11-08T15%3A10%3A06Z&precision=second "See timeline at 11/08/2012 03:10:06 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=0&cnum_hist=27#comment:27))
([diff](/ticket/21022?action=comment-diff&cnum=27&version=1))

### [#28](#comment:28) [@tomdxw](https://profiles.wordpress.org/tomdxw) [12 years](/timeline?from=2012-11-08T15%3A17%3A48Z&precision=second "See timeline at 11/08/2012 03:17:48 PM") ago

* **Cc**
  *tom@…* added

### [#29](#comment:29) in reply to: [↑ 27](#comment:27) [@bpetty](https://profiles.wordpress.org/bpetty) [12 years](/timeline?from=2012-11-08T15%3A42%3A09Z&precision=second "See timeline at 11/08/2012 03:42:09 PM") ago

Replying to [ryanhellyer](/ticket/21022#comment:27 "Comment 27"):

> The situation in which that could be a problem, is when users use horrendously insecure passwords. Moving to a more secure hash will unfortunately not stop users from choosing a password of 123abc which would still be trivial to crack, even with bCrypt. So perhaps an alternative solution to this is to implement a minimum password strength system like the following plugin?
>
> [​http://www.itsananderson.com/plugins/minimum-password-strength/](http://www.itsananderson.com/plugins/minimum-password-strength/)
>
>
> I have seen multiple sites "hacked" due to insecure passwords. Passwords like "password", "letmein" and "admin" appear to be scarily common. Since implementing that plugin, I haven't see any examples of this occurring thankfully. Implementing it seems like it would get to the core of the problem a little more directly and effectively than changing the hashing algorithm.

Ryan has a very good point here. The fact that WP already uses per-password-salts and stretching with a well respected password hashing library is actually pretty good regardless of what hashing method is used. There's no point in bumping server resource requirements, and extending page response times for registration and login past 2 seconds (not even including everything beyond the hash) when the actual problem that needs to be solved is password strength.

### [#30](#comment:30) in reply to: [↑ 27](#comment:27) [@SergeyBiryukov](https://profiles.wordpress.org/sergeybiryukov) [12 years](/timeline?from=2012-11-08T17%3A49%3A16Z&precision=second "See timeline at 11/08/2012 05:49:16 PM") ago

Replying to [ryanhellyer](/ticket/21022#comment:27 "Comment 27"):

> So perhaps an alternative solution to this is to implement a minimum password strength system

Related: [#21737](/ticket/21737 "#21737: task (blessed): Users should have to jump through hoops to set passwords of their ... (closed: fixed)")

### [#31](#comment:31) [@mbijon](https://profiles.wordpress.org/mbijon) [12 years](/timeline?from=2012-11-09T19%3A30%3A42Z&precision=second "See timeline at 11/09/2012 07:30:42 PM") ago

* **Cc**
  *mike@…* added

### [#32](#comment:32) in reply to: [↑ 22](#comment:22) ; follow-up: [↓ 34](#comment:34) [@ryansatterfield](https://profiles.wordpress.org/ryansatterfield) [12 years](/timeline?from=2012-11-16T08%3A30%3A37Z&precision=second "See timeline at 11/16/2012 08:30:37 AM") ago

While I really care about security, it isn't logical to switch the supported version to 5.3. Why? Well, 3,383,560 servers are currently running 5.2. Only 3,475,453 servers support PHP 5.3. If WordPress stopped supporting 5.2 there would be an outrage. The problem stems from PHP not putting in native support for more secure hash types before 5.3. I agree with Nacin on the fact that we should use plugins until at least 2014. If you even know about password hashing, then finding a plugin won't be hard. If you want to double check my findings on the PHP versions go to shodanhq.com and do some searches.

Replying to [nacin](/ticket/21022#comment:22 "Comment 22"):

> Replying to [harrym](/ticket/21022#comment:20 "Comment 20"):
>
>
> > What's involved in increasing the requirement from 5.2 to 5.3? That feels non-trivial.
>
> Only 31% of WordPress installs run 5.3. I don't see this happening before 2014.

Last edited [12 years ago](/timeline?from=2012-11-16T08%3A33%3A08Z&precision=second "See timeline at 11/16/2012 08:33:08 AM")
by ryansatterfield
([previous](/ticket/21022?cversion=0&cnum_hist=32#comment:32))
([diff](/ticket/21022?action=comment-diff&cnum=32&version=1))

### [#33](#comment:33) [@rmccue](https://profiles.wordpress.org/rmccue) [12 years](/timeline?from=2012-11-16T08%3A38%3A59Z&precision=second "See timeline at 11/16/2012 08:38:59 AM") ago

* **Keywords**
  *3.6-early* added; *2nd-opinion* *punt* *dev-feedback* removed

Punting to 3.6-early for discussion then.

### [#34](#comment:34) in reply to: [↑ 32](#comment:32) ; follow-ups: [↓ 35](#comment:35) [↓ 36](#comment:36) [@Otto42](https://profiles.wordpress.org/otto42) [12 years](/timeline?from=2012-11-16T12%3A41%3A39Z&precision=second "See timeline at 11/16/2012 12:41:39 PM") ago

Replying to [ryansatterfield](/ticket/21022#comment:32 "Comment 32"):

> While I really care about security, it isn't logical to use PHPass and switch the supported version to 5.3.

As I stated above, PHPass is \*backwards compatible\* with 5.2 just fine, even in non-portable password mode.

### [#35](#comment:35) in reply to: [↑ 34](#comment:34) [@ryansatterfield](https://profiles.wordpress.org/ryansatterfield) [12 years](/timeline?from=2012-11-17T19%3A44%3A18Z&precision=second "See timeline at 11/17/2012 07:44:18 PM") ago

Do you know that a large majority of people who use WordPress barely know how to turn their computers on or delete their cookies? I do WordPress tutoring through my company and sometimes just to help people out. The "logic" I hear is quite a wake up call to how we should program to help them. Unless PHPass can detect that It has been moved to a server that supports PHP 5.2 instead of PHP 5.3 and then automatically changes the password encryption, then it isn't logical to have it as a WordPress default.

I don't work for WordPress, but I know the end-user mind and so does the WordPress team. I know what you are saying is easy for us geeks, but it isn't for a large portion of WordPress clients. People use WordPress because it is the easiest CMS available.

This will have to wait until at least 2014, although I expect a lot of servers to still support PHP 5.2 in 2014.

Replying to [Otto42](/ticket/21022#comment:34 "Comment 34"):

> Replying to [ryansatterfield](/ticket/21022#comment:32 "Comment 32"):
>
>
> > While I really care about security, it isn't logical to use PHPass and switch the supported version to 5.3.
>
> As I stated above, PHPass is \*backwards compatible\* with 5.2 just fine, even in non-portable password mode.

Last edited [12 years ago](/timeline?from=2012-11-17T19%3A44%3A53Z&precision=second "See timeline at 11/17/2012 07:44:53 PM")
by ryansatterfield
([previous](/ticket/21022?cversion=0&cnum_hist=35#comment:35))
([diff](/ticket/21022?action=comment-diff&cnum=35&version=1))

### [#36](#comment:36) in reply to: [↑ 34](#comment:34) [@ryansatterfield](https://profiles.wordpress.org/ryansatterfield) [12 years](/timeline?from=2012-11-22T08%3A50%3A24Z&precision=second "See timeline at 11/22/2012 08:50:24 AM") ago

After further research I agree with Otto. PHPass will automatically change the hash in non-portable mode and can detect the PHP version on it's own. Maybe this could get into 3.5 or 3.5.1? I don't see a PHPass submitted patch. I will try to submit a patch soon. I am busy today and part of Friday. I have to do Holiday stuff.

Otto, I am sorry for my initial response. I replied that way since I've worked with people who spent a week on their own without my help to learn the most simplest thing about WordPress and still couldn't figure it out. I was wrong to automatically assume the user would have to tell WordPress that they had changed PHP versions. I hope everyone has a good Thanksgiving.

Replying to [Otto42](/ticket/21022#comment:34 "Comment 34"):

> Replying to [ryansatterfield](/ticket/21022#comment:32 "Comment 32"):
>
>
> > While I really care about security, it isn't logical to use PHPass and switch the supported version to 5.3.
>
> As I stated above, PHPass is \*backwards compatible\* with 5.2 just fine, even in non-portable password mode.

### [#37](#comment:37) follow-up: [↓ 38](#comment:38) [@ryansatterfield](https://profiles.wordpress.org/ryansatterfield) [12 years](/timeline?from=2012-11-24T08%3A26%3A57Z&precision=second "See timeline at 11/24/2012 08:26:57 AM") ago

* **Keywords**
  *3.5* *2nd-opinion* added; *3.6-early* removed

I have a patch so it will use MD5 if it is on 5.2, but if it is on 5.3 or higher it will use sha-512. I am setting up subversion right now since git tortoise isn't working great. If PHPass documentation is right, the existing users hash should be automatically switched if the environment changes. The only issue I didn't fix in the patch was altering the table, since varchar only holds 64 characters and sha-512 is 128.

This should be able to get out in 3.5, shouldn't it?

### [#38](#comment:38) in reply to: [↑ 37](#comment:37) [@SergeyBiryukov](https://profiles.wordpress.org/sergeybiryukov) [12 years](/timeline?from=2012-11-24T08%3A37%3A32Z&precision=second "See timeline at 11/24/2012 08:37:32 AM") ago

* **Keywords**
  *3.6-early* added; *3.5* removed

Replying to [ryansatterfield](/ticket/21022#comment:37 "Comment 37"):

> This should be able to get out in 3.5, shouldn't it?

No, we are long past the enhancement stage for 3.5: [​http://make.wordpress.org/core/version-3-5-project-schedule/](http://make.wordpress.org/core/version-3-5-project-schedule/)

### [#39](#comment:39) [@iandunn](https://profiles.wordpress.org/iandunn) [12 years](/timeline?from=2013-02-21T02%3A47%3A24Z&precision=second "See timeline at 02/21/2013 02:47:24 AM") ago

* **Cc**
  *ian\_dunn@…* added

### [#40](#comment:40) [@travisnorthcutt](https://profiles.wordpress.org/travisnorthcutt) [12 years](/timeline?from=2013-03-05T19%3A26%3A57Z&precision=second "See timeline at 03/05/2013 07:26:57 PM") ago

* **Cc**
  *travis@…* added

### [#41](#comment:41) [@josephscott](https://profiles.wordpress.org/josephscott) [12 years](/timeline?from=2013-05-28T21%3A05%3A44Z&precision=second "See timeline at 05/28/2013 09:05:44 PM") ago

* **Cc**
  *joseph@…* added

### [#42](#comment:42) [@freddyware](https://profiles.wordpress.org/freddyware) [12 years](/timeline?from=2013-06-03T17%3A44%3A14Z&precision=second "See timeline at 06/03/2013 05:44:14 PM") ago

* **Cc**
  *frederick.ding@…* added

### [#43](#comment:43) [@betzster](https://profiles.wordpress.org/betzster) [12 years](/timeline?from=2013-06-17T18%3A30%3A26Z&precision=second "See timeline at 06/17/2013 06:30:26 PM") ago

* **Cc**
  *j@…* added

### [#44](#comment:44) [@koke](https://profiles.wordpress.org/koke) [11 years](/timeline?from=2013-12-13T12%3A14%3A57Z&precision=second "See timeline at 12/13/2013 12:14:57 PM") ago

About the required PHP version, PHP has other hashes available since 5.1.2, like SHA1/SHA256/SHA512. See [​hash\_algos()](http://www.php.net/manual/en/function.hash-algos.php) and [​hash\_hmac](http://www.php.net/manual/en/function.hash-hmac.php).

### [#45](#comment:45) [@koke](https://profiles.wordpress.org/koke) [11 years](/timeline?from=2013-12-13T12%3A16%3A15Z&precision=second "See timeline at 12/13/2013 12:16:15 PM") ago

* **Cc**
  *jorge@…* added

### [#46](#comment:46) [@Otto42](https://profiles.wordpress.org/otto42) [11 years](/timeline?from=2014-02-19T19%3A33%3A25Z&precision=second "See timeline at 02/19/2014 07:33:25 PM") ago

Relevant information: [​http://nakedsecurity.sophos.com/2014/02/16/syrian-electronic-army-hacks-forbes-spills-1000000-user-records/](http://nakedsecurity.sophos.com/2014/02/16/syrian-electronic-army-hacks-forbes-spills-1000000-user-records/)

TL;DR: The Forbes.com site (running WordPress) was breached and about a million rows of the users table dumped. The password hashes were exposed.

Though the hashing is still okay using the iterated MD5, it seems that the bar should probably be raised. If not switching to better algorithms when they are available, then the iteration count should be raised.

Personally, I would prefer using better algorithms, which means, at the very least, we should implement a filter or define to allow people to disable the forced use of portable hashes (aka, forcing MD5).

### [@iandunn](https://profiles.wordpress.org/iandunn) [11 years](/timeline?from=2014-02-22T07%3A49%3A27Z&precision=second "See timeline at 02/22/2014 07:49:27 AM") ago

* **Attachment**
  [*21022.2.diff*](/attachment/ticket/21022/21022.2.diff)[​](/raw-attachment/ticket/21022/21022.2.diff "Download")
  added

Updates a few more calls to PasswordHash()

### [#47](#comment:47) [@ocean90](https://profiles.wordpress.org/ocean90) [11 years](/timeline?from=2014-02-22T09%3A30%3A34Z&precision=second "See timeline at 02/22/2014 09:30:34 AM") ago

* **Keywords**
  *has-patch* added

### [#48](#comment:48) [@tomdxw](https://profiles.wordpress.org/tomdxw) [9 years](/timeline?from=2015-09-16T17%3A00%3A26Z&precision=second "See timeline at 09/16/2015 05:00:26 PM") ago

Is this a change that could make it into 4.4?

### [#49](#comment:49) [@mark8barnes](https://profiles.wordpress.org/mark8barnes) [9 years](/timeline?from=2015-10-01T10%3A15%3A40Z&precision=second "See timeline at 10/01/2015 10:15:40 AM") ago

It seems wrong that in 2015 we're still not using bcrypt for password hashing, at least for systems that support it. I understand why portability is a good thing, but not if it makes the majority of systems vulnerable.

* The chances of people downgrading from PHP 5.3+ to 5.2 are diminishing by the day.
* Downgrading is least likely to happen on a large site with lots of users, which is where there is the biggest potential problem.
* It would be trivial create an alert that would display if the admin attempted to log in when passwords were bcrypted but the server didn't support bcrypt. That way if someone does move from 5.3 to 5.2, they'd very soon understand the problem and be able to reverse the change.

### [#50](#comment:50) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2015-10-01T10%3A57%3A17Z&precision=second "See timeline at 10/01/2015 10:57:17 AM") ago

Note that the "use case" for leaving portable hashes enabled no longer makes any real sense, since WordPress is already not portable in other ways. WordPress now behaves differently on different versions of MySQL, using utf8mb4 on certain versions but not others.

### [#51](#comment:51) follow-up: [↓ 52](#comment:52) [@mojorob](https://profiles.wordpress.org/mojorob) [9 years](/timeline?from=2015-10-06T13%3A10%3A13Z&precision=second "See timeline at 10/06/2015 01:10:13 PM") ago

This may be a daft question, however I suspect WordPress already checks version of PHP somewhere. Therefore is it not possible to have a check if PHP is => 5.5.0 then use the native password hashing functions? (password\_hash etc.)

It would seem a fairly good & light option for those hosting on more recent versions of PHP.

### [#52](#comment:52) in reply to: [↑ 51](#comment:51) ; follow-ups: [↓ 53](#comment:53) [↓ 57](#comment:57) [↓ 63](#comment:63) [@mark8barnes](https://profiles.wordpress.org/mark8barnes) [9 years](/timeline?from=2015-10-07T16%3A53%3A54Z&precision=second "See timeline at 10/07/2015 04:53:54 PM") ago

Replying to [mojorob](/ticket/21022#comment:51 "Comment 51"):

> Therefore is it not possible to have a check if PHP is => 5.5.0 then use the native password hashing functions? (password\_hash etc.)

That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.

### [#53](#comment:53) in reply to: [↑ 52](#comment:52) ; follow-up: [↓ 54](#comment:54) [@mojorob](https://profiles.wordpress.org/mojorob) [9 years](/timeline?from=2015-10-07T17%3A27%3A41Z&precision=second "See timeline at 10/07/2015 05:27:41 PM") ago

Replying to [mark8barnes](/ticket/21022#comment:52 "Comment 52"):

> Replying to [mojorob](/ticket/21022#comment:51 "Comment 51"):
>
>
> > Therefore is it not possible to have a check if PHP is => 5.5.0 then use the native password hashing functions? (password\_hash etc.)
>
> That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.

It is that bad for a person to click "forgot password" and have a link emailed to them to create a new password?

### [#54](#comment:54) in reply to: [↑ 53](#comment:53) ; follow-up: [↓ 55](#comment:55) [@chriscct7](https://profiles.wordpress.org/chriscct7) [9 years](/timeline?from=2015-10-07T17%3A39%3A47Z&precision=second "See timeline at 10/07/2015 05:39:47 PM") ago

* **Keywords**
  *3.6-early* removed

Replying to [mojorob](/ticket/21022#comment:53 "Comment 53"):

> Replying to [mark8barnes](/ticket/21022#comment:52 "Comment 52"):
>
>
> > Replying to [mojorob](/ticket/21022#comment:51 "Comment 51"):
> >
> >
> > > Therefore is it not possible to have a check if PHP is => 5.5.0 then use the native password hashing functions? (password\_hash etc.)
> >
> > That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.
>
> It is that bad for a person to click "forgot password" and have a link emailed to them to create a new password?

Yes, because a majority of the users will know they were entering the previously correct password and won't understand they need to reset their passwords. Also on a larger install, with hundreds of thousands of users, particularly if the site deals with eCommerce, this could provide for a massive headache in terms of support.

### [#55](#comment:55) in reply to: [↑ 54](#comment:54) [@mojorob](https://profiles.wordpress.org/mojorob) [9 years](/timeline?from=2015-10-07T17%3A53%3A11Z&precision=second "See timeline at 10/07/2015 05:53:11 PM") ago

Replying to [chriscct7](/ticket/21022#comment:54 "Comment 54"):

> Replying to [mojorob](/ticket/21022#comment:53 "Comment 53"):
>
>
> > Replying to [mark8barnes](/ticket/21022#comment:52 "Comment 52"):
> >
> >
> > > Replying to [mojorob](/ticket/21022#comment:51 "Comment 51"):
> > >
> > >
> > > > Therefore is it not possible to have a check if PHP is => 5.5.0 then use the native password hashing functions? (password\_hash etc.)
> > >
> > > That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.
> >
> > It is that bad for a person to click "forgot password" and have a link emailed to them to create a new password?
>
> Yes, because a majority of the users will know they were entering the previously correct password and won't understand they need to reset their passwords. Also on a larger install, with hundreds of thousands of users, particularly if the site deals with eCommerce, this could provide for a massive headache in terms of support.

Then we're back to a point earlier made by someone else that "it would be trivial to create an alert that would display if the admin attempted to log in when passwords were bcrypted but the server didn't support bcrypt." In that case the request link form can be shown for everyone when login fails the first time (not just admin), and additionally an email sent to admin to alert them. A simple message saying something like "we have changed our login system and require everyone to reset their passwords" could help too.

However, for the kind of sites you mention I would have thought the admins would know what they're doing, and the user case is quite small.

### [#56](#comment:56) [@knutsp](https://profiles.wordpress.org/knutsp) [9 years](/timeline?from=2015-10-07T18%3A09%3A24Z&precision=second "See timeline at 10/07/2015 06:09:24 PM") ago

I think mojorob has a valid point here. The really big sites will or should know what they are doing, and I can't imagine them suddenly downgrading to PHP 5.3 without knowing what they will be facing in this case.

You can already do much more bad/unwise things already, with hooks, filters, dropins and pluggables.

I'm all for responsible thinking when adding hooks, like not inviting to do hazardous and harmful things, but this is meant to enable enhanced security, not?

### [#57](#comment:57) in reply to: [↑ 52](#comment:52) [@toscho](https://profiles.wordpress.org/toscho) [9 years](/timeline?from=2015-10-07T23%3A39%3A57Z&precision=second "See timeline at 10/07/2015 11:39:57 PM") ago

Replying to [mark8barnes](/ticket/21022#comment:52 "Comment 52"):

> That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.

One very exotic and unlikely use case cannot be a reason to lower the security for everyone.

### [#58](#comment:58) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2015-10-07T23%3A50%3A26Z&precision=second "See timeline at 10/07/2015 11:50:26 PM") ago

I'd be careful about "unlikely". There was a fair amount of complaints about the utf8mb4 changes, from people running different versions of mysql on test/demo sites vs. production ones.

In that case, they built sites locally, then transferred them with mysql dumps. This would cause the same problem for local sites running 5.5 and production running 5.2.

Still, my view is to simply reset the passwords in such a case, so I'm still for this change. Maybe making detection of the case is possible too, like was done with the md5 password change originally.

Last edited [9 years ago](/timeline?from=2015-10-07T23%3A55%3A20Z&precision=second "See timeline at 10/07/2015 11:55:20 PM")
by Otto42
([previous](/ticket/21022?cversion=0&cnum_hist=58#comment:58))
([diff](/ticket/21022?action=comment-diff&cnum=58&version=1))

### [#59](#comment:59) [@mojorob](https://profiles.wordpress.org/mojorob) [9 years](/timeline?from=2015-10-08T11%3A12%3A40Z&precision=second "See timeline at 10/08/2015 11:12:40 AM") ago

I also think it's a good idea from now on that for WordPress on PHP5.5+ it should completely bypass the version of PHPass bundled and use the native function. That will ensure the latest algorithm is used as per PHP version on the server.

### [#60](#comment:60) [@kirasong](https://profiles.wordpress.org/kirasong) [9 years](/timeline?from=2015-10-09T00%3A19%3A50Z&precision=second "See timeline at 10/09/2015 12:19:50 AM") ago

Despite the user complications here -- if they switch PHP versions or between hosts, for instance -- I'm very much behind this change.

Let's make passwords more secure for users. :)

### [#61](#comment:61) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2015-10-09T00%3A24%3A24Z&precision=second "See timeline at 10/09/2015 12:24:24 AM") ago

Using the native 5.5 password\_hash functions is a noble idea, but one for a separate ticket given the compat issues.

Let's stick on point for this ticket. All that is needed is to remove the true parameter from where it exists. Maybe some detection code, for the extreme minority of users that will be moving between hosts or systems where this will cause an issue.

Last edited [9 years ago](/timeline?from=2015-10-09T00%3A28%3A07Z&precision=second "See timeline at 10/09/2015 12:28:07 AM")
by Otto42
([previous](/ticket/21022?cversion=0&cnum_hist=61#comment:61))
([diff](/ticket/21022?action=comment-diff&cnum=61&version=1))

### [#62](#comment:62) [@tomdxw](https://profiles.wordpress.org/tomdxw) [9 years](/timeline?from=2015-10-09T13%3A14%3A00Z&precision=second "See timeline at 10/09/2015 01:14:00 PM") ago

One thing that I haven't seen mentioned in this ticket is silently upgrading password hashes. This bit of code updates a user's password hash when they log in if they're still using the compatible hashing scheme:

```
add_filter('check_password', 'my_check_password', 10, 4);
function my_check_password($check='', $password='', $hash='', $user_id='') {
    if($check && substr($hash, 0, 3) == '$P$') {
        wp_set_password($password, $user_id);
    }

    return $check;
}

```

Is it worth including some functionality like that in this ticket? If not, then password hashes will only get updated when users reset their passwords, which means that even after admins upgrade to the latest version of WP it could still be years in the future when the majority of their users are using bcrypt.

Also, note that when the password hashing algorithm is bcrypt, the password reset process breaks. See ticket [#33904](/ticket/33904 "#33904: defect (bug): user_activation_key is too short causing password reset process to ... (closed: fixed)").

### [#63](#comment:63) in reply to: [↑ 52](#comment:52) [@deadduck169](https://profiles.wordpress.org/deadduck169) [9 years](/timeline?from=2015-11-08T22%3A40%3A33Z&precision=second "See timeline at 11/08/2015 10:40:33 PM") ago

Replying to [mark8barnes](/ticket/21022#comment:52 "Comment 52"):

> That's not the worry. The worry is that if this is enabled for PHP 5.5+, then someone downgrades from PHP 5.5 to PHP 5.3, then bcrypt will no longer work, and people won't be able to log-in without resetting their passwords.

Actually, according to [​here](https://github.com/ircmaxell/password_compat), it's versions < 5.3.7 and also that haven't had the $2y fix backported into them that are incompatible. Of the servers using PHP 5.3, most will likely be using either >= 5.3.7 or a version with $2y backported into it.

The [​stats](https://wordpress.org/about/stats/) show that at the time of writing only 11.2% of Wordpress servers currently use PHP 5.2. The chance of someone moving from a PHP 5.3.7+ server back to a 5.2 server are probably pretty negligible, especially since 5.2 has been past its [​end of support](http://php.net/eol.php) since the beginning of 2011, and if changing hosts and given the choice, most people would choose a server with more recent software, not older software.

I feel that while **not** using bcrypt by default we are throwing the baby out with the bath water. We can easily detect whether the user's PHP is compatible with $2y (see the [​check function here](https://github.com/ircmaxell/password_compat/blob/master/lib/password.php)), so even if there's a 0.1% chance that someone might migrate from a compatible version to an incompatible version, all we need to do is display a message to users after they have attempted to log in, like this:

1. User enters their login info
2. Server retrieves password hash from the database
3. Server sees that the hash uses $2y and PHP is <= 5.3.7.
4. Server checks for $2y compatibility using the function linked above
5. If incompatible, display the following message to the user:
   > Warning: This installation of Wordpress was migrated from a new version of PHP to an older one. Unfortunately we are unable to verify your password, so please [reset it]. This only needs to be done once.

So it's a minor inconvenience for the few odd installs that for some reason migrate to an old and unsupported PHP version, but increased security for the ~90% of installs that are currently using PHP >= 5.3.7 (and increasing every day). I think that's a fair trade-off.

Last edited [9 years ago](/timeline?from=2015-11-09T02%3A56%3A28Z&precision=second "See timeline at 11/09/2015 02:56:28 AM")
by deadduck169
([previous](/ticket/21022?cversion=0&cnum_hist=63#comment:63))
([diff](/ticket/21022?action=comment-diff&cnum=63&version=1))

### [#64](#comment:64) [@tomdxw](https://profiles.wordpress.org/tomdxw) [9 years](/timeline?from=2015-12-18T15%3A03%3A16Z&precision=second "See timeline at 12/18/2015 03:03:16 PM") ago

* **Keywords**
  *4.5-early* added

Can we have bcrypt in 4.5?

### [#65](#comment:65) in reply to: [↑ 16](#comment:16) ; follow-up: [↓ 114](#comment:114) [@nacin](https://profiles.wordpress.org/nacin) [9 years](/timeline?from=2016-01-01T23%3A29%3A00Z&precision=second "See timeline at 01/01/2016 11:29:00 PM") ago

Replying to [harrym](/ticket/21022#comment:16 "Comment 16"):

> Switching to bcrypt as the default will only affect a very small number of people (if any) who go from a newer version of PHP to an older one.

This remains my three-year-old concern here. I believe this is a substantially less of a concern of mine now, given that our 5.2 numbers have continued to erode and are under 10% at this time. It's always been unlikely for anyone to deliberately deploy downward to 5.2; but it's now also increasingly unlikely odds for anyone to unwittingly to move to a different host and end up on 5.2.

HOWEVER, we need to handle this with good UX. What does that mean? If you try to log in on a site and the password hash for the account you are trying to log into is `$2a$`, and your site does not support bcrypt, then we need to give them an error message and take them to a very, very good documentation page on wordpress.org.

Additionally, PHP < 5.3.7 has a vulnerability in the Blowfish implementation. We will need to decide if we should skip < 5.3.7, rather than just < 5.2, when turning on Blowfish. That will likely be the cleanest way to do this, based on my rusty understanding of CVE-2011-2483. For more, start with [​http://www.openwall.com/lists/announce/2011/06/21/1](http://www.openwall.com/lists/announce/2011/06/21/1) and [​http://php.net/security/crypt\_blowfish.php](http://php.net/security/crypt_blowfish.php).

Finally, I'd like to see what kind of stats we have on .org that can help us understand how often a site downgrades the PHP version. I'm asking @dd32 for help there.

### [#66](#comment:66) follow-up: [↓ 67](#comment:67) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2016-01-01T23%3A45%3A56Z&precision=second "See timeline at 01/01/2016 11:45:56 PM") ago

Actually, looking at this one again, I think it's been so long on this one that we should instead consider switching to the PHP 5.5+ password\_hash() function, and including a compatibility library such as [​https://github.com/ircmaxell/password\_compat/](https://github.com/ircmaxell/password_compat/) for older PHP versions.

Note that that library is PHP 5.3.7+ only as well, for the same bcrypt security reasons, so we still have issues there. We could consider including both PHPass and the password\_hash compat library, and then using whichever makes sense for the current PHP version.

The user\_pass field was expanded to 255 characters in [#33904](/ticket/33904 "#33904: defect (bug): user_activation_key is too short causing password reset process to ... (closed: fixed)") for exactly this reason, BTW.

Essentially, if we're going to support stronger password encryption methods, then we're ripping the bandaid off anyway. Let's go ahead and modernize to use the built in methods when possible. If we're have to have PHP version checks and such anyway, then we might as well do it up right.

### [#67](#comment:67) in reply to: [↑ 66](#comment:66) [@mojorob](https://profiles.wordpress.org/mojorob) [9 years](/timeline?from=2016-01-02T00%3A23%3A25Z&precision=second "See timeline at 01/02/2016 12:23:25 AM") ago

Replying to [Otto42](/ticket/21022#comment:66 "Comment 66"):

> Actually, looking at this one again, I think it's been so long on this one that we should instead consider switching to the PHP 5.5+ password\_hash() function, and including a compatibility library such as [​https://github.com/ircmaxell/password\_compat/](https://github.com/ircmaxell/password_compat/) for older PHP versions.

I suggested the (PHP5.5+) native password\_hash 3 months ago, and I still think it's the way to go. So I would agree with such a switch.

All except one of the WordPress sites I look after are now running on PHP7, and still using the wp-bcrypt plugin due to what some might suggest is an excessive need to retain backward compatibility. Surely when it comes to password security a better approach is to keep up with standards for those who can. For those who can't/won't then include an alternative as suggested. As mentioned before when there is a downgrade of PHP on a live site, then it could be made to have minimal impact - any large sites would (should?) know of potential issues when downgrading PHP.

Rather than simply having bcrypt in WP4.5, I'd suggest moving over to native password\_hash in a manner suggested by Otto.

### [#68](#comment:68) [@dd32](https://profiles.wordpress.org/dd32) [9 years](/timeline?from=2016-01-02T01%3A37%3A10Z&precision=second "See timeline at 01/02/2016 01:37:10 AM") ago

> I'd like to see what kind of stats we have on .org that can help us understand how often a site downgrades the PHP version.

Unfortunately our stats for this are not very good, it appears that there's probably a lot of sites which are switching between versions of PHP very often which is making our stats very noisy - I'm going to assume these are test or dev sites.. (I'm working on filtering these out so hopefully I'll have some better data to share in a week or so)

I don't think a user would intentionally switch to another host which runs PHP 5.2, however someone who maintains WordPress sites might move a site onto their infrastructure, and run into that problem. I don't see this being an issue to that segment of users though.

Using `password_hash()` in 5.5+ could be a better idea than switching to bcrypt with phpass directly, however, with only ~35% of 4.3/4.4 sites running PHP 5.5/5.6/7 the user experience of a PHP downgrade (no matter how rare) would need to be far better than simply using phpass+bcrypt in PHP 5.3.7+. The number of hosts which are still PHP 5.4 is common enough that a user may switch to one.

I do however wonder if the ideal user experience would simply be a login error with a link to WordPress.org & a password reset email, is something such as `Whoops! PHP can no longer decrypt your password, <a href="w.org">find out why</a> or <a>reset your password</a>` as user friendly as the rest of WordPress which just works?

Last edited [9 years ago](/timeline?from=2016-01-02T02%3A45%3A06Z&precision=second "See timeline at 01/02/2016 02:45:06 AM")
by dd32
([previous](/ticket/21022?cversion=0&cnum_hist=68#comment:68))
([diff](/ticket/21022?action=comment-diff&cnum=68&version=1))

### [#69](#comment:69) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2016-01-02T01%3A44%3A30Z&precision=second "See timeline at 01/02/2016 01:44:30 AM") ago

I agree that this is a UX thing, and giving solid reasoning and information to the user about why is important.

If the password-hash is detectable (via length or header), then this is possible. 3 months ago, we didn't have PHP 7 getting adopted, or 4.4 with increased length password fields. This seems doable now, but maybe making the password hash mechanism more generic and pluggable is the way forward?

### [#70](#comment:70) [@Otto42](https://profiles.wordpress.org/otto42) [9 years](/timeline?from=2016-01-02T01%3A47%3A01Z&precision=second "See timeline at 01/02/2016 01:47:01 AM") ago

Also consider the efforts involved in the two factor plan, insofar as to ensure email resets are working.

### [#71](#comment:71) [@nacin](https://profiles.wordpress.org/nacin) [9 years](/timeline?from=2016-01-04T06%3A36%3A41Z&precision=second "See timeline at 01/04/2016 06:36:41 AM") ago

Replying to @Otto42:

> If the password-hash is detectable

The password algorithm is stored as the first few characters. `$P$` are portable hashes, `$H$` are phpBB portable hashes, `$2a$` is bcrypt, `$2y$` is bcrypt generated by `crypt()` >= PHP 5.3.7.

My comment didn't suggest using phpass over `password_hash()`. Yes, we should probably look at `password_hash()` so we don't need to worry about phpass's internal salt generation. (That said, the author of phpass is also the author of crypt\_blowfish.)

Replying to @dd32:

> Using `password_hash()` in 5.5+ could be a better idea than switching to bcrypt with phpass directly, however, with only ~35% of 4.3/4.4 sites running PHP 5.5/5.6/7 the user experience of a PHP downgrade (no matter how rare) would need to be far better than simply using phpass+bcrypt in PHP 5.3.7+. The number of hosts which are still PHP 5.4 is common enough that a user may switch to one.

It's actually possible we could do 5.5 + `password_hash( $algo = PASSWORD_BCRYPT )` and still be portable down to 5.3.7 without changing anything, because phpass simply uses `crypt()` internally so we'd be able to evaluate a `$2y$` hash. So I'm not actually sure we'd need to use password\_compat.

I'd be mostly interested in figuring out where exactly the new stuff should go. If we do it in our pluggable functions, we'll need to check if we're using portable hashes ($P$, $H$) there so we can send it to phpass (and then upgrade it), otherwise we'll need to put this into phpass. Sounds like we may need our own way to encapsulate (and to get this logic out of pluggable functions).

### [#72](#comment:72) [@mattheweppelsheimer](https://profiles.wordpress.org/mattheweppelsheimer) [9 years](/timeline?from=2016-02-01T00%3A06%3A12Z&precision=second "See timeline at 02/01/2016 12:06:12 AM") ago

> > I don't think a user would intentionally switch to another host which runs PHP 5.2, however someone who maintains WordPress sites might move a site onto their infrastructure, and run into that problem. I don't see this being an issue to that segment of users though.

Agreed, but I just want to point out that "intentionally" is a key word. Over the years we've had a few clients move away from our management to cut costs, then call us in a panic when their cheapskate new host's older PHP version breaks things. Anecdotal but this makes me think it's small sites like these, run by people clueless about PHP versions, who are most likely to get bit.

However we implement better hashing, +1 to @dd32's suggestion (or something similar):

> "Whoops! PHP can no longer decrypt your password, <a href="w.org">find out why</a> or <a>reset your password</a>`

Last edited [9 years ago](/timeline?from=2016-02-01T00%3A07%3A03Z&precision=second "See timeline at 02/01/2016 12:07:03 AM")
by mattheweppelsheimer
([previous](/ticket/21022?cversion=0&cnum_hist=72#comment:72))
([diff](/ticket/21022?action=comment-diff&cnum=72&version=1))

### [#73](#comment:73) [@wturrell](https://profiles.wordpress.org/wturrell) [9 years](/timeline?from=2016-02-17T22%3A09%3A52Z&precision=second "See timeline at 02/17/2016 10:09:52 PM") ago

(Hello, I am new.)

As the ticket is nearly four years old, would the fastest way to make a little progress, but with minimal disruption and whilst keeping our future options open, be implementing the original constant idea, so $portable\_hashes can be false?

Even if the decision is not to activate bcrypt by default for new installations, it would at least allow informed users to increase their security level right now. As already mentioned, phpass stores the algorithm in the initial characters, so it's not computationally expensive to determine which type of password it is (i.e. you don't have to try each in turn) and I can't see how it would restrict future choice of encryption.

Also, I note there's multiple copies of this conditional in core, could it be refactored for DRY purposes?

```
        if ( empty( $wp_hasher ) ) {
                require_once ABSPATH . WPINC . '/class-phpass.php';
                $wp_hasher = new PasswordHash( 8, true );
        }

```

### [#74](#comment:74) [@DeveloperWil](https://profiles.wordpress.org/developerwil) [9 years](/timeline?from=2016-03-05T04%3A20%3A55Z&precision=second "See timeline at 03/05/2016 04:20:55 AM") ago

I like @dd32's idea of simply adding an email and password reset for passwords that cannot be decrypted.

You could even pre-empt issues by storing the current PHP version in the DB during the update check and trigger at the very least an admin email when the version of PHP has been changed, or especially so, downgraded.

That would at least give site owners information on why a site has "broke" as in @mattheweppelsheimer's examples.

Storing the PHP version in the DB could also enable secure password hashing on new installations if PHP >= 5.5

Considering how insecure MD5 is and how many sites are powered by WordPress can this issue get some traction?

Last edited [9 years ago](/timeline?from=2016-03-05T04%3A21%3A17Z&precision=second "See timeline at 03/05/2016 04:21:17 AM")
by DeveloperWil
([previous](/ticket/21022?cversion=0&cnum_hist=74#comment:74))
([diff](/ticket/21022?action=comment-diff&cnum=74&version=1))

### [#75](#comment:75) [@ryan](https://profiles.wordpress.org/ryan) [9 years](/timeline?from=2016-03-07T14%3A57%3A15Z&precision=second "See timeline at 03/07/2016 02:57:15 PM") ago

Related discussion.

[​http://wptavern.com/roots-team-releases-wp-password-bcrypt-plugin-to-improve-wordpress-password-security](http://wptavern.com/roots-team-releases-wp-password-bcrypt-plugin-to-improve-wordpress-password-security)

Comments 65 through 74 summarize the portability concerns.

<https://core.trac.wordpress.org/ticket/21022#comment:65>

### [#76](#comment:76) [@ryan](https://profiles.wordpress.org/ryan) [9 years](/timeline?from=2016-03-07T16%3A05%3A21Z&precision=second "See timeline at 03/07/2016 04:05:21 PM") ago

* Switch to password\_hash() and password\_verify(). This is very straightforward code. [​https://github.com/roots/wp-password-bcrypt/blob/master/wp-password-bcrypt.php](https://github.com/roots/wp-password-bcrypt/blob/master/wp-password-bcrypt.php)
* If log in fails and password\_hash() does not exist and the password hash is not portable, send a password reset email and show a notice on the log in screen explaining that password reset is required and an email has been sent. This will cover the scenario of someone deploying a db with password\_hash() hashes on PHP < 5.3.7.
* Publish a support doc and link to it from the notice.

Should we pull in the back compat versions of password\_hash() and password\_verify() for php >= 5.3.7 and < 5.5 for the scenario of moving forward from phpass to password\_hash()? In other words, do we want to use back compat versions to move sites forward or use them only for the edge case of deploying a database with password\_hash() hashes on an old version of php. Not using them to move forward would mean sites with PHP < 5.5 would stay on phpass, even if they are >= 5.3.7 and can use the back compat funcs.

### [#77](#comment:77) [@ryan](https://profiles.wordpress.org/ryan) [9 years](/timeline?from=2016-03-07T18%3A16%3A42Z&precision=second "See timeline at 03/07/2016 06:16:42 PM") ago

I pinged Solar Designer, author of phpass, for thoughts on migration. Thread:

[​https://twitter.com/rboren/status/706890076135882755](https://twitter.com/rboren/status/706890076135882755)

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #meta by iandunn. [​View the logs](https://wordpress.slack.com/archives/meta/p1459785867000696).* [9 years](/timeline?from=2016-04-04T16%3A04%3A30Z&precision=second "See timeline at 04/04/2016 04:04:30 PM") ago

### [#79](#comment:79) [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2016-09-26T20%3A55%3A14Z&precision=second "See timeline at 09/26/2016 08:55:14 PM") ago

I looked over the past year of comments on this ticket and made a TODO list:

1. add password\_hash()/password\_verify() functions from this library: [​https://github.com/ircmaxell/password\_compat/](https://github.com/ircmaxell/password_compat/)
2. if PHP version >= 5.3.7, use the PHP password\_hash()/password\_verify() functions (for lower versions of PHP, keep using PasswordHash class from phpass)
3. when a user logs in, if the site is using bcrypt and their password is hashed using portable hashes, update their hash to a bcrypt hash
4. when a user logs in, if the site is \*not\* using bcrypt and their password is hashed using bcrypt (i.e. when PHP is downgraded), show a message saying "Sorry, something has gone wrong and you must reset your password. <a href="[​https://codex.wordpress.org/Foobar](https://codex.wordpress.org/Foobar)">More information</a>."

Does this look correct? Have I missed anything? If somebody produced a patch containing the above changes, could we get it committed?

Edit: Removed comment about automatically sending a password reset because the code that sends a password reset lives in wp-login.php so it's not easily accessible from other places.

Last edited [8 years ago](/timeline?from=2016-09-27T18%3A36%3A37Z&precision=second "See timeline at 09/27/2016 06:36:37 PM")
by tomdxw
([previous](/ticket/21022?cversion=1&cnum_hist=79#comment:79))
([diff](/ticket/21022?action=comment-diff&cnum=79&version=2))

### [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2016-09-27T19%3A03%3A16Z&precision=second "See timeline at 09/27/2016 07:03:16 PM") ago

* **Attachment**
  [*21022.3.diff*](/attachment/ticket/21022/21022.3.diff)[​](/raw-attachment/ticket/21022/21022.3.diff "Download")
  added

Use bcrypt where possible, upgrade portable hashes, show error message when downgrading to < PHP 5.3.7

### [#80](#comment:80) [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2016-09-27T19%3A23%3A41Z&precision=second "See timeline at 09/27/2016 07:23:41 PM") ago

Attached a patch.

* I've left the password-protected posts feature alone
* But every other place where the PasswordHash class was being used, that's been replaced with calls to a new class (the new class still uses HashPassword() and CheckPassword() methods so most password-handling code is unchanged)
* The new class checks whether the PHP installation supports the password\_hash/password\_verify functions (and loads a compatibility library for PHP >= 5.3.7 and < 5.5.0)
* It falls back to using the PasswordHash class for PHP < 5.3.7
* I added two filters: one handles upgrading password hashes automatically, and the other provides an explanation when a user logs in and WP is unable to use the password hash found in the database

Of course it needs a bit of polish before it's ready to be committed, but is this the right approach?

### [#81](#comment:81) [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2016-10-26T14%3A14%3A37Z&precision=second "See timeline at 10/26/2016 02:14:37 PM") ago

* **Keywords**
  *needs-testing* added

### [#82](#comment:82) [@chriscct7](https://profiles.wordpress.org/chriscct7) [8 years](/timeline?from=2016-10-27T02%3A47%3A17Z&precision=second "See timeline at 10/27/2016 02:47:17 AM") ago

* **Keywords**
  *4.8-early* added; *4.5-early* removed

### [#83](#comment:83) [@johnbillion](https://profiles.wordpress.org/johnbillion) [8 years](/timeline?from=2016-10-31T01%3A56%3A20Z&precision=second "See timeline at 10/31/2016 01:56:20 AM") ago

* **Milestone**
  changed from *Awaiting Review* to *Future Release*

### [#84](#comment:84) [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2017-01-24T15%3A06%3A52Z&precision=second "See timeline at 01/24/2017 03:06:52 PM") ago

Would be great to get bcrypt support merged into 4.8. Let me know if there's anything I can do to improve the patch.

### [#85](#comment:85) [@tomdxw](https://profiles.wordpress.org/tomdxw) [8 years](/timeline?from=2017-06-21T15%3A05%3A23Z&precision=second "See timeline at 06/21/2017 03:05:23 PM") ago

* **Keywords**
  *4.9-early* added; *4.8-early* removed

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core-passwords by tomdxw. [​View the logs](https://wordpress.slack.com/archives/core-passwords/p1498580559147177).* [8 years](/timeline?from=2017-06-27T16%3A22%3A40Z&precision=second "See timeline at 06/27/2017 04:22:40 PM") ago

### [#87](#comment:87) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-10-06T10%3A48%3A23Z&precision=second "See timeline at 10/06/2017 10:48:23 AM") ago

honestly I would also agree to add native PHP's Password function and give somewhere in the admin panel even an option to set things like the cost or the algorithm (with PHP7.2 for example we will be getting argon2 as an option)

also regarding users with WAY too old PHP versions that are EOL since half an eternity (5.2 was ended in January two thousand ELEVEN), are there stats on how the PHP version split is for people that use the latest (or second latest) version of WP? I wouldnt be expecting too many people who are on older versions to update anyway)

for hosters that only support versions that have been EOL for over 2 years, those hosters should in my opinion be sued for intentionally risking the security of anyone involved.

I would say that when you guys plan to do 5.0 it would be time to throw some things out which are really in the way of security.

Over 25% of Wordpress installations according to stats are running 4.5 or lower, meaning they havent updated for almost a year and a half, in comparison, less than 15% run php 5.2 and 5.3, both are versions EOL for over 3 years at the time of posting.

and for downgrading, another person already mentioned fun with different database versions, so that would be another problem, where PHP cant even do ANYTHING

### [#88](#comment:88) follow-up: [↓ 89](#comment:89) [@tobivreal](https://profiles.wordpress.org/tobivreal) [7 years](/timeline?from=2017-10-19T14%3A44%3A39Z&precision=second "See timeline at 10/19/2017 02:44:39 PM") ago

Use PHPs password\_hash, seriously. How is phpass and md5 still used in 2017??

### [#89](#comment:89) in reply to: [↑ 88](#comment:88) [@KalenJohnson](https://profiles.wordpress.org/kalenjohnson) [7 years](/timeline?from=2017-10-19T15%3A43%3A40Z&precision=second "See timeline at 10/19/2017 03:43:40 PM") ago

Replying to [tobivreal](/ticket/21022#comment:88 "Comment 88"):

> Use PHPs password\_hash, seriously. How is phpass and md5 still used in 2017??

Because WordPress won't support as a minimum PHP 5.5 (when password\_hash became available) until 2025 or so... possibly 2026, we'll see.

### [#90](#comment:90) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-10-19T15%3A50%3A03Z&precision=second "See timeline at 10/19/2017 03:50:03 PM") ago

well it would be enough to ax down PHP 5.2 and anything <5.3.7 and use the compatibility library, also even 5.3 as a whole was axed in august 2014, over 3 years ago and 5.2 is 6 years and 9 months EOL.

and even 5.5 is EOL for over a year already. I think we can drop 5.3 and go with 5.4 at least even though that is also EOL since over 2 years already. a hoster who doesnt even have that should go out of business anyway.

and then again, at least for anyone on PHP>=7 you wouldnt expect those to downgrade lower than 5.5 so it would be at least safe enough to enable proper hashes at least for those, or just go with the best you can and if there's a downgrade you just say password reset and finished

Last edited [7 years ago](/timeline?from=2017-10-19T15%3A51%3A32Z&precision=second "See timeline at 10/19/2017 03:51:32 PM")
by my1xt
([previous](/ticket/21022?cversion=0&cnum_hist=90#comment:90))
([diff](/ticket/21022?action=comment-diff&cnum=90&version=1))

### [#91](#comment:91) [@tomdxw](https://profiles.wordpress.org/tomdxw) [7 years](/timeline?from=2017-10-20T12%3A51%3A39Z&precision=second "See timeline at 10/20/2017 12:51:39 PM") ago

MITRE have assigned the identifier CVE-2012-6707 to refer to the use of a weak MD5-based hash to store passwords in WordPress.

By the way there's a patch which I think should satisfy all the concerns raised in this ticket: <https://core.trac.wordpress.org/ticket/21022#comment:80>

### [#92](#comment:92) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-10-20T13%3A24%3A40Z&precision=second "See timeline at 10/20/2017 01:24:40 PM") ago

@tomdxw I fully agree to this. in case of a downgrade you can just forget the password and set a new one (and you shouldnt use a "personal" password for an installation that has ugly hashes anyway.

but that this now is an official CVE is nice to see.

but a question I posted still stands.

How many of the super-outdated PHP versions are on a recent wordpress installation? are there stats for that?

because only those are in the scope of this anyway.

and even then on a later version of WP like 5.0 PHP <5.3.7 could be axed. also since the older versions apparently still get patched for quite a while, I mean even 3.7 still got an update in September and 3.7 as a whole is almost 4 years old.

PHP 5.2 is as already said already EOL for over 6 years an 9 months and if 4.9 which is sceduled to be on nov 14 would be the last 4.x release and contained MD5 hashes, and it would also get about 4 years of patches PHP5.2 would be EOL since 10 years and 10 months from that hypothetical End of WP4.9.

so while it would be sad to see MD5 in 4.9 it would make sense to enter at least a transition with what @tomdxw said and in 5.0 ax it completely.

while I am not a fan of axing down old versions for mundane reasons, this is a pretty important security thing and really slowing down WP in this aspect.

but when we add password\_hash, I would love to have a setting about the parameters (using argon2 in PHP7.2, or just changing the cost depending on what you like)

### [#93](#comment:93) [@swalkinshaw](https://profiles.wordpress.org/swalkinshaw) [7 years](/timeline?from=2017-10-20T14%3A48%3A42Z&precision=second "See timeline at 10/20/2017 02:48:42 PM") ago

This ticket was opened 5 years ago. There was a patch added 13 months ago without any feedback or response.

@tomdxw has done a great job of summarizing the issues and pushing this forward with a patch. He's even asked twice for feedback about his approach/solution.

After a certain point you have to ask yourself how much the WordPress core team cares about this issue?

### [#94](#comment:94) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-10-24T08%3A26%3A07Z&precision=second "See timeline at 10/24/2017 08:26:07 AM") ago

@swalkinshaw full ack on what you say.

but when it is so **desperately** needed to use some portable hash, why not use an at least marginally safer hash as a base like sha256 or sha512 and iterate on that.

Sure this isnt a very good Idea, but it certainly is better than MD5 and should fullfill the compatibility down to PHP5.2 as I went into the museum of the PHP releases grabbed PHP 5.2.0, started up a shell and let it list hash\_algos which had SHA512.

but the keyword stays on desperately. the approach of either

1) just using whats available and when someone really is either stupid or unlucky enough to downgrade to 5.2, they should reset the password

2) axing off PHP<5.3.7 completely in the next major and going full on the password\_hash

should really be done rather than upgrading the utterly crappy portable password hash into a less junk but still pretty bad but portable password hash.

### [#95](#comment:95) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-11-21T13%3A49%3A35Z&precision=second "See timeline at 11/21/2017 01:49:35 PM") ago

* **Keywords**
  *5.0-early* added; *4.9-early* removed

so 4.9 has release a while ago and of course nothing happened.

version 5.0 is scheduled for 2018, and adding a new full version means that we also could break some things and considering we get many years of security updates even for very old versions, 3.7 even recieved the update on the end of october marking a support time for greater than 4 years, even though it is used just about 0.3% which isnt bad, and I would think if 4 gets similarly lengthy security updates then I think there's no problem to go around breaking stuff on the next major version.

also we still have almost 25% running around on 4.5 or less meaning they are still on a minor from 1 and a half years ago, and they havent bothered updating to a new one. the stats dont show the patchlevel but unless auto updates have been enabled on those, chances are they never recieved any update ever

also small other thing. once 5.0 releases (march 2018 in the earliest considering they run about 4 months per update, though chances are it's more because it's a major) even PHP 5.6 will have less than a year to live and the same for 7.0. At the end of this month PHP 7.2 will release and WP5 should really embrace it by for example allowing the user to use argon2 for passwords.

I honestly dont think it's good in the long run to have a CVE lying around in wordpress for (from the point of WP5.0 release) almost or even more than 6 years, this can seriously affect the reputation at least in the set of people who know IT stuff at least a bit.

and while the following idea is crazy and I know it, if we REALLY want to keep way too old PHP versions alive we should at least switch from MD5 to SHA-1 or if old PHP can work with it, a SHA2 algorithm, and while SHA1 has been Shattered already, it IS less than half as fast as MD5. on a set of 8 GTX1080 MD5 gets over a massive 200 Billion hashes per second. a single overcloecked 1080TI puts in almost 34 Billion hashes, so using 8 of these gets almost 272 Billion hashes. an 8 character completely random password (of all the 94 print-ascii chars) gets us about 6 HOURS in the worst case, considering that most passwords arent random chances are they are broken rather quickly. and while a 10 char password may still take around 6 years on this setup,speeds are only increasing and we are just on GPUs. imagine throwing ASICs into the mix, this is getting crazy and something really needs to be done.

by the way I axed the 4.9-early tag because 4.9 has been released and that tag wont help anyone anymore.

### [#96](#comment:96) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [7 years](/timeline?from=2017-11-21T15%3A47%3A40Z&precision=second "See timeline at 11/21/2017 03:47:40 PM") ago

I've been following this thread for five years. My original comment stands. Once support for for PHP 5.2 is dropped, the password hashing system should change.

I think this debate is better held in a ticket specific to the PHP version number, as I don't see how this ticket can progress without the minimum version number being increased. Once the minimum version number is increased, implementing a better hashing algorithm seems like an obvious and much needed upgrade. In the mean time, we just have to tolerate reduced security.

### [#97](#comment:97) [@my1xt](https://profiles.wordpress.org/my1xt) [7 years](/timeline?from=2017-11-21T15%3A50%3A14Z&precision=second "See timeline at 11/21/2017 03:50:14 PM") ago

but we could at least switch from MD5 to SHA, which isnt a lot better, but hey, it IS better

### [#98](#comment:98) [@kalich5](https://profiles.wordpress.org/kalich5) [7 years](/timeline?from=2018-02-12T16%3A24%3A17Z&precision=second "See timeline at 02/12/2018 04:24:17 PM") ago

Support for PHP 5.2 should be canceled long ago!

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by dingo\_d. [​View the logs](https://wordpress.slack.com/archives/core/p1518688385000149).* [7 years](/timeline?from=2018-02-15T09%3A53%3A07Z&precision=second "See timeline at 02/15/2018 09:53:07 AM") ago

### [#100](#comment:100) [@tomdxw](https://profiles.wordpress.org/tomdxw) [7 years](/timeline?from=2018-05-23T15%3A44%3A24Z&precision=second "See timeline at 05/23/2018 03:44:24 PM") ago

* **Keywords**
  *dev-feedback* added

### [#101](#comment:101) follow-up: [↓ 102](#comment:102) [@tobivreal](https://profiles.wordpress.org/tobivreal) [6 years](/timeline?from=2018-12-28T14%3A40%3A35Z&precision=second "See timeline at 12/28/2018 02:40:35 PM") ago

7 years. Nothing in WP5. You can't delegate this to plugins or user modifications as the average user isn't even aware of this issue.

I cannot justify any new WP installs for clients until this issue is resolved.

### [#102](#comment:102) in reply to: [↑ 101](#comment:101) [@stgoos](https://profiles.wordpress.org/stgoos) [6 years](/timeline?from=2019-01-03T21%3A25%3A33Z&precision=second "See timeline at 01/03/2019 09:25:33 PM") ago

Replying to [tobivreal](/ticket/21022#comment:101 "Comment 101"):

> 7 years. Nothing in WP5. You can't delegate this to plugins or user modifications as the average user isn't even aware of this issue.
>
>
> I cannot justify any new WP installs for clients until this issue is resolved.

Exactly my thoughts, would be nice to see this \*finally\* being resolved in the very near WP5.0.x future.

### [#103](#comment:103) [@bgermann](https://profiles.wordpress.org/bgermann) [6 years](/timeline?from=2019-03-13T22%3A03%3A20Z&precision=second "See timeline at 03/13/2019 10:03:20 PM") ago

As WordPress 5.2 is finally going to [​switch minimum PHP version](https://wordpress.org/news/2019/03/wordpress-5-1-1-security-and-maintenance-release/) to 5.6 this ticket should be revisited. With this change, password\_hash can be used without any backwards compatibility layer.

### [#104](#comment:104) follow-up: [↓ 105](#comment:105) [@Otto42](https://profiles.wordpress.org/otto42) [6 years](/timeline?from=2019-03-13T22%3A22%3A23Z&precision=second "See timeline at 03/13/2019 10:22:23 PM") ago

It is worth noting that switching to password\_hash would effectively limit password lengths to 72 bytes (the bcrypt algorithm ignores the rest, so PHP truncates the password to that length).

This should be discussed, as the last time we limited password lengths, we limited it to 4096 bytes.

I'm for switching to password\_hash, BTW. Just thought this should be known.

### [#105](#comment:105) in reply to: [↑ 104](#comment:104) ; follow-up: [↓ 106](#comment:106) [@deadduck169](https://profiles.wordpress.org/deadduck169) [6 years](/timeline?from=2019-03-13T23%3A05%3A35Z&precision=second "See timeline at 03/13/2019 11:05:35 PM") ago

Replying to [Otto42](/ticket/21022#comment:104 "Comment 104"):

> It is worth noting that switching to password\_hash would effectively limit password lengths to 72 bytes (the bcrypt algorithm ignores the rest, so PHP truncates the password to that length).

If your passwords are 72 bytes long, I can guarantee your security bottleneck is not in the password length limitation.

### [#106](#comment:106) in reply to: [↑ 105](#comment:105) [@Otto42](https://profiles.wordpress.org/otto42) [6 years](/timeline?from=2019-03-13T23%3A08%3A09Z&precision=second "See timeline at 03/13/2019 11:08:09 PM") ago

Replying to [deadduck169](/ticket/21022#comment:105 "Comment 105"):

> If your passwords are 72 bytes long, I can guarantee your security bottleneck is not in the password length limitation.

I don't disagree, but it's worth noting in case any patch tries to keep the existing 4096 limit.

### [@bgermann](https://profiles.wordpress.org/bgermann) [6 years](/timeline?from=2019-05-03T10%3A22%3A59Z&precision=second "See timeline at 05/03/2019 10:22:59 AM") ago

* **Attachment**
  [*21022.4.diff*](/attachment/ticket/21022/21022.4.diff)[​](/raw-attachment/ticket/21022/21022.4.diff "Download")
  added

Use password\_hash instead of phpass

### [#107](#comment:107) follow-up: [↓ 110](#comment:110) [@bgermann](https://profiles.wordpress.org/bgermann) [6 years](/timeline?from=2019-05-03T10%3A33%3A24Z&precision=second "See timeline at 05/03/2019 10:33:24 AM") ago

I kept the class-phpass.php file for the rehashing, however it would be fine to incorporate the used parts inline. How should we handle this?

I did not change the 4096 character limit unit test yet so this one fails. Should I just remove the test or introduce an explicit check for 72 characters in the authentication code and the test?

### [#108](#comment:108) [@bgermann](https://profiles.wordpress.org/bgermann) [6 years](/timeline?from=2019-05-08T19%3A59%3A59Z&precision=second "See timeline at 05/08/2019 07:59:59 PM") ago

* **Keywords**
  *5.0-early* removed
* **Severity**
  changed from *normal* to *major*
* **Summary**
  changed from *Allow bcrypt to be enabled via filter for pass hashing* to *Use bcrypt for password hashing; updating old hashes*

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by bgermann. [​View the logs](https://wordpress.slack.com/archives/core/p1557347902020800).* [6 years](/timeline?from=2019-05-08T20%3A38%3A24Z&precision=second "See timeline at 05/08/2019 08:38:24 PM") ago

### [#110](#comment:110) in reply to: [↑ 107](#comment:107) [@mobby2561](https://profiles.wordpress.org/mobby2561) [6 years](/timeline?from=2019-06-09T16%3A23%3A19Z&precision=second "See timeline at 06/09/2019 04:23:19 PM") ago

Replying to [bgermann](/ticket/21022#comment:107 "Comment 107"):

> I did not change the 4096 character limit unit test yet so this one fails. Should I just remove the test or introduce an explicit check for 72 characters in the authentication code and the test?

I'm not a programmer, but Dropbox has probably a nice approach to this problem - using SHA512 along with the bcrypt.

Maybe this information will help somehow someone.

[​Dorpbox's related article](https://blogs.dropbox.com/tech/2016/09/how-dropbox-securely-stores-your-passwords/)

### [#111](#comment:111) [@paragoninitiativeenterprises](https://profiles.wordpress.org/paragoninitiativeenterprises) [6 years](/timeline?from=2019-07-11T18%3A01%3A23Z&precision=second "See timeline at 07/11/2019 06:01:23 PM") ago

> I'm not a programmer, but Dropbox has probably a nice approach to this problem - using SHA512 along with the bcrypt.

[​Proceed with caution](https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#bcrypt).

The best strategy here, in our opinion, would be to `base64_encode(hash('', '', true))` instead of `hash('', '')`. You'll get a higher information density before the 72 character truncation.

Even unmodified bcrypt is a lot more secure than the current state of affairs with MD5. Bcrypt-SHA2 is the most robust strategy until the whole world can move on to Argon2.

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by timothybjacobs. [​View the logs](https://wordpress.slack.com/archives/core/p1564758499401200).* [5 years](/timeline?from=2019-08-02T15%3A08%3A20Z&precision=second "See timeline at 08/02/2019 03:08:20 PM") ago

### [#113](#comment:113) [@my1xt](https://profiles.wordpress.org/my1xt) [5 years](/timeline?from=2019-09-14T21%3A36%3A12Z&precision=second "See timeline at 09/14/2019 09:36:12 PM") ago

@paragoninitiativeenterprises depending on what characters are safe to use in bcrypt one might even be able to use Base91 instead of base64

[​http://base91.sourceforge.net/](http://base91.sourceforge.net/)

which basically does the same as base64 but with more characters to choose from thereby raising the information density and thereby allowing more stuff into the password before stuff gets truncated.

or obviously IF bcrypt is binary safe one wouldnt need to encode at all and 64 bytes fits into the 72 limit of bcrypt no problem.

### [#114](#comment:114) in reply to: [↑ 65](#comment:65) [@mbijon](https://profiles.wordpress.org/mbijon) [5 years](/timeline?from=2019-09-17T21%3A43%3A30Z&precision=second "See timeline at 09/17/2019 09:43:30 PM") ago

Regarding Base64/basE91...

The truncation of passwords to 72-chars happens automatically in `password_hash()`. Using baseXY methods does not increase the supported password length and does not increase the keyspace.

As for increasing info density, I'm not sure of the point in this situation @paragoninitiativeenterprises. Using `base64_encode( password_hash('', '' true) )` could be un-done with a one-time operation on a leaked DB. then you'd be right back to rainbow table attacks.

---

<red herring alert...>

@paragoninitiativeenterprises:

Did you mean to suggest `password_hash( base64_encode( $password ) )`?

I think that's not really the right debate for a thread aiming to upgrade from MD5 ... but it also runs against the recommendations in NIST 800-63-3:

> Pre-encoding does appear to offer some marginal amount of improvement on bad passwords... First, by converting "abc123" -> "YWJjMTIz". But password complexity is largely ineffective against modern rainbow tables. Longer passwords (ideally passphrases) are a strong recommendation instead of complexity.

> Base64 does offer a 4/3rds stretching effect on passwords. Unfortunately, the stretching effect of base64 means that password\_hash's built-in truncation will limit passwords to 54 characters. Anything above that length would be discarded. This means a reduced keyspace and decreases overall or network-effect security. For example:

* A 54-char input will base74 to 72-chars. Then `password_hash` would use the whole 72-chars
* A 55-char input would base64 to 74-chars and `password_hash` would truncate that to 72-chars

A better option (once password\_hash() is in-use of course) would be to have a "sliding salt" that ensured a minimum-length of 72-chars, ie: `password_hash( $password . $salt_72_char, PASSWORD_DEFAULT )`. Even a short password would get salted to max-out the 72-char limit in password\_hash.

This strategy would allow `password_verify()` to STILL WORK, and also ensure the larger 14-16 char MD5 rainbow tables do nothing if your DB ever is leaked.

### [#115](#comment:115) [@mbijon](https://profiles.wordpress.org/mbijon) [5 years](/timeline?from=2019-09-17T21%3A47%3A10Z&precision=second "See timeline at 09/17/2019 09:47:10 PM") ago

My earlier comment is meant to cut off a potential red herring to this long-running ticket. But it could also be seen as a pretty big red herring itself.

To bring things back to the point: Let's get rid of MD5 hashing.

**I'm in favor of implementing bog standard PHP 5.6 `password_hash( $password, PASSWORD_BCRYPT )`.**

I think if work here focuses on a good backbone of UX and hash-detection, then we'll have an easy path to best-case `PASSWORD_DEFAULT` and Argon2 support in the future.

**Next release:**

* Add the code from `21022.4.diff` but don't remove `passwordHash` yet
* Implement hash-type detection for `$P$B`, `$2y$` and `$argon2i$` (maybe `$2a$`?)
* Using that hash-type detection: 1. Add unit tests for `$2y$` functionality. 2. Deprecate `passwordHash` and start testing for `E_DEPRECATED`
  + Plus, plugins like "wp-password-bcrypt" will easily be able to test for support & capabilities.
* Add an Admin alert to eligible RCs and maybe one major-version of WordPress that detects if `$P$B` hashes are in-use. While PHP 5.6+ ensures support for BCrypt it would be good to warn of a pending password-expiration & length-limit.
* Implement password-expiration for all `$P$B` hashes in Upgrade. Include an Action so Admins can opt to have this upgrade process send password-expiration emails or similar.
  + With hash detection this will ensure NOT expiring `$2y$` or other hashes (in case a site already has "wp-password-bcrypt" or similar installed).
* UX update to registration & pw-reset to inform users of the 72-char password length-limit.

**Future release:**

* REVISE the `password_hash( *, PASSWORD_BCRYPT)` code to `password_hash( *, PASSWORD_DEFAULT )` and add a test for `$argon2i$`
* Remove `passwordHash`

### [#116](#comment:116) [@my1xt](https://profiles.wordpress.org/my1xt) [5 years](/timeline?from=2019-09-18T00%3A31%3A11Z&precision=second "See timeline at 09/18/2019 12:31:11 AM") ago

@mbijon

you kinda overlooked something, so let me summarize (still very long so take your time, there are both code examples and math ahead).

Bcrypt has a 72 length password limit

how to deal with longer Passwords, just truncating kinda sux, especially when we are playing with wordlist passwords?

You said yourself that passphrases are a strong recommendation, the big problem is the bcrypt password length limit though, the idea of wordlist passwords us completely right but the entropy per byte of the phrase is very low. if we knew the list, we could obciously convert this into a byte sequence and be done with it, but we don't.

The idea of @mobby2561 was to SHA-512 the password and throw THAT into bcrypt, basically

```
<?php
$prehash=hash("sha512",$password);
$final_hash=password_hash($prehash,PASSWORD_BCRYPT);

```

Paragon later meant that the hex output is kinda large with 128 chars and suggested to use a base64 hash instead of a hex one, like this:

```
<?php
$prehash_bin=hash("sha512",$password,true);
$prehash_enc=base64_encode($prehash_bin);
$final_hash=password_hash(%prehash_enc,PASSWORD_BCRYPT);

```

now the prehash is down to 88 characters, respectable, but we can do better, was what I thought, and brought base91 to the table.

using a little character counting website SHA512 went for 79 characters, so basically just 7 characters get thrown out.

```
<?php
include("base91.php");

$prehash_bin=hash("sha512",$password,true);
$prehash_enc=base91_encode($prehash_bin);
$final_hash=password_hash(%prehash_enc,PASSWORD_BCRYPT);

```

so the idea is basically to press as much of a password into the bcrypt as we can. obviously a password with more than 512 bits of entropy won't fit into SHA-512 without losing some entropy this way but it would fall out anyway with normal bcrypt.

---

Time for some Math:

the idea is that if we say go for a more optimal case and assume we have a really big wordlist (the one I extract from 1password usually has around 18k words, the one I got a few weeks ago is 18 319, it is 131 879 bytes long, subtracting 18318 (newlines) from it we get 113 561. dividing that by 18 319 gives us an average of 6,2 characters per word.

I think I am pretty generous here, diceware only comes along with 7776 words, so yeah you will probably need a LOT more characters to get the same amount of entropy.

so now we need some harder math so take a breath, look at this and let me explain every step.

[​https://www.wolframalpha.com/input/?i=log18319(2^512)\*6.2](https://www.wolframalpha.com/input/?i=log18319(2^512)*6.2)

from the inside to outside I do the following.

first I let it calculate the possibilites for a 512-bit secure password, aka before we break off the entropy from SHA512.

second I use the log with a base of 18319 to calculate how many words are needed for that

(to clarify a log with base (say 2) of a number (say 8) = x solves the question

2x = 8 with x being obviously 3)

that is about 36 words, quite a lot and most people wont use that sure.

finally we multiply by 6,2 (the average word length and get (not including any spaces) 224 characters before we reach an entropy of 512 bits. no way that's gonna fit into bcrypt.

on the other hand This equation:

[​https://www.wolframalpha.com/input/?i=log2(18319^(72%2F6.2))](https://www.wolframalpha.com/input/?i=log2(18319^(72%2F6.2)))

tells us how much we CAN fit into an average 72 character wordlist password based on the assumptions. around 164 bit, which is definitely VERY good for a password, but reminder that WP currently has had a 4096 character limit for passwords. a straight cut to 72 would be a but dramatic

so after the main math is out let's talk a bit more about the cutting.

the hex sha512 cut 128 to 72, we are down to 288 bit, base64 went down from 88 characters, 418,9 bit, I think we can see where this is going, and finally base91 with 79 chars has 466,6 bit after the 72 character truncation

### [#117](#comment:117) [@my1xt](https://profiles.wordpress.org/my1xt) [5 years](/timeline?from=2019-09-18T00%3A47%3A52Z&precision=second "See timeline at 09/18/2019 12:47:52 AM") ago

regarding the red herring and all the other I am gonna make an extra comment just that it is easier to read.

Let's be honest:

```
<?php
password_hash(base64($password),PASSWORD_BCRYPT)

```

is one of the dumbest ideas ever aside from a little bit of rainbow table prevention, because it limits our options even further, as we actually artificially inflate the password.

the base64 character output is (ignoring padding) is 4/3 of the input. so basically flipping this upside down, the input is 3/4 of the output, meaning we would be down to 54 characters before base64, so let's just not do that.

---

about using password\_DEFAULT instead of forcing bcrypt, while I am generally in big favor of argon there are 2 problems with that.

1) PHP spec says that password default can apply already 1 version after an algorithm has been introduced, meaning that a release without that new hash can be still on the supported list as security only (they generally support 3 at a time, with the last one being security only)

2) Argon2 shows the VERY real problem that just because you have a PHP version you aren't guaranteed to have a certain hash function

3) the idea of downgrading PHP on migration or whatever seems very real here in WP, after all this is what holds/held back this for SEVEN YEARS already.

so currently sadly bcrypt is the only really available hash function, even though I am not happy with it myself.

### [#118](#comment:118) [@deadduck169](https://profiles.wordpress.org/deadduck169) [5 years](/timeline?from=2019-09-18T04%3A50%3A03Z&precision=second "See timeline at 09/18/2019 04:50:03 AM") ago

I think you guys are way over-complicating things here:

1) Always use complete cryptographically secure hashing algorithms. These have been tried and tested for years, whereas their truncated forms have not. Truncated hashes are therefore insecure and using them means you're essentially rolling your own crypto.

2) Bcrypt allows up to 72 bytes (576 bits) of input. SHA-512 produces a 64-bit (512 byte) hash, which fits perfectly in Bcrypt, with space left over. There's absolutely no reason you can't input binary:

```
<?php
$password = 'test';
$sha512_hash = hash('sha512', $password);
$binary = hex2bin($sha512_hash);
$password_hash = password_hash($binary, PASSWORD_DEFAULT);
var_dump(password_verify($binary, $password_hash)); // Output: bool(true)

```

### [#119](#comment:119) follow-up: [↓ 121](#comment:121) [@paragoninitiativeenterprises](https://profiles.wordpress.org/paragoninitiativeenterprises) [5 years](/timeline?from=2019-09-18T05%3A41%3A08Z&precision=second "See timeline at 09/18/2019 05:41:08 AM") ago

> There's absolutely no reason you can't input binary:

What do you think the output of the following code would be?

```
<?php

$correctPW = '34a124424f065ae13936064ab366d9';
$bad = 'be6759bc425ed7b26c177cf53af82b1ed519';

$hash = password_hash(hash('sha512', $correctPW, true), PASSWORD_BCRYPT);
var_dump(
    password_verify(
        hash('sha512', $bad, true),
        $hash
    )
);

```

I'll give you a hint: [​https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#bcrypt](https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#bcrypt)

Code output: [​https://3v4l.org/2FTaS](https://3v4l.org/2FTaS)

### [#120](#comment:120) [@paragoninitiativeenterprises](https://profiles.wordpress.org/paragoninitiativeenterprises) [5 years](/timeline?from=2019-09-18T05%3A59%3A37Z&precision=second "See timeline at 09/18/2019 05:59:37 AM") ago

> now the prehash is down to 88 characters, respectable, but we can do better, was what I thought, and brought base91 to the table.

There's a subtle reason why we recommended Base64: Migrating from base-256 (raw bytes) to any base-N (where N is a power of 2) is easy to implement using constant-time arithmetic. For example: [​https://github.com/paragonie/constant\_time\_encoding/blob/55af0dc01992b4d0da7f6372e2eac097bbbaffdb/src/Base64.php#L213-L270](https://github.com/paragonie/constant_time_encoding/blob/55af0dc01992b4d0da7f6372e2eac097bbbaffdb/src/Base64.php#L213-L270)

When your new base is not an even power of 2, you have to deal with non-constant-time operations. This isn't straightforward: Even multiplying two integers can leak timing information on some processors. [​https://www.bearssl.org/ctmul.html](https://www.bearssl.org/ctmul.html)

RFC 4648 defines several binary-safe encodings that we can use: Base16 (Hex), Base32, Base32Hex, Base64, and Base64Url.

However, we don't actually need **binary-safe** here, what we need is simply "no NUL characters" (without introducing timing leaks would be preferred).

If we really wanted to squeeze as much of the SHA512 hash into the 72 character real estate as possible, we could define an alternative "Base128" where all of the output characters have the high bit set (i.e. they occupy the range `\x80 - \xFF`; the complement to ASCII) and use that instead of Base64. This gives us a binary blow-up of 8/7 which comes out to about 74 characters and is guaranteed to never have a NUL byte. (For the purposes of this discussion, since the high bit is set, let's call this hypothetical "Noble-128" so it doesn't get mistaken for an RFC 4648 approved standard.)

And such an algorithm would be easy to implement: Take 7 bits of input, prefix it with 1 bit, that's your output. (You can even use the standard `=` padding character for uneven inputs, since it's not a valid member of the `\x80-\xFF` keyspace.)

Is this worth the extra engineering effort? Well, the keyspace of a base64-encoded SHA512 hash is roughly 432 bits.

You won't ever need more than 256. [​https://pthree.org/2016/06/19/the-physics-of-brute-force](https://pthree.org/2016/06/19/the-physics-of-brute-force)

In my opinion, bcrypt-sha512-base64 is the most elegant solution available to WordPress with a PHP 5.6 minimum version. Mostly because it's a one-liner and doesn't require a custom encoding scheme be created.

We can bikeshed this further, but a successful argument against base64 here means more technical debt and adding code that mere mortals do not understand in the WordPress codebase.

Of course, if that's worth squeezing an extra 72 bits out of something that's already 174 bits in excessive of a generous security boundary, I'm happy to hear you out.

### [#121](#comment:121) in reply to: [↑ 119](#comment:119) ; follow-up: [↓ 122](#comment:122) [@mbijon](https://profiles.wordpress.org/mbijon) [5 years](/timeline?from=2019-09-18T06%3A51%3A55Z&precision=second "See timeline at 09/18/2019 06:51:55 AM") ago

Funny @paragoninitiativeenterprises, I just found the pointer dereference in PHP's bcrypt: [​https://github.com/php/php-src/blob/master/ext/standard/crypt\_blowfish.c#L613](https://github.com/php/php-src/blob/master/ext/standard/crypt_blowfish.c#L613). Combining crypto methods is never a good idea, eh.

Wish you mentioned the `NUL` dereference in your 1st post here. Good info though: [​https://paragonie.com/blog/2015/04/secure-authentication-php-with-long-term-persistence](https://paragonie.com/blog/2015/04/secure-authentication-php-with-long-term-persistence)

For anyone else following ... **ABSOLUTELY DON'T USE...** `password_hash($raw_sha256|384|512, PASSWORD_BCYPT);`.

The vulnerability is a two-step: (1) Raw SHA hashes allow null-bytes as valid characters. Then (2) the PHP implementation of bcrypt truncates the password-input at the 1st null byte (likely ALL C-based implementations of bcrypt do this).

Or, as @paragoninitiativeenterprises noted in the link just above, there's a 1-in-256 chance that the 1st character in a SHA hash is a NUL-byte (0.39% chance). Extrapolating, that means there's a 5.9% chance a 15+ character (edit: changed 15-char to 15+) password gets truncated early if you feed a raw SHA directly to `password_hash()`.

So ... do NOT `password_hash( hash( 'SHA_any', $password ) )`.

---

In light of that, I think there are two options:

1. `password_hash(base64(sha_abc($password)), SOMETHING)`
2. `password_hash($password, SOMETHING)`

Before anyone has any knee-spasms again: Note that `bcrypt()` is a PBKDF-type cryto. These are sometimes called slow hashes. On the other side, all the SHA's are hash-generators or fast hashes.

In attacker terms, once they get past "easy" rainbow/shortening/lengthening/collision vulnerabilities they're left with brute force. On a GPU bcrypt's default setup/lengthening/salting yields <1,000 attempts/second. On the same GPU, SHA hashing yields ~1,000,000,000 attempts/second.

I can't help but worry your bcrypt-sha512-base64 solution will make jumping to `PASSWORD-DEFAULT` harder @paragoninitiativeenterprises. But heck! it's still 106 better than SHA, and way closer to vanilla `password_hash()` than we have now.

Last edited [5 years ago](/timeline?from=2019-09-18T06%3A54%3A09Z&precision=second "See timeline at 09/18/2019 06:54:09 AM")
by mbijon
([previous](/ticket/21022?cversion=1&cnum_hist=121#comment:121))
([diff](/ticket/21022?action=comment-diff&cnum=121&version=2))

### [#122](#comment:122) in reply to: [↑ 121](#comment:121) [@paragoninitiativeenterprises](https://profiles.wordpress.org/paragoninitiativeenterprises) [5 years](/timeline?from=2019-09-18T07%3A13%3A44Z&precision=second "See timeline at 09/18/2019 07:13:44 AM") ago

Replying to [mbijon](/ticket/21022#comment:121 "Comment 121"):

> Funny @paragoninitiativeenterprises, I just found the pointer dereference in PHP's bcrypt: [​https://github.com/php/php-src/blob/master/ext/standard/crypt\_blowfish.c#L613](https://github.com/php/php-src/blob/master/ext/standard/crypt_blowfish.c#L613). Combining crypto methods is never a good idea, eh.

Most cryptography vulnerabilities exist in the mortar, not the bricks.

> I can't help but worry your bcrypt-sha512-base64 solution will make jumping to `PASSWORD-DEFAULT` harder @paragoninitiativeenterprises. But heck! it's still 106 better than SHA, and way closer to vanilla `password_hash()` than we have now.

It won't make it significantly difficult.

We just need to ensure a reasonable migration path exists for post-bcrypt password hashes, in the same spirit as [​https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#legacy-hashes](https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#legacy-hashes) and [​https://make.wordpress.org/core/2019/05/17/security-in-5-2](https://make.wordpress.org/core/2019/05/17/security-in-5-2)

Back on focus: This ticket was originally targeting WordPress 3.4 when a PHP 5.2 minimum was unlike to change.

Surely with a minimum PHP of 5.6 (the story today) we can seriously consider migrating to bcrypt in a near-future release?

### [#123](#comment:123) [@mbijon](https://profiles.wordpress.org/mbijon) [5 years](/timeline?from=2019-09-18T07%3A52%3A47Z&precision=second "See timeline at 09/18/2019 07:52:47 AM") ago

Yeah @paragoninitiativeenterprises, that's what I was hoping to do with my 1st post today. I do think there are some non-tech steps to take, but using your bcrypt-sha-base64 solution eliminates the need for a password-length warning.

I was leaning toward a forced password-update over backward-compat hashes. It's a big security improvement over having copies of low-security md5's around for years.

But if anyone wants to weigh-in on PM stuff instead of crypto ... How about...?

1. Add Paragon's bcrypt-sha-base64 solution and KEEP `passwordHash`
2. Implement hash-type detection for `$P$B`, `$2y$` and `$argon2i$` (maybe `$2a$`?)
3. For the upgrade, add an `is_legacy_password = true` to `usermeta.meta_key` for every user with a `$P$B` hash.
4. Also during upgrade, using the hash-type detection:
   * Add unit tests for `$2y$` functionality.
   * Batch update every `$P$B` hash into a `$2y$` format.
   * Helps plugins like "wp-password-bcrypt" because the hash detection ensures NOT expiring existing `$2y$` or better hashes.
5. Hook the login Action to check for `is_legacy_password == true` and if so (1) Hash their submitted password with `passwordHash` and `password_hash()` to login, (2) Prompt the user to change their password (including UX with a "why"). On new password creation, set `is_legacy_password = false`

(edited to note two-step hashing for 1st login when `is_legacy_password == true`)

Last edited [5 years ago](/timeline?from=2019-09-18T07%3A59%3A52Z&precision=second "See timeline at 09/18/2019 07:59:52 AM")
by mbijon
([previous](/ticket/21022?cversion=0&cnum_hist=123#comment:123))
([diff](/ticket/21022?action=comment-diff&cnum=123&version=1))

### [#124](#comment:124) [@ayeshrajans](https://profiles.wordpress.org/ayeshrajans) [5 years](/timeline?from=2020-04-29T10%3A47%3A03Z&precision=second "See timeline at 04/29/2020 10:47:03 AM") ago

Created [#50027](/ticket/50027 "#50027: defect (bug): Retire Phpass and use PHP native password hashing (closed: duplicate)") to follow this up.

### [#125](#comment:125) [@SergeyBiryukov](https://profiles.wordpress.org/sergeybiryukov) [4 years](/timeline?from=2020-08-01T19%3A05%3A47Z&precision=second "See timeline at 08/01/2020 07:05:47 PM") ago

* **Description**
  modified ([diff](/ticket/21022?action=diff&version=125))

### [#126](#comment:126) follow-ups: [↓ 127](#comment:127) [↓ 128](#comment:128) [@my1xt](https://profiles.wordpress.org/my1xt) [4 years](/timeline?from=2020-08-02T14%3A03%3A16Z&precision=second "See timeline at 08/02/2020 02:03:16 PM") ago

@SergeyBiryukov I think we can ax phpass altogether in new versions now that WP is committed to use recent PHP versions, and in fact that oldest version stated to work is something in 5.6

[​https://wordpress.org/about/requirements/](https://wordpress.org/about/requirements/)

"WordPress also works with PHP 5.6.20"

or was WP downgrading ever a thing?

### [#127](#comment:127) in reply to: [↑ 126](#comment:126) [@fancsali](https://profiles.wordpress.org/fancsali) [4 years](/timeline?from=2021-04-16T17%3A58%3A24Z&precision=second "See timeline at 04/16/2021 05:58:24 PM") ago

Replying to [my1xt](/ticket/21022#comment:126 "Comment 126"):

> @SergeyBiryukov I think we can ax phpass altogether in new versions now that WP is committed to use recent PHP versions, and in fact that oldest version stated to work is something in 5.6
>
>
> [​https://wordpress.org/about/requirements/](https://wordpress.org/about/requirements/)
>
> "WordPress also works with PHP 5.6.20"
>
>
> or was WP downgrading ever a thing?

+1 ;)

### [#128](#comment:128) in reply to: [↑ 126](#comment:126) [@stgoos](https://profiles.wordpress.org/stgoos) [2 years](/timeline?from=2022-12-11T09%3A02%3A25Z&precision=second "See timeline at 12/11/2022 09:02:25 AM") ago

Replying to [my1xt](/ticket/21022#comment:126 "Comment 126"):

> @SergeyBiryukov I think we can ax phpass altogether in new versions now that WP is committed to use recent PHP versions, and in fact that oldest version stated to work is something in 5.6
>
>
> [​https://wordpress.org/about/requirements/](https://wordpress.org/about/requirements/)
>
> "WordPress also works with PHP 5.6.20"
>
>
> or was WP downgrading ever a thing?

Only when you have a plugin that isn't compatible yet with the newer version of WordPress, but that should only be a very temporarily situation. That said, for the more serious web admins this will only happen on their development/test/staging site and not (as in: never) on their production site.

But in all seriousness. It's plain ridiculous that this particular security topic/ticket (opened at June 20, 2012!!) has still not made it into the core of WordPress. The minimum PHP requirement for WordPress has gone up to PHP 7.4 a while ago already so that can't be the reason (anymore) not to tackle this long long overdue security improvement. Please include it in WordPress 6.2.

Last edited [2 years ago](/timeline?from=2022-12-11T09%3A05%3A02Z&precision=second "See timeline at 12/11/2022 09:05:02 AM")
by stgoos
([previous](/ticket/21022?cversion=1&cnum_hist=128#comment:128))
([diff](/ticket/21022?action=comment-diff&cnum=128&version=2))

### [#129](#comment:129) follow-up: [↓ 130](#comment:130) [@my1xt](https://profiles.wordpress.org/my1xt) [2 years](/timeline?from=2022-12-11T20%3A05%3A10Z&precision=second "See timeline at 12/11/2022 08:05:10 PM") ago

@stgoos fullly agree over here, although considering we are 7.4 already and in fact PHP7 as a whole is EOL by now, so the next version might as well be PHP8+ why not just skip bcrypt and go all-out with argon2id?

### [#130](#comment:130) in reply to: [↑ 129](#comment:129) [@stgoos](https://profiles.wordpress.org/stgoos) [2 years](/timeline?from=2022-12-11T22%3A25%3A00Z&precision=second "See timeline at 12/11/2022 10:25:00 PM") ago

Replying to [my1xt](/ticket/21022#comment:129 "Comment 129"):

> @stgoos fullly agree over here, although considering we are 7.4 already and in fact PHP7 as a whole is EOL by now, so the next version might as well be PHP8+ why not just skip bcrypt and go all-out with argon2id?

Valid point, although backwards compatibility for PHP 7.4 for a little longer is something I can understand due to the fact that so many plugins(/themes) haven't been made PHP 8.x compatible yet - unfortunately.

### [#131](#comment:131) [@my1xt](https://profiles.wordpress.org/my1xt) [2 years](/timeline?from=2022-12-11T22%3A50%3A07Z&precision=second "See timeline at 12/11/2022 10:50:07 PM") ago

A2id has been added to password\_hash in 7.3, which means we should be well spaced in terms of supported versions.

going with the WP stats, the amount of wordpresses being on any 6.x is 63% (the most likely who get an update anyway), and PHP7.3+ is above 80%

### [#132](#comment:132) follow-up: [↓ 133](#comment:133) [@bgermann](https://profiles.wordpress.org/bgermann) [2 years](/timeline?from=2022-12-11T22%3A57%3A59Z&precision=second "See timeline at 12/11/2022 10:57:59 PM") ago

The argon2 suggestion has a problem: It is optional in PHP compilation.

I suggest not using it when compatibility was a concern for a decade.

WordPress always took the stance not to bother people with environment issues and depending on a specific PHP compile-time configuration flag is completely against that notion.

### [#133](#comment:133) in reply to: [↑ 132](#comment:132) ; follow-up: [↓ 135](#comment:135) [@stgoos](https://profiles.wordpress.org/stgoos) [2 years](/timeline?from=2022-12-12T10%3A03%3A15Z&precision=second "See timeline at 12/12/2022 10:03:15 AM") ago

Replying to [bgermann](/ticket/21022#comment:132 "Comment 132"):

> The argon2 suggestion has a problem: It is optional in PHP compilation.
>
> I suggest not using it when compatibility was a concern for a decade.
>
> WordPress always took the stance not to bother people with environment issues and depending on a specific PHP compile-time configuration flag is completely against that notion.

That's a perfectly understandable stance from WordPress side.

**Is a solution in which bcrypt is used, by default, and argon2 -when detected as available- an idea?**

That way we can at least make some progress with this topic after a decade of leaving it aside.

*Btw - WordPress stance "to not bother people with environment issues and depending on a specific PHP compile-time configuration flag" could also be turned around. With an estimated 39-43% of all websites on the web running WordPress it could be a very good driver to make the entire internet a safer place. As providers who don't keep their setup up to date with these requirements from WordPress could simply loose business. I know, it's not as black and white as I just described it and quite a few people starting with WordPress / less tech savvy WordPress users on cheaper(?) hosting will probably think it's a WordPress issue rather than a provider issue..., so avoiding that risk (as mentioned I can understand it) leads to topics like this one.*

Last edited [2 years ago](/timeline?from=2022-12-12T10%3A04%3A00Z&precision=second "See timeline at 12/12/2022 10:04:00 AM")
by stgoos
([previous](/ticket/21022?cversion=0&cnum_hist=133#comment:133))
([diff](/ticket/21022?action=comment-diff&cnum=133&version=1))

### [#134](#comment:134) [@my1xt](https://profiles.wordpress.org/my1xt) [2 years](/timeline?from=2022-12-12T11%3A47%3A13Z&precision=second "See timeline at 12/12/2022 11:47:13 AM") ago

that compile flag thing is some next-level backwards junk.

and I certainly see the point of not needing to look for stuff that deep, because extensions can be "easily" seen and asked for, asking your hoster to recompile PHP gets kinda awkward.

### [#135](#comment:135) in reply to: [↑ 133](#comment:133) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T13%3A06%3A37Z&precision=second "See timeline at 12/12/2022 01:06:37 PM") ago

Replying to [stgoos](/ticket/21022#comment:133 "Comment 133"):

> **Is a solution in which bcrypt is used, by default, and argon2 -when detected as available- an idea?**

Is there potentially a library which could be bundled to support argon2 for the (presumably) rare sites which don't have it available?

Supporting two different encryption methods will presumably cause problems when transitioning between the two. Or is there some method to handle this, without forcing a password reset?

### [#136](#comment:136) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T13%3A09%3A26Z&precision=second "See timeline at 12/12/2022 01:09:26 PM") ago

[​https://github.com/paragonie/sodium\_compat#features-excluded-from-this-polyfill](https://github.com/paragonie/sodium_compat#features-excluded-from-this-polyfill)

```
It's not feasible to polyfill scrypt or Argon2 into PHP and get reasonable performance. Users would feel motivated to select parameters that downgrade security to avoid denial of service (DoS) attacks.

```

That's from a library which interacts with Argon2. It seems to imply that running a simple PHP based library for Argon2 would not be viable due to performance reasons, and the subsequent issues with DDOS attacks that could occur relating to that.

Last edited [2 years ago](/timeline?from=2022-12-12T13%3A11%3A18Z&precision=second "See timeline at 12/12/2022 01:11:18 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=1&cnum_hist=136#comment:136))
([diff](/ticket/21022?action=comment-diff&cnum=136&version=2))

### [#137](#comment:137) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T14%3A09%3A18Z&precision=second "See timeline at 12/12/2022 02:09:18 PM") ago

Since WordPress's minimum requirement is PHP 7.4 and Argon2 comes with PHP 7.2 and above, then perhaps it would be appropriate to add in support for Argon2 to WordPress core, and automatically upgrade everyone to Argon2 when they login next. I don't think BCrypt would be needed, since Argon2 is available to all sites which support the WordPress minimum requirements.

There could be a separate plugin and WP CLI tool which could auto-convert the passwords in bulk too. I think there wouldn't be a problem with server overload from the conversion process, but if there was, then we could even implement a system to allow admins to batch convert them all before they upgraded WordPress (leaving the original password hashes in place until core was upgraded).

EDIT: I forgot about the comment above regarding Argon2 being optional during compilation. But isn't a default feature anyway, so someone would need to actively compile with specific settings in order for this not to work right? That doesn't seem like a problem to me. Doesn't WordPress already fail in some ways if PHP is compiled with different settings? (I can't think of any examples off the top of my head, but I'd have assumed such situations would exist) In rare situations where this did crop up, an error could be shown in the admin and the older (current) system could be used instead. If the site was migrated from an Argon2 encrypted site, then users would need to run a password reset in order to regain access.

Last edited [2 years ago](/timeline?from=2022-12-12T14%3A13%3A53Z&precision=second "See timeline at 12/12/2022 02:13:53 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=1&cnum_hist=137#comment:137))
([diff](/ticket/21022?action=comment-diff&cnum=137&version=2))

### [#138](#comment:138) follow-up: [↓ 139](#comment:139) [@bgermann](https://profiles.wordpress.org/bgermann) [2 years](/timeline?from=2022-12-12T14%3A14%3A36Z&precision=second "See timeline at 12/12/2022 02:14:36 PM") ago

Can somebody enlighten me with a source that the minimum PHP is 7.4 now? I see 5.6 everywhere...

### [#139](#comment:139) in reply to: [↑ 138](#comment:138) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T14%3A15%3A19Z&precision=second "See timeline at 12/12/2022 02:15:19 PM") ago

Replying to [bgermann](/ticket/21022#comment:138 "Comment 138"):

> Can somebody enlighten me with a source that the minimum PHP is 7.4 now? I see 5.6 everywhere...

[​https://wordpress.org/about/requirements/](https://wordpress.org/about/requirements/)

The minimum recommended is 7.4. The minimum that it technically works with is 5.6. The suggestions above wouldn't nullify that statement, as it could still work with 5.6, just using the current password system.

Last edited [2 years ago](/timeline?from=2022-12-12T14%3A18%3A06Z&precision=second "See timeline at 12/12/2022 02:18:06 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=0&cnum_hist=139#comment:139))
([diff](/ticket/21022?action=comment-diff&cnum=139&version=1))

### [#140](#comment:140) follow-up: [↓ 141](#comment:141) [@bgermann](https://profiles.wordpress.org/bgermann) [2 years](/timeline?from=2022-12-12T14%3A17%3A10Z&precision=second "See timeline at 12/12/2022 02:17:10 PM") ago

... which still says: "Note: If you are in a legacy environment where you only have older PHP or MySQL versions, WordPress also works with PHP 5.6.20+ and MySQL 5.0+, but these versions have reached official End Of Life and as such may expose your site to security vulnerabilities."

### [#141](#comment:141) in reply to: [↑ 140](#comment:140) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T14%3A19%3A48Z&precision=second "See timeline at 12/12/2022 02:19:48 PM") ago

> areReplying to [bgermann](/ticket/21022#comment:140 "Comment 140"):
>
>
> > ... which still says: "Note: If you are in a legacy environment where you only have older PHP or MySQL versions, WordPress also works with PHP 5.6.20+ and MySQL 5.0+, but these versions have reached official End Of Life and as such may expose your site to security vulnerabilities."

To me, the "minimum required" is the minimum recommended. Not the minimum that technically still allows it to function. I'm not sure how others interpret that.

Last edited [2 years ago](/timeline?from=2022-12-12T14%3A20%3A09Z&precision=second "See timeline at 12/12/2022 02:20:09 PM")
by ryanhellyer
([previous](/ticket/21022?cversion=0&cnum_hist=141#comment:141))
([diff](/ticket/21022?action=comment-diff&cnum=141&version=1))

### [#142](#comment:142) follow-up: [↓ 143](#comment:143) [@bgermann](https://profiles.wordpress.org/bgermann) [2 years](/timeline?from=2022-12-12T14%3A31%3A07Z&precision=second "See timeline at 12/12/2022 02:31:07 PM") ago

I interpret "works with" as "I can certainly log in".

### [#143](#comment:143) in reply to: [↑ 142](#comment:142) [@ryanhellyer](https://profiles.wordpress.org/ryanhellyer) [2 years](/timeline?from=2022-12-12T15%3A34%3A16Z&precision=second "See timeline at 12/12/2022 03:34:16 PM") ago

Replying to [bgermann](/ticket/21022#comment:142 "Comment 142"):

> I interpret "works with" as "I can certainly log in".

They'd still be able to log in with the suggestion above, albeit they'd need to reset their password if migrating from something with Argon2 to something without it.

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by pikamander2. [​View the logs](https://wordpress.slack.com/archives/core/p1683556480119409).* [21 months](/timeline?from=2023-05-08T14%3A34%3A44Z&precision=second "See timeline at 05/08/2023 02:34:44 PM") ago

### [#145](#comment:145) [@Morno](https://profiles.wordpress.org/morno) [9 months](/timeline?from=2024-04-23T18%3A38%3A09Z&precision=second "See timeline at 04/23/2024 06:38:09 PM") ago

please update to a better password hash than what is currently used and is easy to crack than newer ones.

### [#146](#comment:146) [@bgermann](https://profiles.wordpress.org/bgermann) [7 months](/timeline?from=2024-07-03T22%3A56%3A28Z&precision=second "See timeline at 07/03/2024 10:56:28 PM") ago

WordPress 6.6 will have minimum PHP 7.2, so Argon2i (not Argon2id which needs 7.3) would be viable if the feature unavailability is handled properly.

### *This ticket was mentioned in [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333) on [​WordPress/wordpress-develop](https://github.com/WordPress/wordpress-develop/) by [​@johnbillion](https://profiles.wordpress.org/johnbillion/).* [5 months](/timeline?from=2024-09-11T18%3A38%3A40Z&precision=second "See timeline at 09/11/2024 06:38:40 PM") ago [#147](#comment:147)

* **Keywords**
  *has-unit-tests* added

Latest approach to switching from phpass to bcrypt via the native PHP password hashing functions.

Trac ticket: <https://core.trac.wordpress.org/ticket/21022>

Trac ticket: <https://core.trac.wordpress.org/ticket/50027>

## Todo

* [ ] Decide on an approach for the 72 character limit imposed by bcrypt
* [ ] Tests for the hash upgrade routine for a user password
* [ ] Tests for the hash upgrade routine for an application password
* [ ] Tests for handling post password hashes
* [ ] Find more todos

### [#148](#comment:148) [@desrosj](https://profiles.wordpress.org/desrosj) [3 months](/timeline?from=2024-10-21T13%3A18%3A55Z&precision=second "See timeline at 10/21/2024 01:18:55 PM") ago

* **Keywords**
  *2nd-opinion* *dev-feedback* removed
* **Severity**
  changed from *major* to *normal*

### [#149](#comment:149) [@johnbillion](https://profiles.wordpress.org/johnbillion) [3 months](/timeline?from=2024-10-22T21%3A03%3A53Z&precision=second "See timeline at 10/22/2024 09:03:53 PM") ago

* **Milestone**
  changed from *Future Release* to *6.8*
* **Owner**
  set to *johnbillion*
* **Status**
  changed from *new* to *accepted*

### [#150](#comment:150) [@johnbillion](https://profiles.wordpress.org/johnbillion) [2 months](/timeline?from=2024-11-20T13%3A39%3A50Z&precision=second "See timeline at 11/20/2024 01:39:50 PM") ago

Alright let's kick this out the door at last. I propose switching to bcrypt for password hashing in WordPress 6.8 using the implementation at [​https://github.com/WordPress/wordpress-develop/pull/7333](https://github.com/WordPress/wordpress-develop/pull/7333) .

The description on that PR covers the points raised in the discussion on this ticket and in [#50027](/ticket/50027 "#50027: defect (bug): Retire Phpass and use PHP native password hashing (closed: duplicate)"). The **tl;dr** is that we'll switch from using phpass to using `password_hash()` and `password_verify()` with bcrypt. Loads of info in the PR so please go and take a look and have a read through the description, the FAQ, and the draft for the make/core post.

The one remaining decision to be made concerns the 72 byte input length limit of bcrypt. My proposal is to not implement any specific handling to account for a password greater than 72 bytes in length, and I've written my reasoning for this in the FAQ section of the PR. If there are no objections then we'll go ahead with this.

Feedback, testing, and code reviews on the PR are welcome.

### [#151](#comment:151) [@johnbillion](https://profiles.wordpress.org/johnbillion) [2 months](/timeline?from=2024-11-20T13%3A40%3A01Z&precision=second "See timeline at 11/20/2024 01:40:01 PM") ago

[#50027](/ticket/50027 "#50027: defect (bug): Retire Phpass and use PHP native password hashing (closed: duplicate)") was marked as a duplicate.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2489142795): [2 months](/timeline?from=2024-11-20T17%3A11%3A15Z&precision=second "See timeline at 11/20/2024 05:11:15 PM") ago [#152](#comment:152)

I see @johnbillion beat me to the general strategy in his pull request. I think HMAC-SHA512 is a better approach than SHA384, but both are acceptable.

There are libraries that do SHA384 (not HMAC), but [​then encrypt the password hash with a key](https://github.com/paragonie/password_lock). I think the operational security of both approaches is congruent (you need a key to begin password cracking attempts).

In my opinion, doing SHA384 without HMAC, and without encryption, is less beneficial than the other two approaches. However, al 3 are better than raw bcrypt. And bcrypt is a giant leap in security over phpass.

### [#153](#comment:153) [@haozi](https://profiles.wordpress.org/haozi) [2 months](/timeline?from=2024-11-21T14%3A31%3A34Z&precision=second "See timeline at 11/21/2024 02:31:34 PM") ago

Please refer OWASP's documentation [​https://cheatsheetseries.owasp.org/cheatsheets/Password\_Storage\_Cheat\_Sheet.html#pre-hashing-passwords-with-bcrypt](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#pre-hashing-passwords-with-bcrypt), they don't recommend pre-hashing passwords when using bcrypt, including use base64 to encoding the sha hash result.

Perhaps we can add input length restrictions to prevent users from using too long passwords?

Last edited [2 months ago](/timeline?from=2024-11-21T14%3A42%3A54Z&precision=second "See timeline at 11/21/2024 02:42:54 PM")
by haozi
([previous](/ticket/21022?cversion=0&cnum_hist=153#comment:153))
([diff](/ticket/21022?action=comment-diff&cnum=153&version=1))

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491380138): [2 months](/timeline?from=2024-11-21T14%3A32%3A09Z&precision=second "See timeline at 11/21/2024 02:32:09 PM") ago [#154](#comment:154)

Please refer OWASP's documentation [​https://cheatsheetseries.owasp.org/cheatsheets/Password\_Storage\_Cheat\_Sheet.html#pre-hashing-passwords-with-bcrypt](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#pre-hashing-passwords-with-bcrypt), they don't recommend pre-hashing passwords when using bcrypt.

Perhaps we can add input length restrictions to prevent users from using too long passwords?

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491409237): [2 months](/timeline?from=2024-11-21T14%3A40%3A23Z&precision=second "See timeline at 11/21/2024 02:40:23 PM") ago [#155](#comment:155)

I covered that a bit in the FAQ. The main problem is that 72 bytes != 72 characters once you get outside of ASCII, and you'll need active warnings instead of just a `maxlength` attribute due to the input masking in browsers.

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491507191): [2 months](/timeline?from=2024-11-21T15%3A15%3A50Z&precision=second "See timeline at 11/21/2024 03:15:50 PM") ago [#156](#comment:156)

> I covered that a bit in the FAQ. The main problem is that 72 bytes != 72 characters once you get outside of ASCII, and you'll need active warnings instead of just a `maxlength` attribute due to the input masking in browsers.

In this case, I prefer to ignore them, like Laravel framework.

Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491524133): [2 months](/timeline?from=2024-11-21T15%3A22%3A15Z&precision=second "See timeline at 11/21/2024 03:22:15 PM") ago [#157](#comment:157)

> Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.

Can you be specific? What "more trouble" are you envisioning?

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491572650): [2 months](/timeline?from=2024-11-21T15%3A39%3A57Z&precision=second "See timeline at 11/21/2024 03:39:57 PM") ago [#158](#comment:158)

> > Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.
>
> Can you be specific? What "more trouble" are you envisioning?

> > Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.
>
> Can you be specific? What "more trouble" are you envisioning?

If we upgrade to Argon2 one day, all pre-hashing passwords will need to be re-hashed (Argon2 does not have the 72-byte limit), or we can continue to keep base64+sha384, but this is not necessary in argon2.

If we use PHP's default implementation directly, we won't have these troubles (PHP will handle it automatically).

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491587836): [2 months](/timeline?from=2024-11-21T15%3A45%3A32Z&precision=second "See timeline at 11/21/2024 03:45:32 PM") ago [#159](#comment:159)

> > > Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.
> >
> > Can you be specific? What "more trouble" are you envisioning?
>
> > > Using SHA for pre-hashing will cause more trouble in future upgrades (assuming we need to upgrade to argon2id one day) and will not benefit the vast majority of users and will reduce performance.
> >
> > Can you be specific? What "more trouble" are you envisioning?
>
> If we upgrade to Argon2 one day, all pre-hashing passwords will need to be re-hashed (Argon2 does not have the 72-byte limit), or we can continue to keep base64+sha384, but this is not necessary in argon2.
>
>
> If we use PHP's default implementation directly, we won't have these troubles (PHP will handle it automatically in future version).

Consider:

```
if (hash_equals('$2', substr($pwhash, 0, 2)) {
    $prehash = base64_encode( hash_hmac( /* ... */ ) );
    if (password_verify($prehash, $pwhash)) {
        $newHash = password_hash($password, /* ... */).
    }
}

```

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491618686): [2 months](/timeline?from=2024-11-21T15%3A56%3A44Z&precision=second "See timeline at 11/21/2024 03:56:44 PM") ago [#160](#comment:160)

Another example for reference is [​https://github.com/laravel/framework/pull/49752](https://github.com/laravel/framework/pull/49752) , where they seem to have decided to do nothing.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491643717): [2 months](/timeline?from=2024-11-21T16%3A03%3A28Z&precision=second "See timeline at 11/21/2024 04:03:28 PM") ago [#161](#comment:161)

That's correct. Out of the PHP projects that I listed in the PR, only symfony/password-hasher includes any handling for passwords greater than 72 bytes, and even then it still truncates the resulting hash to due to the use of sha512+base64.

The discussion around hash layering feels dangerously close to rolling your own crypto in order to provide a small amount of additional benefit to an exceptionally small proportion of users.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491675184): [2 months](/timeline?from=2024-11-21T16%3A15%3A39Z&precision=second "See timeline at 11/21/2024 04:15:39 PM") ago [#162](#comment:162)

Thankfully, this isn't anywhere near "rolling our own crypto". The SHA2+base64 paradigm has been implemented in several proprietary systems I've worked on over the past decade.

I also cited password\_lock above as an open source implementation that does a morally equivalent job. If you need a cryptography expert to sign off on this design, ask the developer of that library to review whatever we propose.

> and even then it still truncates the resulting hash due to the use of sha512+base64 which outputs 88 bytes.

SHA-384 and SHA-512 are the exact same algorithm, except SHA-384 has a different initialization vector and is truncated to 384 bits. I don't think it makes any sense to obsess over the truncation here.

If you base64-encode a raw SHA-512 hash to get 88 bytes, and then bcrypt truncates it to a "mere" 72, you still have an input keyspace of 672 or 186 bits of entropy. This is still in far excess of the 128 bits of entropy necessary to be considered secure.

The SHA-2 family of hash functions is secure in most usages (exception: if you're building a MAC by truncating a key and the message). Using HMAC eliminates length-extension, and you can treat HMAC with a secret key as a random oracle.

If you want to be extra paranoid, instead of base64\_encode, prefer [​sodium\_bin2base64](https://www.php.net/manual/en/function.sodium-bin2base64.php) if it's available.

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491701545): [2 months](/timeline?from=2024-11-21T16%3A26%3A10Z&precision=second "See timeline at 11/21/2024 04:26:10 PM") ago [#163](#comment:163)

> Thankfully, this isn't anywhere near "rolling our own crypto". The SHA2+base64 paradigm has been implemented in several proprietary systems I've worked on over the past decade.
>
>
> I also cited password\_lock above as an open source implementation that does a morally equivalent job. If you need a cryptography expert to sign off on this design, ask the developer of that library to review whatever we propose.
>
>
> > and even then it still truncates the resulting hash due to the use of sha512+base64 which outputs 88 bytes.
>
> SHA-384 and SHA-512 are the exact same algorithm, except SHA-384 has a different initialization vector and is truncated to 384 bits. I don't think it makes any sense to obsess over the truncation here.
>
>
> If you base64-encode a raw SHA-512 hash to get 88 bytes, and then bcrypt truncates it to a "mere" 72, you still have an input keyspace of 672 or 486 bits of entropy. This is still in far excess of the 128 bits of entropy necessary to be considered secure.
>
> The SHA-2 family of hash functions is secure in most usages (exception: if you're building a MAC by truncating a key and the message). Using HMAC eliminates length-extension, and you can treat HMAC with a secret key as a random oracle.
>
>
> If you want to be extra paranoid, instead of base64\_encode, prefer [​sodium\_bin2base64](https://www.php.net/manual/en/function.sodium-bin2base64.php) if it's available.

As mentioned before, passwords longer than 72 bytes are rarely used, so it is worth considering whether it is worth doing this.

For `sodium_bin2base64`, it is impossible, WP usually only accepts PHP's own implementation (which is why Argon2 is not used, Argon2 requires PHP to use additional compilation parameters).

There is still a long time before 6.8, let's see what other developers think.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491718269): [2 months](/timeline?from=2024-11-21T16%3A33%3A07Z&precision=second "See timeline at 11/21/2024 04:33:07 PM") ago [#164](#comment:164)

> For `sodium_bin2base64`, it is impossible,

[​https://github.com/WordPress/wordpress-develop/blob/71a52ced57ad8cb9fc52681abb5280c56a0b0a6c/src/wp-includes/sodium\_compat/lib/php72compat.php#L127-L145](https://github.com/WordPress/wordpress-develop/blob/71a52ced57ad8cb9fc52681abb5280c56a0b0a6c/src/wp-includes/sodium_compat/lib/php72compat.php#L127-L145)

:)

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491727314): [2 months](/timeline?from=2024-11-21T16%3A36%3A58Z&precision=second "See timeline at 11/21/2024 04:36:58 PM") ago [#165](#comment:165)

> > For `sodium_bin2base64`, it is impossible,
>
> [​https://github.com/WordPress/wordpress-develop/blob/71a52ced57ad8cb9fc52681abb5280c56a0b0a6c/src/wp-includes/sodium\_compat/lib/php72compat.php#L146-L162](https://github.com/WordPress/wordpress-develop/blob/71a52ced57ad8cb9fc52681abb5280c56a0b0a6c/src/wp-includes/sodium_compat/lib/php72compat.php#L146-L162)
>
>
> :)

If so, is there a pure PHP implementation of Argon2? Using Argon2 directly would not have these annoying problems.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491734241): [2 months](/timeline?from=2024-11-21T16%3A38%3A46Z&precision=second "See timeline at 11/21/2024 04:38:46 PM") ago [#166](#comment:166)

I've covered argon2 and scrypt in the PR description. Unfortunately there is not.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491739496): [2 months](/timeline?from=2024-11-21T16%3A41%3A02Z&precision=second "See timeline at 11/21/2024 04:41:02 PM") ago [#167](#comment:167)

As far as I'm aware, sodium\_compat does not include scrypt or argon2.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491757499): [2 months](/timeline?from=2024-11-21T16%3A48%3A29Z&precision=second "See timeline at 11/21/2024 04:48:29 PM") ago [#168](#comment:168)

Again, I've covered this already in the PR description. sodium\_compat still requires the optional libsodium extension in order to support argon2 or scrypt. There is no polyfill for either in sodium\_compat.

I think we should put a pin in this conversation about the 72 byte limit of bcrypt. It's an interesting computer science problem but it's so far removed from any real life problem that it distracts from assessing the underlying switch to bcrypt.

A 72 byte password has 576 bits of entropy. As soon as a password is over 16 bytes in length, you're beyond the widely recommended 128 bits of entropy to consider a password secure. There is no practical need to retain a higher entropy for passwords greater than 72 bytes.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491817352): [2 months](/timeline?from=2024-11-21T17%3A11%3A57Z&precision=second "See timeline at 11/21/2024 05:11:57 PM") ago [#169](#comment:169)

> > it's so far removed from any real life problem that it distracts from assessing the underlying switch to bcrypt.

I respectfully disagree, for two reasons:

1. WordPress has historically bent over backwards to accommodate a small minority of users. This is evident in the minimum PHP bump from 5.2.4 to 5.6 taking so many years after the PHP team stopped supporting it. That only a few users will see a tangible difference has, historically, not been a valid reason to make a security change.
2. Bcrypt + SHA2 + Base64, as discussed above, materially improves the security and raises the bar for the PHP ecosystem, making WordPress a leader rather than a follower.

The 72-byte limit isn't the only footgun of vanilla bcrypt. Truncating on NUL characters is the other (which is why eschewing the base64 encoding is a bad move).

That being said, consider users with long passphrases. but where each word in the passphrase is low-entropy (e.g. diceware). They're well-served by this change.

That being said:

> I think we should put a pin in this conversation about the 72 byte limit of bcrypt.

That's fine. This is my final word on this topic, unless explicitly queried by another user.

### [​@haozi](https://profiles.wordpress.org/haozi/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2491836607): [2 months](/timeline?from=2024-11-21T17%3A21%3A03Z&precision=second "See timeline at 11/21/2024 05:21:03 PM") ago [#170](#comment:170)

> > it's so far removed from any real life problem that it distracts from assessing the underlying switch to bcrypt.
>
> I respectfully disagree, for two reasons:
>
>
> 1. WordPress has historically bent over backwards to accommodate a small minority of users. This is evident in the minimum PHP bump from 5.2.4 to 5.6 taking so many years after the PHP team stopped supporting it. That only a few users will see a tangible difference has, historically, not been a valid reason to make a security change.
> 2. Bcrypt + SHA2 + Base64, as discussed above, materially improves the security and raises the bar for the PHP ecosystem, making WordPress a leader rather than a follower.
>
> The 72-byte limit isn't the only footgun of vanilla bcrypt. Truncating on NUL characters is the other (which is why eschewing the base64 encoding is a bad move).
>
>
> That being said, consider users with long passphrases. but where each word in the passphrase is low-entropy (e.g. diceware). They're well-served by this change.
>
>
> That being said:
>
>
> > I think we should put a pin in this conversation about the 72 byte limit of bcrypt.
>
> That's fine. This is my final word on this topic, unless explicitly queried by another user.

The criterion for WordPress to stop supporting PHP is the usage rate (as far as I know, this value is less than 5%).

I think the percentage of users using passwords longer than 72 bytes is much less than 5%.

### [#171](#comment:171) follow-up: [↓ 172](#comment:172) [@ayeshrajans](https://profiles.wordpress.org/ayeshrajans) [2 months](/timeline?from=2024-11-22T01%3A59%3A45Z&precision=second "See timeline at 11/22/2024 01:59:45 AM") ago

I maintain a [​WordPress plugin](https://wordpress.org/plugins/password-hash/) does this as well. It intentionally does not pre-hash passwords, and ignore the password length (because it also supports Argon2 with a PHP constant config).

I think the PR looks great as-is, and I really want to vote with the strongest -1 I can muster against pre-hash, pepper, encrypt, or hmac the passwords.

* The point of that plugin is to *upgrade* to bcrypt, and not to roll our own way of hashing passwords. Totally agreeing and echoing what @johnbillion said in [comment:161](/ticket/21022#comment:161 "Comment 161").

* If we were to pre-hash, we run into a problem that users of the roots' or the plugin I linked above will not be able to uninstall the plugin without and let WordPress core handle the same way these plugins were doing.

* If we were to HMAC or god forbid encrypt passwords, we are not doing ourselves any favor, and might break existing sites because now you have to keep the key in sync with the database backups and replicas. Strong -1.

Last edited [2 months ago](/timeline?from=2024-11-22T02%3A01%3A31Z&precision=second "See timeline at 11/22/2024 02:01:31 AM")
by ayeshrajans
([previous](/ticket/21022?cversion=1&cnum_hist=171#comment:171))
([diff](/ticket/21022?action=comment-diff&cnum=171&version=2))

### [#172](#comment:172) in reply to: [↑ 171](#comment:171) [@stgoos](https://profiles.wordpress.org/stgoos) [2 months](/timeline?from=2024-11-22T10%3A29%3A06Z&precision=second "See timeline at 11/22/2024 10:29:06 AM") ago

Replying to [ayeshrajans](/ticket/21022#comment:171 "Comment 171"):

> * The point of that plugin is to *upgrade* to bcrypt, and not to roll our own way of hashing passwords. Totally agreeing and echoing what @johnbillion said in [comment:161](/ticket/21022#comment:161 "Comment 161").
>
> * If we were to pre-hash, we run into a problem that users of the roots' or the plugin I linked above will not be able to uninstall the plugin without and let WordPress core handle the same way these plugins were doing.

Time for WordPress core to adopt the features rollout process as in use with WooCommerce, for existing installations. That way WordPress can draw focus on the additional one-time step(s) that needs to be taken to enable the new feature.

And in all honesty, the problem you described is something WordPress has been creating themselves by leaving this important ticket open for soooo loooong already.

As user of the plugin from Roots, I would not mind informing my users that they will have to set a new password the next time they login due to improved password hashing (/security).

Last edited [2 months ago](/timeline?from=2024-11-22T10%3A30%3A06Z&precision=second "See timeline at 11/22/2024 10:30:06 AM")
by stgoos
([previous](/ticket/21022?cversion=0&cnum_hist=172#comment:172))
([diff](/ticket/21022?action=comment-diff&cnum=172&version=1))

### [​@mbijon](https://profiles.wordpress.org/mbijon/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2498960164): [2 months](/timeline?from=2024-11-25T20%3A23%3A37Z&precision=second "See timeline at 11/25/2024 08:23:37 PM") ago [#173](#comment:173)

I'm with @johnbillion on straight password->bcrypt.

It's counterintuitive, but it will be more secure than password->sha512->bcrypt. Plus, why are we arguing about 470 vs 500+ bits of entropy when ANY form of bcrypt is >30,000,000 more time-consuming to brute force than md5.

---

The cryptographers who designed bcrypt were well aware it limited possible entropy to ~470 bits. They compromised there **on purpose**. At modern cost factors it's 1,000's of years of complexity to brute force a 72 character password. But that limitation prevents resource exhaustion DoS attacks on lower-end servers.

Hashing password->base64(sha512)->bcrypt is less secure in several ways. It enables breach correlation / shucking more easily than raw bcrypt. Plus because of the base64 encoding it LOSES entropy from ALL input passwords. This gets dangerous for the large % of users who have 10 char passwords. They start with a max of ~65 bits of entropy, then clipping from 88 -> 72 characters loses some of that already limited entropy. Progressively more pre-bcrypt steps to deal with this clipping just risks opening DoS vectors.

...meanwhile most users (70-80% per HaveIBeenPwned) are using common, short, and/or recycled passwords. If we're really worried about password security we should raise WP's minimum password length, not bikeshed something cryptographers already considered when designing bcrypt.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2499156613): [2 months](/timeline?from=2024-11-25T22%3A22%3A06Z&precision=second "See timeline at 11/25/2024 10:22:06 PM") ago [#174](#comment:174)

@mbijon Your comment is wrong on several levels, including one I had been ignoring in the previous discussion because I didn't want to derail it with pedantry. Unfortunately, this pedantry is now necessary.

> It enables breach correlation / shucking more easily than raw bcrypt. Plus because of the base64 encoding it LOSES entropy from ALL input passwords. This gets dangerous for the large % of users who have 10 char passwords. They start with a max of ~65 bits of entropy, then clipping from 88 -> 72 characters loses some of that already limited entropy. Progressively more pre-bcrypt steps to deal with this clipping just risks opening DoS vectors.

The most obvious evidence against this statement is [([​https://medium.com/@rajat29gupta/how-bcrypts-limitations-contributed-to-okta-s-vulnerability-a-lesson-for-developers-39425c644ed5](https://medium.com/%40rajat29gupta/how-bcrypts-limitations-contributed-to-okta-s-vulnerability-a-lesson-for-developers-39425c644ed5) the real-world security impact of bcrypt's truncation].

> It enables breach correlation / shucking more easily than raw bcrypt. Plus because of the base64 encoding it LOSES entropy from ALL input passwords. This gets dangerous for the large % of users who have 10 char passwords.

This is nonsense, which I will explain below.

> They start with a max of ~65 bits of entropy, then clipping from 88 -> 72 characters loses some of that already limited entropy.

This is also nonsense, which I will explain below.

> Progressively more pre-bcrypt steps to deal with this clipping just risks opening DoS vectors.

The performance impact of a SHA512 hash compared to a password hashing algorithm is negligible. You can benchmark it yourself.

```
<?php
// Initialize up front
$start = $stop = microtime(true);

// reasonably long example "password"
$x = str_repeat('A', 128);
$y = '';
$i = 0;

$start = microtime(true);
for ($i = 0; $i < 10000; ++$i) {
    $y = hash('sha512', $y, true);
}
$stop = microtime(true);

echo '10,000 iterations of SHA-512 took ', number_format($stop - $start, 3), ' seconds.', PHP_EOL;

$start = microtime(true);
$y = password_hash($x, PASSWORD_BCRYPT);
$stop = microtime(true);

echo '1 iteration of bcrypt took ', number_format($stop - $start, 3), ' seconds.', PHP_EOL;

```

Here's the output on my machine:

```
10,000 iterations of SHA-512 took 0.004 seconds.
1 iteration of bcrypt took 0.045 seconds.

```

We aren't doing 10,000 iterations of SHA-512 here, only 1 or 2 (in the case of HMAC).

The DoS risk for this pre-bcrypt hashing isn't real and can't hurt you.

> ...meanwhile most users (70-80% per HaveIBeenPwned) are using common, short, and/or recycled passwords. If we're really worried about password security we should raise WP's minimum password length, not bikeshed something cryptographers already considered when designing bcrypt.

You... do realize that cryptographers don't like bcrypt, right? That's why the whole [​Password Hashing Competition](https://www.password-hashing.net/) existed. We settled on Argon2id and yescrypt. The whole cryptography community was there.

## Revisiting the Misleading Claims About Entropy

The competing proposals looks like this (vaguely):

1. Hash (or HMAC) the password with SHA-512.
   * SHA-384 is morally congruent to SHA-512, since it's the same exact algorithm but with truncation built-in, and a distinct IV for domain separation. The round functions, word size, and operations are preserved between the two. You don't need to care about this distinction.
2. Base64-encode **the hash output from step 1**.
3. Use the output of step 2 with password\_hash or password\_verify.

SHA-512 is a hash function. Aside from length extension (which isn't relevant to our threat model), you can model SHA-2 family hash functions as a [​Random Oracle](https://crypto.stackexchange.com/a/880).

SHA-512 maps an input domain of 256(2(63)-1) possible inputs to a mere 512 bits. The input isn't guaranteed to be uniformly random (as they are passwords), but the output is.

Base64-encoding **the output of a hash function** does not "[enable] breach correlation / shucking more easily than raw bcrypt". At the layer of base64, we have a uniformly random distribution of 512 bits, which gets encoded as slightly more characters from the base64 alphabet. There is no entropy loss at the base64 layer.

The base64 encoding does not, at all, "[lose] entropy from ALL input passwords."

The "entropy" of the password chosen is preserved as long as SHA-512 collisions are computationally infeasible.

One objection to my previous statement might be, "But what about the 88 -> 72 truncation?"

This is \*still\* secure. 72 characters from the base64 alphabet is still a keyspace representing about 432 bits (or 54 bytes without base64 encoding). This is only 10 bytes short of an untruncated SHA-512, and 6 bytes **longer** than SHA-384.

The best attack against 432 bits of uncertainty is [​a birthday collision attack](https://soatok.blog/2024/07/01/blowing-out-the-candles-on-the-birthday-bound/). You'd need about 2216 samples for a 50% chance of a collision (or 2144 samples for a 1/2144 chance of a collision).

[![https://i0.wp.com/soatok.blog/wp-content/uploads/2021/07/not-gonna-happen.jpg](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/07/not-gonna-happen.jpg "https://i0.wp.com/soatok.blog/wp-content/uploads/2021/07/not-gonna-happen.jpg")](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/07/not-gonna-happen.jpg).

Any concerns about the reduction of entropy from the strategies we've been discussing are either rooted in a poor understanding of password-based cryptography, or are bikeshedding over differences that might as well be zero to any WordPress user.

Meanwhile, that Okta breach is a real thing that happened because of bcrypt's truncation. Maybe we should learn from real world incidents?

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2499229085): [2 months](/timeline?from=2024-11-25T23%3A17%3A32Z&precision=second "See timeline at 11/25/2024 11:17:32 PM") ago [#175](#comment:175)

Unrelated, I was notified because of this GitHub Actions workflow.

> The following contributors have not linked their GitHub and WordPress.org accounts: @soatok.

I'm not going to even \_have\_ a WordPress.org account until this abomination goes away:

[![https://github.com/user-attachments/assets/174c3339-ab8f-4d45-aac1-ef2473b93720](https://github.com/user-attachments/assets/174c3339-ab8f-4d45-aac1-ef2473b93720 "https://github.com/user-attachments/assets/174c3339-ab8f-4d45-aac1-ef2473b93720")](https://github.com/user-attachments/assets/174c3339-ab8f-4d45-aac1-ef2473b93720)

I recommend disabling this until WP.org is Free again.

### [​@mbijon](https://profiles.wordpress.org/mbijon/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2499314967): [2 months](/timeline?from=2024-11-26T00%3A34%3A27Z&precision=second "See timeline at 11/26/2024 12:34:27 AM") ago [#176](#comment:176)

Stop it @soatok. You're undermining a clear improvement on md5 with incorrect information:

Okta's breach was caused by using bcrypt outside it's design params as a cache key generator. They prefixed heavily in a way that consumed most of the 72 bytes in bcrypt's input. This PR does the right thing and uses password-only as input and without hashing, as recommended by both OWASP and NIST.

The hobbyist community's concern over collisions between two 73-char passwords passed directly to bcrypt is wrong in two ways:

1. Most of the examples will have an example where bcrypting 73 chars like `aaa...aaa1` and `aaa...aaa2` produce the same output. That's some userland mess that doesn't happen as long as you don't pass a salt to `PASSWORD_BCRYPT`. Because bcrypt internally salts with Blowfish randoms, two users can use the SAME password of ANY length and get different bcrypt outputs.
2. Anyone using 73+ char passwords is using a generator with some level of randomness and not `aaa...`, `123...123...` or anything remotely simple.

SHA hashing a password does not increase entropy beyond the original password's. SHA may randomize the characters but there's a symbolic (1:1) correlation between those characters and a low-entropy password. Clipping the length of a base64'd string does matter. It reduces the space to store the shortened SHAs of all 10-char passwords.

Regarding cryptographers, NIST does approve of bcrypt and will for several more years. (...it's looking to be past 2029 before FIPS 140-3 validates any modules that might not include bcrypt. More like 2032-2035 if this DOGE department cuts NIST funding).

You are right that Argon2id would be preferable. However the way to make that happen is to push it to the PHP community and not the WP community. md5 however, has been deprecated well over a decade and @johnbillion's approach is the simplest, most recommended way to implement bcrypt.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2499430780): [2 months](/timeline?from=2024-11-26T01%3A58%3A01Z&precision=second "See timeline at 11/26/2024 01:58:01 AM") ago [#177](#comment:177)

> Stop it @soatok. You're undermining a clear improvement on md5 with incorrect information:

1. It's generally considered rude to tell strangers to stop "it". Whatever "it" is, in this context. You're nobody's boss here.
2. Regardless of the choice (which is a one-way door): bcrypt with SHA+base64, or plain bcrypt both materially improve over phpass.

Even if WordPress decides against my recommendations, it's worth discussing the facts so it's an informed decision.

I had rested my case until you came along and posted falsehoods. (Accusing me of "incorrect information" is funny.)

> SHA hashing a password does not increase entropy beyond the original password's.

I didn't say it did.

Using SHA2 to hash a password permutes the bits through the entire hash output, which means the reduction of the base64-encoded hash output is not a meaningful security reduction. That is my argument.

I made no claims about the entropy of the input domain, only the output.

> SHA may randomize the characters but there's a symbolic (1:1) correlation between those characters and a low-entropy password.

This is a meaningless distinction, with my previous statement in mind.

> Clipping the length of a base64'd string does matter. It reduces the space to store the shortened SHAs of all 10-char passwords.

I genuinely do not understand this argument.

If you take a raw SHA-512 hash and encode it with base64, there is no entropy loss due to the encoding of the raw hash, and the truncation of such a large hash still has a sufficiently enormous probability space that it **doesn't help attackers**.

The best possible attack against a truncated SHA-512 is a collision attack. I provided the risk for bcrypt-sha512+base64: After 2144 passwords, there is a 2-144 probability of a collision.

For vanilla bcrypt, it's 2192 for 2-192.

If you \_really\_ want to argue that 2-192 matters more than 2-144, I invite you to write a paper for your argument and submit it to a journal for an IACR-associated event (e.g., Real World Cryptography) and then share your inevitable rejection letter publicly.

Analyzing how the algorithms transform data can tell you if there is a meaningful security reduction in the steps being taken. The short answer is: No. The truncation of an encoded SHA-512 hash is still longer (and of the same quality) as a SHA-384 hash, which is what the US government recommends in CNSA. If we were truncating to less than 256 bits, there might be cause for concern, but that's not the recommendation here.

A weak, 10-character password is just as weak whether or not you use SHA-512+base64 as described above. No meaningful weakness is introduced by this process, and it prevents one that has broken real-world systems.

> Okta's breach was caused by using bcrypt outside it's design params as a cache key generator. They prefixed heavily in a way that consumed most of the 72 bytes in bcrypt's input. This PR does the right thing and uses password-only as input and without hashing, as recommended by both OWASP and NIST.

The point of writing misuse-resistant cryptography (which is what the bcrypt with SHA-512+base64 is) is that you cannot envision all of the possible ways that an API will be used.

Okta previously used bcrypt in a way that wasn't recommended by experts. Developers do this all the time. See also: JWT libraries that accept alg=none.

If someone decides to write a WordPress plugin that uses the WordPress password hashing code for application passwords, and encodes the passwords as `email address || password`, and users supply a very long email address:

* With phpass, their passwords won't be hashed with a memory-hard password hash which sucks. That's the situation today.
* With bcrypt, changing the WordPress password hashing class to vanilla bcrypt will **introduce** a vulnerability that didn't previously exist, due to the 72 character truncation.
* With bcrypt-SHA512+base64, you get the best of both worlds.

You're arguing for the second state, I'm saying the third is the best of both worlds.

In order for it to be correct that I'm "undermining a clear improvement on md5 with incorrect information", I would have to a) be arguing for phpass to continue and b) be stating falsehoods.

> Regarding cryptographers, NIST does approve of bcrypt and will for several more years.

This is incorrect. Bcrypt is not a NIST recommend algorithm, and you cannot use it in a FIPS module. You have to use PBKDF2 with a NIST-approved hash function.

NIST does vaguely recommend a "memory hard" function, but they go on to reference Balloon, not bcrypt.

> > (...it's looking to be past 2029 before FIPS 140-3 validates any modules that might not include bcrypt. More like 2032-2035 if this DOGE department cuts NIST funding).

[​Are you sure about that?](https://aws.amazon.com/blogs/security/aws-lc-is-now-fips-140-3-certified/)

> You are right that Argon2id would be preferable. However the way to make that happen is to push it to the PHP community and not the WP community.

Right. It's a trade-off. I'm not pushing for Argon2id today, I'm telling you what cryptographers prefer today. I know this because cryptography is my job.

---

Aside: [​I'm not the first person to recommend this construction](https://blog.ircmaxell.com/2015/03/security-issue-combining-bcrypt-with.html?m=1#:~:text=You%20are%20100%25%20safe%20if%20you%20do%20one%20of%20the%20following%3A). It's had nearly a decade of scrutiny, even if you only look at the PHP community.

It's comical to suggest that vanilla bcrypt is safer than the construction I recommend.

### [​@paulkevan](https://profiles.wordpress.org/paulkevan/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2500368472): [2 months](/timeline?from=2024-11-26T11%3A21%3A10Z&precision=second "See timeline at 11/26/2024 11:21:10 AM") ago [#178](#comment:178)

> Testing
>
> There's good test coverage for this change. Here are some manual testing steps that can be taken.
>
>
> Remaining logged in after the update

We should try testing this with wp session too, both the standard version and any extended implementation if possible - the expectation is that they aren't affected (user would remain logged in), but it wouldn't harm to check.

> Note that when a user logs in, WordPress already writes to the database via an UPDATE query on the usermeta table to store their updated user session information in the session\_tokens meta field. This happens every time a user logs in.

@johnbillion and I also discussed the potential result of this on large datasets, and assumed it wouldn't result in much higher load, and that a bulk process to update this wouldn't be possible due to how passwords are stored/retrieved. More view on this welcome though!

### [​Synchro](https://github.com/Synchro) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2500464468): [2 months](/timeline?from=2024-11-26T11%3A46%3A39Z&precision=second "See timeline at 11/26/2024 11:46:39 AM") ago [#179](#comment:179)

> Another example for reference is [​laravel/framework#49752](https://github.com/laravel/framework/pull/49752) , where they seem to have decided to [​do nothing](https://github.com/laravel/framework/pull/49752#issuecomment-1905935295).

I made [​this Laravel PR](https://github.com/laravel/framework/pull/52269) to put a bcrypt length check into a validation step, rather than having it just truncate silently, but that was rejected too.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2501958345): [2 months](/timeline?from=2024-11-26T21%3A21%3A49Z&precision=second "See timeline at 11/26/2024 09:21:49 PM") ago [#180](#comment:180)

Meta comment: I've updated my comment earlier in the thread [​to clarify one of my statements](https://github.com/WordPress/wordpress-develop/pull/7333#:~:text=On%20My%20Remark%20About%20Cryptographers%27%20Dislike%20of%20Bcrypt). I wanted to call attention to this in case it is overlooked.

### [​@dd32](https://profiles.wordpress.org/dd32/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2505128884): [2 months](/timeline?from=2024-11-28T02%3A11%3A43Z&precision=second "See timeline at 11/28/2024 02:11:43 AM") ago [#181](#comment:181)

Having read and reviewed this entire PR, I agree with @johnbillion here with retaining the original bcrypt implementation and limitations. Initially I was onboard with SHA384+bcrypt, but after reading, I agree with just bcrypt.

I would suggest that if using bcrypt for >72char is deemed inappropriate, perhaps it should fall back to the current phpass stretched-md5 hashing method, especially if no consensus can be achieved.

That would result in maximum compatibility for existing WordPress users who use the Password hashes outside of WordPress, while also not introducing yet-another-custom-hash into the web where it's not overly obviously necessary, but while still gaining the bcrypt advantages for where it's possible.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2506097988): [2 months](/timeline?from=2024-11-28T13%3A11%3A35Z&precision=second "See timeline at 11/28/2024 01:11:35 PM") ago [#182](#comment:182)

> I would suggest that if using bcrypt for >72char is deemed inappropriate, perhaps it should fall back to the current phpass stretched-md5 hashing method, especially if no consensus can be achieved.

I strongly advise against doing this.

While it's generally assumed that the entropy of a 72+ character password is sufficiently good that nobody is going to crack them, even if it's a weaker password hash like phpass, doing so would kill any chance of a world where everyone is on bcrypt or better.

If possible, I'd suggest trying to measure if this is a real problem before committing to it.

```
/**
 * Is this string longer than the target length?
 * Avoids side-channels.
 * @param string $input
 * @param int $targetLength
 * @return bool true if the length of  $input exceeds $targetLength
 */
function isLongerThanCT(string $input, int $targetLength): bool
{
    $amount = PHP_INT_SIZE === 8 ? 63 : 31;
    $len = strlen($input); // use mb_strlen($input, '8bit'); on older PHP
    $res = (($targetLength - $len) >> $amount) & 1;
    /*
     * It's worth taking a moment to explain what the hell the line above is doing.
     *
     * ($targetLength - $len) will return a negative value if $targetLength is larger than $len.
     *
     * By two's complement, negative values when shifted 31 or 63 places to the right will have a lower
     * bit set. We then use a bit mask of `1` and the bitwise `&` operator on the result of the bitshift.
     *
     * End result? It's the same as if we did the following, except constant-time:
     * $res = (int) ($len > $targetLength);
     */
    return (bool) ($res);
}

```

This function returns `true` if the string has a length greater than or equal to the target length. This calculation is performed without branches or inequality operators and should therefore have a constant-time execution.

You can use this to measure if the length of users' passwords exceeds some threshold.

Demo: [​https://3v4l.org/ebQoq](https://3v4l.org/ebQoq)

### [​@mbijon](https://profiles.wordpress.org/mbijon/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2508743814): [2 months](/timeline?from=2024-11-30T00%3A04%3A48Z&precision=second "See timeline at 11/30/2024 12:04:48 AM") ago [#183](#comment:183)

Please @dd32 let’s not fallback to any form of md5 hashing. The form of md5 stretching in PHPass isn’t built to consume time and can’t be configured to extend the time (rounds). Also, it creates a herd vulnerability on large sites like wordpress.com or WPEngine because it doesn’t have per-user salts (it only peppers passwords with what’s named a “SALT” in wp-config). Plus, there are already enough vulnerabilities in md5 for it to be considered broken since 2008.

Any not-broken form of bcrypt password storage (ie: not like Okta’s old implementation) is more secure than any form of md5 storage.

### [#184](#comment:184) [@mslavco](https://profiles.wordpress.org/mslavco) [8 weeks](/timeline?from=2024-12-03T09%3A46%3A26Z&precision=second "See timeline at 12/03/2024 09:46:26 AM") ago

There are no coverage tests regarding effects against WP core as a whole, let we check how XMLRPC system.multicall would behave from DoS or application passwords from TTB perspective.

Here are simple benchmark results

```
WordPress Hash:
Time Taken: 0.00169 seconds
Hash: $P$Bzw6UBhVjz0K5QWG.iHG52g2lrA7dS0

Bcrypt (Cost 10):
Time Taken: 0.064304 seconds
Hash: $2y$10$c20BhLvwDSRjNZESRZsbtuu1IA5f7o7Q.BbxmG2Tzofm5C2dI87jC

Bcrypt (Cost 12):
Time Taken: 0.218802 seconds
Hash: $2y$12$b9tSyf0J4bfHn/nhW/8n.u0QEYXCgvMBrILEjjXogQF0D4gvZn8Ca

```

for the following pseudo code

```
$p = "1234567890";
wp_hash_password($p);
//vs
password_hash($p, PASSWORD_BCRYPT, ['cost'=>10]);
//vs
password_hash($p, PASSWORD_BCRYPT, ['cost'=>12]);

```

Bcrypt with cost 12 will become/it is default in PHP 8.4. I understand we have no control over PHP, but critical changes/patches like this should be audited with backward and forward compatibility in mind against every existing (maybe against future/planned) functionality in the core. edit

Last edited [5 weeks ago](/timeline?from=2024-12-21T21%3A38%3A01Z&precision=second "See timeline at 12/21/2024 09:38:01 PM")
by mslavco
([previous](/ticket/21022?cversion=1&cnum_hist=184#comment:184))
([diff](/ticket/21022?action=comment-diff&cnum=184&version=2))

### [​raphaelahrens](https://github.com/raphaelahrens) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2528505996): [7 weeks](/timeline?from=2024-12-09T16%3A03%3A27Z&precision=second "See timeline at 12/09/2024 04:03:27 PM") ago [#185](#comment:185)

FYI this was just merged.

[​https://github.com/OWASP/CheatSheetSeries/pull/1551#pullrequestreview-2489258144](https://github.com/OWASP/CheatSheetSeries/pull/1551#pullrequestreview-2489258144)

### [​raphaelahrens](https://github.com/raphaelahrens) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2528505996): [7 weeks](/timeline?from=2024-12-09T16%3A03%3A43Z&precision=second "See timeline at 12/09/2024 04:03:43 PM") ago [#186](#comment:186)

FYI this was just merged.

[​https://github.com/OWASP/CheatSheetSeries/pull/1551#pullrequestreview-2489258144](https://github.com/OWASP/CheatSheetSeries/pull/1551#pullrequestreview-2489258144)

### [​raphaelahrens](https://github.com/raphaelahrens) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2529136157): [7 weeks](/timeline?from=2024-12-09T19%3A09%3A30Z&precision=second "See timeline at 12/09/2024 07:09:30 PM") ago [#187](#comment:187)

FYI [​https://github.com/OWASP/CheatSheetSeries/pull/1551](https://github.com/OWASP/CheatSheetSeries/pull/1551)

### *This ticket was mentioned in [​PR #8020](https://github.com/WordPress/wordpress-develop/pull/8020) on [​WordPress/wordpress-develop](https://github.com/WordPress/wordpress-develop/) by [​@johnbillion](https://profiles.wordpress.org/johnbillion/).* [5 weeks](/timeline?from=2024-12-18T14%3A35%3A04Z&precision=second "See timeline at 12/18/2024 02:35:04 PM") ago [#188](#comment:188)

This is a temporary PR to run the tests for the full bcrypt changes including [​https://github.com/johnbillion/wordpress-develop/pull/5](https://github.com/johnbillion/wordpress-develop/pull/5) and [​https://github.com/johnbillion/wordpress-develop/pull/6](https://github.com/johnbillion/wordpress-develop/pull/6) .

### [​@dd32](https://profiles.wordpress.org/dd32/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2552505596): [5 weeks](/timeline?from=2024-12-19T00%3A10%3A27Z&precision=second "See timeline at 12/19/2024 12:10:27 AM") ago [#189](#comment:189)

> Having read and reviewed this entire PR, I agree with @johnbillion here with retaining the original bcrypt implementation and limitations. Initially I was onboard with SHA384+bcrypt, but after reading, I agree with just bcrypt.

I'd just like to highlight my edit to the above comment:

> \_Edit: (13/Dec/2024) If the consensus from committers and others here is to pre-hash, I'm onboard with that, this was meant as a "If no consensus can be reached" approach\_

I'm totally onboard with double-hashing if it's agreed by all involved.

### [​@mslavco](https://profiles.wordpress.org/mslavco/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2558248404): [5 weeks](/timeline?from=2024-12-21T21%3A45%3A24Z&precision=second "See timeline at 12/21/2024 09:45:24 PM") ago [#190](#comment:190)

Comment from forum <https://core.trac.wordpress.org/ticket/21022#comment:184> here again just for the record:

Context: authentication can take even longer if it is one time process in one system and everything else is later handled with tokens, in WP is different e.g. we perform authentication on every request in many places. Let we check how XMLRPC system.multicall would behave from DoS or application passwords from TTB perspective.

```
WordPress Hash:
Time Taken: 0.00169 seconds
Hash: $P$Bzw6UBhVjz0K5QWG.iHG52g2lrA7dS0

Bcrypt (Cost 10):
Time Taken: 0.064304 seconds
Hash: $2y$10$c20BhLvwDSRjNZESRZsbtuu1IA5f7o7Q.BbxmG2Tzofm5C2dI87jC

Bcrypt (Cost 12):
Time Taken: 0.218802 seconds
Hash: $2y$12$b9tSyf0J4bfHn/nhW/8n.u0QEYXCgvMBrILEjjXogQF0D4gvZn8Ca

```

for the following code a like

```
$p = "1234567890";
wp_hash_password($p);
//vs
password_hash($p, PASSWORD_BCRYPT, ['cost'=>10]);
//vs
password_hash($p, PASSWORD_BCRYPT, ['cost'=>12]);

```

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2558358566): [5 weeks](/timeline?from=2024-12-22T07%3A19%3A29Z&precision=second "See timeline at 12/22/2024 07:19:29 AM") ago [#191](#comment:191)

> Context: authentication can take even longer if it is one time process in one system and everything else is later handled with tokens, in WP is different e.g. we perform authentication on every request in many places.

That's \_horrifying\_.

Bcrypt should be used for logging in actual humans with human-memorable passwords. (These should, in turn, be handled by a password manager, such as 1Password or Bitwarden.)

In an ideal world, XMLRPC authentication should use a high-entropy app password, for which a simple HMAC is more than sufficient.

This is outside the scope of how password hashing is done in WordPress, but I shall ask: How do we get the ecosystem from here to there?

### [​@mslavco](https://profiles.wordpress.org/mslavco/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2558585971): [5 weeks](/timeline?from=2024-12-22T20%3A23%3A23Z&precision=second "See timeline at 12/22/2024 08:23:23 PM") ago [#192](#comment:192)

> Bcrypt should be used for logging in actual humans with human-memorable passwords. (These should, in turn, be handled by a password manager, such as 1Password or Bitwarden.)

Yeah, even more performance intensive algorithms would be ok and can't be a show stopper, because `wp_validate_auth_cookie` is good.

Troubling parts are applications passwords for rest api (here is per request and one time) and xmlrpc (here is where party starts), but also old xmlrpc access (user/pass). Multicall with 20 methods call would cause `~4-5s` per request on any web server out there. Server with 100 workers could be clogged by one party with almost zero resources.

One thing that comes on my mind is how application passwords are implemented, at the moment functionality is with `wp_check_password()` and if move towards `wp_validate_auth_cookie` then xmlrpc access and rest api access won't be troubling. :)

Yet old xmlrpc access with user/pass remains.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2558595399): [5 weeks](/timeline?from=2024-12-22T20%3A52%3A06Z&precision=second "See timeline at 12/22/2024 08:52:06 PM") ago [#193](#comment:193)

> Yet old xmlrpc access with user/pass remains.

As long as a solution \_can be offered\_, I think that's acceptable. We should take extra care to document this, and provide actionable instructions (e.g., "here's how to migrate to app passwords to improve performance after the bcrypt migration").

### [​@mslavco](https://profiles.wordpress.org/mslavco/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2558599705): [5 weeks](/timeline?from=2024-12-22T21%3A06%3A05Z&precision=second "See timeline at 12/22/2024 09:06:05 PM") ago [#194](#comment:194)

> As long as a solution \_can be offered\_, I think that's acceptable.

Only after application passwords are changed, atm it will be the same :)

xmlrpc multicall = effective dos to any instance.

### [​calvinalkan](https://github.com/calvinalkan) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2563081049): [4 weeks](/timeline?from=2024-12-26T20%3A29%3A44Z&precision=second "See timeline at 12/26/2024 08:29:44 PM") ago [#195](#comment:195)

It's not only xmlrpc and application passwords that are affected.

Many plugins also (mistakenly) use `wp_hash_password` for high-entropy input, instead of `wp_hash`

[​https://wpdirectory.net/search/01JG2AGB8XMFHYE9VCB2YR4ZYZ](https://wpdirectory.net/search/01JG2AGB8XMFHYE9VCB2YR4ZYZ)

### [​@Otto42](https://profiles.wordpress.org/otto42/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2564856084): [4 weeks](/timeline?from=2024-12-29T22%3A37%3A52Z&precision=second "See timeline at 12/29/2024 10:37:52 PM") ago [#196](#comment:196)

> 72+ character

Let's be clear here, it's 72 BYTES, not characters. If you use one Unicode character in your password, then now it's 18 characters. UTF8MB4. We do support it.

I'm fine with using password\_hash as is, and relying on the underlying system. However, understand the limitations and know what they are.

### [​@Synchro](https://profiles.wordpress.org/synchro/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2564857972): [4 weeks](/timeline?from=2024-12-29T22%3A48%3A24Z&precision=second "See timeline at 12/29/2024 10:48:24 PM") ago [#197](#comment:197)

> Let's be clear here, it's 72 BYTES, not characters. If you use one Unicode character in your password, then now it's 18 characters. UTF8MB4. We do support it.

That's not how UTF-8 works. For example, `café` is 5 bytes in UTF-8; just because one character is > 1 byte doesn't mean they all are.

### [​@Otto42](https://profiles.wordpress.org/otto42/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2571780936): [3 weeks](/timeline?from=2025-01-05T23%3A03%3A25Z&precision=second "See timeline at 01/05/2025 11:03:25 PM") ago [#198](#comment:198)

> That's not how UTF-8 works. For example, `café` is 5 bytes in UTF-8; just because one character uses > 1 byte doesn't mean they all do.

Fair enough, and I understand that what you're saying here,. However, let's be damn sure of that because failure means not having passwords work correctly, in all languages.

There have to be unit tests for this and those unit tests have to cover a lot of cases. Please make sure we get those right, first.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2573007046): [3 weeks](/timeline?from=2025-01-06T12%3A24%3A07Z&precision=second "See timeline at 01/06/2025 12:24:07 PM") ago [#199](#comment:199)

I'm happy with [​the test coverage that's already in place](https://github.com/WordPress/wordpress-develop/blob/trunk/tests/phpunit/tests/db/charset.php) for utf8mb4 and the other supported database character sets. The tests include string length assertions among many others. Variable length encoding is a fundamental feature of utf8, it's not something that needs specific testing as part of this change.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2573982843): [3 weeks](/timeline?from=2025-01-06T21%3A45%3A42Z&precision=second "See timeline at 01/06/2025 09:45:42 PM") ago [#200](#comment:200)

[​https://github.com/WordPress/wordpress-develop/pull/7333/commits/413e81f1ecf0d69dde0a9c1a6432f26e75ab5f91](https://github.com/WordPress/wordpress-develop/pull/7333/commits/413e81f1ecf0d69dde0a9c1a6432f26e75ab5f91) -- I don't want to belabor the point, but since [​shattered](https://shattered.io/) and [​shambles](https://sha-mbles.github.io/), choosing SHA-1 is at least a code smell. Can you use a SHA-2 family hash function instead?

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2573987070): [3 weeks](/timeline?from=2025-01-06T21%3A48%3A48Z&precision=second "See timeline at 01/06/2025 09:48:48 PM") ago [#201](#comment:201)

@soatok Happy to take some further guidance on this. I was going to use sha256 but it's technically possible for ext/hash to be disabled in PHP < 7.4 which makes this algo unavailable for use in `hash_hmac()`. I will ask the .org team if they have any helpful usage numbers. Any other suggestions?

### [​@Synchro](https://profiles.wordpress.org/synchro/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2573990612): [3 weeks](/timeline?from=2025-01-06T21%3A51%3A29Z&precision=second "See timeline at 01/06/2025 09:51:29 PM") ago [#202](#comment:202)

> [​413e81f](https://github.com/WordPress/wordpress-develop/commit/413e81f1ecf0d69dde0a9c1a6432f26e75ab5f91) -- I don't want to belabor the point, but since [​shattered](https://shattered.io/) and [​shambles](https://sha-mbles.github.io/), choosing SHA-1 is at least a code smell. Can you use a SHA-2 family hash function instead?

Second that. I guarantee that if SHA1 is used, it will be flagged in every pentest and code audit of a WordPress site for the next 20 years...

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574016629): [3 weeks](/timeline?from=2025-01-06T22%3A11%3A41Z&precision=second "See timeline at 01/06/2025 10:11:41 PM") ago [#203](#comment:203)

Scrap that, it looks like sha256 is already unconditionally used in PHPMailer as well as well as the updated Gravatar hash handling in <https://core.trac.wordpress.org/ticket/60638> . I'll make the change.

### [​@Synchro](https://profiles.wordpress.org/synchro/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574021607): [3 weeks](/timeline?from=2025-01-06T22%3A15%3A42Z&precision=second "See timeline at 01/06/2025 10:15:42 PM") ago [#204](#comment:204)

> Scrap that, it looks like sha256 is already unconditionally used in PHPMailer...

That's my department. SHA256 is used to make MIME boundaries, DKIM signatures, S/MIME signing and other things.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574024332): [3 weeks](/timeline?from=2025-01-06T22%3A17%3A56Z&precision=second "See timeline at 01/06/2025 10:17:56 PM") ago [#205](#comment:205)

@dd32 Are you able to pull usage numbers for what % of sites running PHP 7.2-7.3 have ext/hash disabled? In <https://core.trac.wordpress.org/ticket/60638> the Gravatar functions now use sha256 which requires hash to be available on those versions of PHP, and ideally we'd use it in place of my proposed use of sha1 for high entropy security keys.

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574098452): [3 weeks](/timeline?from=2025-01-06T23%3A22%3A38Z&precision=second "See timeline at 01/06/2025 11:22:38 PM") ago [#206](#comment:206)

> I was going to use sha256 but it's technically possible for ext/hash to be disabled in PHP < 7.4 which makes this algo unavailable for use in `hash_hmac()`.

By using `extension_loaded()`, you can [​detect when this extension is disabled](https://3v4l.org/lUie4). If you absolutely need a fallback for "ext/hash is disabled", you can add SHA1 as a fallback. But making it the default just because an edge case is possible will cause years of headache.

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574153931): [3 weeks](/timeline?from=2025-01-07T00%3A16%3A06Z&precision=second "See timeline at 01/07/2025 12:16:06 AM") ago [#207](#comment:207)

There's a few places with conditional logic for `hash()` already in place:

* [​https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/class-wpdb.php#L2409-L2414](https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/class-wpdb.php#L2409-L2414)
* [​https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/pluggable.php#L770-L772](https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/pluggable.php#L770-L772)
* [​https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/pluggable.php#L873-L875](https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/pluggable.php#L873-L875)
* [​https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/class-wp-session-tokens.php#L71-L76](https://github.com/WordPress/wordpress-develop/blob/4a9a928dbcd1c91d3633c8de51614dd90d8ea0ac/src/wp-includes/class-wp-session-tokens.php#L71-L76)

Looks like we'll just need similar logic here for `hash( 'sha256' )` falling back to `sha1()`

### [​@Synchro](https://profiles.wordpress.org/synchro/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2574512655): [3 weeks](/timeline?from=2025-01-07T06%3A53%3A26Z&precision=second "See timeline at 01/07/2025 06:53:26 AM") ago [#208](#comment:208)

> There's a few places with conditional logic for `hash()` already in place:
>
> Looks like we'll just need similar logic here.

Something I have had to do in PHPMailer is to check for extensions in a different way because it seems that some hosting providers (in their infinite wisdom) disable `extension_loaded`, so a safer, more indirect way is to check whether a constant defined by an extension exists, for example by `defined('OPENSSL_ALGO_SHA256')`. However, since WP is already using `extension_loaded` it's safe to continue using it.

### [​calvinalkan](https://github.com/calvinalkan) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2575117998): [3 weeks](/timeline?from=2025-01-07T12%3A04%3A46Z&precision=second "See timeline at 01/07/2025 12:04:46 PM") ago [#209](#comment:209)

@johnbillion why not use:

[​https://www.php.net/manual/en/function.sodium-crypto-generichash.php](https://www.php.net/manual/en/function.sodium-crypto-generichash.php)

For all the high entropy use cases?

It's in sodium\_compat AFAIK

### [​calvinalkan](https://github.com/calvinalkan) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2576018166): [3 weeks](/timeline?from=2025-01-07T18%3A59%3A59Z&precision=second "See timeline at 01/07/2025 06:59:59 PM") ago [#210](#comment:210)

> @johnbillion why not use:
>
>
> [​https://www.php.net/manual/en/function.sodium-crypto-generichash.php](https://www.php.net/manual/en/function.sodium-crypto-generichash.php)
>
>
> For all the high entropy use cases?
>
>
> It's in sodium\_compat AFAIK

Benefits:

[​https://libsodium.gitbook.io/doc/hashing/generic\_hashing#notes](https://libsodium.gitbook.io/doc/hashing/generic_hashing#notes)

> secure hash function that is as strong as SHA-3 but faster than MD5 and SHA-1.

> Unlike MD5, SHA-1, and SHA-256, this function is safe against hash length extension attacks.

### [​@Synchro](https://profiles.wordpress.org/synchro/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2576043384): [3 weeks](/timeline?from=2025-01-07T19%3A15%3A05Z&precision=second "See timeline at 01/07/2025 07:15:05 PM") ago [#211](#comment:211)

> > @johnbillion why not use:
> >
> > [​https://www.php.net/manual/en/function.sodium-crypto-generichash.php](https://www.php.net/manual/en/function.sodium-crypto-generichash.php)
> >
> > For all the high entropy use cases?

This is much [​what I proposed for Laravel](https://github.com/laravel/framework/discussions/32792) \*nearly 5 years ago\*! No movement there either :)

### [​soatok](https://github.com/soatok) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2576066030): [3 weeks](/timeline?from=2025-01-07T19%3A27%3A29Z&precision=second "See timeline at 01/07/2025 07:27:29 PM") ago [#212](#comment:212)

I would much prefer `sodium_crypto_generichash()`, which is included in sodium\_compat, and provides a baked-in keyed hashing mode (so you can replace `hash_hmac()` calls too).

Performance wise, it's obviously fastest if you have ext-sodium installed, but the polyfill isn't too bad.

### *This ticket was mentioned in [​PR #8098](https://github.com/WordPress/wordpress-develop/pull/8098) on [​WordPress/wordpress-develop](https://github.com/WordPress/wordpress-develop/) by [​@johnbillion](https://profiles.wordpress.org/johnbillion/).* [3 weeks](/timeline?from=2025-01-07T22%3A48%3A05Z&precision=second "See timeline at 01/07/2025 10:48:05 PM") ago [#213](#comment:213)

This is to run the tests for [​https://github.com/johnbillion/wordpress-develop/pull/7](https://github.com/johnbillion/wordpress-develop/pull/7)

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2576415635): [3 weeks](/timeline?from=2025-01-07T23%3A25%3A03Z&precision=second "See timeline at 01/07/2025 11:25:03 PM") ago [#214](#comment:214)

I'm working on the switch to `sodium_crypto_generichash()` in [​https://github.com/johnbillion/wordpress-develop/pull/7](https://github.com/johnbillion/wordpress-develop/pull/7).

### [​@johnbillion](https://profiles.wordpress.org/johnbillion/) commented on [​PR #7333](https://github.com/WordPress/wordpress-develop/pull/7333#issuecomment-2578304335): [2 weeks](/timeline?from=2025-01-08T18%3A03%3A55Z&precision=second "See timeline at 01/08/2025 06:03:55 PM") ago [#215](#comment:215)

I've [opened a Trac ticket](https://core.trac.wordpress.org/ticket/62789) to start discussing enforcing application passwords for XML-RPC.

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by johnbillion. [​View the logs](https://wordpress.slack.com/archives/core/p1736974006340259).* [10 days](/timeline?from=2025-01-15T20%3A46%3A48Z&precision=second "See timeline at 01/15/2025 08:46:48 PM") ago

### *This ticket was mentioned in [​Slack](https://make.wordpress.org/chat/) in #core by audrasjb. [​View the logs](https://wordpress.slack.com/archives/core/p1737666578773469).* [2 days](/timeline?from=2025-01-23T21%3A09%3A40Z&precision=second "See timeline at 01/23/2025 09:09:40 PM") ago

**Note:** See
[TracTickets](/wiki/TracTickets) for help on using
tickets.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Comma-delimited Text](/ticket/21022?format=csv)
* [Tab-delimited Text](/ticket/21022?format=tab)
* [RSS Feed](/ticket/21022?format=rss)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from profiles.wordpress.org_df3a6483_20250126_131353.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

# [Profiles](https://profiles.wordpress.org/tomdxw/)

* [Register](https://login.wordpress.org/register?locale=en_US&redirect_to=https%3A%2F%2Fprofiles.wordpress.org%2Ftomdxw%2F)
* [Log In](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fprofiles.wordpress.org%2Ftomdxw%2F&locale=en_US)

![](https://secure.gravatar.com/avatar/821f18aed78fc3a65b3750a4e929951a4d945a7fb51fe8fb6e3a10bfd4a6cf30?s=100&d=mm&r=g)
## [mallorydxw-old](https://profiles.wordpress.org/tomdxw/)

@tomdxw on WordPress.org, @mallorydxw on [Slack](https://make.wordpress.org/chat/)

### Bio

I changed my name. I’m @mallorydxw now.

* Member Since:
  **September 13th, 2012**
* Job Title:
  **Developer**
* Employer:
  **dxw**
* Find me on:

### Contribution History

mallorydxw-old’s badges:

* BuddyPress Contributor
* Core Contributor

* [Activity](#content-activity)

* Mentioned in [[50167]](https://core.trac.wordpress.org/changeset/50167/) on Core SVN:
  Security: add Content-Security-Policy script loaders.

  4 years ago
* Mentioned in [[44659]](https://core.trac.wordpress.org/changeset/44659/) on Core SVN:
  Comments: Show the "awaiting moderation" message when comment cookies are disabled.

  6 years ago
* Created ticket [#43478](https://core.trac.wordpress.org/ticket/43478) on Core Trac:
  Add ability to disable the password protected posts feature

  7 years ago
* Reopened ticket [#43206](https://core.trac.wordpress.org/ticket/43206#comment:2) on Core Trac:
  Angle brackets around URLs can confuse email clients

  7 years ago
* Created ticket [#43206](https://core.trac.wordpress.org/ticket/43206) on Core Trac:
  Angle brackets around URLs can confuse email clients

  7 years ago
* Committed [[1776421]](https://plugins.trac.wordpress.org/changeset/1776421) to Plugins SVN:
  Tag version 1

  7 years ago
* Posted a [reply](https://wordpress.org/support/topic/relevanssi-premium-sql-errors-since-1-15-x/#post-9453991) to *Relevanssi Premium SQL errors since 1.15.x*, on the site WordPress.org Forums:
  Thanks, Mikko. I'm always impressed by how quickly you respond. Keep up the good work.

  7 years ago
* Created a topic, *[Relevanssi Premium SQL errors since 1.15.x](https://wordpress.org/support/topic/relevanssi-premium-sql-errors-since-1-15-x/)*, on the site WordPress.org Forums:
  Here's the two errors I'm getting on each search query…

  7 years ago
* Wrote a [comment](https://make.wordpress.org/core/2017/06/23/dev-chat-summary-june-21st-4-8-1-week-1/#comment-32756) on the post *Dev Chat Summary: June 21st (4.8.1 week 1)*, on the site Make WordPress Core:
  Use bcrypt (has patch): #21022 Stop storing activation keys in plain text (has patch): #38474…

  8 years ago
* Created a topic, *[Call to undefined function get\_field\_object()](https://wordpress.org/support/topic/call-to-undefined-function-get_field_object/)*, on the site WordPress.org Forums:
  If you have ACF activated, but not loaded (for example…

  8 years ago
* Created ticket [#41097](https://core.trac.wordpress.org/ticket/41097) on Core Trac:
  Incorrect parsing of Forwarded header generates warnings

  8 years ago
* Created ticket [#41012](https://core.trac.wordpress.org/ticket/41012) on Core Trac:
  YouTube embed options

  8 years ago
* Created ticket [#40554](https://core.trac.wordpress.org/ticket/40554) on Core Trac:
  Hide /wp-admin/network/site-settings.php

  8 years ago
* Created ticket [#39941](https://core.trac.wordpress.org/ticket/39941) on Core Trac:
  Allow using Content-Security-Policy without unsafe-inline

  8 years ago
* Released a new plugin, [dxw Members Only](https://wordpress.org/plugins/dxw-members-only/)

  8 years ago
* Committed [[1593386]](https://plugins.trac.wordpress.org/changeset/1593386) to Plugins SVN:
  Try and add v4.0.1 again

  8 years ago
* Committed [[1593352]](https://plugins.trac.wordpress.org/changeset/1593352) to Plugins SVN:
  v4.0.1

  8 years ago
* Mentioned in [[39544]](https://core.trac.wordpress.org/changeset/39544/) on Core SVN:
  Allow apostrophes in email address during wp-login.php registration.

  8 years ago
* Created ticket [#38915](https://core.trac.wordpress.org/ticket/38915) on Core Trac:
  Improvements to password reset

  8 years ago
* Created ticket [#38474](https://core.trac.wordpress.org/ticket/38474) on Core Trac:
  wp\_signups.activation\_key stores activation keys in plain text

  8 years ago
* Created ticket [#38134](https://core.trac.wordpress.org/ticket/38134) on Core Trac:
  Allow wp\_no\_robots to be hooked

  8 years ago
* Created ticket [#38109](https://core.trac.wordpress.org/ticket/38109) on Core Trac:
  Improvements to user deletion

  8 years ago
* Created ticket [#38105](https://core.trac.wordpress.org/ticket/38105) on Core Trac:
  wp\_no\_robots() should instruct robots to \*not\* follow links

  8 years ago
* Created ticket [#37790](https://core.trac.wordpress.org/ticket/37790) on Core Trac:
  Post editing sidebar does not always act sticky

  8 years ago
* Mentioned in [[38332]](https://core.trac.wordpress.org/changeset/38332/) on Core SVN:
  WP Mail: If post-by-email functionality is disabled, `wp-mail.php` should return a `403 Forbidden` status code instead if `500 Internal Server Error`.

  8 years ago
* Created ticket [#37572](https://core.trac.wordpress.org/ticket/37572) on Core Trac:
  When wp-mail.php is disabled, it returns 500 instead of a more appropriate ...

  8 years ago
* Wrote a [comment](https://make.wordpress.org/core/2016/04/14/wordpress-4-6-whats-on-your-wish-list/#comment-29819) on the post WordPress 4.6: What’s on your wish list?, on the site Make WordPress Core:
  Let's increase the security of passwords by using bcrypt: https://core.trac.wordpress.org/ticket/21022

  9 years ago
* Wrote a [comment](https://make.wordpress.org/core/2015/12/30/wordpress-4-5-whats-on-your-wishlist/#comment-28834) on the post WordPress 4.5: What’s on your Wishlist?, on the site Make WordPress Core:
  How about bcrypt? https://core.trac.wordpress.org/ticket/21022 It's a one-line change and it'll make a huge difference to…

  9 years ago
* Created ticket [#35266](https://core.trac.wordpress.org/ticket/35266) on Core Trac:
  Set appropriate Cache-Control and/or Pragma headers on the front-end

  9 years ago
* Created ticket [#34483](https://core.trac.wordpress.org/ticket/34483) on Core Trac:
  Allow apostrophes in email addresses when accounts are registered

  9 years ago
* Created ticket [#33904](https://core.trac.wordpress.org/ticket/33904) on Core Trac:
  user\_activation\_key is too short causing password reset process to break ...

  9 years ago
* Created ticket [#32511](https://core.trac.wordpress.org/ticket/32511) on Core Trac:
  "Limited Email Registrations" option should not prevent (super)admins from ...

  10 years ago
* Wrote a [comment](https://make.wordpress.org/core/2015/05/11/the-plan-for-passwords/#comment-25824) on the post The Plan for Passwords, on the site Make WordPress Core:
  I couldn't find an existing ticket about this so I made one: https://core.trac.wordpress.org/ticket/32401

  10 years ago
* Created ticket [#32401](https://core.trac.wordpress.org/ticket/32401) on Core Trac:
  Multi step authentication - adding hooks to wp-login.php

  10 years ago
* Wrote a [comment](https://make.wordpress.org/core/2015/05/11/the-plan-for-passwords/#comment-25796) on the post The Plan for Passwords, on the site Make WordPress Core:
  We definitely need some new hooks for this. I did this recently and I agree…

  10 years ago
* Wrote a [comment](https://make.wordpress.org/core/2015/05/11/the-plan-for-passwords/#comment-25788) on the post The Plan for Passwords, on the site Make WordPress Core:
  IIRC generated passwords are currently a random mixture of letters and numbers, right? Are there…

  10 years ago
* Mentioned in [[31300]](https://core.trac.wordpress.org/changeset/31300/) on Core SVN:
  Switch to a 403 response code in places where it is more appropriate than a 500 due to permissions errors.

  10 years ago
* Created ticket [#30927](https://core.trac.wordpress.org/ticket/30927) on Core Trac:
  Replace some 500 errors with 403 errors

  10 years ago
* Created ticket [#30384](https://core.trac.wordpress.org/ticket/30384) on Core Trac:
  Cannot hook plupload's JavaScript consistently

  10 years ago
* Created ticket [#5977](https://buddypress.trac.wordpress.org/ticket/5977) on BuddyPress Trac:
  Cannot see/activate/delete pending accounts when BuddyPress is activated ...

  10 years ago
* Wrote a [comment](http://make.wordpress.org/core/2014/10/01/4-1-call-for-tickets/#comment-19477) on the post 4.1: Call for Tickets, on the site Make WordPress Core:
  Apostrophes in email addresses! This has been a known issue for at least half a…

  10 years ago
* Committed [[978160]](https://plugins.trac.wordpress.org/changeset/978160) to Plugins SVN:
  Remove old plugin

  10 years ago
* Committed [[977918]](https://plugins.trac.wordpress.org/changeset/977918) to Plugins SVN:
  Deleting old plugin

  10 years ago
* Created ticket [#5743](https://buddypress.trac.wordpress.org/ticket/5743) on BuddyPress Trac:
  Member count uses incorrect plural form if 999 < member count < 2000

  11 years ago
* Created ticket [#27896](https://core.trac.wordpress.org/ticket/27896) on Core Trac:
  wordpress-importer's lack of understanding of XML Namespaces causing ...

  11 years ago
* Created ticket [#27726](https://core.trac.wordpress.org/ticket/27726) on Core Trac:
  Get Shortlink button isn't shown on draft posts

  11 years ago
* Created ticket [#27499](https://core.trac.wordpress.org/ticket/27499) on Core Trac:
  When creating new subdomain site, siteurl and home are set to http:// ...

  11 years ago
* Created ticket [#27413](https://core.trac.wordpress.org/ticket/27413) on Core Trac:
  PHP warnings generated by wp\_generate\_tag\_cloud

  11 years ago
* Created ticket [#25872](https://core.trac.wordpress.org/ticket/25872) on Core Trac:
  WXR export tool generates XML which is not well-formed

  11 years ago
* Created ticket [#25697](https://core.trac.wordpress.org/ticket/25697) on Core Trac:
  User search in network admin returns different results to user search in a ...

  11 years ago

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


