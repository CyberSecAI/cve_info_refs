=== Content from bugzilla.mozilla.org_bb5ce752_20250126_050505.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Sat Jan 25 2025 21:05:04 PST

* **Bug ID:**
  719750,
  748119,
  749039,
  754150,
  754242,
  732870,
  752038,
  753162,
  755916,
  780712,
  730208,
  779849,
  752087,
  765936

---

14 bugs found.

| [ID](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=bug_id%20DESC&query_based_on=) | [Type](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=bug_type%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Summary](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=short_desc%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Product](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=product%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Comp](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=component%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Assignee▲](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=assigned_to%20DESC%2Cbug_status%2Cpriority%2Cbug_id&query_based_on=) | [Status▲](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=bug_status%20DESC%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Resolution](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=resolution%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Updated](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&order=changeddate%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [732870](/show_bug.cgi?id=732870 "RESOLVED FIXED - \"ASSERTION: Weird scope returned\" with document.write twice, dataset, adoptNode") |  | ["ASSERTION: Weird scope returned" with document.write twice, dataset, adoptNode](/show_bug.cgi?id=732870) | Core | XPConnect | bholley | RESO | FIXE | 2012-10-21 |
| [752038](/show_bug.cgi?id=752038 "RESOLVED FIXED - \"ASSERTION: wrapper already in new scope!\" with location.hash, document.open") |  | ["ASSERTION: wrapper already in new scope!" with location.hash, document.open](/show_bug.cgi?id=752038) | Core | XPConnect | bholley | RESO | FIXE | 2012-10-21 |
| [765936](/show_bug.cgi?id=765936 "RESOLVED FIXED - IndexedDB wrapper behavior is still totally broken") |  | [IndexedDB wrapper behavior is still totally broken](/show_bug.cgi?id=765936) | Core | Storage: IndexedDB | khuey | RESO | FIXE | 2012-10-21 |
| [730208](/show_bug.cgi?id=730208 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap") |  | [Hunt down black -> gray edges in the JS heap](/show_bug.cgi?id=730208) | Core | JavaScript Engine | sphink | RESO | FIXE | 2012-10-21 |
| [753162](/show_bug.cgi?id=753162 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified") |  | ["Assertion failure: cx->compartment == this" with document.write during DOMAttrModified](/show_bug.cgi?id=753162) | Core | XPConnect | bholley | VERI | FIXE | 2012-10-21 |
| [748119](/show_bug.cgi?id=748119 "VERIFIED FIXED - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(*thingp)), at jsgc.cpp:4284") |  | [Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(\*thingp)), at jsgc.cpp:4284](/show_bug.cgi?id=748119) | Core | JavaScript Engine | bill.mccloskey | VERI | FIXE | 2013-01-19 |
| [749039](/show_bug.cgi?id=749039 "VERIFIED FIXED - Assertion failure: addr % Cell::CellSize == 0, at ../../jsgc.h:859 or Crash [@ js::gc::Cell::compartment]") |  | [Assertion failure: addr % Cell::CellSize == 0, at ../../jsgc.h:859 or Crash [@ js::gc::Cell::compartment]](/show_bug.cgi?id=749039) | Core | JavaScript Engine | bill.mccloskey | VERI | FIXE | 2013-01-14 |
| [754150](/show_bug.cgi?id=754150 "VERIFIED FIXED - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(thing)), at js/src/jsgc.cpp:4399") |  | [Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(thing)), at js/src/jsgc.cpp:4399](/show_bug.cgi?id=754150) | Core | JavaScript Engine | bill.mccloskey | VERI | FIXE | 2013-01-14 |
| [754242](/show_bug.cgi?id=754242 "VERIFIED FIXED - Assertion failure: incBitmap.isMarked(cell, BLACK), at jsgc.cpp:3125 Crash [@ js::HeapPtr<js::BaseShape, unsigned int>::operator] or Crash [@ getCode]") |  | [Assertion failure: incBitmap.isMarked(cell, BLACK), at jsgc.cpp:3125 Crash [@ js::HeapPtr<js::BaseShape, unsigned int>::operator] or Crash [@ getCode]](/show_bug.cgi?id=754242) | Core | JavaScript Engine | bill.mccloskey | VERI | FIXE | 2013-01-14 |
| [779849](/show_bug.cgi?id=779849 "VERIFIED FIXED - Flash Plugin related Assertion failure: false (compartment mismatched)") |  | [Flash Plugin related Assertion failure: false (compartment mismatched)](/show_bug.cgi?id=779849) | Core Graveyard | Plug-ins | bill.mccloskey | VERI | FIXE | 2022-05-16 |
| [719750](/show_bug.cgi?id=719750 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment") |  | [Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment](/show_bug.cgi?id=719750) | Core | JavaScript Engine | general | VERI | WORK | 2012-10-21 |
| [755916](/show_bug.cgi?id=755916 "VERIFIED FIXED - Assertion failure: enumerators == cx->enumerators,") |  | [Assertion failure: enumerators == cx->enumerators,](/show_bug.cgi?id=755916) | Core | JavaScript Engine | mail | VERI | FIXE | 2012-10-21 |
| [780712](/show_bug.cgi?id=780712 "VERIFIED FIXED - Crash [@ JSC::Yarr::execute] or [@ js::RegExpShared::execute]") |  | [Crash [@ JSC::Yarr::execute] or [@ js::RegExpShared::execute]](/show_bug.cgi?id=780712) | Core | JavaScript Engine | mail | VERI | FIXE | 2013-01-14 |
| [752087](/show_bug.cgi?id=752087 "VERIFIED FIXED - Crash [@ js::GetObjectClass(JSObject const *)] | [@ nsXPConnect::GetNativeOfWrapper]") |  | [Crash [@ js::GetObjectClass(JSObject const \*)] | [@ nsXPConnect::GetNativeOfWrapper]](/show_bug.cgi?id=752087) | Core | Audio/Video | rjesup | VERI | FIXE | 2012-10-21 |

14 bugs found.

|  |  | [REST](/rest/bug?include_fields=id,summary,status&bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936 "Query as a REST API request") | [CSV](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&ctype=csv&human=1) | [Feed](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&title=Bug%20List&ctype=atom) | [iCalendar](/buglist.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&ctype=ics)  [Change Columns](/colchange.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced&query_based_on=) | [Edit Search](/query.cgi?bug_id=719750%2C748119%2C749039%2C754150%2C754242%2C732870%2C752038%2C753162%2C755916%2C780712%2C730208%2C779849%2C752087%2C765936&query_format=advanced) |  | as |
| --- | --- | --- | --- | --- | --- |



=== Content from www.ubuntu.com_fa7e9dcb_20250125_013413.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-1548-1: Firefox vulnerabilities

29 August 2012

Multiple security issues were fixed in Firefox.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 12.04](/security/notices?release=precise)
* [Ubuntu 11.10](/security/notices?release=oneiric)
* [Ubuntu 11.04](/security/notices?release=natty)
* [Ubuntu 10.04](/security/notices?release=lucid)

## Packages

* [firefox](/security/cves?package=firefox) - Mozilla Open Source web browser

## Details

Gary Kwong, Christian Holler, Jesse Ruderman, Steve Fink, Bob Clary, Andrew

Sutherland, Jason Smith, John Schoenick, Vladimir Vukicevic and Daniel

Holbert discovered memory safety issues affecting Firefox. If the user were

tricked into opening a specially crafted page, an attacker could exploit

these to cause a denial of service via application crash, or potentially

execute code with the privileges of the user invoking Firefox.

([CVE-2012-1970](/security/CVE-2012-1970), [CVE-2012-1971](/security/CVE-2012-1971))

Abhishek Arya discovered multiple use-after-free vulnerabilities. If the

user were tricked into opening a specially crafted page, an attacker could

exploit these to cause a denial of service via application crash, or

potentially execute code with the privileges of the user invoking Firefox.

([CVE-2012-1972](/security/CVE-2012-1972), [CVE-2012-1973](/security/CVE-2012-1973), [CVE-2012-1974](/security/CVE-2012-1974), [CVE-2012-1975](/security/CVE-2012-1975), [CVE-2012-1976](/security/CVE-2012-1976),

[CVE-2012-3956](/security/CVE-2012-3956), [CVE-2012-3957](/security/CVE-2012-3957), [CVE-2012-3958](/security/CVE-2012-3958), [CVE-2012-3959](/security/CVE-2012-3959), [CVE-2012-3960](/security/CVE-2012-3960),

[CVE-2012-3961](/security/CVE-2012-3961), [CVE-2012-3962](/security/CVE-2012-3962), [CVE-2012-3963](/security/CVE-2012-3963), [CVE-2012-3964](/security/CVE-2012-3964))

Mariusz Mlynsk discovered that it is possible to shadow the location object

using Object.defineProperty. This could potentially result in a cross-site

scripting (XSS) attack against plugins. With cross-site scripting

vulnerabilities, if a user were tricked into viewing a specially crafted

page, a remote attacker could exploit this to modify the contents or steal

confidential data within the same domain. ([CVE-2012-1956](/security/CVE-2012-1956))

Mariusz Mlynski discovered an escalation of privilege vulnerability through

about:newtab. This could possibly lead to potentially code execution with

the privileges of the user invoking Firefox. ([CVE-2012-3965](/security/CVE-2012-3965))

Frédéric Hoguin discovered that bitmap format images with a negative height

could potentially result in memory corruption. If the user were tricked

into opening a specially crafted image, an attacker could exploit

this to cause a denial of service via application crash, or potentially

execute code with the privileges of the user invoking Firefox.

([CVE-2012-3966](/security/CVE-2012-3966))

It was discovered that Firefox's WebGL implementation was vulnerable to

multiple memory safety issues. If the user were tricked into opening a

specially crafted page, an attacker could exploit these to cause a denial

of service via application crash, or potentially execute code with the

privileges of the user invoking Firefox. ([CVE-2012-3967](/security/CVE-2012-3967), [CVE-2012-3968](/security/CVE-2012-3968))

Arthur Gerkis discovered multiple memory safety issues in Firefox's

Scalable Vector Graphics (SVG) implementation. If the user were tricked

into opening a specially crafted image, an attacker could exploit these to

cause a denial of service via application crash, or potentially execute

code with the privileges of the user invoking Firefox. ([CVE-2012-3969](/security/CVE-2012-3969),

[CVE-2012-3970](/security/CVE-2012-3970))

Christoph Diehl discovered multiple memory safety issues in the bundled

Graphite 2 library. If the user were tricked into opening a specially

crafted page, an attacker could exploit these to cause a denial of service

via application crash, or potentially execute code with the privileges of

the user invoking Firefox. ([CVE-2012-3971](/security/CVE-2012-3971))

Nicolas Grégoire discovered an out-of-bounds read in the format-number

feature of XSLT. This could potentially cause inaccurate formatting of

numbers and information leakage. ([CVE-2012-3972](/security/CVE-2012-3972))

Mark Goodwin discovered that under certain circumstances, Firefox's

developer tools could allow remote debugging even when disabled.

([CVE-2012-3973](/security/CVE-2012-3973))

It was discovered that when the DOMParser is used to parse text/html data

in a Firefox extension, linked resources within this HTML data will be

loaded. If the data being parsed in the extension is untrusted, it could

lead to information leakage and potentially be combined with other attacks

to become exploitable. ([CVE-2012-3975](/security/CVE-2012-3975))

Mark Poticha discovered that under certain circumstances incorrect SSL

certificate information can be displayed on the addressbar, showing the SSL

data for a previous site while another has been loaded. This could

potentially be used for phishing attacks. ([CVE-2012-3976](/security/CVE-2012-3976))

It was discovered that, in some instances, certain security checks in the

location object could be bypassed. This could allow for the loading of

restricted content and can potentially be combined with other issues to

become exploitable. ([CVE-2012-3978](/security/CVE-2012-3978))

Colby Russell discovered that eval in the web console can execute injected

code with chrome privileges, leading to the running of malicious code in a

privileged context. If the user were tricked into opening a specially

crafted page, an attacker could exploit this to cause a denial of service

via application crash, or potentially execute code with the privileges of

the user invoking Firefox. ([CVE-2012-3980](/security/CVE-2012-3980))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 12.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0+build1-0ubuntu0.12.04.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0%2Bbuild1-0ubuntu0.12.04.1)

##### Ubuntu 11.10

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0+build1-0ubuntu0.11.10.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0%2Bbuild1-0ubuntu0.11.10.1)

##### Ubuntu 11.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0+build1-0ubuntu0.11.04.2](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0%2Bbuild1-0ubuntu0.11.04.2)

##### Ubuntu 10.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0+build1-0ubuntu0.10.04.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0%2Bbuild1-0ubuntu0.10.04.1)

After a standard system update you need to restart Firefox to make

all the necessary changes.

## References

* [CVE-2012-1970](/security/CVE-2012-1970)
* [CVE-2012-1971](/security/CVE-2012-1971)
* [CVE-2012-1972](/security/CVE-2012-1972)
* [CVE-2012-1973](/security/CVE-2012-1973)
* [CVE-2012-1974](/security/CVE-2012-1974)
* [CVE-2012-1975](/security/CVE-2012-1975)
* [CVE-2012-1976](/security/CVE-2012-1976)
* [CVE-2012-3956](/security/CVE-2012-3956)
* [CVE-2012-3957](/security/CVE-2012-3957)
* [CVE-2012-3958](/security/CVE-2012-3958)
* [CVE-2012-3959](/security/CVE-2012-3959)
* [CVE-2012-3960](/security/CVE-2012-3960)
* [CVE-2012-3961](/security/CVE-2012-3961)
* [CVE-2012-3962](/security/CVE-2012-3962)
* [CVE-2012-3963](/security/CVE-2012-3963)
* [CVE-2012-3964](/security/CVE-2012-3964)
* [CVE-2012-1956](/security/CVE-2012-1956)
* [CVE-2012-3965](/security/CVE-2012-3965)
* [CVE-2012-3966](/security/CVE-2012-3966)
* [CVE-2012-3967](/security/CVE-2012-3967)
* [CVE-2012-3968](/security/CVE-2012-3968)
* [CVE-2012-3969](/security/CVE-2012-3969)
* [CVE-2012-3970](/security/CVE-2012-3970)
* [CVE-2012-3971](/security/CVE-2012-3971)
* [CVE-2012-3972](/security/CVE-2012-3972)
* [CVE-2012-3973](/security/CVE-2012-3973)
* [CVE-2012-3975](/security/CVE-2012-3975)
* [CVE-2012-3976](/security/CVE-2012-3976)
* [CVE-2012-3978](/security/CVE-2012-3978)
* [CVE-2012-3980](/security/CVE-2012-3980)
* <https://launchpad.net/bugs/1041620>

## Related notices

* [USN-1551-1](/security/notices/USN-1551-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from bugzilla.mozilla.org_15511de5_20250125_013437.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/753162)
* [XML](/show_bug.cgi?ctype=xml&id=753162)

Closed
[Bug 753162](/show_bug.cgi?id=753162)

Opened 13 years ago
Closed 13 years ago

# "Assertion failure: cx->compartment == this" with document.write during DOMAttrModified

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

"Assertion failure: cx->compartment == this" with document.write during DOMAttrModified

## Categories

### (Core :: XPConnect, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=XPConnect#XPConnect)

XPConnect
▾

Core :: XPConnect
Facilitates calling between JavaScript and XPCOM components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=XPConnect)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla16

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | --- | [verified](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=verified) |
| firefox16 | [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=verified) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 |  | verified |
| firefox16 | + | verified |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jruderman, Assigned: bholley)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/ac57223c49d41049a4917e187b854377?d=mm&size=40)  [bholley](/user_profile?user_id=313730)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

![](https://secure.gravatar.com/avatar/eae3698bd33e06ad8fb792ae7c6ffd5d?d=mm&size=40)  [u279076](/user_profile?user_id=279076)

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d2dc9227eafcd0ec5ba3712ee4f19b75?d=mm&size=40)  [jruderman](/user_profile?user_id=11608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/5111b810214a00377104f5ad3efefa26?d=mm&size=40)  [sefeng](/user_profile?user_id=625922)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[343943](/show_bug.cgi?id=343943 "RESOLVED INACTIVE - [meta] HTML Element and Attribute fuzzer"), [cpg](/show_bug.cgi?id=650353 "RESOLVED FIXED - have one global object per compartment")

Dependency [tree](/showdependencytree.cgi?id=753162&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=753162)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-high, testcase, Whiteboard: [sg:high][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:high][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [testcase (asserts fatally when loaded)](/attachment.cgi?id=622181)  [13 years ago](#c0)  [Jesse Ruderman](/user_profile?user_id=11608)   516 bytes, text/html |  | [Details](/attachment.cgi?id=622181&action=edit) |
| --- | --- | --- |
| [stack traces](/attachment.cgi?id=622182)  [13 years ago](#c1)  [Jesse Ruderman](/user_profile?user_id=11608)   33.52 KB, text/plain |  | [Details](/attachment.cgi?id=622182&action=edit) |
| [Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1](/attachment.cgi?id=634862)  [13 years ago](#c4)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   9.57 KB, patch | mrbkap : [review+](#c6 "13 years ago")  akeybl : [approval-mozilla-aurora+](#c15 "13 years ago") | [Details](/attachment.cgi?id=634862&action=edit) | [Diff](/attachment.cgi?id=634862&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=753162&attachment=634862) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=753162#c0)• 13 years ago |
|  | |

Attached file
[testcase (asserts fatally when loaded)](attachment.cgi?id=622181)
— [Details](attachment.cgi?id=622181&action=edit)

During DOMAttrModified:
###!!! ASSERTION: nsHTMLDocument::Reset() - Wyciwyg Channel still exists!: '!mWyciwygChannel', file content/html/document/src/nsHTMLDocument.cpp, line 329
(That first assertion might be [bug 675518](/show_bug.cgi?id=675518 "RESOLVED WORKSFORME - \"ASSERTION:nsHTMLDocument::Reset() - Wyciwyg Channel still exists!\"") or [bug 680086](/show_bug.cgi?id=680086 "RESOLVED FIXED - \"ASSERTION: nsHTMLDocument::StopDocumentLoad(): Trying to remove nonexistent wyciwyg channel!\"").)
After DOMAttrModified:
Assertion failure: cx->compartment == this, at js/src/jscompartment.cpp:124

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=753162#c1)• 13 years ago |
|  | |

Attached file
[stack traces](attachment.cgi?id=622182)
— [Details](attachment.cgi?id=622182&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=753162#c2)• 13 years ago |
|  | |

CC'ing moz\_bug\_r\_a4 in case this compartment confusion leads to interesting discoveries.Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)Whiteboard: [sg:high]

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=753162#c3)• 13 years ago |
|  | |

Ok, the basic problem here is that the code in CrossCompartmentWrapper::call is assuming that the AutoCompartment restored cx->compartment to the same compartment it had when enter() was called, which isn't necessarily the case. Specifically, the function being call()-ed ends up calling document.write, which triggers a call to SetOuterObject on the outer window. This changes cx->globalObject, and so the resetCompartment() that happens in AutoCompartment::leave() sets cx->compartment to the new scope.
The fix is to just wrap with cx->compartment. Patch coming up.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=753162#c4)• 13 years ago |
|  | |

Attached patch

[Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1](attachment.cgi?id=634862&action=diff)
— [Details](attachment.cgi?id=634862&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=753162&attachment=634862)

Attaching a patch, flagging blake for review.
[Attachment #634862](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") -
Flags: review?(mrbkap)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=753162#c5)• 13 years ago |
|  | |

Gave this a try push: <https://tbpl.mozilla.org/?tree=Try&rev=704b40375e24>

|  | [Blake Kaplan (:mrbkap) (inactive)](/user_profile?user_id=69426) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=753162#c6)• 13 years ago |
|  | |

Comment on [attachment 634862](/attachment.cgi?id=634862 "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[details]](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[diff]](/attachment.cgi?id=634862&action=diff "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=753162&attachment=634862)
Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1
IIRC, this has been a longstanding concern... it's always been odd that if I have:
JSAutoRequest ac; ac.enter(cx, compartmentA);
after a call, cx->compartment might not be compartmentA. Will this get better when we remove fake stack frames?
I'm fine with this fix, since it doesn't make anything worse, though.
[Attachment #634862](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") -
Flags: review?(mrbkap) → review+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=753162#c7)• 13 years ago |
|  | |

(In reply to Blake Kaplan (:mrbkap) from [comment #6](/show_bug.cgi?id=753162#c6 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified"))
> Will this get better when we remove fake stack frames?
I don't think so. The fundamental issue is that the document moves compartments during the course of the call. There are two invariants that would be nice:
1 - If we enter from compartment A, we leave in compartment A
2 - If we enter in the compartment of document D, we leave in the compartment of document D
AFAICT we can only guarantee one of them. Though I wonder what will happen when cx->globalObject goes away like I've been hearing it will. Will there be a cx->defaultCompartment?
pushed to m-i: <http://hg.mozilla.org/integration/mozilla-inbound/rev/eca1167488ca>Assignee: nobody → bobbyholley+bmo

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=753162#c8)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/eca1167488ca>Status: NEW → RESOLVEDClosed: 13 years ago
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla16

|  | [Blake Kaplan (:mrbkap) (inactive)](/user_profile?user_id=69426) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=753162#c9)• 13 years ago |
|  | |

(In reply to Bobby Holley (:bholley) from [comment #7](/show_bug.cgi?id=753162#c7 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified"))
> 1 - If we enter from compartment A, we leave in compartment A
> 2 - If we enter in the compartment of document D, we leave in the
> compartment of document D
>
> AFAICT we can only guarantee one of them.
Right. The problem is that right now we have a mix of the two options based on whether or not entering the compartment was a no-op or not and whether there were already stack frames on the context. I think that, in general, option 1 is more important since any code that enters compartment A will still only have objects from compartment A lying around (even if they've been brain transplanted), but all this belongs in some other bug, I suppose.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=753162#c10)• 13 years ago |
|  | |

Is this fallout from cpg or does it affect earlier builds as well?

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=753162#c11)• 13 years ago |
|  | |

(In reply to Daniel Veditz [:dveditz] from [comment #10](/show_bug.cgi?id=753162#c10 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified"))
> Is this fallout from cpg or does it affect earlier builds as well?
The former, I think.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=753162#c12)• 13 years ago |
|  | |

Should we land this in Aurora then?Blocks: [cpg](/show_bug.cgi?id=650353 "RESOLVED FIXED - have one global object per compartment")
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox16](/buglist.cgi?f1=cf_tracking_firefox16&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=753162#a3867631_1689)• 13 years ago |

[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%3F)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=753162#c13)• 13 years ago |
|  | |

(In reply to Daniel Veditz [:dveditz] from [comment #12](/show_bug.cgi?id=753162#c12 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified"))
> Should we land this in Aurora then?
Yes, probably.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=753162#c14)• 13 years ago |
|  | |

Comment on [attachment 634862](/attachment.cgi?id=634862 "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[details]](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[diff]](/attachment.cgi?id=634862&action=diff "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=753162&attachment=634862)
Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1
Nominating per [comment 12](/show_bug.cgi?id=753162#c12 "VERIFIED FIXED - \"Assertion failure: cx->compartment == this\" with document.write during DOMAttrModified").
[Approval Request Comment]
Bug caused by (feature/regressing bug #): [bug 650353](/show_bug.cgi?id=650353 "RESOLVED FIXED - have one global object per compartment")
User impact if declined: Potential security vulnerabilities.
Testing completed (on m-c, etc.): Baking on m-c.
Risk to taking this patch (and alternatives if risky): Not risky.
String or UUID changes made by this patch: None.
[Attachment #634862](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") -
Flags: approval-mozilla-aurora?

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=753162#c15)• 13 years ago |
|  | |

Comment on [attachment 634862](/attachment.cgi?id=634862 "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[details]](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[diff]](/attachment.cgi?id=634862&action=diff "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=753162&attachment=634862)
Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1
[Triage Comment]
Low risk sg:crit fix. Approved for Aurora 15.
[Attachment #634862](/attachment.cgi?id=634862&action=edit "Don't assume that we end up in the same compartment as we started in CrossCompartmentWrapper. v1") -
Flags: approval-mozilla-aurora? → approval-mozilla-aurora+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=753162#c16)• 13 years ago |
|  | |

Pushed to m-a: <http://hg.mozilla.org/releases/mozilla-aurora/rev/8859b02413f4>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%3F) → ---

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=753162#a7869308_280903)• 12 years ago |

Whiteboard: [sg:high] → [sg:high][advisory-tracking+]

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=753162#a8557807_279076)• 12 years ago |

Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=753162#c17)• 12 years ago |
|  | |

Confirmed testcase crashes/asserts 2012-05-08 Firefox 15.0a1 Nightly Debug.
Does not crash:
2012-06-22 Firefox 16.0a1 Nightly Debug
2012-06-26 Firefox 15.0a2 Aurora DebugStatus: RESOLVED → VERIFIED
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=verified)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=verified)Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)QA Contact: anthony.s.hughes

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=753162#a14365629_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=753162&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jesse Ruderman](/user_profile?user_id=11608)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_310aa3ee_20250125_013429.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/749039)
* [XML](/show_bug.cgi?ctype=xml&id=749039)

Closed
[Bug 749039](/show_bug.cgi?id=749039)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: addr % Cell::CellSize == 0, at ../../jsgc.h:859 or Crash [@ js::gc::Cell::compartment]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: addr % Cell::CellSize == 0, at ../../jsgc.h:859 or Crash [@ js::gc::Cell::compartment]

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Accessibility Severity | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox12 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=unaffected) |
| firefox13 | [-](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=-) | [affected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=affected) |
| firefox14 | [-](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=-) | [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) |
| firefox15 | [-](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=-) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox12 |  | unaffected |
| firefox13 | - | affected |
| firefox14 | - | affected |
| firefox15 | - | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: billm)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/81db2831554209472ec9b0d5485ca1c9?d=mm&size=40)  [billm](/user_profile?user_id=389993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

8 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[723313](/show_bug.cgi?id=723313 "RESOLVED FIXED - Stop using conservative stack scanner for VM stack marking")

Dependency [tree](/showdependencytree.cgi?id=749039&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=749039)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [sg:critical] js-triage-needed[advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical] js-triage-needed[advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [decoder](/user_profile?user_id=395101) | [in-testsuite](#c9 "12 years ago") | + |
| --- | --- | --- |
| [decoder](/user_profile?user_id=395101) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::gc::Cell::compartment ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3Agc%3A%3ACell%3A%3Acompartment)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [patch](/attachment.cgi?id=620419)  [13 years ago](#c3)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   4.54 KB, patch | bhackett1024 : [review+](#a666007_346231 "13 years ago") | [Details](/attachment.cgi?id=620419&action=edit) | [Diff](/attachment.cgi?id=620419&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=749039&attachment=620419) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=749039#c0)• 13 years ago |
|  | |

The following test asserts/crashes on mozilla-central revision 75c7378c87b6 (options -m -n -a):
gczeal(4);
try { jsTestDriverEnd(); } catch(exc1) {}
evaluate("\
schedulegc(10);\
for(var i=0; i<3; i++) {\
var obj = { first: 'first', second: 'second' };\
for (var elem in obj) {}\
x.push(count);\
}\
");
Backtrace in debug build after stepping through assertion:
Program received signal SIGSEGV, Segmentation fault.
0x0804c7cd in js::gc::Cell::compartment (this=0xdadadada) at ../../jsgc.h:984
984 return arenaHeader()->compartment;
(gdb) bt 8
#0 0x0804c7cd in js::gc::Cell::compartment (this=0xdadadada) at ../../jsgc.h:984
#1 0x0811e8f5 in js::gc::CheckMarkedThing<js::types::TypeObject> (trc=0x85fe540, thing=0xdadadada) at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:80
#2 0x0811c888 in js::gc::MarkInternal<js::types::TypeObject> (trc=0x85fe540, thingp=0xf750af24) at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:102
#3 0x0811bf41 in js::gc::Mark<js::types::TypeObject> (trc=0x85fe540, thing=0xf750af24, name=0x845dbdc "type") at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:141
#4 0x08117074 in js::gc::MarkTypeObject (trc=0x85fe540, thing=0xf750af24, name=0x845dbdc "type") at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:217
#5 0x0828cf0d in js::ObjectImpl::markChildren (this=0xf750af20, trc=0x85fe540) at /srv/repos/mozilla-central/js/src/vm/ObjectImpl.cpp:157
#6 0x081189db in js::gc::MarkChildren (trc=0x85fe540, obj=0xf750af20) at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:675
#7 0x08119fa2 in js::TraceChildren (trc=0x85fe540, thing=0xf750af20, kind=JSTRACE\_OBJECT) at /srv/repos/mozilla-central/js/src/jsgcmark.cpp:1160
(More stack frames follow...)
(gdb) x /i $pc
=> 0x804c7cd <js::gc::Cell::compartment() const+17>: mov (%eax),%eax
(gdb) info reg eax
eax 0xdadad000 -623194112
Assuming s-s and sg:critical due to use-after-free condition.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=749039#c1)• 13 years ago |
|  | |

Does this affect ESR-10 or Firefox 12?
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=749039#c2)• 13 years ago |
|  | |

I'm quite sure this is Linux-only.
autoBisect shows this is probably related to the following changeset:
The first bad revision is:
changeset: 86651:dc0f6ad7eff3
user: Bill McCloskey
date: Fri Feb 10 18:32:08 2012 -0800
summary: [Bug 723313](/show_bug.cgi?id=723313 "RESOLVED FIXED - Stop using conservative stack scanner for VM stack marking") - Stop using conservative stack scanner for VM stack marking (r=luke,bhackett)
Marking flags based on regression window.Blocks: [723313](/show_bug.cgi?id=723313 "RESOLVED FIXED - Stop using conservative stack scanner for VM stack marking")
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox12](/buglist.cgi?f1=cf_status_firefox12&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=unaffected)
[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=affected)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[tracking-firefox13](/buglist.cgi?f1=cf_tracking_firefox13&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%3F)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%3F)

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a413002_294323)• 13 years ago |

[tracking-firefox13](/buglist.cgi?f1=cf_tracking_firefox13&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%2B)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=749039#c3)• 13 years ago |
|  | |

Attached patch

[patch](attachment.cgi?id=620419&action=diff)
— [Details](attachment.cgi?id=620419&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=749039&attachment=620419)

Here's what seems to be happening. We partially execute a function in the interpreter, and then we enter the methodjit at a loop edge. At this point, the stack pointer has some value, say sp\_loop. We finish executing the method in the methodjit. Inside the methodjit, the stack pointer decreases to some other value, sp\_base. At that point we GC and the pointers in between sp\_base and sp\_loop are not marked.
We return to the methodjit and end up throwing in the middle of an op (I think GETGNAME). We then return to the interpreter. When we do so, we repoint the registers to their old location, which still has sp = sp\_loop. Then we return to the interpreter, which quickly exits. Upon exiting from the interpreter, we call the write barrier verifier. It tries to trace through one of the pointers between sp\_base and sp\_loop (which it thinks is the correct stack pointer) and dies.
This patch is from Luke. It tries to ensure that all the FrameRegs are correct on all paths that exit the methodjit. I'm not entirely sure if there's a real, exploitable problem here. If we hadn't invoked the write barrier verifier, then we would have popped the regs eventually and everything would have been fine. However, it looks like we don't pop the regs on some return paths, so maybe that's unsafe. I don't know this code well at all.Assignee: general → wmccloskeyStatus: NEW → ASSIGNED
[Attachment #620419](/attachment.cgi?id=620419&action=edit "patch") -
Flags: review?(bhackett1024)

|  | [Curtis Koenig [:curtisk-use curtis.koenig+bzATgmail.com]]](/user_profile?user_id=406847) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a658933_406847)• 13 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a666007_346231)• 13 years ago |

[Attachment #620419](/attachment.cgi?id=620419&action=edit "patch") -
Flags: review?(bhackett1024) → review+

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=749039#c4)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/0e883cf61970>Target Milestone: --- → mozilla15

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=749039#c5)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/0e883cf61970>Status: ASSIGNED → RESOLVEDClosed: 13 years agoResolution: --- → FIXED

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=749039#c6)• 13 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a1040299_395101)• 13 years ago |

Status: RESOLVED → VERIFIED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=749039#c7)• 13 years ago |
|  | |

Will this patch apply as-is to beta, aurora, and ESR, or will you need a new patch? Please request branch approvals when this is ready to go in.
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=749039#c8)• 13 years ago |
|  | |

This only seems to affect the barrier verifier, so it's debug-only. We don't need the fix on branches.Group: core-security

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a1812317_425645)• 13 years ago |

[tracking-firefox13](/buglist.cgi?f1=cf_tracking_firefox13&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%2B) → [-](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=-)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) → [-](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=-)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) → [-](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=-)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=749039#a8984653_280903)• 12 years ago |

Whiteboard: [sg:critical] js-triage-needed → [sg:critical] js-triage-needed[advisory-tracking+]

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=749039#c9)• 12 years ago |
|  | |

A testcase for this bug was automatically identified at js/src/jit-test/tests/basic/[bug749039](/show_bug.cgi?id=749039 "VERIFIED FIXED - Assertion failure: addr % Cell::CellSize == 0, at ../../jsgc.h:859 or Crash [@ js::gc::Cell::compartment]").js.Flags: in-testsuite+
You need to [log in](/show_bug.cgi?id=749039&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_3c68b673_20250125_013449.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/773097)
* [XML](/show_bug.cgi?ctype=xml&id=773097)

Closed
[Bug 773097](/show_bug.cgi?id=773097)

Opened 13 years ago
Closed 12 years ago

# crash in gfxContext::~gfxContext()

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

crash in gfxContext::~gfxContext()

## Categories

### (Core :: Graphics, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics#Graphics)

Graphics
▾

Core :: Graphics
Mapping of cross platform rendering interfaces to various 2D graphics APIs
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Windows XP

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla17

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox16 | [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) |
| firefox17 | [+](/buglist.cgi?f1=cf_tracking_firefox17&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed) |
| firefox-esr10 | [15+](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=15%2B) | [fixed](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | + | affected |
| firefox15 | + | fixed |
| firefox16 | + | fixed |
| firefox17 | + | fixed |
| firefox-esr10 | 15+ | fixed |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jsmith, Assigned: joe)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/7a41e6ee07ffb6fa8873f73b962603fd?d=mm&size=40)  [joe](/user_profile?user_id=94)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

![](https://secure.gravatar.com/avatar/cf7a6485ad75c35d66da0af6c88515d5?d=mm&size=40)  [marcia](/user_profile?user_id=8519)

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/fba16ea71cd5ef27991fcea651e8cd56?d=mm&size=40)  [jsmith](/user_profile?user_id=432443)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/17436ade8da1b23d42b3df05b9c4fc77?d=mm&size=40)  [bhood](/user_profile?user_id=697075)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

35 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[787623](/show_bug.cgi?id=787623 "VERIFIED FIXED - mousemove event fails to draw content on canvas"), [787892](/show_bug.cgi?id=787892 "RESOLVED DUPLICATE - Huge slowdown in canvas demo from Ionmonkey landing")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[591358](/show_bug.cgi?id=591358 "RESOLVED FIXED - Crash [@ mozilla::layers::BasicLayerManager::PushGroupWithCachedSurface(gfxContext*, gfxASurface::gfxContentType, gfxPoint*) ]"), [704762](/show_bug.cgi?id=704762 "RESOLVED WORKSFORME - Startup crash in mozilla::layers::SwapChainD3D9::PrepareForRendering")

Dependency [tree](/showdependencytree.cgi?id=773097&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=773097)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy"), [780904](/show_bug.cgi?id=780904 "RESOLVED DUPLICATE - crash in mozilla::RefCounted")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: crash, sec-high, topcrash, Whiteboard: [startupcrash][advisory-tracking+] [qa?])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[topcrash](/buglist.cgi?keywords=topcrash&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[startupcrash][advisory-tracking+] [qa?]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

1

Bug Flags:

| [djcater+bugzilla](/user_profile?user_id=185959) | [in-testsuite](#c58 "12 years ago") | ? |
| --- | --- | --- |
| [djcater+bugzilla](/user_profile?user_id=185959) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ gfxContext::~gfxContext() ]](https://crash-stats.mozilla.org/signature/?signature=gfxContext%3A%3A~gfxContext%28%29)

[[@ \_moz\_cairo\_destroy ]](https://crash-stats.mozilla.org/signature/?signature=_moz_cairo_destroy)

[[@ moz\_cairo\_destroy ]](https://crash-stats.mozilla.org/signature/?signature=moz_cairo_destroy)

[[@ \_moz\_cairo\_surface\_get\_reference\_count ]](https://crash-stats.mozilla.org/signature/?signature=_moz_cairo_surface_get_reference_count)

[[@ \_cairo\_gstate\_restore ]](https://crash-stats.mozilla.org/signature/?signature=_cairo_gstate_restore)

[[@ gfxASurface::Release() ]](https://crash-stats.mozilla.org/signature/?signature=gfxASurface%3A%3ARelease%28%29)

[[@ je\_free | mozilla::`anonymous namespace''::ContainerState::FindThebesLayerFor(nsDisplayItem\*, nsIntRect const&, nsIntRect const&, mozilla::FrameLayerBuilder::Clip const&, nsIFrame\*) ]](https://crash-stats.mozilla.org/signature/?signature=je_free%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AFindThebesLayerFor%28nsDisplayItem%2A%2C%20nsIntRect%20const%26%2C%20nsIntRect%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%20const%26%2C%20nsIFrame%2A%29)

[[@ mozilla::FrameLayerBuilder::BuildContainerLayerFor(nsDisplayListBuilder\*, mozilla::layers::LayerManager\*, nsIFrame\*, nsDisplayItem\*, nsDisplayList const&, mozilla::FrameLayerBuilder::ContainerParameters const&, gfx3DMatrix const\*) ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3AFrameLayerBuilder%3A%3ABuildContainerLayerFor%28nsDisplayListBuilder%2A%2C%20mozilla%3A%3Alayers%3A%3ALayerManager%2A%2C%20nsIFrame%2A%2C%20nsDisplayItem%2A%2C%20nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AContainerParameters%20const%26%2C%20gfx3DMatrix%20const%2A%29)

[[@ nsTArray<nsGenericHTMLFormElement\*, nsTArrayDefaultAllocator>::Clear() | nsTArray<nsCSSStyleSheet\*, nsTArrayDefaultAllocator>::~nsTArray<nsCSSStyleSheet\*, nsTArrayDefaultAllocator>() | gfxContext::AzureState::~AzureState() ]](https://crash-stats.mozilla.org/signature/?signature=nsTArray%3CnsGenericHTMLFormElement%2A%2C%20nsTArrayDefaultAllocator%3E%3A%3AClear%28%29%20%7C%20nsTArray%3CnsCSSStyleSheet%2A%2C%20nsTArrayDefaultAllocator%3E%3A%3A~nsTArray%3CnsCSSStyleSheet%2A%2C%20nsTArrayDefaultAllocator%3E%28%29%20%7C%20gfxContext%3A%3AAzureState%3A%3A~AzureState%28%29)

[[@ nsTArray<PtrInfo\*, nsTArrayDefaultAllocator>::Clear() | nsTArray<float, nsTArrayDefaultAllocator>::~nsTArray<float, nsTArrayDefaultAllocator>() | gfxContext::AzureState::~AzureState() ]](https://crash-stats.mozilla.org/signature/?signature=nsTArray%3CPtrInfo%2A%2C%20nsTArrayDefaultAllocator%3E%3A%3AClear%28%29%20%7C%20nsTArray%3Cfloat%2C%20nsTArrayDefaultAllocator%3E%3A%3A~nsTArray%3Cfloat%2C%20nsTArrayDefaultAllocator%3E%28%29%20%7C%20gfxContext%3A%3AAzureState%3A%3A~AzureState%28%29)

[[@ mozilla::RefCounted<mozilla::gfx::ScaledFont>::Release() ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3ARefCounted%3Cmozilla%3A%3Agfx%3A%3AScaledFont%3E%3A%3ARelease%28%29)

[[@ PL\_DHashTableOperate | mozilla::`anonymous namespace''::ContainerState::ProcessDisplayItems(nsDisplayList const&, mozilla::FrameLayerBuilder::Clip&, unsigned int) ]](https://crash-stats.mozilla.org/signature/?signature=PL_DHashTableOperate%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AProcessDisplayItems%28nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%26%2C%20unsigned%20int%29)

[[@ PL\_DHashTableOperate | mozilla::`anonymous namespace''::ContainerState::ProcessDisplayItems(nsDisplayList const&, mozilla::FrameLayerBuilder::Clip&) ]](https://crash-stats.mozilla.org/signature/?signature=PL_DHashTableOperate%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AProcessDisplayItems%28nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%26%29)

[[@ PL\_DHashTableOperate | nsTHashtable<mozilla::FrameLayerBuilder::ThebesLayerItemsEntry>::PutEntry(mozilla::layers::ThebesLayer\*) ]](https://crash-stats.mozilla.org/signature/?signature=PL_DHashTableOperate%20%7C%20nsTHashtable%3Cmozilla%3A%3AFrameLayerBuilder%3A%3AThebesLayerItemsEntry%3E%3A%3APutEntry%28mozilla%3A%3Alayers%3A%3AThebesLayer%2A%29)

[[@ nsTArray\_base<nsTArrayDefaultAllocator>::SwapArrayElements<nsTArrayDefaultAllocator>(nsTArray\_base<nsTArrayDefaultAllocator>&, unsigned int, unsigned int) | nsTHashtable<mozilla::FrameLayerBuilder::DisplayItemDataEntry>::s\_CopyEntry(PLDHashTable\*, PLDH... ]](https://crash-stats.mozilla.org/signature/?signature=nsTArray_base%3CnsTArrayDefaultAllocator%3E%3A%3ASwapArrayElements%3CnsTArrayDefaultAllocator%3E%28nsTArray_base%3CnsTArrayDefaultAllocator%3E%26%2C%20unsigned%20int%2C%20unsigned%20int%29%20%7C%20nsTHashtable%3Cmozilla%3A%3AFrameLayerBuilder%3A%3ADisplayItemDataEntry%3E%3A%3As_CopyEntry%28PLDHashTable%2A%2C%20PLDH...)

[[@ mozilla::FrameLayerBuilder::GetLeafLayerFor(nsDisplayListBuilder\*, mozilla::layers::LayerManager\*, nsDisplayItem\*) ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3AFrameLayerBuilder%3A%3AGetLeafLayerFor%28nsDisplayListBuilder%2A%2C%20mozilla%3A%3Alayers%3A%3ALayerManager%2A%2C%20nsDisplayItem%2A%29)

[[@ @0x0 | PL\_DHashTableOperate | mozilla::`anonymous namespace''::ContainerState::ProcessDisplayItems(nsDisplayList const&, mozilla::FrameLayerBuilder::Clip&, unsigned int) ]](https://crash-stats.mozilla.org/signature/?signature=%400x0%20%7C%20PL_DHashTableOperate%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AProcessDisplayItems%28nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%26%2C%20unsigned%20int%29)

[[@ je\_free | ChangeTable ]](https://crash-stats.mozilla.org/signature/?signature=je_free%20%7C%20ChangeTable)

[[@ mozilla::RefCounted<mozilla::gfx::DrawTarget>::Release() ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3ARefCounted%3Cmozilla%3A%3Agfx%3A%3ADrawTarget%3E%3A%3ARelease%28%29)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files)

| [about supoort from machine](/attachment.cgi?id=650404)  [12 years ago](#c24)  [Marcia Knous [:marcia]](/user_profile?user_id=8519)   3.34 KB, text/plain |  | [Details](/attachment.cgi?id=650404&action=edit) |
| --- | --- | --- |
| [Testcase](/attachment.cgi?id=650485)  [12 years ago](#c32)  [Daniel C](/user_profile?user_id=185959)   376 bytes, text/html |  | [Details](/attachment.cgi?id=650485&action=edit) |
| [don't create the surface from GetCanvasLayer](/attachment.cgi?id=650708)  [12 years ago](#c45)  [Joe Drew (not getting mail)](/user_profile?user_id=94)   1.19 KB, patch | roc : [review+](#c50 "12 years ago")  mattwoodrow : [review+](#a2515963_380838 "12 years ago")  lsblakk : [approval-mozilla-aurora+](#c67 "12 years ago")  lsblakk : [approval-mozilla-beta+](#c67 "12 years ago")  lsblakk : [approval-mozilla-esr10+](#c67 "12 years ago") | [Details](/attachment.cgi?id=650708&action=edit) | [Diff](/attachment.cgi?id=650708&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708) |
| [somewhat ineffective test](/attachment.cgi?id=650998)  [12 years ago](#c63)  [Joe Drew (not getting mail)](/user_profile?user_id=94)   2.39 KB, patch | ehsan.akhgari : [review+](#a2583113_251051 "12 years ago") | [Details](/attachment.cgi?id=650998&action=edit) | [Diff](/attachment.cgi?id=650998&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650998) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jason Smith [:jsmith]](/user_profile?user_id=432443)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=773097#c0)• 13 years ago |
|  | |

This bug was filed from the Socorro interface and is
report [bp-0101e134-9558-4f01-97f2-18c332120710](https://crash-stats.mozilla.org/report/index/0101e134-9558-4f01-97f2-18c332120710) .
=============================================================
Found when looking at crash stats for the webapp runtime. Don't have reproduction steps for this.

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a28280_386758)• 13 years ago |

Whiteboard: [startupcrash]

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=773097#c1)• 13 years ago |
|  | |

Frame Module Signature Source
0 xul.dll gfxContext::~gfxContext gfx/thebes/gfxContext.cpp:121
1 xul.dll gfxContext::`scalar deleting destructor'
2 xul.dll nsWindow::OnPaint widget/windows/nsWindowGfx.cpp:427
3 xul.dll nsWindow::ProcessMessage widget/windows/nsWindow.cpp:4738
4 xul.dll nsCOMPtr\_base::assign\_from\_qi obj-firefox/xpcom/build/nsCOMPtr.cpp:58
5 xul.dll CallWindowProcCrashProtected xpcom/base/nsCrashOnException.cpp:32
6 xul.dll nsWindow::WindowProc widget/windows/nsWindow.cpp:4267
7 xul.dll CallWindowProcCrashProtected xpcom/base/nsCrashOnException.cpp:38
8 user32.dll StringDuplicateW

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=773097#c2)• 12 years ago |
|  | |

It's #9 top browser crasher in 14.0.1, #5 in 15.0b3, #8 in 16.0a2 and #54 in 17.0a1.
This spike is likely related to the one of [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy").
Here are correlations per module:
gfxContext::~gfxContext()|EXCEPTION\_ACCESS\_VIOLATION\_READ (10195 crashes)
100% (10193/10195) vs. 37% (95988/258368) d3d9.dll
100% (10173/10195) vs. 37% (95823/258368) d3d8thk.dllKeywords: [topcrash](/buglist.cgi?keywords=topcrash&resolution=---)OS: Windows NT → Windows XPSee Also: → [734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy")

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2291024_386758)• 12 years ago |

Keywords: [needURLs](/buglist.cgi?keywords=needURLs&resolution=---)

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=773097#c3)• 12 years ago |
|  | |

The signature in this bug, the one in [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy"), as well as some other gfx-related ones have been radically exploding in yesterday's data (2012-08-06), see <https://crash-analysis.mozilla.com/rkaiser/2012-08-06/2012-08-06.firefox.14.explosiveness.html>

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=773097#c4)• 12 years ago |
|  | |

Top 10 URLs:
331 <http://www.google.com.tr/>
243 <http://www.google.de/>
201 about:blank
188 <http://www.google.co.id/>
173 <http://www.google.fr/>
143 <http://www.google.com.au/>
120 <http://www.google.pl/>
112 <http://www.google.es/>
112 <http://www.google.com.vn/>
100 <http://www.google.co.th/>
This is followed by a long list of other Google URLs. Is there some Google Doodle today or yesterday that could be causing this?

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2296679_5189)• 12 years ago |

Keywords: [needURLs](/buglist.cgi?keywords=needURLs&resolution=---)

|  | [bloodflash](/user_profile?user_id=324467) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=773097#c5)• 12 years ago |
|  | |

@Robert Kaiser:
My reply to this Bug is here:
[https://bugzilla.mozilla.org/show\_bug.cgi?id=734921#c10](/show_bug.cgi?id=734921#c10 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy")

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=773097#c6)• 12 years ago |
|  | |

I can reproduce this on an Intel Integrated Windows 7 machine here with D3D9 layers turned on, but only on Aurora and Beta (not Nightly). I'm going to bisect now.Assignee: nobody → joe

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=773097#c7)• 12 years ago |
|  | |

Note: you frequently need to clear the cache in order for this to reliably crash.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=773097#c8)• 12 years ago |
|  | |

Joe, FYI, marcia says in [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy") that there's trunk signatures fitting the same kind of case. Still, having something reproducible is already a good step. :)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=773097#c9)• 12 years ago |
|  | |

This is fixed by turning on the Azure canvas implementation by default on Windows (i.e., [bug 773460](/show_bug.cgi?id=773460 "RESOLVED FIXED - [Azure] pref on Azure canvas")). Unfortunately, fixing it properly requires me to work out the difference between how Azure's canvas works and how the Thebes canvas works.

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=773097#c10)• 12 years ago |
|  | |

Joe, are you able to reproduce the issue with older Google doodles? Ones you can try:
<http://www.google.com/logos/bunsen.html>
<http://www.google.com/logos/2011/calder11.html>
Thanks,
Mike

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=773097#c11)• 12 years ago |
|  | |

Nope, neither of these crash for me. What's more, I find it harder to reliably crash using <http://www.google.com/doodles/hurdles-2012> too; <http://www.google.com> seems to be the easiest and most reliable crashing URL for me.

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=773097#c12)• 12 years ago |
|  | |

Does it crash more reliably if you use: <http://www.google.com/logos/2012/hurdles-2012-hp.html>
That URL has the doodle, without the surrounding gallery elements.
Not sure if this helps with debugging, but the older doodles used setTimeout, whereas the sports games use requestAnimationFrame if it's available.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=773097#c13)• 12 years ago |
|  | |

Those crashes are literally killing us. In yesterday's data, this signature has slightly over 10% of all 14.0.1 crashes and is #2 while [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy") has over 50% of all crashes and is #1. This doodle made our crash rates increase by a factor of ~2.5 or so.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=773097#c14)• 12 years ago |
|  | |

FWIW, since the hurdles doodle is no longer on Google's homepage, this crash should jump way down in today's stats.

|  | [Daniel C](/user_profile?user_id=185959) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=773097#c15)• 12 years ago |
|  | |

(In reply to Joe Drew (:JOEDREW!) from [comment #14](/show_bug.cgi?id=773097#c14 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> FWIW, since the hurdles doodle is no longer on Google's homepage, this crash
> should jump way down in today's stats.
I've seen this crash on today's basketball doodle as well so I don't think that will be the case. I expect there will also be similar game-type doodles from now until Sunday and given that the first 2 cause crashes, there's a high chance that the others will too.

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=773097#c16)• 12 years ago |
|  | |

Just a few questions:
\* Is the crash rate info (browser version, number of crashes, URL before crash) publicly available?
\* When will we know if today's basketball doodle is causing as many crashes as yesterday's hurdles doodle?
\* What is the raw number (and/or what is the %) of all Firefox browsers that we estimate have crashed, both due to the hurdles doodle and the basketball doodle?

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=773097#c17)• 12 years ago |
|  | |

(In reply to Mike Graboski from [comment #16](/show_bug.cgi?id=773097#c16 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> \* Is the crash rate info (browser version, number of crashes, URL before
> crash) publicly available?
Except URLs, they are available:
<https://crash-stats.mozilla.com/report/list?signature=gfxContext%3A%3A~gfxContext%28%29>
> \* When will we know if today's basketball doodle is causing as many crashes
> as yesterday's hurdles doodle?
There are crashes on August 8.
> \* What is the raw number (and/or what is the %) of all Firefox browsers
> that we estimate have crashed, both due to the hurdles doodle and the
> basketball doodle?
See [comment 13](/show_bug.cgi?id=773097#c13 "RESOLVED FIXED - crash in gfxContext::~gfxContext()").

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=773097#c18)• 12 years ago |
|  | |

(In reply to Mike Graboski from [comment #16](/show_bug.cgi?id=773097#c16 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> \* Is the crash rate info (browser version, number of crashes, URL before
> crash) publicly available?
As Scoobidiver has pointed out, version, number, etc. are available on crash-stats. URLs are only internal as they often can contain privacy-related information (and even plaintext passwords at times).
> \* When will we know if today's basketball doodle is causing as many crashes
> as yesterday's hurdles doodle?
We're only doing daily aggregations, so we'll know exact numbers tomorrow, but crash-stats allows us to do advanced do searches over hours to get some feel.
> \* What is the raw number (and/or what is the %) of all Firefox browsers
> that we estimate have crashed, both due to the hurdles doodle and the
> basketball doodle?
We don't have unique IDs per installation/user for privacy reasons, so we can't tell for sure. What we know is that yesterday we had a rise of our crash rates for 14.0.1 by ~3 crashes per 100 active daily installations, we can attribute those entirely to those signatures with the doodle, mainly [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy") and this one, and that's quite significant. Graphs of this are at the crash-stats front page: <https://crash-stats.mozilla.com/products/Firefox>
For the current release, i.e. 14.0.1, this was 2.5 million crashes at a throttle rate of 10%, i.e. 25 million crashes per day more than usual!

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=773097#c19)• 12 years ago |
|  | |

(In reply to Robert Kaiser (:kairo@mozilla.com) from [comment #18](/show_bug.cgi?id=773097#c18 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> For the current release, i.e. 14.0.1, this was 2.5 million crashes at a
> throttle rate of 10%, i.e. 25 million crashes per day more than usual!
Bah, sorry, my bad, that 2.5 million number already includes the throttling. It's 250k at 10% throttling and 2.5 million total.
Sorry for overdoing it, but it's still quite a lot.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=773097#c20)• 12 years ago |
|  | |

And, FYI, I just checked if things improved today compared to yesterday, using [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy")'s signature as it's the main one:
Results within 3 hours of 08/07/2012 16:00:00, where the crash signature contains '\_moz\_cairo\_destroy', and the product is one of Firefox and the crashing process was of any type (including unofficial release channels): 48960
<https://crash-stats.mozilla.com/query/query?product=Firefox&version=ALL%3AALL&range_value=3&range_unit=hours&date=08%2F07%2F2012+16%3A00%3A00&query_search=signature&query_type=contains&query=_moz_cairo_destroy&reason=&build_id=&process_type=any&hang_type=any&do_query=1>
Results within 3 hours of 08/08/2012 16:00:00, where the crash signature contains '\_moz\_cairo\_destroy', and the product is one of Firefox and the crashing process was of any type (including unofficial release channels): 40786
<https://crash-stats.mozilla.com/query/query?product=Firefox&version=ALL%3AALL&range_value=3&range_unit=hours&date=08%2F08%2F2012+16%3A00%3A00&query_search=signature&query_type=contains&query=_moz_cairo_destroy&reason=&build_id=&process_type=any&hang_type=any&do_query=1>
This implies that today's doodle is just as bad as yesterday's in the crash rate.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=773097#c21)• 12 years ago |
|  | |

I have tried several memory debugging tools and all of them have failed to yield much in terms of things to go on in terms of debugging this.
At this point the best thing for us to move forward with debugging this is a reduced testcase. Unfortunately, doing the usual "Save as" on the hurdles doodle didn't give me much to go on.
If Google could send me a copy of this doodle privately (joe@mozilla.com) I'd really appreciate it.

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=773097#c22)• 12 years ago |
|  | |

We can reproduce this consistently in the QA lab with a Win 7 machine with a GeForce GT520 card.
The two variables that seem to consistently cause the crash are:
\*gfx.canvas.azure =false
\*layers.prefs.d3d9=false
\*clear cache right before restarting
\*google.com or the google doodles page as your startup page
\*https versus http seems to make a difference
Geo postulates it might be some kind of race condition.
We tried several requestanimationframe demos and we were not able to reproduce the crash with those demos.

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=773097#c23)• 12 years ago |
|  | |

Correction to [Comment 22](/show_bug.cgi?id=773097#c22 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"):
layers.prefer.d3d9=true, not false as stated previously.

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=773097#c24)• 12 years ago |
|  | |

Attached file
[about supoort from machine](attachment.cgi?id=650404)
— [Details](attachment.cgi?id=650404&action=edit)

Attached is the about:support configuration from the machine we crashed on. We also were able to reproduce the crash on the lab Vista machine.

|  | [Geo Mealer [:geo] -- This account is inactive after 2015-07-07](/user_profile?user_id=384418) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=773097#c25)• 12 years ago |
|  | |

Definitely seeing the crash happen during whatever happens between loading the basic Doodle and loading the Chrome promo, on the home page. Disabling the Chrome promo didn't suppress the crash, so it's not that, but it does establish timeline.
I think it's probably doing a lazy JS request of some animation info (maybe pushing it into a graphics buffer of some kind?) and crashing doing that. But since cache definitely affected it, it'd be some sort of cached data.
As an external effect, you can see the Chrome promo appear immediately when the animation is cached, and after a short delay when not. There's a similar delay on the Doodle archive page before the "more doodles" part loads.
Crash is also reproducable by disabling Direct2D. Think it was gfx.disable.direct2d=true, but I don't have the about:support that supplied the testcase in front of me.
Also, I was primarily working on GT520, but it repro'd on an older 8xxx card, and the about:support was ATI. It did not repro on a machine w/ blacklisted video drivers, and also didn't repro with hardware acceleration disabled.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=773097#c26)• 12 years ago |
|  | |

Ever since Joe mentioned in [comment #7](/show_bug.cgi?id=773097#c7 "RESOLVED FIXED - crash in gfxContext::~gfxContext()") that clearing the cache makes a difference this sounded a lot like a race condition thing to me (i.e. something's causing this when it loads with some delay and doesn't when it's loaded instantly by being cached, maybe some layout is changing by lazy-loading something and that causes an graphics crash). What puzzles me is how this causes a whole bunch of different crash signatures, almost as if that load would change something in memory and we crash when we access it in an unexpected way afterwards from different places (and which place that is can vary). As I have no clue about the code at all and am not even a C/C++ coder, this is all just hunches from all the crazy things I have heard so far when dealing with crashes. ;-)

|  | [Geo Mealer [:geo] -- This account is inactive after 2015-07-07](/user_profile?user_id=384418) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=773097#c27)• 12 years ago |
|  | |

Oh, one other thing that was maybe interesting, gfx.canvas.azure.enabled=false did give us reliable reproduction as mentioned above, but gfx.content.azure.enabled=false did not repro.

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=773097#c28)• 12 years ago |
|  | |

Ok we've been able to pare down the code to a minimal test case. Here's a tiny reproducing case.
We are investigating if there's a workaround to this bug that we can push soon; else we may push a change that shows a static Google logo instead of the animated sports doodles for Firefox 14 and above.
1. Paste the HTML below into an html file.
2. Open the file in Firefox.
3. Set that file as the homepage (Tools -> Options -> General -> "Use Current Pages")
4. Clear the cache (Tools -> Clear Recent History)
5. Restart firefox and it will crash.
<!doctype html>
<head>
<script>
function load() {
var context = document.getElementById('canvas').getContext('2d');
var update = function() {
context.fillRect(0, 0, 500, 200);
mozRequestAnimationFrame(update);
}
mozRequestAnimationFrame(update);
}
</script>
</head>
<body onload='load()'>
<canvas id='canvas' width='500px' height='200px'></canvas>
</body>
</html>

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=773097#c29)• 12 years ago |
|  | |

Hah, yes, I should say that's quite minimal.
Thanks so much, Mike.

|  | [Geo Mealer [:geo] -- This account is inactive after 2015-07-07](/user_profile?user_id=384418) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=773097#c30)• 12 years ago |
|  | |

Our explicit STR, btw:
Firefox 15.x on Windows Vista/7
1. Create new profile
2. about:config
3. Set gfx.canvas.azure.enabled=false
4. Set layers.prefer.d3d9=true
5. Restart
6. Navigate to <http://www.google.com/doodles/basketball-2012>
// no crash
7. Preferences, set start page to current
8. Clear all content (cache in particular, but just clear everything)
9. Restart
// crash between doodle and "more doodles" loading
3 + 4 must be set together. Either alone did not repro.
Alternately, set gfx.disable.direct2d=true instead of changing either of them, repros as well with same signature.
Top level signature was actually \_moz\_cairo\_destroy from [Bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy"). Next stack level was this one.
This worked reliably on a couple of different machines. Since I suspect race, network speed/latency (i.e. fast) may have been a factor.

|  | [Geo Mealer [:geo] -- This account is inactive after 2015-07-07](/user_profile?user_id=384418) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=773097#c31)• 12 years ago |
|  | |

Just tried the minimal case. Worked the same, same requirements for the prefs. Just substitute into #6 for STR.
I did look closer at the crash reports, though.
The one with the two prefs as #3 + #4 is \_moz\_cairo\_destroy at top level and gfxContext::~gfxContext just below, as I mention above.
However, when you disable direct2d instead of setting those prefs, you get a crash with gfxContext::~gfxContext as the top level.
This may help with [Bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy"), or at least help differentiate from this one.

|  | [Daniel C](/user_profile?user_id=185959) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=773097#c32)• 12 years ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=650485)
— [Details](attachment.cgi?id=650485&action=edit)

Here is the testcase from [comment 28](/show_bug.cgi?id=773097#c28 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"). My colleage was hitting this crash on the basketball homepage so I asked him to try this testcase and it also causes a crash (although the homepage crash signature was this one, and the testcase crash signature was [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy")). They seem closely related though.
It didn't crash every time. The first time the browser was already open and then opening the file didn't crash. Then closing the browser and opening it by double-clicking the file caused the crash. Not sure if that helps at all. There was no cache clearing involved.
Crash: <https://crash-stats.mozilla.com/report/index/cf99bc73-4946-4b2b-a0f3-541532120809>
about:support graphics section:
Adapter Description
Mobile Intel(R) 965 Express Chipset Family
Vendor
ID0x8086
Device
ID0x2a12
Adapter RAM
Unknown
Adapter Driver
sigdumdx32 igd10umd32
Driver Version
8.15.10.1930
Driver Date
9-23-2009
Direct2D Enabled
Blocked for your graphics driver version.
DirectWrite Enabled
false (6.1.7601.17789)
ClearType Parameters
ClearType parameters not found
WebGL Renderer
Google Inc. -- ANGLE (Mobile Intel(R) 965 Express Chipset Family) -- OpenGL ES 2.0 (ANGLE 1.0.0.1041)
GPU Accelerated Windows
1/1 Direct3D 9

|  | [Daniel C](/user_profile?user_id=185959) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=773097#c33)• 12 years ago |
|  | |

(In reply to Daniel Cater from [comment #32](/show_bug.cgi?id=773097#c32 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> There was no cache clearing involved.
Actually, there was no manual cache clearing involved. Of course the cache could have been nuked via [bug 105843](/show_bug.cgi?id=105843 "RESOLVED WORKSFORME - Cache lost if Mozilla crashes") though.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=773097#c35)• 12 years ago |
|  | |

Moving over all the signatures from [bug 734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy") as the actual discussions are going on over here, so let's consolidate this here.Crash Signature: [@ gfxContext::~gfxContext()] → [@ gfxContext::~gfxContext()]
[@ \_moz\_cairo\_destroy ]
[@ moz\_cairo\_destroy ]
[@ \_moz\_cairo\_surface\_get\_reference\_count]
[@ \_cairo\_gstate\_restore ]
[@ gfxASurface::Release() ]
[@ je\_free | mozilla::`anonymous namespace''::ContainerState::FindThebesL…See Also: [734921](/show_bug.cgi?id=734921 "RESOLVED DUPLICATE - Startup Crash @ _moz_cairo_destroy") →

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2469643_8519)• 12 years ago |

Crash Signature: PLDH... ] → PLDH...]
[@ mozilla::FrameLayerBuilder::GetLeafLayerFor(nsDisplayListBuilder\*, mozilla::layers::LayerManager\*, nsDisplayItem\*)]
[@ @0x0 | PL\_DHashTableOperate | mozilla::`anonymous namespace''::ContainerState::ProcessDisplayItems(nsDisplayList const& mo…

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2474576_272375)• 12 years ago |

[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected)
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=affected)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)
[tracking-firefox16](/buglist.cgi?f1=cf_tracking_firefox16&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B)
[tracking-firefox17](/buglist.cgi?f1=cf_tracking_firefox17&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox17&o1=equals&v1=%2B)

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=773097#c37)• 12 years ago |
|  | |

Can anyone try reproducing this bug today with your homepage set to google.com? Changes to the Google sports doodles were pushed last night, and we expect that the crash issues may be resolved.

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=773097#c38)• 12 years ago |
|  | |

The spike stopped on August 9 after 8H20 UTC.

|  | [Mike Graboski](/user_profile?user_id=430583) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=773097#c39)• 12 years ago |
|  | |

Perfect, this is minutes after the doodle fix was pushed.

|  | [[:jberkus] Josh Berkus](/user_profile?user_id=86607) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=773097#c40)• 12 years ago |
|  | |

Crashes are now down to the normal level of around 250,000 per hour, as opposed to the 430,000 per hour we were seeing yesterday.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=773097#c41)• 12 years ago |
|  | |

I have made this testcase even smaller. And even scarier.
<canvas id='canvas' width='1px' height='1px'></canvas>
<script>
var ctx = document.getElementById('canvas').getContext('2d');
</script>

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=773097#c42)• 12 years ago |
|  | |

Mike: I don't see a crash today using the STR in [Comment 30](/show_bug.cgi?id=773097#c30 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"). I am testing on the same machine that we were able to reproduce the crash on last evening.
In looking at crash stats, I do still see some recent crashes with UTC times just a few minutes ago, so it appears it is still happening to some users.
(In reply to Mike Graboski from [comment #37](/show_bug.cgi?id=773097#c37 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> Can anyone try reproducing this bug today with your homepage set to
> google.com? Changes to the Google sports doodles were pushed last night,
> and we expect that the crash issues may be resolved.QA Contact: mozillamarcia.knous

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=773097#c43)• 12 years ago |
|  | |

Those may very well be my crashes, Marcia. :) Check the URL.

|  | [Caboosey](/user_profile?user_id=448711) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=773097#c44)• 12 years ago |
|  | |

In my issues with the Google doodle.....
Firefox loaded google.com good as the homepage prior to August 8, 2012.
Firefox will still crash with safe mode most of the time with google.com set as homepage.
Firefox will not crash if google.com isn't homepage and and tell Firefox to go to google.com. The doodle will load fine and no crash.
My personal conclusion:
initial loading of the doodle and Firefox while the user has google.com has homepage seems to be the issue I see.
I and reported the Google Doodle issue to Google and referenced this bug.
<https://productforums.google.com/d/topic/websearch/S5AjuXNtczo/discussion>

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=773097#c45)• 12 years ago |
|  | |

Attached patch

[don't create the surface from GetCanvasLayer](attachment.cgi?id=650708&action=diff)
— [Details](attachment.cgi?id=650708&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708)

This was a bit of "fun" to figure out.
On Windows, we start up Firefox with a software-only layer manager, to hide the latency of creating a D3D device. Five seconds after startup, we switch to the accelerated layer manager (if it's possible to). This works just fine, most of the time.
However, canvases always want to use an accelerated layer manager, because that way we're sure to get good performance out of them (and it won't matter whether you open your canvas before or after the 5 second interval). Therefore, before they create their surface, they ask for the "persistent" layer manager, which causes us to destroy the old, software-only layer manager, and create a new accelerated layer manager. Again, most of the time this works fine.
Unfortunately, [bug 591358](/show_bug.cgi?id=591358 "RESOLVED FIXED - Crash [@ mozilla::layers::BasicLayerManager::PushGroupWithCachedSurface(gfxContext*, gfxASurface::gfxContentType, gfxPoint*) ]") made us defer construction of the canvas' backing surface until it's actually going to be used. And, in this case, "used" includes being drawn, even before it has any contents.
So what happened is that, during a paint, the layers system went through and asked a canvas to draw, which then caused us to destroy the software-only layer manager (which we were using to paint) and create the accelerated layer manager.
Because we simply hold on to pointers to layer managers, we had a stale pointer which we then happily used to corrupt most of the heap.
<https://tbpl.mozilla.org/?tree=Try&rev=5c6fe721e239> is a try run for this patch.
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(roc)
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(matt.woodrow)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=773097#c46)• 12 years ago |
|  | |

Also, I filed [bug 781679](/show_bug.cgi?id=781679 "RESOLVED FIXED - Assert that we do not destroy the layer manager while in the middle of painting") to help us make sure that this doesn't happen again.

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=773097#c47)• 12 years ago |
|  | |

(In reply to Joe Drew (:JOEDREW!) from [comment #43](/show_bug.cgi?id=773097#c43 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> Those may very well be my crashes, Marcia. :) Check the URL.
I rechecked and there still are crashes on 14.0.1 in [@ \_moz\_cairo\_destroy ] - see
<https://crash-stats.mozilla.com/report/index/578f98a5-6502-464b-96a5-a07322120809> as an example. The UTC time stamp shows 21:33 - so either we are still catching up on processing of crashes from yesterday or people are still crashing.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=773097#c48)• 12 years ago |
|  | |

(In reply to Marcia Knous [:marcia] from [comment #47](/show_bug.cgi?id=773097#c47 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> The UTC time stamp shows 21:33 - so either we
> are still catching up on processing of crashes from yesterday or people are
> still crashing.
Catching up doesn't show current times, we always show the time we have received the crash from the user. Also, we were able to handle all crashes that were incoming over the last days.
So those are crashes happening now. Still, since Aug 09, 2012 08:17 UTC this has slowed down very significantly.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=773097#c49)• 12 years ago |
|  | |

To clarify more: This is not in the top 100 any more for 14.0.1 in the last 12 hours.
There are still a low volume of crashes happening, but given that joe found out that this is caused by just initializing canvas at all, it doesn't take a lot to run into it somehow - and even the fixed version still is a canvas-based game so probably can trigger it in some way.
The real fix is to get the patch to our code landed.
Thanks, joe, for figuring that out, sounds like a real pain to find. :)

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=773097#c50)• 12 years ago |
|  | |

Comment on [attachment 650708](/attachment.cgi?id=650708 "don't create the surface from GetCanvasLayer") [[details]](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") [[diff]](/attachment.cgi?id=650708&action=diff "don't create the surface from GetCanvasLayer") [[review]](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708)
don't create the surface from GetCanvasLayer
Review of [attachment 650708](/attachment.cgi?id=650708 "don't create the surface from GetCanvasLayer") [[details]](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") [[diff]](/attachment.cgi?id=650708&action=diff "don't create the surface from GetCanvasLayer") [[review]](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708):
-----------------------------------------------------------------
I don't think we need Matt's review here.
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(roc)
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(matt.woodrow)
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review+

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=773097#c51)• 12 years ago |
|  | |

To be clear, this could only be triggered when loading a page using a 2D canvas within 5 seconds of starting the browser, on Windows using D3D9. The page would also have to call getContext("2d") but not draw into the canvas.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=773097#c52)• 12 years ago |
|  | |

> The page would also have to call getContext("2d") but not draw into the canvas.
Clarification: \*before\* drawing into the canvas. I.e., always. :)

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=773097#c53)• 12 years ago |
|  | |

If the page actually draws into the canvas, then EnsureSurface will be called and the persistent layer manager will be switched to at that point, which will not be during painting so we wouldn't crash. I think.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=773097#c54)• 12 years ago |
|  | |

Er, right. I forgot the getContext() call wasn't what crashed, it just created the context so it could cause the crash.
If the page doesn't draw into the canvas before we draw it the first time, though, we'll crash.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=773097#c55)• 12 years ago |
|  | |

Comment on [attachment 650708](/attachment.cgi?id=650708 "don't create the surface from GetCanvasLayer") [[details]](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") [[diff]](/attachment.cgi?id=650708&action=diff "don't create the surface from GetCanvasLayer") [[review]](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708)
don't create the surface from GetCanvasLayer
Because this was roc's idea, Matt should look at this too.
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(matt.woodrow)

|  | [Matt Woodrow (:mattwoodrow)](/user_profile?user_id=380838) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2515963_380838)• 12 years ago |

[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: review?(matt.woodrow) → review+

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2528006_386758)• 12 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F)

|  | [farluiz](/user_profile?user_id=443580) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=773097#c56)• 12 years ago |
|  | |

Perhaps this information can help.
Firefox 14.0.1 on my Windows XP SP3 does not crashes in any scenario proposed here.
a) Reproducing case [comment 28](/show_bug.cgi?id=773097#c28 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"):
no crash;
works fine;
b) Reproducing case [comment 30](/show_bug.cgi?id=773097#c30 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"):
no crash;
works fine;
c) <http://www.google.com/doodles/basketball-2012> and
\*ALL\* other Google doodles as a homepage:
no crash;
works fine;
My computer.
- XP SP3 2GB memory;
- Firefox 14.0.1;
- Flash 11.3.300.268;
- Next Generation Java Plug-in 10.5.1 for Mozilla browsers;
- GPU AMD Radeon HD 3850 with Catalyst 11.12;
- Hardware Acceleration always enabled;
- Hardware Acceleration working perfectly!
- GPU acceleration of the Google doodles very well (great!);
- I tested in all scenarios:
New profile, current profile, cache clear,
cache unclear, gfx.canvas.azure.enabled=false and
layers.prefer.d3d9=true, gfx.canvas.azure.enabled=true and
layers.prefer.d3d9=false, etc
I've tried everything to crash Firefox and nothing! Google doodles works fine!
Does the crash only occurs in nvidia's cards?

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=773097#c57)• 12 years ago |
|  | |

farluiz, thanks for your help, but we already have a testcase and a fix.

|  | [Daniel C](/user_profile?user_id=185959) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=773097#c58)• 12 years ago |
|  | |

(In reply to Joe Drew (:JOEDREW!) from [comment #45](/show_bug.cgi?id=773097#c45 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> On Windows, we start up Firefox with a software-only layer manager, to hide
> the latency of creating a D3D device. Five seconds after startup, we switch
> to the accelerated layer manager (if it's possible to). This works just
> fine, most of the time.
Is it possible to write a test that runs within 5 seconds of startup in order to test this?Flags: in-testsuite?

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=773097#c59)• 12 years ago |
|  | |

(In reply to [comment #58](/show_bug.cgi?id=773097#c58 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> (In reply to Joe Drew (:JOEDREW!) from [comment #45](/show_bug.cgi?id=773097#c45 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> > On Windows, we start up Firefox with a software-only layer manager, to hide
> > the latency of creating a D3D device. Five seconds after startup, we switch
> > to the accelerated layer manager (if it's possible to). This works just
> > fine, most of the time.
>
> Is it possible to write a test that runs within 5 seconds of startup in order
> to test this?
Of course, the test just needs to run at the initialization time of one of our test frameworks.

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=773097#c60)• 12 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/ccbcf3438328>
I'll request approval to land this patch on other branches once it's baked a little while.
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=773097#c61)• 12 years ago |
|  | |

And I'll also try to work up a test for this.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2574994_1689)• 12 years ago |

Blocks: [704762](/show_bug.cgi?id=704762 "RESOLVED WORKSFORME - Startup crash in mozilla::layers::SwapChainD3D9::PrepareForRendering")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=773097#c62)• 12 years ago |
|  | |

Tight timing window but potentially exploitable. Have no idea how easy or hard it might be to make a reliable exploit, but hiding anyway because the testcases here can only give someone a head start on doing so.No longer blocks: [704762](/show_bug.cgi?id=704762 "RESOLVED WORKSFORME - Startup crash in mozilla::layers::SwapChainD3D9::PrepareForRendering")Group: core-securityKeywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2577132_1689)• 12 years ago |

Blocks: [704762](/show_bug.cgi?id=704762 "RESOLVED WORKSFORME - Startup crash in mozilla::layers::SwapChainD3D9::PrepareForRendering")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2577290_1689)• 12 years ago |

[Comment 28](#c28) is private:
false
[Comment 41](#c41) is private:
false

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2578282_94)• 12 years ago |

Blocks: [591358](/show_bug.cgi?id=591358 "RESOLVED FIXED - Crash [@ mozilla::layers::BasicLayerManager::PushGroupWithCachedSurface(gfxContext*, gfxASurface::gfxContentType, gfxPoint*) ]")

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=773097#c63)• 12 years ago |
|  | |

Attached patch

[somewhat ineffective test](attachment.cgi?id=650998&action=diff)
— [Details](attachment.cgi?id=650998&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650998)

This test \*should\* work, but at least on my very fast machine, on a debug build, it doesn't crash without my patch - presumably because with the reftest addon it takes more than 5 seconds to start up Firefox.
We might need to add a manual test for this.
[Attachment #650998](/attachment.cgi?id=650998&action=edit "somewhat ineffective test") -
Flags: review?(ehsan)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2581684_94)• 12 years ago |

Flags: in-litmus?(mozillamarcia.knous)

|  | [Jason Smith [:jsmith]](/user_profile?user_id=432443)  Reporter |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=773097#c64)• 12 years ago |
|  | |

We're using in-moztrap? now, not in-litmus?Flags: in-litmus?(mozillamarcia.knous) → in-moztrap?(mozillamarcia.knous)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2583113_251051)• 12 years ago |

[Attachment #650998](/attachment.cgi?id=650998&action=edit "somewhat ineffective test") -
Flags: review?(ehsan) → review+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=773097#c65)• 12 years ago |
|  | |

(In reply to Joe Drew (:JOEDREW!) from [comment #60](/show_bug.cgi?id=773097#c60 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> <https://hg.mozilla.org/integration/mozilla-inbound/rev/ccbcf3438328>
>
<https://hg.mozilla.org/mozilla-central/rev/ccbcf3438328>Status: NEW → RESOLVEDClosed: 12 years agoResolution: --- → FIXEDTarget Milestone: --- → mozilla17

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=773097#c66)• 12 years ago |
|  | |

Comment on [attachment 650708](/attachment.cgi?id=650708 "don't create the surface from GetCanvasLayer") [[details]](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") [[diff]](/attachment.cgi?id=650708&action=diff "don't create the surface from GetCanvasLayer") [[review]](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708)
don't create the surface from GetCanvasLayer
[Approval Request Comment]
Bug caused by (feature/regressing bug #): [bug 591358](/show_bug.cgi?id=591358 "RESOLVED FIXED - Crash [@ mozilla::layers::BasicLayerManager::PushGroupWithCachedSurface(gfxContext*, gfxASurface::gfxContentType, gfxPoint*) ]")
User impact if declined: Possibility for further crashes if Google or another major site that people have as their homepage includes canvases.
Testing completed (on m-c, etc.): On m-c for a few days. Local testing too.
Risk to taking this patch (and alternatives if risky): Could potentially break canvases in some very edge casey ways.
String or UUID changes made by this patch: none
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-esr10?
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-beta?
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-aurora?

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=773097#c67)• 12 years ago |
|  | |

Comment on [attachment 650708](/attachment.cgi?id=650708 "don't create the surface from GetCanvasLayer") [[details]](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") [[diff]](/attachment.cgi?id=650708&action=diff "don't create the surface from GetCanvasLayer") [[review]](/page.cgi?id=splinter.html&ignore=&bug=773097&attachment=650708)
don't create the surface from GetCanvasLayer
Will track this for ESR 10.0.7 as well, please land to branches.
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-esr10?
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-esr10+
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-beta?
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-beta+
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-aurora?
[Attachment #650708](/attachment.cgi?id=650708&action=edit "don't create the surface from GetCanvasLayer") -
Flags: approval-mozilla-aurora+

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2917964_272375)• 12 years ago |

[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F) → [15+](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=15%2B)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94)  Assignee |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=773097#c68)• 12 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/fe13653f05ec>
<https://hg.mozilla.org/releases/mozilla-aurora/rev/c45599eff49f>
<https://hg.mozilla.org/releases/mozilla-esr10/rev/e6961914db3b>
I presume we will set this to fx14:wontfix, but I'll leave that change to someone else.
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=fixed)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a2931270_279076)• 12 years ago |

Whiteboard: [startupcrash] → [startupcrash][qa+]

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a3021959_279076)• 12 years ago |

Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)Whiteboard: [startupcrash][qa+] → [startupcrash]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a3618627_280903)• 12 years ago |

Whiteboard: [startupcrash] → [startupcrash][advisory-tracking+]

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=773097#c69)• 12 years ago |
|  | |

(In reply to Marcia Knous [:marcia] from [comment #22](/show_bug.cgi?id=773097#c22 "RESOLVED FIXED - crash in gfxContext::~gfxContext()"))
> We can reproduce this consistently in the QA lab with a Win 7 machine with a
> GeForce GT520 card.
Marcia, I'm having a hard time reproducing this locally. Can you please retry reproducing this in the QA lab, and if you can please verify the fix for Firefox 15, 10.0.7esr, 16.0a2 and 17.0a1 (in order of priority).
Thanks

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a4669514_20209)• 12 years ago |

Depends on: [787892](/show_bug.cgi?id=787892 "RESOLVED DUPLICATE - Huge slowdown in canvas demo from Ionmonkey landing")

|  | [Jason Smith [:jsmith]](/user_profile?user_id=432443)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a4669845_432443)• 12 years ago |

Flags: in-moztrap?(mozillamarcia.knous)

|  | [Scoobidiver (away)](/user_profile?user_id=386758) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a4690969_386758)• 12 years ago |

Depends on: [787623](/show_bug.cgi?id=787623 "VERIFIED FIXED - mousemove event fails to draw content on canvas")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a8831206_1689)• 12 years ago |

Group: core-security

|  | [Mihaela Velimiroviciu (:mihaelav)](/user_profile?user_id=421899) |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=773097#c70)• 12 years ago |
|  | |

Mozilla/5.0 (Windows NT 5.1; rv:17.0) Gecko/17.0 Firefox/17.0
Mozilla/5.0 (Windows NT 6.1; rv:17.0) Gecko/17.0 Firefox/17.0
I could not reproduce the crash on the above builds (latest beta - 17b4) with the scenarios from comments 28 and 30.
However, there are many crashes with this signature in socorro, on builds newer than the fixes, but they don't have similar stacktrace.
There are crash reports for the other signatures tracked here:
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&query_search=signature&query_type=exact&query=gfxASurface%3A%3ARelease%28%29&reason_type=contains&date=11%2F05%2F2012%2014%3A42%3A24&range_value=1&range_unit=weeks&hang_type=any&process_type=any&do_query=1&signature=gfxASurface%3A%3ARelease%28%29>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=_moz_cairo_surface_get_reference_count&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=4&range_unit=weeks&hang_type=any&process_type=any&do_query=1&signature=_moz_cairo_surface_get_reference_count>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=gfxASurface%3A%3ARelease%28%29&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=4&range_unit=weeks&hang_type=any&process_type=any&do_query=1&signature=gfxASurface%3A%3ARelease%28%29>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=mozilla%3A%3AFrameLayerBuilder%3A%3ABuildContainerLayerFor%28nsDisplayListBuilder%2A%2C%20mozilla%3A%3Alayers%3A%3ALayerManager%2A%2C%20nsIFrame%2A%2C%20nsDisplayItem%2A%2C%20nsDisplayList%20const%26amp%3B%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AContainerParameters%20const%26amp%3B%2C%20gfx3DMatrix%20const%2A%29&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=30&range_unit=days&hang_type=any&process_type=any&do_query=1&signature=mozilla%3A%3AFrameLayerBuilder%3A%3ABuildContainerLayerFor%28nsDisplayListBuilder%2A%2C%20mozilla%3A%3Alayers%3A%3ALayerManager%2A%2C%20nsIFrame%2A%2C%20nsDisplayItem%2A%2C%20nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AContainerParameters%20const%26%2C%20gfx3DMatrix%20const%2A%29>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=%400x0%20%7C%20PL_DHashTableOperate%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AProcessDisplayItems%28nsDisplayList%20const%26amp%3B%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%26amp%3B%2C%20unsigned%20int%29&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=30&range_unit=days&hang_type=any&process_type=any&do_query=1&signature=%400x0%20%7C%20PL_DHashTableOperate%20%7C%20mozilla%3A%3A%60anonymous%20namespace%27%27%3A%3AContainerState%3A%3AProcessDisplayItems%28nsDisplayList%20const%26%2C%20mozilla%3A%3AFrameLayerBuilder%3A%3AClip%26%2C%20unsigned%20int%29>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=je_free%20%7C%20ChangeTable&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=30&range_unit=days&hang_type=any&process_type=any&do_query=1&signature=je_free%20%7C%20ChangeTable>
\* <https://crash-stats.mozilla.com/report/list?product=Firefox&version=Firefox%3A17.0b4&version=Firefox%3A17.0b3&version=Firefox%3A17.0b2&version=Firefox%3A17.0b1&platform=windows&query_search=signature&query_type=exact&query=mozilla%3A%3ARefCounted%26lt%3Bmozilla%3A%3Agfx%3A%3ADrawTarget%26gt%3B%3A%3ARelease%28%29&reason_type=contains&date=11%2F05%2F2012%2014%3A54%3A01&range_value=30&range_unit=days&hang_type=any&process_type=any&do_query=1&signature=mozilla%3A%3ARefCounted%3Cmozilla%3A%3Agfx%3A%3ADrawTarget%3E%3A%3ARelease%28%29>
Joe, do you think these are related to this issue?Whiteboard: [startupcrash][advisory-tracking+] → [startupcrash][advisory-tracking+] [qa?]

|  | [Mihaela Velimiroviciu (:mihaelav)](/user_profile?user_id=421899) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a10143065_421899)• 12 years ago |

Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)

|  | [Darkspirit](/user_profile?user_id=580271) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=773097#a311942629_580271)• 3 years ago |

Flags: needinfo?(masterclient66)

|  | [Mike Hoye [:mhoye]](/user_profile?user_id=461850) |  |
| --- | --- | --- |
| [Comment 84](/show_bug.cgi?id=773097#c84)• 2 years ago |
|  | |

That's quite enough of that.

Restrict Comments: true
You need to [log in](/show_bug.cgi?id=773097&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Marcia Knous [:marcia]](/user_profile?user_id=8519)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_d5a147c1_20250125_013421.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/730208)
* [XML](/show_bug.cgi?ctype=xml&id=730208)

Closed
[Bug 730208](/show_bug.cgi?id=730208)

Opened 13 years ago
Closed 13 years ago

# Hunt down black -> gray edges in the JS heap

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Hunt down black -> gray edges in the JS heap

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Priority | --- |
| a11y-review | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 |  | fixed |
| firefox-esr10 |  | wontfix |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sfink, Assigned: sfink)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/d269c0228684029dedb75d73b81a64c3?d=mm&size=40)  [sfink](/user_profile?user_id=359004)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d269c0228684029dedb75d73b81a64c3?d=mm&size=40)  [sfink](/user_profile?user_id=359004)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

10 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[752081](/show_bug.cgi?id=752081 "VERIFIED FIXED - \"Assertion failure: invalid trace kind\" with incremental GC and multiple browser windows"), [752250](/show_bug.cgi?id=752250 "RESOLVED FIXED - Thunderbird stderr prints many messages: JavaScript error: , line 0: nothing active on context"), [776497](/show_bug.cgi?id=776497 "RESOLVED FIXED - crash in nsGlobalWindow::SetNewDocument")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=730208&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=730208)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[752250](/show_bug.cgi?id=752250 "RESOLVED FIXED - Thunderbird stderr prints many messages: JavaScript error: , line 0: nothing active on context")

## Details

### (Keywords: sec-moderate, Whiteboard: [sg:moderate][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:moderate][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (7 files, 11 obsolete files)

| [Aggressive asserts for finding external callers that do not UnmarkGray](/attachment.cgi?id=600317)  [13 years ago](#c1)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   5.21 KB, patch |  | [Details](/attachment.cgi?id=600317&action=edit) | [Diff](/attachment.cgi?id=600317&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600317) |
| --- | --- | --- |
| [Various UnmarkGray fixes](/attachment.cgi?id=600318)  [13 years ago](#c2)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   23.69 KB, patch | smaug : [review-](#c6 "13 years ago") | [Details](/attachment.cgi?id=600318&action=edit) | [Diff](/attachment.cgi?id=600318&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318) |
| [Variety of places where we need to UnmarkGray objects that will be touched by the JSAPI, to prevent black -> gray edges.](/attachment.cgi?id=605870)  [13 years ago](#c20)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   24.32 KB, patch |  | [Details](/attachment.cgi?id=605870&action=edit) | [Diff](/attachment.cgi?id=605870&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605870) |
| [Root JSD's pet global so it can't participate in CC cycles](/attachment.cgi?id=605871)  [13 years ago](#c21)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   1.87 KB, patch |  | [Details](/attachment.cgi?id=605871&action=edit) | [Diff](/attachment.cgi?id=605871&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605871) |
| [patch6: UnmarkGray fixups for globals and contexts](/attachment.cgi?id=605872)  [13 years ago](#c22)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   13.77 KB, patch | billm : [review+](#c40 "13 years ago") | [Details](/attachment.cgi?id=605872&action=edit) | [Diff](/attachment.cgi?id=605872&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605872) |
| [patch7: UnmarkGray for JS\_TransplantObject](/attachment.cgi?id=605874)  [13 years ago](#c23)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   4.19 KB, patch | billm : [review-](#c48 "13 years ago") | [Details](/attachment.cgi?id=605874&action=edit) | [Diff](/attachment.cgi?id=605874&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605874) |
| [patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges](/attachment.cgi?id=606459)  [13 years ago](#c33)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   950 bytes, patch | smaug : [review+](#a1832728_39966 "13 years ago") | [Details](/attachment.cgi?id=606459&action=edit) | [Diff](/attachment.cgi?id=606459&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606459) |
| [UnmarkGray various JS objects to prevent them from being used to create black -> gray edges](/attachment.cgi?id=606460)  [13 years ago](#c34)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   12.28 KB, patch |  | [Details](/attachment.cgi?id=606460&action=edit) | [Diff](/attachment.cgi?id=606460&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606460) |
| [patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges](/attachment.cgi?id=606464)  [13 years ago](#c35)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   12.29 KB, patch | smaug : [review+](#a1832866_39966 "13 years ago") | [Details](/attachment.cgi?id=606464&action=edit) | [Diff](/attachment.cgi?id=606464&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606464) |
| [patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](/attachment.cgi?id=606465)  [13 years ago](#c36)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   10.10 KB, patch | mccr8 : [review-](#c43 "13 years ago") | [Details](/attachment.cgi?id=606465&action=edit) | [Diff](/attachment.cgi?id=606465&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465) |
| [patch5: Root JSD's pet global so it can't participate in CC cycles](/attachment.cgi?id=606468)  [13 years ago](#c37)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   1.87 KB, patch | billm : [review+](#c38 "13 years ago") | [Details](/attachment.cgi?id=606468&action=edit) | [Diff](/attachment.cgi?id=606468&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606468) |
| [patch1: Implement JS\_GetGCThingRuntime](/attachment.cgi?id=606661)  [13 years ago](#c39)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   1.74 KB, patch |  | [Details](/attachment.cgi?id=606661&action=edit) | [Diff](/attachment.cgi?id=606661&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606661) |
| [patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](/attachment.cgi?id=607849)  [13 years ago](#c45)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   10.39 KB, patch | mccr8 : [review-](#c51 "13 years ago") | [Details](/attachment.cgi?id=607849&action=edit) | [Diff](/attachment.cgi?id=607849&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849) |
| [patch1: Implement IsIncrementalBarrierNeededOnScript](/attachment.cgi?id=616338)  [13 years ago](#c52)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   1.40 KB, patch | billm : [review+](#a4796733_389993 "13 years ago") | [Details](/attachment.cgi?id=616338&action=edit) | [Diff](/attachment.cgi?id=616338&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616338) |
| [patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](/attachment.cgi?id=616339)  [13 years ago](#c53)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   10.90 KB, patch |  | [Details](/attachment.cgi?id=616339&action=edit) | [Diff](/attachment.cgi?id=616339&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616339) |
| [patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](/attachment.cgi?id=616693)  [13 years ago](#c55)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   10.53 KB, patch | mccr8 : [review+](#c56 "13 years ago") | [Details](/attachment.cgi?id=616693&action=edit) | [Diff](/attachment.cgi?id=616693&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616693) |
| [patch5: Root JSD's pet global so it can't participate in gray CC cycles](/attachment.cgi?id=619112)  [13 years ago](#c61)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   2.08 KB, patch | billm : [review+](#c62 "13 years ago") | [Details](/attachment.cgi?id=619112&action=edit) | [Diff](/attachment.cgi?id=619112&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=619112) |
| [path7: UnmarkGray for component loader](/attachment.cgi?id=620517)  [13 years ago](#c64)  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)   1.64 KB, patch |  | [Details](/attachment.cgi?id=620517&action=edit) | [Diff](/attachment.cgi?id=620517&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=730208#c0)• 13 years ago |
|  | |

billm, was there a bug for this? I can't remember one, so I'm making one to attach my current WIP.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=730208#c1)• 13 years ago |
|  | |

Attached patch

[Aggressive asserts for finding external callers that do not UnmarkGray](attachment.cgi?id=600317&action=diff)
— [Details](attachment.cgi?id=600317&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600317)

This is billm's original patch that tries to find places where C++ code passes gray JS objects back into JSAPI without unmarking them. I added some additional (and excessive) checks while trying to track some of these to their sources.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=730208#c2)• 13 years ago |
|  | |

Attached patch

[Various UnmarkGray fixes](attachment.cgi?id=600318&action=diff) (obsolete)
— [Details](attachment.cgi?id=600318&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318)

Can you take a quick look at this set? This seems to catch most of them, but they may be in the wrong places and/or excessive.
I'm not really asking for review yet, more of a sanity check, and I'll split up the patch before landing so I can assign appropriate reviewers for different areas.
I wonder if I should make XPConnect accessors like xpc\_GetGlobalObject(JSContext \*)?
[Attachment #600318](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") -
Flags: review?(wmccloskey)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=730208#c3)• 13 years ago |
|  | |

I have a couple of these bugs filed I should CC you on.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=730208#c4)• 13 years ago |
|  | |

Comment on [attachment 600318](/attachment.cgi?id=600318 "Various UnmarkGray fixes") [[details]](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") [[diff]](/attachment.cgi?id=600318&action=diff "Various UnmarkGray fixes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318)
Various UnmarkGray fixes
Review of [attachment 600318](/attachment.cgi?id=600318 "Various UnmarkGray fixes") [[details]](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") [[diff]](/attachment.cgi?id=600318&action=diff "Various UnmarkGray fixes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318):
-----------------------------------------------------------------
::: js/xpconnect/src/nsXPConnect.cpp
@@ +735,5 @@
> xpc->EnsureGCBeforeCC();
> return;
> }
>
> + if (!xpc\_IsGrayGCThing(thing))
I wouldn't make this change lightly. It could cause stack overflows in the CC, which won't cause crashes, but will make the CC invoke the GC, which will make it take longer. I don't know how common that is in practice.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=730208#c5)• 13 years ago |
|  | |

Olli might want to take a look at this too, as it is mostly DOM code. Or another DOM person.

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=730208#c6)• 13 years ago |
|  | |

Comment on [attachment 600318](/attachment.cgi?id=600318 "Various UnmarkGray fixes") [[details]](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") [[diff]](/attachment.cgi?id=600318&action=diff "Various UnmarkGray fixes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318)
Various UnmarkGray fixes
>+ xpc\_UnmarkGrayObject(JS\_GetGlobalForScopeChain(mContext));
This looks like a missing or buggy JSAPI
>+static void
>+UnmarkGrayValue(JS::Value &v)
>+{
>+ if (!JSVAL\_IS\_PRIMITIVE(v))
>+ xpc\_UnmarkGrayObject(JSVAL\_TO\_OBJECT(v));
>+}
Could you move this to xpcpublic.h
>@@ -1942,16 +1968,18 @@ nsJSContext::CallEventHandler(nsISupport
>
> // Use |target| as the scope for wrapping the arguments, since aScope is
> // the safe scope in many cases, which isn't very useful. Wrapping aTarget
> // was OK because those typically have PreCreate methods that give them the
> // right scope anyway, and we want to make sure that the arguments end up
> // in the same scope as aTarget.
> rv = ConvertSupportsTojsvals(aargv, target, &argc, &argv, tempStorage);
> NS\_ENSURE\_SUCCESS(rv, rv);
>+ for (uint32\_t i = 0; i < argc; i++)
>+ UnmarkGrayValue(argv[i]);
Coding style is
for (;;) {
stmt;
}
> nsCOMPtr<nsIXPConnectJSObjectHolder> wrapper;
>+ JSObject \*global = xpc\_UnmarkGrayObject(::JS\_GetGlobalObject(cx));
Again, why is JSAPI giving us a gray object.
If it does that, it is very error prone API
>+ JSObject\*
>+ GetPrototypeJSObject() const
>+ {if (mPrototypeJSObject != INVALID\_OBJECT)
>+ xpc\_UnmarkGrayObject(mPrototypeJSObject);
>+ return mPrototypeJSObject;}
Ok, this is xpconnect so horrible coding style is expected :/
r- because of JSAPI problems. Either fix the existing JSAPI methods or add something new for
preservecolor, IMO. (Not that I know much about JSAPI internals)
[Attachment #600318](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") -
Flags: review-

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=730208#c7)• 13 years ago |
|  | |

Though, perhaps I'm wrong, because this is about CC <-> GC setup.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=730208#c8)• 13 years ago |
|  | |

Don't take this patch too seriously yet; I fully expect some of these to be in absolutely the wrong place.
In general, though, the JSAPI absolutely doesn't mind handing out gray objects. Other than the more incestuous aspects of the CC <-> GC setup, the JSAPI doesn't pay any attention to the gray mark bits.
But it's still a good point. I suspect the "proper" fix would be to add XPConnect accessor APIs for all/most of these.
The nastiest pieces are probably the
xpc\_UnmarkGrayObject(::JS\_GetGlobalObject(cx))
and
xpc\_UnmarkGrayObject(::JS\_GetGlobalForScopeChain(mContext))
ones, because you can't hide those with an accessor -- you're not even really aware that you might be accessing them. (The danger is that you compile a script using a context whose global is gray, and that entrains the global or its gray properties.) Perhaps an xpc\_PrepareContext or somesuch? (I'm not really familiar with any of this code, so I don't know what is "standard".)
I just don't want to wrap the whole JSAPI with an xpc slime layer.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=730208#c9)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #4](/show_bug.cgi?id=730208#c4 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Comment on [attachment 600318](/attachment.cgi?id=600318 "Various UnmarkGray fixes") [[details]](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") [[diff]](/attachment.cgi?id=600318&action=diff "Various UnmarkGray fixes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318)
> Various UnmarkGray fixes
>
> Review of [attachment 600318](/attachment.cgi?id=600318 "Various UnmarkGray fixes") [[details]](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") [[diff]](/attachment.cgi?id=600318&action=diff "Various UnmarkGray fixes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=600318):
> -----------------------------------------------------------------
>
> ::: js/xpconnect/src/nsXPConnect.cpp
> @@ +735,5 @@
> > xpc->EnsureGCBeforeCC();
> > return;
> > }
> >
> > + if (!xpc\_IsGrayGCThing(thing))
>
> I wouldn't make this change lightly. It could cause stack overflows in the
> CC, which won't cause crashes, but will make the CC invoke the GC, which
> will make it take longer. I don't know how common that is in practice.
That's actually an independent fix. billm explained it to me and it made sense at the time, but it fell out of my brain.
And I think you're talking about
- // If this thing is not a CC-kind or already non-gray then we're done.
- if (!AddToCCKind(kind) || !xpc\_IsGrayGCThing(thing))
+ if (!xpc\_IsGrayGCThing(thing))
return;
right? (Must be splinter being silly again.)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=730208#c10)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #9](/show_bug.cgi?id=730208#c9 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> And I think you're talking about
>
> - // If this thing is not a CC-kind or already non-gray then we're done.
> - if (!AddToCCKind(kind) || !xpc\_IsGrayGCThing(thing))
> + if (!xpc\_IsGrayGCThing(thing))
> return;
>
> right? (Must be splinter being silly again.)
Yes, that. It might be my fault, I was only sort of paying attention when I decided where to click.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=730208#c11)• 13 years ago |
|  | |

Marking this s-s just in case.Group: core-security

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a43609_406194)• 13 years ago |

Whiteboard: [sg:moderate]

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=730208#c12)• 13 years ago |
|  | |

It seems like dealing with global objects is the main problem here. Everything else looks basically fine. Steve, in some cases you might want to use JSVAL\_IS\_TRACEABLE and JSVAL\_TO\_TRACEABLE when you don't know something is a JSObject\*.
Olli, this isn't really a problem with JSAPI. The JS engine isn't even supposed to know what gray means; clients are supposed to be able to use the extra mark colors however they wish.
Normally, the JS engine would mark JSContext::globalObject black for every JS context. However, XPConnect sets a special flag on all contexts specifying that their globalObject field should not be marked. Then XPConnect marks all the globalObject fields gray itself. The JS engine has no knowledge of this. In theory, XPConnect should ensure that the globalObject is marked black before you actually use a context. But it totally fails to do this.
Luke told me that the globalObject field will be removed from JSContext in the big compartment-per-global patch. This means that nsJSContext will be responsible for keeping track of the global object. Anyone else holding a JSContext will have to do their own thing.
Does anyone know why we mark cx->globalObject gray anyway? I would be surprised if we ever expect to collect the globalObject of a JSContext attached to an nsJSContext. So is it for other JSContexts? Waldo mentioned web workers to me as a possible reason.
If this is true, then once c-p-g lands, it seems feasible that the globalObject connected to an nsJSContext could be marked black. And if any other contexts want to mark their global objects gray, then they would be responsible for calling UnmarkGray before ever using the context.
Olli, Ben, does this seem reasonable? I have to admit that I don't understand these issues very well.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=730208#c13)• 13 years ago |
|  | |

That sounds about right with respect to cx->globalObject, but I saw several cases where it was JS\_GetGlobalForScopeChain that was the problematic gray object. I guess I didn't check to see whether it was ever different from cx->globalObject in those cases. Let's see... when would that arise? You'd probably have to have
C++ ->
JS ->
boundary crossing, causing a dummy frame to be pushed ->
back into C++ ->
JS that entrains its scope somehow
Or maybe that's impossible? The "back into C++" layer has to be something that goes back to nsJSEnvironment or nsXBLDocument or something, not just any C++, and perhaps you'd get a JS\_SaveFrameChain in that case?
(In reply to Bill McCloskey (:billm) from [comment #12](/show_bug.cgi?id=730208#c12 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> no knowledge of this. In theory, XPConnect should ensure that the
> globalObject is marked black before you actually use a context. But it
> totally fails to do this.
I think there are some cases where XPConnect is skipped, and the code directly uses the JSAPI. Oh! They probably don't store their JSContexts directly. Maybe ContextStack::Peek is a good interception point.
billm, one thing I don't understand about all this -- couldn't this happen:
1. GC runs, marks stuff black
2. XPConnect marks things gray
3. nsJSEnvironment marks an object black, then accesses it
4. During the access operation, another GC runs and marks stuff black
5. XPConnect marks things gray, including that same object
6. The access operation continues, and points a black object at the again-gray object

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=730208#c14)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #13](/show_bug.cgi?id=730208#c13 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> That sounds about right with respect to cx->globalObject, but I saw several
> cases where it was JS\_GetGlobalForScopeChain that was the problematic gray
> object. I guess I didn't check to see whether it was ever different from
> cx->globalObject in those cases. Let's see... when would that arise? You'd
> probably have to have
>
> C++ ->
> JS ->
> boundary crossing, causing a dummy frame to be pushed ->
> back into C++ ->
> JS that entrains its scope somehow
>
> Or maybe that's impossible? The "back into C++" layer has to be something
> that goes back to nsJSEnvironment or nsXBLDocument or something, not just
> any C++, and perhaps you'd get a JS\_SaveFrameChain in that case?
I didn't understand the last part. However, I think in the future we would want to maintain the invariant that anything on the stack should be black. And I think we can do that by doing UnmarkGray when we push. Right now we can't do that, because cx->globalObject always serves as the backstop for JS\_GetGlobalForScopeChain.
However, it would be interesting to make sure that all stack pushes maintain this invariant. We should be able to assert that now.
> (In reply to Bill McCloskey (:billm) from [comment #12](/show_bug.cgi?id=730208#c12 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> > no knowledge of this. In theory, XPConnect should ensure that the
> > globalObject is marked black before you actually use a context. But it
> > totally fails to do this.
>
> I think there are some cases where XPConnect is skipped, and the code
> directly uses the JSAPI. Oh! They probably don't store their JSContexts
> directly. Maybe ContextStack::Peek is a good interception point.
>
> billm, one thing I don't understand about all this -- couldn't this happen:
>
> 1. GC runs, marks stuff black
> 2. XPConnect marks things gray
> 3. nsJSEnvironment marks an object black, then accesses it
> 4. During the access operation, another GC runs and marks stuff black
> 5. XPConnect marks things gray, including that same object
> 6. The access operation continues, and points a black object at the
> again-gray object
I guess the idea is that when the GC runs the second time, it's not supposed to mark the object gray. It's supposed to realize that the object is currently being used, and so it should mark it black. I don't know if that's actually happening right now, though.
Luckily, outside the JS engine, there aren't as many places where GC is going to run. It's really only going to happen during JSAPI calls. And once you pass something into JSAPI, it should get rooted in a way that it will be marked black if any GCs happen there.

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=730208#c15)• 13 years ago |
|  | |

(In reply to Bill McCloskey (:billm) from [comment #12](/show_bug.cgi?id=730208#c12 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Normally, the JS engine would mark JSContext::globalObject black for every
> JS context. However, XPConnect sets a special flag on all contexts
> specifying that their globalObject field should not be marked. Then
> XPConnect marks all the globalObject fields gray itself. The JS engine has
> no knowledge of this.
It seems to me that the root of the problem is that we unmark gray when someone accesses an object. Ideally we should unmark gray when we add an edge from a black object to a gray object. I have no idea if it's possible to do that, but it would solve the problem with globals and it seems more correct to me. It would also avoid chasing down random code that hands out a gray object.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=730208#c16)• 13 years ago |
|  | |

(In reply to Bill McCloskey (:billm) from [comment #14](/show_bug.cgi?id=730208#c14 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> (In reply to Steve Fink [:sfink] from [comment #13](/show_bug.cgi?id=730208#c13 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> > billm, one thing I don't understand about all this -- couldn't this happen:
> >
> > 1. GC runs, marks stuff black
> > 2. XPConnect marks things gray
> > 3. nsJSEnvironment marks an object black, then accesses it
> > 4. During the access operation, another GC runs and marks stuff black
> > 5. XPConnect marks things gray, including that same object
> > 6. The access operation continues, and points a black object at the
> > again-gray object
>
> I guess the idea is that when the GC runs the second time, it's not supposed
> to mark the object gray. It's supposed to realize that the object is
> currently being used, and so it should mark it black. I don't know if that's
> actually happening right now, though.
Oh, right, sorry. Step 5 wouldn't happen, because it would get marked black in step 4.
(In reply to Peter Van der Beken [:peterv] from [comment #15](/show_bug.cgi?id=730208#c15 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> It seems to me that the root of the problem is that we unmark gray when
> someone accesses an object. Ideally we should unmark gray when we add an
> edge from a black object to a gray object. I have no idea if it's possible
> to do that, but it would solve the problem with globals and it seems more
> correct to me. It would also avoid chasing down random code that hands out a
> gray object.
Makes sense. I would think that this would be possible now with the barriers, but the GC is currently unaware of the gray mark bits and their semantics. To keep that separation, we'd need a callback to be invoked on a given pattern of color changes or something. And I have no idea how much you can do from a barrier without needing to worry about interactions with other stuff.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=730208#c17)• 13 years ago |
|  | |

(In reply to Peter Van der Beken [:peterv] from [comment #15](/show_bug.cgi?id=730208#c15 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> It seems to me that the root of the problem is that we unmark gray when
> someone accesses an object. Ideally we should unmark gray when we add an
> edge from a black object to a gray object. I have no idea if it's possible
> to do that, but it would solve the problem with globals and it seems more
> correct to me. It would also avoid chasing down random code that hands out a
> gray object.
If we allow arbitrary objects to be gray, then that doesn't seem possible. We'd have to instrument every SETPROP operation to check if the object we're assigning is gray. SETPROP is really hot, and checking the mark color isn't all that fast.
I talked to Johnny about this yesterday, and it sounds like maybe we could take a two-pronged approach:
1. If an nsJSContext is tied to a window that's actually being displayed, then we can mark its global black. This would also speed up the cycle collector, and it ties in well with [bug 717500](/show_bug.cgi?id=717500 "RESOLVED INCOMPLETE - [CC] Mark JS objects reachable from obviously live C++ objects black during GC marking").
2. For other contexts, maybe we could find some convenient bottlenecks for when their contexts are used. Once example Johnny mentioned was that nsJSEventListener can keep a context alive even after window is closed. We could add UnmarkGray to its GetEventContext method. Hopefully we could do similar things in other places where nsJSContext is kept alive.
Peter, does that sound at all feasible?

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=730208#c18)• 13 years ago |
|  | |

Ok, here's a nasty one:
0 linux-gate.so + 0x424
1 firefox-bin!MOZ\_Crash [Assertions.cpp : 79 + 0x6]
2 firefox-bin!MOZ\_Assert [Assertions.cpp : 88 + 0x4]
3 libxul.so!js::ContextStack::pushDummyFrame [Stack.cpp : 843 + 0x1f]
4 libxul.so!js::AutoCompartment::enter [jswrapper.cpp : 474 + 0x19]
5 libxul.so!JS\_TransplantObject [jsapi.cpp : 1580 + 0x4]
6 libxul.so!nsGlobalWindow::SetNewDocument [nsGlobalWindow.cpp : 2087 + 0x1a]
I've already added UnmarkGray to all arguments to JS\_TransplantObject.
What is happening, assuming I am interpreting things correctly: you are calling JS\_TransplantObject(orig, target). That means you want to eat orig's brain with a spoon, then replace it with target. That means you also need to re-point any wrapper in any other compartment to the target object.
During that process, you find a wrapper[orig] in some random compartment. You create a new wrapper[target] in that same compartment, do a brain transplant with the original wrapper[orig], and replace wrapper[orig] in the crossCompartmentWrapperMap with wrapper[target].
Except that wrapper[orig]'s global object is gray, so before you get a chance to create wrapper[target] in this random compartment, you hit the assert.
So the question is, is the assert valid in this case? If the assert was not hit, the new wrapper would point to the same gray global, and that wrapper would point to the black target. So if the global can reach the wrapper, we have a problem. And I don't know of an existing way to unmark gray for an object and all wrappers that point to the object. Obviously, I could add one, but it seems pretty crazy. Though it's not surprising that object transplantation is a special case.
Does my analysis sound correct?

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=730208#c19)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #18](/show_bug.cgi?id=730208#c18 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Does my analysis sound correct?
Answer: no, it does not.
Well, I still think it's fine up until "if the global can reach the wrapper, we have a problem". That's not a problem; that's just a gray->black edge (or perhaps gray->white->black, but whatever.)
Assume the global is gray. Then before the transplant operation, the wrapper could not have been black, because the wrapper points to its global (via parent links) and we (theoretically) don't have black->gray edges. The transplant operation creates a new wrapper, which is white and therefore contains a scary but temporary white->gray edge, then it transplants the new wrapper's guts into the old wrapper and sanity is restored -- well, other than having a white zombie wrapper lying around with a pointer to a gray global. But that's actually a good thing, because it serves as a cool band name. Except you'd probably want to spell it White Zombie Rappers.
Anyway, nothing should be able to reach that white zombie wrapper, so it seems like the assertion is just noise. It does technically violate the invariant, though, so it would be nice if we could explicitly erase (exorcise?) the white zombie wrapper.
I'm about to post a patch that fixes the assertion by brute force: it iterates through all compartments' wrapper tables to find all wrappers[orig], and UnmarkGray's them. But now I'm thinking that maybe that's just extra work to shut up an unnecessary assertion, especially since it (incorrectly) ends up unmarking a global which is still unreachable from black and so ought to be gray.
I suppose I ought to at least make it DEBUG-only or something. But exorcism seems cleaner. I'll wait for an r-.Version: unspecified → Trunk

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=730208#c20)• 13 years ago |
|  | |

Attached patch

[Variety of places where we need to UnmarkGray objects that will be touched by the JSAPI, to prevent black -> gray edges.](attachment.cgi?id=605870&action=diff) (obsolete)
— [Details](attachment.cgi?id=605870&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605870)

[Attachment #605870](/attachment.cgi?id=605870&action=edit "Variety of places where we need to UnmarkGray objects that will be touched by the JSAPI, to prevent black -> gray edges.") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=730208#c21)• 13 years ago |
|  | |

Attached patch

[Root JSD's pet global so it can't participate in CC cycles](attachment.cgi?id=605871&action=diff) (obsolete)
— [Details](attachment.cgi?id=605871&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605871)

[Attachment #605871](/attachment.cgi?id=605871&action=edit "Root JSD's pet global so it can't participate in CC cycles") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=730208#c22)• 13 years ago |
|  | |

Attached patch

[patch6: UnmarkGray fixups for globals and contexts](attachment.cgi?id=605872&action=diff)
— [Details](attachment.cgi?id=605872&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605872)

A common source of potential black -> gray edges is JSAPI calls made on objects with gray globals or contexts holding gray globals. (The call could potentially update a black object with a pointer to that global.) This patch mostly traps places where contexts are used, and unmarks their globals. It also includes some more global unmarking.
[Attachment #605872](/attachment.cgi?id=605872&action=edit "patch6: UnmarkGray fixups for globals and contexts") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=730208#c23)• 13 years ago |
|  | |

Attached patch

[patch7: UnmarkGray for JS\_TransplantObject](attachment.cgi?id=605874&action=diff) (obsolete)
— [Details](attachment.cgi?id=605874&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605874)

Nasty case. JS\_TransplantObject swaps the brains of two JSObjects to maintain pointer identity. Unfortunately, that means updating all cross-compartment wrappers as well, and if some random compartment contains a wrapper for the target object, then a global from that compartment will be used to construct a new wrapper (which will then be transplanted into the old wrapper.) If that global is gray, then we end up with a temporary new wrapper (marked white), which points to the gray global, which will trigger an assertion failure even though it isn't a real problem.
[Attachment #605874](/attachment.cgi?id=605874&action=edit "patch7: UnmarkGray for JS_TransplantObject") -
Flags: review?(wmccloskey)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=730208#c24)• 13 years ago |
|  | |

I wonder if this will fix a problem I'm seeing in the CC, where we're needlessly visiting a gray JS Object (ChromeWindow) (and the stuff it holds onto) that is held alive by a currently displayed window.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1697670_359004)• 13 years ago |

[Attachment #600318](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") -
Attachment is obsolete: true
[Attachment #600318](/attachment.cgi?id=600318&action=edit "Various UnmarkGray fixes") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=730208#c25)• 13 years ago |
|  | |

Oops, sorry, I should've split up that first patch because it touches some random files in the tree well away from JS/xpconnect.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=730208#c26)• 13 years ago |
|  | |

Also note: this patch series is still not a complete solution. My current try push has 6 greens out of 10 total tests with the assertion patch applied. (I think it's 0/10 or 1/10 without these patches.)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=730208#c27)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #25](/show_bug.cgi?id=730208#c25 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Oops, sorry, I should've split up that first patch because it touches some
> random files in the tree well away from JS/xpconnect.
Yeah, I don't really feel comfortable reviewing the browser changes. Maybe ask peterv or smaug or bent? My main fear is that we'll suddenly be spending a lot of time in UnmarkGray when we start calling it on all these globals.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=730208#c28)• 13 years ago |
|  | |

What holds these globals? I've been thinking for CC speed reasons we may want to mark black all globals held by live windows, or some such thing.
The thing to remember is that the size of the CC graph is an upper bound on the number of gray objects, which is an upper bound on how many objects we have to ungray, and the CC graph has been getting smaller and smaller. Though the first CC cleanup phase can be pretty long, so maybe it would be bad if you end up doing all that work right after the GC and before that cleanup phase, at some random point in time where it is bad.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=730208#c29)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #28](/show_bug.cgi?id=730208#c28 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> What holds these globals? I've been thinking for CC speed reasons we may
> want to mark black all globals held by live windows, or some such thing.
This would be fantastic, and it would really help this bug.
> The thing to remember is that the size of the CC graph is an upper bound on
> the number of gray objects, which is an upper bound on how many objects we
> have to ungray, and the CC graph has been getting smaller and smaller.
> Though the first CC cleanup phase can be pretty long, so maybe it would be
> bad if you end up doing all that work right after the GC and before that
> cleanup phase, at some random point in time where it is bad.
Yeah, it's the time right after GC that I'm worried about.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=730208#c30)• 13 years ago |
|  | |

(In reply to Bill McCloskey (:billm) from [comment #29](/show_bug.cgi?id=730208#c29 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> (In reply to Andrew McCreight [:mccr8] from [comment #28](/show_bug.cgi?id=730208#c28 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> > What holds these globals? I've been thinking for CC speed reasons we may
> > want to mark black all globals held by live windows, or some such thing.
>
> This would be fantastic, and it would really help this bug.
>
> > The thing to remember is that the size of the CC graph is an upper bound on
> > the number of gray objects, which is an upper bound on how many objects we
> > have to ungray, and the CC graph has been getting smaller and smaller.
> > Though the first CC cleanup phase can be pretty long, so maybe it would be
> > bad if you end up doing all that work right after the GC and before that
> > cleanup phase, at some random point in time where it is bad.
>
> Yeah, it's the time right after GC that I'm worried about.
I hesitate to suggest anything that further complicates things, but could we finesse this? As in, if you UnmarkGray something after a GC and before a CC, it does a DeferredUnmarkGray on them, adding them (if non-black) to a list that is processed during the CC? You'd do it after marking live windows' globals black, so that most of them wouldn't do anything.
Hm, maybe that isn't entirely sound. You could (1) do a GC, (2) UnmarkGray a global, (3) reach through it to grab onto a gray object, (4) mutate the graph to remove all edges from the global to that gray object, then (5) run the CC. The recursive UnmarkGray would then fail to blacken the gray object.
Alternatively, what if live windows just rooted their globals via AddNamedRoot, and unrooted them in their destructors (or whatever finalizers are called in refcount-land)?

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=730208#c31)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #30](/show_bug.cgi?id=730208#c30 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Alternatively, what if live windows just rooted their globals via
> AddNamedRoot, and unrooted them in their destructors (or whatever finalizers
> are called in refcount-land)?
Oh. I think the answer is because the global could keep those windows alive. Unless there's some other way to tell when a live window dies that does not involve the object graph? If so, that's when we'd unroot.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=730208#c32)• 13 years ago |
|  | |

Yes, the black-gray problem is at its root just like incremental GC, and we need to have barriers in place. (read instead of write)
We know when a window is currently being displayed. We can use this information to mark everything reachable from it black. This does not give us 100% soundness, but it probably covers enough of the cases to reduce the number of gray objects in the common case, and reduce the cost of the read barriers.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=730208#c33)• 13 years ago |
|  | |

Attached patch

[patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges](attachment.cgi?id=606459&action=diff)
— [Details](attachment.cgi?id=606459&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606459)

[Attachment #606459](/attachment.cgi?id=606459&action=edit "patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges") -
Flags: review?(bugs)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=730208#c34)• 13 years ago |
|  | |

Attached patch

[UnmarkGray various JS objects to prevent them from being used to create black -> gray edges](attachment.cgi?id=606460&action=diff) (obsolete)
— [Details](attachment.cgi?id=606460&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606460)

Whoops, this is the same component as the other patch. I could've merged them. Oh well.
[Attachment #606460](/attachment.cgi?id=606460&action=edit "UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Flags: review?(bugs)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=730208#c35)• 13 years ago |
|  | |

Attached patch

[patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges](attachment.cgi?id=606464&action=diff)
— [Details](attachment.cgi?id=606464&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606464)

Sorry, this could've been merged into the other patch. I didn't realize it was the same component.
[Attachment #606464](/attachment.cgi?id=606464&action=edit "patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Flags: review?(bugs)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=730208#c36)• 13 years ago |
|  | |

Attached patch

[patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](attachment.cgi?id=606465&action=diff) (obsolete)
— [Details](attachment.cgi?id=606465&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465)

[Attachment #606465](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(bobbyholley+bmo)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=730208#c37)• 13 years ago |
|  | |

Attached patch

[patch5: Root JSD's pet global so it can't participate in CC cycles](attachment.cgi?id=606468&action=diff) (obsolete)
— [Details](attachment.cgi?id=606468&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606468)

There aren't really any active JSD reviewers, but this is only relevant to GC anyway.
[Attachment #606468](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1807984_359004)• 13 years ago |

[Attachment #605870](/attachment.cgi?id=605870&action=edit "Variety of places where we need to UnmarkGray objects that will be touched by the JSAPI, to prevent black -> gray edges.") -
Attachment is obsolete: true
[Attachment #605870](/attachment.cgi?id=605870&action=edit "Variety of places where we need to UnmarkGray objects that will be touched by the JSAPI, to prevent black -> gray edges.") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1808028_359004)• 13 years ago |

[Attachment #606460](/attachment.cgi?id=606460&action=edit "UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Attachment is obsolete: true
[Attachment #606460](/attachment.cgi?id=606460&action=edit "UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Flags: review?(bugs)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1832728_39966)• 13 years ago |

[Attachment #606459](/attachment.cgi?id=606459&action=edit "patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges") -
Flags: review?(bugs) → review+

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1832866_39966)• 13 years ago |

[Attachment #606464](/attachment.cgi?id=606464&action=edit "patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Flags: review?(bugs) → review+

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855514_359004)• 13 years ago |

[Attachment #605871](/attachment.cgi?id=605871&action=edit "Root JSD's pet global so it can't participate in CC cycles") -
Attachment is obsolete: true
[Attachment #605871](/attachment.cgi?id=605871&action=edit "Root JSD's pet global so it can't participate in CC cycles") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855709_359004)• 13 years ago |

[Attachment #606464](/attachment.cgi?id=606464&action=edit "patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges") -
Attachment description: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges → patch3: UnmarkGray various JS objects to prevent them from being used to create black -> gray edges

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855734_359004)• 13 years ago |

[Attachment #606468](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") -
Attachment description: Root JSD's pet global so it can't participate in CC cycles → patch5: Root JSD's pet global so it can't participate in CC cycles

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855767_359004)• 13 years ago |

[Attachment #605872](/attachment.cgi?id=605872&action=edit "patch6: UnmarkGray fixups for globals and contexts") -
Attachment description: UnmarkGray fixups for globals and contexts → patch6: UnmarkGray fixups for globals and contexts

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855791_359004)• 13 years ago |

[Attachment #605874](/attachment.cgi?id=605874&action=edit "patch7: UnmarkGray for JS_TransplantObject") -
Attachment description: UnmarkGray for JS\_TransplantObject → patch7: UnmarkGray for JS\_TransplantObject

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855817_359004)• 13 years ago |

[Attachment #606459](/attachment.cgi?id=606459&action=edit "patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges") -
Attachment description: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges → patch4: UnmarkGray the global object held by nsXULPDGlobalObject to avoid it being used to create black -> gray edges

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1855841_359004)• 13 years ago |

[Attachment #606465](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Attachment description: XPConnect changes to UnmarkGray some more objects and return them for convenience → patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=730208#c38)• 13 years ago |
|  | |

Comment on [attachment 606468](/attachment.cgi?id=606468 "patch5: Root JSD's pet global so it can't participate in CC cycles") [[details]](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") [[diff]](/attachment.cgi?id=606468&action=diff "patch5: Root JSD's pet global so it can't participate in CC cycles") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606468)
patch5: Root JSD's pet global so it can't participate in CC cycles
Review of [attachment 606468](/attachment.cgi?id=606468 "patch5: Root JSD's pet global so it can't participate in CC cycles") [[details]](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") [[diff]](/attachment.cgi?id=606468&action=diff "patch5: Root JSD's pet global so it can't participate in CC cycles") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606468):
-----------------------------------------------------------------
::: js/jsd/jsd\_high.c
@@ +170,5 @@
> return jsdc;
>
> label\_newJSDContext\_failure:
> if( jsdc ) {
> + JS\_RemoveObjectRoot(jsdc->dumbContext, &jsdc->glob);
I think this should be guarded by |if (jsdc->dumbContext)|.
[Attachment #606468](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") -
Flags: review?(wmccloskey) → review+

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=730208#c39)• 13 years ago |
|  | |

Attached patch

[patch1: Implement JS\_GetGCThingRuntime](attachment.cgi?id=606661&action=diff) (obsolete)
— [Details](attachment.cgi?id=606661&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606661)

Utility function needed for UnmarkGray stuff.
[Attachment #606661](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a1856043_359004)• 13 years ago |

[Attachment #606661](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") -
Attachment description: Implement JS\_GetGCThingRuntime → patch1: Implement JS\_GetGCThingRuntime
[Attachment #606661](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") -
Attachment filename: bug-730208-p1-unmark-gray-fixups → bug-730208-p1-getgcthingrt

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=730208#c40)• 13 years ago |
|  | |

Comment on [attachment 605872](/attachment.cgi?id=605872 "patch6: UnmarkGray fixups for globals and contexts") [[details]](/attachment.cgi?id=605872&action=edit "patch6: UnmarkGray fixups for globals and contexts") [[diff]](/attachment.cgi?id=605872&action=diff "patch6: UnmarkGray fixups for globals and contexts") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605872)
patch6: UnmarkGray fixups for globals and contexts
This seems fine to me, but I'd feel more comfortable if we wait to land it until [bug 736563](/show_bug.cgi?id=736563 "RESOLVED FIXED - Mark global objects black if they belong to an active window") (just filed) is fixed.
[Attachment #605872](/attachment.cgi?id=605872&action=edit "patch6: UnmarkGray fixups for globals and contexts") -
Flags: review?(wmccloskey) → review+

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=730208#c41)• 13 years ago |
|  | |

Comment on [attachment 606661](/attachment.cgi?id=606661 "patch1: Implement JS_GetGCThingRuntime") [[details]](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") [[diff]](/attachment.cgi?id=606661&action=diff "patch1: Implement JS_GetGCThingRuntime") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606661)
patch1: Implement JS\_GetGCThingRuntime
I don't think we need this. You should be able to do something like:
nsXPConnect::GetXPConnect()->GetRuntime()->GetJSRuntime()
(modulo some annoying null checks). This is actually pretty fast, so we don't have to worry about performance.
[Attachment #606661](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") -
Flags: review?(wmccloskey)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=730208#c42)• 13 years ago |
|  | |

Comment on [attachment 606465](/attachment.cgi?id=606465 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=606465&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
I think mccr8 would be a better reviewer here. I don't know a ton about the CC, and I don't have time at the moment to really do so. Hopefully I'll do that soon.
[Attachment #606465](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(bobbyholley+bmo) → review?(continuation)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=730208#c43)• 13 years ago |
|  | |

Comment on [attachment 606465](/attachment.cgi?id=606465 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=606465&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
Review of [attachment 606465](/attachment.cgi?id=606465 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=606465&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465):
-----------------------------------------------------------------
Which places that are using the functions in XPCLazyCallContext, XPCWrappedNativeScope and XPCWrappedNativeProto have had their behavior changed, and why is that okay? I don't really know anything about those classes. r- because I'd like to know more about that.
The places where you change the function look reasonable enough to me.
::: js/xpconnect/src/XPCWrappedNativeJSOps.cpp
@@ +651,4 @@
> NS\_ASSERTION(obj, "bad scope JSObject");
> JS\_CALL\_OBJECT\_TRACER(trc, obj, "XPCWrappedNativeScope::mGlobalJSObject");
>
> + obj = scope->GetPrototypeJSObjectPreserveColor();
You don't unmark gray here because you are just tracing through things and not returning anything?
::: js/xpconnect/src/XPCWrappedNativeScope.cpp
@@ +151,5 @@
> { // scoped lock
> XPCAutoLock lock(mRuntime->GetMapLock());
>
> #ifdef DEBUG
> for (XPCWrappedNativeScope\* cur = gScopes; cur; cur = cur->mNext)
You don't unmark gray here because the object isn't being returned, just examined for an internal property?
@@ +746,5 @@
>
> DEBUG\_TrackScopeTraversal();
>
> for (XPCWrappedNativeScope\* cur = gScopes; cur; cur = cur->mNext) {
> + if (obj == cur->GetGlobalJSObjectPreserveColor()) {
You don't unmark gray here because you aren't actually returning the object itself?
::: js/xpconnect/src/nsXPConnect.cpp
@@ +775,5 @@
> } while (thing);
> }
>
> void
> +xpc\_UnmarkGrayObjectRecursive(void \*thing, JSGCTraceKind kind)
please rename to xpc\_UnmarkGrayGCThingRecursive
@@ +780,2 @@
> {
> + NS\_ASSERTION(thing, "Don't pass me null!");
Probably should change this to MOZ\_ASSERT(thing) while you are here.
@@ +785,3 @@
>
> // Trace children.
> UnmarkGrayTracer trc;
This is a bit unfortunate. UnmarkGrayTracer is not really set up to trace shapes at the top level. It is probably okay to do, but I'm not 100% sure. But it looks like you never call it with a shape, so if you could add an assertion that kind != JSTRACE\_SHAPE, with a comment that UnmarkGrayTracer may not be safe for top level use with a shape, or something to that effect, that's good enough I think. If somebody wants to actually do that, Bill or I can think about it some more.
[Attachment #606465](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation) → review-

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=730208#c44)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #43](/show_bug.cgi?id=730208#c43 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Comment on [attachment 606465](/attachment.cgi?id=606465 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=606465&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465)
> patch2: XPConnect changes to UnmarkGray some more objects and return them
> for convenience
>
> Review of [attachment 606465](/attachment.cgi?id=606465 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=606465&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=606465):
> -----------------------------------------------------------------
>
> Which places that are using the functions in XPCLazyCallContext,
> XPCWrappedNativeScope and XPCWrappedNativeProto have had their behavior
> changed, and why is that okay? I don't really know anything about those
> classes. r- because I'd like to know more about that.
What do you mean by having their behavior changed? Other than the unmarking, they get the same object back as always. So the only behavior change possible would be not freeing a cycle because a JS object in the cycle got unmarked. (But if they're part of a garbage cycle, nothing should be looking at them, I would think.)
Or at least, that was my logic. Maybe I'm misunderstanding?
> The places where you change the function look reasonable enough to me.
>
> ::: js/xpconnect/src/XPCWrappedNativeJSOps.cpp
> @@ +651,4 @@
> > NS\_ASSERTION(obj, "bad scope JSObject");
> > JS\_CALL\_OBJECT\_TRACER(trc, obj, "XPCWrappedNativeScope::mGlobalJSObject");
> >
> > + obj = scope->GetPrototypeJSObjectPreserveColor();
>
> You don't unmark gray here because you are just tracing through things and
> not returning anything?
Don't mistake me for someone who knows what he's doing. :)
My thinking was mostly that mutating mark bits during tracing is a little funky, unless it's directly related to the traversal you're doing. Especially since any unnecessary unmarking could be slow. And it shouldn't be needed because the whole point here is to avoid getting a gray object and pointing a black one at it, and I assumed that you wouldn't be mutating the graph while tracing it.
>
> ::: js/xpconnect/src/XPCWrappedNativeScope.cpp
> @@ +151,5 @@
> > { // scoped lock
> > XPCAutoLock lock(mRuntime->GetMapLock());
> >
> > #ifdef DEBUG
> > for (XPCWrappedNativeScope\* cur = gScopes; cur; cur = cur->mNext)
>
> You don't unmark gray here because the object isn't being returned, just
> examined for an internal property?
If it were returning an internal property that could be used in a graph mutation, we'd want to unmark it. Given that this is DEBUG-only, it seems safe to assume that we don't need to unmark something that wouldn't be unmarked non-DEBUG. If you'll excuse the triple? negative.
>
> @@ +746,5 @@
> >
> > DEBUG\_TrackScopeTraversal();
> >
> > for (XPCWrappedNativeScope\* cur = gScopes; cur; cur = cur->mNext) {
> > + if (obj == cur->GetGlobalJSObjectPreserveColor()) {
>
> You don't unmark gray here because you aren't actually returning the object
> itself?
Yes. No possibility of problematic graph mutation if the caller isn't handed back a gray object to point something at.
>
> ::: js/xpconnect/src/nsXPConnect.cpp
> @@ +775,5 @@
> > } while (thing);
> > }
> >
> > void
> > +xpc\_UnmarkGrayObjectRecursive(void \*thing, JSGCTraceKind kind)
>
> please rename to xpc\_UnmarkGrayGCThingRecursive
Ok.
> @@ +780,2 @@
> > {
> > + NS\_ASSERTION(thing, "Don't pass me null!");
>
> Probably should change this to MOZ\_ASSERT(thing) while you are here.
Ok
> @@ +785,3 @@
> >
> > // Trace children.
> > UnmarkGrayTracer trc;
>
> This is a bit unfortunate. UnmarkGrayTracer is not really set up to trace
> shapes at the top level. It is probably okay to do, but I'm not 100% sure.
> But it looks like you never call it with a shape, so if you could add an
> assertion that kind != JSTRACE\_SHAPE, with a comment that UnmarkGrayTracer
> may not be safe for top level use with a shape, or something to that effect,
> that's good enough I think. If somebody wants to actually do that, Bill or
> I can think about it some more.
I don't know why shapes are special, but I don't know many things. Added an assert.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=730208#c45)• 13 years ago |
|  | |

Attached patch

[patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](attachment.cgi?id=607849&action=diff) (obsolete)
— [Details](attachment.cgi?id=607849&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849)

The question of behavior changes is still open, but I made the other changes. (Given that the r- was for the behavior changes, that doesn't mean much. But I'm happy to look into it if you can clarify what you're asking.)
[Attachment #606465](/attachment.cgi?id=606465&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Attachment is obsolete: true
[Attachment #606661](/attachment.cgi?id=606661&action=edit "patch1: Implement JS_GetGCThingRuntime") -
Attachment is obsolete: true
[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=730208#c46)• 13 years ago |
|  | |

(In reply to Steve Fink [:sfink] from [comment #44](/show_bug.cgi?id=730208#c44 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Or at least, that was my logic. Maybe I'm misunderstanding?
I guess that's true. Though I guess if you unmark during tracing that would be bad.
> My thinking was mostly that mutating mark bits during tracing is a little
> funky, unless it's directly related to the traversal you're doing.
> Especially since any unnecessary unmarking could be slow. And it shouldn't
> be needed because the whole point here is to avoid getting a gray object and
> pointing a black one at it, and I assumed that you wouldn't be mutating the
> graph while tracing it.
Yeah, I think you should never unmarkGray during tracing. I wonder if we could/should enforce that somehow.
> I don't know why shapes are special, but I don't know many things. Added an
> assert.
There are some optimizations in place for tracing shapes to avoid blowing up the stack that make things a little weird.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=730208#c47)• 13 years ago |
|  | |

Comment on [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
Review of [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849):
-----------------------------------------------------------------
Looks good. I'm going to look over the callers of the functions that are now unmark-graying, hopefully tomorrow morning, before I r+ it.
::: js/xpconnect/src/nsXPConnect.cpp
@@ +780,3 @@
> {
> + MOZ\_ASSERT(thing, "Don't pass me null!");
> + MOZ\_ASSERT(kind != JSTRACE\_SHAPE, "UnmarkGrayTracer not intended for Shapes");
I think xpc\_UnmarkGrayGCThingRecursing instead of UnmarkGrayTracer. It is okay to use UnmarkGrayTracer for shapes, just under more restricted circumstances. ;)
::: js/xpconnect/src/xpcpublic.h
@@ +194,5 @@
> + return obj;
> +}
> +
> +inline JSScript \*
> +xpc\_UnmarkGrayScript(JSScript \*script)
You should check with Bill if this new function also needs the IncrementalReferenceBarrier thing, which I don't know much about.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=730208#c48)• 13 years ago |
|  | |

Comment on [attachment 605874](/attachment.cgi?id=605874 "patch7: UnmarkGray for JS_TransplantObject") [[details]](/attachment.cgi?id=605874&action=edit "patch7: UnmarkGray for JS_TransplantObject") [[diff]](/attachment.cgi?id=605874&action=diff "patch7: UnmarkGray for JS_TransplantObject") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=605874)
patch7: UnmarkGray for JS\_TransplantObject
This seems like a pretty hard problem. I was hoping that compartment-per-global could somehow fix this. However, JS\_TransplantObject creates new wrappers (that will be black) and their global object will potentially be gray. I don't think this patch fixes that problem, and neither will c-p-g.
Rather than worry about the assertion, I think we should consider what new edges are actually being created by this function. As long as it doesn't create any black-to-gray edges, we can disable the grayness assertion locally (possibly with a check after the function runs that ensures that no wrappers have black-to-gray edges).
This function basically switches some wrapper pointers from orig to target. As long as orig and target are black (which can be ensured with UnmarkGray), this can't be bad. However, there are a few corner cases.
1. In some cases, rather than redirecting the pointers to orig or target, we redirect them to the existing wrapper for orig that is in the target compartment. Perhaps it makes sense for the JS\_TransplantObject callers to UnmarkGray this object as well if it exists. If we do this, we probably should have an XPConnect version of JS\_TransplantObject that safely handles the UnmarkGray calls. Everyone would just call that.
2. When we redirect wrappers, we do so by creating a new wrapper and then swapping it with the old wrapper. The new wrapper object will be black. After the swap it will point to whatever the old wrapper pointed to, including the global object, which could be gray. So this seems like a problem. One idea would be to color the new wrapper the same color as the existing wrapper. This kinda makes sense, and I think it solves the problem.
So this looks feasible to me. My recommendation would be to implement (1) and (2). Then we'll need to disable the grayness checker while JS\_TransplantObject is running. Maybe we should just have a counter in the runtime for how many invocations of JS\_TransplantObject are on the stack. We wouldn't assert if this is non-zero.
Finally, I think we should add a pretty heavyweight assertion at the end of JS\_TransplantObject. It would accumulate the set of all wrappers and objects touched, and then it would use a non-recursive JS\_TraceChildren call to look for black-to-gray edges. I won't be at all surprised if this finds some bugs since JS\_TransplantObject is pretty complicated.
[Attachment #605874](/attachment.cgi?id=605874&action=edit "patch7: UnmarkGray for JS_TransplantObject") -
Flags: review?(wmccloskey) → review-

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=730208#c49)• 13 years ago |
|  | |

Comment on [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
Bill, does this patch need an IncrementalReferenceBarrier sort of thing for xpc\_UnmarkGrayScript in the same way that xpc\_UnmarkGrayObject has?
[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: feedback?(wmccloskey)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=730208#c50)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #49](/show_bug.cgi?id=730208#c49 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Comment on [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849)
> patch2: XPConnect changes to UnmarkGray some more objects and return them
> for convenience
>
> Bill, does this patch need an IncrementalReferenceBarrier sort of thing for
> xpc\_UnmarkGrayScript in the same way that xpc\_UnmarkGrayObject has?
Yes it does. Any UnmarkGray call should also do the incremental check.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=730208#c51)• 13 years ago |
|  | |

Comment on [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
Review of [attachment 607849](/attachment.cgi?id=607849 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=607849&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=607849):
-----------------------------------------------------------------
r- due to the IncrementalReferenceBarrier thing that needs to be fixed. Otherwise, it looked fine to me. I glanced over the various places that the functions that now ungray are being called, and it didn't look like any of it was inside of any GC or CC related thing so they should be okay.
[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation)
[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review-
[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: feedback?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=730208#c52)• 13 years ago |
|  | |

Attached patch

[patch1: Implement IsIncrementalBarrierNeededOnScript](attachment.cgi?id=616338&action=diff)
— [Details](attachment.cgi?id=616338&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616338)

This is needed for xpc\_UnmarkGrayScript in the patch2 that I'm about to update, which is itself needed for patch3.
[Attachment #616338](/attachment.cgi?id=616338&action=edit "patch1: Implement IsIncrementalBarrierNeededOnScript") -
Flags: review?(wmccloskey)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=730208#c53)• 13 years ago |
|  | |

Attached patch

[patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](attachment.cgi?id=616339&action=diff) (obsolete)
— [Details](attachment.cgi?id=616339&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616339)

[Attachment #607849](/attachment.cgi?id=607849&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Attachment is obsolete: true
[Attachment #616339](/attachment.cgi?id=616339&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a4724048_359004)• 13 years ago |

[Attachment #616338](/attachment.cgi?id=616338&action=edit "patch1: Implement IsIncrementalBarrierNeededOnScript") -
Attachment description: Implement IsIncrementalBarrierNeededOnScript → patch1: Implement IsIncrementalBarrierNeededOnScript

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=730208#c54)• 13 years ago |
|  | |

Un-inlining xpc\_UnmarkGrayObject seems bad, especially since Boris is already complaining about how slow it is (see [bug 747066](/show_bug.cgi?id=747066 "RESOLVED FIXED - xpc_UnmarkGrayObject is slow")). Can you grab the runtime in \*Recursive and leave it inlined?

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=730208#c55)• 13 years ago |
|  | |

Attached patch

[patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience](attachment.cgi?id=616693&action=diff)
— [Details](attachment.cgi?id=616693&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616693)

Oops, was un-inlining xpc\_UnmarkGrayObject to grab the runtime.
[Attachment #616339](/attachment.cgi?id=616339&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Attachment is obsolete: true
[Attachment #616693](/attachment.cgi?id=616693&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation)
[Attachment #616339](/attachment.cgi?id=616339&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a4796733_389993)• 13 years ago |

[Attachment #616338](/attachment.cgi?id=616338&action=edit "patch1: Implement IsIncrementalBarrierNeededOnScript") -
Flags: review?(wmccloskey) → review+

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=730208#c56)• 13 years ago |
|  | |

Comment on [attachment 616693](/attachment.cgi?id=616693 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=616693&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=616693&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616693)
patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience
Review of [attachment 616693](/attachment.cgi?id=616693 "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[details]](/attachment.cgi?id=616693&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[diff]](/attachment.cgi?id=616693&action=diff "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=616693):
-----------------------------------------------------------------
::: js/xpconnect/src/nsXPConnect.cpp
@@ +784,4 @@
>
> // Trace children.
> UnmarkGrayTracer trc;
> + JSRuntime \*rt = nsXPConnect::GetXPConnect()->GetRuntime()->GetJSRuntime();
I think you can use nsXPConnect::GetRuntimeInstance()->GetJSRuntime() here, which looks like it is the same, but slightly shorter. No big deal.
::: js/xpconnect/src/xpcpublic.h
@@ +185,5 @@
> xpc\_UnmarkGrayObject(JSObject \*obj)
> {
> if (obj) {
> + if (xpc\_IsGrayGCThing(obj)) {
> + xpc\_UnmarkGrayGCThingRecursive(obj, JSTRACE\_OBJECT);
nit: You don't need to brace this if/then/else.
@@ +198,5 @@
> +xpc\_UnmarkGrayScript(JSScript \*script)
> +{
> + if (script) {
> + if (xpc\_IsGrayGCThing(script)) {
> + xpc\_UnmarkGrayGCThingRecursive(script, JSTRACE\_SCRIPT);
nit: You don't need to brace this if/then/else.
[Attachment #616693](/attachment.cgi?id=616693&action=edit "patch2: XPConnect changes to UnmarkGray some more objects and return them for convenience") -
Flags: review?(continuation) → review+

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=730208#c57)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/3ed6da4fe968>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/19c6e9e8fd23>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/00f27a773782>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/3c130fe45db0>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/f33dc9d93420>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/311b9a384ba9>
This bug can be resolved when these are merged. I landed all attachments except the initial "aggressive asserts" one (because not all problems are fixed) and the transplant one, which I'll do in another bug.Target Milestone: --- → mozilla15

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=730208#c58)• 13 years ago |
|  | |

Oops. Except I didn't notice that this got backed out:
<https://hg.mozilla.org/integration/mozilla-inbound/rev/cecc9064c6cb>
for breaking xpcshell tests in debug builds, which looks like it must have been a PITA to track down given all of the intervening failures and lack of test runs. Sorry about that; I thought I'd run everything in the final push through try.Target Milestone: mozilla15 → ---

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=730208#c59)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/3ed6da4fe968>
<https://hg.mozilla.org/mozilla-central/rev/19c6e9e8fd23>
<https://hg.mozilla.org/mozilla-central/rev/00f27a773782>
<https://hg.mozilla.org/mozilla-central/rev/3c130fe45db0>
<https://hg.mozilla.org/mozilla-central/rev/f33dc9d93420>
<https://hg.mozilla.org/mozilla-central/rev/311b9a384ba9>Status: NEW → RESOLVEDClosed: 13 years agoResolution: --- → FIXEDTarget Milestone: --- → mozilla15

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=730208#c60)• 13 years ago |
|  | |

Backed out: <https://hg.mozilla.org/mozilla-central/rev/cecc9064c6cb>Status: RESOLVED → REOPENEDResolution: FIXED → ---

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=730208#c61)• 13 years ago |
|  | |

Attached patch

[patch5: Root JSD's pet global so it can't participate in gray CC cycles](attachment.cgi?id=619112&action=diff)
— [Details](attachment.cgi?id=619112&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=619112)

Request re-review because removing the root could be done outside of a request.
[Attachment #606468](/attachment.cgi?id=606468&action=edit "patch5: Root JSD's pet global so it can't participate in CC cycles") -
Attachment is obsolete: true
[Attachment #619112](/attachment.cgi?id=619112&action=edit "patch5: Root JSD's pet global so it can't participate in gray CC cycles") -
Flags: review?(wmccloskey)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=730208#c62)• 13 years ago |
|  | |

Comment on [attachment 619112](/attachment.cgi?id=619112 "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[details]](/attachment.cgi?id=619112&action=edit "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[diff]](/attachment.cgi?id=619112&action=diff "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=619112)
patch5: Root JSD's pet global so it can't participate in gray CC cycles
Assuming you can easily get your hands on a runtime, it's probably better to use JS\_RemoveObjectRootRT here. Then you wouldn't need a request. The other rooting functions could be changed too, although they don't have to be.
[Attachment #619112](/attachment.cgi?id=619112&action=edit "patch5: Root JSD's pet global so it can't participate in gray CC cycles") -
Flags: review?(wmccloskey) → review+

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=730208#c63)• 13 years ago |
|  | |

(In reply to Bill McCloskey (:billm) from [comment #62](/show_bug.cgi?id=730208#c62 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Comment on [attachment 619112](/attachment.cgi?id=619112 "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[details]](/attachment.cgi?id=619112&action=edit "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[diff]](/attachment.cgi?id=619112&action=diff "patch5: Root JSD's pet global so it can't participate in gray CC cycles") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=619112)
> patch5: Root JSD's pet global so it can't participate in gray CC cycles
>
> Assuming you can easily get your hands on a runtime, it's probably better to
> use JS\_RemoveObjectRootRT here. Then you wouldn't need a request. The other
> rooting functions could be changed too, although they don't have to be.
Oh, great, thanks! I didn't know about that one. I have a context, so a runtime is just a JS\_GetRuntime away.
I'll change the other one too, even though at the moment it's guaranteed to be in a request. But that's brittle wrt future changes.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=730208#c64)• 13 years ago |
|  | |

Attached patch

[path7: UnmarkGray for component loader](attachment.cgi?id=620517&action=diff) (obsolete)
— [Details](attachment.cgi?id=620517&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517)

As long as I can't commit due to the tree closure, I may as well pile on one more of these patches. This fixes mozJSComponentLoader.
[Attachment #605874](/attachment.cgi?id=605874&action=edit "patch7: UnmarkGray for JS_TransplantObject") -
Attachment is obsolete: true
[Attachment #620517](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") -
Flags: review?(continuation)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=730208#c65)• 13 years ago |
|  | |

Comment on [attachment 620517](/attachment.cgi?id=620517 "path7: UnmarkGray for component loader") [[details]](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") [[diff]](/attachment.cgi?id=620517&action=diff "path7: UnmarkGray for component loader") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517)
path7: UnmarkGray for component loader
Review of [attachment 620517](/attachment.cgi?id=620517 "path7: UnmarkGray for component loader") [[details]](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") [[diff]](/attachment.cgi?id=620517&action=diff "path7: UnmarkGray for component loader") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517):
-----------------------------------------------------------------
::: js/xpconnect/loader/mozJSComponentLoader.h
@@ +134,5 @@
>
> JSAutoEnterCompartment ac;
> ac.enterAndIgnoreErrors(sSelf->mContext, global);
>
> + JS\_ClearScope(sSelf->mContext, xpc\_UnmarkGrayObject(global));
Does anything "escape" from clear scope? I thought it would just delete some properties, not copy them out.

|  | [Curtis Koenig [:curtisk-use curtis.koenig+bzATgmail.com]]](/user_profile?user_id=406847) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a6004358_406847)• 13 years ago |

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=730208#c66)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #65](/show_bug.cgi?id=730208#c65 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> Comment on [attachment 620517](/attachment.cgi?id=620517 "path7: UnmarkGray for component loader") [[details]](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") [[diff]](/attachment.cgi?id=620517&action=diff "path7: UnmarkGray for component loader") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517)
> path7: UnmarkGray for component loader
>
> Review of [attachment 620517](/attachment.cgi?id=620517 "path7: UnmarkGray for component loader") [[details]](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") [[diff]](/attachment.cgi?id=620517&action=diff "path7: UnmarkGray for component loader") [[review]](/page.cgi?id=splinter.html&ignore=&bug=730208&attachment=620517):
> -----------------------------------------------------------------
>
> ::: js/xpconnect/loader/mozJSComponentLoader.h
> @@ +134,5 @@
> >
> > JSAutoEnterCompartment ac;
> > ac.enterAndIgnoreErrors(sSelf->mContext, global);
> >
> > + JS\_ClearScope(sSelf->mContext, xpc\_UnmarkGrayObject(global));
>
> Does anything "escape" from clear scope? I thought it would just delete
> some properties, not copy them out.
Um... er... well, ok, you have a point. I don't see how this could ever cause black->gray.
On the other hand, this trips the assertion, and I'm not sure if I want to come up with a way of conditionally disabling the assert. Maybe I'll make this DEBUG-only.
What if an exception was triggered? I wonder if the exception could hold onto gray objects. In this case, it still wouldn't matter, because of the enterAndIgnoreErrors which I assume does a clearPendingException.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=730208#c67)• 13 years ago |
|  | |

What assertion specifically is it triggering and where? I'm not really that familiar with JS\_ClearScope.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=730208#c68)• 13 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #67](/show_bug.cgi?id=730208#c67 "RESOLVED FIXED - Hunt down black -> gray edges in the JS heap"))
> What assertion specifically is it triggering and where? I'm not really that
> familiar with JS\_ClearScope.
Huh? No, that was just me speculating on tricky ways that things can escape, and it's not even relevant here because we nuke the exception. But I assume you could get eg an OOM exception. I don't know how much stuff exceptions can point to, but come to think of it the exception object itself would point to the global, and that's enough.
Anyway, I'm going to just delete this patch from the attachments list, because it's only relevant to detecting the leaks. I'll merge it with the patch that adds the asserts.

|  | [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a6020281_359004)• 13 years ago |

[Attachment #620517](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") -
Attachment is obsolete: true
[Attachment #620517](/attachment.cgi?id=620517&action=edit "path7: UnmarkGray for component loader") -
Flags: review?(continuation)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=730208#c69)• 13 years ago |
|  | |

backporting this to ESR (or even Aurora) doesn't seem sane or worth the risk of regression. If we find a specific abuse of this problem we can figure out how to deal with it then.
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix)

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=730208#c70)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/3ac9d5b00a61>
<https://hg.mozilla.org/mozilla-central/rev/2cf654124beb>
<https://hg.mozilla.org/mozilla-central/rev/defb50779980>
<https://hg.mozilla.org/mozilla-central/rev/74c90cb52930>
<https://hg.mozilla.org/mozilla-central/rev/3cc705cca95b>
<https://hg.mozilla.org/mozilla-central/rev/2e603a571520>Status: REOPENED → RESOLVEDClosed: 13 years ago → 13 years ago
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a6116660_11608)• 13 years ago |

Depends on: [752081](/show_bug.cgi?id=752081 "VERIFIED FIXED - \"Assertion failure: invalid trace kind\" with incremental GC and multiple browser windows")

|  | [:Irving Reid (No longer working on Firefox)](/user_profile?user_id=420324) |  |
| --- | --- | --- |
| [Comment 71](/show_bug.cgi?id=730208#c71)• 13 years ago |
|  | |

Changeset <https://hg.mozilla.org/mozilla-central/rev/2e603a571520> caused Thunderbird to start printing many warnings:
JavaScript error: , line 0: nothing active on context
See [https://bugzilla.mozilla.org/show\_bug.cgi?id=752250](/show_bug.cgi?id=752250 "RESOLVED FIXED - Thunderbird stderr prints many messages: JavaScript error: , line 0: nothing active on context")
At first glance, it looks like the global object in the Javascript context isn't set up properly.
Any advice on how to resolve this in Thunderbird?See Also: → [752250](/show_bug.cgi?id=752250 "RESOLVED FIXED - Thunderbird stderr prints many messages: JavaScript error: , line 0: nothing active on context")

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 72](/show_bug.cgi?id=730208#c72)• 13 years ago |
|  | |

Now that CPG has landed, we should think about doing the UnmarkGray inside AutoCompartment::enter. I talked this over with Luke, and I think the way we want to do it is as follows:
bool
AutoCompartment::enter()
{
JS\_ASSERT(!entered);
if (origin != destination) {
JSObject &scopeChain = target->global();
// ...
if (scopeChain.isMarked(GRAY) ||
scopeChain.compartment()->rt->gcIncrementalState == MARK)
{
(\*scopeChain.compartment()->rt->enterGrayGlobal)(&scopeChain);
}
}
entered = true;
return true;
}
The enterGrayGlobal would be a callback implemented by XPConnect that would call xpc\_UnmarkGray on the global. It's a little gross, but it seems like a fairly complete solution to our problems.

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a6634841_11608)• 13 years ago |

Depends on: [752250](/show_bug.cgi?id=752250 "RESOLVED FIXED - Thunderbird stderr prints many messages: JavaScript error: , line 0: nothing active on context")

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 73](/show_bug.cgi?id=730208#c73)• 13 years ago |
|  | |

I assume that there is nothing to do done here to specifically verify this fix?

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a13693495_336670)• 12 years ago |

Depends on: [776497](/show_bug.cgi?id=776497 "RESOLVED FIXED - crash in nsGlobalWindow::SetNewDocument")

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a14317492_280903)• 12 years ago |

Whiteboard: [sg:moderate] → [sg:moderate][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=730208#a20815399_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=730208&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Steve Fink [:sfink] [:s:]](/user_profile?user_id=359004)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.ubuntu.com_da551876_20250125_013414.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-1548-2: Firefox regression

11 September 2012

USN-1548-1 introduced a regression in Firefox.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 12.04](/security/notices?release=precise)
* [Ubuntu 11.10](/security/notices?release=oneiric)
* [Ubuntu 11.04](/security/notices?release=natty)
* [Ubuntu 10.04](/security/notices?release=lucid)

## Packages

* [firefox](/security/cves?package=firefox) - Mozilla Open Source web browser

## Details

USN-1548-1 fixed vulnerabilities in Firefox. The new package caused a

regression in Private Browsing which could leak sites visited to the

browser cache. This update fixes the problem.

Original advisory details:

Gary Kwong, Christian Holler, Jesse Ruderman, Steve Fink, Bob Clary, Andrew

Sutherland, Jason Smith, John Schoenick, Vladimir Vukicevic and Daniel

Holbert discovered memory safety issues affecting Firefox. If the user were

tricked into opening a specially crafted page, an attacker could exploit

these to cause a denial of service via application crash, or potentially

execute code with the privileges of the user invoking Firefox.

([CVE-2012-1970](/security/CVE-2012-1970), [CVE-2012-1971](/security/CVE-2012-1971))

Abhishek Arya discovered multiple use-after-free vulnerabilities. If the

user were tricked into opening a specially crafted page, an attacker could

exploit these to cause a denial of service via application crash, or

potentially execute code with the privileges of the user invoking Firefox.

([CVE-2012-1972](/security/CVE-2012-1972), [CVE-2012-1973](/security/CVE-2012-1973), [CVE-2012-1974](/security/CVE-2012-1974), [CVE-2012-1975](/security/CVE-2012-1975), [CVE-2012-1976](/security/CVE-2012-1976),

[CVE-2012-3956](/security/CVE-2012-3956), [CVE-2012-3957](/security/CVE-2012-3957), [CVE-2012-3958](/security/CVE-2012-3958), [CVE-2012-3959](/security/CVE-2012-3959), [CVE-2012-3960](/security/CVE-2012-3960),

[CVE-2012-3961](/security/CVE-2012-3961), [CVE-2012-3962](/security/CVE-2012-3962), [CVE-2012-3963](/security/CVE-2012-3963), [CVE-2012-3964](/security/CVE-2012-3964))

Mariusz Mlynsk discovered that it is possible to shadow the location object

using Object.defineProperty. This could potentially result in a cross-site

scripting (XSS) attack against plugins. With cross-site scripting

vulnerabilities, if a user were tricked into viewing a specially crafted

page, a remote attacker could exploit this to modify the contents or steal

confidential data within the same domain. ([CVE-2012-1956](/security/CVE-2012-1956))

Mariusz Mlynski discovered an escalation of privilege vulnerability through

about:newtab. This could possibly lead to potentially code execution with

the privileges of the user invoking Firefox. ([CVE-2012-3965](/security/CVE-2012-3965))

Frédéric Hoguin discovered that bitmap format images with a negative height

could potentially result in memory corruption. If the user were tricked

into opening a specially crafted image, an attacker could exploit

this to cause a denial of service via application crash, or potentially

execute code with the privileges of the user invoking Firefox.

([CVE-2012-3966](/security/CVE-2012-3966))

It was discovered that Firefox's WebGL implementation was vulnerable to

multiple memory safety issues. If the user were tricked into opening a

specially crafted page, an attacker could exploit these to cause a denial

of service via application crash, or potentially execute code with the

privileges of the user invoking Firefox. ([CVE-2012-3967](/security/CVE-2012-3967), [CVE-2012-3968](/security/CVE-2012-3968))

Arthur Gerkis discovered multiple memory safety issues in Firefox's

Scalable Vector Graphics (SVG) implementation. If the user were tricked

into opening a specially crafted image, an attacker could exploit these to

cause a denial of service via application crash, or potentially execute

code with the privileges of the user invoking Firefox. ([CVE-2012-3969](/security/CVE-2012-3969),

[CVE-2012-3970](/security/CVE-2012-3970))

Christoph Diehl discovered multiple memory safety issues in the bundled

Graphite 2 library. If the user were tricked into opening a specially

crafted page, an attacker could exploit these to cause a denial of service

via application crash, or potentially execute code with the privileges of

the user invoking Firefox. ([CVE-2012-3971](/security/CVE-2012-3971))

Nicolas Grégoire discovered an out-of-bounds read in the format-number

feature of XSLT. This could potentially cause inaccurate formatting of

numbers and information leakage. ([CVE-2012-3972](/security/CVE-2012-3972))

Mark Goodwin discovered that under certain circumstances, Firefox's

developer tools could allow remote debugging even when disabled.

([CVE-2012-3973](/security/CVE-2012-3973))

It was discovered that when the DOMParser is used to parse text/html data

in a Firefox extension, linked resources within this HTML data will be

loaded. If the data being parsed in the extension is untrusted, it could

lead to information leakage and potentially be combined with other attacks

to become exploitable. ([CVE-2012-3975](/security/CVE-2012-3975))

Mark Poticha discovered that under certain circumstances incorrect SSL

certificate information can be displayed on the addressbar, showing the SSL

data for a previous site while another has been loaded. This could

potentially be used for phishing attacks. ([CVE-2012-3976](/security/CVE-2012-3976))

It was discovered that, in some instances, certain security checks in the

location object could be bypassed. This could allow for the loading of

restricted content and can potentially be combined with other issues to

become exploitable. ([CVE-2012-3978](/security/CVE-2012-3978))

Colby Russell discovered that eval in the web console can execute injected

code with chrome privileges, leading to the running of malicious code in a

privileged context. If the user were tricked into opening a specially

crafted page, an attacker could exploit this to cause a denial of service

via application crash, or potentially execute code with the privileges of

the user invoking Firefox. ([CVE-2012-3980](/security/CVE-2012-3980))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 12.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0.1+build1-0ubuntu0.12.04.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0.1%2Bbuild1-0ubuntu0.12.04.1)

##### Ubuntu 11.10

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0.1+build1-0ubuntu0.11.10.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0.1%2Bbuild1-0ubuntu0.11.10.1)

##### Ubuntu 11.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0.1+build1-0ubuntu0.11.04.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0.1%2Bbuild1-0ubuntu0.11.04.1)

##### Ubuntu 10.04

* [firefox](https://launchpad.net/ubuntu/%2Bsource/firefox)
  -
  [15.0.1+build1-0ubuntu0.10.04.1](https://launchpad.net/ubuntu/%2Bsource/firefox/15.0.1%2Bbuild1-0ubuntu0.10.04.1)

After a standard system update you need to restart Firefox to make

all the necessary changes.

## References

* <https://launchpad.net/bugs/1047667>

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from www.mozilla.org_1592a60a_20250125_013410.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2012-57

## Miscellaneous memory safety hazards (rv:15.0/ rv:10.0.7)

Announced
August 28, 2012
Reporter
Mozilla Developers
Impact
Critical
Products
Firefox, Firefox ESR, SeaMonkey, Thunderbird, Thunderbird ESR
Fixed in

* Firefox 15
* Firefox ESR 10.0.7
* SeaMonkey 2.12
* Thunderbird 15
* Thunderbird ESR 10.0.7

### Description

Mozilla developers identified and fixed several memory safety bugs in the
browser engine used in Firefox and other Mozilla-based products. Some of these
bugs showed evidence of memory corruption under certain circumstances, and we
presume that with enough effort at least some of these could be exploited to run
arbitrary code.

In general these flaws cannot be exploited through email in the Thunderbird
and SeaMonkey products because scripting is disabled, but are potentially a risk
in browser or browser-like contexts in those products.

### References

Gary Kwong, Christian Holler, Jesse Ruderman, Steve Fink, Bob Clary, and Andrew
Sutherland reported memory safety problems and crashes that
affect Firefox 14.

* [Memory safety bugs fixed in Firefox 15](https://bugzilla.mozilla.org/buglist.cgi?bug_id=719750,748119,749039,754150,754242,732870,752038,753162,755916,780712,730208,779849,752087,765936)
* [CVE-2012-1971](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1971)

Gary Kwong, Christian Holler, Jesse Ruderman, John Schoenick, Vladimir
Vukicevic, Daniel Holbert, and Jason Smith reported memory safety problems and crashes that affect Firefox ESR 10 and Firefox 14.

* [Memory safety bugs fixed in Firefox ESR 10.0.7 and Firefox 15](https://bugzilla.mozilla.org/buglist.cgi?bug_id=745158,758408,761831,764176,777806,775206,778765,773097)
* [CVE-2012-1970](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1970)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.2/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_95e98c64_20250125_013438.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/754150)
* [XML](/show_bug.cgi?ctype=xml&id=754150)

Closed
[Bug 754150](/show_bug.cgi?id=754150)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(thing)), at js/src/jsgc.cpp:4399

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(thing)), at js/src/jsgc.cpp:4399

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=unaffected) |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 |  | unaffected |
| firefox14 | + | affected |
| firefox15 |  | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: billm)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/81db2831554209472ec9b0d5485ca1c9?d=mm&size=40)  [billm](/user_profile?user_id=389993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-critical, testcase, Whiteboard: [sg:critical][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [decoder](/user_profile?user_id=395101) | [in-testsuite](#c8 "12 years ago") | + |
| --- | --- | --- |
| [decoder](/user_profile?user_id=395101) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [patch](/attachment.cgi?id=623280)  [13 years ago](#c1)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   2.98 KB, patch | bhackett1024 : [review+](#a301401_346231 "13 years ago") | [Details](/attachment.cgi?id=623280&action=edit) | [Diff](/attachment.cgi?id=623280&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=754150&attachment=623280) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=754150#c0)• 13 years ago |
|  | |

The following test asserts on mozilla-central revision 4c6d01c92dcc (options -m -n):
function printStatus (msg) {}
function toPrinted(value) {
value = value.replace(/\\n/g, 'NL')
}
function reportCompare (expected, actual, description) {
printStatus ("Expected value '" + toPrinted(expected) + "' matched actual value '" + toPrinted(actual) + "'");
}
var UBound = 0;
var statusitems = [];
var actual = '';
var actualvalues = [];
var expect= '';
var expectedvalues = [];
testThis('x()');
testThis('"abc"()');
testThis('x()');
testThis('Date(12345)()');
testThis('x()');
testThis('1()');
testThis('x()');
testThis('void(0)()');
testThis('x()');
testThis('[1,2,3,4,5](1)');
gczeal(4);
testThis('x(1)');
checkThis('(function (y) {return y+1;})("abc")');
checkThis('f("abc")');
function testThis(sInvalidSyntax) {
expectedvalues[UBound] = expect;
actualvalues[UBound] = actual;
UBound++;
}
function checkThis(sValidSyntax) {
for (var i=0; i<UBound; i++)
reportCompare(expectedvalues[i], actualvalues[i], statusitems[i]);
}
var actualvalues = [];
for (var i=0; i<UBound; i++)
reportCompare(expectedvalues[i], actualvalues[i], statusitems[i]);
Might be another verifier (debug-only) bug, but I'm marking s-s until this is confirmed.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a45_389993)• 13 years ago |

Assignee: general → wmccloskey

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=754150#c1)• 13 years ago |
|  | |

Attached patch

[patch](attachment.cgi?id=623280&action=diff)
— [Details](attachment.cgi?id=623280&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=754150&attachment=623280)

We need a write barrier on the objects held by a JITChunk, since the JITChunk can be destroyed during an incremental slice.
[Attachment #623280](/attachment.cgi?id=623280&action=edit "patch") -
Flags: review?(bhackett1024)

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a301401_346231)• 13 years ago |

[Attachment #623280](/attachment.cgi?id=623280&action=edit "patch") -
Flags: review?(bhackett1024) → review+

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=754150#c2)• 13 years ago |
|  | |

Can we land this now? The fuzzer is being spammed with these asserts and I don't even know for which of them this bug accounts.
Also, given the description in [comment 1](/show_bug.cgi?id=754150#c1 "VERIFIED FIXED - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(thing)), at js/src/jsgc.cpp:4399"), I assume this can lead to use-after-free of JITChunk? Or is this a save assert?Whiteboard: [fuzzblocker]

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=754150#c3)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/f36749114f76>
Yes, during an incremental GC this can lead to use-after-free.Target Milestone: --- → mozilla15

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a503020_395101)• 13 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)Whiteboard: [fuzzblocker] → [sg:critical]

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=754150#c4)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/f36749114f76>Status: NEW → RESOLVEDClosed: 13 years ago
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=754150#c5)• 13 years ago |
|  | |

We should get this fix landed on Aurora unless we plan to disable incremental GC on that branch.
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=unaffected)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=754150#c6)• 13 years ago |
|  | |

Incremental GC is disabled on Aurora (at least, prefed off).

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=754150#c7)• 13 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a636328_395101)• 13 years ago |

Status: RESOLVED → VERIFIED

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a7686028_280903)• 12 years ago |

Whiteboard: [sg:critical] → [sg:critical][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754150#a14182178_1689)• 12 years ago |

Group: core-security

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=754150#c8)• 12 years ago |
|  | |

A testcase for this bug was automatically identified at js/src/jit-test/tests/basic/[bug754150](/show_bug.cgi?id=754150 "VERIFIED FIXED - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(thing)), at js/src/jsgc.cpp:4399").js.Flags: in-testsuite+
You need to [log in](/show_bug.cgi?id=754150&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_e55532af_20250125_013424.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/732870)
* [XML](/show_bug.cgi?ctype=xml&id=732870)

Closed
[Bug 732870](/show_bug.cgi?id=732870)

Opened 13 years ago
Closed 13 years ago

# "ASSERTION: Weird scope returned" with document.write twice, dataset, adoptNode

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

"ASSERTION: Weird scope returned" with document.write twice, dataset, adoptNode

## Categories

### (Core :: XPConnect, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=XPConnect#XPConnect)

XPConnect
▾

Core :: XPConnect
Facilitates calling between JavaScript and XPCOM components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=XPConnect)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla16

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix) |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox16 | [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) |
| firefox-esr10 | [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | + | wontfix |
| firefox15 | + | fixed |
| firefox16 | + | fixed |
| firefox-esr10 | - | wontfix |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jruderman, Assigned: bholley)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/ac57223c49d41049a4917e187b854377?d=mm&size=40)  [bholley](/user_profile?user_id=313730)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d2dc9227eafcd0ec5ba3712ee4f19b75?d=mm&size=40)  [jruderman](/user_profile?user_id=11608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/5111b810214a00377104f5ad3efefa26?d=mm&size=40)  [sefeng](/user_profile?user_id=625922)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

9 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-high, testcase, Whiteboard: [fuzzblocker:compartment-mismatch][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[fuzzblocker:compartment-mismatch][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files, 1 obsolete file)

| [testcase](/attachment.cgi?id=602792)  [13 years ago](#c0)  [Jesse Ruderman](/user_profile?user_id=11608)   400 bytes, text/html |  | [Details](/attachment.cgi?id=602792&action=edit) |
| --- | --- | --- |
| [stack trace](/attachment.cgi?id=602793)  [13 years ago](#c1)  [Jesse Ruderman](/user_profile?user_id=11608)   2.64 KB, text/plain |  | [Details](/attachment.cgi?id=602793&action=edit) |
| [testcase 2](/attachment.cgi?id=631713)  [13 years ago](#c4)  [Jesse Ruderman](/user_profile?user_id=11608)   357 bytes, text/html |  | [Details](/attachment.cgi?id=631713&action=edit) |
| [stack traces 2](/attachment.cgi?id=631714)  [13 years ago](#c5)  [Jesse Ruderman](/user_profile?user_id=11608)   27.45 KB, text/plain |  | [Details](/attachment.cgi?id=631714&action=edit) |
| [Have nsDOMStringMapSH::PreCreate use the document as the parent, rather than the window. v1](/attachment.cgi?id=634325)  [13 years ago](#c8)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   2.38 KB, patch | peterv : [review+](#a9183955_24295 "13 years ago") | [Details](/attachment.cgi?id=634325&action=edit) | [Diff](/attachment.cgi?id=634325&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634325) |
| [Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2](/attachment.cgi?id=634343)  [13 years ago](#c10)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   2.54 KB, patch | peterv : [review+](#a9310341_24295 "13 years ago")  akeybl : [approval-mozilla-aurora+](#c21 "13 years ago") | [Details](/attachment.cgi?id=634343&action=edit) | [Diff](/attachment.cgi?id=634343&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634343) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=732870#c0)• 13 years ago |
|  | |

Attached file
[testcase](attachment.cgi?id=602792)
— [Details](attachment.cgi?id=602792&action=edit)

###!!! ASSERTION: Weird scope returned: 'betterScope == newScope', file js/xpconnect/src/nsXPConnect.cpp, line 1771
(Previous episodes: [bug 716383](/show_bug.cgi?id=716383 "RESOLVED DUPLICATE - \"ASSERTION: Weird scope returned\" with document.write twice"), [bug 731471](/show_bug.cgi?id=731471 "RESOLVED FIXED - Don't reparent wrappers that don't want to move").)

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=732870#c1)• 13 years ago |
|  | |

Attached file
[stack trace](attachment.cgi?id=602793)
— [Details](attachment.cgi?id=602793&action=edit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=732870#c2)• 13 years ago |
|  | |

Still affects 16.

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=732870#c3)• 13 years ago |
|  | |

Now it also triggers:
Assertion failure: compartment mismatched, at js/src/jscntxtinlines.h:237

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=732870#c4)• 13 years ago |
|  | |

Attached file
[testcase 2](attachment.cgi?id=631713)
— [Details](attachment.cgi?id=631713&action=edit)

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=732870#c5)• 13 years ago |
|  | |

Attached file
[stack traces 2](attachment.cgi?id=631714)
— [Details](attachment.cgi?id=631714&action=edit)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=732870#c6)• 13 years ago |
|  | |

I'll try to take a look at this.Assignee: nobody → bobbyholley+bmo

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a9141592_11608)• 13 years ago |

Whiteboard: [fuzzblocker:compartment-mismatch]

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=732870#c7)• 13 years ago |
|  | |

So the issue here is that nsDOMStringMapSH::PreCreate uses its ownerDocument to find the parent, but requests to be parented directly to the window. This breaks our orphan detection over in [bug 751995](/show_bug.cgi?id=751995 "VERIFIED FIXED - Compartment mismatch with adoptNode, style"), because the wrapper isn't orphaned: It's still in the scope of the window, which is its parent. But since PreCreate finds the window via the document (which has moved), calling PreCreate again will give a different answer.
I don't see any obvious reason why nsDOMStringMap wrappers can't just be parented to the document, like Node. I've got a patch to do this that I'll upload and pushed to try.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=732870#c8)• 13 years ago |
|  | |

Attached patch

[Have nsDOMStringMapSH::PreCreate use the document as the parent, rather than the window. v1](attachment.cgi?id=634325&action=diff) (obsolete)
— [Details](attachment.cgi?id=634325&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634325)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=732870#c9)• 13 years ago |
|  | |

Pushed to try: <https://tbpl.mozilla.org/?tree=Try&rev=dd59a366d436>

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a9183500_313730)• 13 years ago |

[Attachment #634325](/attachment.cgi?id=634325&action=edit "Have nsDOMStringMapSH::PreCreate use the document as the parent, rather than the window. v1") -
Flags: review?(peterv)

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a9183955_24295)• 13 years ago |

[Attachment #634325](/attachment.cgi?id=634325&action=edit "Have nsDOMStringMapSH::PreCreate use the document as the parent, rather than the window. v1") -
Flags: review?(peterv) → review+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=732870#c10)• 13 years ago |
|  | |

Attached patch

[Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2](attachment.cgi?id=634343&action=diff)
— [Details](attachment.cgi?id=634343&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634343)

Arg, this wasn't quite right. The crashtest is non-deterministic (since it depends the order in which wrappers are reparented), so I didn't realize that this wasn't fixed in all cases.
The issue here was that nsDOMStringMap::PreCreate actually finds its document via its associated element. And in this case, the element gets adopted into another document. Our orphan fixup code is supposed to detect when the parent moves, but in this case the parent (the document) didn't move.
So I think we should actually use the element as the parent. Attaching a patch that does that.
[Attachment #634325](/attachment.cgi?id=634325&action=edit "Have nsDOMStringMapSH::PreCreate use the document as the parent, rather than the window. v1") -
Attachment is obsolete: true
[Attachment #634343](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") -
Flags: review?(peterv)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=732870#c11)• 13 years ago |
|  | |

Repushed to try: <https://tbpl.mozilla.org/?tree=Try&rev=69c4caecc2de>

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=732870#c12)• 13 years ago |
|  | |

Can the non-deterministic crashtest be turned into two deterministic crashtests?

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=732870#c13)• 13 years ago |
|  | |

(In reply to Jesse Ruderman from [comment #12](/show_bug.cgi?id=732870#c12 "RESOLVED FIXED - \"ASSERTION: Weird scope returned\" with document.write twice, dataset, adoptNode"))
> Can the non-deterministic crashtest be turned into two deterministic
> crashtests?
I played around with it a bit just now, but I don't think there's a good way.
More to the point, it's only non-deterministic if we parent it to the document (my v1 patch, which we're not doing). It's deterministic against trunk.

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a9310341_24295)• 13 years ago |

[Attachment #634343](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") -
Flags: review?(peterv) → review+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=732870#c14)• 13 years ago |
|  | |

Pushed to m-i: <http://hg.mozilla.org/integration/mozilla-inbound/rev/eca1167488ca>

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=732870#c15)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/b37799afa959>Status: NEW → RESOLVEDClosed: 13 years ago
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla16

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=732870#c16)• 13 years ago |
|  | |

The code being patched looks like it is in ESR, but it also might be fallout from cpg which wouldn't affect ESR.
Does it?
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F)
[tracking-firefox16](/buglist.cgi?f1=cf_tracking_firefox16&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B)Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=732870#c17)• 13 years ago |
|  | |

This is basically just patching an edge case in the fix from [bug 751995](/show_bug.cgi?id=751995 "VERIFIED FIXED - Compartment mismatch with adoptNode, style"). Same issue.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a9469207_1689)• 13 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F) → [affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F) → [14+](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=14%2B)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=732870#c18)• 13 years ago |
|  | |

[Bug 751995](/show_bug.cgi?id=751995 "VERIFIED FIXED - Compartment mismatch with adoptNode, style") is fixing a CPG regression, so it'd be nice to fix this in the release we landed CPG. Please request Aurora approval to land this for Firefox 15.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=732870#c19)• 13 years ago |
|  | |

Comment on [attachment 634343](/attachment.cgi?id=634343 "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[details]](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[diff]](/attachment.cgi?id=634343&action=diff "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634343)
Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2
Per [comment 18](/show_bug.cgi?id=732870#c18 "RESOLVED FIXED - \"ASSERTION: Weird scope returned\" with document.write twice, dataset, adoptNode").
[Attachment #634343](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") -
Flags: approval-mozilla-aurora?

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=732870#c20)• 13 years ago |
|  | |

Bug caused by (feature/regressing bug #): CPG
User impact if declined: Potential security exploits.
Testing completed (on m-c, etc.): Baked on m-c for quite some time.
Risk to taking this patch (and alternatives if risky): not risky.
String or UUID changes made by this patch: None

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a10684569_1689)• 13 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
[14+](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=14%2B) → [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-)

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=732870#c21)• 13 years ago |
|  | |

Comment on [attachment 634343](/attachment.cgi?id=634343 "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[details]](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[diff]](/attachment.cgi?id=634343&action=diff "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=732870&attachment=634343)
Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2
[Triage Comment]
Low risk fix for a new sg:high regression in FF15. Approved for Aurora 15.
[Attachment #634343](/attachment.cgi?id=634343&action=edit "Have nsDOMStringMapSH::PreCreate use the element as its parent, rather than the window. v2") -
Flags: approval-mozilla-aurora? → approval-mozilla-aurora+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=732870#c22)• 13 years ago |
|  | |

Landed to m-a:
<http://hg.mozilla.org/releases/mozilla-aurora/rev/f123feca7157>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a13469532_280903)• 12 years ago |

Whiteboard: [fuzzblocker:compartment-mismatch] → [fuzzblocker:compartment-mismatch][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=732870#a19967261_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=732870&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jesse Ruderman](/user_profile?user_id=11608)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_dd8e015d_20250125_013452.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/779849)
* [XML](/show_bug.cgi?ctype=xml&id=779849)

Closed
[Bug 779849](/show_bug.cgi?id=779849)

Opened 12 years ago
Closed 12 years ago

# Flash Plugin related Assertion failure: false (compartment mismatched)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Flash Plugin related Assertion failure: false (compartment mismatched)

## Categories

### (Core Graveyard :: Plug-ins, defect)

[Product:](/describecomponents.cgi?product=Core%20Graveyard)

Core Graveyard
▾

Core Graveyard
Old, retired Core components
[See Open Bugs in This Product](/buglist.cgi?product=Core%20Graveyard&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core%20Graveyard)
Watch This Product

[Component:](/describecomponents.cgi?product=Core%20Graveyard&component=Plug-ins#Plug-ins)

Plug-ins
▾

Core Graveyard :: Plug-ins
Bugs in core Mozilla code that supports registering and using plug-ins. For bugs in specific plugins, please file those bugs under External Software Affecting Firefox.
[See Open Bugs in This Component](/buglist.cgi?product=Core%20Graveyard&component=Plug-ins&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core%20Graveyard&component=Plug-ins&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core%20Graveyard&component=Plug-ins)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

## Tracking

### (firefox15+ verified, firefox16+ verified, firefox17+ verified, firefox-esr10 unaffected)

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla17

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=verified) |
| firefox16 | [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=verified) |
| firefox17 | [+](/buglist.cgi?f1=cf_tracking_firefox17&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=verified) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | + | verified |
| firefox16 | + | verified |
| firefox17 | + | verified |
| firefox-esr10 |  | unaffected |

## People

### (Reporter: bc, Assigned: billm)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/81db2831554209472ec9b0d5485ca1c9?d=mm&size=40)  [billm](/user_profile?user_id=389993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

![](https://secure.gravatar.com/avatar/eae3698bd33e06ad8fb792ae7c6ffd5d?d=mm&size=40)  [u279076](/user_profile?user_id=279076)

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/ee4c7c6351b45c4655e16993a29979b0?d=mm&size=40)  [bc](/user_profile?user_id=23402)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](extensions/Gravatar/web/default.jpg)  [jimm](/user_profile?user_id=279663)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

### ( [URL](http://www.blogs.com/topten/top-10-country-music-blogs/ "http://www.blogs.com/topten/top-10-country-music-blogs/") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[771251](/show_bug.cgi?id=771251 "RESOLVED FIXED - OOP crash reporting access the directory service off the main thread"), [774052](/show_bug.cgi?id=774052 "VERIFIED FIXED - crash in js::types::TypeObject::sweep")

Dependency [tree](/showdependencytree.cgi?id=779849&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=779849)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[blogs.com/topten/top-10-country-music...](http://www.blogs.com/topten/top-10-country-music-blogs/ "http://www.blogs.com/topten/top-10-country-music-blogs/")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, crash, sec-critical, Whiteboard: [advisory-tracking+] regression from bug 771202)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[advisory-tracking+] regression from bug 771202

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::types::TypeObject::addPropertyType ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3Atypes%3A%3ATypeObject%3A%3AaddPropertyType)

[[@ js::gc::PushMarkStack ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3Agc%3A%3APushMarkStack)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [patch?](/attachment.cgi?id=648486)  [12 years ago](#c2)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   769 bytes, patch | bholley : [review+](#c4 "12 years ago")  lsblakk : [approval-mozilla-aurora+](#a376254_272375 "12 years ago")  lsblakk : [approval-mozilla-beta+](#a376254_272375 "12 years ago") | [Details](/attachment.cgi?id=648486&action=edit) | [Diff](/attachment.cgi?id=648486&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=779849&attachment=648486) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=779849#c0)• 12 years ago |
|  | |

1. <http://www.blogs.com/topten/top-10-country-music-blogs/>
This occurs on many many urls not just this one. This is my current top crasher in crash automation.
2. Assertion failure: false (compartment mismatched), at ../../../js/src/jscntxtinlines.h:227
Initially on Nightly this was a
###!!! ABORT: attempt to initialize OOP crash reporter before in-process crashreporter!: 'gExceptionHandler != NULL', file ../../../toolkit/crashreporter/nsExceptionHandler.cpp, line 2020
but after [bug 773830](/show_bug.cgi?id=773830 "RESOLVED FIXED - ###!!! ABORT: attempt to initialize OOP crash reporter before in-process crashreporter!: 'gExceptionHandler != NULL'") was fixed it settled down into the Assertion. It is just the assertion on Beta and Aurora.
ABORT: attempt to initialize OOP crash reporter before in-process crashreporter!: 'gExceptionHandler != NULL', file ../../../toolkit/crashreporter/nsExceptionHandler.cpp, line 2020
then Assertion failure: false (compartment mismatched), at ../../../js/src/jscntxtinlines.h:227
Also crashed Nightly, Aurora (may need to reload)
[bp-a9cd5c2f-db62-4383-85c4-a08672120802](https://crash-stats.mozilla.org/report/index/a9cd5c2f-db62-4383-85c4-a08672120802)
Firefox 17.0a1 Crash Report [@ js::types::TypeObject::addPropertyType ]
[bp-723b5531-d568-4856-9977-3ee742120802](https://crash-stats.mozilla.org/report/index/723b5531-d568-4856-9977-3ee742120802)
Firefox 15.0a2 Crash Report [@ js::gc::PushMarkStack ]
Found regression between 20120712015541-20120712174703
Pushlog: <http://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=70d92a6ccdfa&tochange=6489be1890c0>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-12-mozilla-central-debug/firefox-16.0a1.en-US.debug-linux-i686.tar.bz2>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-13-mozilla-central-debug/firefox-16.0a1.en-US.debug-linux-i686.tar.bz2>
Found regression between 20120715024321-20120716024822
Pushlog: <http://hg.mozilla.org/releases/mozilla-aurora/pushloghtml?fromchange=50963e16d1dc&tochange=d7602223c982>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-15-mozilla-aurora-debug/firefox-15.0a2.en-US.debug-linux-i686.tar.bz2>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-16-mozilla-aurora-debug/firefox-15.0a2.en-US.debug-linux-i686.tar.bz2>
(didn't see the ABORT here)
Found regression between 20120718210721-20120719120951
Pushlog: <http://hg.mozilla.org/releases/mozilla-beta/pushloghtml?fromchange=b2487714085b&tochange=ebfad1bf8749>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-19-mozilla-beta-debug/firefox-15.0.en-US.debug-linux-i686.tar.bz2>
<http://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2012/07/2012-07-20-mozilla-beta-debug/firefox-15.0.en-US.debug-linux-i686.tar.bz2>
(didn't see ABORT here)

|  | [Chris Jones [:cjones] inactive; ni?/f?/r? if you need me](/user_profile?user_id=336288) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a2295_336288)• 12 years ago |

Component: IPC → Plug-ins

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=779849#c1)• 12 years ago |
|  | |

Forgot to mention most if not all of the assertions I've seen have been just after loading Flash. This is not specific to 11.3 as it occurs on Linux with 11.2 as well.Summary: Plugin related Assertion failure: false (compartment mismatched) → Flash Plugin related Assertion failure: false (compartment mismatched)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=779849#c2)• 12 years ago |
|  | |

Attached patch

[patch?](attachment.cgi?id=648486&action=diff)
— [Details](attachment.cgi?id=648486&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=779849&attachment=648486)

I don't know this code at all--even who to ask for review. But the fix looks relatively straightforward. There are two paths in GetNewOrUsed that return an existing object. One of them calls JS\_WrapObject and the other one doesn't. On the page that crashes, we take the non-JS\_WrapObject path and end up getting something from the wrong compartment.Assignee: nobody → wmccloskeyStatus: NEW → ASSIGNED
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: review?(bobbyholley+bmo)
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: review?(benjamin)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=779849#c3)• 12 years ago |
|  | |

Also, this should probably be closed.Group: core-security

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=779849#c4)• 12 years ago |
|  | |

Comment on [attachment 648486](/attachment.cgi?id=648486 "patch?") [[details]](/attachment.cgi?id=648486&action=edit "patch?") [[diff]](/attachment.cgi?id=648486&action=diff "patch?") [[review]](/page.cgi?id=splinter.html&ignore=&bug=779849&attachment=648486)
patch?
Yes! You rock, bill.
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: review?(bobbyholley+bmo) → review+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=779849#c5)• 12 years ago |
|  | |

This fixes the crash in [bug 774052](/show_bug.cgi?id=774052 "VERIFIED FIXED - crash in js::types::TypeObject::sweep"). We should get this on beta ASAP.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a86243_406194)• 12 years ago |

Blocks: [774052](/show_bug.cgi?id=774052 "VERIFIED FIXED - crash in js::types::TypeObject::sweep")

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a101081_272375)• 12 years ago |

[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)
[tracking-firefox16](/buglist.cgi?f1=cf_tracking_firefox16&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B)
[tracking-firefox17](/buglist.cgi?f1=cf_tracking_firefox17&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox17&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox17&o1=equals&v1=%2B)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=779849#c6)• 12 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/4f774268e674>
It sounds like Bobby's review is enough here.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=779849#c7)• 12 years ago |
|  | |

Comment on [attachment 648486](/attachment.cgi?id=648486 "patch?") [[details]](/attachment.cgi?id=648486&action=edit "patch?") [[diff]](/attachment.cgi?id=648486&action=diff "patch?") [[review]](/page.cgi?id=splinter.html&ignore=&bug=779849&attachment=648486)
patch?
[Approval Request Comment]
Bug caused by (feature/regressing bug #): CPG, I assume
User impact if declined: Crashes, exploits.
Testing completed (on m-c, etc.): On m-c.
Risk to taking this patch (and alternatives if risky): Seems low, but I don't know this code well.
String or UUID changes made by this patch: None.
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: review?(benjamin)
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-beta?
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-aurora?

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=779849#c8)• 12 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/4f774268e674>Status: ASSIGNED → RESOLVEDClosed: 12 years ago
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla17

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a370790_336670)• 12 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a376254_272375)• 12 years ago |

[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-beta?
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-beta+
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-aurora?
[Attachment #648486](/attachment.cgi?id=648486&action=edit "patch?") -
Flags: approval-mozilla-aurora+

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=779849#c9)• 12 years ago |
|  | |

Please land this before EOD tomorrow so it can go into Beta 4 and we can have some bake time before final release.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=779849#c10)• 12 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/bac4527ff910>
<https://hg.mozilla.org/releases/mozilla-beta/rev/0a2004271b21>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=779849#c11)• 12 years ago |
|  | |

Does this not affect ESR?
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a466842_280903)• 12 years ago |

Whiteboard: [advisory-tracking+]

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=779849#c12)• 12 years ago |
|  | |

(In reply to Al Billings [:abillings] from [comment #11](/show_bug.cgi?id=779849#c11 "VERIFIED FIXED - Flash Plugin related Assertion failure: false (compartment mismatched)"))
> Does this not affect ESR?
I don't think so, but Bobby would know better. Bobby?

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=779849#c13)• 12 years ago |
|  | |

Bob implies it is a regression from July.

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=779849#c14)• 12 years ago |
|  | |

I don't test esr so can't say from experience whether this affects it or not. It would depend on if any of the responsible patches have landed there. If this is related to the Flash crash reporting then it is possible that esr is affected as well.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=779849#c15)• 12 years ago |
|  | |

(In reply to Bill McCloskey (:billm) from [comment #12](/show_bug.cgi?id=779849#c12 "VERIFIED FIXED - Flash Plugin related Assertion failure: false (compartment mismatched)"))
> I don't think so, but Bobby would know better. Bobby?
This is a regression from [bug 771202](/show_bug.cgi?id=771202 "RESOLVED FIXED - Custom-spliced plugin prototypes disappear after transplant"). I can't mark it because of circularity.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a531377_406194)• 12 years ago |

Whiteboard: [advisory-tracking+] → [advisory-tracking+] regression from bug 771202

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=779849#c16)• 12 years ago |
|  | |

If this is a regression frombug 771202, then it shouldn't affect ESR.
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a1156125_279076)• 12 years ago |

Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=779849#c17)• 12 years ago |
|  | |

I'm not able to reproduce this with the 2012-07-30 Firefox 17.0a1 debug build on Ubuntu 12.04 64-bit with Flash 11.2. Can someone provide some assistance here with the verification, either by doing some testing or by providing me with some guidance so I can reproduce it myself? Priority is getting it verified against Firefox 15.
ThanksKeywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)Whiteboard: [advisory-tracking+] regression from bug 771202 → [advisory-tracking+][qa?] regression from bug 771202

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=779849#c18)• 12 years ago |
|  | |

ashughes, do you have 32bit linux available?

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=779849#c19)• 12 years ago |
|  | |

(In reply to Bob Clary [:bc:] from [comment #18](/show_bug.cgi?id=779849#c18 "VERIFIED FIXED - Flash Plugin related Assertion failure: false (compartment mismatched)"))
> ashughes, do you have 32bit linux available?
I have an Ubuntu 11.10 32-bit VM -- will that work?

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=779849#c20)• 12 years ago |
|  | |

Worth a try.

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=779849#c21)• 12 years ago |
|  | |

Thanks Bob. I was able to reproduce this with Firefox 17.0a1 2012-07-30, Ubuntu 11.10 32-bit, and Flash 11.2. I'll now test to verify the fix.

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=779849#c22)• 12 years ago |
|  | |

Verified fixed with:
\* 2012-08-24 Firefox 17.0a1
\* 2012-08-24 Firefox 16.0a2
\* 2012-08-24 Firefox 15.0Status: RESOLVED → VERIFIED
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=verified)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=verified)
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=verified)QA Contact: anthony.s.hughesWhiteboard: [advisory-tracking+][qa?] regression from bug 771202 → [advisory-tracking+] regression from bug 771202

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a6964511_1689)• 12 years ago |

Group: core-security

|  | [BMO Automation](/user_profile?user_id=546015) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=779849#a308811992_546015)• 3 years ago |

Product: Core → Core Graveyard
You need to [log in](/show_bug.cgi?id=779849&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_5537b0b3_20250125_013443.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/755916)
* [XML](/show_bug.cgi?ctype=xml&id=755916)

Closed
[Bug 755916](/show_bug.cgi?id=755916)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: enumerators == cx->enumerators,

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: enumerators == cx->enumerators,

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Windows 7

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=unaffected) |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 |  | unaffected |
| firefox14 | + | affected |
| firefox15 | + | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: gkw, Assigned: luke)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](extensions/Gravatar/web/default.jpg)  [luke](/user_profile?user_id=347312)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [gkw](/user_profile?user_id=132034)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

8 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[732744](/show_bug.cgi?id=732744 "RESOLVED FIXED - no need for AutoPreserveEnumerators")

Dependency [tree](/showdependencytree.cgi?id=755916&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=755916)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [sg:critical] [js:p1:fx15][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical] [js:p1:fx15][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [khuey](/user_profile?user_id=336670) | [in-testsuite](#a186116_336670 "13 years ago") | + |
| --- | --- | --- |
| [khuey](/user_profile?user_id=336670) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [stack](/attachment.cgi?id=624548)  [13 years ago](#c0)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   20.58 KB, text/plain |  | [Details](/attachment.cgi?id=624548&action=edit) |
| --- | --- | --- |
| [fix and test](/attachment.cgi?id=624607)  [13 years ago](#c2)  [Luke Wagner [:luke]](/user_profile?user_id=347312)   1.23 KB, patch | bhackett1024 : [review+](#a143491_346231 "13 years ago") | [Details](/attachment.cgi?id=624607&action=edit) | [Diff](/attachment.cgi?id=624607&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=755916&attachment=624607) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=755916#c0)• 13 years ago |
|  | |

Attached file
[stack](attachment.cgi?id=624548)
— [Details](attachment.cgi?id=624548&action=edit)

Object.defineProperty(this, "t2", {
get: function() {
for (p in h2) {
t2
}
}
})
h2 = {}
mjitChunkLimit(8)
h2.a = function() {}
Object(t2)
asserts js 64-bit debug shell on m-c changeset 65fb8b9ea0b7 with -m and -n at Assertion failure: enumerators == cx->enumerators,
Asserts on Windows 7 but apparently not on Mac OS X 10.7.
Setting s-s because I'm not sure if this is sensitive, 64-bit js shell fuzzing on Windows 7 was only turned on recently.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=755916#c1)• 13 years ago |
|  | |

autoBisect shows this is probably related to the following changeset:
The first bad revision is:
changeset: 92285:c4c1511bafbd
user: Luke Wagner
date: Fri Apr 13 18:06:40 2012 -0700
summary: [Bug 746843](/show_bug.cgi?id=746843 "RESOLVED FIXED - StackFrame::scopeChain() should return a HandleObject") - change StackFrame::scopeChain() to return a HandleObject (r=bhackett)Blocks: [746843](/show_bug.cgi?id=746843 "RESOLVED FIXED - StackFrame::scopeChain() should return a HandleObject")

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a11166_347312)• 13 years ago |

No longer blocks: [746843](/show_bug.cgi?id=746843 "RESOLVED FIXED - StackFrame::scopeChain() should return a HandleObject")

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=755916#c2)• 13 years ago |
|  | |

Attached patch

[fix and test](attachment.cgi?id=624607&action=diff)
— [Details](attachment.cgi?id=624607&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=755916&attachment=624607)

Err, I don't know how I missed this one when I fixed the early return directly below it...Assignee: general → lukeStatus: NEW → ASSIGNED
[Attachment #624607](/attachment.cgi?id=624607&action=edit "fix and test") -
Flags: review?(bhackett1024)

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a11249_347312)• 13 years ago |

Whiteboard: js-triage-needed → js-triage-done

|  | [Naveed Ihsanullah [:naveed]](/user_profile?user_id=441971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a78468_441971)• 13 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)Whiteboard: js-triage-done → [sg:critical] [js:p1:fx15]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=755916#c3)• 13 years ago |
|  | |

> Luke Wagner [:luke] 2012-05-16 17:47:37 PDT
> No longer blocks: 746843
Is that a mid-air, or do you mean to say that this is not a regression from [bug 746843](/show_bug.cgi?id=746843 "RESOLVED FIXED - StackFrame::scopeChain() should return a HandleObject"). If so do you know what it's a regression from, or is it not a regression?
If it /is/ a regression from that bug then this should not affect Firefox 13 or ESR-10, but does affect 14 and later.
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=unaffected)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a143491_346231)• 13 years ago |

[Attachment #624607](/attachment.cgi?id=624607&action=edit "fix and test") -
Flags: review?(bhackett1024) → review+

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=755916#c4)• 13 years ago |
|  | |

This bug results us hitting the C stack limit at just the right place, so all [bug 746843](/show_bug.cgi?id=746843 "RESOLVED FIXED - StackFrame::scopeChain() should return a HandleObject") did was perturb the stack frame size a bit in debug builds so that the stars aligned to hit the limit at the right check. Thus, there probably exists some test-cast that goes back to the original [bug 732744](/show_bug.cgi?id=732744 "RESOLVED FIXED - no need for AutoPreserveEnumerators") that asserted the invariant.Blocks: [732744](/show_bug.cgi?id=732744 "RESOLVED FIXED - no need for AutoPreserveEnumerators")

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=755916#c5)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/1d70f1cf90e8>Target Milestone: --- → mozilla15

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=755916#c6)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/1d70f1cf90e8>Status: ASSIGNED → RESOLVEDClosed: 13 years agoResolution: --- → FIXED

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a186116_336670)• 13 years ago |

Flags: in-testsuite+

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a186194_336670)• 13 years ago |

[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=755916#c7)• 13 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a191785_395101)• 13 years ago |

Status: RESOLVED → VERIFIED

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=755916#c8)• 13 years ago |
|  | |

Fixing [bug 735082](/show_bug.cgi?id=735082 "RESOLVED DUPLICATE - Provide a way to cause artificial stack limit failures") would make it easier to find bugs like this, and easier to make reliable regression tests for them.No longer blocks: [732744](/show_bug.cgi?id=732744 "RESOLVED FIXED - no need for AutoPreserveEnumerators")

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a416857_132034)• 13 years ago |

Blocks: [732744](/show_bug.cgi?id=732744 "RESOLVED FIXED - no need for AutoPreserveEnumerators")

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a7182843_280903)• 12 years ago |

Whiteboard: [sg:critical] [js:p1:fx15] → [sg:critical] [js:p1:fx15][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=755916#a13678667_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=755916&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_59602448_20250125_013419.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/719750)
* [XML](/show_bug.cgi?ctype=xml&id=719750)

Closed
[Bug 719750](/show_bug.cgi?id=719750)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
WORKSFORME

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

WORKSFORME

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox10 | [-](/buglist.cgi?f1=cf_tracking_firefox10&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_firefox10&o1=equals&v1=wontfix) |
| firefox11 | [-](/buglist.cgi?f1=cf_tracking_firefox11&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_firefox11&o1=equals&v1=wontfix) |
| firefox12 | [-](/buglist.cgi?f1=cf_tracking_firefox12&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=wontfix) |
| firefox13 | [-](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=wontfix) |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix) |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox16 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox10 | - | wontfix |
| firefox11 | - | wontfix |
| firefox12 | - | wontfix |
| firefox13 | - | wontfix |
| firefox14 | + | wontfix |
| firefox15 | + | fixed |
| firefox16 |  | fixed |
| firefox-esr10 |  | wontfix |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Unassigned)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

*Unassigned*

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment")

Dependency [tree](/showdependencytree.cgi?id=719750&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=719750)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-critical, testcase, Whiteboard: [sg:critical][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [gkw](/user_profile?user_id=132034) | [in-testsuite](#c12 "13 years ago") | + |
| --- | --- | --- |
| [gkw](/user_profile?user_id=132034) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=719750#c0)• 13 years ago |
|  | |

The following test asserts on mozilla-central revision e5e66f40c35b (options -n -m -a):
function f( ) {
var [ [x], e ] = ["\*", "/", "%"];
function h() {
for (var i = 0; i < 5; ++i) {
x = i \* 2;
}
}
h();
assertEq(x, 8);
}
f();
This bug strongly reminds me of [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") which also had a destructuring assignment. S-s due to infer failure.

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=719750#c1)• 13 years ago |
|  | |

Yeah, this looks almost identical to [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment"). The 'x' in f() is not marked as closed yet is overwritten within h().Blocks: [685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment"), [708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers")

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=719750#c2)• 13 years ago |
|  | |

I would expect [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") to take care of this. I just tested m-i rev 374975f24277 and it WFM.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=719750#c3)• 13 years ago |
|  | |

(In reply to David Mandelin from [comment #2](/show_bug.cgi?id=719750#c2 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment"))
> I would expect [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") to take care of this. I just tested m-i rev
> 374975f24277 and it WFM.
I thought [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") was already fixed? I just re-tested this on m-i tip (0a116f325333) and still get the crash.

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=719750#c4)• 13 years ago |
|  | |

Yeah, either this is a different underlying problem from [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") (though the problem is still during parsing/emitting) or the [bug 685321](/show_bug.cgi?id=685321 "VERIFIED FIXED - Assertion failure: [infer failure] Missing type pushed 0: int, at jsinfer.cpp:341 with destructuring assignment") fix was not complete.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a480309_1689)• 13 years ago |

Whiteboard: js-triage-needed → [sg:critical] js-triage-needed

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a552402_1689)• 13 years ago |

[status-firefox12](/buglist.cgi?f1=cf_status_firefox12&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=affected)
[tracking-firefox10](/buglist.cgi?f1=cf_tracking_firefox10&o1=isnotempty):
--- → [-](/buglist.cgi?f1=cf_tracking_firefox10&o1=equals&v1=-)
[tracking-firefox12](/buglist.cgi?f1=cf_tracking_firefox12&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox12&o1=equals&v1=%2B)Whiteboard: [sg:critical] js-triage-needed → [sg:critical] js-triage-needed [needs testing on Fx10 and Fx11]

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a557007_294323)• 13 years ago |

No longer blocks: [708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers")Depends on: [708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers")Whiteboard: [sg:critical] js-triage-needed [needs testing on Fx10 and Fx11] → [sg:critical] [needs testing on Fx10 and Fx11]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a1156695_1689)• 13 years ago |

[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=affected)
[tracking-firefox13](/buglist.cgi?f1=cf_tracking_firefox13&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a1158866_1689)• 13 years ago |

[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected)
[status-firefox10](/buglist.cgi?f1=cf_status_firefox10&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox10&o1=equals&v1=affected)
[status-firefox11](/buglist.cgi?f1=cf_status_firefox11&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox11&o1=equals&v1=affected)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a1158881_1689)• 13 years ago |

Whiteboard: [sg:critical] [needs testing on Fx10 and Fx11] → [sg:critical]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a2376125_1689)• 13 years ago |

[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F) → ---

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=719750#c5)• 13 years ago |
|  | |

Not going to push for this for 11.
[status-firefox10](/buglist.cgi?f1=cf_status_firefox10&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox10&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox10&o1=equals&v1=wontfix)
[status-firefox11](/buglist.cgi?f1=cf_status_firefox11&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox11&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox11&o1=equals&v1=wontfix)
[tracking-firefox11](/buglist.cgi?f1=cf_tracking_firefox11&o1=isnotempty):
--- → [-](/buglist.cgi?f1=cf_tracking_firefox11&o1=equals&v1=-)

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=719750#c6)• 13 years ago |
|  | |

This depends on [bug 708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers"), which is too complicated to fix in time for 12.
[status-firefox12](/buglist.cgi?f1=cf_status_firefox12&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox12&o1=equals&v1=wontfix)
[tracking-firefox12](/buglist.cgi?f1=cf_tracking_firefox12&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox12&o1=equals&v1=%2B) → [-](/buglist.cgi?f1=cf_tracking_firefox12&o1=equals&v1=-)

|  | [David Bolter [:davidb] (NeedInfo me for attention)](/user_profile?user_id=152868) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a4782445_152868)• 13 years ago |

[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a5483820_294323)• 13 years ago |

[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=wontfix)
[tracking-firefox13](/buglist.cgi?f1=cf_tracking_firefox13&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=%2B) → [-](/buglist.cgi?f1=cf_tracking_firefox13&o1=equals&v1=-)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=719750#c7)• 13 years ago |
|  | |

(In reply to David Mandelin from [comment #6](/show_bug.cgi?id=719750#c6 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment"))
> This depends on [bug 708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers"), which is too complicated to fix in time for 12.
How will we get all the depends-on bugs backported to ESR once this does get fixed?
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=719750#c8)• 13 years ago |
|  | |

(In reply to Daniel Veditz [:dveditz] from [comment #7](/show_bug.cgi?id=719750#c7 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment"))
> (In reply to David Mandelin from [comment #6](/show_bug.cgi?id=719750#c6 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment"))
> > This depends on [bug 708892](/show_bug.cgi?id=708892 "RESOLVED INVALID - Clean up destructuring var initializers"), which is too complicated to fix in time for 12.
>
> How will we get all the depends-on bugs backported to ESR once this does get
> fixed?
Hmmm, not sure. Getting it fixed at is apparently difficult enough, so I'll worry about ESR once we get there.

|  | [Curtis Koenig [:curtisk-use curtis.koenig+bzATgmail.com]]](/user_profile?user_id=406847) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a8999397_406847)• 13 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=719750#c9)• 13 years ago |
|  | |

This WFM on trunk. I bet Luke's scope chain work fixed it. That was a huge chain of work and basically a new feature so backport is not realistic. Is there anything to do other than close WFM and mark branches wontfix?

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a13091097_294323)• 13 years ago |

Status: NEW → RESOLVEDClosed: 13 years agoResolution: --- → WORKSFORME

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=719750#c10)• 13 years ago |
|  | |

Luke, could you please add this to the testsuite as well?Flags: in-testsuite?

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=719750#c11)• 13 years ago |
|  | |

(In reply to Gary Kwong [:gkw, :nth10sd] from [comment #10](/show_bug.cgi?id=719750#c10 "VERIFIED WORKSFORME - Assertion failure: [infer failure] Missing type pushed 0: int with destructuring assignment"))
> Luke, could you please add this to the testsuite as well?
As far as I know, this affects ESR and I don't know if it was fixed because the original fix cannot be backported. If this is not fixed on ESR then adding the test now will make it much easier to detect this.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=719750#c12)• 13 years ago |
|  | |

Test landed on mozilla-inbound:
<http://hg.mozilla.org/integration/mozilla-inbound/rev/bb2a5759abb4>Flags: in-testsuite? → in-testsuite+

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=719750#c13)• 13 years ago |
|  | |

> <http://hg.mozilla.org/integration/mozilla-inbound/rev/bb2a5759abb4>
<http://hg.mozilla.org/integration/mozilla-inbound/rev/efb3a00b3aad> removes the extraneous print statement I added.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=719750#c14)• 13 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/rev/bb2a5759abb4>
<http://hg.mozilla.org/mozilla-central/rev/efb3a00b3aad>
Test landed, so marking VERIFIED.Status: RESOLVED → VERIFIED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a13855418_1689)• 13 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=wontfix)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a17324196_280903)• 12 years ago |

Whiteboard: [sg:critical] → [sg:critical][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=719750#a23822396_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=719750&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑



=== Content from bugzilla.mozilla.org_495ab168_20250125_013455.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/780712)
* [XML](/show_bug.cgi?ctype=xml&id=780712)

Closed
[Bug 780712](/show_bug.cgi?id=780712)

Opened 12 years ago
Closed 12 years ago

# Crash [@ JSC::Yarr::execute] or [@ js::RegExpShared::execute]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash [@ JSC::Yarr::execute] or [@ js::RegExpShared::execute]

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla17

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Accessibility Severity | --- |
| a11y-review | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix) |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox16 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) |
| firefox17 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 |  | wontfix |
| firefox15 |  | fixed |
| firefox16 |  | fixed |
| firefox17 |  | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: gkw, Assigned: luke)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](extensions/Gravatar/web/default.jpg)  [luke](/user_profile?user_id=347312)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

![](https://secure.gravatar.com/avatar/55857f92ded07119259dc6c1dd386205?d=mm&size=40)  [general](/user_profile?user_id=4729)

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [gkw](/user_profile?user_id=132034)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

8 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[742570](/show_bug.cgi?id=742570 "RESOLVED FIXED - Better shell tests for GC")

Dependency [tree](/showdependencytree.cgi?id=780712&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=780712)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [advisory-tracking+][qa?])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[advisory-tracking+][qa?]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [decoder](/user_profile?user_id=395101) | [in-testsuite](#c13 "12 years ago") | + |
| --- | --- | --- |
| [decoder](/user_profile?user_id=395101) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ JSC::Yarr::execute ]](https://crash-stats.mozilla.org/signature/?signature=JSC%3A%3AYarr%3A%3Aexecute)

[[@ js::RegExpShared::execute ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3ARegExpShared%3A%3Aexecute)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [stacks](/attachment.cgi?id=649406)  [12 years ago](#c0)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   8.11 KB, text/plain |  | [Details](/attachment.cgi?id=649406&action=edit) |
| --- | --- | --- |
| [fix and test](/attachment.cgi?id=649678)  [12 years ago](#c4)  [Luke Wagner [:luke]](/user_profile?user_id=347312)   2.49 KB, patch | billm : [review+](#c5 "12 years ago")  lsblakk : [approval-mozilla-aurora+](#a246131_272375 "12 years ago")  lsblakk : [approval-mozilla-beta+](#a246131_272375 "12 years ago") | [Details](/attachment.cgi?id=649678&action=edit) | [Diff](/attachment.cgi?id=649678&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=780712&attachment=649678) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=780712#c0)• 12 years ago |
|  | |

Attached file
[stacks](attachment.cgi?id=649406)
— [Details](attachment.cgi?id=649406&action=edit)

r = evalcx("/x/", undefined);
s = "";
gc()
Function("\
s.match(r);\
schedulegc(\_\_proto\_\_);\
({c:schedulegc(2)});\
s.match(r);\
")()
crashes js debug shell on m-c changeset 6c60e99d9739 without any CLI arguments at JSC::Yarr::execute with js::RegExpShared::execute on the stack.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=780712#c1)• 12 years ago |
|  | |

autoBisect shows this is probably related to the following changeset:
The first bad revision is:
changeset: 91130:15a23c3923ff
user: Bill McCloskey
date: Tue Apr 03 14:07:38 2012 -0700
summary: [Bug 742570](/show_bug.cgi?id=742570 "RESOLVED FIXED - Better shell tests for GC") - Improve GC testing functions (r=igor)
Not sure if this only affects gc testing functions, so setting Firefox 14 and later as affected.Blocks: [742570](/show_bug.cgi?id=742570 "RESOLVED FIXED - Better shell tests for GC")
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected)
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=affected)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a2685_389993)• 12 years ago |

Assignee: general → wmccloskey

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=780712#c2)• 12 years ago |
|  | |

Here's what seems to be happening. We have a cross-compartment wrapper to a regexp. We call some regexp method on it, and that calls RegExpToShared on the CCW. That calls through some proxy code, which basically unwraps the regexp and calls RegExpToShared on the unwrapped regexp. We don't have a RegExpShared for this regexp yet, so we call RegExpObject::createShared, which looks like this:
bool
RegExpObject::createShared(JSContext \*cx, RegExpGuard \*g)
{
Rooted<RegExpObject\*> self(cx, this);
JS\_ASSERT(!maybeShared());
if (!cx->compartment->regExps.get(cx, getSource(), getFlags(), g))
return false;
self->setShared(cx, \*\*g);
return true;
}
The crucial thing here is that while self is the unwrapped regexp, cx->compartment is the compartment that the CCW was in. So they don't match. Consequently, we're putting the RegExpShared in the wrong compartment's table. Later on, we collect that compartment and kill the RegExpShared, but the |self| object from above still has a pointer to it because it was in a different compartment and not traced.
An easy fix would be to change cx->compartment to self->compartment(). However, it seems like this is a more general problem. I see a number of IndirectProxyHandler methods that unwrap a CCW and do some work on the unwrapped object without ever switching compartments. This seems pretty dangerous to me. Is it by design? Can we change it so that we enter the right compartment? We'd have to wrap the result, but that doesn't seem to be an issue in these cases as far as I can tell.

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=780712#c3)• 12 years ago |
|  | |

Sorry you had to look into this. It seems to me like the fix would be for CrossCompartmentWrapper to override regexp\_toShared, wrapping the call to IndirectProxyHandler::regexp\_toShared with an AutoCompartment, as with most of the rest of the ProxyHandler hooks.

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=780712#c4)• 12 years ago |
|  | |

Attached patch

[fix and test](attachment.cgi?id=649678&action=diff)
— [Details](attachment.cgi?id=649678&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=780712&attachment=649678)

[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: review?(wmccloskey)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=780712#c5)• 12 years ago |
|  | |

Comment on [attachment 649678](/attachment.cgi?id=649678 "fix and test") [[details]](/attachment.cgi?id=649678&action=edit "fix and test") [[diff]](/attachment.cgi?id=649678&action=diff "fix and test") [[review]](/page.cgi?id=splinter.html&ignore=&bug=780712&attachment=649678)
fix and test
Thanks. I hadn't realized that CrossCompartmentWrapper overrode all these.
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: review?(wmccloskey) → review+

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=780712#c6)• 12 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/a2398a7be210>Target Milestone: --- → mozilla17

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=780712#c7)• 12 years ago |
|  | |

Comment on [attachment 649678](/attachment.cgi?id=649678 "fix and test") [[details]](/attachment.cgi?id=649678&action=edit "fix and test") [[diff]](/attachment.cgi?id=649678&action=diff "fix and test") [[review]](/page.cgi?id=splinter.html&ignore=&bug=780712&attachment=649678)
fix and test
[Approval Request Comment]
User impact if declined: memory corruption
Testing completed (on m-c, etc.): m-c
Risk to taking this patch (and alternatives if risky): low
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-beta?
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-aurora?

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=780712#c8)• 12 years ago |
|  | |

This will probably be WONTFIX for Firefox 14.
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a81624_389993)• 12 years ago |

Assignee: wmccloskey → luke

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=780712#c9)• 12 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/a2398a7be210>Status: NEW → RESOLVEDClosed: 12 years ago
[status-firefox17](/buglist.cgi?f1=cf_status_firefox17&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox17&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a164606_395101)• 12 years ago |

Status: RESOLVED → VERIFIEDCrash Signature: [@ JSC::Yarr::execute]
[@ js::RegExpShared::execute] → [@ JSC::Yarr::execute]
[@ js::RegExpShared::execute]

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=780712#c10)• 12 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a246131_272375)• 12 years ago |

[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-beta?
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-beta+
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-aurora?
[Attachment #649678](/attachment.cgi?id=649678&action=edit "fix and test") -
Flags: approval-mozilla-aurora+

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=780712#c11)• 12 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/6372bb9fb95d>
<https://hg.mozilla.org/releases/mozilla-beta/rev/ac9af7f6b0d1>Crash Signature: [@ JSC::Yarr::execute]
[@ js::RegExpShared::execute] → [@ JSC::Yarr::execute]
[@ js::RegExpShared::execute]
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a787634_279076)• 12 years ago |

Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a1384706_280903)• 12 years ago |

Whiteboard: [advisory-tracking+]

|  | [u279076](/user_profile?user_id=279076) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=780712#c12)• 12 years ago |
|  | |

Does this need verification given [comment 10](/show_bug.cgi?id=780712#c10 "VERIFIED FIXED - Crash [@ JSC::Yarr::execute] or [@ js::RegExpShared::execute]")?Keywords: [verifyme](/buglist.cgi?keywords=verifyme&resolution=---)Whiteboard: [advisory-tracking+] → [advisory-tracking+][qa?]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=780712#a6596735_1689)• 12 years ago |

Group: core-security

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=780712#c13)• 12 years ago |
|  | |

A testcase for this bug was automatically identified at js/src/jit-test/tests/basic/testBug780712.js.Flags: in-testsuite+
You need to [log in](/show_bug.cgi?id=780712&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from lists.opensuse.org_2618a86b_20250125_013408.html ===


[![openSUSE](https://static.opensuse.org/favicon.svg)
Mailing Lists](/archives/ "openSUSE Mailing Lists")

[Sign In](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40lists.opensuse.org/message/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/)

[Manage this list](/manage/lists/security-announce.lists.opensuse.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40lists.opensuse.org/message/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[thread](/archives/list/security-announce%40lists.opensuse.org/thread/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/#ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25)

# [security-announce] SUSE-SU-2012:1157-1: important: Security update for Mozilla Firefox

![](https://seccdn.libravatar.org/avatar/099a17325bdf082b643d1a6bbacde279.jpg?s=120&d=mm&r=g)
## [opensuse-security＠opensuse.org](/archives/users/1b72def497ef4503896cd7a5fe9fb8e0/ "See the profile for opensuse-security＠opensuse.org")

12 Sep
2012

12 Sep
'12

23:08

SUSE Security Update: Security update for Mozilla Firefox
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Announcement ID: SUSE-SU-2012:1157-1
Rating: important
References: #777588
Affected Products:
SUSE Linux Enterprise Software Development Kit 11 SP2
SUSE Linux Enterprise Server 11 SP2 for VMware
SUSE Linux Enterprise Server 11 SP2
SUSE Linux Enterprise Desktop 11 SP2
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
An update that contains security fixes can now be
installed. It includes three new package versions.
Description:
MozillaFirefox was updated to 10.0.7ESR release, fixing a
lot of bugs and security problems.
The following security issues have been addressed:
\*
MFSA 2012-57: Mozilla developers identified and fixed
several memory safety bugs in the browser engine used in
Firefox and other Mozilla-based products. Some of these
bugs showed evidence of memory corruption under certain
circumstances, and we presume that with enough effort at
least some of these could be exploited to run arbitrary
code.
In general these flaws cannot be exploited through
email in the Thunderbird and SeaMonkey products because
scripting is disabled, but are potentially a risk in
browser or browser-like contexts in those products.
\*
CVE-2012-1971: Gary Kwong, Christian Holler, Jesse
Ruderman, Steve Fink, Bob Clary, Andrew Sutherland, and
Jason Smith reported memory safety problems and crashes
that affect Firefox 14.
\*
CVE-2012-1970: Gary Kwong, Christian Holler, Jesse
Ruderman, John Schoenick, Vladimir Vukicevic and Daniel
Holbert reported memory safety problems and crashes that
affect Firefox ESR 10 and Firefox 14.
\*
MFSA 2012-58: Security researcher Abhishek Arya
(Inferno) of Google Chrome Security Team discovered a
series of use-after-free issues using the Address Sanitizer
tool. Many of these issues are potentially exploitable,
allowing for remote code execution.
o Heap-use-after-free in
nsHTMLEditor::CollapseAdjacentTextNodes CVE-2012-1972 o
Heap-use-after-free in nsObjectLoadingContent::LoadObject
CVE-2012-1973 o Heap-use-after-free in
gfxTextRun::CanBreakLineBefore CVE-2012-1974 o
Heap-use-after-free in PresShell::CompleteMove
CVE-2012-1975 o Heap-use-after-free in
nsHTMLSelectElement::SubmitNamesValues CVE-2012-1976 o
Heap-use-after-free in
MediaStreamGraphThreadRunnable::Run() CVE-2012-3956 o
Heap-buffer-overflow in nsBlockFrame::MarkLineDirty
CVE-2012-3957 o Heap-use-after-free in
nsHTMLEditRules::DeleteNonTableElements CVE-2012-3958 o
Heap-use-after-free in nsRangeUpdater::SelAdjDeleteNode
CVE-2012-3959 o Heap-use-after-free in
mozSpellChecker::SetCurrentDictionary CVE-2012-3960 o
Heap-use-after-free in RangeData::~RangeData CVE-2012-3961
o Bad iterator in text runs CVE-2012-3962 o use after free
in js::gc::MapAllocToTraceKind CVE-2012-3963 o
Heap-use-after-free READ 8 in gfxTextRun::GetUserData
CVE-2012-3964
\*
MFSA 2012-59 / CVE-2012-1956: Security researcher
Mariusz Mlynski reported that it is possible to shadow the
location object using Object.defineProperty. This could be
used to confuse the current location to plugins, allowing
for possible cross-site scripting (XSS) attacks.
\*
MFSA 2012-60 / CVE-2012-3965: Security researcher
Mariusz Mlynski reported that when a page opens a new tab,
a subsequent window can then be opened that can be
navigated to about:newtab, a chrome privileged page. Once
about:newtab is loaded, the special context can potentially
be used to escalate privilege, allowing for arbitrary code
execution on the local system in a maliciously crafted
attack.
\*
MFSA 2012-61 / CVE-2012-3966: Security researcher
Frederic Hoguin reported two related issues with the
decoding of bitmap (.BMP) format images embedded in icon
(.ICO) format files. When processing a negative "height"
header value for the bitmap image, a memory corruption can
be induced, allowing an attacker to write random memory and
cause a crash. This crash may be potentially exploitable.
\*
MFSA 2012-62: Security researcher miaubiz used the
Address Sanitizer tool to discover two WebGL issues. The
first issue is a use-after-free when WebGL shaders are
called after being destroyed. The second issue exposes a
problem with Mesa drivers on Linux, leading to a
potentially exploitable crash.
o
use after free, webgl fragment shader deleted
by accessor CVE-2012-3968
o
stack scribbling with 4-byte values choosable
among a few values, when using more than 16 sampler
uniforms, on Mesa, with all drivers CVE-2012-3967
\*
MFSA 2012-63: Security researcher Arthur Gerkis used
the Address Sanitizer tool to find two issues involving
Scalable Vector Graphics (SVG) files. The first issue is a
buffer overflow in Gecko's SVG filter code when the sum of
two values is too large to be stored as a signed 32-bit
integer, causing the function to write past the end of an
array. The second issue is a use-after-free when an element
with a "requiredFeatures" attribute is moved between
documents. In that situation, the internal representation
of the "requiredFeatures" value could be freed prematurely.
Both issues are potentially exploitable.
o
Heap-buffer-overflow in
nsSVGFEMorphologyElement::Filter CVE-2012-3969
o
Heap-use-after-free in nsTArray\_base::Length()
CVE-2012-3970
\*
MFSA 2012-64 / CVE-2012-3971: Using the Address
Sanitizer tool, Mozilla security researcher Christoph Diehl
discovered two memory corruption issues involving the
Graphite 2 library used in Mozilla products. Both of these
issues can cause a potentially exploitable crash. These
problems were fixed in the Graphite 2 library, which has
been updated for Mozilla products.
\*
MFSA 2012-65 / CVE-2012-3972: Security research
Nicolas Gregoire used the Address Sanitizer tool to
discover an out-of-bounds read in the format-number feature
of XSLT, which can cause inaccurate formatting of numbers
and information leakage. This is not directly exploitable.
\*
MFSA 2012-66 / CVE-2012-3973: Mozilla security
researcher Mark Goodwin discovered an issue with the
Firefox developer tools' debugger. If remote debugging is
disabled, but the experimental HTTPMonitor extension has
been installed and enabled, a remote user can connect to
and use the remote debugging service through the port used
by HTTPMonitor. A remote-enabled flag has been added to
resolve this problem and close the port unless debugging is
explicitly enabled.
\*
MFSA 2012-67 / CVE-2012-3974: Security researcher
Masato Kinugawa reported that if a crafted executable is
placed in the root partition on a Windows file system, the
Firefox and Thunderbird installer will launch this program
after a standard installation instead of Firefox or
Thunderbird, running this program with the user's
privileges.
\*
MFSA 2012-68 / CVE-2012-3975: Security researcher
vsemozhetbyt reported that when the DOMParser is used to
parse text/html data in a Firefox extension, linked
resources within this HTML data will be loaded. If the data
being parsed in the extension is untrusted, it could lead
to information leakage and can potentially be combined with
other attacks to become exploitable.
\*
MFSA 2012-69 / CVE-2012-3976: Security researcher
Mark Poticha reported an issue where incorrect SSL
certificate information can be displayed on the addressbar,
showing the SSL data for a previous site while another has
been loaded. This is caused by two onLocationChange events
being fired out of the expected order, leading to the
displayed certificate data to not be updated. This can be
used for phishing attacks by allowing the user to input
form or other data on a newer, attacking, site while the
credentials of an older site appear on the addressbar.
\*
MFSA 2012-70 / CVE-2012-3978: Mozilla security
researcher moz\_bug\_r\_a4 reported that certain security
checks in the location object can be bypassed if chrome
code is called content in a specific manner. This allowed
for the loading of restricted content. This can be combined
with other issues to become potentially exploitable.
\*
MFSA 2012-71 / CVE-2012-3979: Mozilla developer Blake
Kaplan reported that \_\_android\_log\_print is called
insecurely in places. If a malicious web page used a dump()
statement with a specially crafted string, it can trigger a
potentially exploitable crash.
This vulnerability only affects Firefox for Android.
\*
MFSA 2012-72 / CVE-2012-3980: Security researcher
Colby Russell discovered that eval in the web console can
execute injected code with chrome privileges, leading to
the running of malicious code in a privileged context. This
allows for arbitrary code execution through a malicious web
page if the web console is invoked by the user.
Indications:
Please install this update.
Patch Instructions:
To install this SUSE Security Update use YaST online\_update.
Alternatively you can run the command listed for your product:
- SUSE Linux Enterprise Software Development Kit 11 SP2:
zypper in -t patch sdksp2-firefox-201208-6763
- SUSE Linux Enterprise Server 11 SP2 for VMware:
zypper in -t patch slessp2-firefox-201208-6763
- SUSE Linux Enterprise Server 11 SP2:
zypper in -t patch slessp2-firefox-201208-6763
- SUSE Linux Enterprise Desktop 11 SP2:
zypper in -t patch sledsp2-firefox-201208-6763
To bring your system up-to-date, use "zypper patch".
Package List:
- SUSE Linux Enterprise Software Development Kit 11 SP2 (i586 ia64 ppc64 s390x x86\_64) [New Version: 3.13.6 and 4.9.2]:
mozilla-nspr-devel-4.9.2-0.6.1
mozilla-nss-devel-3.13.6-0.5.1
- SUSE Linux Enterprise Server 11 SP2 for VMware (i586 x86\_64) [New Version: 10.0.7,3.13.6 and 4.9.2]:
MozillaFirefox-10.0.7-0.3.1
MozillaFirefox-translations-10.0.7-0.3.1
libfreebl3-3.13.6-0.5.1
mozilla-nspr-4.9.2-0.6.1
mozilla-nss-3.13.6-0.5.1
mozilla-nss-tools-3.13.6-0.5.1
- SUSE Linux Enterprise Server 11 SP2 for VMware (x86\_64) [New Version: 3.13.6 and 4.9.2]:
libfreebl3-32bit-3.13.6-0.5.1
mozilla-nspr-32bit-4.9.2-0.6.1
mozilla-nss-32bit-3.13.6-0.5.1
- SUSE Linux Enterprise Server 11 SP2 (i586 ia64 ppc64 s390x x86\_64) [New Version: 10.0.7,3.13.6 and 4.9.2]:
MozillaFirefox-10.0.7-0.3.1
MozillaFirefox-branding-SLED-7-0.6.7.80
MozillaFirefox-translations-10.0.7-0.3.1
libfreebl3-3.13.6-0.5.1
mozilla-nspr-4.9.2-0.6.1
mozilla-nss-3.13.6-0.5.1
mozilla-nss-tools-3.13.6-0.5.1
- SUSE Linux Enterprise Server 11 SP2 (ppc64 s390x x86\_64) [New Version: 3.13.6 and 4.9.2]:
libfreebl3-32bit-3.13.6-0.5.1
mozilla-nspr-32bit-4.9.2-0.6.1
mozilla-nss-32bit-3.13.6-0.5.1
- SUSE Linux Enterprise Server 11 SP2 (ia64) [New Version: 3.13.6 and 4.9.2]:
libfreebl3-x86-3.13.6-0.5.1
mozilla-nspr-x86-4.9.2-0.6.1
mozilla-nss-x86-3.13.6-0.5.1
- SUSE Linux Enterprise Desktop 11 SP2 (i586 x86\_64) [New Version: 10.0.7,3.13.6 and 4.9.2]:
MozillaFirefox-10.0.7-0.3.1
MozillaFirefox-branding-SLED-7-0.6.7.80
MozillaFirefox-translations-10.0.7-0.3.1
libfreebl3-3.13.6-0.5.1
mozilla-nspr-4.9.2-0.6.1
mozilla-nss-3.13.6-0.5.1
mozilla-nss-tools-3.13.6-0.5.1
- SUSE Linux Enterprise Desktop 11 SP2 (x86\_64) [New Version: 3.13.6 and 4.9.2]:
libfreebl3-32bit-3.13.6-0.5.1
mozilla-nspr-32bit-4.9.2-0.6.1
mozilla-nss-32bit-3.13.6-0.5.1
References:
<https://bugzilla.novell.com/777588>
[http://download.novell.com/patch/finder/?keywords=eb74965ce2354d47597681ee9c...](http://download.novell.com/patch/finder/?keywords=eb74965ce2354d47597681ee9cf49621)
--
To unsubscribe, e-mail: opensuse-security-announce+unsubscribe@opensuse.org
For additional commands, e-mail: opensuse-security-announce+help@opensuse.org

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/)
Use email software

[Back to the thread](/archives/list/security-announce%40lists.opensuse.org/thread/ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25/#ZXQ3DJHWTXLCSUYUSYUSAW424F4W3V25)

[Back to the list](/archives/list/security-announce%40lists.opensuse.org/)

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from lists.opensuse.org_21831c24_20250125_013409.html ===


[![openSUSE](https://static.opensuse.org/favicon.svg)
Mailing Lists](/archives/ "openSUSE Mailing Lists")

[Sign In](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40lists.opensuse.org/message/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/)

[Manage this list](/manage/lists/security-announce.lists.opensuse.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40lists.opensuse.org/message/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[thread](/archives/list/security-announce%40lists.opensuse.org/thread/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/#6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7)

# [security-announce] SUSE-SU-2012:1167-1: important: Security update for Mozilla Firefox

![](https://seccdn.libravatar.org/avatar/099a17325bdf082b643d1a6bbacde279.jpg?s=120&d=mm&r=g)
## [opensuse-security＠opensuse.org](/archives/users/1b72def497ef4503896cd7a5fe9fb8e0/ "See the profile for opensuse-security＠opensuse.org")

14 Sep
2012

14 Sep
'12

00:08

SUSE Security Update: Security update for Mozilla Firefox
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Announcement ID: SUSE-SU-2012:1167-1
Rating: important
References: #684069 #769762 #777588
Cross-References: CVE-2012-1956 CVE-2012-1970 CVE-2012-1971
CVE-2012-1972 CVE-2012-1973 CVE-2012-1974
CVE-2012-1975 CVE-2012-1976 CVE-2012-3956
CVE-2012-3957 CVE-2012-3958 CVE-2012-3959
CVE-2012-3960 CVE-2012-3961 CVE-2012-3962
CVE-2012-3963 CVE-2012-3964 CVE-2012-3965
CVE-2012-3966 CVE-2012-3967 CVE-2012-3968
CVE-2012-3969 CVE-2012-3970 CVE-2012-3971
CVE-2012-3972 CVE-2012-3973 CVE-2012-3974
CVE-2012-3975 CVE-2012-3976 CVE-2012-3978
CVE-2012-3979 CVE-2012-3980
Affected Products:
SUSE Linux Enterprise Server 10 SP4
SUSE Linux Enterprise Desktop 10 SP4
SLE SDK 10 SP4
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
An update that fixes 32 vulnerabilities is now available.
It includes three new package versions.
Description:
MozillaFirefox was updated to 10.0.7ESR release, fixing a
lot of bugs and security problems.
The following security issues have been addressed:
\*
MFSA 2012-57: Mozilla developers identified and fixed
several memory safety bugs in the browser engine used in
Firefox and other Mozilla-based products. Some of these
bugs showed evidence of memory corruption under certain
circumstances, and we presume that with enough effort at
least some of these could be exploited to run arbitrary
code.
In general these flaws cannot be exploited through
email in the Thunderbird and SeaMonkey products because
scripting is disabled, but are potentially a risk in
browser or browser-like contexts in those products.
\*
CVE-2012-1971: Gary Kwong, Christian Holler, Jesse
Ruderman, Steve Fink, Bob Clary, Andrew Sutherland, and
Jason Smith reported memory safety problems and crashes
that affect Firefox 14.
\*
CVE-2012-1970: Gary Kwong, Christian Holler, Jesse
Ruderman, John Schoenick, Vladimir Vukicevic and Daniel
Holbert reported memory safety problems and crashes that
affect Firefox ESR 10 and Firefox 14.
\*
MFSA 2012-58: Security researcher Abhishek Arya
(Inferno) of Google Chrome Security Team discovered a
series of use-after-free issues using the Address Sanitizer
tool. Many of these issues are potentially exploitable,
allowing for remote code execution.
o Heap-use-after-free in
nsHTMLEditor::CollapseAdjacentTextNodes CVE-2012-1972 o
Heap-use-after-free in nsObjectLoadingContent::LoadObject
CVE-2012-1973 o Heap-use-after-free in
gfxTextRun::CanBreakLineBefore CVE-2012-1974 o
Heap-use-after-free in PresShell::CompleteMove
CVE-2012-1975 o Heap-use-after-free in
nsHTMLSelectElement::SubmitNamesValues CVE-2012-1976 o
Heap-use-after-free in
MediaStreamGraphThreadRunnable::Run() CVE-2012-3956 o
Heap-buffer-overflow in nsBlockFrame::MarkLineDirty
CVE-2012-3957 o Heap-use-after-free in
nsHTMLEditRules::DeleteNonTableElements CVE-2012-3958 o
Heap-use-after-free in nsRangeUpdater::SelAdjDeleteNode
CVE-2012-3959 o Heap-use-after-free in
mozSpellChecker::SetCurrentDictionary CVE-2012-3960 o
Heap-use-after-free in RangeData::~RangeData CVE-2012-3961
o Bad iterator in text runs CVE-2012-3962 o use after free
in js::gc::MapAllocToTraceKind CVE-2012-3963 o
Heap-use-after-free READ 8 in gfxTextRun::GetUserData
CVE-2012-3964
\*
MFSA 2012-59 / CVE-2012-1956: Security researcher
Mariusz Mlynski reported that it is possible to shadow the
location object using Object.defineProperty. This could be
used to confuse the current location to plugins, allowing
for possible cross-site scripting (XSS) attacks.
\*
MFSA 2012-60 / CVE-2012-3965: Security researcher
Mariusz Mlynski reported that when a page opens a new tab,
a subsequent window can then be opened that can be
navigated to about:newtab, a chrome privileged page. Once
about:newtab is loaded, the special context can potentially
be used to escalate privilege, allowing for arbitrary code
execution on the local system in a maliciously crafted
attack.
\*
MFSA 2012-61 / CVE-2012-3966: Security researcher
Frederic Hoguin reported two related issues with the
decoding of bitmap (.BMP) format images embedded in icon
(.ICO) format files. When processing a negative "height"
header value for the bitmap image, a memory corruption can
be induced, allowing an attacker to write random memory and
cause a crash. This crash may be potentially exploitable.
\*
MFSA 2012-62: Security researcher miaubiz used the
Address Sanitizer tool to discover two WebGL issues. The
first issue is a use-after-free when WebGL shaders are
called after being destroyed. The second issue exposes a
problem with Mesa drivers on Linux, leading to a
potentially exploitable crash.
o
use after free, webgl fragment shader deleted
by accessor CVE-2012-3968
o
stack scribbling with 4-byte values choosable
among a few values, when using more than 16 sampler
uniforms, on Mesa, with all drivers CVE-2012-3967
\*
MFSA 2012-63: Security researcher Arthur Gerkis used
the Address Sanitizer tool to find two issues involving
Scalable Vector Graphics (SVG) files. The first issue is a
buffer overflow in Gecko's SVG filter code when the sum of
two values is too large to be stored as a signed 32-bit
integer, causing the function to write past the end of an
array. The second issue is a use-after-free when an element
with a "requiredFeatures" attribute is moved between
documents. In that situation, the internal representation
of the "requiredFeatures" value could be freed prematurely.
Both issues are potentially exploitable.
o
Heap-buffer-overflow in
nsSVGFEMorphologyElement::Filter CVE-2012-3969
o
Heap-use-after-free in nsTArray\_base::Length()
CVE-2012-3970
\*
MFSA 2012-64 / CVE-2012-3971: Using the Address
Sanitizer tool, Mozilla security researcher Christoph Diehl
discovered two memory corruption issues involving the
Graphite 2 library used in Mozilla products. Both of these
issues can cause a potentially exploitable crash. These
problems were fixed in the Graphite 2 library, which has
been updated for Mozilla products.
\*
MFSA 2012-65 / CVE-2012-3972: Security research
Nicolas Gregoire used the Address Sanitizer tool to
discover an out-of-bounds read in the format-number feature
of XSLT, which can cause inaccurate formatting of numbers
and information leakage. This is not directly exploitable.
\*
MFSA 2012-66 / CVE-2012-3973: Mozilla security
researcher Mark Goodwin discovered an issue with the
Firefox developer tools' debugger. If remote debugging is
disabled, but the experimental HTTPMonitor extension has
been installed and enabled, a remote user can connect to
and use the remote debugging service through the port used
by HTTPMonitor. A remote-enabled flag has been added to
resolve this problem and close the port unless debugging is
explicitly enabled.
\*
MFSA 2012-67 / CVE-2012-3974: Security researcher
Masato Kinugawa reported that if a crafted executable is
placed in the root partition on a Windows file system, the
Firefox and Thunderbird installer will launch this program
after a standard installation instead of Firefox or
Thunderbird, running this program with the user's
privileges.
\*
MFSA 2012-68 / CVE-2012-3975: Security researcher
vsemozhetbyt reported that when the DOMParser is used to
parse text/html data in a Firefox extension, linked
resources within this HTML data will be loaded. If the data
being parsed in the extension is untrusted, it could lead
to information leakage and can potentially be combined with
other attacks to become exploitable.
\*
MFSA 2012-69 / CVE-2012-3976: Security researcher
Mark Poticha reported an issue where incorrect SSL
certificate information can be displayed on the addressbar,
showing the SSL data for a previous site while another has
been loaded. This is caused by two onLocationChange events
being fired out of the expected order, leading to the
displayed certificate data to not be updated. This can be
used for phishing attacks by allowing the user to input
form or other data on a newer, attacking, site while the
credentials of an older site appear on the addressbar.
\*
MFSA 2012-70 / CVE-2012-3978: Mozilla security
researcher moz\_bug\_r\_a4 reported that certain security
checks in the location object can be bypassed if chrome
code is called content in a specific manner. This allowed
for the loading of restricted content. This can be combined
with other issues to become potentially exploitable.
\*
MFSA 2012-71 / CVE-2012-3979: Mozilla developer Blake
Kaplan reported that \_\_android\_log\_print is called
insecurely in places. If a malicious web page used a dump()
statement with a specially crafted string, it can trigger a
potentially exploitable crash.
This vulnerability only affects Firefox for Android.
\*
MFSA 2012-72 / CVE-2012-3980: Security researcher
Colby Russell discovered that eval in the web console can
execute injected code with chrome privileges, leading to
the running of malicious code in a privileged context. This
allows for arbitrary code execution through a malicious web
page if the web console is invoked by the user.
Security Issue references:
\* CVE-2012-1971
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1971>

...

\* CVE-2012-1970
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1970>

...

\* CVE-2012-1972
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1972>

...

\* CVE-2012-1973
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1973>

...

\* CVE-2012-1974
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1974>

...

\* CVE-2012-1975
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1975>

...

\* CVE-2012-1976
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1976>

...

\* CVE-2012-3956
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3956>

...

\* CVE-2012-3957
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3957>

...

\* CVE-2012-3958
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3958>

...

\* CVE-2012-3959
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3959>

...

\* CVE-2012-3960
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3960>

...

\* CVE-2012-3961
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3961>

...

\* CVE-2012-3962
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3962>

...

\* CVE-2012-3963
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3963>

...

\* CVE-2012-3964
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3964>

...

\* CVE-2012-1956
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-1956>

...

\* CVE-2012-3965
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3965>

...

\* CVE-2012-3966
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3966>

...

\* CVE-2012-3968
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3968>

...

\* CVE-2012-3967
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3967>

...

\* CVE-2012-3969
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3969>

...

\* CVE-2012-3970
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3970>

...

\* CVE-2012-3971
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3971>

...

\* CVE-2012-3972
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3972>

...

\* CVE-2012-3973
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3973>

...

\* CVE-2012-3974
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3974>

...

\* CVE-2012-3975
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3975>

...

\* CVE-2012-3976
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3976>

...

\* CVE-2012-3978
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3978>

...

\* CVE-2012-3979
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3979>

...

\* CVE-2012-3980
<<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-3980>

...

Indications:
Please install this update.
Package List:
- SUSE Linux Enterprise Server 10 SP4 (i586 ia64 ppc s390x x86\_64) [New Version: 3.13.6 and 4.9.2]:
firefox3-cairo-1.2.4-0.8.1
mozilla-nspr-4.9.2-0.9.1
mozilla-nspr-devel-4.9.2-0.9.1
mozilla-nss-3.13.6-0.8.1
mozilla-nss-devel-3.13.6-0.8.1
mozilla-nss-tools-3.13.6-0.8.1
- SUSE Linux Enterprise Server 10 SP4 (i586 ia64 ppc s390x) [New Version: 7]:
MozillaFirefox-10.0.7-0.5.1
MozillaFirefox-branding-SLED-7-0.8.31
MozillaFirefox-translations-10.0.7-0.5.1
- SUSE Linux Enterprise Server 10 SP4 (s390x x86\_64) [New Version: 3.13.6 and 4.9.2]:
firefox3-cairo-32bit-1.2.4-0.8.1
mozilla-nspr-32bit-4.9.2-0.9.1
mozilla-nss-32bit-3.13.6-0.8.1
- SUSE Linux Enterprise Server 10 SP4 (ia64) [New Version: 3.13.6 and 4.9.2]:
mozilla-nspr-x86-4.9.2-0.9.1
mozilla-nss-x86-3.13.6-0.8.1
- SUSE Linux Enterprise Server 10 SP4 (ppc) [New Version: 3.13.6 and 4.9.2]:
mozilla-nspr-64bit-4.9.2-0.9.1
mozilla-nss-64bit-3.13.6-0.8.1
- SUSE Linux Enterprise Desktop 10 SP4 (i586 x86\_64) [New Version: 3.13.6 and 4.9.2]:
firefox3-cairo-1.2.4-0.8.1
mozilla-nspr-4.9.2-0.9.1
mozilla-nspr-devel-4.9.2-0.9.1
mozilla-nss-3.13.6-0.8.1
mozilla-nss-devel-3.13.6-0.8.1
mozilla-nss-tools-3.13.6-0.8.1
- SUSE Linux Enterprise Desktop 10 SP4 (x86\_64) [New Version: 3.13.6 and 4.9.2]:
firefox3-cairo-32bit-1.2.4-0.8.1
mozilla-nspr-32bit-4.9.2-0.9.1
mozilla-nss-32bit-3.13.6-0.8.1
- SUSE Linux Enterprise Desktop 10 SP4 (i586) [New Version: 7]:
MozillaFirefox-10.0.7-0.5.1
MozillaFirefox-branding-SLED-7-0.8.31
MozillaFirefox-translations-10.0.7-0.5.1
- SLE SDK 10 SP4 (i586 ia64 ppc s390x x86\_64) [New Version: 3.13.6]:
firefox3-cairo-devel-1.2.4-0.8.1
firefox3-cairo-doc-1.2.4-0.8.1
mozilla-nss-tools-3.13.6-0.8.1
- SLE SDK 10 SP4 (i586 ia64 ppc s390x):
MozillaFirefox-branding-upstream-10.0.7-0.5.1
References:
<http://support.novell.com/security/cve/CVE-2012-1956.html>
<http://support.novell.com/security/cve/CVE-2012-1970.html>
<http://support.novell.com/security/cve/CVE-2012-1971.html>
<http://support.novell.com/security/cve/CVE-2012-1972.html>
<http://support.novell.com/security/cve/CVE-2012-1973.html>
<http://support.novell.com/security/cve/CVE-2012-1974.html>
<http://support.novell.com/security/cve/CVE-2012-1975.html>
<http://support.novell.com/security/cve/CVE-2012-1976.html>
<http://support.novell.com/security/cve/CVE-2012-3956.html>
<http://support.novell.com/security/cve/CVE-2012-3957.html>
<http://support.novell.com/security/cve/CVE-2012-3958.html>
<http://support.novell.com/security/cve/CVE-2012-3959.html>
<http://support.novell.com/security/cve/CVE-2012-3960.html>
<http://support.novell.com/security/cve/CVE-2012-3961.html>
<http://support.novell.com/security/cve/CVE-2012-3962.html>
<http://support.novell.com/security/cve/CVE-2012-3963.html>
<http://support.novell.com/security/cve/CVE-2012-3964.html>
<http://support.novell.com/security/cve/CVE-2012-3965.html>
<http://support.novell.com/security/cve/CVE-2012-3966.html>
<http://support.novell.com/security/cve/CVE-2012-3967.html>
<http://support.novell.com/security/cve/CVE-2012-3968.html>
<http://support.novell.com/security/cve/CVE-2012-3969.html>
<http://support.novell.com/security/cve/CVE-2012-3970.html>
<http://support.novell.com/security/cve/CVE-2012-3971.html>
<http://support.novell.com/security/cve/CVE-2012-3972.html>
<http://support.novell.com/security/cve/CVE-2012-3973.html>
<http://support.novell.com/security/cve/CVE-2012-3974.html>
<http://support.novell.com/security/cve/CVE-2012-3975.html>
<http://support.novell.com/security/cve/CVE-2012-3976.html>
<http://support.novell.com/security/cve/CVE-2012-3978.html>
<http://support.novell.com/security/cve/CVE-2012-3979.html>
<http://support.novell.com/security/cve/CVE-2012-3980.html>
<https://bugzilla.novell.com/684069>
<https://bugzilla.novell.com/769762>
<https://bugzilla.novell.com/777588>
[http://download.novell.com/patch/finder/?keywords=3d961c9ba7250844680b248327...](http://download.novell.com/patch/finder/?keywords=3d961c9ba7250844680b248327a712ac)
--
To unsubscribe, e-mail: opensuse-security-announce+unsubscribe@opensuse.org
For additional commands, e-mail: opensuse-security-announce+help@opensuse.org

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40lists.opensuse.org/message/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/)
Use email software

[Back to the thread](/archives/list/security-announce%40lists.opensuse.org/thread/6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7/#6ISUZHQGG3T7QUJEJP6MOAM7T7652GA7)

[Back to the list](/archives/list/security-announce%40lists.opensuse.org/)

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from bugzilla.mozilla.org_72914c64_20250125_013426.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/748119)
* [XML](/show_bug.cgi?ctype=xml&id=748119)

Closed
[Bug 748119](/show_bug.cgi?id=748119)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(\*thingp)), at jsgc.cpp:4284

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: IsMarkedOrAllocated(static\_cast<Cell \*>(\*thingp)), at jsgc.cpp:4284

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 |  | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: billm)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/81db2831554209472ec9b0d5485ca1c9?d=mm&size=40)  [billm](/user_profile?user_id=389993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[746136](/show_bug.cgi?id=746136 "RESOLVED DUPLICATE - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(*thingp)), at js/src/jsgc.cpp:4284")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-critical, testcase, Whiteboard: js-triage-needed, [sg:critical][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

js-triage-needed, [sg:critical][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [decoder](/user_profile?user_id=395101) | [in-testsuite](#c9 "12 years ago") | + |
| --- | --- | --- |
| [decoder](/user_profile?user_id=395101) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Test case for shell (run with -n -m -a)](/attachment.cgi?id=617640)  [13 years ago](#c0)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   2.74 KB, application/javascript |  | [Details](/attachment.cgi?id=617640&action=edit) |
| --- | --- | --- |
| [TI patch](/attachment.cgi?id=620919)  [13 years ago](#c1)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   2.69 KB, patch | bhackett1024 : [review+](#a1131388_346231 "13 years ago") | [Details](/attachment.cgi?id=620919&action=edit) | [Diff](/attachment.cgi?id=620919&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=748119&attachment=620919) |
| [verifier patch](/attachment.cgi?id=620922)  [13 years ago](#c2)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   2.00 KB, patch | bhackett1024 : [review+](#a1131453_346231 "13 years ago") | [Details](/attachment.cgi?id=620922&action=edit) | [Diff](/attachment.cgi?id=620922&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=748119&attachment=620922) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=748119#c0)• 13 years ago |
|  | |

Attached file
[Test case for shell (run with -n -m -a)](attachment.cgi?id=617640)
— [Details](attachment.cgi?id=617640&action=edit)

The attached test asserts on mozilla-central revision 17af008937e3 (options -m -n -a).

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a76154_389993)• 13 years ago |

Assignee: general → wmccloskey

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=748119#c1)• 13 years ago |
|  | |

Attached patch

[TI patch](attachment.cgi?id=620919&action=diff)
— [Details](attachment.cgi?id=620919&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=748119&attachment=620919)

This test exposed two problems. The first one is that we need read barriers on the TypeObjects and JSObjects that are stored in Types. Here's what can go wrong:
1. Incremental GC starts.
2. Type object that will eventually be swept is read out from the compiler. Some component of it (newScript->fun in this case) is copied to some other location so that it's now reachable.
3. We fail to mark the type object and its newScript->fun component, so potentially it gets collected. Later, it can be accessed.
It seems pretty easy to fix the problem. We just need to invoke a read barrier whenever we read anything out of a Type. I'm guessing that this isn't a very hot path.
[Attachment #620919](/attachment.cgi?id=620919&action=edit "TI patch") -
Flags: review?(bhackett1024)

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=748119#c2)• 13 years ago |
|  | |

Attached patch

[verifier patch](attachment.cgi?id=620922&action=diff)
— [Details](attachment.cgi?id=620922&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=748119&attachment=620922)

Unfortunately, even with the first patch, we still fail the test.
The barrier verifier is actually doing two checks:
1. If some object has a field that changes while JS is running, then the original value of the field should be marked. This checks the correctness of write barriers.
2. Any object that is reachable at the end of verification was reachable at the beginning, or else it was marked. This is mostly to check that read barriers are invoked correctly.
In this test, the read barrier causes us to mark the original TypeObject that we fetch out of the Type. But we don't transitively mark everything reachable from it. In a real GC that would happen, but the verifier doesn't mimic the GC closely enough. It just notices that that the object that was found via the newScript->fun access from the type object is reachable and unmarked, so it asserts.
To really check #2 above, I should be transitively marking forward from everything marked via a read barrier. Then the assertion would pass. However, this is kind of a pain to do. So I'd like to just remove the #2 assertions. They've been the cause of a lot of false positives, including [bug 729571](/show_bug.cgi?id=729571 "RESOLVED FIXED - Assertion failure: IsMarkedOrAllocated(static_cast<Cell *>(*thingp)), at jsgc.cpp:4363"), which is still outstanding.
Brian, if you don't want to review this, I can give it to Igor. It's really just removing a bogus assert, though.
[Attachment #620922](/attachment.cgi?id=620922&action=edit "verifier patch") -
Flags: review?(bhackett1024)

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a1131388_346231)• 13 years ago |

[Attachment #620919](/attachment.cgi?id=620919&action=edit "TI patch") -
Flags: review?(bhackett1024) → review+

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a1131453_346231)• 13 years ago |

[Attachment #620922](/attachment.cgi?id=620922&action=edit "verifier patch") -
Flags: review?(bhackett1024) → review+

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=748119#c4)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/3a3737f41b41>
<https://hg.mozilla.org/integration/mozilla-inbound/rev/f6f8a9d335fe>Target Milestone: --- → mozilla15

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=748119#c5)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/f6f8a9d335fe>
<https://hg.mozilla.org/mozilla-central/rev/3a3737f41b41>Status: NEW → RESOLVEDClosed: 13 years agoResolution: --- → FIXED

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=748119#c6)• 13 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a1225929_395101)• 13 years ago |

Status: RESOLVED → VERIFIED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=748119#c7)• 13 years ago |
|  | |

How far back does this problem go? Does it affect the ESR-10 branch?
I see a reference in the patch to IsIncrementalGCSafe() so maybe this is all new code? Or maybe only that part of it?
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)Whiteboard: js-triage-needed → js-triage-needed, [sg:critical]

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=748119#c8)• 13 years ago |
|  | |

This only affect incremental GC, which is still disabled by default.

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a2687301_272375)• 13 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a6037481_278074)• 13 years ago |

Depends on: [770268](/show_bug.cgi?id=770268 "RESOLVED FIXED - jsinfer.h:98:24: warning: inline function ‘js::types::TypeObject* js::types::Type::typeObject() const’ used but never defined [enabled by default] (also for \"singleObject() const\")")

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a6038130_278074)• 13 years ago |

No longer depends on: [770268](/show_bug.cgi?id=770268 "RESOLVED FIXED - jsinfer.h:98:24: warning: inline function ‘js::types::TypeObject* js::types::Type::typeObject() const’ used but never defined [enabled by default] (also for \"singleObject() const\")")

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a9170288_280903)• 12 years ago |

Whiteboard: js-triage-needed, [sg:critical] → js-triage-needed, [sg:critical][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=748119#a15667578_1689)• 12 years ago |

Group: core-security

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=748119#c9)• 12 years ago |
|  | |

Automatically extracted testcase for this bug was committed:
<https://hg.mozilla.org/mozilla-central/rev/efaf8960a929>Flags: in-testsuite+
You need to [log in](/show_bug.cgi?id=748119&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Christian Holler (:decoder)](/user_profile?user_id=395101)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_bba62416_20250125_013435.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/752087)
* [XML](/show_bug.cgi?ctype=xml&id=752087)

Closed
[Bug 752087](/show_bug.cgi?id=752087)

Opened 13 years ago
Closed 13 years ago

# Crash [@ js::GetObjectClass(JSObject const \*)] | [@ nsXPConnect::GetNativeOfWrapper]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash [@ js::GetObjectClass(JSObject const \*)] | [@ nsXPConnect::GetNativeOfWrapper]

## Categories

### (Core :: Audio/Video, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Audio%2FVideo#Audio%2FVideo)

Audio/Video
▾

Core :: Audio/Video
For problems related to media (video/audio) -- especially when the reporter is not sure which area of the media stack the problem is in. This category will mostly be for untriaged video/audio issues. Bugs in this category will typically be moved to another media category during the triage process.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Audio%2FVideo)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-) | --- |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 |  | fixed |
| firefox-esr10 | - |  |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: bc, Assigned: jesup)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/ae002109ba1cfbb7f5ad990cc5d9fbaf?d=mm&size=40)  [jesup](/user_profile?user_id=11539)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/ee4c7c6351b45c4655e16993a29979b0?d=mm&size=40)  [bc](/user_profile?user_id=23402)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](extensions/Gravatar/web/default.jpg)  [jimm](/user_profile?user_id=279663)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

### ( [URL](http://www.ohmstudio.com/ "http://www.ohmstudio.com/") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[664918](/show_bug.cgi?id=664918 "RESOLVED FIXED - Infrastructure for media stream graph processing")

Dependency [tree](/showdependencytree.cgi?id=752087&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=752087)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[752826](/show_bug.cgi?id=752826 "RESOLVED DUPLICATE - crash in nsHTMLMediaElement::SetSrc @ js::IsProxy")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[ohmstudio.com](http://www.ohmstudio.com/ "http://www.ohmstudio.com/")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: crash, Whiteboard: [inbound][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[inbound][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::GetObjectClass(JSObject const \*) ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3AGetObjectClass%28JSObject%20const%20%2A%29)

[[@ nsXPConnect::GetNativeOfWrapper ]](https://crash-stats.mozilla.org/signature/?signature=nsXPConnect%3A%3AGetNativeOfWrapper)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files, 4 obsolete files)

| [Debug Crash Report](/attachment.cgi?id=621204)  [13 years ago](#c0)  [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)   61.91 KB, text/plain |  | [Details](/attachment.cgi?id=621204&action=edit) |
| --- | --- | --- |
| [Use correct method to check is a jsval is an object](/attachment.cgi?id=621387)  [13 years ago](#c3)  [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)   1.13 KB, patch | roc : [review+](#c5 "13 years ago") | [Details](/attachment.cgi?id=621387&action=edit) | [Diff](/attachment.cgi?id=621387&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621387) |
| [Use correct method to check is a jsval is an object and tests](/attachment.cgi?id=621535)  [13 years ago](#c6)  [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)   2.18 KB, patch |  | [Details](/attachment.cgi?id=621535&action=edit) | [Diff](/attachment.cgi?id=621535&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621535) |
| [Use correct method to check is a jsval is an object and tests](/attachment.cgi?id=621565)  [13 years ago](#c10)  [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)   3.10 KB, patch |  | [Details](/attachment.cgi?id=621565&action=edit) | [Diff](/attachment.cgi?id=621565&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621565) |
| [Use correct method to check is a jsval is an object and tests (minor update)](/attachment.cgi?id=621580)  [13 years ago](#c12)  [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)   3.17 KB, patch |  | [Details](/attachment.cgi?id=621580&action=edit) | [Diff](/attachment.cgi?id=621580&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621580) |
| [Use correct method to check is a jsval is an object and tests (minor update)](/attachment.cgi?id=621581)  [13 years ago](#c13)  [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)   3.17 KB, patch | roc : [review+](#a258000_5038 "13 years ago") | [Details](/attachment.cgi?id=621581&action=edit) | [Diff](/attachment.cgi?id=621581&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621581) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=752087#c0)• 13 years ago |
|  | |

Attached file
[Debug Crash Report](attachment.cgi?id=621204)
— [Details](attachment.cgi?id=621204&action=edit)

<http://us.blizzard.com/en-us/games/music/sc2-wings-of-liberty.html>
<http://www.ohmstudio.com/>
###!!! ASSERTION: bad param: 'aJSObj', file /work/mozilla/builds/nightly/mozilla/js/xpconnect/src/nsXPConnect.cpp, line 1429
###!!! ASSERTION: bad param: 'obj', file /work/mozilla/builds/nightly/mozilla/js/xpconnect/src/XPCWrappedNative.cpp, line 1786
Nightly Debug Crash @ js::GetObjectClass(JSObject const \*)
Nightly Opt Crash @ nsXPConnect::GetNativeOfWrapper
[bp-412995f0-045d-485c-92aa-daf952120504](https://crash-stats.mozilla.org/report/index/412995f0-045d-485c-92aa-daf952120504)
[bp-c96d3eee-924d-41d4-8a20-7e6832120504](https://crash-stats.mozilla.org/report/index/c96d3eee-924d-41d4-8a20-7e6832120504)
Marking s-s since [bug 729812](/show_bug.cgi?id=729812 "VERIFIED FIXED - IonMonkey: Crash [@ js::GetObjectClass]") is s-s, but this is a crash at null. This may be a dupe of that though.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=752087#c1)• 13 years ago |
|  | |

(In reply to Bob Clary [:bc:] from [comment #0](/show_bug.cgi?id=752087#c0 "VERIFIED FIXED - Crash [@ js::GetObjectClass(JSObject const *)] | [@ nsXPConnect::GetNativeOfWrapper]"))
> Marking s-s since [bug 729812](/show_bug.cgi?id=729812 "VERIFIED FIXED - IonMonkey: Crash [@ js::GetObjectClass]") is s-s, but this is a crash at null. This may
> be a dupe of that though.
That other bug is on the IonMonkey branch, so it's unlikely that this is the same issue.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=752087#c2)• 13 years ago |
|  | |

This is actually a media bug. nsHTMLMediaElement::SetSrc has:
482 if (JSVAL\_IS\_OBJECT(aParams)) {
483 nsCOMPtr<nsIDOMMediaStream> stream;
484 stream = do\_QueryInterface(nsContentUtils::XPConnect()->
485 GetNativeOfWrapper(aCtx, JSVAL\_TO\_OBJECT(aParams)));
But JSVAL\_IS\_OBJECT is true for null (in which case JSVAL\_TO\_OBJECT will return a null JSObject\*). This should presumably be testing !JSVAL\_IS\_PRIMITIVE, or better yet aParams.isObject() (which excludes null).
I don't think this is exploitable; it's a guaranteed null-deref. Probably completely unrelated to [bug 729812](/show_bug.cgi?id=729812 "VERIFIED FIXED - IonMonkey: Crash [@ js::GetObjectClass]").Assignee: general → nobodyBlocks: [664918](/show_bug.cgi?id=664918 "RESOLVED FIXED - Infrastructure for media stream graph processing")Component: JavaScript Engine → Video/AudioQA Contact: general → video.audio

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=752087#c3)• 13 years ago |
|  | |

Attached patch

[Use correct method to check is a jsval is an object](attachment.cgi?id=621387&action=diff) (obsolete)
— [Details](attachment.cgi?id=621387&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621387)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=752087#c4)• 13 years ago |
|  | |

Comment on [attachment 621387](/attachment.cgi?id=621387 "Use correct method to check is a jsval is an object") [[details]](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") [[diff]](/attachment.cgi?id=621387&action=diff "Use correct method to check is a jsval is an object") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621387)
Use correct method to check is a jsval is an object
Patch per bz's analysis (I verified the bug in GDB, and that the fix corrects it)
Full try build pushed (against inbound):
<https://tbpl.mozilla.org/?tree=Try&rev=21b02e25bdb4>
Methinks these functions/defines aren't quite properly named...
Before landing we should add a test as well.
[Attachment #621387](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") -
Flags: review?(roc)

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=752087#c5)• 13 years ago |
|  | |

Comment on [attachment 621387](/attachment.cgi?id=621387 "Use correct method to check is a jsval is an object") [[details]](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") [[diff]](/attachment.cgi?id=621387&action=diff "Use correct method to check is a jsval is an object") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621387)
Use correct method to check is a jsval is an object
Review of [attachment 621387](/attachment.cgi?id=621387 "Use correct method to check is a jsval is an object") [[details]](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") [[diff]](/attachment.cgi?id=621387&action=diff "Use correct method to check is a jsval is an object") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621387):
-----------------------------------------------------------------
Thank you!
[Attachment #621387](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") -
Flags: review?(roc) → review+

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=752087#c6)• 13 years ago |
|  | |

Attached patch

[Use correct method to check is a jsval is an object and tests](attachment.cgi?id=621535&action=diff) (obsolete)
— [Details](attachment.cgi?id=621535&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621535)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a207984_11539)• 13 years ago |

[Attachment #621387](/attachment.cgi?id=621387&action=edit "Use correct method to check is a jsval is an object") -
Attachment is obsolete: true

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=752087#c7)• 13 years ago |
|  | |

Comment on [attachment 621535](/attachment.cgi?id=621535 "Use correct method to check is a jsval is an object and tests") [[details]](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") [[diff]](/attachment.cgi?id=621535&action=diff "Use correct method to check is a jsval is an object and tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621535)
Use correct method to check is a jsval is an object and tests
Just need review on the test; no change to code. Verified without the patch we crash, with the patch we work (loading the test directly from a file).
Try push:
<https://tbpl.mozilla.org/?tree=Try&rev=b7f96aebd7f8>
[Attachment #621535](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") -
Flags: review?(roc)

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=752087#c8)• 13 years ago |
|  | |

Comment on [attachment 621535](/attachment.cgi?id=621535 "Use correct method to check is a jsval is an object and tests") [[details]](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") [[diff]](/attachment.cgi?id=621535&action=diff "Use correct method to check is a jsval is an object and tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621535)
Use correct method to check is a jsval is an object and tests
Review of [attachment 621535](/attachment.cgi?id=621535 "Use correct method to check is a jsval is an object and tests") [[details]](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") [[diff]](/attachment.cgi?id=621535&action=diff "Use correct method to check is a jsval is an object and tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621535):
-----------------------------------------------------------------
You need to hg add test\_source\_null.html

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=752087#c9)• 13 years ago |
|  | |

Weird, I did add it.
It may have been confused by a qpop (to check failure before)/qpush combo; the push failed to apply the test file I added (generated a .rej file) because it existed (to test without the code patch). But I hg qref'd after that, I figured that would resolve it. Apparently it decided to resolve it by removing the file... Sigh. Should have looked more closely at the list-of-files qref dumps - it was late here.
Update in a sec.

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=752087#c10)• 13 years ago |
|  | |

Attached patch

[Use correct method to check is a jsval is an object and tests](attachment.cgi?id=621565&action=diff) (obsolete)
— [Details](attachment.cgi?id=621565&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621565)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a221354_11539)• 13 years ago |

[Attachment #621535](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") -
Attachment is obsolete: true
[Attachment #621535](/attachment.cgi?id=621535&action=edit "Use correct method to check is a jsval is an object and tests") -
Flags: review?(roc)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=752087#c11)• 13 years ago |
|  | |

Comment on [attachment 621565](/attachment.cgi?id=621565 "Use correct method to check is a jsval is an object and tests") [[details]](/attachment.cgi?id=621565&action=edit "Use correct method to check is a jsval is an object and tests") [[diff]](/attachment.cgi?id=621565&action=diff "Use correct method to check is a jsval is an object and tests") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621565)
Use correct method to check is a jsval is an object and tests
Test is there now.
Try push:
<https://tbpl.mozilla.org/?tree=Try&rev=7f5a2c571cb5>
[Attachment #621565](/attachment.cgi?id=621565&action=edit "Use correct method to check is a jsval is an object and tests") -
Flags: review?(roc)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=752087#c12)• 13 years ago |
|  | |

Attached patch

[Use correct method to check is a jsval is an object and tests (minor update)](attachment.cgi?id=621580&action=diff) (obsolete)
— [Details](attachment.cgi?id=621580&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621580)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a227177_11539)• 13 years ago |

[Attachment #621565](/attachment.cgi?id=621565&action=edit "Use correct method to check is a jsval is an object and tests") -
Attachment is obsolete: true
[Attachment #621565](/attachment.cgi?id=621565&action=edit "Use correct method to check is a jsval is an object and tests") -
Flags: review?(roc)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=752087#c13)• 13 years ago |
|  | |

Attached patch

[Use correct method to check is a jsval is an object and tests (minor update)](attachment.cgi?id=621581&action=diff)
— [Details](attachment.cgi?id=621581&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621581)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a227293_11539)• 13 years ago |

[Attachment #621580](/attachment.cgi?id=621580&action=edit "Use correct method to check is a jsval is an object and tests (minor update)") -
Attachment is obsolete: true

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=752087#c14)• 13 years ago |
|  | |

Comment on [attachment 621581](/attachment.cgi?id=621581 "Use correct method to check is a jsval is an object and tests (minor update)") [[details]](/attachment.cgi?id=621581&action=edit "Use correct method to check is a jsval is an object and tests (minor update)") [[diff]](/attachment.cgi?id=621581&action=diff "Use correct method to check is a jsval is an object and tests (minor update)") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752087&attachment=621581)
Use correct method to check is a jsval is an object and tests (minor update)
Ok, you need ok() in the test infrastructure (which is why I run try...) :-)
New try build at <https://tbpl.mozilla.org/?tree=Try&rev=77874b64b6da>
Note there's a bug causing a lot of random reds.... If we don't feel we get good try results, we may need to re-trigger.
[Attachment #621581](/attachment.cgi?id=621581&action=edit "Use correct method to check is a jsval is an object and tests (minor update)") -
Flags: review?(roc)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=752087#c15)• 13 years ago |
|  | |

Oh, and as this does appear to be a null-deref only, should we mark it as non-ss?

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)  Reporter |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=752087#c16)• 13 years ago |
|  | |

Let's wait until you land this and I can check [bug 752340](/show_bug.cgi?id=752340 "VERIFIED FIXED - js::FunctionProxyClass needs a finalizer") to see if it is fixed by this patch.

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=752087#c17)• 13 years ago |
|  | |

The try build (while fighting an infrastructure Error 500 bug that's hitting everyone right now) got multiple successful runs of the new test on different platforms.

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a258000_5038)• 13 years ago |

[Attachment #621581](/attachment.cgi?id=621581&action=edit "Use correct method to check is a jsval is an object and tests (minor update)") -
Flags: review?(roc) → review+

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a259729_11539)• 13 years ago |

Assignee: nobody → rjesupWhiteboard: [inbound]

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=752087#c18)• 13 years ago |
|  | |

<http://hg.mozilla.org/integration/mozilla-inbound/rev/c77b4c6085c1>

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=752087#c20)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/c77b4c6085c1>Status: NEW → RESOLVEDClosed: 13 years ago
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla15

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a521091_425645)• 13 years ago |

[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
--- → [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=752087#c23)• 13 years ago |
|  | |

Marking as verified fixed based on Bob Clary's testing of post-patch build with same URLs.Status: RESOLVED → VERIFIED

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=752087#c24)• 12 years ago |
|  | |

This doesn't affect ESR and isn't a known regression?Whiteboard: [inbound] → [inbound][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752087#a14711283_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=752087&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.xerox.com_572c96ce_20250125_013416.html ===
Xerox Security Bulletin XRX13-003

FreeFlow Print Server v8
January 2013 Security Patch Cluster (includes Java 6 Update 37 Software)
v1.0
2/26/2013

Background

Oracle delivers quarterly Critical Patch Updates (CPU) to address US-CERT-announced Security vulnerabilities
and deliver reliability improvements to the Solaris Operating System.  Oracle no longer provides these patches
to the general public, but Xerox is authorized to deliver them to Customers with active FreeFlow Print Server
(FFPS) Support contracts (FSMA).  Customers who may have an Oracle Support Contract for their non-FFPS
Solaris  Servers  should  not  install  patches  that  have  not  been  customized  by  Xerox.  Otherwise  the  FFPS
software could be damaged and result in downtime and a lengthy re-installation service call.

This bulletin announces the availability of the following:

1.

2.

Security Patch Cluster
January    2012012012013333    Security Patch Cluster
January
Security Patch Cluster
Security Patch Cluster
January
January

(cid:1)  This supersedes the October 2012 Security Patch Cluster

Software
Java 6 Update 33337777    Software
Java 6 Update
Software
Software
Java 6 Update
Java 6 Update

(cid:1)  This supersedes Java 6 Update 33 Software

The Security vulnerabilities that are remediated with this FFPS Security patch delivery are as follows:

CVE-2006-4514  CVE-2012-0841  CVE-2012-2983  CVE-2012-3968  CVE-2013-0415  CVE-2012-5075
CVE-2008-6536  CVE-2012-0883  CVE-2012-3401  CVE-2012-3969  CVE-2012-1531  CVE-2012-5077
CVE-2011-2697  CVE-2012-1960  CVE-2012-3956  CVE-2012-3970  CVE-2012-1532  CVE-2012-5079
CVE-2011-2964  CVE-2012-1970  CVE-2012-3957  CVE-2012-3972  CVE-2012-1533  CVE-2012-5081
CVE-2011-3102  CVE-2012-1971  CVE-2012-3958  CVE-2012-3974  CVE-2012-3143  CVE-2012-5083
CVE-2011-4339  CVE-2012-1972  CVE-2012-3959  CVE-2012-3976  CVE-2012-3159  CVE-2012-5084
CVE-2012-0569  CVE-2012-1973  CVE-2012-3960  CVE-2012-3978  CVE-2012-3216  CVE-2012-5085
CVE-2012-0724  CVE-2012-1974  CVE-2012-3961  CVE-2012-3980  CVE-2012-4416  CVE-2012-5086
CVE-2012-0725  CVE-2012-1975  CVE-2012-3962  CVE-2012-4245  CVE-2012-5068  CVE-2012-5089
CVE-2012-0768  CVE-2012-1976  CVE-2012-3963  CVE-2012-5166  CVE-2012-5069
CVE-2012-0769  CVE-2012-2687  CVE-2012-3964  CVE-2013-0399  CVE-2012-5071
CVE-2012-0772  CVE-2012-2981  CVE-2012-3966  CVE-2013-0400  CVE-2012-5072
CVE-2012-0773  CVE-2012-2982  CVE-2012-3967  CVE-2013-0407  CVE-2012-5073

Note: Xerox recommends that customers evaluate their security needs periodically and if they need Security
patches  to  address  the  above  CVE  issues,  schedule  an  activity  with  their  Xerox  Service  team  to  install  this
announced Security Patch Cluster.

Applicability

These Security updates are intended for Xerox printer products running one of the FFPS 73.C0.41 or 73.B3.61
SPAR software releases.  This Security patch update has only been tested on these software releases and it is
recommended that they be installed on these FFPS software release versions.  They have not been tested with
the FFPS 73.B0.73 and 73.A3.31 software releases.

The  Xerox  CSE/Analyst  is  provided  a  tool  (accessible  from  CFO  Web  site)  that  enables  them  to  confirm  the
currently  installed  FFPS  software  release,  Security  Patch  Cluster,  and  Java  Software  version.    When  this
Security update has been installed on the FFPS system, this script will output the following:

FFPS Release Version:
FFPS Patch Cluster:
Java Version:

8.0_SP-3 (82.C5.24.86)
January 2013
Java 6 Update 37

Patch Install Methods

The  install  of  these  Security  patches  must  be  performed  by  the  Xerox  Customer  Service  Engineer  (CSE)  or
Analyst.  The customer process to obtain this Security update is to call the Xerox support number to request
the service.

Xerox strives to deliver these critical Security patch updates in a timely manner.  They are available from the
Xerox  Support  organization,  and  can  be  delivered  electronically  over  the  Internet  to  the  FFPS  system  via  a
GUI tool called the FFPS Update Manager. The other method of delivery is an FTP transfer to the FFPS system
or  writing  the  patch  cluster  to  DVD/USB  media.    A  more  detailed  description  of  the  methods  used  by  the
CSE/Analyst to install the Security patches is as follows:

FFPS Update Manager GUI

Once the Security patches are ready for customer delivery they are made available from the Xerox Edge
Host  and  Download  servers.    The  CSE/Analyst  uses  the  Update  Manager  GUI  on  the  FFPS  system  to
download  and  install  the  Security  patches  over  the  Internet.    When  the  Xerox  server  is  checked  for
updates  from  FFPS  Update  Manager,  this  Security  patch  update  is  listed  as  “January  2013  Security
Patch Cluster (FFPS v8)”.

This requires that the FFPS system be configured with the customer proxy information to gain Security
patch  update  access  from  the  Xerox  servers.    The  connection  is  initiated  by  the  FFPS  system  and  the
Xerox  servers  do  not  have  access  to  the  customer  network.    The  Xerox  server  and  FFPS  system  both
authenticate  each  other  before  a  data  transfer  can  be  successfully  established  between  the  two  end
points.

Hard Disk, DVD/USB Media

Once  the  Security  patch  updates  are  ready  for  customer  delivery  they  are  made  available  on  the  CFO
Web site.  The CSE/Analyst can download and prepare for the install by writing the Security patch update
into a well-known directory on the FFPS system, or on DVD/USB media.  The FFPS Security Patch Cluster is
delivered  as  an  ISO  image  and  ZIP  archive  file  to  provide  the  Xerox  Service  Representative  options  to
choose an install method.  Once the patch cluster has been prepared on media an install script can be run
to perform the install.  The install  script accepts an argument that identifies the media that contains a
copy of the FFPS Security Patch Cluster.  (E.g., # installSecPatches.sh [ disk | dvd | usb ]).

Important: The install of this Security patch update can fail if the archive file containing the patches is
corrupted from file transfer or writing to DVD media.  There have been reported install failures when the
archive  file  written  on  DVD  media  was  corrupt.    The  Security  patch  update  could  be  corrupted  when
writing  to  media  by  particular  DVD  burn  applications  writing  on  some  DVD  media  types.    It  is  very
important that the Security patch archive written onto the DVD install media be verified with the original
archive file that was written to DVD.

The Security patch cluster is delivered as a ZIP and an ISO file.  The file size and check sum of these files
on Windows and Solaris are as follows:

Security Patch File

Windows Size (Kb)

Solaris Size (bytes)

Solaris Checksum

Jan2013AndJava6U37Patches_v8.zip

1,663,512

1,703,435,583

54151  3327023

Jan2013AndJava6U37Patches_v8.iso

1,615,862

1,703,794,688

13849  3327724

The Jan2013AndJava6U37Patches_v8.zip listed on the DVD media can be verified by comparing it to
the original archive file size and checksum.  Copy this archive to a location on the FFPS system and type
‘sum  Jan2013AndJava6U37Patches_v8.zip’  from  a  terminal  window.    The  checksum  value  should  be
‘54151    3327023’,  and  this  validates  the  correct  January  2013  Security  Patch  Cluster  is  written  on  the
DVD.

Disclaimer

The information provided in this Xerox Product Response is provided "as is" without warranty of any kind. Xerox
Corporation disclaims all warranties, either express or implied, including the warranties of merchantability and
fitness  for  a  particular  purpose.  In  no  event  shall  Xerox  Corporation  be  liable  for  any  damages  whatsoever
resulting  from  user's  use  or  disregard  of  the  information  provided  in  this  Xerox  Product  Response  including
direct, indirect, incidental, consequential, loss of business profits or special damages, even if Xerox Corporation
has  been  advised  of  the  possibility  of  such  damages.  Some  states  do  not  allow  the  exclusion  or  limitation  of
liability for consequential damages so the foregoing limitation may not apply.



=== Content from bugzilla.mozilla.org_1ced9c6c_20250125_013440.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/754242)
* [XML](/show_bug.cgi?ctype=xml&id=754242)

Closed
[Bug 754242](/show_bug.cgi?id=754242)

Opened 13 years ago
Closed 13 years ago

# Assertion failure: incBitmap.isMarked(cell, BLACK), at jsgc.cpp:3125 Crash [@ js::HeapPtr<js::BaseShape, unsigned int>::operator] or Crash [@ getCode]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: incBitmap.isMarked(cell, BLACK), at jsgc.cpp:3125 Crash [@ js::HeapPtr<js::BaseShape, unsigned int>::operator] or Crash [@ getCode]

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-) | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox14 | + | affected |
| firefox15 |  | fixed |
| firefox-esr10 | - | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: billm)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/81db2831554209472ec9b0d5485ca1c9?d=mm&size=40)  [billm](/user_profile?user_id=389993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[746768](/show_bug.cgi?id=746768 "RESOLVED DUPLICATE - Crash [@ js::gc::Chunk::allocateArena]")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [sg:critical][advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---),
[valgrind](/buglist.cgi?keywords=valgrind&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical][advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [decoder](/user_profile?user_id=395101) | [in-testsuite](#c8 "12 years ago") | + |
| --- | --- | --- |
| [decoder](/user_profile?user_id=395101) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::HeapPtr<js::BaseShape, unsigned int>::operator ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3AHeapPtr%3Cjs%3A%3ABaseShape%2C%20unsigned%20int%3E%3A%3Aoperator)

[[@ getCode ]](https://crash-stats.mozilla.org/signature/?signature=getCode)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [Log for opt-build Valgrind errors](/attachment.cgi?id=623110)  [13 years ago](#c0)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   107.79 KB, text/plain |  | [Details](/attachment.cgi?id=623110&action=edit) |
| --- | --- | --- |
| [patch](/attachment.cgi?id=623229)  [13 years ago](#c1)  [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)   2.75 KB, patch | terrence : [review+](#a36696_231770 "13 years ago") | [Details](/attachment.cgi?id=623229&action=edit) | [Diff](/attachment.cgi?id=623229&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=754242&attachment=623229) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=754242#c0)• 13 years ago |
|  | |

Attached file
[Log for opt-build Valgrind errors](attachment.cgi?id=623110)
— [Details](attachment.cgi?id=623110&action=edit)

The following test asserts/crashes/shows Valgrind errors on mozilla-central revision 4c6d01c92dcc (options -m -n -a):
var g1 = newGlobal('new-compartment');
schedulegc(g1);
gcslice(0);
function testEq(b) {
var a = deserialize(serialize(b));
}
testEq(Array(1024).join(Array(1024).join((false))));
After stepping through the assertion I get this crash on the debug build:
Program received signal SIGSEGV, Segmentation fault.
0x0805aad4 in js::HeapPtr<js::BaseShape, unsigned int>::operator js::BaseShape\* (this=0xdadadada) at ../../gc/Barrier.h:212
212 operator T\*() const { return value; }
(gdb) bt 8
#0 0x0805aad4 in js::HeapPtr<js::BaseShape, unsigned int>::operator js::BaseShape\* (this=0xdadadada) at ../../gc/Barrier.h:212
#1 0x0804d24d in js::Shape::base (this=0xdadadada) at ../../jsscope.h:708
#2 0x0804d18f in js::Shape::getObjectClass (this=0xdadadada) at ../../jsscope.h:607
#3 0x0804e269 in js::ObjectImpl::getClass (this=0xf7503040) at ../../vm/ObjectImpl-inl.h:245
#4 0x0804e27d in js::ObjectImpl::hasClass (this=0xf7503040, c=0x85dabe0) at ../../vm/ObjectImpl-inl.h:257
#5 0x0805fdf1 in JSObject::isWith (this=0xf7503040) at ../../jsobjinlines.h:817
#6 0x081472c5 in js::IsActiveWithOrBlock (cx=0x861dd80, obj=..., stackDepth=0) at /srv/repos/mozilla-central/js/src/jsinterp.cpp:947
#7 0x0814b898 in js::Interpret (cx=0x861dd80, entryFrame=0xf7702020, interpMode=js::JSINTERP\_NORMAL) at /srv/repos/mozilla-central/js/src/jsinterp.cpp:1890
More interesting however is the behavior on opt-builds. In GDB I get this crash:
Program received signal SIGSEGV, Segmentation fault.
getCode (cx=0x8360a68, script=0xf75060f8, pc=0x836b785 ":", rval=...) at ../jsanalyze.h:958
958 Bytecode& getCode(const jsbytecode \*pc) { return getCode(pc - script->code); }
(gdb) bt 8
#0 getCode (cx=0x8360a68, script=0xf75060f8, pc=0x836b785 ":", rval=...) at ../jsanalyze.h:958
#1 bytecodeTypes (cx=0x8360a68, script=0xf75060f8, pc=0x836b785 ":", rval=...) at ../jsanalyze.h:984
#2 js::types::TypeMonitorResult (cx=0x8360a68, script=0xf75060f8, pc=0x836b785 ":", rval=...) at /srv/repos/mozilla-central/js/src/jsinfer.cpp:4966
#3 0x080c65e7 in Monitor (cx=0x8360a68, entryFrame=0xf7702020, interpMode=js::JSINTERP\_NORMAL) at ../jsinferinlines.h:622
#4 js::Interpret (cx=0x8360a68, entryFrame=0xf7702020, interpMode=js::JSINTERP\_NORMAL) at /srv/repos/mozilla-central/js/src/jsinterp.cpp:1915
#5 0x081d6e69 in js::mjit::EnterMethodJIT (cx=0x8360a68, fp=0xf7702020, code=0xf74cf050, stackLimit=0xf7ae2000, partial=false) at /srv/repos/mozilla-central/js/src/methodjit/MethodJIT.cpp:1074
#6 0x081d6fc3 in CheckStackAndEnterMethodJIT (cx=0x8360a68, partial=false) at /srv/repos/mozilla-central/js/src/methodjit/MethodJIT.cpp:1109
#7 js::mjit::JaegerShot (cx=0x8360a68, partial=false) at /srv/repos/mozilla-central/js/src/methodjit/MethodJIT.cpp:1121
and on Valgrind I see lots of errors with the opt-build indicating some corruption (see attached Valgrind log). Marking s-s because of that until investigated.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a15297_389993)• 13 years ago |

Assignee: general → wmccloskey

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=754242#c1)• 13 years ago |
|  | |

Attached patch

[patch](attachment.cgi?id=623229&action=diff)
— [Details](attachment.cgi?id=623229&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=754242&attachment=623229)

This found two bugs.
The first one is that JSCompartment::emptyTypeObject needs a read barrier because it's a weak pointer.
The other problem is that we weren't correctly resetting the incremental GC when a new compartment was added in the middle. The sequence of events looks like this:
First GC slice:
Collect only compartment A
Second GC slice: triggered by TOO\_MUCH\_MALLOC in compartment B
Schedule compartments A and B for collection
(since A was collected before, and B was the trigger)
Call BudgetIncrementalGC
Notice that tooMuchMalloc() is true for B, so set the budget to
unlimited and return
If we hadn't returned early, we also would have noticed that compartment B was not collected in the first slice, and we would have called ResetIncrementalGC. That's the bug.
[Attachment #623229](/attachment.cgi?id=623229&action=edit "patch") -
Flags: review?

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a35914_389993)• 13 years ago |

[Attachment #623229](/attachment.cgi?id=623229&action=edit "patch") -
Flags: review? → review?(terrence)

|  | [Terrence Cole [:terrence]](/user_profile?user_id=231770) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a36696_231770)• 13 years ago |

[Attachment #623229](/attachment.cgi?id=623229&action=edit "patch") -
Flags: review?(terrence) → review+

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=754242#c2)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/edf797d10aa0>Target Milestone: --- → mozilla15

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=754242#c3)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/edf797d10aa0>Status: NEW → RESOLVEDClosed: 13 years agoResolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=754242#c4)• 13 years ago |
|  | |

The incremental GC part doesn't affect the ESR-10 branch, but what about the emptyTypeObject bug? Is that a "regression" from a more recent feature too, or an older problem?
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F)
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)Whiteboard: js-triage-needed → [sg:critical]

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=754242#c5)• 13 years ago |
|  | |

This bug only hits if incremental GC is enabled.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=754242#c6)• 13 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a597475_395101)• 13 years ago |

Status: RESOLVED → VERIFIEDCrash Signature: [@ js::HeapPtr<js::BaseShape, unsigned int>::operator]
[@ getCode] → [@ js::HeapPtr<js::BaseShape, unsigned int>::operator]
[@ getCode]

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a1163538_425645)• 13 years ago |

Crash Signature: [@ js::HeapPtr<js::BaseShape, unsigned int>::operator]
[@ getCode] → [@ js::HeapPtr<js::BaseShape, unsigned int>::operator]
[@ getCode]
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[tracking-firefox-esr10](/buglist.cgi?f1=cf_tracking_esr10&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=%3F) → [-](/buglist.cgi?f1=cf_tracking_esr10&o1=equals&v1=-)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a7647353_280903)• 12 years ago |

Whiteboard: [sg:critical] → [sg:critical][advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=754242#a14143324_1689)• 12 years ago |

Group: core-security

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=754242#c8)• 12 years ago |
|  | |

A testcase for this bug was automatically identified at js/src/jit-test/tests/basic/[bug754242](/show_bug.cgi?id=754242 "VERIFIED FIXED - Assertion failure: incBitmap.isMarked(cell, BLACK), at jsgc.cpp:3125 Crash [@ js::HeapPtr<js::BaseShape, unsigned int>::operator] or Crash [@ getCode]").js.Flags: in-testsuite+
You need to [log in](/show_bug.cgi?id=754242&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Christian Holler (:decoder)](/user_profile?user_id=395101)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_7d803474_20250125_013433.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/752038)
* [XML](/show_bug.cgi?ctype=xml&id=752038)

Closed
[Bug 752038](/show_bug.cgi?id=752038)

Opened 13 years ago
Closed 13 years ago

# "ASSERTION: wrapper already in new scope!" with location.hash, document.open

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

"ASSERTION: wrapper already in new scope!" with location.hash, document.open

## Categories

### (Core :: XPConnect, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=XPConnect#XPConnect)

XPConnect
▾

Core :: XPConnect
Facilitates calling between JavaScript and XPCOM components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=XPConnect&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=XPConnect)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla15

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Accessibility Severity | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox15 |  | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jruderman, Assigned: bholley)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/ac57223c49d41049a4917e187b854377?d=mm&size=40)  [bholley](/user_profile?user_id=313730)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d2dc9227eafcd0ec5ba3712ee4f19b75?d=mm&size=40)  [jruderman](/user_profile?user_id=11608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/5111b810214a00377104f5ad3efefa26?d=mm&size=40)  [sefeng](/user_profile?user_id=625922)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

10 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[cpg](/show_bug.cgi?id=650353 "RESOLVED FIXED - have one global object per compartment"), [752309](/show_bug.cgi?id=752309 "RESOLVED WORKSFORME - crash in xpc::WrapperFactory::PrepareForWrapping")

Dependency [tree](/showdependencytree.cgi?id=752038&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=752038)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, testcase, Whiteboard: [advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [bholley](/user_profile?user_id=313730) | [in-testsuite](#a2161247_313730 "13 years ago") | + |
| --- | --- | --- |
| [bholley](/user_profile?user_id=313730) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 3 obsolete files)

| [testcase (inner)](/attachment.cgi?id=621165)  [13 years ago](#c0)  [Jesse Ruderman](/user_profile?user_id=11608)   123 bytes, text/html |  | [Details](/attachment.cgi?id=621165&action=edit) |
| --- | --- | --- |
| [testcase (outer)](/attachment.cgi?id=621166)  [13 years ago](#c1)  [Jesse Ruderman](/user_profile?user_id=11608)   233 bytes, text/html |  | [Details](/attachment.cgi?id=621166&action=edit) |
| [stack trace](/attachment.cgi?id=621168)  [13 years ago](#c2)  [Jesse Ruderman](/user_profile?user_id=11608)   12.43 KB, text/plain |  | [Details](/attachment.cgi?id=621168&action=edit) |
| [reduced testcase](/attachment.cgi?id=621987)  [13 years ago](#c7)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   163 bytes, text/html |  | [Details](/attachment.cgi?id=621987&action=edit) |
| [Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v1](/attachment.cgi?id=624504)  [13 years ago](#c14)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   6.33 KB, patch |  | [Details](/attachment.cgi?id=624504&action=edit) | [Diff](/attachment.cgi?id=624504&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752038&attachment=624504) |
| [Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2](/attachment.cgi?id=624506)  [13 years ago](#c15)  [Bobby Holley (:bholley)](/user_profile?user_id=313730)   6.37 KB, patch | mrbkap : [review+](#c16 "13 years ago") | [Details](/attachment.cgi?id=624506&action=edit) | [Diff](/attachment.cgi?id=624506&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752038&attachment=624506) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=752038#c0)• 13 years ago |
|  | |

Attached file
[testcase (inner)](attachment.cgi?id=621165) (obsolete)
— [Details](attachment.cgi?id=621165&action=edit)

To reproduce, save both testcase files, then open outer.html.
###!!! ASSERTION: wrapper already in new scope!: '!newMap->Find(wrapper->GetIdentityObject())', file js/xpconnect/src/XPCWrappedNative.cpp, line 1636
Might be a regression from cpg.

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=752038#c1)• 13 years ago |
|  | |

Attached file
[testcase (outer)](attachment.cgi?id=621166) (obsolete)
— [Details](attachment.cgi?id=621166&action=edit)

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=752038#c2)• 13 years ago |
|  | |

Attached file
[stack trace](attachment.cgi?id=621168)
— [Details](attachment.cgi?id=621168&action=edit)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=752038#c3)• 13 years ago |
|  | |

Probably the same issue as [bug 751995](/show_bug.cgi?id=751995 "VERIFIED FIXED - Compartment mismatch with adoptNode, style"). Taking.Assignee: nobody → bobbyholley+bmo

|  | [Martijn Wargers (dead)](/user_profile?user_id=55600) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a158850_55600)• 13 years ago |

Blocks: [752309](/show_bug.cgi?id=752309 "RESOLVED WORKSFORME - crash in xpc::WrapperFactory::PrepareForWrapping")

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=752038#c4)• 13 years ago |
|  | |

(In reply to Bobby Holley (:bholley) from [comment #3](/show_bug.cgi?id=752038#c3 "RESOLVED FIXED - \"ASSERTION: wrapper already in new scope!\" with location.hash, document.open"))
> Probably the same issue as [bug 751995](/show_bug.cgi?id=751995 "VERIFIED FIXED - Compartment mismatch with adoptNode, style"). Taking.
They appear to be different issues. I'm looking into this one now.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=752038#c5)• 13 years ago |
|  | |

[Bug 752164 comment #1](/show_bug.cgi?id=752164#c1 "RESOLVED DUPLICATE - crash in xpc::WrapperFactory::PrepareForWrapping") says those two might be dupes, should the crash signature be copied in here as well?
In that case, [bug 752309](/show_bug.cgi?id=752309 "RESOLVED WORKSFORME - crash in xpc::WrapperFactory::PrepareForWrapping") has another testcase and the same signature.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=752038#c6)• 13 years ago |
|  | |

(In reply to Robert Kaiser (:kairo@mozilla.com) from [comment #5](/show_bug.cgi?id=752038#c5 "RESOLVED FIXED - \"ASSERTION: wrapper already in new scope!\" with location.hash, document.open"))
> [Bug 752164 comment #1](/show_bug.cgi?id=752164#c1 "RESOLVED DUPLICATE - crash in xpc::WrapperFactory::PrepareForWrapping") says those two might be dupes, should the crash
> signature be copied in here as well?
> In that case, [bug 752309](/show_bug.cgi?id=752309 "RESOLVED WORKSFORME - crash in xpc::WrapperFactory::PrepareForWrapping") has another testcase and the same signature.
Let's keep using the other bug to track the crashes until we're sure that this is the same issue.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=752038#c7)• 13 years ago |
|  | |

Attached file
[reduced testcase](attachment.cgi?id=621987)
— [Details](attachment.cgi?id=621987&action=edit)

Attaching a simpler, reduced testcase.
[Attachment #621165](/attachment.cgi?id=621165&action=edit "testcase (inner)") -
Attachment is obsolete: true
[Attachment #621166](/attachment.cgi?id=621166&action=edit "testcase (outer)") -
Attachment is obsolete: true

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=752038#c8)• 13 years ago |
|  | |

So here's what's going on. This is the #1 topcrasher on Nightly, so there's a moderate amount of urgency here.
We do a dummy hash navigation, which causes a Location wrapper to be created for the underlying DOM object. We then do a document.write, which gives us a new scope and forces everything, including the Location object, to be reparented to the new scope.
During this reparenting, we iterate over all the wrappers. We happen to hit the |Document| first. Post-CPG this operation crosses compartment boundaries, so we do a brain transplant, and copy all of the properties from the JS object across the compartment (including document.location). This causes us to do a call wrap() on document.location, which takes us into PrepareForWrapping. This calls PreCreate on native nsLocation object in order to figure out if it needs to make a cross-compartment wrapper.
nsLocationSH::PreCreate then examines the docshell in order to find the outer window (a particular oddity of Location objects is that they're parented to the outer window for security reasons). But the outer window has already been brain transplanted into the new scope. So PreCreate informs PrepareForWrapping that the object ought to live in the new scope, and PrepareForUnwrapping dutifully creates a new XPCWN for it in the new scope.
But now we're screwed, because we have two wrappers for the same object (one in each scope). We continue along our merry way in MoveWrappers, until we hit the XPCWN for the Location object in the old scope. But by this point, we've already got an XPCWN for the underlying native in the new scope. So we assert, pooch the hash table, and (sometimes) crash a bit later on.
There are a couple of things we could do to fix this. We could make the JS\_CopyPropertiesFrom stuff be more careful about this, but I can't think of a great way to do that. My ideal approach, I think, is to make nsLocation implement nsWrapperCache, and change PrepareForWrapping to check the wrapper cache (and defer to it) before calling PreCreate.
So the only big question here is if there are any gotchas surrounding wrapper-caching Location. Anybody have any?

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=752038#c9)• 13 years ago |
|  | |

CCing jst, since he might be a good candidate to advise about wrapper-caching nsLocation.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=752038#c10)• 13 years ago |
|  | |

So, it seems that I was slightly wrong about how things fall apart at the end. I just investigated the testcase over in [bug 752309](/show_bug.cgi?id=752309 "RESOLVED WORKSFORME - crash in xpc::WrapperFactory::PrepareForWrapping"), which doesn't involve nsLocation, but rather nsDOMStringMap.
What happens is that, after transplanting wrappers, we null out their private (since the XPCWN is gone, and all that's left is the shell JS object). So in this case, the DOMStringMap gets transplanted first (before the location), at which point the expando on |document| is bogus.
nsDOMStringMapSH::PreCreate just tries to parent the object to the window associated with the document's scope. I guess the document has already changed windows by this point, so this probably isn't unique to location. Maybe another solution is in order.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=752038#c11)• 13 years ago |
|  | |

So, in a sense, there are two bugs here that occur during MoveWrappers, depending on whether we first encounter an object as a wrapper-to-move or as a property on an object being transplanted.
If the first is true, then we end up nulling out the private of the JS object once we move the XPCWN over to the new scope, which causes us to crash if we subsequently encounter a reference to the same object defined on the object upon which we call JS\_CopyPropertiesFrom. I think we can probably fix this by replacing the neutered object with a cross-compartment wrapper to the new object (Hopefully mrbkap writes that API comment for JS\_TransplantObject soon ;-) ).
If the second is true, things are a little trickier. When JS\_CopyPropertiesFrom calls wrap, it ends up calling PreCreate in PrepareForWrapping (as mentioned in [comment 8](/show_bug.cgi?id=752038#c8 "RESOLVED FIXED - \"ASSERTION: wrapper already in new scope!\" with location.hash, document.open")), and PreCreate jumps the gun a little bit and returns the new scope. The only way I can think of to fix this in our current architecture is, as suggested before, to have PrepareForUnwrapping defer to the wrapper cache.
But now we're not just talking about Location anymore. We're talking about inheriting nsWrapperCache for every object that implements PreCreate. This might not be so much work, and we can probably assert this invariant in XPConnect whenever we find WANT\_PRECREATE on a set of scriptable flags. But there might also be snakes in the grass.
So, I'd appreciate input from jst, mrbkap, or peterv about the prospect of requiring nsWrapperCache for anything that implements PreCreate. It seems like it would make sense, but I may not have the whole picture here.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=752038#c12)• 13 years ago |
|  | |

So, I realized that it might not make sense for all PreCreate objects to implement nsWrapperCache. Specifically, there are some objects that \_sometimes\_ specify a parent when calling PreCreate, but default to the global in certain cases. It's not totally clear to me whether this is just an exceptional/error case or whether it's a valid code path, but if the latter is true then certain objects with PreCreate hooks might sometimes have multiple wrappers. Ugh.
So I think we might just want to stick global state on XPCJSRuntime that says "are we reparenting wrappers right now?" If we are, we can just unconditionally return from the PreWrap callback for everything that has a PreCreate hook. This isn't totally correct, per se, but it's probably good enough. I'll look into doing that once I get all this same-compartment-security-wrapper stuff sorted out.

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=752038#c13)• 13 years ago |
|  | |

So, js\_TransplantObjectWithWrapper is supposed to handle the first case in [comment 11](/show_bug.cgi?id=752038#c11 "RESOLVED FIXED - \"ASSERTION: wrapper already in new scope!\" with location.hash, document.open"). But unfortunately we crash if anyone gets around SCSWs. Which happens any time you call wrap() on an SCSW, which we do during wrapper reparenting. This is also [bug 754044](/show_bug.cgi?id=754044 "VERIFIED FIXED - Same-compartment security wrappers can be trivially bypassed by passing them to another compartment"), which I just filed.

|  | [David Bolter [:davidb] (NeedInfo me for attention)](/user_profile?user_id=152868) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a1023474_152868)• 13 years ago |

Blocks: [752150](/show_bug.cgi?id=752150 "RESOLVED DUPLICATE - \"ASSERTION: scope has non-empty map\" with SVG, embed, adoptNode")

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=752038#c14)• 13 years ago |
|  | |

Attached patch

[Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v1](attachment.cgi?id=624504&action=diff) (obsolete)
— [Details](attachment.cgi?id=624504&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752038&attachment=624504)

Blake and I discussed this on IRC, and ended up deciding to go with an ugly member variable on XPCJSRuntime. But then I had a very clever idea that I'm quite proud of. Hope you approve, Blake. ;-)
[Attachment #624504](/attachment.cgi?id=624504&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v1") -
Flags: review?(mrbkap)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=752038#c15)• 13 years ago |
|  | |

Attached patch

[Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2](attachment.cgi?id=624506&action=diff)
— [Details](attachment.cgi?id=624506&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=752038&attachment=624506)

Fixed a few typos in the comment.
[Attachment #624506](/attachment.cgi?id=624506&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2") -
Flags: review?(mrbkap)

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a1033749_313730)• 13 years ago |

[Attachment #624504](/attachment.cgi?id=624504&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v1") -
Attachment is obsolete: true
[Attachment #624504](/attachment.cgi?id=624504&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v1") -
Flags: review?(mrbkap)

|  | [Blake Kaplan (:mrbkap) (inactive)](/user_profile?user_id=69426) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=752038#c16)• 13 years ago |
|  | |

Comment on [attachment 624506](/attachment.cgi?id=624506 "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2") [[details]](/attachment.cgi?id=624506&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2") [[diff]](/attachment.cgi?id=624506&action=diff "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=752038&attachment=624506)
Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2
Phew!
[Attachment #624506](/attachment.cgi?id=624506&action=edit "Avoid getting confused by PreCreate giving a different answer when we wrap objects cross-compartment during reparenting. v2") -
Flags: review?(mrbkap) → review+

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=752038#c17)• 13 years ago |
|  | |

pushed to m-i: <http://hg.mozilla.org/integration/mozilla-inbound/rev/3bfee91d5f09>
I thought I'd pushed this to try, but I can't find the link anywhere. It's unlikely that this would break anything, but if it does I apologize. :-(

|  | [Bobby Holley (:bholley)](/user_profile?user_id=313730)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a2161247_313730)• 13 years ago |

Flags: in-testsuite+Target Milestone: --- → mozilla15

|  | [Ed Morley [:emorley]](/user_profile?user_id=373476) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=752038#c18)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/3bfee91d5f09>Status: NEW → RESOLVEDClosed: 13 years ago
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a3446361_406194)• 13 years ago |

No longer blocks: [752150](/show_bug.cgi?id=752150 "RESOLVED DUPLICATE - \"ASSERTION: scope has non-empty map\" with SVG, embed, adoptNode")

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a4158161_425645)• 13 years ago |

[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a8220608_280903)• 12 years ago |

Whiteboard: [advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=752038#a14717528_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=752038&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jesse Ruderman](/user_profile?user_id=11608)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_c4726721_20250125_013445.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/765936)
* [XML](/show_bug.cgi?ctype=xml&id=765936)

Closed
[Bug 765936](/show_bug.cgi?id=765936)

Opened 13 years ago
Closed 13 years ago

# IndexedDB wrapper behavior is still totally broken

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

IndexedDB wrapper behavior is still totally broken

## Categories

### (Core :: Storage: IndexedDB, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Storage%3A%20IndexedDB#Storage%3A%20IndexedDB)

Storage: IndexedDB
▾

Core :: Storage: IndexedDB
[IndexedDB](https://w3c.github.io/IndexedDB/) implementation, exposed through self.indexedDB.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Storage%3A%20IndexedDB&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Storage%3A%20IndexedDB&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Storage%3A%20IndexedDB)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla16

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=wontfix) |
| firefox14 | [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B) | [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix) |
| firefox15 | [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) |
| firefox16 | [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed) |
| firefox-esr10 | --- | [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox13 |  | wontfix |
| firefox14 | + | wontfix |
| firefox15 | + | fixed |
| firefox16 | + | fixed |
| firefox-esr10 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: asuth, Assigned: khuey)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/d8bebbee32670ee5755ce1bc535cd251?d=mm&size=40)  [khuey](/user_profile?user_id=336670)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/75b1e0d00a677e73b24efe34917fa1e9?d=mm&size=40)  [asuth](/user_profile?user_id=151407)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/056757eff6ed7c8ec26f61e3bf7695fe?d=mm&size=40)  [smaug](/user_profile?user_id=39966)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

6 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[731227](/show_bug.cgi?id=731227 "RESOLVED FIXED - Fix script object ownership in IDBWrapperCache/IDBCursor")

Dependency [tree](/showdependencytree.cgi?id=765936&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=765936)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: regression, sec-critical, Whiteboard: [advisory-tracking+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[advisory-tracking+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [khuey](/user_profile?user_id=336670) | [in-testsuite](#c13 "13 years ago") | ? |
| --- | --- | --- |
| [khuey](/user_profile?user_id=336670) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 3 obsolete files)

| [a test that adds an expando and dies](/attachment.cgi?id=634216)  [13 years ago](#c0)  [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)   2.24 KB, patch |  | [Details](/attachment.cgi?id=634216&action=edit) | [Diff](/attachment.cgi?id=634216&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=634216) |
| --- | --- | --- |
| [Patch](/attachment.cgi?id=635499)  [13 years ago](#c2)  [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)   7.30 KB, patch | bent.mozilla : [review+](#c3 "13 years ago")  peterv : [superreview-](#c6 "13 years ago") | [Details](/attachment.cgi?id=635499&action=edit) | [Diff](/attachment.cgi?id=635499&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499) |
| [Patch](/attachment.cgi?id=637274)  [13 years ago](#c10)  [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)   15.53 KB, patch | bent.mozilla : [review+](#c11 "13 years ago")  peterv : [superreview+](#a910310_24295 "13 years ago") | [Details](/attachment.cgi?id=637274&action=edit) | [Diff](/attachment.cgi?id=637274&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=637274) |
| [Patch for Aurora](/attachment.cgi?id=640218)  [13 years ago](#c17)  [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)   9.42 KB, patch | akeybl : [approval-mozilla-aurora+](#a1882440_425645 "13 years ago") | [Details](/attachment.cgi?id=640218&action=edit) | [Diff](/attachment.cgi?id=640218&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=640218) |
| [Patch for Beta](/attachment.cgi?id=640253)  [13 years ago](#c18)  [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)   8.19 KB, patch | akeybl : [approval-mozilla-beta-](#c21 "13 years ago") | [Details](/attachment.cgi?id=640253&action=edit) | [Diff](/attachment.cgi?id=640253&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=640253) |
| [Patch for beta](/attachment.cgi?id=649325)  [12 years ago](#c26)  [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)   9.42 KB, patch | khuey : [review+](#c26 "12 years ago")  lsblakk : [approval-mozilla-beta+](#c27 "12 years ago") | [Details](/attachment.cgi?id=649325&action=edit) | [Diff](/attachment.cgi?id=649325&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=649325) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=765936#c0)• 13 years ago |
|  | |

Attached patch

[a test that adds an expando and dies](attachment.cgi?id=634216&action=diff)
— [Details](attachment.cgi?id=634216&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=634216)

I accidentally added an expando to a request because meta-/ thought onfailure was a good name and I agreed.
This results in:
###!!! ASSERTION: Already rooted?!: '!PreservingWrapper()', file /home/visbrero/rev\_control/fgit/b2g-gaia/mozilla-central/dom/indexedDB/IDBRequest.cpp, line 80
I have included a dubiously named xpcshell test for your edification.

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a91_336670)• 13 years ago |

Group: core-security

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a156484_336670)• 13 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)Summary: expandos cause ###!!! ASSERTION: Already rooted?!: '!PreservingWrapper()' → IndexedDB wrapper behavior is still totally broken

|  | [David Bolter [:davidb] (NeedInfo me for attention)](/user_profile?user_id=152868) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=765936#c1)• 13 years ago |
|  | |

What versions of FF/geco/b2g are affected?

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=765936#c2)• 13 years ago |
|  | |

Attached patch

[Patch](attachment.cgi?id=635499&action=diff) (obsolete)
— [Details](attachment.cgi?id=635499&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499)

The assertion is bogus, but there is another problem here. Since [bug 731227](/show_bug.cgi?id=731227 "RESOLVED FIXED - Fix script object ownership in IDBWrapperCache/IDBCursor") we call NS\_HOLD\_JS\_OBJECTS on all requests at creation time. All the existing rooting/unrooting stuff just serves to duplicate that, except that we can run into scenarios where we hold twice and then call drop (and then end up with an unpreserved wrapper).
[Attachment #635499](/attachment.cgi?id=635499&action=edit "Patch") -
Flags: superreview?(peterv)
[Attachment #635499](/attachment.cgi?id=635499&action=edit "Patch") -
Flags: review?(bent.mozilla)

|  | [Ben Turner (not reading bugmail, use the needinfo flag!)](/user_profile?user_id=200444) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=765936#c3)• 13 years ago |
|  | |

Comment on [attachment 635499](/attachment.cgi?id=635499 "Patch") [[details]](/attachment.cgi?id=635499&action=edit "Patch") [[diff]](/attachment.cgi?id=635499&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499)
Patch
Review of [attachment 635499](/attachment.cgi?id=635499 "Patch") [[details]](/attachment.cgi?id=635499&action=edit "Patch") [[diff]](/attachment.cgi?id=635499&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499):
-----------------------------------------------------------------
::: dom/indexedDB/IDBRequest.cpp
@@ -110,5 @@
>
> JSAutoRequest ar(cx);
> JSAutoEnterCompartment ac;
> if (ac.enter(cx, global)) {
> - RootResultVal();
I think we should assert PreservingWrapper... somewhere? At the top of this method most likely.
[Attachment #635499](/attachment.cgi?id=635499&action=edit "Patch") -
Flags: review?(bent.mozilla) → review+

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=765936#c4)• 13 years ago |
|  | |

We can't assert PreservingWrapper anywhere. Whether or not we're preserving the wrapper is totally independent of everything else that's going on.

|  | [Ben Turner (not reading bugmail, use the needinfo flag!)](/user_profile?user_id=200444) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=765936#c5)• 13 years ago |
|  | |

Er... we need to somehow assert that we're rooted. Is there no way to do that?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=765936#c6)• 13 years ago |
|  | |

Comment on [attachment 635499](/attachment.cgi?id=635499 "Patch") [[details]](/attachment.cgi?id=635499&action=edit "Patch") [[diff]](/attachment.cgi?id=635499&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499)
Patch
Review of [attachment 635499](/attachment.cgi?id=635499 "Patch") [[details]](/attachment.cgi?id=635499&action=edit "Patch") [[diff]](/attachment.cgi?id=635499&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=635499):
-----------------------------------------------------------------
I don't think we can rely on SetScriptOwner unless it returns false if a null aScriptOwner is passed in.
[Attachment #635499](/attachment.cgi?id=635499&action=edit "Patch") -
Flags: superreview?(peterv) → superreview-

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=765936#c7)• 13 years ago |
|  | |

Not sure we can do that, given other consumers of that API. The other option would be to somehow have one flag to signal 'rooted by SetScriptOwner' and 'rooted by RootResultVal'.

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=765936#c8)• 13 years ago |
|  | |

Another option is to make IDBRequest/IDBOpenDBRequest::Create check the argument it passes to SetScriptOwner and bail if it's null.

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=765936#c9)• 13 years ago |
|  | |

I was going to say that I don't think the script owner should ever be null, but now with the IPC stuff I'm not so sure. I'll dig further.

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=765936#c10)• 13 years ago |
|  | |

Attached patch

[Patch](attachment.cgi?id=637274&action=diff)
— [Details](attachment.cgi?id=637274&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=637274)

How about this? This passes our test suite with no assertions.
[Attachment #635499](/attachment.cgi?id=635499&action=edit "Patch") -
Attachment is obsolete: true
[Attachment #637274](/attachment.cgi?id=637274&action=edit "Patch") -
Flags: superreview?(peterv)
[Attachment #637274](/attachment.cgi?id=637274&action=edit "Patch") -
Flags: review?(bent.mozilla)

|  | [Ben Turner (not reading bugmail, use the needinfo flag!)](/user_profile?user_id=200444) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=765936#c11)• 13 years ago |
|  | |

Comment on [attachment 637274](/attachment.cgi?id=637274 "Patch") [[details]](/attachment.cgi?id=637274&action=edit "Patch") [[diff]](/attachment.cgi?id=637274&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=637274)
Patch
Review of [attachment 637274](/attachment.cgi?id=637274 "Patch") [[details]](/attachment.cgi?id=637274&action=edit "Patch") [[diff]](/attachment.cgi?id=637274&action=diff "Patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=637274):
-----------------------------------------------------------------
Looks good to me with these things addressed:
::: dom/indexedDB/IDBFactory.cpp
@@ +408,5 @@
>
> if (mWindow) {
> window = mWindow;
> + scriptOwner =
> + static\_cast<nsGlobalWindow\*>(window.get())->FastGetGlobalJSObject();
I don't like this... We're not in performance-critical code here, can we just use the nsI\* methods to get this?
::: dom/indexedDB/IDBWrapperCache.cpp
@@ +47,5 @@
>
> bool
> IDBWrapperCache::SetScriptOwner(JSObject\* aScriptOwner)
> {
> + MOZ\_ASSERT(aScriptOwner);
NS\_ASSERTION. We'll do a full replace someday, but for now please use the other. (I'm still a little miffed that we don't get stacks with MOZ\_ASSERT)
@@ +68,5 @@
> +#ifdef DEBUG
> +void
> +IDBWrapperCache::AssertIsRooted() const
> +{
> + MOZ\_ASSERT(nsContentUtils::AreJSObjectsHeld(const\_cast<IDBWrapperCache\*>(this)),
Here too.
[Attachment #637274](/attachment.cgi?id=637274&action=edit "Patch") -
Flags: review?(bent.mozilla) → review+

|  | [David Bolter [:davidb] (NeedInfo me for attention)](/user_profile?user_id=152868) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=765936#c12)• 13 years ago |
|  | |

Kyle, and idea what FF versions are affected by this bug?
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected)
[tracking-firefox16](/buglist.cgi?f1=cf_tracking_firefox16&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox16&o1=equals&v1=%2B)

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a910310_24295)• 13 years ago |

[Attachment #637274](/attachment.cgi?id=637274&action=edit "Patch") -
Flags: superreview?(peterv) → superreview+

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=765936#c13)• 13 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/03c5347327d8>Flags: in-testsuite?Target Milestone: --- → mozilla16

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=765936#c14)• 13 years ago |
|  | |

This definitely affects Aurora and Beta.
[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected)
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%3F)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%3F)

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=765936#c15)• 13 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/03c5347327d8>Status: ASSIGNED → RESOLVEDClosed: 13 years agoResolution: --- → FIXED

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=765936#c16)• 13 years ago |
|  | |

What's the risk profile of this bug? Please nominate for Aurora approval, and Beta approval if low risk or a particularly critical security regression.
[tracking-firefox14](/buglist.cgi?f1=cf_tracking_firefox14&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox14&o1=equals&v1=%2B)
[tracking-firefox15](/buglist.cgi?f1=cf_tracking_firefox15&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox15&o1=equals&v1=%2B)

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=765936#c17)• 13 years ago |
|  | |

Attached patch

[Patch for Aurora](attachment.cgi?id=640218&action=diff) (obsolete)
— [Details](attachment.cgi?id=640218&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=640218)

This is a narrower patch for Aurora and Beta.
[Approval Request Comment]
Bug caused by (feature/regressing bug #): [bug 731227](/show_bug.cgi?id=731227 "RESOLVED FIXED - Fix script object ownership in IDBWrapperCache/IDBCursor")
User impact if declined: A potential SG crit involving stale pointers to GCd objects. I haven't actually constructed a test case which crashes though.
Testing completed (on m-c, etc.): Has been on m-c for a bit, is simple enough to understand.
Risk to taking this patch (and alternatives if risky): Low risk.
String or UUID changes made by this patch: None.
[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Flags: approval-mozilla-beta?
[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Flags: approval-mozilla-aurora?

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=765936#c18)• 13 years ago |
|  | |

Attached patch

[Patch for Beta](attachment.cgi?id=640253&action=diff) (obsolete)
— [Details](attachment.cgi?id=640253&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=640253)

Beta required a slightly different patch. See above for approval comments.
[Attachment #640253](/attachment.cgi?id=640253&action=edit "Patch for Beta") -
Flags: approval-mozilla-beta?

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a1792905_336670)• 13 years ago |

[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Attachment description: Patch for Aurora and Beta → Patch for Aurora
[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Flags: approval-mozilla-beta?

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=765936#c19)• 13 years ago |
|  | |

(In reply to David Bolter [:davidb] from [comment #12](/show_bug.cgi?id=765936#c12 "RESOLVED FIXED - IndexedDB wrapper behavior is still totally broken"))
> Kyle, and idea what FF versions are affected by this bug?
Any answer to this? Did we ship this problem in a final release or is it a more recent regression? Is Firefox 13 affected or existing ESR?

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=765936#c20)• 13 years ago |
|  | |

This shipped in 13 (see the regressing bug). ESR doesn't have this issue, but it may have related problems.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a1825623_1689)• 13 years ago |

Blocks: [731227](/show_bug.cgi?id=731227 "RESOLVED FIXED - Fix script object ownership in IDBWrapperCache/IDBCursor")
[status-firefox-esr10](/buglist.cgi?f1=cf_status_esr10&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_esr10&o1=equals&v1=unaffected)
[status-firefox13](/buglist.cgi?f1=cf_status_firefox13&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox13&o1=equals&v1=wontfix)Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---)

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a1882427_425645)• 13 years ago |

[status-firefox14](/buglist.cgi?f1=cf_status_firefox14&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox14&o1=equals&v1=wontfix)

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a1882440_425645)• 13 years ago |

[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Flags: approval-mozilla-aurora? → approval-mozilla-aurora+

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=765936#c21)• 13 years ago |
|  | |

Comment on [attachment 640253](/attachment.cgi?id=640253 "Patch for Beta") [[details]](/attachment.cgi?id=640253&action=edit "Patch for Beta") [[diff]](/attachment.cgi?id=640253&action=diff "Patch for Beta") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=640253)
Patch for Beta
[Triage Comment]
Spoke with Dan/Al - although this is low risk, we're already taking significant change in our final beta, and we'll try to mitigate by taking less change that's on the line.
[Attachment #640253](/attachment.cgi?id=640253&action=edit "Patch for Beta") -
Flags: approval-mozilla-beta? → approval-mozilla-beta-

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=765936#c22)• 13 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/ddda87bd4a4a>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)
[status-firefox16](/buglist.cgi?f1=cf_status_firefox16&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox16&o1=equals&v1=fixed)

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=765936#c23)• 13 years ago |
|  | |

And backed out due to test failures.
<https://hg.mozilla.org/releases/mozilla-aurora/rev/626ac9c0bf97>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed) → [affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected)

|  | [Alex Keybl [:akeybl]](/user_profile?user_id=425645) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=765936#c24)• 12 years ago |
|  | |

(In reply to Kyle Huey [:khuey] (khuey@mozilla.com) from [comment #23](/show_bug.cgi?id=765936#c23 "RESOLVED FIXED - IndexedDB wrapper behavior is still totally broken"))
> And backed out due to test failures.
>
> <https://hg.mozilla.org/releases/mozilla-aurora/rev/626ac9c0bf97>
When are we going to take another stab at this? We should still be targeting 15, given the risk profile here.

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=765936#c25)• 12 years ago |
|  | |

It's on my list for next week.

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=765936#c26)• 12 years ago |
|  | |

Attached patch

[Patch for beta](attachment.cgi?id=649325&action=diff)
— [Details](attachment.cgi?id=649325&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=649325)

Same as before, but it actually works.
[Attachment #640218](/attachment.cgi?id=640218&action=edit "Patch for Aurora") -
Attachment is obsolete: true
[Attachment #640253](/attachment.cgi?id=640253&action=edit "Patch for Beta") -
Attachment is obsolete: true
[Attachment #649325](/attachment.cgi?id=649325&action=edit "Patch for beta") -
Flags: review+
[Attachment #649325](/attachment.cgi?id=649325&action=edit "Patch for beta") -
Flags: approval-mozilla-beta?

|  | [Lukas Blakk [:lsblakk] use ?needinfo](/user_profile?user_id=272375) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=765936#c27)• 12 years ago |
|  | |

Comment on [attachment 649325](/attachment.cgi?id=649325 "Patch for beta") [[details]](/attachment.cgi?id=649325&action=edit "Patch for beta") [[diff]](/attachment.cgi?id=649325&action=diff "Patch for beta") [[review]](/page.cgi?id=splinter.html&ignore=&bug=765936&attachment=649325)
Patch for beta
approving the patch that works then :)
[Attachment #649325](/attachment.cgi?id=649325&action=edit "Patch for beta") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Kyle Huey (Exited; not receiving bugmail, old account, do not use)](/user_profile?user_id=336670)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=765936#c28)• 12 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-beta/rev/5c49f5a87e9e>
[status-firefox15](/buglist.cgi?f1=cf_status_firefox15&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox15&o1=equals&v1=fixed)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a4406734_280903)• 12 years ago |

Whiteboard: [advisory-tracking+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=765936#a10823484_1689)• 12 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=765936&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


