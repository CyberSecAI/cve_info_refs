=== Content from wordpress.org_d9cf5314_20250124_121606.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Videopack

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fvideo-embed-thumbnail-generator&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fvideo-embed-thumbnail-generator&locale=en_US)

Search plugins

![](https://ps.w.org/video-embed-thumbnail-generator/assets/banner-772x250.png?rev=2965979)
![](https://ps.w.org/video-embed-thumbnail-generator/assets/icon.svg?rev=2965979)
# Videopack

By [Kyle Gilman](https://www.kylegilman.net/)

[Download](https://downloads.wordpress.org/plugin/video-embed-thumbnail-generator.4.10.2.zip)

* [Details](https://wordpress.org/plugins/video-embed-thumbnail-generator/#description)
* [Reviews](https://wordpress.org/plugins/video-embed-thumbnail-generator/#reviews)
* [Installation](https://wordpress.org/plugins/video-embed-thumbnail-generator/#installation)
* [Development](https://wordpress.org/plugins/video-embed-thumbnail-generator/#developers)

[Support](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/)

## Description

#### A plugin to make video players, thumbnails, multiple resolutions, and video galleries.

This video plugin adds several options to any video uploaded to the WordPress Media Library. If your video can be played natively in your browser, or if you have FFMPEG installed on your server (optional), you can generate thumbnails from your video. Using either the “Generate” or “Randomize” buttons will create a selection to choose from. Click “Insert into Post” and you’ll get a shortcode in the post editor that will make a flexible, responsive video player.

If you provide multiple H.264 resolutions, Videopack can automatically select the one closest to the size of the player or a resolution of your choice, and provide a button for users to select the resolution manually. If FFMPEG is installed on your server, Videopack can encode the videos automatically.

You can also use Videopack to create a popup video gallery. The shortcode uses options similar to the [WordPress image gallery shortcode](https://codex.wordpress.org/Gallery_Shortcode). In its simplest form it will create a gallery of all videos attached to the post.

You can now add advertisements to your videos using the [Videopack Ads](https://www.videopack.video/add-ons/videopack-ads/) premium add-on which you can purchase from the Add-ons tab of the Videopack Settings page or on the [Videopack website](https://www.videopack.video/add-ons/videopack-ads/).

Not compatible with the Block Editor. Please continue to use the [Classic Editor](https://wordpress.org/plugins/classic-editor/).

Visit the [Videopack Documentation pages](https://www.videopack.video/docs/) for more info.

## Screenshots

* [![](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-1.jpg?rev=2965979)](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-1.jpg?rev=2965979)

  Thumbnails in the Add Media modal.
* [![](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-2.jpg?rev=2965979)](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-2.jpg?rev=2965979)

  Video Options in the Add Media modal.
* [![](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-3.jpg?rev=2965979)](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-3.jpg?rev=2965979)

  Encoding Queue.
* [![](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-4.jpg?rev=2965979)](https://ps.w.org/video-embed-thumbnail-generator/assets/screenshot-4.jpg?rev=2965979)

  Shortcode inserted into the post content by the plugin.

## Installation

1. Upload the unzipped folder `video-embed-thumbnail-generator` to the `/wp-content/plugins/` directory.
2. Activate the plugin through the ‘Plugins’ menu in WordPress.

## FAQ

### Why doesn’t my video play?

Most of the time your video doesn’t play because it’s not encoded in the right format. Videos have containers like mp4, mov, ogv, mkv, etc and within those containers there are video and audio codecs like H.264, MPEG-4, VP8, etc. The best option for this plugin is an mp4 container with H.264 video and AAC audio. It’s confusing, but there is a codec usually identified simply as “MPEG-4” of “MPEG-4 Visual” which is not the same thing as H.264 even if it’s in an mp4 container. mp4s with MPEG-4 video will not play in most browsers, and if you don’t use AAC audio you won’t get any audio. I highly recommend using [Handbrake](http://handbrake.fr/) to make a file with H.264 video and AAC audio in an MP4 container.

Use [MediaInfo](http://mediaarea.net/en/MediaInfo) to get really detailed information about your media files.

### Why does my video have to download completely before it starts playing?

mp4/m4v/mov files have something called a moov atom that gives the video player information about the content of the video (dimensions, duration, codecs, etc). Depending on the program you used to make your video, the moov atom can be at the beginning or the end of the file. Most video players will wait until they find the moov atom before starting playback. Otherwise it doesn’t know how to display the information it’s downloading. If it’s at the beginning of the file, playback starts very soon after the user hits the play button. If it’s at the end of the file, the whole video has to download before playback starts.

There are a number of ways to fix this problem. Most video encoding programs have an option like “Web optimized,” “Streaming,” “Fast start,” or “Progressive download.” Try to find and enable that option in your program. If you can’t do that, there are programs designed to move the moov atom to the head of the file. Try [MP4 Faststart](http://www.datagoround.com/lab/) for Windows, or [QTFastStart](http://mac.softpedia.com/get/Video/QTFastStart.shtml) for Mac.

FFMPEG puts the moov atom at the end of the file, so this can be a problem. Videopack will fix this problem on newly encoded H.264 videos if you have a recent version of FFMPEG and enable the “movflags faststart” option in the Videopack settings or if you have qt-faststart or MP4Box installed on your server.

### Why doesn’t this work with YouTube?

WordPress already has [a built-in system for embedding videos from YouTube, Vimeo, Dailymotion, etc](https://codex.wordpress.org/Embeds). Just put the URL into your post and WordPress will automatically convert it to an embedded video using oEmbed. You don’t need this plugin to do that. If you’re trying to generate new thumbnails from YouTube videos, I’m not going to risk Google’s wrath by providing that functionality. I’m not even sure I could figure out how to do it anyway.

### Why can’t I make thumbnails?

If you’re like most users and don’t have FFMPEG installed on your server, Videopack relies on your browser’s built-in ability to play videos. Google Chrome is best when making thumbnails because it supports the most formats. Wikipedia has [a great chart that explains which browsers work with which video formats](http://en.wikipedia.org/wiki/HTML5_video#Browser_support).

### How can I change the watermark’s size or position?

The watermark option is a simple image overlay and is styled using CSS. The default styling is

```
.kgvid_watermark img {
  display: block;
  position: absolute;
  bottom: 7%;
  right: 5%;
  z-index: 1;
  margin: 0px;
  max-width: 10%;
  box-shadow: none;
}

```

You can override any of those settings in either your theme’s custom CSS area or using the Jetpack “Custom CSS” module. If you want to make the watermark bigger, try something like

```
.kgvid_watermark img {
  max-width: 20%;
}

```

If you want to put it in the upper left instead of the lower right, try something like this:

```
.kgvid_watermark img {
  top: 7%;
  left: 5%;
}

```

### I’m getting an error message FFMPEG not found at /usr/local/bin/. You can embed existing videos, but video thumbnail generation and Mobile/HTML5 video encoding is not possible without FFMPEG.

You can get instructions to install FFMPEG for several different Linux distributions at https://www.tecmint.com/install-ffmpeg-in-linux/ You do not need the obsolete [FFMPEG-PHP module/extension](https://ffmpeg-php.sourceforge.net/). It does not work with Videopack.

Videopack can use FFMPEG to make thumbnails and create alternate video formats. Unfortunately most servers don’t have FFMPEG installed and most shared hosting plans don’t allow you to install FFMPEG because of the system resources it requires. You’re getting this error message because you don’t have FFMPEG installed in the most common directory. If you know you have FFMPEG installed on your server, you’ll need to find the actual path to the program and enter it in the Videopack settings field `Path to applications on server`.

Most of Videopack’s features will work without FFMPEG. You can generate embed shortcodes for your videos and make thumbnails on any host because that part of Videopack is JavaScript running in your browser. But without FFMPEG you won’t be able to automatically generate thumbnails or encode alternate formats on the server. If you don’t have your own VPS or dedicated server, Dreamhost and Arvixe are two of the few shared hosts I know of that has FFMPEG installed and available for users.

### How can I encode videos in directories protected by .htaccess passwords?

Enter the username & password in the Videopack settings page, “FFMPEG Settings” tab, or use the “Embed from URL” tab and enter the URL in this format http://username:password@yourdomain.com/uploads/2012/01/awesomevid.mp4 in the Video URL field.

## Reviews

![](https://secure.gravatar.com/avatar/82c35afc6f34eb31df1a74cad33c74465abd2fc9fdf244fd2b86c5de3e7b1ddb?s=60&d=retro&r=g)
### [Excellent plugin!](https://wordpress.org/support/topic/excellent-plugin-8490/)

[carlosvai](https://profiles.wordpress.org/carlosvai/ "Posts by carlosvai")
March 10, 2023

I needed a way to easily generate thumbnails. iOs Safari browsers do not render WordPress video thumbnails out of the box. It has something to do with not parsing the first frame or something. So I needed something that can generate an image from a second different from 0.
This plug in saves me a lot of time by simply generating an aleatory thumbnail in one click.
Of course, it has many more features, but just for that one it deserves 5 stars from me.
Thanks!

![](https://secure.gravatar.com/avatar/c97166bc0bb35cec7c257f593daadf97ca365f73e6d31cea34a5751ee5fe9678?s=60&d=retro&r=g)
### [The Best One](https://wordpress.org/support/topic/the-best-one-118/)

[Jack](https://profiles.wordpress.org/jack1132132/ "Posts by Jack")
December 15, 2022

Pretty much the best wordpress plugin to encode files.

![](https://secure.gravatar.com/avatar/b2856836e3a51ae03e0297559a7fdf2f860a8307f388ea29dd958f3495bda7b7?s=60&d=retro&r=g)
### [Works brilliantly](https://wordpress.org/support/topic/works-brilliantly-35/)

[carl4141](https://profiles.wordpress.org/carl4141/ "Posts by carl4141")
September 11, 2021

Works brilliantly!

![](https://secure.gravatar.com/avatar/283aaab7fe2438675e25a421beadbcf15cedf718f84da415964f16e184f0758c?s=60&d=retro&r=g)
### [handy plugin](https://wordpress.org/support/topic/handy-plugin-115/)

[macpheek](https://profiles.wordpress.org/macpheek/ "Posts by macpheek")
August 6, 2021

Very handy plugin, used it to add a custom thumbnail to a locally hosted video. Worked a treat

![](https://secure.gravatar.com/avatar/6a1387257f851d3cb5cbf7d37dbb6db07a649ec810e1c31b19fcf472ffc57a7b?s=60&d=retro&r=g)
### [Awesome (life)time-saver](https://wordpress.org/support/topic/awesome-lifetime-saver/)

[procuria](https://profiles.wordpress.org/procuria/ "Posts by procuria")
July 19, 2021

Beside of being a super helpful plugin, even for ‘only’ generating thumbnails and the extensive documentation, the developer is extremely fast, helpful and super friendly regarding support requests!
One of the best experiences I ever had.

![](https://secure.gravatar.com/avatar/b7d56dc70f29e33b84aa7bce14d9e580e9abace6d5daad8f17388d925ffcf687?s=60&d=retro&r=g)
### [Awesome Plugin!](https://wordpress.org/support/topic/awesome-plugin-5923/)

[worpressy](https://profiles.wordpress.org/worpressy/ "Posts by worpressy")
May 16, 2021

This plugin is by far the best plugin to embed your videos. Tons of features and best of all the developer is super professional.

[Read all 60 reviews](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/)
## Contributors & Developers

“Videopack” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/fac46e339edcfaf70886bb89bd7ceff42ee2141945d3438c67b8b2f0c29fa997?s=32&d=mm&r=g) [Kyle Gilman](https://profiles.wordpress.org/kylegilman/)

“Videopack” has been translated into 4 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/video-embed-thumbnail-generator/contributors) for their contributions.

[Translate “Videopack” into your language.](https://translate.wordpress.org/projects/wp-plugins/video-embed-thumbnail-generator)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/video-embed-thumbnail-generator/), check out the [SVN repository](https://plugins.svn.wordpress.org/video-embed-thumbnail-generator/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/video-embed-thumbnail-generator/) by [RSS](https://plugins.trac.wordpress.org/log/video-embed-thumbnail-generator/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 4.10.2 – May 8, 2024

* Fixed bug that prevented disabling the “Set all videos to expand to 100% of their containers” setting.
* Better resizing for the settings page sample video.

#### 4.10.1 – April 7, 2024

* Switched custom database query for looking up attachment IDs via URLs to the WordPress function attachment\_url\_to\_postid() which could result in some video URLs no longer returning attachment IDs when the video player code is generated. That would prevent features like video play recording in the WordPress database, and would only apply to shortcodes that don’t include attachment IDs. Please let me know if this happens to you.
* Revised thumbnail generation to work with PNG as a fallback when GD is not configured to support JPG.
* Fixed “replace original” encoding when newly-encoded files are a different format from the original. Original formats are now deleted after the replacement encode format is complete.
* Added extra check that attachment files are deleted when deleting encoded video formats.
* Fixed bug that always enabled the custom format encode setting.
* Fixed typo in FFMPEG rotation test filename.
* Made sample video on the Videopack settings page responsive.
* Added WordPress Playground Blueprint for easy plugin previews.
* Added a VIDEOPACK\_FREEMIUS\_ENABLED constant to disable loading Freemius.
* Confirmed compatibility with FFMPEG v7.0
* Updated Freemius SDK to v2.7.0

#### 4.10 – March 24, 2024

* Changed browser-thumbnail upload process to use blobs instead of data URLs and switched to wp\_handle\_upload instead of custom process for enhanced security.
* Removed Video.js v7
* Restored Freemius SDK after accidentally disabling it in 4.9.6.
* Changed audio codec for VP8/VP9 encoding from libvorbis to libopus.
* Updated FFMPEG status checking to account for log output changes in FFMPEG version 6.1
* Fixed errors when FFMPEG “Encode quality control method” was set to Average Bit Rate.
* Added custom hooks related to thumbnail generation.
* Updated Video.js to v8.10.0 and Symfony/Process to v5.4.36

#### 4.9.6 – February 26, 2024

* Fixed uninstall routine for more complete cleanup when deleting the plugin.
* Disabled Chromecast overlay button on videos used to make thumbnails.
* Removed comma after final parameter in function call that caused errors in PHP versions earlier than 7.3.

#### 4.9.5 – February 7, 2024

* Fixed bug that failed to save some Videopack settings when they were disabled.
* Fixed thumbnail rotation bug for vertical videos when using FFMPEG versions earlier than 6.0.
* Fixed bug that set the “FFMPEG Exists” option to an invalid value when upgrading to Videopack v4.8. If no settings that triggered a check for FFMPEG were changed in the year since then, FFMPEG would not execute.
* Improved options validation and FFMPEG test encode process.
* Removed “Insert title above video” option when inserting videos into posts.

#### 4.9.4 – January 23, 2024

* Fixed bugs that interfered with Media Library functions that don’t involve videos, including image gallery editing.
* Improved text track (subtitle/caption) box.

#### 4.9.3 – January 22, 2024

* Multiple fixes for in-browser thumbnail generation to make the process more stable.
* Restored inline “autoplay” attribute to Video.js video elements.
* Enabled default Video.js keyboard controls.
* Prevented page scrolling while pop-up video gallery is open.
* Replaced WordPress Default player elements with Videopack-generated ones for compatibility with URLs that contain query strings.
* Updated method for determining the location of FFMPEG on the server to allow automatic discovery in the system PATH.
* Updated Video.js to v8.9.0, Freemius SDK to v2.6.2 and Symfony/Process to v5.4.34.

#### 4.9.2 – January 13, 2024

* Fixed unpausable audio on autoplayed Video.js players (including Video Galleries).
* Fixed WordPress Default player initialization.
* Fixed unnecessary override of some canonical redirect filters.
* Improved saving thumbnails generated by FFMPEG.
* Improved manual selection of thumbnails from the Media Library.
* Improved saving plugin settings.
* Added filters for customizing video source URLs, and removed unnecessary query strings.
* Removed unnecessary browser console debugging messages.

#### 4.9.1 – November 10, 2023

* Improved in-browser thumbnail generating process.
* Improved animated GIF detection.
* Added option to change default behavior when inserting videos into a post.
* Added check for Videopack embed URLs to maintain embedding functionality after attachment pages were disabled in new WordPress 6.4 installations.
* Updated Video.js to v8.6.1 and Freemius SDK to v2.6.0.

#### 4.9 – September 12, 2023

* Removed Video.js v5.
* Removed support for FFMPEG versions older than approximately 10 years.
* Added options for skip forward/backward buttons in Video.js v8 players.
* Fixed bug that rotated vertical videos incorrectly when encoding video formats.
* Restored video thumbnail watermark previews on the settings page.
* Improved methods for determining the mime type of URLs and animated GIF detection.
* Revised FFMPEG scaling method to use the “scale” video filter instead of -s
* Removed width setting from custom video encoding formats. Width will be calculated automatically to match the aspect ratio of the original video.
* Added new sample video to plugin settings page.
* Updated Video.js to v8.5.2 and v7.21.5
* Updated Freemius SDK to 2.5.12
* Updated Symfony/Process to v5.4.28

[See the full changelog on the Videopack website.](https://www.videopack.video/docs/changelog/)

## Meta

* Version **4.10.2**
* Last updated **9 months ago**
* Active installations **10,000+**
* WordPress version **5.0 or higher**
* Tested up to **6.5.5**
* PHP version **7.2 or higher**
* Languages
  See all 5

  Close

  [English (US)](https://wordpress.org/plugins/video-embed-thumbnail-generator/), [French (France)](https://fr.wordpress.org/plugins/video-embed-thumbnail-generator/), [German](https://de.wordpress.org/plugins/video-embed-thumbnail-generator/), [Greek](https://el.wordpress.org/plugins/video-embed-thumbnail-generator/), and [Spanish (Spain)](https://es.wordpress.org/plugins/video-embed-thumbnail-generator/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/video-embed-thumbnail-generator)
* Tags [thumbnail](https://wordpress.org/plugins/tags/thumbnail/)[video](https://wordpress.org/plugins/tags/video/)[video gallery](https://wordpress.org/plugins/tags/video-gallery/)[video player](https://wordpress.org/plugins/tags/video-player/)
* [Advanced View](https://wordpress.org/plugins/video-embed-thumbnail-generator/advanced/)

## Ratings

4.8 out of 5 stars.

* [56 5-star reviews
  5 stars

  56](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/?filter=5)
* [1 4-star review
  4 stars

  1](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/?filter=3)
* [0 2-star reviews
  2 stars

  0](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/?filter=2)
* [3 1-star reviews
  1 star

  3](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/fac46e339edcfaf70886bb89bd7ceff42ee2141945d3438c67b8b2f0c29fa997?s=32&d=mm&r=g) [Kyle Gilman](https://profiles.wordpress.org/kylegilman/)
## Support

Issues resolved in last two months:

0 out of 1

[View support forum](https://wordpress.org/support/plugin/video-embed-thumbnail-generator/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=kylegilman@gmail.com&item_name=Videopack%20Plugin%20Donation)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_504b05c3_20250124_121605.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew_path%3D%252Fvideo-embed-thumbnail-generator%26old%3D507924%26new%3D507924%26old_path%3D%252Fvideo-embed-thumbnail-generator)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/486730/video-embed-thumbnail-generator "Changeset 486730 for video-embed-thumbnail-generator")
* [Next Change](/changeset/507928/video-embed-thumbnail-generator "Changeset 507928 for video-embed-thumbnail-generator") →

---

# Changeset [507924](/changeset/507924 "Show full changeset") for [video-embed-thumbnail-generator](/browser/video-embed-thumbnail-generator?rev=507924 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/20/2012 10:00:46 PM
([13 years](/timeline?from=2012-02-20T22%3A00%3A46Z&precision=second "See timeline at 02/20/2012 10:00:46 PM") ago)

Author:
kylegilman
Message:

Version 2.0 with multiple security fixes and UI improvements

Location:
[video-embed-thumbnail-generator/trunk](/browser/video-embed-thumbnail-generator/trunk?rev=507924)
Files:

2 added
6 edited

* [kg\_callffmpeg.php](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924 "Show entry in browser")
  (modified)
  ([11 diffs](#file0 "Show differences"))
* [kg\_video\_plugin.js](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=507924 "Show entry in browser")
  (modified)
  ([4 diffs](#file1 "Show differences"))
* [readme.txt](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924 "Show entry in browser")
  (modified)
  ([6 diffs](#file2 "Show differences"))
* [screenshot-2.jpg](/browser/video-embed-thumbnail-generator/trunk/screenshot-2.jpg?rev=507924 "Show entry in browser")
  (modified)
  ([previous](/browser/video-embed-thumbnail-generator/trunk/screenshot-2.jpg?rev=486697 "Show previous version in browser"))
* [screenshot-3.jpg](/browser/video-embed-thumbnail-generator/trunk/screenshot-3.jpg?rev=507924 "Show entry in browser")
  (modified)
  ([previous](/browser/video-embed-thumbnail-generator/trunk/screenshot-3.jpg?rev=453632 "Show previous version in browser"))
* [screenshot-4.jpg](/browser/video-embed-thumbnail-generator/trunk/screenshot-4.jpg?rev=507924 "Show entry in browser")
  (added)
* [video-embed-thumbnail-generator.css](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.css?rev=507924 "Show entry in browser")
  (added)
* [video-embed-thumbnail-generator.php](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924 "Show entry in browser")
  (modified)
  ([31 diffs](#file7 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [video-embed-thumbnail-generator/trunk/kg\_callffmpeg.php](/changeset/507924/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php "Show the changeset 507924 restricted to video-embed-thumbnail-generator/trunk/kg_callffmpeg.php")

  | [r486697](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L1 "Show revision 486697 of this file in browser") | [r507924](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L1 "Show revision 507924 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  |  |
  | 3 |  | $ffmpegPath = $\_POST['ffmpeg']."/ffmpeg"; |
  | 4 |  | $encodemobile = $\_POST['encodemobile']; |
  | 5 |  | $encodeogg = $\_POST['encodeogg']; |
  | 6 |  | $encodewebm = $\_POST['encodewebm']; |
  | 7 |  | $movieurl = $\_POST['movieurl']; |
  | 8 |  | $numberofthumbs = $\_POST['numberofthumbs']; |
  | 9 |  | //$randomize = $\_POST['randomize']; |
  | 10 |  | $action = $\_POST['action']; |
  | 11 |  | $poster = $\_POST['poster']; |
  | 12 |  | $uploads['path'] = $\_POST['uploads\_path']; |
  | 13 |  | $uploads['url'] = $\_POST['uploads\_url']; |
  | 14 |  | $uploads['basedir'] = $\_POST['uploads\_basedir']; |
  | 15 |  | $postID = $\_POST['attachmentID']; |
  | 16 |  | $thumbtimecode = $\_POST['thumbtimecode']; |
  | 17 |  | $dofirstframe = $\_POST['dofirstframe']; |
  | 18 |  | $generate\_button = $\_POST['generate\_button']; |
  | 19 |  |  |
  | 20 |  | $moviefilepath = str\_replace(" ", "%20", $movieurl); |
  |  | 2 | global $ffmpegPath; |
  |  | 3 | $ffmpegPath = get\_option('wp\_FMP\_ffmpeg')."/ffmpeg"; |
  |  | 4 | $mobile\_res = get\_option('wp\_FMP\_mobile\_res'); |
  |  | 5 | $uploads = wp\_upload\_dir(); |
  |  | 6 | if (isset($\_POST['encodemobile'])) { $encodemobile = $\_POST['encodemobile']; } |
  |  | 7 | if (isset($\_POST['encodeogg'])) { $encodeogg = $\_POST['encodeogg']; } |
  |  | 8 | if (isset($\_POST['encodewebm'])) { $encodewebm = $\_POST['encodewebm']; } |
  |  | 9 | if (isset($\_POST['movieurl'])) { $movieurl = $\_POST['movieurl']; } |
  |  | 10 | if (isset($\_POST['numberofthumbs'])) { $numberofthumbs = $\_POST['numberofthumbs']; } |
  |  | 11 | if (isset($\_POST['thumbnumber'])) { $i = $\_POST['thumbnumber']; } |
  |  | 12 | if (isset($\_POST['thumbnumberplusincreaser'])) { $iincreaser = $\_POST['thumbnumberplusincreaser']; } |
  |  | 13 | if (isset($\_POST['ffmpeg\_action'])) { $action = $\_POST['ffmpeg\_action']; } |
  |  | 14 | if (isset($\_POST['poster'])) { $poster = $\_POST['poster']; } |
  |  | 15 | if (isset($\_POST['attachmentID'])) { $postID = $\_POST['attachmentID']; } |
  |  | 16 | if (isset($\_POST['thumbtimecode'])) { $thumbtimecode = $\_POST['thumbtimecode']; } |
  |  | 17 | if (isset($\_POST['dofirstframe'])) { $dofirstframe = $\_POST['dofirstframe']; } |
  |  | 18 | if (isset($\_POST['generate\_button'])) { $generate\_button = $\_POST['generate\_button']; } |
  |  | 19 |  |
  |  | 20 | if ($postID != "singleurl") { $moviefilepath = get\_attached\_file($postID); } |
  |  | 21 | else { $moviefilepath = str\_replace(" ", "%20", $movieurl); } |
  | 21 | 22 | $movie\_extension = pathinfo(parse\_url($movieurl, PHP\_URL\_PATH), PATHINFO\_EXTENSION); |
  | 22 | 23 | $moviefilebasename = basename($movieurl,'.'.$movie\_extension); |
  | 23 | 24 | $thumbnailfilebase = $uploads['url']."/thumb\_tmp/".$moviefilebasename; |
  |  | 25 |  |
  | 24 | 26 |  |
  | 25 | 27 | class Process{ |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L34) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L36) |  |
  | 34 | 36 | } |
  | 35 | 37 | private function runCom(){ |
  | 36 |  | $command = 'nohup '.$this->command.' > /dev/null 2>&1 & echo $!'; |
  | 37 |  | //$command = 'nohup '.$this->command.' 1> /home/kylegilm/output.txt 2>&1'; |
  | 38 |  | exec($command ,$op); |
  | 39 |  | $this->pid = (int)$op[0]; |
  |  | 38 |  |
  |  | 39 | //$command = 'nohup '.$this->command.' > /dev/null 2>&1 & echo $!'; //this is the original command |
  |  | 40 |  |
  |  | 41 | $sys = strtoupper(PHP\_OS); // Get OS Name |
  |  | 42 | if(substr($sys,0,3) == "WIN") { |
  |  | 43 | $command = $this->command; |
  |  | 44 | $this->OS = "windows"; |
  |  | 45 | } //exec this way if it's Windows |
  |  | 46 |  |
  |  | 47 | else { |
  |  | 48 | $command = 'nohup '.$this->command; |
  |  | 49 | $this->OS = "linux"; |
  |  | 50 | } |
  |  | 51 |  |
  |  | 52 | exec($command ,$op); |
  |  | 53 | $this->output = $op; |
  |  | 54 | if(substr($sys,0,3) != "WIN") { $this->pid = (int)$op[0]; } |
  | 40 | 55 | } |
  | 41 | 56 |  |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L78) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L93) |  |
  | 78 | 93 | function get\_video\_dimensions($video = false) { |
  | 79 | 94 | global $ffmpegPath; |
  |  | 95 |  |
  | 80 | 96 | $command = $ffmpegPath . ' -i "' . $video . '" -vstats 2>&1'; |
  | 81 | 97 |  |
  | 82 | 98 | exec ( $command, $output ); |
  |  | 99 | $lastline = end($output); |
  |  | 100 | $lastline = prev($output)."<br />".$lastline; |
  | 83 | 101 | $output = implode("\n", $output); |
  | 84 | 102 |  |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L93) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L111) |  |
  | 93 | 111 | preg\_match('/configuration: (.\*?)\n/', $output, $matches); |
  | 94 | 112 | $configuration = $matches[1]; |
  | 95 |  | return array ('width' => $width, 'height' => $height, 'duration' => $duration, 'configuration' => $configuration ); |
  |  | 113 | preg\_match('/rotate          : (.\*?)\n/', $output, $matches); |
  |  | 114 | if ( array\_key\_exists(1, $matches) == true ) { $rotate = $matches[1]; } |
  |  | 115 | else $rotate = "0"; |
  |  | 116 | return array ('width' => $width, 'height' => $height, 'duration' => $duration, 'configuration' => $configuration, 'rotate' => $rotate, 'worked'=>true ); |
  | 96 | 117 | } else { |
  | 97 |  | return ~~false~~; |
  |  | 118 | return array ('output'=>$lastline, 'worked'=>false); |
  | 98 | 119 | } |
  | 99 | 120 |  |
  | 100 | 121 | } |
  | 101 | 122 |  |
  | 102 |  | function rrmdir($dir) { |
  | 103 |  | if (is\_dir($dir)) { |
  | 104 |  | $objects = scandir($dir); |
  | 105 |  | foreach ($objects as $object) { |
  | 106 |  | if ($object != "." && $object != "..") { |
  | 107 |  | if (filetype($dir."/".$object) == "dir") rrmdir($dir."/".$object); else unlink($dir."/".$object); |
  | 108 |  | } |
  | 109 |  | } |
  | 110 |  | reset($objects); |
  | 111 |  | rmdir($dir); |
  | 112 |  | } |
  | 113 |  | } |
  | 114 |  |  |
  | 115 |  |  |
  | 116 |  | if ($action == generate || $action == encode ) { |
  | 117 |  |  |
  | 118 |  | exec($ffmpegPath.' /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 119 |  |  |
  | 120 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  |  | 123 | if ($action == "generate" || $action == "encode" ) { |
  |  | 124 |  |
  |  | 125 | //exec($ffmpegPath.' /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  |  | 126 | $ffmpeg\_info = kg\_check\_ffmpeg\_exists(); |
  |  | 127 |  |
  |  | 128 | if ( $ffmpeg\_info['ffmpeg\_exists'] == true ) { //if FFMPEG executed |
  | 121 | 129 |  |
  | 122 | 130 | $movie\_info = get\_video\_dimensions($moviefilepath); |
  | 123 | 131 |  |
  | 124 |  | if ($movie\_info~~!= fals~~e) { //if FFMPEG was able to open the file |
  |  | 132 | if ($movie\_info['worked'] == true) { //if FFMPEG was able to open the file |
  | 125 | 133 |  |
  | 126 | 134 | $movie\_duration\_hours = intval(substr($movie\_info['duration'], -11, 2)); |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L131) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L139) |  |
  | 131 | 139 | $movie\_height = $movie\_info['height']; |
  | 132 | 140 |  |
  | 133 |  | if ($action == generate) { |
  | 134 |  |  |
  | 135 |  | //rrmdir($uploads['path'].'/thumb\_tmp'); |
  |  | 141 | switch ($movie\_info['rotate']) { |
  |  | 142 | case "90": $movie\_rotate = '-vf "transpose=1"'; break; |
  |  | 143 | case "180": $movie\_rotate = '-vf "hflip,vflip"'; break; |
  |  | 144 | case "270": $movie\_rotate = '-vf "transpose=2"'; break; |
  |  | 145 | default: $movie\_rotate = ""; break; |
  |  | 146 | } |
  |  | 147 |  |
  |  | 148 | if ($action == "generate") { |
  |  | 149 |  |
  | 136 | 150 | if (!file\_exists($uploads['path'].'/thumb\_tmp')) { mkdir($uploads['path'].'/thumb\_tmp'); } |
  | 137 | 151 |  |
  | 138 | 152 | $thumbnailheight = strval(round(floatval($movie\_height) / floatval($movie\_width) \* 200)); |
  |  | 153 |  |
  |  | 154 | switch ($movie\_info['rotate']) { //if it's a sideways iPhone video |
  |  | 155 | case "90"; |
  |  | 156 | case "270": $thumbnailheight = strval(round(floatval($movie\_width) / floatval($movie\_height) \* 200)); |
  |  | 157 | } |
  |  | 158 |  |
  | 139 | 159 | $jpgpath = $uploads['path']."/thumb\_tmp/"; |
  | 140 |  |  |
  | 141 |  | ~~$i = 1;~~ |
  | 142 |  | ~~$increaser = 0;~~ |
  | 143 |  |  |
  | 144 |  | ~~$thumbnaildisplaycode = '<p><strong>Choose Thumbnail:</strong></p><div style="border-style:solid; border-color:#ccc; border-width:1px; width:425px; text-align:center; margin-bottom:10px; padding:5px;">';~~ |
  | 145 |  |  |
  | 146 |  | ~~while ($i <= $numberofthumbs) {~~ |
  | 147 | 160 |  |
  | 148 |  | $iincreaser = $i + $increaser; |
  | 149 |  | $movieoffset = round(($movie\_duration\_seconds \* $iincreaser) / ($numberofthumbs \* 2)); |
  | 150 |  |  |
  | 151 |  | if ($generate\_button == "random") { //adjust offset random amount |
  | 152 |  | $movieoffset = $movieoffset - rand(0, round($movie\_duration\_seconds / $numberofthumbs)); |
  | 153 |  | } |
  | 154 |  |  |
  | 155 |  | if ($thumbtimecode) { //if a specific thumbnail timecode is set |
  | 156 |  | if ($thumbtimecode == "firstframe") { $thumbtimecode = "0"; } |
  | 157 |  | $timecode\_array = explode(":", $thumbtimecode); |
  | 158 |  | $timecode\_array = array\_reverse($timecode\_array); |
  | 159 |  | $thumbtimecode = $timecode\_array[0] + ($timecode\_array[1] \* 60) + ($timecode\_array[2] \* 3600); |
  | 160 |  | $movieoffset = $thumbtimecode; |
  | 161 |  | $i = $numberofthumbs + 1; |
  | 162 |  | } |
  | 163 |  |  |
  | 164 |  | if ($dofirstframe == "true" && $i == 1) { |
  | 165 |  | $movieoffset = "0"; |
  | 166 |  | } |
  | 167 |  |  |
  | 168 |  | $thumbnailfilename[$i] = $jpgpath.$moviefilebasename."\_thumb".$i.".jpg"; |
  | 169 |  | $thumbnailfilename[$i] = str\_replace(" ", "\_", $thumbnailfilename[$i]); |
  | 170 |  | $ffmpeg\_options = '-y -ss '.$movieoffset.' -i "'.$moviefilepath.'" -vframes 1 "'.$thumbnailfilename[$i].'"'; |
  | 171 |  | $thumbnailurl = $thumbnailfilebase."\_thumb".$i.'.jpg'; |
  | 172 |  | $thumbnailurl = str\_replace(" ", "\_", $thumbnailurl); |
  | 173 |  |  |
  | 174 |  | exec($ffmpegPath." ".$ffmpeg\_options); |
  | 175 |  |  |
  | 176 |  | if (floatval($movieoffset) > 60) { |
  | 177 |  | $movieoffset\_minutes = sprintf("%02s", intval(intval($movieoffset) / 60) ); |
  | 178 |  | $movieoffset\_seconds = sprintf("%02s", round(fmod( floatval($movieoffset), 60), 2) ); |
  | 179 |  | $movieoffset\_display = $movieoffset\_minutes.":".$movieoffset\_seconds; |
  | 180 |  | } |
  | 181 |  | else { $movieoffset\_display = "00:".sprintf("%02s", $movieoffset); } |
  | 182 |  |  |
  | 183 |  | $thumbnaildisplaycode = $thumbnaildisplaycode.'<div style="text-align:center; display:inline-block; margin:2px;"><label for="kgflashmedia-thumb'.$i.'"><img src="'.$thumbnailurl.'?'.rand().'" width="200" height="'.$thumbnailheight.'"></label><br /><input type="radio" name="kgflashmedia-thumb" id="kgflashmedia-thumb'.$i.'" value="'.str\_replace('/thumb\_tmp/', '/', $thumbnailurl).'" onchange="getElementById(\'attachments['. $postID .'][kgflashmediaplayer-poster]\').value = this.value; getElementById(\'attachments['. $postID .'][thumbtime]\').value = \''. $movieoffset\_display .'\'; getElementById(\'attachments\_'. $postID .'\_numberofthumbs\').value =\'1\';"></div>'; |
  | 184 |  |  |
  | 185 |  | $increaser++; |
  | 186 |  | $i++; |
  | 187 |  | } //end thumbnail loop |
  | 188 |  |  |
  | 189 |  | //$thumbnaildisplaycode = $thumbnaildisplaycode.'<p><input type="button" id="attachments['. $postID .'][confirmbutton]" class="button-secondary" value="Confirm" name="confirmbutton" onclick="kg\_generate\_thumb('. $postID .', \'confirm\');"/></p>'; |
  | 190 |  |  |
  | 191 |  | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode, "movie\_width"=>$movie\_width, "movie\_height"=>$movie\_height ); |
  |  | 161 | $movieoffset = round(($movie\_duration\_seconds \* $iincreaser) / ($numberofthumbs \* 2)); |
  |  | 162 |  |
  |  | 163 | if ($generate\_button == "random") { //adjust offset random amount |
  |  | 164 | $movieoffset = $movieoffset - rand(0, round($movie\_duration\_seconds / $numberofthumbs)); |
  |  | 165 | if ($movieoffset < 0) { $movieoffset = "0"; } |
  |  | 166 | } |
  |  | 167 |  |
  |  | 168 | if ($thumbtimecode) { //if a specific thumbnail timecode is set |
  |  | 169 | if ($thumbtimecode == "firstframe") { $thumbtimecode = "0"; } |
  |  | 170 | $timecode\_array = explode(":", $thumbtimecode); |
  |  | 171 | $timecode\_array = array\_reverse($timecode\_array); |
  |  | 172 | $thumbtimecode = $timecode\_array[0] + ($timecode\_array[1] \* 60) + ($timecode\_array[2] \* 3600); |
  |  | 173 | $movieoffset = $thumbtimecode; |
  |  | 174 | $i = $numberofthumbs + 1; |
  |  | 175 | } |
  |  | 176 |  |
  |  | 177 | if ($dofirstframe == "true" && $i == 1) { |
  |  | 178 | $movieoffset = "0"; |
  |  | 179 | } |
  |  | 180 |  |
  |  | 181 | $thumbnailfilename[$i] = $jpgpath.$moviefilebasename."\_thumb".$i.".jpg"; |
  |  | 182 | $thumbnailfilename[$i] = str\_replace(" ", "\_", $thumbnailfilename[$i]); |
  |  | 183 | $ffmpeg\_options = '-y -ss '.$movieoffset.' -i "'.$moviefilepath.'" '.$movie\_rotate.' -vframes 1 "'.$thumbnailfilename[$i].'"'; |
  |  | 184 | $thumbnailurl = $thumbnailfilebase."\_thumb".$i.'.jpg'; |
  |  | 185 | $thumbnailurl = str\_replace(" ", "\_", $thumbnailurl); |
  |  | 186 |  |
  |  | 187 | exec($ffmpegPath." ".$ffmpeg\_options); |
  |  | 188 |  |
  |  | 189 | if (floatval($movieoffset) > 60) { |
  |  | 190 | $movieoffset\_minutes = sprintf("%02s", intval(intval($movieoffset) / 60) ); |
  |  | 191 | $movieoffset\_seconds = sprintf("%02s", round(fmod( floatval($movieoffset), 60), 2) ); |
  |  | 192 | $movieoffset\_display = $movieoffset\_minutes.":".$movieoffset\_seconds; |
  |  | 193 | } |
  |  | 194 | else { $movieoffset\_display = "00:".sprintf("%02s", $movieoffset); } |
  |  | 195 |  |
  |  | 196 | $thumbnaildisplaycode = '<div class="kg\_thumbnail\_select" name="attachments\_'.$postID.'\_thumb'.$i.'" id="attachments\_'.$postID.'\_thumb'.$i.'"><label for="kgflashmedia-thumb'.$i.'"><img src="'.$thumbnailurl.'?'.rand().'" width="200" height="'.$thumbnailheight.'" class="kg\_thumbnail"></label><br /><input type="radio" name="kgflashmedia-thumb" id="kgflashmedia-thumb'.$i.'" value="'.str\_replace('/thumb\_tmp/', '/', $thumbnailurl).'" onchange="getElementById(\'attachments['. $postID .'][kgflashmediaplayer-poster]\').value = this.value; getElementById(\'attachments['. $postID .'][thumbtime]\').value = \''. $movieoffset\_display .'\'; getElementById(\'attachments\_'. $postID .'\_numberofthumbs\').value =\'1\';"></div>'; |
  |  | 197 |  |
  |  | 198 | switch ($movie\_info['rotate']) { |
  |  | 199 | case "90"; |
  |  | 200 | case "270": $movie\_width ^= $movie\_height ^= $movie\_width ^= $movie\_height; break; //swap height & width |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | $i++; |
  |  | 204 |  |
  |  | 205 | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode, "movie\_width"=>$movie\_width, "movie\_height"=>$movie\_height, "lastthumbnumber"=>$i, "movieoffset"=>$movieoffset ); |
  | 192 | 206 |  |
  | 193 | 207 | echo json\_encode($arr); |
  | 194 | 208 | }//if generate |
  | 195 | 209 |  |
  | 196 |  | if ($action == ~~encode~~) { |
  |  | 210 | if ($action == "encode") { |
  | 197 | 211 |  |
  | 198 | 212 | //preferred encode path is the directory of the original file (likely in the wp\_upload dir) |
  | 199 | 213 | $encodepath = ""; |
  | 200 |  | $url\_parts = parse\_url($uploads['url']); |
  | 201 |  | if ( strpos($moviefilepath, $url\_parts['host']) != "" ) { //if we're on the same server |
  | 202 |  | $home\_path = substr(strrev(strstr(strrev($uploads['basedir']), strrev("public\_html"))), 0, -strlen("public\_html")); //home path of the current server |
  | 203 |  | $moviefiledirectory = dirname(parse\_url($moviefilepath, PHP\_URL\_PATH)); //gets file's directory |
  | 204 |  | $encodepath = $home\_path."public\_html".$moviefiledirectory."/"; |
  | 205 |  | } |
  | 206 |  | if ( !is\_writable($encodepath) ) { //if the original directory is not writable use a directory in base wp\_upload |
  | 207 |  | $encodepath = $uploads['basedir']."/html5encodes/"; |
  | 208 |  | if ( !file\_exists($encodepath) ) { mkdir($encodepath); } |
  | 209 |  | } |
  | 210 |  |  |
  | 211 |  | $ipodfilepath = $encodepath.$moviefilebasename."-ipod.m4v"; |
  | 212 |  | $ogvfilepath = $encodepath.$moviefilebasename.".ogv"; |
  | 213 |  | $webmfilepath = $encodepath.$moviefilebasename.".webm"; |
  |  | 214 | $embed\_display = ""; |
  |  | 215 | $ffmpeg\_ipod\_options = ""; |
  |  | 216 | $ffmpeg\_ogv\_options = ""; |
  |  | 217 | $ffmpeg\_webm\_options = ""; |
  |  | 218 | $logfile = ""; |
  |  | 219 | $processPID = ""; |
  |  | 220 | $serverOS = ""; |
  |  | 221 |  |
  |  | 222 | $encode\_anything = "false"; |
  |  | 223 |  |
  |  | 224 | $encodevideo\_info = kg\_encodevideo\_info($movieurl, $postID); |
  | 214 | 225 |  |
  | 215 | 226 | if ($encodemobile == "true") { |
  | 216 |  | if ( ! file\_exists($ipodfilepath) || filesize($webmfilepath) < 24576 ) { |
  | 217 |  | $ipod\_movie\_height = strval(round(floatval($movie\_height) / floatval($movie\_width) \* 640)); |
  | 218 |  | if ($ipod\_movie\_height % 2 != 0) { $ipod\_movie\_height++; } |
  | 219 |  | if ( strpos($movie\_info['configuration'], 'enable-libfaac') &&  strpos($movie\_info['configuration'], 'enable-libx264') ) { |
  | 220 |  | $ffmpeg\_ipod\_options = ' -acodec libfaac -ab 128k -s 640x'.$ipod\_movie\_height.' -vcodec libx264 -vpre slow -vpre ipod640 -b 800k -bt 800k -threads 1 -f ipod "'.$ipodfilepath.'"'; |
  | 221 |  | $embed\_display .= "<strong> Encoding Mobile M4V... </strong>"; |
  |  | 227 | if ( ! $encodevideo\_info['mobile\_exists'] || ($encodevideo\_info['sameserver'] && filesize($encodevideo\_info['mobilefilepath']) < 24576) ) { |
  |  | 228 |  |
  |  | 229 | switch($mobile\_res) { |
  |  | 230 | case "480": $ipod\_movie\_max\_width = 640; break; |
  |  | 231 | case "720": $ipod\_movie\_max\_width = 1280; break; |
  |  | 232 | case "1080": $ipod\_movie\_max\_width = 1920; break; |
  |  | 233 | default: $ipod\_movie\_max\_width = 640; |
  |  | 234 | } |
  |  | 235 |  |
  |  | 236 | if ( floatval($movie\_width)  > $ipod\_movie\_max\_width ) { $ipod\_movie\_width = strval($ipod\_movie\_max\_width); } |
  |  | 237 | else { $ipod\_movie\_width = $movie\_width; } |
  |  | 238 | $ipod\_movie\_height = strval(round(floatval($movie\_height) / floatval($movie\_width) \* $ipod\_movie\_width)); |
  |  | 239 | if ($ipod\_movie\_height % 2 != 0) { $ipod\_movie\_height++; } //make sure it's an even number |
  |  | 240 |  |
  |  | 241 | if ( strpos($movie\_info['configuration'], 'enable-libfaac') || strpos($movie\_info['configuration'], 'enable-libvo-aacenc') &&  strpos($movie\_info['configuration'], 'enable-libx264') ) { |
  |  | 242 |  |
  |  | 243 | if ( strpos($movie\_info['configuration'], 'enable-libfaac') ) { $aaclib = "libfaac"; } |
  |  | 244 | else { $aaclib = "libvo\_aacenc"; } |
  |  | 245 |  |
  |  | 246 | $ipodbitrate = $movie\_height \* 3; |
  |  | 247 |  |
  |  | 248 | $ffmpeg\_ipod\_options = ' -acodec '.$aaclib.' -ab 128k -s '.$ipod\_movie\_width.'x'.$ipod\_movie\_height.' -vcodec libx264 -threads 1 '.$movie\_rotate.' -b:v '.$ipodbitrate.'k -bt 800k -f ipod "'.$encodevideo\_info['mobilefilepath'].'"'; |
  |  | 249 | $encode\_anything = "true"; |
  |  | 250 | $embed\_display .= "<strong> Encoding Mobile M4V. </strong>"; |
  | 222 | 251 | }//if the proper FFMPEG libraries are enabled |
  | 223 |  | else { $embed\_display .= "<strong>FFMPEG missing library 'libfaac' ~~or 'libx264' required for iPod~~ encoding. </strong>"; } |
  | 224 |  | }//if ~~iPod~~ file doesn't already exist |
  |  | 252 | else { $embed\_display .= "<strong>FFMPEG missing library 'libfaac' 'libvo-aacenc' or 'libx264' required for Mobile M4V encoding. </strong>"; } |
  |  | 253 | }//if mobile file doesn't already exist |
  | 225 | 254 | else { $embed\_display .= "<strong>Mobile M4V Already Encoded! </strong>"; } |
  | 226 | 255 | }//if mobile is checked |
  | 227 | 256 |  |
  | 228 | 257 | if ($encodewebm == "true") { |
  | 229 |  | if ( ! ~~file\_exists($webmfilepath) || filesize($webmfilepath) < 24576~~ ) { |
  |  | 258 | if ( ! $encodevideo\_info['webm\_exists'] || ($encodevideo\_info['sameserver'] && filesize($encodevideo\_info['webmfilepath']) < 24576) ) { |
  | 230 | 259 | if ( strpos($movie\_info['configuration'], 'enable-libvorbis') &&  strpos($movie\_info['configuration'], 'enable-libvpx') ) { |
  | 231 | 260 | $webmbitrate = $movie\_height \* 3; |
  | 232 |  | $ffmpeg\_webm\_options = ' -ab 128k -b '.$webmbitrate.'k -threads 1 "'.$webmfilepath.'"'; |
  | 233 |  | $embed\_display .= "<strong> Encoding WEBM... </strong>"; |
  |  | 261 | $ffmpeg\_webm\_options = ' -ab 128k -b:v '.$webmbitrate.'k '.$movie\_rotate.' -threads 1 "'.$encodevideo\_info['webmfilepath'].'"'; |
  |  | 262 | $encode\_anything = "true"; |
  |  | 263 | $embed\_display .= "<strong> Encoding WEBM. </strong>"; |
  | 234 | 264 | }//if the proper FFMPEG libraries are enabled |
  | 235 | 265 | else { $embed\_display .= "<strong>FFMPEG missing library 'libvorbis' or 'libvpx' required for WEBM encoding. </strong>"; } |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L239) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L269) |  |
  | 239 | 269 |  |
  | 240 | 270 | if ($encodeogg == "true") { |
  | 241 |  | if ( ! ~~file\_exists($ogvfilepath) || filesize($webmfilepath) < 24576~~ ) { |
  |  | 271 | if ( ! $encodevideo\_info['ogg\_exists'] || ($encodevideo\_info['sameserver'] && filesize($encodevideo\_info['oggfilepath']) < 24576) ) { |
  | 242 | 272 |  |
  | 243 | 273 | if ( strpos($movie\_info['configuration'], 'enable-libvorbis') &&  strpos($movie\_info['configuration'], 'enable-libtheora') ) { |
  | 244 | 274 | $ogvbitrate = $movie\_height \* 3; |
  | 245 |  | $ffmpeg\_ogv\_options = ' -acodec libvorbis -ab 128k -vcodec libtheora -b '.$ogvbitrate.'k -threads 1 "'.$ogvfilepath.'"'; |
  | 246 |  | $embed\_display .= "<strong> Encoding OGV... </strong>"; |
  |  | 275 | $ffmpeg\_ogv\_options = ' -acodec libvorbis -ab 128k -vcodec libtheora -b:v '.$ogvbitrate.'k '.$movie\_rotate.' -threads 1 "'.$encodevideo\_info['oggfilepath'].'"'; |
  |  | 276 | $encode\_anything = "true"; |
  |  | 277 | $embed\_display .= "<strong> Encoding OGV. </strong>"; |
  | 247 | 278 | }//if the proper FFMPEG libraries are enabled |
  | 248 | 279 | else { $embed\_display .= "<strong>FFMPEG missing library 'libvorbis' or 'libtheora' required for OGV encoding. </strong>"; } |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L252) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L283) |  |
  | 252 | 283 |  |
  | 253 | 284 |  |
  | 254 |  | if ( ! file\_exists($ogvfilepath) || ! file\_exists($ipodfilepath) || ! file\_exists($webmfilepath) ) { |
  | 255 |  | $ffmpeg\_options = '-y -i "'.$moviefilepath.'"'.$ffmpeg\_ipod\_options.$ffmpeg\_ogv\_options.$ffmpeg\_webm\_options; |
  | 256 |  |  |
  | 257 |  | $process = new Process($ffmpegPath." ".$ffmpeg\_options); |
  |  | 285 | if ( $encode\_anything == "true" ) { |
  |  | 286 |  |
  |  | 287 | if ( ! file\_exists($encodevideo\_info['encodepath']) ) { mkdir($encodevideo\_info['encodepath']); } |
  |  | 288 |  |
  |  | 289 | $ffmpeg\_options = '-y -i "'.$moviefilepath.'" '.$ffmpeg\_ipod\_options.$ffmpeg\_ogv\_options.$ffmpeg\_webm\_options; |
  |  | 290 | $logfile = $encodevideo\_info['encodepath'].str\_replace(" ", "\_", $moviefilebasename)."\_".sprintf("%04s",mt\_rand(1, 1000))."\_encode.txt"; |
  |  | 291 | $cmd = escapeshellcmd($ffmpegPath." ".$ffmpeg\_options); |
  |  | 292 | $cmd = $cmd." > ".$logfile." 2>&1 & echo $!"; |
  |  | 293 |  |
  |  | 294 | $process = new Process($cmd); |
  |  | 295 |  |
  |  | 296 | sleep(1); |
  |  | 297 |  |
  |  | 298 | $processPID = $process->getPid(); |
  |  | 299 | $serverOS = $process->OS; |
  |  | 300 | $encodevideo\_info = kg\_encodevideo\_info($movieurl, $postID); //update after encoding starts |
  |  | 301 |  |
  |  | 302 | $embed\_display .= " <em><small>(continues if window is closed)</small></em>"; |
  |  | 303 |  |
  |  | 304 | //$output\_map = array\_map(create\_function('$key, $value', 'return $key.":".$value." # ";'), array\_keys($process->output), array\_values($process->output)); |
  |  | 305 | //$output\_implode = implode($output\_map); |
  |  | 306 |  |
  |  | 307 | //$embed\_display .= "Command: ".$cmd." Status: ".$process->status()." Output: ".$output\_implode; |
  | 258 | 308 |  |
  | 259 | 309 | }//if any HTML5 videos don't already exist |
  | 260 | 310 |  |
  | 261 |  | $arr = array ( "embed\_display"=>$embed\_display ); |
  | 262 |  |  |
  |  | 311 | $replaceoptions = ""; |
  |  | 312 | if ( $encodevideo\_info['mobile\_exists'] ) { $replaceoptions .= '<option value="'.$encodevideo\_info['mobileurl'].'">Mobile/H.264</option>'; } |
  |  | 313 | if ( $encodevideo\_info['webm\_exists'] ) { $replaceoptions .= '<option value="'.$encodevideo\_info['webmurl'].'">WEBM</option>'; } |
  |  | 314 | if ( $encodevideo\_info['ogg\_exists'] ) { $replaceoptions .= '<option value="'.$encodevideo\_info['oggurl'].'">OGV</option>'; } |
  |  | 315 |  |
  |  | 316 | $altembedselect = '<span class="kg\_embedselect">Embed <select name="attachments['.$postID.'][kgflashmediaplayer-altembed]" id="attachments['.$postID.'][kgflashmediaplayer-altembed]"><option value="'.$movieurl.'">original</option>'.$replaceoptions.'</select></span>'; |
  |  | 317 |  |
  |  | 318 | //$encodevideo\_info\_map = array\_map(create\_function('$key, $value', 'return $key.":".$value." # ";'), array\_keys($encodevideo\_info), array\_values($encodevideo\_info)); |
  |  | 319 | //$encodevideo\_info\_implode = implode($encodevideo\_info\_map); |
  |  | 320 |  |
  |  | 321 | $arr = array ( "embed\_display"=>$embed\_display, "pid"=>$processPID, "logfile"=>$logfile, "movie\_duration"=>$movie\_duration\_seconds, "encode\_anything"=>$encode\_anything, "altembedselect"=>$altembedselect, "serverOS"=>$serverOS ); |
  | 263 | 322 | echo json\_encode($arr); |
  | 264 |  |  |
  |  | 323 |  |
  | 265 | 324 | }//if encode |
  | 266 | 325 |  |
  | 267 | 326 | }//if ffmpeg can open movie |
  | 268 | 327 |  |
  | 269 |  | else { $thumbnaildisplaycode = '<strong>Can\'t open movie file.</strong>~~' ;~~ |
  | 270 |  | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode ); |
  |  | 328 | else { $thumbnaildisplaycode = '<strong>Can\'t open movie file.</strong><br />'.$movie\_info['output']; |
  |  | 329 | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode, "embed\_display"=>$thumbnaildisplaycode, "lastthumbnumber"=>"break" ); |
  | 271 | 330 | echo json\_encode($arr); |
  | 272 | 331 | } //can't open movie |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L275) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L334) |  |
  | 275 | 334 |  |
  | 276 | 335 | else { $thumbnaildisplaycode = '<strong>Error: FFMPEG not found. Verify that FFMPEG is installed and check the <a href="options-general.php?page=video-embed-thumbnail-generator.php">path to FFMPEG plugin setting</a>.</strong>' ; |
  | 277 |  | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode ); |
  |  | 336 | $arr = array ( "thumbnaildisplaycode"=>$thumbnaildisplaycode, "embed\_display"=>$thumbnaildisplaycode, "lastthumbnumber"=>"break" ); |
  | 278 | 337 | echo json\_encode($arr); |
  | 279 | 338 | } //no ffmpeg |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L282) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L341) |  |
  | 282 | 341 | }// if encoding or generating |
  | 283 | 342 |  |
  | 284 |  | if ($action == ~~delete~~) { |
  |  | 343 | if ($action == "delete") { |
  | 285 | 344 |  |
  | 286 | 345 | if ($poster) { |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L297) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L356) |  |
  | 297 | 356 |  |
  | 298 | 357 |  |
  | 299 |  | if ($action == ~~submit~~) { |
  |  | 358 | if ($action == "submit") { |
  | 300 | 359 |  |
  | 301 | 360 | $posterfile = pathinfo($poster, PATHINFO\_BASENAME); |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=486697#L309) | […](/browser/video-embed-thumbnail-generator/trunk/kg_callffmpeg.php?rev=507924#L368) |  |
  | 309 | 368 | } |
  | 310 | 369 | } |
  | 311 |  | if ( is\_dir($uploads['path'].'/thumb\_tmp') && ($files = @scandir($uploads['path'].'/thumb\_tmp') && (count($files) < 2)) ) { rmdir($uploads['path'].'/thumb\_tmp'); } |
  |  | 370 |  |
  |  | 371 | if ( is\_empty\_dir($uploads["path"].'/thumb\_tmp') ) { rrmdir($uploads["path"].'/thumb\_tmp'); } |
  | 312 | 372 | } |
  | 313 | 373 |  |
* ## [video-embed-thumbnail-generator/trunk/kg\_video\_plugin.js](/changeset/507924/video-embed-thumbnail-generator/trunk/kg_video_plugin.js "Show the changeset 507924 restricted to video-embed-thumbnail-generator/trunk/kg_video_plugin.js")

  | [r486697](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=486697#L14 "Show revision 486697 of this file in browser") | [r507924](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=507924#L14 "Show revision 507924 of this file in browser") |  |
  | --- | --- | --- |
  | 14 | 14 |  |
  | 15 | 15 | function kg\_set\_aspect(postID, checked) { |
  | 16 |  | if (checked) { document.getElementById('attachments['+postID+'][kgflashmediaplayer-aspect]').value = document.getElementById('attachments\_'+postID+'\_kgflashmediaplayer-height').value / document.getElementById('attachments\_'+postID+'\_kgflashmediaplayer-width').value; } |
  |  | 16 | if (checked) { document.getElementById('attachments['+postID+'][kgflashmediaplayer-aspect]').value = document.getElementById('attachments\_'+postID+'\_kgflashmediaplayer-height').value / document.getElementById('attachments\_'+postID+'\_kgflashmediaplayer-width').value; |
  |  | 17 | } |
  | 17 | 18 | } |
  | 18 | 19 |  |
  | 19 | 20 | function kg\_generate\_thumb(postID, buttonPushed) { |
  | 20 | 21 |  |
  | 21 |  | var kg~~\_ffmpeg\_path = document.getElementById('attachments['+postID+'][kgflashmediaplayer-ffmpeg\_path~~]').value; |
  |  | 22 | var kgflashmediaplayersecurity = document.getElementById('attachments['+postID+'][kgflashmediaplayer-security]').value; |
  | 22 | 23 | var kg\_encodemobile = document.getElementById('attachments['+postID+'][kgflashmediaplayer-encodemobile]').value; |
  | 23 | 24 | var kg\_encodeogg = document.getElementById('attachments['+postID+'][kgflashmediaplayer-encodeogg]').value; |
  | 24 | 25 | var kg\_encodewebm = document.getElementById('attachments['+postID+'][kgflashmediaplayer-encodewebm]').value; |
  | 25 |  | ~~var kg\_plugin\_dir = document.getElementById('attachments['+postID+'][kgflashmediaplayer-plugin\_dir]').value;~~ |
  | 26 |  | ~~var kg\_upload\_dir\_url = document.getElementById('attachments['+postID+'][kgflashmediaplayer-upload\_url]').value;~~ |
  | 27 |  | ~~var kg\_upload\_dir\_path = document.getElementById('attachments['+postID+'][kgflashmediaplayer-upload\_path]').value;~~ |
  | 28 |  | ~~var kg\_upload\_dir\_basedir = document.getElementById('attachments['+postID+'][kgflashmediaplayer-upload\_basedir]').value;~~ |
  | 29 | 26 | var attachmentURL = document.getElementById('attachments['+postID+'][kgflashmediaplayer-url]').value; |
  | 30 | 27 | var howmanythumbs = document.getElementById('attachments\_'+postID+'\_numberofthumbs').value; |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=486697#L35) | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=507924#L32) |  |
  | 35 | 32 | var thumbnailplaceholderid = "#attachments\_"+postID+"\_thumbnailplaceholder"; |
  | 36 | 33 | var encodeplaceholderid = "#attachments\_"+postID+"\_encodeplaceholder"; |
  |  | 34 | var encodeprogressplaceholderid = "#attachments\_"+postID+"\_encodeprogressplaceholder"; |
  |  | 35 | var altembedselectid = "#attachments\_"+postID+"\_altembedselect"; |
  |  | 36 | var thumbnailboxID = "#attachments\_"+postID+"\_kgflashmediaplayer-thumbnailbox"; |
  |  | 37 | var thumbnailboxoverlayID = "#attachments\_"+postID+"\_kgflashmediaplayer-thumbnailboxoverlay"; |
  | 37 | 38 | var widthID = 'attachments\_'+postID+'\_kgflashmediaplayer-width'; |
  | 38 | 39 | var heightID = 'attachments\_'+postID+'\_kgflashmediaplayer-height'; |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=486697#L42) | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=507924#L43) |  |
  | 42 | 43 | var maxheightID = 'attachments['+postID+'][kgflashmediaplayer-maxheight]'; |
  | 43 | 44 |  |
  | 44 |  |  |
  | 45 |  | ~~if (buttonPushed == "generate" || buttonPushed == "random" ) { actionName = "generate"; }~~ |
  | 46 |  | ~~else { actionName = buttonPushed~~; } |
  | 47 |  |  |
  | 48 |  | ~~if (buttonPushed == "delete")~~ { |
  | 49 |  | ~~document.getElementById('attachments['+postID+'][kgflashmediaplayer-poster]').value = ""~~; |
  | 50 |  | ~~document.getElementById('attachments['+postID+'][thumbtime]').value = ""~~; |
  |  | 45 | if (buttonPushed == "generate" || buttonPushed == "random" ) { |
  |  | 46 | actionName = "generate"; |
  |  | 47 | if (specifictimecode != 0 ) { howmanythumbs = 1; } |
  |  | 48 | } |
  |  | 49 | else { |
  |  | 50 | actionName = buttonPushed; |
  |  | 51 | howmanythumbs = 1; |
  | 51 | 52 | } |
  | 52 | 53 |  |
  | 53 | 54 | if (buttonPushed != "encode") { |
  | 54 | 55 | jQuery(thumbnailplaceholderid).empty(); |
  | 55 |  | jQuery(thumbnailplaceholderid).append('<~~strong>Loading...</strong~~>'); |
  |  | 56 | jQuery(thumbnailplaceholderid).append('<p><strong>Choose Thumbnail:</strong></p><div id="attachments\_'+postID+'\_kgflashmediaplayer-thumbnailboxoverlay" name="attachments\_'+postID+'\_kgflashmediaplayer-thumbnailboxoverlay" class="kg\_thumbnail\_overlay"><div id="attachments\_'+postID+'\_kgflashmediaplayer-ajaxloading" name="attachments\_'+postID+'\_kgflashmediaplayer-ajaxloading" class="kg\_ajax\_loading"></div><div name="attachments\_'+postID+'\_kgflashmediaplayer-thumbnailbox" id="attachments\_'+postID+'\_kgflashmediaplayer-thumbnailbox" class="kg\_thumbnail\_box"></div></div>'); |
  | 56 | 57 | } |
  | 57 | 58 |  |
  | 58 | 59 | if (buttonPushed == "encode") { |
  | 59 | 60 | jQuery(encodeplaceholderid).empty(); |
  | 60 |  | } |
  | 61 |  |  |
  | 62 |  | jQuery.post(kg\_plugin\_dir + '/kg\_callffmpeg.php', { movieurl: attachmentURL, numberofthumbs: howmanythumbs, action: actionName, ffmpeg: kg\_ffmpeg\_path, encodemobile: kg\_encodemobile, encodeogg: kg\_encodeogg, encodewebm: kg\_encodewebm, uploads\_path: kg\_upload\_dir\_path, uploads\_url: kg\_upload\_dir\_url, uploads\_basedir: kg\_upload\_dir\_basedir, attachmentID: postID, generate\_button: buttonPushed, thumbtimecode: specifictimecode, dofirstframe: firstframethumb, poster: posterurl }, function(data) { |
  | 63 |  |  |
  | 64 |  | if (buttonPushed != "encode") { |
  | 65 |  | jQuery(thumbnailplaceholderid).empty(); |
  | 66 |  | jQuery(thumbnailplaceholderid).append(data.thumbnaildisplaycode); |
  | 67 |  | } |
  | 68 |  |  |
  | 69 |  | if (actionName == "generate") { |
  | 70 |  | kg\_aspect = data.movie\_height/data.movie\_width; |
  | 71 |  | document.getElementById('attachments['+postID+'][kgflashmediaplayer-aspect]').value = kg\_aspect; |
  | 72 |  | if (parseInt(data.movie\_width) < parseInt(document.getElementById(maxwidthID).value) ) { document.getElementById(widthID).value = data.movie\_width; } |
  | 73 |  | else { document.getElementById(widthID).value = document.getElementById(maxwidthID).value; } |
  | 74 |  | if (parseInt(data.movie\_width) > parseInt(document.getElementById(maxwidthID).value) ) { document.getElementById(heightID).value = Math.round(kg\_aspect\*parseInt(document.getElementById(maxwidthID).value)); } |
  | 75 |  | else { document.getElementById(heightID).value = data.movie\_height; } |
  | 76 |  | if(postID != "singleurl") { |
  | 77 |  | document.getElementById(widthsaveID).value = document.getElementById(widthID).value; |
  | 78 |  | document.getElementById(heightsaveID).value = document.getElementById(heightID).value; |
  |  | 61 | jQuery(encodeprogressplaceholderid).empty(); |
  |  | 62 | jQuery(encodeplaceholderid).append('<strong>Encoding...</strong>'); |
  |  | 63 | } |
  |  | 64 |  |
  |  | 65 |  |
  |  | 66 | var i=1; |
  |  | 67 | var increaser = 0; |
  |  | 68 | var iincreaser = 0; |
  |  | 69 |  |
  |  | 70 | //for (i=1; i<=howmanythumbs; i++) { //loop until thumbnails are generated |
  |  | 71 |  |
  |  | 72 | function kg\_do\_post() { |
  |  | 73 |  |
  |  | 74 | iincreaser = i + increaser; |
  |  | 75 |  |
  |  | 76 | jQuery.post(ajaxurl, { action:"kg\_callffmpeg", security: kgflashmediaplayersecurity, movieurl: attachmentURL, numberofthumbs: howmanythumbs, thumbnumber:i, thumbnumberplusincreaser:iincreaser, ffmpeg\_action: actionName, encodemobile: kg\_encodemobile, encodeogg: kg\_encodeogg, encodewebm: kg\_encodewebm, attachmentID: postID, generate\_button: buttonPushed, thumbtimecode: specifictimecode, dofirstframe: firstframethumb, poster: posterurl }, function(data) { |
  |  | 77 |  |
  |  | 78 | if (buttonPushed != "encode") { |
  |  | 79 | jQuery(thumbnailboxID).append(data.thumbnaildisplaycode); |
  |  | 80 | var thumbnailselectID = "#attachments\_"+postID+"\_thumb"+i; |
  |  | 81 | jQuery(thumbnailselectID).css({display:"none"}); |
  |  | 82 | //jQuery(thumbnailselectID).fadeIn(1000); |
  |  | 83 | jQuery(thumbnailselectID).animate({opacity: 'toggle', height: 'toggle', width: 'toggle'}, 1000); |
  |  | 84 | //jQuery(thumbnailselectID).animate({display:"inline-block"}, 2000); |
  |  | 85 | if (data.lastthumbnumber != "break") { i = parseInt(data.lastthumbnumber); } |
  |  | 86 | else { i = howmanythumbs + 1; } |
  |  | 87 | increaser++; |
  |  | 88 | if ( i <= howmanythumbs ) { setTimeout(function(){kg\_do\_post()}, 1000); } |
  |  | 89 | else { jQuery(thumbnailboxoverlayID).fadeTo(2000, 1); } |
  |  | 90 |  |
  |  | 91 | kg\_aspect = data.movie\_height/data.movie\_width; |
  |  | 92 | document.getElementById('attachments['+postID+'][kgflashmediaplayer-aspect]').value = kg\_aspect; |
  |  | 93 | if (parseInt(data.movie\_width) < parseInt(document.getElementById(maxwidthID).value) ) { document.getElementById(widthID).value = data.movie\_width; } |
  |  | 94 | else { document.getElementById(widthID).value = document.getElementById(maxwidthID).value; } |
  |  | 95 | if (parseInt(data.movie\_width) > parseInt(document.getElementById(maxwidthID).value) ) { document.getElementById(heightID).value = Math.round(kg\_aspect\*parseInt(document.getElementById(maxwidthID).value)); } |
  |  | 96 | else { document.getElementById(heightID).value = data.movie\_height; } |
  |  | 97 | if(postID != "singleurl") { |
  |  | 98 | document.getElementById(widthsaveID).value = document.getElementById(widthID).value; |
  |  | 99 | document.getElementById(heightsaveID).value = document.getElementById(heightID).value; |
  |  | 100 | } |
  |  | 101 | jQuery.post( ajaxurl ,  { action:"kg\_schedule\_cleanup\_generated\_files", security:kgflashmediaplayersecurity, thumbs:"true" } ); |
  | 79 | 102 | } |
  | 80 |  | } |
  | 81 |  |  |
  | 82 |  | if (buttonPushed == "encode") { |
  | 83 |  | jQuery(encodeplaceholderid).append(data.embed\_display); |
  | 84 |  | } |
  | 85 |  |  |
  | 86 |  | }, "json"); |
  | 87 |  |  |
  | 88 |  | jQuery.post( ajaxurl ,  { action:"kg\_schedule\_cleanup\_generated\_files" } ); |
  | 89 |  |  |
  |  | 103 |  |
  |  | 104 | if (buttonPushed == "encode") { |
  |  | 105 | jQuery(encodeplaceholderid).empty(); |
  |  | 106 | jQuery(encodeprogressplaceholderid).empty(); |
  |  | 107 | jQuery(encodeplaceholderid).append(data.embed\_display); |
  |  | 108 | jQuery(altembedselectid).empty(); |
  |  | 109 | jQuery(altembedselectid).append(data.altembedselect); |
  |  | 110 | if ( data.encode\_anything == "true" ) { |
  |  | 111 | var kg\_start\_time = new Date().getTime(); |
  |  | 112 | jQuery.post( ajaxurl ,  { action:"kg\_schedule\_cleanup\_generated\_files", security:kgflashmediaplayersecurity, logfile:data.logfile } ); |
  |  | 113 | if (data.serverOS != "windows" ) { |
  |  | 114 | jQuery(encodeprogressplaceholderid).append('<div class="meter"><span style="width:0%;"></span></div>'); |
  |  | 115 | setTimeout(function(){kg\_check\_encode\_progress(postID, data.pid, data.logfile, data.movie\_duration, data.altembedselect, kg\_start\_time)}, 1000); |
  |  | 116 | } |
  |  | 117 | else { //if it's Windows skip the progress bar |
  |  | 118 | jQuery(encodeprogressplaceholderid).append('<div class="meter\_finished"><span style="width:100%;">100%</span></div>'); |
  |  | 119 | jQuery(encodeplaceholderid).empty(); |
  |  | 120 | jQuery(encodeplaceholderid).append('<strong>Encoding Complete</strong>'); |
  |  | 121 | } |
  |  | 122 | } |
  |  | 123 | } |
  |  | 124 | }, "json"); |
  |  | 125 |  |
  |  | 126 | }// end kg\_do\_post function |
  |  | 127 |  |
  |  | 128 | kg\_do\_post(); //actually call the loop |
  | 90 | 129 | } |
  | 91 | 130 |  |
  | 92 | 131 | function kg\_insert\_shortcode() { |
  | 93 | 132 |  |
  | 94 |  | jQuery.post(document.getElementById('attachments[singleurl][kgflashmediaplayer-plugin\_dir]').value + '/kg\_callffmpeg.php', { |
  | 95 |  | movieurl: document.getElementById('attachments[singleurl][kgflashmediaplayer-url]').value, action:'submit', poster: document.getElementById('attachments[singleurl][kgflashmediaplayer-poster]').value, uploads\_path: document.getElementById('attachments[singleurl][kgflashmediaplayer-upload\_path]').value }, function(data) { |
  |  | 133 | var kgflashmediaplayersecurity = document.getElementById('attachments[singleurl][kgflashmediaplayer-security]').value; |
  |  | 134 |  |
  |  | 135 | jQuery.post(ajaxurl, { action:'kg\_callffmpeg', security: kgflashmediaplayersecurity, attachmentID: 'singleurl', movieurl: document.getElementById('attachments[singleurl][kgflashmediaplayer-url]').value, ffmpeg\_action:'submit', poster: document.getElementById('attachments[singleurl][kgflashmediaplayer-poster]').value }, function(data) { |
  | 96 | 136 | jQuery('attachments\_singleurl\_thumbnailplaceholder').empty(); |
  | 97 | 137 | }, "json" ); |
  | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=486697#L109) | […](/browser/video-embed-thumbnail-generator/trunk/kg_video_plugin.js?rev=507924#L149) |  |
  | 109 | 149 | parent.send\_to\_editor(shortcode); |
  | 110 | 150 | } |
  |  | 151 |  |
  |  | 152 | function kg\_check\_encode\_progress(postID, kg\_pid, kg\_logfile, kg\_movie\_duration, kg\_altembedselect, kg\_start\_time) { |
  |  | 153 | var encodeprogressplaceholderid = "#attachments\_"+postID+"\_encodeprogressplaceholder"; |
  |  | 154 | var encodeplaceholderid = "#attachments\_"+postID+"\_encodeplaceholder"; |
  |  | 155 | var altembedselectid = "#attachments\_"+postID+"\_altembedselect"; |
  |  | 156 | var kgflashmediaplayersecurity = document.getElementById('attachments['+postID+'][kgflashmediaplayer-security]').value; |
  |  | 157 | var stopChecking = false; |
  |  | 158 |  |
  |  | 159 | jQuery.post(ajaxurl, { action:"kg\_check\_encode\_progress", security: kgflashmediaplayersecurity, pid: kg\_pid, logfile: kg\_logfile, movie\_duration: kg\_movie\_duration }, function(data) { |
  |  | 160 |  |
  |  | 161 | var display\_percent = ""; |
  |  | 162 | if ( data.percent\_done > 7 ) { display\_percent = data.percent\_done+"%"; } |
  |  | 163 |  |
  |  | 164 | var kg\_current\_time = new Date().getTime(); |
  |  | 165 | var kg\_time\_elapsed = Math.round( (kg\_current\_time - kg\_start\_time) / 1000 ); |
  |  | 166 | if ( kg\_time\_elapsed >= 60 ) { |
  |  | 167 | kg\_time\_elapsed\_minutes = Math.floor(kg\_time\_elapsed/60); |
  |  | 168 | kg\_time\_elapsed\_seconds = kg\_time\_elapsed%60; |
  |  | 169 | kg\_time\_elapsed\_seconds = (kg\_time\_elapsed\_seconds < 10) ? ("0" + kg\_time\_elapsed\_seconds) : kg\_time\_elapsed\_seconds; |
  |  | 170 | kg\_time\_elapsed\_display = kg\_time\_elapsed\_minutes+':'+kg\_time\_elapsed\_seconds; |
  |  | 171 | } |
  |  | 172 | else { kg\_time\_elapsed\_display = kg\_time\_elapsed+' seconds'; } |
  |  | 173 |  |
  |  | 174 | if ( data.percent\_done != "" && data.percent\_done != "100" ) { |
  |  | 175 | var kg\_time\_remaining = Math.floor( (kg\_time\_elapsed / (data.percent\_done/100) ) - kg\_time\_elapsed); |
  |  | 176 | if ( kg\_time\_remaining >= 60 ) { |
  |  | 177 | kg\_time\_remaining\_minutes = Math.round(kg\_time\_remaining/60); |
  |  | 178 | kg\_time\_remaining\_seconds = kg\_time\_remaining%60; |
  |  | 179 | kg\_time\_remaining\_seconds = (kg\_time\_remaining\_seconds < 10) ? ("0" + kg\_time\_remaining\_seconds) : kg\_time\_remaining\_seconds; |
  |  | 180 | kg\_time\_remaining\_display = kg\_time\_remaining\_minutes+':'+kg\_time\_remaining\_seconds; |
  |  | 181 | } |
  |  | 182 | else { kg\_time\_remaining\_display = kg\_time\_remaining+' seconds'; } |
  |  | 183 | jQuery(encodeprogressplaceholderid).empty(); |
  |  | 184 | jQuery(encodeprogressplaceholderid).append('<div class="meter"><span style="width:'+data.percent\_done+'%;">'+display\_percent+'</span></div><div class="kg\_cancel\_button"><input type="button" id="attachments\_'+postID+'\_kgflashmediaplayer-cancelencode" class="button-secondary" value="Cancel" name="attachments\_'+postID+'\_cancelencode" onclick="kg\_cancel\_encode('+kg\_pid+', \''+postID+'\');"></div><div style="display:block;"><small>Elapsed: '+kg\_time\_elapsed\_display+'. Estimated Remaining: '+kg\_time\_remaining\_display+'. FPS:'+data.fps+'</small></div>'); |
  |  | 185 | } |
  |  | 186 |  |
  |  | 187 | if (data.other\_message != "") { |
  |  | 188 | clearTimeout(percent\_timeout); |
  |  | 189 | stopChecking = true; |
  |  | 190 | jQuery(encodeplaceholderid).empty(); |
  |  | 191 | jQuery(encodeplaceholderid).append('<strong>Encoding Halted</strong>'); |
  |  | 192 | jQuery(encodeprogressplaceholderid).empty(); |
  |  | 193 | jQuery(encodeprogressplaceholderid).append('<strong><span style="color:red;">Message from FFMPEG: '+data.other\_message+'</span></strong>'); |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 | if ( data.percent\_done == "100" ) { |
  |  | 197 | clearTimeout(percent\_timeout); |
  |  | 198 | stopChecking = true; |
  |  | 199 | //delete window.kg\_start\_time\_over; |
  |  | 200 | jQuery(encodeprogressplaceholderid).empty(); |
  |  | 201 | jQuery(encodeprogressplaceholderid).append('<div class="meter\_finished"><span style="width:100%;">100%</span></div><div style="display:block;"><small>Elapsed: '+kg\_time\_elapsed+' seconds. Estimated Remaining: 0 seconds.</small></div>'); |
  |  | 202 | jQuery(encodeplaceholderid).empty(); |
  |  | 203 | jQuery(encodeplaceholderid).append('<strong>Encoding Complete</strong>'); |
  |  | 204 | } |
  |  | 205 | //jQuery(encodeplaceholderid).empty(); |
  |  | 206 | //jQuery(encodeplaceholderid).append(data.embed\_display); |
  |  | 207 |  |
  |  | 208 | if ( data.fps !== "" ) { |
  |  | 209 | var kg\_timetowait = Math.round(30000/parseInt(data.fps)); |
  |  | 210 | if (kg\_timetowait < 1000) { kg\_timetowait = 1000; } |
  |  | 211 | } |
  |  | 212 | else { var kg\_timetowait = 2000; } |
  |  | 213 |  |
  |  | 214 | if ( stopChecking != true ) { |
  |  | 215 | percent\_timeout = setTimeout(function(){kg\_check\_encode\_progress(postID, kg\_pid, kg\_logfile, kg\_movie\_duration, kg\_altembedselect, kg\_start\_time)}, kg\_timetowait); |
  |  | 216 | } |
  |  | 217 |  |
  |  | 218 | }, "json" ); |
  |  | 219 | } |
  |  | 220 |  |
  |  | 221 | function kg\_cancel\_encode(kg\_pid, postID) { |
  |  | 222 |  |
  |  | 223 | var kgflashmediaplayersecurity = document.getElementById('attachments['+postID+'][kgflashmediaplayer-security]').value; |
  |  | 224 | var cancelbuttonID = 'attachments\_'+postID+'\_kgflashmediaplayer-cancelencode'; |
  |  | 225 |  |
  |  | 226 | document.getElementById(cancelbuttonID).disabled = true; |
  |  | 227 | document.getElementById(cancelbuttonID).title = "Command sent. Be patient"; |
  |  | 228 |  |
  |  | 229 | jQuery.post(ajaxurl, { action:"kg\_cancel\_encode", security: kgflashmediaplayersecurity, kg\_pid: kg\_pid } ); |
  |  | 230 |  |
  |  | 231 | } |
* ## [video-embed-thumbnail-generator/trunk/readme.txt](/changeset/507924/video-embed-thumbnail-generator/trunk/readme.txt "Show the changeset 507924 restricted to video-embed-thumbnail-generator/trunk/readme.txt")

  | [r486730](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L1 "Show revision 486730 of this file in browser") | [r507924](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L1 "Show revision 507924 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | === ~~Plugin Name~~ === |
  |  | 1 | === Video Embed & Thumbnail Generator === |
  | 2 | 2 | Contributors: kylegilman |
  | 3 |  | Tags: video, html5, shortcode, thumbnail, ffmpeg |
  |  | 3 | Donate link: https://www.paypal.com/cgi-bin/webscr?cmd=\_donations&business=kylegilman@gmail.com&item\_name=Video%20Embed%20And%20Thumbnail%20Generator%20Plugin%20Donation/ |
  |  | 4 | Tags: video, html5, shortcode, thumbnail, ffmpeg, embed, mobile, webm, ogg, h.264 |
  | 4 | 5 | Requires at least: 3.0 |
  | 5 | 6 | Tested up to: 3.3.1 |
  | 6 |  | Stable tag: ~~1.1~~ |
  |  | 7 | Stable tag: 2.0 |
  | 7 | 8 |  |
  | 8 | 9 | Generates thumbnails, HTML5-compliant videos, and embed codes for locally hosted videos. Requires FFMPEG for thumbnails and encodes. |
  | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L16) | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L17) |  |
  | 16 | 17 | The embedded player will default to a Flash video player if you're using a Flash-compatible file (flv, f4v, mp4, mov, or m4v). Otherwise it will use an HTML5 video element. I highly recommend H.264 video and AAC audio in an MP4 container. If you're encoding with Apple's Compressor, the "Streaming" setting should be "Fast Start" (NOT Fast Start - Compressed Header). I've written up my recommended video encode settings in <a href="http://www.kylegilman.net/2011/02/25/making-mp4-h-264-videos-in-apple-compressor/">a post on my website</a>. |
  | 17 | 18 |  |
  | 18 |  | The plugin uses FFMPEG to generate thumbnails and encode HTML5/mobile videos. By default the plugin looks for FFMPEG in `/usr/local/bin` but if FFMPEG is installed in a different place on your server, you can point it to the correct place in the plugin settings. |
  |  | 19 | The plugin uses FFMPEG to generate thumbnails and encode HTML5/mobile videos. By default the plugin looks for FFMPEG in `/usr/local/bin` but if FFMPEG is installed in a different place on your server, you can point it to the correct place in the plugin settings. Users running WordPress on Windows servers should try using Linux-style paths (with forward slashes instead of backslashes and a forward slash instead of C:\) |
  | 19 | 20 |  |
  | 20 | 21 | If FFMPEG is installed on your server, you can generate thumbnails using either the "Generate" or "Randomize" buttons. The "Generate" button will always generate thumbnails from the same frames of your video, evenly spaced. If you don't like them you can randomize the results with the "Randomize" button. If you want to see the first frame of the video, check the "Force 1st Frame Thumbnail" button. If you want really fine control you can enter timecode in the "Thumbnail Timecode" field. Use mm:ss format. If you want even more control you can use decimals to approximate frames. For example, `23.5` will generate a thumbnail halfway between the 23rd and 24th seconds in the video. `02:23.25` would be one quarter of the way between the 143rd and 144th seconds. You can generate as many or as few as you need (up to 9 at a time). The unused thumbnails will be deleted once you click "Insert into Post" or "Save Changes." |
  | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L22) | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L23) |  |
  | 22 | 23 | In the plugin settings you can set the default maximum width based on the width of your particular template and those values will be filled in when you open the window. If you generate thumbnails, the video display dimensions will be automatically adjusted to match the size and aspect ratio of the video file. You can make further adjustments if you want. |
  | 23 | 24 |  |
  | 24 |  | The "Encode" button is still a bit experimental. If you have FFMPEG on your server, clicking the button will start encoding an iPod/iPad/Android compliant H.264 video (which will also work in Safari and IE 9), or a Firefox/Chrome-compatible WEBM or OGV video in the same directory as your original file. Anyone using a modern browser who doesn't have a Flash plugin will see these files instead of the original. The files will encode in the background and will take several minutes to complete, depending on your server setup and the length and size of your video. Currently, if something goes wrong after the encode starts, the plugin will not tell you. It also won't tell you when the files are done. You just have to wait. |
  |  | 25 | The "Encode" button is still a bit experimental. If you have FFMPEG on your server, clicking the button will start encoding an iPod/iPad/Android compliant H.264 video (which will also work in Safari and IE 9), or a Firefox/Chrome-compatible WEBM or OGV video in the same directory as your original file. Anyone using a modern browser who doesn't have a Flash plugin will see these files instead of the original. The files will encode in the background and will take several minutes to complete, depending on your server setup and the length and size of your video. New in version 2.0, you will see the encoding progress, you will have the option to cancel an encoding job, and you should get an error message if something goes wrong. Closing the window will not cancel encoding, but once the window is closed the progress bar won't come back. Users on Windows servers will not get any feedback while the files are encoding. |
  |  | 26 |  |
  |  | 27 | Also new in this version is the option to encode an HD Mobile/H.264 file. Since there are more devices that can handle HD H.264 videos available now, you can choose to increase the resolution to 720p or 1080p. Keep in mind, very few mobile devices can currently play 1080p video. |
  | 25 | 28 |  |
  | 26 | 29 | The plugin is currently favoring Flash instead of HTML5 because Flash is a better user experience in most cases. I'm particularly not a fan of some browsers' tendencies to auto-download HTML5 video elements. I may eventually include the option to favor HTML5. However, if you embed a non-Flash compatible file (like an ogv or webm file) then you will only get the HTML5 video element. If you want to make ogv, webm, or H.264 files available and can't use the FFMPEG encode button, you can upload your own files to the same directory as the original and the plugin will automatically find them. For example, if your main file is awesomevid.mp4, the plugin will look for awesomevid.webm and awesomevid.ogv as well. If you want to embed a high-res H.264 video but also make a mobile-compatible version available, add -ipod.m4v to the end of the filename (awesomevid-ipod.m4v) and it will be served up to most smartphones and tablets instead of the original. |
  | 27 | 30 |  |
  | 28 | 31 | Android viewers who don't use Flash will see a play button superimposed on the thumbnail to make it a little clearer that it's an embedded video. |
  |  | 32 |  |
  |  | 33 | If you have Mobile, WEBM, or OGV files encoded, you will have the option to embed one of those files instead of the original. This is for a small group of users who need to upload a file format that can't be embedded and want to replace that file with a newly encoded file. No matter which option you choose, any other encoded files will still be automatically swapped in on the appropriate devices and browsers. |
  | 29 | 34 |  |
  | 30 | 35 | If you want to make it easier for people to save the video to their computers, you can choose to include a link by checking the "Generate Download Link Below Video" button. |
  | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L37) | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L42) |  |
  | 37 | 42 | width="720" height="404"]http://www.kylegilman.net/wp-content/uploads/2011/10/Reel-11-10-10-web.mp4[/FMP]` |
  | 38 | 43 |  |
  | 39 |  | ~~Once you save the post, the thumbnail file will be registered in the Wordpress Media Library and added to the post's attachments. Thumbnails are saved in the current Wordpress uploads directory. HTML5~~ videos are not yet registered with the media library. |
  |  | 44 | After you save the post, the thumbnail file will be registered in the Wordpress Media Library and added to the post's attachments. Thumbnails are saved in the current Wordpress uploads directory. Encoded videos are not yet registered with the media library. |
  | 40 | 45 |  |
  | 41 | 46 | = If you want to further modify the way the Flash video player works, you can add the following options inside the [FMP] tag. These will override anything you’ve set in the plugin settings. = |
  | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L84) | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L89) |  |
  | 84 | 89 | Some of it will work without FFMPEG. You can generate embed codes for your videos on any host because that part of the plugin is JavaScript running in your browser. But without FFMPEG you won't be able to generate thumbnails or generate HTML5 videos. There is no way around this. A program has to read the video files in order to generate the thumbnails, and FFMPEG is the best one I've found to do that. |
  | 85 | 90 |  |
  |  | 91 | = Why doesn't the encoding progress bar work on Windows? = |
  |  | 92 |  |
  |  | 93 | Because I can't figure out how to do it. Windows works a little differently from Linux, and I don't understand it enough to get it to work. |
  |  | 94 |  |
  | 86 | 95 | == Screenshots == |
  | 87 | 96 |  |
  | 88 | 97 | 1. Thumbnail & Embed Options in the Media Library/Insert Video page. |
  | 89 |  | 2. "Embed from Url" tab. |
  | 90 |  | 3. Shortcode inserted into the post content by the plugin. |
  |  | 98 | 2. Encoding in progress. |
  |  | 99 | 3. "Embed from Url" tab. |
  |  | 100 | 4. Shortcode inserted into the post content by the plugin. |
  | 91 | 101 |  |
  | 92 | 102 | == Changelog == |
  |  | 103 |  |
  |  | 104 | = 2.0 - February 20, 2012= |
  |  | 105 | \* Large rewrite to fix several security issues. Full server paths are no longer exposed in the Media Upload form, all AJAX calls are handled through wp\_ajax, and nonces are checked. |
  |  | 106 | \* Video encoding shows progress bar on Linux servers. |
  |  | 107 | \* Ability to cancel encoding added. |
  |  | 108 | \* Option to encode 720p or 1080p H.264 videos. |
  |  | 109 | \* Videos recorded on phones in portrait mode (tall and skinny) will not end up sideways if FFMPEG version .10 or later is installed. |
  |  | 110 | \* Thumbnail generation process uses fancy jQuery animation. |
  |  | 111 | \* Better check for FFMPEG. Should actually work in Windows now. |
  | 93 | 112 |  |
  | 94 | 113 | = 1.1 - January 8, 2012 = |
  | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=486730#L128) | […](/browser/video-embed-thumbnail-generator/trunk/readme.txt?rev=507924#L147) |  |
  | 128 | 147 | = 0.2 - January 18, 2011 = |
  | 129 | 148 | \* First Release |
  |  | 149 |  |
  |  | 150 | == Upgrade Notice == |
  |  | 151 |  |
  |  | 152 | = 2.0 = Fixes several security issues. |
* ## [video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php](/changeset/507924/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php "Show the changeset 507924 restricted to video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php")

  | [r486697](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L3 "Show revision 486697 of this file in browser") | [r507924](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L3 "Show revision 507924 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Plugin Name: Video Embed & Thumbnail Generator |
  | 4 | 4 | Plugin URI: http://www.kylegilman.net/2011/01/18/video-embed-thumbnail-generator-wordpress-plugin/ |
  | 5 |  | Description: Generate~~video thumbnails, HTML5-compliant videos, and video embed shortcodes. Some functions require FFMPEG.~~ |
  | 6 |  | Version: ~~1.1~~ |
  |  | 5 | Description: Generates thumbnails, HTML5-compliant videos, and embed codes for locally hosted videos. Requires FFMPEG for thumbnails and encodes. <a href="options-general.php?page=video-embed-thumbnail-generator.php">Settings</a> | <a href="https://www.paypal.com/cgi-bin/webscr?cmd=\_donations&business=kylegilman@gmail.com&item\_name=Video%20Embed%20And%20Thumbnail%20Generator%20Plugin%20Donation/">Donate</a> |
  |  | 6 | Version: 2.0 |
  | 7 | 7 | Author: Kyle Gilman |
  | 8 | 8 | Author URI: http://www.kylegilman.net/ |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L58) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L58) |  |
  | 58 | 58 | } |
  | 59 | 59 |  |
  |  | 60 | function is\_empty\_dir($dir) |
  |  | 61 | { |
  |  | 62 | if ($dh = @opendir($dir)) |
  |  | 63 | { |
  |  | 64 | while ($file = readdir($dh)) |
  |  | 65 | { |
  |  | 66 | if ($file != '.' && $file != '..') { |
  |  | 67 | closedir($dh); |
  |  | 68 | return false; |
  |  | 69 | } |
  |  | 70 | } |
  |  | 71 | closedir($dh); |
  |  | 72 | return true; |
  |  | 73 | } |
  |  | 74 | else return false; // whatever the reason is : no such dir, not a dir, not readable |
  |  | 75 | } |
  |  | 76 |  |
  |  | 77 | function kg\_explodeX($delimiters,$string) |
  |  | 78 | { |
  |  | 79 | $return\_array = Array($string); // The array to return |
  |  | 80 | $d\_count = 0; |
  |  | 81 | while (isset($delimiters[$d\_count])) // Loop to loop through all delimiters |
  |  | 82 | { |
  |  | 83 | $new\_return\_array = Array(); |
  |  | 84 | foreach($return\_array as $el\_to\_split) // Explode all returned elements by the next delimiter |
  |  | 85 | { |
  |  | 86 | $put\_in\_new\_return\_array = explode($delimiters[$d\_count],$el\_to\_split); |
  |  | 87 | foreach($put\_in\_new\_return\_array as $substr) // Put all the exploded elements in array to return |
  |  | 88 | { |
  |  | 89 | $new\_return\_array[] = $substr; |
  |  | 90 | } |
  |  | 91 | } |
  |  | 92 | $return\_array = $new\_return\_array; // Replace the previous return array by the next version |
  |  | 93 | $d\_count++; |
  |  | 94 | } |
  |  | 95 | return $return\_array; // Return the exploded elements |
  |  | 96 | } |
  | 60 | 97 |  |
  | 61 | 98 | function rrmdir($dir) { |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L72) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L109) |  |
  | 72 | 109 | } |
  | 73 | 110 |  |
  |  | 111 | function kg\_check\_ffmpeg\_exists() { |
  |  | 112 |  |
  |  | 113 | $exec\_enabled = false; |
  |  | 114 | $ffmpeg\_exists = false; |
  |  | 115 | $output = array(); |
  |  | 116 |  |
  |  | 117 | if(function\_exists('exec')) { |
  |  | 118 | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg 2>&1', $output, $returnvalue); |
  |  | 119 | $exec\_enabled = true; |
  |  | 120 | } //attempt to execute FFMPEG |
  |  | 121 |  |
  |  | 122 | if ( $exec\_enabled == true && strpos(end($output), 'even better') != false ) { //if FFMPEG executed |
  |  | 123 | update\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  |  | 124 | $ffmpeg\_exists = true; |
  |  | 125 | } |
  |  | 126 | else {  update\_option('wp\_FMP\_ffmpeg\_exists', "notinstalled"); } |
  |  | 127 |  |
  |  | 128 | $output\_output = implode("/n", $output); |
  |  | 129 |  |
  |  | 130 | $arr = array ("exec\_enabled"=>$exec\_enabled, "ffmpeg\_exists"=>$ffmpeg\_exists, "return\_value"=>$returnvalue, "output"=>$output\_output); |
  |  | 131 |  |
  |  | 132 | return $arr; |
  |  | 133 | } |
  |  | 134 |  |
  |  | 135 | function kg\_encodevideo\_info($movieurl, $postID) { |
  |  | 136 |  |
  |  | 137 | $uploads = wp\_upload\_dir(); |
  |  | 138 | $movie\_extension = pathinfo(parse\_url($movieurl, PHP\_URL\_PATH), PATHINFO\_EXTENSION); |
  |  | 139 | $encodevideo\_info['moviefilebasename'] = basename($movieurl,'.'.$movie\_extension); |
  |  | 140 | $moviefilepath = str\_replace(" ", "%20", $movieurl); |
  |  | 141 |  |
  |  | 142 | if ($postID != "singleurl") { //if it's an attachment, not from URL |
  |  | 143 | $moviefile = get\_attached\_file($postID); |
  |  | 144 | $path\_parts = pathinfo($moviefile); |
  |  | 145 | $encodevideo\_info['encodepath'] = $path\_parts['dirname']."/"; |
  |  | 146 | $encodevideo\_info['sameserver'] = true; |
  |  | 147 | } |
  |  | 148 | else { |
  |  | 149 | $url\_parts = parse\_url($uploads['url']); |
  |  | 150 | if ( strpos($moviefilepath, $url\_parts['host']) != "" ) { //if we're on the same server |
  |  | 151 | $encodevideo\_info['sameserver'] = true; |
  |  | 152 | $filename = urldecode($moviefilepath); |
  |  | 153 | $parsed\_url= parse\_url($filename); |
  |  | 154 | $fileinfo = pathinfo($filename); |
  |  | 155 | $parsed\_url['extension'] = $fileinfo['extension']; |
  |  | 156 | $parsed\_url['filename'] = $fileinfo['basename']; |
  |  | 157 | $parsed\_url['localpath'] = $\_SERVER['DOCUMENT\_ROOT'].$parsed\_url['path']; |
  |  | 158 | // just in case there is a double slash created when joining document\_root and path |
  |  | 159 | $parsed\_url['localpath'] = preg\_replace('/\/\//', '/', $parsed\_url['localpath']); |
  |  | 160 |  |
  |  | 161 | $encodevideo\_info['encodepath'] = rtrim($parsed\_url['localpath'], $parsed\_url['filename']); |
  |  | 162 | } |
  |  | 163 | else { |
  |  | 164 | $encodevideo\_info['sameserver'] = false; |
  |  | 165 | $encodevideo\_info['encodepath'] = $uploads['basedir']."/html5encodes/"; |
  |  | 166 | } |
  |  | 167 | } |
  |  | 168 |  |
  |  | 169 | $movieurl\_noextension = preg\_replace("/\\.[^.\\s]{3,4}$/", "", $movieurl); |
  |  | 170 | $encodevideo\_info['mobileurl'] = $movieurl\_noextension."-ipod.m4v"; |
  |  | 171 | $encodevideo\_info['oggurl'] = $movieurl\_noextension.".ogv"; |
  |  | 172 | $encodevideo\_info['webmurl'] = $movieurl\_noextension.".webm"; |
  |  | 173 |  |
  |  | 174 | if ( !is\_writable($encodevideo\_info['encodepath']) ) { //if the original directory is not writable use a directory in base wp\_upload |
  |  | 175 | $encodevideo\_info['encodepath'] = $uploads['basedir']."/html5encodes/"; |
  |  | 176 | $encodevideo\_info['html5encodes'] = true; |
  |  | 177 | $encodevideo\_info['mobileurl'] = $uploads['baseurl']."/html5encodes/".$encodevideo\_info['moviefilebasename']."-ipod.m4v"; |
  |  | 178 | $encodevideo\_info['oggurl'] = $uploads['baseurl']."/html5encodes/".$encodevideo\_info['moviefilebasename'].".ogv"; |
  |  | 179 | $encodevideo\_info['webmurl'] = $uploads['baseurl']."/html5encodes/".$encodevideo\_info['moviefilebasename'].".webm"; |
  |  | 180 | } |
  |  | 181 |  |
  |  | 182 | $encodevideo\_info['mobilefilepath'] = $encodevideo\_info['encodepath'].$encodevideo\_info['moviefilebasename']."-ipod.m4v"; |
  |  | 183 | $encodevideo\_info['oggfilepath'] = $encodevideo\_info['encodepath'].$encodevideo\_info['moviefilebasename'].".ogv"; |
  |  | 184 | $encodevideo\_info['webmfilepath'] = $encodevideo\_info['encodepath'].$encodevideo\_info['moviefilebasename'].".webm"; |
  |  | 185 |  |
  |  | 186 | $encodevideo\_info['mobilefilepath\_html5encodes'] = $uploads['basedir']."/html5encodes/".$encodevideo\_info['moviefilebasename']."-ipod.m4v"; |
  |  | 187 | $encodevideo\_info['oggfilepath\_html5encodes'] = $uploads['basedir']."/html5encodes/".$encodevideo\_info['moviefilebasename'].".ogv"; |
  |  | 188 | $encodevideo\_info['webmfilepath\_html5encodes'] = $uploads['basedir']."/html5encodes/".$encodevideo\_info['moviefilebasename'].".webm"; |
  |  | 189 |  |
  |  | 190 | if ( file\_exists($encodevideo\_info['mobilefilepath']) ) { $encodevideo\_info['mobile\_exists'] = true; } |
  |  | 191 | else { |
  |  | 192 | if ( file\_exists($encodevideo\_info['mobilefilepath\_html5encodes']) ) { |
  |  | 193 | $encodevideo\_info['mobilefilepath'] = $encodevideo\_info['mobilefilepath\_html5encodes']; |
  |  | 194 | $encodevideo\_info['mobile\_exists'] = true; |
  |  | 195 | } |
  |  | 196 | else { $encodevideo\_info['mobile\_exists'] = false; } |
  |  | 197 | } |
  |  | 198 | if ( file\_exists($encodevideo\_info['oggfilepath']) ) { $encodevideo\_info['ogg\_exists'] = true; } |
  |  | 199 | else { |
  |  | 200 | if ( file\_exists($encodevideo\_info['oggfilepath\_html5encodes']) ) { |
  |  | 201 | $encodevideo\_info['oggfilepath'] = $encodevideo\_info['oggfilepath\_html5encodes']; |
  |  | 202 | $encodevideo\_info['ogg\_exists'] = true; |
  |  | 203 | } |
  |  | 204 | else { $encodevideo\_info['ogg\_exists'] = false; } |
  |  | 205 | } |
  |  | 206 | if ( file\_exists($encodevideo\_info['webmfilepath']) ) { $encodevideo\_info['webm\_exists'] = true; } |
  |  | 207 | else { |
  |  | 208 | if ( file\_exists($encodevideo\_info['webmfilepath\_html5encodes']) ) { |
  |  | 209 | $encodevideo\_info['webmfilepath'] = $encodevideo\_info['webmfilepath\_html5encodes']; |
  |  | 210 | $encodevideo\_info['webm\_exists'] = true; |
  |  | 211 | } |
  |  | 212 | else { $encodevideo\_info['webm\_exists'] = false; } |
  |  | 213 | } |
  |  | 214 |  |
  |  | 215 | if ( !$encodevideo\_info['sameserver'] ) { //last resort if it's not on the same server, check url\_exists |
  |  | 216 | if ( !file\_exists($encodevideo\_info['mobilefilepath']) ) { |
  |  | 217 | if ( url\_exists($movieurl\_noextension."-ipod.m4v") ) { |
  |  | 218 | $encodevideo\_info['mobile\_exists'] = true; |
  |  | 219 | $encodevideo\_info['mobileurl'] = $movieurl\_noextension."-ipod.m4v"; ; |
  |  | 220 | } |
  |  | 221 | else { $encodevideo\_info['mobile\_exists'] = false; } |
  |  | 222 | } |
  |  | 223 | if ( !file\_exists($encodevideo\_info['oggfilepath']) ) { |
  |  | 224 | if ( url\_exists($movieurl\_noextension.".ogv") ) { |
  |  | 225 | $encodevideo\_info['ogg\_exists'] = true; |
  |  | 226 | $encodevideo\_info['oggurl'] = $movieurl\_noextension.".ogv"; ; |
  |  | 227 | } |
  |  | 228 | else { $encodevideo\_info['ogg\_exists'] = false; } |
  |  | 229 | } |
  |  | 230 | if ( !file\_exists($encodevideo\_info['webmfilepath']) ) { |
  |  | 231 | if ( url\_exists($movieurl\_noextension.".webm") ) { |
  |  | 232 | $encodevideo\_info['webm\_exists'] = true; |
  |  | 233 | $encodevideo\_info['webmurl'] = $movieurl\_noextension.".webm"; ; |
  |  | 234 | } |
  |  | 235 | } |
  |  | 236 | } |
  |  | 237 |  |
  |  | 238 | return $encodevideo\_info; |
  |  | 239 | } |
  | 74 | 240 |  |
  | 75 | 241 | function video\_embed\_thumbnail\_generator\_activate() { |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L94) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L260) |  |
  | 94 | 260 | define("wp\_FMP\_default\_ffmpeg\_exists", "notchecked", true); |
  | 95 | 261 | define("wp\_FMP\_default\_encodemobile", "true", true); |
  |  | 262 | define("wp\_FMP\_default\_mobile\_res", "480", true); |
  | 96 | 263 | define("wp\_FMP\_default\_encodeogg", "false", true); |
  | 97 | 264 | define("wp\_FMP\_default\_encodewebm", "true", true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L115) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L282) |  |
  | 115 | 282 | add\_option('wp\_FMP\_ffmpeg', wp\_FMP\_default\_ffmpeg); |
  | 116 | 283 | add\_option('wp\_FMP\_ffmpeg\_exists', wp\_FMP\_default\_ffmpeg\_exists); |
  |  | 284 | add\_option('wp\_FMP\_mobile\_res', wp\_FMP\_default\_mobile\_res); |
  | 117 | 285 | add\_option('wp\_FMP\_encodemobile', wp\_FMP\_default\_encodemobile); |
  | 118 | 286 | add\_option('wp\_FMP\_encodeogg', wp\_FMP\_default\_encodeogg); |
  | 119 | 287 | add\_option('wp\_FMP\_encodewebm', wp\_FMP\_default\_encodewebm); |
  | 120 | 288 |  |
  | 121 |  | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 122 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  | 123 |  | update\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  | 124 |  | } |
  | 125 |  | else { update\_option('wp\_FMP\_ffmpeg\_exists', "notinstalled"); } |
  |  | 289 | kg\_check\_ffmpeg\_exists(); |
  |  | 290 |  |
  | 126 | 291 | } |
  | 127 | 292 |  |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L212) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L377) |  |
  | 212 | 377 | $h264compatible = array("mp4", "mov", "m4v"); |
  | 213 | 378 |  |
  | 214 |  | //look for encoded files in the same directory as the movie, or in the encodes folder |
  | 215 |  | $originalurl = dirname(trim($content))."/".$moviefilebasename; |
  | 216 |  | $uploads = wp\_upload\_dir(); |
  | 217 |  | $url\_parts = parse\_url($uploads['baseurl']); |
  | 218 |  | $moviefiledirectory = dirname(parse\_url(trim($content), PHP\_URL\_PATH)); |
  | 219 |  | $home\_path = substr(strrev(strstr(strrev($uploads['basedir']), strrev("public\_html"))), 0, -strlen("public\_html")); |
  | 220 |  | if ( strpos( dirname(trim($content)), $url\_parts['host']) != "" ) { //if it's on the current server |
  | 221 |  | $originalpath = $home\_path."public\_html".$moviefiledirectory."/".$moviefilebasename; |
  | 222 |  | } |
  | 223 |  | $encodeurl = $uploads['baseurl']."/html5encodes/".$moviefilebasename; |
  | 224 |  | $encodepath = $uploads['basedir']."/html5encodes/".$moviefilebasename; |
  | 225 |  |  |
  | 226 |  | $html5type = array("-ipod.m4v", ".ogv", ".webm"); |
  | 227 |  |  |
  | 228 |  | foreach ($html5type as $extension) { |
  | 229 |  | $existing\_url = ""; |
  | 230 |  | if ( ".".$moviefiletype == $extension ) { $existing\_url = $content; } |
  | 231 |  | if ($existing\_url == "") { //search on the server for matching filename |
  | 232 |  | if ( file\_exists($originalpath.$extension) ) { $existing\_url = $originalurl.$extension; } |
  | 233 |  | } |
  | 234 |  | if ($existing\_url == "") { //search in the wp\_upload html5encodes directory |
  | 235 |  | if ( file\_exists($encodepath.$extension) ) { $existing\_url = $encodeurl.$extension; } |
  | 236 |  | } |
  | 237 |  | if ($existing\_url == "" && $originalpath == "") { //if the file's not on the server, search wherever it is |
  | 238 |  | if ( url\_exists($originalurl.$extension) ) { $existing\_url = $originalurl.$extension; } |
  | 239 |  | } |
  | 240 |  | $html5file[$extension] = $existing\_url; |
  | 241 |  | } |
  |  | 379 | $encodevideo\_info = kg\_encodevideo\_info(trim($content), 'singleurl'); |
  | 242 | 380 |  |
  | 243 | 381 | $code = "<div id=\"flashcontent".$div\_suffix."\">"; |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L245) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L383) |  |
  | 245 | 383 | if ($query\_atts["loop"] == 'true') { $code .= "loop='loop' " ;} |
  | 246 | 384 | if ($query\_atts["autoplay"] == 'true') { $code .= "autoplay='autoplay' " ;} |
  | 247 |  | if ($query\_atts["control~~s~~"] != 'none') { $code .= "controls='controls' " ;} |
  |  | 385 | if ($query\_atts["controlbar"] != 'none') { $code .= "controls='controls' " ;} |
  | 248 | 386 | if ($isAndroid) { $code .= "onclick='this.play();' "; } |
  | 249 | 387 | $code .= "preload='metadata' "; |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L258) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L396) |  |
  | 258 | 396 |  |
  | 259 | 397 | if ( in\_array($moviefiletype, $h264compatible) ) { |
  | 260 |  | if ( $~~html5file["-ipod.m4v"] !=""~~ && $isTierIphone ) { |
  | 261 |  | $code .= "<source src='".$~~html5file['-ipod.m4v'~~]."'"; |
  |  | 398 | if ( $encodevideo\_info["mobile\_exists"] && $isTierIphone ) { |
  |  | 399 | $code .= "<source src='".$encodevideo\_info["mobileurl"]."'"; |
  | 262 | 400 | } |
  | 263 |  | else { $code .= "<source src='".~~$content~~."'"; } |
  |  | 401 | else { $code .= "<source src='".trim($content)."'"; } |
  | 264 | 402 | if (!$isAndroid) { $code.= " type='video/mp4'"; } |
  | 265 | 403 | $code .=">\n"; |
  | 266 | 404 | } |
  | 267 |  | else { if (~~$html5file["-ipod.m4v"] != ""~~) { |
  | 268 |  | $code .= "<source src='".$~~html5file['-ipod.m4v'~~]."'"; |
  |  | 405 | else { if ( $encodevideo\_info["mobile\_exists"] ) { |
  |  | 406 | $code .= "<source src='".$encodevideo\_info["mobileurl"]."'"; |
  | 269 | 407 | if (!$isAndroid) { $code.= " type='video/mp4'"; } |
  | 270 | 408 | $code .=">\n"; |
  | 271 | 409 | } } |
  | 272 |  | if (~~$html5file[".webm"] != "") { $code .= "<source src='".$html5file['.webm'~~]."' type='video/webm'>\n"; } |
  | 273 |  | if (~~$html5file[".ogv"] != "") { $code .= "<source src='".$html5file['.ogv'~~]."' type='video/ogg'>\n"; } |
  |  | 410 | if ( $encodevideo\_info["webm\_exists"] ) { $code .= "<source src='".$encodevideo\_info["webmurl"]."' type='video/webm'>\n"; } |
  |  | 411 | if ( $encodevideo\_info["ogg\_exists"] ) { $code .= "<source src='".$encodevideo\_info["oggurl"]."' type='video/ogg'>\n"; } |
  | 274 | 412 | $code .= "</video>\n"; |
  | 275 | 413 | $code .= "</div>\n\n"; |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L311) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L449) |  |
  | 311 | 449 | define("wp\_FMP\_default\_skin", plugins\_url("", \_\_FILE\_\_)."/flash/skin/kg\_skin.xml", true); |
  | 312 | 450 | define("wp\_FMP\_default\_ffmpeg", "/usr/local/bin", true); |
  |  | 451 | define("wp\_FMP\_default\_mobile\_res", "480", true); |
  | 313 | 452 | define("wp\_FMP\_default\_encodemobile", "true", true); |
  | 314 | 453 | define("wp\_FMP\_default\_encodeogg", "false", true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L333) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L472) |  |
  | 333 | 472 | update\_option('wp\_FMP\_skin', wp\_FMP\_default\_skin); |
  | 334 | 473 | update\_option('wp\_FMP\_ffmpeg', wp\_FMP\_default\_ffmpeg); |
  |  | 474 | update\_option('wp\_FMP\_mobile\_res', wp\_FMP\_default\_mobile\_res); |
  | 335 | 475 | update\_option('wp\_FMP\_encodemobile', wp\_FMP\_default\_encodemobile); |
  | 336 | 476 | update\_option('wp\_FMP\_encodeogg', wp\_FMP\_default\_encodeogg); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L339) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L479) |  |
  | 339 | 479 | echo "<div class='updated'><p><strong>Video Embed & Thumbnail Generator plugin reset to default settings</strong></p></div>"; |
  | 340 | 480 |  |
  | 341 |  | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 342 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  | 343 |  | update\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  | 344 |  | } |
  | 345 |  | else { |
  |  | 481 | $ffmpeg\_info = kg\_check\_ffmpeg\_exists(); |
  |  | 482 |  |
  |  | 483 | if ( $ffmpeg\_info['exec\_enabled'] == false ) { |
  |  | 484 | echo "<div class='error'><p><strong>EXEC function is disabled in PHP settings. Embed codes will work, but video thumbnail generation and Mobile/HTML5 encoding will not. Contact your System Administrator to find out if you can enable EXEC</strong></p></div>"; |
  |  | 485 | } |
  |  | 486 | elseif ( $ffmpeg\_info['ffmpeg\_exists'] == false ) { |
  | 346 | 487 | echo "<div class='error'><p><strong>FFMPEG not found at ".get\_option('wp\_FMP\_ffmpeg').". Embed codes will work, but video thumbnail generation and Mobile/HTML5 encoding will not.</strong></p></div>"; |
  | 347 |  | ~~update\_option('wp\_FMP\_ffmpeg\_exists', "notinstalled");~~ |
  | 348 | 488 | } |
  | 349 | 489 |  |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L416) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L556) |  |
  | 416 | 556 | update\_option(wp\_FMP\_encodewebm, "false"); |
  | 417 | 557 | } |
  | 418 |  |  |
  |  | 558 |  |
  |  | 559 | update\_option('wp\_FMP\_mobile\_res', $\_POST[wp\_FMP\_mobile\_res]); |
  | 419 | 560 | update\_option('wp\_FMP\_width', $\_POST[wp\_FMP\_width]); |
  | 420 | 561 | update\_option('wp\_FMP\_height', $\_POST[wp\_FMP\_height]); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L431) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L572) |  |
  | 431 | 572 | echo "<div class='updated'><p><strong>Video Embed & Thumbnail Generator plugin settings updated</strong></p></div>"; |
  | 432 | 573 |  |
  | 433 |  | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 434 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  | 435 |  | update\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  | 436 |  | } |
  | 437 |  | else { |
  |  | 574 |  |
  |  | 575 | $ffmpeg\_info = kg\_check\_ffmpeg\_exists(); |
  |  | 576 |  |
  |  | 577 | if ( $ffmpeg\_info['exec\_enabled'] == false ) { |
  |  | 578 | echo "<div class='error'><p><strong>EXEC function is disabled in PHP settings. Embed codes will work, but video thumbnail generation and Mobile/HTML5 encoding will not. Contact your System Administrator to find out if you can enable EXEC</strong></p></div>"; |
  |  | 579 | } |
  |  | 580 | elseif ( $ffmpeg\_info['ffmpeg\_exists'] == false ) { |
  | 438 | 581 | echo "<div class='error'><p><strong>FFMPEG not found at ".get\_option('wp\_FMP\_ffmpeg').". Embed codes will work, but video thumbnail generation and Mobile/HTML5 encoding will not.</strong></p></div>"; |
  | 439 |  | ~~update\_option('wp\_FMP\_ffmpeg\_exists', "false");~~ |
  | 440 | 582 | } |
  | 441 | 583 | } |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L481) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L623) |  |
  | 481 | 623 | echo " />\n"; |
  | 482 | 624 | ?> |
  | 483 |  | Uncheck if you don't want HTML5 video fallback. |
  |  | 625 | Uncheck if you don't want HTML5 video fallback when Flash isn't installed. |
  | 484 | 626 | </td> |
  | 485 | 627 | </tr> |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L516) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L658) |  |
  | 516 | 658 | <em>Requires FFMPEG.</em> |
  | 517 | 659 | </td> |
  |  | 660 | </tr> |
  |  | 661 | <tr> |
  |  | 662 | <th scope="row" valign="top" align="left"> |
  |  | 663 | <label>Maximum H.264/Mobile Encode Resolution:</label> |
  |  | 664 | </th> |
  |  | 665 | <td width="10"></td> |
  |  | 666 | <td> |
  |  | 667 | <select name="wp\_FMP\_mobile\_res" id="wp\_FMP\_mobile\_res"> |
  |  | 668 | <?php |
  |  | 669 | $res\_480 = ""; |
  |  | 670 | $res\_720 = ""; |
  |  | 671 | $res\_1080 = ""; |
  |  | 672 | if(get\_option('wp\_FMP\_mobile\_res') == "480") { |
  |  | 673 | $res\_480 = " selected=\"selected\""; |
  |  | 674 | } |
  |  | 675 | if(get\_option('wp\_FMP\_mobile\_res') == "720") { |
  |  | 676 | $res\_720 = " selected=\"selected\""; |
  |  | 677 | } |
  |  | 678 | if(get\_option('wp\_FMP\_mobile\_res') == "1080") { |
  |  | 679 | $res\_1080 = " selected=\"selected\""; |
  |  | 680 | } |
  |  | 681 | ?> |
  |  | 682 | <option value="480"<?php echo $res\_480 ?>>480p</option> |
  |  | 683 | <option value="720"<?php echo $res\_720 ?>>720p</option> |
  |  | 684 | <option value="1080"<?php echo $res\_1080 ?>>1080p</option> |
  |  | 685 | </select> |
  |  | 686 | <em>Newer mobile devices can display HD video (iPhone 4/iPad 1/some Android play 720p, iPhone 4s/iPad 2 play 1080p) but many older devices (iPhone 3Gs/older Android) can't play higher than 480p. Increase at your own risk.</em> |
  |  | 687 | </td> |
  | 518 | 688 | </tr> |
  | 519 | 689 | <tr> |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L848) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1018) |  |
  | 848 | 1018 | if( substr($post->post\_mime\_type, 0, 5) == 'video' ){ |
  | 849 | 1019 |  |
  |  | 1020 | $form\_fields["kgflashmediaplayer-security"]["input"] = "hidden"; |
  |  | 1021 | $form\_fields["kgflashmediaplayer-security"]["value"] = wp\_create\_nonce('video-embed-thumbnail-generator-nonce'); |
  |  | 1022 |  |
  |  | 1023 | $movieurl = wp\_get\_attachment\_url($post->ID); |
  | 850 | 1024 | $form\_fields["kgflashmediaplayer-url"]["input"] = "hidden"; |
  | 851 |  | $form\_fields["kgflashmediaplayer-url"]["value"] = wp\_get\_attachment\_url($post->ID); |
  | 852 |  |  |
  | 853 |  | $form\_fields["kgflashmediaplayer-ffmpeg\_path"]["input"] = "hidden"; |
  | 854 |  | $form\_fields["kgflashmediaplayer-ffmpeg\_path"]["value"] = get\_option('wp\_FMP\_ffmpeg'); |
  |  | 1025 | $form\_fields["kgflashmediaplayer-url"]["value"] = $movieurl; |
  | 855 | 1026 |  |
  | 856 | 1027 | $encodemobileset = get\_post\_meta($post->ID, "\_kgflashmediaplayer-encodemobile", true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L869) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1040) |  |
  | 869 | 1040 | $form\_fields["kgflashmediaplayer-encodewebm"]["value"] = $encodewebmset; |
  | 870 | 1041 |  |
  | 871 |  | $form\_fields["kgflashmediaplayer-plugin\_dir"]["input"] = "hidden"; |
  | 872 |  | $form\_fields["kgflashmediaplayer-plugin\_dir"]["value"] = plugins\_url("", \_\_FILE\_\_); |
  | 873 |  |  |
  | 874 |  | $uploads = wp\_upload\_dir(); |
  | 875 |  | $form\_fields["kgflashmediaplayer-upload\_url"]["input"] = "hidden"; |
  | 876 |  | $form\_fields["kgflashmediaplayer-upload\_url"]["value"] = $uploads['url']; |
  | 877 |  |  |
  | 878 |  | $form\_fields["kgflashmediaplayer-upload\_path"]["input"] = "hidden"; |
  | 879 |  | $form\_fields["kgflashmediaplayer-upload\_path"]["value"] = $uploads['path']; |
  | 880 |  |  |
  | 881 |  | $form\_fields["kgflashmediaplayer-upload\_basedir"]["input"] = "hidden"; |
  | 882 |  | $form\_fields["kgflashmediaplayer-upload\_basedir"]["value"] = $uploads['basedir']; |
  |  | 1042 | $encoded = get\_post\_meta($post->ID, "\_kgflashmediaplayer-encoded", true); |
  |  | 1043 | $form\_fields["kgflashmediaplayer-encoded"]["input"] = "hidden"; |
  |  | 1044 | $form\_fields["kgflashmediaplayer-encoded"]["value"] = $encoded; |
  | 883 | 1045 |  |
  | 884 | 1046 | $maxwidth = get\_option('wp\_FMP\_width'); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L916) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1078) |  |
  | 916 | 1078 | $thumbnail\_url = get\_post\_meta($post->ID, "\_kgflashmediaplayer-poster", true); |
  | 917 | 1079 |  |
  |  | 1080 | $uploads = wp\_upload\_dir(); |
  | 918 | 1081 | $url\_parts = parse\_url($uploads['baseurl']); |
  | 919 | 1082 | $moviefiledirectory = dirname(parse\_url(trim($thumbnail\_url), PHP\_URL\_PATH)); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L934) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1097) |  |
  | 934 | 1097 | else { $numberofthumbs\_value = "4"; } |
  | 935 | 1098 |  |
  | 936 |  | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == false ) { //make sure the new ffmpeg\_exists option exists |
  | 937 |  | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 938 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  | 939 |  | add\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  | 940 |  | } |
  | 941 |  | else { add\_option('wp\_FMP\_ffmpeg\_exists', "notinstalled"); } |
  | 942 |  | } |
  |  | 1099 | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == false ) { kg\_check\_ffmpeg\_exists(); } //make sure the new ffmpeg\_exists option exists |
  | 943 | 1100 |  |
  | 944 | 1101 | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == "notinstalled" ) { $ffmpeg\_disabled\_text = 'disabled="disabled" title="FFMPEG not found at '.get\_option('wp\_FMP\_ffmpeg').'"'; } |
  |  | 1102 | else { $ffmpeg\_disabled\_text = ""; } |
  | 945 | 1103 |  |
  | 946 | 1104 | $form\_fields["generator"]["label"] = \_\_("Thumbnails"); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L975) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1133) |  |
  | 975 | 1133 | if ($encodewebmset == "false") { $webmchecked = ""; } |
  | 976 | 1134 | else { $webmchecked = "checked"; } |
  |  | 1135 |  |
  |  | 1136 | $replaceoptions = ""; |
  |  | 1137 |  |
  |  | 1138 | $altembedset = get\_post\_meta($post->ID, "\_kgflashmediaplayer-altembed", true); |
  |  | 1139 | $encodevideo\_info = kg\_encodevideo\_info($movieurl, $post->ID); |
  |  | 1140 |  |
  |  | 1141 | $altembedselect = ""; |
  |  | 1142 | $selected = ' selected="selected" '; |
  |  | 1143 | $mobileselected = ""; |
  |  | 1144 | $oggselected = ""; |
  |  | 1145 | $webmselected = ""; |
  |  | 1146 | if ($altembedset == $encodevideo\_info['mobileurl']) { $mobileselected = $selected; } |
  |  | 1147 | if ($altembedset == $encodevideo\_info['oggurl']) { $oggselected = $selected; } |
  |  | 1148 | if ($altembedset == $encodevideo\_info['webmurl']) { $webmselected = $selected; } |
  |  | 1149 |  |
  |  | 1150 | if ( $encodevideo\_info['mobile\_exists'] ) { $replaceoptions .= '<option '.$mobileselected.' value="'.$encodevideo\_info['mobileurl'].'">Mobile/H.264</option>'; } |
  |  | 1151 | if ( $encodevideo\_info['webm\_exists'] ) { $replaceoptions .= '<option '.$webmselected.' value="'.$encodevideo\_info['webmurl'].'">WEBM</option>'; } |
  |  | 1152 | if ( $encodevideo\_info['ogg\_exists'] ) { $replaceoptions .= '<option '.$oggselected.' value="'.$encodevideo\_info['oggurl'].'">OGV</option>'; } |
  |  | 1153 | if ( $encodevideo\_info['mobile\_exists'] || $encodevideo\_info['webm\_exists'] || $encodevideo\_info['ogg\_exists'] ) { $altembedselect ='<span class="kg\_embedselect">Embed <select name="attachments['.$post->ID.'][kgflashmediaplayer-altembed]" id="attachments['.$post->ID.'][kgflashmediaplayer-altembed]"><option value="'.$movieurl.'">original</option>'.$replaceoptions.'</select></span>'; } |
  |  | 1154 |  |
  | 977 | 1155 | $form\_fields["kgflashmediaplayer-encode"]["label"] = \_\_("HTML5 & Mobile"); |
  | 978 | 1156 | $form\_fields["kgflashmediaplayer-encode"]["input"] = "html"; |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L988) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1166) |  |
  | 988 | 1166 | <label for="attachments['. $post->ID .'][kgflashmediaplayer-encodeoggcheck]">OGV</label> |
  | 989 | 1167 |  |
  | 990 |  | <div style="display:inline-block;" id="attachments\_'. $post->ID .'\_encodeplaceholder"></div><br /><small><em>(Experimental) Generates video files compatible with most mobile & HTML5-compatible browsers.</em></small>'; |
  |  | 1168 | <div style="display:inline;" id="attachments\_'. $post->ID .'\_altembedselect">'.$altembedselect.'</div> |
  |  | 1169 | <div style="display:block;" id="attachments\_'. $post->ID .'\_encodeplaceholder"></div> |
  |  | 1170 | <div style="display:block;" id="attachments\_'. $post->ID .'\_encodeprogressplaceholder"></div> |
  |  | 1171 |  |
  |  | 1172 | <small><em>(Experimental) Generates video files compatible with most mobile & HTML5-compatible browsers.</em></small>'; |
  | 991 | 1173 |  |
  | 992 | 1174 | $showtitlechecked = get\_post\_meta($post->ID, "\_kgflashmediaplayer-showtitle", true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L997) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1179) |  |
  | 997 | 1179 | $form\_fields["kgflashmediaplayer-options"]["label"] = \_\_("Video Embed Options"); |
  | 998 | 1180 | $form\_fields["kgflashmediaplayer-options"]["input"] = "html"; |
  | 999 |  | $form\_fields["kgflashmediaplayer-options"]["html"] = '<input type="checkbox" name="attachments[~~{$post->ID}][kgflashmediaplayer-showtitle]" id="attachments[{$post->ID}~~][kgflashmediaplayer-showtitle]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-showtitlesave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-showtitlesave]\').value = \'unchecked\'; }"" '.$showtitlechecked.'> |
  | 1000 |  | <label for="attachments[~~{$post->ID}~~][kgflashmediaplayer-showtitle]">Include Title Above Video</label><br /> |
  | 1001 |  |  |
  | 1002 |  | <input type="checkbox" name="attachments[~~{$post->ID}][kgflashmediaplayer-downloadlink]" id="attachments[{$post->ID}~~][kgflashmediaplayer-downloadlink]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-downloadsave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-downloadsave]\').value = \'unchecked\'; }" '.$downloadlinkchecked.'> |
  | 1003 |  | <label for="attachments[~~{$post->ID}~~][kgflashmediaplayer-downloadlink]">Generate Download Link Below Video<em><small>(Makes it easier for users to download video file)</em></small></label><br /> |
  | 1004 |  |  |
  | 1005 |  | <input type="checkbox" name="attachments[~~{$post->ID}][kgflashmediaplayer-embed]" id="attachments[{$post->ID}~~][kgflashmediaplayer-embed]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-embedsave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-embedsave]\').value = \'unchecked\'; }" '.$embedchecked.'> |
  | 1006 |  | <label for="attachments[~~{$post->ID}~~][kgflashmediaplayer-embed]">Generate Embed Shortcode <em><small>(Turn off checkbox to use default WordPress video embedding)</small></em></label>'; |
  |  | 1181 | $form\_fields["kgflashmediaplayer-options"]["html"] = '<input type="checkbox" name="attachments['.$post->ID.'][kgflashmediaplayer-showtitle]" id="attachments['.$post->ID.'][kgflashmediaplayer-showtitle]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-showtitlesave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-showtitlesave]\').value = \'unchecked\'; }"" '.$showtitlechecked.'> |
  |  | 1182 | <label for="attachments['.$post->ID.'][kgflashmediaplayer-showtitle]">Include Title Above Video</label><br /> |
  |  | 1183 |  |
  |  | 1184 | <input type="checkbox" name="attachments['.$post->ID.'][kgflashmediaplayer-downloadlink]" id="attachments['.$post->ID.'][kgflashmediaplayer-downloadlink]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-downloadsave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-downloadsave]\').value = \'unchecked\'; }" '.$downloadlinkchecked.'> |
  |  | 1185 | <label for="attachments['.$post->ID.'][kgflashmediaplayer-downloadlink]">Generate Download Link Below Video<em><small>(Makes it easier for users to download video file)</em></small></label><br /> |
  |  | 1186 |  |
  |  | 1187 | <input type="checkbox" name="attachments['.$post->ID.'][kgflashmediaplayer-embed]" id="attachments['.$post->ID.'][kgflashmediaplayer-embed]" value="checked" onclick="if(this.checked) { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-embedsave]\').value = \'checked\'; } else { document.getElementById(\'attachments['.$post->ID.'][kgflashmediaplayer-embedsave]\').value = \'unchecked\'; }" '.$embedchecked.'> |
  |  | 1188 | <label for="attachments['.$post->ID.'][kgflashmediaplayer-embed]">Generate Embed Shortcode <em><small>(Turn off checkbox to use default WordPress video embedding)</small></em></label>'; |
  | 1007 | 1189 |  |
  | 1008 | 1190 | //$form\_fields["kgflashmediaplayer-attachment"]["label"] = \_\_("All Meta"); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1036) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1218) |  |
  | 1036 | 1218 | } |
  | 1037 | 1219 | } |
  | 1038 |  | if ( is\_~~dir($uploads['path'].'/thumb\_tmp') && ($files = @scandir($uploads['path'].'/thumb\_tmp') && (count($files) < 2)) ) { rmdir($uploads['path'~~].'/thumb\_tmp'); } |
  |  | 1220 | if ( is\_empty\_dir($uploads["path"].'/thumb\_tmp') ) { rrmdir($uploads["path"].'/thumb\_tmp'); } |
  | 1039 | 1221 | } |
  | 1040 | 1222 | update\_post\_meta($post['ID'], '\_kgflashmediaplayer-poster', $attachment['kgflashmediaplayer-poster']); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1050) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1232) |  |
  | 1050 | 1232 | if( isset($attachment['kgflashmediaplayer-downloadsave']) ) { update\_post\_meta($post['ID'], '\_kgflashmediaplayer-download', $attachment['kgflashmediaplayer-downloadsave']); } |
  | 1051 | 1233 | if( isset($attachment['kgflashmediaplayer-showtitlesave']) ) { update\_post\_meta($post['ID'], '\_kgflashmediaplayer-showtitle', $attachment['kgflashmediaplayer-showtitlesave']); } |
  | 1052 |  |  |
  |  | 1234 | if( isset($attachment['kgflashmediaplayer-altembed']) ) { update\_post\_meta($post['ID'], '\_kgflashmediaplayer-altembed', $attachment['kgflashmediaplayer-altembed']); } |
  |  | 1235 | /\* if( isset($attachment['kgflashmediaplayer-encoded']) ) { update\_post\_meta($post['ID'], '\_kgflashmediaplayer-encoded', $attachment['kgflashmediaplayer-encoded']); } \*/ |
  | 1053 | 1236 |  |
  | 1054 | 1237 | //$attachment\_printr = print\_r($attachment, true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1074) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1257) |  |
  | 1074 | 1257 | if ($attachment['embed'] == "checked" || $attachment\_id == "singleurl" ) { |
  | 1075 | 1258 | $output = ""; |
  | 1076 |  | $attachment['url'] = wp\_get\_attachment\_url($attachment\_id); |
  |  | 1259 | $attachment['altembed'] = get\_post\_meta($attachment\_id, "\_kgflashmediaplayer-altembed", true); |
  |  | 1260 | if ( $attachment['altembed'] != "" ) { $attachment['url'] = $attachment['altembed']; } |
  |  | 1261 | else { $attachment['url'] = wp\_get\_attachment\_url($attachment\_id); } |
  | 1077 | 1262 | $attachment['title'] = get\_the\_title($attachment\_id); |
  | 1078 | 1263 | $attachment['poster'] = get\_post\_meta($attachment\_id, "\_kgflashmediaplayer-poster", true); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1111) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1296) |  |
  | 1111 | 1296 | function media\_embedurl\_process() { |
  | 1112 | 1297 |  |
  | 1113 |  | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == false ) { //make sure the new ffmpeg\_exists option exists |
  | 1114 |  | exec(get\_option('wp\_FMP\_ffmpeg').'/ffmpeg /dev/null 2>&1', $output, $returnvalue); //attempt to execute FFMPEG |
  | 1115 |  | if ($returnvalue < 126 ) { //if FFMPEG executed |
  | 1116 |  | add\_option('wp\_FMP\_ffmpeg\_exists', "true"); |
  | 1117 |  | } |
  | 1118 |  | else { add\_option('wp\_FMP\_ffmpeg\_exists', "notinstalled"); } |
  | 1119 |  | } |
  |  | 1298 | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == false ) { kg\_check\_ffmpeg\_exists(); } //make sure the new ffmpeg\_exists option exists |
  | 1120 | 1299 |  |
  | 1121 | 1300 | if ( get\_option('wp\_FMP\_ffmpeg\_exists') == "notinstalled" ) { $ffmpeg\_disabled\_text = 'disabled="disabled" title="FFMPEG not found at '.get\_option('wp\_FMP\_ffmpeg').'"'; } |
  |  | 1301 | else { $ffmpeg\_disabled\_text = ""; } |
  | 1122 | 1302 |  |
  | 1123 | 1303 | if ( get\_option('wp\_FMP\_encodemobile') == "true" ) { $mobilechecked = "checked";  } |
  |  | 1304 | else { $mobilechecked = ""; } |
  | 1124 | 1305 | if ( get\_option('wp\_FMP\_encodeogg') == "true" ) { $oggchecked = "checked";  } |
  |  | 1306 | else { $oggchecked = ""; } |
  | 1125 | 1307 | if ( get\_option('wp\_FMP\_encodewebm') == "true" ) { $webmchecked = "checked";  } |
  |  | 1308 | else { $webmchecked = ""; } |
  | 1126 | 1309 |  |
  | 1127 | 1310 | media\_upload\_header(); |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1179) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1362) |  |
  | 1179 | 1362 | <label for="attachments[singleurl][kgflashmediaplayer-encodeoggcheck]">OGV</label> |
  | 1180 | 1363 |  |
  | 1181 |  | <div id="attachments\_singleurl\_encodeplaceholder" name="attachments\_singleurl\_encodeplaceholder" style="display:inline-block;"></div><br /> |
  | 1182 |  | <small><em>(Experimental) Generates video files compatible with most mobile & HTML5-compatible browsers.</em></small></td> |
  |  | 1364 | <div style="display:inline;" id="attachments\_singleurl\_altembedselect"></div> |
  |  | 1365 | <div style="display:block;" id="attachments\_singleurl\_encodeplaceholder"></div> |
  |  | 1366 | <div style="display:block;" id="attachments\_singleurl\_encodeprogressplaceholder"></div> |
  |  | 1367 |  |
  |  | 1368 | <small><em>(Experimental) Generates video files compatible with most mobile & HTML5-compatible browsers.</em></small></td> |
  | 1183 | 1369 | </tr> |
  | 1184 | 1370 | <tr> |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1202) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1388) |  |
  | 1202 | 1388 | ?> |
  | 1203 | 1389 |  |
  | 1204 |  | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-~~ffmpeg\_path]' id='attachments[singleurl][kgflashmediaplayer-ffmpeg\_path]' value='<?php echo get\_option('wp\_FMP\_ffmpeg~~'); ?>' /> |
  |  | 1390 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-security]' id='attachments[singleurl][kgflashmediaplayer-security]' value='<?php echo wp\_create\_nonce('video-embed-thumbnail-generator-nonce'); ?>' /> |
  | 1205 | 1391 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-encodemobile]' id='attachments[singleurl][kgflashmediaplayer-encodemobile]' value='<?php echo get\_option('wp\_FMP\_encodemobile'); ?>' /> |
  | 1206 | 1392 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-encodeogg]' id='attachments[singleurl][kgflashmediaplayer-encodeogg]' value='<?php echo get\_option('wp\_FMP\_encodeogg'); ?>' /> |
  | 1207 | 1393 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-encodewebm]' id='attachments[singleurl][kgflashmediaplayer-encodewebm]' value='<?php echo get\_option('wp\_FMP\_encodewebm'); ?>' /> |
  | 1208 |  | ~~<input type='hidden' name='attachments[singleurl][kgflashmediaplayer-plugin\_dir]' id='attachments[singleurl][kgflashmediaplayer-plugin\_dir]' value='<?php echo plugins\_url("", \_\_FILE\_\_); ?>' />~~ |
  | 1209 |  | ~~<input type='hidden' name='attachments[singleurl][kgflashmediaplayer-upload\_url]' id='attachments[singleurl][kgflashmediaplayer-upload\_url]' value='<?php echo $uploads['url']; ?>' />~~ |
  | 1210 |  | ~~<input type='hidden' name='attachments[singleurl][kgflashmediaplayer-upload\_path]' id='attachments[singleurl][kgflashmediaplayer-upload\_path]' value='<?php echo $uploads['path']; ?>' />~~ |
  | 1211 |  | ~~<input type='hidden' name='attachments[singleurl][kgflashmediaplayer-upload\_basedir]' id='attachments[singleurl][kgflashmediaplayer-upload\_basedir]' value='<?php echo $uploads['basedir']; ?>' />~~ |
  | 1212 | 1394 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-maxheight]' id='attachments[singleurl][kgflashmediaplayer-maxheight]' value='<?php echo($maxheight); ?>' /> |
  | 1213 | 1395 | <input type='hidden' name='attachments[singleurl][kgflashmediaplayer-maxwidth]' id='attachments[singleurl][kgflashmediaplayer-maxwidth]' value='<?php echo($maxwidth); ?>' /> |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1223) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1405) |  |
  | 1223 | 1405 | add\_action('media\_upload\_embedurl', 'kg\_embedurl\_handle'); |
  | 1224 | 1406 |  |
  | 1225 |  |  |
  | 1226 |  |  |
  | 1227 |  |  |
  | 1228 |  | function kg\_cleanup\_generated\_thumbnails\_handler($posterurl) { |
  |  | 1407 | function kg\_cleanup\_generated\_logfiles\_handler($logfile) { |
  |  | 1408 | $lastmodified = ""; |
  |  | 1409 | if ( file\_exists($logfile) ) { $lastmodified = filemtime($logfile); } |
  |  | 1410 | if ( $lastmodified != false ) { |
  |  | 1411 | if ( time() - $lastmodified > 120 ) { unlink($logfile); } |
  |  | 1412 | else { |
  |  | 1413 | $timestamp = wp\_next\_scheduled( 'kg\_cleanup\_generated\_logfiles' ); |
  |  | 1414 | wp\_unschedule\_event($timestamp, 'kg\_cleanup\_generated\_logfiles' ); |
  |  | 1415 | $args = array('logfile'=>$logfile); |
  |  | 1416 | wp\_schedule\_single\_event(time()+600, 'kg\_cleanup\_generated\_logfiles', $args); |
  |  | 1417 | } |
  |  | 1418 | } |
  |  | 1419 | } |
  |  | 1420 | add\_action('kg\_cleanup\_generated\_logfiles','kg\_cleanup\_generated\_logfiles\_handler'); |
  |  | 1421 |  |
  |  | 1422 | function kg\_cleanup\_generated\_thumbnails\_handler() { |
  | 1229 | 1423 | $uploads = wp\_upload\_dir(); |
  | 1230 | 1424 | rrmdir($uploads['path'].'/thumb\_tmp'); //remove the whole tmp file directory |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1232) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1426) |  |
  | 1232 | 1426 | add\_action('kg\_cleanup\_generated\_thumbnails','kg\_cleanup\_generated\_thumbnails\_handler'); |
  | 1233 | 1427 |  |
  | 1234 |  | function kg\_schedule\_cleanup\_generated\_files() { //schedules deleting all tmp thumbnails if no thumbnails are generated in an hour |
  | 1235 |  | $timestamp = wp\_next\_scheduled( 'kg\_cleanup\_generated\_thumbnails' ); |
  | 1236 |  | wp\_unschedule\_event($timestamp, 'kg\_cleanup\_generated\_thumbnails' ); |
  | 1237 |  | wp\_schedule\_single\_event(time()+3600, 'kg\_cleanup\_generated\_thumbnails'); |
  |  | 1428 | function kg\_schedule\_cleanup\_generated\_files() { //schedules deleting all tmp thumbnails or logfiles if no files are generated in an hour |
  |  | 1429 |  |
  |  | 1430 | check\_ajax\_referer( 'video-embed-thumbnail-generator-nonce', 'security' ); |
  |  | 1431 |  |
  |  | 1432 | if (isset($\_POST['thumbs'])) { |
  |  | 1433 | $timestamp = wp\_next\_scheduled( 'kg\_cleanup\_generated\_thumbnails' ); |
  |  | 1434 | wp\_unschedule\_event($timestamp, 'kg\_cleanup\_generated\_thumbnails' ); |
  |  | 1435 | wp\_schedule\_single\_event(time()+3600, 'kg\_cleanup\_generated\_thumbnails'); |
  |  | 1436 | } |
  |  | 1437 |  |
  |  | 1438 | if (isset($\_POST['logfile'])) { |
  |  | 1439 | $timestamp = wp\_next\_scheduled( 'kg\_cleanup\_generated\_logfiles' ); |
  |  | 1440 | wp\_unschedule\_event($timestamp, 'kg\_cleanup\_generated\_logfiles' ); |
  |  | 1441 | $args = array('logfile'=>$\_POST['logfile']); |
  |  | 1442 | wp\_schedule\_single\_event(time()+600, 'kg\_cleanup\_generated\_logfiles', $args); |
  |  | 1443 | } |
  | 1238 | 1444 | die(); // this is required to return a proper result |
  | 1239 | 1445 | } |
  | 1240 | 1446 | add\_action('wp\_ajax\_kg\_schedule\_cleanup\_generated\_files', 'kg\_schedule\_cleanup\_generated\_files'); |
  |  | 1447 |  |
  |  | 1448 | function kg\_callffmpeg() { |
  |  | 1449 |  |
  |  | 1450 | check\_ajax\_referer( 'video-embed-thumbnail-generator-nonce', 'security' ); |
  |  | 1451 | global $wpdb; |
  |  | 1452 | include\_once dirname( \_\_FILE\_\_ ) .'/kg\_callffmpeg.php'; |
  |  | 1453 | die(); // this is required to return a proper result |
  |  | 1454 | } |
  |  | 1455 |  |
  |  | 1456 | add\_action('wp\_ajax\_kg\_callffmpeg', 'kg\_callffmpeg'); |
  |  | 1457 |  |
  |  | 1458 | function kg\_check\_encode\_progress() { |
  |  | 1459 |  |
  |  | 1460 | check\_ajax\_referer( 'video-embed-thumbnail-generator-nonce', 'security' ); |
  |  | 1461 | global $wpdb; |
  |  | 1462 | $pid = $\_POST['pid']; |
  |  | 1463 | $logfile = $\_POST['logfile']; |
  |  | 1464 | $movie\_duration = $\_POST['movie\_duration']; |
  |  | 1465 | $embed\_display = ""; |
  |  | 1466 | $percent\_done = ""; |
  |  | 1467 | $other\_message = ""; |
  |  | 1468 | $logfilecontents = ""; |
  |  | 1469 | $lastline = ""; |
  |  | 1470 |  |
  |  | 1471 | if ( is\_file($logfile) ) { |
  |  | 1472 |  |
  |  | 1473 | $logfilecontents = file\_get\_contents($logfile); |
  |  | 1474 | $fp = fopen($logfile, 'w'); |
  |  | 1475 | fclose($fp); |
  |  | 1476 | $lastlines = kg\_explodeX(array("\r","\n"), $logfilecontents); |
  |  | 1477 | $lastlines\_output = print\_r($lastlines, true); |
  |  | 1478 | $lastline = end($lastlines); |
  |  | 1479 | if ( $lastline == "" ) { $lastline = prev($lastlines); } |
  |  | 1480 |  |
  |  | 1481 | $last\_match = ""; |
  |  | 1482 | $time\_matches = ""; |
  |  | 1483 | $video\_matches = ""; |
  |  | 1484 | $libx264\_matches = ""; |
  |  | 1485 | $fps\_matches = ""; |
  |  | 1486 | $fps\_match = ""; |
  |  | 1487 | $basename = ""; |
  |  | 1488 |  |
  |  | 1489 | preg\_match('/time=(.\*?) /', $lastline, $time\_matches); |
  |  | 1490 |  |
  |  | 1491 | if ( array\_key\_exists(1, $time\_matches) != true ) { |
  |  | 1492 | preg\_match('/video:(.\*?) /', $lastline, $video\_matches); |
  |  | 1493 | preg\_match('/libx264 (.\*?) /', $lastline, $libx264\_matches); |
  |  | 1494 | } |
  |  | 1495 |  |
  |  | 1496 | if ( array\_key\_exists(1, $time\_matches) == true ) { |
  |  | 1497 | $current\_hours = intval(substr($time\_matches[1], -11, 2)); |
  |  | 1498 | $current\_minutes = intval(substr($time\_matches[1], -8, 2)); |
  |  | 1499 | $current\_seconds = intval(substr($time\_matches[1], -5, 2)); |
  |  | 1500 | $current\_seconds = ($current\_hours \* 60 \* 60) + ($current\_minutes \* 60) + $current\_seconds; |
  |  | 1501 | $percent\_done = round(intval($current\_seconds)/intval($movie\_duration)\*100); |
  |  | 1502 |  |
  |  | 1503 | preg\_match('/fps=\s+(.\*?) /', $lastline, $fps\_matches); |
  |  | 1504 | if ( array\_key\_exists(1, $fps\_matches) == true ) { $fps\_match = $fps\_matches[1]; } |
  |  | 1505 | else {  $fps\_match = "10"; } |
  |  | 1506 | } |
  |  | 1507 | elseif ( array\_key\_exists(1, $video\_matches) == true || array\_key\_exists(1, $libx264\_matches) == true ) { |
  |  | 1508 | $percent\_done = 100; |
  |  | 1509 | } |
  |  | 1510 | else { |
  |  | 1511 | $other\_message = $lastline; |
  |  | 1512 | $basename = substr($logfile, 0, -16); |
  |  | 1513 | if ( is\_file($basename."-ipod.m4v") ) { |
  |  | 1514 | if ( (time() - filemtime($basename."-ipod.m4v")) < 30 ) { unlink($basename."-ipod.m4v"); } |
  |  | 1515 | } |
  |  | 1516 | if ( is\_file($basename.".ogv") ) { |
  |  | 1517 | if ( (time() - filemtime($basename.".ogv")) < 30 ) { unlink($basename.".ogv"); } |
  |  | 1518 | } |
  |  | 1519 | if ( is\_file($basename.".webm") ) { |
  |  | 1520 | if ( (time() - filemtime($basename.".webm")) < 30 ) { //unlink($basename.".webm"); |
  |  | 1521 | } |
  |  | 1522 | } |
  |  | 1523 | } |
  |  | 1524 |  |
  |  | 1525 | if ( $percent\_done == "100" || $other\_message != "" ) { if ( file\_exists($logfile) ) { unlink($logfile); } } |
  |  | 1526 |  |
  |  | 1527 | $embed\_display .= $lastline; |
  |  | 1528 | $arr = array ( "embed\_display"=>$embed\_display, "percent\_done"=>$percent\_done, "other\_message"=>$other\_message, "fps"=>$fps\_match ); |
  |  | 1529 | } |
  |  | 1530 | else { $arr = array ( "other\_message"=>"Encoding Failed" ); } |
  |  | 1531 |  |
  |  | 1532 | echo json\_encode($arr); |
  |  | 1533 |  |
  |  | 1534 | die(); // this is required to return a proper result |
  |  | 1535 | } |
  |  | 1536 | add\_action('wp\_ajax\_kg\_check\_encode\_progress', 'kg\_check\_encode\_progress'); |
  |  | 1537 |  |
  |  | 1538 | function kg\_cancel\_encode() { |
  |  | 1539 |  |
  |  | 1540 | check\_ajax\_referer( 'video-embed-thumbnail-generator-nonce', 'security' ); |
  |  | 1541 |  |
  |  | 1542 | if (isset($\_POST['kg\_pid'])) { |
  |  | 1543 | $kg\_pid = $\_POST['kg\_pid']; |
  |  | 1544 | if ( intval($kg\_pid) > 0 ) { |
  |  | 1545 | //$command = escapeshellcmd('kill '.$kg\_pid); |
  |  | 1546 | //exec($command); |
  |  | 1547 | posix\_kill($kg\_pid, 15); |
  |  | 1548 | } |
  |  | 1549 | } |
  |  | 1550 |  |
  |  | 1551 | die(); // this is required to return a proper result |
  |  | 1552 | } |
  |  | 1553 | add\_action('wp\_ajax\_kg\_cancel\_encode', 'kg\_cancel\_encode'); |
  | 1241 | 1554 |  |
  | 1242 | 1555 | function enqueue\_kg\_script() { //loads plugin-related javascripts |
  | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=486697#L1245) | […](/browser/video-embed-thumbnail-generator/trunk/video-embed-thumbnail-generator.php?rev=507924#L1558) |  |
  | 1245 | 1558 | add\_action('admin\_enqueue\_scripts', 'enqueue\_kg\_script'); |
  | 1246 | 1559 |  |
  |  | 1560 | function enqueue\_kg\_style() { //loads plugin-related CSS |
  |  | 1561 | $myStyleUrl = plugins\_url('video-embed-thumbnail-generator.css', \_\_FILE\_\_); |
  |  | 1562 | wp\_enqueue\_style('kg\_progressbar\_style', $myStyleUrl); |
  |  | 1563 | } |
  |  | 1564 | add\_action('admin\_print\_styles', 'enqueue\_kg\_style'); |
  |  | 1565 |  |
  | 1247 | 1566 | add\_action('wp\_head', 'addSWFObject'); |
  | 1248 | 1567 | add\_action('admin\_menu', 'addFMPOptionsPage'); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=507924)
* [Zip Archive](?format=zip&new=507924)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


