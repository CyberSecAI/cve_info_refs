=== Content from bugs.launchpad.net_10e3f9dd_20250124_165541.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[nvidia-graphics-drivers package](https://launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers)

# heap overflows in nvidia driver

Bug #979373 reported by
[Kees Cook](https://launchpad.net/~kees)
on 2012-04-11

[278](/%2Bhelp-bugs/bug-heat.html)

This bug affects 2 people

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [nvidia-graphics-drivers (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers "Latest release: 304.88-0ubuntu0.0.2, uploaded to restricted on 2013-04-08 17:55:14.669856+00:00 by Marc Deslauriers (mdeslaur), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | High | Unassigned |  |

### Bug Description

Hello,

While I haven't had time to prove these out, they seem to be problems.

1) Race, available only to uid 0 (but uid 0 should not mean ring-0 access): /proc/driver/nvidia/registry is vulnerable to a write race that can result in a limited heap overflow.

nv\_procfs\_write\_registry does not perform locking on nvfp->off, so two writers (of the same fd) could race to confuse the bytes\_left and proc\_buffer locations, leading to heap overflow:

writer 1: bytes\_left = (NV\_PROC\_WRITE\_BUFFER\_SIZE - nvfp->off - 1);

writer 1: ...

writer 1: copy\_from\_user(proc\_buffer, buffer, count))

writer 2: bytes\_left = (NV\_PROC\_WRITE\_BUFFER\_SIZE - nvfp->off - 1);

writer 1: nvfp->off += count;

writer 2: ...

writer 2: proc\_buffer = &((char \*)nvfp->data)[nvfp->off];

writer 2: copy\_from\_user(proc\_buffer, buffer, count)

writer 2's count was checked against nvfp->off before it was moved, and writer 2's proc\_buffer is now offset by nvfp->off, allowing a write past the end of the heap buffer, by at most NV\_PROC\_WRITE\_BUFFER\_SIZE (64k) - 2 bytes.

2) Heap overflow in control device ioctl: minimum size of the ioctl buffer is not checked for NV\_ESC\_CARD\_INFO, which will write 50 bytes per device to the allocated kernel buffer (which was sized to the input buffer), before attempting to then write it back to the user buffer. With a minimum 1 byte buffer, this is a 49 byte overflow, since the rm\_api->magic check doesn't actually abort the ioctl.

I expect there are additional heap overflows in the rm\_ioctl function since it is not passed arg\_size as a parameter, but I didn't have time to examine the binary module. Seems like enforcing a minimum allocation size when calling rm\_ioctl would be the simplest fix.

3) Kernel heap contents leak race in ioctl handler: the ioctl will copy the contents of kernel heap back to the user buffer even on failure. By racing the ioctl with a change in VMA protections, it should be possible to extract uncleared kernel heap memory:

thread 1: set VMA for arg\_ptr to PROT\_NONE

thread 1: NV\_KMALLOC(arg\_copy, arg\_size);

thread 1: copy\_from\_user(arg\_copy, arg\_ptr, arg\_size) <- fails and jumps to "done"

thread 2: set VMA for arg\_ptr to PROT\_WRITE

thread 1: if (arg\_copy != NULL) ... copy\_to\_user(arg\_ptr, arg\_copy, arg\_size)

Tags:

[patch](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbugs?field.tag=patch)

## CVE References

* [2012-0951](/bugs/cve/2012-0951 "A Memory Corruption Vulnerability exi...")
* [2012-0952](/bugs/cve/2012-0952 "A heap buffer overflow was discovered...")
* [2012-0953](/bugs/cve/2012-0953 "A race condition was discovered in th...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Bryce Harrington (bryce)](https://launchpad.net/~bryce) wrote on 2012-04-12: |  |  | [#1](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/1) |
| --- | --- | --- | --- |

@Alberto, please escalate with NVIDIA as soon as possible.

@Alberto, please escalate with NVIDIA as soon as possible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jamie Strandboge (jdstrand)](https://launchpad.net/~jdstrand) wrote on 2012-04-20: |  |  | [#2](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/2) |
| --- | --- | --- | --- |

Is there any word on this?

Is there any word on this?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-04-27: |  |  | [#3](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/3) |
| --- | --- | --- | --- |

Thanks for reporting these issues. We are investigating each of the three reported issues separately.

Thanks for reporting these issues. We are investigating each of the three reported issues separately.

[Bryce Harrington (bryce)](https://launchpad.net/~bryce)
on 2012-05-07

| Changed in nvidia-graphics-drivers (Ubuntu): | |
| --- | --- |
| **importance**: | Undecided → High |
| **status**: | New → Triaged |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-05-17: |  |  | [#4](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/4) |
| --- | --- | --- | --- |

Hi everybody,

All three of these potential races/overflows should be resolved in the new 295.53 driver. Please have the original reporter verify that the resolution is satisfactory for all three issues.

Hi everybody,
All three of these potential races/overflows should be resolved in the new 295.53 driver. Please have the original reporter verify that the resolution is satisfactory for all three issues.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kees Cook (kees)](https://launchpad.net/~kees) wrote on 2012-05-17: |  |  | [#5](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/5) |
| --- | --- | --- | --- |

Thanks for working on this! Is there a patch I can review?

Thanks for working on this! Is there a patch I can review?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-05-22: |  |  | [#6](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/6) |
| --- | --- | --- | --- |

You should be able to just diff the kernel module interface layer sources between 295.49 and 295.53. I'll pull the actual individual changes to make review easier, and to filter away any unrelated changes.

You should be able to just diff the kernel module interface layer sources between 295.49 and 295.53. I'll pull the actual individual changes to make review easier, and to filter away any unrelated changes.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-06-06: |  |  | [#7](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/7) |
| --- | --- | --- | --- |

Sorry, it turned out that one of the changes required changes to non open-source portions of the driver code. They are pretty basic changes, but I'm not authorized to release the complete patch. I will post sanitized patches, which only include the open-source changes, shortly.

Sorry, it turned out that one of the changes required changes to non open-source portions of the driver code. They are pretty basic changes, but I'm not authorized to release the complete patch. I will post sanitized patches, which only include the open-source changes, shortly.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-06-06: |  |  | [#8](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/8) |
| --- | --- | --- | --- |

* [Patch for problem (1)](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178006/%2Bfiles/proclock.diff)
  [Edit](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178006)
  (2.7 KiB,
  text/plain)

The patch "proclock.diff" addresses problem (1) identified here.

The patch "ioctl.diff" addresses problems (2) and (3). Unfortunately, this patch is heavily redacted, due to the bulk of the changes having been made in non-open source parts of the driver. Note that changes to the Solaris interface layer are also redacted, due to the licensing for the Solaris driver: the Solaris interface layer changes are functionally equivalent to the Linux and FreeBSD changes.

The patch "proclock.diff" addresses problem (1) identified here.
The patch "ioctl.diff" addresses problems (2) and (3). Unfortunately, this patch is heavily redacted, due to the bulk of the changes having been made in non-open source parts of the driver. Note that changes to the Solaris interface layer are also redacted, due to the licensing for the Solaris driver: the Solaris interface layer changes are functionally equivalent to the Linux and FreeBSD changes.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Dadap (ddadap)](https://launchpad.net/~ddadap) wrote on 2012-06-06: |  |  | [#9](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/9) |
| --- | --- | --- | --- |

* [Patch for problems (2) and (3)](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178007/%2Bfiles/ioctl.diff)
  [Edit](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178007)
  (8.3 KiB,
  text/plain)

Second patch, since launchpad only allows one attachment per comment

Second patch, since launchpad only allows one attachment per comment

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kees Cook (kees)](https://launchpad.net/~kees) wrote on 2012-06-06:  [**Re: [Bug 979373] Re: heap overflows in nvidia driver**](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/10) |  |  | [#10](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/10) |
| --- | --- | --- | --- |

Thanks very much for getting these fixed and providing the patches for

review. :)

--

Kees Cook

Thanks very much for getting these fixed and providing the patches for
review. :)
--
Kees Cook

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2012-06-07: |  |  | [#11](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/11) |
| --- | --- | --- | --- |

(1) is CVE-2012-0951:

/proc/driver/nvidia/registry is vulnerable to a write race that can result in a limited heap overflow.

(2) is CVE-2012-0952:

Heap overflow in control device ioctl

(3) is CVE-2012-0953:

Kernel heap contents leak race in ioctl handler

(1) is CVE-2012-0951:
/proc/driver/nvidia/registry is vulnerable to a write race that can result in a limited heap overflow.
(2) is CVE-2012-0952:
Heap overflow in control device ioctl
(3) is CVE-2012-0953:
Kernel heap contents leak race in ioctl handler

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2012-06-20: |  |  | [#12](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/12) |
| --- | --- | --- | --- |

@Daniel:

So, have these been fixed in 295.59 now? Should we update all Ubuntu releases to that version?

What about the legacy GPU trees, have they been updated also?

@Daniel:
So, have these been fixed in 295.59 now? Should we update all Ubuntu releases to that version?
What about the legacy GPU trees, have they been updated also?

[Kees Cook (kees)](https://launchpad.net/~kees)
on 2012-07-13

| **visibility**: | private → public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ubuntu Foundations Team Bug Bot (crichton)](https://launchpad.net/~crichton) wrote on 2012-07-13: |  |  | [#13](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/13) |
| --- | --- | --- | --- |

The attachment "Patch for problem (1)" of this bug report has been identified as being a patch. The ubuntu-reviewers team has been subscribed to the bug report so that they can review the patch. In the event that this is in fact not a patch you can resolve this situation by removing the tag 'patch' from the bug report and editing the attachment so that it is not flagged as a patch. Additionally, if you are member of the ubuntu-reviewers team please also unsubscribe the team from this bug report.

[This is an automated message performed by a Launchpad user owned by Brian Murray. Please contact him regarding any issues with the action taken in this bug report.]

The attachment "Patch for problem (1)" of this bug report has been identified as being a patch. The ubuntu-reviewers team has been subscribed to the bug report so that they can review the patch. In the event that this is in fact not a patch you can resolve this situation by removing the tag 'patch' from the bug report and editing the attachment so that it is not flagged as a patch. Additionally, if you are member of the ubuntu-reviewers team please also unsubscribe the team from this bug report.
[This is an automated message performed by a Launchpad user owned by Brian Murray. Please contact him regarding any issues with the action taken in this bug report.]

| **tags**: | added: patch |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2013-09-09: |  |  | [#14](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/comments/14) |
| --- | --- | --- | --- |

All supported releases have been bumped to the 304.x drivers, so this is fix now. Closing.

All supported releases have been bumped to the 304.x drivers, so this is fix now. Closing.

| Changed in nvidia-graphics-drivers (Ubuntu): | |
| --- | --- |
| **status**: | Triaged → Fix Released |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [Patch for problem (1)](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178006/%2Bfiles/proclock.diff)
  [Edit](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178006 "Change patch details")
* [Patch for problems (2) and (3)](https://bugs.launchpad.net/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178007/%2Bfiles/ioctl.diff)
  [Edit](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Battachment/3178007 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/nvidia-graphics-drivers/%2Bbug/979373/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


