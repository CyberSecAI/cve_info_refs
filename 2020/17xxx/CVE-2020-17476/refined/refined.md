The provided content relates to CVE-2020-17476.

**Root cause of vulnerability:**
The vulnerability is due to a lack of proper sanitization of user-provided input in several parts of the Mibew Messenger application, specifically within the message posting functionality.

**Weaknesses/vulnerabilities present:**
Cross-Site Scripting (XSS) vulnerabilities exist in multiple locations where user-controlled data is displayed without proper encoding. This includes:

*   Referrer URLs
*   User-provided information fields (e.g., email, info)
*   Operator names
*   Chat messages and events
*   Visitor names and their changes

**Impact of exploitation:**
An attacker can inject malicious JavaScript code into chat messages, visitor info, or other fields. This can lead to:

*   Stealing user session cookies
*   Performing actions on behalf of a user
*   Displaying arbitrary content
*   Redirecting users to malicious websites

**Attack vectors:**
The primary attack vector is through the user interface, where an attacker could craft malicious inputs that are then stored and displayed to other users or operators. Specifically:

*   A malicious user could inject XSS via referrer URL parameters when initiating the chat.
*   A malicious user could inject XSS through the info field when leaving a message.
*   Malicious operator names could be injected when an operator is redirected, joins, or is back.
*   Malicious visitor names could inject XSS through the visitor name or when the visitor changes name.
*   An attacker could inject XSS via the email provided during surveys.
*   An attacker could inject XSS via chat messages.

**Required attacker capabilities/position:**
The attacker needs to be able to input data into the chat system, such as a visitor, and manipulate fields that are later displayed without sanitization to other users.

**Details of the fix:**
The commit `84f5bca0a90b2fe470e35e9b5121548ccce0093c` addresses the XSS issues by sanitizing the user provided data using the `safe_htmlspecialchars()` function before displaying it within messages. This function encodes HTML special characters, preventing them from being interpreted as code by the browser. The changes are visible across multiple files:

*   `src/mibew/libs/chat.php`: Sanitizes referrer, info, and operator name inputs.
*   `src/mibew/libs/classes/Mibew/Controller/ButtonController.php`: Sanitizes the referrer URL.
*  `src/mibew/libs/classes/Mibew/Controller/Chat/RedirectController.php`: Sanitizes operator name when redirection happens.
*   `src/mibew/libs/classes/Mibew/RequestProcessor/ThreadProcessor.php`: Sanitizes email, referrer, and info fields.
*   `src/mibew/libs/classes/Mibew/Thread.php`: Sanitizes operator and visitor names during different events, such as when the operator joins, returns, and when the user changes name.
*   `src/mibew/libs/invitation.php`: Sanitizes operator name and the last visited page.