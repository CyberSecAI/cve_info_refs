=== Content from launchpad.net_358978c3_20250119_131807.html ===

[Log in / Register](https://launchpad.net/~hudson-openstack/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~hudson-openstack)

## [OpenStack Infra](https://launchpad.net/~hudson-openstack)

* Overview
* [Code](https://code.launchpad.net/~hudson-openstack)
* [Bugs](https://bugs.launchpad.net/~hudson-openstack)
* [Blueprints](https://blueprints.launchpad.net/~hudson-openstack)
* [Translations](https://translations.launchpad.net/~hudson-openstack)
* [Answers](https://answers.launchpad.net/~hudson-openstack)

* [Related packages](https://launchpad.net/~hudson-openstack/%2Brelated-packages)
* [Related projects](https://launchpad.net/~hudson-openstack/%2Brelated-projects)

## User information

Launchpad Id:
hudson-openstack

Email:
[Log in](%2Blogin) for email information.

Member since:
2010-07-14

[![Icon of Burrow](https://launchpadlibrarian.net/67728214/os14.png "Member of Burrow")](/~burrow)
[![Icon of Citrix OpenStack development team](https://launchpadlibrarian.net/64472709/Citrix%2014.png "Member of Citrix OpenStack development team")](/~citrix-openstack)
[![Icon of (deprecated) OpenStack PPA maintainers](https://launchpadlibrarian.net/87891894/ppa.gif "Member of (deprecated) OpenStack PPA maintainers")](/~openstack-ppa)
[![Icon of Designate Core](https://launchpadlibrarian.net/360468328/designate_14.jpg "Member of Designate Core")](/~designate-core)
[![Icon of Designate Drivers](https://launchpadlibrarian.net/360468067/designate_14.jpg "Member of Designate Drivers")](/~designate-drivers)
[![Icon of MidoNet Bugs](https://launchpadlibrarian.net/228074955/midonet_14x14.png "Member of MidoNet Bugs")](/~midonet-bugs)
[![Icon of Nova Bug Team](https://launchpadlibrarian.net/108832444/bug.gif "Member of Nova Bug Team")](/~nova-bugs)
[![Icon of Nova](https://launchpadlibrarian.net/52560219/os14.png "Member of Nova")](/~nova)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)

Languages:

English

OpenPGP keys:

72571ACC301E6FE900837F5CDF85501232EE128C

SSH keys:

[hudson@hudson](%2Bsshkeys)

[jenkins@vpcslave](%2Bsshkeys)

Time zone:

UTC
(UTC+0000)

Karma:
[6656](https://launchpad.net/~hudson-openstack/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## [All memberships](https://launchpad.net/~hudson-openstack/%2Bparticipation) Latest memberships

| [Compute Hyper-V Bugs](/~compute-hyperv-bugs)  Joined on 2019-08-28 | |
| --- | --- |
| [OS-Win Bugs](/~os-win-bugs)  Joined on 2019-08-28 | |
| [Networking Hyper-V Bugs](/~networking-hyperv-bugs)  Joined on 2019-08-28 | |
| [kolla-drivers](/~kolla-drivers)  Joined on 2019-05-20 | |
| [fixtures-git-bugs](/~fixtures-git-bugs)  Joined on 2018-03-25 | |

## [Recent activities](https://launchpad.net/~hudson-openstack/%2Bkarma) Most active in

| [StarlingX](/starlingx) |  |
| --- | --- |
| [kolla-ansible](/kolla-ansible) |  |
| [kolla](/kolla) |  |
| [kayobe](/kayobe) |  |
| [OpenStack Compute (nova)](/nova) |  |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from security.openstack.org_88681d81_20250119_112543.html ===


Toggle navigation

 Search

* [Software](https://www.openstack.org/software/)
  + [Overview](https://www.openstack.org/software/)
  + [OpenStack Components](https://www.openstack.org/software/project-navigator/openstack-components)
  + [SDKs](https://www.openstack.org/software/project-navigator/sdks)
  + [Deployment Tools](https://www.openstack.org/software/project-navigator/deployment-tools)
  + [OpenStack Map](https://www.openstack.org/assets/software/projectmap/openstack-map.pdf)
  + [Sample Configs](https://www.openstack.org/software/sample-configs/)
* [Use Cases](https://www.openstack.org/use-cases/)
  + [Users in Production](https://www.openstack.org/use-cases/)
  + [Ironic Bare Metal](https://www.openstack.org/use-cases/bare-metal/)
  + [Edge Computing](https://www.openstack.org/use-cases/edge-computing/)
  + [Telecom & NFV](https://www.openstack.org/use-cases/telecoms-and-nfv/)
  + [Science and HPC](https://www.openstack.org/use-cases/science/)
  + [Containers](https://www.openstack.org/use-cases/containers/)
  + [Enterprise](https://www.openstack.org/use-cases/enterprise/)
  + [User Survey](https://www.openstack.org/surveys/landing)
* [Events](https://openinfra.dev/summit)
  + [OpenInfra Summit](https://openinfra.dev/summit)
  + [Project Teams Gathering](https://www.openstack.org/ptg/)
  + [OpenDev](https://www.openstack.org/events/opendev-2020/)
  + [Community Events](https://www.openstack.org/events/community-events/)
  + [OpenStack & OpenInfra Days](https://www.openstack.org/events/openstackdays)
  + [Summit Videos](https://www.openstack.org/videos/)
* [Community](https://www.openstack.org/community/)
  + [Welcome! Start Here](https://www.openstack.org/community/)
  + [OpenStack Technical Committee](https://www.openstack.org/community/tech-committee)
  + [Speakers Bureau](https://www.openstack.org/community/speakers/)
  + [OpenStack Wiki](http://wiki.openstack.org)
  + [Get Certified (COA)](https://www.openstack.org/coa/)
  + [Jobs](https://www.openstack.org/community/jobs/)
  + [Marketing Resources](https://www.openstack.org/marketing/)
  + [Community News](https://www.openstack.org/news/)
  + [Superuser Magazine](http://superuser.openstack.org)
  + [OpenInfra Foundation Supporting Organizations](https://www.openstack.org/community/supporting-organizations/)
  + [OpenInfra Foundation](https://openinfra.dev)
* [Marketplace](https://www.openstack.org/marketplace/)
  + [Training](https://www.openstack.org/marketplace/training/)
  + [Distros & Appliances](https://www.openstack.org/marketplace/distros/)
  + [Public Clouds](https://www.openstack.org/marketplace/public-clouds/)
  + [Hosted Private Clouds](https://www.openstack.org/marketplace/hosted-private-clouds/)
  + [Remotely Managed Private Clouds](https://www.openstack.org/marketplace/remotely-managed-private-clouds/)
  + [Consulting & Integrators](https://www.openstack.org/marketplace/consulting/)
  + [Drivers](https://www.openstack.org/marketplace/drivers/)
* [Blog](https://www.openstack.org/blog/)
* [Docs](http://docs.openstack.org/)
* [Join](https://openinfra.dev/join/)
  + [Sign up for Foundation Membership](https://openinfra.dev/join/)
  + [Sponsor the Foundation](https://openinfra.dev/join/)
  + [More about the Foundation](https://openinfra.dev)
* [Log In](https://www.openstack.org/Security/login/?BackURL=/home/)

# OSSA-2020-004: Keystone credential endpoints allow owner modification and are not protected from a scoped context

# OSSA-2020-004: Keystone credential endpoints allow owner modification and are not protected from a scoped context[Â¶](#ossa-2020-004-keystone-credential-endpoints-allow-owner-modification-and-are-not-protected-from-a-scoped-context "Link to this heading")

Date:

May 06, 2020

CVE:

CVE-2020-12689,
CVE-2020-12691

## Affects[Â¶](#affects "Link to this heading")

* Keystone: <15.0.1, ==16.0.0

## Description[Â¶](#description "Link to this heading")

kay reported two vulnerabilities in keystoneâs EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. (CVE-2020-12691)
Any authenticated user within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining admin while the user is on a limited viewer role. (CVE-2020-12689)
Both of these vulnerabilities potentially allow a malicious user to act as admin on a project that another user has the admin role on, which can effectively grant the malicious user global admin privileges.

## Errata[Â¶](#errata "Link to this heading")

CVE-2020-12689 and CVE-2020-12691 were assigned after the original publication date.

## Patches[Â¶](#patches "Link to this heading")

* <https://review.opendev.org/725895> (Rocky)
* <https://review.opendev.org/725893> (Stein)
* <https://review.opendev.org/725891> (Train)
* <https://review.opendev.org/725888> (Ussuri)
* <https://review.opendev.org/725886> (Victoria)

## Credits[Â¶](#credits "Link to this heading")

* kay (CVE-2020-12689, CVE-2020-12691)

## References[Â¶](#references "Link to this heading")

* <https://launchpad.net/bugs/1872733>
* <https://launchpad.net/bugs/1872735>
* <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12689>
* <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12691>

## Notes[Â¶](#notes "Link to this heading")

* The stable/rocky branch is under extended maintenance and will receive
  no new point releases, but a patch for it is provided as a courtesy.

## OSSA History[Â¶](#ossa-history "Link to this heading")

* 2020-05-07 - Errata 1
* 2020-05-06 - Original Version

this page last updated: 2025-01-07 18:17:35

[![Creative Commons Attribution 3.0 License](../_static/images/docs/license.png)](https://creativecommons.org/licenses/by/3.0/)

Except where otherwise noted, this document is licensed under
[Creative Commons
Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/). See all [OpenStack Legal Documents](https://www.openstack.org/legal).

found an error? report a bug

OpenStack Documentation

* Guides
* [Install Guides](https://docs.openstack.org/index.html#install-guides)
* [User Guides](https://docs.openstack.org/index.html#user-guides)
* [Configuration Guides](https://docs.openstack.org/index.html#configuration-guides)
* [Operations and Administration Guides](https://docs.openstack.org/index.html#ops-and-admin-guides)
* [API Guides](https://docs.openstack.org/index.html#api-guides)
* [Contributor Guides](https://docs.openstack.org/index.html#contributor-guides)
* Languages
* [Deutsch (German)](https://docs.openstack.org/de/)
* [FranÃ§ais (French)](https://docs.openstack.org/fr/)
* [Bahasa Indonesia (Indonesian)](https://docs.openstack.org/id/)
* [Italiano (Italian)](https://docs.openstack.org/it/)
* [æ¥æ¬èª (Japanese)](https://docs.openstack.org/ja/)
* [íêµ­ì´ (Korean)](https://docs.openstack.org/ko_KR/)
* [PortuguÃªs (Portuguese)](https://docs.openstack.org/pt_BR/)
* [TÃ¼rkÃ§e (TÃ¼rkiye)](https://docs.openstack.org/tr_TR/)
* [ç®ä½ä¸­æ (Simplified Chinese)](https://docs.openstack.org/zh_CN/)

#### Contents

* OSSA-2020-004: Keystone credential endpoints allow owner modification and are not protected from a scoped context
  + [Affects](#affects)
  + [Description](#description)
  + [Errata](#errata)
  + [Patches](#patches)
  + [Credits](#credits)
  + [References](#references)
  + [Notes](#notes)
  + [OSSA History](#ossa-history)

### OpenStack

* [Projects](https://www.openstack.org/software/project-navigator/)
* [OpenStack Security](https://security.openstack.org/)
* [Blog](https://openstack.org/blog/)
* [News](https://openstack.org/news/)

### Community

* [User Groups](https://www.meetup.com/pro/openinfradev/)
* [Events](https://openstack.org/community/events/)
* [Jobs](https://openstack.org/community/jobs/)
* [Companies](https://openinfra.dev/members/)
* [Contribute](https://docs.openstack.org/contributors)

### Documentation

* [OpenStack Manuals](https://docs.openstack.org)
* [Getting Started](https://openstack.org/software/start/)
* [API Documentation](https://developer.openstack.org)
* [Wiki](https://wiki.openstack.org)

### Branding & Legal

* [Legal Docs](https://openinfra.dev/legal)
* [Logos & Guidelines](https://openstack.org/brand/)
* [Trademark Policy](https://openinfra.dev/legal/trademark-policy)
* [Privacy Policy](https://openinfra.dev/privacy-policy)
* [OpenInfra CLA](https://docs.openstack.org/contributors/common/setup-gerrit.html#individual-contributor-license-agreement)

### Stay In Touch

The OpenStack project is provided under the
[Apache 2.0 license](https://www.apache.org/licenses/LICENSE-2.0). Docs.openstack.org is powered by
[Rackspace Cloud Computing](https://rackspace.com).



=== Content from lists.apache.org_17ad87bd_20250119_112543.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from www.openwall.com_171a6363_20250119_112544.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](4) [[next>]](6) [[thread-next>]](../../../2020/05/07/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAE4Awf_qX8osK8cvGF=+1Lozp9+TR442K7KDSATX_zJE2EW9Gg@mail.gmail.com>
Date: Wed, 6 May 2020 14:49:25 -0500
From: Gage Hugo <gagehugo@...il.com>
To: oss-security@...ts.openwall.com
Subject: [OSSA-2020-004] Keystone: Keystone credential endpoints allow owner
 modification and are not protected from a scoped context (CVE PENDING)

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

=================================================================================================================
OSSA-2020-004: Keystone credential endpoints allow owner modification and
are not protected from a scoped context
=================================================================================================================

:Date: May 06, 2020
:CVE: Pending

Affects
~~~~~~~
- - Keystone: <15.0.1, ==16.0.0

Description
~~~~~~~~~~~
kay reported two vulnerabilities in keystone's EC2 credentials API.
Any authenticated user could create an EC2 credential for themselves
for a project that they have a specified role on, then perform an
update to the credential user and project, allowing them to masquerade
as another user. (CVE #1 PENDING) Any authenticated user within a
limited scope (trust/oauth/application credential) can create an EC2
credential with an escalated permission, such as obtaining admin while
the user is on a limited viewer role. (CVE #2 PENDING) Both of these
vulnerabilities potentially allow a malicious user to act as admin on
a project that another user has the admin role on, which can
effectively grant the malicious user global admin privileges.

Patches
~~~~~~~
- - <https://review.opendev.org/725895> (Rocky)
- - <https://review.opendev.org/725893> (Stein)
- - <https://review.opendev.org/725891> (Train)
- - <https://review.opendev.org/725888> (Ussuri)
- - <https://review.opendev.org/725886> (Victoria)

Credits
~~~~~~~
- - kay (CVE Pending)

References
~~~~~~~~~~
- - <https://launchpad.net/bugs/1872733>
- - <https://launchpad.net/bugs/1872735>
- - <http://cve.mitre.org/cgi-bin/cvename.cgi?name=Pending>

Notes
~~~~~
- - The stable/rocky branch is under extended maintenance and will receive
no new
  point releases, but a patch for it is provided as a courtesy.
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEWa125cLHIuv6ekof56j9K3b+vREFAl6zE70ACgkQ56j9K3b+
vREQsBAAnHZLyrbjSwu7/CEdDVfb0sQZfDvyuXMttzouXQ6ZwEgLFKzc/aFWMjru
loyst9jAx2pJzvxDfMYO11oU0M5tYFCFxhKsVvu+3ggbcNHeov1s25bPkxE7A2j7
IYJj9b+bbieYVj1ru3FJjDl3iTae4K73DeHNBCdxTSeahJZdya7hiboA1VJFt4p7
fNqU3+szsYt/vwspPBi7x+xnZszIMaUw8tVgxzB4KVD6YXbDR9Mp7itH77kGdn8l
e3OpnURvfaIkPbK6fqE6jjwjQEL/6+Ahffaf4KqvsdjbAcdQRpK0UQrBX+n6DIWd
TRwV/W7bEy64HrC16W78fcBlegRmEUUM4xNmdll3lwUS5KqfEeM3vXU4Ksfe9tQ2
8fDU1hDALcC55+2CMMrdFfmX/MBSTz0HVmP4snaGuoXBL/iQz22OmekFKC1tmXxb
+vAtOUBsdzphRZn9KWvPIHOFGeuepWb9W0eN594JT2pdHfniLj6EaPrBaN63l7M/
pu0DTPygN5IdUXv6v/vquQZp50CaN59okmXDNiFkBeHsfaAqhdyjJjRaYvyU62OA
apjVam8/f2HM0RC0vvpIqv0z0kU55NPCo61dlMZPg6U9JiQd2PzBqvEtDF1lyByF
vz5e+r9fmtRcgCJIYr0Z7VlOlSMONpITN03oICaexieDTEXDXHc=
=lSDG
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from usn.ubuntu.com_90de5a6c_20250119_112544.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4480-1: OpenStack Keystone vulnerabilities

1 September 2020

Several security issues were fixed in OpenStack Keystone.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 18.04 ESM](/security/notices?release=bionic)

## Packages

* [keystone](/security/cves?package=keystone) - OpenStack identity service

## Details

It was discovered that OpenStack Keystone incorrectly handled EC2

credentials. An authenticated attacker with a limited scope could possibly

create EC2 credentials with escalated permissions. ([CVE-2020-12689](/security/CVE-2020-12689),

[CVE-2020-12691](/security/CVE-2020-12691))

It was discovered that OpenStack Keystone incorrectly handled the list of

roles provided with OAuth1 access tokens. An authenticated user could

possibly end up with more role assignments than intended. ([CVE-2020-12690](/security/CVE-2020-12690))

It was discovered that OpenStack Keystone incorrectly handled EC2 signature

TTL checks. A remote attacker could possibly use this issue to reuse

Authorization headers. ([CVE-2020-12692](/security/CVE-2020-12692))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 18.04

* [keystone](https://launchpad.net/ubuntu/%2Bsource/keystone)
  -
  [2:13.0.4-0ubuntu1](https://launchpad.net/ubuntu/%2Bsource/keystone/2%3A13.0.4-0ubuntu1)
* [python-keystone](https://launchpad.net/ubuntu/%2Bsource/keystone)
  -
  [2:13.0.4-0ubuntu1](https://launchpad.net/ubuntu/%2Bsource/keystone/2%3A13.0.4-0ubuntu1)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2020-12689](/security/CVE-2020-12689)
* [CVE-2020-12690](/security/CVE-2020-12690)
* [CVE-2020-12691](/security/CVE-2020-12691)
* [CVE-2020-12692](/security/CVE-2020-12692)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from review.opendev.org_2df6904f_20250119_131806.html ===




=== Content from review.opendev.org_a91b497d_20250119_131804.html ===




=== Content from review.opendev.org_f0fde495_20250119_131804.html ===




=== Content from launchpad.net_697430ff_20250119_131802.html ===

[Log in / Register](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Blogin)

[![](https://launchpadlibrarian.net/359059841/OpenStack_Project_Keystone_mascot%20%281%29.png)](https://launchpad.net/keystone)

## [OpenStack Identity (keystone)](https://launchpad.net/keystone)

* [Overview](https://launchpad.net/keystone)
* [Code](https://code.launchpad.net/keystone)
* [Bugs](https://bugs.launchpad.net/keystone)
* [Blueprints](https://blueprints.launchpad.net/keystone)
* [Translations](https://translations.launchpad.net/keystone)
* [Answers](https://answers.launchpad.net/keystone)

# [OSSA-2020-004] EC2 and/or credential endpoints are not protected from a scoped context (CVE-2020-12689)

Bug #1872735 reported by
[kay](https://launchpad.net/~kay-diam)
on 2020-04-14

[266](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Identity (keystone)](https://bugs.launchpad.net/keystone) | Fix Released | High | [Colleen Murphy](https://launchpad.net/~krinkle) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Undecided | Unassigned |  |

### Bug Description

Being authorized within a limited scope context, i.e. trust / oauth / application credential with a limited role, e.g. "monitoring\_viewer" or "viewer", it is still possible to create EC2 credentials. User can auth against Keystone using EC2 credentials and obtain all project roles

 of a trust/oauth/application\_credential owner.

I prepared a tool to auth against keyston using ec2 credentials: <https://github.com/kayrus/ec2auth>

\* auth against keystone using trust/oauth/application\_credential credentials

\* issue ec2 credentials: "openstack ec2 credentials create"

\* authenticate against keystone using ec2 credentials: "ec2auth --access 7522162ced8f4e3eb9502168ef199584 --secret c558d9401a6943bbbb77a83ce910e5a5 --debug"

You'll see that returned token contains all owner roles.

See [original description](comments/0)

Tags:

[in-stable-pike](/keystone/%2Bbugs?field.tag=in-stable-pike)
[in-stable-queens](/keystone/%2Bbugs?field.tag=in-stable-queens)
[in-stable-rocky](/keystone/%2Bbugs?field.tag=in-stable-rocky)
[in-stable-stein](/keystone/%2Bbugs?field.tag=in-stable-stein)
[in-stable-train](/keystone/%2Bbugs?field.tag=in-stable-train)
[in-stable-ussuri](/keystone/%2Bbugs?field.tag=in-stable-ussuri)

## CVE References

* [2020-12689](/bugs/cve/2020-12689 "An issue was discovered in OpenStack ...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-14: |  |  | [#1](/keystone/%2Bbug/1872735/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete

security advisory task has been added while the core security

reviewers for the affected project or projects confirm the bug and

discuss the scope of any vulnerability along with potential

solutions.

Since this report concerns a possible security risk, an incomplete
security advisory task has been added while the core security
reviewers for the affected project or projects confirm the bug and
discuss the scope of any vulnerability along with potential
solutions.

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-14: |  |  | [#2](/keystone/%2Bbug/1872735/comments/2) |
| --- | --- | --- | --- |

* [ec2.example.2](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5354179/%2Bfiles/ec2.example.2)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5354179)
  (3.4 KiB,
  text/plain)

Attached is what I get when I use your tool to authenticate with an ec2 credential for a user who only has the "reader" role on the "demo" project. The token only contains the "reader" role, which is expected. Any project-scoped request the user makes will be limited by that role.

Attached is what I get when I use your tool to authenticate with an ec2 credential for a user who only has the "reader" role on the "demo" project. The token only contains the "reader" role, which is expected. Any project-scoped request the user makes will be limited by that role.

| Changed in keystone: | |
| --- | --- |
| **status**: | New → Invalid |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-15: |  |  | [#3](/keystone/%2Bbug/1872735/comments/3) |
| --- | --- | --- | --- |

* [test.log](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5354359/%2Bfiles/test.log)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5354359)
  (12.7 KiB,
  text/plain)

Hi Colleen. Sorry for not being clear enough. I was talking about creating EC2 credentials under "trust / oauth / application credential". For instance, when your base user has "admin" and "viewer" roles, you create "application credential" with a "viewer" and expect that "application credential" won't be able to escalate privileges to "admin".

However being authed using "application credential" with a "viewer" role allows to create EC2 credentials, which are associated with a parent user. Therefore "application credential" with a "viewer" role can successfully escalate privileges to "admin".

I uploaded more detailed JSON logs for convenience. Note that I created "application credential" with a limited "monitoring\_viewer" role, then created "ec2 credentials" within "application credential" scope, and escalated privileges to parent user roles.

Hi Colleen. Sorry for not being clear enough. I was talking about creating EC2 credentials under "trust / oauth / application credential". For instance, when your base user has "admin" and "viewer" roles, you create "application credential" with a "viewer" and expect that "application credential" won't be able to escalate privileges to "admin".
However being authed using "application credential" with a "viewer" role allows to create EC2 credentials, which are associated with a parent user. Therefore "application credential" with a "viewer" role can successfully escalate privileges to "admin".
I uploaded more detailed JSON logs for convenience. Note that I created "application credential" with a limited "monitoring\_viewer" role, then created "ec2 credentials" within "application credential" scope, and escalated privileges to parent user roles.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#4](/keystone/%2Bbug/1872735/comments/4) |
| --- | --- | --- | --- |

Thanks for the clarification, I've now reproduced this.

Thanks for the clarification, I've now reproduced this.

| Changed in keystone: | |
| --- | --- |
| **status**: | Invalid → Triaged |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#5](/keystone/%2Bbug/1872735/comments/5) |
| --- | --- | --- | --- |

This sounds like a class A report for a privilege escalation vulnerability:

<https://security.openstack.org/vmt-process.html#incident-report-taxonomy>

This sounds like a class A report for a privilege escalation vulnerability:
https://security.openstack.org/vmt-process.html#incident-report-taxonomy

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#6](/keystone/%2Bbug/1872735/comments/6) |
| --- | --- | --- | --- |

* [0001-Respect-token-roles-when-creating-EC2-credentials.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5355250/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5355250)
  (22.4 KiB,
  text/plain)

Attaching a fix for this. Running tempest and unit tests locally.

Attaching a fix for this. Running tempest and unit tests locally.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-16: |  |  | [#7](/keystone/%2Bbug/1872735/comments/7) |
| --- | --- | --- | --- |

> OAUTH1 tokens already always contain all of the roles the authorizing user has on the requested project, ignoring the authorized roles that are stored with the access token during the authorization request.

Hi Colleen, thanks for a fix. I read the "<https://docs.openstack.org/api-ref/identity/v3-ext/?expanded=authorize-request-token-detail#authorize-request-token>" and I'm confused, why does the request contain roles list?

<https://github.com/openstack/keystone/blob/7bb6314e40d6947294260324e84a58de191f8609/keystone/api/os_oauth1.py#L287>

Do I miss something?

> OAUTH1 tokens already always contain all of the roles the authorizing user has on the requested project, ignoring the authorized roles that are stored with the access token during the authorization request.
Hi Colleen, thanks for a fix. I read the "https://docs.openstack.org/api-ref/identity/v3-ext/?expanded=authorize-request-token-detail#authorize-request-token" and I'm confused, why does the request contain roles list?
https://github.com/openstack/keystone/blob/7bb6314e40d6947294260324e84a58de191f8609/keystone/api/os\_oauth1.py#L287
Do I miss something?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#8](/keystone/%2Bbug/1872735/comments/8) |
| --- | --- | --- | --- |

> I'm confused, why does the request contain roles list?

I find this confusing too. Let me know if you see the same behavior. I don't think it's the intended behavior but as far as I can tell it's either always been that way or has for a long time, and wasn't discovered because it used to be rare to have more than one role assignment on a project.

I think it's fixable but the patch for this bug was already getting dense. I think opening a second (public?) bug might be worthwhile.

> I'm confused, why does the request contain roles list?
I find this confusing too. Let me know if you see the same behavior. I don't think it's the intended behavior but as far as I can tell it's either always been that way or has for a long time, and wasn't discovered because it used to be rare to have more than one role assignment on a project.
I think it's fixable but the patch for this bug was already getting dense. I think opening a second (public?) bug might be worthwhile.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#9](/keystone/%2Bbug/1872735/comments/9) |
| --- | --- | --- | --- |

> Attaching a fix for this. Running tempest and unit tests locally.

Tempest and py37/pep8 tests passed for me locally.

> Attaching a fix for this. Running tempest and unit tests locally.
Tempest and py37/pep8 tests passed for me locally.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-16: |  |  | [#10](/keystone/%2Bbug/1872735/comments/10) |
| --- | --- | --- | --- |

> I think opening a second (public?) bug might be worthwhile.

To be on the safe side, I'd open a private issue for this, because "openstack request token authorize" requires a role definition and "OAuth1 trustor" user expects that oauth1 token will be limited to this role, but it this role is ignored by Keystone: [https://bugs.launchpad.net/keystone/+bug/1873290](https://bugs.launchpad.net/keystone/%2Bbug/1873290)

> I think opening a second (public?) bug might be worthwhile.
To be on the safe side, I'd open a private issue for this, because "openstack request token authorize" requires a role definition and "OAuth1 trustor" user expects that oauth1 token will be limited to this role, but it this role is ignored by Keystone: https://bugs.launchpad.net/keystone/+bug/1873290

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#11](/keystone/%2Bbug/1872735/comments/11) |
| --- | --- | --- | --- |

* [0001-Respect-token-roles-when-creating-EC2-credentials.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5355722/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5355722)
  (22.7 KiB,
  text/plain)

Updated release note to include bug reference

Updated release note to include bug reference

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-16: |  |  | [#12](/keystone/%2Bbug/1872735/comments/12) |
| --- | --- | --- | --- |

Given the interrelationship, should we try to cover this and [bug 1873290](/bugs/1873290) in the same advisory, or write them up and disclose them independently when the time comes?

Given the interrelationship, should we try to cover this and bug 1873290 in the same advisory, or write them up and disclose them independently when the time comes?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-16: |  |  | [#13](/keystone/%2Bbug/1872735/comments/13) |
| --- | --- | --- | --- |

Colleen's patch looks fine, would like another pair of eyes on it as well as it touches a bit more logic here.

Colleen's patch looks fine, would like another pair of eyes on it as well as it touches a bit more logic here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristi Nikolla (knikolla)](https://launchpad.net/~knikolla) wrote on 2020-04-17: |  |  | [#14](/keystone/%2Bbug/1872735/comments/14) |
| --- | --- | --- | --- |

Colleen's patch at #11 looks good and the test correctly covers the issue. The release note also accurately describes the problem and solution.

Colleen's patch at #11 looks good and the test correctly covers the issue. The release note also accurately describes the problem and solution.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lance Bragstad (lbragstad)](https://launchpad.net/~lbragstad) wrote on 2020-04-17: |  |  | [#15](/keystone/%2Bbug/1872735/comments/15) |
| --- | --- | --- | --- |

+2 on Colleen's patch in comment #11.

+2 on Colleen's patch in comment #11.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-17: |  |  | [#16](/keystone/%2Bbug/1872735/comments/16) |
| --- | --- | --- | --- |

> Given the interrelationship, should we try to cover this and [bug 1873290](/bugs/1873290) in the same advisory, or write them up and disclose them independently when the time comes?

Although they are separate problems, the solution to [bug 1873290](/bugs/1873290) is closely related to the solution to this one so I think it's not possible to safely disclose them separately.

> Given the interrelationship, should we try to cover this and bug 1873290 in the same advisory, or write them up and disclose them independently when the time comes?
Although they are separate problems, the solution to bug 1873290 is closely related to the solution to this one so I think it's not possible to safely disclose them separately.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-21: |  |  | [#17](/keystone/%2Bbug/1872735/comments/17) |
| --- | --- | --- | --- |

Below is a rough draft for an impact description for this bug, please review it for any changes.

I assumed this will not get fixed before ussuri release as we will need this impact before obtaining a CVE.

Also @kay, if there is another name/alias you wish to go by, please feel free to correct me.

Title: EC2 and/or credential endpoints are not protected from a scoped context

Reporter: kay (kay-diam)

Products: Keystone

Affects: ==15.0.0, ==16.0.0, ==17.0.0

Description:

kay (kay-diam) reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Below is a rough draft for an impact description for this bug, please review it for any changes.
I assumed this will not get fixed before ussuri release as we will need this impact before obtaining a CVE.
Also @kay, if there is another name/alias you wish to go by, please feel free to correct me.
Title: EC2 and/or credential endpoints are not protected from a scoped context
Reporter: kay (kay-diam)
Products: Keystone
Affects: ==15.0.0, ==16.0.0, ==17.0.0
Description:
kay (kay-diam) reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-21: |  |  | [#18](/keystone/%2Bbug/1872735/comments/18) |
| --- | --- | --- | --- |

> Affects: ==15.0.0, ==16.0.0, ==17.0.0

I think this affects Rocky too, which is 14.0.0. Will verify shortly.

<https://opendev.org/openstack/keystone/src/branch/stable/rocky/keystone/contrib/ec2/controllers.py#L148-L150>

<https://opendev.org/openstack/keystone/src/branch/stable/rocky/keystone/contrib/ec2/controllers.py#L296-L298>

> Any user authenticated within a limited scope ... can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

This look okay to me, though I think it overestimates the problem slightly. The user who is exploiting this can only assume the role assignments that the delegator currently has on the project, which might not necessarily be as bad as admin. But if the impact description is meant to illustrate the worst-case scenario then this looks fine to me.

> Affects: ==15.0.0, ==16.0.0, ==17.0.0
I think this affects Rocky too, which is 14.0.0. Will verify shortly.
https://opendev.org/openstack/keystone/src/branch/stable/rocky/keystone/contrib/ec2/controllers.py#L148-L150
https://opendev.org/openstack/keystone/src/branch/stable/rocky/keystone/contrib/ec2/controllers.py#L296-L298
> Any user authenticated within a limited scope ... can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.
This look okay to me, though I think it overestimates the problem slightly. The user who is exploiting this can only assume the role assignments that the delegator currently has on the project, which might not necessarily be as bad as admin. But if the impact description is meant to illustrate the worst-case scenario then this looks fine to me.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-21: |  |  | [#19](/keystone/%2Bbug/1872735/comments/19) |
| --- | --- | --- | --- |

Examples in advisories will typically illustrate worst-case scenarios, but we use terms like "can," "could," "may," or "might" so as to avoid writing in absolutes and make it apparent that the severity of the impact depends greatly on situational variables.

As for whether this can be disclosed soon enough to make it into Ussuri, final release candidates aren't due until May 8. If we took the day before as the proposed disclosure date (which would admittedly be cutting it close), then we would need a suitable impact description and working backports no later than May 4. If we had those any time between now and April 25, we could set a disclosure date of April 28 (too late for RC1 so would need to be committed to both master and stable/ussuri branches, but still well in time for the release). Timeframes for coordinated disclosure are calculated per the rules outlined here: <https://security.openstack.org/vmt-process.html#embargoed-disclosure>

Also, the reporter detail in parentheses would typically be Kay's employer or other affiliated organization they wanted to credit along with their name.

Examples in advisories will typically illustrate worst-case scenarios, but we use terms like "can," "could," "may," or "might" so as to avoid writing in absolutes and make it apparent that the severity of the impact depends greatly on situational variables.
As for whether this can be disclosed soon enough to make it into Ussuri, final release candidates aren't due until May 8. If we took the day before as the proposed disclosure date (which would admittedly be cutting it close), then we would need a suitable impact description and working backports no later than May 4. If we had those any time between now and April 25, we could set a disclosure date of April 28 (too late for RC1 so would need to be committed to both master and stable/ussuri branches, but still well in time for the release). Timeframes for coordinated disclosure are calculated per the rules outlined here: https://security.openstack.org/vmt-process.html#embargoed-disclosure
Also, the reporter detail in parentheses would typically be Kay's employer or other affiliated organization they wanted to credit along with their name.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-21: |  |  | [#20](/keystone/%2Bbug/1872735/comments/20) |
| --- | --- | --- | --- |

> > Affects: ==15.0.0, ==16.0.0, ==17.0.0

> I think this affects Rocky too, which is 14.0.0. Will verify shortly.

Verified this affects Rocky.

> > Affects: ==15.0.0, ==16.0.0, ==17.0.0
> I think this affects Rocky too, which is 14.0.0. Will verify shortly.
Verified this affects Rocky.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-21: |  |  | [#21](/keystone/%2Bbug/1872735/comments/21) |
| --- | --- | --- | --- |

Updated, please review:

Title: EC2 and/or credential endpoints are not protected from a scoped context

Reporter: kay

Products: Keystone

Affects: >=14.0.0 <=14.2.0, ==15.0.0, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Updated, please review:
Title: EC2 and/or credential endpoints are not protected from a scoped context
Reporter: kay
Products: Keystone
Affects: >=14.0.0 <=14.2.0, ==15.0.0, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-21: |  |  | [#22](/keystone/%2Bbug/1872735/comments/22) |
| --- | --- | --- | --- |

> Verified this affects Rocky.

I was off by one in my head, I forgot that Rocky just went to EM. I interpret <https://security.openstack.org/vmt-process.html#supported-versions> to mean we don't need to support fixes for Rocky? (a lot of the controller code changed between Rocky and Stein so the backport is a pain)

> Verified this affects Rocky.
I was off by one in my head, I forgot that Rocky just went to EM. I interpret https://security.openstack.org/vmt-process.html#supported-versions to mean we don't need to support fixes for Rocky? (a lot of the controller code changed between Rocky and Stein so the backport is a pain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-22: |  |  | [#23](/keystone/%2Bbug/1872735/comments/23) |
| --- | --- | --- | --- |

Yes, if Rocky has entered extended maintenance now for Keystone, there will be no new Rocky stable point release which includes the fix (even if the stable/rocky branch gets a backport of it under extended maintenance). We usually try to refer to ranges with inequalities excluding the next highest possible version number, which for Stein would be 15.0.1. When there's only a singular version in the range, like with 16.0.0 for Train, an equivalency is acceptable. There should be no need to mention 17.0.0 unless the fix does not get backported into stable/ussuri prior to Ussuri release day. As such, an accurate impact would include...

Affects: <15.0.1, ==16.0.0

Yes, if Rocky has entered extended maintenance now for Keystone, there will be no new Rocky stable point release which includes the fix (even if the stable/rocky branch gets a backport of it under extended maintenance). We usually try to refer to ranges with inequalities excluding the next highest possible version number, which for Stein would be 15.0.1. When there's only a singular version in the range, like with 16.0.0 for Train, an equivalency is acceptable. There should be no need to mention 17.0.0 unless the fix does not get backported into stable/ussuri prior to Ussuri release day. As such, an accurate impact would include...
Affects: <15.0.1, ==16.0.0

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-22: |  |  | [#24](/keystone/%2Bbug/1872735/comments/24) |
| --- | --- | --- | --- |

Updated, please review:

Title: EC2 and/or credential endpoints are not protected from a scoped context

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Updated, please review:
Title: EC2 and/or credential endpoints are not protected from a scoped context
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-22: |  |  | [#25](/keystone/%2Bbug/1872735/comments/25) |
| --- | --- | --- | --- |

Also, the "and/or" in the title should probably just be "and" as that's more inclusive and less likely to lead to confusion if someone has both.

Also, the "and/or" in the title should probably just be "and" as that's more inclusive and less likely to lead to confusion if someone has both.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-22: |  |  | [#26](/keystone/%2Bbug/1872735/comments/26) |
| --- | --- | --- | --- |

Updated, please review:

Title: EC2 and credential endpoints are not protected from a scoped context

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Updated, please review:
Title: EC2 and credential endpoints are not protected from a scoped context
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any user authenticated within a limited scope (trust/oauth/application credential) can create an EC2 credential with an escalated permission, such as obtaining "admin" while the user is on a limited "viewer" role.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#27](/keystone/%2Bbug/1872735/comments/27) |
| --- | --- | --- | --- |

The impact description looks fine to me.

The impact description looks fine to me.

| Changed in keystone: | |
| --- | --- |
| **status**: | Triaged → In Progress |
| **assignee**: | nobody → Colleen Murphy (krinkle) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-27: |  |  | [#28](/keystone/%2Bbug/1872735/comments/28) |
| --- | --- | --- | --- |

I agree, Gage's impact description in comment #26 looks ready for a CVE assignment request.

Separately, it seems we've reached some consensus that we should switch [bug 1872755](/bugs/1872755) to public at the same time this report is officially disclosed.

I agree, Gage's impact description in comment #26 looks ready for a CVE assignment request.
Separately, it seems we've reached some consensus that we should switch bug 1872755 to public at the same time this report is officially disclosed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-28: |  |  | [#29](/keystone/%2Bbug/1872735/comments/29) |
| --- | --- | --- | --- |

Awaiting CVE, does the patch here apply cleanly to Stein/Train as well?

Awaiting CVE, does the patch here apply cleanly to Stein/Train as well?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-28: |  |  | [#30](/keystone/%2Bbug/1872735/comments/30) |
| --- | --- | --- | --- |

* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363000/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-train)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363000)
  (23.2 KiB,
  text/plain)

The patch does not apply cleanly. Attaching the modified backports for stein and train.

The patch does not apply cleanly. Attaching the modified backports for stein and train.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-28: |  |  | [#31](/keystone/%2Bbug/1872735/comments/31) |
| --- | --- | --- | --- |

* [stein](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363001/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-stein)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363001)
  (23.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-29: |  |  | [#32](/keystone/%2Bbug/1872735/comments/32) |
| --- | --- | --- | --- |

* [stein updated](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363648/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-stein)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363648)
  (23.4 KiB,
  text/plain)

Fixed unit test for stein patch

Fixed unit test for stein patch

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-30: |  |  | [#33](/keystone/%2Bbug/1872735/comments/33) |
| --- | --- | --- | --- |

Waiting on a response for the CVE.

I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Waiting on a response for the CVE.
I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-30: |  |  | [#34](/keystone/%2Bbug/1872735/comments/34) |
| --- | --- | --- | --- |

May 5 should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

May 5 should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-05-01: |  |  | [#35](/keystone/%2Bbug/1872735/comments/35) |
| --- | --- | --- | --- |

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#36](/keystone/%2Bbug/1872735/comments/36) |
| --- | --- | --- | --- |

May 6th works, we will still send out the embargo notification today.

May 6th works, we will still send out the embargo notification today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#37](/keystone/%2Bbug/1872735/comments/37) |
| --- | --- | --- | --- |

Notification sent for this one.

Notification sent for this one.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-01: |  |  | [#38](/keystone/%2Bbug/1872735/comments/38) |
| --- | --- | --- | --- |

I also support Class A for this one. Description looks pretty good.

I also support Class A for this one. Description looks pretty good.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-01: |  |  | [#39](/keystone/%2Bbug/1872735/comments/39) |
| --- | --- | --- | --- |

I'd like to propose squashing the patches for this and the other currently-private EC2 bugs reported by kay into one patch, with the fix for the OAuth1 [bug 1873290](/bugs/1873290) kept as its own patch that will only affect the token model code and not the EC2 credential code. This cuts the number of patches needed from 4 per branch down to 2, so with 4 branches the total number is cut from 16 to 8. This eliminates the merge conflicts, will make it easier for stakeholders to patch their packages and deployments and will make the public review and backporting process in gerrit much smoother. I've reworked the patches for master in my development environment and am currently validating them, and if the VMT is okay with this approach I will do the same for ussuri, train, and stein and attach them to the relevant bugs.

If, on the other hand, it is too late to do this reorganization since the embargo notification has already been sent, I will instead just update the patches to resolve the merge conflict with the now-landed <https://review.opendev.org/724124>.

I'd like to propose squashing the patches for this and the other currently-private EC2 bugs reported by kay into one patch, with the fix for the OAuth1 bug 1873290 kept as its own patch that will only affect the token model code and not the EC2 credential code. This cuts the number of patches needed from 4 per branch down to 2, so with 4 branches the total number is cut from 16 to 8. This eliminates the merge conflicts, will make it easier for stakeholders to patch their packages and deployments and will make the public review and backporting process in gerrit much smoother. I've reworked the patches for master in my development environment and am currently validating them, and if the VMT is okay with this approach I will do the same for ussuri, train, and stein and attach them to the relevant bugs.
If, on the other hand, it is too late to do this reorganization since the embargo notification has already been sent, I will instead just update the patches to resolve the merge conflict with the now-landed https://review.opendev.org/724124.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-02: |  |  | [#40](/keystone/%2Bbug/1872735/comments/40) |
| --- | --- | --- | --- |

Simplifying the number of patches is highly desirable (but I'm not a VMT member). If a notified downstream fails to request access and pay attention to developments, that is on them.

Simplifying the number of patches is highly desirable (but I'm not a VMT member). If a notified downstream fails to request access and pay attention to developments, that is on them.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-02: |  |  | [#41](/keystone/%2Bbug/1872735/comments/41) |
| --- | --- | --- | --- |

While not part of the VMT, I support simplifying the patches. Personally do not see any drawbacks to this option.

While not part of the VMT, I support simplifying the patches. Personally do not see any drawbacks to this option.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#42](/keystone/%2Bbug/1872735/comments/42) |
| --- | --- | --- | --- |

* [master](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365983/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365983)
  (42.4 KiB,
  text/plain)

I've reworked this patch to include fixes for [bug 1872733](/bugs/1872733), bug, 1872735 and [bug 1872755](/bugs/1872755) and to resolve the merge conflict arising from the fix for [bug 1872737](/bugs/1872737). These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. Attaching patches for master, ussuri, train, and stein.

I've reworked this patch to include fixes for bug 1872733, bug, 1872735 and bug 1872755 and to resolve the merge conflict arising from the fix for bug 1872737. These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. Attaching patches for master, ussuri, train, and stein.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#43](/keystone/%2Bbug/1872735/comments/43) |
| --- | --- | --- | --- |

* [ussuri](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365984/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365984)
  (42.5 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#44](/keystone/%2Bbug/1872735/comments/44) |
| --- | --- | --- | --- |

* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365985/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365985)
  (43.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#45](/keystone/%2Bbug/1872735/comments/45) |
| --- | --- | --- | --- |

* [stein](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365986/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365986)
  (43.2 KiB,
  text/plain)

Note that this patch only applies on top of the as-of-this-writing-unmerged <https://review.opendev.org/725069>

Note that this patch only applies on top of the as-of-this-writing-unmerged https://review.opendev.org/725069

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-05: |  |  | [#46](/keystone/%2Bbug/1872735/comments/46) |
| --- | --- | --- | --- |

Description doesn't include 17. That needs fixing right?

Description doesn't include 17. That needs fixing right?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-05: |  |  | [#47](/keystone/%2Bbug/1872735/comments/47) |
| --- | --- | --- | --- |

(I was trying to talk about the affects field of description but didn't mention that)

Corrected version should read

Affects: <15.0.1, ==16.0.0, ==17.0.0

(I was trying to talk about the affects field of description but didn't mention that)
Corrected version should read
Affects: <15.0.1, ==16.0.0, ==17.0.0

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-05: |  |  | [#48](/keystone/%2Bbug/1872735/comments/48) |
| --- | --- | --- | --- |

The goal is to get this merged into Ussuri before the release is cut, so any releases after 16.0.0 should not be vulnerable.

The goal is to get this merged into Ussuri before the release is cut, so any releases after 16.0.0 should not be vulnerable.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-05: |  |  | [#49](/keystone/%2Bbug/1872735/comments/49) |
| --- | --- | --- | --- |

* [rocky](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366542/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366542)
  (45.1 KiB,
  text/plain)

I'm attaching a patch for rocky even though it has reached EM to help distros that need to support older releases. This patch must be applied on top of this public patch: <https://review.opendev.org/725385>

To mitigate this bug for older branches, I recommend disabling the use of ec2 and s3 tokens as authentication mechanisms by removing ec2\_extension, ec2\_extension\_v3, and s3\_extension from the paste pipelines in keystone-paste.ini. Note that this will not work for rocky - even though keystone includes an example keystone-paste.ini file, it is not respected in the keystone service as this release was a transitional release away from the paste middleware implementation.

An alternative mitigation strategy is to disable the ability to create and modify credentials by restricting them with policies. For example, you can use the following rules in your policy.json:

"identity:create\_credential": "!"

"identity:update\_credential": "!"

"identity:ec2\_create\_credential": "!"

I'm attaching a patch for rocky even though it has reached EM to help distros that need to support older releases. This patch must be applied on top of this public patch: https://review.opendev.org/725385
To mitigate this bug for older branches, I recommend disabling the use of ec2 and s3 tokens as authentication mechanisms by removing ec2\_extension, ec2\_extension\_v3, and s3\_extension from the paste pipelines in keystone-paste.ini. Note that this will not work for rocky - even though keystone includes an example keystone-paste.ini file, it is not respected in the keystone service as this release was a transitional release away from the paste middleware implementation.
An alternative mitigation strategy is to disable the ability to create and modify credentials by restricting them with policies. For example, you can use the following rules in your policy.json:
"identity:create\_credential": "!"
"identity:update\_credential": "!"
"identity:ec2\_create\_credential": "!"

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2020-05-05: |  |  | [#50](/keystone/%2Bbug/1872735/comments/50) |
| --- | --- | --- | --- |

Hi,

I found that less than 24 hours is a very short timeframe to get things organized:

- patch the distro

- test the patch

- send to the security team

- wait for approval

- upload

- wait for security team ACK of the upload

All of this in a few hours of time (since I got the pre-OSSA yesterday before sleep time) is really too short. I understand the urgency to fix this before the release is out, though we have until Friday for this, so maybe waiting until tomorrow was enough, no?

I'm working on this, hopefully I can catch up before the 1500 UTC deadline...

Hi,
I found that less than 24 hours is a very short timeframe to get things organized:
- patch the distro
- test the patch
- send to the security team
- wait for approval
- upload
- wait for security team ACK of the upload
All of this in a few hours of time (since I got the pre-OSSA yesterday before sleep time) is really too short. I understand the urgency to fix this before the release is out, though we have until Friday for this, so maybe waiting until tomorrow was enough, no?
I'm working on this, hopefully I can catch up before the 1500 UTC deadline...

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2020-05-05: |  |  | [#51](/keystone/%2Bbug/1872735/comments/51) |
| --- | --- | --- | --- |

* [ec2\_test\_failure.txt](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366711/%2Bfiles/ec2_test_failure.txt)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366711)
  (19.0 KiB,
  text/plain)

Hi Colleen,

I'm getting a unit test failure when building Keystone for Debian Buster (that's Rocky) with the added patches on top of 14.2.0:

0001-Add-cadf-auditing-to-credentials.patch

CVE\_Check\_timestamp\_of\_signed\_EC2\_token\_request.patch

0002\_Fix\_security\_issues\_with\_EC2\_credentials.patch

Please find attached failure dump.

Can you help fixing it?

Cheers,

Thomas Goirand

Hi Colleen,
I'm getting a unit test failure when building Keystone for Debian Buster (that's Rocky) with the added patches on top of 14.2.0:
0001-Add-cadf-auditing-to-credentials.patch
CVE\_Check\_timestamp\_of\_signed\_EC2\_token\_request.patch
0002\_Fix\_security\_issues\_with\_EC2\_credentials.patch
Please find attached failure dump.
Can you help fixing it?
Cheers,
Thomas Goirand

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-05: |  |  | [#52](/keystone/%2Bbug/1872735/comments/52) |
| --- | --- | --- | --- |

* [bug 1873290 rocky patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366841/%2Bfiles/0001-Ensure-OAuth1-authorized-roles-are-respected.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366841)
  (5.5 KiB,
  text/plain)

Hi Thomas, as mentioned in comment 42 you will also need the fix for [bug 1873290](/bugs/1873290) in order for that unit test test\_access\_token\_ec2\_credential to pass. I will attach the patch for rocky here for your convenience.

Hi Thomas, as mentioned in comment 42 you will also need the fix for bug 1873290 in order for that unit test test\_access\_token\_ec2\_credential to pass. I will attach the patch for rocky here for your convenience.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2020-05-05: |  |  | [#53](/keystone/%2Bbug/1872735/comments/53) |
| --- | --- | --- | --- |

With this last patch that was missing, all builds fine, thanks!

Pushing this to the Debian security team.

With this last patch that was missing, all builds fine, thanks!
Pushing this to the Debian security team.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-05: |  |  | [#54](/keystone/%2Bbug/1872735/comments/54) |
| --- | --- | --- | --- |

Hi Thomas,

The disclosure date is tomorrow at 1500 UTC, would you need this extended?

Hi Thomas,
The disclosure date is tomorrow at 1500 UTC, would you need this extended?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2020-05-05: |  |  | [#55](/keystone/%2Bbug/1872735/comments/55) |
| --- | --- | --- | --- |

Oh, I thought it was today. Tomorrow is fine for me then, this gives me plenty of time for testing!

Oh, I thought it was today. Tomorrow is fine for me then, this gives me plenty of time for testing!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-05-05: |  |  | [#56](/keystone/%2Bbug/1872735/comments/56) |
| --- | --- | --- | --- |

Yes, and sorry about the tight disclosure timeline. OpenStack's VMT process recommends 3-5 "business days" between downstream stakeholder notification and publication, but with final RCs for Ussuri due on Thursday we wanted to avoid releasing with known vulnerabilities which have fixes ready. As it is, we chose Wednesday instead of Tuesday because we realized last weekend was a major holiday for much of the World.

Yes, and sorry about the tight disclosure timeline. OpenStack's VMT process recommends 3-5 "business days" between downstream stakeholder notification and publication, but with final RCs for Ussuri due on Thursday we wanted to avoid releasing with known vulnerabilities which have fixes ready. As it is, we chose Wednesday instead of Tuesday because we realized last weekend was a major holiday for much of the World.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2020-05-05: |  |  | [#57](/keystone/%2Bbug/1872735/comments/57) |
| --- | --- | --- | --- |

Hi Jeremy,

It's all on me. I thought I had only about 16 hours to do my tests, but there's 24 hours more than what I thought, which should hopefully be enough.

Hi Jeremy,
It's all on me. I thought I had only about 16 hours to do my tests, but there's 24 hours more than what I thought, which should hopefully be enough.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-06: |  |  | [#58](/keystone/%2Bbug/1872735/comments/58) |
| --- | --- | --- | --- |

The embargo for this bug will now be lifted and fixes will be available in gerrit here shortly.

The embargo for this bug will now be lifted and fixes will be available in gerrit here shortly.

| **description**: | updated |
| --- | --- |
| **information type**: | Private Security → Public Security |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (master)**](/keystone/%2Bbug/1872735/comments/59) |  |  | [#59](/keystone/%2Bbug/1872735/comments/59) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.opendev.org/725886>

Fix proposed to branch: master
Review: https://review.opendev.org/725886

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/ussuri)**](/keystone/%2Bbug/1872735/comments/60) |  |  | [#60](/keystone/%2Bbug/1872735/comments/60) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: <https://review.opendev.org/725888>

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/725888

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/train)**](/keystone/%2Bbug/1872735/comments/61) |  |  | [#61](/keystone/%2Bbug/1872735/comments/61) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/train

Review: <https://review.opendev.org/725891>

Fix proposed to branch: stable/train
Review: https://review.opendev.org/725891

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/stein)**](/keystone/%2Bbug/1872735/comments/62) |  |  | [#62](/keystone/%2Bbug/1872735/comments/62) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/stein

Review: <https://review.opendev.org/725893>

Fix proposed to branch: stable/stein
Review: https://review.opendev.org/725893

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/rocky)**](/keystone/%2Bbug/1872735/comments/63) |  |  | [#63](/keystone/%2Bbug/1872735/comments/63) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/rocky

Review: <https://review.opendev.org/725895>

Fix proposed to branch: stable/rocky
Review: https://review.opendev.org/725895

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix merged to ossa (master)**](/keystone/%2Bbug/1872735/comments/64) |  |  | [#64](/keystone/%2Bbug/1872735/comments/64) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725912>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236>

Submitter: Zuul

Branch: master

commit 2548f46b0aff357f6c953b30179b4d8e151e4236

Author: Gage Hugo <email address hidden>

Date: Wed May 6 10:57:15 2020 -0500

Add OSSA-2020-004 (CVEs Pending)

Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244

    Closes-Bug: #1872735

    Closes-Bug: #1872733

Reviewed: https://review.opendev.org/725912
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236
Submitter: Zuul
Branch: master
commit 2548f46b0aff357f6c953b30179b4d8e151e4236
Author: Gage Hugo <gagehugo@gmail.com>
Date: Wed May 6 10:57:15 2020 -0500
Add OSSA-2020-004 (CVEs Pending)
Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244
Closes-Bug: #1872735
Closes-Bug: #1872733

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix proposed to keystone (stable/pike)**](/keystone/%2Bbug/1872735/comments/65) |  |  | [#65](/keystone/%2Bbug/1872735/comments/65) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/pike

Review: <https://review.opendev.org/726046>

Fix proposed to branch: stable/pike
Review: https://review.opendev.org/726046

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-07:  [**Re: EC2 and/or credential endpoints are not protected from a scoped context**](/keystone/%2Bbug/1872735/comments/66) |  |  | [#66](/keystone/%2Bbug/1872735/comments/66) |
| --- | --- | --- | --- |

Any news on CVE assignment? This seems longer than usual.

Any news on CVE assignment? This seems longer than usual.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-07: |  |  | [#67](/keystone/%2Bbug/1872735/comments/67) |
| --- | --- | --- | --- |

I got a reply last night, updates will go out this afternoon.

I got a reply last night, updates will go out this afternoon.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-05-07: |  |  | [#68](/keystone/%2Bbug/1872735/comments/68) |
| --- | --- | --- | --- |

Our best guess is that MITRE is recently backlogged (understaffed/overworked?), and our publications to the oss-security ML yesterday prompted them to complete our requested assignments.

Our best guess is that MITRE is recently backlogged (understaffed/overworked?), and our publications to the oss-security ML yesterday prompted them to complete our requested assignments.

[Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo)
on 2020-05-07

| **summary**: | - EC2 and/or credential endpoints are not protected from a scoped context+ [OSSA-2020-004] EC2 and/or credential endpoints are not protected from a+ scoped context (CVE-2020-12689) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix merged to keystone (stable/ussuri)**](/keystone/%2Bbug/1872735/comments/69) |  |  | [#69](/keystone/%2Bbug/1872735/comments/69) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725888>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d>

Submitter: Zuul

Branch: stable/ussuri

commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

    (cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

Reviewed: https://review.opendev.org/725888
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Submitter: Zuul
Branch: stable/ussuri
commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

| **tags**: | added: in-stable-ussuri |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix merged to keystone (master)**](/keystone/%2Bbug/1872735/comments/70) |  |  | [#70](/keystone/%2Bbug/1872735/comments/70) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725886>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548>

Submitter: Zuul

Branch: master

commit 37e9907a176dad6843819b1bec4946c3aecc4548

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

Reviewed: https://review.opendev.org/725886
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548
Submitter: Zuul
Branch: master
commit 37e9907a176dad6843819b1bec4946c3aecc4548
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735

| Changed in keystone: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix proposed to keystone (stable/queens)**](/keystone/%2Bbug/1872735/comments/71) |  |  | [#71](/keystone/%2Bbug/1872735/comments/71) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/queens

Review: <https://review.opendev.org/726435>

Fix proposed to branch: stable/queens
Review: https://review.opendev.org/726435

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/train)**](/keystone/%2Bbug/1872735/comments/72) |  |  | [#72](/keystone/%2Bbug/1872735/comments/72) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872735/comments/72/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725891>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29>

Submitter: Zuul

Branch: stable/train

commit 54590544fb7a2cd65e23fce8abcf77296352cd29

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper

    in 52da4d0e12):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Depends-on: htt...

[Read more...](/keystone/%2Bbug/1872735/comments/72)

Reviewed: https://review.opendev.org/725891
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29
Submitter: Zuul
Branch: stable/train
commit 54590544fb7a2cd65e23fce8abcf77296352cd29
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper
in 52da4d0e12):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Depends-on: https://review.opendev.org/726526
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)

| **tags**: | added: in-stable-train |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/stein)**](/keystone/%2Bbug/1872735/comments/73) |  |  | [#73](/keystone/%2Bbug/1872735/comments/73) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872735/comments/73/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725893>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da>

Submitter: Zuul

Branch: stable/stein

commit 206392a40ce3da3d389e5e7ec721ada2737b84da

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Change-Id: I39d0d705839fbe31ac518ac9a82959e108...

[Read more...](/keystone/%2Bbug/1872735/comments/73)

Reviewed: https://review.opendev.org/725893
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da
Submitter: Zuul
Branch: stable/stein
commit 206392a40ce3da3d389e5e7ec721ada2737b84da
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)

| **tags**: | added: in-stable-stein |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-13:  [**Fix merged to keystone (stable/rocky)**](/keystone/%2Bbug/1872735/comments/74) |  |  | [#74](/keystone/%2Bbug/1872735/comments/74) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872735/comments/74/%2Bdownload) (3.9 KiB)

Reviewed: <https://review.opendev.org/725895>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191>

Submitter: Zuul

Branch: stable/rocky

commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keys...

[Read more...](/keystone/%2Bbug/1872735/comments/74)

Reviewed: https://review.opendev.org/725895
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Submitter: Zuul
Branch: stable/rocky
commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)

| **tags**: | added: in-stable-rocky |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-14:  [**Fix merged to keystone (stable/queens)**](/keystone/%2Bbug/1872735/comments/75) |  |  | [#75](/keystone/%2Bbug/1872735/comments/75) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872735/comments/75/%2Bdownload) (4.3 KiB)

Reviewed: <https://review.opendev.org/726435>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a>

Submitter: Zuul

Branch: stable/queens

commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            key...

[Read more...](/keystone/%2Bbug/1872735/comments/75)

Reviewed: https://review.opendev.org/726435
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a
Submitter: Zuul
Branch: stable/queens
commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to token provider refactor between Queens and Rocky. Also
conflicted due to changing method signature for \_authenticate().
keystone/credential/controllers.py
keystone/contrib/ec2/controllers.py
keystone/application\_credential/controllers.py
keystone/token/providers/common.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-06-04:  [**Fix merged to keystone (stable/pike)**](/keystone/%2Bbug/1872735/comments/76) |  |  | [#76](/keystone/%2Bbug/1872735/comments/76) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872735/comments/76/%2Bdownload) (4.2 KiB)

Reviewed: <https://review.opendev.org/726046>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe>

Submitter: Zuul

Branch: stable/pike

commit a405e4b71d7de31e81a01f07e02f189650eb66fe

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keyst...

[Read more...](/keystone/%2Bbug/1872735/comments/76)

Reviewed: https://review.opendev.org/726046
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe
Submitter: Zuul
Branch: stable/pike
commit a405e4b71d7de31e81a01f07e02f189650eb66fe
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
NOTE: the application credential functional changes, along with its
tests were removed from the stable/pike backport as stable/pike does not
support application credentials.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)
(cherry picked from commit 6db1bb09a048dfb7f337484698a9a19fdbbe9546)

| **tags**: | added: in-stable-pike |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-08-18:  [**Fix included in openstack/keystone pike-eol**](/keystone/%2Bbug/1872735/comments/77) |  |  | [#77](/keystone/%2Bbug/1872735/comments/77) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone pike-eol release.

This issue was fixed in the openstack/keystone pike-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-01-17:  [**Fix included in openstack/keystone queens-eol**](/keystone/%2Bbug/1872735/comments/78) |  |  | [#78](/keystone/%2Bbug/1872735/comments/78) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone queens-eol release.

This issue was fixed in the openstack/keystone queens-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-06-27:  [**Fix included in openstack/keystone rocky-eol**](/keystone/%2Bbug/1872735/comments/79) |  |  | [#79](/keystone/%2Bbug/1872735/comments/79) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone rocky-eol release.

This issue was fixed in the openstack/keystone rocky-eol release.

[See full activity log](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/keystone/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/keystone/%2Bbug/1872735/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-Respect-token-roles-when-creating-EC2-credentials.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5355250/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5355250 "Change patch details")
* [0001-Respect-token-roles-when-creating-EC2-credentials.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5355722/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5355722 "Change patch details")
* [stein updated](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363648/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-stein)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363648 "Change patch details")
* [master](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365983/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365983 "Change patch details")
* [ussuri](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365984/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365984 "Change patch details")
* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365985/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365985 "Change patch details")
* [stein](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5365986/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5365986 "Change patch details")
* [rocky](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366542/%2Bfiles/0002-Fix-security-issues-with-EC2-credentials.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366542 "Change patch details")

* [Add patch](/keystone/%2Bbug/1872735/%2Baddcomment?field.patch=on)

## Bug attachments

* [ec2.example.2](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5354179/%2Bfiles/ec2.example.2)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5354179 "Change attachment details")
* [test.log](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5354359/%2Bfiles/test.log)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5354359 "Change attachment details")
* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363000/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-train)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363000 "Change attachment details")
* [stein](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5363001/%2Bfiles/0001-Respect-token-roles-when-creating-EC2-credentials.patch-stein)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5363001 "Change attachment details")
* [ec2\_test\_failure.txt](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366711/%2Bfiles/ec2_test_failure.txt)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366711 "Change attachment details")
* [bug 1873290 rocky patch](https://bugs.launchpad.net/keystone/%2Bbug/1872735/%2Battachment/5366841/%2Bfiles/0001-Ensure-OAuth1-authorized-roles-are-respected.patch)
  [Edit](/keystone/%2Bbug/1872735/%2Battachment/5366841 "Change attachment details")

* [Add attachment](/keystone/%2Bbug/1872735/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from lists.ubuntu.com_be8ed54b_20250119_131800.html ===


| **ubuntu-hardened -- Ubuntu security discussion** | |
| --- | --- |
|  | |
| **About ubuntu-hardened** | English (USA)   Chinese (Taiwan) |
| Discussion on Ubuntu security updates, development of new security technologies, and general "hardening" of the operating system.  A place to talk about MAC systems (SELinux, AppArmor, Smack) in Ubuntu, about both kernel-level and user-land security improvements and technologies, etc.  To see the collection of prior postings to the list, visit the [ubuntu-hardened Archives](https://lists.ubuntu.com/archives/ubuntu-hardened). | |
| **Using ubuntu-hardened** | |
| To post a message to all the list members, send email to ubuntu-hardened@lists.ubuntu.com. You can subscribe to the list, or change your existing subscription, in the sections below. | |
| **Subscribing to ubuntu-hardened** | |
| Subscribe to ubuntu-hardened by filling out the following form. You will be sent email requesting confirmation, to prevent others from gratuitously subscribing you. This is a hidden list, which means that the list of members is available only to the list administrator.    | Your email address: |  |  | | --- | --- | --- | | Your name (optional): |  |  | | You may enter a privacy password below. This provides only mild security, but should prevent others from messing with your subscription. **Do not use a valuable password** as it will occasionally be emailed back to you in cleartext. If you choose not to enter a password, one will be automatically generated for you, and it will be sent to you once you've confirmed your subscription. You can always request a mail-back of your password when you edit your personal options. | | | | Pick a password: |  |  | | Reenter password to confirm: |  |  | | Which language do you prefer to display your messages? | English (USA)   Chinese (Taiwan) |  | | Would you like to receive list mail batched in a daily digest? | No  Yes | |  | | | | |

| **ubuntu-hardened Subscribers** | |
| (*The subscribers list is only available to the list administrator.*) Enter your admin address and password to visit the subscribers list: Admin address: Password:  To unsubscribe from ubuntu-hardened, get a password reminder, or change your subscription options enter your subscription email address: If you leave the field blank, you will be prompted for your email address | |

---

[ubuntu-hardened](../listinfo/ubuntu-hardened) list run by jamie at ubuntu.com, mdeslaur at ubuntu.com, sbeattie at ubuntu.com, alex.murray at canonical.com
[ubuntu-hardened administrative interface](../admin/ubuntu-hardened) (requires authorization)
[Overview of all lists.ubuntu.com mailing lists](../listinfo)

| [Delivered by Mailmanversion 2.1.20](http://www.gnu.org/software/mailman/index.html) | [Python Powered](http://www.python.org/) | [GNU's Not Unix](http://www.gnu.org/) | [Debian Powered](http://www.debian.org/) |
| --- | --- | --- | --- |

[![](http://tuxedo-es.org/images/hardened_debian.png)](http://www.debian-hardened.org)



=== Content from answers.launchpad.net_da5dcf83_20250119_131807.html ===

[Log in / Register](https://answers.launchpad.net/keystone/%2Blogin)

[![](https://launchpadlibrarian.net/359059841/OpenStack_Project_Keystone_mascot%20%281%29.png)](https://launchpad.net/keystone)

## [OpenStack Identity (keystone)](https://launchpad.net/keystone)

* [Overview](https://launchpad.net/keystone)
* [Code](https://code.launchpad.net/keystone)
* [Bugs](https://bugs.launchpad.net/keystone)
* [Blueprints](https://blueprints.launchpad.net/keystone)
* [Translations](https://translations.launchpad.net/keystone)
* Answers

# Questions for OpenStack Identity (keystone)

**Launchpad does not know where
OpenStack Identity (keystone)
tracks support requests.**

OpenStack Identity (keystone) questions are
tracked in:
[keystone in Ubuntu](/ubuntu/%2Bsource/keystone).

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from review.opendev.org_05d8844f_20250119_131804.html ===




=== Content from launchpad.net_b142794d_20250119_131807.html ===

[Log in / Register](https://launchpad.net/~kay-diam/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~kay-diam)

## [kay](https://launchpad.net/~kay-diam)

* Overview
* [Code](https://code.launchpad.net/~kay-diam)
* [Bugs](https://bugs.launchpad.net/~kay-diam)
* [Blueprints](https://blueprints.launchpad.net/~kay-diam)
* [Translations](https://translations.launchpad.net/~kay-diam)
* [Answers](https://answers.launchpad.net/~kay-diam)

* [Related packages](https://launchpad.net/~kay-diam/%2Brelated-packages)
* [Related projects](https://launchpad.net/~kay-diam/%2Brelated-projects)

## User information

Launchpad Id:
kay-diam

Email:
[Log in](%2Blogin) for email information.

Member since:
2009-04-06

Languages:

English

Time zone:

UTC
(UTC+0000)

Karma:
[0](https://launchpad.net/~kay-diam/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## Personal package archives

| [Ejabberd 15.03 for Ubuntu 14.04](/~kay-diam/%2Barchive/ubuntu/ejabberd15.03) |
| --- |

## Latest memberships

kay is not an
active member of any Launchpad teams.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_ab41b67b_20250119_131805.html ===

[Log in / Register](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Blogin)

[![](https://launchpadlibrarian.net/359059841/OpenStack_Project_Keystone_mascot%20%281%29.png)](https://launchpad.net/keystone)

## [OpenStack Identity (keystone)](https://launchpad.net/keystone)

* [Overview](https://launchpad.net/keystone)
* [Code](https://code.launchpad.net/keystone)
* [Bugs](https://bugs.launchpad.net/keystone)
* [Blueprints](https://blueprints.launchpad.net/keystone)
* [Translations](https://translations.launchpad.net/keystone)
* [Answers](https://answers.launchpad.net/keystone)

# [OSSA-2020-004] Keystone V3 /credentials endpoint policy logic allows to change credentials owner or target project ID (CVE-2020-12691)

Bug #1872733 reported by
[kay](https://launchpad.net/~kay-diam)
on 2020-04-14

[264](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Identity (keystone)](https://bugs.launchpad.net/keystone) | Fix Released | High | [Colleen Murphy](https://launchpad.net/~krinkle) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Undecided | Unassigned |  |

### Bug Description

"\_build\_target\_enforcement" function checks only for "credential\_id": <https://github.com/openstack/keystone/blob/7bb6314e40d6947294260324e84a58de191f8609/keystone/api/credentials.py#L38>

Thus even having a '"identity:update\_credential": "rule:cloud\_admin or (user\_id:%(target.credential.user\_id)s)"' policy doesn't prevent a malicious user to create an EC2 credential, then change its owner and project ID, e.g.:

curl -X PATCH <https://keystone/v3/credentials/3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f> -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{

  "credential": {

    "project\_id": "\_target\_project\_id\_",

    "user\_id": "\_target\_user\_id\_"

  }

}'

Additionally it is possible to Create a credential with any existing project\_id, though it doesn't have a serious security issue, e.g.:

{

  "credential": {

    "blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",

    "id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",

    "project\_id": "\_any\_project\_id\_",

    "type": "ec2",

    "user\_id": "\_my\_user\_id\_"

  }

}

See [original description](comments/0)

Tags:

[in-stable-pike](/keystone/%2Bbugs?field.tag=in-stable-pike)
[in-stable-queens](/keystone/%2Bbugs?field.tag=in-stable-queens)
[in-stable-rocky](/keystone/%2Bbugs?field.tag=in-stable-rocky)
[in-stable-stein](/keystone/%2Bbugs?field.tag=in-stable-stein)
[in-stable-train](/keystone/%2Bbugs?field.tag=in-stable-train)
[in-stable-ussuri](/keystone/%2Bbugs?field.tag=in-stable-ussuri)

## CVE References

* [2020-12691](/bugs/cve/2020-12691 "An issue was discovered in OpenStack ...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-14: |  |  | [#1](/keystone/%2Bbug/1872733/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete

security advisory task has been added while the core security

reviewers for the affected project or projects confirm the bug and

discuss the scope of any vulnerability along with potential

solutions.

Since this report concerns a possible security risk, an incomplete
security advisory task has been added while the core security
reviewers for the affected project or projects confirm the bug and
discuss the scope of any vulnerability along with potential
solutions.

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-14: |  |  | [#2](/keystone/%2Bbug/1872733/comments/2) |
| --- | --- | --- | --- |

In case, when "/credentials" endpoint is used to store a secret for TOTP (Time-based One-time Password), an attacker can set a TOTP secret for a victim user and it will be used to verify TOTP "passcode" along with all "totp" secrets, associated with a victim user.

In case, when "/credentials" endpoint is used to store a secret for TOTP (Time-based One-time Password), an attacker can set a TOTP secret for a victim user and it will be used to verify TOTP "passcode" along with all "totp" secrets, associated with a victim user.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-14: |  |  | [#3](/keystone/%2Bbug/1872733/comments/3) |
| --- | --- | --- | --- |

Verified. This is a critical issue as it allows any authenticated user to escalate to admin privileges. However, it is mitigated somewhat by the fact that the attacker needs to know or guess the UUID of the admin user and admin project, or the UUIDs of the user and project they are trying to impersonate.

Verified. This is a critical issue as it allows any authenticated user to escalate to admin privileges. However, it is mitigated somewhat by the fact that the attacker needs to know or guess the UUID of the admin user and admin project, or the UUIDs of the user and project they are trying to impersonate.

| Changed in keystone: | |
| --- | --- |
| **status**: | New → Triaged |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#4](/keystone/%2Bbug/1872733/comments/4) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5354247/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5354247)
  (4.9 KiB,
  text/plain)

Patch attached. Currently running tempest and unit tests on it locally.

Patch attached. Currently running tempest and unit tests on it locally.

| Changed in keystone: | |
| --- | --- |
| **assignee**: | nobody → Colleen Murphy (krinkle) |
| **status**: | Triaged → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lance Bragstad (lbragstad)](https://launchpad.net/~lbragstad) wrote on 2020-04-15: |  |  | [#5](/keystone/%2Bbug/1872733/comments/5) |
| --- | --- | --- | --- |

The proposed patch in comment #4 looks good and the unit test covers the exposed behavior.

The proposed patch in comment #4 looks good and the unit test covers the exposed behavior.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-15: |  |  | [#6](/keystone/%2Bbug/1872733/comments/6) |
| --- | --- | --- | --- |

Thanks cmurphy for the quick fix, looks good and works for me locally.

With the verification here and fix, this is looking like a Class A vulnerability according to the VMT taxonomy[0]. Even with the requirement to know/guess UUIDs, this looks to be something that is exploitable by any authenticated user.

[0] <https://security.openstack.org/vmt-process.html#incident-report-taxonomy>

Thanks cmurphy for the quick fix, looks good and works for me locally.
With the verification here and fix, this is looking like a Class A vulnerability according to the VMT taxonomy[0]. Even with the requirement to know/guess UUIDs, this looks to be something that is exploitable by any authenticated user.
[0] https://security.openstack.org/vmt-process.html#incident-report-taxonomy

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristi Nikolla (knikolla)](https://launchpad.net/~knikolla) wrote on 2020-04-15: |  |  | [#7](/keystone/%2Bbug/1872733/comments/7) |
| --- | --- | --- | --- |

Patch in #4 looks good and unit test covers the issue. Was able to reproduce the bug local.

Patch in #4 looks good and unit test covers the issue. Was able to reproduce the bug local.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#8](/keystone/%2Bbug/1872733/comments/8) |
| --- | --- | --- | --- |

Tempest and py37 unit tests pass for me locally. We will need to backport this to all supported releases. I have backports prepared, but we should wait for the keystone stable/stein branch to be unblocked before proposing them[0].

[0] <https://review.opendev.org/720053>

Tempest and py37 unit tests pass for me locally. We will need to backport this to all supported releases. I have backports prepared, but we should wait for the keystone stable/stein branch to be unblocked before proposing them[0].
[0] https://review.opendev.org/720053

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-15: |  |  | [#9](/keystone/%2Bbug/1872733/comments/9) |
| --- | --- | --- | --- |

Hi Colleen. Could you also add a protection and unit test for create action? It is not so serious, but would be great to have.

As I mentioned in original ticket it is possible to create EC2 credentials with any existing projectID, even if it is a domainID:

curl -X POST <https://keystone/v3/credentials> -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{

  "credential": {

    "blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",

    "id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",

    "project\_id": "\_any\_project\_id\_",

    "type": "ec2",

    "user\_id": "\_my\_user\_id\_"

  }

}'

This credential won't be useful, but it would be great to have this protection.

Hi Colleen. Could you also add a protection and unit test for create action? It is not so serious, but would be great to have.
As I mentioned in original ticket it is possible to create EC2 credentials with any existing projectID, even if it is a domainID:
curl -X POST https://keystone/v3/credentials -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{
"credential": {
"blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",
"id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",
"project\_id": "\_any\_project\_id\_",
"type": "ec2",
"user\_id": "\_my\_user\_id\_"
}
}'
This credential won't be useful, but it would be great to have this protection.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#10](/keystone/%2Bbug/1872733/comments/10) |
| --- | --- | --- | --- |

Protecting the POST case is more complicated because not all credential types use project\_id and so the credentials policy only checks against the credential's owner, not their scope. Since this behavior is longstanding and can't be exploited to elevate the user's privileges, I'm inclined not to fix it.

Protecting the POST case is more complicated because not all credential types use project\_id and so the credentials policy only checks against the credential's owner, not their scope. Since this behavior is longstanding and can't be exploited to elevate the user's privileges, I'm inclined not to fix it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#11](/keystone/%2Bbug/1872733/comments/11) |
| --- | --- | --- | --- |

Since exploiting this depends on the attacker obtaining a UUID to which they should not normally have access, the VMT would typically consider this a class C1 report:

<https://security.openstack.org/vmt-process.html#incident-report-taxonomy>

As such, it shouldn't warrant the overhead of an embargo process and would be fine finishing in public instead. Does anyone disagree with that assessment?

Since exploiting this depends on the attacker obtaining a UUID to which they should not normally have access, the VMT would typically consider this a class C1 report:
https://security.openstack.org/vmt-process.html#incident-report-taxonomy
As such, it shouldn't warrant the overhead of an embargo process and would be fine finishing in public instead. Does anyone disagree with that assessment?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#12](/keystone/%2Bbug/1872733/comments/12) |
| --- | --- | --- | --- |

Oh, now I see Gage's suggestion to treat it as a class A report instead. Gage, what's the scenario where an authenticated user can exploit this without access to the victim's UUID?

Oh, now I see Gage's suggestion to treat it as a class A report instead. Gage, what's the scenario where an authenticated user can exploit this without access to the victim's UUID?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-15: |  |  | [#13](/keystone/%2Bbug/1872733/comments/13) |
| --- | --- | --- | --- |

I believe I was thinking that an authenticated user would be able to guess easier than a remote non-authenticated user. I'm fine with classifying this as C1 since it really does depend on UUID guessing.

I believe I was thinking that an authenticated user would be able to guess easier than a remote non-authenticated user. I'm fine with classifying this as C1 since it really does depend on UUID guessing.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-15: |  |  | [#14](/keystone/%2Bbug/1872733/comments/14) |
| --- | --- | --- | --- |

In certain OpenStack environments user listing is allowed. As for the project IDs, users just post them in chats/github and don't think it is a secret. I'd not call it "guessing".

In certain OpenStack environments user listing is allowed. As for the project IDs, users just post them in chats/github and don't think it is a secret. I'd not call it "guessing".

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#15](/keystone/%2Bbug/1872733/comments/15) |
| --- | --- | --- | --- |

Resource UUIDs are often not as carefully protected as other secret information. We have already set a precedent[0] that UUIDs are effectively public.

[0] [https://bugs.launchpad.net/keystone/+bug/1840288](https://bugs.launchpad.net/keystone/%2Bbug/1840288)

Resource UUIDs are often not as carefully protected as other secret information. We have already set a precedent[0] that UUIDs are effectively public.
[0] https://bugs.launchpad.net/keystone/+bug/1840288

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristi Nikolla (knikolla)](https://launchpad.net/~knikolla) wrote on 2020-04-15: |  |  | [#16](/keystone/%2Bbug/1872733/comments/16) |
| --- | --- | --- | --- |

In our environment, we allow users with project\_admin role to list people in their project. If a user with an admin role is part of the project of a malicious user (maybe to help with some debugging, or an inherited role), this would allow the malicious user to know the UUID of the admin user.

In our environment, we allow users with project\_admin role to list people in their project. If a user with an admin role is part of the project of a malicious user (maybe to help with some debugging, or an inherited role), this would allow the malicious user to know the UUID of the admin user.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#17](/keystone/%2Bbug/1872733/comments/17) |
| --- | --- | --- | --- |

Since it's been suggested that account UUIDs are generally available to untrusted users in some environments, I concur that this is better handled as a class A report and continuing the embargo is unfortunately warranted.

The UUID guessing guidance was added as an example for the C1 report classification in 2015 via <https://review.openstack.org/255476> following a rash of theoretical vulnerabilities in that vein, but several recent examples have made it clear that some of objects in various services' APIs are keyed with UUIDs which are not safeguarded or we otherwise don't position this information as sensitive in obvious ways. As such, I've proposed <https://review.opendev.org/720291> to remove this example from the OpenStack VMT's report taxonomy.

Since it's been suggested that account UUIDs are generally available to untrusted users in some environments, I concur that this is better handled as a class A report and continuing the embargo is unfortunately warranted.
The UUID guessing guidance was added as an example for the C1 report classification in 2015 via https://review.openstack.org/255476 following a rash of theoretical vulnerabilities in that vein, but several recent examples have made it clear that some of objects in various services' APIs are keyed with UUIDs which are not safeguarded or we otherwise don't position this information as sensitive in obvious ways. As such, I've proposed https://review.opendev.org/720291 to remove this example from the OpenStack VMT's report taxonomy.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-16: |  |  | [#18](/keystone/%2Bbug/1872733/comments/18) |
| --- | --- | --- | --- |

There are at least two use cases, when project admin user or barbican secret owner needs to know user ID (in certain cases they are provisioned automatically, e.g. by LDAP):

\* assign a project role to this user, so he can access the project: [https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project\*](https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project*) fine grained barbican ACL permissions: <https://docs.openstack.org/barbican/latest/api/reference/acls.html>

Therefore it is not clear, whether user IDs or project IDs have to be considered as sensitive.

There are at least two use cases, when project admin user or barbican secret owner needs to know user ID (in certain cases they are provisioned automatically, e.g. by LDAP):
\* assign a project role to this user, so he can access the project: https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project\* fine grained barbican ACL permissions: https://docs.openstack.org/barbican/latest/api/reference/acls.html
Therefore it is not clear, whether user IDs or project IDs have to be considered as sensitive.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#19](/keystone/%2Bbug/1872733/comments/19) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5355724/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5355724)
  (5.1 KiB,
  text/plain)

Updated release notes in patch to include bug reference

Updated release notes in patch to include bug reference

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#20](/keystone/%2Bbug/1872733/comments/20) |
| --- | --- | --- | --- |

Is a CVE being requested for this? How can we move this forward?

Is a CVE being requested for this? How can we move this forward?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#21](/keystone/%2Bbug/1872733/comments/21) |
| --- | --- | --- | --- |

If we agree that this should be considered a Class A, I can write up an impact description for this.

If we agree that this should be considered a Class A, I can write up an impact description for this.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#22](/keystone/%2Bbug/1872733/comments/22) |
| --- | --- | --- | --- |

First draft below, please review:

Assuming that this affects all currently maintained releases of keystone.

Title: Credentials endpoint policy logic allows changing credential owner and target project ID

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on.

First draft below, please review:
Assuming that this affects all currently maintained releases of keystone.
Title: Credentials endpoint policy logic allows changing credential owner and target project ID
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#23](/keystone/%2Bbug/1872733/comments/23) |
| --- | --- | --- | --- |

> This potentially allows the malicious user to act as the admin on a project another user has the admin role on

... which in many cases can effectively grant the user global admin privileges.

> This potentially allows the malicious user to act as the admin on a project another user has the admin role on
... which in many cases can effectively grant the user global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#24](/keystone/%2Bbug/1872733/comments/24) |
| --- | --- | --- | --- |

Updated, please review:

Title: Credentials endpoint policy logic allows changing credential owner and target project ID

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on, which can effectively grant the user global admin privileges.

Updated, please review:
Title: Credentials endpoint policy logic allows changing credential owner and target project ID
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on, which can effectively grant the user global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#25](/keystone/%2Bbug/1872733/comments/25) |
| --- | --- | --- | --- |

lgtm

lgtm

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-27: |  |  | [#26](/keystone/%2Bbug/1872733/comments/26) |
| --- | --- | --- | --- |

Gage's impact description in comment #24 works for me, I think we're set to get a CVE request rolling for this one and propose a disclosure timeline once the stable branch backports are confirmed viable.

Gage's impact description in comment #24 works for me, I think we're set to get a CVE request rolling for this one and propose a disclosure timeline once the stable branch backports are confirmed viable.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-30: |  |  | [#27](/keystone/%2Bbug/1872733/comments/27) |
| --- | --- | --- | --- |

Could we get a patch for Stein/Train for this as well?

Waiting on a response for the CVE.

I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Could we get a patch for Stein/Train for this as well?
Waiting on a response for the CVE.
I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-30: |  |  | [#28](/keystone/%2Bbug/1872733/comments/28) |
| --- | --- | --- | --- |

* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363821/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-train)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363821)
  (5.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-30: |  |  | [#29](/keystone/%2Bbug/1872733/comments/29) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch-stein](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363822/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-stein)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363822)
  (5.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-30: |  |  | [#30](/keystone/%2Bbug/1872733/comments/30) |
| --- | --- | --- | --- |

May 5 disclosure should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

May 5 disclosure should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-05-01: |  |  | [#31](/keystone/%2Bbug/1872733/comments/31) |
| --- | --- | --- | --- |

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#32](/keystone/%2Bbug/1872733/comments/32) |
| --- | --- | --- | --- |

May 6th works, we will still send out the embargo notification today.

May 6th works, we will still send out the embargo notification today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#33](/keystone/%2Bbug/1872733/comments/33) |
| --- | --- | --- | --- |

Embargo email sent.

Embargo email sent.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-01: |  |  | [#34](/keystone/%2Bbug/1872733/comments/34) |
| --- | --- | --- | --- |

I support Class A for this. Eagerly awaiting CVE assignment. Simplified the description a little, you are welcome to use this:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential in a project that they have a specified role on, then modify the credential user and project, allowing them to masquerade as another user. This may enable a malicious user to escalate themselves as an admin which (in some environments) is equivalent to gaining global admin privileges.

I support Class A for this. Eagerly awaiting CVE assignment. Simplified the description a little, you are welcome to use this:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential in a project that they have a specified role on, then modify the credential user and project, allowing them to masquerade as another user. This may enable a malicious user to escalate themselves as an admin which (in some environments) is equivalent to gaining global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#35](/keystone/%2Bbug/1872733/comments/35) |
| --- | --- | --- | --- |

* [bug-1872733.diff](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5365987/%2Bfiles/bug-1872733.diff)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5365987)
  (660 bytes,
  text/plain)

I've reworked this patch to include fixes for [bug 1872733](/bugs/1872733), [bug 1872735](/bugs/1872735) and [bug 1872755](/bugs/1872755) and to resolve the merge conflict arising from the fix for [bug 1872737](/bugs/1872737). These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. I've attached them on [bug 1872735](/bugs/1872735).

In validating the new version I noticed an error in the solution for this bug, attaching the diff here.

I've reworked this patch to include fixes for bug 1872733, bug 1872735 and bug 1872755 and to resolve the merge conflict arising from the fix for bug 1872737. These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. I've attached them on bug 1872735.
In validating the new version I noticed an error in the solution for this bug, attaching the diff here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-06: |  |  | [#36](/keystone/%2Bbug/1872733/comments/36) |
| --- | --- | --- | --- |

The embargo for this bug has expired, we will be making public and fixes will be available in gerrit here shortly.

The embargo for this bug has expired, we will be making public and fixes will be available in gerrit here shortly.

| **description**: | updated |
| --- | --- |
| **information type**: | Private Security → Public Security |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (master)**](/keystone/%2Bbug/1872733/comments/37) |  |  | [#37](/keystone/%2Bbug/1872733/comments/37) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.opendev.org/725886>

Fix proposed to branch: master
Review: https://review.opendev.org/725886

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/ussuri)**](/keystone/%2Bbug/1872733/comments/38) |  |  | [#38](/keystone/%2Bbug/1872733/comments/38) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: <https://review.opendev.org/725888>

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/725888

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/train)**](/keystone/%2Bbug/1872733/comments/39) |  |  | [#39](/keystone/%2Bbug/1872733/comments/39) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/train

Review: <https://review.opendev.org/725891>

Fix proposed to branch: stable/train
Review: https://review.opendev.org/725891

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/stein)**](/keystone/%2Bbug/1872733/comments/40) |  |  | [#40](/keystone/%2Bbug/1872733/comments/40) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/stein

Review: <https://review.opendev.org/725893>

Fix proposed to branch: stable/stein
Review: https://review.opendev.org/725893

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/rocky)**](/keystone/%2Bbug/1872733/comments/41) |  |  | [#41](/keystone/%2Bbug/1872733/comments/41) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/rocky

Review: <https://review.opendev.org/725895>

Fix proposed to branch: stable/rocky
Review: https://review.opendev.org/725895

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2020-05-06

| Changed in ossa: | |
| --- | --- |
| **status**: | Incomplete → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix merged to ossa (master)**](/keystone/%2Bbug/1872733/comments/42) |  |  | [#42](/keystone/%2Bbug/1872733/comments/42) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725912>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236>

Submitter: Zuul

Branch: master

commit 2548f46b0aff357f6c953b30179b4d8e151e4236

Author: Gage Hugo <email address hidden>

Date: Wed May 6 10:57:15 2020 -0500

Add OSSA-2020-004 (CVEs Pending)

Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244

    Closes-Bug: #1872735

    Closes-Bug: #1872733

Reviewed: https://review.opendev.org/725912
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236
Submitter: Zuul
Branch: master
commit 2548f46b0aff357f6c953b30179b4d8e151e4236
Author: Gage Hugo <gagehugo@gmail.com>
Date: Wed May 6 10:57:15 2020 -0500
Add OSSA-2020-004 (CVEs Pending)
Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244
Closes-Bug: #1872735
Closes-Bug: #1872733

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix proposed to keystone (stable/pike)**](/keystone/%2Bbug/1872733/comments/43) |  |  | [#43](/keystone/%2Bbug/1872733/comments/43) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/pike

Review: <https://review.opendev.org/726046>

Fix proposed to branch: stable/pike
Review: https://review.opendev.org/726046

[Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo)
on 2020-05-07

| **summary**: | - Keystone V3 /credentials endpoint policy logic allows to change- credentials owner or target project ID+ [OSSA-2020-004] Keystone V3 /credentials endpoint policy logic allows to+ change credentials owner or target project ID (CVE-2020-12691) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix merged to keystone (stable/ussuri)**](/keystone/%2Bbug/1872733/comments/44) |  |  | [#44](/keystone/%2Bbug/1872733/comments/44) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725888>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d>

Submitter: Zuul

Branch: stable/ussuri

commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

    (cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

Reviewed: https://review.opendev.org/725888
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Submitter: Zuul
Branch: stable/ussuri
commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

| **tags**: | added: in-stable-ussuri |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix merged to keystone (master)**](/keystone/%2Bbug/1872733/comments/45) |  |  | [#45](/keystone/%2Bbug/1872733/comments/45) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725886>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548>

Submitter: Zuul

Branch: master

commit 37e9907a176dad6843819b1bec4946c3aecc4548

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

Reviewed: https://review.opendev.org/725886
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548
Submitter: Zuul
Branch: master
commit 37e9907a176dad6843819b1bec4946c3aecc4548
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735

| Changed in keystone: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix proposed to keystone (stable/queens)**](/keystone/%2Bbug/1872733/comments/46) |  |  | [#46](/keystone/%2Bbug/1872733/comments/46) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/queens

Review: <https://review.opendev.org/726435>

Fix proposed to branch: stable/queens
Review: https://review.opendev.org/726435

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/train)**](/keystone/%2Bbug/1872733/comments/47) |  |  | [#47](/keystone/%2Bbug/1872733/comments/47) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/47/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725891>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29>

Submitter: Zuul

Branch: stable/train

commit 54590544fb7a2cd65e23fce8abcf77296352cd29

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper

    in 52da4d0e12):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Depends-on: htt...

[Read more...](/keystone/%2Bbug/1872733/comments/47)

Reviewed: https://review.opendev.org/725891
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29
Submitter: Zuul
Branch: stable/train
commit 54590544fb7a2cd65e23fce8abcf77296352cd29
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper
in 52da4d0e12):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Depends-on: https://review.opendev.org/726526
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)

| **tags**: | added: in-stable-train |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/stein)**](/keystone/%2Bbug/1872733/comments/48) |  |  | [#48](/keystone/%2Bbug/1872733/comments/48) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/48/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725893>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da>

Submitter: Zuul

Branch: stable/stein

commit 206392a40ce3da3d389e5e7ec721ada2737b84da

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Change-Id: I39d0d705839fbe31ac518ac9a82959e108...

[Read more...](/keystone/%2Bbug/1872733/comments/48)

Reviewed: https://review.opendev.org/725893
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da
Submitter: Zuul
Branch: stable/stein
commit 206392a40ce3da3d389e5e7ec721ada2737b84da
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)

| **tags**: | added: in-stable-stein |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-13:  [**Fix merged to keystone (stable/rocky)**](/keystone/%2Bbug/1872733/comments/49) |  |  | [#49](/keystone/%2Bbug/1872733/comments/49) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/49/%2Bdownload) (3.9 KiB)

Reviewed: <https://review.opendev.org/725895>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191>

Submitter: Zuul

Branch: stable/rocky

commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keys...

[Read more...](/keystone/%2Bbug/1872733/comments/49)

Reviewed: https://review.opendev.org/725895
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Submitter: Zuul
Branch: stable/rocky
commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)

| **tags**: | added: in-stable-rocky |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-14:  [**Fix merged to keystone (stable/queens)**](/keystone/%2Bbug/1872733/comments/50) |  |  | [#50](/keystone/%2Bbug/1872733/comments/50) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/50/%2Bdownload) (4.3 KiB)

Reviewed: <https://review.opendev.org/726435>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a>

Submitter: Zuul

Branch: stable/queens

commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            key...

[Read more...](/keystone/%2Bbug/1872733/comments/50)

Reviewed: https://review.opendev.org/726435
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a
Submitter: Zuul
Branch: stable/queens
commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to token provider refactor between Queens and Rocky. Also
conflicted due to changing method signature for \_authenticate().
keystone/credential/controllers.py
keystone/contrib/ec2/controllers.py
keystone/application\_credential/controllers.py
keystone/token/providers/common.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-06-04:  [**Fix merged to keystone (stable/pike)**](/keystone/%2Bbug/1872733/comments/51) |  |  | [#51](/keystone/%2Bbug/1872733/comments/51) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/51/%2Bdownload) (4.2 KiB)

Reviewed: <https://review.opendev.org/726046>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe>

Submitter: Zuul

Branch: stable/pike

commit a405e4b71d7de31e81a01f07e02f189650eb66fe

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keyst...

[Read more...](/keystone/%2Bbug/1872733/comments/51)

Reviewed: https://review.opendev.org/726046
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe
Submitter: Zuul
Branch: stable/pike
commit a405e4b71d7de31e81a01f07e02f189650eb66fe
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
NOTE: the application credential functional changes, along with its
tests were removed from the stable/pike backport as stable/pike does not
support application credentials.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)
(cherry picked from commit 6db1bb09a048dfb7f337484698a9a19fdbbe9546)

| **tags**: | added: in-stable-pike |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-08-18:  [**Fix included in openstack/keystone pike-eol**](/keystone/%2Bbug/1872733/comments/52) |  |  | [#52](/keystone/%2Bbug/1872733/comments/52) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone pike-eol release.

This issue was fixed in the openstack/keystone pike-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-01-17:  [**Fix included in openstack/keystone queens-eol**](/keystone/%2Bbug/1872733/comments/53) |  |  | [#53](/keystone/%2Bbug/1872733/comments/53) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone queens-eol release.

This issue was fixed in the openstack/keystone queens-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-06-27:  [**Fix included in openstack/keystone rocky-eol**](/keystone/%2Bbug/1872733/comments/54) |  |  | [#54](/keystone/%2Bbug/1872733/comments/54) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone rocky-eol release.

This issue was fixed in the openstack/keystone rocky-eol release.

[See full activity log](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/keystone/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/keystone/%2Bbug/1872733/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5354247/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5354247 "Change patch details")
* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5355724/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5355724 "Change patch details")
* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363821/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-train)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363821 "Change patch details")
* [0001-Disable-altering-credential-owner-attributes.patch-stein](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363822/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-stein)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363822 "Change patch details")

* [Add patch](/keystone/%2Bbug/1872733/%2Baddcomment?field.patch=on)

## Bug attachments

* [bug-1872733.diff](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5365987/%2Bfiles/bug-1872733.diff)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5365987 "Change attachment details")

* [Add attachment](/keystone/%2Bbug/1872733/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from lists.apache.org_1d45f2b5_20250119_112543.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from review.opendev.org_448ef9c6_20250119_131803.html ===




=== Content from www.openwall.com_9deee3b1_20250119_112535.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2020/05/06/5) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAE4Awf9hGeTGw-k1k2EJDwXffXU-Q4Auddtvz8L+9c=zJLU1Lg@mail.gmail.com>
Date: Thu, 7 May 2020 16:00:25 -0500
From: Gage Hugo <gagehugo@...il.com>
To: oss-security@...ts.openwall.com
Subject: Re: [OSSA-2020-004] Keystone: Keystone credential endpoints allow
 owner modification and are not protected from a scoped context (CVE PENDING)

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

=================================================================================================================
OSSA-2020-004: Keystone credential endpoints allow owner modification and
are not protected from a scoped context
=================================================================================================================

:Date: May 06, 2020
:CVE: CVE-2020-12689,
      CVE-2020-12691

Affects
~~~~~~~
- - Keystone: <15.0.1, ==16.0.0

Description
~~~~~~~~~~~
kay reported two vulnerabilities in keystone's EC2 credentials API.
Any authenticated user could create an EC2 credential for themselves
for a project that they have a specified role on, then perform an
update to the credential user and project, allowing them to masquerade
as another user. (CVE-2020-12691) Any authenticated user within a
limited scope (trust/oauth/application credential) can create an EC2
credential with an escalated permission, such as obtaining admin while
the user is on a limited viewer role. (CVE-2020-12689) Both of these
vulnerabilities potentially allow a malicious user to act as admin on
a project that another user has the admin role on, which can
effectively grant the malicious user global admin privileges.

Errata
~~~~~~
CVE-2020-12689 and CVE-2020-12691 were assigned after the original
publication date.

Patches
~~~~~~~
- - <https://review.opendev.org/725895> (Rocky)
- - <https://review.opendev.org/725893> (Stein)
- - <https://review.opendev.org/725891> (Train)
- - <https://review.opendev.org/725888> (Ussuri)
- - <https://review.opendev.org/725886> (Victoria)

Credits
~~~~~~~
- - kay (CVE-2020-12689, CVE-2020-12691)

References
~~~~~~~~~~
- - <https://launchpad.net/bugs/1872733>
- - <https://launchpad.net/bugs/1872735>
- - <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12689>
- - <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12691>

Notes
~~~~~
- - The stable/rocky branch is under extended maintenance and will receive
no new
  point releases, but a patch for it is provided as a courtesy.

OSSA History
~~~~~~~~~~~~
- - 2020-05-07 - Errata 1
- - 2020-05-06 - Original Version
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEWa125cLHIuv6ekof56j9K3b+vREFAl60dYUACgkQ56j9K3b+
vRESOw//YJGlVKCPz7HkUtmyu6RWnpGzSPMoWhzP0HyLLpStMlrFXUKNZsgfXAw3
90vFD6zWSSWn2abJxlyW4JFDtOALKdGEZ0Ml68WSREDdupyOyd+G/ucT01Y95wB2
6nHkoHVvKbhPAI1OeV2haNGp02UUROSLGBT/FtvFnnCAcfAiUfI7+kBbLQgeG50q
/MNQlfaWi0uBxCt/HZg0YqZ3QXIE/LuS2MgFkaQ2+Yr4r9V1M58Wi2pYA1Dkhz6e
J7q/2hDJ1Nn7P4LHUuZEXupR3Ztjrnh5uIO8yr2jSK/r4DawCmRMqT24r7ebS5ZA
/p+JhvV0+StujicmhfPSyY3A24kNHRQCSCOlFn0xF8aN+/VEFT82SOIf+NVuutZb
04wzrp4D3KIrSoulIbXVebAX+lj21qvlaYGwPAkmT8/p7kmj8mGWMlWhqBrCBJIC
OiGd9pUe2GQcRSvBPj2Bex4WZCedvehSkPAiWh1MXFmUAUb2T7iNXNP7BlMd7LZA
gdM4gW6HeFUEysj0vQfSCF+Mu+cB1PAjKZgqgHX7twgu+sOzlCKDlFkQuuzbma3M
abGlfPwVl1v7X/xZ0U7xAwViFCAI+gpqA+Yi1hmMirxzyotUWn/J17AtvhOk3Hms
mwUZiGr41oJhGhX3uSB2Jn0TulA+qhapncuMxG5qDk9Y/ijcpmQ=
=ddr5
-----END PGP SIGNATURE-----

On Wed, May 6, 2020 at 2:49 PM Gage Hugo <gagehugo@...il.com> wrote:

> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
>
>
> =================================================================================================================
> OSSA-2020-004: Keystone credential endpoints allow owner modification and
> are not protected from a scoped context
>
> =================================================================================================================
>
> :Date: May 06, 2020
> :CVE: Pending
>
>
> Affects
> ~~~~~~~
> - - Keystone: <15.0.1, ==16.0.0
>
>
> Description
> ~~~~~~~~~~~
> kay reported two vulnerabilities in keystone's EC2 credentials API.
> Any authenticated user could create an EC2 credential for themselves
> for a project that they have a specified role on, then perform an
> update to the credential user and project, allowing them to masquerade
> as another user. (CVE #1 PENDING) Any authenticated user within a
> limited scope (trust/oauth/application credential) can create an EC2
> credential with an escalated permission, such as obtaining admin while
> the user is on a limited viewer role. (CVE #2 PENDING) Both of these
> vulnerabilities potentially allow a malicious user to act as admin on
> a project that another user has the admin role on, which can
> effectively grant the malicious user global admin privileges.
>
>
> Patches
> ~~~~~~~
> - - <https://review.opendev.org/725895> (Rocky)
> - - <https://review.opendev.org/725893> (Stein)
> - - <https://review.opendev.org/725891> (Train)
> - - <https://review.opendev.org/725888> (Ussuri)
> - - <https://review.opendev.org/725886> (Victoria)
>
>
> Credits
> ~~~~~~~
> - - kay (CVE Pending)
>
>
> References
> ~~~~~~~~~~
> - - <https://launchpad.net/bugs/1872733>
> - - <https://launchpad.net/bugs/1872735>
> - - <http://cve.mitre.org/cgi-bin/cvename.cgi?name=Pending>
>
>
> Notes
> ~~~~~
> - - The stable/rocky branch is under extended maintenance and will receive
> no new
>   point releases, but a patch for it is provided as a courtesy.
> -----BEGIN PGP SIGNATURE-----
>
> iQIzBAEBCgAdFiEEWa125cLHIuv6ekof56j9K3b+vREFAl6zE70ACgkQ56j9K3b+
> vREQsBAAnHZLyrbjSwu7/CEdDVfb0sQZfDvyuXMttzouXQ6ZwEgLFKzc/aFWMjru
> loyst9jAx2pJzvxDfMYO11oU0M5tYFCFxhKsVvu+3ggbcNHeov1s25bPkxE7A2j7
> IYJj9b+bbieYVj1ru3FJjDl3iTae4K73DeHNBCdxTSeahJZdya7hiboA1VJFt4p7
> fNqU3+szsYt/vwspPBi7x+xnZszIMaUw8tVgxzB4KVD6YXbDR9Mp7itH77kGdn8l
> e3OpnURvfaIkPbK6fqE6jjwjQEL/6+Ahffaf4KqvsdjbAcdQRpK0UQrBX+n6DIWd
> TRwV/W7bEy64HrC16W78fcBlegRmEUUM4xNmdll3lwUS5KqfEeM3vXU4Ksfe9tQ2
> 8fDU1hDALcC55+2CMMrdFfmX/MBSTz0HVmP4snaGuoXBL/iQz22OmekFKC1tmXxb
> +vAtOUBsdzphRZn9KWvPIHOFGeuepWb9W0eN594JT2pdHfniLj6EaPrBaN63l7M/
> pu0DTPygN5IdUXv6v/vquQZp50CaN59okmXDNiFkBeHsfaAqhdyjJjRaYvyU62OA
> apjVam8/f2HM0RC0vvpIqv0z0kU55NPCo61dlMZPg6U9JiQd2PzBqvEtDF1lyByF
> vz5e+r9fmtRcgCJIYr0Z7VlOlSMONpITN03oICaexieDTEXDXHc=
> =lSDG
> -----END PGP SIGNATURE-----
>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugs.launchpad.net_39b74cb8_20250119_112542.html ===

[Log in / Register](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Blogin)

[![](https://launchpadlibrarian.net/359059841/OpenStack_Project_Keystone_mascot%20%281%29.png)](https://launchpad.net/keystone)

## [OpenStack Identity (keystone)](https://launchpad.net/keystone)

* [Overview](https://launchpad.net/keystone)
* [Code](https://code.launchpad.net/keystone)
* [Bugs](https://bugs.launchpad.net/keystone)
* [Blueprints](https://blueprints.launchpad.net/keystone)
* [Translations](https://translations.launchpad.net/keystone)
* [Answers](https://answers.launchpad.net/keystone)

# [OSSA-2020-004] Keystone V3 /credentials endpoint policy logic allows to change credentials owner or target project ID (CVE-2020-12691)

Bug #1872733 reported by
[kay](https://launchpad.net/~kay-diam)
on 2020-04-14

[264](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Identity (keystone)](https://bugs.launchpad.net/keystone) | Fix Released | High | [Colleen Murphy](https://launchpad.net/~krinkle) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Undecided | Unassigned |  |

### Bug Description

"\_build\_target\_enforcement" function checks only for "credential\_id": <https://github.com/openstack/keystone/blob/7bb6314e40d6947294260324e84a58de191f8609/keystone/api/credentials.py#L38>

Thus even having a '"identity:update\_credential": "rule:cloud\_admin or (user\_id:%(target.credential.user\_id)s)"' policy doesn't prevent a malicious user to create an EC2 credential, then change its owner and project ID, e.g.:

curl -X PATCH <https://keystone/v3/credentials/3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f> -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{

  "credential": {

    "project\_id": "\_target\_project\_id\_",

    "user\_id": "\_target\_user\_id\_"

  }

}'

Additionally it is possible to Create a credential with any existing project\_id, though it doesn't have a serious security issue, e.g.:

{

  "credential": {

    "blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",

    "id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",

    "project\_id": "\_any\_project\_id\_",

    "type": "ec2",

    "user\_id": "\_my\_user\_id\_"

  }

}

See [original description](comments/0)

Tags:

[in-stable-pike](/keystone/%2Bbugs?field.tag=in-stable-pike)
[in-stable-queens](/keystone/%2Bbugs?field.tag=in-stable-queens)
[in-stable-rocky](/keystone/%2Bbugs?field.tag=in-stable-rocky)
[in-stable-stein](/keystone/%2Bbugs?field.tag=in-stable-stein)
[in-stable-train](/keystone/%2Bbugs?field.tag=in-stable-train)
[in-stable-ussuri](/keystone/%2Bbugs?field.tag=in-stable-ussuri)

## CVE References

* [2020-12691](/bugs/cve/2020-12691 "An issue was discovered in OpenStack ...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-14: |  |  | [#1](/keystone/%2Bbug/1872733/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete

security advisory task has been added while the core security

reviewers for the affected project or projects confirm the bug and

discuss the scope of any vulnerability along with potential

solutions.

Since this report concerns a possible security risk, an incomplete
security advisory task has been added while the core security
reviewers for the affected project or projects confirm the bug and
discuss the scope of any vulnerability along with potential
solutions.

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-14: |  |  | [#2](/keystone/%2Bbug/1872733/comments/2) |
| --- | --- | --- | --- |

In case, when "/credentials" endpoint is used to store a secret for TOTP (Time-based One-time Password), an attacker can set a TOTP secret for a victim user and it will be used to verify TOTP "passcode" along with all "totp" secrets, associated with a victim user.

In case, when "/credentials" endpoint is used to store a secret for TOTP (Time-based One-time Password), an attacker can set a TOTP secret for a victim user and it will be used to verify TOTP "passcode" along with all "totp" secrets, associated with a victim user.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-14: |  |  | [#3](/keystone/%2Bbug/1872733/comments/3) |
| --- | --- | --- | --- |

Verified. This is a critical issue as it allows any authenticated user to escalate to admin privileges. However, it is mitigated somewhat by the fact that the attacker needs to know or guess the UUID of the admin user and admin project, or the UUIDs of the user and project they are trying to impersonate.

Verified. This is a critical issue as it allows any authenticated user to escalate to admin privileges. However, it is mitigated somewhat by the fact that the attacker needs to know or guess the UUID of the admin user and admin project, or the UUIDs of the user and project they are trying to impersonate.

| Changed in keystone: | |
| --- | --- |
| **status**: | New → Triaged |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#4](/keystone/%2Bbug/1872733/comments/4) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5354247/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5354247)
  (4.9 KiB,
  text/plain)

Patch attached. Currently running tempest and unit tests on it locally.

Patch attached. Currently running tempest and unit tests on it locally.

| Changed in keystone: | |
| --- | --- |
| **assignee**: | nobody → Colleen Murphy (krinkle) |
| **status**: | Triaged → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lance Bragstad (lbragstad)](https://launchpad.net/~lbragstad) wrote on 2020-04-15: |  |  | [#5](/keystone/%2Bbug/1872733/comments/5) |
| --- | --- | --- | --- |

The proposed patch in comment #4 looks good and the unit test covers the exposed behavior.

The proposed patch in comment #4 looks good and the unit test covers the exposed behavior.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-15: |  |  | [#6](/keystone/%2Bbug/1872733/comments/6) |
| --- | --- | --- | --- |

Thanks cmurphy for the quick fix, looks good and works for me locally.

With the verification here and fix, this is looking like a Class A vulnerability according to the VMT taxonomy[0]. Even with the requirement to know/guess UUIDs, this looks to be something that is exploitable by any authenticated user.

[0] <https://security.openstack.org/vmt-process.html#incident-report-taxonomy>

Thanks cmurphy for the quick fix, looks good and works for me locally.
With the verification here and fix, this is looking like a Class A vulnerability according to the VMT taxonomy[0]. Even with the requirement to know/guess UUIDs, this looks to be something that is exploitable by any authenticated user.
[0] https://security.openstack.org/vmt-process.html#incident-report-taxonomy

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristi Nikolla (knikolla)](https://launchpad.net/~knikolla) wrote on 2020-04-15: |  |  | [#7](/keystone/%2Bbug/1872733/comments/7) |
| --- | --- | --- | --- |

Patch in #4 looks good and unit test covers the issue. Was able to reproduce the bug local.

Patch in #4 looks good and unit test covers the issue. Was able to reproduce the bug local.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#8](/keystone/%2Bbug/1872733/comments/8) |
| --- | --- | --- | --- |

Tempest and py37 unit tests pass for me locally. We will need to backport this to all supported releases. I have backports prepared, but we should wait for the keystone stable/stein branch to be unblocked before proposing them[0].

[0] <https://review.opendev.org/720053>

Tempest and py37 unit tests pass for me locally. We will need to backport this to all supported releases. I have backports prepared, but we should wait for the keystone stable/stein branch to be unblocked before proposing them[0].
[0] https://review.opendev.org/720053

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-15: |  |  | [#9](/keystone/%2Bbug/1872733/comments/9) |
| --- | --- | --- | --- |

Hi Colleen. Could you also add a protection and unit test for create action? It is not so serious, but would be great to have.

As I mentioned in original ticket it is possible to create EC2 credentials with any existing projectID, even if it is a domainID:

curl -X POST <https://keystone/v3/credentials> -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{

  "credential": {

    "blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",

    "id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",

    "project\_id": "\_any\_project\_id\_",

    "type": "ec2",

    "user\_id": "\_my\_user\_id\_"

  }

}'

This credential won't be useful, but it would be great to have this protection.

Hi Colleen. Could you also add a protection and unit test for create action? It is not so serious, but would be great to have.
As I mentioned in original ticket it is possible to create EC2 credentials with any existing projectID, even if it is a domainID:
curl -X POST https://keystone/v3/credentials -H 'Accept: application/json' -H 'Content-Type: application/json' -H "X-Auth-Token: \*\*\*" -d'{
"credential": {
"blob": "{\"access\": \"ffe6fc21b47c4d87befc95ad070c3b7a\", \"secret\": \"530196cd097e4a7ca9df7258aa89ff0e\", \"trust\_id\": null}",
"id": "3c2b3265350c6da3a18a143fbe975ca4a8ed88a6f8c6dacc2494a5c1287ba66f",
"project\_id": "\_any\_project\_id\_",
"type": "ec2",
"user\_id": "\_my\_user\_id\_"
}
}'
This credential won't be useful, but it would be great to have this protection.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#10](/keystone/%2Bbug/1872733/comments/10) |
| --- | --- | --- | --- |

Protecting the POST case is more complicated because not all credential types use project\_id and so the credentials policy only checks against the credential's owner, not their scope. Since this behavior is longstanding and can't be exploited to elevate the user's privileges, I'm inclined not to fix it.

Protecting the POST case is more complicated because not all credential types use project\_id and so the credentials policy only checks against the credential's owner, not their scope. Since this behavior is longstanding and can't be exploited to elevate the user's privileges, I'm inclined not to fix it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#11](/keystone/%2Bbug/1872733/comments/11) |
| --- | --- | --- | --- |

Since exploiting this depends on the attacker obtaining a UUID to which they should not normally have access, the VMT would typically consider this a class C1 report:

<https://security.openstack.org/vmt-process.html#incident-report-taxonomy>

As such, it shouldn't warrant the overhead of an embargo process and would be fine finishing in public instead. Does anyone disagree with that assessment?

Since exploiting this depends on the attacker obtaining a UUID to which they should not normally have access, the VMT would typically consider this a class C1 report:
https://security.openstack.org/vmt-process.html#incident-report-taxonomy
As such, it shouldn't warrant the overhead of an embargo process and would be fine finishing in public instead. Does anyone disagree with that assessment?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#12](/keystone/%2Bbug/1872733/comments/12) |
| --- | --- | --- | --- |

Oh, now I see Gage's suggestion to treat it as a class A report instead. Gage, what's the scenario where an authenticated user can exploit this without access to the victim's UUID?

Oh, now I see Gage's suggestion to treat it as a class A report instead. Gage, what's the scenario where an authenticated user can exploit this without access to the victim's UUID?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-15: |  |  | [#13](/keystone/%2Bbug/1872733/comments/13) |
| --- | --- | --- | --- |

I believe I was thinking that an authenticated user would be able to guess easier than a remote non-authenticated user. I'm fine with classifying this as C1 since it really does depend on UUID guessing.

I believe I was thinking that an authenticated user would be able to guess easier than a remote non-authenticated user. I'm fine with classifying this as C1 since it really does depend on UUID guessing.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-15: |  |  | [#14](/keystone/%2Bbug/1872733/comments/14) |
| --- | --- | --- | --- |

In certain OpenStack environments user listing is allowed. As for the project IDs, users just post them in chats/github and don't think it is a secret. I'd not call it "guessing".

In certain OpenStack environments user listing is allowed. As for the project IDs, users just post them in chats/github and don't think it is a secret. I'd not call it "guessing".

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-15: |  |  | [#15](/keystone/%2Bbug/1872733/comments/15) |
| --- | --- | --- | --- |

Resource UUIDs are often not as carefully protected as other secret information. We have already set a precedent[0] that UUIDs are effectively public.

[0] [https://bugs.launchpad.net/keystone/+bug/1840288](https://bugs.launchpad.net/keystone/%2Bbug/1840288)

Resource UUIDs are often not as carefully protected as other secret information. We have already set a precedent[0] that UUIDs are effectively public.
[0] https://bugs.launchpad.net/keystone/+bug/1840288

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kristi Nikolla (knikolla)](https://launchpad.net/~knikolla) wrote on 2020-04-15: |  |  | [#16](/keystone/%2Bbug/1872733/comments/16) |
| --- | --- | --- | --- |

In our environment, we allow users with project\_admin role to list people in their project. If a user with an admin role is part of the project of a malicious user (maybe to help with some debugging, or an inherited role), this would allow the malicious user to know the UUID of the admin user.

In our environment, we allow users with project\_admin role to list people in their project. If a user with an admin role is part of the project of a malicious user (maybe to help with some debugging, or an inherited role), this would allow the malicious user to know the UUID of the admin user.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-15: |  |  | [#17](/keystone/%2Bbug/1872733/comments/17) |
| --- | --- | --- | --- |

Since it's been suggested that account UUIDs are generally available to untrusted users in some environments, I concur that this is better handled as a class A report and continuing the embargo is unfortunately warranted.

The UUID guessing guidance was added as an example for the C1 report classification in 2015 via <https://review.openstack.org/255476> following a rash of theoretical vulnerabilities in that vein, but several recent examples have made it clear that some of objects in various services' APIs are keyed with UUIDs which are not safeguarded or we otherwise don't position this information as sensitive in obvious ways. As such, I've proposed <https://review.opendev.org/720291> to remove this example from the OpenStack VMT's report taxonomy.

Since it's been suggested that account UUIDs are generally available to untrusted users in some environments, I concur that this is better handled as a class A report and continuing the embargo is unfortunately warranted.
The UUID guessing guidance was added as an example for the C1 report classification in 2015 via https://review.openstack.org/255476 following a rash of theoretical vulnerabilities in that vein, but several recent examples have made it clear that some of objects in various services' APIs are keyed with UUIDs which are not safeguarded or we otherwise don't position this information as sensitive in obvious ways. As such, I've proposed https://review.opendev.org/720291 to remove this example from the OpenStack VMT's report taxonomy.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [kay (kay-diam)](https://launchpad.net/~kay-diam) wrote on 2020-04-16: |  |  | [#18](/keystone/%2Bbug/1872733/comments/18) |
| --- | --- | --- | --- |

There are at least two use cases, when project admin user or barbican secret owner needs to know user ID (in certain cases they are provisioned automatically, e.g. by LDAP):

\* assign a project role to this user, so he can access the project: [https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project\*](https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project*) fine grained barbican ACL permissions: <https://docs.openstack.org/barbican/latest/api/reference/acls.html>

Therefore it is not clear, whether user IDs or project IDs have to be considered as sensitive.

There are at least two use cases, when project admin user or barbican secret owner needs to know user ID (in certain cases they are provisioned automatically, e.g. by LDAP):
\* assign a project role to this user, so he can access the project: https://docs.openstack.org/api-ref/identity/v3/?expanded=assign-role-to-user-on-project-detail#assign-role-to-user-on-project\* fine grained barbican ACL permissions: https://docs.openstack.org/barbican/latest/api/reference/acls.html
Therefore it is not clear, whether user IDs or project IDs have to be considered as sensitive.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-16: |  |  | [#19](/keystone/%2Bbug/1872733/comments/19) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5355724/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5355724)
  (5.1 KiB,
  text/plain)

Updated release notes in patch to include bug reference

Updated release notes in patch to include bug reference

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#20](/keystone/%2Bbug/1872733/comments/20) |
| --- | --- | --- | --- |

Is a CVE being requested for this? How can we move this forward?

Is a CVE being requested for this? How can we move this forward?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#21](/keystone/%2Bbug/1872733/comments/21) |
| --- | --- | --- | --- |

If we agree that this should be considered a Class A, I can write up an impact description for this.

If we agree that this should be considered a Class A, I can write up an impact description for this.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#22](/keystone/%2Bbug/1872733/comments/22) |
| --- | --- | --- | --- |

First draft below, please review:

Assuming that this affects all currently maintained releases of keystone.

Title: Credentials endpoint policy logic allows changing credential owner and target project ID

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on.

First draft below, please review:
Assuming that this affects all currently maintained releases of keystone.
Title: Credentials endpoint policy logic allows changing credential owner and target project ID
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#23](/keystone/%2Bbug/1872733/comments/23) |
| --- | --- | --- | --- |

> This potentially allows the malicious user to act as the admin on a project another user has the admin role on

... which in many cases can effectively grant the user global admin privileges.

> This potentially allows the malicious user to act as the admin on a project another user has the admin role on
... which in many cases can effectively grant the user global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-27: |  |  | [#24](/keystone/%2Bbug/1872733/comments/24) |
| --- | --- | --- | --- |

Updated, please review:

Title: Credentials endpoint policy logic allows changing credential owner and target project ID

Reporter: kay

Products: Keystone

Affects: <15.0.1, ==16.0.0

Description:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on, which can effectively grant the user global admin privileges.

Updated, please review:
Title: Credentials endpoint policy logic allows changing credential owner and target project ID
Reporter: kay
Products: Keystone
Affects: <15.0.1, ==16.0.0
Description:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential for themselves for a project that they have a specified role on, then perform an update to the credential user and project, allowing them to masquerade as another user. This potentially allows the malicious user to act as the admin on a project another user has the admin role on, which can effectively grant the user global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-27: |  |  | [#25](/keystone/%2Bbug/1872733/comments/25) |
| --- | --- | --- | --- |

lgtm

lgtm

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-27: |  |  | [#26](/keystone/%2Bbug/1872733/comments/26) |
| --- | --- | --- | --- |

Gage's impact description in comment #24 works for me, I think we're set to get a CVE request rolling for this one and propose a disclosure timeline once the stable branch backports are confirmed viable.

Gage's impact description in comment #24 works for me, I think we're set to get a CVE request rolling for this one and propose a disclosure timeline once the stable branch backports are confirmed viable.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-04-30: |  |  | [#27](/keystone/%2Bbug/1872733/comments/27) |
| --- | --- | --- | --- |

Could we get a patch for Stein/Train for this as well?

Waiting on a response for the CVE.

I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Could we get a patch for Stein/Train for this as well?
Waiting on a response for the CVE.
I'd like to propose next Tuesday (May 5th) as the proper disclosure date as well for this. Does that sound reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-30: |  |  | [#28](/keystone/%2Bbug/1872733/comments/28) |
| --- | --- | --- | --- |

* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363821/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-train)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363821)
  (5.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-04-30: |  |  | [#29](/keystone/%2Bbug/1872733/comments/29) |
| --- | --- | --- | --- |

* [0001-Disable-altering-credential-owner-attributes.patch-stein](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363822/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-stein)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363822)
  (5.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-04-30: |  |  | [#30](/keystone/%2Bbug/1872733/comments/30) |
| --- | --- | --- | --- |

May 5 disclosure should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

May 5 disclosure should work as long as we send a downstream stakeholder notification with the patches for this no later than tomorrow (Friday, May 1).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2020-05-01: |  |  | [#31](/keystone/%2Bbug/1872733/comments/31) |
| --- | --- | --- | --- |

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

In retrospect, what with the tight timeline and this being a major holiday weekend for much of the World, let's push the advisory date to Wednesday May 6.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#32](/keystone/%2Bbug/1872733/comments/32) |
| --- | --- | --- | --- |

May 6th works, we will still send out the embargo notification today.

May 6th works, we will still send out the embargo notification today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-01: |  |  | [#33](/keystone/%2Bbug/1872733/comments/33) |
| --- | --- | --- | --- |

Embargo email sent.

Embargo email sent.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nick Tait (nickthetait)](https://launchpad.net/~nickthetait) wrote on 2020-05-01: |  |  | [#34](/keystone/%2Bbug/1872733/comments/34) |
| --- | --- | --- | --- |

I support Class A for this. Eagerly awaiting CVE assignment. Simplified the description a little, you are welcome to use this:

kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential in a project that they have a specified role on, then modify the credential user and project, allowing them to masquerade as another user. This may enable a malicious user to escalate themselves as an admin which (in some environments) is equivalent to gaining global admin privileges.

I support Class A for this. Eagerly awaiting CVE assignment. Simplified the description a little, you are welcome to use this:
kay reported a vulnerability in Keystone's EC2 credentials API. Any authenticated user could create an EC2 credential in a project that they have a specified role on, then modify the credential user and project, allowing them to masquerade as another user. This may enable a malicious user to escalate themselves as an admin which (in some environments) is equivalent to gaining global admin privileges.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Colleen Murphy (krinkle)](https://launchpad.net/~krinkle) wrote on 2020-05-04: |  |  | [#35](/keystone/%2Bbug/1872733/comments/35) |
| --- | --- | --- | --- |

* [bug-1872733.diff](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5365987/%2Bfiles/bug-1872733.diff)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5365987)
  (660 bytes,
  text/plain)

I've reworked this patch to include fixes for [bug 1872733](/bugs/1872733), [bug 1872735](/bugs/1872735) and [bug 1872755](/bugs/1872755) and to resolve the merge conflict arising from the fix for [bug 1872737](/bugs/1872737). These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. I've attached them on [bug 1872735](/bugs/1872735).

In validating the new version I noticed an error in the solution for this bug, attaching the diff here.

I've reworked this patch to include fixes for bug 1872733, bug 1872735 and bug 1872755 and to resolve the merge conflict arising from the fix for bug 1872737. These patches are independently appliable but they won't pass unit tests without also applying the fix for 1873290. I've attached them on bug 1872735.
In validating the new version I noticed an error in the solution for this bug, attaching the diff here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo) wrote on 2020-05-06: |  |  | [#36](/keystone/%2Bbug/1872733/comments/36) |
| --- | --- | --- | --- |

The embargo for this bug has expired, we will be making public and fixes will be available in gerrit here shortly.

The embargo for this bug has expired, we will be making public and fixes will be available in gerrit here shortly.

| **description**: | updated |
| --- | --- |
| **information type**: | Private Security → Public Security |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (master)**](/keystone/%2Bbug/1872733/comments/37) |  |  | [#37](/keystone/%2Bbug/1872733/comments/37) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.opendev.org/725886>

Fix proposed to branch: master
Review: https://review.opendev.org/725886

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/ussuri)**](/keystone/%2Bbug/1872733/comments/38) |  |  | [#38](/keystone/%2Bbug/1872733/comments/38) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: <https://review.opendev.org/725888>

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/725888

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/train)**](/keystone/%2Bbug/1872733/comments/39) |  |  | [#39](/keystone/%2Bbug/1872733/comments/39) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/train

Review: <https://review.opendev.org/725891>

Fix proposed to branch: stable/train
Review: https://review.opendev.org/725891

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/stein)**](/keystone/%2Bbug/1872733/comments/40) |  |  | [#40](/keystone/%2Bbug/1872733/comments/40) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/stein

Review: <https://review.opendev.org/725893>

Fix proposed to branch: stable/stein
Review: https://review.opendev.org/725893

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix proposed to keystone (stable/rocky)**](/keystone/%2Bbug/1872733/comments/41) |  |  | [#41](/keystone/%2Bbug/1872733/comments/41) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/rocky

Review: <https://review.opendev.org/725895>

Fix proposed to branch: stable/rocky
Review: https://review.opendev.org/725895

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2020-05-06

| Changed in ossa: | |
| --- | --- |
| **status**: | Incomplete → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-06:  [**Fix merged to ossa (master)**](/keystone/%2Bbug/1872733/comments/42) |  |  | [#42](/keystone/%2Bbug/1872733/comments/42) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725912>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236>

Submitter: Zuul

Branch: master

commit 2548f46b0aff357f6c953b30179b4d8e151e4236

Author: Gage Hugo <email address hidden>

Date: Wed May 6 10:57:15 2020 -0500

Add OSSA-2020-004 (CVEs Pending)

Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244

    Closes-Bug: #1872735

    Closes-Bug: #1872733

Reviewed: https://review.opendev.org/725912
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=2548f46b0aff357f6c953b30179b4d8e151e4236
Submitter: Zuul
Branch: master
commit 2548f46b0aff357f6c953b30179b4d8e151e4236
Author: Gage Hugo <gagehugo@gmail.com>
Date: Wed May 6 10:57:15 2020 -0500
Add OSSA-2020-004 (CVEs Pending)
Change-Id: Ide28e91b184edab45d22c47661ad6bb6003dd244
Closes-Bug: #1872735
Closes-Bug: #1872733

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix proposed to keystone (stable/pike)**](/keystone/%2Bbug/1872733/comments/43) |  |  | [#43](/keystone/%2Bbug/1872733/comments/43) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/pike

Review: <https://review.opendev.org/726046>

Fix proposed to branch: stable/pike
Review: https://review.opendev.org/726046

[Gage Hugo (gagehugo)](https://launchpad.net/~gagehugo)
on 2020-05-07

| **summary**: | - Keystone V3 /credentials endpoint policy logic allows to change- credentials owner or target project ID+ [OSSA-2020-004] Keystone V3 /credentials endpoint policy logic allows to+ change credentials owner or target project ID (CVE-2020-12691) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-07:  [**Fix merged to keystone (stable/ussuri)**](/keystone/%2Bbug/1872733/comments/44) |  |  | [#44](/keystone/%2Bbug/1872733/comments/44) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725888>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d>

Submitter: Zuul

Branch: stable/ussuri

commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

    (cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

Reviewed: https://review.opendev.org/725888
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Submitter: Zuul
Branch: stable/ussuri
commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)

| **tags**: | added: in-stable-ussuri |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix merged to keystone (master)**](/keystone/%2Bbug/1872733/comments/45) |  |  | [#45](/keystone/%2Bbug/1872733/comments/45) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/725886>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548>

Submitter: Zuul

Branch: master

commit 37e9907a176dad6843819b1bec4946c3aecc4548

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d

    Closes-bug: #1872733

    Closes-bug: #1872755

    Closes-bug: #1872735

Reviewed: https://review.opendev.org/725886
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=37e9907a176dad6843819b1bec4946c3aecc4548
Submitter: Zuul
Branch: master
commit 37e9907a176dad6843819b1bec4946c3aecc4548
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735

| Changed in keystone: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-08:  [**Fix proposed to keystone (stable/queens)**](/keystone/%2Bbug/1872733/comments/46) |  |  | [#46](/keystone/%2Bbug/1872733/comments/46) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/queens

Review: <https://review.opendev.org/726435>

Fix proposed to branch: stable/queens
Review: https://review.opendev.org/726435

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/train)**](/keystone/%2Bbug/1872733/comments/47) |  |  | [#47](/keystone/%2Bbug/1872733/comments/47) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/47/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725891>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29>

Submitter: Zuul

Branch: stable/train

commit 54590544fb7a2cd65e23fce8abcf77296352cd29

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper

    in 52da4d0e12):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Depends-on: htt...

[Read more...](/keystone/%2Bbug/1872733/comments/47)

Reviewed: https://review.opendev.org/725891
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=54590544fb7a2cd65e23fce8abcf77296352cd29
Submitter: Zuul
Branch: stable/train
commit 54590544fb7a2cd65e23fce8abcf77296352cd29
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9, test helper
in 52da4d0e12):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Depends-on: https://review.opendev.org/726526
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)

| **tags**: | added: in-stable-train |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-11:  [**Fix merged to keystone (stable/stein)**](/keystone/%2Bbug/1872733/comments/48) |  |  | [#48](/keystone/%2Bbug/1872733/comments/48) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/48/%2Bdownload) (3.4 KiB)

Reviewed: <https://review.opendev.org/725893>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da>

Submitter: Zuul

Branch: stable/stein

commit 206392a40ce3da3d389e5e7ec721ada2737b84da

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Change-Id: I39d0d705839fbe31ac518ac9a82959e108...

[Read more...](/keystone/%2Bbug/1872733/comments/48)

Reviewed: https://review.opendev.org/725893
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=206392a40ce3da3d389e5e7ec721ada2737b84da
Submitter: Zuul
Branch: stable/stein
commit 206392a40ce3da3d389e5e7ec721ada2737b84da
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)

| **tags**: | added: in-stable-stein |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-13:  [**Fix merged to keystone (stable/rocky)**](/keystone/%2Bbug/1872733/comments/49) |  |  | [#49](/keystone/%2Bbug/1872733/comments/49) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/49/%2Bdownload) (3.9 KiB)

Reviewed: <https://review.opendev.org/725895>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191>

Submitter: Zuul

Branch: stable/rocky

commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keys...

[Read more...](/keystone/%2Bbug/1872733/comments/49)

Reviewed: https://review.opendev.org/725895
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Submitter: Zuul
Branch: stable/rocky
commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)

| **tags**: | added: in-stable-rocky |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-05-14:  [**Fix merged to keystone (stable/queens)**](/keystone/%2Bbug/1872733/comments/50) |  |  | [#50](/keystone/%2Bbug/1872733/comments/50) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/50/%2Bdownload) (4.3 KiB)

Reviewed: <https://review.opendev.org/726435>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a>

Submitter: Zuul

Branch: stable/queens

commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            key...

[Read more...](/keystone/%2Bbug/1872733/comments/50)

Reviewed: https://review.opendev.org/726435
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a
Submitter: Zuul
Branch: stable/queens
commit 487c7276c7608fb11086b9875b0d7cc7cf594a5a
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to token provider refactor between Queens and Rocky. Also
conflicted due to changing method signature for \_authenticate().
keystone/credential/controllers.py
keystone/contrib/ec2/controllers.py
keystone/application\_credential/controllers.py
keystone/token/providers/common.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-06-04:  [**Fix merged to keystone (stable/pike)**](/keystone/%2Bbug/1872733/comments/51) |  |  | [#51](/keystone/%2Bbug/1872733/comments/51) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/keystone/%2Bbug/1872733/comments/51/%2Bdownload) (4.2 KiB)

Reviewed: <https://review.opendev.org/726046>

Committed: <https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe>

Submitter: Zuul

Branch: stable/pike

commit a405e4b71d7de31e81a01f07e02f189650eb66fe

Author: Colleen Murphy <email address hidden>

Date: Tue Apr 14 16:47:44 2020 -0700

Fix security issues with EC2 credentials

This change addresses several issues in the creation and use of EC2/S3

    credentials with keystone tokens.

1. Disable altering credential owner attributes or metadata

Without this patch, an authenticated user can create an EC2 credential

    for themself for a project they have a role on, then update the

    credential to target a user and project completely unrelated to them. In

    the worst case, this could be the admin user and a project the admin

    user has a role assignment on. A token granted for an altered credential

    like this would allow the user to masquerade as the victim user. This

    patch ensures that when updating a credential, the new form of the

    credential is one the acting user has access to: if the system admin

    user is changing the credential, the new user ID or project ID could be

    anything, but regular users may only change the credential to be one

    that they still own.

Relatedly, when a user uses an application credential or a trust to

    create an EC2 credential, keystone automatically adds the trust ID or

    application credential ID as metadata in the EC2 access blob so that it

    knows how the token can be scoped when it is used. Without this patch, a

    user who has created a credential in this way can update the access blob

    to remove or alter this metadata and escalate their privileges to be

    fully authorized for the trustor's, application credential creator's, or

    OAuth1 access token authorizor's privileges on the project. This patch

    fixes the issue by simply disallowing updates to keystone-controlled

    metadata in the credential.

2. Respect token roles when creating EC2 credentials

Without this patch, a trustee, an application credential user, or an

    OAuth1 access token holder could create an EC2 credential or an

    application credential using any roles the trustor, application

    credential creator, or access token authorizor had on the project,

    regardless of whether the creator had delegated only a limited subset of

    roles. This was because the trust\_id attribute of the EC2 access blob

    was ignored, and no metadata for the application credential or access

    token was recorded either. This change ensures that the access

    delegation resource is recorded in the metadata of the EC2 credential

    when created and passed to the token provider when used for

    authentication so that the token provider can look up the correct roles

    for the request.

Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):

          keystone/api/credentials.py

          keystone/tests/unit/test\_v3\_application\_credential.py

          keystone/tests/unit/test\_v3\_credential.py

Conflicts due to flask reorg:

            keyst...

[Read more...](/keystone/%2Bbug/1872733/comments/51)

Reviewed: https://review.opendev.org/726046
Committed: https://git.openstack.org/cgit/openstack/keystone/commit/?id=a405e4b71d7de31e81a01f07e02f189650eb66fe
Submitter: Zuul
Branch: stable/pike
commit a405e4b71d7de31e81a01f07e02f189650eb66fe
Author: Colleen Murphy <colleen.murphy@suse.com>
Date: Tue Apr 14 16:47:44 2020 -0700
Fix security issues with EC2 credentials
This change addresses several issues in the creation and use of EC2/S3
credentials with keystone tokens.
1. Disable altering credential owner attributes or metadata
Without this patch, an authenticated user can create an EC2 credential
for themself for a project they have a role on, then update the
credential to target a user and project completely unrelated to them. In
the worst case, this could be the admin user and a project the admin
user has a role assignment on. A token granted for an altered credential
like this would allow the user to masquerade as the victim user. This
patch ensures that when updating a credential, the new form of the
credential is one the acting user has access to: if the system admin
user is changing the credential, the new user ID or project ID could be
anything, but regular users may only change the credential to be one
that they still own.
Relatedly, when a user uses an application credential or a trust to
create an EC2 credential, keystone automatically adds the trust ID or
application credential ID as metadata in the EC2 access blob so that it
knows how the token can be scoped when it is used. Without this patch, a
user who has created a credential in this way can update the access blob
to remove or alter this metadata and escalate their privileges to be
fully authorized for the trustor's, application credential creator's, or
OAuth1 access token authorizor's privileges on the project. This patch
fixes the issue by simply disallowing updates to keystone-controlled
metadata in the credential.
2. Respect token roles when creating EC2 credentials
Without this patch, a trustee, an application credential user, or an
OAuth1 access token holder could create an EC2 credential or an
application credential using any roles the trustor, application
credential creator, or access token authorizor had on the project,
regardless of whether the creator had delegated only a limited subset of
roles. This was because the trust\_id attribute of the EC2 access blob
was ignored, and no metadata for the application credential or access
token was recorded either. This change ensures that the access
delegation resource is recorded in the metadata of the EC2 credential
when created and passed to the token provider when used for
authentication so that the token provider can look up the correct roles
for the request.
Conflicts (six removal in e2d83ae9, pep8 fixes in e2d83ae9):
keystone/api/credentials.py
keystone/tests/unit/test\_v3\_application\_credential.py
keystone/tests/unit/test\_v3\_credential.py
Conflicts due to flask reorg:
keystone/api/\_shared/EC2\_S3\_Resource.py
keystone/api/credentials.py
keystone/api/users.py
keystone/tests/unit/test\_v3\_credential.py
Moved the test\_update\_credential\_non\_owner unit test to
CredentialSelfServiceTestCase since in this branch the default policies
are not affected by #1872733.
NOTE: the application credential functional changes, along with its
tests were removed from the stable/pike backport as stable/pike does not
support application credentials.
Change-Id: I39d0d705839fbe31ac518ac9a82959e108cb7c1d
Closes-bug: #1872733
Closes-bug: #1872755
Closes-bug: #1872735
(cherry picked from commit 37e9907a176dad6843819b1bec4946c3aecc4548)
(cherry picked from commit 2f2736ebb267c757ad77fcf25ee0aaeefab2a09d)
(cherry picked from commit 27caafe3daa552663719954f2cd6713dd4493178)
(cherry picked from commit bfba75fc3c5c8f119f74dbf31347e008824a2134)
(cherry picked from commit 53d1ccb8a1bdbb5aa0efaacf9739b1a6f436e191)
(cherry picked from commit 6db1bb09a048dfb7f337484698a9a19fdbbe9546)

| **tags**: | added: in-stable-pike |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-08-18:  [**Fix included in openstack/keystone pike-eol**](/keystone/%2Bbug/1872733/comments/52) |  |  | [#52](/keystone/%2Bbug/1872733/comments/52) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone pike-eol release.

This issue was fixed in the openstack/keystone pike-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-01-17:  [**Fix included in openstack/keystone queens-eol**](/keystone/%2Bbug/1872733/comments/53) |  |  | [#53](/keystone/%2Bbug/1872733/comments/53) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone queens-eol release.

This issue was fixed in the openstack/keystone queens-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-06-27:  [**Fix included in openstack/keystone rocky-eol**](/keystone/%2Bbug/1872733/comments/54) |  |  | [#54](/keystone/%2Bbug/1872733/comments/54) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/keystone rocky-eol release.

This issue was fixed in the openstack/keystone rocky-eol release.

[See full activity log](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/keystone/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/keystone/%2Bbug/1872733/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5354247/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5354247 "Change patch details")
* [0001-Disable-altering-credential-owner-attributes.patch](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5355724/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5355724 "Change patch details")
* [train](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363821/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-train)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363821 "Change patch details")
* [0001-Disable-altering-credential-owner-attributes.patch-stein](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5363822/%2Bfiles/0001-Disable-altering-credential-owner-attributes.patch-stein)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5363822 "Change patch details")

* [Add patch](/keystone/%2Bbug/1872733/%2Baddcomment?field.patch=on)

## Bug attachments

* [bug-1872733.diff](https://bugs.launchpad.net/keystone/%2Bbug/1872733/%2Battachment/5365987/%2Bfiles/bug-1872733.diff)
  [Edit](/keystone/%2Bbug/1872733/%2Battachment/5365987 "Change attachment details")

* [Add attachment](/keystone/%2Bbug/1872733/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from review.opendev.org_49c14cc6_20250119_131804.html ===



