=== Content from git.kernel.org_c6ec575f_20250119_115007.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Felix Fietkau <nbd@nbd.name> | 2020-02-20 12:41:39 +0100 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@codeaurora.org> | 2020-03-03 17:30:25 +0200 |
| commit | [b102f0c522cf668c8382c56a4f771b37d011cda2](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b102f0c522cf668c8382c56a4f771b37d011cda2) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)) | |
| tree | [7241c52d1e25587c46fe14df15ee207c0c11eeaf](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=b102f0c522cf668c8382c56a4f771b37d011cda2) | |
| parent | [a9149d243f259ad8f02b1e23dfe8ba06128f15e1](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a9149d243f259ad8f02b1e23dfe8ba06128f15e1) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b102f0c522cf668c8382c56a4f771b37d011cda2&id2=a9149d243f259ad8f02b1e23dfe8ba06128f15e1)) | |
| download | [linux-b102f0c522cf668c8382c56a4f771b37d011cda2.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-b102f0c522cf668c8382c56a4f771b37d011cda2.tar.gz) | |

mt76: fix array overflow on receiving too many fragments for a packetIf the hardware receives an oversized packet with too many rx fragments,
skb\_shinfo(skb)->frags can overflow and corrupt memory of adjacent pages.
This becomes especially visible if it corrupts the freelist pointer of
a slab page.
Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b102f0c522cf668c8382c56a4f771b37d011cda2)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/dma.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/net/wireless/mediatek/mt76/dma.c?id=b102f0c522cf668c8382c56a4f771b37d011cda2) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/dma.c b/drivers/net/wireless/mediatek/mt76/dma.cindex 6173c80189ba3e..1847f55e199b09 100644--- a/[drivers/net/wireless/mediatek/mt76/dma.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/wireless/mediatek/mt76/dma.c?id=a9149d243f259ad8f02b1e23dfe8ba06128f15e1)+++ b/[drivers/net/wireless/mediatek/mt76/dma.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/wireless/mediatek/mt76/dma.c?id=b102f0c522cf668c8382c56a4f771b37d011cda2)@@ -447,10 +447,13 @@ mt76\_add\_fragment(struct mt76\_dev \*dev, struct mt76\_queue \*q, void \*data, struct page \*page = virt\_to\_head\_page(data); int offset = data - page\_address(page); struct sk\_buff \*skb = q->rx\_head;+ struct skb\_shared\_info \*shinfo = skb\_shinfo(skb); - offset += q->buf\_offset;- skb\_add\_rx\_frag(skb, skb\_shinfo(skb)->nr\_frags, page, offset, len,- q->buf\_size);+ if (shinfo->nr\_frags < ARRAY\_SIZE(shinfo->frags)) {+ offset += q->buf\_offset;+ skb\_add\_rx\_frag(skb, shinfo->nr\_frags, page, offset, len,+ q->buf\_size);+ }  if (more) return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-19 10:56:13 +0000



=== Content from github.com_76e8ee3a_20250119_115010.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb102f0c522cf668c8382c56a4f771b37d011cda2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb102f0c522cf668c8382c56a4f771b37d011cda2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  436](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/b102f0c522cf668c8382c56a4f771b37d011cda2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

mt76: fix array overflow on receiving too many fragments for a packet

[Browse files](/torvalds/linux/tree/b102f0c522cf668c8382c56a4f771b37d011cda2)
Browse the repository at this point in the history

```
If the hardware receives an oversized packet with too many rx fragments,
skb_shinfo(skb)->frags can overflow and corrupt memory of adjacent pages.
This becomes especially visible if it corrupts the freelist pointer of
a slab page.

Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
```

* Loading branch information

[![@nbd168](https://avatars.githubusercontent.com/u/2529314?s=40&v=4)](/nbd168)

[nbd168](/torvalds/linux/commits?author=nbd168 "View all commits by nbd168")
authored and
Kalle Valo
committed
Mar 3, 2020

1 parent
[a9149d2](/torvalds/linux/commit/a9149d243f259ad8f02b1e23dfe8ba06128f15e1)

commit b102f0c

Showing
**1 changed file**
with
**6 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

9 changes: 6 additions & 3 deletions

9
[drivers/net/wireless/mediatek/mt76/dma.c](#diff-a0e65fbb151832dd37761f784e3d7f8be3146cbfb3226a18329af4c8802ff765 "drivers/net/wireless/mediatek/mt76/dma.c")

Show comments

[View file](/torvalds/linux/blob/b102f0c522cf668c8382c56a4f771b37d011cda2/drivers/net/wireless/mediatek/mt76/dma.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -447,10 +447,13 @@ mt76\_add\_fragment(struct mt76\_dev \*dev, struct mt76\_queue \*q, void \*data, |
|  |  | struct page \*page = virt\_to\_head\_page(data); |
|  |  | int offset = data - page\_address(page); |
|  |  | struct sk\_buff \*skb = q->rx\_head; |
|  |  | struct skb\_shared\_info \*shinfo = skb\_shinfo(skb); |
|  |  |  |
|  |  | offset += q->buf\_offset; |
|  |  | skb\_add\_rx\_frag(skb, skb\_shinfo(skb)->nr\_frags, page, offset, len, |
|  |  | q->buf\_size); |
|  |  | if (shinfo->nr\_frags < ARRAY\_SIZE(shinfo->frags)) { |
|  |  | offset += q->buf\_offset; |
|  |  | skb\_add\_rx\_frag(skb, shinfo->nr\_frags, page, offset, len, |
|  |  | q->buf\_size); |
|  |  | } |
|  |  |  |
|  |  | if (more) |
|  |  | return; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b102f0c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb102f0c522cf668c8382c56a4f771b37d011cda2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from security.netapp.com_41a9e947_20250119_115011.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [May 2020 Linux Kernel Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20200608-0001)

## May 2020 Linux Kernel Vulnerabilities in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20200608-0001 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20200608-0001 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20200608-0001 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20200608-0001 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20200608-0001
**Version:**
20.0

**Last updated:**
02/07/2023

**Status:**
Interim.

**CVEs:** CVE-2020-10711, CVE-2020-13143, CVE-2020-12888, CVE-2020-12826, CVE-2020-12771, CVE-2020-12770, CVE-2020-12769, CVE-2019-20794, CVE-2019-14898, CVE-2020-12659, CVE-2020-12657, CVE-2020-12655, CVE-2020-12653, CVE-2020-12654, CVE-2020-12652, CVE-2020-12114, CVE-2020-12465, CVE-2020-12464, CVE-2020-11884, CVE-2019-11599, CVE-2020-10690

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 5.7 are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2019-11599](https://nvd.nist.gov/vuln/detail/CVE-2019-11599) | 7.0 (HIGH) | CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-14898](https://nvd.nist.gov/vuln/detail/CVE-2019-14898) | 7.0 (HIGH) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-20794](https://nvd.nist.gov/vuln/detail/CVE-2019-20794) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-10690](https://nvd.nist.gov/vuln/detail/CVE-2020-10690) | 6.4 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-10711](https://nvd.nist.gov/vuln/detail/CVE-2020-10711) | 7.5 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-11884](https://nvd.nist.gov/vuln/detail/CVE-2020-11884) | 7.0 (HIGH) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12114](https://nvd.nist.gov/vuln/detail/CVE-2020-12114) | 4.7 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12464](https://nvd.nist.gov/vuln/detail/CVE-2020-12464) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12465](https://nvd.nist.gov/vuln/detail/CVE-2020-12465) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12652](https://nvd.nist.gov/vuln/detail/CVE-2020-12652) | 6.4 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12653](https://nvd.nist.gov/vuln/detail/CVE-2020-12653) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12654](https://nvd.nist.gov/vuln/detail/CVE-2020-12654) | 9.8 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12655](https://nvd.nist.gov/vuln/detail/CVE-2020-12655) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12657](https://nvd.nist.gov/vuln/detail/CVE-2020-12657) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12659](https://nvd.nist.gov/vuln/detail/CVE-2020-12659) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12769](https://nvd.nist.gov/vuln/detail/CVE-2020-12769) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12770](https://nvd.nist.gov/vuln/detail/CVE-2020-12770) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12771](https://nvd.nist.gov/vuln/detail/CVE-2020-12771) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12826](https://nvd.nist.gov/vuln/detail/CVE-2020-12826) | 8.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H |
| [CVE-2020-12888](https://nvd.nist.gov/vuln/detail/CVE-2020-12888) | 6.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H |
| [CVE-2020-13143](https://nvd.nist.gov/vuln/detail/CVE-2020-13143) | 6.5 (MEDIUM) | CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

#### References

* <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.6.7>

Affected Products
#### Affected Products

* AFF Baseboard Management Controller (BMC) - A700s
* Active IQ Unified Manager for VMware vSphere
* NetApp Cloud Backup (formerly AltaVault)
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp SolidFire Baseboard Management Controller (BMC)
* NetApp SteelStore Cloud Integrated Storage

#### Products Not Affected

* 7-Mode Transition Tool
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Trident
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Insights Acquisition Unit
* Cloud Insights Telegraf Agent
* Cloud Secure Agent
* Cloud Volumes ONTAP Mediator
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Storage Manager
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Python SDK
* FAS/AFF BIOS - 8300/8700/A400
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400
* FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800
* FAS/AFF Service Processor - 8080/8060/8040/8020
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* Inventory Collect Tool
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* NetApp BlueXP
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Performance Analyzer
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SMI-S Provider
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp Storage Services Connector for SAP Landscape Management
* NetApp VASA Provider for Clustered Data ONTAP 9.7 and above
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* OnCommand Insight
* OnCommand Workflow Automation
* SAS Firmware
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* Storage Replication Adapter for Clustered Data ONTAP for VMware vSphere 9.7 and above
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID Baseboard Management Controller (BMC)
* StorageGRID9 (9.x and prior)
* System Manager 9.x
* Virtual Storage Console for VMware vSphere 9.7 and above

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.12> |
| **AFF Baseboard Management Controller (BMC) - A700s** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1323875. First fixed versions include the following: 1.87 |
| **NetApp Cloud Backup (formerly AltaVault)** | NetApp Cloud Backup (formerly AltaVault) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2880179.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H410C** | NetApp HCI Baseboard Management Controller (BMC) - H410C has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610S** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle/downloads> <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/Storage_Firmware_Bundle/downloads> First fixed in storage firmware version 2.76. |
| **NetApp HCI Baseboard Management Controller (BMC) - H615C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp SolidFire & HCI Management Node** | <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/12.5> <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/1.10> |
| **NetApp SolidFire Baseboard Management Controller (BMC)** | NetApp SolidFire Baseboard Management Controller (BMC) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2847476.html%20) for more information. |
| **NetApp SteelStore Cloud Integrated Storage** | NetApp SteelStore Cloud Integrated Storage has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2397079.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20200608-0001>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20200608 | Initial Public Release |
| 2.0 | 20200611 | AFF Baseboard Management Controller (BMC) - A700s moved to Affected Products and Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 3.0 | 20200616 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above moved to Affected Products |
| 4.0 | 20200618 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above moved to Affected Products |
| 5.0 | 20200619 | After additional review FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved from Affected Products to Products Not Affected |
| 6.0 | 20200717 | NetApp Converged Systems Advisor Agent moved to Products Not Affected |
| 7.0 | 20200722 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 8.0 | 20200730 | NetApp HCI Baseboard Management Controller (BMC) - H610C, NetApp HCI Baseboard Management Controller (BMC) - H610S, and NetApp HCI Baseboard Management Controller (BMC) - H615C moved to Affected Products |
| 9.0 | 20200731 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S, and NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 10.0 | 20200901 | NetApp SteelStore Cloud Integrated Storage moved to Won't Fix status |
| 11.0 | 20210205 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 12.0 | 20210209 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 13.0 | 20210414 | NetApp HCI Baseboard Management Controller (BMC) - H610S added to Software Versions and Fixes |
| 14.0 | 20210816 | AFF Baseboard Management Controller (BMC) - A700s added to Software Versions and Fixes |
| 15.0 | 20211012 | NetApp HCI Baseboard Management Controller (BMC) - H410C and NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S moved to Won't Fix status |
| 16.0 | 20211101 | NetApp SolidFire Baseboard Management Controller (BMC) moved to Won't Fix status |
| 17.0 | 20220106 | NetApp Cloud Backup (formerly AltaVault) moved to Won't Fix status |
| 18.0 | 20220527 | NetApp SolidFire & HCI Management Node added to Software Versions and Fixes |
| 19.0 | 20220701 | NetApp HCI Baseboard Management Controller (BMC) - H610C and NetApp HCI Baseboard Management Controller (BMC) - H615C added to Software Versions and Fixes |
| 20.0 | 20230207 | Active IQ Unified Manager for VMware vSphere added to Software Versions and Fixes |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from cdn.kernel.org_08472350_20250119_115007.html ===
commit 7ee76f1601f39ab3941c8b1c9a19dfc58f7cea47
Author: Greg Kroah-Hartman
Date: Wed Mar 18 07:19:20 2020 +0100
Linux 5.5.10
commit 40d816c70e095e684f69978f3a51c94156f84eb5
Author: Karsten Graul
Date: Wed Feb 26 17:52:46 2020 +0100
net/smc: check for valid ib\_client\_data
commit a2f2ef4a54c0d97aa6a8386f4ff23f36ebb488cf upstream.
In smc\_ib\_remove\_dev() check if the provided ib device was actually
initialized for SMC before.
Reported-by: syzbot+84484ccebdd4e5451d91@syzkaller.appspotmail.com
Fixes: a4cf0443c414 ("smc: introduce SMC as an IB-client")
Signed-off-by: Karsten Graul
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8b871cdcbb11ed43c8268f89584e670b4cda7e12
Author: Eric Dumazet
Date: Tue Feb 25 11:52:29 2020 -0800
ipv6: restrict IPV6\_ADDRFORM operation
commit b6f6118901d1e867ac9177bbff3b00b185bd4fdc upstream.
IPV6\_ADDRFORM is able to transform IPv6 socket to IPv4 one.
While this operation sounds illogical, we have to support it.
One of the things it does for TCP socket is to switch sk->sk\_prot
to tcp\_prot.
We now have other layers playing with sk->sk\_prot, so we should make
sure to not interfere with them.
This patch makes sure sk\_prot is the default pointer for TCP IPv6 socket.
syzbot reported :
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD a0113067 P4D a0113067 PUD a8771067 PMD 0
Oops: 0010 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 10686 Comm: syz-executor.0 Not tainted 5.6.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:0x0
Code: Bad RIP value.
RSP: 0018:ffffc9000281fce0 EFLAGS: 00010246
RAX: 1ffffffff15f48ac RBX: ffffffff8afa4560 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff8880a69a8f40
RBP: ffffc9000281fd10 R08: ffffffff86ed9b0c R09: ffffed1014d351f5
R10: ffffed1014d351f5 R11: 0000000000000000 R12: ffff8880920d3098
R13: 1ffff1101241a613 R14: ffff8880a69a8f40 R15: 0000000000000000
FS: 00007f2ae75db700(0000) GS:ffff8880aea00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffffffffd6 CR3: 00000000a3b85000 CR4: 00000000001406f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
inet\_release+0x165/0x1c0 net/ipv4/af\_inet.c:427
\_\_sock\_release net/socket.c:605 [inline]
sock\_close+0xe1/0x260 net/socket.c:1283
\_\_fput+0x2e4/0x740 fs/file\_table.c:280
\_\_\_\_fput+0x15/0x20 fs/file\_table.c:313
task\_work\_run+0x176/0x1b0 kernel/task\_work.c:113
tracehook\_notify\_resume include/linux/tracehook.h:188 [inline]
exit\_to\_usermode\_loop arch/x86/entry/common.c:164 [inline]
prepare\_exit\_to\_usermode+0x480/0x5b0 arch/x86/entry/common.c:195
syscall\_return\_slowpath+0x113/0x4a0 arch/x86/entry/common.c:278
do\_syscall\_64+0x11f/0x1c0 arch/x86/entry/common.c:304
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x45c429
Code: ad b6 fb ff c3 66 2e 0f 1f 84 00 00 00 00 00 66 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 0f 83 7b b6 fb ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007f2ae75dac78 EFLAGS: 00000246 ORIG\_RAX: 0000000000000036
RAX: 0000000000000000 RBX: 00007f2ae75db6d4 RCX: 000000000045c429
RDX: 0000000000000001 RSI: 000000000000011a RDI: 0000000000000004
RBP: 000000000076bf20 R08: 0000000000000038 R09: 0000000000000000
R10: 0000000020000180 R11: 0000000000000246 R12: 00000000ffffffff
R13: 0000000000000a9d R14: 00000000004ccfb4 R15: 000000000076bf2c
Modules linked in:
CR2: 0000000000000000
---[ end trace 82567b5207e87bae ]---
RIP: 0010:0x0
Code: Bad RIP value.
RSP: 0018:ffffc9000281fce0 EFLAGS: 00010246
RAX: 1ffffffff15f48ac RBX: ffffffff8afa4560 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff8880a69a8f40
RBP: ffffc9000281fd10 R08: ffffffff86ed9b0c R09: ffffed1014d351f5
R10: ffffed1014d351f5 R11: 0000000000000000 R12: ffff8880920d3098
R13: 1ffff1101241a613 R14: ffff8880a69a8f40 R15: 0000000000000000
FS: 00007f2ae75db700(0000) GS:ffff8880aea00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffffffffffd6 CR3: 00000000a3b85000 CR4: 00000000001406f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Signed-off-by: Eric Dumazet
Reported-by: syzbot+1938db17e275e85dc328@syzkaller.appspotmail.com
Cc: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 886b6020f3dd9e962b2b583b3a2edb8154f2c48e
Author: Suravee Suthikulpanit
Date: Thu Mar 12 05:18:39 2020 -0500
iommu/amd: Fix IOMMU AVIC not properly update the is\_run bit in IRTE
commit 730ad0ede130015a773229573559e97ba0943065 upstream.
Commit b9c6ff94e43a ("iommu/amd: Re-factor guest virtual APIC
(de-)activation code") accidentally left out the ir\_data pointer when
calling modity\_irte\_ga(), which causes the function amd\_iommu\_update\_ga()
to return prematurely due to struct amd\_ir\_data.ref is NULL and
the "is\_run" bit of IRTE does not get updated properly.
This results in bad I/O performance since IOMMU AVIC always generate GA Log
entry and notify IOMMU driver and KVM when it receives interrupt from the
PCI pass-through device instead of directly inject interrupt to the vCPU.
Fixes by passing ir\_data when calling modify\_irte\_ga() as done previously.
Fixes: b9c6ff94e43a ("iommu/amd: Re-factor guest virtual APIC (de-)activation code")
Signed-off-by: Suravee Suthikulpanit
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit d9a2aa82976559a7f8a469d9c8577aa91145a807
Author: Wolfram Sang
Date: Thu Mar 12 14:32:44 2020 +0100
i2c: acpi: put device when verifying client fails
commit 8daee952b4389729358665fb91949460641659d4 upstream.
i2c\_verify\_client() can fail, so we need to put the device when that
happens.
Fixes: 525e6fabeae2 ("i2c / ACPI: add support for ACPI reconfigure notifications")
Reported-by: Geert Uytterhoeven
Signed-off-by: Wolfram Sang
Reviewed-by: Geert Uytterhoeven
Reviewed-by: Andy Shevchenko
Acked-by: Mika Westerberg
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 6992aa0a741dde0e3d2225c7164db455692e8c64
Author: Daniel Drake
Date: Thu Mar 12 14:09:55 2020 +0800
iommu/vt-d: Ignore devices with out-of-spec domain number
commit da72a379b2ec0bad3eb265787f7008bead0b040c upstream.
VMD subdevices are created with a PCI domain ID of 0x10000 or
higher.
These subdevices are also handled like all other PCI devices by
dmar\_pci\_bus\_notifier().
However, when dmar\_alloc\_pci\_notify\_info() take records of such devices,
it will truncate the domain ID to a u16 value (in info->seg).
The device at (e.g.) 10000:00:02.0 is then treated by the DMAR code as if
it is 0000:00:02.0.
In the unlucky event that a real device also exists at 0000:00:02.0 and
also has a device-specific entry in the DMAR table,
dmar\_insert\_dev\_scope() will crash on:
  BUG\_ON(i >= devices\_cnt);
That's basically a sanity check that only one PCI device matches a
single DMAR entry; in this case we seem to have two matching devices.
Fix this by ignoring devices that have a domain number higher than
what can be looked up in the DMAR table.
This problem was carefully diagnosed by Jian-Hong Pan.
Signed-off-by: Lu Baolu
Signed-off-by: Daniel Drake
Fixes: 59ce0515cdaf3 ("iommu/vt-d: Update DRHD/RMRR/ATSR device scope caches when PCI hotplug happens")
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit e8de7510abd2a55252d9a13ba690b33a7d45d390
Author: Zhenzhong Duan
Date: Thu Mar 12 14:09:54 2020 +0800
iommu/vt-d: Fix the wrong printing in RHSA parsing
commit b0bb0c22c4db623f2e7b1a471596fbf1c22c6dc5 upstream.
When base address in RHSA structure doesn't match base address in
each DRHD structure, the base address in last DRHD is printed out.
This doesn't make sense when there are multiple DRHD units, fix it
by printing the buggy RHSA's base address.
Signed-off-by: Lu Baolu
Signed-off-by: Zhenzhong Duan
Fixes: fd0c8894893cb ("intel-iommu: Set a more specific taint flag for invalid BIOS DMAR tables")
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 19acceae7a2f9a6d080cf0aa0d708c7f52e72d23
Author: Pablo Neira Ayuso
Date: Fri Mar 6 17:37:28 2020 +0100
netfilter: nft\_chain\_nat: inet family is missing module ownership
commit 6a42cefb25d8bdc1b391f4a53c78c32164eea2dd upstream.
Set owner to THIS\_MODULE, otherwise the nft\_chain\_nat module might be
removed while there are still inet/nat chains in place.
[ 117.942096] BUG: unable to handle page fault for address: ffffffffa0d5e040
[ 117.942101] #PF: supervisor read access in kernel mode
[ 117.942103] #PF: error\_code(0x0000) - not-present page
[ 117.942106] PGD 200c067 P4D 200c067 PUD 200d063 PMD 3dc909067 PTE 0
[ 117.942113] Oops: 0000 [#1] PREEMPT SMP PTI
[ 117.942118] CPU: 3 PID: 27 Comm: kworker/3:0 Not tainted 5.6.0-rc3+ #348
[ 117.942133] Workqueue: events nf\_tables\_trans\_destroy\_work [nf\_tables]
[ 117.942145] RIP: 0010:nf\_tables\_chain\_destroy.isra.0+0x94/0x15a [nf\_tables]
[ 117.942149] Code: f6 45 54 01 0f 84 d1 00 00 00 80 3b 05 74 44 48 8b 75 e8 48 c7 c7 72 be de a0 e8 56 e6 2d e0 48 8b 45 e8 48 c7 c7 7f be de a0 <48> 8b 30 e8 43 e6 2d e0 48 8b 45 e8 48 8b 40 10 48 85 c0 74 5b 8b
[ 117.942152] RSP: 0018:ffffc9000015be10 EFLAGS: 00010292
[ 117.942155] RAX: ffffffffa0d5e040 RBX: ffff88840be87fc2 RCX: 0000000000000007
[ 117.942158] RDX: 0000000000000007 RSI: 0000000000000086 RDI: ffffffffa0debe7f
[ 117.942160] RBP: ffff888403b54b50 R08: 0000000000001482 R09: 0000000000000004
[ 117.942162] R10: 0000000000000000 R11: 0000000000000001 R12: ffff8883eda7e540
[ 117.942164] R13: dead000000000122 R14: dead000000000100 R15: ffff888403b3db80
[ 117.942167] FS: 0000000000000000(0000) GS:ffff88840e4c0000(0000) knlGS:0000000000000000
[ 117.942169] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 117.942172] CR2: ffffffffa0d5e040 CR3: 00000003e4c52002 CR4: 00000000001606e0
[ 117.942174] Call Trace:
[ 117.942188] nf\_tables\_trans\_destroy\_work.cold+0xd/0x12 [nf\_tables]
[ 117.942196] process\_one\_work+0x1d6/0x3b0
[ 117.942200] worker\_thread+0x45/0x3c0
[ 117.942203] ? process\_one\_work+0x3b0/0x3b0
[ 117.942210] kthread+0x112/0x130
[ 117.942214] ? kthread\_create\_worker\_on\_cpu+0x40/0x40
[ 117.942221] ret\_from\_fork+0x35/0x40
nf\_tables\_chain\_destroy() crashes on module\_put() because the module is
gone.
Fixes: d164385ec572 ("netfilter: nat: add inet family nat support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit fb99a32fb8ddbcc5507639c301f248045def0b40
Author: Pablo Neira Ayuso
Date: Tue Mar 3 15:02:45 2020 +0100
netfilter: nf\_tables: dump NFTA\_CHAIN\_FLAGS attribute
commit d78008de6103c708171baff9650a7862645d23b0 upstream.
Missing NFTA\_CHAIN\_FLAGS netlink attribute when dumping basechain
definitions.
Fixes: c9626a2cbdb2 ("netfilter: nf\_tables: add hardware offload support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit faad112a61bf6ffc717f514ee4059947a16abd17
Author: Jakub Kicinski
Date: Mon Mar 2 21:08:33 2020 -0800
netfilter: nft\_tunnel: add missing attribute validation for tunnels
commit 88a637719a1570705c02cacb3297af164b1714e7 upstream.
Add missing attribute validation for tunnel source and
destination ports to the netlink policy.
Fixes: af308b94a2a4 ("netfilter: nf\_tables: add tunnel support")
Signed-off-by: Jakub Kicinski
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 0f25d22be9f52d86a4519e9fc048cf5fdbab112d
Author: Jakub Kicinski
Date: Mon Mar 2 21:08:32 2020 -0800
netfilter: nft\_payload: add missing attribute validation for payload csum flags
commit 9d6effb2f1523eb84516e44213c00f2fd9e6afff upstream.
Add missing attribute validation for NFTA\_PAYLOAD\_CSUM\_FLAGS
to the netlink policy.
Fixes: 1814096980bb ("netfilter: nft\_payload: layer 4 checksum adjustment for pseudoheader fields")
Signed-off-by: Jakub Kicinski
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit ac88f8253faa555a698b5e0c8f82173f0a7ffa8c
Author: Jakub Kicinski
Date: Mon Mar 2 21:08:31 2020 -0800
netfilter: cthelper: add missing attribute validation for cthelper
commit c049b3450072b8e3998053490e025839fecfef31 upstream.
Add missing attribute validation for cthelper
to the netlink policy.
Fixes: 12f7a505331e ("netfilter: add user-space connection tracking helper infrastructure")
Signed-off-by: Jakub Kicinski
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit c9c6bcec7e332bdd578dd9561a1b0cab6c01588c
Author: Florian Westphal
Date: Mon Mar 2 21:58:50 2020 +0100
netfilter: nf\_tables: free flowtable hooks on hook register error
commit 2d285f26ecd072800a29c5b71e63437f21ef830a upstream.
If hook registration fails, the hooks allocated via nft\_netdev\_hook\_alloc
need to be freed.
We can't change the goto label to 'goto 5' -- while it does fix the memleak
it does cause a warning splat from the netfilter core (the hooks were not
registered).
Fixes: 3f0465a9ef02 ("netfilter: nf\_tables: dynamically allocate hooks per net\_device in flowtables")
Reported-by: syzbot+a2ff6fa45162a5ed4dd3@syzkaller.appspotmail.com
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 2cbb27243668e2b28f2b67bd86a348e1ad383db2
Author: Tommi Rantala
Date: Thu Mar 5 10:37:13 2020 +0200
perf bench futex-wake: Restore thread count default to online CPU count
commit f649bd9dd5d5004543bbc3c50b829577b49f5d75 upstream.
Since commit 3b2323c2c1c4 ("perf bench futex: Use cpumaps") the default
number of threads the benchmark uses got changed from number of online
CPUs to zero:
$ perf bench futex wake
# Running 'futex/wake' benchmark:
Run summary [PID 15930]: blocking on 0 threads (at [private] futex 0x558b8ee4bfac), waking up 1 at a time.
[Run 1]: Wokeup 0 of 0 threads in 0.0000 ms
[...]
[Run 10]: Wokeup 0 of 0 threads in 0.0000 ms
Wokeup 0 of 0 threads in 0.0004 ms (+-40.82%)
Restore the old behavior by grabbing the number of online CPUs via
cpu->nr:
$ perf bench futex wake
# Running 'futex/wake' benchmark:
Run summary [PID 18356]: blocking on 8 threads (at [private] futex 0xb3e62c), waking up 1 at a time.
[Run 1]: Wokeup 8 of 8 threads in 0.0260 ms
[...]
[Run 10]: Wokeup 8 of 8 threads in 0.0270 ms
Wokeup 8 of 8 threads in 0.0419 ms (+-24.35%)
Fixes: 3b2323c2c1c4 ("perf bench futex: Use cpumaps")
Signed-off-by: Tommi Rantala
Tested-by: Arnaldo Carvalho de Melo
Cc: Alexander Shishkin
Cc: Darren Hart
Cc: Davidlohr Bueso
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: http://lore.kernel.org/lkml/20200305083714.9381-3-tommi.t.rantala@nokia.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 8369caa1ddcbfb464aa10cdb904d58f56524e28a
Author: Jakub Kicinski
Date: Mon Mar 2 21:10:58 2020 -0800
nl80211: add missing attribute validation for channel switch
commit 5cde05c61cbe13cbb3fa66d52b9ae84f7975e5e6 upstream.
Add missing attribute validation for NL80211\_ATTR\_OPER\_CLASS
to the netlink policy.
Fixes: 1057d35ede5d ("cfg80211: introduce TDLS channel switch commands")
Signed-off-by: Jakub Kicinski
Link: https://lore.kernel.org/r/20200303051058.4089398-4-kuba@kernel.org
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 80530e4cfb55a0c3f6ce205249ddb55b0eb65db3
Author: Jakub Kicinski
Date: Mon Mar 2 21:10:57 2020 -0800
nl80211: add missing attribute validation for beacon report scanning
commit 056e9375e1f3c4bf2fd49b70258c7daf788ecd9d upstream.
Add missing attribute validation for beacon report scanning
to the netlink policy.
Fixes: 1d76250bd34a ("nl80211: support beacon report scanning")
Signed-off-by: Jakub Kicinski
Link: https://lore.kernel.org/r/20200303051058.4089398-3-kuba@kernel.org
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 7c0907acd1f0b145bf2c925d8a2e484a48a3cb78
Author: Jakub Kicinski
Date: Mon Mar 2 21:10:56 2020 -0800
nl80211: add missing attribute validation for critical protocol indication
commit 0e1a1d853ecedc99da9d27f9f5c376935547a0e2 upstream.
Add missing attribute validation for critical protocol fields
to the netlink policy.
Fixes: 5de17984898c ("cfg80211: introduce critical protocol indication from user-space")
Signed-off-by: Jakub Kicinski
Link: https://lore.kernel.org/r/20200303051058.4089398-2-kuba@kernel.org
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 4f7ad7d568f79dc17e243d2e3b115fdbb74005c7
Author: Hamish Martin
Date: Tue Mar 10 10:16:18 2020 +1300
i2c: gpio: suppress error on probe defer
commit 3747cd2efe7ecb9604972285ab3f60c96cb753a8 upstream.
If a GPIO we are trying to use is not available and we are deferring
the probe, don't output an error message.
This seems to have been the intent of commit 05c74778858d
("i2c: gpio: Add support for named gpios in DT") but the error was
still output due to not checking the updated 'retdesc'.
Fixes: 05c74778858d ("i2c: gpio: Add support for named gpios in DT")
Signed-off-by: Hamish Martin
Acked-by: Linus Walleij
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 34e8d20c334890a848d5035b9b140f666b6eeaa5
Author: Qian Cai
Date: Thu Mar 5 15:00:46 2020 -0500
iommu/vt-d: Fix RCU-list bugs in intel\_iommu\_init()
commit 2d48ea0efb8887ebba3e3720bb5b738aced4e574 upstream.
There are several places traverse RCU-list without holding any lock in
intel\_iommu\_init(). Fix them by acquiring dmar\_global\_lock.
WARNING: suspicious RCU usage
-----------------------------
drivers/iommu/intel-iommu.c:5216 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
no locks held by swapper/0/1.
Call Trace:
dump\_stack+0xa0/0xea
lockdep\_rcu\_suspicious+0x102/0x10b
intel\_iommu\_init+0x947/0xb13
pci\_iommu\_init+0x26/0x62
do\_one\_initcall+0xfe/0x500
kernel\_init\_freeable+0x45a/0x4f8
kernel\_init+0x11/0x139
ret\_from\_fork+0x3a/0x50
DMAR: Intel(R) Virtualization Technology for Directed I/O
Fixes: d8190dc63886 ("iommu/vt-d: Enable DMA remapping after rmrr mapped")
Signed-off-by: Qian Cai
Acked-by: Lu Baolu
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 28e2f6b183d49964aac587e638f3708a29afb88c
Author: Christoph Hellwig
Date: Wed Mar 11 17:07:10 2020 +0100
driver code: clarify and fix platform device DMA mask allocation
commit e3a36eb6dfaeea8175c05d5915dcf0b939be6dab upstream.
This does three inter-related things to clarify the usage of the
platform device dma\_mask field. In the process, fix the bug introduced
by cdfee5623290 ("driver core: initialize a default DMA mask for
platform device") that caused Artem Tashkinov's laptop to not boot with
newer Fedora kernels.
This does:
- First off, rename the field to "platform\_dma\_mask" to make it
greppable.
We have way too many different random fields called "dma\_mask" in
various data structures, where some of them are actual masks, and
some of them are just pointers to the mask. And the structures all
have pointers to each other, or embed each other inside themselves,
and "pdev" sometimes means "platform device" and sometimes it means
"PCI device".
So to make it clear in the code when you actually use this new field,
give it a unique name (it really should be something even more unique
like "platform\_device\_dma\_mask", since it's per platform device, not
per platform, but that gets old really fast, and this is unique
enough in context).
To further clarify when the field gets used, initialize it when we
actually start using it with the default value.
- Then, use this field instead of the random one-off allocation in
platform\_device\_register\_full() that is now unnecessary since we now
already have a perfectly fine allocation for it in the platform
device structure.
- The above then allows us to fix the actual bug, where the error path
of platform\_device\_register\_full() would unconditionally free the
platform device DMA allocation with 'kfree()'.
That kfree() was dont regardless of whether the allocation had been
done earlier with the (now removed) kmalloc, or whether
setup\_pdev\_dma\_masks() had already been used and the dma\_mask pointer
pointed to the mask that was part of the platform device.
It seems most people never triggered the error path, or only triggered
it from a call chain that set an explicit pdevinfo->dma\_mask value (and
thus caused the unnecessary allocation that was "cleaned up" in the
error path) before calling platform\_device\_register\_full().
Robin Murphy points out that in Artem's case the wdat\_wdt driver failed
in platform\_device\_add(), and that was the one that had called
platform\_device\_register\_full() with pdevinfo.dma\_mask = 0, and would
have caused that kfree() of pdev.dma\_mask corrupting the heap.
A later unrelated kmalloc() then oopsed due to the heap corruption.
Fixes: cdfee5623290 ("driver core: initialize a default DMA mask for platform device")
Reported-bisected-and-tested-by: Artem S. Tashkinov
Reviewed-by: Robin Murphy
Cc: Greg Kroah-Hartman
Signed-off-by: Christoph Hellwig
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4450a7b9e8f7d38814ed303a22ff5016472df8f9
Author: Zhenyu Wang
Date: Tue Mar 3 13:54:12 2020 +0800
drm/i915/gvt: Fix unnecessary schedule timer when no vGPU exits
commit 04d6067f1f19e70a418f92fa3170cf7fe53b7fdf upstream.
From commit f25a49ab8ab9 ("drm/i915/gvt: Use vgpu\_lock to protect per
vgpu access") the vgpu idr destroy is moved later than vgpu resource
destroy, then it would fail to stop timer for schedule policy clean
which to check vgpu idr for any left vGPU. So this trys to destroy
vgpu idr earlier.
Cc: Colin Xu
Fixes: f25a49ab8ab9 ("drm/i915/gvt: Use vgpu\_lock to protect per vgpu access")
Acked-by: Colin Xu
Signed-off-by: Zhenyu Wang
Link: http://patchwork.freedesktop.org/patch/msgid/20200229055445.31481-1-zhenyuw@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit a76b2d3a4c86f64ed92549e3f4f079bd8c62fa4c
Author: Charles Keepax
Date: Fri Feb 28 15:41:42 2020 +0000
pinctrl: core: Remove extra kref\_get which blocks hogs being freed
commit aafd56fc79041bf36f97712d4b35208cbe07db90 upstream.
kref\_init starts with the reference count at 1, which will be balanced
by the pinctrl\_put in pinctrl\_unregister. The additional kref\_get in
pinctrl\_claim\_hogs will increase this count to 2 and cause the hogs to
not get freed when pinctrl\_unregister is called.
Fixes: 6118714275f0 ("pinctrl: core: Fix pinctrl\_register\_and\_init() with pinctrl\_enable()")
Signed-off-by: Charles Keepax
Link: https://lore.kernel.org/r/20200228154142.13860-1-ckeepax@opensource.cirrus.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit dad3e99a617178f642e5b8e8fa83bc7d2c0e76fa
Author: Tina Zhang
Date: Thu Feb 27 09:00:41 2020 +0800
drm/i915/gvt: Fix dma-buf display blur issue on CFL
commit 259170cb4c84f4165a36c0b05811eb74c495412c upstream.
Commit c3b5a8430daad ("drm/i915/gvt: Enable gfx virtualiztion for CFL")
added the support on CFL. The vgpu emulation hotplug support on CFL was
supposed to be included in that patch. Without the vgpu emulation
hotplug support, the dma-buf based display gives us a blur face.
So fix this issue by adding the vgpu emulation hotplug support on CFL.
Fixes: c3b5a8430daad ("drm/i915/gvt: Enable gfx virtualiztion for CFL")
Signed-off-by: Tina Zhang
Acked-by: Zhenyu Wang
Signed-off-by: Zhenyu Wang
Link: http://patchwork.freedesktop.org/patch/msgid/20200227010041.32248-1-tina.zhang@intel.com
(cherry picked from commit 135dde8853c7e00f6002e710f7e4787ed8585c0e)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 6daf40bc08b849cfe9b40d5c37c8494f168fdc7b
Author: Thomas Gleixner
Date: Tue Feb 25 14:55:15 2020 +0100
x86/mce/therm\_throt: Undo thermal polling properly on CPU offline
commit d364847eed890211444ad74496bb549f838c6018 upstream.
Chris Wilson reported splats from running the thermal throttling
workqueue callback on offlined CPUs. The problem is that that callback
should not even run on offlined CPUs but it happens nevertheless because
the offlining callback thermal\_throttle\_offline() does not symmetrically
undo the setup work done in its onlining counterpart. IOW,
1. The thermal interrupt vector should be masked out before ...
2. ... cancelling any pending work synchronously so that no new work is
enqueued anymore.
Do those things and fix the issue properly.
[ bp: Write commit message. ]
Fixes: f6656208f04e ("x86/mce/therm\_throt: Optimize notifications of thermal throttle")
Reported-by: Chris Wilson
Tested-by: Pandruvada, Srinivas
Signed-off-by: Thomas Gleixner
Signed-off-by: Borislav Petkov
Link: https://lkml.kernel.org/r/158120068234.18291.7938335950259651295@skylake-alporthouse-com
Signed-off-by: Greg Kroah-Hartman
commit d01de099fca4289624420ffec63b0b2391ad9bcb
Author: Suman Anna
Date: Mon Feb 24 15:26:43 2020 -0600
virtio\_ring: Fix mem leak with vring\_new\_virtqueue()
commit f13f09a12cbd0c7b776e083c5d008b6c6a9c4e0b upstream.
The functions vring\_new\_virtqueue() and \_\_vring\_new\_virtqueue() are used
with split rings, and any allocations within these functions are managed
outside of the .we\_own\_ring flag. The commit cbeedb72b97a ("virtio\_ring:
allocate desc state for split ring separately") allocates the desc state
within the \_\_vring\_new\_virtqueue() but frees it only when the .we\_own\_ring
flag is set. This leads to a memory leak when freeing such allocated
virtqueues with the vring\_del\_virtqueue() function.
Fix this by moving the desc\_state free code outside the flag and only
for split rings. Issue was discovered during testing with remoteproc
and virtio\_rpmsg.
Fixes: cbeedb72b97a ("virtio\_ring: allocate desc state for split ring separately")
Signed-off-by: Suman Anna
Link: https://lore.kernel.org/r/20200224212643.30672-1-s-anna@ti.com
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Signed-off-by: Greg Kroah-Hartman
commit 84b78a4da93b1ac328a3a390d1791f2f561289df
Author: Leonard Crestez
Date: Thu Feb 20 18:29:37 2020 +0200
pinctrl: imx: scu: Align imx sc msg structs to 4
commit 4c48e549f39f8ed10cf8a0b6cb96f5eddf0391ce upstream.
The imx SC api strongly assumes that messages are composed out of
4-bytes words but some of our message structs have odd sizeofs.
This produces many oopses with CONFIG\_KASAN=y.
Fix by marking with \_\_aligned(4).
Fixes: b96eea718bf6 ("pinctrl: fsl: add scu based pinctrl support")
Signed-off-by: Leonard Crestez
Link: https://lore.kernel.org/r/bd7ad5fd755739a6d8d5f4f65e03b3ca4f457bd2.1582216144.git.leonard.crestez@nxp.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 349e5991e48b9f2302e1617ae7bdff4cb7379c98
Author: Nicolas Belin
Date: Thu Feb 20 14:15:12 2020 +0100
pinctrl: meson-gxl: fix GPIOX sdio pins
commit dc7a06b0dbbafac8623c2b7657e61362f2f479a7 upstream.
In the gxl driver, the sdio cmd and clk pins are inverted. It has not caused
any issue so far because devices using these pins always take both pins
so the resulting configuration is OK.
Fixes: 0f15f500ff2c ("pinctrl: meson: Add GXL pinctrl definitions")
Reviewed-by: Jerome Brunet
Signed-off-by: Nicolas Belin
Link: https://lore.kernel.org/r/1582204512-7582-1-git-send-email-nbelin@baylibre.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit fb36d9b4cb37808dd27781af6214c11b05ad18dd
Author: Anson Huang
Date: Mon Feb 17 11:01:35 2020 +0800
clk: imx8mn: Fix incorrect clock defines
commit 5eb40257047fb11085d582b7b9ccd0bffe900726 upstream.
IMX8MN\_CLK\_I2C4 and IMX8MN\_CLK\_UART1's index definitions are incorrect,
fix them.
Fixes: 1e80936a42e1 ("dt-bindings: imx: Add clock binding doc for i.MX8MN")
Signed-off-by: Anson Huang
Signed-off-by: Shawn Guo
Signed-off-by: Greg Kroah-Hartman
commit dada8dbf1c2172e32a2038419ba906aaa93c2d5f
Author: Sven Eckelmann
Date: Sun Feb 16 13:02:06 2020 +0100
batman-adv: Don't schedule OGM for disabled interface
commit 8e8ce08198de193e3d21d42e96945216e3d9ac7f upstream.
A transmission scheduling for an interface which is currently dropped by
batadv\_iv\_ogm\_iface\_disable could still be in progress. The B.A.T.M.A.N. V
is simply cancelling the workqueue item in an synchronous way but this is
not possible with B.A.T.M.A.N. IV because the OGM submissions are
intertwined.
Instead it has to stop submitting the OGM when it detect that the buffer
pointer is set to NULL.
Reported-by: syzbot+a98f2016f40b9cd3818a@syzkaller.appspotmail.com
Reported-by: syzbot+ac36b6a33c28a491e929@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Sven Eckelmann
Cc: Hillf Danton
Signed-off-by: Simon Wunderlich
Signed-off-by: Greg Kroah-Hartman
commit de1d6cf7f4b86ac0aff7843def2467238028438d
Author: Yonghyun Hwang
Date: Wed Feb 26 12:30:06 2020 -0800
iommu/vt-d: Fix a bug in intel\_iommu\_iova\_to\_phys() for huge page
commit 77a1bce84bba01f3f143d77127b72e872b573795 upstream.
intel\_iommu\_iova\_to\_phys() has a bug when it translates an IOVA for a huge
page onto its corresponding physical address. This commit fixes the bug by
accomodating the level of page entry for the IOVA and adds IOVA's lower
address to the physical address.
Cc:
Acked-by: Lu Baolu
Reviewed-by: Moritz Fischer
Signed-off-by: Yonghyun Hwang
Fixes: 3871794642579 ("VT-d: Changes to support KVM")
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 72751dab23df582dc2a10be7e7878a0243c04ee3
Author: Amol Grover
Date: Sun Feb 23 22:25:39 2020 +0530
iommu/vt-d: Fix RCU list debugging warnings
commit 02d715b4a8182f4887d82df82a7b83aced647760 upstream.
dmar\_drhd\_units is traversed using list\_for\_each\_entry\_rcu()
outside of an RCU read side critical section but under the
protection of dmar\_global\_lock. Hence add corresponding lockdep
expression to silence the following false-positive warnings:
[ 1.603975] =============================
[ 1.603976] WARNING: suspicious RCU usage
[ 1.603977] 5.5.4-stable #17 Not tainted
[ 1.603978] -----------------------------
[ 1.603980] drivers/iommu/intel-iommu.c:4769 RCU-list traversed in non-reader section!!
[ 1.603869] =============================
[ 1.603870] WARNING: suspicious RCU usage
[ 1.603872] 5.5.4-stable #17 Not tainted
[ 1.603874] -----------------------------
[ 1.603875] drivers/iommu/dmar.c:293 RCU-list traversed in non-reader section!!
Tested-by: Madhuparna Bhowmik
Signed-off-by: Amol Grover
Cc: stable@vger.kernel.org
Acked-by: Lu Baolu
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 153a0efacf6cec3d3ce6c939d08982a824d03e7e
Author: Hans de Goede
Date: Mon Mar 9 15:01:38 2020 +0100
iommu/vt-d: dmar\_parse\_one\_rmrr: replace WARN\_TAINT with pr\_warn + add\_taint
commit 96788c7a7f1e7206519d4d736f89a2072dcfe0fc upstream.
Quoting from the comment describing the WARN functions in
include/asm-generic/bug.h:
\* WARN(), WARN\_ON(), WARN\_ON\_ONCE, and so on can be used to report
\* significant kernel issues that need prompt attention if they should ever
\* appear at runtime.
\*
\* Do not use these macros when checking for invalid external inputs
The (buggy) firmware tables which the dmar code was calling WARN\_TAINT
for really are invalid external inputs. They are not under the kernel's
control and the issues in them cannot be fixed by a kernel update.
So logging a backtrace, which invites bug reports to be filed about this,
is not helpful.
Some distros, e.g. Fedora, have tools watching for the kernel backtraces
logged by the WARN macros and offer the user an option to file a bug for
this when these are encountered. The WARN\_TAINT in dmar\_parse\_one\_rmrr
+ another iommu WARN\_TAINT, addressed in another patch, have lead to over
a 100 bugs being filed this way.
This commit replaces the WARN\_TAINT("...") call, with a
pr\_warn(FW\_BUG "...") + add\_taint(TAINT\_FIRMWARE\_WORKAROUND, ...) call
avoiding the backtrace and thus also avoiding bug-reports being filed
about this against the kernel.
Fixes: f5a68bb0752e ("iommu/vt-d: Mark firmware tainted if RMRR fails sanity check")
Signed-off-by: Hans de Goede
Signed-off-by: Joerg Roedel
Acked-by: Lu Baolu
Cc: stable@vger.kernel.org
Cc: Barret Rhoden
Link: https://lore.kernel.org/r/20200309140138.3753-3-hdegoede@redhat.com
BugLink: https://bugzilla.redhat.com/show\_bug.cgi?id=1808874
Signed-off-by: Greg Kroah-Hartman
commit 0960910ac977b07f5fdf00b8f5aa854e8ce653a4
Author: Hans de Goede
Date: Mon Mar 9 15:01:37 2020 +0100
iommu/vt-d: dmar: replace WARN\_TAINT with pr\_warn + add\_taint
commit 59833696442c674acbbd297772ba89e7ad8c753d upstream.
Quoting from the comment describing the WARN functions in
include/asm-generic/bug.h:
\* WARN(), WARN\_ON(), WARN\_ON\_ONCE, and so on can be used to report
\* significant kernel issues that need prompt attention if they should ever
\* appear at runtime.
\*
\* Do not use these macros when checking for invalid external inputs
The (buggy) firmware tables which the dmar code was calling WARN\_TAINT
for really are invalid external inputs. They are not under the kernel's
control and the issues in them cannot be fixed by a kernel update.
So logging a backtrace, which invites bug reports to be filed about this,
is not helpful.
Some distros, e.g. Fedora, have tools watching for the kernel backtraces
logged by the WARN macros and offer the user an option to file a bug for
this when these are encountered. The WARN\_TAINT in warn\_invalid\_dmar()
+ another iommu WARN\_TAINT, addressed in another patch, have lead to over
a 100 bugs being filed this way.
This commit replaces the WARN\_TAINT("...") calls, with
pr\_warn(FW\_BUG "...") + add\_taint(TAINT\_FIRMWARE\_WORKAROUND, ...) calls
avoiding the backtrace and thus also avoiding bug-reports being filed
about this against the kernel.
Fixes: fd0c8894893c ("intel-iommu: Set a more specific taint flag for invalid BIOS DMAR tables")
Fixes: e625b4a95d50 ("iommu/vt-d: Parse ANDD records")
Signed-off-by: Hans de Goede
Signed-off-by: Joerg Roedel
Acked-by: Lu Baolu
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20200309140138.3753-2-hdegoede@redhat.com
BugLink: https://bugzilla.redhat.com/show\_bug.cgi?id=1564895
Signed-off-by: Greg Kroah-Hartman
commit 57c73840b8df2c8f6e0254c87f644f156a925823
Author: Marc Zyngier
Date: Wed Mar 4 11:11:17 2020 +0000
iommu/dma: Fix MSI reservation allocation
commit 65ac74f1de3334852fb7d9b1b430fa5a06524276 upstream.
The way cookie\_init\_hw\_msi\_region() allocates the iommu\_dma\_msi\_page
structures doesn't match the way iommu\_put\_dma\_cookie() frees them.
The former performs a single allocation of all the required structures,
while the latter tries to free them one at a time. It doesn't quite
work for the main use case (the GICv3 ITS where the range is 64kB)
when the base granule size is 4kB.
This leads to a nice slab corruption on teardown, which is easily
observable by simply creating a VF on a SRIOV-capable device, and
tearing it down immediately (no need to even make use of it).
Fortunately, this only affects systems where the ITS isn't translated
by the SMMU, which are both rare and non-standard.
Fix it by allocating iommu\_dma\_msi\_page structures one at a time.
Fixes: 7c1b058c8b5a3 ("iommu/dma: Handle IOMMU API reserved regions")
Signed-off-by: Marc Zyngier
Reviewed-by: Eric Auger
Cc: Robin Murphy
Cc: Joerg Roedel
Cc: Will Deacon
Cc: stable@vger.kernel.org
Reviewed-by: Robin Murphy
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 750f88ea5ed8b49a5410bb570373ed15724000d8
Author: Tony Luck
Date: Tue Feb 25 17:17:37 2020 -0800
x86/mce: Fix logic and comments around MSR\_PPIN\_CTL
commit 59b5809655bdafb0767d3fd00a3e41711aab07e6 upstream.
There are two implemented bits in the PPIN\_CTL MSR:
Bit 0: LockOut (R/WO)
Set 1 to prevent further writes to MSR\_PPIN\_CTL.
Bit 1: Enable\_PPIN (R/W)
If 1, enables MSR\_PPIN to be accessible using RDMSR.
If 0, an attempt to read MSR\_PPIN will cause #GP.
So there are four defined values:
0: PPIN is disabled, PPIN\_CTL may be updated
1: PPIN is disabled. PPIN\_CTL is locked against updates
2: PPIN is enabled. PPIN\_CTL may be updated
3: PPIN is enabled. PPIN\_CTL is locked against updates
Code would only enable the X86\_FEATURE\_INTEL\_PPIN feature for case "2".
When it should have done so for both case "2" and case "3".
Fix the final test to just check for the enable bit. Also fix some of
the other comments in this function.
Fixes: 3f5a7896a509 ("x86/mce: Include the PPIN in MCE records when available")
Signed-off-by: Tony Luck
Signed-off-by: Borislav Petkov
Cc:
Link: https://lkml.kernel.org/r/20200226011737.9958-1-tony.luck@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 529f729b28e19c976b986b36a93da53a2c2f08da
Author: Kim Phillips
Date: Wed Mar 11 14:13:21 2020 -0500
perf/amd/uncore: Replace manual sampling check with CAP\_NO\_INTERRUPT flag
commit f967140dfb7442e2db0868b03b961f9c59418a1b upstream.
Enable the sampling check in kernel/events/core.c::perf\_event\_open(),
which returns the more appropriate -EOPNOTSUPP.
BEFORE:
$ sudo perf record -a -e instructions,l3\_request\_g1.caching\_l3\_cache\_accesses true
Error:
The sys\_perf\_event\_open() syscall returned with 22 (Invalid argument) for event (l3\_request\_g1.caching\_l3\_cache\_accesses).
/bin/dmesg | grep -i perf may provide additional information.
With nothing relevant in dmesg.
AFTER:
$ sudo perf record -a -e instructions,l3\_request\_g1.caching\_l3\_cache\_accesses true
Error:
l3\_request\_g1.caching\_l3\_cache\_accesses: PMU Hardware doesn't support sampling/overflow-interrupts. Try 'perf stat'
Fixes: c43ca5091a37 ("perf/x86/amd: Add support for AMD NB and L2I "uncore" counters")
Signed-off-by: Kim Phillips
Signed-off-by: Borislav Petkov
Acked-by: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20200311191323.13124-1-kim.phillips@amd.com
Signed-off-by: Greg Kroah-Hartman
commit fc09229baaaf75e068302b060f7f21548ba2ded6
Author: Felix Fietkau
Date: Thu Feb 20 12:41:39 2020 +0100
mt76: fix array overflow on receiving too many fragments for a packet
commit b102f0c522cf668c8382c56a4f771b37d011cda2 upstream.
If the hardware receives an oversized packet with too many rx fragments,
skb\_shinfo(skb)->frags can overflow and corrupt memory of adjacent pages.
This becomes especially visible if it corrupts the freelist pointer of
a slab page.
Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 6710853e488e03a4ee22a104c1f076fc15f54330
Author: Jarkko Nikula
Date: Thu Feb 13 17:15:03 2020 +0200
i2c: designware-pci: Fix BUG\_ON during device removal
commit 9be8bc4dd6177cf992b93b0bd014c4f611283896 upstream.
Function i2c\_dw\_pci\_remove() -> pci\_free\_irq\_vectors() ->
pci\_disable\_msi() -> free\_msi\_irqs() will throw a BUG\_ON() for MSI
enabled device since the driver has not released the requested IRQ before
calling the pci\_free\_irq\_vectors().
Here driver requests an IRQ using devm\_request\_irq() but automatic
release happens only after remove callback. Fix this by explicitly
freeing the IRQ before calling pci\_free\_irq\_vectors().
Fixes: 21aa3983d619 ("i2c: designware-pci: Switch over to MSI interrupts")
Cc: stable@vger.kernel.org # v5.4+
Signed-off-by: Jarkko Nikula
Reviewed-by: Andy Shevchenko
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 68002f17e2a7c2dd0150826327b71b55a2787ed2
Author: Vladis Dronov
Date: Sun Mar 8 09:08:55 2020 +0100
efi: Add a sanity check to efivar\_store\_raw()
commit d6c066fda90d578aacdf19771a027ed484a79825 upstream.
Add a sanity check to efivar\_store\_raw() the same way
efivar\_{attr,size,data}\_read() and efivar\_show\_raw() have it.
Signed-off-by: Vladis Dronov
Signed-off-by: Ard Biesheuvel
Signed-off-by: Ingo Molnar
Cc:
Link: https://lore.kernel.org/r/20200305084041.24053-3-vdronov@redhat.com
Link: https://lore.kernel.org/r/20200308080859.21568-25-ardb@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4364b5e357ead9245f29f5ec567f244a804aaf62
Author: Vladis Dronov
Date: Sun Mar 8 09:08:54 2020 +0100
efi: Fix a race and a buffer overflow while reading efivars via sysfs
commit 286d3250c9d6437340203fb64938bea344729a0e upstream.
There is a race and a buffer overflow corrupting a kernel memory while
reading an EFI variable with a size more than 1024 bytes via the older
sysfs method. This happens because accessing struct efi\_variable in
efivar\_{attr,size,data}\_read() and friends is not protected from
a concurrent access leading to a kernel memory corruption and, at best,
to a crash. The race scenario is the following:
CPU0: CPU1:
efivar\_attr\_read()
var->DataSize = 1024;
efivar\_entry\_get(... &var->DataSize)
down\_interruptible(&efivars\_lock)
efivar\_attr\_read() // same EFI var
var->DataSize = 1024;
efivar\_entry\_get(... &var->DataSize)
down\_interruptible(&efivars\_lock)
virt\_efi\_get\_variable()
// returns EFI\_BUFFER\_TOO\_SMALL but
// var->DataSize is set to a real
// var size more than 1024 bytes
up(&efivars\_lock)
virt\_efi\_get\_variable()
// called with var->DataSize set
// to a real var size, returns
// successfully and overwrites
// a 1024-bytes kernel buffer
up(&efivars\_lock)
This can be reproduced by concurrent reading of an EFI variable which size
is more than 1024 bytes:
ts# for cpu in $(seq 0 $(nproc --ignore=1)); do ( taskset -c $cpu \
cat /sys/firmware/efi/vars/KEKDefault\*/size & ) ; done
Fix this by using a local variable for a var's data buffer size so it
does not get overwritten.
Fixes: e14ab23dde12b80d ("efivars: efivar\_entry API")
Reported-by: Bob Sanders  and the LTP testsuite
Signed-off-by: Vladis Dronov
Signed-off-by: Ard Biesheuvel
Signed-off-by: Ingo Molnar
Cc:
Link: https://lore.kernel.org/r/20200305084041.24053-2-vdronov@redhat.com
Link: https://lore.kernel.org/r/20200308080859.21568-24-ardb@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 91b3829766c5645e95bc9be10d44c24a68760a99
Author: Tom Lendacky
Date: Tue Mar 10 18:35:57 2020 +0100
x86/ioremap: Map EFI runtime services data as encrypted for SEV
commit 985e537a4082b4635754a57f4f95430790afee6a upstream.
The dmidecode program fails to properly decode the SMBIOS data supplied
by OVMF/UEFI when running in an SEV guest. The SMBIOS area, under SEV, is
encrypted and resides in reserved memory that is marked as EFI runtime
services data.
As a result, when memremap() is attempted for the SMBIOS data, it
can't be mapped as regular RAM (through try\_ram\_remap()) and, since
the address isn't part of the iomem resources list, it isn't mapped
encrypted through the fallback ioremap().
Add a new \_\_ioremap\_check\_other() to deal with memory types like
EFI\_RUNTIME\_SERVICES\_DATA which are not covered by the resource ranges.
This allows any runtime services data which has been created encrypted,
to be mapped encrypted too.
[ bp: Move functionality to a separate function. ]
Signed-off-by: Tom Lendacky
Signed-off-by: Borislav Petkov
Reviewed-by: Joerg Roedel
Tested-by: Joerg Roedel
Cc:  # 5.3
Link: https://lkml.kernel.org/r/2d9e16eb5b53dc82665c95c6764b7407719df7a0.1582645327.git.thomas.lendacky@amd.com
Signed-off-by: Greg Kroah-Hartman
commit 46f25715f60e648dd664ae9c43a90c8a8aa83553
Author: Wolfram Sang
Date: Tue Mar 3 13:50:46 2020 +0100
macintosh: windfarm: fix MODINFO regression
commit bcf3588d8ed3517e6ffaf083f034812aee9dc8e2 upstream.
Commit af503716ac14 made sure OF devices get an OF style modalias with
I2C events. It assumed all in-tree users were converted, yet it missed
some Macintosh drivers.
Add an OF module device table for all windfarm drivers to make them
automatically load again.
Fixes: af503716ac14 ("i2c: core: report OF style module alias for devices registered via OF")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=199471
Reported-by: Erhard Furtner
Tested-by: Erhard Furtner
Acked-by: Michael Ellerman  (powerpc)
Signed-off-by: Wolfram Sang
Cc: stable@kernel.org # v4.17+
Signed-off-by: Greg Kroah-Hartman
commit 6964a5a247e6f01d89a47630367adba1b2dbb178
Author: Corey Minyard
Date: Fri Mar 6 11:23:14 2020 -0600
pid: Fix error return value in some cases
commit b26ebfe12f34f372cf041c6f801fa49c3fb382c5 upstream.
Recent changes to alloc\_pid() allow the pid number to be specified on
the command line. If set\_tid\_size is set, then the code scanning the
levels will hard-set retval to -EPERM, overriding it's previous -ENOMEM
value.
After the code scanning the levels, there are error returns that do not
set retval, assuming it is still set to -ENOMEM.
So set retval back to -ENOMEM after scanning the levels.
Fixes: 49cb2fc42ce4 ("fork: extend clone3() to support setting a PID")
Signed-off-by: Corey Minyard
Acked-by: Christian Brauner
Cc: Andrei Vagin
Cc: Dmitry Safonov <0x7f454c46@gmail.com>
Cc: Oleg Nesterov
Cc: Adrian Reber
Cc:  # 5.5
Link: https://lore.kernel.org/r/20200306172314.12232-1-minyard@acm.org
[christian.brauner@ubuntu.com: fixup commit message]
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit c0128764695f27d908428e118b56a66b731d3cf6
Author: Eric Biggers
Date: Thu Mar 5 00:41:38 2020 -0800
fscrypt: don't evict dirty inodes after removing key
commit 2b4eae95c7361e0a147b838715c8baa1380a428f upstream.
After FS\_IOC\_REMOVE\_ENCRYPTION\_KEY removes a key, it syncs the
filesystem and tries to get and put all inodes that were unlocked by the
key so that unused inodes get evicted via fscrypt\_drop\_inode().
Normally, the inodes are all clean due to the sync.
However, after the filesystem is sync'ed, userspace can modify and close
one of the files. (Userspace is \*supposed\* to close the files before
removing the key. But it doesn't always happen, and the kernel can't
assume it.) This causes the inode to be dirtied and have i\_count == 0.
Then, fscrypt\_drop\_inode() failed to consider this case and indicated
that the inode can be dropped, causing the write to be lost.
On f2fs, other problems such as a filesystem freeze could occur due to
the inode being freed while still on f2fs's dirty inode list.
Fix this bug by making fscrypt\_drop\_inode() only drop clean inodes.
I've written an xfstest which detects this bug on ext4, f2fs, and ubifs.
Fixes: b1c0ec3599f4 ("fscrypt: add FS\_IOC\_REMOVE\_ENCRYPTION\_KEY ioctl")
Cc:  # v5.4+
Link: https://lore.kernel.org/r/20200305084138.653498-1-ebiggers@kernel.org
Signed-off-by: Eric Biggers
Signed-off-by: Greg Kroah-Hartman
commit 148119c2d43f92c63eff571b7504b50273c2196a
Author: Tejun Heo
Date: Tue Mar 10 13:07:46 2020 -0400
blk-iocost: fix incorrect vtime comparison in iocg\_is\_idle()
commit dcd6589b11d3b1e71f516a87a7b9646ed356b4c0 upstream.
vtimes may wrap and time\_before/after64() should be used to determine
whether a given vtime is before or after another. iocg\_is\_idle() was
incorrectly using plain "<" comparison do determine whether done\_vtime
is before vtime. Here, the only thing we're interested in is whether
done\_vtime matches vtime which indicates that there's nothing in
flight. Let's test for inequality instead.
Signed-off-by: Tejun Heo
Fixes: 7caa47151ab2 ("blkcg: implement blk-iocost")
Cc: stable@vger.kernel.org # v5.4+
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit ffa2d7340d4fbfecd5e01ec66502cab18cc15d84
Author: Artem Savkov
Date: Fri Mar 6 18:43:17 2020 +0100
ftrace: Return the first found result in lookup\_rec()
commit d9815bff6b379ff46981bea9dfeb146081eab314 upstream.
It appears that ip ranges can overlap so. In that case lookup\_rec()
returns whatever results it got last even if it found nothing in last
searched page.
This breaks an obscure livepatch late module patching usecase:
- load livepatch
- load the patched module
- unload livepatch
- try to load livepatch again
To fix this return from lookup\_rec() as soon as it found the record
containing searched-for ip. This used to be this way prior lookup\_rec()
introduction.
Link: http://lkml.kernel.org/r/20200306174317.21699-1-asavkov@redhat.com
Cc: stable@vger.kernel.org
Fixes: 7e16f581a817 ("ftrace: Separate out functionality from ftrace\_location\_range()")
Signed-off-by: Artem Savkov
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit f6a85df83f5df29d0a914268168189ffd0443efa
Author: Takashi Iwai
Date: Wed Feb 5 10:31:46 2020 +0100
ipmi\_si: Avoid spurious errors for optional IRQs
commit 443d372d6a96cd94ad119e5c14bb4d63a536a7f6 upstream.
Although the IRQ assignment in ipmi\_si driver is optional,
platform\_get\_irq() spews error messages unnecessarily:
ipmi\_si dmi-ipmi-si.0: IRQ index 0 not found
Fix this by switching to platform\_get\_irq\_optional().
Cc: stable@vger.kernel.org # 5.4.x
Cc: John Donnelly
Fixes: 7723f4c5ecdb ("driver core: platform: Add an error message to platform\_get\_irq\*()")
Reported-and-tested-by: Patrick Vo
Signed-off-by: Takashi Iwai
Message-Id: <20200205093146.1352-1-tiwai@suse.de>
Signed-off-by: Corey Minyard
Signed-off-by: Greg Kroah-Hartman
commit 5f7c9989f11305aaa43e0f4378f4f070022a9f2b
Author: Stefan Haberland
Date: Thu Mar 12 14:17:15 2020 +0100
s390/dasd: fix data corruption for thin provisioned devices
commit 5e6bdd37c5526ef01326df5dabb93011ee89237e upstream.
Devices are formatted in multiple of tracks.
For an Extent Space Efficient (ESE) volume we get errors when accessing
unformatted tracks. In this case the driver either formats the track on
the flight for write requests or returns zero data for read requests.
In case a request spans multiple tracks, the indication of an unformatted
track presented for the first track is incorrectly applied to all tracks
covered by the request. As a result, tracks containing data will be handled
as empty, resulting in zero data being returned on read, or overwriting
existing data with zero on write.
Fix by determining the track that gets the NRF error.
For write requests only format the track that is surely not formatted.
For Read requests all tracks before have returned valid data and should not
be touched.
All tracks after the unformatted track might be formatted or not. Those are
returned to the blocklayer to build a new request.
When using alias devices there is a chance that multiple write requests
trigger a format of the same track which might lead to data loss. Ensure
that a track is formatted only once by maintaining a list of currently
processed tracks.
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Cc: stable@vger.kernel.org # 5.3+
Signed-off-by: Stefan Haberland
Reviewed-by: Jan Hoeppner
Reviewed-by: Peter Oberparleiter
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 671963b7b3db885f56f4a4559274190400989e34
Author: Paul Cercueil
Date: Tue Feb 25 12:28:09 2020 -0300
MIPS: Fix CONFIG\_MIPS\_CMDLINE\_DTB\_EXTEND handling
commit 8e029eb0bcd6a7fab6dc9191152c085784c31ee6 upstream.
The CONFIG\_MIPS\_CMDLINE\_DTB\_EXTEND option is used so that the kernel
arguments provided in the 'bootargs' property in devicetree are extended
with the kernel arguments provided by the bootloader.
The code was broken, as it didn't actually take any of the kernel
arguments provided in devicetree when that option was set.
Fixes: 7784cac69735 ("MIPS: cmdline: Clean up boot\_command\_line initialization")
Cc: stable@vger.kernel.org
Signed-off-by: Paul Cercueil
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit f4901adae1b69e2d1c69f9597be8fd4eab60227a
Author: H. Nikolaus Schaller
Date: Fri Mar 6 18:28:30 2020 +0100
MIPS: DTS: CI20: fix interrupt for pcf8563 RTC
commit 130ab8819d81bd96f1a71e8461a8f73edf1fbe82 upstream.
Interrupts should not be specified by interrupt line but by
gpio parent and reference.
Fixes: 73f2b940474d ("MIPS: CI20: DTS: Add I2C nodes")
Cc: stable@vger.kernel.org
Signed-off-by: H. Nikolaus Schaller
Reviewed-by: Paul Cercueil
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 177f6f6badf5d032037bf21d13e56184feaa171b
Author: H. Nikolaus Schaller
Date: Fri Mar 6 18:27:58 2020 +0100
MIPS: DTS: CI20: fix PMU definitions for ACT8600
commit e8d87a0b822d4b3d9a94a5da915f93aa1b674c93 upstream.
There is a ACT8600 on the CI20 board and the bindings of the
ACT8865 driver have changed without updating the CI20 device
tree. Therefore the PMU can not be probed successfully and
is running in power-on reset state.
Fix DT to match the latest act8865-regulator bindings.
Fixes: 73f2b940474d ("MIPS: CI20: DTS: Add I2C nodes")
Cc: stable@vger.kernel.org
Signed-off-by: H. Nikolaus Schaller
Reviewed-by: Paul Cercueil
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 2031a50a17f2f3b99d5fc9b6b8fe85688b139a5b
Author: Miklos Szeredi
Date: Thu Feb 13 09:16:07 2020 +0100
fuse: fix stack use after return
commit 3e8cb8b2eaeb22f540f1cbc00cbb594047b7ba89 upstream.
Normal, synchronous requests will have their args allocated on the stack.
After the FR\_FINISHED bit is set by receiving the reply from the userspace
fuse server, the originating task may return and reuse the stack frame,
resulting in an Oops if the args structure is dereferenced.
Fix by setting a flag in the request itself upon initializing, indicating
whether it has an asynchronous ->end() callback.
Reported-by: Kyle Sanderson
Reported-by: Michael Stapelberg
Fixes: 2b319d1f6f92 ("fuse: don't dereference req->args on finished request")
Cc:  # v5.4
Tested-by: Michael Stapelberg
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 7114a8a8d3b7d11d04888f6c41849690bfbfc54c
Author: Eugeniy Paltsev
Date: Wed Mar 11 19:26:43 2020 +0300
ARC: define \_\_ALIGN\_STR and \_\_ALIGN symbols for ARC
commit 8d92e992a785f35d23f845206cf8c6cafbc264e0 upstream.
The default defintions use fill pattern 0x90 for padding which for ARC
generates unintended "ldh\_s r12,[r0,0x20]" corresponding to opcode 0x9090
So use ".align 4" which insert a "nop\_s" instruction instead.
Cc: stable@vger.kernel.org
Acked-by: Vineet Gupta
Signed-off-by: Eugeniy Paltsev
Signed-off-by: Vineet Gupta
Signed-off-by: Greg Kroah-Hartman
commit 721cff8874d63a180b851bb4efce9663090a16df
Author: Vitaly Kuznetsov
Date: Mon Mar 9 16:52:11 2020 +0100
KVM: nVMX: avoid NULL pointer dereference with incorrect EVMCS GPAs
commit 95fa10103dabc38be5de8efdfced5e67576ed896 upstream.
When an EVMCS enabled L1 guest on KVM will tries doing enlightened VMEnter
with EVMCS GPA = 0 the host crashes because the
evmcs\_gpa != vmx->nested.hv\_evmcs\_vmptr
condition in nested\_vmx\_handle\_enlightened\_vmptrld() will evaluate to
false (as nested.hv\_evmcs\_vmptr is zeroed after init). The crash will
happen on vmx->nested.hv\_evmcs pointer dereference.
Another problematic EVMCS ptr value is '-1' but it only causes host crash
after nested\_release\_evmcs() invocation. The problem is exactly the same as
with '0', we mistakenly think that the EVMCS pointer hasn't changed and
thus nested.hv\_evmcs\_vmptr is valid.
Resolve the issue by adding an additional !vmx->nested.hv\_evmcs
check to nested\_vmx\_handle\_enlightened\_vmptrld(), this way we will
always be trying kvm\_vcpu\_map() when nested.hv\_evmcs is NULL
and this is supposed to catch all invalid EVMCS GPAs.
Also, initialize hv\_evmcs\_vmptr to '0' in nested\_release\_evmcs()
to be consistent with initialization where we don't currently
set hv\_evmcs\_vmptr to '-1'.
Cc: stable@vger.kernel.org
Signed-off-by: Vitaly Kuznetsov
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 6e094de6d3aeb68b00487b9a4238a01bb459856d
Author: Vitaly Kuznetsov
Date: Tue Mar 3 15:33:15 2020 +0100
KVM: x86: clear stale x86\_emulate\_ctxt->intercept value
commit 342993f96ab24d5864ab1216f46c0b199c2baf8e upstream.
After commit 07721feee46b ("KVM: nVMX: Don't emulate instructions in guest
mode") Hyper-V guests on KVM stopped booting with:
kvm\_nested\_vmexit: rip fffff802987d6169 reason EPT\_VIOLATION info1 181
info2 0 int\_info 0 int\_info\_err 0
kvm\_page\_fault: address febd0000 error\_code 181
kvm\_emulate\_insn: 0:fffff802987d6169: f3 a5
kvm\_emulate\_insn: 0:fffff802987d6169: f3 a5 FAIL
kvm\_inj\_exception: #UD (0x0)
"f3 a5" is a "rep movsw" instruction, which should not be intercepted
at all. Commit c44b4c6ab80e ("KVM: emulate: clean up initializations in
init\_decode\_cache") reduced the number of fields cleared by
init\_decode\_cache() claiming that they are being cleared elsewhere,
'intercept', however, is left uncleared if the instruction does not have
any of the "slow path" flags (NotImpl, Stack, Op3264, Sse, Mmx, CheckPerm,
NearBranch, No16 and of course Intercept itself).
Fixes: c44b4c6ab80e ("KVM: emulate: clean up initializations in init\_decode\_cache")
Fixes: 07721feee46b ("KVM: nVMX: Don't emulate instructions in guest mode")
Cc: stable@vger.kernel.org
Suggested-by: Paolo Bonzini
Signed-off-by: Vitaly Kuznetsov
Reviewed-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 295f65553b411d3dbf32bcd5bdd44f351bdcf577
Author: Al Viro
Date: Tue Mar 10 09:31:41 2020 -0400
gfs2\_atomic\_open(): fix O\_EXCL|O\_CREAT handling on cold dcache
commit 21039132650281de06a169cbe8a0f7e5c578fd8b upstream.
with the way fs/namei.c:do\_last() had been done, ->atomic\_open()
instances needed to recognize the case when existing file got
found with O\_EXCL|O\_CREAT, either by falling back to finish\_no\_open()
or failing themselves. gfs2 one didn't.
Fixes: 6d4ade986f9c (GFS2: Add atomic\_open support)
Cc: stable@kernel.org # v3.11
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit a1ab1c60a5f33773b77b8deb894f311c7105db85
Author: Al Viro
Date: Thu Mar 12 18:25:20 2020 -0400
cifs\_atomic\_open(): fix double-put on late allocation failure
commit d9a9f4849fe0c9d560851ab22a85a666cddfdd24 upstream.
several iterations of ->atomic\_open() calling conventions ago, we
used to need fput() if ->atomic\_open() failed at some point after
successful finish\_open(). Now (since 2016) it's not needed -
struct file carries enough state to make fput() work regardless
of the point in struct file lifecycle and discarding it on
failure exits in open() got unified. Unfortunately, I'd missed
the fact that we had an instance of ->atomic\_open() (cifs one)
that used to need that fput(), as well as the stale comment in
finish\_open() demanding such late failure handling. Trivially
fixed...
Fixes: fe9ec8291fca "do\_last(): take fput() on error after opening to out:"
Cc: stable@kernel.org # v4.7+
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit b032c163acfbd7fe4aa2ff189d9cc55e9791ad5d
Author: Shin'ichiro Kawasaki
Date: Fri Feb 21 10:37:08 2020 +0900
block: Fix partition support for host aware zoned block devices
commit b53df2e7442c73a932fb74228147fb946e531585 upstream.
Commit b72053072c0b ("block: allow partitions on host aware zone
devices") introduced the helper function disk\_has\_partitions() to check
if a given disk has valid partitions. However, since this function result
directly depends on the disk partition table length rather than the
actual existence of valid partitions in the table, it returns true even
after all partitions are removed from the disk. For host aware zoned
block devices, this results in zone management support to be kept
disabled even after removing all partitions.
Fix this by changing disk\_has\_partitions() to walk through the partition
table entries and return true if and only if a valid non-zero size
partition is found.
Fixes: b72053072c0b ("block: allow partitions on host aware zone devices")
Cc: stable@vger.kernel.org # 5.5
Reviewed-by: Damien Le Moal
Reviewed-by: Johannes Thumshirn
Reviewed-by: Christoph Hellwig
Signed-off-by: Shin'ichiro Kawasaki
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 1839a61e26ae5f6cdf228e3aa72067d891dc5953
Author: Steven Rostedt (VMware)
Date: Mon Mar 9 16:00:11 2020 -0400
ktest: Add timeout for ssh sync testing
commit 4d00fc477a2ce8b6d2b09fb34ef9fe9918e7d434 upstream.
Before rebooting the box, a "ssh sync" is called to the test machine to see
if it is alive or not. But if the test machine is in a partial state, that
ssh may never actually finish, and the ktest test hangs.
Add a 10 second timeout to the sync test, which will fail after 10 seconds
and then cause the test to reboot the test machine.
Cc: stable@vger.kernel.org
Fixes: 6474ace999edd ("ktest.pl: Powercycle the box on reboot if no connection can be made")
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit bddb07a930ffe5e22402d102a8f61c9c4128dca5
Author: Linus Walleij
Date: Mon Mar 9 16:26:04 2020 +0100
pinctrl: qcom: Assign irq\_eoi conditionally
commit 1cada2f307665e208a486d7ac2294ed9a6f74a6f upstream.
The hierarchical parts of MSM pinctrl/GPIO is only
used when the device tree has a "wakeup-parent" as
a phandle, but the .irq\_eoi is anyway assigned leading
to semantic problems on elder Qualcomm chipsets.
When the drivers/mfd/qcom-pm8xxx.c driver calls
chained\_irq\_exit() that call will in turn call chip->irq\_eoi()
which is set to irq\_chip\_eoi\_parent() by default on a
hierachical IRQ chip, and the parent is pinctrl-msm.c
so that will in turn unconditionally call
irq\_chip\_eoi\_parent() again, but its parent is invalid
so we get the following crash:
Unnable to handle kernel NULL pointer dereference at
virtual address 00000010
pgd = (ptrval)
[00000010] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
(...)
PC is at irq\_chip\_eoi\_parent+0x4/0x10
LR is at pm8xxx\_irq\_handler+0x1b4/0x2d8
If we solve this crash by avoiding to call up to
irq\_chip\_eoi\_parent(), the machine will hang and get
reset by the watchdog, because of semantic issues,
probably inside irq\_chip.
As a solution, just assign the .irq\_eoi conditionally if
we are actually using a wakeup parent.
Cc: David Heidelberg
Cc: Bjorn Andersson
Cc: Lina Iyer
Cc: Stephen Boyd
Cc: stable@vger.kernel.org
Fixes: e35a6ae0eb3a ("pinctrl/msm: Setup GPIO chip in hierarchy")
Link: https://lore.kernel.org/r/20200306121221.1231296-1-linus.walleij@linaro.org
Link: https://lore.kernel.org/r/20200309125207.571840-1-linus.walleij@linaro.org
Link: https://lore.kernel.org/r/20200309152604.585112-1-linus.walleij@linaro.org
Tested-by: David Heidelberg
Acked-by: Marc Zyngier
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit b1a978aa5a2cfd6f37284e9336978b15e5983c71
Author: Mathias Kresin
Date: Thu Mar 5 19:22:45 2020 +0100
pinctrl: falcon: fix syntax error
commit d62e7fbea4951c124a24176da0c7bf3003ec53d4 upstream.
Add the missing semicolon after of\_node\_put to get the file compiled.
Fixes: f17d2f54d36d ("pinctrl: falcon: Add of\_node\_put() before return")
Cc: stable@vger.kernel.org # v5.4+
Signed-off-by: Mathias Kresin
Link: https://lore.kernel.org/r/20200305182245.9636-1-dev@kresin.me
Acked-by: Thomas Langer
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 6addf8cea846093a0b1f83eadc9ba73014766ead
Author: Ben Chuang
Date: Wed Feb 19 17:29:00 2020 +0800
mmc: sdhci-pci-gli: Enable MSI interrupt for GL975x
commit 31e43f31890ca6e909b27dcb539252b46aa465da upstream.
Enable MSI interrupt for GL9750/GL9755. Some platforms
do not support PCI INTx and devices can not work without
interrupt. Like messages below:
[ 4.487132] sdhci-pci 0000:01:00.0: SDHCI controller found [17a0:9755] (rev 0)
[ 4.487198] ACPI BIOS Error (bug): Could not resolve symbol [\\_SB.PCI0.PBR2.\_PRT.APS2], AE\_NOT\_FOUND (20190816/psargs-330)
[ 4.487397] ACPI Error: Aborting method \\_SB.PCI0.PBR2.\_PRT due to previous error (AE\_NOT\_FOUND) (20190816/psparse-529)
[ 4.487707] pcieport 0000:00:01.3: can't derive routing for PCI INT A
[ 4.487709] sdhci-pci 0000:01:00.0: PCI INT A: no GSI
Signed-off-by: Ben Chuang
Tested-by: Raul E Rangel
Fixes: e51df6ce668a ("mmc: host: sdhci-pci: Add Genesys Logic GL975x support")
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20200219092900.9151-1-benchuanggli@gmail.com
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit be0e53f10e05d58740478ff1416a0d9b456cc2ce
Author: Chris Wilson
Date: Fri Mar 6 11:30:10 2020 +0000
drm/i915/execlists: Enable timeslice on partial virtual engine dequeue
commit eafc2aa20fba319b6e791a1b0c45a91511eccb6b upstream.
If we stop filling the ELSP due to an incompatible virtual engine
request, check if we should enable the timeslice on behalf of the queue.
This fixes the case where we are inspecting the last->next element when
we know that the last element is the last request in the execution queue,
and so decided we did not need to enable timeslicing despite the intent
to do so!
Fixes: 8ee36e048c98 ("drm/i915/execlists: Minimalistic timeslicing")
Signed-off-by: Chris Wilson
Cc: Mika Kuoppala
Cc: Tvrtko Ursulin
Cc:  # v5.4+
Reviewed-by: Mika Kuoppala
Link: https://patchwork.freedesktop.org/patch/msgid/20200306113012.3184606-1-chris@chris-wilson.co.uk
(cherry picked from commit 3df2deed411e0f1b7312baf0139aab8bba4c0410)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit ce5922168a2a3257df2a1718f65eaaeffd37fe73
Author: Chris Wilson
Date: Fri Mar 6 15:46:47 2020 +0000
drm/i915/gt: Close race between cacheline\_retire and free
commit 8ea6bb8e4d47e07518e5dba4f5cb77e210f0df82 upstream.
If the cacheline may still be busy, atomically mark it for future
release, and only if we can determine that it will never be used again,
immediately free it.
Closes: https://gitlab.freedesktop.org/drm/intel/issues/1392
Fixes: ebece7539242 ("drm/i915: Keep timeline HWSP allocated until idle across the system")
Signed-off-by: Chris Wilson
Cc: Tvrtko Ursulin
Cc: Mika Kuoppala
Cc: Matthew Auld
Reviewed-by: Mika Kuoppala
Cc:  # v5.2+
Link: https://patchwork.freedesktop.org/patch/msgid/20200306154647.3528345-1-chris@chris-wilson.co.uk
(cherry picked from commit 2d4bd971f5baa51418625f379a69f5d58b5a0450)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 371f7a3e0cde7c5cd1e0c7c95af60b05e7c9277e
Author: Chris Wilson
Date: Tue Mar 10 10:17:20 2020 +0000
drm/i915: Defer semaphore priority bumping to a workqueue
commit 14a0d527a479eb2cb6067f9e5e163e1bf35db2a9 upstream.
Since the semaphore fence may be signaled from inside an interrupt
handler from inside a request holding its request->lock, we cannot then
enter into the engine->active.lock for processing the semaphore priority
bump as we may traverse our call tree and end up on another held
request.
CPU 0:
[ 2243.218864] \_raw\_spin\_lock\_irqsave+0x9a/0xb0
[ 2243.218867] i915\_schedule\_bump\_priority+0x49/0x80 [i915]
[ 2243.218869] semaphore\_notify+0x6d/0x98 [i915]
[ 2243.218871] \_\_i915\_sw\_fence\_complete+0x61/0x420 [i915]
[ 2243.218874] ? kmem\_cache\_free+0x211/0x290
[ 2243.218876] i915\_sw\_fence\_complete+0x58/0x80 [i915]
[ 2243.218879] dma\_i915\_sw\_fence\_wake+0x3e/0x80 [i915]
[ 2243.218881] signal\_irq\_work+0x571/0x690 [i915]
[ 2243.218883] irq\_work\_run\_list+0xd7/0x120
[ 2243.218885] irq\_work\_run+0x1d/0x50
[ 2243.218887] smp\_irq\_work\_interrupt+0x21/0x30
[ 2243.218889] irq\_work\_interrupt+0xf/0x20
CPU 1:
[ 2242.173107] \_raw\_spin\_lock+0x8f/0xa0
[ 2242.173110] \_\_i915\_request\_submit+0x64/0x4a0 [i915]
[ 2242.173112] \_\_execlists\_submission\_tasklet+0x8ee/0x2120 [i915]
[ 2242.173114] ? i915\_sched\_lookup\_priolist+0x1e3/0x2b0 [i915]
[ 2242.173117] execlists\_submit\_request+0x2e8/0x2f0 [i915]
[ 2242.173119] submit\_notify+0x8f/0xc0 [i915]
[ 2242.173121] \_\_i915\_sw\_fence\_complete+0x61/0x420 [i915]
[ 2242.173124] ? \_raw\_spin\_unlock\_irqrestore+0x39/0x40
[ 2242.173137] i915\_sw\_fence\_complete+0x58/0x80 [i915]
[ 2242.173140] i915\_sw\_fence\_commit+0x16/0x20 [i915]
Closes: https://gitlab.freedesktop.org/drm/intel/issues/1318
Fixes: b7404c7ecb38 ("drm/i915: Bump ready tasks ahead of busywaits")
Signed-off-by: Chris Wilson
Cc: Tvrtko Ursulin
Cc:  # v5.2+
Reviewed-by: Tvrtko Ursulin
Link: https://patchwork.freedesktop.org/patch/msgid/20200310101720.9944-1-chris@chris-wilson.co.uk
(cherry picked from commit 209df10bb4536c81c2540df96c02cd079435357f)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 56bb6bbb7d6e0ebb5b95229da54eca01b74ddbe9
Author: Matthew Auld
Date: Thu Mar 5 20:35:34 2020 +0000
drm/i915: be more solid in checking the alignment
commit 1d61c5d711a2dc0b978ae905535edee9601f9449 upstream.
The alignment is u64, and yet is\_power\_of\_2() assumes unsigned long,
which might give different results between 32b and 64b kernel.
Signed-off-by: Matthew Auld
Cc: Chris Wilson
Reviewed-by: Chris Wilson
Signed-off-by: Chris Wilson
Link: https://patchwork.freedesktop.org/patch/msgid/20200305203534.210466-1-matthew.auld@intel.com
Cc: stable@vger.kernel.org
(cherry picked from commit 2920516b2f719546f55079bc39a7fe409d9e80ab)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 9c757343dfed3bad886b527ebfe24825a2e61eff
Author: Chris Wilson
Date: Thu Mar 5 13:48:22 2020 +0000
drm/i915: Return early for await\_start on same timeline
commit c951b0af2dddbb1f34be103029eb9030392d5554 upstream.
Requests within a timeline are ordered by that timeline, so awaiting for
the start of a request within the timeline is a no-op. This used to work
by falling out of the mutex\_trylock() as the signaler and waiter had the
same timeline and not returning an error.
Fixes: 6a79d848403d ("drm/i915: Lock signaler timeline while navigating")
Signed-off-by: Chris Wilson
Cc: Tvrtko Ursulin
Cc:  # v5.5+
Reviewed-by: Tvrtko Ursulin
Link: https://patchwork.freedesktop.org/patch/msgid/20200305134822.2750496-1-chris@chris-wilson.co.uk
(cherry picked from commit ab7a69020fb5d5c7ba19fba60f62fd6f9ca9f779)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 10456606d668d1f4758eed569408d93e3cb55039
Author: Chris Wilson
Date: Thu Mar 5 10:42:10 2020 +0000
drm/i915: Actually emit the await\_start
commit c67b35d970ed3391069c21f3071a26f687399ab2 upstream.
Fix the inverted test to emit the wait on the end of the previous
request if we /haven't/ already.
Fixes: 6a79d848403d ("drm/i915: Lock signaler timeline while navigating")
Signed-off-by: Chris Wilson
Cc: Tvrtko Ursulin
Cc:  # v5.5+
Reviewed-by: Tvrtko Ursulin
Link: https://patchwork.freedesktop.org/patch/msgid/20200305104210.2619967-1-chris@chris-wilson.co.uk
(cherry picked from commit 07e9c59d63df6a1c44c1975c01827ba18b69270a)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 6ef49e0481c0ebc3019a919192f0122eb167260a
Author: Colin Ian King
Date: Fri Nov 8 14:45:27 2019 +0000
drm/amd/display: remove duplicated assignment to grph\_obj\_type
commit d785476c608c621b345dd9396e8b21e90375cb0e upstream.
Variable grph\_obj\_type is being assigned twice, one of these is
redundant so remove it.
Addresses-Coverity: ("Evaluation order violation")
Signed-off-by: Colin Ian King
Signed-off-by: Alex Deucher
Cc:
Signed-off-by: Greg Kroah-Hartman
commit ad2e2d9b194ea63b2147f022f2a1179a1913a047
Author: Hillf Danton
Date: Fri Jan 24 20:14:45 2020 -0500
workqueue: don't use wq\_select\_unbound\_cpu() for bound works
commit aa202f1f56960c60e7befaa0f49c72b8fa11b0a8 upstream.
wq\_select\_unbound\_cpu() is designed for unbound workqueues only, but
it's wrongly called when using a bound workqueue too.
Fixing this ensures work queued to a bound workqueue with
cpu=WORK\_CPU\_UNBOUND always runs on the local CPU.
Before, that would happen only if wq\_unbound\_cpumask happened to include
it (likely almost always the case), or was empty, or we got lucky with
forced round-robin placement. So restricting
/sys/devices/virtual/workqueue/cpumask to a small subset of a machine's
CPUs would cause some bound work items to run unexpectedly there.
Fixes: ef557180447f ("workqueue: schedule WORK\_CPU\_UNBOUND work on wq\_unbound\_cpumask CPUs")
Cc: stable@vger.kernel.org # v4.5+
Signed-off-by: Hillf Danton
[dj: massage changelog]
Signed-off-by: Daniel Jordan
Cc: Tejun Heo
Cc: Lai Jiangshan
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 04cfa2387d9e5e582dde567c5831fec9d70a1215
Author: Vasily Averin
Date: Tue Feb 25 10:07:12 2020 +0300
netfilter: x\_tables: xt\_mttg\_seq\_next should increase position index
commit ee84f19cbbe9cf7cba2958acb03163fed3ecbb0f upstream.
If .next function does not change position index,
following .show function will repeat output related
to current position index.
Without patch:
# dd if=/proc/net/ip\_tables\_matches # original file output
conntrack
conntrack
conntrack
recent
recent
icmp
udplite
udp
tcp
0+1 records in
0+1 records out
65 bytes copied, 5.4074e-05 s, 1.2 MB/s
# dd if=/proc/net/ip\_tables\_matches bs=62 skip=1
dd: /proc/net/ip\_tables\_matches: cannot skip to specified offset
cp <<< end of last line
tcp <<< and then unexpected whole last line once again
0+1 records in
0+1 records out
7 bytes copied, 0.000102447 s, 68.3 kB/s
Cc: stable@vger.kernel.org
Fixes: 1f4aace60b0e ("fs/seq\_file.c: simplify seq\_file iteration code ...")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=206283
Signed-off-by: Vasily Averin
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 9a9aafa2d7bebb600c66e239880561ea5175c9c5
Author: Vasily Averin
Date: Tue Feb 25 10:06:29 2020 +0300
netfilter: xt\_recent: recent\_seq\_next should increase position index
commit db25517a550926f609c63054b12ea9ad515e1a10 upstream.
If .next function does not change position index,
following .show function will repeat output related
to current position index.
Without the patch:
# dd if=/proc/net/xt\_recent/SSH # original file outpt
src=127.0.0.4 ttl: 0 last\_seen: 6275444819 oldest\_pkt: 1 6275444819
src=127.0.0.2 ttl: 0 last\_seen: 6275438906 oldest\_pkt: 1 6275438906
src=127.0.0.3 ttl: 0 last\_seen: 6275441953 oldest\_pkt: 1 6275441953
0+1 records in
0+1 records out
204 bytes copied, 6.1332e-05 s, 3.3 MB/s
Read after lseek into middle of last line (offset 140 in example below)
generates expected end of last line and then unexpected whole last line
once again
# dd if=/proc/net/xt\_recent/SSH bs=140 skip=1
dd: /proc/net/xt\_recent/SSH: cannot skip to specified offset
127.0.0.3 ttl: 0 last\_seen: 6275441953 oldest\_pkt: 1 6275441953
src=127.0.0.3 ttl: 0 last\_seen: 6275441953 oldest\_pkt: 1 6275441953
0+1 records in
0+1 records out
132 bytes copied, 6.2487e-05 s, 2.1 MB/s
Cc: stable@vger.kernel.org
Fixes: 1f4aace60b0e ("fs/seq\_file.c: simplify seq\_file iteration code ...")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=206283
Signed-off-by: Vasily Averin
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit ee8f0dcd28550c9742d0ef92639a0c3b379b8d15
Author: Vasily Averin
Date: Tue Feb 25 10:05:59 2020 +0300
netfilter: synproxy: synproxy\_cpu\_seq\_next should increase position index
commit bb71f846a0002239f7058c84f1496648ff4a5c20 upstream.
If .next function does not change position index,
following .show function will repeat output related
to current position index.
Cc: stable@vger.kernel.org
Fixes: 1f4aace60b0e ("fs/seq\_file.c: simplify seq\_file iteration code ...")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=206283
Signed-off-by: Vasily Averin
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit b784bfda4d2e9247726264079d511898fe8cd60d
Author: Vasily Averin
Date: Tue Feb 25 10:05:47 2020 +0300
netfilter: nf\_conntrack: ct\_cpu\_seq\_next should increase position index
commit dc15af8e9dbd039ebb06336597d2c491ef46ab74 upstream.
If .next function does not change position index,
following .show function will repeat output related
to current position index.
Cc: stable@vger.kernel.org
Fixes: 1f4aace60b0e ("fs/seq\_file.c: simplify seq\_file iteration code ...")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=206283
Signed-off-by: Vasily Averin
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 3efdf5120a3a83ca59ce4226bc46b2544fb71ba6
Author: Hans de Goede
Date: Mon Mar 9 19:25:10 2020 +0100
iommu/vt-d: quirk\_ioat\_snb\_local\_iommu: replace WARN\_TAINT with pr\_warn + add\_taint
commit 81ee85d0462410de8eeeec1b9761941fd6ed8c7b upstream.
Quoting from the comment describing the WARN functions in
include/asm-generic/bug.h:
\* WARN(), WARN\_ON(), WARN\_ON\_ONCE, and so on can be used to report
\* significant kernel issues that need prompt attention if they should ever
\* appear at runtime.
\*
\* Do not use these macros when checking for invalid external inputs
The (buggy) firmware tables which the dmar code was calling WARN\_TAINT
for really are invalid external inputs. They are not under the kernel's
control and the issues in them cannot be fixed by a kernel update.
So logging a backtrace, which invites bug reports to be filed about this,
is not helpful.
Fixes: 556ab45f9a77 ("ioat2: catch and recover from broken vtd configurations v6")
Signed-off-by: Hans de Goede
Acked-by: Lu Baolu
Link: https://lore.kernel.org/r/20200309182510.373875-1-hdegoede@redhat.com
BugLink: https://bugzilla.redhat.com/show\_bug.cgi?id=701847
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit 96d7ef4945f2054aa86144f2c564e7667e49e27f
Author: Halil Pasic
Date: Thu Feb 13 13:37:27 2020 +0100
virtio-blk: fix hw\_queue stopped on arbitrary error
commit f5f6b95c72f7f8bb46eace8c5306c752d0133daa upstream.
Since nobody else is going to restart our hw\_queue for us, the
blk\_mq\_start\_stopped\_hw\_queues() is in virtblk\_done() is not sufficient
necessarily sufficient to ensure that the queue will get started again.
In case of global resource outage (-ENOMEM because mapping failure,
because of swiotlb full) our virtqueue may be empty and we can get
stuck with a stopped hw\_queue.
Let us not stop the queue on arbitrary errors, but only on -EONSPC which
indicates a full virtqueue, where the hw\_queue is guaranteed to get
started by virtblk\_done() before when it makes sense to carry on
submitting requests. Let us also remove a stale comment.
Signed-off-by: Halil Pasic
Cc: Jens Axboe
Fixes: f7728002c1c7 ("virtio\_ring: fix return code on DMA mapping fails")
Link: https://lore.kernel.org/r/20200213123728.61216-2-pasic@linux.ibm.com
Signed-off-by: Michael S. Tsirkin
Reviewed-by: Stefan Hajnoczi
Signed-off-by: Greg Kroah-Hartman
commit 6cfd18c6f32c6516e6930d1a58d3e0c5aeb9fd09
Author: Dan Moulding
Date: Tue Jan 28 02:31:07 2020 -0700
iwlwifi: mvm: Do not require PHY\_SKU NVM section for 3168 devices
commit a9149d243f259ad8f02b1e23dfe8ba06128f15e1 upstream.
The logic for checking required NVM sections was recently fixed in
commit b3f20e098293 ("iwlwifi: mvm: fix NVM check for 3168
devices"). However, with that fixed the else is now taken for 3168
devices and within the else clause there is a mandatory check for the
PHY\_SKU section. This causes the parsing to fail for 3168 devices.
The PHY\_SKU section is really only mandatory for the IWL\_NVM\_EXT
layout (the phy\_sku parameter of iwl\_parse\_nvm\_data is only used when
the NVM type is IWL\_NVM\_EXT). So this changes the PHY\_SKU section
check so that it's only mandatory for IWL\_NVM\_EXT.
Fixes: b3f20e098293 ("iwlwifi: mvm: fix NVM check for 3168 devices")
Signed-off-by: Dan Moulding
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 27ec80ad29c889b144a7c716093774bcb2adcba2
Author: Florian Westphal
Date: Thu Mar 5 11:15:36 2020 +0100
netfilter: nf\_tables: fix infinite loop when expr is not available
commit 1d305ba40eb8081ff21eeb8ca6ba5c70fd920934 upstream.
nft will loop forever if the kernel doesn't support an expression:
1. nft\_expr\_type\_get() appends the family specific name to the module list.
2. -EAGAIN is returned to nfnetlink, nfnetlink calls abort path.
3. abort path sets ->done to true and calls request\_module for the
expression.
4. nfnetlink replays the batch, we end up in nft\_expr\_type\_get() again.
5. nft\_expr\_type\_get attempts to append family-specific name. This
one already exists on the list, so we continue
6. nft\_expr\_type\_get adds the generic expression name to the module
list. -EAGAIN is returned, nfnetlink calls abort path.
7. abort path encounters the family-specific expression which
has 'done' set, so it gets removed.
8. abort path requests the generic expression name, sets done to true.
9. batch is replayed.
If the expression could not be loaded, then we will end up back at 1),
because the family-specific name got removed and the cycle starts again.
Note that userspace can SIGKILL the nft process to stop the cycle, but
the desired behaviour is to return an error after the generic expr name
fails to load the expression.
Fixes: eb014de4fd418 ("netfilter: nf\_tables: autoload modules from the abort path")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit de9d0ad764628a55a9e1d46a7d6bd30acd1a02a2
Author: Michal Koutný
Date: Fri Jan 24 12:40:15 2020 +0100
cgroup: Iterate tasks that did not finish do\_exit()
commit 9c974c77246460fa6a92c18554c3311c8c83c160 upstream.
PF\_EXITING is set earlier than actual removal from css\_set when a task
is exitting. This can confuse cgroup.procs readers who see no PF\_EXITING
tasks, however, rmdir is checking against css\_set membership so it can
transitionally fail with EBUSY.
Fix this by listing tasks that weren't unlinked from css\_set active
lists.
It may happen that other users of the task iterator (without
CSS\_TASK\_ITER\_PROCS) spot a PF\_EXITING task before cgroup\_exit(). This
is equal to the state before commit c03cd7738a83 ("cgroup: Include dying
leaders with live threads in PROCS iterations") but it may be reviewed
later.
Reported-by: Suren Baghdasaryan
Fixes: c03cd7738a83 ("cgroup: Include dying leaders with live threads in PROCS iterations")
Signed-off-by: Michal Koutný
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 3f605480ac77e07429cea5fef223d1fa3bcf6d35
Author: Vasily Averin
Date: Thu Jan 30 13:34:59 2020 +0300
cgroup: cgroup\_procs\_next should increase position index
commit 2d4ecb030dcc90fb725ecbfc82ce5d6c37906e0e upstream.
If seq\_file .next fuction does not change position index,
read after some lseek can generate unexpected output:
1) dd bs=1 skip output of each 2nd elements
$ dd if=/sys/fs/cgroup/cgroup.procs bs=8 count=1
2
3
4
5
1+0 records in
1+0 records out
8 bytes copied, 0,000267297 s, 29,9 kB/s
[test@localhost ~]$ dd if=/sys/fs/cgroup/cgroup.procs bs=1 count=8
2
4 <<< NB! 3 was skipped
6 <<< ... and 5 too
8 <<< ... and 7
8+0 records in
8+0 records out
8 bytes copied, 5,2123e-05 s, 153 kB/s
This happen because \_\_cgroup\_procs\_start() makes an extra
extra cgroup\_procs\_next() call
2) read after lseek beyond end of file generates whole last line.
3) read after lseek into middle of last line generates
expected rest of last line and unexpected whole line once again.
Additionally patch removes an extra position index changes in
\_\_cgroup\_procs\_start()
Cc: stable@vger.kernel.org
https://bugzilla.kernel.org/show\_bug.cgi?id=206283
Signed-off-by: Vasily Averin
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 13be570b96c53d191ca764cce763a0f62578ba5c
Author: Qian Cai
Date: Sun Feb 23 22:00:07 2020 -0500
cgroup: fix psi\_show() crash on 32bit ino archs
commit 190ecb190a9cd8c0599d8499b901e3c32e87966a upstream.
Similar to the commit d7495343228f ("cgroup: fix incorrect
WARN\_ON\_ONCE() in cgroup\_setup\_root()"), cgroup\_id(root\_cgrp) does not
equal to 1 on 32bit ino archs which triggers all sorts of issues with
psi\_show() on s390x. For example,
BUG: KASAN: slab-out-of-bounds in collect\_percpu\_times+0x2d0/
Read of size 4 at addr 000000001e0ce000 by task read\_all/3667
collect\_percpu\_times+0x2d0/0x798
psi\_show+0x7c/0x2a8
seq\_read+0x2ac/0x830
vfs\_read+0x92/0x150
ksys\_read+0xe2/0x188
system\_call+0xd8/0x2b4
Fix it by using cgroup\_ino().
Fixes: 743210386c03 ("cgroup: use cgrp->kn->id as the cgroup ID")
Signed-off-by: Qian Cai
Acked-by: Johannes Weiner
Signed-off-by: Tejun Heo
Cc: stable@vger.kernel.org # v5.5
Signed-off-by: Greg Kroah-Hartman
commit 914e916e2066117823c6e84f79c592f16cce19e8
Author: Florian Fainelli
Date: Thu Feb 20 15:34:53 2020 -0800
net: phy: Avoid multiple suspends
commit 503ba7c6961034ff0047707685644cad9287c226 upstream.
It is currently possible for a PHY device to be suspended as part of a
network device driver's suspend call while it is still being attached to
that net\_device, either via phy\_suspend() or implicitly via phy\_stop().
Later on, when the MDIO bus controller get suspended, we would attempt
to suspend again the PHY because it is still attached to a network
device.
This is both a waste of time and creates an opportunity for improper
clock/power management bugs to creep in.
Fixes: 803dd9c77ac3 ("net: phy: avoid suspending twice a PHY")
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 36afe8b14e893f800e5d138263308e48a1e14e44
Author: Andrew Lunn
Date: Wed Mar 11 21:02:31 2020 +0100
net: dsa: mv88e6xxx: Add missing mask of ATU occupancy register
[ Upstream commit 012fc74517b25177dfede2ed45cd108258564e4a ]
Only the bottom 12 bits contain the ATU bin occupancy statistics. The
upper bits need masking off.
Fixes: e0c69ca7dfbb ("net: dsa: mv88e6xxx: Add ATU occupancy via devlink resources")
Signed-off-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 833110c7d72b45f7071d58efbb61f0314ba5ff07
Author: Andrew Lunn
Date: Wed Mar 11 16:24:24 2020 +0100
net: dsa: Don't instantiate phylink for CPU/DSA ports unless needed
[ Upstream commit a20f997010c4ec76eaa55b8cc047d76dcac69f70 ]
By default, DSA drivers should configure CPU and DSA ports to their
maximum speed. In many configurations this is sufficient to make the
link work.
In some cases it is necessary to configure the link to run slower,
e.g. because of limitations of the SoC it is connected to. Or back to
back PHYs are used and the PHY needs to be driven in order to
establish link. In this case, phylink is used.
Only instantiate phylink if it is required. If there is no PHY, or no
fixed link properties, phylink can upset a link which works in the
default configuration.
Fixes: 0e27921816ad ("net: dsa: Use PHYLINK for the CPU/DSA ports")
Signed-off-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f4bd31aeeaf53c4fdf5ef04384b946d4694dcb3d
Author: Julian Wiedmann
Date: Tue Mar 10 18:38:02 2020 +0100
s390/qeth: handle error when backing RX buffer
[ Upstream commit 17413852804d7e86e6f0576cca32c1541817800e ]
qeth\_init\_qdio\_queues() fills the RX ring with an initial set of
RX buffers. If qeth\_init\_input\_buffer() fails to back one of the RX
buffers with memory, we need to bail out and report the error.
Fixes: 4a71df50047f ("qeth: new qeth device driver")
Signed-off-by: Julian Wiedmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4c02e8c24c5048c74cee0dfdc83b4ac1a6ff712d
Author: Julian Wiedmann
Date: Tue Mar 10 18:38:01 2020 +0100
s390/qeth: don't reset default\_out\_queue
[ Upstream commit 240c1948491b81cfe40f84ea040a8f2a4966f101 ]
When an OSA device in prio-queue setup is reduced to 1 TX queue due to
HW restrictions, we reset its the default\_out\_queue to 0.
In the old code this was needed so that qeth\_get\_priority\_queue() gets
the queue selection right. But with proper multiqueue support we already
reduced dev->real\_num\_tx\_queues to 1, and so the stack puts all traffic
on txq 0 without even calling .ndo\_select\_queue.
Thus we can preserve the user's configuration, and apply it if the OSA
device later re-gains support for multiple TX queues.
Fixes: 73dc2daf110f ("s390/qeth: add TX multiqueue support for OSA devices")
Signed-off-by: Julian Wiedmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 296f37b5ba49f76f5ec5e66cacf81d3bb037735f
Author: Hangbin Liu
Date: Tue Mar 3 14:37:36 2020 +0800
selftests/net/fib\_tests: update addr\_metric\_test for peer route testing
[ Upstream commit 0d29169a708bf730ede287248e429d579f432d1d ]
This patch update {ipv4, ipv6}\_addr\_metric\_test with
1. Set metric of address with peer route and see if the route added
correctly.
2. Modify metric and peer address for peer route and see if the route
changed correctly.
Signed-off-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f1357a679d9b74d7e072d555fd2e964c1b1bf48f
Author: Hangbin Liu
Date: Tue Mar 3 14:37:35 2020 +0800
net/ipv6: remove the old peer route if change it to a new one
[ Upstream commit d0098e4c6b83e502cc1cd96d67ca86bc79a6c559 ]
When we modify the peer route and changed it to a new one, we should
remove the old route first. Before the fix:
+ ip addr add dev dummy1 2001:db8::1 peer 2001:db8::2
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 256 pref medium
2001:db8::2 proto kernel metric 256 pref medium
+ ip addr change dev dummy1 2001:db8::1 peer 2001:db8::3
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 256 pref medium
2001:db8::2 proto kernel metric 256 pref medium
After the fix:
+ ip addr change dev dummy1 2001:db8::1 peer 2001:db8::3
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 256 pref medium
2001:db8::3 proto kernel metric 256 pref medium
This patch depend on the previous patch "net/ipv6: need update peer route
when modify metric" to update new peer route after delete old one.
Signed-off-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0ce257739cbfb31ba175a3503ec46fdeffa57e13
Author: Hangbin Liu
Date: Tue Mar 3 14:37:34 2020 +0800
net/ipv6: need update peer route when modify metric
[ Upstream commit 617940123e0140521f3080d2befc2bf55bcda094 ]
When we modify the route metric, the peer address's route need also
be updated. Before the fix:
+ ip addr add dev dummy1 2001:db8::1 peer 2001:db8::2 metric 60
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 60 pref medium
2001:db8::2 proto kernel metric 60 pref medium
+ ip addr change dev dummy1 2001:db8::1 peer 2001:db8::2 metric 61
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 61 pref medium
2001:db8::2 proto kernel metric 60 pref medium
After the fix:
+ ip addr change dev dummy1 2001:db8::1 peer 2001:db8::2 metric 61
+ ip -6 route show dev dummy1
2001:db8::1 proto kernel metric 61 pref medium
2001:db8::2 proto kernel metric 61 pref medium
Fixes: 8308f3ff1753 ("net/ipv6: Add support for specifying metric of connected routes")
Signed-off-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 500ac6cd6e8047af74c9187eabb08cd93348aa09
Author: Heiner Kallweit
Date: Thu Mar 12 22:25:20 2020 +0100
net: phy: fix MDIO bus PM PHY resuming
[ Upstream commit 611d779af7cad2b87487ff58e4931a90c20b113c ]
So far we have the unfortunate situation that mdio\_bus\_phy\_may\_suspend()
is called in suspend AND resume path, assuming that function result is
the same. After the original change this is no longer the case,
resulting in broken resume as reported by Geert.
To fix this call mdio\_bus\_phy\_may\_suspend() in the suspend path only,
and let the phy\_device store the info whether it was suspended by
MDIO bus PM.
Fixes: 503ba7c69610 ("net: phy: Avoid multiple suspends")
Reported-by: Geert Uytterhoeven
Tested-by: Geert Uytterhoeven
Signed-off-by: Heiner Kallweit
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5a214ba7dd48fa862afe343dabd49dee136ccbe7
Author: Heiner Kallweit
Date: Sun Mar 1 21:36:09 2020 +0100
net: phy: avoid clearing PHY interrupts twice in irq handler
[ Upstream commit 249bc9744e165abe74ae326f43e9d70bad54c3b7 ]
On all PHY drivers that implement did\_interrupt() reading the interrupt
status bits clears them. This means we may loose an interrupt that
is triggered between calling did\_interrupt() and phy\_clear\_interrupt().
As part of the fix make it a requirement that did\_interrupt() clears
the interrupt.
The Fixes tag refers to the first commit where the patch applies
cleanly.
Fixes: 49644e68f472 ("net: phy: add callback for custom interrupt handler to struct phy\_driver")
Reported-by: Michael Walle
Signed-off-by: Heiner Kallweit
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit aab30c42cad4721634e2a48fe5e2274719d8af51
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:26 2020 -0800
nfc: add missing attribute validation for vendor subcommand
[ Upstream commit 6ba3da446551f2150fadbf8c7788edcb977683d3 ]
Add missing attribute validation for vendor subcommand attributes
to the netlink policy.
Fixes: 9e58095f9660 ("NFC: netlink: Implement vendor command support")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 363f746627bdc328846b0716cda349133b7d70ca
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:25 2020 -0800
nfc: add missing attribute validation for deactivate target
[ Upstream commit 88e706d5168b07df4792dbc3d1bc37b83e4bd74d ]
Add missing attribute validation for NFC\_ATTR\_TARGET\_INDEX
to the netlink policy.
Fixes: 4d63adfe12dd ("NFC: Add NFC\_CMD\_DEACTIVATE\_TARGET support")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4422a48479c18ffbad3459d2f5382bd065542f79
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:24 2020 -0800
nfc: add missing attribute validation for SE API
[ Upstream commit 361d23e41ca6e504033f7e66a03b95788377caae ]
Add missing attribute validation for NFC\_ATTR\_SE\_INDEX
to the netlink policy.
Fixes: 5ce3f32b5264 ("NFC: netlink: SE API implementation")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e6b521aa8a4792bc622a19a4fe5d54eda6282b9a
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:23 2020 -0800
tipc: add missing attribute validation for MTU property
[ Upstream commit 213320a67962ff6e7b83b704d55cbebc341426db ]
Add missing attribute validation for TIPC\_NLA\_PROP\_MTU
to the netlink policy.
Fixes: 901271e0403a ("tipc: implement configuration of UDP media MTU")
Signed-off-by: Jakub Kicinski
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0c3b59e7f0867f0153a95e0a6429aeb2dcde8fda
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:22 2020 -0800
team: add missing attribute validation for array index
[ Upstream commit 669fcd7795900cd1880237cbbb57a7db66cb9ac8 ]
Add missing attribute validation for TEAM\_ATTR\_OPTION\_ARRAY\_INDEX
to the netlink policy.
Fixes: b13033262d24 ("team: introduce array options")
Signed-off-by: Jakub Kicinski
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c2a346979ab62e5e8fbd2c2bad39d9c1291fd4d8
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:21 2020 -0800
team: add missing attribute validation for port ifindex
[ Upstream commit dd25cb272ccce4db67dc8509278229099e4f5e99 ]
Add missing attribute validation for TEAM\_ATTR\_OPTION\_PORT\_IFINDEX
to the netlink policy.
Fixes: 80f7c6683fe0 ("team: add support for per-port options")
Signed-off-by: Jakub Kicinski
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dd9f60f959866a94dc6dfe727ac0fc7660826182
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:20 2020 -0800
net: taprio: add missing attribute validation for txtime delay
[ Upstream commit e13aaa0643da10006ec35715954e7f92a62899a5 ]
Add missing attribute validation for TCA\_TAPRIO\_ATTR\_TXTIME\_DELAY
to the netlink policy.
Fixes: 4cfd5779bd6e ("taprio: Add support for txtime-assist mode")
Signed-off-by: Jakub Kicinski
Reviewed-by: Vinicius Costa Gomes
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 10105672bd4d11222759a5b1f718b4d89083032b
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:19 2020 -0800
net: fq: add missing attribute validation for orphan mask
[ Upstream commit 7e6dc03eeb023e18427a373522f1d247b916a641 ]
Add missing attribute validation for TCA\_FQ\_ORPHAN\_MASK
to the netlink policy.
Fixes: 06eb395fa985 ("pkt\_sched: fq: better control of DDOS traffic")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 67a008d0a61ac280d28bfafe72f4925e18c8f1ef
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:18 2020 -0800
openvswitch: add missing attribute validation for hash
[ Upstream commit b5ab1f1be6180a2e975eede18731804b5164a05d ]
Add missing attribute validation for OVS\_PACKET\_ATTR\_HASH
to the netlink policy.
Fixes: bd1903b7c459 ("net: openvswitch: add hash info to upcall")
Signed-off-by: Jakub Kicinski
Reviewed-by: Greg Rose
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit caf313aa0b975b6ff7208117523d03aa42a4889d
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:17 2020 -0800
macsec: add missing attribute validation for port
[ Upstream commit 31d9a1c524964bac77b7f9d0a1ac140dc6b57461 ]
Add missing attribute validation for IFLA\_MACSEC\_PORT
to the netlink policy.
Fixes: c09440f7dcb3 ("macsec: introduce IEEE 802.1AE driver")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d5a51de6c81263882a18c3afa8f62a9d2b5ace7b
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:16 2020 -0800
can: add missing attribute validation for termination
[ Upstream commit ab02ad660586b94f5d08912a3952b939cf4c4430 ]
Add missing attribute validation for IFLA\_CAN\_TERMINATION
to the netlink policy.
Fixes: 12a6075cabc0 ("can: dev: add CAN interface termination API")
Signed-off-by: Jakub Kicinski
Acked-by: Oliver Hartkopp
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6996829d9327d35a6fd1add343ab32c171009647
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:15 2020 -0800
nl802154: add missing attribute validation for dev\_type
[ Upstream commit b60673c4c418bef7550d02faf53c34fbfeb366bf ]
Add missing attribute type validation for IEEE802154\_ATTR\_DEV\_TYPE
to the netlink policy.
Fixes: 90c049b2c6ae ("ieee802154: interface type to be added")
Signed-off-by: Jakub Kicinski
Acked-by: Stefan Schmidt
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d3bee2dd016f2e4b5f9824a35124416cfccdd765
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:14 2020 -0800
nl802154: add missing attribute validation
[ Upstream commit 9322cd7c4af2ccc7fe7c5f01adb53f4f77949e92 ]
Add missing attribute validation for several u8 types.
Fixes: 2c21d11518b6 ("net: add NL802154 interface for configuration of 802.15.4 devices")
Signed-off-by: Jakub Kicinski
Acked-by: Stefan Schmidt
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e960cb0526d68461ad388300aa8d80b97893c974
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:13 2020 -0800
fib: add missing attribute validation for tun\_id
[ Upstream commit 4c16d64ea04056f1b1b324ab6916019f6a064114 ]
Add missing netlink policy entry for FRA\_TUN\_ID.
Fixes: e7030878fc84 ("fib: Add fib rule match on tunnel id")
Signed-off-by: Jakub Kicinski
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2ecf0f66ac6617152da7888338c3834a179b3a77
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:12 2020 -0800
devlink: validate length of region addr/len
[ Upstream commit ff3b63b8c299b73ac599b120653b47e275407656 ]
DEVLINK\_ATTR\_REGION\_CHUNK\_ADDR and DEVLINK\_ATTR\_REGION\_CHUNK\_LEN
lack entries in the netlink policy. Corresponding nla\_get\_u64()s
may read beyond the end of the message.
Fixes: 4e54795a27f5 ("devlink: Add support for region snapshot read command")
Signed-off-by: Jakub Kicinski
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 08e42270aa5f21124787f247776a60d23bb57ba4
Author: Jakub Kicinski
Date: Mon Mar 2 21:05:11 2020 -0800
devlink: validate length of param values
[ Upstream commit 8750939b6ad86abc3f53ec8a9683a1cded4a5654 ]
DEVLINK\_ATTR\_PARAM\_VALUE\_DATA may have different types
so it's not checked by the normal netlink policy. Make
sure the attribute length is what we expect.
Fixes: e3b7ca18ad7b ("devlink: Add param set command")
Signed-off-by: Jakub Kicinski
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 15a4ad76485f21aefe221e23360f64be0126324b
Author: Jian Shen
Date: Thu Mar 12 15:11:06 2020 +0800
net: hns3: clear port base VLAN when unload PF
[ Upstream commit 59359fc8a2f7af062777692e6a7aae73483729ec ]
Currently, PF missed to clear the port base VLAN for VF when
unload. In this case, the VLAN id will remain in the VLAN
table. This patch fixes it.
Fixes: 92f11ea177cd ("net: hns3: fix set port based VLAN issue for VF")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 52db97d314aae0c9d10f704ae4cebf5e9f84468d
Author: Jian Shen
Date: Thu Mar 12 15:11:05 2020 +0800
net: hns3: fix RMW issue for VLAN filter switch
[ Upstream commit 903b85d3adce99a5301d5959c4d3c9d14a7974d4 ]
According to the user manual, the ingress and egress VLAN filter
are configured at the same time. Currently, hclge\_init\_vlan\_config()
and hclge\_set\_vlan\_spoofchk() will both change the VLAN filter
switch. So it's necessary to read the old configuration before
modifying it.
Fixes: 22044f95faa0 ("net: hns3: add support for spoof check setting")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit deb003cecab42f81bf860d5ffaf0d2efad376752
Author: Yonglong Liu
Date: Thu Mar 12 15:11:03 2020 +0800
net: hns3: fix "tc qdisc del" failed issue
[ Upstream commit 5eb01ddfcfb25e6ebc404a41deae946bde776731 ]
The HNS3 driver supports to configure TC numbers and TC to priority
map via "tc" tool. But when delete the rule, will fail, because
the HNS3 driver needs at least one TC, but the "tc" tool sets TC
number to zero when delete.
This patch makes sure that the TC number is at least one.
Fixes: 30d240dfa2e8 ("net: hns3: Add mqprio hardware offload support in hns3 driver")
Signed-off-by: Yonglong Liu
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f3693a3243ec0b9e3b5881df9809ba39afc865ea
Author: Madalin Bucur
Date: Wed Mar 4 18:04:28 2020 +0200
dpaa\_eth: FMan erratum A050385 workaround
commit 3c68b8fffb48c0018c24e73c48f2bac768c6203e upstream.
Align buffers, data start, SG fragment length to avoid DMA splits.
These changes prevent the A050385 erratum to manifest itself:
FMAN DMA read or writes under heavy traffic load may cause FMAN
internal resource leak; thus stopping further packet processing.
The FMAN internal queue can overflow when FMAN splits single
read or write transactions into multiple smaller transactions
such that more than 17 AXI transactions are in flight from FMAN
to interconnect. When the FMAN internal queue overflows, it can
stall further packet processing. The issue can occur with any one
of the following three conditions:
1. FMAN AXI transaction crosses 4K address boundary (Errata
A010022)
2. FMAN DMA address for an AXI transaction is not 16 byte
aligned, i.e. the last 4 bits of an address are non-zero
3. Scatter Gather (SG) frames have more than one SG buffer in
the SG list and any one of the buffers, except the last
buffer in the SG list has data size that is not a multiple
of 16 bytes, i.e., other than 16, 32, 48, 64, etc.
With any one of the above three conditions present, there is
likelihood of stalled FMAN packet processing, especially under
stress with multiple ports injecting line-rate traffic.
To avoid situations that stall FMAN packet processing, all of the
above three conditions must be avoided; therefore, configure the
system with the following rules:
1. Frame buffers must not span a 4KB address boundary, unless
the frame start address is 256 byte aligned
2. All FMAN DMA start addresses (for example, BMAN buffer
address, FD[address] + FD[offset]) are 16B aligned
3. SG table and buffer addresses are 16B aligned and the size
of SG buffers are multiple of 16 bytes, except for the last
SG buffer that can be of any size.
Additional workaround notes:
- Address alignment of 64 bytes is recommended for maximally
efficient system bus transactions (although 16 byte alignment is
sufficient to avoid the stall condition)
- To support frame sizes that are larger than 4K bytes, there are
two options:
1. Large single buffer frames that span a 4KB page boundary can
be converted into SG frames to avoid transaction splits at
the 4KB boundary,
2. Align the large single buffer to 256B address boundaries,
ensure that the frame address plus offset is 256B aligned.
- If software generated SG frames have buffers that are unaligned
and with random non-multiple of 16 byte lengths, before
transmitting such frames via FMAN, frames will need to be copied
into a new single buffer or multiple buffer SG frame that is
compliant with the three rules listed above.
Signed-off-by: Madalin Bucur
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 47e0813506597fbcf23cf175d6fd9cd38c38f770
Author: Madalin Bucur
Date: Wed Mar 4 18:04:27 2020 +0200
fsl/fman: detect FMan erratum A050385
commit b281f7b93b258ce1419043bbd898a29254d5c9c7 upstream.
Detect the presence of the A050385 erratum.
Signed-off-by: Madalin Bucur
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e9bf9aabff57a1bdf5d90e61a1e42501cea7d683
Author: Madalin Bucur
Date: Wed Mar 4 18:04:26 2020 +0200
arm64: dts: ls1043a: FMan erratum A050385
commit b54d3900862374e1bb2846e6b39d79c896c0b200 upstream.
The LS1043A SoC is affected by the A050385 erratum stating that
FMAN DMA read or writes under heavy traffic load may cause FMAN
internal resource leak thus stopping further packet processing.
Signed-off-by: Madalin Bucur
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 699c82d70bd1ed8596cefe880c20d05e619e334a
Author: Madalin Bucur
Date: Wed Mar 4 18:04:25 2020 +0200
dt-bindings: net: FMan erratum A050385
commit 26d5bb9e4c4b541c475751e015072eb2cbf70d15 upstream.
FMAN DMA read or writes under heavy traffic load may cause FMAN
internal resource leak; thus stopping further packet processing.
The FMAN internal queue can overflow when FMAN splits single
read or write transactions into multiple smaller transactions
such that more than 17 AXI transactions are in flight from FMAN
to interconnect. When the FMAN internal queue overflows, it can
stall further packet processing. The issue can occur with any one
of the following three conditions:
1. FMAN AXI transaction crosses 4K address boundary (Errata
A010022)
2. FMAN DMA address for an AXI transaction is not 16 byte
aligned, i.e. the last 4 bits of an address are non-zero
3. Scatter Gather (SG) frames have more than one SG buffer in
the SG list and any one of the buffers, except the last
buffer in the SG list has data size that is not a multiple
of 16 bytes, i.e., other than 16, 32, 48, 64, etc.
With any one of the above three conditions present, there is
likelihood of stalled FMAN packet processing, especially under
stress with multiple ports injecting line-rate traffic.
To avoid situations that stall FMAN packet processing, all of the
above three conditions must be avoided; therefore, configure the
system with the following rules:
1. Frame buffers must not span a 4KB address boundary, unless
the frame start address is 256 byte aligned
2. All FMAN DMA start addresses (for example, BMAN buffer
address, FD[address] + FD[offset]) are 16B aligned
3. SG table and buffer addresses are 16B aligned and the size
of SG buffers are multiple of 16 bytes, except for the last
SG buffer that can be of any size.
Additional workaround notes:
- Address alignment of 64 bytes is recommended for maximally
efficient system bus transactions (although 16 byte alignment is
sufficient to avoid the stall condition)
- To support frame sizes that are larger than 4K bytes, there are
two options:
1. Large single buffer frames that span a 4KB page boundary can
be converted into SG frames to avoid transaction splits at
the 4KB boundary,
2. Align the large single buffer to 256B address boundaries,
ensure that the frame address plus offset is 256B aligned.
- If software generated SG frames have buffers that are unaligned
and with random non-multiple of 16 byte lengths, before
transmitting such frames via FMAN, frames will need to be copied
into a new single buffer or multiple buffer SG frame that is
compliant with the three rules listed above.
Signed-off-by: Madalin Bucur
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit abd3d76e1172f01a222de5420a6a050ef00f74a0
Author: Eric Dumazet
Date: Wed Mar 11 11:44:26 2020 -0700
net: memcg: fix lockdep splat in inet\_csk\_accept()
commit 06669ea346e476a5339033d77ef175566a40efbb upstream.
Locking newsk while still holding the listener lock triggered
a lockdep splat [1]
We can simply move the memcg code after we release the listener lock,
as this can also help if multiple threads are sharing a common listener.
Also fix a typo while reading socket sk\_rmem\_alloc.
[1]
WARNING: possible recursive locking detected
5.6.0-rc3-syzkaller #0 Not tainted
--------------------------------------------
syz-executor598/9524 is trying to acquire lock:
ffff88808b5b8b90 (sk\_lock-AF\_INET6){+.+.}, at: lock\_sock include/net/sock.h:1541 [inline]
ffff88808b5b8b90 (sk\_lock-AF\_INET6){+.+.}, at: inet\_csk\_accept+0x69f/0xd30 net/ipv4/inet\_connection\_sock.c:492
but task is already holding lock:
ffff88808b5b9590 (sk\_lock-AF\_INET6){+.+.}, at: lock\_sock include/net/sock.h:1541 [inline]
ffff88808b5b9590 (sk\_lock-AF\_INET6){+.+.}, at: inet\_csk\_accept+0x8d/0xd30 net/ipv4/inet\_connection\_sock.c:445
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(sk\_lock-AF\_INET6);
lock(sk\_lock-AF\_INET6);
\*\*\* DEADLOCK \*\*\*
May be due to missing lock nesting notation
1 lock held by syz-executor598/9524:
#0: ffff88808b5b9590 (sk\_lock-AF\_INET6){+.+.}, at: lock\_sock include/net/sock.h:1541 [inline]
#0: ffff88808b5b9590 (sk\_lock-AF\_INET6){+.+.}, at: inet\_csk\_accept+0x8d/0xd30 net/ipv4/inet\_connection\_sock.c:445
stack backtrace:
CPU: 0 PID: 9524 Comm: syz-executor598 Not tainted 5.6.0-rc3-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x188/0x20d lib/dump\_stack.c:118
print\_deadlock\_bug kernel/locking/lockdep.c:2370 [inline]
check\_deadlock kernel/locking/lockdep.c:2411 [inline]
validate\_chain kernel/locking/lockdep.c:2954 [inline]
\_\_lock\_acquire.cold+0x114/0x288 kernel/locking/lockdep.c:3954
lock\_acquire+0x197/0x420 kernel/locking/lockdep.c:4484
lock\_sock\_nested+0xc5/0x110 net/core/sock.c:2947
lock\_sock include/net/sock.h:1541 [inline]
inet\_csk\_accept+0x69f/0xd30 net/ipv4/inet\_connection\_sock.c:492
inet\_accept+0xe9/0x7c0 net/ipv4/af\_inet.c:734
\_\_sys\_accept4\_file+0x3ac/0x5b0 net/socket.c:1758
\_\_sys\_accept4+0x53/0x90 net/socket.c:1809
\_\_do\_sys\_accept4 net/socket.c:1821 [inline]
\_\_se\_sys\_accept4 net/socket.c:1818 [inline]
\_\_x64\_sys\_accept4+0x93/0xf0 net/socket.c:1818
do\_syscall\_64+0xf6/0x790 arch/x86/entry/common.c:294
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x4445c9
Code: e8 0c 0d 03 00 48 83 c4 18 c3 0f 1f 80 00 00 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 0f 83 eb 08 fc ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007ffc35b37608 EFLAGS: 00000246 ORIG\_RAX: 0000000000000120
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00000000004445c9
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000003
RBP: 0000000000000000 R08: 0000000000306777 R09: 0000000000306777
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00000000004053d0 R14: 0000000000000000 R15: 0000000000000000
Fixes: d752a4986532 ("net: memcg: late association of sock to memcg")
Signed-off-by: Eric Dumazet
Cc: Shakeel Butt
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fddc57f84d7da531d7cc8093717ec17ddd50a0df
Author: Shakeel Butt
Date: Mon Mar 9 22:16:06 2020 -0700
net: memcg: late association of sock to memcg
[ Upstream commit d752a4986532cb6305dfd5290a614cde8072769d ]
If a TCP socket is allocated in IRQ context or cloned from unassociated
(i.e. not associated to a memcg) in IRQ context then it will remain
unassociated for its whole life. Almost half of the TCPs created on the
system are created in IRQ context, so, memory used by such sockets will
not be accounted by the memcg.
This issue is more widespread in cgroup v1 where network memory
accounting is opt-in but it can happen in cgroup v2 if the source socket
for the cloning was created in root memcg.
To fix the issue, just do the association of the sockets at the accept()
time in the process context and then force charge the memory buffer
already used and reserved by the socket.
Signed-off-by: Shakeel Butt
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 48f7246793390c0410d74ec5d273dfc9d75338a1
Author: Shakeel Butt
Date: Mon Mar 9 22:16:05 2020 -0700
cgroup: memcg: net: do not associate sock with unrelated cgroup
[ Upstream commit e876ecc67db80dfdb8e237f71e5b43bb88ae549c ]
We are testing network memory accounting in our setup and noticed
inconsistent network memory usage and often unrelated cgroups network
usage correlates with testing workload. On further inspection, it
seems like mem\_cgroup\_sk\_alloc() and cgroup\_sk\_alloc() are broken in
irq context specially for cgroup v1.
mem\_cgroup\_sk\_alloc() and cgroup\_sk\_alloc() can be called in irq context
and kind of assumes that this can only happen from sk\_clone\_lock()
and the source sock object has already associated cgroup. However in
cgroup v1, where network memory accounting is opt-in, the source sock
can be unassociated with any cgroup and the new cloned sock can get
associated with unrelated interrupted cgroup.
Cgroup v2 can also suffer if the source sock object was created by
process in the root cgroup or if sk\_alloc() is called in irq context.
The fix is to just do nothing in interrupt.
WARNING: Please note that about half of the TCP sockets are allocated
from the IRQ context, so, memory used by such sockets will not be
accouted by the memcg.
The stack trace of mem\_cgroup\_sk\_alloc() from IRQ-context:
CPU: 70 PID: 12720 Comm: ssh Tainted: 5.6.0-smp-DEV #1
Hardware name: ...
Call Trace:
dump\_stack+0x57/0x75
mem\_cgroup\_sk\_alloc+0xe9/0xf0
sk\_clone\_lock+0x2a7/0x420
inet\_csk\_clone\_lock+0x1b/0x110
tcp\_create\_openreq\_child+0x23/0x3b0
tcp\_v6\_syn\_recv\_sock+0x88/0x730
tcp\_check\_req+0x429/0x560
tcp\_v6\_rcv+0x72d/0xa40
ip6\_protocol\_deliver\_rcu+0xc9/0x400
ip6\_input+0x44/0xd0
? ip6\_protocol\_deliver\_rcu+0x400/0x400
ip6\_rcv\_finish+0x71/0x80
ipv6\_rcv+0x5b/0xe0
? ip6\_sublist\_rcv+0x2e0/0x2e0
process\_backlog+0x108/0x1e0
net\_rx\_action+0x26b/0x460
\_\_do\_softirq+0x104/0x2a6
do\_softirq\_own\_stack+0x2a/0x40

do\_softirq.part.19+0x40/0x50
\_\_local\_bh\_enable\_ip+0x51/0x60
ip6\_finish\_output2+0x23d/0x520
? ip6table\_mangle\_hook+0x55/0x160
\_\_ip6\_finish\_output+0xa1/0x100
ip6\_finish\_output+0x30/0xd0
ip6\_output+0x73/0x120
? \_\_ip6\_finish\_output+0x100/0x100
ip6\_xmit+0x2e3/0x600
? ipv6\_anycast\_cleanup+0x50/0x50
? inet6\_csk\_route\_socket+0x136/0x1e0
? skb\_free\_head+0x1e/0x30
inet6\_csk\_xmit+0x95/0xf0
\_\_tcp\_transmit\_skb+0x5b4/0xb20
\_\_tcp\_send\_ack.part.60+0xa3/0x110
tcp\_send\_ack+0x1d/0x20
tcp\_rcv\_state\_process+0xe64/0xe80
? tcp\_v6\_connect+0x5d1/0x5f0
tcp\_v6\_do\_rcv+0x1b1/0x3f0
? tcp\_v6\_do\_rcv+0x1b1/0x3f0
\_\_release\_sock+0x7f/0xd0
release\_sock+0x30/0xa0
\_\_inet\_stream\_connect+0x1c3/0x3b0
? prepare\_to\_wait+0xb0/0xb0
inet\_stream\_connect+0x3b/0x60
\_\_sys\_connect+0x101/0x120
? \_\_sys\_getsockopt+0x11b/0x140
\_\_x64\_sys\_connect+0x1a/0x20
do\_syscall\_64+0x51/0x200
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
The stack trace of mem\_cgroup\_sk\_alloc() from IRQ-context:
Fixes: 2d7580738345 ("mm: memcontrol: consolidate cgroup socket tracking")
Fixes: d979a39d7242 ("cgroup: duplicate cgroup reference when cloning sockets")
Signed-off-by: Shakeel Butt
Reviewed-by: Roman Gushchin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6cbcee990995262c43088fbe78d7077470082145
Author: Edwin Peer
Date: Sun Mar 1 22:07:18 2020 -0500
bnxt\_en: fix error handling when flashing from file
[ Upstream commit 22630e28f9c2b55abd217869cc0696def89f2284 ]
After bnxt\_hwrm\_do\_send\_message() was updated to return standard error
codes in a recent commit, a regression in bnxt\_flash\_package\_from\_file()
was introduced. The return value does not properly reflect all
possible firmware errors when calling firmware to flash the package.
Fix it by consolidating all errors in one local variable rc instead
of having 2 variables for different errors.
Fixes: d4f1420d3656 ("bnxt\_en: Convert error code in firmware message response to standard code.")
Signed-off-by: Edwin Peer
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3802d02eaaaddb72e011deb4dcf4850b33fabc4b
Author: Vasundhara Volam
Date: Sun Mar 1 22:07:17 2020 -0500
bnxt\_en: reinitialize IRQs when MTU is modified
[ Upstream commit a9b952d267e59a3b405e644930f46d252cea7122 ]
MTU changes may affect the number of IRQs so we must call
bnxt\_close\_nic()/bnxt\_open\_nic() with the irq\_re\_init parameter
set to true. The reason is that a larger MTU may require
aggregation rings not needed with smaller MTU. We may not be
able to allocate the required number of aggregation rings and
so we reduce the number of channels which will change the number
of IRQs. Without this patch, it may crash eventually in
pci\_disable\_msix() when the IRQs are not properly unwound.
Fixes: c0c050c58d84 ("bnxt\_en: New Broadcom ethernet driver.")
Signed-off-by: Vasundhara Volam
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 129a8737e1cce6ba6dfb2b4bcf3451831940ad6f
Author: Eric Dumazet
Date: Wed Mar 4 09:32:16 2020 -0800
bonding/alb: make sure arp header is pulled before accessing it
commit b7469e83d2add567e4e0b063963db185f3167cea upstream.
Similar to commit 38f88c454042 ("bonding/alb: properly access headers
in bond\_alb\_xmit()"), we need to make sure arp header was pulled
in skb->head before blindly accessing it in rlb\_arp\_xmit().
Remove arp\_pkt() private helper, since it is more readable/obvious
to have the following construct back to back :
if (!pskb\_network\_may\_pull(skb, sizeof(\*arp)))
return NULL;
arp = (struct arp\_pkt \*)skb\_network\_header(skb);
syzbot reported :
BUG: KMSAN: uninit-value in bond\_slave\_has\_mac\_rx include/net/bonding.h:704 [inline]
BUG: KMSAN: uninit-value in rlb\_arp\_xmit drivers/net/bonding/bond\_alb.c:662 [inline]
BUG: KMSAN: uninit-value in bond\_alb\_xmit+0x575/0x25e0 drivers/net/bonding/bond\_alb.c:1477
CPU: 0 PID: 12743 Comm: syz-executor.4 Not tainted 5.6.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x1c9/0x220 lib/dump\_stack.c:118
kmsan\_report+0xf7/0x1e0 mm/kmsan/kmsan\_report.c:118
\_\_msan\_warning+0x58/0xa0 mm/kmsan/kmsan\_instr.c:215
bond\_slave\_has\_mac\_rx include/net/bonding.h:704 [inline]
rlb\_arp\_xmit drivers/net/bonding/bond\_alb.c:662 [inline]
bond\_alb\_xmit+0x575/0x25e0 drivers/net/bonding/bond\_alb.c:1477
\_\_bond\_start\_xmit drivers/net/bonding/bond\_main.c:4257 [inline]
bond\_start\_xmit+0x85d/0x2f70 drivers/net/bonding/bond\_main.c:4282
\_\_netdev\_start\_xmit include/linux/netdevice.h:4524 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4538 [inline]
xmit\_one net/core/dev.c:3470 [inline]
dev\_hard\_start\_xmit+0x531/0xab0 net/core/dev.c:3486
\_\_dev\_queue\_xmit+0x37de/0x4220 net/core/dev.c:4063
dev\_queue\_xmit+0x4b/0x60 net/core/dev.c:4096
packet\_snd net/packet/af\_packet.c:2967 [inline]
packet\_sendmsg+0x8347/0x93b0 net/packet/af\_packet.c:2992
sock\_sendmsg\_nosec net/socket.c:652 [inline]
sock\_sendmsg net/socket.c:672 [inline]
\_\_sys\_sendto+0xc1b/0xc50 net/socket.c:1998
\_\_do\_sys\_sendto net/socket.c:2010 [inline]
\_\_se\_sys\_sendto+0x107/0x130 net/socket.c:2006
\_\_x64\_sys\_sendto+0x6e/0x90 net/socket.c:2006
do\_syscall\_64+0xb8/0x160 arch/x86/entry/common.c:296
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
RIP: 0033:0x45c479
Code: ad b6 fb ff c3 66 2e 0f 1f 84 00 00 00 00 00 66 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 0f 83 7b b6 fb ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007fc77ffbbc78 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007fc77ffbc6d4 RCX: 000000000045c479
RDX: 000000000000000e RSI: 00000000200004c0 RDI: 0000000000000003
RBP: 000000000076bf20 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00000000ffffffff
R13: 0000000000000a04 R14: 00000000004cc7b0 R15: 000000000076bf2c
Uninit was created at:
kmsan\_save\_stack\_with\_flags mm/kmsan/kmsan.c:144 [inline]
kmsan\_internal\_poison\_shadow+0x66/0xd0 mm/kmsan/kmsan.c:127
kmsan\_slab\_alloc+0x8a/0xe0 mm/kmsan/kmsan\_hooks.c:82
slab\_alloc\_node mm/slub.c:2793 [inline]
\_\_kmalloc\_node\_track\_caller+0xb40/0x1200 mm/slub.c:4401
\_\_kmalloc\_reserve net/core/skbuff.c:142 [inline]
\_\_alloc\_skb+0x2fd/0xac0 net/core/skbuff.c:210
alloc\_skb include/linux/skbuff.h:1051 [inline]
alloc\_skb\_with\_frags+0x18c/0xa70 net/core/skbuff.c:5766
sock\_alloc\_send\_pskb+0xada/0xc60 net/core/sock.c:2242
packet\_alloc\_skb net/packet/af\_packet.c:2815 [inline]
packet\_snd net/packet/af\_packet.c:2910 [inline]
packet\_sendmsg+0x66a0/0x93b0 net/packet/af\_packet.c:2992
sock\_sendmsg\_nosec net/socket.c:652 [inline]
sock\_sendmsg net/socket.c:672 [inline]
\_\_sys\_sendto+0xc1b/0xc50 net/socket.c:1998
\_\_do\_sys\_sendto net/socket.c:2010 [inline]
\_\_se\_sys\_sendto+0x107/0x130 net/socket.c:2006
\_\_x64\_sys\_sendto+0x6e/0x90 net/socket.c:2006
do\_syscall\_64+0xb8/0x160 arch/x86/entry/common.c:296
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Jay Vosburgh
Cc: Veaceslav Falico
Cc: Andy Gospodarek
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ac3fe63efe935659c8d42ea58a41472cdf7ad46b
Author: Vinicius Costa Gomes
Date: Mon Mar 9 10:39:53 2020 -0700
taprio: Fix sending packets without dequeueing them
[ Upstream commit b09fe70ef520e011ba4a64f4b93f948a8f14717b ]
There was a bug that was causing packets to be sent to the driver
without first calling dequeue() on the "child" qdisc. And the KASAN
report below shows that sending a packet without calling dequeue()
leads to bad results.
The problem is that when checking the last qdisc "child" we do not set
the returned skb to NULL, which can cause it to be sent to the driver,
and so after the skb is sent, it may be freed, and in some situations a
reference to it may still be in the child qdisc, because it was never
dequeued.
The crash log looks like this:
[ 19.937538] ==================================================================
[ 19.938300] BUG: KASAN: use-after-free in taprio\_dequeue\_soft+0x620/0x780
[ 19.938968] Read of size 4 at addr ffff8881128628cc by task swapper/1/0
[ 19.939612]
[ 19.939772] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 5.6.0-rc3+ #97
[ 19.940397] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.0-59-gc9ba5276e321-prebuilt.qe4
[ 19.941523] Call Trace:
[ 19.941774]
[ 19.941985] dump\_stack+0x97/0xe0
[ 19.942323] print\_address\_description.constprop.0+0x3b/0x60
[ 19.942884] ? taprio\_dequeue\_soft+0x620/0x780
[ 19.943325] ? taprio\_dequeue\_soft+0x620/0x780
[ 19.943767] \_\_kasan\_report.cold+0x1a/0x32
[ 19.944173] ? taprio\_dequeue\_soft+0x620/0x780
[ 19.944612] kasan\_report+0xe/0x20
[ 19.944954] taprio\_dequeue\_soft+0x620/0x780
[ 19.945380] \_\_qdisc\_run+0x164/0x18d0
[ 19.945749] net\_tx\_action+0x2c4/0x730
[ 19.946124] \_\_do\_softirq+0x268/0x7bc
[ 19.946491] irq\_exit+0x17d/0x1b0
[ 19.946824] smp\_apic\_timer\_interrupt+0xeb/0x380
[ 19.947280] apic\_timer\_interrupt+0xf/0x20
[ 19.947687]
[ 19.947912] RIP: 0010:default\_idle+0x2d/0x2d0
[ 19.948345] Code: 00 00 41 56 41 55 65 44 8b 2d 3f 8d 7c 7c 41 54 55 53 0f 1f 44 00 00 e8 b1 b2 c5 fd e9 07 00 3
[ 19.950166] RSP: 0018:ffff88811a3efda0 EFLAGS: 00000282 ORIG\_RAX: ffffffffffffff13
[ 19.950909] RAX: 0000000080000000 RBX: ffff88811a3a9600 RCX: ffffffff8385327e
[ 19.951608] RDX: 1ffff110234752c0 RSI: 0000000000000000 RDI: ffffffff8385262f
[ 19.952309] RBP: ffffed10234752c0 R08: 0000000000000001 R09: ffffed10234752c1
[ 19.953009] R10: ffffed10234752c0 R11: ffff88811a3a9607 R12: 0000000000000001
[ 19.953709] R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000000
[ 19.954408] ? default\_idle\_call+0x2e/0x70
[ 19.954816] ? default\_idle+0x1f/0x2d0
[ 19.955192] default\_idle\_call+0x5e/0x70
[ 19.955584] do\_idle+0x3d4/0x500
[ 19.955909] ? arch\_cpu\_idle\_exit+0x40/0x40
[ 19.956325] ? \_raw\_spin\_unlock\_irqrestore+0x23/0x30
[ 19.956829] ? trace\_hardirqs\_on+0x30/0x160
[ 19.957242] cpu\_startup\_entry+0x19/0x20
[ 19.957633] start\_secondary+0x2a6/0x380
[ 19.958026] ? set\_cpu\_sibling\_map+0x18b0/0x18b0
[ 19.958486] secondary\_startup\_64+0xa4/0xb0
[ 19.958921]
[ 19.959078] Allocated by task 33:
[ 19.959412] save\_stack+0x1b/0x80
[ 19.959747] \_\_kasan\_kmalloc.constprop.0+0xc2/0xd0
[ 19.960222] kmem\_cache\_alloc+0xe4/0x230
[ 19.960617] \_\_alloc\_skb+0x91/0x510
[ 19.960967] ndisc\_alloc\_skb+0x133/0x330
[ 19.961358] ndisc\_send\_ns+0x134/0x810
[ 19.961735] addrconf\_dad\_work+0xad5/0xf80
[ 19.962144] process\_one\_work+0x78e/0x13a0
[ 19.962551] worker\_thread+0x8f/0xfa0
[ 19.962919] kthread+0x2ba/0x3b0
[ 19.963242] ret\_from\_fork+0x3a/0x50
[ 19.963596]
[ 19.963753] Freed by task 33:
[ 19.964055] save\_stack+0x1b/0x80
[ 19.964386] \_\_kasan\_slab\_free+0x12f/0x180
[ 19.964830] kmem\_cache\_free+0x80/0x290
[ 19.965231] ip6\_mc\_input+0x38a/0x4d0
[ 19.965617] ipv6\_rcv+0x1a4/0x1d0
[ 19.965948] \_\_netif\_receive\_skb\_one\_core+0xf2/0x180
[ 19.966437] netif\_receive\_skb+0x8c/0x3c0
[ 19.966846] br\_handle\_frame\_finish+0x779/0x1310
[ 19.967302] br\_handle\_frame+0x42a/0x830
[ 19.967694] \_\_netif\_receive\_skb\_core+0xf0e/0x2a90
[ 19.968167] \_\_netif\_receive\_skb\_one\_core+0x96/0x180
[ 19.968658] process\_backlog+0x198/0x650
[ 19.969047] net\_rx\_action+0x2fa/0xaa0
[ 19.969420] \_\_do\_softirq+0x268/0x7bc
[ 19.969785]
[ 19.969940] The buggy address belongs to the object at ffff888112862840
[ 19.969940] which belongs to the cache skbuff\_head\_cache of size 224
[ 19.971202] The buggy address is located 140 bytes inside of
[ 19.971202] 224-byte region [ffff888112862840, ffff888112862920)
[ 19.972344] The buggy address belongs to the page:
[ 19.972820] page:ffffea00044a1800 refcount:1 mapcount:0 mapping:ffff88811a2bd1c0 index:0xffff8881128625c0 compo0
[ 19.973930] flags: 0x8000000000010200(slab|head)
[ 19.974388] raw: 8000000000010200 ffff88811a2ed650 ffff88811a2ed650 ffff88811a2bd1c0
[ 19.975151] raw: ffff8881128625c0 0000000000190013 00000001ffffffff 0000000000000000
[ 19.975915] page dumped because: kasan: bad access detected
[ 19.976461] page\_owner tracks the page as allocated
[ 19.976946] page last allocated via order 2, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NO)
[ 19.978332] prep\_new\_page+0x24b/0x330
[ 19.978707] get\_page\_from\_freelist+0x2057/0x2c90
[ 19.979170] \_\_alloc\_pages\_nodemask+0x218/0x590
[ 19.979619] new\_slab+0x9d/0x300
[ 19.979948] \_\_\_slab\_alloc.constprop.0+0x2f9/0x6f0
[ 19.980421] \_\_slab\_alloc.constprop.0+0x30/0x60
[ 19.980870] kmem\_cache\_alloc+0x201/0x230
[ 19.981269] \_\_alloc\_skb+0x91/0x510
[ 19.981620] alloc\_skb\_with\_frags+0x78/0x4a0
[ 19.982043] sock\_alloc\_send\_pskb+0x5eb/0x750
[ 19.982476] unix\_stream\_sendmsg+0x399/0x7f0
[ 19.982904] sock\_sendmsg+0xe2/0x110
[ 19.983262] \_\_\_\_sys\_sendmsg+0x4de/0x6d0
[ 19.983660] \_\_\_sys\_sendmsg+0xe4/0x160
[ 19.984032] \_\_sys\_sendmsg+0xab/0x130
[ 19.984396] do\_syscall\_64+0xe7/0xae0
[ 19.984761] page last free stack trace:
[ 19.985142] \_\_free\_pages\_ok+0x432/0xbc0
[ 19.985533] qlist\_free\_all+0x56/0xc0
[ 19.985907] quarantine\_reduce+0x149/0x170
[ 19.986315] \_\_kasan\_kmalloc.constprop.0+0x9e/0xd0
[ 19.986791] kmem\_cache\_alloc+0xe4/0x230
[ 19.987182] prepare\_creds+0x24/0x440
[ 19.987548] do\_faccessat+0x80/0x590
[ 19.987906] do\_syscall\_64+0xe7/0xae0
[ 19.988276] entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
[ 19.988775]
[ 19.988930] Memory state around the buggy address:
[ 19.989402] ffff888112862780: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 19.990111] ffff888112862800: fc fc fc fc fc fc fc fc fb fb fb fb fb fb fb fb
[ 19.990822] >ffff888112862880: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 19.991529] ^
[ 19.992081] ffff888112862900: fb fb fb fb fc fc fc fc fc fc fc fc fc fc fc fc
[ 19.992796] ffff888112862980: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
Fixes: 5a781ccbd19e ("tc: Add support for configuring the taprio scheduler")
Reported-by: Michael Schmidt
Signed-off-by: Vinicius Costa Gomes
Acked-by: Andre Guedes
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b7130e838c1dcf414fdba7a65fc0aab35bc5cf92
Author: Eric Dumazet
Date: Wed Mar 4 15:51:43 2020 -0800
slip: make slhc\_compress() more robust against malicious packets
[ Upstream commit 110a40dfb708fe940a3f3704d470e431c368d256 ]
Before accessing various fields in IPV4 network header
and TCP header, make sure the packet :
- Has IP version 4 (ip->version == 4)
- Has not a silly network length (ip->ihl >= 5)
- Is big enough to hold network and transport headers
- Has not a silly TCP header size (th->doff >= sizeof(struct tcphdr) / 4)
syzbot reported :
BUG: KMSAN: uninit-value in slhc\_compress+0x5b9/0x2e60 drivers/net/slip/slhc.c:270
CPU: 0 PID: 11728 Comm: syz-executor231 Not tainted 5.6.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x1c9/0x220 lib/dump\_stack.c:118
kmsan\_report+0xf7/0x1e0 mm/kmsan/kmsan\_report.c:118
\_\_msan\_warning+0x58/0xa0 mm/kmsan/kmsan\_instr.c:215
slhc\_compress+0x5b9/0x2e60 drivers/net/slip/slhc.c:270
ppp\_send\_frame drivers/net/ppp/ppp\_generic.c:1637 [inline]
\_\_ppp\_xmit\_process+0x1902/0x2970 drivers/net/ppp/ppp\_generic.c:1495
ppp\_xmit\_process+0x147/0x2f0 drivers/net/ppp/ppp\_generic.c:1516
ppp\_write+0x6bb/0x790 drivers/net/ppp/ppp\_generic.c:512
do\_loop\_readv\_writev fs/read\_write.c:717 [inline]
do\_iter\_write+0x812/0xdc0 fs/read\_write.c:1000
compat\_writev+0x2df/0x5a0 fs/read\_write.c:1351
do\_compat\_pwritev64 fs/read\_write.c:1400 [inline]
\_\_do\_compat\_sys\_pwritev fs/read\_write.c:1420 [inline]
\_\_se\_compat\_sys\_pwritev fs/read\_write.c:1414 [inline]
\_\_ia32\_compat\_sys\_pwritev+0x349/0x3f0 fs/read\_write.c:1414
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:339 [inline]
do\_fast\_syscall\_32+0x3c7/0x6e0 arch/x86/entry/common.c:410
entry\_SYSENTER\_compat+0x68/0x77 arch/x86/entry/entry\_64\_compat.S:139
RIP: 0023:0xf7f7cd99
Code: 90 e8 0b 00 00 00 f3 90 0f ae e8 eb f9 8d 74 26 00 89 3c 24 c3 90 90 90 90 90 90 90 90 90 90 90 90 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 eb 0d 90 90 90 90 90 90 90 90 90 90 90 90
RSP: 002b:00000000ffdb84ac EFLAGS: 00000217 ORIG\_RAX: 000000000000014e
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00000000200001c0
RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000000000000003
RBP: 0000000040047459 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
Uninit was created at:
kmsan\_save\_stack\_with\_flags mm/kmsan/kmsan.c:144 [inline]
kmsan\_internal\_poison\_shadow+0x66/0xd0 mm/kmsan/kmsan.c:127
kmsan\_slab\_alloc+0x8a/0xe0 mm/kmsan/kmsan\_hooks.c:82
slab\_alloc\_node mm/slub.c:2793 [inline]
\_\_kmalloc\_node\_track\_caller+0xb40/0x1200 mm/slub.c:4401
\_\_kmalloc\_reserve net/core/skbuff.c:142 [inline]
\_\_alloc\_skb+0x2fd/0xac0 net/core/skbuff.c:210
alloc\_skb include/linux/skbuff.h:1051 [inline]
ppp\_write+0x115/0x790 drivers/net/ppp/ppp\_generic.c:500
do\_loop\_readv\_writev fs/read\_write.c:717 [inline]
do\_iter\_write+0x812/0xdc0 fs/read\_write.c:1000
compat\_writev+0x2df/0x5a0 fs/read\_write.c:1351
do\_compat\_pwritev64 fs/read\_write.c:1400 [inline]
\_\_do\_compat\_sys\_pwritev fs/read\_write.c:1420 [inline]
\_\_se\_compat\_sys\_pwritev fs/read\_write.c:1414 [inline]
\_\_ia32\_compat\_sys\_pwritev+0x349/0x3f0 fs/read\_write.c:1414
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:339 [inline]
do\_fast\_syscall\_32+0x3c7/0x6e0 arch/x86/entry/common.c:410
entry\_SYSENTER\_compat+0x68/0x77 arch/x86/entry/entry\_64\_compat.S:139
Fixes: b5451d783ade ("slip: Move the SLIP drivers")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e6cf2131afebbec918fb503c844d43a7a7f6a9d2
Author: Edward Cree
Date: Mon Mar 9 18:16:24 2020 +0000
sfc: detach from cb\_page in efx\_copy\_channel()
[ Upstream commit 4b1bd9db078f7d5332c8601a2f5bd43cf0458fd4 ]
It's a resource, not a parameter, so we can't copy it into the new
channel's TX queues, otherwise aliasing will lead to resource-
management bugs if the channel is subsequently torn down without
being initialised.
Before the Fixes:-tagged commit there was a similar bug with
tsoh\_page, but I'm not sure it's worth doing another fix for such
old kernels.
Fixes: e9117e5099ea ("sfc: Firmware-Assisted TSO version 2")
Suggested-by: Derek Shute
Signed-off-by: Edward Cree
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a524fd6728302b7563e8e0484de1f16264b4a6b8
Author: You-Sheng Yang
Date: Wed Feb 26 23:37:10 2020 +0800
r8152: check disconnect status after long sleep
[ Upstream commit d64c7a08034b32c285e576208ae44fc3ba3fa7df ]
Dell USB Type C docking WD19/WD19DC attaches additional peripherals as:
/: Bus 02.Port 1: Dev 1, Class=root\_hub, Driver=xhci\_hcd/6p, 5000M
|\_\_ Port 1: Dev 11, If 0, Class=Hub, Driver=hub/4p, 5000M
|\_\_ Port 3: Dev 12, If 0, Class=Hub, Driver=hub/4p, 5000M
|\_\_ Port 4: Dev 13, If 0, Class=Vendor Specific Class,
Driver=r8152, 5000M
where usb 2-1-3 is a hub connecting all USB Type-A/C ports on the dock.
When hotplugging such dock with additional usb devices already attached on
it, the probing process may reset usb 2.1 port, therefore r8152 ethernet
device is also reset. However, during r8152 device init there are several
for-loops that, when it's unable to retrieve hardware registers due to
being disconnected from USB, may take up to 14 seconds each in practice,
and that has to be completed before USB may re-enumerate devices on the
bus. As a result, devices attached to the dock will only be available
after nearly 1 minute after the dock was plugged in:
[ 216.388290] [250] r8152 2-1.4:1.0: usb\_probe\_interface
[ 216.388292] [250] r8152 2-1.4:1.0: usb\_probe\_interface - got id
[ 258.830410] r8152 2-1.4:1.0 (unnamed net\_device) (uninitialized): PHY not ready
[ 258.830460] r8152 2-1.4:1.0 (unnamed net\_device) (uninitialized): Invalid header when reading pass-thru MAC addr
[ 258.830464] r8152 2-1.4:1.0 (unnamed net\_device) (uninitialized): Get ether addr fail
This happens in, for example, r8153\_init:
static int generic\_ocp\_read(struct r8152 \*tp, u16 index, u16 size,
void \*data, u16 type)
{
if (test\_bit(RTL8152\_UNPLUG, &tp->flags))
return -ENODEV;
...
}
static u16 ocp\_read\_word(struct r8152 \*tp, u16 type, u16 index)
{
u32 data;
...
generic\_ocp\_read(tp, index, sizeof(tmp), &tmp, type | byen);
data = \_\_le32\_to\_cpu(tmp);
...
return (u16)data;
}
static void r8153\_init(struct r8152 \*tp)
{
...
if (test\_bit(RTL8152\_UNPLUG, &tp->flags))
return;
for (i = 0; i < 500; i++) {
if (ocp\_read\_word(tp, MCU\_TYPE\_PLA, PLA\_BOOT\_CTRL) &
AUTOLOAD\_DONE)
break;
msleep(20);
}
...
}
Since ocp\_read\_word() doesn't check the return status of
generic\_ocp\_read(), and the only exit condition for the loop is to have
a match in the returned value, such loops will only ends after exceeding
its maximum runs when the device has been marked as disconnected, which
takes 500 \* 20ms = 10 seconds in theory, 14 in practice.
To solve this long latency another test to RTL8152\_UNPLUG flag should be
added after those 20ms sleep to skip unnecessary loops, so that the device
probe can complete early and proceed to parent port reset/reprobe process.
This can be reproduced on all kernel versions up to latest v5.6-rc2, but
after v5.5-rc7 the reproduce rate is dramatically lowered to 1/30 or less
while it was around 1/2.
Signed-off-by: You-Sheng Yang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0010beac70d4fbfe930065270fd63c30edaeff95
Author: Colin Ian King
Date: Thu Mar 12 15:04:30 2020 +0000
net: systemport: fix index check to avoid an array out of bounds access
[ Upstream commit c0368595c1639947839c0db8294ee96aca0b3b86 ]
Currently the bounds check on index is off by one and can lead to
an out of bounds access on array priv->filters\_loc when index is
RXCHK\_BRCM\_TAG\_MAX.
Fixes: bb9051a2b230 ("net: systemport: Add support for WAKE\_FILTER")
Signed-off-by: Colin Ian King
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 21a33a4a2c142eee369943e9b2db546746bfe813
Author: Remi Pommarel
Date: Sun Mar 8 10:25:56 2020 +0100
net: stmmac: dwmac1000: Disable ACS if enhanced descs are not used
[ Upstream commit b723bd933980f4956dabc8a8d84b3e83be8d094c ]
ACS (auto PAD/FCS stripping) removes FCS off 802.3 packets (LLC) so that
there is no need to manually strip it for such packets. The enhanced DMA
descriptors allow to flag LLC packets so that the receiving callback can
use that to strip FCS manually or not. On the other hand, normal
descriptors do not support that.
Thus in order to not truncate LLC packet ACS should be disabled when
using normal DMA descriptors.
Fixes: 47dd7a540b8a0 ("net: add support for STMicroelectronics Ethernet controllers.")
Signed-off-by: Remi Pommarel
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 941aeb6e93544be1d23f22c88fe885da27130d8f
Author: Karsten Graul
Date: Tue Mar 10 09:33:30 2020 +0100
net/smc: cancel event worker during device removal
[ Upstream commit ece0d7bd74615773268475b6b64d6f1ebbd4b4c6 ]
During IB device removal, cancel the event worker before the device
structure is freed.
Fixes: a4cf0443c414 ("smc: introduce SMC as an IB-client")
Reported-by: syzbot+b297c6825752e7a07272@syzkaller.appspotmail.com
Signed-off-by: Karsten Graul
Reviewed-by: Ursula Braun
Reviewed-by: Leon Romanovsky
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ab00b888b66b53efbb2bc56e48f5643dd2ed9ce9
Author: Jonas Gorski
Date: Mon Mar 2 20:46:57 2020 +0100
net: phy: bcm63xx: fix OOPS due to missing driver name
[ Upstream commit 43de81b0601df7d7988d3f5617ee0987df65c883 ]
719655a14971 ("net: phy: Replace phy driver features u32 with link\_mode
bitmap") was a bit over-eager and also removed the second phy driver's
name, resulting in a nasty OOPS on registration:
[ 1.319854] CPU 0 Unable to handle kernel paging request at virtual address 00000000, epc == 804dd50c, ra == 804dd4f0
[ 1.330859] Oops[#1]:
[ 1.333138] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.4.22 #0
[ 1.339217] $ 0 : 00000000 00000001 87ca7f00 805c1874
[ 1.344590] $ 4 : 00000000 00000047 00585000 8701f800
[ 1.349965] $ 8 : 8701f800 804f4a5c 00000003 64726976
[ 1.355341] $12 : 00000001 00000000 00000000 00000114
[ 1.360718] $16 : 87ca7f80 00000000 00000000 80639fe4
[ 1.366093] $20 : 00000002 00000000 806441d0 80b90000
[ 1.371470] $24 : 00000000 00000000
[ 1.376847] $28 : 87c1e000 87c1fda0 80b90000 804dd4f0
[ 1.382224] Hi : d1c8f8da
[ 1.385180] Lo : 5518a480
[ 1.388182] epc : 804dd50c kset\_find\_obj+0x3c/0x114
[ 1.393345] ra : 804dd4f0 kset\_find\_obj+0x20/0x114
[ 1.398530] Status: 10008703 KERNEL EXL IE
[ 1.402833] Cause : 00800008 (ExcCode 02)
[ 1.406952] BadVA : 00000000
[ 1.409913] PrId : 0002a075 (Broadcom BMIPS4350)
[ 1.414745] Modules linked in:
[ 1.417895] Process swapper/0 (pid: 1, threadinfo=(ptrval), task=(ptrval), tls=00000000)
[ 1.426214] Stack : 87cec000 80630000 80639370 80640658 80640000 80049af4 80639fe4 8063a0d8
[ 1.434816] 8063a0d8 802ef078 00000002 00000000 806441d0 80b90000 8063a0d8 802ef114
[ 1.443417] 87cea0de 87c1fde0 00000000 804de488 87cea000 8063a0d8 8063a0d8 80334e48
[ 1.452018] 80640000 8063984c 80639bf4 00000000 8065de48 00000001 8063a0d8 80334ed0
[ 1.460620] 806441d0 80b90000 80b90000 802ef164 8065dd70 80620000 80b90000 8065de58
[ 1.469222] ...
[ 1.471734] Call Trace:
[ 1.474255] [<804dd50c>] kset\_find\_obj+0x3c/0x114
[ 1.479141] [<802ef078>] driver\_find+0x1c/0x44
[ 1.483665] [<802ef114>] driver\_register+0x74/0x148
[ 1.488719] [<80334e48>] phy\_driver\_register+0x9c/0xd0
[ 1.493968] [<80334ed0>] phy\_drivers\_register+0x54/0xe8
[ 1.499345] [<8001061c>] do\_one\_initcall+0x7c/0x1f4
[ 1.504374] [<80644ed8>] kernel\_init\_freeable+0x1d4/0x2b4
[ 1.509940] [<804f4e24>] kernel\_init+0x10/0xf8
[ 1.514502] [<80018e68>] ret\_from\_kernel\_thread+0x14/0x1c
[ 1.520040] Code: 1060000c 02202025 90650000 <90810000> 24630001 14250004 24840001 14a0fffb 90650000
[ 1.530061]
[ 1.531698] ---[ end trace d52f1717cd29bdc8 ]---
Fix it by readding the name.
Fixes: 719655a14971 ("net: phy: Replace phy driver features u32 with link\_mode bitmap")
Signed-off-by: Jonas Gorski
Acked-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6c951b4f2d688a0de433f9ffb2742be2a1981fe9
Author: Willem de Bruijn
Date: Mon Mar 9 11:34:35 2020 -0400
net/packet: tpacket\_rcv: do not increment ring index on drop
[ Upstream commit 46e4c421a053c36bf7a33dda2272481bcaf3eed3 ]
In one error case, tpacket\_rcv drops packets after incrementing the
ring producer index.
If this happens, it does not update tp\_status to TP\_STATUS\_USER and
thus the reader is stalled for an iteration of the ring, causing out
of order arrival.
The only such error path is when virtio\_net\_hdr\_from\_skb fails due
to encountering an unknown GSO type.
Signed-off-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 71f15f769e0cdbcbe9b3c086d105495310642791
Author: Dan Carpenter
Date: Wed Mar 4 17:24:31 2020 +0300
net: nfc: fix bounds checking bugs on "pipe"
[ Upstream commit a3aefbfe45751bf7b338c181b97608e276b5bb73 ]
This is similar to commit 674d9de02aa7 ("NFC: Fix possible memory
corruption when handling SHDLC I-Frame commands") and commit d7ee81ad09f0
("NFC: nci: Add some bounds checking in nci\_hci\_cmd\_received()") which
added range checks on "pipe".
The "pipe" variable comes skb->data[0] in nfc\_hci\_msg\_rx\_work().
It's in the 0-255 range. We're using it as the array index into the
hdev->pipes[] array which has NFC\_HCI\_MAX\_PIPES (128) members.
Fixes: 118278f20aa8 ("NFC: hci: Add pipes table to reference them with a tuple {gate, host}")
Signed-off-by: Dan Carpenter
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bc2eb5f583124cacafcb95dfe2e65a7892e1814b
Author: Vladimir Oltean
Date: Tue Mar 10 03:28:18 2020 +0200
net: mscc: ocelot: properly account for VLAN header length when setting MRU
[ Upstream commit a8015ded89ad740d21355470d41879c5bd82aab7 ]
What the driver writes into MAC\_MAXLEN\_CFG does not actually represent
VLAN\_ETH\_FRAME\_LEN but instead ETH\_FRAME\_LEN + ETH\_FCS\_LEN. Yes they are
numerically equal, but the difference is important, as the switch treats
VLAN-tagged traffic specially and knows to increase the maximum accepted
frame size automatically. So it is always wrong to account for VLAN in
the MAC\_MAXLEN\_CFG register.
Unconditionally increase the maximum allowed frame size for
double-tagged traffic. Accounting for the additional length does not
mean that the other VLAN membership checks aren't performed, so there's
no harm done.
Also, stop abusing the MTU name for configuring the MRU. There is no
support for configuring the MRU on an interface at the moment.
Fixes: a556c76adc05 ("net: mscc: Add initial Ocelot switch support")
Fixes: fa914e9c4d94 ("net: mscc: ocelot: create a helper for changing the port MTU")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a653b2223367700a3de062ebc07d455247a6204d
Author: Dmitry Bogdanov
Date: Tue Mar 10 18:22:24 2020 +0300
net: macsec: update SCI upon MAC address change.
[ Upstream commit 6fc498bc82929ee23aa2f35a828c6178dfd3f823 ]
SCI should be updated, because it contains MAC in its first 6 octets.
Fixes: c09440f7dcb3 ("macsec: introduce IEEE 802.1AE driver")
Signed-off-by: Dmitry Bogdanov
Signed-off-by: Mark Starovoytov
Signed-off-by: Igor Russkikh
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1a78f10e28053ba6033971721fdc7d771feb1bfe
Author: Pablo Neira Ayuso
Date: Wed Feb 26 19:47:34 2020 +0100
netlink: Use netlink header as base to calculate bad attribute offset
[ Upstream commit 84b3268027641401bb8ad4427a90a3cce2eb86f5 ]
Userspace might send a batch that is composed of several netlink
messages. The netlink\_ack() function must use the pointer to the netlink
header as base to calculate the bad attribute offset.
Fixes: 2d4bc93368f5 ("netlink: extended ACK reporting")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7cd130bca3d22b2b87d1e83250fe2c8ec67d9503
Author: Hangbin Liu
Date: Sat Feb 29 17:27:13 2020 +0800
net/ipv6: use configured metric when add peer route
[ Upstream commit 07758eb9ff52794fba15d03aa88d92dbd1b7d125 ]
When we add peer address with metric configured, IPv4 could set the dest
metric correctly, but IPv6 do not. e.g.
]# ip addr add 192.0.2.1 peer 192.0.2.2/32 dev eth1 metric 20
]# ip route show dev eth1
192.0.2.2 proto kernel scope link src 192.0.2.1 metric 20
]# ip addr add 2001:db8::1 peer 2001:db8::2/128 dev eth1 metric 20
]# ip -6 route show dev eth1
2001:db8::1 proto kernel metric 20 pref medium
2001:db8::2 proto kernel metric 256 pref medium
Fix this by using configured metric instead of default one.
Reported-by: Jianlin Shi
Fixes: 8308f3ff1753 ("net/ipv6: Add support for specifying metric of connected routes")
Reviewed-by: David Ahern
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 28eacc01e817c28accd09d77dd580af6fdf94760
Author: Jian Shen
Date: Thu Mar 5 09:47:53 2020 +0800
net: hns3: fix a not link up issue when fibre port supports autoneg
[ Upstream commit 68e1006f618e509fc7869259fe83ceec4a95dac3 ]
When fibre port supports auto-negotiation, the IMP(Intelligent
Management Process) processes the speed of auto-negotiation
and the user's speed separately.
For below case, the port will get a not link up problem.
step 1: disables auto-negotiation and sets speed to A, then
the driver's MAC speed will be updated to A.
step 2: enables auto-negotiation and MAC gets negotiated
speed B, then the driver's MAC speed will be updated to B
through querying in periodical task.
step 3: MAC gets new negotiated speed A.
step 4: disables auto-negotiation and sets speed to B before
periodical task query new MAC speed A, the driver will ignore
the speed configuration.
This patch fixes it by skipping speed and duplex checking when
fibre port supports auto-negotiation.
Fixes: 22f48e24a23d ("net: hns3: add autoneg and change speed support for fibre port")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a394ca66aaa858f67b817f72d60daf42815c7f0a
Author: Jakub Kicinski
Date: Tue Mar 10 20:36:16 2020 -0700
net: fec: validate the new settings in fec\_enet\_set\_coalesce()
[ Upstream commit ab14961d10d02d20767612c78ce148f6eb85bd58 ]
fec\_enet\_set\_coalesce() validates the previously set params
and if they are within range proceeds to apply the new ones.
The new ones, however, are not validated. This seems backwards,
probably a copy-paste error?
Compile tested only.
Fixes: d851b47b22fc ("net: fec: add interrupt coalescence feature support")
Signed-off-by: Jakub Kicinski
Acked-by: Fugang Duan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 405f31f2e773f4601e505681c575cebaf1bcf4f6
Author: Russell King
Date: Fri Feb 28 19:39:41 2020 +0000
net: dsa: mv88e6xxx: fix lockup on warm boot
[ Upstream commit 0395823b8d9a4d87bd1bf74359123461c2ae801b ]
If the switch is not hardware reset on a warm boot, interrupts can be
left enabled, and possibly pending. This will cause us to enter an
infinite loop trying to service an interrupt we are unable to handle,
thereby preventing the kernel from booting.
Ensure that the global 2 interrupt sources are disabled before we claim
the parent interrupt.
Observed on the ZII development revision B and C platforms with
reworked serdes support, and using reboot -f to reboot the platform.
Fixes: dc30c35be720 ("net: dsa: mv88e6xxx: Implement interrupt support.")
Signed-off-by: Russell King
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5094cd2f4a5d494c0c67f92dad2c167054d74910
Author: Russell King
Date: Tue Mar 3 15:01:46 2020 +0000
net: dsa: fix phylink\_start()/phylink\_stop() calls
[ Upstream commit 8640f8dc6d657ebfb4e67c202ad32c5457858a13 ]
Place phylink\_start()/phylink\_stop() inside dsa\_port\_enable() and
dsa\_port\_disable(), which ensures that we call phylink\_stop() before
tearing down phylink - which is a documented requirement. Failure
to do so can cause use-after-free bugs.
Fixes: 0e27921816ad ("net: dsa: Use PHYLINK for the CPU/DSA ports")
Signed-off-by: Russell King
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0c1c9950fbd3d8853ece44ba84d0ed88e1be1276
Author: Mahesh Bandewar
Date: Mon Mar 9 15:57:07 2020 -0700
macvlan: add cond\_resched() during multicast processing
[ Upstream commit ce9a4186f9ac475c415ffd20348176a4ea366670 ]
The Rx bound multicast packets are deferred to a workqueue and
macvlan can also suffer from the same attack that was discovered
by Syzbot for IPvlan. This solution is not as effective as in
IPvlan. IPvlan defers all (Tx and Rx) multicast packet processing
to a workqueue while macvlan does this way only for the Rx. This
fix should address the Rx codition to certain extent.
Tx is still suseptible. Tx multicast processing happens when
.ndo\_start\_xmit is called, hence we cannot add cond\_resched().
However, it's not that severe since the user which is generating
/ flooding will be affected the most.
Fixes: 412ca1550cbe ("macvlan: Move broadcasts into a work queue")
Signed-off-by: Mahesh Bandewar
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f48b35b0d71e6c6ebf4e27c558c6fae33083a6c5
Author: Mahesh Bandewar
Date: Mon Mar 9 15:56:56 2020 -0700
ipvlan: don't deref eth hdr before checking it's set
[ Upstream commit ad8192767c9f9cf97da57b9ffcea70fb100febef ]
IPvlan in L3 mode discards outbound multicast packets but performs
the check before ensuring the ether-header is set or not. This is
an error that Eric found through code browsing.
Fixes: 2ad7bf363841 (“ipvlan: Initial check-in of the IPVLAN driver.”)
Signed-off-by: Mahesh Bandewar
Reported-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a217be5ae614c4603ff8871ce29dd565139cc3c3
Author: Eric Dumazet
Date: Mon Mar 9 18:22:58 2020 -0700
ipvlan: do not use cond\_resched\_rcu() in ipvlan\_process\_multicast()
[ Upstream commit afe207d80a61e4d6e7cfa0611a4af46d0ba95628 ]
Commit e18b353f102e ("ipvlan: add cond\_resched\_rcu() while
processing muticast backlog") added a cond\_resched\_rcu() in a loop
using rcu protection to iterate over slaves.
This is breaking rcu rules, so lets instead use cond\_resched()
at a point we can reschedule
Fixes: e18b353f102e ("ipvlan: add cond\_resched\_rcu() while processing muticast backlog")
Signed-off-by: Eric Dumazet
Cc: Mahesh Bandewar
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 65ec3ca5369b6f5ee578fa7ef65ba9210301ea47
Author: Jiri Wiesner
Date: Sat Mar 7 13:31:57 2020 +0100
ipvlan: do not add hardware address of master to its unicast filter list
[ Upstream commit 63aae7b17344d4b08a7d05cb07044de4c0f9dcc6 ]
There is a problem when ipvlan slaves are created on a master device that
is a vmxnet3 device (ipvlan in VMware guests). The vmxnet3 driver does not
support unicast address filtering. When an ipvlan device is brought up in
ipvlan\_open(), the ipvlan driver calls dev\_uc\_add() to add the hardware
address of the vmxnet3 master device to the unicast address list of the
master device, phy\_dev->uc. This inevitably leads to the vmxnet3 master
device being forced into promiscuous mode by \_\_dev\_set\_rx\_mode().
Promiscuous mode is switched on the master despite the fact that there is
still only one hardware address that the master device should use for
filtering in order for the ipvlan device to be able to receive packets.
The comment above struct net\_device describes the uc\_promisc member as a
"counter, that indicates, that promiscuous mode has been enabled due to
the need to listen to additional unicast addresses in a device that does
not implement ndo\_set\_rx\_mode()". Moreover, the design of ipvlan
guarantees that only the hardware address of a master device,
phy\_dev->dev\_addr, will be used to transmit and receive all packets from
its ipvlan slaves. Thus, the unicast address list of the master device
should not be modified by ipvlan\_open() and ipvlan\_stop() in order to make
ipvlan a workable option on masters that do not support unicast address
filtering.
Fixes: 2ad7bf3638411 ("ipvlan: Initial check-in of the IPVLAN driver")
Reported-by: Per Sundstrom
Signed-off-by: Jiri Wiesner
Reviewed-by: Eric Dumazet
Acked-by: Mahesh Bandewar
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2cedbf1f6066def9af0ab6d2137661b4f74c60ac
Author: Mahesh Bandewar
Date: Mon Mar 9 15:57:02 2020 -0700
ipvlan: add cond\_resched\_rcu() while processing muticast backlog
[ Upstream commit e18b353f102e371580f3f01dd47567a25acc3c1d ]
If there are substantial number of slaves created as simulated by
Syzbot, the backlog processing could take much longer and result
into the issue found in the Syzbot report.
INFO: rcu\_sched detected stalls on CPUs/tasks:
(detected by 1, t=10502 jiffies, g=5049, c=5048, q=752)
All QSes seen, last rcu\_sched kthread activity 10502 (4294965563-4294955061), jiffies\_till\_next\_fqs=1, root ->qsmask 0x0
syz-executor.1 R running task on cpu 1 10984 11210 3866 0x30020008 179034491270
Call Trace:
[] \_sched\_show\_task kernel/sched/core.c:8063 [inline]
[] \_sched\_show\_task.cold+0x2fd/0x392 kernel/sched/core.c:8030
[] sched\_show\_task+0xb/0x10 kernel/sched/core.c:8073
[] print\_other\_cpu\_stall kernel/rcu/tree.c:1577 [inline]
[] check\_cpu\_stall kernel/rcu/tree.c:1695 [inline]
[] \_\_rcu\_pending kernel/rcu/tree.c:3478 [inline]
[] rcu\_pending kernel/rcu/tree.c:3540 [inline]
[] rcu\_check\_callbacks.cold+0xbb4/0xc29 kernel/rcu/tree.c:2876
[] update\_process\_times+0x32/0x80 kernel/time/timer.c:1635
[] tick\_sched\_handle+0xa0/0x180 kernel/time/tick-sched.c:161
[] tick\_sched\_timer+0x44/0x130 kernel/time/tick-sched.c:1193
[] \_\_run\_hrtimer kernel/time/hrtimer.c:1393 [inline]
[] \_\_hrtimer\_run\_queues+0x307/0xd90 kernel/time/hrtimer.c:1455
[] hrtimer\_interrupt+0x2ea/0x730 kernel/time/hrtimer.c:1513
[] local\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1031 [inline]
[] smp\_apic\_timer\_interrupt+0x144/0x5e0 arch/x86/kernel/apic/apic.c:1056
[] apic\_timer\_interrupt+0x8e/0xa0 arch/x86/entry/entry\_64.S:778
RIP: 0010:do\_raw\_read\_lock+0x22/0x80 kernel/locking/spinlock\_debug.c:153
RSP: 0018:ffff8801dad07ab8 EFLAGS: 00000a02 ORIG\_RAX: ffffffffffffff12
RAX: 0000000000000000 RBX: ffff8801c4135680 RCX: 0000000000000000
RDX: 1ffff10038826afe RSI: ffff88019d816bb8 RDI: ffff8801c41357f0
RBP: ffff8801dad07ac0 R08: 0000000000004b15 R09: 0000000000310273
R10: ffff88019d816bb8 R11: 0000000000000001 R12: ffff8801c41357e8
R13: 0000000000000000 R14: ffff8801cfb19850 R15: ffff8801cfb198b0
[] \_\_raw\_read\_lock\_bh include/linux/rwlock\_api\_smp.h:177 [inline]
[] \_raw\_read\_lock\_bh+0x3e/0x50 kernel/locking/spinlock.c:240
[] ipv6\_chk\_mcast\_addr+0x11a/0x6f0 net/ipv6/mcast.c:1006
[] ip6\_mc\_input+0x319/0x8e0 net/ipv6/ip6\_input.c:482
[] dst\_input include/net/dst.h:449 [inline]
[] ip6\_rcv\_finish+0x408/0x610 net/ipv6/ip6\_input.c:78
[] NF\_HOOK include/linux/netfilter.h:292 [inline]
[] NF\_HOOK include/linux/netfilter.h:286 [inline]
[] ipv6\_rcv+0x10e/0x420 net/ipv6/ip6\_input.c:278
[] \_\_netif\_receive\_skb\_one\_core+0x12a/0x1f0 net/core/dev.c:5303
[] \_\_netif\_receive\_skb+0x2c/0x1b0 net/core/dev.c:5417
[] process\_backlog+0x216/0x6c0 net/core/dev.c:6243
[] napi\_poll net/core/dev.c:6680 [inline]
[] net\_rx\_action+0x47b/0xfb0 net/core/dev.c:6748
[] \_\_do\_softirq+0x2c8/0x99a kernel/softirq.c:317
[] invoke\_softirq kernel/softirq.c:399 [inline]
[] irq\_exit+0x16a/0x1a0 kernel/softirq.c:439
[] exiting\_irq arch/x86/include/asm/apic.h:561 [inline]
[] smp\_apic\_timer\_interrupt+0x165/0x5e0 arch/x86/kernel/apic/apic.c:1058
[] apic\_timer\_interrupt+0x8e/0xa0 arch/x86/entry/entry\_64.S:778

RIP: 0010:\_\_sanitizer\_cov\_trace\_pc+0x26/0x50 kernel/kcov.c:102
RSP: 0018:ffff880196033bd8 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffff12
RAX: ffff88019d8161c0 RBX: 00000000ffffffff RCX: ffffc90003501000
RDX: 0000000000000002 RSI: ffffffff816236d1 RDI: 0000000000000005
RBP: ffff880196033bd8 R08: ffff88019d8161c0 R09: 0000000000000000
R10: 1ffff10032c067f0 R11: 0000000000000000 R12: 0000000000000000
R13: 0000000000000080 R14: 0000000000000000 R15: 0000000000000000
[] do\_futex+0x151/0x1d50 kernel/futex.c:3548
[] C\_SYSC\_futex kernel/futex\_compat.c:201 [inline]
[] compat\_SyS\_futex+0x270/0x3b0 kernel/futex\_compat.c:175
[] do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:353 [inline]
[] do\_fast\_syscall\_32+0x357/0xe1c arch/x86/entry/common.c:415
[] entry\_SYSENTER\_compat+0x8b/0x9d arch/x86/entry/entry\_64\_compat.S:139
RIP: 0023:0xf7f23c69
RSP: 002b:00000000f5d1f12c EFLAGS: 00000282 ORIG\_RAX: 00000000000000f0
RAX: ffffffffffffffda RBX: 000000000816af88 RCX: 0000000000000080
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 000000000816af8c
RBP: 00000000f5d1f228 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
rcu\_sched kthread starved for 10502 jiffies! g5049 c5048 f0x2 RCU\_GP\_WAIT\_FQS(3) ->state=0x0 ->cpu=1
rcu\_sched R running task on cpu 1 13048 8 2 0x90000000 179099587640
Call Trace:
[] context\_switch+0x60f/0xa60 kernel/sched/core.c:3209
[] \_\_schedule+0x5aa/0x1da0 kernel/sched/core.c:3934
[] schedule+0x8f/0x1b0 kernel/sched/core.c:4011
[] schedule\_timeout+0x50d/0xee0 kernel/time/timer.c:1803
[] rcu\_gp\_kthread+0xda1/0x3b50 kernel/rcu/tree.c:2327
[] kthread+0x348/0x420 kernel/kthread.c:246
[] ret\_from\_fork+0x56/0x70 arch/x86/entry/entry\_64.S:393
Fixes: ba35f8588f47 (“ipvlan: Defer multicast / broadcast processing to a work-queue”)
Signed-off-by: Mahesh Bandewar
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4b91a96d63b87b685c055eda89b82c6ce696e622
Author: Hangbin Liu
Date: Tue Mar 10 15:27:37 2020 +0800
ipv6/addrconf: call ipv6\_mc\_up() for non-Ethernet interface
[ Upstream commit 60380488e4e0b95e9e82aa68aa9705baa86de84c ]
Rafał found an issue that for non-Ethernet interface, if we down and up
frequently, the memory will be consumed slowly.
The reason is we add allnodes/allrouters addressed in multicast list in
ipv6\_add\_dev(). When link down, we call ipv6\_mc\_down(), store all multicast
addresses via mld\_add\_delrec(). But when link up, we don't call ipv6\_mc\_up()
for non-Ethernet interface to remove the addresses. This makes idev->mc\_tomb
getting bigger and bigger. The call stack looks like:
addrconf\_notify(NETDEV\_REGISTER)
ipv6\_add\_dev
ipv6\_dev\_mc\_inc(ff01::1)
ipv6\_dev\_mc\_inc(ff02::1)
ipv6\_dev\_mc\_inc(ff02::2)
addrconf\_notify(NETDEV\_UP)
addrconf\_dev\_config
/\* Alas, we support only Ethernet autoconfiguration. \*/
return;
addrconf\_notify(NETDEV\_DOWN)
addrconf\_ifdown
ipv6\_mc\_down
igmp6\_group\_dropped(ff02::2)
mld\_add\_delrec(ff02::2)
igmp6\_group\_dropped(ff02::1)
igmp6\_group\_dropped(ff01::1)
After investigating, I can't found a rule to disable multicast on
non-Ethernet interface. In RFC2460, the link could be Ethernet, PPP, ATM,
tunnels, etc. In IPv4, it doesn't check the dev type when calls ip\_mc\_up()
in inetdev\_event(). Even for IPv6, we don't check the dev type and call
ipv6\_add\_dev(), ipv6\_dev\_mc\_inc() after register device.
So I think it's OK to fix this memory consumer by calling ipv6\_mc\_up() for
non-Ethernet interface.
v2: Also check IFF\_MULTICAST flag to make sure the interface supports
multicast
Reported-by: Rafał Miłecki
Tested-by: Rafał Miłecki
Fixes: 74235a25c673 ("[IPV6] addrconf: Fix IPv6 on tuntap tunnels")
Fixes: 1666d49e1d41 ("mld: do not remove mld souce list info when set link down")
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cd8c3cc975c64b99e3e4936410a1bbcd3dda6709
Author: Dmitry Yakunin
Date: Thu Mar 5 15:33:12 2020 +0300
inet\_diag: return classid for all socket types
[ Upstream commit 83f73c5bb7b9a9135173f0ba2b1aa00c06664ff9 ]
In commit 1ec17dbd90f8 ("inet\_diag: fix reporting cgroup classid and
fallback to priority") croup classid reporting was fixed. But this works
only for TCP sockets because for other socket types icsk parameter can
be NULL and classid code path is skipped. This change moves classid
handling to inet\_diag\_msg\_attrs\_fill() function.
Also inet\_diag\_msg\_attrs\_size() helper was added and addends in
nlmsg\_new() were reordered to save order from inet\_sk\_diag\_fill().
Fixes: 1ec17dbd90f8 ("inet\_diag: fix reporting cgroup classid and fallback to priority")
Signed-off-by: Dmitry Yakunin
Reviewed-by: Konstantin Khlebnikov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cfe511ce3d84281c12cf643f0bbdd267bd6ff1d5
Author: Eric Dumazet
Date: Sat Mar 7 22:05:14 2020 -0800
gre: fix uninit-value in \_\_iptunnel\_pull\_header
[ Upstream commit 17c25cafd4d3e74c83dce56b158843b19c40b414 ]
syzbot found an interesting case of the kernel reading
an uninit-value [1]
Problem is in the handling of ETH\_P\_WCCP in gre\_parse\_header()
We look at the byte following GRE options to eventually decide
if the options are four bytes longer.
Use skb\_header\_pointer() to not pull bytes if we found
that no more bytes were needed.
All callers of gre\_parse\_header() are properly using pskb\_may\_pull()
anyway before proceeding to next header.
[1]
BUG: KMSAN: uninit-value in pskb\_may\_pull include/linux/skbuff.h:2303 [inline]
BUG: KMSAN: uninit-value in \_\_iptunnel\_pull\_header+0x30c/0xbd0 net/ipv4/ip\_tunnel\_core.c:94
CPU: 1 PID: 11784 Comm: syz-executor940 Not tainted 5.6.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x1c9/0x220 lib/dump\_stack.c:118
kmsan\_report+0xf7/0x1e0 mm/kmsan/kmsan\_report.c:118
\_\_msan\_warning+0x58/0xa0 mm/kmsan/kmsan\_instr.c:215
pskb\_may\_pull include/linux/skbuff.h:2303 [inline]
\_\_iptunnel\_pull\_header+0x30c/0xbd0 net/ipv4/ip\_tunnel\_core.c:94
iptunnel\_pull\_header include/net/ip\_tunnels.h:411 [inline]
gre\_rcv+0x15e/0x19c0 net/ipv6/ip6\_gre.c:606
ip6\_protocol\_deliver\_rcu+0x181b/0x22c0 net/ipv6/ip6\_input.c:432
ip6\_input\_finish net/ipv6/ip6\_input.c:473 [inline]
NF\_HOOK include/linux/netfilter.h:307 [inline]
ip6\_input net/ipv6/ip6\_input.c:482 [inline]
ip6\_mc\_input+0xdf2/0x1460 net/ipv6/ip6\_input.c:576
dst\_input include/net/dst.h:442 [inline]
ip6\_rcv\_finish net/ipv6/ip6\_input.c:76 [inline]
NF\_HOOK include/linux/netfilter.h:307 [inline]
ipv6\_rcv+0x683/0x710 net/ipv6/ip6\_input.c:306
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5198 [inline]
\_\_netif\_receive\_skb net/core/dev.c:5312 [inline]
netif\_receive\_skb\_internal net/core/dev.c:5402 [inline]
netif\_receive\_skb+0x66b/0xf20 net/core/dev.c:5461
tun\_rx\_batched include/linux/skbuff.h:4321 [inline]
tun\_get\_user+0x6aef/0x6f60 drivers/net/tun.c:1997
tun\_chr\_write\_iter+0x1f2/0x360 drivers/net/tun.c:2026
call\_write\_iter include/linux/fs.h:1901 [inline]
new\_sync\_write fs/read\_write.c:483 [inline]
\_\_vfs\_write+0xa5a/0xca0 fs/read\_write.c:496
vfs\_write+0x44a/0x8f0 fs/read\_write.c:558
ksys\_write+0x267/0x450 fs/read\_write.c:611
\_\_do\_sys\_write fs/read\_write.c:623 [inline]
\_\_se\_sys\_write fs/read\_write.c:620 [inline]
\_\_ia32\_sys\_write+0xdb/0x120 fs/read\_write.c:620
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:339 [inline]
do\_fast\_syscall\_32+0x3c7/0x6e0 arch/x86/entry/common.c:410
entry\_SYSENTER\_compat+0x68/0x77 arch/x86/entry/entry\_64\_compat.S:139
RIP: 0023:0xf7f62d99
Code: 90 e8 0b 00 00 00 f3 90 0f ae e8 eb f9 8d 74 26 00 89 3c 24 c3 90 90 90 90 90 90 90 90 90 90 90 90 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 eb 0d 90 90 90 90 90 90 90 90 90 90 90 90
RSP: 002b:00000000fffedb2c EFLAGS: 00000217 ORIG\_RAX: 0000000000000004
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 0000000020002580
RDX: 0000000000000fca RSI: 0000000000000036 RDI: 0000000000000004
RBP: 0000000000008914 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
Uninit was created at:
kmsan\_save\_stack\_with\_flags mm/kmsan/kmsan.c:144 [inline]
kmsan\_internal\_poison\_shadow+0x66/0xd0 mm/kmsan/kmsan.c:127
kmsan\_slab\_alloc+0x8a/0xe0 mm/kmsan/kmsan\_hooks.c:82
slab\_alloc\_node mm/slub.c:2793 [inline]
\_\_kmalloc\_node\_track\_caller+0xb40/0x1200 mm/slub.c:4401
\_\_kmalloc\_reserve net/core/skbuff.c:142 [inline]
\_\_alloc\_skb+0x2fd/0xac0 net/core/skbuff.c:210
alloc\_skb include/linux/skbuff.h:1051 [inline]
alloc\_skb\_with\_frags+0x18c/0xa70 net/core/skbuff.c:5766
sock\_alloc\_send\_pskb+0xada/0xc60 net/core/sock.c:2242
tun\_alloc\_skb drivers/net/tun.c:1529 [inline]
tun\_get\_user+0x10ae/0x6f60 drivers/net/tun.c:1843
tun\_chr\_write\_iter+0x1f2/0x360 drivers/net/tun.c:2026
call\_write\_iter include/linux/fs.h:1901 [inline]
new\_sync\_write fs/read\_write.c:483 [inline]
\_\_vfs\_write+0xa5a/0xca0 fs/read\_write.c:496
vfs\_write+0x44a/0x8f0 fs/read\_write.c:558
ksys\_write+0x267/0x450 fs/read\_write.c:611
\_\_do\_sys\_write fs/read\_write.c:623 [inline]
\_\_se\_sys\_write fs/read\_write.c:620 [inline]
\_\_ia32\_sys\_write+0xdb/0x120 fs/read\_write.c:620
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:339 [inline]
do\_fast\_syscall\_32+0x3c7/0x6e0 arch/x86/entry/common.c:410
entry\_SYSENTER\_compat+0x68/0x77 arch/x86/entry/entry\_64\_compat.S:139
Fixes: 95f5c64c3c13 ("gre: Move utility functions to common headers")
Fixes: c54419321455 ("GRE: Refactor GRE tunneling code.")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f3b4544a1a962303d4a7cfd2749de0d2594cc4f0
Author: Vishal Kulkarni
Date: Mon Mar 2 10:54:13 2020 +0530
cxgb4: fix checks for max queues to allocate
[ Upstream commit 116ca924aea664141afa86a1425edc3fcda0d06f ]
Hardware can support more than 8 queues currently limited by
netif\_get\_num\_default\_rss\_queues(). So, rework and fix checks for max
number of queues to allocate. The checks should be based on how many are
actually supported by hardware, OR the number of online cpus; whichever
is lower.
Fixes: 5952dde72307 ("cxgb4: set maximal number of default RSS queues")
Signed-off-by: Vishal Kulkarni "
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b4003dc0caf7ef9e7888e6139efabd21fc756f3c
Author: Dmitry Yakunin
Date: Thu Mar 5 17:45:57 2020 +0300
cgroup, netclassid: periodically release file\_lock on classid updating
[ Upstream commit 018d26fcd12a75fb9b5fe233762aa3f2f0854b88 ]
In our production environment we have faced with problem that updating
classid in cgroup with heavy tasks cause long freeze of the file tables
in this tasks. By heavy tasks we understand tasks with many threads and
opened sockets (e.g. balancers). This freeze leads to an increase number
of client timeouts.
This patch implements following logic to fix this issue:
аfter iterating 1000 file descriptors file table lock will be released
thus providing a time gap for socket creation/deletion.
Now update is non atomic and socket may be skipped using calls:
dup2(oldfd, newfd);
close(oldfd);
But this case is not typical. Moreover before this patch skip is possible
too by hiding socket fd in unix socket buffer.
New sockets will be allocated with updated classid because cgroup state
is updated before start of the file descriptors iteration.
So in common cases this patch has no side effects.
Signed-off-by: Dmitry Yakunin
Reviewed-by: Konstantin Khlebnikov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b350fea945793bdbc25e0b362c3b182779d4037d
Author: Kailang Yang
Date: Wed Feb 5 15:40:01 2020 +0800
ALSA: hda/realtek - Fixed one of HP ALC671 platform Headset Mic supported
[ Upstream commit f2adbae0cb20c8eaf06914b2187043ea944b0aff ]
HP want to keep BIOS verb table for release platform.
So, it need to add 0x19 pin for quirk.
Fixes: 5af29028fd6d ("ALSA: hda/realtek - Add Headset Mic supported for HP cPC")
Signed-off-by: Kailang Yang
Link: https://lore.kernel.org/r/74636ccb700a4cbda24c58a99dc430ce@realtek.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit c273dadbb2afd80bed42895b2118064732567f34
Author: Kailang Yang
Date: Fri Jan 17 14:04:01 2020 +0800
ALSA: hda/realtek - Add Headset Mic supported for HP cPC
[ Upstream commit 5af29028fd6db9438b5584ab7179710a0a22569d ]
HP ALC671 need to support Headset Mic.
Signed-off-by: Kailang Yang
Link: https://lore.kernel.org/r/06a9d2b176e14706976d6584cbe2d92a@realtek.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 229d3811cd1ca4b472aa9475da342036cd312a94
Author: Takashi Iwai
Date: Sun Jan 5 15:47:18 2020 +0100
ALSA: hda/realtek - More constifications
[ Upstream commit 6b0f95c49d890440c01a759c767dfe40e2acdbf2 ]
Apply const prefix to each coef table array.
Just for minor optimization and no functional changes.
Link: https://lore.kernel.org/r/20200105144823.29547-4-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 54673a9cdd8499405cbd5603263767f2d678789f
Author: Nathan Chancellor
Date: Sat Feb 15 17:40:39 2020 -0700
virtio\_balloon: Adjust label in virtballoon\_probe
[ Upstream commit 6ae4edab2fbf86ec92fbf0a8f0c60b857d90d50f ]
Clang warns when CONFIG\_BALLOON\_COMPACTION is unset:
../drivers/virtio/virtio\_balloon.c:963:1: warning: unused label
'out\_del\_vqs' [-Wunused-label]
out\_del\_vqs:
^~~~~~~~~~~~
1 warning generated.
Move the label within the preprocessor block since it is only used when
CONFIG\_BALLOON\_COMPACTION is set.
Fixes: 1ad6f58ea936 ("virtio\_balloon: Fix memory leaks on errors in virtballoon\_probe()")
Link: https://github.com/ClangBuiltLinux/linux/issues/886
Signed-off-by: Nathan Chancellor
Link: https://lore.kernel.org/r/20200216004039.23464-1-natechancellor@gmail.com
Signed-off-by: Michael S. Tsirkin
Reviewed-by: David Hildenbrand
Signed-off-by: Sasha Levin

