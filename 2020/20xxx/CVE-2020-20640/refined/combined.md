=== Content from www.jianshu.com_c3be270c_20250119_122754.html ===
[登录](/sign_in)[注册](/sign_up)[写文章](/writer)[首页](/)[下载APP](/apps?utm_medium=desktop&utm_source=navbar-apps)[会员](/vips)[IT技术](/techareas)
# ECShop 4.0反射型XSS漏洞分析

[Cyc1e](/u/9c3ca1ca4784)关注赞赏支持
# ECShop 4.0反射型XSS漏洞分析

## **原文已发[Freebuf ECShop 4.0反射型XSS漏洞分析](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.freebuf.com%2Fvuls%2F198140.html)**

**前言**： Ecshop是国内的一款开源的电商框架，在国内应用较为广泛，当前最新版本为4.0.0，最近对其代码进行了简单的分析，发现可以绕过其filter触发XSS。

## **一、漏洞利用方式**

发送GET请求包如下：

> GET/CMS/ECShop\_V4.0./user.php HTTP/1.1
>
> Referer:https://127.0.0.1" /><a href=j&#97v&#97script:&#97lert('Cyc1e\_test')><imgsrc="xxxxx
>
> User-Agent:Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko)Chrome/41.0.2228.0 Safari/537.21
>
> Cookie:ECS\_ID=17b608d2a679cf2c7e8611581478e6929dbfb34b;ECS[visit\_times]=2
>
> Connection:
>
> keep-aliveAccept: */*
>
> Accept-Encoding:gzip,deflate
>
> Host: 127.0.0.1

其中漏洞触发代码为：

```
Referer:https://127.0.0.1" /><ahref=j&#97v&#97script:&#97lert('Cyc1e_test')><imgsrc="xxxxx

```

实现绕过过滤规则，触发XSS漏洞的效果。

**二、相关环境**

版本：ECShop4.0.0

漏洞类型：反射型XSS

本地环境：php5.6.27+ Apache + Mysql

**三、漏洞分析**

该XSS漏洞路口点在user.php文件，查看user.php：328行

![]()

user.php

在用户登入界面的处理代码中，首先变量$action赋值为login进入主体代码，若变量$back\_act为空并且请求包中存在REFERER字段，则将REFERER字段中的内容赋值给变量$back\_act，这是导致该漏洞的直接原因，对$back\_act变量赋值过后传入assign函数进行处理，其中$smarty是模版类cls\_template的实例化：/includes/init.php：170行

![]()

init.php

所以查看assign函数时跟进到模版类cls\_template中查看：/includes/ cls\_template.php：70行

![]()

cls\_template.php

对传入变量名和变量值进行变量注册，我们可以传入非数组数据对$back\_act进行变量注册，注册完毕回到user.php代码，继续跟进模版类中的display函数：/includes/ cls\_template.php：100行

![]()

cls\_template.php

调用fetch函数进行user\_passport.dwt文件的页面显示，也就是显示用户登入页面，其中在user\_passport.dwt文件中：

![]()

user\_passport.dwt

$back\_act值被赋值给input标签中的value,所以我们控制了$back\_act变量值便可以在html页面中插入js代码。

**四、绕过全局Waf触发XSS**

Ecshop中定义了全局安全过滤规则，查看代码：/includes/safety.php

![]()

safety.php

这个过滤规则比较简单粗暴，利用’on[a-zA-Z]{3,15}’ 过滤了所有的on开头js事件，所以用事件触发是较为困难了，并且<script、alert、eval、data、Javascript等敏感字符，继续查看代码：

![]()

safety.php

$back\_act的值如果不是数组便传入filter()函数中利用preg\_match进行字符校验，这里利用了/i，所以不区分大小写，无法利用大小写的方式进行绕过，不过这里的敏感字符过滤也不全，例如对于弹窗的js函数confirm就可以被利用，所以主要考虑的是如何绕过过滤检测。

我利用了HTML的实体编码来进行绕过，在 HTML 中，某些字符是预留的，比如不能使用小于号（<）和大于号（>），这是因为浏览器会误认为它们是标签。如果希望正确地显示预留字符，我们必须在 HTML 源代码中使用字符实体，如需显示小于号，我们必须这样写：< 或 <，其中'< '便是小于号（<）的HTML实体编码，并且不仅是 "<"">" 这样的能编码，所有字符均能编码，a-zA-Z的HTML实体编码方式是&#[字符ACCII编码]，例如a->&#97。

所以可以利用这一编码方式进行构造POC：

```
Referer: [https://127.0.0.1](https://127.0.0.1)"/><a href=j&#97v&#97script:&#97lert('Cyc1e_test')><imgsrc="xxxxx

```

其中j&#97v&#97script:&#97lert('Cyc1e\_test')可以绕过xss过滤规则的匹配从而绕过服务端的安全过滤植入html页面中，经过html编码解析会恢复成javascript:alert('Cyc1e\_test')，从而触发执行，效果如图：

![]()

XSS代码植入

通过点击图片可以直接触发

![]()

XSS代码植入

漏洞绕过触发的方式不唯一。

最后编辑于 ：2019.03.27 16:14:02©著作权归作者所有,转载或内容合作请联系作者

* [人面猴](/p/1003a129be45)序言：七十年代末，一起剥皮案震惊了整个滨河市，随后出现的几起案子，更是在滨河造成了极大的恐慌，老刑警刘岩，带你破解...[沈念sama](/u/dcd395522934)阅读 214,922评论 6赞 497
* [死咒](/p/1c4506f51019)序言：滨河连续发生了三起死亡事件，死亡现场离奇诡异，居然都是意外死亡，警方通过查阅死者的电脑和手机，发现死者居然都...[沈念sama](/u/dcd395522934)阅读 91,591评论 3赞 389
* [救了他两次的神仙让他今天三更去死](/p/1ded57e57939)文/潘晓璐 我一进店门，熙熙楼的掌柜王于贵愁眉苦脸地迎上来，“玉大人，你说我怎么就摊上这事。” “怎么了？”我有些...[开封第一讲书人](/u/5891e866c93e)阅读 160,546评论 0赞 350
* [道士缉凶录：失踪的卖姜人](/p/25685c1b1f2b) 文/不坏的土叔 我叫张陵，是天一观的道长。 经常有香客问我，道长，这世上最难降的妖魔是什么？ 我笑而不...[开封第一讲书人](/u/5891e866c93e)阅读 57,467评论 1赞 288
* [﻿港岛之恋（遗憾婚礼）](/p/553802eff5d6)正文 为了忘掉前任，我火速办了婚礼，结果婚礼上，老公的妹妹穿的比我还像新娘。我一直安慰自己，他们只是感情好，可当我...[茶点故事](/u/0f438ff0a55f)阅读 66,553评论 6赞 386
* [恶毒庶女顶嫁案：这布局不是一般人想出来的](/p/59985a89b4ef)文/花漫 我一把揭开白布。 她就那样静静地躺着，像睡着了一般。 火红的嫁衣衬着肌肤如雪。 梳的纹丝不乱的头发上，一...[开封第一讲书人](/u/5891e866c93e)阅读 50,580评论 1赞 293
* [城市分裂传说](/p/62a01de427e0)那天，我揣着相机与录音，去河边找鬼。 笑死，一个胖子当着我的面吹牛，可吹牛的内容都是我干的。 我是一名探鬼主播，决...[沈念sama](/u/dcd395522934)阅读 39,588评论 3赞 414
* [双鸳鸯连环套：你想象不到人心有多黑](/p/6ccdc163474a)文/苍兰香墨 我猛地睁开眼，长吁一口气：“原来是场噩梦啊……” “哼！你这毒妇竟也来了？” 一声冷哼从身侧响起，我...[开封第一讲书人](/u/5891e866c93e)阅读 38,334评论 0赞 270
* [万荣杀人案实录](/p/8796e3463067)序言：老挝万荣一对情侣失踪，失踪者是张志新（化名）和其女友刘颖，没想到半个月后，有当地人在树林里发现了一具尸体，经...[沈念sama](/u/dcd395522934)阅读 44,780评论 1赞 307
* [﻿护林员之死](/p/8a691dd8fa34)正文 独居荒郊野岭守林人离奇死亡，尸身上长有42处带血的脓包…… 初始之章·张勋 以下内容为张勋视角 年9月15日...[茶点故事](/u/0f438ff0a55f)阅读 37,092评论 2赞 330
* [﻿白月光启示录](/p/a5293fa3b5e0)正文 我和宋清朗相恋三年，在试婚纱的时候发现自己被绿了。 大学时的朋友给我发了我未婚夫和他白月光在一起吃饭的照片。...[茶点故事](/u/0f438ff0a55f)阅读 39,270评论 1赞 344
* [活死人](/p/a83aa7e71001)序言：一个原本活蹦乱跳的男人离奇死亡，死状恐怖，灵堂内的尸体忽然破棺而出，到底是诈尸还是另有隐情，我是刑警宁泽，带...[沈念sama](/u/dcd395522934)阅读 34,925评论 5赞 338
* [﻿日本核电站爆炸内幕](/p/bee7d9c3fcf9)正文 年R本政府宣布，位于F岛的核电站，受9级特大地震影响，放射性物质发生泄漏。R本人自食恶果不足惜，却给世界环境...[茶点故事](/u/0f438ff0a55f)阅读 40,573评论 3赞 322
* [男人毒药：我在死后第九天来索命](/p/c2cfc4cb0aa7)文/蒙蒙 一、第九天 我趴在偏房一处隐蔽的房顶上张望。 院中可真热闹，春花似锦、人声如沸。这庄子的主人今日做“春日...[开封第一讲书人](/u/5891e866c93e)阅读 31,194评论 0赞 21
* [一桩弑父案，背后竟有这般阴谋](/p/c329b54bd638)文/苍兰香墨 我抬头看了看天上的太阳。三九已至，却和暖如春，着一层夹袄步出监牢的瞬间，已是汗流浃背。 一阵脚步声响...[开封第一讲书人](/u/5891e866c93e)阅读 32,437评论 1赞 268
* [情欲美人皮](/p/d79d2f48417f)我被黑心中介骗来泰国打工， 没想到刚下飞机就差点儿被人妖公主榨干…… 1. 我叫王不留，地道东北人。 一个月前我还...[沈念sama](/u/dcd395522934)阅读 47,154评论 2赞 366
* [代替公主和亲](/p/fc890ed5083c)正文 我出身青楼，却偏偏与公主长得像，于是被迫代替她去往敌国和亲。 传闻我的和亲对象是个残疾皇子，可洞房花烛夜当晚...[茶点故事](/u/0f438ff0a55f)阅读 44,127评论 2赞 352
### 推荐阅读[更多精彩内容](/)

* [旧电影感想日志2015《大圣归来》《小王子》《头脑特工队》](/p/166e25af5b66)《大圣归来》……画面达到国产动画电影新高，情节立意也不错。不过后面的战斗比较仓促，气氛渲染没铺好，结局也有点突兀。...[丘神](/u/691014d5341c)阅读 284评论 0赞 0
* [基于WDA的远程真机调试](/p/b50f2eab331f)公司刚要做远程真机平台，经过一些坑做出来，现在做个随手笔记。 先理一下思路，本文要实现的远程真机需要以下几部分： ...[Amanda\_Lhy](/u/db6872624f1e)阅读 1,686评论 0赞 0
* [小小燕什么时候变大](/p/9cc49c677395)不想让你心情不好，还是我太敏感。 现在看完东西准备要休息了，倒出时间和你说说话，人毕竟不是钢铁铸成的，需要休息，娱...[小诸看世界](/u/480dd61fa1e2)阅读 198评论 0赞 0
评论0赞55赞6赞赞赏![](data:image/gif;base64...)
