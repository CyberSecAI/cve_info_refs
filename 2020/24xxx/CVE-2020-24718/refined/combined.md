=== Content from security.FreeBSD.org_cacf77a1_20250119_121931.html ===
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512
=============================================================================
FreeBSD-SA-20:28.bhyve\_vmcs Security Advisory
The FreeBSD Project
Topic: bhyve privilege escalation via VMCS access
Category: core
Module: bhyve
Announced: 2020-09-15
Credits: Patrick Mooney
Affects: All supported versions of FreeBSD.
Corrected: 2020-09-15 21:28:47 UTC (stable/12, 12.2-STABLE)
2020-09-15 21:43:41 UTC (releng/12.2, 12.2-BETA1-p1)
2020-09-15 21:43:41 UTC (releng/12.1, 12.1-RELEASE-p10)
2020-09-15 21:28:47 UTC (stable/11, 11.4-STABLE)
2020-09-15 21:43:41 UTC (releng/11.4, 11.4-RELEASE-p4)
2020-09-15 21:43:41 UTC (releng/11.3, 11.3-RELEASE-p14)
CVE Name: CVE-2020-24718
For general information regarding FreeBSD Security Advisories,
including descriptions of the fields above, security branches, and the
following sections, please visit .
I. Background
bhyve(8) is a hypervisor that supports running a variety of guest operating
systems in virtual machines on AMD and Intel CPUs.
II. Problem Description
AMD and Intel CPUs support hardware virtualization using specialized data
structures that control various aspects of guest operation. These are the
Virtual Machine Control Structure (VMCS) on Intel CPUs, and the Virtual
Machine Control Block (VMCB) on AMD CPUs. Insufficient access controls allow
root users, including those running in a jail, to change these data
structures.
III. Impact
An attacker with host root access (including to a jailed bhyve instance) can
use this vulnerability to achieve kernel code execution.
IV. Workaround
No workaround is available. This issue is likely of concern only to systems
relying on running bhyve in jail(8) for security domain separation.
V. Solution
Upgrade your vulnerable system to a supported FreeBSD stable or
release / security branch (releng) dated after the correction date,
and reboot.
Perform one of the following:
1) To update your vulnerable system via a binary patch:
Systems running a RELEASE version of FreeBSD on the i386 or amd64
platforms can be updated via the freebsd-update(8) utility:
# freebsd-update fetch
# freebsd-update install
# shutdown -r +10min "Rebooting for a security update"
2) To update your vulnerable system via a source code patch:
The following patches have been verified to apply to the applicable
FreeBSD release branches.
a) Download the relevant patch from the location below, and verify the
detached PGP signature using your PGP utility.
# fetch https://security.FreeBSD.org/patches/SA-20:28/bhyve\_vmcs.patch
# fetch https://security.FreeBSD.org/patches/SA-20:28/bhyve\_vmcs.patch.asc
# gpg --verify bhyve\_vmcs.patch.asc
b) Apply the patch. Execute the following commands as root:
# cd /usr/src
# patch < /path/to/patch
c) Recompile your kernel as described in
 and reboot the
system.
VI. Correction details
The following list contains the correction revision numbers for each
affected branch.
Branch/path Revision
- -------------------------------------------------------------------------
stable/12/ r365777
releng/12.2/ r365779
releng/12.1/ r365779
stable/11/ r365777
releng/11.4/ r365779
releng/11.3/ r365779
- -------------------------------------------------------------------------
To see which files were modified by a particular revision, run the
following command, replacing NNNNNN with the revision number, on a
machine with Subversion installed:
# svn diff -cNNNNNN --summarize svn://svn.freebsd.org/base
Or visit the following URL, replacing NNNNNN with the revision number:
VII. References
The latest revision of this advisory is available at
-----BEGIN PGP SIGNATURE-----
iQKTBAEBCgB9FiEE/A6HiuWv54gCjWNV05eS9J6n5cIFAl9hOJdfFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldEZD
MEU4NzhBRTVBRkU3ODgwMjhENjM1NUQzOTc5MkY0OUVBN0U1QzIACgkQ05eS9J6n
5cKJBQ//UOwIgcc2n+Yr0MrNIs2XzLjmKBsuVfIrFni0GGJFFSAUd7Kzw7oeY4ng
e9JURtfV6NlU63QkaRw+QqgvnXm5vLbgO+oWuedsj33eNgUNdUinZinieZuFAyAt
BBgfMJ3D9X7HffIw1iKN/DWaealFJ1SHtKYzVssTBx/7ju+SFj5HkwLh/7QzKBYO
CoeNE7RN2kSDmvvEKMdN17QyM4+H3wYpsnylWHa89slIe1xj0eVqgnGw2NrjjKlV
N2DAQM+MvdJ+W8oA0idEvBZj55uHV9OlgIwJCDi0/u5yHPJkhuYYuHsf0oyW+NT6
gWvzwTI27IAAyYKK57pGVP7x4sy8VhsDItzqubhDqa/zjNZM9SYOtLYiOnDjev2B
nqC2mV08XpC9lfwd3EDPGv+FYbTTe9OzirlJBnbMnwhj/p0sPMYCtuWKp/MyQyyD
1yhUJJlZgI6HdrTOOeqhObNDtEz75MI1bpLVmjq9VMLz1PtzdNFDcNmyvtTOpMut
vZDFgCqtkpcukqxfqV1EJAWr0UWnaUyPc0klbmLwrQCpTWDOBT7QK+S5ZtNLQqu4
c6UJ7CQLNPn9nEjf16D8dZ1Iy3AJyPmtv7ehEkKFjJtNIwitCx/AIzKiXXzzxe56
boJoQL0pmgJkv3tjP5dEMeSx5SA4mrhtKCL+ri3/ZFXHxtcDNsQ=
=Jluz
-----END PGP SIGNATURE-----


=== Content from security.netapp.com_8f0a415e_20250119_121931.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [October 2020 FreeBSD Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20201016-0002)

## October 2020 FreeBSD Vulnerabilities in NetApp Products

circle-check-alt

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20201016-0002 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20201016-0002 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20201016-0002 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20201016-0002 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20201016-0002
**Version:**
4.0

**Last updated:**
06/18/2021

**Status:**
Final.

**CVEs:** CVE-2020-7461, CVE-2020-7462, CVE-2020-7463, CVE-2020-7464, CVE-2020-7467, CVE-2020-7468, CVE-2020-24718

Overview
#### Summary

Multiple NetApp products incorporate FreeBSD. All supported versions of FreeBSD are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

Clustered Data ONTAP is only affected by CVE-2020-7461 and CVE-2020-7462.

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2020-24718](https://nvd.nist.gov/vuln/detail/CVE-2020-24718) | 6.7 (MEDIUM) | CVSS:3.0/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-7461](https://nvd.nist.gov/vuln/detail/CVE-2020-7461) | 8.8 (HIGH) | CVSS:3.0/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-7462](https://nvd.nist.gov/vuln/detail/CVE-2020-7462) | 6.5 (MEDIUM) | CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H |
| [CVE-2020-7463](https://nvd.nist.gov/vuln/detail/CVE-2020-7463) | 6.5 (MEDIUM) | CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H |
| [CVE-2020-7464](https://nvd.nist.gov/vuln/detail/CVE-2020-7464) | 6.5 (MEDIUM) | CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N |
| [CVE-2020-7467](https://nvd.nist.gov/vuln/detail/CVE-2020-7467) | 7.6 (HIGH) | CVSS:3.0/AV:P/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H |
| [CVE-2020-7468](https://nvd.nist.gov/vuln/detail/CVE-2020-7468) | 7.8 (HIGH) | CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* Clustered Data ONTAP

#### Products Not Affected

* 7-Mode Transition Tool
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 6500N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* Active IQ mobile app
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Insights Telegraf Agent
* Cloud Manager
* Cloud Volumes ONTAP Mediator
* Clustered Data ONTAP Antivirus Connector
* Data ONTAP operating in 7-Mode
* E-Series SANtricity OS Controller Baseboard Management Controller (BMC) - EF600A
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Storage Manager
* E-Series SANtricity Web Services (REST API) for Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Python SDK
* FAS/AFF BIOS
* FAS/AFF Baseboard Management Controller (BMC)
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* Inventory Collect Tool
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* NetApp Cloud Backup (formerly AltaVault)
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Performance Analyzer
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp SANtricity Cloud Connector
* NetApp SANtricity SMI-S Provider
* NetApp SMI-S Provider
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp SolidFire BIOS
* NetApp SolidFire Baseboard Management Controller (BMC)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp Storage Encryption
* NetApp VASA Provider for Clustered Data ONTAP 9.6 and above
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* OnCommand Insight
* OnCommand Workflow Automation
* Open Systems SnapVault Agent
* SANtricity Unified Manager
* SAS Firmware
* SRA Plugin for Linux
* SRA Plugin for Windows
* Service Processor
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapDrive for Unix
* SnapManager for Exchange
* SnapManager for Hyper-V
* SnapManager for Oracle
* SnapManager for SAP
* SnapManager for Sharepoint
* SolidFire Storage Replication Adapter
* Storage Replication Adapter for Clustered Data ONTAP for VMware vSphere 9.6 and above
* Storage Services Connector
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID Baseboard Management Controller (BMC)
* StorageGRID9 (9.x and prior)
* System Manager 9.x
* Trident
* Virtual Storage Console for VMware vSphere 9.6 and above

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Clustered Data ONTAP** | <https://mysupport.netapp.com/site/products/all/details/ontap9/downloads-tab/download/62286/9.7P14> <https://mysupport.netapp.com/site/products/all/details/ontap9/downloads-tab/download/62286/9.8/> Fixed under bug 1354675. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Final.**

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20201016-0002>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20201016 | Initial Public Release |
| 2.0 | 20201202 | Added Clustered Data ONTAP information to Impact section |
| 3.0 | 20210104 | Clustered Data ONTAP added to Software Versions and Fixes, Final status |
| 4.0 | 20210618 | Clustered Data ONTAP 9.7P14 added to Software Versions and Fixes |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from github.com_2ec50297_20250119_121930.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fillumos%2Fillumos-gate%2Fblob%2F84971882a96ac0fecd538b02208054a872ff8af3%2Fusr%2Fsrc%2Futs%2Fi86pc%2Fio%2Fvmm%2Fintel%2Fvmcs.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fillumos%2Fillumos-gate%2Fblob%2F84971882a96ac0fecd538b02208054a872ff8af3%2Fusr%2Fsrc%2Futs%2Fi86pc%2Fio%2Fvmm%2Fintel%2Fvmcs.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=illumos%2Fillumos-gate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[illumos](/illumos)
/
**[illumos-gate](/illumos/illumos-gate)**
Public

* [Notifications](/login?return_to=%2Fillumos%2Fillumos-gate) You must be signed in to change notification settings
* [Fork
  770](/login?return_to=%2Fillumos%2Fillumos-gate)
* [Star
   1.7k](/login?return_to=%2Fillumos%2Fillumos-gate)

* [Code](/illumos/illumos-gate)
* [Pull requests
  8](/illumos/illumos-gate/pulls)
* [Actions](/illumos/illumos-gate/actions)
* [Security](/illumos/illumos-gate/security)
* [Insights](/illumos/illumos-gate/pulse)

Additional navigation options

* [Code](/illumos/illumos-gate)
* [Pull requests](/illumos/illumos-gate/pulls)
* [Actions](/illumos/illumos-gate/actions)
* [Security](/illumos/illumos-gate/security)
* [Insights](/illumos/illumos-gate/pulse)

## Files

 8497188
## Breadcrumbs

1. [illumos-gate](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3)
2. /[usr](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr)
3. /[src](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src)
4. /[uts](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts)
5. /[i86pc](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc)
6. /[io](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io)
7. /[vmm](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm)
8. /[intel](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm/intel)
/
# vmcs.c

Copy path Blame  Blame
## Latest commit

## History

[History](/illumos/illumos-gate/commits/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm/intel/vmcs.c)562 lines (489 loc) · 12.9 KB 8497188
## Breadcrumbs

1. [illumos-gate](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3)
2. /[usr](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr)
3. /[src](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src)
4. /[uts](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts)
5. /[i86pc](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc)
6. /[io](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io)
7. /[vmm](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm)
8. /[intel](/illumos/illumos-gate/tree/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm/intel)
/
# vmcs.c

Top
## File metadata and controls

* Code
* Blame

562 lines (489 loc) · 12.9 KB[Raw](https://github.com/illumos/illumos-gate/raw/84971882a96ac0fecd538b02208054a872ff8af3/usr/src/uts/i86pc/io/vmm/intel/vmcs.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562/\*- \* SPDX-License-Identifier: BSD-2-Clause-FreeBSD \* \* Copyright (c) 2011 NetApp, Inc. \* All rights reserved. \* \* Redistribution and use in source and binary forms, with or without \* modification, are permitted provided that the following conditions \* are met: \* 1. Redistributions of source code must retain the above copyright \* notice, this list of conditions and the following disclaimer. \* 2. Redistributions in binary form must reproduce the above copyright \* notice, this list of conditions and the following disclaimer in the \* documentation and/or other materials provided with the distribution. \* \* THIS SOFTWARE IS PROVIDED BY NETAPP, INC ``AS IS'' AND \* ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE \* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE \* ARE DISCLAIMED. IN NO EVENT SHALL NETAPP, INC OR CONTRIBUTORS BE LIABLE \* FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL \* DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS \* OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) \* HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT \* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY \* OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF \* SUCH DAMAGE. \* \* $FreeBSD$ \*//\* \* This file and its contents are supplied under the terms of the \* Common Development and Distribution License ("CDDL"), version 1.0. \* You may only use this file in accordance with the terms of version \* 1.0 of the CDDL. \* \* A full copy of the text of the CDDL should have accompanied this \* source. A copy of the CDDL is also available via the Internet at \* http://www.illumos.org/license/CDDL. \* \* Copyright 2014 Pluribus Networks Inc. \* Copyright 2017 Joyent, Inc. \*/
#ifdef \_\_FreeBSD\_\_#include "opt\_ddb.h"#endif
#include <sys/cdefs.h>\_\_FBSDID("$FreeBSD$");
#include <sys/param.h>#include <sys/sysctl.h>#include <sys/systm.h>#include <sys/pcpu.h>
#include <vm/vm.h>#include <vm/pmap.h>
#include <machine/segments.h>#include <machine/vmm.h>#include "vmm\_host.h"#include "vmx\_cpufunc.h"#include "vmcs.h"#include "ept.h"#include "vmx.h"
#ifdef DDB#include <ddb/ddb.h>#endif
SYSCTL\_DECL(\_hw\_vmm\_vmx);
static int no\_flush\_rsb;SYSCTL\_INT(\_hw\_vmm\_vmx, OID\_AUTO, no\_flush\_rsb, CTLFLAG\_RW, &no\_flush\_rsb, 0, "Do not flush RSB upon vmexit");
static uint64\_tvmcs\_fix\_regval(uint32\_t encoding, uint64\_t val){
 switch (encoding) { case VMCS\_GUEST\_CR0: val = vmx\_fix\_cr0(val); break; case VMCS\_GUEST\_CR4: val = vmx\_fix\_cr4(val); break; default: break; } return (val);}
static uint32\_tvmcs\_field\_encoding(int ident){ switch (ident) { case VM\_REG\_GUEST\_CR0: return (VMCS\_GUEST\_CR0); case VM\_REG\_GUEST\_CR3: return (VMCS\_GUEST\_CR3); case VM\_REG\_GUEST\_CR4: return (VMCS\_GUEST\_CR4); case VM\_REG\_GUEST\_DR7: return (VMCS\_GUEST\_DR7); case VM\_REG\_GUEST\_RSP: return (VMCS\_GUEST\_RSP); case VM\_REG\_GUEST\_RIP: return (VMCS\_GUEST\_RIP); case VM\_REG\_GUEST\_RFLAGS: return (VMCS\_GUEST\_RFLAGS); case VM\_REG\_GUEST\_ES: return (VMCS\_GUEST\_ES\_SELECTOR); case VM\_REG\_GUEST\_CS: return (VMCS\_GUEST\_CS\_SELECTOR); case VM\_REG\_GUEST\_SS: return (VMCS\_GUEST\_SS\_SELECTOR); case VM\_REG\_GUEST\_DS: return (VMCS\_GUEST\_DS\_SELECTOR); case VM\_REG\_GUEST\_FS: return (VMCS\_GUEST\_FS\_SELECTOR); case VM\_REG\_GUEST\_GS: return (VMCS\_GUEST\_GS\_SELECTOR); case VM\_REG\_GUEST\_TR: return (VMCS\_GUEST\_TR\_SELECTOR); case VM\_REG\_GUEST\_LDTR: return (VMCS\_GUEST\_LDTR\_SELECTOR); case VM\_REG\_GUEST\_EFER: return (VMCS\_GUEST\_IA32\_EFER); case VM\_REG\_GUEST\_PDPTE0: return (VMCS\_GUEST\_PDPTE0); case VM\_REG\_GUEST\_PDPTE1: return (VMCS\_GUEST\_PDPTE1); case VM\_REG\_GUEST\_PDPTE2: return (VMCS\_GUEST\_PDPTE2); case VM\_REG\_GUEST\_PDPTE3: return (VMCS\_GUEST\_PDPTE3); case VM\_REG\_GUEST\_ENTRY\_INST\_LENGTH: return (VMCS\_ENTRY\_INST\_LENGTH); default: return (-1); }
}
static intvmcs\_seg\_desc\_encoding(int seg, uint32\_t \*base, uint32\_t \*lim, uint32\_t \*acc){
 switch (seg) { case VM\_REG\_GUEST\_ES: \*base = VMCS\_GUEST\_ES\_BASE; \*lim = VMCS\_GUEST\_ES\_LIMIT; \*acc = VMCS\_GUEST\_ES\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_CS: \*base = VMCS\_GUEST\_CS\_BASE; \*lim = VMCS\_GUEST\_CS\_LIMIT; \*acc = VMCS\_GUEST\_CS\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_SS: \*base = VMCS\_GUEST\_SS\_BASE; \*lim = VMCS\_GUEST\_SS\_LIMIT; \*acc = VMCS\_GUEST\_SS\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_DS: \*base = VMCS\_GUEST\_DS\_BASE; \*lim = VMCS\_GUEST\_DS\_LIMIT; \*acc = VMCS\_GUEST\_DS\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_FS: \*base = VMCS\_GUEST\_FS\_BASE; \*lim = VMCS\_GUEST\_FS\_LIMIT; \*acc = VMCS\_GUEST\_FS\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_GS: \*base = VMCS\_GUEST\_GS\_BASE; \*lim = VMCS\_GUEST\_GS\_LIMIT; \*acc = VMCS\_GUEST\_GS\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_TR: \*base = VMCS\_GUEST\_TR\_BASE; \*lim = VMCS\_GUEST\_TR\_LIMIT; \*acc = VMCS\_GUEST\_TR\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_LDTR: \*base = VMCS\_GUEST\_LDTR\_BASE; \*lim = VMCS\_GUEST\_LDTR\_LIMIT; \*acc = VMCS\_GUEST\_LDTR\_ACCESS\_RIGHTS; break; case VM\_REG\_GUEST\_IDTR: \*base = VMCS\_GUEST\_IDTR\_BASE; \*lim = VMCS\_GUEST\_IDTR\_LIMIT; \*acc = VMCS\_INVALID\_ENCODING; break; case VM\_REG\_GUEST\_GDTR: \*base = VMCS\_GUEST\_GDTR\_BASE; \*lim = VMCS\_GUEST\_GDTR\_LIMIT; \*acc = VMCS\_INVALID\_ENCODING; break; default: return (EINVAL); }
 return (0);}
intvmcs\_getreg(struct vmcs \*vmcs, int running, int ident, uint64\_t \*retval){ int error; uint32\_t encoding;
 /\* \* If we need to get at vmx-specific state in the VMCS we can bypass \* the translation of 'ident' to 'encoding' by simply setting the \* sign bit. As it so happens the upper 16 bits are reserved (i.e \* set to 0) in the encodings for the VMCS so we are free to use the \* sign bit. \*/ if (ident < 0) encoding = ident & 0x7fffffff; else encoding = vmcs\_field\_encoding(ident);
 if (encoding == (uint32\_t)-1) return (EINVAL);
 if (!running) VMPTRLD(vmcs);
 error = vmread(encoding, retval);
 if (!running) VMCLEAR(vmcs);
 return (error);}
intvmcs\_setreg(struct vmcs \*vmcs, int running, int ident, uint64\_t val){ int error; uint32\_t encoding;
 if (ident < 0) encoding = ident & 0x7fffffff; else encoding = vmcs\_field\_encoding(ident);
 if (encoding == (uint32\_t)-1) return (EINVAL);
 val = vmcs\_fix\_regval(encoding, val);
 if (!running) VMPTRLD(vmcs);
 error = vmwrite(encoding, val);
 if (!running) VMCLEAR(vmcs);
 return (error);}
intvmcs\_setdesc(struct vmcs \*vmcs, int running, int seg, struct seg\_desc \*desc){ int error; uint32\_t base, limit, access;
 error = vmcs\_seg\_desc\_encoding(seg, &base, &limit, &access); if (error != 0) panic("vmcs\_setdesc: invalid segment register %d", seg);
 if (!running) VMPTRLD(vmcs); if ((error = vmwrite(base, desc->base)) != 0) goto done;
 if ((error = vmwrite(limit, desc->limit)) != 0) goto done;
 if (access != VMCS\_INVALID\_ENCODING) { if ((error = vmwrite(access, desc->access)) != 0) goto done; }done: if (!running) VMCLEAR(vmcs); return (error);}
intvmcs\_getdesc(struct vmcs \*vmcs, int running, int seg, struct seg\_desc \*desc){ int error; uint32\_t base, limit, access; uint64\_t u64;
 error = vmcs\_seg\_desc\_encoding(seg, &base, &limit, &access); if (error != 0) panic("vmcs\_getdesc: invalid segment register %d", seg);
 if (!running) VMPTRLD(vmcs); if ((error = vmread(base, &u64)) != 0) goto done; desc->base = u64;
 if ((error = vmread(limit, &u64)) != 0) goto done; desc->limit = u64;
 if (access != VMCS\_INVALID\_ENCODING) { if ((error = vmread(access, &u64)) != 0) goto done; desc->access = u64; }done: if (!running) VMCLEAR(vmcs); return (error);}
intvmcs\_set\_msr\_save(struct vmcs \*vmcs, u\_long g\_area, u\_int g\_count){ int error;
 VMPTRLD(vmcs);
 /\* \* Guest MSRs are saved in the VM-exit MSR-store area. \* Guest MSRs are loaded from the VM-entry MSR-load area. \* Both areas point to the same location in memory. \*/ if ((error = vmwrite(VMCS\_EXIT\_MSR\_STORE, g\_area)) != 0) goto done; if ((error = vmwrite(VMCS\_EXIT\_MSR\_STORE\_COUNT, g\_count)) != 0) goto done;
 if ((error = vmwrite(VMCS\_ENTRY\_MSR\_LOAD, g\_area)) != 0) goto done; if ((error = vmwrite(VMCS\_ENTRY\_MSR\_LOAD\_COUNT, g\_count)) != 0) goto done;
 error = 0;done: VMCLEAR(vmcs); return (error);}
intvmcs\_init(struct vmcs \*vmcs){ int error, codesel, datasel, tsssel; u\_long cr0, cr4, efer; uint64\_t pat;#ifdef \_\_FreeBSD\_\_ uint64\_t fsbase, idtrbase;#endif
 codesel = vmm\_get\_host\_codesel(); datasel = vmm\_get\_host\_datasel(); tsssel = vmm\_get\_host\_tsssel();
 /\* \* Make sure we have a "current" VMCS to work with. \*/ VMPTRLD(vmcs);
 /\* Host state \*/
 /\* Initialize host IA32\_PAT MSR \*/ pat = vmm\_get\_host\_pat(); if ((error = vmwrite(VMCS\_HOST\_IA32\_PAT, pat)) != 0) goto done;
 /\* Load the IA32\_EFER MSR \*/ efer = vmm\_get\_host\_efer(); if ((error = vmwrite(VMCS\_HOST\_IA32\_EFER, efer)) != 0) goto done;
 /\* Load the control registers \*/
 cr0 = vmm\_get\_host\_cr0(); if ((error = vmwrite(VMCS\_HOST\_CR0, cr0)) != 0) goto done;
 cr4 = vmm\_get\_host\_cr4() | CR4\_VMXE; if ((error = vmwrite(VMCS\_HOST\_CR4, cr4)) != 0) goto done;
 /\* Load the segment selectors \*/ if ((error = vmwrite(VMCS\_HOST\_ES\_SELECTOR, datasel)) != 0) goto done;
 if ((error = vmwrite(VMCS\_HOST\_CS\_SELECTOR, codesel)) != 0) goto done;
 if ((error = vmwrite(VMCS\_HOST\_SS\_SELECTOR, datasel)) != 0) goto done;
 if ((error = vmwrite(VMCS\_HOST\_DS\_SELECTOR, datasel)) != 0) goto done;
#ifdef \_\_FreeBSD\_\_ if ((error = vmwrite(VMCS\_HOST\_FS\_SELECTOR, datasel)) != 0) goto done;
 if ((error = vmwrite(VMCS\_HOST\_GS\_SELECTOR, datasel)) != 0) goto done;#else if ((error = vmwrite(VMCS\_HOST\_FS\_SELECTOR, vmm\_get\_host\_fssel())) != 0) goto done;
 if ((error = vmwrite(VMCS\_HOST\_GS\_SELECTOR, vmm\_get\_host\_gssel())) != 0) goto done;#endif
 if ((error = vmwrite(VMCS\_HOST\_TR\_SELECTOR, tsssel)) != 0) goto done;
#ifdef \_\_FreeBSD\_\_ /\* \* Load the Base-Address for %fs and idtr. \* \* Note that we exclude %gs, tss and gdtr here because their base \* address is pcpu specific. \*/ fsbase = vmm\_get\_host\_fsbase(); if ((error = vmwrite(VMCS\_HOST\_FS\_BASE, fsbase)) != 0) goto done;
 idtrbase = vmm\_get\_host\_idtrbase(); if ((error = vmwrite(VMCS\_HOST\_IDTR\_BASE, idtrbase)) != 0) goto done;
#else /\* \_\_FreeBSD\_\_ \*/ /\* \* Configure host sysenter MSRs to be restored on VM exit. \* The thread-specific MSR\_INTC\_SEP\_ESP value is loaded in vmx\_run. \*/ if ((error = vmwrite(VMCS\_HOST\_IA32\_SYSENTER\_CS, KCS\_SEL)) != 0) goto done; /\* Natively defined as MSR\_INTC\_SEP\_EIP \*/ if ((error = vmwrite(VMCS\_HOST\_IA32\_SYSENTER\_EIP, rdmsr(MSR\_SYSENTER\_EIP\_MSR))) != 0) goto done;
#endif /\* \_\_FreeBSD\_\_ \*/
 /\* instruction pointer \*/ if (no\_flush\_rsb) { if ((error = vmwrite(VMCS\_HOST\_RIP, (u\_long)vmx\_exit\_guest)) != 0) goto done; } else { if ((error = vmwrite(VMCS\_HOST\_RIP, (u\_long)vmx\_exit\_guest\_flush\_rsb)) != 0) goto done; }
 /\* link pointer \*/ if ((error = vmwrite(VMCS\_LINK\_POINTER, ~0)) != 0) goto done;done: VMCLEAR(vmcs); return (error);}
#ifdef DDBextern int vmxon\_enabled[];
DB\_SHOW\_COMMAND(vmcs, db\_show\_vmcs){ uint64\_t cur\_vmcs, val; uint32\_t exit;
 if (!vmxon\_enabled[curcpu]) { db\_printf("VMX not enabled\n"); return; }
 if (have\_addr) { db\_printf("Only current VMCS supported\n"); return; }
 vmptrst(&cur\_vmcs); if (cur\_vmcs == VMCS\_INITIAL) { db\_printf("No current VM context\n"); return; } db\_printf("VMCS: %jx\n", cur\_vmcs); db\_printf("VPID: %lu\n", vmcs\_read(VMCS\_VPID)); db\_printf("Activity: "); val = vmcs\_read(VMCS\_GUEST\_ACTIVITY); switch (val) { case 0: db\_printf("Active"); break; case 1: db\_printf("HLT"); break; case 2: db\_printf("Shutdown"); break; case 3: db\_printf("Wait for SIPI"); break; default: db\_printf("Unknown: %#lx", val); } db\_printf("\n"); exit = vmcs\_read(VMCS\_EXIT\_REASON); if (exit & 0x80000000) db\_printf("Entry Failure Reason: %u\n", exit & 0xffff); else db\_printf("Exit Reason: %u\n", exit & 0xffff); db\_printf("Qualification: %#lx\n", vmcs\_exit\_qualification()); db\_printf("Guest Linear Address: %#lx\n", vmcs\_read(VMCS\_GUEST\_LINEAR\_ADDRESS)); switch (exit & 0x8000ffff) { case EXIT\_REASON\_EXCEPTION: case EXIT\_REASON\_EXT\_INTR: val = vmcs\_read(VMCS\_EXIT\_INTR\_INFO); db\_printf("Interrupt Type: "); switch (val >> 8 & 0x7) { case 0: db\_printf("external"); break; case 2: db\_printf("NMI"); break; case 3: db\_printf("HW exception"); break; case 4: db\_printf("SW exception"); break; default: db\_printf("?? %lu", val >> 8 & 0x7); break; } db\_printf(" Vector: %lu", val & 0xff); if (val & 0x800) db\_printf(" Error Code: %lx", vmcs\_read(VMCS\_EXIT\_INTR\_ERRCODE)); db\_printf("\n"); break; case EXIT\_REASON\_EPT\_FAULT: case EXIT\_REASON\_EPT\_MISCONFIG: db\_printf("Guest Physical Address: %#lx\n", vmcs\_read(VMCS\_GUEST\_PHYSICAL\_ADDRESS)); break; } db\_printf("VM-instruction error: %#lx\n", vmcs\_instruction\_error());}#endif

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


