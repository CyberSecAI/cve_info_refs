=== Content from trac.ffmpeg.org_241fd396_20250119_124737.html ===


[![FFmpeg](/ffmpeg-logo.png)](https://ffmpeg.org)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Help/Guide](/wiki/TracGuide)
* [About Trac](/about)
* [Register](/register)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [View Tickets](/report)
* [Search](/search)
* [Tags](/tags)

## Context Navigation

* ![Up-vote](/chrome/vote/aupgray.png)+0![Down-vote](/chrome/vote/adowngray.png)
* ← [Previous Ticket](/ticket/8858 "Ticket #8858")
* [Next Ticket](/ticket/8860 "Ticket #8860") →

---

Opened [4 years ago](/timeline?from=2020-08-22T02%3A37%3A55Z&precision=second "See timeline at Aug 22, 2020, 2:37:55 AM")

Closed [4 years ago](/timeline?from=2020-08-24T21%3A33%3A50Z&precision=second "See timeline at Aug 24, 2020, 9:33:50 PM")

## [#8859](/ticket/8859) [closed](/query?status=closed) [defect](/query?status=!closed&type=defect) ([duplicate](/query?resolution=duplicate&status=closed))

# A heap-buffer-overflow in aacdec\_template.c:543:15

| Reported by: | [Zhou Anshunkang](/query?reporter=seviezhou&status=!closed) | Owned by: |  |
| --- | --- | --- | --- |
| Priority: | [normal](/query?priority=normal&status=!closed) | Component: | [avcodec](/query?component=avcodec&status=!closed) |
| Version: | [git-master](/query?status=!closed&version=git-master) | Keywords: | [aac](/query?keywords=~aac&status=!closed) |
| Cc: |  | Blocked By: |  |
| Blocking: |  | Reproduced by developer: | [no](/query?reproduced=0&status=!closed) |
| Analyzed by developer: | [no](/query?analyzed=0&status=!closed) |  |  |

## Description

## System info

Ubuntu x86\_64, clang 6.0, ffmpeg (git-master [​https://github.com/FFmpeg/FFmpeg/commit/3fc3d712a99cf39f69a2258b48cbc81fa8ae5471](https://github.com/FFmpeg/FFmpeg/commit/3fc3d712a99cf39f69a2258b48cbc81fa8ae5471))

## Configure

```
./configure --disable-shared --enable-debug=3 --disable-ffplay --disable-ffprobe --disable-doc --disable-asm --cc=clang --cxx=clang++ --ld=clang --toolchain=clang-asan

```
## Command line

```
./ffmpeg -y -f mov /dev/null -i @@

```
## AddressSanitizer

```
=================================================================
==35580==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x624000008308 at pc 0x0000030dcdfc bp 0x7ffe3ba63450 sp 0x7ffe3ba63448
READ of size 8 at 0x624000008308 thread T0
    #0 0x30dcdfb  (/home/seviezhou/ffmpeg/ffmpeg+0x30dcdfb)
    #1 0x30d1314  (/home/seviezhou/ffmpeg/ffmpeg+0x30d1314)
    #2 0x30e7f96  (/home/seviezhou/ffmpeg/ffmpeg+0x30e7f96)
    #3 0x30c7dbc  (/home/seviezhou/ffmpeg/ffmpeg+0x30c7dbc)
    #4 0x179945c  (/home/seviezhou/ffmpeg/ffmpeg+0x179945c)
    #5 0x1798a55  (/home/seviezhou/ffmpeg/ffmpeg+0x1798a55)
    #6 0x145def6  (/home/seviezhou/ffmpeg/ffmpeg+0x145def6)
    #7 0x1451f5d  (/home/seviezhou/ffmpeg/ffmpeg+0x1451f5d)
    #8 0x519abb  (/home/seviezhou/ffmpeg/ffmpeg+0x519abb)
    #9 0x5179a6  (/home/seviezhou/ffmpeg/ffmpeg+0x5179a6)
    #10 0x516e1b  (/home/seviezhou/ffmpeg/ffmpeg+0x516e1b)
    #11 0x5839c2  (/home/seviezhou/ffmpeg/ffmpeg+0x5839c2)
    #12 0x7f6ec8c51b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #13 0x41e179 in _init (/home/seviezhou/ffmpeg/ffmpeg+0x41e179)

Address 0x624000008308 is a wild pointer.
SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/seviezhou/ffmpeg/ffmpeg+0x30dcdfb)
Shadow bytes around the buggy address:
  0x0c487fff9010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c487fff9060: fa[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9070: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9080: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff9090: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff90a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff90b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==35580==ABORTING

```

### Attachments (1)

[heap-overflow-ffmpeg-JIT](/attachment/ticket/8859/heap-overflow-ffmpeg-JIT "View attachment")[​](/raw-attachment/ticket/8859/heap-overflow-ffmpeg-JIT "Download")
(227 bytes
) - added by Carl Eugen Hoyos [4 years ago](/timeline?from=2020-08-22T11%3A49%3A47Z&precision=second "See timeline at Aug 22, 2020, 11:49:47 AM").

Download all attachments as:
[.zip](/zip-attachment/ticket/8859/)

Oldest first

Newest first

Threaded

Show comments

Show property changes

### Change History (7)

### in reply to: [description](#comment:description) [comment:1](#comment:1) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-22T11%3A49%3A29Z&precision=second "See timeline at Aug 22, 2020, 11:49:29 AM")

| Component: | ffmpeg → avcodec |
| --- | --- |
| Keywords: | aac added |

Replying to [seviezhou](/ticket/8859 "#8859: defect: A heap-buffer-overflow in aacdec_template.c:543:15 (closed: duplicate)"):

> ```
> ./configure --disable-shared --enable-debug=3 --disable-ffplay --disable-ffprobe --disable-doc --disable-asm --cc=clang --cxx=clang++ --ld=clang --toolchain=clang-asan
>
> ```

This will get more readable if you use `./configure --toolchain=clang-asan && make ffmpeg_g`, feel free to add `--disable-asm`.

> ```
> ./ffmpeg -y -f mov /dev/null -i @@
>
> ```

This is unfortunately useless, use `ffmpeg_g` instead and post everything that gets printed, not only the part you consider important (we disagree).

Please do not use zip here and please explain what "JIT" means.

### by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-22T11%3A49%3A47Z&precision=second "See timeline at Aug 22, 2020, 11:49:47 AM")

| Attachment: | [*heap-overflow-ffmpeg-JIT*](/attachment/ticket/8859/heap-overflow-ffmpeg-JIT)[​](/raw-attachment/ticket/8859/heap-overflow-ffmpeg-JIT "Download") added |
| --- | --- |

### [comment:2](#comment:2) by Cigaes, [4 years ago](/timeline?from=2020-08-22T11%3A51%3A03Z&precision=second "See timeline at Aug 22, 2020, 11:51:03 AM")

Just a small question: what is this "JIT code" you are referring to?

### [comment:3](#comment:3) by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-22T11%3A54%3A42Z&precision=second "See timeline at Aug 22, 2020, 11:54:42 AM")

Just because although I enabled debug information and disable inline assembly, I still cannot get any source line information from the backtrace. So I think the crash point might not in the source code, but in the assembly code. So I guess that the crash point is in some "just in time generated" code. Any ideas about this?

### [comment:4](#comment:4) by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-22T11%3A59%3A54Z&precision=second "See timeline at Aug 22, 2020, 11:59:54 AM")

Here is the output of ffmpeg\_g, I am sorry for my previous post:

```
ffmpeg version N-98801-g3fc3d712a9 Copyright (c) 2000-2020 the FFmpeg developers
  built with clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)
  configuration: --disable-shared --enable-debug=3 --disable-ffplay --disable-ffprobe --disable-doc --disable-asm --cc=clang --cxx=clang++ --ld=clang --toolchain=clang-asan
  libavutil      56. 58.100 / 56. 58.100
  libavcodec     58.101.100 / 58.101.100
  libavformat    58. 51.100 / 58. 51.100
  libavdevice    58. 11.101 / 58. 11.101
  libavfilter     7. 87.100 /  7. 87.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
[aac @ 0x61b000000080] Format aac detected only with low score of 1, misdetection possible!
[aac @ 0x619000000580] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x61b000000080] Packet corrupt (stream = 0, dts = NOPTS).
[aac @ 0x619000000580] Error decoding AAC frame header.
[aac @ 0x619000000580] Sample rate index in program config element does not match the sample rate index configured by the container.
=================================================================
==36919==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6240000055d0 at pc 0x0000027e9428 bp 0x7ffe1de34230 sp 0x7ffe1de34228
READ of size 8 at 0x6240000055d0 thread T0
    #0 0x27e9427 in che_configure /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c
    #1 0x27db93d in output_configure /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:543:15
    #2 0x27ef51c in aac_decode_frame_int /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3312:23
    #3 0x27d7843 in aac_decode_frame /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3457:15
    #4 0x12659b8 in decode_simple_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:342:15
    #5 0x12659b8 in decode_simple_receive_frame /home/seviezhou/ffmpeg/libavcodec/decode.c:538
    #6 0x12659b8 in decode_receive_frame_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:556
    #7 0x12652cd in avcodec_send_packet /home/seviezhou/ffmpeg/libavcodec/decode.c:614:15
    #8 0xfabadf in try_decode_frame /home/seviezhou/ffmpeg/libavformat/utils.c:3111:19
    #9 0xfa3054 in avformat_find_stream_info /home/seviezhou/ffmpeg/libavformat/utils.c:3954:9
    #10 0x5181fa in open_input_file /home/seviezhou/ffmpeg/fftools/ffmpeg_opt.c:1186:15
    #11 0x516d6a in open_files /home/seviezhou/ffmpeg/fftools/ffmpeg_opt.c:3303:15
    #12 0x516795 in ffmpeg_parse_options /home/seviezhou/ffmpeg/fftools/ffmpeg_opt.c:3343:11
    #13 0x555d8f in main /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4850:11
    #14 0x7fd409933b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #15 0x41df49 in _start (/home/seviezhou/ffmpeg/ffmpeg_g+0x41df49)

Address 0x6240000055d0 is a wild pointer.
SUMMARY: AddressSanitizer: heap-buffer-overflow /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c in che_configure
Shadow bytes around the buggy address:
  0x0c487fff8a60: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8a70: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8a80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8a90: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8aa0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c487fff8ab0: fa fa fa fa fa fa fa fa fa fa[fa]fa fa fa fa fa
  0x0c487fff8ac0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8ad0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8ae0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8af0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c487fff8b00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==36919==ABORTING

```

### [comment:5](#comment:5) by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-22T12%3A06%3A13Z&precision=second "See timeline at Aug 22, 2020, 12:06:13 PM")

| Summary: | A heap-buffer-overflow in FFmpeg JIT code → A heap-buffer-overflow in aacdec\_template.c:543:15 |
| --- | --- |

### [comment:6](#comment:6) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-24T21%3A33%3A50Z&precision=second "See timeline at Aug 24, 2020, 9:33:50 PM")

| Resolution: | → duplicate |
| --- | --- |
| Status: | new → closed |

Fixed by Jan Ekström in [d6f293353c94c7ce200f6e0975ae3de49787f91f](/changeset/d6f293353c94c7ce200f6e0975ae3de49787f91f/ffmpeg "avcodec/aacdec_template: add more checks to make sure only 22.2 gets ...")

**Note:**
See [TracTickets](/wiki/TracTickets)
for help on using tickets.

### Download in other formats:

* [RSS Feed](/ticket/8859?format=rss)
* [Comma-delimited Text](/ticket/8859?format=csv)
* [Tab-delimited Text](/ticket/8859?format=tab)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.6**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Visit the Trac open source project at
<http://trac.edgewall.org/>



=== Content from trac.ffmpeg.org_b6997f30_20250119_124738.html ===


[![FFmpeg](/ffmpeg-logo.png)](https://ffmpeg.org)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Help/Guide](/wiki/TracGuide)
* [About Trac](/about)
* [Register](/register)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [View Tickets](/report)
* [Search](/search)
* [Tags](/tags)

## Context Navigation

* ![Up-vote](/chrome/vote/aupgray.png)+0![Down-vote](/chrome/vote/adowngray.png)
* ← [Previous Ticket](/ticket/8859 "Ticket #8859")
* [Next Ticket](/ticket/8861 "Ticket #8861") →

---

Opened [4 years ago](/timeline?from=2020-08-22T12%3A19%3A58Z&precision=second "See timeline at Aug 22, 2020, 12:19:58 PM")

Closed [4 years ago](/timeline?from=2020-08-24T21%3A33%3A37Z&precision=second "See timeline at Aug 24, 2020, 9:33:37 PM")

## [#8860](/ticket/8860) [closed](/query?status=closed) [defect](/query?status=!closed&type=defect) ([duplicate](/query?resolution=duplicate&status=closed))

# A stack-buffer-overflow in aacdec\_template.c:539:24

| Reported by: | [Zhou Anshunkang](/query?reporter=seviezhou&status=!closed) | Owned by: |  |
| --- | --- | --- | --- |
| Priority: | [normal](/query?priority=normal&status=!closed) | Component: | [avcodec](/query?component=avcodec&status=!closed) |
| Version: | [git-master](/query?status=!closed&version=git-master) | Keywords: | [aac](/query?keywords=~aac&status=!closed) |
| Cc: |  | Blocked By: |  |
| Blocking: |  | Reproduced by developer: | [no](/query?reproduced=0&status=!closed) |
| Analyzed by developer: | [no](/query?analyzed=0&status=!closed) |  |  |

## Description

## System info

Ubuntu x86\_64, clang 6.0, ffmpeg (git-master [​https://github.com/FFmpeg/FFmpeg/commit/01a580f141627cfc8eae5de2300d2d93911887e3](https://github.com/FFmpeg/FFmpeg/commit/01a580f141627cfc8eae5de2300d2d93911887e3))

## Configure

```
./configure --toolchain=clang-asan && make ffmpeg_g

```
## Command line

```
./ffmpeg_g -y -f mov /dev/null -i @@

```
## AddressSanitizer

```
 built with clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)
  configuration: --disable-shared --enable-debug=3 --disable-ffplay --disable-ffprobe --disable-doc --disable-asm --cc=clang --cxx=clang++ --ld=clang --toolchain=clang-asan
  libavutil      56. 58.100 / 56. 58.100
  libavcodec     58.101.100 / 58.101.100
  libavformat    58. 51.100 / 58. 51.100
  libavdevice    58. 11.101 / 58. 11.101
  libavfilter     7. 87.100 /  7. 87.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
[aac @ 0x61b000000080] Format aac detected only with low score of 1, misdetection possible!
[aac @ 0x61b000000080] Packet corrupt (stream = 0, dts = NOPTS).
[aac @ 0x619000000580] Error decoding AAC frame header.
[aac @ 0x619000000580] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x619000000580] Multiple frames in a packet.
[aac @ 0x619000000580] channel element 3.6 is not allocated
[aac @ 0x61b000000080] decoding for stream 0 failed
[aac @ 0x61b000000080] Estimating duration from bitrate, this may be inaccurate
[aac @ 0x61b000000080] Could not find codec parameters for stream 0 (Audio: aac (Main), 4.0, fltp, 198 kb/s): unspecified sample rate
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
Input #0, aac, from '/home/seviezhou/stack-overflow-output_configure-aacdec_template-539':
  Duration: 00:00:00.02, bitrate: 198 kb/s
    Stream #0:0: Audio: aac (Main), 4.0, fltp, 198 kb/s
Stream mapping:
  Stream #0:0 -> #0:0 (aac (native) -> aac (native))
Press [q] to stop, [?] for help
[aac @ 0x619000001e80] Error decoding AAC frame header.
Error while decoding stream #0:0: Error number -50531338 occurred
[aac @ 0x619000001e80] Gain control is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x619000001e80] Sample rate index in program config element does not match the sample rate index configured by the container.
=================================================================
==66288==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffeac79c4b4 at pc 0x0000027df271 bp 0x7ffeac79b770 sp 0x7ffeac79b768
READ of size 1 at 0x7ffeac79c4b4 thread T0
    #0 0x27df270 in output_configure /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:539:24
    #1 0x27ef51c in aac_decode_frame_int /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3312:23
    #2 0x27d7843 in aac_decode_frame /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3457:15
    #3 0x12659b8 in decode_simple_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:342:15
    #4 0x12659b8 in decode_simple_receive_frame /home/seviezhou/ffmpeg/libavcodec/decode.c:538
    #5 0x12659b8 in decode_receive_frame_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:556
    #6 0x12652cd in avcodec_send_packet /home/seviezhou/ffmpeg/libavcodec/decode.c:614:15
    #7 0x567e4e in decode /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2217:15
    #8 0x567e4e in decode_audio /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2274
    #9 0x567e4e in process_input_packet /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2596
    #10 0x560528 in process_input /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4493:5
    #11 0x560528 in transcode_step /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4613
    #12 0x560528 in transcode /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4667
    #13 0x555f45 in main /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4872:9
    #14 0x7fb163d6db96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #15 0x41df49 in _start (/home/seviezhou/ffmpeg/ffmpeg_g+0x41df49)

Address 0x7ffeac79c4b4 is located in stack of thread T0 at offset 1012 in frame
    #0 0x27ea7ef in aac_decode_frame_int /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3198

  This frame has 7 object(s):
    [32, 288) 'buf.i.i' (line 2467)
    [352, 356) 'major.i.i' (line 2468)
    [368, 372) 'minor.i.i' (line 2468)
    [384, 404) 'hdr_info.i' (line 3065)
    [448, 640) 'layout_map.i' (line 3066)
    [704, 768) 'che_presence' (line 3206)
    [800, 992) 'layout_map' (line 3292) <== Memory access at offset 1012 overflows this variable
HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: stack-buffer-overflow /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:539:24 in output_configure
Shadow bytes around the buggy address:
  0x1000558eb840: f2 f2 f2 f2 f8 f2 f8 f2 f8 f8 f8 f2 f2 f2 f2 f2
  0x1000558eb850: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
  0x1000558eb860: f8 f8 f8 f8 f8 f8 f8 f8 f2 f2 f2 f2 f2 f2 f2 f2
  0x1000558eb870: 00 00 00 00 00 00 00 00 f2 f2 f2 f2 00 00 00 00
  0x1000558eb880: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x1000558eb890: 00 00 00 00 f3 f3[f3]f3 f3 f3 f3 f3 00 00 00 00
  0x1000558eb8a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000558eb8b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000558eb8c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000558eb8d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000558eb8e0: 00 00 00 00 00 00 00 00 00 00 00 00 f1 f1 f1 f1
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==66288==ABORTING

```

### Attachments (1)

[stack-overflow-output\_configure-aacdec\_template-539](/attachment/ticket/8860/stack-overflow-output_configure-aacdec_template-539 "View attachment")[​](/raw-attachment/ticket/8860/stack-overflow-output_configure-aacdec_template-539 "Download")
(423 bytes
) - added by Zhou Anshunkang [4 years ago](/timeline?from=2020-08-22T12%3A20%3A19Z&precision=second "See timeline at Aug 22, 2020, 12:20:19 PM").
stack-overflow-output\_configure-aacdec\_template-539

Download all attachments as:
[.zip](/zip-attachment/ticket/8860/)

Oldest first

Newest first

Threaded

Show comments

Show property changes

### Change History (4)

### by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-22T12%3A20%3A19Z&precision=second "See timeline at Aug 22, 2020, 12:20:19 PM")

| Attachment: | [*stack-overflow-output\_configure-aacdec\_template-539*](/attachment/ticket/8860/stack-overflow-output_configure-aacdec_template-539)[​](/raw-attachment/ticket/8860/stack-overflow-output_configure-aacdec_template-539 "Download") added |
| --- | --- |

stack-overflow-output\_configure-aacdec\_template-539

### in reply to: [description](#comment:description) [comment:1](#comment:1) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-22T13%3A43%3A38Z&precision=second "See timeline at Aug 22, 2020, 1:43:38 PM")

Replying to [seviezhou](/ticket/8860 "#8860: defect: A stack-buffer-overflow in aacdec_template.c:539:24 (closed: duplicate)"):

> ```
>   configuration: --disable-shared --enable-debug=3 --disable-ffplay --disable-ffprobe --disable-doc --disable-asm --cc=clang --cxx=clang++ --ld=clang --toolchain=clang-asan
>
> ```

As said: Please use `./configure --toolchain=clang-asan && make ffmpeg_g` instead to make your reports more readable. And maybe wait with opening more aac related reports until the ones you opened are fixed.

### [comment:2](#comment:2) by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-22T13%3A53%3A50Z&precision=second "See timeline at Aug 22, 2020, 1:53:50 PM")

Use `./configure --toolchain=clang-asan && make ffmpeg_g`:

```
ffmpeg version N-98802-g01a580f141 Copyright (c) 2000-2020 the FFmpeg developers
  built with clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)
  configuration: --toolchain=clang-asan
  libavutil      56. 58.100 / 56. 58.100
  libavcodec     58.101.100 / 58.101.100
  libavformat    58. 51.100 / 58. 51.100
  libavdevice    58. 11.101 / 58. 11.101
  libavfilter     7. 87.100 /  7. 87.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
[aac @ 0x61b000000080] Format aac detected only with low score of 1, misdetection possible!
[aac @ 0x61b000000080] Packet corrupt (stream = 0, dts = NOPTS).
[aac @ 0x619000000580] Error decoding AAC frame header.
[aac @ 0x619000000580] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x619000000580] Multiple frames in a packet.
[aac @ 0x619000000580] channel element 3.6 is not allocated
[aac @ 0x61b000000080] decoding for stream 0 failed
[aac @ 0x61b000000080] Estimating duration from bitrate, this may be inaccurate
[aac @ 0x61b000000080] Could not find codec parameters for stream 0 (Audio: aac (Main), 4.0, fltp, 198 kb/s): unspecified sample rate
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
Input #0, aac, from 'stack-overflow-output_configure-aacdec_template-539':
  Duration: 00:00:00.02, bitrate: 198 kb/s
    Stream #0:0: Audio: aac (Main), 4.0, fltp, 198 kb/s
Stream mapping:
  Stream #0:0 -> #0:0 (aac (native) -> aac (native))
Press [q] to stop, [?] for help
[aac @ 0x619000001e80] Error decoding AAC frame header.
Error while decoding stream #0:0: Error number -50531338 occurred
[aac @ 0x619000001e80] Gain control is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x619000001e80] Sample rate index in program config element does not match the sample rate index configured by the container.
=================================================================
==30448==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7fffe9040e65 at pc 0x00000294ef91 bp 0x7fffe903fe10 sp 0x7fffe903fe08
READ of size 1 at 0x7fffe9040e65 thread T0
    #0 0x294ef90 in output_configure /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:539:24
    #1 0x295ee10 in aac_decode_frame_int /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3312:23
    #2 0x2947523 in aac_decode_frame /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3457:15
    #3 0x126db5c in decode_simple_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:342:15
    #4 0x126db5c in decode_simple_receive_frame /home/seviezhou/ffmpeg/libavcodec/decode.c:538
    #5 0x126db5c in decode_receive_frame_internal /home/seviezhou/ffmpeg/libavcodec/decode.c:556
    #6 0x126d46d in avcodec_send_packet /home/seviezhou/ffmpeg/libavcodec/decode.c:614:15
    #7 0x567e4e in decode /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2217:15
    #8 0x567e4e in decode_audio /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2274
    #9 0x567e4e in process_input_packet /home/seviezhou/ffmpeg/fftools/ffmpeg.c:2596
    #10 0x560528 in process_input /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4493:5
    #11 0x560528 in transcode_step /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4613
    #12 0x560528 in transcode /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4667
    #13 0x555f45 in main /home/seviezhou/ffmpeg/fftools/ffmpeg.c:4872:9
    #14 0x7ffa992fbb96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #15 0x41df89 in _start (/home/seviezhou/ffmpeg/ffmpeg_g+0x41df89)

Address 0x7fffe9040e65 is located in stack of thread T0 at offset 165 in frame
    #0 0x2946f3f in aac_decode_frame /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:3409

  This frame has 4 object(s):
    [32, 64) 'gb.i' (line 1113)
    [96, 128) 'gb' (line 3413)
    [160, 164) 'new_extradata_size' (line 3417) <== Memory access at offset 165 overflows this variable
    [176, 180) 'jp_dualmono_size' (line 3421)
HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: stack-buffer-overflow /home/seviezhou/ffmpeg/libavcodec/aacdec_template.c:539:24 in output_configure
Shadow bytes around the buggy address:
  0x10007d200170: f8 f8 f8 f8 f8 f8 f8 f8 f2 f2 f2 f2 f2 f2 f2 f2
  0x10007d200180: 00 00 00 00 00 00 00 00 f2 f2 f2 f2 00 00 00 00
  0x10007d200190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007d2001a0: 00 00 00 00 f3 f3 f3 f3 f3 f3 f3 f3 00 00 00 00
  0x10007d2001b0: 00 00 00 00 00 00 00 00 f1 f1 f1 f1 f8 f8 f8 f8
=>0x10007d2001c0: f2 f2 f2 f2 00 00 00 00 f2 f2 f2 f2[04]f2 04 f3
  0x10007d2001d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007d2001e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007d2001f0: 00 00 00 00 00 00 00 00 00 00 00 00 f1 f1 f1 f1
  0x10007d200200: 04 f2 f8 f3 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007d200210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==30448==ABORTING

```

### [comment:3](#comment:3) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-24T21%3A33%3A37Z&precision=second "See timeline at Aug 24, 2020, 9:33:37 PM")

| Resolution: | → duplicate |
| --- | --- |
| Status: | new → closed |

Fixed by Jan Ekström in [d6f293353c94c7ce200f6e0975ae3de49787f91f](/changeset/d6f293353c94c7ce200f6e0975ae3de49787f91f/ffmpeg "avcodec/aacdec_template: add more checks to make sure only 22.2 gets ...")

**Note:**
See [TracTickets](/wiki/TracTickets)
for help on using tickets.

### Download in other formats:

* [RSS Feed](/ticket/8860?format=rss)
* [Comma-delimited Text](/ticket/8860?format=csv)
* [Tab-delimited Text](/ticket/8860?format=tab)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.6**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Visit the Trac open source project at
<http://trac.edgewall.org/>



=== Content from trac.ffmpeg.org_c90320a5_20250119_124737.html ===


[![FFmpeg](/ffmpeg-logo.png)](https://ffmpeg.org)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Help/Guide](/wiki/TracGuide)
* [About Trac](/about)
* [Register](/register)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [View Tickets](/report)
* [Search](/search)
* [Tags](/tags)

## Context Navigation

* ![Up-vote](/chrome/vote/aupgray.png)+0![Down-vote](/chrome/vote/adowngray.png)
* ← [Previous Ticket](/ticket/8844 "Ticket #8844")
* [Next Ticket](/ticket/8846 "Ticket #8846") →

---

Opened [4 years ago](/timeline?from=2020-08-11T02%3A52%3A01Z&precision=second "See timeline at Aug 11, 2020, 2:52:01 AM")

Closed [4 years ago](/timeline?from=2020-08-24T21%3A33%3A17Z&precision=second "See timeline at Aug 24, 2020, 9:33:17 PM")

Last modified [4 years ago](/timeline?from=2021-07-13T20%3A56%3A49Z&precision=second "See timeline at Jul 13, 2021, 8:56:49 PM")

## [#8845](/ticket/8845) [closed](/query?status=closed) [defect](/query?status=!closed&type=defect) ([fixed](/query?resolution=fixed&status=closed))

# A stack-buffer-overflow in FFmpeg JIT code

| Reported by: | [Zhou Anshunkang](/query?reporter=seviezhou&status=!closed) | Owned by: |  |
| --- | --- | --- | --- |
| Priority: | [important](/query?priority=important&status=!closed) | Component: | [avcodec](/query?component=avcodec&status=!closed) |
| Version: | [git-master](/query?status=!closed&version=git-master) | Keywords: | [aac](/query?keywords=~aac&status=!closed) |
| Cc: |  | Blocked By: |  |
| Blocking: |  | Reproduced by developer: | [no](/query?reproduced=0&status=!closed) |
| Analyzed by developer: | [no](/query?analyzed=0&status=!closed) |  |  |

## Description

## System info

Ubuntu x86\_64, clang 6.0, ffmpeg (git-master [​https://github.com/FFmpeg/FFmpeg/commit/1ead176d874acb489827ace3935fc71e1eea7e0e](https://github.com/FFmpeg/FFmpeg/commit/1ead176d874acb489827ace3935fc71e1eea7e0e))

## Configure

```
./configure --cc=clang --cxx=clang++ --ld=clang --enable-debug --toolchain=clang-asan

```
## Command line

```
./ffmpeg -i @@ -y -f mov /dev/null

```
## Address Sanitizer

```
  built with clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)
  configuration: --cc=clang --cxx=clang++ --ld=clang --enable-debug --toolchain=clang-asan
  libavutil      56. 58.100 / 56. 58.100
  libavcodec     58.100.100 / 58.100.100
  libavformat    58. 50.100 / 58. 50.100
  libavdevice    58. 11.101 / 58. 11.101
  libavfilter     7. 87.100 /  7. 87.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
[aac @ 0x61b000000080] Format aac detected only with low score of 1, misdetection possible!
[aac @ 0x619000000580] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x61b000000080] Packet corrupt (stream = 0, dts = NOPTS).
[aac @ 0x619000000580] Sample rate index in program config element does not match the sample rate index configured by the container.
[aac @ 0x619000000580] Inconsistent channel configuration.
[aac @ 0x619000000580] get_buffer() failed
[aac @ 0x61b000000080] decoding for stream 0 failed
[aac @ 0x61b000000080] Estimating duration from bitrate, this may be inaccurate
[aac @ 0x61b000000080] Could not find codec parameters for stream 0 (Audio: aac (Main), 13 channels (FL+FR+FLC+FRC+TC+TFL+TFC+TFR+TBL+TBC+TBR+TSL+TSR+BFC+BFL+BFR), fltp, 5 kb/s): unspecified sample rate
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
Input #0, aac, from '/home/seviezhou//experiment-3/AlphaFuzz-ffmpeg/alpha_out/crashes/id:000001,src:003723,op:havoc':
  Duration: 00:00:00.18, bitrate: 5 kb/s
    Stream #0:0: Audio: aac (Main), 13 channels (FL+FR+FLC+FRC+TC+TFL+TFC+TFR+TBL+TBC+TBR+TSL+TSR+BFC+BFL+BFR), fltp, 5 kb/s
[aac @ 0x619000002380] Channel layout '16 channels (FL+FR+FLC+FRC+TC+TFL+TFC+TFR+TBL+TBC+TBR+TSL+TSR+BFC+BFL+BFR)' with 16 channels does not match specified number of channels 13: ignoring specified channel layout
Stream mapping:
  Stream #0:0 -> #0:0 (aac (native) -> aac (native))
Press [q] to stop, [?] for help
[aac @ 0x619000002380] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x619000002380] channel element 3.7 is not allocated
Error while decoding stream #0:0: Invalid data found when processing input
[aac @ 0x619000002380] Sample rate index in program config element does not match the sample rate index configured by the container.
=================================================================
==48056==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffff1e2fba5 at pc 0x0000029497f1 bp 0x7ffff1e2eb50 sp 0x7ffff1e2eb48
READ of size 1 at 0x7ffff1e2fba5 thread T0
    #0 0x29497f0  (/home/seviezhou/ffmpeg/ffmpeg+0x29497f0)
    #1 0x2959670  (/home/seviezhou/ffmpeg/ffmpeg+0x2959670)
    #2 0x2941d83  (/home/seviezhou/ffmpeg/ffmpeg+0x2941d83)
    #3 0x126e91c  (/home/seviezhou/ffmpeg/ffmpeg+0x126e91c)
    #4 0x126e22d  (/home/seviezhou/ffmpeg/ffmpeg+0x126e22d)
    #5 0x567dae  (/home/seviezhou/ffmpeg/ffmpeg+0x567dae)
    #6 0x560488  (/home/seviezhou/ffmpeg/ffmpeg+0x560488)
    #7 0x555ea5  (/home/seviezhou/ffmpeg/ffmpeg+0x555ea5)
    #8 0x7f1571274b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #9 0x41dea9 in _init (/home/seviezhou/ffmpeg/ffmpeg+0x41dea9)

Address 0x7ffff1e2fba5 is located in stack of thread T0 at offset 165 in frame
    #0 0x294179f  (/home/seviezhou/ffmpeg/ffmpeg+0x294179f)

  This frame has 4 object(s):
    [32, 64) 'gb.i' (line 1113)
    [96, 128) 'gb' (line 3413)
    [160, 164) 'new_extradata_size' (line 3417) <== Memory access at offset 165 overflows this variable
    [176, 180) 'jp_dualmono_size' (line 3421)
HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: stack-buffer-overflow (/home/seviezhou/ffmpeg/ffmpeg+0x29497f0)
Shadow bytes around the buggy address:
  0x10007e3bdf20: f2 f2 f2 f2 f2 f2 f2 f2 00 00 00 00 00 00 00 00
  0x10007e3bdf30: f2 f2 f2 f2 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007e3bdf40: 00 00 00 00 00 00 00 00 00 00 00 00 f3 f3 f3 f3
  0x10007e3bdf50: f3 f3 f3 f3 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007e3bdf60: f1 f1 f1 f1 f8 f8 f8 f8 f2 f2 f2 f2 00 00 00 00
=>0x10007e3bdf70: f2 f2 f2 f2[04]f2 04 f3 00 00 00 00 00 00 00 00
  0x10007e3bdf80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007e3bdf90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007e3bdfa0: 00 00 00 00 f1 f1 f1 f1 04 f2 f8 f3 00 00 00 00
  0x10007e3bdfb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x10007e3bdfc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==48056==ABORTING

```

It seems that if I ran this command multiple times, it can crash different objects, here is another ASAN output, using the same input:

```
  built with clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)
  configuration: --cc=clang --cxx=clang++ --ld=clang --enable-debug --toolchain=clang-asan
  libavutil      56. 58.100 / 56. 58.100
  libavcodec     58.100.100 / 58.100.100
  libavformat    58. 50.100 / 58. 50.100
  libavdevice    58. 11.101 / 58. 11.101
  libavfilter     7. 87.100 /  7. 87.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
[aac @ 0x61b000000080] Format aac detected only with low score of 1, misdetection possible!
[aac @ 0x619000000580] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
[aac @ 0x61b000000080] Packet corrupt (stream = 0, dts = NOPTS).
[aac @ 0x619000000580] Sample rate index in program config element does not match the sample rate index configured by the container.
=================================================================
==73492==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffe338744d7 at pc 0x0000029497f1 bp 0x7ffe33873cd0 sp 0x7ffe33873cc8
READ of size 1 at 0x7ffe338744d7 thread T0
    #0 0x29497f0  (/home/seviezhou/ffmpeg/ffmpeg+0x29497f0)
    #1 0x2959670  (/home/seviezhou/ffmpeg/ffmpeg+0x2959670)
    #2 0x2941d83  (/home/seviezhou/ffmpeg/ffmpeg+0x2941d83)
    #3 0x126e91c  (/home/seviezhou/ffmpeg/ffmpeg+0x126e91c)
    #4 0x126e22d  (/home/seviezhou/ffmpeg/ffmpeg+0x126e22d)
    #5 0xfbf83f  (/home/seviezhou/ffmpeg/ffmpeg+0xfbf83f)
    #6 0xfb6db4  (/home/seviezhou/ffmpeg/ffmpeg+0xfb6db4)
    #7 0x51815a  (/home/seviezhou/ffmpeg/ffmpeg+0x51815a)
    #8 0x516cca  (/home/seviezhou/ffmpeg/ffmpeg+0x516cca)
    #9 0x5166f5  (/home/seviezhou/ffmpeg/ffmpeg+0x5166f5)
    #10 0x555cef  (/home/seviezhou/ffmpeg/ffmpeg+0x555cef)
    #11 0x7f0651f26b96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #12 0x41dea9 in _init (/home/seviezhou/ffmpeg/ffmpeg+0x41dea9)

Address 0x7ffe338744d7 is located in stack of thread T0 at offset 2039 in frame
    #0 0x294596f  (/home/seviezhou/ffmpeg/ffmpeg+0x294596f)

  This frame has 26 object(s):
    [32, 37) '.compoundliteral.sroa.5.i.i' (line 199)
    [64, 69) '.compoundliteral11.sroa.5.i.i' (line 199)
    [96, 101) '.compoundliteral22.sroa.5.i.i' (line 199)
    [128, 1152) 'e2c_vec.i' (line 263)
    [1280, 1285) '.compoundliteral.sroa.5.i' (line 260)
    [1312, 1317) '.compoundliteral60.sroa.5.i' (line 260)
    [1344, 1349) '.compoundliteral80.sroa.5.i' (line 260)
    [1376, 1381) '.compoundliteral99.sroa.5.i' (line 260)
    [1408, 1413) '.compoundliteral118.sroa.5.i' (line 260)
    [1440, 1445) '.compoundliteral133.sroa.5.i' (line 260)
    [1472, 1477) '.compoundliteral156.sroa.5.i' (line 260)
    [1504, 1509) '.compoundliteral176.sroa.5.i' (line 260)
    [1536, 1541) '.compoundliteral193.sroa.5.i' (line 260)
    [1568, 1584) 'SWAP_tmp.i' (line 438)
    [1600, 1616) 'SWAP_tmp219.i' (line 439)
    [1632, 1648) 'SWAP_tmp224.i' (line 440)
    [1664, 1680) 'SWAP_tmp229.i' (line 441)
    [1696, 1712) 'SWAP_tmp234.i' (line 442)
    [1728, 1744) 'SWAP_tmp239.i' (line 443)
    [1760, 1776) 'SWAP_tmp244.i' (line 444)
    [1792, 1808) 'SWAP_tmp249.i' (line 445)
    [1824, 1840) 'SWAP_tmp254.i' (line 446)
    [1856, 1872) 'SWAP_tmp270.i' (line 454)
    [1888, 1892) 'channels' (line 514)
    [1904, 2016) 'id_map' (line 516)
    [2048, 2055) 'type_counts' (line 517) <== Memory access at offset 2039 underflows this variable
HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: stack-buffer-overflow (/home/seviezhou/ffmpeg/ffmpeg+0x29497f0)
Shadow bytes around the buggy address:
  0x100046706840: f8 f2 f2 f2 f8 f2 f2 f2 f8 f2 f2 f2 f8 f2 f2 f2
  0x100046706850: f8 f2 f2 f2 f8 f2 f2 f2 f8 f2 f2 f2 f8 f2 f2 f2
  0x100046706860: f8 f8 f2 f2 f8 f8 f2 f2 f8 f8 f2 f2 f8 f8 f2 f2
  0x100046706870: f8 f8 f2 f2 f8 f8 f2 f2 f8 f8 f2 f2 f8 f8 f2 f2
  0x100046706880: f8 f8 f2 f2 f8 f8 f2 f2 04 f2 00 00 00 00 00 00
=>0x100046706890: 00 00 00 00 00 00 00 00 f2 f2[f2]f2 07 f3 f3 f3
  0x1000467068a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000467068b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000467068c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000467068d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000467068e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==73492==ABORTING

```

After it crashes, it also seems to mess up the terminal.

### Attachments (1)

[stack-overflow-ffmpeg-JIT](/attachment/ticket/8845/stack-overflow-ffmpeg-JIT "View attachment")[​](/raw-attachment/ticket/8845/stack-overflow-ffmpeg-JIT "Download")
(116 bytes
) - added by Carl Eugen Hoyos [4 years ago](/timeline?from=2020-08-17T21%3A26%3A47Z&precision=second "See timeline at Aug 17, 2020, 9:26:47 PM").

Download all attachments as:
[.zip](/zip-attachment/ticket/8845/)

Oldest first

Newest first

Threaded

Show comments

Show property changes

### Change History (6)

### by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-17T21%3A26%3A47Z&precision=second "See timeline at Aug 17, 2020, 9:26:47 PM")

| Attachment: | [*stack-overflow-ffmpeg-JIT*](/attachment/ticket/8845/stack-overflow-ffmpeg-JIT)[​](/raw-attachment/ticket/8845/stack-overflow-ffmpeg-JIT "Download") added |
| --- | --- |

### [comment:1](#comment:1) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-17T21%3A31%3A34Z&precision=second "See timeline at Aug 17, 2020, 9:31:34 PM")

| Component: | ffmpeg → avcodec |
| --- | --- |
| Keywords: | aac added; asan removed |
| Priority: | normal → important |

valgrind shows a possible issue:

```
==17778== Invalid read of size 8
==17778==    at 0x4767E9: che_configure (aacdec_template.c:133)
==17778==    by 0x4767E9: output_configure.cold (aacdec_template.c:543)
==17778==    by 0xE889EC: aac_decode_frame_int.isra.0 (aacdec_template.c:3312)
==17778==    by 0xE8935C: aac_decode_frame (aacdec_template.c:3457)
==17778==    by 0x8B119F: decode_simple_internal (decode.c:342)
==17778==    by 0x8B119F: decode_simple_receive_frame (decode.c:538)
==17778==    by 0x8B119F: decode_receive_frame_internal (decode.c:556)
==17778==    by 0x8B1E4F: avcodec_send_packet (decode.c:614)
==17778==    by 0x4B85AC: decode (ffmpeg.c:2217)
==17778==    by 0x4B85AC: decode_audio (ffmpeg.c:2274)
==17778==    by 0x4B85AC: process_input_packet (ffmpeg.c:2596)
==17778==    by 0x4BB31A: process_input (ffmpeg.c:4493)
==17778==    by 0x4BB31A: transcode_step (ffmpeg.c:4613)
==17778==    by 0x4BB31A: transcode (ffmpeg.c:4667)
==17778==    by 0x49838D: main (ffmpeg.c:4872)

```

### [comment:2](#comment:2) by Zhou Anshunkang, [4 years ago](/timeline?from=2020-08-18T01%3A26%3A20Z&precision=second "See timeline at Aug 18, 2020, 1:26:20 AM")

I am not surely if these three bug reports point to the same location. I think it is a little bit strange.

### [comment:3](#comment:3) by jeeb, [4 years ago](/timeline?from=2020-08-20T20%3A41%3A13Z&precision=second "See timeline at Aug 20, 2020, 8:41:13 PM")

For the record I posted a patch set that would improve the sanity checks for 22.2 so that it is not as easy to get handled as such on the 18th, but so far have received no reviews:

[​https://patchwork.ffmpeg.org/project/ffmpeg/list/?series=2055](https://patchwork.ffmpeg.org/project/ffmpeg/list/?series=2055)

This causes both of the fuzzing samples I have received to no longer be an issue (with both valgrind and clang 10 ASAN), while it still enables valid 22.2 content to decode properly.

### [comment:4](#comment:4) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-08-24T21%3A33%3A17Z&precision=second "See timeline at Aug 24, 2020, 9:33:17 PM")

| Resolution: | → fixed |
| --- | --- |
| Status: | new → closed |

Fixed by Jan Ekström in [d6f293353c94c7ce200f6e0975ae3de49787f91f](/changeset/d6f293353c94c7ce200f6e0975ae3de49787f91f/ffmpeg "avcodec/aacdec_template: add more checks to make sure only 22.2 gets ...")

### [comment:5](#comment:5) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2021-07-13T20%3A56%3A49Z&precision=second "See timeline at Jul 13, 2021, 8:56:49 PM")

Since the information in the CVE report is wrong:

This issue is neither reproducible with FFmpeg 4.3 nor earlier versions.

**Note:**
See [TracTickets](/wiki/TracTickets)
for help on using tickets.

### Download in other formats:

* [RSS Feed](/ticket/8845?format=rss)
* [Comma-delimited Text](/ticket/8845?format=csv)
* [Tab-delimited Text](/ticket/8845?format=tab)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.6**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Visit the Trac open source project at
<http://trac.edgewall.org/>


