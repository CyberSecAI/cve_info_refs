=== Content from bugzilla.nasm.us_23560fcf_20250119_111214.html ===


Bugzilla – Bug 3392712
double-free in pp\_tokline asm/preproc.c:6750
Last modified: 2020-08-18 06:45:32 PDT

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/en/html/using/understanding.html)
* |
  [Log In](show_bug.cgi?id=3392712&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3392712&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

Self-registration is disabled due to spam issue (mail gorcunov@gmail.com or hpa@zytor.com to create an account)

[**Bug 3392712**](show_bug.cgi?id=3392712)
- double-free in pp\_tokline asm/preproc.c:6750

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
double-free in pp\_tokline asm/preproc.c:6750

| | [Status](page.cgi?id=fields.html#bug_status): | CLOSED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | NASM | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=NASM "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Assembler ([show other bugs](buglist.cgi?component=Assembler&product=NASM&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.15.xx | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Importance](page.cgi?id=fields.html#importance): | Medium normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | nobody | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | |  | | | Duplicates (2): | [3392670](show_bug.cgi?id=3392670 "CLOSED DUPLICATE - heap-use-after-free in asm/preproc.c:5058") [3392671](show_bug.cgi?id=3392671 "CLOSED DUPLICATE - heap-use-after-free in asm/preproc.c:4025")  ([view as bug list](buglist.cgi?bug_id=3392670,3392671)) | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2020-08-03 22:11 PDT by Suhwan | | --- | --- | | Modified: | 2020-08-18 06:45 PDT ([History](show_activity.cgi?id=3392712)) | | CC List: | 5 users (show)  chang.seok.bae gorcunov hpa nasm-bugs puppet | |  | | | [Obtained from:](page.cgi?id=fields.html#cf_build "Please indicate where you obtained and/or built your version of NASM.") | Build from source archive using configure | | [Generated by:](page.cgi?id=fields.html#cf_robot "Was this bug report generated by an automatic tool, such as a memory leak detector or fuzzer, *without* including a human validation description or analysis of the problem?") | --- | | [Bug category:](page.cgi?id=fields.html#cf_category "The general category of this bug oor request.") |  | | [Breaks existing code:](page.cgi?id=fields.html#cf_breaks "This bug report breaks existing code in production or under development.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**poc**](attachment.cgi?id=411800 "View the content of the attachment") (1.00 KB, text/x-matlab)  [2020-08-03 22:11 PDT](#attach_411800 "Go to the comment associated with the attachment"), Suhwan | [Details](attachment.cgi?id=411800&action=edit) | | [Add an attachment](attachment.cgi?bugid=3392712&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3392712&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3392712#c0)  Suhwan    2020-08-03 22:11:08 PDT  ``` Created [attachment 411800](attachment.cgi?id=411800 "poc") [[details]](attachment.cgi?id=411800&action=edit "poc") poc  Hi, we found a double-free in pp_tokline asm/preproc.c:6750 version : nasm-2.15.04rc3  Please run following command `nasm -f win -o tmp.o $PoC`   ==32583==ERROR: AddressSanitizer: attempting double-free on 0x60c0001d7700 in thread T0:     #0 0x7fb5dfbf97a8 in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xde7a8)     #1 0x556ecf725656 in nasm_free nasmlib/alloc.c:108     #2 0x556ecf769767 in pp_tokline asm/preproc.c:6750     #3 0x556ecf76a802 in pp_getline asm/preproc.c:6922     #4 0x556ecf7231dc in assemble_file asm/nasm.c:1718     #5 0x556ecf71e567 in main asm/nasm.c:714     #6 0x7fb5df74bb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)     #7 0x556ecf71b809 in _start (/mnt/hda2/suhwan/add_project/final/FINAL_TEST_ZONE/program/nasm-2.15.04rc3/install_dir/bin/nasm+0x111809)  0x60c0001d7700 is located 0 bytes inside of 128-byte region [0x60c0001d7700,0x60c0001d7780) freed by thread T0 here:     #0 0x7fb5dfbf97a8 in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xde7a8)     #1 0x556ecf725656 in nasm_free nasmlib/alloc.c:108     #2 0x556ecf769767 in pp_tokline asm/preproc.c:6750     #3 0x556ecf76a802 in pp_getline asm/preproc.c:6922     #4 0x556ecf7231dc in assemble_file asm/nasm.c:1718     #5 0x556ecf71e567 in main asm/nasm.c:714     #6 0x7fb5df74bb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)  previously allocated by thread T0 here:     #0 0x7fb5dfbf9d28 in __interceptor_calloc (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xded28)     #1 0x556ecf725572 in nasm_calloc nasmlib/alloc.c:72     #2 0x556ecf7541d6 in count_mmac_params asm/preproc.c:2443     #3 0x556ecf765d08 in is_mmacro asm/preproc.c:6004     #4 0x556ecf76722b in expand_mmacro asm/preproc.c:6284     #5 0x556ecf76a766 in pp_tokline asm/preproc.c:6910     #6 0x556ecf76a802 in pp_getline asm/preproc.c:6922     #7 0x556ecf7231dc in assemble_file asm/nasm.c:1718     #8 0x556ecf71e567 in main asm/nasm.c:714     #9 0x7fb5df74bb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)  SUMMARY: AddressSanitizer: double-free (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xde7a8) in __interceptor_free ==32583==ABORTING   This is found by Agency for Defense Development (ADD). ```  [Comment 1](show_bug.cgi?id=3392712#c1)  Cyrill Gorcunov    2020-08-17 11:32:47 PDT  ``` Fixed in 8806c3ca007b84accac21dd88b900fb03614ceb7. Thanks for report! Actually we've a bunch of memory leaks but this is less destructive than double free.  Still we need more precise look into our preproc code, sigh... ```  [Comment 2](show_bug.cgi?id=3392712#c2)  Cyrill Gorcunov    2020-08-18 06:44:47 PDT  ``` *** [Bug 3392671](show_bug.cgi?id=3392671 "CLOSED DUPLICATE - heap-use-after-free in asm/preproc.c:4025") has been marked as a duplicate of this bug. *** ```  [Comment 3](show_bug.cgi?id=3392712#c3)  Cyrill Gorcunov    2020-08-18 06:45:32 PDT  ``` *** [Bug 3392670](show_bug.cgi?id=3392670 "CLOSED DUPLICATE - heap-use-after-free in asm/preproc.c:5058") has been marked as a duplicate of this bug. *** ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3392712)
* - [XML](show_bug.cgi?ctype=xml&id=3392712)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3392712)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/en/html/using/understanding.html)
  + |
    [Log In](show_bug.cgi?id=3392712&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3392712&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


