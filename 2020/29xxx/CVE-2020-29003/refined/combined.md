=== Content from phabricator.wikimedia.org_3c74290b_20250119_123007.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT266508)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T266508
# PollNY: Stored XSS (CVE-2020-29003)Closed, Resolved[Public](/policy/explain/PHID-TASK-ghaxlm32p3pw4uqn36xa/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/266508/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/266508/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Protect as security issue](/wmf/escalate-task/266508/)
* [Award Token](/token/give/PHID-TASK-ghaxlm32p3pw4uqn36xa/)
* [Flag For Later](/flag/edit/PHID-TASK-ghaxlm32p3pw4uqn36xa/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Oct 26 2020, 8:43 PM2020-10-26 20:43:57 (UTC+0) |

Tags

* [Security](/tag/security/)
* [Vuln-XSS](/tag/vuln-xss/)
* [PollNY](/tag/pollny/) [(Backlog)](/project/board/510/)
* [Social-Tools](/tag/social-tools/) [(PollNY)](/project/board/1009/)
Referenced Files

|  | [F32416835: new-stored-xss-patch.patch](/F32416835) |
| --- | --- |
| Oct 27 2020, 9:19 PM2020-10-27 21:19:33 (UTC+0) |

|  | [F32415006: PollNY-Stored-XSS-T266508.patch](/F32415006) |
| --- | --- |
| Oct 26 2020, 8:48 PM2020-10-26 20:48:48 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [Isarra](/p/Isarra/) |
| --- | --- |

|  | [lcawte](/p/lcawte/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

Like [T266400](/T266400) but only for [PollNY](/tag/pollny/) this time around...

Prerequisites: [social tools](https://www.mediawiki.org/wiki/Social_tools) setup (MW 1.34 with [SocialProfile](https://www.mediawiki.org/wiki/Extension%3ASocialProfile), and for this particular bug, also need [PollNY](https://www.mediawiki.org/wiki/Extension%3APollNY))

1. Create a poll via Special:CreatePoll, or edit an existing one via Special:UpdatePoll
2. Have an answer option contain something like <script>alert('XSS')</script>
3. Save changes
4. When viewing the poll's page in the NS\_POLL namespace, the malicious code gets executed despite that it damn well shouldn't

The last step is also true for polls embedded on other wiki pages via the pollembed parser tag.

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [[SECURITY] Fix stored XSS via poll choices on Poll: pages etc.](https://gerrit.wikimedia.org/r/c/651588) | [mediawiki/extensions/PollNY](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PollNY) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PollNY/%2B/REL1_35) | +62 -19 |
|  | [[SECURITY] Fix stored XSS via poll choices on Poll: pages etc.](https://gerrit.wikimedia.org/r/c/641216) | [mediawiki/extensions/PollNY](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PollNY) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PollNY/%2B/master) | +62 -19 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T266508)
# Related Objects

* Mentions

Mentioned In [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810) Mentioned Here [T248390: Better NoJS support](/T248390)
[T266400: RandomGameUnit: Stored XSS (CVE-2020-27957)](/T266400)
### Event Timeline

[ashley](/p/ashley/) created this task.[Oct 26 2020, 8:43 PM2020-10-26 20:43:57 (UTC+0)](#6580012)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3956555/)[Oct 26 2020, 8:43 PM2020-10-26 20:43:58 (UTC+0)](#6580024)[ashley](/p/ashley/) claimed this task.[Oct 26 2020, 8:44 PM2020-10-26 20:44:26 (UTC+0)](#6580027)[ashley](/p/ashley/) added projects: [Vuln-XSS](/tag/vuln-xss/), [PollNY](/tag/pollny/).Restricted Application added a project: [Social-Tools](/tag/social-tools/).  · [View Herald Transcript](/herald/transcript/3956558/)[Oct 26 2020, 8:44 PM2020-10-26 20:44:27 (UTC+0)](#6580029)[ashley](/p/ashley/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-vovqo4u5yfhq5e3/)[Oct 26 2020, 8:45 PM2020-10-26 20:45:54 (UTC+0)](#6580030)[ashley](/p/ashley/) moved this task from [Backlog](/project/board/1009/) to [PollNY](/project/board/1009/) on the [Social-Tools](/tag/social-tools/) board.[Oct 26 2020, 8:48 PM2020-10-26 20:48:01 (UTC+0)](#6580035)Comment Actions

PollNY-Stored-XSS-T266508.patch7 KB[Download](https://phab.wmfusercontent.org/file/download/wnaewhotpa2b2jr4wxrb/PHID-FILE-fx636bmw2ie53dwhqb54/PollNY-Stored-XSS-T266508.patch)

Proposed patch which fixes the issues noted here and includes some unrelated no-JS work ([T248390](/T248390)); the relevant chunks are obviously the ones where htmlspecialchars is mentioned, except for the last one ("next poll" URL stuff), that's strictly no-JS related and not related to this ticket.

[Legoktm](/p/Legoktm/) subscribed.[Oct 27 2020, 5:06 PM2020-10-27 17:06:03 (UTC+0)](#6582096)Comment Actions
```
@@ -230,8 +230,9 @@ class PollNYHooks {

 					foreach ( $poll_info['choices'] as $choice ) {
 						$output .= "<div class=\"poll-choice\">
-						<input type=\"radio\" name=\"poll_choice\" data-poll-id=\"{$poll_info['id']}\" data-poll-page-id=\"{$poll_page_id}\" id=\"poll_choice\" value=\"{$choice['id']}\">{$choice['choice']}
-						</div>";
+						<input type=\"radio\" name=\"poll_choice\" data-poll-id=\"{$poll_info['id']}\" data-poll-page-id=\"{$poll_page_id}\" id=\"poll_choice\" value=\"{$choice['id']}\">";
+						$output .= htmlspecialchars( $choice['choice'], ENT_QUOTES );
+						$output .= '</div>';
 					}

 					$output .= Html::submitButton( wfMessage( 'poll-submit-btn' )->escaped(), [ 'class' => 'poll-vote-btn-nojs' ] );
```

Do you want to apply the same (int) casting for these ids just to make it obvious these are safe? Or switch to the Html wrapper which should escape attributes I believe?

Other stuff LGTM.

[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[Oct 27 2020, 8:16 PM2020-10-27 20:16:35 (UTC+0)](#6582818)[ashley](/p/ashley/) added a comment.[Oct 27 2020, 9:19 PM2020-10-27 21:19:33 (UTC+0)](#6583137)Comment Actions

new-stored-xss-patch.patch8 KB[Download](https://phab.wmfusercontent.org/file/download/72efrch5gvklwqkvbovm/PHID-FILE-xkhsfnqz73qozzomk7w2/new-stored-xss-patch.patch)

[@Legoktm](/p/Legoktm/) Thanks for the CR! While attempting to implement your changes, I found a few more nasty stored XSS lines in that same file...here's a new patch which hopefully catches 'em all, for good this time around.

[Reedy](/p/Reedy/) removed a project: [Security-Team](/tag/security-team/).[Nov 2 2020, 4:03 PM2020-11-02 16:03:41 (UTC+0)](#6596970)[ashley](/p/ashley/) added a subscriber: [Bawolff](/p/Bawolff/).[Nov 5 2020, 8:30 AM2020-11-05 08:30:06 (UTC+0)](#6605278)Comment Actions

cc'ing [@Bawolff](/p/Bawolff/) for thoughts

[Bawolff](/p/Bawolff/) added a comment.[Nov 5 2020, 8:48 AM2020-11-05 08:48:42 (UTC+0)](#6605338)Comment Actions

This looks like it fixes the XSS's properly, as far as that patch goes (I did not look at any of the other PollNY code beyond what was in the patch)

[sbassett](/p/sbassett/) subscribed.[Nov 5 2020, 8:33 PM2020-11-05 20:33:05 (UTC+0)](#6607466)Comment Actions

+1 to the patch at [T266508#6583137](/T266508#6583137). One thing I did notice was that in PollNY.hooks.php, the $choice['percent'] variable used to build the html string on [line 263](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PollNY/%2B/refs/heads/master/includes/PollNY.hooks.php#263) isn't cast to an int as similar variables are within the patch. The cast likely isn't necessary, even though this does appear to be a database value as opposed to a computed value as the similar percent variables are within PollPage.class.php. Just pointing out for consistency's sake.

[Legoktm](/p/Legoktm/) closed this task as Resolved.[Nov 16 2020, 6:35 PM2020-11-16 18:35:36 (UTC+0)](#6625156)[Legoktm](/p/Legoktm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-5wqxxxbkga4jaol/)" to "Public (No Login Required)".[Legoktm](/p/Legoktm/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-fevnwkwhn32akyy/)" to "All Users".[sbassett](/p/sbassett/) renamed this task from PollNY: Stored XSS to PollNY: Stored XSS (CVE-2020-29003).[Dec 1 2020, 5:47 PM2020-12-01 17:47:20 (UTC+0)](#6660485)[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 9:20 PM2020-12-22 21:20:39 (UTC+0)](#6709172)Comment Actions

Change 651588 had a related patch set uploaded (by SBassett; owner: Jack Phoenix):

[mediawiki/extensions/PollNY@REL1\_35] [SECURITY] Fix stored XSS via poll choices on Poll: pages etc.

<https://gerrit.wikimedia.org/r/651588>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Dec 22 2020, 9:20 PM2020-12-22 21:20:40 (UTC+0)](#6709173)[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 9:31 PM2020-12-22 21:31:35 (UTC+0)](#6709191)Comment Actions

Change 651588 **merged** by jenkins-bot:

[mediawiki/extensions/PollNY@REL1\_35] [SECURITY] Fix stored XSS via poll choices on Poll: pages etc.

<https://gerrit.wikimedia.org/r/651588>

[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Dec 22 2020, 10:10 PM2020-12-22 22:10:28 (UTC+0)](#6709309)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from phabricator.wikimedia.org_83cc9632_20250119_140745.html ===
[HomePhabricator](/)

* SearchConfigure Global Search
 [Auth](/auth/)  Login

Click the *MediaWiki* button below to connect your [Wikimedia unified account](https://meta.wikimedia.org/wiki/Help%3AUnified_login). Alternatively, click the *Wikitech Account (LDAP)* button to connect your [Developer account](https://www.mediawiki.org/wiki/Developer_account) credentials.

In case of doubt, [check the Phabricator Help](https://www.mediawiki.org/wiki/Phabricator/Help#Creating_your_account).

Log In or RegisterMediaWikiDeveloper Account Log InLDAP Account (IDP)
# Log In or Register with LDAP

LDAP UsernameLDAP PasswordLog In or RegisterTrouble logging in? [Send a login link to your email address.](/login/email/)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
