=== Content from docs.microsoft.com_a5d6894a_20250119_121628.html ===

[Skip to main content](#main)

This browser is no longer supported.

Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.

[Download Microsoft Edge](https://go.microsoft.com/fwlink/p/?LinkID=2092881 )
[More info about Internet Explorer and Microsoft Edge](https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge)

Table of contents

Exit focus mode

Read in English

Save

Table of contentsRead in English

Save

Add to Plan
[Edit](https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/Dlls/dynamic-link-library-search-order.md "Edit This Document")

---

#### Share via

Facebook
x.com
LinkedIn
Email

---

Print

Table of contents

# Dynamic-link library search order

* Article
* 02/09/2023
* 8 contributors

Feedback

## In this article

It's common for multiple versions of the same dynamic-link library (DLL) to exist in different file system locations within an operating system (OS). You *can* control the specific location from which any given DLL is loaded by specifying a full path. But if you don't use that method, then the system searches for the DLL at load time as described in this topic. The *DLL loader* is the part of the operating system (OS) that loads DLLs and/or resolves references to DLLs.

Tip

For definitions of *packaged* and *unpackaged* apps, see [Advantages and disadvantages of packaging your app](/en-us/windows/apps/package-and-deploy/#advantages-and-disadvantages-of-packaging-your-app).

## Factors that affect searching

Here are some special search factors that are discussed in this topicâyou can consider them to be part of the DLL search order. Later sections in this topic list these factors in the appropriate search order for certain app types, together with other search locations. This section is just to introduce the concepts, and to give them names that we'll use to refer to them later in the topic.

* **DLL redirection**. For details, see [Dynamic-link library redirection](/en-us/windows/win32/dlls/dynamic-link-library-redirection).
* **API sets**. For details, see [Windows API sets](/en-us/windows/win32/apiindex/windows-apisets).
* **Side-by-side (SxS) manifest redirection**âdesktop apps only (not UWP apps). You can redirect by using an application manifest (also known as a side-by-side application manifest, or a fusion manifest). For details, see [Manifests](/en-us/windows/win32/sbscs/manifests).
* **Loaded-module list**. The system can check to see whether a DLL with the same module name is already loaded into memory (no matter which folder it was loaded from).
* **Known DLLs**. If the DLL is on the list of known DLLs for the version of Windows on which the application is running, then the system uses its copy of the known DLL (and the known DLL's dependent DLLs, if any). For a list of known DLLs on the current system, see the registry key `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`.

If a DLL has dependencies, then the system searches for the dependent DLLs as if they were loaded by using only their module names. That's true even if the first DLL was loaded by specifying a full path.

## Search order for packaged apps

When a packaged app loads a packaged module (specifically, a library moduleâa `.dll` file) by calling the [**LoadPackagedLibrary**](/en-us/windows/win32/api/Winbase/nf-winbase-loadpackagedlibrary) function, the DLL must be in the package dependency graph of the process. For more information, see **LoadPackagedLibrary**. When a packaged app loads a module by other means, and doesn't specify a full path, the system searches for the DLL and its dependencies at load time as described in this section.

When the system searches for a module or its dependencies, it always uses the search order for packaged apps; even if a dependency is not packaged app code.

### Standard search order for packaged apps

The system searches in this order:

1. DLL redirection.
2. API sets.
3. **Desktop apps only (not UWP apps)**. SxS manifest redirection.
4. Loaded-module list.
5. Known DLLs.
6. The package dependency graph of the process. This is the application's package plus any dependencies specified as `<PackageDependency>` in the `<Dependencies>` section of the application's package manifest. Dependencies are searched in the order they appear in the manifest.
7. The folder the calling process was loaded from (the executable's folder).
8. The system folder (`%SystemRoot%\system32`).

If a DLL has dependencies, then the system searches for the dependent DLLs as if they were loaded with just their module names (even if the first DLL was loaded by specifying a full path).

### Alternate search order for packaged apps

If a module changes the standard search order by calling the [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function with **LOAD\_WITH\_ALTERED\_SEARCH\_PATH**, then the search order is the same as the standard search order except that in step 7 the system searches the folder that the specified module was loaded from (the top-loading module's folder) instead of the executable's folder.

## Search order for unpackaged apps

When an unpackaged app loads a module and doesn't specify a full path, the system searches for the DLL at load time as described in this section.

Important

If an attacker gains control of one of the directories that's searched, then it can place a malicious copy of the DLL in that folder. For ways to help prevent such attacks, see [Dynamic-link library security](/en-us/windows/win32/dlls/dynamic-link-library-security).

### Standard search order for unpackaged apps

The standard DLL search order used by the system depends on whether or not *safe DLL search mode* is enabled.

Safe DLL search mode (which is enabled by default) moves the user's current folder later in the search order. To disable safe DLL search mode, create the `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode` registry value, and set it to 0. Calling the [**SetDllDirectory**](/en-us/windows/win32/api/winbase/nf-winbase-setdlldirectorya) function effectively disables safe DLL search mode (while the specified folder is in the search path), and changes the search order as described in this topic.

If safe DLL search mode is enabled, then the search order is as follows:

1. DLL Redirection.
2. API sets.
3. SxS manifest redirection.
4. Loaded-module list.
5. Known DLLs.
6. **Windows 11, version 21H2 (10.0; Build 22000), and later**. The package dependency graph of the process. This is the application's package plus any dependencies specified as `<PackageDependency>` in the `<Dependencies>` section of the application's package manifest. Dependencies are searched in the order they appear in the manifest.
7. The folder from which the application loaded.
8. The system folder. Use the [**GetSystemDirectory**](/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya) function to retrieve the path of this folder.
9. The 16-bit system folder. There's no function that obtains the path of this folder, but it is searched.
10. The Windows folder. Use the [**GetWindowsDirectory**](/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya) function to get the path of this folder.
11. The current folder.
12. The directories that are listed in the `PATH` environment variable. This doesn't include the per-application path specified by the **App Paths** registry key. The **App Paths** key isn't used when computing the DLL search path.

If safe DLL search mode is *disabled*, then the search order is the same except that *the current folder* moves from position 11 to position 8 in the sequence (immediately after step *7. The folder from which the application loaded*).

### Alternate search order for unpackaged apps

To change the standard search order used by the system, you can call the [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function with **LOAD\_WITH\_ALTERED\_SEARCH\_PATH**. You can also change the standard search order by calling the [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) function.

Note

The standard search order of the process will also be affected by calling the [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) function in the parent process before the start of the current process.

If you specify an alternate search strategy, then its behavior continues until all associated executable modules have been located. After the system starts processing DLL initialization routines, the system reverts to the standard search strategy.

The [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function supports an alternate search order if the call specifies **LOAD\_WITH\_ALTERED\_SEARCH\_PATH**, and the *lpFileName* parameter specifies an absolute path.

* The standard search strategy begins (after the initial steps) in the calling application's folder.
* The alternate search strategy specified by [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) with **LOAD\_WITH\_ALTERED\_SEARCH\_PATH** begins (after the initial steps) in the folder of the executable module that **LoadLibraryEx** is loading.

That's the only way in which they differ.

If safe DLL search mode is enabled, then the alternate search order is as follows:

Steps 1-6 are the same as the standard search order.

7. The folder specified by *lpFileName*.
8. The system folder. Use the [**GetSystemDirectory**](/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya) function to retrieve the path of this folder.
9. The 16-bit system folder. There's no function that obtains the path of this folder, but it is searched.
10. The Windows folder. Use the [**GetWindowsDirectory**](/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya) function to get the path of this folder.
11. The current folder.
12. The directories that are listed in the `PATH` environment variable. This doesn't include the per-application path specified by the **App Paths** registry key. The **App Paths** key isn't used when computing the DLL search path.

If safe DLL search mode is *disabled*, then the alternate search order is the same except that *the current folder* moves from position 11 to position 8 in the sequence (immediately after step *7. The folder specified by lpFileName*).

The [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) function supports an alternate search order if the *lpPathName* parameter specifies a path. The alternate search order is as follows:

Steps 1-6 are the same as the standard search order.

7. The folder from which the application loaded.
8. The folder specified by the *lpPathName* parameter of [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya).
9. The system folder.
10. The 16-bit system folder.
11. The Windows folder.
12. The directories listed in the `PATH` environment variable.

If the *lpPathName* parameter is an empty string, then the call removes the current folder from the search order.

[**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) effectively disables safe DLL search mode while the specified folder is in the search path. To restore safe DLL search mode based on the **SafeDllSearchMode** registry value, and restore the current folder to the search order, call **SetDllDirectory** with *lpPathName* as NULL.

### Search order using LOAD\_LIBRARY\_SEARCH flags

You can specify a search order by using one or more **LOAD\_LIBRARY\_SEARCH** flags with the [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function. You can also use **LOAD\_LIBRARY\_SEARCH** flags with the [**SetDefaultDllDirectories**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-setdefaultdlldirectories) function to establish a DLL search order for a process. You can specify additional directories for the process DLL search order by using the [**AddDllDirectory**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-adddlldirectory) or [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) functions.

The directories that are searched depend on the flags specified with [**SetDefaultDllDirectories**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-setdefaultdlldirectories) or [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa). If you use more than one flag, then the corresponding directories are searched in this order:

1. **LOAD\_LIBRARY\_SEARCH\_DLL\_LOAD\_DIR**. The folder that contains the DLL is searched. This folder is searched only for dependencies of the DLL to be loaded.
2. **LOAD\_LIBRARY\_SEARCH\_APPLICATION\_DIR**. The application folder is searched.
3. **LOAD\_LIBRARY\_SEARCH\_USER\_DIRS**. Paths explicitly added with the [**AddDllDirectory**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-adddlldirectory) function or the [**SetDllDirectory**](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya) function are searched. If you add more than one path, then the order in which the paths are searched is unspecified.
4. **LOAD\_LIBRARY\_SEARCH\_SYSTEM32**. The System folder is searched.

If you call [**LoadLibraryEx**](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) with no **LOAD\_LIBRARY\_SEARCH** flags, or you establish a DLL search order for the process, then the system searches for DLLs using either the standard search order or the alternate search order.

## Related topics

* [Application registration](/en-us/windows/win32/shell/app-registration)
* [Dynamic-link library redirection](dynamic-link-library-redirection)
* [Dynamic-link library security](dynamic-link-library-security)
* [Side-by-side components](/en-us/windows/win32/SbsCs/isolated-applications-and-side-by-side-assemblies-portal)
* [AddDllDirectory](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-adddlldirectory)
* [LoadLibrary](/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
* [LoadLibraryEx](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa)
* [LoadPackagedLibrary](/en-us/windows/win32/api/Winbase/nf-winbase-loadpackagedlibrary)
* [SetDefaultDllDirectories](/en-us/windows/win32/api/LibLoaderAPI/nf-libloaderapi-setdefaultdlldirectories)
* [SetDllDirectory](/en-us/windows/win32/api/Winbase/nf-winbase-setdlldirectorya)

---

## Feedback

Was this page helpful?

Yes

No

[Provide product feedback](https://www.microsoft.com/en-us/windowsinsider/feedbackhub/fb)|[Get help at Microsoft Q&A](https://learn.microsoft.com/answers/tags/224/windows-api-win32/)

---

## Additional resources

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025
## Additional resources

### In this article

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2025



=== Content from gist.github.com_28c13a07_20250119_121629.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@blackcon](https://avatars.githubusercontent.com/u/6852711?s=64&v=4)](/blackcon)

# [blackcon](/blackcon)/**[Exploit raonk.svc (LPE)](/blackcon/ae155656d21a2228aa25fdcb79c85159)**

Last active
September 9, 2020 01:13

Show Gist options

* [Download ZIP](/blackcon/ae155656d21a2228aa25fdcb79c85159/archive/2cf5f200559f5527eac75f8556071251fda85b9e.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/blackcon/ae155656d21a2228aa25fdcb79c85159.js&quot;&gt;&lt;/script&gt;
* Save blackcon/ae155656d21a2228aa25fdcb79c85159 to your computer and use it in GitHub Desktop.

[Code](/blackcon/ae155656d21a2228aa25fdcb79c85159)
[Revisions
5](/blackcon/ae155656d21a2228aa25fdcb79c85159/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/blackcon/ae155656d21a2228aa25fdcb79c85159.js&quot;&gt;&lt;/script&gt;

Save blackcon/ae155656d21a2228aa25fdcb79c85159 to your computer and use it in GitHub Desktop.

[Download ZIP](/blackcon/ae155656d21a2228aa25fdcb79c85159/archive/2cf5f200559f5527eac75f8556071251fda85b9e.zip)

 [Raw](/blackcon/ae155656d21a2228aa25fdcb79c85159/raw/2cf5f200559f5527eac75f8556071251fda85b9e/Exploit%2520raonk.svc%2520%28LPE%29)

[**Exploit raonk.svc (LPE)**](#file-exploit-raonk-svc-lpe)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | 1. Vulnerability |
| --- | --- |
|  | - DLL Search Order Hijacking Vulnerability (LPE) |
|  |  |
|  | 2. Product |
|  | - product: raonk.svc.exe (version: 2018.0.0.10) |
|  | - company: RAONWIZ Inc |
|  |  |
|  | 3. Vulnerebility Version |
|  | - before 2018.0.0.10 |
|  |  |
|  | 4. Update Version |
|  | - Not yet |
|  |  |
|  | 5. Describe vulnerability |
|  | - read this apply |
|  | https://gist.github.com/blackcon/ae155656d21a2228aa25fdcb79c85159#gistcomment-3445913 |
|  |  |
|  | 6. Reference URL |
|  | - http://www.raonk.com/page/intro/solution\_intro.aspx |
|  | - https://resources.infosecinstitute.com/dll-hijacking-attacks-revisited/#gref |
|  |  |
|  | 7. Discoverer |
|  | - Jihwan Yoon in NBP(NAVER BUSINESS PLATFORM) |
|  | - Security Engineer |
|  | - Service : https://www.ncloud.com, https://www.naver.com |

[![@blackcon](https://avatars.githubusercontent.com/u/6852711?s=80&v=4)](/blackcon)

Copy link

Author

### **[blackcon](/blackcon)** commented [Sep 8, 2020](/blackcon/ae155656d21a2228aa25fdcb79c85159?permalink_comment_id=3445913#gistcomment-3445913) • edited Loading

# 5. Proof

## **1) Load DLL List**

[![raonk_001](https://user-images.githubusercontent.com/6852711/92488635-c7ecfe80-f229-11ea-88fe-f963495650c6.png)](https://user-images.githubusercontent.com/6852711/92488635-c7ecfe80-f229-11ea-88fe-f963495650c6.png)

## **2) move the new DLL for hijacking and restart the service(raonk.svc)**

[![raonk_002](https://user-images.githubusercontent.com/6852711/92488629-c6233b00-f229-11ea-86c4-50aab87a30a9.png)](https://user-images.githubusercontent.com/6852711/92488629-c6233b00-f229-11ea-86c4-50aab87a30a9.png)

## **3) Success dll hijacking and execute commnad as SYSTEM auth.**

[![raonk_003](https://user-images.githubusercontent.com/6852711/92488632-c7546800-f229-11ea-9020-2c01f1119f3a.png)](https://user-images.githubusercontent.com/6852711/92488632-c7546800-f229-11ea-9020-2c01f1119f3a.png)

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fblackcon%2Fae155656d21a2228aa25fdcb79c85159)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


