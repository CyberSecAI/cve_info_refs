=== Content from github.com_6a51838b_20250119_122320.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-3p3g-vpw6-4w66)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-3p3g-vpw6-4w66)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=ory%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ory](/ory)
/
**[hydra](/ory/hydra)**
Public

* [Notifications](/login?return_to=%2Fory%2Fhydra) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fory%2Fhydra)
* [Star
   15.8k](/login?return_to=%2Fory%2Fhydra)

* [Code](/ory/hydra)
* [Issues
  85](/ory/hydra/issues)
* [Pull requests
  22](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

Additional navigation options

* [Code](/ory/hydra)
* [Issues](/ory/hydra/issues)
* [Pull requests](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

# Disallow replay of `private\_key\_jwt` by blacklisting JTIs

Moderate

[aeneasr](/aeneasr)
published
GHSA-3p3g-vpw6-4w66
Apr 2, 2020

## Package

No package listed

## Affected versions

v1.3.2+oryOS.17

## Patched versions

v1.4.0+oryOS.17

## Description

### Impact

When using client authentication method "private\_key\_jwt" [1], OpenId specification says the following about assertion `jti`:

> A unique identifier for the token, which can be used to prevent reuse of the token. These tokens MUST only be used once, unless conditions for reuse were negotiated between the parties

Hydra does not seem to check the uniqueness of this `jti` value. Here is me sending the same token request twice, hence with the same `jti` assertion, and getting two access tokens:

```
$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"zeG0NoqOtlACl8q5J6A-TIsNegQRRUzqLZaYrQtoBZQ.VR6iUcJQYp3u_j7pwvL7YtPqGhtyQe5OhnBE2KCp5pM","expires_in":3599,"scope":"application openid","token_type":"bearer"}⏎            ~$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"wOYtgCLxLXlELORrwZlmeiqqMQ4kRzV-STU2_Sollas.mwlQGCZWXN7G2IoegUe1P0Vw5iGoKrkOzOaplhMSjm4","expires_in":3599,"scope":"application openid","token_type":"bearer"}

```
### Severity

We rate the severity as medium because the following reasons make it hard to replay tokens without the patch:�

* TLS protects against MITM which makes it difficult to intercept valid tokens for replay attacks
* The expiry time of the JWT gives only a short window of opportunity where it could be replayed

### Patches

This will be patched with v1.4.0+oryOS.17

### Workarounds

Two workarounds have been identified:

* Do not allow clients to use `private_key_jwt`
* Use short expiry times for the JWTs

### References

<https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication>

### Upstream

This issue will be resolved in the upstream repository <https://github.com/ory/fosite>

### Severity

Moderate

### CVE ID

CVE-2020-5300

### Weaknesses

No CWEs

### Credits

* [![@cedricvanrompay](https://avatars.githubusercontent.com/u/2635438?s=40&v=4)](/cedricvanrompay)
  [cedricvanrompay](/cedricvanrompay)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7056fcc4_20250119_122319.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Fcommit%2F700d17d3b7d507de1b1d459a7261d6fb2571ebe3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Fcommit%2F700d17d3b7d507de1b1d459a7261d6fb2571ebe3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ory%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ory](/ory)
/
**[hydra](/ory/hydra)**
Public

* [Notifications](/login?return_to=%2Fory%2Fhydra) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fory%2Fhydra)
* [Star
   15.8k](/login?return_to=%2Fory%2Fhydra)

* [Code](/ory/hydra)
* [Issues
  85](/ory/hydra/issues)
* [Pull requests
  22](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

Additional navigation options

* [Code](/ory/hydra)
* [Issues](/ory/hydra/issues)
* [Pull requests](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

## Commit

[Permalink](/ory/hydra/commit/700d17d3b7d507de1b1d459a7261d6fb2571ebe3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-3p3g-vpw6-4w66](https://github.com/advisories/GHSA-3p3g-vpw6-4w66 "GHSA-3p3g-vpw6-4w66")

[Browse files](/ory/hydra/tree/700d17d3b7d507de1b1d459a7261d6fb2571ebe3)
Browse the repository at this point in the history

```
BREAKING CHANGE: This patch requires a new SQL Table which needs to be created using `hydra migrate sql`. No other breaking changes have been introduced by this patch.

This patch introduces a blacklist for JTIs which prevents a potential replay of `private_key_jwt` JWTs when performing client authorization.

## [GHSA-3p3g-vpw6-4w66](https://github.com/advisories/GHSA-3p3g-vpw6-4w66 "GHSA-3p3g-vpw6-4w66")

### Impact

When using client authentication method "private_key_jwt" [1], OpenId specification says the following about assertion `jti`:

> A unique identifier for the token, which can be used to prevent reuse of the token. These tokens MUST only be used once, unless conditions for reuse were negotiated between the parties

Hydra does not seem to check the uniqueness of this `jti` value. Here is me sending the same token request twice, hence with the same `jti` assertion, and getting two access tokens:

```
$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"zeG0NoqOtlACl8q5J6A-TIsNegQRRUzqLZaYrQtoBZQ.VR6iUcJQYp3u_j7pwvL7YtPqGhtyQe5OhnBE2KCp5pM","expires_in":3599,"scope":"application openid","token_type":"bearer"}⏎            ~$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"wOYtgCLxLXlELORrwZlmeiqqMQ4kRzV-STU2_Sollas.mwlQGCZWXN7G2IoegUe1P0Vw5iGoKrkOzOaplhMSjm4","expires_in":3599,"scope":"application openid","token_type":"bearer"}
```

### Severity

We rate the severity as medium because the following reasons make it hard to replay tokens without the patch:�

- TLS protects against MITM which makes it difficult to intercept valid tokens for replay attacks
- The expiry time of the JWT gives only a short window of opportunity where it could be replayed

### Patches

This will be patched with v1.4.0+oryOS.17

### Workarounds

Two workarounds have been identified:

- Do not allow clients to use `private_key_jwt`
- Use short expiry times for the JWTs

### References

<https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication>

### Upstream

This issue will be resolved in the upstream repository <https://github.com/ory/fosite>
```

* Loading branch information

[![@zepatrik](https://avatars.githubusercontent.com/u/5354445?s=40&v=4)](/zepatrik)

[zepatrik](/ory/hydra/commits?author=zepatrik "View all commits by zepatrik")
authored
Apr 2, 2020

1 parent
[179dd5a](/ory/hydra/commit/179dd5af03c6f8d9227aa55f7cf6d496a6928933)

commit 700d17d

 Show file tree

 Hide file tree

Showing
**17 changed files**
with
**464 additions**
and
**47 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* client

  + client/manager.go
    [manager.go](#diff-eb69dc0c20caa9bc16886516740acd065704ec5154b51b12e39481c78ec03d24)
* driver/configuration

  + driver/configuration/provider\_viper\_test.go
    [provider\_viper\_test.go](#diff-10dd7565ad69756d8c1ec50a150b233de755a9b9d4bc1d3ad202caa4f85f0483)
* go.mod
  [go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6)
* go.sum
  [go.sum](#diff-3295df7234525439d778f1b282d146a4f1ff6b415248aaac074e8042d9f42d63)
* oauth2

  + oauth2/fosite\_store\_helpers.go
    [fosite\_store\_helpers.go](#diff-e9d2c16a05ba33099b776b8163a8d8bffd4db78690e320624347c5639e9b3f82)
  + oauth2/fosite\_store\_memory.go
    [fosite\_store\_memory.go](#diff-25c0d316c9c9e0cd9c528628e9797da81c8307dbc125d6ba9a912db9a463a307)
  + oauth2/fosite\_store\_sql.go
    [fosite\_store\_sql.go](#diff-4ccc63c2624b5877c51970dfc50acbd870b9c9c09f8e45fabc9b93ce9873de0e)
  + oauth2/handler.go
    [handler.go](#diff-dc5158991c1ce571f0a59c32b86d6fc64c55fbe11d67cdee44b1b0ae436569df)
  + migrations/sql

    - cockroach

      * oauth2/migrations/sql/cockroach/10.sql
        [10.sql](#diff-a749da2dceea5841455d2ce3935bfa9dcd606590f8dd37cb0479e9c1e68df4c7)
      * oauth2/migrations/sql/cockroach/11.sql
        [11.sql](#diff-179ad9b3a88f383d2d51cf6a3bc48d266c43766b0ea5e4563158fe81c54d9e1d)
    - shared

      * oauth2/migrations/sql/shared/11.sql
        [11.sql](#diff-b0c5e188712db4af024d53b867bc6e042b63392b3fa2bdd2ee76f2231da56c80)
    - tests

      * oauth2/migrations/sql/tests/11\_test.sql
        [11\_test.sql](#diff-e1d5272727fe15868abde84bbb2e1479139426fdeefa3e53ad3ea18af155cf32)
  + oauth2/oauth2\_auth\_code\_test.go
    [oauth2\_auth\_code\_test.go](#diff-6d883efffdabd9715dc9872121018df30a5843c81e25dc6c4af2c3edc13fb21c)
  + oauth2/oauth2\_refresh\_token\_test.go
    [oauth2\_refresh\_token\_test.go](#diff-c0a17fe0b4cea84046c7a3578a1c25f884b76b8a09f404bfb977a0b1d93c4e07)
  + oauth2/sql\_migration\_files.go
    [sql\_migration\_files.go](#diff-f4e3c597dddd9d399d998ed4718a2850e49e7dadb0cee4cad0dbbca99918d957)
  + oauth2/x\_fosite\_migrations\_test.go
    [x\_fosite\_migrations\_test.go](#diff-fed74d0c60db2aee3aa4cfe945e7818e448af9b6535f1db8b36ea322fb806545)
* x

  + x/clean\_sql.go
    [clean\_sql.go](#diff-d68415fcac53f5ac4e4e98dd1f2e8ef3a931352b96b87025e68a593708802e23)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[client/manager.go](#diff-eb69dc0c20caa9bc16886516740acd065704ec5154b51b12e39481c78ec03d24 "client/manager.go")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/client/manager.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -35,7 +35,7 @@ type Manager interface { |
|  |  | } |
|  |  |  |
|  |  | type Storage interface { |
|  |  | fosite.Storage |
|  |  | GetClient(ctx context.Context, id string) (fosite.Client, error) |
|  |  |  |
|  |  | CreateClient(ctx context.Context, c \*Client) error |
|  |  |  |
| Expand Down | |  |

7 changes: 4 additions & 3 deletions

7
[driver/configuration/provider\_viper\_test.go](#diff-10dd7565ad69756d8c1ec50a150b233de755a9b9d4bc1d3ad202caa4f85f0483 "driver/configuration/provider_viper_test.go")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/driver/configuration/provider_viper_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,13 +8,14 @@ import ( |
|  |  | "strings" |
|  |  | "testing" |
|  |  |  |
|  |  | "github.com/ory/hydra/x" |
|  |  | "github.com/ory/viper" |
|  |  | "github.com/ory/x/logrusx" |
|  |  | "github.com/rs/cors" |
|  |  | "github.com/sirupsen/logrus" |
|  |  | "github.com/stretchr/testify/assert" |
|  |  | "github.com/stretchr/testify/require" |
|  |  |  |
|  |  | "github.com/ory/hydra/x" |
|  |  | "github.com/ory/viper" |
|  |  | "github.com/ory/x/logrusx" |
|  |  | ) |
|  |  |  |
|  |  | func setupEnv(env map[string]string) func(t \*testing.T) (func(), func()) { |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6 "go.mod")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/go.mod)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,7 +14,7 @@ require ( |
|  |  | github.com/go-swagger/go-swagger v0.22.1-0.20200306221957-4aad3a5f78b8 |
|  |  | github.com/gobuffalo/packr v1.24.0 |
|  |  | github.com/gobwas/glob v0.2.3 |
|  |  | github.com/golang/mock v1.3.1 |
|  |  | github.com/golang/mock v1.4.3 |
|  |  | github.com/google/uuid v1.1.1 |
|  |  | github.com/gorilla/sessions v1.1.4-0.20181208214519-12bd4761fc66 |
|  |  | github.com/gtank/cryptopasta v0.0.0-20170601214702-1f550f6f2f69 |
| Expand All | | @@ -26,7 +26,7 @@ require ( |
|  |  | github.com/oleiade/reflections v1.0.0 |
|  |  | github.com/olekukonko/tablewriter v0.0.1 |
|  |  | github.com/opentracing/opentracing-go v1.1.1-0.20190913142402-a7454ce5950e |
|  |  | github.com/ory/fosite v0.30.6 |
|  |  | github.com/ory/fosite v0.31.0 |
|  |  | github.com/ory/go-acc v0.2.1 |
|  |  | github.com/ory/graceful v0.1.1 |
|  |  | github.com/ory/herodot v0.7.0 |
| Expand All | | @@ -53,7 +53,7 @@ require ( |
|  |  | github.com/uber/jaeger-client-go v2.22.1+incompatible |
|  |  | github.com/urfave/negroni v1.0.0 |
|  |  | go.opentelemetry.io/otel v0.2.1 |
|  |  | golang.org/x/crypto v0.0.0-20200320181102-891825fb96df |
|  |  | golang.org/x/crypto v0.0.0-20200323165209-0ec3e9974c59 |
|  |  | golang.org/x/lint v0.0.0-20200302205851-738671d3881b // indirect |
|  |  | golang.org/x/oauth2 v0.0.0-20200107190931-bf48bf16ab8d |
|  |  | golang.org/x/tools v0.0.0-20200313205530-4303120df7d8 |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[go.sum](#diff-3295df7234525439d778f1b282d146a4f1ff6b415248aaac074e8042d9f42d63 "go.sum")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/go.sum)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -452,6 +452,8 @@ github.com/golang/mock v1.1.1/go.mod h1:oTYuIxOrZwtPieC+H1uAHpcLFnEyAGVDL/k47Jfb |
|  |  | github.com/golang/mock v1.2.0/go.mod h1:oTYuIxOrZwtPieC+H1uAHpcLFnEyAGVDL/k47Jfbm0A= |
|  |  | github.com/golang/mock v1.3.1 h1:qGJ6qTW+x6xX/my+8YUVl4WNpX9B7+/l2tRsHGZ7f2s= |
|  |  | github.com/golang/mock v1.3.1/go.mod h1:sBzyDLLjw3U8JLTeZvSv8jJB+tU5PVekmnlKIyFUx0Y= |
|  |  | github.com/golang/mock v1.4.3 h1:GV+pQPG/EUUbkh47niozDcADz6go/dUwhVzdUQHIVRw= |
|  |  | github.com/golang/mock v1.4.3/go.mod h1:UOMv5ysSaYNkG+OFQykRIcU/QvvxJf3p21QfJ2Bt3cw= |
|  |  | github.com/golang/protobuf v1.1.0/go.mod h1:6lQm79b+lXiMfvg/cZm0SGofjICqVBUtrP5yJMmIC1U= |
|  |  | github.com/golang/protobuf v1.2.0/go.mod h1:6lQm79b+lXiMfvg/cZm0SGofjICqVBUtrP5yJMmIC1U= |
|  |  | github.com/golang/protobuf v1.3.1/go.mod h1:6lQm79b+lXiMfvg/cZm0SGofjICqVBUtrP5yJMmIC1U= |
| Expand Down  Expand Up | | @@ -737,6 +739,8 @@ github.com/ory/dockertest/v3 v3.5.4/go.mod h1:J8ZUbNB2FOhm1cFZW9xBpDsODqsSWcyYgt |
|  |  | github.com/ory/fosite v0.29.0/go.mod h1:0atSZmXO7CAcs6NPMI/Qtot8tmZYj04Nddoold4S2h0= |
|  |  | github.com/ory/fosite v0.30.6 h1:t1EQHkGv3gVODC9oBvoEi3nIyZ4kvC/ayCsvyswDvis= |
|  |  | github.com/ory/fosite v0.30.6/go.mod h1:Lq9qQ9Sl6mcea2Tt8J7PU+wUeFYPZ+vg7N3zPVKGbN8= |
|  |  | github.com/ory/fosite v0.31.0 h1:NZ0FA4ywPEYrCGLNVBAz2dq8vTacLDbbO4Iiy68WCKQ= |
|  |  | github.com/ory/fosite v0.31.0/go.mod h1:lSSqjo8Kr/U1P3kJWxsNGHmq7TnH/7pS1ijvQRT7G+g= |
|  |  | github.com/ory/go-acc v0.0.0-20181118080137-ddc355013f90 h1:Bpk3eqc3rbJT2mE+uS9ETzmi2cEL4RuIKz2iUeteh04= |
|  |  | github.com/ory/go-acc v0.0.0-20181118080137-ddc355013f90/go.mod h1:sxnvPCxChFuSmTJGj8FdMupeq1BezCiEpDjTUXQ4hf4= |
|  |  | github.com/ory/go-acc v0.2.1 h1:Pwcmwd/cSnwJsYN76+w3HU7oXeWFTkwj/KUj1qGDrVw= |
| Expand Down  Expand Up | | @@ -1025,6 +1029,8 @@ golang.org/x/crypto v0.0.0-20200221231518-2aa609cf4a9d h1:1ZiEyfaQIg3Qh0EoqpwAak |
|  |  | golang.org/x/crypto v0.0.0-20200221231518-2aa609cf4a9d/go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto= |
|  |  | golang.org/x/crypto v0.0.0-20200320181102-891825fb96df h1:lDWgvUvNnaTnNBc/dwOty86cFeKoKWbwy2wQj0gIxbU= |
|  |  | golang.org/x/crypto v0.0.0-20200320181102-891825fb96df/go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto= |
|  |  | golang.org/x/crypto v0.0.0-20200323165209-0ec3e9974c59 h1:3zb4D3T4G8jdExgVU/95+vQXfpEPiMdCaZgmGVxjNHM= |
|  |  | golang.org/x/crypto v0.0.0-20200323165209-0ec3e9974c59/go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto= |
|  |  | golang.org/x/exp v0.0.0-20180321215751-8460e604b9de/go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA= |
|  |  | golang.org/x/exp v0.0.0-20180807140117-3d87b88a115f/go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA= |
|  |  | golang.org/x/exp v0.0.0-20190121172915-509febef88a4/go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA= |
| Expand Down  Expand Up | | @@ -1153,6 +1159,7 @@ golang.org/x/sys v0.0.0-20200223170610-d5e6a3e2c0ae h1:/WDfKMnPU+m5M4xB+6x4kaepx |
|  |  | golang.org/x/sys v0.0.0-20200223170610-d5e6a3e2c0ae/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs= |
|  |  | golang.org/x/sys v0.0.0-20200302150141-5c8b2ff67527 h1:uYVVQ9WP/Ds2ROhcaGPeIdVq0RIXVLwsHlnvJ+cT1So= |
|  |  | golang.org/x/sys v0.0.0-20200302150141-5c8b2ff67527/go.mod h1:h1NjWce9XRLGQEsW7wpKNCjG9DtNlClVuFLEZdDNbEs= |
|  |  | golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ= |
|  |  | golang.org/x/text v0.3.0/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ= |
|  |  | golang.org/x/text v0.3.1-0.20180807135948-17ff2d5776d2/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ= |
|  |  | golang.org/x/text v0.3.2 h1:tW2bmiBqwgJj/UpqtC8EpXEZVYOwU0yG4iWbprSVAcs= |
| Expand Down  Expand Up | | @@ -1324,5 +1331,7 @@ mvdan.cc/unparam v0.0.0-20190720180237-d51796306d8f/go.mod h1:4G1h5nDURzA3bwVMZI |
|  |  | mvdan.cc/unparam v0.0.0-20190917161559-b83a221c10a2/go.mod h1:rCqoQrfAmpTX/h2APczwM7UymU/uvaOluiVPIYCSY/k= |
|  |  | rsc.io/binaryregexp v0.2.0/go.mod h1:qTv7/COck+e2FymRvadv62gMdZztPaShugOCi3I+8D8= |
|  |  | rsc.io/pdf v0.1.1/go.mod h1:n8OzWcQ6Sp37PL01nO98y4iUCRdTGarVfzxY20ICaU4= |
|  |  | rsc.io/quote/v3 v3.1.0/go.mod h1:yEA65RcK8LyAZtP9Kv3t0HmxON59tX3rD+tICJqUlj0= |
|  |  | rsc.io/sampler v1.3.0/go.mod h1:T1hPZKmBbMNahiBKFy5HrXp6adAjACjK9JXDnKaTXpA= |
|  |  | sourcegraph.com/sqs/pbtypes v0.0.0-20180604144634-d3ebe8f20ae4/go.mod h1:ketZ/q3QxT9HOBeFhu6RdvsftgpsbFHBF5Cas6cDKZ0= |
|  |  | sourcegraph.com/sqs/pbtypes v1.0.0/go.mod h1:3AciMUv4qUuRHRHhOG4TZOB+72GdPVz5k+c648qsFS4= |

116 changes: 116 additions & 0 deletions

116
[oauth2/fosite\_store\_helpers.go](#diff-e9d2c16a05ba33099b776b8163a8d8bffd4db78690e320624347c5639e9b3f82 "oauth2/fosite_store_helpers.go")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/oauth2/fosite_store_helpers.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,11 +22,14 @@ package oauth2 |
|  |  |  |
|  |  | import ( |
|  |  | "context" |
|  |  | "crypto/sha256" |
|  |  | "fmt" |
|  |  | "net/url" |
|  |  | "testing" |
|  |  | "time" |
|  |  |  |
|  |  | "github.com/ory/hydra/x" |
|  |  |  |
|  |  | "github.com/ory/fosite/storage" |
|  |  | "github.com/ory/x/sqlxx" |
|  |  |  |
| Expand All | | @@ -44,6 +47,33 @@ import ( |
|  |  | "github.com/ory/hydra/consent" |
|  |  | ) |
|  |  |  |
|  |  | func signatureFromJTI(jti string) string { |
|  |  | return fmt.Sprintf("%x", sha256.Sum256([]byte(jti))) |
|  |  | } |
|  |  |  |
|  |  | type blacklistedJTI struct { |
|  |  | JTI string |
|  |  | Signature string `db:"signature"` |
|  |  | Expiry time.Time `db:"expires\_at"` |
|  |  | } |
|  |  |  |
|  |  | func newBlacklistedJTI(jti string, exp time.Time) \*blacklistedJTI { |
|  |  | return &blacklistedJTI{ |
|  |  | JTI: jti, |
|  |  | Signature: signatureFromJTI(jti), |
|  |  | // because the database timestamp types are not as accurate as time.Time we truncate to seconds (which should always work) |
|  |  | Expiry: exp.UTC().Truncate(time.Second), |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | type assertionJWTReader interface { |
|  |  | x.FositeStorer |
|  |  |  |
|  |  | getClientAssertionJWT(ctx context.Context, jti string) (\*blacklistedJTI, error) |
|  |  |  |
|  |  | setClientAssertionJWT(context.Context, \*blacklistedJTI) error |
|  |  | } |
|  |  |  |
|  |  | var defaultRequest = fosite.Request{ |
|  |  | ID: "blank", |
|  |  | RequestedAt: time.Now().UTC().Round(time.Second), |
| Expand Down  Expand Up | | @@ -135,6 +165,8 @@ func TestHelperRunner(t \*testing.T, store InternalRegistry, k string) { |
|  |  | t.Run(fmt.Sprintf("case=testHelperRevokeRefreshToken/db=%s", k), testHelperRevokeRefreshToken(store)) |
|  |  | t.Run(fmt.Sprintf("case=testHelperCreateGetDeletePKCERequestSession/db=%s", k), testHelperCreateGetDeletePKCERequestSession(store)) |
|  |  | t.Run(fmt.Sprintf("case=testHelperFlushTokens/db=%s", k), testHelperFlushTokens(store, time.Hour)) |
|  |  | t.Run(fmt.Sprintf("case=testFositeStoreSetClientAssertionJWT/db=%s", k), testFositeStoreSetClientAssertionJWT(store)) |
|  |  | t.Run(fmt.Sprintf("case=testFositeStoreClientAssertionJWTValid/db=%s", k), testFositeStoreClientAssertionJWTValid(store)) |
|  |  | } |
|  |  |  |
|  |  | func testHelperUniqueConstraints(m InternalRegistry, storageType string) func(t \*testing.T) { |
| Expand Down  Expand Up | | @@ -531,6 +563,90 @@ func testFositeSqlStoreTransactionRollbackOpenIdConnectSession(m InternalRegistr |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func testFositeStoreSetClientAssertionJWT(m InternalRegistry) func(\*testing.T) { |
|  |  | return func(t \*testing.T) { |
|  |  | t.Run("case=basic setting works", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | jti := newBlacklistedJTI("basic jti", time.Now().Add(time.Minute)) |
|  |  |  |
|  |  | require.NoError(t, store.SetClientAssertionJWT(context.Background(), jti.JTI, jti.Expiry)) |
|  |  |  |
|  |  | cmp, err := store.getClientAssertionJWT(context.Background(), jti.JTI) |
|  |  | require.NoError(t, err) |
|  |  | assert.Equal(t, jti, cmp) |
|  |  | }) |
|  |  |  |
|  |  | t.Run("case=errors when the JTI is blacklisted", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | jti := newBlacklistedJTI("already set jti", time.Now().Add(time.Minute)) |
|  |  | require.NoError(t, store.setClientAssertionJWT(context.Background(), jti)) |
|  |  |  |
|  |  | assert.True(t, errors.Is(store.SetClientAssertionJWT(context.Background(), jti.JTI, jti.Expiry), fosite.ErrJTIKnown)) |
|  |  | }) |
|  |  |  |
|  |  | t.Run("case=deletes expired JTIs", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | expiredJTI := newBlacklistedJTI("expired jti", time.Now().Add(-time.Minute)) |
|  |  | require.NoError(t, store.setClientAssertionJWT(context.Background(), expiredJTI)) |
|  |  | newJTI := newBlacklistedJTI("some new jti", time.Now().Add(time.Minute)) |
|  |  |  |
|  |  | require.NoError(t, store.SetClientAssertionJWT(context.Background(), newJTI.JTI, newJTI.Expiry)) |
|  |  |  |
|  |  | \_, err := store.getClientAssertionJWT(context.Background(), expiredJTI.JTI) |
|  |  | assert.True(t, errors.Is(err, sqlcon.ErrNoRows)) |
|  |  | cmp, err := store.getClientAssertionJWT(context.Background(), newJTI.JTI) |
|  |  | assert.Equal(t, newJTI, cmp) |
|  |  | }) |
|  |  |  |
|  |  | t.Run("case=inserts same JTI if expired", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | jti := newBlacklistedJTI("going to be reused jti", time.Now().Add(-time.Minute)) |
|  |  | require.NoError(t, store.setClientAssertionJWT(context.Background(), jti)) |
|  |  |  |
|  |  | jti.Expiry = jti.Expiry.Add(2 \* time.Minute) |
|  |  | assert.NoError(t, store.SetClientAssertionJWT(context.Background(), jti.JTI, jti.Expiry)) |
|  |  | cmp, err := store.getClientAssertionJWT(context.Background(), jti.JTI) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Equal(t, jti, cmp) |
|  |  | }) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func testFositeStoreClientAssertionJWTValid(m InternalRegistry) func(\*testing.T) { |
|  |  | return func(t \*testing.T) { |
|  |  | t.Run("case=returns valid on unknown JTI", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  |  |
|  |  | assert.NoError(t, store.ClientAssertionJWTValid(context.Background(), "unknown jti")) |
|  |  | }) |
|  |  |  |
|  |  | t.Run("case=returns invalid on known JTI", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | jti := newBlacklistedJTI("known jti", time.Now().Add(time.Minute)) |
|  |  |  |
|  |  | require.NoError(t, store.setClientAssertionJWT(context.Background(), jti)) |
|  |  |  |
|  |  | assert.True(t, errors.Is(store.ClientAssertionJWTValid(context.Background(), jti.JTI), fosite.ErrJTIKnown)) |
|  |  | }) |
|  |  |  |
|  |  | t.Run("case=returns valid on expired JTI", func(t \*testing.T) { |
|  |  | store, ok := m.OAuth2Storage().(assertionJWTReader) |
|  |  | require.True(t, ok) |
|  |  | jti := newBlacklistedJTI("expired jti", time.Now().Add(-time.Minute)) |
|  |  |  |
|  |  | require.NoError(t, store.setClientAssertionJWT(context.Background(), jti)) |
|  |  |  |
|  |  | assert.NoError(t, store.ClientAssertionJWTValid(context.Background(), jti.JTI)) |
|  |  | }) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func doTestCommit(m InternalRegistry, t \*testing.T, |
|  |  | createFn func(context.Context, string, fosite.Requester) error, |
|  |  | getFn func(context.Context, string, fosite.Session) (fosite.Requester, error), |
| Expand Down | |  |

69 changes: 59 additions & 10 deletions

69
[oauth2/fosite\_store\_memory.go](#diff-25c0d316c9c9e0cd9c528628e9797da81c8307dbc125d6ba9a912db9a463a307 "oauth2/fosite_store_memory.go")

Show comments

[View file](/ory/hydra/blob/700d17d3b7d507de1b1d459a7261d6fb2571ebe3/oauth2/fosite_store_memory.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -34,11 +34,12 @@ import ( |
|  |  | ) |
|  |  |  |
|  |  | type FositeMemoryStore struct { |
|  |  | AuthorizeCodes map[string]authorizeCode |
|  |  | IDSessions map[string]fosite.Requester |
|  |  | AccessTokens map[string]fosite.Requester |
|  |  | RefreshTokens map[string]fosite.Requester |
|  |  | PKCES map[string]fosite.Requester |
|  |  | AuthorizeCodes map[string]authorizeCode |
|  |  | IDSessions map[string]fosite.Requester |
|  |  | AccessTokens map[string]fosite.Requester |
|  |  | RefreshTokens map[string]fosite.Requester |
|  |  | PKCES map[string]fosite.Requester |
|  |  | BlacklistedJTIs map[string]time.Time |
|  |  |  |
|  |  | c Configuration |
|  |  | r InternalRegistry |
| Expand All | | @@ -53,11 +54,12 @@ func NewFositeMemoryStore( |
|  |  | c Configuration, |
|  |  | ) \*FositeMemoryStore { |
|  |  | return &FositeMemoryStore{ |
|  |  | AuthorizeCodes: make(map[string]authorizeCode), |
|  |  | IDSessions: make(map[string]fosite.Requester), |
|  |  | AccessTokens: make(map[string]fosite.Requester), |
|  |  | PKCES: make(map[string]fosite.Requester), |
|  |  | RefreshTokens: make(map[string]fosite.Requester), |
|  |  | AuthorizeCodes: make(map[string]authorizeCode), |
|  |  | IDSessions: make(map[string]fosite.Requester), |
|  |  | AccessTokens: make(map[string]fosite.Requester), |
|  |  | PKCES: make(map[string]fosite.Requester), |
|  |  | RefreshTokens: make(map[string]fosite.Requester), |
|  |  | BlacklistedJTIs: make(map[string]time.Time), |
|  |  |  |
|  |  | c: c, |
|  |  | r: r, |
| Expand All | | @@ -73,6 +75,53 @@ func (s \*FositeMemoryStore) GetClient(ctx context.Context, id string) (fosite.Cl |
|  |  | return s.r.ClientManager().GetClient(ctx, id) |
|  |  | } |
|  |  |  |
|  |  | func (s \*FositeMemoryStore) ClientAssertionJWTValid(\_ context.Context, jti string) error { |
|  |  | s.RLock() |
|  |  | defer s.RUnlock() |
|  |  | if exp, exists := s.BlacklistedJTIs[jti]; exists && exp.After(time.Now()) { |
|  |  | return errors.WithStack(fosite.ErrJTIKnown) |
|  |  | } |
|  |  |  |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func (s \*FositeMemoryStore) SetClientAssertionJWT(\_ context.Context, jti string, exp time.Time) error { |
|  |  | s.Lock() |
|  |  | defer s.Unlock() |
|  |  |  |
|  |  | for j, e := range s.BlacklistedJTIs { |
|  |  | if e.Before(time.Now()) { |
|  |  | delete(s.BlacklistedJTIs, j) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if \_, exists := s.BlacklistedJTIs[jti]; exists { |
|  |  | return errors.WithStack(fosite.ErrJTIKnown) |
|  |  | } |
|  |  |  |
|  |  | s.BlacklistedJTIs[jti] = exp |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func (s \*FositeMemoryStore) getClientAssertionJWT(\_ context.Context, jti string) (\*blacklistedJTI, error) { |
|  |  | s.RLock() |
|  |  | defer s.RUnlock() |
|  |  |  |
|  |  | if exp, exists := s.BlacklistedJTIs[jti]; exists { |
|  |  | return newBlacklistedJTI(jti, exp), nil |
|  |  | } |
|  |  |  |
|  |  | return nil, errors.WithStack(sqlcon.ErrNoRows) |
|  |  | } |
|  |  |  |
|  |  | func (s \*FositeMemoryStore) setClientAssertionJWT(\_ context.Context, jti \*blacklistedJTI) error { |
|  |  | s.Lock() |
|  |  | defer s.Unlock() |
|  |  |  |
|  |  | s.BlacklistedJTIs[jti.JTI] = jti.Expiry |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func (s \*FositeMemoryStore) Authenticate(ctx context.Context, id string, secret []byte) (\*client.Client, error) { |
|  |  | return s.r.ClientManager().Authenticate(ctx, id, secret) |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `700d17d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Fcommit%2F700d17d3b7d507de1b1d459a7261d6fb2571ebe3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from avatars.githubusercontent.com_e69b61a4_20250119_140144.html ===
���� JFIF  ` `  �� ;CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 90
�� C 



�� C  

��  ( (" ��           
�� �   } !1AQa"q2���#B��R��$3br�
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz���������������������������������������������������������������������������        
�� �  w !1AQaq"2�B���� #3R�br�
$4�%�&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz��������������������������������������������������������������������������   ? ��)��E�m����\�.nn�8�>α�S�318�Ҽ=4lE�E��4UR큀1�+ۿm�{�?~#|=�4�H]�����<�RI
;�m8�8=��� �ZN�����B���Q��/on�pvY�\������І+ji+y�>� $�L M�w�{t���{ׇl��AIU��^Et�~�����:f�+�u�x�E���[[^�Y�2,�0%���I�0rr@���t���5�xgD�A:�����2�I��GP������\*��Ќ����;~'�G1�L<�J�V��+��i�w��k�|��N�+���:�S�̡��Ɗ��?����
:�V��{�`�[�u9�ŝճ�]w�M�Fq�G�E}V�L4]8TVG�f5a���:n���� ��ڭ�ǧ�Q��l ��x|�$�q�>ާҪ�W��Q���9H%G���5￷�}\�C����|M��ٮRVQ��ެ:9�k������Z����E��~=+�ΰ�7Quw��s&�c^1��I/�����֍��&��zE�[7�3,[ى
�C�W�X� dk���o�ޠ��]��2ড়g���Z׍��.����\�mgh��c��pk���,m-��
V�k�U�G<5t-��{��׍�I�
Z����H�{H�\*���ϣt�jW�~�
yi&���S�Ί��=+x��^�c1y� �I���#���4W�e�(�u{�
�fu�չ(J���{\_|�ޜ'��}� .>������#���t��mr���s�� �J(���S�U�%����Kߋ�����5{3>�=��۰��m�W��y���Y�g�te"('�#����(��kk��ӯRT���O����x���[�S�m6�-6؇2ct�}�Q\_{��iЌb~]���yJG��

=== Content from github.com_6084d62d_20250119_140147.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Ffosite)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Ffosite)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ory%2Ffosite)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ory](/ory)
/
**[fosite](/ory/fosite)**
Public

* [Notifications](/login?return_to=%2Fory%2Ffosite) You must be signed in to change notification settings
* [Fork
  368](/login?return_to=%2Fory%2Ffosite)
* [Star
   2.3k](/login?return_to=%2Fory%2Ffosite)

Extensible security first OAuth 2.0 and OpenID Connect SDK for Go.

[www.ory.sh/?utm\_source=github&utm\_medium=banner&utm\_campaign=fosite](https://www.ory.sh/?utm_source=github&utm_medium=banner&utm_campaign=fosite "https://www.ory.sh/?utm_source=github&utm_medium=banner&utm_campaign=fosite")

### License

[Apache-2.0 license](/ory/fosite/blob/master/LICENSE)

[2.3k
stars](/ory/fosite/stargazers) [368
forks](/ory/fosite/forks) [Branches](/ory/fosite/branches) [Tags](/ory/fosite/tags) [Activity](/ory/fosite/activity)
 [Star](/login?return_to=%2Fory%2Ffosite)

 [Notifications](/login?return_to=%2Fory%2Ffosite) You must be signed in to change notification settings

* [Code](/ory/fosite)
* [Issues
  25](/ory/fosite/issues)
* [Pull requests
  19](/ory/fosite/pulls)
* [Actions](/ory/fosite/actions)
* [Security](/ory/fosite/security)
* [Insights](/ory/fosite/pulse)

Additional navigation options

* [Code](/ory/fosite)
* [Issues](/ory/fosite/issues)
* [Pull requests](/ory/fosite/pulls)
* [Actions](/ory/fosite/actions)
* [Security](/ory/fosite/security)
* [Insights](/ory/fosite/pulse)

# ory/fosite

    master[Branches](/ory/fosite/branches)[Tags](/ory/fosite/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[813 Commits](/ory/fosite/commits/master/) | | |
| [.github](/ory/fosite/tree/master/.github ".github") | | [.github](/ory/fosite/tree/master/.github ".github") |  |  |
| [.reports](/ory/fosite/tree/master/.reports ".reports") | | [.reports](/ory/fosite/tree/master/.reports ".reports") |  |  |
| [compose](/ory/fosite/tree/master/compose "compose") | | [compose](/ory/fosite/tree/master/compose "compose") |  |  |
| [docs](/ory/fosite/tree/master/docs "docs") | | [docs](/ory/fosite/tree/master/docs "docs") |  |  |
| [handler](/ory/fosite/tree/master/handler "handler") | | [handler](/ory/fosite/tree/master/handler "handler") |  |  |
| [i18n](/ory/fosite/tree/master/i18n "i18n") | | [i18n](/ory/fosite/tree/master/i18n "i18n") |  |  |
| [integration](/ory/fosite/tree/master/integration "integration") | | [integration](/ory/fosite/tree/master/integration "integration") |  |  |
| [internal](/ory/fosite/tree/master/internal "internal") | | [internal](/ory/fosite/tree/master/internal "internal") |  |  |
| [scripts](/ory/fosite/tree/master/scripts "scripts") | | [scripts](/ory/fosite/tree/master/scripts "scripts") |  |  |
| [storage](/ory/fosite/tree/master/storage "storage") | | [storage](/ory/fosite/tree/master/storage "storage") |  |  |
| [token](/ory/fosite/tree/master/token "token") | | [token](/ory/fosite/tree/master/token "token") |  |  |
| [.gitignore](/ory/fosite/blob/master/.gitignore ".gitignore") | | [.gitignore](/ory/fosite/blob/master/.gitignore ".gitignore") |  |  |
| [.golangci.yml](/ory/fosite/blob/master/.golangci.yml ".golangci.yml") | | [.golangci.yml](/ory/fosite/blob/master/.golangci.yml ".golangci.yml") |  |  |
| [.nancy-ignore](/ory/fosite/blob/master/.nancy-ignore ".nancy-ignore") | | [.nancy-ignore](/ory/fosite/blob/master/.nancy-ignore ".nancy-ignore") |  |  |
| [.prettierignore](/ory/fosite/blob/master/.prettierignore ".prettierignore") | | [.prettierignore](/ory/fosite/blob/master/.prettierignore ".prettierignore") |  |  |
| [.reference-ignore](/ory/fosite/blob/master/.reference-ignore ".reference-ignore") | | [.reference-ignore](/ory/fosite/blob/master/.reference-ignore ".reference-ignore") |  |  |
| [.travis.yml](/ory/fosite/blob/master/.travis.yml ".travis.yml") | | [.travis.yml](/ory/fosite/blob/master/.travis.yml ".travis.yml") |  |  |
| [CHANGELOG.md](/ory/fosite/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/ory/fosite/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [CODE\_OF\_CONDUCT.md](/ory/fosite/blob/master/CODE_OF_CONDUCT.md "CODE_OF_CONDUCT.md") | | [CODE\_OF\_CONDUCT.md](/ory/fosite/blob/master/CODE_OF_CONDUCT.md "CODE_OF_CONDUCT.md") |  |  |
| [CONTRIBUTING.md](/ory/fosite/blob/master/CONTRIBUTING.md "CONTRIBUTING.md") | | [CONTRIBUTING.md](/ory/fosite/blob/master/CONTRIBUTING.md "CONTRIBUTING.md") |  |  |
| [HISTORY.md](/ory/fosite/blob/master/HISTORY.md "HISTORY.md") | | [HISTORY.md](/ory/fosite/blob/master/HISTORY.md "HISTORY.md") |  |  |
| [LICENSE](/ory/fosite/blob/master/LICENSE "LICENSE") | | [LICENSE](/ory/fosite/blob/master/LICENSE "LICENSE") |  |  |
| [MAINTAINERS](/ory/fosite/blob/master/MAINTAINERS "MAINTAINERS") | | [MAINTAINERS](/ory/fosite/blob/master/MAINTAINERS "MAINTAINERS") |  |  |
| [Makefile](/ory/fosite/blob/master/Makefile "Makefile") | | [Makefile](/ory/fosite/blob/master/Makefile "Makefile") |  |  |
| [README.md](/ory/fosite/blob/master/README.md "README.md") | | [README.md](/ory/fosite/blob/master/README.md "README.md") |  |  |
| [SECURITY.md](/ory/fosite/blob/master/SECURITY.md "SECURITY.md") | | [SECURITY.md](/ory/fosite/blob/master/SECURITY.md "SECURITY.md") |  |  |
| [access\_error.go](/ory/fosite/blob/master/access_error.go "access_error.go") | | [access\_error.go](/ory/fosite/blob/master/access_error.go "access_error.go") |  |  |
| [access\_error\_test.go](/ory/fosite/blob/master/access_error_test.go "access_error_test.go") | | [access\_error\_test.go](/ory/fosite/blob/master/access_error_test.go "access_error_test.go") |  |  |
| [access\_request.go](/ory/fosite/blob/master/access_request.go "access_request.go") | | [access\_request.go](/ory/fosite/blob/master/access_request.go "access_request.go") |  |  |
| [access\_request\_handler.go](/ory/fosite/blob/master/access_request_handler.go "access_request_handler.go") | | [access\_request\_handler.go](/ory/fosite/blob/master/access_request_handler.go "access_request_handler.go") |  |  |
| [access\_request\_handler\_test.go](/ory/fosite/blob/master/access_request_handler_test.go "access_request_handler_test.go") | | [access\_request\_handler\_test.go](/ory/fosite/blob/master/access_request_handler_test.go "access_request_handler_test.go") |  |  |
| [access\_request\_test.go](/ory/fosite/blob/master/access_request_test.go "access_request_test.go") | | [access\_request\_test.go](/ory/fosite/blob/master/access_request_test.go "access_request_test.go") |  |  |
| [access\_response.go](/ory/fosite/blob/master/access_response.go "access_response.go") | | [access\_response.go](/ory/fosite/blob/master/access_response.go "access_response.go") |  |  |
| [access\_response\_test.go](/ory/fosite/blob/master/access_response_test.go "access_response_test.go") | | [access\_response\_test.go](/ory/fosite/blob/master/access_response_test.go "access_response_test.go") |  |  |
| [access\_response\_writer.go](/ory/fosite/blob/master/access_response_writer.go "access_response_writer.go") | | [access\_response\_writer.go](/ory/fosite/blob/master/access_response_writer.go "access_response_writer.go") |  |  |
| [access\_response\_writer\_test.go](/ory/fosite/blob/master/access_response_writer_test.go "access_response_writer_test.go") | | [access\_response\_writer\_test.go](/ory/fosite/blob/master/access_response_writer_test.go "access_response_writer_test.go") |  |  |
| [access\_write.go](/ory/fosite/blob/master/access_write.go "access_write.go") | | [access\_write.go](/ory/fosite/blob/master/access_write.go "access_write.go") |  |  |
| [access\_write\_test.go](/ory/fosite/blob/master/access_write_test.go "access_write_test.go") | | [access\_write\_test.go](/ory/fosite/blob/master/access_write_test.go "access_write_test.go") |  |  |
| [arguments.go](/ory/fosite/blob/master/arguments.go "arguments.go") | | [arguments.go](/ory/fosite/blob/master/arguments.go "arguments.go") |  |  |
| [arguments\_test.go](/ory/fosite/blob/master/arguments_test.go "arguments_test.go") | | [arguments\_test.go](/ory/fosite/blob/master/arguments_test.go "arguments_test.go") |  |  |
| [audience\_strategy.go](/ory/fosite/blob/master/audience_strategy.go "audience_strategy.go") | | [audience\_strategy.go](/ory/fosite/blob/master/audience_strategy.go "audience_strategy.go") |  |  |
| [audience\_strategy\_test.go](/ory/fosite/blob/master/audience_strategy_test.go "audience_strategy_test.go") | | [audience\_strategy\_test.go](/ory/fosite/blob/master/audience_strategy_test.go "audience_strategy_test.go") |  |  |
| [authorize\_error.go](/ory/fosite/blob/master/authorize_error.go "authorize_error.go") | | [authorize\_error.go](/ory/fosite/blob/master/authorize_error.go "authorize_error.go") |  |  |
| [authorize\_error\_test.go](/ory/fosite/blob/master/authorize_error_test.go "authorize_error_test.go") | | [authorize\_error\_test.go](/ory/fosite/blob/master/authorize_error_test.go "authorize_error_test.go") |  |  |
| [authorize\_helper.go](/ory/fosite/blob/master/authorize_helper.go "authorize_helper.go") | | [authorize\_helper.go](/ory/fosite/blob/master/authorize_helper.go "authorize_helper.go") |  |  |
| [authorize\_helper\_test.go](/ory/fosite/blob/master/authorize_helper_test.go "authorize_helper_test.go") | | [authorize\_helper\_test.go](/ory/fosite/blob/master/authorize_helper_test.go "authorize_helper_test.go") |  |  |
| [authorize\_helper\_whitebox\_test.go](/ory/fosite/blob/master/authorize_helper_whitebox_test.go "authorize_helper_whitebox_test.go") | | [authorize\_helper\_whitebox\_test.go](/ory/fosite/blob/master/authorize_helper_whitebox_test.go "authorize_helper_whitebox_test.go") |  |  |
| [authorize\_request.go](/ory/fosite/blob/master/authorize_request.go "authorize_request.go") | | [authorize\_request.go](/ory/fosite/blob/master/authorize_request.go "authorize_request.go") |  |  |
| [authorize\_request\_handler.go](/ory/fosite/blob/master/authorize_request_handler.go "authorize_request_handler.go") | | [authorize\_request\_handler.go](/ory/fosite/blob/master/authorize_request_handler.go "authorize_request_handler.go") |  |  |
| [authorize\_request\_handler\_oidc\_request\_test.go](/ory/fosite/blob/master/authorize_request_handler_oidc_request_test.go "authorize_request_handler_oidc_request_test.go") | | [authorize\_request\_handler\_oidc\_request\_test.go](/ory/fosite/blob/master/authorize_request_handler_oidc_request_test.go "authorize_request_handler_oidc_request_test.go") |  |  |
| [authorize\_request\_handler\_test.go](/ory/fosite/blob/master/authorize_request_handler_test.go "authorize_request_handler_test.go") | | [authorize\_request\_handler\_test.go](/ory/fosite/blob/master/authorize_request_handler_test.go "authorize_request_handler_test.go") |  |  |
| [authorize\_request\_test.go](/ory/fosite/blob/master/authorize_request_test.go "authorize_request_test.go") | | [authorize\_request\_test.go](/ory/fosite/blob/master/authorize_request_test.go "authorize_request_test.go") |  |  |
| [authorize\_response.go](/ory/fosite/blob/master/authorize_response.go "authorize_response.go") | | [authorize\_response.go](/ory/fosite/blob/master/authorize_response.go "authorize_response.go") |  |  |
| [authorize\_response\_test.go](/ory/fosite/blob/master/authorize_response_test.go "authorize_response_test.go") | | [authorize\_response\_test.go](/ory/fosite/blob/master/authorize_response_test.go "authorize_response_test.go") |  |  |
| [authorize\_response\_writer.go](/ory/fosite/blob/master/authorize_response_writer.go "authorize_response_writer.go") | | [authorize\_response\_writer.go](/ory/fosite/blob/master/authorize_response_writer.go "authorize_response_writer.go") |  |  |
| [authorize\_response\_writer\_test.go](/ory/fosite/blob/master/authorize_response_writer_test.go "authorize_response_writer_test.go") | | [authorize\_response\_writer\_test.go](/ory/fosite/blob/master/authorize_response_writer_test.go "authorize_response_writer_test.go") |  |  |
| [authorize\_validators\_test.go](/ory/fosite/blob/master/authorize_validators_test.go "authorize_validators_test.go") | | [authorize\_validators\_test.go](/ory/fosite/blob/master/authorize_validators_test.go "authorize_validators_test.go") |  |  |
| [authorize\_write.go](/ory/fosite/blob/master/authorize_write.go "authorize_write.go") | | [authorize\_write.go](/ory/fosite/blob/master/authorize_write.go "authorize_write.go") |  |  |
| [authorize\_write\_test.go](/ory/fosite/blob/master/authorize_write_test.go "authorize_write_test.go") | | [authorize\_write\_test.go](/ory/fosite/blob/master/authorize_write_test.go "authorize_write_test.go") |  |  |
| [client.go](/ory/fosite/blob/master/client.go "client.go") | | [client.go](/ory/fosite/blob/master/client.go "client.go") |  |  |
| [client\_authentication.go](/ory/fosite/blob/master/client_authentication.go "client_authentication.go") | | [client\_authentication.go](/ory/fosite/blob/master/client_authentication.go "client_authentication.go") |  |  |
| [client\_authentication\_jwks\_strategy.go](/ory/fosite/blob/master/client_authentication_jwks_strategy.go "client_authentication_jwks_strategy.go") | | [client\_authentication\_jwks\_strategy.go](/ory/fosite/blob/master/client_authentication_jwks_strategy.go "client_authentication_jwks_strategy.go") |  |  |
| [client\_authentication\_jwks\_strategy\_test.go](/ory/fosite/blob/master/client_authentication_jwks_strategy_test.go "client_authentication_jwks_strategy_test.go") | | [client\_authentication\_jwks\_strategy\_test.go](/ory/fosite/blob/master/client_authentication_jwks_strategy_test.go "client_authentication_jwks_strategy_test.go") |  |  |
| [client\_authentication\_test.go](/ory/fosite/blob/master/client_authentication_test.go "client_authentication_test.go") | | [client\_authentication\_test.go](/ory/fosite/blob/master/client_authentication_test.go "client_authentication_test.go") |  |  |
| [client\_manager.go](/ory/fosite/blob/master/client_manager.go "client_manager.go") | | [client\_manager.go](/ory/fosite/blob/master/client_manager.go "client_manager.go") |  |  |
| [client\_test.go](/ory/fosite/blob/master/client_test.go "client_test.go") | | [client\_test.go](/ory/fosite/blob/master/client_test.go "client_test.go") |  |  |
| [client\_with\_custom\_token\_lifespans.go](/ory/fosite/blob/master/client_with_custom_token_lifespans.go "client_with_custom_token_lifespans.go") | | [client\_with\_custom\_token\_lifespans.go](/ory/fosite/blob/master/client_with_custom_token_lifespans.go "client_with_custom_token_lifespans.go") |  |  |
| [client\_with\_custom\_token\_lifespans\_test.go](/ory/fosite/blob/master/client_with_custom_token_lifespans_test.go "client_with_custom_token_lifespans_test.go") | | [client\_with\_custom\_token\_lifespans\_test.go](/ory/fosite/blob/master/client_with_custom_token_lifespans_test.go "client_with_custom_token_lifespans_test.go") |  |  |
| [config.go](/ory/fosite/blob/master/config.go "config.go") | | [config.go](/ory/fosite/blob/master/config.go "config.go") |  |  |
| [config\_default.go](/ory/fosite/blob/master/config_default.go "config_default.go") | | [config\_default.go](/ory/fosite/blob/master/config_default.go "config_default.go") |  |  |
| [context.go](/ory/fosite/blob/master/context.go "context.go") | | [context.go](/ory/fosite/blob/master/context.go "context.go") |  |  |
| [equalKeys\_test.go](/ory/fosite/blob/master/equalKeys_test.go "equalKeys_test.go") | | [equalKeys\_test.go](/ory/fosite/blob/master/equalKeys_test.go "equalKeys_test.go") |  |  |
| [errors.go](/ory/fosite/blob/master/errors.go "errors.go") | | [errors.go](/ory/fosite/blob/master/errors.go "errors.go") |  |  |
| [errors\_test.go](/ory/fosite/blob/master/errors_test.go "errors_test.go") | | [errors\_test.go](/ory/fosite/blob/master/errors_test.go "errors_test.go") |  |  |
| [fosite.go](/ory/fosite/blob/master/fosite.go "fosite.go") | | [fosite.go](/ory/fosite/blob/master/fosite.go "fosite.go") |  |  |
| [fosite.png](/ory/fosite/blob/master/fosite.png "fosite.png") | | [fosite.png](/ory/fosite/blob/master/fosite.png "fosite.png") |  |  |
| [fosite\_test.go](/ory/fosite/blob/master/fosite_test.go "fosite_test.go") | | [fosite\_test.go](/ory/fosite/blob/master/fosite_test.go "fosite_test.go") |  |  |
| [generate-mocks.sh](/ory/fosite/blob/master/generate-mocks.sh "generate-mocks.sh") | | [generate-mocks.sh](/ory/fosite/blob/master/generate-mocks.sh "generate-mocks.sh") |  |  |
| [generate.go](/ory/fosite/blob/master/generate.go "generate.go") | | [generate.go](/ory/fosite/blob/master/generate.go "generate.go") |  |  |
| [go.mod](/ory/fosite/blob/master/go.mod "go.mod") | | [go.mod](/ory/fosite/blob/master/go.mod "go.mod") |  |  |
| [go.sum](/ory/fosite/blob/master/go.sum "go.sum") | | [go.sum](/ory/fosite/blob/master/go.sum "go.sum") |  |  |
| [go\_mod\_indirect\_pins.go](/ory/fosite/blob/master/go_mod_indirect_pins.go "go_mod_indirect_pins.go") | | [go\_mod\_indirect\_pins.go](/ory/fosite/blob/master/go_mod_indirect_pins.go "go_mod_indirect_pins.go") |  |  |
| [handler.go](/ory/fosite/blob/master/handler.go "handler.go") | | [handler.go](/ory/fosite/blob/master/handler.go "handler.go") |  |  |
| [hash.go](/ory/fosite/blob/master/hash.go "hash.go") | | [hash.go](/ory/fosite/blob/master/hash.go "hash.go") |  |  |
| [hash\_bcrypt.go](/ory/fosite/blob/master/hash_bcrypt.go "hash_bcrypt.go") | | [hash\_bcrypt.go](/ory/fosite/blob/master/hash_bcrypt.go "hash_bcrypt.go") |  |  |
| [hash\_bcrypt\_test.go](/ory/fosite/blob/master/hash_bcrypt_test.go "hash_bcrypt_test.go") | | [hash\_bcrypt\_test.go](/ory/fosite/blob/master/hash_bcrypt_test.go "hash_bcrypt_test.go") |  |  |
| [helper.go](/ory/fosite/blob/master/helper.go "helper.go") | | [helper.go](/ory/fosite/blob/master/helper.go "helper.go") |  |  |
| [helper\_test.go](/ory/fosite/blob/master/helper_test.go "helper_test.go") | | [helper\_test.go](/ory/fosite/blob/master/helper_test.go "helper_test.go") |  |  |
| [i18n\_helper.go](/ory/fosite/blob/master/i18n_helper.go "i18n_helper.go") | | [i18n\_helper.go](/ory/fosite/blob/master/i18n_helper.go "i18n_helper.go") |  |  |
| [i18n\_helper\_test.go](/ory/fosite/blob/master/i18n_helper_test.go "i18n_helper_test.go") | | [i18n\_helper\_test.go](/ory/fosite/blob/master/i18n_helper_test.go "i18n_helper_test.go") |  |  |
| [introspect.go](/ory/fosite/blob/master/introspect.go "introspect.go") | | [introspect.go](/ory/fosite/blob/master/introspect.go "introspect.go") |  |  |
| [introspect\_test.go](/ory/fosite/blob/master/introspect_test.go "introspect_test.go") | | [introspect\_test.go](/ory/fosite/blob/master/introspect_test.go "introspect_test.go") |  |  |
| [introspection\_request\_handler.go](/ory/fosite/blob/master/introspection_request_handler.go "introspection_request_handler.go") | | [introspection\_request\_handler.go](/ory/fosite/blob/master/introspection_request_handler.go "introspection_request_handler.go") |  |  |
| [introspection\_request\_handler\_test.go](/ory/fosite/blob/master/introspection_request_handler_test.go "introspection_request_handler_test.go") | | [introspection\_request\_handler\_test.go](/ory/fosite/blob/master/introspection_request_handler_test.go "introspection_request_handler_test.go") |  |  |
| [introspection\_response\_writer.go](/ory/fosite/blob/master/introspection_response_writer.go "introspection_response_writer.go") | | [introspection\_response\_writer.go](/ory/fosite/blob/master/introspection_response_writer.go "introspection_response_writer.go") |  |  |
| [introspection\_response\_writer\_test.go](/ory/fosite/blob/master/introspection_response_writer_test.go "introspection_response_writer_test.go") | | [introspection\_response\_writer\_test.go](/ory/fosite/blob/master/introspection_response_writer_test.go "introspection_response_writer_test.go") |  |  |
| [oauth2.go](/ory/fosite/blob/master/oauth2.go "oauth2.go") | | [oauth2.go](/ory/fosite/blob/master/oauth2.go "oauth2.go") |  |  |
| [package-lock.json](/ory/fosite/blob/master/package-lock.json "package-lock.json") | | [package-lock.json](/ory/fosite/blob/master/package-lock.json "package-lock.json") |  |  |
| [package.json](/ory/fosite/blob/master/package.json "package.json") | | [package.json](/ory/fosite/blob/master/package.json "package.json") |  |  |
| [pushed\_authorize\_request\_handler.go](/ory/fosite/blob/master/pushed_authorize_request_handler.go "pushed_authorize_request_handler.go") | | [pushed\_authorize\_request\_handler.go](/ory/fosite/blob/master/pushed_authorize_request_handler.go "pushed_authorize_request_handler.go") |  |  |
| View all files | | |

## Repository files navigation

* README
* Code of conduct
* Apache-2.0 license
* Security
# [ORY Fosite - Security-first OAuth2 framework](/ory/fosite/blob/master/docs/image/banner_fosite.png)

[![Build Status](https://camo.githubusercontent.com/95c9aa76e456772c23d6cf38ee95d74eefcd58c38c678403457eb3b88db15250/68747470733a2f2f7472617669732d63692e6f72672f6f72792f666f736974652e7376673f6272616e63683d6d6173746572)](https://travis-ci.org/ory/fosite?branch=master)
[![Coverage Status](https://camo.githubusercontent.com/93c01b0eaf0003da41a628a0a69e9e5a69d41038280ee4cb1bf7caa89c39af56/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6f72792f666f736974652f62616467652e7376673f6272616e63683d6d617374657226736572766963653d67697468756226666f6f)](https://coveralls.io/github/ory/fosite?branch=master)
[![Go Report Card](https://camo.githubusercontent.com/6f13866e1bef4eb3410d7c65a1f5dc2432912b9b1a4f5b252303ad7a29ce5d42/68747470733a2f2f676f7265706f7274636172642e636f6d2f62616467652f6f72792f666f73697465)](https://goreportcard.com/report/ory/fosite)

[![Join the chat at https://www.ory.sh/chat](https://camo.githubusercontent.com/3115c993d57d563f42d6c144b9317ac98693ef87025d9b824180c2e44b2513fa/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6a6f696e2d636861742d3030636339392e737667)](https://www.ory.sh/chat)

**The security first OAuth2 & OpenID Connect framework for
[Go](https://golang.org).** Built simple, powerful and extensible. This library
implements peer-reviewed [IETF RFC6749](https://tools.ietf.org/html/rfc6749),
counterfeits weaknesses covered in peer-reviewed
[IETF RFC6819](https://tools.ietf.org/html/rfc6819) and countermeasures various
database attack scenarios, keeping your application safe when that hacker
penetrates or leaks your database. OpenID Connect is implemented according to
[OpenID Connect Core 1.0 incorporating errata set 1](https://openid.net/specs/openid-connect-core-1_0.html)
and includes all flows: code, implicit, hybrid.

This library considered and implemented:

* [The OAuth 2.0 Authorization Framework](https://tools.ietf.org/html/rfc6749)
* [OAuth 2.0 Multiple Response Type Encoding Practices](https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html)
* [OAuth 2.0 Threat Model and Security Considerations](https://tools.ietf.org/html/rfc6819)
* [Proof Key for Code Exchange by OAuth Public Clients](https://tools.ietf.org/html/rfc7636)
* [OAuth 2.0 for Native Apps](https://tools.ietf.org/html/rfc8252)
* [OpenID Connect Core 1.0](https://openid.net/specs/openid-connect-core-1_0.html)
* [OAuth 2.0 Pushed Authorization Request](https://datatracker.ietf.org/doc/html/rfc9126)

OAuth2 and OpenID Connect are difficult protocols. If you want quick wins, we
strongly encourage you to look at [Hydra](https://github.com/ory-am/hydra).
Hydra is a secure, high performance, cloud native OAuth2 and OpenID Connect
service that integrates with every authentication method imaginable and is built
on top of Fosite.

**Table of Contents**

* [Motivation](#motivation)
* [API Stability](#api-stability)
* [Example](#example)
* [A word on quality](#a-word-on-quality)
* [A word on security](#a-word-on-security)
* [A word on extensibility](#a-word-on-extensibility)
* [Installation](#installation)
* [Documentation](#documentation)
  + [Scopes](#scopes)
    - [`fosite.WildcardScopeStrategy`](#fositewildcardscopestrategy)
    - [`fosite.HierarchicScopeStrategy`](#fositehierarchicscopestrategy)
  + [Quickstart](#quickstart)
  + [Code Examples](#code-examples)
  + [Example Storage Implementation](#example-storage-implementation)
  + [Extensible handlers](#extensible-handlers)
  + [JWT Introspection](#jwt-introspection)
* [Contribute](#contribute)
  + [Refresh mock objects](#refresh-mock-objects)
* [Hall of Fame](#hall-of-fame)

## Motivation

Fosite was written because our OAuth2 and OpenID Connect service
[**Hydra**](https://github.com/ory-am/hydra) required a secure and extensible
OAuth2 library. We had to realize that nothing matching our requirements was out
there, so we decided to build it ourselves.

## API Stability

The core public API is almost stable as most changes will only touch the inner
workings.

We strongly encourage vendoring fosite using
[dep](https://github.com/golang/dep) or comparable tools.

## Example

The example does not have nice visuals but it should give you an idea of what
you can do with Fosite and a few lines of code.

[![Authorize Code Grant](/ory/fosite/raw/master/docs/authorize-code-grant.gif)](/ory/fosite/blob/master/docs/authorize-code-grant.gif)

You can run this minimalistic example by doing

```
go get github.com/ory/fosite-example
cd $GOPATH/src/github.com/ory/fosite-example
dep ensure
go install github.com/ory/fosite-example
fosite-example

```

There should be a server listening on [localhost:3846](https://localhost:3846/).
You can check out the example's source code
[here](https://github.com/ory/fosite-example/).

## A word on quality

We tried to set up as many tests as possible and test for as many cases covered
in the RFCs as possible. But we are only human. Please, feel free to add tests
for the various cases defined in the OAuth2 RFCs 6749 and 6819 or any other
cases that improve the tests.

**Everyone** writing an RFC conform test that breaks with the current
implementation, will receive a place in the [Hall of Fame](#hall-of-fame)!

## A word on security

Please be aware that Fosite only secures parts of your server side security. You
still need to secure your apps and clients, keep your tokens safe, prevent CSRF
attacks, ensure database security, use valid and strong TLS certificates and
much more. If you need any help or advice feel free to contact our security
staff through [our website](https://ory.am/)!

We have given the various specifications, especially
[OAuth 2.0 Threat Model and Security Considerations](https://tools.ietf.org/html/rfc6819#section-5.1.5.3),
a very close look and included everything we thought was in the scope of this
framework. Here is a complete list of things we implemented in Fosite:

* [No Cleartext Storage of Credentials](https://tools.ietf.org/html/rfc6819#section-5.1.4.1.3)
* [Encryption of Credentials](https://tools.ietf.org/html/rfc6819#section-5.1.4.1.4)
* [Use Short Expiration Time](https://tools.ietf.org/html/rfc6819#section-5.1.5.3)
* [Limit Number of Usages or One-Time Usage](https://tools.ietf.org/html/rfc6819#section-5.1.5.4)
* [Bind Token to Client id](https://tools.ietf.org/html/rfc6819#section-5.1.5.8)
* [Automatic Revocation of Derived Tokens If Abuse Is Detected](https://tools.ietf.org/html/rfc6819#section-5.2.1.1)
* [Binding of Refresh Token to "client\_id"](https://tools.ietf.org/html/rfc6819#section-5.2.2.2)
* [Refresh Token Rotation](https://tools.ietf.org/html/rfc6819#section-5.2.2.3)
* [Revocation of Refresh Tokens](https://tools.ietf.org/html/rfc6819#section-5.2.2.4)
* [Validate Pre-Registered "redirect\_uri"](https://tools.ietf.org/html/rfc6819#section-5.2.3.5)
* [Binding of Authorization "code" to "client\_id"](https://tools.ietf.org/html/rfc6819#section-5.2.4.4)
* [Binding of Authorization "code" to "redirect\_uri"](https://tools.ietf.org/html/rfc6819#section-5.2.4.6)
* [Opaque access tokens](https://tools.ietf.org/html/rfc6749#section-1.4)
* [Opaque refresh tokens](https://tools.ietf.org/html/rfc6749#section-1.5)
* [Ensure Confidentiality of Requests](https://tools.ietf.org/html/rfc6819#section-5.1.1)
* [Use of Asymmetric Cryptography](https://tools.ietf.org/html/rfc6819#section-5.1.4.1.5)
  Fosite ensures that redirect URIs use https **except localhost** but you need
  to implement TLS for the token and auth endpoints yourself.

Additionally, we added these safeguards:

* **Enforcing random states:** Without a random-looking state or OpenID Connect
  nonce the request will fail.
* **Advanced Token Validation:** Tokens are layouted as `<key>.<signature>`
  where `<signature>` is created using HMAC-SHA256 using a global secret. This
  is what a token can look like:
  `/tgBeUhWlAT8tM8Bhmnx+Amf8rOYOUhrDi3pGzmjP7c=.BiV/Yhma+5moTP46anxMT6cWW8gz5R5vpC9RbpwSDdM=`

Sections below [Section 5](https://tools.ietf.org/html/rfc6819#section-5) that
are not covered in the list above should be reviewed by you. If you think that a
specific section should be something that is covered in Fosite, feel free to
create an [issue](https://github.com/ory/fosite/issues). Please be aware that
OpenID Connect requires specific knowledge of the identity provider, which is
why Fosite only implements core requirements and most things must be implemented
by you (for example prompt, max\_age, ui\_locales, id\_token\_hint, user
authentication, session management, ...).

**It is strongly encouraged to use the handlers shipped with Fosite as they
follow the specs and are well tested.**

## A word on extensibility

Fosite is extensible ... because OAuth2 is an extensible and flexible
**framework**. Fosite let's you register custom token and authorize endpoint
handlers with the security that the requests have been validated against the
OAuth2 specs beforehand. You can easily extend Fosite's capabilities. For
example, if you want to provide OpenID Connect on top of your OAuth2 stack,
that's no problem. Or custom assertions, what ever you like and as long as it is
secure. ;)

## Installation

[Go 1.11+](https://golang.org) must be installed on your system and it is
required that you have set up your GOPATH environment variable.

```
go get -u github.com/ory/fosite/...

```

We recommend to use [dep](https://github.com/golang/dep) to mitigate
compatibility breaks that come with new api versions.

## Documentation

There is an API documentation available at
[godoc.org/ory/fosite](https://godoc.org/github.com/ory/fosite).

### Scopes

Fosite has three strategies for matching scopes. You can replace the default
scope strategy if you need a custom one by implementing `fosite.ScopeStrategy`.

Using the composer, setting a strategy is easy:

```
import "github.com/ory/fosite"

var config = &fosite.Config{
ScopeStrategy: fosite.HierarchicScopeStrategy,
}
```

**Note:** To issue refresh tokens with any of the grants, you need to include
the `offline` scope in the OAuth2 request. This can be modified by the
`RefreshTokenScopes` compose configuration. When set to an empty array, *all*
grants will issue refresh tokens.

#### `fosite.WildcardScopeStrategy`

This is the default strategy, and the safest one. It is best explained by
looking at some examples:

* `users.*` matches `users.read`
* `users.*` matches `users.read.foo`
* `users.read` matches `users.read`
* `users` does not match `users.read`
* `users.read.*` does not match `users.read`
* `users.*.*` does not match `users.read`
* `users.*.*` matches `users.read.own`
* `users.*.*` matches `users.read.own.other`
* `users.read.*` matches `users.read.own`
* `users.read.*` matches `users.read.own.other`
* `users.write.*` does not match `users.read.own`
* `users.*.bar` matches `users.baz.bar`
* `users.*.bar` does not `users.baz.baz.bar`

To request `users.*`, a client must have exactly `users.*` as granted scope.

#### `fosite.ExactScopeStrategy`

This strategy is searching only for exact matches. It returns true iff the scope
is granted.

#### `fosite.HierarchicScopeStrategy`

This strategy is deprecated, use it with care. Again, it is best explained by
looking at some examples:

* `users` matches `users`
* `users` matches `users.read`
* `users` matches `users.read.own`
* `users.read` matches `users.read`
* `users.read` matches `users.read.own`
* `users.read` does not match `users.write`
* `users.read` does not match `users.write.own`

### Globalization

Fosite does not natively carry translations for error messages and hints, but
offers an interface that allows the consumer to define catalog bundles and an
implementation to translate. This is available through the
[MessageCatalog](/ory/fosite/blob/master/i18n/i18n.go) interface. The functions defined are
self-explanatory. The `DefaultMessageCatalog` illustrates this. Compose config
has been extended to take in an instance of the `MessageCatalog`.

#### Building translated files

There are three possible "message key" types:

1. Value of `RFC6749Error.ErrorField`: This is a string like `invalid_request`
   and correlates to most errors produced by Fosite.
2. Hint identifier passed into `RFC6749Error.WithHintIDOrDefaultf`: This func is
   not used extensively in Fosite but, in time, most `WithHint` and `WithHintf`
   will be replaced with this function.
3. Free text string format passed into `RFC6749Error.WithHint` and
   `RFC6749Error.WithHintf`: This function is used in Fosite and Hydra
   extensively and any message catalog implementation can use the format string
   parameter as the message key.

An example of a message catalog can be seen in the
[i18n\_test.go](/ory/fosite/blob/master/i18n/i18n_test.go).

#### Generating the `en` messages file

This is a WIP at the moment, but effectively any scripting language can be used
to generate this. It would need to traverse all files in the source code and
extract the possible message identifiers based on the different message key
types.

### Quickstart

Instantiating fosite by hand can be painful. Therefore we created a few
convenience helpers available through the [compose package](/ory/fosite/blob/master/compose). It is
strongly encouraged to use these well tested composers.

In this very basic example, we will instantiate fosite with all OpenID Connect
and OAuth2 handlers enabled. Please refer to the
[example app](https://github.com/ory/fosite-example/) for more details.

This little code snippet sets up a full-blown OAuth2 and OpenID Connect example.

```
package main

import "github.com/ory/fosite"
import "github.com/ory/fosite/compose"
import "github.com/ory/fosite/storage"

// This is the example storage that contains:
// * an OAuth2 Client with id "my-client" and secrets "foobar" and "foobaz" capable of all oauth2 and open id connect grant and response types.
// * a User for the resource owner password credentials grant type with username "peter" and password "secret".
//
// You will most likely replace this with your own logic once you set up a real world application.
var storage = storage.NewExampleStore()

// This secret is being used to sign access and refresh tokens as well as
// authorization codes. It must be exactly 32 bytes long.
var secret = []byte("my super secret signing password")

privateKey, err := rsa.GenerateKey(rand.Reader, 2048)
if err != nil {
panic("unable to create private key")
}

// check the api docs of fosite.Config for further configuration options
var config = &fosite.Config{
	AccessTokenLifespan: time.Minute * 30,
	GlobalSecret: secret,
	// ...
}

var oauth2Provider = compose.ComposeAllEnabled(config, storage, privateKey)

// The authorize endpoint is usually at "https://mydomain.com/oauth2/auth".
func authorizeHandlerFunc(rw http.ResponseWriter, req *http.Request) {
	// This context will be passed to all methods. It doesn't fulfill a real purpose in the standard library but could be used
	// to abort database lookups or similar things.
	ctx := req.Context()

	// Let's create an AuthorizeRequest object!
	// It will analyze the request and extract important information like scopes, response type and others.
	ar, err := oauth2Provider.NewAuthorizeRequest(ctx, req)
	if err != nil {
		oauth2Provider.WriteAuthorizeError(ctx, rw, ar, err)
		return
	}

	// Normally, this would be the place where you would check if the user is logged in and gives his consent.
	// We're simplifying things and just checking if the request includes a valid username and password
	if req.Form.Get("username") != "peter" {
		rw.Header().Set("Content-Type", "text/html;charset=UTF-8")
		rw.Write([]byte(`<h1>Login page</h1>`))
		rw.Write([]byte(`
			<p>Howdy! This is the log in page. For this example, it is enough to supply the username.</p>
			<form method="post">
				<input type="text" name="username" /> <small>try peter</small><br>
				<input type="submit">
			</form>
		`))
		return
	}

	// Now that the user is authorized, we set up a session. When validating / looking up tokens, we additionally get
	// the session. You can store anything you want in it.

	// The session will be persisted by the store and made available when e.g. validating tokens or handling token endpoint requests.
	// The default OAuth2 and OpenID Connect handlers require the session to implement a few methods. Apart from that, the
	// session struct can be anything you want it to be.
	mySessionData := &fosite.DefaultSession{
		Username: req.Form.Get("username"),
	}

	// It's also wise to check the requested scopes, e.g.:
	// if authorizeRequest.GetScopes().Has("admin") {
	//     http.Error(rw, "you're not allowed to do that", http.StatusForbidden)
	//     return
	// }

	// Now we need to get a response. This is the place where the AuthorizeEndpointHandlers kick in and start processing the request.
	// NewAuthorizeResponse is capable of running multiple response type handlers which in turn enables this library
	// to support open id connect.
	response, err := oauth2Provider.NewAuthorizeResponse(ctx, ar, mySessionData)
	if err != nil {
		oauth2Provider.WriteAuthorizeError(ctx, rw, ar, err)
		return
	}

	// Awesome, now we redirect back to the client redirect uri and pass along an authorize code
	oauth2Provider.WriteAuthorizeResponse(ctx, rw, ar, response)
}

// The token endpoint is usually at "https://mydomain.com/oauth2/token"
func tokenHandlerFunc(rw http.ResponseWriter, req *http.Request) {
	ctx := req.Context()

	// Create an empty session object that will be passed to storage implementation to populate (unmarshal) the session into.
	// By passing an empty session object as a "prototype" to the store, the store can use the underlying type to unmarshal the value into it.
	// For an example of storage implementation that takes advantage of that, see SQL Store (fosite_store_sql.go) from ory/Hydra project.
	mySessionData := new(fosite.DefaultSession)

	// This will create an access request object and iterate through the registered TokenEndpointHandlers to validate the request.
	accessRequest, err := oauth2Provider.NewAccessRequest(ctx, req, mySessionData)
	if err != nil {
		oauth2Provider.WriteAccessError(ctx, rw, accessRequest, err)
		return
	}

	if mySessionData.Username == "super-admin-guy" {
		// do something...
	}

	// Next we create a response for the access request. Again, we iterate through the TokenEndpointHandlers
	// and aggregate the result in response.
	response, err := oauth2Provider.NewAccessResponse(ctx, accessRequest)
	if err != nil {
		oauth2Provider.WriteAccessError(ctx, rw, accessRequest, err)
		return
	}

	// All done, send the response.
	oauth2Provider.WriteAccessResponse(ctx, rw, accessRequest, response)

	// The client has a valid access token now
}

func someResourceProviderHandlerFunc(rw http.ResponseWriter, req *http.Request) {
	ctx := req.Context()
	requiredScope := "blogposts.create"

	_, ar, err := oauth2Provider.IntrospectToken(ctx, fosite.AccessTokenFromRequest(req), fosite.AccessToken, new(fosite.DefaultSession), requiredScope)
	if err != nil {
		// ...
	}

	// If no error occurred the token + scope is valid and you have access to:
	// ar.GetClient().GetID(), ar.GetGrantedScopes(), ar.GetScopes(), ar.GetSession().UserID, ar.GetRequestedAt(), ...
}
```

### Code Examples

Fosite provides integration tests as well as a http server example:

* Fosite ships with an example app that runs in your browser:
  [Example app](https://github.com/ory/fosite-example/).
* If you want to check out how to enable specific handlers, check out the
  [integration tests](/ory/fosite/blob/master/integration).

If you have working examples yourself, please share them with us!

### Example Storage Implementation

Fosite does not ship a storage implementation. This is intended, because
requirements vary with every environment. You can find a reference
implementation at [storage/memory.go](/ory/fosite/blob/master/storage/memory.go). This storage fulfills
requirements from all OAuth2 and OpenID Connect handlers.

### Extensible handlers

OAuth2 is a framework. Fosite mimics this behaviour by enabling you to replace
existing or create new OAuth2 handlers. Of course, fosite ships handlers for all
OAuth2 and OpenID Connect flows.

* **[Fosite OAuth2 Core Handlers](/ory/fosite/blob/master/handler/oauth2)** implement the
  [Client Credentials Grant](https://tools.ietf.org/html/rfc6749#section-4.4),
  [Resource Owner Password Credentials Grant](https://tools.ietf.org/html/rfc6749#section-4.3),
  [Implicit Grant](https://tools.ietf.org/html/rfc6749#section-4.2),
  [Authorization Code Grant](https://tools.ietf.org/html/rfc6749#section-4.1),
  [Refresh Token Grant](https://tools.ietf.org/html/rfc6749#section-6)
* **[Fosite OpenID Connect Handlers](/ory/fosite/blob/master/handler/openid)** implement the
  [Authentication using the Authorization Code Flow](http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth),
  [Authentication using the Implicit Flow](http://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth),
  [Authentication using the Hybrid Flow](http://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth)

This section is missing documentation and we welcome any contributions in that
direction.

### JWT Introspection

Please note that when using the OAuth2StatelessJWTIntrospectionFactory access
token revocation is not possible.

## Contribute

You need git and golang installed on your system.

```
go get -d github.com/ory/fosite
cd $GOPATH/src/github.com/ory/fosite
git status
git remote add myfork <url-to-your-fork>
go test ./...

```

Simple, right? Now you are ready to go! Make sure to run `go test ./...` often,
detecting problems with your code rather sooner than later. Please read
[CONTRIBUTE.md] before creating pull requests and issues.

### Refresh mock objects

Run `./generate-mocks.sh` in fosite's root directory or run the contents of
[generate-mocks.sh] in a shell.

## Hall of Fame

This place is reserved for the fearless bug hunters, reviewers and contributors
(alphabetical order).

* [agtorre](https://github.com/agtorre):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Aagtorre),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Aagtorre).
* [danielchatfield](https://github.com/danielchatfield):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Adanielchatfield),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Adanielchatfield).
* [leetal](https://github.com/leetal):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Aleetal),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Aleetal).
* [jrossiter](https://github.com/jrossiter):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Ajrossiter),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Ajrossiter).
* [jrossiter](https://github.com/jrossiter):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Ajrossiter),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Ajrossiter).
* [danilobuerger](https://github.com/danilobuerger):
  [contributions](https://github.com/ory/fosite/issues?q=author%3Adanilobuerger),
  [participations](https://github.com/ory/fosite/issues?q=commenter%3Adanilobuerger).

Find out more about the [author](https://aeneas.io/) of Fosite and Hydra, and
the [Ory Company](https://ory.am/).

## About

Extensible security first OAuth 2.0 and OpenID Connect SDK for Go.

[www.ory.sh/?utm\_source=github&utm\_medium=banner&utm\_campaign=fosite](https://www.ory.sh/?utm_source=github&utm_medium=banner&utm_campaign=fosite "https://www.ory.sh/?utm_source=github&utm_medium=banner&utm_campaign=fosite")

### Topics

[golang](/topics/golang "Topic: golang")
[security](/topics/security "Topic: security")
[oauth](/topics/oauth "Topic: oauth")
[library](/topics/library "Topic: library")
[oauth2](/topics/oauth2 "Topic: oauth2")
[sdk](/topics/sdk "Topic: sdk")
[authentication](/topics/authentication "Topic: authentication")
[auth](/topics/auth "Topic: auth")
[authorization](/topics/authorization "Topic: authorization")
[openid-connect](/topics/openid-connect "Topic: openid-connect")
[hacktoberfest](/topics/hacktoberfest "Topic: hacktoberfest")

### Resources

[Readme](#readme-ov-file)
### License

[Apache-2.0 license](#Apache-2.0-1-ov-file)
### Code of conduct

[Code of conduct](#coc-ov-file)
### Security policy

[Security policy](#security-ov-file)

[Activity](/ory/fosite/activity)
[Custom properties](/ory/fosite/custom-properties)
### Stars

[**2.3k**
stars](/ory/fosite/stargazers)
### Watchers

[**50**
watching](/ory/fosite/watchers)
### Forks

[**368**
forks](/ory/fosite/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fory%2Ffosite&report=ory+%28user%29)

## [Releases 157](/ory/fosite/releases)

[v0.49.0
Latest

Dec 12, 2024](/ory/fosite/releases/tag/v0.49.0)
[+ 156 releases](/ory/fosite/releases)

## [Packages 0](/orgs/ory/packages?repo_name=fosite)

No packages published

## [Contributors 102](/ory/fosite/graphs/contributors)

* [![@aeneasr](https://avatars.githubusercontent.com/u/3372410?s=64&v=4)](https://github.com/aeneasr)
* [![@mitar](https://avatars.githubusercontent.com/u/585279?s=64&v=4)](https://github.com/mitar)
* [![@leetal](https://avatars.githubusercontent.com/u/1221839?s=64&v=4)](https://github.com/leetal)
* [![@aaslamin](https://avatars.githubusercontent.com/u/1800781?s=64&v=4)](https://github.com/aaslamin)
* [![@kevgo](https://avatars.githubusercontent.com/u/268934?s=64&v=4)](https://github.com/kevgo)
* [![@zepatrik](https://avatars.githubusercontent.com/u/5354445?s=64&v=4)](https://github.com/zepatrik)
* [![@narg95](https://avatars.githubusercontent.com/u/6938606?s=64&v=4)](https://github.com/narg95)
* [![@ory-bot](https://avatars.githubusercontent.com/u/60093411?s=64&v=4)](https://github.com/ory-bot)
* [![@dependabot[bot]](https://avatars.githubusercontent.com/in/29110?s=64&v=4)](https://github.com/apps/dependabot)
* [![@michaelboke](https://avatars.githubusercontent.com/u/2121940?s=64&v=4)](https://github.com/michaelboke)
* [![@nerocrux](https://avatars.githubusercontent.com/u/452535?s=64&v=4)](https://github.com/nerocrux)
* [![@james-d-elliott](https://avatars.githubusercontent.com/u/3903683?s=64&v=4)](https://github.com/james-d-elliott)
* [![@hperl](https://avatars.githubusercontent.com/u/34397?s=64&v=4)](https://github.com/hperl)
* [![@pschultz](https://avatars.githubusercontent.com/u/607733?s=64&v=4)](https://github.com/pschultz)

[+ 88 contributors](/ory/fosite/graphs/contributors)

## Languages

* [Go
  99.5%](/ory/fosite/search?l=go)
* Other
  0.5%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5e5de3a1_20250119_122319.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Freleases%2Ftag%2Fv1.4.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fory%2Fhydra%2Freleases%2Ftag%2Fv1.4.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=ory%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ory](/ory)
/
**[hydra](/ory/hydra)**
Public

* [Notifications](/login?return_to=%2Fory%2Fhydra) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fory%2Fhydra)
* [Star
   15.8k](/login?return_to=%2Fory%2Fhydra)

* [Code](/ory/hydra/tree/v1.4.0)
* [Issues
  85](/ory/hydra/issues)
* [Pull requests
  22](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

Additional navigation options

* [Code](/ory/hydra/tree/v1.4.0)
* [Issues](/ory/hydra/issues)
* [Pull requests](/ory/hydra/pulls)
* [Discussions](/ory/hydra/discussions)
* [Actions](/ory/hydra/actions)
* [Security](/ory/hydra/security)
* [Insights](/ory/hydra/pulse)

1. [Releases](/ory/hydra/releases)
2. [v1.4.0](/ory/hydra/releases/tag/v1.4.0)

# v1.4.0+oryOS.18

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/ory/hydra/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v1.4.0)

 Loading

[View all tags](/ory/hydra/tags)

![@aeneasr](https://avatars.githubusercontent.com/u/3372410?s=40&v=4)
[aeneasr](/aeneasr)
released this
02 Apr 09:37

·
[2330 commits](/ory/hydra/compare/v1.4.0...master)
to master
since this release

[v1.4.0](/ory/hydra/tree/v1.4.0)

[`700d17d`](/ory/hydra/commit/700d17d3b7d507de1b1d459a7261d6fb2571ebe3)

This commit was created on GitHub.com and signed with GitHub’s **verified signature**.
The key has expired.

GPG key ID: 4AEE18F83AFDEB23
Expired

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

```
Merge pull request from GHSA-3p3g-vpw6-4w66

BREAKING CHANGE: This patch requires a new SQL Table which needs to be created using `hydra migrate sql`. No other breaking changes have been introduced by this patch.

This patch introduces a blacklist for JTIs which prevents a potential replay of `private_key_jwt` JWTs when performing client authorization.

## GHSA-3p3g-vpw6-4w66

### Impact

When using client authentication method "private_key_jwt" [1], OpenId specification says the following about assertion `jti`:

> A unique identifier for the token, which can be used to prevent reuse of the token. These tokens MUST only be used once, unless conditions for reuse were negotiated between the parties

Hydra does not seem to check the uniqueness of this `jti` value. Here is me sending the same token request twice, hence with the same `jti` assertion, and getting two access tokens:

```
$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"zeG0NoqOtlACl8q5J6A-TIsNegQRRUzqLZaYrQtoBZQ.VR6iUcJQYp3u_j7pwvL7YtPqGhtyQe5OhnBE2KCp5pM","expires_in":3599,"scope":"application openid","token_type":"bearer"}⏎            ~$ curl --insecure --location --request POST 'https://localhost/_/oauth2/token' \
   --header 'Content-Type: application/x-www-form-urlencoded' \
   --data-urlencode 'grant_type=client_credentials' \
   --data-urlencode 'client_id=c001d00d-5ecc-beef-ca4e-b00b1e54a111' \
   --data-urlencode 'scope=application openid' \
   --data-urlencode 'client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer' \
   --data-urlencode 'client_assertion=eyJhb [...] jTw'
{"access_token":"wOYtgCLxLXlELORrwZlmeiqqMQ4kRzV-STU2_Sollas.mwlQGCZWXN7G2IoegUe1P0Vw5iGoKrkOzOaplhMSjm4","expires_in":3599,"scope":"application openid","token_type":"bearer"}
```

### Severity

We rate the severity as medium because the following reasons make it hard to replay tokens without the patch:

- TLS protects against MITM which makes it difficult to intercept valid tokens for replay attacks
- The expiry time of the JWT gives only a short window of opportunity where it could be replayed

### Patches

This will be patched with v1.4.0+oryOS.17

### Workarounds

Two workarounds have been identified:

- Do not allow clients to use `private_key_jwt`
- Use short expiry times for the JWTs

### References

https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication

### Upstream

This issue will be resolved in the upstream repository https://github.com/ory/fosite
```

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


