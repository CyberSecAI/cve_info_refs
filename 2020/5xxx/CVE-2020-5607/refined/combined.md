=== Content from github.com_2c1a40ab_20250119_112318.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi%2Fcommit%2F040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi%2Fcommit%2F040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=shirasagi%2Fshirasagi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[shirasagi](/shirasagi)
/
**[shirasagi](/shirasagi/shirasagi)**
Public

* [Notifications](/login?return_to=%2Fshirasagi%2Fshirasagi) You must be signed in to change notification settings
* [Fork
  74](/login?return_to=%2Fshirasagi%2Fshirasagi)
* [Star
   110](/login?return_to=%2Fshirasagi%2Fshirasagi)

* [Code](/shirasagi/shirasagi)
* [Issues
  415](/shirasagi/shirasagi/issues)
* [Pull requests
  62](/shirasagi/shirasagi/pulls)
* [Actions](/shirasagi/shirasagi/actions)
* [Projects
  0](/shirasagi/shirasagi/projects)
* [Wiki](/shirasagi/shirasagi/wiki)
* [Security](/shirasagi/shirasagi/security)
* [Insights](/shirasagi/shirasagi/pulse)

Additional navigation options

* [Code](/shirasagi/shirasagi)
* [Issues](/shirasagi/shirasagi/issues)
* [Pull requests](/shirasagi/shirasagi/pulls)
* [Actions](/shirasagi/shirasagi/actions)
* [Projects](/shirasagi/shirasagi/projects)
* [Wiki](/shirasagi/shirasagi/wiki)
* [Security](/shirasagi/shirasagi/security)
* [Insights](/shirasagi/shirasagi/pulse)

## Commit

[Permalink](/shirasagi/shirasagi/commit/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[fix][cms] open redirect vulnerability on member login ([#3646](https://github.com/shirasagi/shirasagi/pull/3646))

[Browse files](/shirasagi/shirasagi/tree/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a)
Browse the repository at this point in the history

```
* [fix] open redirect vulnerability

* [add] reproducible spec
```

* Loading branch information

[![@sunny4381](https://avatars.githubusercontent.com/u/3593466?s=40&v=4)](/sunny4381)

[sunny4381](/shirasagi/shirasagi/commits?author=sunny4381 "View all commits by sunny4381")
authored
Jul 1, 2020

1 parent
[04675a5](/shirasagi/shirasagi/commit/04675a5217d3b6a7df4bc20cd81cf7c829ada6ba)

commit 040a02c

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**163 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + controllers

    - concerns/member

      * app/controllers/concerns/member/login\_filter.rb
        [login\_filter.rb](#diff-479ff0118f8a4cece10c32ec1f98d9f5c69cbdb5da9feb43c85b7c831bb9ab2c)
    - member/agents/nodes

      * app/controllers/member/agents/nodes/login\_controller.rb
        [login\_controller.rb](#diff-fe033199d4a61253835a5ef45b29ca451d95be65cb36ef2f1dffc33eab556998)
  + models/member

    - app/models/member/node.rb
      [node.rb](#diff-ceb595e3f812bee15776787568d18df6468e734f96da7e6b3683241d44bee1ec)
* spec

  + features/members/agents/nodes

    - spec/features/members/agents/nodes/login\_spec.rb
      [login\_spec.rb](#diff-6512dba0a84d1e80d8dd4312bcb20484befb95cc7b4ae308f7717ca2773e6813)
  + models/member/node

    - spec/models/member/node/login\_spec.rb
      [login\_spec.rb](#diff-67bfb712069742811def8b6dbf64b59f92ded45bc323b1e94443494452f13092)

## There are no files selected for viewing

5 changes: 0 additions & 5 deletions

5
[app/controllers/concerns/member/login\_filter.rb](#diff-479ff0118f8a4cece10c32ec1f98d9f5c69cbdb5da9feb43c85b7c831bb9ab2c "app/controllers/concerns/member/login_filter.rb")

Show comments

[View file](/shirasagi/shirasagi/blob/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a/app/controllers/concerns/member/login_filter.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -68,11 +68,6 @@ def member\_login\_path |
|  |  | "#{member\_login\_node.url}login.html" |
|  |  | end |
|  |  |  |
|  |  | def redirect\_url |
|  |  | return "/" unless member\_login\_node |
|  |  | member\_login\_node.redirect\_url || "/" |
|  |  | end |
|  |  |  |
|  |  | def translate\_redirect\_option(opts) |
|  |  | case opts[:redirect] |
|  |  | when true |
| Expand Down | |  |

27 changes: 25 additions & 2 deletions

27
[app/controllers/member/agents/nodes/login\_controller.rb](#diff-fe033199d4a61253835a5ef45b29ca451d95be65cb36ef2f1dffc33eab556998 "app/controllers/member/agents/nodes/login_controller.rb")

Show comments

[View file](/shirasagi/shirasagi/blob/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a/app/controllers/member/agents/nodes/login_controller.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,13 +21,36 @@ def set\_member\_and\_redirect(member) |
|  |  | remote\_addr: remote\_addr, |
|  |  | user\_agent: request.user\_agent) |
|  |  |  |
|  |  | ref = URI::decode(params[:ref] || flash[:ref] || "") |
|  |  | ref = redirect\_url if ref.blank? |
|  |  | ref = @cur\_node.make\_trusted\_full\_url(params[:ref] || flash[:ref]) |
|  |  | ref = @cur\_node.redirect\_full\_url if ref.blank? |
|  |  | ref = @cur\_site.full\_url if ref.blank? |
|  |  | flash.discard(:ref) |
|  |  |  |
|  |  | redirect\_to ref |
|  |  | end |
|  |  |  |
|  |  | def make\_url\_if\_trusted(ref) |
|  |  | return if ref.blank? |
|  |  |  |
|  |  | ref = URI::decode(ref) |
|  |  |  |
|  |  | site\_url = URI.parse(@cur\_site.full\_url) |
|  |  | full\_url = URI.join(site\_url, ref) rescue nil |
|  |  | return if full\_url.blank? |
|  |  | return unless %w(http https).include?(full\_url.scheme) |
|  |  |  |
|  |  | # normalize full url |
|  |  | full\_url.fragment = nil |
|  |  | full\_url.query = nil |
|  |  |  |
|  |  | # trusted? |
|  |  | return if full\_url.scheme != site\_url.scheme |
|  |  | return if full\_url.host != site\_url.host |
|  |  | return if full\_url.port != site\_url.port |
|  |  |  |
|  |  | full\_url.to\_s |
|  |  | end |
|  |  |  |
|  |  | public |
|  |  |  |
|  |  | def login |
| Expand Down | |  |

39 changes: 39 additions & 0 deletions

39
[app/models/member/node.rb](#diff-ceb595e3f812bee15776787568d18df6468e734f96da7e6b3683241d44bee1ec "app/models/member/node.rb")

Show comments

[View file](/shirasagi/shirasagi/blob/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a/app/models/member/node.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,6 +22,45 @@ class Login |
|  |  | include History::Addon::Backup |
|  |  |  |
|  |  | default\_scope ->{ where(route: "member/login") } |
|  |  |  |
|  |  | def redirect\_full\_url |
|  |  | return if redirect\_url.blank? |
|  |  |  |
|  |  | ret = make\_full\_url(redirect\_url) |
|  |  | return if ret.blank? |
|  |  | return unless trusted?(ret) |
|  |  |  |
|  |  | ret.to\_s |
|  |  | end |
|  |  |  |
|  |  | def make\_trusted\_full\_url(ref) |
|  |  | return if ref.blank? |
|  |  |  |
|  |  | full\_url = make\_full\_url(URI::decode(ref)) |
|  |  | return if full\_url.blank? |
|  |  |  |
|  |  | # normalize full url |
|  |  | full\_url.fragment = nil |
|  |  | full\_url.query = nil |
|  |  |  |
|  |  | # trusted? |
|  |  | return unless trusted?(full\_url) |
|  |  |  |
|  |  | full\_url.to\_s |
|  |  | end |
|  |  |  |
|  |  | private |
|  |  |  |
|  |  | def make\_full\_url(path) |
|  |  | site\_root\_url = URI.parse(site.full\_root\_url) |
|  |  | URI.join(site\_root\_url, path) rescue nil |
|  |  | end |
|  |  |  |
|  |  | def trusted?(full\_url) |
|  |  | return false if full\_url.blank? |
|  |  |  |
|  |  | %w(http https).include?(full\_url.scheme) && full\_url.to\_s.start\_with?(site.full\_url) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | class Mypage |
| Expand Down | |  |

27 changes: 26 additions & 1 deletion

27
[spec/features/members/agents/nodes/login\_spec.rb](#diff-6512dba0a84d1e80d8dd4312bcb20484befb95cc7b4ae308f7717ca2773e6813 "spec/features/members/agents/nodes/login_spec.rb")

Show comments

[View file](/shirasagi/shirasagi/blob/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a/spec/features/members/agents/nodes/login_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,6 @@ |
|  |  | require 'spec\_helper' |
|  |  |  |
|  |  | describe 'members/agents/nodes/login', type: :feature, dbscope: :example do |
|  |  | describe 'members/agents/nodes/login', type: :feature, dbscope: :example, js: true do |
|  |  | describe "ss-2724" do |
|  |  | let(:root\_site) { cms\_site } |
|  |  | let(:site1) { create(:cms\_site\_subdir, domains: root\_site.domains) } |
| Expand Down  Expand Up | | @@ -46,4 +46,29 @@ |
|  |  | expect(page).to have\_css(".form-login") |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe "open redirect" do |
|  |  | let(:site) { cms\_site } |
|  |  | let(:layout) { create\_cms\_layout(cur\_site: site) } |
|  |  | let(:index\_page) { create :cms\_page, cur\_site: site, layout: layout, filename: "index.html", html: "you've been logged in" } |
|  |  | let!(:login\_node) do |
|  |  | create( |
|  |  | :member\_node\_login, cur\_site: site, layout: layout, redirect\_url: index\_page.url, form\_auth: "enabled" |
|  |  | ) |
|  |  | end |
|  |  | let!(:member) { create :cms\_member, cur\_site: site } |
|  |  |  |
|  |  | it do |
|  |  | visit "#{login\_node.full\_url}login.html" + "?" + { ref: URI.encode("https://www.ss-proj.org/") }.to\_query |
|  |  |  |
|  |  | within ".form-login" do |
|  |  | fill\_in "item[email]", with: member.email |
|  |  | fill\_in "item[password]", with: member.in\_password |
|  |  |  |
|  |  | click\_on I18n.t("ss.login") |
|  |  | end |
|  |  |  |
|  |  | expect(page).to have\_css(".body", text: "you've been logged in") |
|  |  | end |
|  |  | end |
|  |  | end |

73 changes: 73 additions & 0 deletions

73
[spec/models/member/node/login\_spec.rb](#diff-67bfb712069742811def8b6dbf64b59f92ded45bc323b1e94443494452f13092 "spec/models/member/node/login_spec.rb")

Show comments

[View file](/shirasagi/shirasagi/blob/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a/spec/models/member/node/login_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,73 @@ |
|  |  | require 'spec\_helper' |
|  |  |  |
|  |  | describe Member::Node::Login, type: :model, dbscope: :example do |
|  |  | describe "#redirect\_full\_url" do |
|  |  | let(:site) { cms\_site } |
|  |  |  |
|  |  | context "when redirect\_url is missing" do |
|  |  | let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: nil } |
|  |  | it do |
|  |  | expect(node.redirect\_full\_url).to be\_blank |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when redirect\_url is full path" do |
|  |  | let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: "/#{unique\_id}" } |
|  |  | it do |
|  |  | expect(node.redirect\_full\_url).to eq URI.join(node.site.full\_url, node.redirect\_url).to\_s |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when redirect\_url is full url" do |
|  |  | let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: "#{site.full\_url}#{unique\_id}" } |
|  |  | it do |
|  |  | expect(node.redirect\_full\_url).to eq URI.join(node.site.full\_url, node.redirect\_url).to\_s |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when redirect\_url is other site url" do |
|  |  | let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: unique\_url } |
|  |  | it do |
|  |  | expect(node.redirect\_full\_url).to be\_blank |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe "#make\_trusted\_full\_url" do |
|  |  | let(:site) { cms\_site } |
|  |  | let(:node) { create :member\_node\_login, cur\_site: site } |
|  |  |  |
|  |  | context "when nil is given" do |
|  |  | it do |
|  |  | expect(node.make\_trusted\_full\_url(nil)).to be\_blank |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when empty string is given" do |
|  |  | it do |
|  |  | expect(node.make\_trusted\_full\_url("")).to be\_blank |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when full path is given" do |
|  |  | let(:path) { "/#{unique\_id}" } |
|  |  | it do |
|  |  | expect(node.make\_trusted\_full\_url(path)).to eq URI.join(node.site.full\_url, path[1..-1]).to\_s |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when full url is given" do |
|  |  | let(:url) { "#{site.full\_url}#{unique\_id}" } |
|  |  | it do |
|  |  | expect(node.make\_trusted\_full\_url(url)).to eq url |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context "when other site url is given" do |
|  |  | let(:url) { unique\_url } |
|  |  | it do |
|  |  | expect(node.make\_trusted\_full\_url(url)).to be\_blank |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  | end |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `040a02c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi%2Fcommit%2F040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b125f903_20250119_112318.html ===
From 040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a Mon Sep 17 00:00:00 2001
From: NAKANO Hideo
Date: Wed, 1 Jul 2020 13:49:01 +0900
Subject: [PATCH] [fix][cms] open redirect vulnerability on member login
(#3646)
\* [fix] open redirect vulnerability
\* [add] reproducible spec
---
.../concerns/member/login\_filter.rb | 5 --
.../member/agents/nodes/login\_controller.rb | 27 ++++++-
app/models/member/node.rb | 39 ++++++++++
.../members/agents/nodes/login\_spec.rb | 27 ++++++-
spec/models/member/node/login\_spec.rb | 73 +++++++++++++++++++
5 files changed, 163 insertions(+), 8 deletions(-)
create mode 100644 spec/models/member/node/login\_spec.rb
diff --git a/app/controllers/concerns/member/login\_filter.rb b/app/controllers/concerns/member/login\_filter.rb
index 2952216dc5e..4a2283e15e6 100644
--- a/app/controllers/concerns/member/login\_filter.rb
+++ b/app/controllers/concerns/member/login\_filter.rb
@@ -68,11 +68,6 @@ def member\_login\_path
"#{member\_login\_node.url}login.html"
end
- def redirect\_url
- return "/" unless member\_login\_node
- member\_login\_node.redirect\_url || "/"
- end
-
def translate\_redirect\_option(opts)
case opts[:redirect]
when true
diff --git a/app/controllers/member/agents/nodes/login\_controller.rb b/app/controllers/member/agents/nodes/login\_controller.rb
index a51005fe959..129ab6eb957 100644
--- a/app/controllers/member/agents/nodes/login\_controller.rb
+++ b/app/controllers/member/agents/nodes/login\_controller.rb
@@ -21,13 +21,36 @@ def set\_member\_and\_redirect(member)
remote\_addr: remote\_addr,
user\_agent: request.user\_agent)
- ref = URI::decode(params[:ref] || flash[:ref] || "")
- ref = redirect\_url if ref.blank?
+ ref = @cur\_node.make\_trusted\_full\_url(params[:ref] || flash[:ref])
+ ref = @cur\_node.redirect\_full\_url if ref.blank?
+ ref = @cur\_site.full\_url if ref.blank?
flash.discard(:ref)
redirect\_to ref
end
+ def make\_url\_if\_trusted(ref)
+ return if ref.blank?
+
+ ref = URI::decode(ref)
+
+ site\_url = URI.parse(@cur\_site.full\_url)
+ full\_url = URI.join(site\_url, ref) rescue nil
+ return if full\_url.blank?
+ return unless %w(http https).include?(full\_url.scheme)
+
+ # normalize full url
+ full\_url.fragment = nil
+ full\_url.query = nil
+
+ # trusted?
+ return if full\_url.scheme != site\_url.scheme
+ return if full\_url.host != site\_url.host
+ return if full\_url.port != site\_url.port
+
+ full\_url.to\_s
+ end
+
public
def login
diff --git a/app/models/member/node.rb b/app/models/member/node.rb
index 58085079ebd..20b9759e6e7 100644
--- a/app/models/member/node.rb
+++ b/app/models/member/node.rb
@@ -22,6 +22,45 @@ class Login
include History::Addon::Backup
default\_scope ->{ where(route: "member/login") }
+
+ def redirect\_full\_url
+ return if redirect\_url.blank?
+
+ ret = make\_full\_url(redirect\_url)
+ return if ret.blank?
+ return unless trusted?(ret)
+
+ ret.to\_s
+ end
+
+ def make\_trusted\_full\_url(ref)
+ return if ref.blank?
+
+ full\_url = make\_full\_url(URI::decode(ref))
+ return if full\_url.blank?
+
+ # normalize full url
+ full\_url.fragment = nil
+ full\_url.query = nil
+
+ # trusted?
+ return unless trusted?(full\_url)
+
+ full\_url.to\_s
+ end
+
+ private
+
+ def make\_full\_url(path)
+ site\_root\_url = URI.parse(site.full\_root\_url)
+ URI.join(site\_root\_url, path) rescue nil
+ end
+
+ def trusted?(full\_url)
+ return false if full\_url.blank?
+
+ %w(http https).include?(full\_url.scheme) && full\_url.to\_s.start\_with?(site.full\_url)
+ end
end
class Mypage
diff --git a/spec/features/members/agents/nodes/login\_spec.rb b/spec/features/members/agents/nodes/login\_spec.rb
index 972d109e4b7..32eadc5e178 100644
--- a/spec/features/members/agents/nodes/login\_spec.rb
+++ b/spec/features/members/agents/nodes/login\_spec.rb
@@ -1,6 +1,6 @@
require 'spec\_helper'
-describe 'members/agents/nodes/login', type: :feature, dbscope: :example do
+describe 'members/agents/nodes/login', type: :feature, dbscope: :example, js: true do
describe "ss-2724" do
let(:root\_site) { cms\_site }
let(:site1) { create(:cms\_site\_subdir, domains: root\_site.domains) }
@@ -46,4 +46,29 @@
expect(page).to have\_css(".form-login")
end
end
+
+ describe "open redirect" do
+ let(:site) { cms\_site }
+ let(:layout) { create\_cms\_layout(cur\_site: site) }
+ let(:index\_page) { create :cms\_page, cur\_site: site, layout: layout, filename: "index.html", html: "you've been logged in" }
+ let!(:login\_node) do
+ create(
+ :member\_node\_login, cur\_site: site, layout: layout, redirect\_url: index\_page.url, form\_auth: "enabled"
+ )
+ end
+ let!(:member) { create :cms\_member, cur\_site: site }
+
+ it do
+ visit "#{login\_node.full\_url}login.html" + "?" + { ref: URI.encode("https://www.ss-proj.org/") }.to\_query
+
+ within ".form-login" do
+ fill\_in "item[email]", with: member.email
+ fill\_in "item[password]", with: member.in\_password
+
+ click\_on I18n.t("ss.login")
+ end
+
+ expect(page).to have\_css(".body", text: "you've been logged in")
+ end
+ end
end
diff --git a/spec/models/member/node/login\_spec.rb b/spec/models/member/node/login\_spec.rb
new file mode 100644
index 00000000000..17ccd065b9d
--- /dev/null
+++ b/spec/models/member/node/login\_spec.rb
@@ -0,0 +1,73 @@
+require 'spec\_helper'
+
+describe Member::Node::Login, type: :model, dbscope: :example do
+ describe "#redirect\_full\_url" do
+ let(:site) { cms\_site }
+
+ context "when redirect\_url is missing" do
+ let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: nil }
+ it do
+ expect(node.redirect\_full\_url).to be\_blank
+ end
+ end
+
+ context "when redirect\_url is full path" do
+ let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: "/#{unique\_id}" }
+ it do
+ expect(node.redirect\_full\_url).to eq URI.join(node.site.full\_url, node.redirect\_url).to\_s
+ end
+ end
+
+ context "when redirect\_url is full url" do
+ let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: "#{site.full\_url}#{unique\_id}" }
+ it do
+ expect(node.redirect\_full\_url).to eq URI.join(node.site.full\_url, node.redirect\_url).to\_s
+ end
+ end
+
+ context "when redirect\_url is other site url" do
+ let(:node) { create :member\_node\_login, cur\_site: site, redirect\_url: unique\_url }
+ it do
+ expect(node.redirect\_full\_url).to be\_blank
+ end
+ end
+ end
+
+ describe "#make\_trusted\_full\_url" do
+ let(:site) { cms\_site }
+ let(:node) { create :member\_node\_login, cur\_site: site }
+
+ context "when nil is given" do
+ it do
+ expect(node.make\_trusted\_full\_url(nil)).to be\_blank
+ end
+ end
+
+ context "when empty string is given" do
+ it do
+ expect(node.make\_trusted\_full\_url("")).to be\_blank
+ end
+ end
+
+ context "when full path is given" do
+ let(:path) { "/#{unique\_id}" }
+ it do
+ expect(node.make\_trusted\_full\_url(path)).to eq URI.join(node.site.full\_url, path[1..-1]).to\_s
+ end
+ end
+
+ context "when full url is given" do
+ let(:url) { "#{site.full\_url}#{unique\_id}" }
+ it do
+ expect(node.make\_trusted\_full\_url(url)).to eq url
+ end
+ end
+
+ context "when other site url is given" do
+ let(:url) { unique\_url }
+ it do
+ expect(node.make\_trusted\_full\_url(url)).to be\_blank
+ end
+ end
+ end
+end


=== Content from jvndb.jvn.jp_06b886e4_20250119_131614.html ===


![JVN iPedia](/en/common/img/en_logo.gif)
Last Updated:2020/07/09

| [[Japanese]](/ja/contents/2020/JVNDB-2020-000045.html) | |
| --- | --- |
| JVNDB-2020-000045 | |
| SHIRASAGI vulnerable to open redirect | |
| Overview | |
| SHIRASAGI provided by SHIRASAGI Project contains an open redirect vulnerability (CWE-601). | |
| CVSS Severity ([What is CVSS?](/en/nav/jvndbhelp.html#jvndb3)) | |
| **CVSS V3 Severity:Base Metrics [4.7](/cvss/en/v3.html#CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:N/I:L/A:N) (Medium) [IPA Score]**  * Attack Vector: Network * Attack Complexity: Low * Privileges Required: None * User Interaction: Required * Scope: Changed * Confidentiality Impact: None * Integrity Impact: Low * Availability Impact: None  **CVSS V2 Severity:Base Metrics [4.3](/cvss/en/v2.html#AV:N/AC:M/Au:N/C:N/I:P/A:N) (Medium) [IPA Score]**  * Access Vector: Network * Access Complexity: Medium * Authentication: None * Confidentiality Impact: None * Integrity Impact: Partial * Availability Impact: None | |
| Affected Products | |
|  | |
| SHIRASAGI Project  * SHIRASAGI v1.13.1 and earlier | |
|  | |
| Impact | |
| When accessing a specially crafted URL, the user may be redirected to an arbitrary website. As a result, the user may become a victim of a phishing attack. | |
| Solution | |
| [Update the Software] | |
| Vendor Information | |
| SHIRASAGI Project  * GitHub : [SHIRASAGI](https://github.com/shirasagi/shirasagi) * GitHub : [[fix][cms] open redirect vulnerability on member login (#3646)](https://github.com/shirasagi/shirasagi/commit/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a) * GitHub : [[PATCH][fix][cms] open redirect vulnerability on member login (#3646)](https://github.com/shirasagi/shirasagi/commit/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a.patch) * SHIRASAGI Official Website : [Top Page](https://www.ss-proj.org) (in Japanese) * SHIRASAGI Official Website : [SHIRASAGI](https://www.ss-proj.org/release/778.html) (in Japanese) | |
| CWE ([What is CWE?](http://www.ipa.go.jp/security/english/vuln/CWE_en.html)) | |
| 1. [Improper Input Validation(CWE-20)](https://www.ipa.go.jp/en/security/vulnerabilities/cwe.html) [IPA Evaluation] | |
| CVE ([What is CVE?](http://www.ipa.go.jp/security/english/vuln/CVE_en.html)) | |
| 1. [CVE-2020-5607](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5607) | |
| References | |
| 1. JVN : [JVN#55657988](https://jvn.jp/en/jp/JVN55657988/index.html) 2. National Vulnerability Database (NVD) : [CVE-2020-5607](https://nvd.nist.gov/vuln/detail/CVE-2020-5607) | |
| Revision History | |
| * [2020/07/09] | |

| --- | |
| --- | --- |
| Date Public | 2020/07/09 |
| Date First Published | 2020/07/09 |
| Date Last Updated | 2020/07/09 |
| --- | |

* JVN
* [HOME](https://jvn.jp/en/)
* [What is JVN ?](https://jvn.jp/en/nav/jvn.html)
* [Instructions](https://jvn.jp/en/nav/jvnhelp.html)
* [List of Vulnerability Report](https://jvn.jp/en/report/index.html)
* [VN\_JP](https://jvn.jp/en/jp/index.html)
* [VN\_JP(Unreachable)](https://jvn.jp/en/adj/index.html)
* [VN\_VU](https://jvn.jp/en/vu/index.html)
* [TA](https://jvn.jp/en/ta/index.html)
* [TRnotes](https://jvn.jp/en/tr/index.html)
* [JVN iPedia](/en/)
* [Search](/search/index.php?mode=_vulnerability_search_IA_VulnSearch&lang=en)
* [What is JVN iPedia?](/en/nav/jvndb.html)
* [How to Use?](/en/nav/jvndbhelp.html)
* [MyJVN](/en/apis/myjvn/index.html)
* [JVNJS/RSS](https://jvn.jp/en/rss/index.html)
* [Vendor List](https://jvn.jp/en/nav/index.html)
* [List of unreachable developers](https://jvn.jp/en/reply/index.html)
* [Contact](https://jvn.jp/en/contact/index.html)

![Copyright © 2007- IPA. All rights reserved.](/common/img/copyright.png)



=== Content from jvn.jp_e1175206_20250119_112320.html ===


![Japan Vulnerability Notes](/common/img/note_logo.gif)

Published:2020/07/09  Last Updated:2020/07/09
# JVN#55657988 SHIRASAGI vulnerable to open redirect

## Overview

SHIRASAGI contains an open redirect vulnerability.

## Products Affected

* SHIRASAGI v1.13.1 and earlier

## Description

SHIRASAGI provided by SHIRASAGI Project contains an open redirect vulnerability ([CWE-601](//cwe.mitre.org/data/definitions/601.html)).

## Impact

When accessing a specially crafted URL, the user may be redirected to an arbitrary website. As a result, the user may become a victim of a phishing attack.

## Solution

**Update the Software**

Update to the latest version according to the information provided by the developer.

The vulnerability is fixed in v1.13.2.

## Vendor Status

| Vendor | Link |
| --- | --- |
| SHIRASAGI Project | [SHIRASAGI Official Website](https://www.ss-proj.org/) |
|  | [SHIRASAGI](https://github.com/shirasagi/shirasagi) |
|  | [[fix][cms] open redirect vulnerability on member login (#3646)](https://github.com/shirasagi/shirasagi/commit/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a) |
|  | [[PATCH][fix][cms] open redirect vulnerability on member login (#3646)](https://github.com/shirasagi/shirasagi/commit/040a02c9d4b5dd2f91c5c29c0008a47cde6ee99a.patch) |

## References

## JPCERT/CC Addendum

## Vulnerability Analysis by JPCERT/CC

CVSS v3
CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:N/I:L/A:N
Base Score:
4.7

| Attack Vector(AV) | Physical (P) | Local (L) | Adjacent (A) | Network (N) |
| --- | --- | --- | --- | --- |
| Attack Complexity(AC) | High (H) | Low (L) |
| Privileges Required(PR) | High (H) | Low (L) | None (N) |
| User Interaction(UI) | Required (R) | None (N) |
| Scope(S) | Unchanged (U) | Changed (C) |
| Confidentiality Impact(C) | None (N) | Low (L) | High (H) |
| Integrity Impact(I) | None (N) | Low (L) | High (H) |
| Availability Impact(A) | None (N) | Low (L) | High (H) |

CVSS v2
AV:N/AC:M/Au:N/C:N/I:P/A:N
Base Score:
4.3

| Access Vector(AV) | Local (L) | Adjacent Network (A) | Network (N) |
| --- | --- | --- | --- |
| Access Complexity(AC) | High (H) | Medium (M) | Low (L) |
| Authentication(Au) | Multiple (M) | Single (S) | None (N) |
| Confidentiality Impact(C) | None (N) | Partial (P) | Complete (C) |
| Integrity Impact(I) | None (N) | Partial (P) | Complete (C) |
| Availability Impact(A) | None (N) | Partial (P) | Complete (C) |

## Credit

Ryoya Koyama of Mitsui Bussan Secure Directions, Inc. reported this vulnerability to IPA.

JPCERT/CC coordinated with the developer under Information Security Early Warning Partnership.

## Other Information

| JPCERT Alert |  |
| --- | --- |
| JPCERT Reports |  |
| CERT Advisory |  |
| CPNI Advisory |  |
| TRnotes |  |
| CVE | [CVE-2020-5607](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5607) |
| JVN iPedia | [JVNDB-2020-000045](https://jvndb.jvn.jp/jvndb/JVNDB-2020-000045) |

* JVN
* [HOME](/en/index.html)
* [What is JVN ?](/en/nav/jvn.html)
* [Instructions](/en/nav/jvnhelp.html)
* [List of Vulnerability Report](/en/report/index.html)
* [VN\_JP](/en/jp/index.html)
* [VN\_JP(Unreachable)](/en/adj/index.html)
* [VN\_VU](/en/vu/index.html)
* [TA](/en/ta/index.html)
* [TRnotes](/en/tr/index.html)
* [JVN iPedia](http://jvndb.jvn.jp/en/)
* [MyJVN](http://jvndb.jvn.jp/en/apis/myjvn/index.html)
* [JVNJS/RSS](/en/rss/index.html)
* [Vendor List](/en/nav/index.html)
* [List of unreachable developers](/en/reply/index.html)
* [Contact](/en/contact/index.html)

Copyright (c) 2000-2020 JPCERT/CC and IPA. All rights reserved.



=== Content from github.com_5c8419f4_20250119_112317.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=shirasagi%2Fshirasagi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[shirasagi](/shirasagi)
/
**[shirasagi](/shirasagi/shirasagi)**
Public

* [Notifications](/login?return_to=%2Fshirasagi%2Fshirasagi) You must be signed in to change notification settings
* [Fork
  74](/login?return_to=%2Fshirasagi%2Fshirasagi)
* [Star
   110](/login?return_to=%2Fshirasagi%2Fshirasagi)

SHIRASAGI

[ss-proj.org/](http://ss-proj.org/ "http://ss-proj.org/")

### License

[MIT license](/shirasagi/shirasagi/blob/master/MIT-LICENSE)

[110
stars](/shirasagi/shirasagi/stargazers) [74
forks](/shirasagi/shirasagi/forks) [Branches](/shirasagi/shirasagi/branches) [Tags](/shirasagi/shirasagi/tags) [Activity](/shirasagi/shirasagi/activity)
 [Star](/login?return_to=%2Fshirasagi%2Fshirasagi)

 [Notifications](/login?return_to=%2Fshirasagi%2Fshirasagi) You must be signed in to change notification settings

* [Code](/shirasagi/shirasagi)
* [Issues
  415](/shirasagi/shirasagi/issues)
* [Pull requests
  62](/shirasagi/shirasagi/pulls)
* [Actions](/shirasagi/shirasagi/actions)
* [Projects
  0](/shirasagi/shirasagi/projects)
* [Wiki](/shirasagi/shirasagi/wiki)
* [Security](/shirasagi/shirasagi/security)
* [Insights](/shirasagi/shirasagi/pulse)

Additional navigation options

* [Code](/shirasagi/shirasagi)
* [Issues](/shirasagi/shirasagi/issues)
* [Pull requests](/shirasagi/shirasagi/pulls)
* [Actions](/shirasagi/shirasagi/actions)
* [Projects](/shirasagi/shirasagi/projects)
* [Wiki](/shirasagi/shirasagi/wiki)
* [Security](/shirasagi/shirasagi/security)
* [Insights](/shirasagi/shirasagi/pulse)

# shirasagi/shirasagi

    master[Branches](/shirasagi/shirasagi/branches)[Tags](/shirasagi/shirasagi/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[7,922 Commits](/shirasagi/shirasagi/commits/master/) | | |
| [.github](/shirasagi/shirasagi/tree/master/.github ".github") | | [.github](/shirasagi/shirasagi/tree/master/.github ".github") |  |  |
| [.travis.d](/shirasagi/shirasagi/tree/master/.travis.d ".travis.d") | | [.travis.d](/shirasagi/shirasagi/tree/master/.travis.d ".travis.d") |  |  |
| [.vscode](/shirasagi/shirasagi/tree/master/.vscode ".vscode") | | [.vscode](/shirasagi/shirasagi/tree/master/.vscode ".vscode") |  |  |
| [app](/shirasagi/shirasagi/tree/master/app "app") | | [app](/shirasagi/shirasagi/tree/master/app "app") |  |  |
| [bin](/shirasagi/shirasagi/tree/master/bin "bin") | | [bin](/shirasagi/shirasagi/tree/master/bin "bin") |  |  |
| [config](/shirasagi/shirasagi/tree/master/config "config") | | [config](/shirasagi/shirasagi/tree/master/config "config") |  |  |
| [db](/shirasagi/shirasagi/tree/master/db "db") | | [db](/shirasagi/shirasagi/tree/master/db "db") |  |  |
| [lib](/shirasagi/shirasagi/tree/master/lib "lib") | | [lib](/shirasagi/shirasagi/tree/master/lib "lib") |  |  |
| [log](/shirasagi/shirasagi/tree/master/log "log") | | [log](/shirasagi/shirasagi/tree/master/log "log") |  |  |
| [private](/shirasagi/shirasagi/tree/master/private "private") | | [private](/shirasagi/shirasagi/tree/master/private "private") |  |  |
| [public](/shirasagi/shirasagi/tree/master/public "public") | | [public](/shirasagi/shirasagi/tree/master/public "public") |  |  |
| [spec](/shirasagi/shirasagi/tree/master/spec "spec") | | [spec](/shirasagi/shirasagi/tree/master/spec "spec") |  |  |
| [vendor](/shirasagi/shirasagi/tree/master/vendor "vendor") | | [vendor](/shirasagi/shirasagi/tree/master/vendor "vendor") |  |  |
| [webpack](/shirasagi/shirasagi/tree/master/webpack "webpack") | | [webpack](/shirasagi/shirasagi/tree/master/webpack "webpack") |  |  |
| [.brakeman.yml](/shirasagi/shirasagi/blob/master/.brakeman.yml ".brakeman.yml") | | [.brakeman.yml](/shirasagi/shirasagi/blob/master/.brakeman.yml ".brakeman.yml") |  |  |
| [.codeclimate.yml](/shirasagi/shirasagi/blob/master/.codeclimate.yml ".codeclimate.yml") | | [.codeclimate.yml](/shirasagi/shirasagi/blob/master/.codeclimate.yml ".codeclimate.yml") |  |  |
| [.coveralls.yml](/shirasagi/shirasagi/blob/master/.coveralls.yml ".coveralls.yml") | | [.coveralls.yml](/shirasagi/shirasagi/blob/master/.coveralls.yml ".coveralls.yml") |  |  |
| [.eslintrc.js](/shirasagi/shirasagi/blob/master/.eslintrc.js ".eslintrc.js") | | [.eslintrc.js](/shirasagi/shirasagi/blob/master/.eslintrc.js ".eslintrc.js") |  |  |
| [.gitattributes](/shirasagi/shirasagi/blob/master/.gitattributes ".gitattributes") | | [.gitattributes](/shirasagi/shirasagi/blob/master/.gitattributes ".gitattributes") |  |  |
| [.gitignore](/shirasagi/shirasagi/blob/master/.gitignore ".gitignore") | | [.gitignore](/shirasagi/shirasagi/blob/master/.gitignore ".gitignore") |  |  |
| [.reviewdog.yml](/shirasagi/shirasagi/blob/master/.reviewdog.yml ".reviewdog.yml") | | [.reviewdog.yml](/shirasagi/shirasagi/blob/master/.reviewdog.yml ".reviewdog.yml") |  |  |
| [.rspec](/shirasagi/shirasagi/blob/master/.rspec ".rspec") | | [.rspec](/shirasagi/shirasagi/blob/master/.rspec ".rspec") |  |  |
| [.rubocop.yml](/shirasagi/shirasagi/blob/master/.rubocop.yml ".rubocop.yml") | | [.rubocop.yml](/shirasagi/shirasagi/blob/master/.rubocop.yml ".rubocop.yml") |  |  |
| [.rubocop\_todo.yml](/shirasagi/shirasagi/blob/master/.rubocop_todo.yml ".rubocop_todo.yml") | | [.rubocop\_todo.yml](/shirasagi/shirasagi/blob/master/.rubocop_todo.yml ".rubocop_todo.yml") |  |  |
| [.scss-lint.yml](/shirasagi/shirasagi/blob/master/.scss-lint.yml ".scss-lint.yml") | | [.scss-lint.yml](/shirasagi/shirasagi/blob/master/.scss-lint.yml ".scss-lint.yml") |  |  |
| [.tachikoma.yml](/shirasagi/shirasagi/blob/master/.tachikoma.yml ".tachikoma.yml") | | [.tachikoma.yml](/shirasagi/shirasagi/blob/master/.tachikoma.yml ".tachikoma.yml") |  |  |
| [.travis.yml](/shirasagi/shirasagi/blob/master/.travis.yml ".travis.yml") | | [.travis.yml](/shirasagi/shirasagi/blob/master/.travis.yml ".travis.yml") |  |  |
| [Gemfile](/shirasagi/shirasagi/blob/master/Gemfile "Gemfile") | | [Gemfile](/shirasagi/shirasagi/blob/master/Gemfile "Gemfile") |  |  |
| [Gemfile.lock](/shirasagi/shirasagi/blob/master/Gemfile.lock "Gemfile.lock") | | [Gemfile.lock](/shirasagi/shirasagi/blob/master/Gemfile.lock "Gemfile.lock") |  |  |
| [Guardfile](/shirasagi/shirasagi/blob/master/Guardfile "Guardfile") | | [Guardfile](/shirasagi/shirasagi/blob/master/Guardfile "Guardfile") |  |  |
| [MIT-LICENSE](/shirasagi/shirasagi/blob/master/MIT-LICENSE "MIT-LICENSE") | | [MIT-LICENSE](/shirasagi/shirasagi/blob/master/MIT-LICENSE "MIT-LICENSE") |  |  |
| [Procfile.dev](/shirasagi/shirasagi/blob/master/Procfile.dev "Procfile.dev") | | [Procfile.dev](/shirasagi/shirasagi/blob/master/Procfile.dev "Procfile.dev") |  |  |
| [README.md](/shirasagi/shirasagi/blob/master/README.md "README.md") | | [README.md](/shirasagi/shirasagi/blob/master/README.md "README.md") |  |  |
| [Rakefile](/shirasagi/shirasagi/blob/master/Rakefile "Rakefile") | | [Rakefile](/shirasagi/shirasagi/blob/master/Rakefile "Rakefile") |  |  |
| [config.ru](/shirasagi/shirasagi/blob/master/config.ru "config.ru") | | [config.ru](/shirasagi/shirasagi/blob/master/config.ru "config.ru") |  |  |
| [package.json](/shirasagi/shirasagi/blob/master/package.json "package.json") | | [package.json](/shirasagi/shirasagi/blob/master/package.json "package.json") |  |  |
| [postcss.config.js](/shirasagi/shirasagi/blob/master/postcss.config.js "postcss.config.js") | | [postcss.config.js](/shirasagi/shirasagi/blob/master/postcss.config.js "postcss.config.js") |  |  |
| [stylelint.config.cjs](/shirasagi/shirasagi/blob/master/stylelint.config.cjs "stylelint.config.cjs") | | [stylelint.config.cjs](/shirasagi/shirasagi/blob/master/stylelint.config.cjs "stylelint.config.cjs") |  |  |
| [webpack.config.js](/shirasagi/shirasagi/blob/master/webpack.config.js "webpack.config.js") | | [webpack.config.js](/shirasagi/shirasagi/blob/master/webpack.config.js "webpack.config.js") |  |  |
| [yarn.lock](/shirasagi/shirasagi/blob/master/yarn.lock "yarn.lock") | | [yarn.lock](/shirasagi/shirasagi/blob/master/yarn.lock "yarn.lock") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# SHIRASAGI

SHIRASAGI is Contents Management System.

## Code Status

[![Ruby](https://github.com/shirasagi/shirasagi/actions/workflows/ruby.yml/badge.svg)](https://github.com/shirasagi/shirasagi/actions/workflows/ruby.yml)
[![Coverage Status](https://camo.githubusercontent.com/d5c8cd5a09691993a1d48956d242963345f5ce206ef4a8dd6891f4474ba73e67/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f7368697261736167692f7368697261736167692f62616467652e706e67)](https://coveralls.io/r/shirasagi/shirasagi)
[![Code Climate](https://camo.githubusercontent.com/b39380cb995cb917fdc79edabafe31a89647d20f2753c9deecb530486eefde03/68747470733a2f2f6170692e636f6465636c696d6174652e636f6d2f76312f6261646765732f65363237343936356563373563653866643630352f746573745f636f766572616765)](https://codeclimate.com/github/shirasagi/shirasagi/test_coverage)
[![GitHub version](https://camo.githubusercontent.com/4c67d9df899c8114b63d2aad5441a2fb4f6928d33b833b8a030a63d7599b5fba/68747470733a2f2f62616467652e667572792e696f2f67682f7368697261736167692532467368697261736167692e737667)](http://badge.fury.io/gh/shirasagi/shirasagi)

## Documentation

* [公式サイト](http://ss-proj.org/)
  + [オンラインデモ](https://www.ss-proj.org/download/demo.html)
  + [ダウンロード](https://www.ss-proj.org/download/)
  + [よくある質問記事](https://www.ss-proj.org/faq/docs/)
* [開発マニュアル](http://shirasagi.github.io/)

## Platform

* AlmaLinux, RockyLinux, Ubuntu
* Ruby 3.1 or 3.2
* Ruby on Rails 7.1
* MongoDB 6.0 or 7.0
* Unicorn
* Node.js 20
* Elasticsearch 7.1

## Installation (Auto)

* AlmaLinux8 の環境で実行してください。
* 一般ユーザーで実行する場合はユーザーで実行する場合は、sudo が利用できることを確認してください。
* パラメーターの"example.jp"には、ブラウザでアクセスする際のドメイン名または、IPアドレスを指定してください。

```
$ su - user-which-executes-shirasagi-server
$ curl https://raw.githubusercontent.com/shirasagi/shirasagi/master/bin/install.sh | bash -s example.jp

```

## Installation (AlmaLinux)

* 本手順は簡易的に動作確認を行う為の最小構成の手順となります。
  正式にサービスとしてご利用の際は、フロントにNginx等のWEBサーバを立て、
  セキュリティに配慮した設定を実施頂くことを推奨いたします。

  Nginxの導入につきましては開発マニュアルの[Nginxのインストール](https://shirasagi.github.io/installation/nginx.html)
  をご確認ください。
* 拡張機能（ふりがな、読み上げ、オープンデータ等）や詳細なインストール手順は[開発マニュアル](http://shirasagi.github.io/)をご確認ください。

### パッケージのダウンロード

```
$ su -
# dnf -y install epel-release wget
# dnf config-manager --disable epel
# dnf --enablerepo=epel -y update epel-release
# dnf -y groupinstall "Development tools"
# dnf -y --enablerepo=epel,powertools install ImageMagick ImageMagick-devel openssl3

```

### MongoDB のインストール

```
$ su -
# vi /etc/yum.repos.d/mongodb-org-7.0.repo

```

```
[mongodb-org-7.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/7/mongodb-org/7.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://pgp.mongodb.com/server-7.0.asc

```

```
# dnf install -y --enablerepo=mongodb-org-7.0 mongodb-org
# systemctl start mongod
# systemctl enable mongod

```

### asdf のインストール

```
$ su -
# git clone https://github.com/asdf-vm/asdf.git ~/.asdf
# vi ~/.bashrc
---(追記)
. $HOME/.asdf/asdf.sh
. $HOME/.asdf/completions/asdf.bash
---
# source ~/.bashrc

```

### Ruby のインストール

```
$ su -
# asdf plugin add ruby
# asdf install ruby 3.2.5
# asdf global ruby 3.2.5

```

### Nodejs のインストール

```
$ su -
# asdf plugin add nodejs
# asdf install nodejs 20.17.0
# asdf global nodejs 20.17.0
# npm install -g yarn

```

### SHIRASAGI のインストール

SHIRASAGI のダウンロード (stable)

```
$ su -
# git clone -b stable https://github.com/shirasagi/shirasagi /var/www/shirasagi

```

設定ファイルの設置と gem のインストール

```
$ su -
# cd /var/www/shirasagi
# cp -n config/samples/*.{yml,rb} config/
# bundle install --without development test
# ./bin/deploy

```

Web サーバの起動

```
$ su -
# bundle exec rake unicorn:start

```

## サイトの作成

データベース（インデックス）の作成

```
$ su -
# bundle exec rake db:drop
# bundle exec rake db:create_indexes

```

新規サイトの追加

```
$ su -
# bundle exec rake ss:create_site data='{ name: "サイト名", host: "www", domains: "localhost:3000" }'

```

サンプルデータ (自治体サンプル) の投入

```
$ su -
# bundle exec rake db:seed name=demo site=www

```

## サイトの確認

#### 管理画面

<http://localhost:3000/.mypage> にアクセスするとログイン画面が表示されます。

サイト名のリンクをクリックすると、登録したデモデータを確認・編集することができます。

[ ユーザーID： admin , パスワード： pass ]

#### 公開画面

<http://localhost:3000/> にアクセスすると登録したデモサイトが表示されます。

## 開発・テスト環境

`.env`というファイルをプロジェクトルートに用意すれば各種設定をお好みのものに切り替えられます。

(設定例)

* デフォルトで`warn`になっているログレベルを`debug`にしたい場合。
* テスト時にデフォルトで実行されるカバレッジ計測を省きたい場合。

```
DEVELOPMENT_LOG_LEVEL=debug
ANALYZE_COVERAGE=disabled

```

## その他機能の利用方法

* [グループウェアの始め方](http://shirasagi.github.io/start/gws.html)
* [ウェブメールの始め方](http://shirasagi.github.io/start/webmail.html)

## About

SHIRASAGI

[ss-proj.org/](http://ss-proj.org/ "http://ss-proj.org/")

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/shirasagi/shirasagi/activity)
[Custom properties](/shirasagi/shirasagi/custom-properties)
### Stars

[**110**
stars](/shirasagi/shirasagi/stargazers)
### Watchers

[**19**
watching](/shirasagi/shirasagi/watchers)
### Forks

[**74**
forks](/shirasagi/shirasagi/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fshirasagi%2Fshirasagi&report=shirasagi+%28user%29)

## [Releases 69](/shirasagi/shirasagi/releases)

[v1.19.1
Latest

Oct 4, 2024](/shirasagi/shirasagi/releases/tag/v1.19.1)
[+ 68 releases](/shirasagi/shirasagi/releases)

## [Packages 0](/orgs/shirasagi/packages?repo_name=shirasagi)

No packages published

## [Contributors 39](/shirasagi/shirasagi/graphs/contributors)

[+ 25 contributors](/shirasagi/shirasagi/graphs/contributors)

## Languages

* [Ruby
  40.9%](/shirasagi/shirasagi/search?l=ruby)
* [JavaScript
  40.0%](/shirasagi/shirasagi/search?l=javascript)
* [HTML
  10.6%](/shirasagi/shirasagi/search?l=html)
* [Fluent
  3.6%](/shirasagi/shirasagi/search?l=fluent)
* [CSS
  2.7%](/shirasagi/shirasagi/search?l=css)
* [SCSS
  2.1%](/shirasagi/shirasagi/search?l=scss)
* [Shell
  0.1%](/shirasagi/shirasagi/search?l=shell)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


