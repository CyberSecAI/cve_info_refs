=== Content from gist.github.com_ebbbc71f_20250119_121609.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@ariard](https://avatars.githubusercontent.com/u/23310655?s=64&v=4)](/ariard)

# [ariard](/ariard)/**[public-report-HTLC-collision.txt](/ariard/6bdeb995565d1cc292753e1ee4ae402d)** Secret

Last active
June 18, 2022 03:14

Show Gist options

* [Download ZIP](/ariard/6bdeb995565d1cc292753e1ee4ae402d/archive/fbd2a5ef4523f3a9b7fc88577a547b20e6235a1c.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/ariard/6bdeb995565d1cc292753e1ee4ae402d.js&quot;&gt;&lt;/script&gt;
* Save ariard/6bdeb995565d1cc292753e1ee4ae402d to your computer and use it in GitHub Desktop.

[Code](/ariard/6bdeb995565d1cc292753e1ee4ae402d)
[Revisions
3](/ariard/6bdeb995565d1cc292753e1ee4ae402d/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/ariard/6bdeb995565d1cc292753e1ee4ae402d.js&quot;&gt;&lt;/script&gt;

Save ariard/6bdeb995565d1cc292753e1ee4ae402d to your computer and use it in GitHub Desktop.

[Download ZIP](/ariard/6bdeb995565d1cc292753e1ee4ae402d/archive/fbd2a5ef4523f3a9b7fc88577a547b20e6235a1c.zip)

 [Raw](/ariard/6bdeb995565d1cc292753e1ee4ae402d/raw/fbd2a5ef4523f3a9b7fc88577a547b20e6235a1c/public-report-HTLC-collision.txt)

[**public-report-HTLC-collision.txt**](#file-public-report-htlc-collision-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | # Problem |
| --- | --- |
|  |  |
|  | In case of a relayed HTLC hash-and-amount collisioning with a expected payment HTLC on the same |
|  | channel, LND was releasing the preimage for the later while claiming onchain the former. A malicious |
|  | peer could have deliberatelt intercept a HTLC intended for the victim node, probe the victim to learn |
|  | the preimage and steal the intercepted HTLC. |
|  |  |
|  | Prior to v0.11, LND had a vulnerability in its invoice database while claiming onchain a received |
|  | HTLC output, it didn't verify that the corresponding outgoing off-chain HTLC was already settled |
|  | before releasing the preimage. In case of hash-and-amount collision with an invoice, the preimage |
|  | for an expected payment was instead released. A malicious peer could have deliberately intercept |
|  | a HTLC intended for the victim node, probe the preimage through a colluding relayed HTLC and steal |
|  | the intercepted HTLC. |
|  |  |
|  | Note that MPP payments (invoices with `s` field`) aren't subjects to this vulnerability as an attacker |
|  | wouldn't have the payment secret to authenticate the probe HTLC. |
|  |  |
|  | This vulnerability was exposing routing nodes also receiving payments. A peer servicing as an |
|  | intermediary hop of a payment path could have guess that the next hop is a the final receiver |
|  | by comparing the HTLC's `amount\_msat` with any goods/services advertised by the victim node |
|  | merchant website. This is not affecting non-routing nodes. |
|  |  |
|  | # Solution |
|  |  |
|  | The current spec requiremet is the following : |
|  |  |
|  | "A local node if it receives (or already posseses) a payment preimage for an unresolved HTLC output |
|  | that it has been offered AND for which is it has committed to an outoing HTLC MUST resolve the |
|  | output by spending it, using the HTLC-Success transaction". |
|  |  |
|  | This point could be clearer and precise the risk of HTLC hash-and-amount collision. |
|  | "MUST NOT reveal a preimage for an incoming HTLC if it has not learnt the preimage for the |
|  | claiming of the outgoing HTLC" |
|  |  |
|  | That said, with the deployment of `payment\_secret`, this specific risk should be less of a concern. |
|  |  |
|  | # Background |
|  |  |
|  | Alice, a merchant, is sending an invoice for amount A and hash H to Bob. |
|  |  |
|  | Bob is routing the HTLC A/H to Alice through Mallory. |
|  |  |
|  | Channel topology [0] |
|  |  |
|  |  |
|  | HTLC (A,H') HTLC (A,H') HTLC (A,H) |
|  | \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ |
|  | / \ / \ / \ |
|  | V \ V \ V \ |
|  | Mallet <-----------> Alice <------------> Mallory <-----------> Bob |
|  | \ ^ |
|  | \\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_/ |
|  |  |
|  | invoice (A,H) |
|  |  |
|  | Mallory intercepts HTLC (A,H) from Bob and doesn't relay it forward. Mallory, knowing that Alice |
|  | node pubkey is tied to a merchant node, is browsing through her goods/services index to decide |
|  | if Bob's HTLC is intended for Alice by comparing the relayed amount with the price of an item. |
|  |  |
|  | If there is a match, more-or-less some noise of sats, Mallory draws a new payment path to Mallet, |
|  | a colluding node. Mallory sends a HTLC (A,H') to Alice, which relays it forward to Mallet. |
|  |  |
|  | Mallet holds the HTLC and doesn't it immediately. Instead, Mallet route back a new HTLC Y to |
|  | Mallory through Alice. This HTLC Y won't be failed by Mallory, thus forcing Alice to force-close |
|  | the channel when HTLC Y off-chain settlement deadline is crossed. |
|  |  |
|  | Alice goes onchain with her commitment for chan Alice-Mallory. She claims back offered output for |
|  | HTLC Y and received output for HTLC H'. She reveals preimage P, with H'=sha256(P) equivalent to |
|  | H=sha256(P). |
|  |  |
|  | Mallory learns preimage P onchain and sends it out-of-band to Mallet which claims the incoming |
|  | HTLC H' from Alice. Mallory claims the previously intercepted HTLC H from Bob. |
|  |  |
|  | Bob learns the preimage P. |
|  |  |
|  | The coalition Mallet and Mallory gain the value of HTLC H minus Alice's routing fee for HTLC H'. |
|  | Also, they may have pay the channels opening/closing fees depending on who initiates. |
|  |  |
|  | Alice reveals a preimage P which corresponds to a provided good/service without receiving the |
|  | payment for it, thus being at loss. |
|  |  |
|  | Alice might not have learnt about her loss until reconciliating her merchant inventory with |
|  | her HTLC accounting, thus this exploitation might have been stay stealth for a while. |
|  |  |
|  | # Discovery |
|  |  |
|  | While working on Rust-Lightning, I observed that the specification was silent on the risk of |
|  | hash collision during the onchain operations. I surveyd deployed Lightning implmentations on this |
|  | behavior. A quick manual test against LND (65f5119) confirmed this vulnerability, which has |
|  | been immediately disclosed to LND team. |
|  |  |
|  | We agreed for a 6-month embargo period, as at that time a LND release (0.10) was |
|  | undergoing and it was too late to implement a covert fix in this release. |
|  |  |
|  | If this vulnerability has been exploited, the original sender would have discovered the preimage, |
|  | according to the pre-agreed invoice but without the issuer effectively being paid. In case of legal |
|  | disagreement if the corresponding good/service should be settled, and assuming parties were subject |
|  | to the same juridiction, it could have been an interesting case to decide if the invoice/preimage pair |
|  | is legally binding. |
|  |  |
|  | # Timeline |
|  |  |
|  | 2020-04-19: Vulnerability discovered, LND team notified |
|  | 2020-04-29: lnd v0.10.0-beta released (without fix) |
|  | 2020-07-31: lnd v0.11-0-beta released (with fix) |
|  | 2020-10-08: Partial Disclosure, encouraging lnd users to upgrade to lnd v0.11.x ASAP |
|  | 2020-10-20: Full Disclosure |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fariard%2F6bdeb995565d1cc292753e1ee4ae402d)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.linuxfoundation.org_4f9c917a_20250119_121613.html ===
From conner at lightning.engineering Tue Oct 20 21:52:29 2020
From: conner at lightning.engineering (Conner Fromknecht)
Date: Tue, 20 Oct 2020 14:52:29 -0700
Subject: [Lightning-dev] CVE-2020-26896: LND Invoice Preimage Extraction
Message-ID:
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
Hi all,
Today we are writing to disclose the details of CVE-2020-26896 as a follow up to
the partial disclosure sent to lightning-dev [1].
## Abstract
Prior to v0.11.0-beta, an lnd node could be coerced into revealing an invoice
preimage for a forwarded HTLC with a colliding payment hash. This can be
exploited to a) weaken the victim's receiver privacy by confirming the
destination of an HTLC, and/or b) under certain circumstances, result in loss of
funds to the victim by believing the invoice was paid when it only received
routing fees. We have no evidence of either case being exploited in the wild.
It affects routing nodes, i.e. any lnd node that permits HTLC forwarding and
operates as any form of merchant node (accepts payment for goods & services);
nodes that use rejecthtlc=1 are not affected.
The vulnerability was reported privately to the lnd team by Antoine Riard.
## Background
When resolving incoming HTLCs on-chain, the forwarding node is expected to
supply a valid preimage via the witness in order to claim the HTLC. Preimages
can be learned in two primary ways: by generating an invoice or receiving a
preimage as the result of a successfully forwarded HTLC. Internally, lnd tracks
these differing preimage classes in two distinct places: an invoice database and
a preimage database.
For proper handling, a node should inspect the off-chain HTLC it received to
determine whether the node was an intermediary or the final hop (indicated by an
all zeros next\_hop short channel id). Final hops are intended to consult the
invoice database for preimages, while intermediaries should consult the preimage
database.
Earlier versions of lnd would incorrectly fallback to the invoice database if
the preimage database did not contain the preimage. This resulted in situations
where the node would reveal an invoice preimage, even though the victim was not
the final hop in a route.
In coordination with a triggered channel closure, an attacker can construct a
malicious HTLC through the victim, divulging the target invoice preimage
on-chain when the incoming HTLCis claimed. After disclosing the preimage, an
attacker can claim a concurrent outgoing HTLC whose CLTV has not yet expired.
his results in the HTLC's value being stolen, minus routing fees, since the
victim incorrectly believes they received the payment.
## Attack Scenario
An example of the attack goes as follows:
Assume a \_real HTLC\_ is routed to a malicious node, Malice, that has a channel
with sufficient outgoing bandwidth to forward to the victim, Bob, the intended
receiver of the payment.
Instead of forwarding the real HTLC, Malice creates a new \_malicious HTLC\_ which
has the same payment hash. The first hop?s amount should be equal or slightly
larger, the CLTV can be increased as desired up to default implementation
limits.
Malice forwards the malicious HTLC in a circular route through Bob and back to
herself, where she holds the malicious HTLC.
With the malicious HTLC locked in place, Malice triggers a unilateral close of
the Malice-Bob channel. The commitment played (from Bob?s POV) has an incoming
HTLC with the target invoice?s payment hash. The unilateral closure should be
initiated well before any of the malicious HTLC?s CLTVs expire, otherwise the
last channel in the route will also go to chain.
When the unilateral close is confirmed, Bob will promptly broadcast the
HTLC-success transaction for the malicious HTLC. Due to the bug, the preimage
provided to sweep the malicious HTLC is obtained from the invoice database as a
fallback to the (forwarded) preimage database, rather than being ignored.
The victim, Bob, has already marked the invoice settled and published the
preimage on-chain. However, the malicious HTLC is still active on Bob?s
downstream channel (and the rest of the circular route), allowing Malice to
settle the malicious HTLC she holds \_after\_ the invoice has already been marked
paid. This results in Bob only receiving routing fees, and the Malice
redirecting the payment to herself, while simultaneously convincing Bob of
receiving the full payment.
At this point, the malicious HTLC has been successfully pulled from Malice to
herself in a circular route, making herself whole minus routing fees (in
addition to chain fees if she was the initiator of the Malice-Bob channel).
Malice then settles the real, intercepted HTLC using the same preimage to obtain
a profit.
### Caveats
For the attack to succeed, Malice must intercept a legacy HTLC or a
single-sharded MPP HTLC. If any other concurrent MPP shard has already reached
Bob before attempting to claim on-chain, the attack will fail due to additional
safety checks added to lnd [2], preventing an invoice from being settled by a
downgraded HTLC after it has already accepted an MPP shard with a valid payment
secret.
In order to directly profit from the attack, Malice must be intercepting a
payment from an unsuspecting victim, limiting control of timing and the amount
that can be siphoned. Malice must also somehow infer or guess that Bob has the
corresponding invoice being paid.
If Malice runs the same attack without intercepting a real HTLC, she pays
routing fees, and possibly chain fees, in exchange for the invoice preimage and
identity of the receiver. However, it is possible for her to indirectly profit
from this if the service provider releases tangible goods or services to anyone
with knowledge of the invoice preimage, which is not recommended in practice.
The upstream attacker does not need to be adjacent, they only need to know which
channel to target and watch for closure. Being adjacent increases the
assuredness of pulling off an exploit, but is not strictly required.
Similarly, the downstream attacker (possibly distinct from Malice) does not need
to be adjacent, they can settle the malicious HTLC further downstream to the
same effect at the cost of more routing fees.
## Patch
This vulnerability was patched in lnd v0.11.0-beta, by properly isolating the
preimage database from the invoice database according to the HTLC's next\_hop
field in commit cf739f3f [3] of PR 4157 [4]. The isolation ensures that we can
only claim forwarded HTLCs as a result of learning the preimage from an outgoing
HTLC. It also fixes the privacy leak by not revealing invoice preimages unless
the node is the final destination.
Due to the complexities involved in describing vulnerabilities over textual
mediums, the full nature of the issue wasn?t fully understood until after
v0.10.0-beta had been released. Additionally, the covert fix contained in the
v0.11.0-beta release was pushed back due to a concurrent investigation into
network instabilities resulting in unexpected channel closures.
Note, although the above patch fixes the issue, this issue could have also been
avoided by having receivers require payment secrets (BOLT 11 `s` field) since
the attackers would be unable to guess the payment secret. However, left as
optional, the attacker can always downgrade to using malicious HTLCs that omit
the payment secret.
For some time we have debated flipping the switch on requiring payment secrets
across the three major implementations. This vulnerability is further evidence
to the additional safety and privacy benefits. Now almost a year since the
initial deployment of payment secrets in lnd, the upcoming v0.12.0-beta release
of lnd is likely to make payment secrets required by default. We would welcome
other implementations to do the same.
## Timeline
04/19/2020 - Initial report from Antoine Riard
04/29/2020 - lnd v0.10.0-beta released
07/07/2020 - PR 4157 merged into master
08/20/2020 - lnd v0.11.0-beta released
10/08/2020 - Partial Disclosure sent to lightning-dev and lnd mailing list [1]
10/20/2020 - Full Disclosure sent to lightning-dev and lnd mailing list
## References
[1] https://lists.linuxfoundation.org/pipermail/lightning-dev/2020-October/002819.html
[2] https://github.com/lightningnetwork/lnd/blob/9f32942a90bcd91cc37a4a9c6c2fb454f534a65d/invoices/update.go#L229
[3] https://github.com/lightningnetwork/lnd/pull/4157/commits/cf739f3f87fdcb28ab45dfd48e3d18adf26e45b3
[4] https://github.com/lightningnetwork/lnd/pull/4157
[5] https://gist.github.com/ariard/6bdeb995565d1cc292753e1ee4ae402d
A big thank you to Antoine for the responsible disclosure and for helping to
make lnd more safu. More information can be found in Antoine?s disclosure [5].
Regards,
Conner Fromknecht
-----BEGIN PGP SIGNATURE-----
iQIzBAEBCAAdFiEEnI1hhop8SSADsnRO59c3tn+lkscFAl+PWzMACgkQ59c3tn+l
kseIJw//UwswUyh6BNgmi4D8NoC6olelW0dRmecqcZF7JBQa619kVFm/D7rixp33
J1YsXvZC2OLTpqmaJcJ3OvBKLVcW7CxheDp3Pm0JjrfVnmOl1NGX4CSymL6Zpou7
nFqh+nqOZ2n6o4OIv+mx0y2YANKjAVtAcr9LakubMn/3LgYzqvKKu39QGqrtz9vZ
lYGAAPU3zlAjIjFNv56xWpF0Pj9VE2mQB27w2QmbSuNtR21feOSJhJimEvmXhk6d
O0Ze78Fea+eaS+d1uyRkB7aaEKBRAA5WCtDKgSOwfEY+mHC7u5+LRasyegjlc8Ie
hYBNOsjEZqVjwIgr+lqMDbQ8B5RtW4LVro/LMYGCbVRnGuF16gHu/lkDnVgz/sY7
sbsPVG11wfVFH0U/TyJoBC8qOmeHMJoVsvGbY9I2XQiFw7yAbWxEdU+7mMhQZA2Z
Zd9pl0ATByLFPyg58gA6G4JV+F45DvYrG3jj6cdkUvL2nQST08IZtTjnDxAnkDTk
HwnJo0fd7vsixEyssTMuSCjbGSaPDMPCkmNQg8PAhhoIK8MeKUlylCKJuM6gMWeW
YypzGBmE6O7OtoMTOYFWysU67edVXgQTV2dD/PE6abTYOfS79gvkNekU4BvW9NDE
af0JBywXovzNVshdqpijPBleOT8/QSyTdLvI78ev+zpJMsKMugU=
=PY6W
-----END PGP SIGNATURE-----


=== Content from lists.linuxfoundation.org_460efa49_20250119_121612.html ===
From antoine.riard at gmail.com Tue Oct 20 22:05:18 2020
From: antoine.riard at gmail.com (Antoine Riard)
Date: Tue, 20 Oct 2020 18:05:18 -0400
Subject: [Lightning-dev] Full Disclosure: CVE-2020-26896 LND "The (un)covert
channel"
Message-ID:
# Problem
In case of a relayed HTLC hash-and-amount collision with an expected
payment HTLC on the same channel, LND was releasing the preimage for the
later while claiming onchain the former. A malicious peer could have
deliberately intercepted a HTLC intended for the victim node, probe the
victim to learn the preimage and steal the intercepted HTLC.
Prior to v0.11, LND had a vulnerability in its invoice database while
claiming onchain a received HTLC output, it didn't verify that the
corresponding outgoing off-chain HTLC was already settled before releasing
the preimage. In case of hash-and-amount collision with an invoice, the
preimage for an expected payment was instead released. A malicious peer
could have deliberately intercept a HTLC intended for the victim node,
probe the preimage through a colluding relayed HTLC and steal the
intercepted HTLC.
Note that MPP payments (invoices with `s` field`) aren't subject to this
vulnerability as an attacker wouldn't have the payment secret to
authenticate the probe HTLC. As of today, this class of invoices isn?t
well-deployed as it outlaws non-upgraded payers.
This vulnerability was exposing routing nodes also receiving payments (e.g
merchant nodes). A peer servicing as an intermediary hop of a payment path
could have guessed that the next hop is the final receiver by comparing the
HTLC's `amount\_msat` with any goods/services advertised by the victim node
merchant website. This is not affecting non-routing nodes.
Note, this is a case of \_indirect\_ fund loss of which the exploitation
scope depends on application logic. As the invoice state would have been
marked as settled, an application directly subscribing to it might have
automatically released the offered good/service. Otherwise, the loss may
have been characterized if the preimage had a direct liquid value (e.g
atomic data exchange where the preimage is a decryption key).
# Solution
The current spec requirement is the following :
"A local node if it receives (or already possesses) a payment preimage for
an unresolved HTLC output that it has been offered AND for which it has
committed to an outgoing HTLC MUST resolve the output by spending it, using
the HTLC-Success transaction".
This point could be clearer and precise the risk of HTLC hash-and-amount
collision : "MUST NOT reveal a preimage for an incoming HTLC if it has not
learnt the preimage for the claiming of the outgoing HTLC" [0]
I engage the LN ecosystem to consider the mandatory deployment of
`payment\_secret`, reducing the surface for this class of bugs, among other
benefits.
# Background
Alice, a merchant, is sending an invoice for amount A and hash H to Bob.
Bob is routing the HTLC A/H to Alice through Mallory.
Channel topology [0]
HTLC (A,H') HTLC (A,H') HTLC (A,H)
\_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_
/ \ / \ / \
V \ V \ V \
Mallet <-----------> Alice <------------> Mallory <-----------> Bob
\ ^
\\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_/
invoice (A,H)
Mallory intercepts HTLC (A,H) from Bob and doesn't relay it forward.
Mallory, knowing that Alice node pubkey is tied to a merchant node, is
browsing through her goods/services index to decide if Bob's HTLC is
intended for Alice by comparing the relayed amount with the price of an
item.
If there is a match, more-or-less some noise of sats, Mallory draws a new
payment path to Mallet, a colluding node. Mallory sends a HTLC (A,H') to
Alice, which relays it forward to Mallet.
Mallet holds the HTLC and doesn't do it immediately. Instead, Mallet routes
back a new HTLC Y to Mallory through Alice. This HTLC Y won't be failed by
Mallory, thus forcing Alice to force-close the channel when HTLC Y
off-chain settlement deadline is crossed.
Alice goes onchain with her commitment for chan Alice-Mallory. She claims
back offered output for HTLC Y and received output for HTLC H'. She reveals
preimage P, with H'=sha256(P) equivalent to H=sha256(P).
Mallory learns preimage P onchain and sends it out-of-band to Mallet which
claims the incoming HTLC H' from Alice. Mallory claims the previously
intercepted HTLC H from Bob.
Bob learns the preimage P.
The coalition Mallet and Mallory gain the value of HTLC H minus Alice's
routing fee for HTLC H'. Also, they may have to pay the channels
opening/closing fees depending on who initiates.
Alice reveals a preimage P which corresponds to a provided good/service
without receiving the payment for it, thus being at loss.
Alice might not have learnt about her loss until reconciling her merchant
inventory with her HTLC accounting, thus this exploitation might have been
stealth for a while.
# Discovery
While working on Rust-Lightning, I observed that the specification was
silent on the risk of hash collision during the onchain operations. I
surveyed deployed Lightning implementations on this behavior. A quick
manual test against LND (65f5119) confirmed this vulnerability, which has
been immediately disclosed to the LND team.
We agreed for a 6-month embargo period, as at that time a LND release
(0.10) was undergoing and it was too late to implement a covert fix in this
release.
If this vulnerability has been exploited, the original sender would have
discovered the preimage, according to the pre-agreed invoice but without
the issuer effectively being paid. In case of legal disagreement if the
corresponding good/service should be settled, and assuming parties were
subject to the same jurisdiction, it could have been an interesting case to
decide if the invoice/preimage pair is legally binding.
# Timeline
2020-04-19: Vulnerability discovered, LND team notified
2020-04-29: lnd v0.10.0-beta released (without fix)
2020-07-31: lnd v0.11-0-beta released (with fix)
2020-10-08: Partial Disclosure, encouraging lnd users to upgrade to lnd
v0.11.x ASAP
2020-10-09: CVE assigned (
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-26896)
200-10-15: Preventive Disclosure to c-lightning, Electrum and Eclair teams
2020-10-20: Full Disclosure
[0] See gist if it doesn?t survive ML formatting:
https://gist.github.com/ariard/42935dd26ccf88cea7b91505c3d59d63
-------------- next part --------------
An HTML attachment was scrubbed...
URL:

