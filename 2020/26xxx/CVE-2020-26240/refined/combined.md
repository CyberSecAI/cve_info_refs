=== Content from github.com_91f788cf_20250119_122206.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fcommit%2Fd990df909d7839640143344e79356754384dcdd0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fcommit%2Fd990df909d7839640143344e79356754384dcdd0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ethereum%2Fgo-ethereum)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ethereum](/ethereum)
/
**[go-ethereum](/ethereum/go-ethereum)**
Public

* [Notifications](/login?return_to=%2Fethereum%2Fgo-ethereum) You must be signed in to change notification settings
* [Fork
  20.4k](/login?return_to=%2Fethereum%2Fgo-ethereum)
* [Star
   48.2k](/login?return_to=%2Fethereum%2Fgo-ethereum)

* [Code](/ethereum/go-ethereum)
* [Issues
  192](/ethereum/go-ethereum/issues)
* [Pull requests
  101](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects
  0](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

Additional navigation options

* [Code](/ethereum/go-ethereum)
* [Issues](/ethereum/go-ethereum/issues)
* [Pull requests](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

## Commit

[Permalink](/ethereum/go-ethereum/commit/d990df909d7839640143344e79356754384dcdd0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

consensus/ethash: use 64bit indexes for the DAG generation ([#21793](https://github.com/ethereum/go-ethereum/pull/21793))

[Browse files](/ethereum/go-ethereum/tree/d990df909d7839640143344e79356754384dcdd0)
Browse the repository at this point in the history

```
* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
```

* Loading branch information

[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&v=4)](/shrikus)

[slavikus](/ethereum/go-ethereum/commits?author=slavikus "View all commits by slavikus")
and
[shrikus](/ethereum/go-ethereum/commits?author=shrikus "View all commits by shrikus")
authored
Nov 11, 2020

1 parent
[27d93c1](/ethereum/go-ethereum/commit/27d93c1848846b75d0e67fcac284a0d417acd47c)

commit d990df9

Showing
**1 changed file**
with
**5 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

10 changes: 5 additions & 5 deletions

10
[consensus/ethash/algorithm.go](#diff-9fdae72e50f2d2deb85a6a2961be950c7316d39f25dd22d60a169678dfe7b3cf "consensus/ethash/algorithm.go")

Show comments

[View file](/ethereum/go-ethereum/blob/d990df909d7839640143344e79356754384dcdd0/consensus/ethash/algorithm.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -304,16 +304,16 @@ func generateDataset(dest []uint32, epoch uint64, cache []uint32) { |
|  |  | keccak512 := makeHasher(sha3.NewLegacyKeccak512()) |
|  |  |  |
|  |  | // Calculate the data segment this thread should generate |
|  |  | batch := uint32((size + hashBytes\*uint64(threads) - 1) / (hashBytes \* uint64(threads))) |
|  |  | first := uint32(id) \* batch |
|  |  | batch := (size + hashBytes\*uint64(threads) - 1) / (hashBytes \* uint64(threads)) |
|  |  | first := uint64(id) \* batch |
|  |  | limit := first + batch |
|  |  | if limit > uint32(size/hashBytes) { |
|  |  | limit = uint32(size / hashBytes) |
|  |  | if limit > size/hashBytes { |
|  |  | limit = size / hashBytes |
|  |  | } |
|  |  | // Calculate the dataset segment |
|  |  | percent := size / hashBytes / 100 |
|  |  | for index := first; index < limit; index++ { |
|  |  | item := generateDatasetItem(cache, index, keccak512) |
|  |  | item := generateDatasetItem(cache, uint32(index), keccak512) |
|  |  | if swapped { |
|  |  | swap(item) |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d990df9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fcommit%2Fd990df909d7839640143344e79356754384dcdd0) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from avatars.githubusercontent.com_b8896e94_20250119_140036.html ===
ÔøΩÔøΩÔøΩÔøΩ ÔøΩ  

 $.' ",#(7),01444'9=82<.342 
2!!22222222222222222222222222222222222222222222222222ÔøΩÔøΩ  ( (" ÔøΩÔøΩÔøΩ          
   } !1AQa"q2ÔøΩÔøΩÔøΩ#BÔøΩÔøΩRÔøΩÔøΩ$3brÔøΩ
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ       
  w !1AQaq"2ÔøΩBÔøΩÔøΩÔøΩÔøΩ #3RÔøΩbrÔøΩ
$4ÔøΩ%ÔøΩ&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyzÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ   ? ÀäÔøΩVK}ÔøΩÔøΩgsÔøΩU5f$ÔøΩP\HbÔøΩ,X,ÔøΩ"ÔøΩ‹ÑRIÔøΩGÔøΩÔøΩÔøΩÔøΩQ’öRÔøΩÔøΩÔøΩeÔøΩÔøΩÔøΩYÔøΩÔøΩ…åÔøΩÔøΩ8ÔøΩÔøΩEpÔøΩ\*ÔøΩH=ÔøΩvVÔøΩ/ÔøΩÔøΩÔøΩÔøΩÔøΩQ 8ÔøΩÔøΩjÔøΩÔøΩFAÔøΩÔøΩÔøΩXWÔøΩÔøΩ\_ÔøΩ\*!UÔøΩkÔøΩÔøΩ ÔøΩÔøΩJÔøΩœ£V7ÔøΩN\*7F3ÔøΩÔøΩJgÔøΩWÔøΩ\*=ÔøΩG!,K“¨ÔøΩZ|ÔøΩ,ÔøΩfÔøΩÔøΩÔøΩWÔøΩÔøΩÔøΩ0ÔøΩÔøΩV
œà!ÔøΩÔøΩR
ÔøΩÔøΩ{ÔøΩÔøΩÔøΩÔøΩÔøΩ <ÔøΩmÔøΩÔøΩÔøΩÔøΩƒö,ÔøΩ^ÔøΩÔøΩ.ÔøΩÔøΩ–¨ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÂäâ;ÔøΩBÔøΩjE/jUÔøΩÔøΩ0ÔøΩŸñB%,8w'ÔøΩmÔøΩ}ÔøΩ◊≤M;ÔøΩÔøΩBÔøΩz:ÔøΩÔøΩjÔøΩÔøΩÔøΩÔøΩCLÔøΩwÔøΩÔøΩÔøΩ4ÔøΩXÔøΩÔøΩ 7l~UÔøΩÔøΩÔøΩY”≠ÔøΩrÔøΩ 7)1du9ÔøΩÔøΩÔøΩ#ÔøΩVpVÔøΩÔøΩÔøΩÔøΩsÔøΩXÔøΩjÔøΩÔøΩkÔøΩÔøΩvÔøΩ ÔøΩ  ÔøΩ}ÔøΩÔøΩÔøΩÔøΩ÷≠ÔøΩaÔøΩÔøΩÔøΩÔøΩÔøΩ: $ÔøΩÔøΩgÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ?ÔøΩ Ìï∑ÔøΩÔøΩZÔøΩÔøΩ5ÔøΩ #◊á?ÔøΩÔøΩ?ÔøΩckÔøΩÔøΩÔøΩÔøΩÔøΩLÔøΩDÔøΩ ÔøΩ1YZÔøΩÔøΩpOÔøΩÔøΩ#ÔøΩKF\_\*ÔøΩ7\ÔøΩÔøΩÔøΩÔøΩ√øÔøΩknOÔøΩ>ÔøΩÔøΩÔøΩÔøΩÔøΩ/ÔøΩÔøΩÔøΩTÔøΩ3GÔøΩOb4?jÔøΩTiÔøΩÔøΩÔøΩÔøΩrHÔøΩ''ÔøΩÔøΩÔøΩSÔøΩÔøΩÔøΩJÔøΩ>?ÔøΩ ÔøΩÔøΩ\v?ÔøΩÔøΩ

=== Content from github.com_847355d9_20250119_122209.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fsecurity%2Fadvisories%2FGHSA-v592-xf75-856p)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fsecurity%2Fadvisories%2FGHSA-v592-xf75-856p)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=ethereum%2Fgo-ethereum)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ethereum](/ethereum)
/
**[go-ethereum](/ethereum/go-ethereum)**
Public

* [Notifications](/login?return_to=%2Fethereum%2Fgo-ethereum) You must be signed in to change notification settings
* [Fork
  20.4k](/login?return_to=%2Fethereum%2Fgo-ethereum)
* [Star
   48.2k](/login?return_to=%2Fethereum%2Fgo-ethereum)

* [Code](/ethereum/go-ethereum)
* [Issues
  192](/ethereum/go-ethereum/issues)
* [Pull requests
  101](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects
  0](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

Additional navigation options

* [Code](/ethereum/go-ethereum)
* [Issues](/ethereum/go-ethereum/issues)
* [Pull requests](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

# Ethash DAG generation bug can cause miners to create invalid PoW

Moderate

[holiman](/holiman)
published
GHSA-v592-xf75-856p
Nov 24, 2020

## Package

go-ethereum
(golang)

## Affected versions

<1.9.24

## Patched versions

1.9.24

## Description

### Impact

An ethash mining DAG generation flaw in Geth could cause miners to erroneously calculate PoW in an upcoming epoch (estimated early January, 2021). This happened on the ETC chain on 2020-11-06. This issue is relevant only for miners, non-mining nodes are unaffected.

### Patches

This issue is also fixed as of 1.9.24. Thanks to [@slavikus](https://github.com/slavikus) for bringing the issue to our attention and writing the fix.

### Workarounds

This PR implements a patch: [#21793](https://github.com/ethereum/go-ethereum/pull/21793)

### References

<https://blog.ethereum.org/2020/11/12/geth_security_release/>

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [go-ethereum](https://github.com/ethereum/go-ethereum)
* Email us at security@ethereum.org

### Severity

Moderate

### CVE ID

CVE-2020-26240

### Weaknesses

No CWEs

### Credits

* [![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&v=4)](/slavikus)
  [slavikus](/slavikus)
  Analyst

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_fe5a9e0b_20250119_122208.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fpull%2F21793)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fpull%2F21793)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=ethereum%2Fgo-ethereum)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ethereum](/ethereum)
/
**[go-ethereum](/ethereum/go-ethereum)**
Public

* [Notifications](/login?return_to=%2Fethereum%2Fgo-ethereum) You must be signed in to change notification settings
* [Fork
  20.4k](/login?return_to=%2Fethereum%2Fgo-ethereum)
* [Star
   48.2k](/login?return_to=%2Fethereum%2Fgo-ethereum)

* [Code](/ethereum/go-ethereum)
* [Issues
  192](/ethereum/go-ethereum/issues)
* [Pull requests
  101](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects
  0](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

Additional navigation options

* [Code](/ethereum/go-ethereum)
* [Issues](/ethereum/go-ethereum/issues)
* [Pull requests](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fethereum%2Fgo-ethereum%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fethereum%2Fgo-ethereum%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# consensus/ethash: use 64bit indexes for the DAG generation #21793

 Merged

[holiman](/holiman)
merged 2 commits into
[ethereum:master](/ethereum/go-ethereum/tree/master "ethereum/go-ethereum:master")
from
2miners:master

Nov 11, 2020

 Merged

# [consensus/ethash: use 64bit indexes for the DAG generation](#top) #21793

[holiman](/holiman)
merged 2 commits into
[ethereum:master](/ethereum/go-ethereum/tree/master "ethereum/go-ethereum:master")
from
2miners:master

Nov 11, 2020

[Conversation
19](/ethereum/go-ethereum/pull/21793)
[Commits
2](/ethereum/go-ethereum/pull/21793/commits)
[Checks
0](/ethereum/go-ethereum/pull/21793/checks)
[Files changed](/ethereum/go-ethereum/pull/21793/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![slavikus](https://avatars.githubusercontent.com/u/143051?s=60&v=4)](/slavikus)

Copy link

Contributor

### @slavikus **[slavikus](/slavikus)** commented [Nov 6, 2020](#issue-737644925) ‚Ä¢ edited by karalabe Loading

If DAG size is exceeding the maximum 32 bit unsigned value, the DAG generation will produce incorrect results due to an index overflow. This PR converts all index calculations to 64 bit, which implicitly also fixes the addressing overflow.

Sorry, something went wrong.

 üëÄ
3
 q9f, n1charlie, and reo101 reacted with eyes emoji

All reactions

* üëÄ
  3 reactions

[![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&v=4)](/shrikus)

`[Bit boundary fix for the DAG generation routine](/ethereum/go-ethereum/pull/21793/commits/46750bc7263c6443fe052004c35d3798f4b761ae "Bit boundary fix for the DAG generation routine")`

`[46750bc](/ethereum/go-ethereum/pull/21793/commits/46750bc7263c6443fe052004c35d3798f4b761ae)`

 [![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus)
[slavikus](/slavikus)
requested a review
from [karalabe](/karalabe)
as a [code owner](/ethereum/go-ethereum/blob/97fc1c3b1d054a1345934e18fa6c3489e9119666/.github/CODEOWNERS#L9)
[November 6, 2020 10:23](#event-3966534763)

[![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&v=4)](/shrikus)

`[Fix unnecessary conversion warnings](/ethereum/go-ethereum/pull/21793/commits/cea20afc580b5103dbabec9a85da61a5f6561073 "Fix unnecessary conversion warnings")`

`[cea20af](/ethereum/go-ethereum/pull/21793/commits/cea20afc580b5103dbabec9a85da61a5f6561073)`

[![MariusVanDerWijden](https://avatars.githubusercontent.com/u/16664698?s=60&v=4)](/MariusVanDerWijden)

**[MariusVanDerWijden](/MariusVanDerWijden)**
reviewed
[Nov 6, 2020](#pullrequestreview-525074781)

 [View reviewed changes](/ethereum/go-ethereum/pull/21793/files/cea20afc580b5103dbabec9a85da61a5f6561073)

[consensus/ethash/algorithm.go](/ethereum/go-ethereum/pull/21793/files/cea20afc580b5103dbabec9a85da61a5f6561073#diff-9fdae72e50f2d2deb85a6a2961be950c7316d39f25dd22d60a169678dfe7b3cf)

Show resolved

Hide resolved

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 6, 2020](#issuecomment-723040589)

| If our math is correct, the problematic epoch is 385, so in about 56 days... which puts it on... drumroll... January 1st :)) |
| --- |

 üòÑ
5
 slavikus, q9f, deluca-mike, n1charlie, and reo101 reacted with laugh emoji

All reactions

* üòÑ
  5 reactions

Sorry, something went wrong.

[![@q9f](https://avatars.githubusercontent.com/u/58883403?s=80&u=163c64e1f2715b370dc87a6e9eb6044b3f37303a&v=4)](/q9f)

Copy link

Contributor

### **[q9f](/q9f)** commented [Nov 6, 2020](#issuecomment-723041426)

| Guess which network is already on epoch 385 ;) |
| --- |

 üòÑ
2
 deluca-mike and n1charlie reacted with laugh emoji

All reactions

* üòÑ
  2 reactions

Sorry, something went wrong.

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 6, 2020](#issuecomment-723041655) ‚Ä¢ edited Loading

| [@q9f](https://github.com/q9f) That which we must not name |
| --- |

 üòÑ
2
 deluca-mike and n1charlie reacted with laugh emoji

All reactions

* üòÑ
  2 reactions

Sorry, something went wrong.

[![holiman](https://avatars.githubusercontent.com/u/142290?s=60&v=4)](/holiman)

**[holiman](/holiman)**
approved these changes
[Nov 6, 2020](#pullrequestreview-525095642)

 [View reviewed changes](/ethereum/go-ethereum/pull/21793/files/cea20afc580b5103dbabec9a85da61a5f6561073)

Copy link

Contributor

### @holiman **[holiman](/holiman)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM, but it would be good to (in the long run) figure out a way to test faraway epochs, in a way which doesn't require the test harness to allocate 8Gb of ram.

The problematic aspect is that N threads are simultaneously writing to a slice (or mmap), so we can't just replace it with a `Writer` (which could be replaced with a hasher in the tests. )

Sorry, something went wrong.

 üëç
2
 slavikus and n1charlie reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 6, 2020](#issuecomment-723049787)

| I don't get why this fix fixes anything. Am I missing something?  The dataset size would need to be `max uint32 * 64` to overflow, so about 256GB? |
| --- |

All reactions

Sorry, something went wrong.

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 6, 2020](#issuecomment-723051563) ‚Ä¢ edited Loading

| It would seem to me that the issue is actuall 1 line below, `copy(dataset[index*hashBytes:], item)`. This is the place were we convert the computed hash-index back into byte-index. If the `index` is uint32, then this multiplication will overflow when the dataset size is larger than maxuint32.  This PR may very well accidentally fix it because it leaves the `index` as uint64 (thus this line correctly computing the result), but all the calculations really fit well into uint32 up until 256GB datasets, just this final byte-index multiplication should have been done on uint64. Could someone please verify this? |
| --- |

All reactions

Sorry, something went wrong.

[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=80&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus)

Copy link

Contributor

Author

### **[slavikus](/slavikus)** commented [Nov 6, 2020](#issuecomment-723084523)

| It would seem to me that the issue is actuall 1 line below, `copy(dataset[index*hashBytes:], item)`. This is the place were we convert the computed hash-index back into byte-index. If the `index` is uint32, then this multiplication will overflow when the dataset size is larger than maxuint32.  This PR may very well accidentally fix it because it leaves the `index` as uint64 (thus this line correctly computing the result), but all the calculations really fit well into uint32 up until 256GB datasets, just this final byte-index multiplication should have been done on uint64. Could someone please verify this?  Yes, [@karalabe](https://github.com/karalabe) , the problem is indeed in the `copy` call, but we have intentionally did not do `copy(dataset[uint64(index)*hashBytes:], item)` because I believe it is more reasonable to do the calculations in the 64 bit space instead of just doing the final typecast on the `index` variable. |
| --- |

All reactions

Sorry, something went wrong.

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=40&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman)
[holiman](/holiman)
added this to the [1.9.24](/ethereum/go-ethereum/milestone/110) milestone
[Nov 6, 2020](#event-3968953176)

[![@fjl](https://avatars.githubusercontent.com/u/6915?s=40&u=4ae824ebf83e9652f0a9a25705b2f4af24666aa9&v=4)](/fjl)
[fjl](/fjl)
changed the title
~~Bit boundary fix for the DAG generation routine~~
consensus/ethash: bit boundary fix for the DAG generation routine
[Nov 6, 2020](#event-3969203927)

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=80&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman)

Copy link

Contributor

### **[holiman](/holiman)** commented [Nov 9, 2020](#issuecomment-723928490) ‚Ä¢ edited Loading

| Epoch 385 Creation command: `$ ./build/bin/geth makedag 11550000 ./dag`  Sums on `master`:  ``` $ sha1sum full-R23-fc3afa075197d819 08d4242b19b6972ee863f83d9ef8ab111962fc2e  full-R23-fc3afa075197d819 $ md5sum full-R23-fc3afa075197d819 280684ebf3ff648612e20365267494f0  full-R23-fc3afa075197d819  ```  Sums with this PR:  ``` $ sha1sum full-R23-fc3afa075197d819  778f092f29998e57d7bda025e40c1f1a28bb8352  full-R23-fc3afa075197d819 $ md5sum full-R23-fc3afa075197d819  49ebb9d90f694bee149bc2235aa1217f  full-R23-fc3afa075197d819  ``` Epoch 733 Creation command: `$ ./build/bin/geth makedag 22000000 ./dag`  Sums on `master`:  ``` $ sha1sum full-R23-df934ec22255d03d 46d88183db3e82b1f5c446d9e18feb6eb498bf55  full-R23-df934ec22255d03d $ md5sum full-R23-df934ec22255d03d 7414f95fc2335aa069e5f7e0fe519819  full-R23-df934ec22255d03d  ```  Sums with this PR:  ``` $ sha1sum full-R23-df934ec22255d03d  263b537d60165b24068859f9c009028fd680a5ea  full-R23-df934ec22255d03d $ md5sum full-R23-df934ec22255d03d  67118039af19abd5091fbb1a710001e1  full-R23-df934ec22255d03d  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=40&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman)
[holiman](/holiman)
mentioned this pull request
[Nov 9, 2020](#ref-pullrequest-738919718)

[consensus/ethash: fix the percentage progress report
#21803](/ethereum/go-ethereum/pull/21803)
 Merged

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=40&v=4)](/karalabe)
[karalabe](/karalabe)
changed the title
~~consensus/ethash: bit boundary fix for the DAG generation routine~~
consensus/ethash: use 64bit indexes for the DAG generation
[Nov 9, 2020](#event-3974570133)

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 9, 2020](#issuecomment-724114544)

| Can confirm the hashes with my proposed fix, so PR SGTM  ``` diff --git a/consensus/ethash/algorithm.go b/consensus/ethash/algorithm.go index e79c702dc..600fcfc56 100644 --- a/consensus/ethash/algorithm.go +++ b/consensus/ethash/algorithm.go @@ -317,7 +317,7 @@ func generateDataset(dest []uint32, epoch uint64, cache []uint32) {                                 if swapped {                                         swap(item)                                 } -                               copy(dataset[index*hashBytes:], item) +                               copy(dataset[int64(index)*hashBytes:], item)                                   if status := atomic.AddUint64(&progress, 1); status%percent == 0 {                                         logger.Info("Generating DAG in progress", "percentage", (status*100)/(size/hashBytes), "elapsed", common.PrettyDuration(time.Since(start))) ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=80&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman)

Copy link

Contributor

### **[holiman](/holiman)** commented [Nov 9, 2020](#issuecomment-724117283)

| cc [@adria0](https://github.com/adria0) is it possible to cross-check the checksums against OE ? cc [@AlexeyAkhunov](https://github.com/AlexeyAkhunov) FYI |
| --- |

 üëÄ
1
 adria0 reacted with eyes emoji

All reactions

* üëÄ
  1 reaction

Sorry, something went wrong.

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=80&v=4)](/karalabe)

Copy link

Member

### **[karalabe](/karalabe)** commented [Nov 10, 2020](#issuecomment-725032936)

| The checksum checks out with the old C++ ethash library via Geth 1.2.1 too.  ``` $ geth makedag 11550000 /work/dag making DAG, this could take awhile... I1110 22:22:35.542381   39201 ethash.go:202] Generating DAG for epoch 385 (fc3afa075197d819758f4d3aacefbbace58798e55360d999892440dfee5e1c13) I1110 22:22:38.593699   39201 ethash.go:230] Still generating DAG: 0% I1110 22:22:56.926268   39201 ethash.go:230] Still generating DAG: 1% I1110 22:23:15.749309   39201 ethash.go:230] Still generating DAG: 2% [...] I1110 22:52:11.906846   39201 ethash.go:230] Still generating DAG: 100% I1110 22:52:11.910694   39201 ethash.go:219] Done generating DAG for epoch 385, it took 29m36.368661929s  $ sha1sum /work/dag/full-R23-fc3afa075197d819  778f092f29998e57d7bda025e40c1f1a28bb8352  /work/dag/full-R23-fc3afa075197d819  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@adria0](https://avatars.githubusercontent.com/u/5526331?s=80&u=40dce70c01f9039ced84bb5c8aaf689bffdc154b&v=4)](/adria0)

Copy link

### **[adria0](/adria0)** commented [Nov 11, 2020](#issuecomment-725277635)

| cc [@adria0](https://github.com/adria0) is it possible to cross-check the checksums against OE ? cc [@AlexeyAkhunov](https://github.com/AlexeyAkhunov) FYI  I'm checking the code and it seems that OE never generates the full DAG it delegates it to the miner, I only the cache for verifying, but maybe I'm missing something here cc/[@niklasad1](https://github.com/niklasad1) |
| --- |

All reactions

Sorry, something went wrong.

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=40&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman)
[holiman](/holiman)
merged commit [`d990df9`](/ethereum/go-ethereum/commit/d990df909d7839640143344e79356754384dcdd0)
into
ethereum:master

[Nov 11, 2020](https://github.com/ethereum/go-ethereum/pull/21793#event-3985475236)

[![@niklasad1](https://avatars.githubusercontent.com/u/14157425?s=80&u=9a4973dd68ade19095b26edb25f8564f44effdc1&v=4)](/niklasad1)

Copy link

### **[niklasad1](/niklasad1)** commented [Nov 12, 2020](#issuecomment-725954181) ‚Ä¢ edited Loading

| [@adria0](https://github.com/adria0) I don't know (not intimate with that part) but I passed the question along let's see if anyone has time to respond. |
| --- |

All reactions

Sorry, something went wrong.

![@ghost](https://avatars.githubusercontent.com/u/10137?s=32&v=4)
**ghost**
mentioned this pull request
[Nov 16, 2020](#ref-issue-743575714)

[any change for geth (Akantha (v1.9.24)) change? which may trigger a chain split on January 1st 2021
openethereum/openethereum#99](/openethereum/openethereum/issues/99)

Closed

[MetadiumRelease](/MetadiumRelease)
pushed a commit
to METADIUM/go-metadium
that referenced
this pull request
[Nov 25, 2020](#ref-commit-d5fdd55)
[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&u=07b1f7ace046a1f8fb68ae20eb26618fc15779c6&v=4)](/shrikus) [![@sadoci](https://avatars.githubusercontent.com/u/40418428?s=40&v=4)](/sadoci)

`[consensus/ethash: use 64bit indexes for the DAG generation (](/METADIUM/go-metadium/commit/d5fdd55dfd0bd2d925c1c59685735469ae3c5e9b "consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>")[ethereum#‚Ä¶](https://github.com/ethereum/go-ethereum/pull/21793)`
‚Ä¶

`[d5fdd55](/METADIUM/go-metadium/commit/d5fdd55dfd0bd2d925c1c59685735469ae3c5e9b)`

```
[‚Ä¶21793](https://github.com/ethereum/go-ethereum/pull/21793))

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
```

[MetadiumRelease](/MetadiumRelease)
pushed a commit
to METADIUM/go-metadium
that referenced
this pull request
[Nov 25, 2020](#ref-commit-3988419)
[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&u=07b1f7ace046a1f8fb68ae20eb26618fc15779c6&v=4)](/shrikus) [![@sadoci](https://avatars.githubusercontent.com/u/40418428?s=40&v=4)](/sadoci)

`[consensus/ethash: use 64bit indexes for the DAG generation (](/METADIUM/go-metadium/commit/398841911f421882363318c7b9abba631bcfe83d "consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>")[ethereum#‚Ä¶](https://github.com/ethereum/go-ethereum/pull/21793)`
‚Ä¶

`[3988419](/METADIUM/go-metadium/commit/398841911f421882363318c7b9abba631bcfe83d)`

```
[‚Ä¶21793](https://github.com/ethereum/go-ethereum/pull/21793))

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
```

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=40&v=4)](/karalabe)
[karalabe](/karalabe)
mentioned this pull request
[Dec 1, 2020](#ref-issue-753770824)

[Invalid PoW verification resulted in an Orphan block on Ethereum Mainnet
#21929](/ethereum/go-ethereum/issues/21929)

Closed

[![@unclezoro](https://avatars.githubusercontent.com/u/7310198?s=40&v=4)](/unclezoro)
[unclezoro](/unclezoro)
mentioned this pull request
[Jan 11, 2021](#ref-pullrequest-783095242)

[[R4R] security patch from go-ethereum
bnb-chain/bsc#63](/bnb-chain/bsc/pull/63)
 Merged

3 tasks

[recmo](/recmo)
pushed a commit
to recmo/go-ethereum
that referenced
this pull request
[Feb 17, 2021](#ref-commit-2a79ac1)
[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&u=07b1f7ace046a1f8fb68ae20eb26618fc15779c6&v=4)](/shrikus) [![@unclezoro](https://avatars.githubusercontent.com/u/7310198?s=40&v=4)](/unclezoro)

`[consensus/ethash: use 64bit indexes for the DAG generation (](/recmo/go-ethereum/commit/2a79ac162237bec8923b8703d7e71340360ee3eb "consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>")[ethereum#‚Ä¶](https://github.com/ethereum/go-ethereum/pull/21793)`
‚Ä¶

`[2a79ac1](/recmo/go-ethereum/commit/2a79ac162237bec8923b8703d7e71340360ee3eb)`

```
[‚Ä¶21793](https://github.com/ethereum/go-ethereum/pull/21793))

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
```

[enriquefynn](/enriquefynn)
pushed a commit
to enriquefynn/go-ethereum
that referenced
this pull request
[Mar 10, 2021](#ref-commit-3d7b8ea)
[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&u=07b1f7ace046a1f8fb68ae20eb26618fc15779c6&v=4)](/shrikus) [![@enriquefynn](https://avatars.githubusercontent.com/u/278786?s=40&v=4)](/enriquefynn)

`[consensus/ethash: use 64bit indexes for the DAG generation (](/enriquefynn/go-ethereum/commit/3d7b8ea406574ca3373bb48e4c663c099371bdca "consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>")[ethereum#‚Ä¶](https://github.com/ethereum/go-ethereum/pull/21793)`
‚Ä¶

`[3d7b8ea](/enriquefynn/go-ethereum/commit/3d7b8ea406574ca3373bb48e4c663c099371bdca)`

```
[‚Ä¶21793](https://github.com/ethereum/go-ethereum/pull/21793))

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
```

[flyworker](/flyworker)
pushed a commit
to nebulaai/nbai-node
that referenced
this pull request
[Apr 7, 2021](#ref-commit-409b498)
[![@czhang-nbai](https://avatars.githubusercontent.com/u/44036868?s=40&v=4)](/czhang-nbai) [![@karalabe](https://avatars.githubusercontent.com/u/129561?s=40&v=4)](/karalabe)
[![@holiman](https://avatars.githubusercontent.com/u/142290?s=40&u=cc1c365b40d8b3b84e2622effc8c8f7792e2a216&v=4)](/holiman) [![@MariusVanDerWijden](https://avatars.githubusercontent.com/u/16664698?s=40&v=4)](/MariusVanDerWijden) [![@Neurone](https://avatars.githubusercontent.com/u/562943?s=40&u=b4cc49611f48d53c88c6d64b72b1c7952150517f&v=4)](/Neurone) [![@rjl493456442](https://avatars.githubusercontent.com/u/5959481?s=40&u=e633f116e6b02648d9333a0ad406d50c2788e563&v=4)](/rjl493456442) [![@timcooijmans](https://avatars.githubusercontent.com/u/3218488?s=40&v=4)](/timcooijmans) [![@fjl](https://avatars.githubusercontent.com/u/6915?s=40&u=4ae824ebf83e9652f0a9a25705b2f4af24666aa9&v=4)](/fjl) [![@islishude](https://avatars.githubusercontent.com/u/24730006?s=40&v=4)](/islishude) [![@ucwong](https://avatars.githubusercontent.com/u/22344498?s=40&u=47a0929d1480a1fe83fedcbbd39c459e691b48d8&v=4)](/ucwong) [![@libotony](https://avatars.githubusercontent.com/u/8411962?s=40&u=41c3adb448a16c089ed24626187a71003cb9996c&v=4)](/libotony) [![@tofudfy](https://avatars.githubusercontent.com/u/35551352?s=40&v=4)](/tofudfy) [![@de1acr0ix](https://avatars.githubusercontent.com/u/42531996?s=40&u=715074fef36f35e61b7d64d5591b2f085e92ff73&v=4)](/de1acr0ix) [![@muse254](https://avatars.githubusercontent.com/u/38883999?s=40&u=f5ad0a03afadc82770e80b6e80ecae9e268d63f7&v=4)](/muse254) [![@gballet](https://avatars.githubusercontent.com/u/3272758?s=40&u=df5a0f1f75b7d5c9d8282274fb58da631245168f&v=4)](/gballet) [![@sosedoff](https://avatars.githubusercontent.com/u/71051?s=40&u=9aa5b098bb8aca7e9079b279906c79744b410006&v=4)](/sosedoff) [![@zsfelfoldi](https://avatars.githubusercontent.com/u/9884311?s=40&u=a44e4d9e7b8e5aa3a64a52dc4e14211f370c4ce2&v=4)](/zsfelfoldi) [![@kirelagin](https://avatars.githubusercontent.com/u/451835?s=40&v=4)](/kirelagin) [![@masonforest](https://avatars.githubusercontent.com/u/229473?s=40&v=4)](/masonforest) [![@vdamle](https://avatars.githubusercontent.com/u/5338861?s=40&u=9a33c1727ba52afb7c7895e9e0193570088a07e0&v=4)](/vdamle) [![@renaynay](https://avatars.githubusercontent.com/u/41963722?s=40&u=c59607053f9459aed74d2c4175120a43e2148ea7&v=4)](/renaynay) [![@binacs](https://avatars.githubusercontent.com/u/23079887?s=40&u=8b8a3fcced2b58a4fc49bbaf02186b66849d6b69&v=4)](/binacs) [![@aaronbuchwald](https://avatars.githubusercontent.com/u/24684335?s=40&v=4)](/aaronbuchwald) [![@mrFranklin](https://avatars.githubusercontent.com/u/5235904?s=40&u=4b75f84fd9942b3019e03100ac456961e5a2419a&v=4)](/mrFranklin) [![@azuchi](https://avatars.githubusercontent.com/u/1539047?s=40&u=61c6b71f3eeef6cca51fb08c4d747fa9c44ee7a6&v=4)](/azuchi) [![@q9f](https://avatars.githubusercontent.com/u/58883403?s=40&u=163c64e1f2715b370dc87a6e9eb6044b3f37303a&v=4)](/q9f) [![@meowsbits](https://avatars.githubusercontent.com/u/45600330?s=40&u=2caabd8cd42b4f41f5bd6edd43f64e87a8fe04d7&v=4)](/meowsbits) [![@hwanjo](https://avatars.githubusercontent.com/u/34005989?s=40&u=5d9b743dc42769d79fdb1348ee882823f3d9b6a9&v=4)](/hwanjo) [![@svenski123](https://avatars.githubusercontent.com/u/10262704?s=40&u=b871a20dd4761b9ada5683ba9509429d87ae03d1&v=4)](/svenski123) [![@prestwich](https://avatars.githubusercontent.com/u/10149425?s=40&u=cc92bd8d22e69aaca6b9c920fae22dd50ac89447&v=4)](/prestwich) [![@slavikus](https://avatars.githubusercontent.com/u/143051?s=40&u=686ae5fb1786d88a5fc26379002594fe70c23b7e&v=4)](/slavikus) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=40&u=07b1f7ace046a1f8fb68ae20eb26618fc15779c6&v=4)](/shrikus) [![@nfeignon](https://avatars.githubusercontent.com/u/3756898?s=40&u=be19e0485cd66f7bf8cfde09dfa1790472f9ff25&v=4)](/nfeignon) [![@PascalDierich](https://avatars.githubusercontent.com/u/14186263?s=40&u=a379059000938f03fd6becd45ae38f95038507ea&v=4)](/PascalDierich) [![@SadPencil](https://avatars.githubusercontent.com/u/11227602?s=40&v=4)](/SadPencil) [![@prestonvanloon](https://avatars.githubusercontent.com/u/7246818?s=40&u=3f838d99c5179fdec697d8ed3bf7111485bc7fbf&v=4)](/prestonvanloon) [![@hbakhtiyor](https://avatars.githubusercontent.com/u/3434496?s=40&v=4)](/hbakhtiyor) [![@wbt](https://avatars.githubusercontent.com/u/563406?s=40&v=4)](/wbt) [![@ligi](https://avatars.githubusercontent.com/u/111600?s=40&u=26403e7ba609510cbfd05103cc1f8a81c7d66834&v=4)](/ligi) [![@LieutenantRoger](https://avatars.githubusercontent.com/u/2875203?s=40&u=6fae781ab7764e06603b8bb309abc8e64d0c42d9&v=4)](/LieutenantRoger) [![@alexprut](https://avatars.githubusercontent.com/u/1648497?s=40&u=254a58f7e6ee9d49d81876bdbe203936b4aba986&v=4)](/alexprut) [![@atoulme](https://avatars.githubusercontent.com/u/16758?s=40&u=01bae8825a9887f393aeeee93aee2aac3d48fe01&v=4)](/atoulme) [![@nisdas](https://avatars.githubusercontent.com/u/33201827?s=40&u=237644f422467c55d98eab69d7b360d4d2b9e54f&v=4)](/nisdas) [![@pmerkleplant](https://avatars.githubusercontent.com/u/85061506?s=40&u=48a738e93e1ed40f392be68da78b56954540e31f&v=4)](/pmerkleplant) [![@ziogaschr](https://avatars.githubusercontent.com/u/802700?s=40&u=b1a7275bf398ca461679b23de2c87c07c59e54d3&v=4)](/ziogaschr) [![@steveruckdashel](https://avatars.githubusercontent.com/u/300013?s=40&v=4)](/steveruckdashel) [![@lobatt](https://avatars.githubusercontent.com/u/1172678?s=40&v=4)](/lobatt)

`[Dev (](/nebulaai/nbai-node/commit/409b4989098656eb7964a0c37f90f21111e81c0f "Dev (#16)

* params: update CHTs for v1.9.19

* params: release Geth v1.9.19

* params: begin v1.9.20 release cycle

* cmd/geth/tests: try to fix spurious travis failure in les tests (#21410)

* cmd/geth/tests: try to fix spurious travis failure in les tests

* cmd/geth: les_test - remove extraneous option during boot

* metrics: make meter updates lock-free (#21446)

* core/state: fixed some comments (#21450)

* build: drop disco, enable groovy on Ubuntu PPAs

* cmd/evm: statet8n output folder + tx hashes on trace filenames (#21406)

* t8ntool: add output basedir

* t8ntool: add txhash to trace filename

* t8ntool: don't default to '.' basedir, allow absolute paths

* core: more detailed metering for reorgs (#21420)

* core: define and test chain rewind corner cases (#21409)

* core: define and test chain reparation cornercases

* core: write up a variety of set-head tests

* core, eth: unify chain rollbacks, handle all the cases

* core: make linter smile

* core: remove commented out legacy code

* core, eth/downloader: fix review comments

* core: revert a removed recovery mechanism

* travis, dockerfile, appveyor, build: bump to Go 1.15

* metrics: zero temp variable in  updateMeter (#21470)

* metrics: zero temp variable in  updateMeter

Previously the temp variable was not updated properly after summing it to count.
This meant we had astronomically high metrics, now we zero out the temp whenever we
sum it onto the snapshot count

* metrics: move temp variable to be aligned, unit tests

Moves the temp variable in MeterSnapshot to be 64-bit aligned because of the atomic bug.
Adds a unit test, that catches the previous bug.

* eth/downloader: fix rollback issue on short chains

* core, eth, les, trie: add a prefix to contract code (#21080)

* core: do less lookups when writing fast-sync block bodies (#21468)

* eth: utilize sync bloom for getNodeData (#21445)

* eth/downloader, eth/handler: utilize sync bloom for getNodeData

* trie: handle if bloom is nil

* trie, downloader: check bloom nilness externally

* core/state/snapshot: reduce disk layer depth during generation

* p2p/discover: avoid dropping unverified nodes when table is almost empty (#21396)

This change improves discovery behavior in small networks. Very small
networks would often fail to bootstrap because all member nodes were
dropping table content due to findnode failure. The check is now changed
to avoid dropping nodes on findnode failure when their bucket is almost
empty. It also relaxes the liveness check requirement for FINDNODE/v4
response nodes, returning unverified nodes as results when there aren't
any verified nodes yet.

The \"findnode failed\" log now reports whether the node was dropped
instead of the number of results. The value of the \"results\" was
always zero by definition.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/rawdb: only complain loudly if truncating many items

* graphql: add support for retrieving the chain id (#21451)

* params: update CHTs for v1.9.20 release

* params: release Geth v1.9.20

* params: begin v1.9.21 release cycle

* accounts/abi/bind/backends: Disallow AdjustTime for non-empty blocks (#21334)

* accounts/abi/bind/backends: Disallow timeshift for non-empty blocks

* accounts/abi/bind/backends: added tests for adjust time

* accounts/abi/bind/simulated: added comments, fixed test for AdjustTime

* accounts/abi/bind/backends: updated comment

* core/state, eth, trie: stabilize memory use, fix memory leak

* eth: updated comments (#21490)

* go.mod | goleveldb latest update (#21448)

* go.mod | goleveldb latest update

* go.mod update

* leveldb options

* go.mod: double check

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* eth/tracers: revert reason in call_tracer + error for failed internal calls (#21387)

* tests: add testdata of call tracer

* eth/tracers: return revert reason in call_tracer

* eth/tracers: regenerate assets

* eth/tracers: add error message even if no exec occurrs, fixes #21438

Co-authored-by: Martin Holst Swende <martin@swende.se>

* rpc: fix issue with null JSON-RPC messages (#21497)

* accounts/abi: fix a bug in getTypeSize method (#21501)

* accounts/abi: fix a bug in getTypeSize method

e.g. for \"Tuple[2]\" type, the element of the array is a tuple type and the size of the tuple may not be 32.

* accounts/abi: add unit test of getTypeSize method

* internal: fix personal.sign() (#21503)

* \"Downloader queue stats\" is now provided once per minute (#21455)

* \"Downloader queue stats\" is now a DEBUG information

I think this info is more a DEBUG related information then an INFO. If it must remains an INFO, maybe it can be slow down to one time every 5 minutes or so.

* Update queue.go

\"Downloader queue stats\" information is now provided once every minute instead of once every 10 seconds.

* go.mod : update goja dependency (#21432)

* eth/downloader: change intial download size (#21366)

This changes how the downloader works, a little bit. Previously, when block sync started,
we immediately started filling up to 8192 blocks. Usually this is fine, blocks are small
in the early numbers. The threshold then is lowered as we measure the size of the blocks
that are filled.

However, if the node is shut down and restarts syncing while we're in a heavy segment,
that might be bad. This PR introduces a more conservative initial threshold of 2K blocks
instead.

* core, eth, trie: prepare trie sync for path based operation

* eth: added trace_call to trace on top of arbitrary blocks (#21338)

* eth: Added TraceTransactionPending

* eth: Implement Trace_Call, remove traceTxPending

* eth: debug_call -> debug_traceCall, recompute tx environment if pruned

* eth: fix nil panic

* eth: improve block retrieving logic in tracers

* internal/web3ext: add debug_traceCall to console

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments (#21514)

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* whisper: remove whisper (#21487)

* whisper: remove whisper

* Update cmd/geth/config.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/geth: warn on enabling whisper + remove more whisper deps

* mobile: remove all whisper references

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/usbwallet, signer/core: show accounts from ledger legacy derivation paths (#21517)

* accounts/usbwallet, signer/core: un-hide accounts from ledger legacy derivation paths

* Update accounts/usbwallet/wallet.go

* Update signer/core/api.go

* Update signer/core/api.go

* build: remove wnode from the list of packages binaries (#21526)

* .github: remove whisper from CODEOWNERS (#21527)

* params: update CHTs for v1.9.21 release

* params: release Geth v1.9.21

* params: begin v1.9.22 release cycle

* eth/downloader: only roll back light sync if not fully validating

* accounts/abi/bind/backends: reverted some stylistic changes (#21535)

* cmd, eth: offer maxprice flag for overwritting price cap (#21531)

* cmd, eth: offer maxprice flag for overwritting price cap

* eth: rename default price cap

* core/vm: fix benchmark overflow + prep for precompile repricings (#21530)

* core/vm/testdata: add gascost expectations to testcases

* core/vm: verify expected gas in tests for precompiles

* core/vm: fix overflow flaw in gas/s calculation

* go.mod: remove golang.org/x/sync (#21541)

* ethclient: add BlockNumber method (#21500)

This adds a new client method BlockNumber to fetch the most recent
block number of the chain.

* cmd/geth: print warning when whisper config is present in toml (#21544)

* cmd/geth: print warning when whisper config is present in toml

* Update cmd/geth/config.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* miner: use channels instead of atomics in update loop (#21536)

This PR changes several different things:

- Adds test cases for the miner loop
- Stops the worker if it wasn't already stopped in worker.Close()
- Uses channels instead of atomics in the miner.update() loop

Co-authored-by: Felix Lange <fjl@twurst.com>

* miner: fix regression, add test for starting while download (#21547)

Fixes a regression introduced in #21536

* p2p/discover: fix typo in comments (#21554)

* Dockerfile: unexpose port 8547 as GraphQL was merged into HTTP endpoint (#21556)

* p2p/nodestate: ensure correct callback order (#21436)

This PR adds an extra guarantee to NodeStateMachine: it ensures that all
immediate effects of a certain change are processed before any subsequent
effects of any of the immediate effects on the same node. In the original
version, if a cascaded change caused a subscription callback to be called
multiple times for the same node then these calls might have happened in a
wrong chronological order.

For example:

- a subscription to flag0 changes flag1 and flag2
- a subscription to flag1 changes flag3
- a subscription to flag1, flag2 and flag3 was called in the following order:

   [flag1] -> [flag1, flag3]
   [] -> [flag1]
   [flag1, flag3] -> [flag1, flag2, flag3]

This happened because the tree of changes was traversed in a \"depth-first
order\". Now it is traversed in a \"breadth-first order\"; each node has a
FIFO queue for pending callbacks and each triggered subscription callback
is added to the end of the list. The already existing guarantees are
retained; no SetState or SetField returns until the callback queue of the
node is empty again. Just like before, it is the responsibility of the
state machine design to ensure that infinite state loops are not possible.
Multiple changes affecting the same node can still happen simultaneously;
in this case the changes can be interleaved in the FIFO of the node but the
correct order is still guaranteed.

A new unit test is also added to verify callback order in the above scenario.

* js/tracers: make calltracer report value in selfdestructs  (#21549)

* rlp: add SplitUint64 (#21563)

This can be useful when working with raw RLP data.

* les, les/lespay/server: refactor client pool (#21236)

* les, les/lespay/server: refactor client pool

* les: use ns.Operation and sub calls where needed

* les: fixed tests

* les: removed active/inactive logic from peerSet

* les: removed active/inactive peer logic

* les: fixed linter warnings

* les: fixed more linter errors and added missing metrics

* les: addressed comments

* cmd/geth: fixed TestPriorityClient

* les: simplified clientPool state machine

* les/lespay/server: do not use goroutine for balance callbacks

* internal/web3ext: fix addBalance required parameters

* les: removed freeCapacity, always connect at minCapacity initially

* les: only allow capacity change with priority status

Co-authored-by: rjl493456442 <garyrong0905@gmail.com>

* eth/tracers: regenerate assets from #21549 (#21564)

* COYPING: restore the full text text of GPL (#21568)

When the license was added to the repository, its text was changed (some
sections at the end removed) and, worse, the authors of go-ethereum
tried to claim copyright on the license text.

The correct way to apply GPL to a project is to copy it verbatim.
This change reverts the text of the GPL to the original.

* core/rawdb: single point of maintenance for writing and deleting tx lookup indexes (#21480)

* ethclient: fix BlockNumber (#21565)

It didn't actually work because it called a method that doesn't
exist. This fixes it also adds a test.

Co-authored-by: Felix Lange <fjl@twurst.com>

* params: allow setting Petersburg block before chain head (#21473)

* Allow setting PetersburgBlock before chainhead

if it is at the same block as ConstantinopleBlock

* Add a negative test

* les/lespay/server: bump database version (#21571)

* tests/fuzzers/abi: add fuzzer for fuzzing package accounts/abi (#21217)

* tests/fuzzers/abi: added abi fuzzer

* accounts/abi: fixed issues found by fuzzing

* tests/fuzzers/abi: update fuzzers, added repro test

* tests/fuzzers/abi: renamed abi_fuzzer to abifuzzer

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: updated abi fuzzer

* accounts/abi: minor style fix

* go.mod: added go-fuzz dependency

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: comment out false positives

* cmd/utils: use preconfigured testnet flags instead of networkid (#21561)

* cmd/utils: use preconfigured testnet flags instead of networkid

* cmd/utils: shorter description

Co-authored-by: Martin Holst Swende <martin@swende.se>

* Update flags.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: added counters to the geth inspect report (#21495)

* database: added counters

* Improved stats for ancient db

* Small improvement

* Better message and added percentage while counting receipts

* Fast counting for receipts

* added info message

* Show both receips itemscount  from ancient db and counted receipts

* Fixed default case

* Removed counter for receipts in ancient store

* Removed counting of receipts present in leveldb

* eth/downloader: dynamically move pivot even during chain sync

* core: fix a typo in comment (#21439)

* accounts/abi: improve documentation and names (#21540)

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments

* acounts/abi/bind: doc errors, anonymous parameter assignments

* accounts/abi: doc edits, camelCase refactors

* accounts/abi/bind: review fix

* reverted name changes

* name revert

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* mobile: better api for java users (#21580)

* (mobile): Adds string representations for types

* mobile: better interfaces add stringer to types

Co-authored-by: sarath <sarath@melvault.com>

* p2p: move rlpx into separate package (#21464)

This change moves the RLPx protocol implementation into a separate package,
p2p/rlpx. The new package can be used to establish RLPx connections for
protocol testing purposes.

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/clef, cmd/geth: use SplitAndTrim from cmd/utils (#21579)

* trie: fix gaped range proof test case (#21484)

* trie: support empty range proof (#21199)

* internal/ethapi: add optional parameter blockNrOrHash to estimateGas (#21545)

This allows users to estimate gas on top of arbitrary blocks as well as pending and latest.
Tracing on pending is useful for most users as it takes into account the current txpool while
tracing on latest might be useful for users that have little to know knowledge of the current
transactions in the network.

If blockNrOrHash is not specified, estimateGas defaults to pending

* trie: extend range proof (#21250)

* trie: support non-existent right proof

* trie: improve test

* trie: minor linter fix

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* internal/ethapi: fix nil deref + fix estimateGas console bindings (#21601)

* tried to fix

* fix for js api

* fix for nil pointer ex

* rev space

* rev space

* input call formatter

* cmd/devp2p: add eth protocol test suite (#21598)

This change adds a test framework for the \"eth\" protocol and some basic
tests. The tests can be run using the './devp2p rlpx eth-test' command.

* cmd/devp2p/internal/ethtest: update version in handshake (#21603)

* cmd/devp2p/internal/ethtest: lower protocol version to 64 (#21604)

* params: update CHTs for Geth v1.9.22

* params: release Geth v1.9.22

* params: begin v1.9.23 release cycle

* accounts/abi: ABI explicit difference between Unpack and UnpackIntoInterface (#21091)

* accounts/abi: refactored abi.Unpack

* accounts/abi/bind: fixed error

* accounts/abi/bind: modified template

* accounts/abi/bind: added ToStruct for conversion

* accounts/abi: reenabled tests

* accounts/abi: fixed tests

* accounts/abi: fixed tests for packing/unpacking

* accounts/abi: fixed tests

* accounts/abi: added more logic to ToStruct

* accounts/abi/bind: fixed template

* accounts/abi/bind: fixed ToStruct conversion

* accounts/abi/: removed unused code

* accounts/abi: updated template

* accounts/abi: refactored unused code

* contracts/checkpointoracle: updated contracts to sol ^0.6.0

* accounts/abi: refactored reflection logic

* accounts/abi: less code duplication in Unpack*

* accounts/abi: fixed rebasing bug

* fix a few typos in comments

* rebase on master

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* mobile: added constructor for big int (#21597)

* mobile: added constructor for big int

* mobile: tiny nitpick

* core/vm, params: make 2200 in line with spec (#21605)

* core: free pointer from slice after popping element from price heap (#21572)

* Fix potential memory leak in price heap

* core: nil free pointer slice (alternative version)

Co-authored-by: Martin Holst Swende <martin@swende.se>

* internal/web3ext: improve eth_getBlockByNumber and eth_getBlockByHash console api (#21608)

* light: fix wrong description in a comment (#21573)

* p2p/enode: remove unused code (#21612)

* build: keep geth-sources.jar build result for JavaDoc (#21596)

* ci: tooltips for javadoc for mobile app

* f space

* cmd/bootnode,internal/debug: fix some comments (#21623)

* trie: use stacktrie for Derivesha operation (#21407)

core/types: use stacktrie for derivesha

trie: add stacktrie file

trie: fix linter

core/types: use stacktrie for derivesha

rebased: adapt stacktrie to the newer version of DeriveSha

Co-authored-by: Martin Holst Swende <martin@swende.se>

More linter fixes

review feedback: no key offset for nodes converted to hashes

trie: use EncodeRLP for full nodes

core/types: insert txs in order in derivesha

trie: tests for derivesha with stacktrie

trie: make stacktrie use pooled hashers

trie: make stacktrie reuse tmp slice space

trie: minor polishes on stacktrie

trie/stacktrie: less rlp dancing

core/types: explain the contorsions in DeriveSha

ci: fix goimport errors

trie: clear mem on subtrie hashing

squashme: linter fix

stracktrie: use pooling, less allocs (#3)

trie: in-place hex prefix, reduce allocs and add rawNode.EncodeRLP

Reintroduce the `[]node` method, add the missing `EncodeRLP` implementation for `rawNode` and calculate the hex prefix in place.

Co-authored-by: Martin Holst Swende <martin@swende.se>

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts, signer: implement gnosis safe support (#21593)

* accounts, signer: implement gnosis safe support

* common/math: add type for marshalling big to dec

* accounts, signer: properly sign gnosis requests

* signer, clef: implement account_signGnosisTx

* signer: fix auditlog print, change rpc-name (signGnosisTx to signGnosisSafeTx)

* signer: pass validation-messages/warnings to the UI for gnonsis-safe txs

* signer/core: minor change to validationmessages of typed data

* trie: polishes to trie committer (#21351)

* trie: update tests to check commit integrity

* trie: polish committer

* trie: fix typo

* trie: remove hasvalue notion

According to the benchmarks, type assertion between the pointer and
interface is extremely fast.

BenchmarkIntmethod-12           1000000000               1.91 ns/op
BenchmarkInterface-12           1000000000               2.13 ns/op
BenchmarkTypeSwitch-12          1000000000               1.81 ns/op
BenchmarkTypeAssertion-12       2000000000               1.78 ns/op

So the overhead for asserting whether the shortnode has \"valuenode\"
child is super tiny. No necessary to have another field.

* trie: linter nitpicks

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie: add Commit-sequence tests for stacktrie commit (#21643)

* core/state/snapshot: stop generator if it hits missing trie nodes (#21649)

* core/state/snapshot: exit Geth if generator hits missing trie nodes

* core/state/snapshot: error instead of hard die on generator fault

* core/state/snapshot: don't enable logging on the tests

* cmd/faucet: enable DNS discovery for known networks (#21636)

* params: update goerli testnet bootnodes (#21659)

* params: update pegasys besu bootnode

* params: update goerli initiative bootnodes

* core/bloombits: faster generator (#21625)

* core/bloombits: add benchmark

* core/bloombits: optimize inserts

* core/types: optimize bloom filters (#21624)

* core/types: tests for bloom

* core/types: refactored bloom filter for receipts, added tests

core/types: replaced old bloom implementation

core/types: change interface of bloom add+test

* core/types: refactor bloom

* core/types: minor tweak on LogsBloom

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/devp2p/internal/ethtest: improve eth test suite (#21615)

This fixes issues with the protocol handshake and status exchange
and adds support for responding to GetBlockHeaders requests.

* node: relax websocket connection header check (#21646)

This makes it accept the \"upgrade,keep-alive\" header value, which
apparently is a thing.

* signer/core: don't mismatch reject and no accounts (#21677)

* signer/core: don't mismatch reject and zero accounts, fixes #21674

* signer/core: docs

* p2p/discover: remove use of shared hash instance for key derivation (#21673)

For some reason, using the shared hash causes a cryptographic incompatibility
when using Go 1.15. I noticed this during the development of Discovery v5.1
when I added test vector verification.

The go library commit that broke this is golang/go@97240d5, but the
way we used HKDF is slightly dodgy anyway and it's not a regression.

* core/vm: dedup config check in markdown logger (#21655)

* core/vm: dedup config check

* review feedback: reuse buffer

* eth/downloader: fix data race around the ancientlimit (#21681)

* eth/downloader: fix data race around the ancientlimit

* eth/downloader: initialize the ancientlimit as 0

* eth/downloader: cache parent hash instead of recomputing (#21678)

* core: fix txpool off-by-one error (#21683)

* trie: polish commit function (#21692)

* trie: polish commit function

* trie: fix typo

* accouts, consensus, core: fix some comments (#21617)

* console: fix admin.sleepBlocks (#21629)

* all: replace RWMutex with Mutex in places where RLock is not used (#21622)

* consensus/clique: unexport calcDifficulty and improve comment (#21619)

* trie: fix flaw in stacktrie pool reuse (#21699)

* internal/web3ext: improve some web3 apis (#21639)

* imporve some web3-ext apis

* Update web3ext.go

Co-authored-by: Felix Lange <fjl@twurst.com>

* eth, p2p: use truncated names  (#21698)

* peer: return localAddr instead of name to prevent spam

We currently use the name (which can be freely set by the peer) in several log messages.
This enables malicious actors to write spam into your geth log.
This commit returns the localAddr instead of the freely settable name.

* p2p: reduce usage of peer.Name in warn messages

* eth, p2p: use truncated names

* Update peer.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth, cmd/utils: fixed flags name (#21700)

* miner: don't interrupt mining after successful sync (#21701)

* miner: exit loop when downloader Done or Failed

Following the logic of the comment at the method,
this fixes a regression introduced at 7cf56d6f064869cb62b1673f9ee437020c595391
, which would allow external parties to DoS with
blocks, preventing mining progress.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove ineff assign (lint)

Signed-off-by: meows <b5c6@protonmail.com>

* miner: update test re downloader events

Signed-off-by: meows <b5c6@protonmail.com>

* Revert \"miner: remove ineff assign (lint)\"

This reverts commit eaefcd34ab4862ebc936fb8a07578aa2744bc058.

* Revert \"miner: exit loop when downloader Done or Failed\"

This reverts commit 23abd34265aa246c38fc390bb72572ad6ae9fe3b.

* miner: add test showing imprecise TestMiner

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix waitForMiningState precision

This helper function would return an affirmation
on the first positive match on a desired bool.

This was imprecise; it return false positives
by not waiting initially for an 'updated' value.

This fix causes TestMiner_2 to fail, which is
expected.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove TestMiner_2 demonstrating broken test

This test demonstrated the imprecision of the test
helper function waitForMiningState. This function
has been fixed with 6d365c2851, and this test test
may now be removed.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix test regarding downloader event/mining expectations

See comment for logic.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: add test describing expectations for downloader/mining events

We expect that once the downloader emits a DoneEvent,
signaling a successful sync, that subsequent StartEvents
are not longer permitted to stop the miner.

This prevents a security vulnerability where forced syncs via
fake high blocks would stall mining operation.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: use 'canStop' state to fix downloader event handling

- Break downloader event handling into event
separating Done and Failed events. We need to
treat these cases differently since a DoneEvent
should prevent the miner from being stopped on
subsequent downloader Start events.

- Use canStop state to handle the one-off
case when a downloader first succeeds.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: improve comment wording

Signed-off-by: meows <b5c6@protonmail.com>

* miner: start mining on downloader events iff not already mining

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor miner update logic w/r/t downloader events

This makes mining pause/start logic regarding downloader
events more explicit. Instead of eternally handling downloader
events after the first done event, the subscription is closed
when downloader events are no longer actionable.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix handling downloader events on subcription closed

Signed-off-by: meows <b5c6@protonmail.com>

* miner: (lint:gosimple) use range over chan instead of for/select

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor update loop to remove race condition

The go routine handling the downloader events handling
vars in parallel with the parent routine, causing a
race condition.

This change, though ugly, remove the condition while
still allowing the downloader event subscription to be
closed when the miner has no further use for it (ie DoneEvent).

* miner: alternate fix for miner-flaw

Co-authored-by: meows <b5c6@protonmail.com>

* accounts/keystore: fix flaky test (#21703)

* accounts/keystore: add timeout to test to prevent failure on travis

The TestWalletNotifications test sporadically fails on travis.
This is because we shutdown the event collection before all events are received.
Adding a small timeout (10 milliseconds) allows the collector to be scheduled
and to consume all pending events before we shut it down.

* accounts/keystore: added newlines back in

* accounts/keystore: properly fix the walletNotifications test

* params: update CHTs (#21706)

* miner: set etherbase even if mining isn't possible at the moment (#21707)

* p2p/discover: implement v5.1 wire protocol (#21647)

This change implements the Discovery v5.1 wire protocol and
also adds an interactive test suite for this protocol.

* params: go-ethereum v1.9.23 stable

* params: begin v1.9.24 release cycle

* core/vm: marshall returnData as hexstring in trace logs (#21715)

* core/vm: marshall returnData as hexstring in trace logs

* core/vm: marshall returnData as hexstring in trace logs

* console: don't exit on ctrl-c, only on ctrl-d (#21660)

* add interrupt counter

* remove interrupt counter, allow ctrl-C to clear ONLY, ctrl-D will terminate console, stop node

* format

* add instructions to exit

* fix tests

* miner: fixed race condition in tests (#21664)

* core: track and improve tx indexing/unindexing (#21331)

* core: add background indexer to waitgroup

* core: make indexer stopable

* core/rawdb: add unit tests

* core/rawdb: fix lint

* core/rawdb: fix tests

* core/rawdb: fix linter

* eth/api: fix potential nil deref in AccountRange (#21710)

* Fix potential nil pointer error when neither block number nor hash is specified to accountRange

* Update error description

* les: remove clientPeerSet and serverSet (#21566)

* les: move NodeStateMachine from clientPool to LesServer

* les: new header broadcaster

* les: peerCommons.headInfo always contains last announced head

* les: remove clientPeerSet and serverSet

* les: fixed panic

* les: fixed --nodiscover option

* les: disconnect all peers at ns.Stop()

* les: added comments and fixed signed broadcasts

* les: removed unused parameter, fixed tests

* core: fix blockchain insert report time interval calculation (#21723)

* accounts/usbwallet: fix ledger version check (#21733)

The version check logic did not take into account the second digit (i.e. the '4' in v1.4.0) - this one line patch corrects this.

* all: implement EIP-2929 (gas cost increases for state access opcodes) + yolo-v2 (#21509)

* core/vm, core/state: implement EIP-2929 + YOLOv2

* core/state, core/vm: fix some review concerns

* core/state, core/vm: address review concerns

* core/vm: address review concerns

* core/vm: better documentation

* core/vm: unify sload cost as fully dynamic

* core/vm: fix typo

* core/vm/runtime: fix compilation flaw

* core/vm/runtime: fix renaming-err leftovers

* core/vm: renaming

* params/config: use correct yolov2 chainid for config

* core, params: use a proper new genesis for yolov2

* core/state/tests: golinter nitpicks

* cmd/devp2p/internal/ethtest: update test chain (#21742)

The old one was wrong in two ways: the first block in chain.rlp was the
genesis block, and the genesis difficulty was below minimum difficulty.

This also contains some other fixes to the test.

* utils, params: add yolov2 bootnode

* params: update yolov2 bootnode with elastic ip

* cmd/geth: fix dir path in geth attach for yolov2 network (#21749)

* accounts/abi/bind: restore error functionality (#21743)

* accounts/abi/bind: restore error functionality

* Update accounts/abi/bind/base.go

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* core/state: maintain one more diff layer (#21730)

* core/state: maintain one more diff layer

* core/state: address comment

* core/state: disable snapshot iteration if it's not fully constructed (#21682)

* core/state/snapshot: add diskRoot function

* core/state/snapshot: disable iteration if the snapshot is generating

* core/state/snapshot: simplify the function

* core/state: panic for undefined layer

* core: improve snapshot journal recovery (#21594)

* core/state/snapshot: introduce snapshot journal version

* core: update the disk layer in an atomic way

* core: persist the disk layer generator periodically

* core/state/snapshot: improve logging

* core/state/snapshot: forcibly ensure the legacy snapshot is matched

* core/state/snapshot: add debug logs

* core, tests: fix tests and special recovery case

* core: polish

* core: add more blockchain tests for snapshot recovery

* core/state: fix comment

* core: add recovery flag for snapshot

* core: add restart after start-after-crash tests

* core/rawdb: fix imports

* core: fix tests

* core: remove log

* core/state/snapshot: fix snapshot

* core: avoid callbacks in SetHead

* core: fix setHead cornercase where the threshold root has state

* core: small docs for the test cases

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* les, p2p/simulations/adapters: fix issues found while simulating les  (#21761)

This adds a few tiny fixes for les and the p2p simulation framework:

LES Parts

- Keep the LES-SERVER connection even it's non-synced

  We had this idea to reject the connections in LES protocol if the les-server itself is
  not synced. However, in LES protocol we will also receive the connection from another
  les-server. In this case even the local node is not synced yet, we should keep the tcp
  connection for other protocols(e.g. eth protocol).

- Don't count \"invalid message\" for non-existing GetBlockHeadersMsg request

  In the eth syncing mechanism (full sync, fast sync, light sync), it will try to fetch
  some non-existent blocks or headers(to ensure we indeed download all the missing chain).
  In this case, it's possible that the les-server will receive the request for
  non-existent headers. So don't count it as the \"invalid message\" for scheduling
  dropping.

- Copy the announce object in the closure

  Before the les-server pushes the latest headers to all connected clients, it will create
  a closure and queue it in the underlying request scheduler. In some scenarios it's
  problematic. E.g, in private networks, the block can be mined very fast. So before the
  first closure is executed, we may already update the latest_announce object. So actually
  the \"announce\" object we want to send is replaced.

  The downsize is the client will receive two announces with the same td and then drop the
  server.

P2P Simulation Framework

- Don't double register the protocol services in p2p-simulation \"Start\".

  The protocols upon the devp2p are registered in the \"New node stage\". So don't reigster
  them again when starting a node in the p2p simulation framework

- Add one more new config field \"ExternalSigner\", in order to use clef service in the
  framework.

* common: remove ToHex and ToHexArray (#21610)

ToHex was deprecated a couple years ago. The last remaining use
was in ToHexArray, which itself only had a single call site.

This just moves ToHexArray near its only remaining call site and
implements it using hexutil.Encode. This changes the default behaviour
of ToHexArray and with it the behaviour of eth_getProof. Previously we
encoded an empty slice as 0, now the empty slice is encoded as 0x.

* core/state/snapshot: fix journal recovery from generating old journal (#21775)

* core/state/snapshot: print warning if failed to resolve journal

* core/state/snapshot: fix snapshot recovery

When we meet the snapshot journal consisted with:
- disk layer generator with new-format
- diff layer journal with old-format

The base layer should be returned without error.
The broken diff layer can be reconstructed later
but we definitely don't want to reconstruct the
huge diff layer.

* core: add tests

* cmd/devp2p, internal/utesting: implement TAP output (#21760)

TAP is a text format for test results. Parsers for it are available in many languages,
making it easy to consume. I want TAP output from our protocol tests because the
Hive wrapper around them needs to know about the test names and their individual
results and logs. It would also be possible to just write this info as JSON, but I don't
want to invent a new format.

This also improves the normal console output for tests (when running without --tap).
It now prints -- RUN lines before any output from the test, and indents the log output
by one space.

* cmd/devp2p/internal/ethtest: add correct chain files and improve test output (#21782)

This PR replaces the old test genesis.json and chain.rlp files in the testdata
directory for the eth protocol test suite, and also adds documentation for
running the eth test suite locally.

It also improves the test output text and adds more timeouts.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/types, rlp: optimize derivesha (#21728)

This PR contains a minor optimization in derivesha, by exposing the RLP
int-encoding and making use of it to write integers directly to a
buffer (an RLP integer is known to never require more than 9 bytes
total). rlp.AppendUint64 might be useful in other places too.

The code assumes, just as before, that the hasher (a trie) will copy the
key internally, which it does when doing keybytesToHex(key).

Co-authored-by: Felix Lange <fjl@twurst.com>

* build: stop verbose output to keep travis from overflowing

* consensus/ethash: fix the percentage progress report

* core/state/snapshot: update generator marker in sync with flushes

* trie, tests/fuzzers: implement a stacktrie fuzzer + stacktrie fixes (#21799)

* trie: fix error in stacktrie not committing small roots

* fuzzers: make trie-fuzzer use correct returnvalues

* trie: improved tests

* tests/fuzzers: fuzzer for stacktrie vs regular trie

* test/fuzzers: make stacktrie fuzzer use 32-byte keys

* trie: fix error in stacktrie with small nodes

* trie: add (skipped) testcase for stacktrie

* tests/fuzzers: address review comments for stacktrie fuzzer

* trie: fix docs in stacktrie

* travis: drop Go 1.13 builders as it's not supported any more

* build: stop building for Ubuntu Eoan, not supported any more

* p2p/simulations/adapters/exec: fix some issues (#21801)

- Remove the ws:// prefix from the status endpoint since
  the ws:// is already included in the stack.WSEndpoint().
- Don't register the services again in the node start.
  Registration is already done in the initialization stage.
- Expose admin namespace via websocket.
  This namespace is necessary for connecting the peers via websocket.
- Offer logging relevant options for exec adapter.
  It's really painful to mix all log output in the single console. So
  this PR offers two additional options for exec adapter in this case
  testers can config the log output(e.g. file output) and log level
  for each p2p node.

* scripts: create oss-fuzz script in go-ethereum (#21808)

* fuzzers: removed fuzzbuzz configuration (#21813)

We decided to move our fuzzing efforts to oss-fuzz since fuzzbuzz is still early access.

* build: add -dlgo flag in ci.go (#21824)

This new flag downloads a known version of Go and builds with it. This
is meant for environments where we can't easily upgrade the installed Go
version.

* .travis.yml: remove install step for PR test builders

We added this step originally to avoid re-building everything
for every test. go test has become much smarter in recent go
releases, so we no longer need to install anything here.

* consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>

* build: fix regressions with the -dlgo change (#21831)

This fixes cross-build and mobile framework failures.
It also disables the mac test builder because it was failing
all the time in hard to understand ways and we can't afford
it anymore under Travis CI's new pricing.

* .travis.yml: move test builders after install builders (#21833)

* params: release Geth v1.9.24 with Go 1.15.5 (#21842)

* params: begin v1.9.25 release cycle

* crypto/bn256: improve bn256 fuzzer (#21815)

* crypto/cloudflare: fix nil deref in random G1/G2 reading

* crypto/bn256: improve fuzzer

* crypto/bn256: fix some flaws in fuzzer

* crypto/bn256: better comments for u, P and Order (#21836)

* tests/fuzzers: improve the fuzzers (#21829)

* tests/fuzzers, common/bitutil: make fuzzers use correct returnvalues + remove output

* tests/fuzzers/stacktrie: fix duplicate-key insertion in stacktrie (false positive)

* tests/fuzzers/stacktrie: fix compilation error

* tests/fuzzers: linter nits

* core/vm, protocol_params: implement eip-2565 modexp repricing (#21607)

* core/vm, protocol_params: implement eip-2565 modexp repricing

* core/vm: fix review concerns

* core, all: split vm.Context into BlockContext and TxContext (#21672)

* all: core: split vm.Config into BlockConfig and TxConfig

* core: core/vm: reset EVM between tx in block instead of creating new

* core/vm: added docs

* accounts/abi: template: set events Raw field in Parse methods (#21807)

* common: fix documentation of Address.SetBytes (#21814)

* crypto/bn256: refine comments according to #19577, #21595, and #21836 (#21847)

* consensus/ethash: fix usage of *reflect.SliceHeader (#21372)

* consensus/ethash: only use *reflect.SliceHeader, not reflect.SliceHeader. See comment here: https://github.com/golang/go/issues/40397\#issuecomment-663748689

* consensus/ethash: pr feedback from @mdempsky, makes a copy of dest such that is not mutated

* consensus/ethash: remove noop assign

* consensus/ethash: apply same fix to another location

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: remove retesteth

* crypto/secp256k1: add checking z sign in affineFromJacobian (#18419)

The z == 0 check is hit whenever we Add two points with the same x1/x2
coordinate. crypto/elliptic uses the same check in their affineFromJacobian
function. This change does not affect block processing or tx signature verification
in any way, because it does not use the Add or Double methods.

* cmd/geth: improve les test on windows (#21860)

* all: disable recording preimage of trie keys (#21402)

* cmd, core, eth, light, trie: disable recording preimage by default

* core, eth: fix unit tests

* core: fix import

* all: change to nopreimage

* cmd, core, eth, trie: use cache.preimages flag

* cmd: enable preimages for archive node

* cmd/utils, trie: simplify preimage tracking a bit

* core: fix linter

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* metrics: fix the panic for reading empty cpu stats (#21864)

* node: support expressive origin rules in ws.origins (#21481)

* Only compare hostnames in ws.origins

Also using a helper function for ToLower consolidates all preparation steps in one function for more maintainable consistency.

Spaces => tabs

Remove a semicolon

Add space at start of comment

Remove parens around conditional

Handle case wehre parsed hostname is empty

When passing a single word like \"localhost\" the parsed hostname is an empty string. Handle this and the error-parsing case together as default, and the nonempty hostname case in the conditional.

Refactor with new originIsAllowed functions

Adds originIsAllowed() & ruleAllowsOrigin(); removes prepOriginForComparison

Remove blank line

Added tests for simple allowed-orign rule

which does not specify a protocol or port, just a hostname

Fix copy-paste: `:=` => `=`

Remove parens around conditional

Remove autoadded whitespace on blank lines

Compare scheme, hostname, and port with rule

if the rule specifies those portions.

Remove one autoadded trailing whitespace

Better handle case where only origin host is given

e.g. \"localhost\"

Remove parens around conditional

Refactor: attemptWebsocketConnectionFromOrigin DRY

Include return type on helper function

Provide srv obj in helper fn

Provide srv to helper fn

Remove stray underscore

Remove blank line

parent 93e666b4c1e7e49b8406dc83ed93f4a02ea49ac1
author wbt <wbt@users.noreply.github.com> 1598559718 -0400
committer Martin Holst Swende <martin@swende.se> 1605602257 +0100
gpgsig -----BEGIN PGP SIGNATURE-----

 iQFFBAABCAAvFiEEypmrtbNuJK1doP1AaDtDjAWl3fAFAl+zi9ARHG1hcnRpbkBz
 d2VuZGUuc2UACgkQaDtDjAWl3fDRiwgAoMtzU8dwRV7Q9xkCwWEx9Wz2f3n6jUr2
 VWBycDKGKwRkPPOER3oc9kzjGU/P1tFlK07PjfnAKZ9KWzxpDcJZwYM3xCBurG7A
 16y4YsQnzgPNONv3xIkdi3RZtDBIiPFFEmdZFFvZ/jKexfI6JIYPngCAoqdTIFb9
 On/aPvvVWQn1ExfmarsvvJ7kUDUG77tZipuacEH5FfFsfelBWOEYPe+I9ToUHskv
 +qO6rOkV1Ojk8eBc6o0R1PnApwCAlEhJs7aM/SEOg4B4ZJJneiFuEXBIG9+0yS2I
 NOicuDPLGucOB5nBsfIKI3USPeE+3jxdT8go2lN5Nrhm6MimoILDsQ==
 =sgUp
 -----END PGP SIGNATURE-----

Refactor: drop err var for more concise test lines

Add several tests for new WebSocket origin checks

Remove autoadded whitespace on blank lines

Restore TestWebsocketOrigins originally-named test

and rename the others to be helpers rather than full tests

Remove autoadded whitespace on blank line

Temporarily comment out new test sets

Uncomment test around origin rule with scheme

Remove tests without scheme on browser origin

per https://github.com/ethereum/go-ethereum/pull/21481/files#r479371498

Uncomment tests with port; remove some blank lines

Handle when browser does not specify scheme/port

Uncomment test for including scheme & port in rule

Add IP tests

* node: more tests + table-driven, ws origin changes

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie, rpc, cmd/geth: fix tests on 32-bit and windows + minor rpc fixes (#21871)

* trie: fix tests to work on 32-bit systems

* les: make test work on 32-bit platform

* cmd/geth: fix windows-issues on tests

* trie: improve balance

* cmd/geth: make account tests less verbose + less mem intense

* rpc: make debug-level log output less verbose

* cmd/geth: lint

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input (#21872)

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input

* Update crypto/bn256/bn256_fuzz.go

Co-authored-by: ligi <ligi@ligi.de>

Co-authored-by: ligi <ligi@ligi.de>

* p2p: avoid spinning loop on out-of-handles (#21878)

* p2p: avoid busy-loop on temporary errors

* p2p: address review concerns

* les/utils: protect against WeightedRandomSelect overflow (#21839)

Also fixes a bug in les/flowcontrol that caused the overflow.

* github: Add new style of issue-templates

closes #20024

* tests/fuzzers/bls1381: add bls fuzzer (#21796)

* added bls fuzzer

* crypto/bls12381: revert bls-changes, fixup fuzzer tests

* fuzzers: split bls fuzzing into 8 different units

* fuzzers/bls: remove (now stale) corpus

* crypto/bls12381: added blsfuzz corpus

* fuzzers/bls12381: fix the bls corpus

* fuzzers: fix oss-fuzz script

* tests/fuzzers: fixups on bls corpus

* test/fuzzers: remove leftover corpus

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/faucet: improve handling of facebook post url (#21838)

Resolves #21532

Co-authored-by: roger <dengjun@huobi.com>

* les: fix GetProofsV2 bug (#21896)

* github: Remove vulnerability.md (#21894)

This type is automatically offered by github after changing to the new style and a security.md being present

* cmd/devp2p/internal/ethtest: add 'large announcement' tests (#21792)

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: refactored stuff a bit

* cmd/devp2p/internal/ethtest: added TestMaliciousStatus/Handshake

* cmd/devp2p/internal/ethtest: fixed rebasing issue

* happy linter, happy life

* cmd/devp2p/internal/ethtest: used readAndServe

* stuff

* cmd/devp2p/internal/ethtest: fixed test cases

* core/types: fixed typo (#21897)

* all: simplify nested complexity and if blocks ending with a return statement (#21854)

Changes:

    Simplify nested complexity
    If an if blocks ends with a return statement then remove the else nesting.

Most of the changes has also been reported in golint https://goreportcard.com/report/github.com/ethereum/go-ethereum#golint

* graphql: always return 400 if errors are present in the response (#21882)

* Make sure to return 400 when errors are present in the response

* graphql: use less memory in chainconfig for tests

Co-authored-by: Martin Holst Swende <martin@swende.se>

* all: remove redundant conversions and import names (#21903)

* p2p/discover: fix deadlock in discv5 message dispatch (#21858)

This fixes a deadlock that could occur when a response packet arrived
after a call had already received enough responses and was about to
signal completion to the dispatch loop.

Co-authored-by: Felix Lange <fjl@twurst.com>

* crypto: signing builds with signify/minisign (#21798)

* internal/build: implement signify's signing func
* Add signify to the ci utility
* fix output file format
* Add unit test for signify
* holiman's + travis' feedback
* internal/build: verify signify's output
* crypto: move signify to common dir
* use go-minisign to verify binaries
* more holiman feedback
* crypto, ci: support minisign output
* only accept one-line trusted comments
* configurable untrusted comments
* code cleanup in tests
* revert to use ed25519 from the stdlib
* bug: fix for empty untrusted comments
* write timestamp as comment if trusted comment isn't present
* rename line checker to commentHasManyLines
* crypto: added signify fuzzer (#6)
* crypto: added signify fuzzer
* stuff
* crypto: updated signify fuzzer to fuzz comments
* crypto: repro signify crashes
* rebased fuzzer on build-signify branch
* hide fuzzer behind gofuzz build flag
* extract key data inside a single function
* don't treat \r as a newline
* travis: fix signing command line
* do not use an external binary in tests
* crypto: move signify to crypto/signify
* travis: fix formatting issue
* ci: fix linter build after package move

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* accounts, signer: fix Ledger Live account derivation path (clef) (#21757)

* signer/core/api: fix derivation of ledger live accounts

For ledger hardware wallets, change account iteration as follows:

- ledger legacy: m/44'/60'/0'/X; for 0<=X<5
- ledger live: m/44'/60'/0'/0/X; for 0<=X<5

- ledger legacy: m/44'/60'/0'/X; for 0<=X<10
- ledger live: m/44'/60'/X'/0/0; for 0<=X<10

Non-ledger derivation is unchanged and remains as:
- non-ledger: m/44'/60'/0'/0/X; for 0<=X<10

* signer/core/api: derive ten default paths for all hardware wallets, plus ten legacy and ten live paths for ledger wallets

* signer/core/api: as .../0'/0/0 already included by default paths, do not include it again with ledger live paths

* accounts, signer: implement path iterators for hd wallets

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/keystore: add missing function doc for SignText (#21914)

Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>

* cmd/geth: make tests run quicker + use less memory and disk (#21919)

* cmd/devp2p/internal/ethtest: add transaction tests (#21857)

* p2p/nodestate: fix deadlock during shutdown of les server (#21927)

This PR fixes a deadlock reported here: #21925

The cause is that many operations may be pending, but if the close happens, only one of them gets awoken and exits, the others remain waiting for a signal that never comes.

* les: fix nodiscover option (#21906)

* params: update CHTs (#21941)

* eth: fix error in tracing if reexec is set (#21830)

* eth: fix error in tracing if reexec is set

* eth: change pointer embedding to value-embedding

* go.mod: update github.com/golang/snappy(#21934)

This updates the snappy library depency to include a fix for
a Go 1.16 incompatibility issue.

* cmd/devp2p: add node filter for snap + fix arg error (#21950)

* core/vm/runtime: remove duplicated line (#21956)

This line is duplicated, though it doesn't cause any issues.

* core: improve contextual information on core errors (#21869)

A lot of times when we hit 'core' errors, example: invalid tx, the information provided is
insufficient. We miss several pieces of information: what account has nonce too high,
and what transaction in that block was offending?

This PR adds that information, using the new type of wrapped errors.
It also adds a testcase which (partly) verifies the output from the errors.

The first commit changes all usage of direct equality-checks on core errors, into
using errors.Is. The second commit adds contextual information. This wraps most
of the core errors with more information, and also wraps it one more time in
stateprocessor, to further provide tx index and tx hash, if such a tx is encoutered in
a block. The third commit uses the chainmaker to try to generate chains with such
errors in them, thus triggering the errors and checking that the generated string meets
expectations.

* cmd/geth: implement vulnerability check (#21859)

* cmd/geth: implement vulnerability check

* cmd/geth: use minisign to verify vulnerability feed

* cmd/geth: add the test too

* cmd/geth: more minisig/signify testing

* cmd/geth: support multiple pubfiles for signing

* cmd/geth: add @holiman minisig pubkey

* cmd/geth: polishes on vulnerability check

* cmd/geth: fix ineffassign linter nit

* cmd/geth: add CVE to version check struct

* cmd/geth/testdata: add missing testfile

* cmd/geth: add more keys to versionchecker

* cmd/geth: support file:// URLs in version check

* cmd/geth: improve key ID printing when signature check fails

Co-authored-by: Felix Lange <fjl@twurst.com>

* les: cosmetic rewrite of the arm64 float bug workaround (#21960)

* les: revert arm float bug workaround to check go 1.15

* add traces to reproduce outside travis

* simpler workaround

* crypto/secp256k1: add workaround for go mod vendor (#21735)

Go won't vendor C files if there are no Go files present in the directory.
Workaround is to add dummy Go files.

Fixes: #20232

* accounts/abi/bind: allow specifying signer on transactOpts (#21356)

This commit enables users to specify which signer they want to use while creating their transactOpts.
Previously all contract interactions used the homestead signer. Now a user can specify whether they
want to sign with homestead or EIP155 and specify the chainID which adds another layer of security.

Closes #16484

* common: improve printing of Hash and Address (#21834)

Both Hash and Address have a String method, which returns the value as
hex with 0x prefix. They also had a Format method which tried to print
the value using printf of []byte. The way Format worked was at odds with
String though, leading to a situation where fmt.Sprintf(\"%v\", hash)
returned the decimal notation and hash.String() returned a hex string.

This commit makes it consistent again. Both types now support the %v,
%s, %q format verbs for 0x-prefixed hex output. %x, %X creates
unprefixed hex output. %d is also supported and returns the decimal
notation \"[1 2 3...]\".

For Address, the case of hex characters in %v, %s, %q output is
determined using the EIP-55 checksum. Using %x, %X with Address
disables checksumming.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core,les: headerchain import in batches (#21471)

* core: add test for headerchain inserts

* core, light: write headerchains in batches

* core: change to one callback per batch of inserted headers + review concerns

* core: error-check on batch write

* core: unexport writeHeaders

* core: remove callback parameter in InsertHeaderChain

The semantics of InsertHeaderChain are now much simpler: it is now an
all-or-nothing operation. The new WriteStatus return value allows
callers to check for the canonicality of the insertion. This change
simplifies use of HeaderChain in package les, where the callback was
previously used to post chain events.

* core: skip some hashing when writing headers

* core: less hashing in header validation

* core: fix headerchain flaw regarding blacklisted hashes

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth: add test to verify regexps in version check (#21962)

* crypto/signify, build: fix archive signing with signify (#21977)

This fixes some issues in crypto/signify and makes release signing work.

The archive signing step in ci.go used getenvBase64, which decodes the key data.
This is incorrect here because crypto/signify already base64-decodes the key.

* p2p/enode: avoid crashing for invalid IP (#21981)

The database panicked for invalid IPs. This is usually no problem
because all code paths leading to node DB access verify the IP, but it's
dangerous because improper validation can turn this panic into a DoS
vulnerability. The quick fix here is to just turn database accesses
using invalid IP into a noop. This isn't great, but I'm planning to
remove the node DB for discv5 long-term, so it should be fine to have
this quick fix for half a year.

Fixes #21849

* les, light: remove untrusted header retrieval in ODR (#21907)

* les, light: remove untrusted header retrieval in ODR

* les: polish

* light: check the hash equality in odr

* core, trie: speed up some tests with quadratic processing flaw (#21987)

This commit fixes a flaw in two testcases, and brings down the exec-time from ~40s to ~8s for trie/TestIncompleteSync.

The checkConsistency was performed over and over again on the complete set of nodes, not just the recently added, turning it into a quadratic runtime.

* les: introduce forkID (#21974)

* les: introduce forkID

* les: address comment

* build: upgrade to Go 1.15.6 (#21986)

* params: go-ethereum v1.9.25 stable

* update README.md

* update Makefile

* add mining node as bootnode

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>
Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Giuseppe Bertone <bertone.giuseppe@gmail.com>
Co-authored-by: gary rong <garyrong0905@gmail.com>
Co-authored-by: timcooijmans <timcooijmans@gmail.com>
Co-authored-by: Felix Lange <fjl@twurst.com>
Co-authored-by: Shude Li <islishude@gmail.com>
Co-authored-by: ucwong <ucwong@126.com>
Co-authored-by: libotony <liboliqi@gmail.com>
Co-authored-by: Fuyang Deng <dengfuyang@outlook.com>
Co-authored-by: Hanjiang Yu <delacroix.yu@gmail.com>
Co-authored-by: Osoro Bironga <fanosoro@gmail.com>
Co-authored-by: Osoro Bironga <osoro@doctaroo.com>
Co-authored-by: Guillaume Ballet <gballet@gmail.com>
Co-authored-by: Dan Sosedoff <dan.sosedoff@gmail.com>
Co-authored-by: Felf√∂ldi Zsolt <zsfelfoldi@gmail.com>
Co-authored-by: Julian Koh <jk2698@cornell.edu>
Co-authored-by: Kirill Elagin <kirelagin@gmail.com>
Co-authored-by: Mason Fischer <mason@kissr.co>
Co-authored-by: Vinod Damle <vdamle@users.noreply.github.com>
Co-authored-by: sarath <sarath@melvault.com>
Co-authored-by: rene <41963722+renaynay@users.noreply.github.com>
Co-authored-by: Binacs <bin646891055@gmail.com>
Co-authored-by: aaronbuchwald <aaron.buchwald56@gmail.com>
Co-authored-by: mr_franklin <mr_franklin@126.com>
Co-authored-by: shigeyuki azuchi <azuchi@chaintope.com>
Co-authored-by: Raw Pong Ghmoa <58883403+q9f@users.noreply.github.com>
Co-authored-by: meows <b5c6@protonmail.com>
Co-authored-by: hwanjo <34005989+hwanjo@users.noreply.github.com>
Co-authored-by: Kristofer Peterson <svenski123@users.noreply.github.com>
Co-authored-by: James Prestwich <10149425+prestwich@users.noreply.github.com>
Co-authored-by: Slava Karpenko <slavikus@gmail.com>
Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
Co-authored-by: Nicolas Feignon <nfeignon@gmail.com>
Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>
Co-authored-by: Sad Pencil <sadpencil@outlook.com>
Co-authored-by: Preston Van Loon <preston@prysmaticlabs.com>
Co-authored-by: Abd ar-Rahman Hamidi <bakhtiyor.h@gmail.com>
Co-authored-by: wbt <wbt@users.noreply.github.com>
Co-authored-by: ligi <ligi@ligi.de>
Co-authored-by: LieutenantRoger <dijsky_2015@hotmail.com>
Co-authored-by: roger <dengjun@huobi.com>
Co-authored-by: Alex Prut <1648497+alexprut@users.noreply.github.com>
Co-authored-by: Antoine Toulme <atoulme@users.noreply.github.com>
Co-authored-by: Nishant Das <nishdas93@gmail.com>
Co-authored-by: Pascal Dierich <pascal@merkleplant.xyz>
Co-authored-by: Chris Ziogas <ziogas_chr@hotmail.com>
Co-authored-by: Steve Ruckdashel <steven.ruckdashel@optum.com>
Co-authored-by: Li, Cheng <lob4tt@gmail.com>")[#16](https://github.com/nebulaai/nbai-node/pull/16)[)](/nebulaai/nbai-node/commit/409b4989098656eb7964a0c37f90f21111e81c0f "Dev (#16)

* params: update CHTs for v1.9.19

* params: release Geth v1.9.19

* params: begin v1.9.20 release cycle

* cmd/geth/tests: try to fix spurious travis failure in les tests (#21410)

* cmd/geth/tests: try to fix spurious travis failure in les tests

* cmd/geth: les_test - remove extraneous option during boot

* metrics: make meter updates lock-free (#21446)

* core/state: fixed some comments (#21450)

* build: drop disco, enable groovy on Ubuntu PPAs

* cmd/evm: statet8n output folder + tx hashes on trace filenames (#21406)

* t8ntool: add output basedir

* t8ntool: add txhash to trace filename

* t8ntool: don't default to '.' basedir, allow absolute paths

* core: more detailed metering for reorgs (#21420)

* core: define and test chain rewind corner cases (#21409)

* core: define and test chain reparation cornercases

* core: write up a variety of set-head tests

* core, eth: unify chain rollbacks, handle all the cases

* core: make linter smile

* core: remove commented out legacy code

* core, eth/downloader: fix review comments

* core: revert a removed recovery mechanism

* travis, dockerfile, appveyor, build: bump to Go 1.15

* metrics: zero temp variable in  updateMeter (#21470)

* metrics: zero temp variable in  updateMeter

Previously the temp variable was not updated properly after summing it to count.
This meant we had astronomically high metrics, now we zero out the temp whenever we
sum it onto the snapshot count

* metrics: move temp variable to be aligned, unit tests

Moves the temp variable in MeterSnapshot to be 64-bit aligned because of the atomic bug.
Adds a unit test, that catches the previous bug.

* eth/downloader: fix rollback issue on short chains

* core, eth, les, trie: add a prefix to contract code (#21080)

* core: do less lookups when writing fast-sync block bodies (#21468)

* eth: utilize sync bloom for getNodeData (#21445)

* eth/downloader, eth/handler: utilize sync bloom for getNodeData

* trie: handle if bloom is nil

* trie, downloader: check bloom nilness externally

* core/state/snapshot: reduce disk layer depth during generation

* p2p/discover: avoid dropping unverified nodes when table is almost empty (#21396)

This change improves discovery behavior in small networks. Very small
networks would often fail to bootstrap because all member nodes were
dropping table content due to findnode failure. The check is now changed
to avoid dropping nodes on findnode failure when their bucket is almost
empty. It also relaxes the liveness check requirement for FINDNODE/v4
response nodes, returning unverified nodes as results when there aren't
any verified nodes yet.

The \"findnode failed\" log now reports whether the node was dropped
instead of the number of results. The value of the \"results\" was
always zero by definition.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/rawdb: only complain loudly if truncating many items

* graphql: add support for retrieving the chain id (#21451)

* params: update CHTs for v1.9.20 release

* params: release Geth v1.9.20

* params: begin v1.9.21 release cycle

* accounts/abi/bind/backends: Disallow AdjustTime for non-empty blocks (#21334)

* accounts/abi/bind/backends: Disallow timeshift for non-empty blocks

* accounts/abi/bind/backends: added tests for adjust time

* accounts/abi/bind/simulated: added comments, fixed test for AdjustTime

* accounts/abi/bind/backends: updated comment

* core/state, eth, trie: stabilize memory use, fix memory leak

* eth: updated comments (#21490)

* go.mod | goleveldb latest update (#21448)

* go.mod | goleveldb latest update

* go.mod update

* leveldb options

* go.mod: double check

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* eth/tracers: revert reason in call_tracer + error for failed internal calls (#21387)

* tests: add testdata of call tracer

* eth/tracers: return revert reason in call_tracer

* eth/tracers: regenerate assets

* eth/tracers: add error message even if no exec occurrs, fixes #21438

Co-authored-by: Martin Holst Swende <martin@swende.se>

* rpc: fix issue with null JSON-RPC messages (#21497)

* accounts/abi: fix a bug in getTypeSize method (#21501)

* accounts/abi: fix a bug in getTypeSize method

e.g. for \"Tuple[2]\" type, the element of the array is a tuple type and the size of the tuple may not be 32.

* accounts/abi: add unit test of getTypeSize method

* internal: fix personal.sign() (#21503)

* \"Downloader queue stats\" is now provided once per minute (#21455)

* \"Downloader queue stats\" is now a DEBUG information

I think this info is more a DEBUG related information then an INFO. If it must remains an INFO, maybe it can be slow down to one time every 5 minutes or so.

* Update queue.go

\"Downloader queue stats\" information is now provided once every minute instead of once every 10 seconds.

* go.mod : update goja dependency (#21432)

* eth/downloader: change intial download size (#21366)

This changes how the downloader works, a little bit. Previously, when block sync started,
we immediately started filling up to 8192 blocks. Usually this is fine, blocks are small
in the early numbers. The threshold then is lowered as we measure the size of the blocks
that are filled.

However, if the node is shut down and restarts syncing while we're in a heavy segment,
that might be bad. This PR introduces a more conservative initial threshold of 2K blocks
instead.

* core, eth, trie: prepare trie sync for path based operation

* eth: added trace_call to trace on top of arbitrary blocks (#21338)

* eth: Added TraceTransactionPending

* eth: Implement Trace_Call, remove traceTxPending

* eth: debug_call -> debug_traceCall, recompute tx environment if pruned

* eth: fix nil panic

* eth: improve block retrieving logic in tracers

* internal/web3ext: add debug_traceCall to console

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments (#21514)

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* whisper: remove whisper (#21487)

* whisper: remove whisper

* Update cmd/geth/config.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/geth: warn on enabling whisper + remove more whisper deps

* mobile: remove all whisper references

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/usbwallet, signer/core: show accounts from ledger legacy derivation paths (#21517)

* accounts/usbwallet, signer/core: un-hide accounts from ledger legacy derivation paths

* Update accounts/usbwallet/wallet.go

* Update signer/core/api.go

* Update signer/core/api.go

* build: remove wnode from the list of packages binaries (#21526)

* .github: remove whisper from CODEOWNERS (#21527)

* params: update CHTs for v1.9.21 release

* params: release Geth v1.9.21

* params: begin v1.9.22 release cycle

* eth/downloader: only roll back light sync if not fully validating

* accounts/abi/bind/backends: reverted some stylistic changes (#21535)

* cmd, eth: offer maxprice flag for overwritting price cap (#21531)

* cmd, eth: offer maxprice flag for overwritting price cap

* eth: rename default price cap

* core/vm: fix benchmark overflow + prep for precompile repricings (#21530)

* core/vm/testdata: add gascost expectations to testcases

* core/vm: verify expected gas in tests for precompiles

* core/vm: fix overflow flaw in gas/s calculation

* go.mod: remove golang.org/x/sync (#21541)

* ethclient: add BlockNumber method (#21500)

This adds a new client method BlockNumber to fetch the most recent
block number of the chain.

* cmd/geth: print warning when whisper config is present in toml (#21544)

* cmd/geth: print warning when whisper config is present in toml

* Update cmd/geth/config.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* miner: use channels instead of atomics in update loop (#21536)

This PR changes several different things:

- Adds test cases for the miner loop
- Stops the worker if it wasn't already stopped in worker.Close()
- Uses channels instead of atomics in the miner.update() loop

Co-authored-by: Felix Lange <fjl@twurst.com>

* miner: fix regression, add test for starting while download (#21547)

Fixes a regression introduced in #21536

* p2p/discover: fix typo in comments (#21554)

* Dockerfile: unexpose port 8547 as GraphQL was merged into HTTP endpoint (#21556)

* p2p/nodestate: ensure correct callback order (#21436)

This PR adds an extra guarantee to NodeStateMachine: it ensures that all
immediate effects of a certain change are processed before any subsequent
effects of any of the immediate effects on the same node. In the original
version, if a cascaded change caused a subscription callback to be called
multiple times for the same node then these calls might have happened in a
wrong chronological order.

For example:

- a subscription to flag0 changes flag1 and flag2
- a subscription to flag1 changes flag3
- a subscription to flag1, flag2 and flag3 was called in the following order:

   [flag1] -> [flag1, flag3]
   [] -> [flag1]
   [flag1, flag3] -> [flag1, flag2, flag3]

This happened because the tree of changes was traversed in a \"depth-first
order\". Now it is traversed in a \"breadth-first order\"; each node has a
FIFO queue for pending callbacks and each triggered subscription callback
is added to the end of the list. The already existing guarantees are
retained; no SetState or SetField returns until the callback queue of the
node is empty again. Just like before, it is the responsibility of the
state machine design to ensure that infinite state loops are not possible.
Multiple changes affecting the same node can still happen simultaneously;
in this case the changes can be interleaved in the FIFO of the node but the
correct order is still guaranteed.

A new unit test is also added to verify callback order in the above scenario.

* js/tracers: make calltracer report value in selfdestructs  (#21549)

* rlp: add SplitUint64 (#21563)

This can be useful when working with raw RLP data.

* les, les/lespay/server: refactor client pool (#21236)

* les, les/lespay/server: refactor client pool

* les: use ns.Operation and sub calls where needed

* les: fixed tests

* les: removed active/inactive logic from peerSet

* les: removed active/inactive peer logic

* les: fixed linter warnings

* les: fixed more linter errors and added missing metrics

* les: addressed comments

* cmd/geth: fixed TestPriorityClient

* les: simplified clientPool state machine

* les/lespay/server: do not use goroutine for balance callbacks

* internal/web3ext: fix addBalance required parameters

* les: removed freeCapacity, always connect at minCapacity initially

* les: only allow capacity change with priority status

Co-authored-by: rjl493456442 <garyrong0905@gmail.com>

* eth/tracers: regenerate assets from #21549 (#21564)

* COYPING: restore the full text text of GPL (#21568)

When the license was added to the repository, its text was changed (some
sections at the end removed) and, worse, the authors of go-ethereum
tried to claim copyright on the license text.

The correct way to apply GPL to a project is to copy it verbatim.
This change reverts the text of the GPL to the original.

* core/rawdb: single point of maintenance for writing and deleting tx lookup indexes (#21480)

* ethclient: fix BlockNumber (#21565)

It didn't actually work because it called a method that doesn't
exist. This fixes it also adds a test.

Co-authored-by: Felix Lange <fjl@twurst.com>

* params: allow setting Petersburg block before chain head (#21473)

* Allow setting PetersburgBlock before chainhead

if it is at the same block as ConstantinopleBlock

* Add a negative test

* les/lespay/server: bump database version (#21571)

* tests/fuzzers/abi: add fuzzer for fuzzing package accounts/abi (#21217)

* tests/fuzzers/abi: added abi fuzzer

* accounts/abi: fixed issues found by fuzzing

* tests/fuzzers/abi: update fuzzers, added repro test

* tests/fuzzers/abi: renamed abi_fuzzer to abifuzzer

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: updated abi fuzzer

* accounts/abi: minor style fix

* go.mod: added go-fuzz dependency

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: comment out false positives

* cmd/utils: use preconfigured testnet flags instead of networkid (#21561)

* cmd/utils: use preconfigured testnet flags instead of networkid

* cmd/utils: shorter description

Co-authored-by: Martin Holst Swende <martin@swende.se>

* Update flags.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: added counters to the geth inspect report (#21495)

* database: added counters

* Improved stats for ancient db

* Small improvement

* Better message and added percentage while counting receipts

* Fast counting for receipts

* added info message

* Show both receips itemscount  from ancient db and counted receipts

* Fixed default case

* Removed counter for receipts in ancient store

* Removed counting of receipts present in leveldb

* eth/downloader: dynamically move pivot even during chain sync

* core: fix a typo in comment (#21439)

* accounts/abi: improve documentation and names (#21540)

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments

* acounts/abi/bind: doc errors, anonymous parameter assignments

* accounts/abi: doc edits, camelCase refactors

* accounts/abi/bind: review fix

* reverted name changes

* name revert

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* mobile: better api for java users (#21580)

* (mobile): Adds string representations for types

* mobile: better interfaces add stringer to types

Co-authored-by: sarath <sarath@melvault.com>

* p2p: move rlpx into separate package (#21464)

This change moves the RLPx protocol implementation into a separate package,
p2p/rlpx. The new package can be used to establish RLPx connections for
protocol testing purposes.

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/clef, cmd/geth: use SplitAndTrim from cmd/utils (#21579)

* trie: fix gaped range proof test case (#21484)

* trie: support empty range proof (#21199)

* internal/ethapi: add optional parameter blockNrOrHash to estimateGas (#21545)

This allows users to estimate gas on top of arbitrary blocks as well as pending and latest.
Tracing on pending is useful for most users as it takes into account the current txpool while
tracing on latest might be useful for users that have little to know knowledge of the current
transactions in the network.

If blockNrOrHash is not specified, estimateGas defaults to pending

* trie: extend range proof (#21250)

* trie: support non-existent right proof

* trie: improve test

* trie: minor linter fix

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* internal/ethapi: fix nil deref + fix estimateGas console bindings (#21601)

* tried to fix

* fix for js api

* fix for nil pointer ex

* rev space

* rev space

* input call formatter

* cmd/devp2p: add eth protocol test suite (#21598)

This change adds a test framework for the \"eth\" protocol and some basic
tests. The tests can be run using the './devp2p rlpx eth-test' command.

* cmd/devp2p/internal/ethtest: update version in handshake (#21603)

* cmd/devp2p/internal/ethtest: lower protocol version to 64 (#21604)

* params: update CHTs for Geth v1.9.22

* params: release Geth v1.9.22

* params: begin v1.9.23 release cycle

* accounts/abi: ABI explicit difference between Unpack and UnpackIntoInterface (#21091)

* accounts/abi: refactored abi.Unpack

* accounts/abi/bind: fixed error

* accounts/abi/bind: modified template

* accounts/abi/bind: added ToStruct for conversion

* accounts/abi: reenabled tests

* accounts/abi: fixed tests

* accounts/abi: fixed tests for packing/unpacking

* accounts/abi: fixed tests

* accounts/abi: added more logic to ToStruct

* accounts/abi/bind: fixed template

* accounts/abi/bind: fixed ToStruct conversion

* accounts/abi/: removed unused code

* accounts/abi: updated template

* accounts/abi: refactored unused code

* contracts/checkpointoracle: updated contracts to sol ^0.6.0

* accounts/abi: refactored reflection logic

* accounts/abi: less code duplication in Unpack*

* accounts/abi: fixed rebasing bug

* fix a few typos in comments

* rebase on master

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* mobile: added constructor for big int (#21597)

* mobile: added constructor for big int

* mobile: tiny nitpick

* core/vm, params: make 2200 in line with spec (#21605)

* core: free pointer from slice after popping element from price heap (#21572)

* Fix potential memory leak in price heap

* core: nil free pointer slice (alternative version)

Co-authored-by: Martin Holst Swende <martin@swende.se>

* internal/web3ext: improve eth_getBlockByNumber and eth_getBlockByHash console api (#21608)

* light: fix wrong description in a comment (#21573)

* p2p/enode: remove unused code (#21612)

* build: keep geth-sources.jar build result for JavaDoc (#21596)

* ci: tooltips for javadoc for mobile app

* f space

* cmd/bootnode,internal/debug: fix some comments (#21623)

* trie: use stacktrie for Derivesha operation (#21407)

core/types: use stacktrie for derivesha

trie: add stacktrie file

trie: fix linter

core/types: use stacktrie for derivesha

rebased: adapt stacktrie to the newer version of DeriveSha

Co-authored-by: Martin Holst Swende <martin@swende.se>

More linter fixes

review feedback: no key offset for nodes converted to hashes

trie: use EncodeRLP for full nodes

core/types: insert txs in order in derivesha

trie: tests for derivesha with stacktrie

trie: make stacktrie use pooled hashers

trie: make stacktrie reuse tmp slice space

trie: minor polishes on stacktrie

trie/stacktrie: less rlp dancing

core/types: explain the contorsions in DeriveSha

ci: fix goimport errors

trie: clear mem on subtrie hashing

squashme: linter fix

stracktrie: use pooling, less allocs (#3)

trie: in-place hex prefix, reduce allocs and add rawNode.EncodeRLP

Reintroduce the `[]node` method, add the missing `EncodeRLP` implementation for `rawNode` and calculate the hex prefix in place.

Co-authored-by: Martin Holst Swende <martin@swende.se>

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts, signer: implement gnosis safe support (#21593)

* accounts, signer: implement gnosis safe support

* common/math: add type for marshalling big to dec

* accounts, signer: properly sign gnosis requests

* signer, clef: implement account_signGnosisTx

* signer: fix auditlog print, change rpc-name (signGnosisTx to signGnosisSafeTx)

* signer: pass validation-messages/warnings to the UI for gnonsis-safe txs

* signer/core: minor change to validationmessages of typed data

* trie: polishes to trie committer (#21351)

* trie: update tests to check commit integrity

* trie: polish committer

* trie: fix typo

* trie: remove hasvalue notion

According to the benchmarks, type assertion between the pointer and
interface is extremely fast.

BenchmarkIntmethod-12           1000000000               1.91 ns/op
BenchmarkInterface-12           1000000000               2.13 ns/op
BenchmarkTypeSwitch-12          1000000000               1.81 ns/op
BenchmarkTypeAssertion-12       2000000000               1.78 ns/op

So the overhead for asserting whether the shortnode has \"valuenode\"
child is super tiny. No necessary to have another field.

* trie: linter nitpicks

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie: add Commit-sequence tests for stacktrie commit (#21643)

* core/state/snapshot: stop generator if it hits missing trie nodes (#21649)

* core/state/snapshot: exit Geth if generator hits missing trie nodes

* core/state/snapshot: error instead of hard die on generator fault

* core/state/snapshot: don't enable logging on the tests

* cmd/faucet: enable DNS discovery for known networks (#21636)

* params: update goerli testnet bootnodes (#21659)

* params: update pegasys besu bootnode

* params: update goerli initiative bootnodes

* core/bloombits: faster generator (#21625)

* core/bloombits: add benchmark

* core/bloombits: optimize inserts

* core/types: optimize bloom filters (#21624)

* core/types: tests for bloom

* core/types: refactored bloom filter for receipts, added tests

core/types: replaced old bloom implementation

core/types: change interface of bloom add+test

* core/types: refactor bloom

* core/types: minor tweak on LogsBloom

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/devp2p/internal/ethtest: improve eth test suite (#21615)

This fixes issues with the protocol handshake and status exchange
and adds support for responding to GetBlockHeaders requests.

* node: relax websocket connection header check (#21646)

This makes it accept the \"upgrade,keep-alive\" header value, which
apparently is a thing.

* signer/core: don't mismatch reject and no accounts (#21677)

* signer/core: don't mismatch reject and zero accounts, fixes #21674

* signer/core: docs

* p2p/discover: remove use of shared hash instance for key derivation (#21673)

For some reason, using the shared hash causes a cryptographic incompatibility
when using Go 1.15. I noticed this during the development of Discovery v5.1
when I added test vector verification.

The go library commit that broke this is golang/go@97240d5, but the
way we used HKDF is slightly dodgy anyway and it's not a regression.

* core/vm: dedup config check in markdown logger (#21655)

* core/vm: dedup config check

* review feedback: reuse buffer

* eth/downloader: fix data race around the ancientlimit (#21681)

* eth/downloader: fix data race around the ancientlimit

* eth/downloader: initialize the ancientlimit as 0

* eth/downloader: cache parent hash instead of recomputing (#21678)

* core: fix txpool off-by-one error (#21683)

* trie: polish commit function (#21692)

* trie: polish commit function

* trie: fix typo

* accouts, consensus, core: fix some comments (#21617)

* console: fix admin.sleepBlocks (#21629)

* all: replace RWMutex with Mutex in places where RLock is not used (#21622)

* consensus/clique: unexport calcDifficulty and improve comment (#21619)

* trie: fix flaw in stacktrie pool reuse (#21699)

* internal/web3ext: improve some web3 apis (#21639)

* imporve some web3-ext apis

* Update web3ext.go

Co-authored-by: Felix Lange <fjl@twurst.com>

* eth, p2p: use truncated names  (#21698)

* peer: return localAddr instead of name to prevent spam

We currently use the name (which can be freely set by the peer) in several log messages.
This enables malicious actors to write spam into your geth log.
This commit returns the localAddr instead of the freely settable name.

* p2p: reduce usage of peer.Name in warn messages

* eth, p2p: use truncated names

* Update peer.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth, cmd/utils: fixed flags name (#21700)

* miner: don't interrupt mining after successful sync (#21701)

* miner: exit loop when downloader Done or Failed

Following the logic of the comment at the method,
this fixes a regression introduced at 7cf56d6f064869cb62b1673f9ee437020c595391
, which would allow external parties to DoS with
blocks, preventing mining progress.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove ineff assign (lint)

Signed-off-by: meows <b5c6@protonmail.com>

* miner: update test re downloader events

Signed-off-by: meows <b5c6@protonmail.com>

* Revert \"miner: remove ineff assign (lint)\"

This reverts commit eaefcd34ab4862ebc936fb8a07578aa2744bc058.

* Revert \"miner: exit loop when downloader Done or Failed\"

This reverts commit 23abd34265aa246c38fc390bb72572ad6ae9fe3b.

* miner: add test showing imprecise TestMiner

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix waitForMiningState precision

This helper function would return an affirmation
on the first positive match on a desired bool.

This was imprecise; it return false positives
by not waiting initially for an 'updated' value.

This fix causes TestMiner_2 to fail, which is
expected.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove TestMiner_2 demonstrating broken test

This test demonstrated the imprecision of the test
helper function waitForMiningState. This function
has been fixed with 6d365c2851, and this test test
may now be removed.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix test regarding downloader event/mining expectations

See comment for logic.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: add test describing expectations for downloader/mining events

We expect that once the downloader emits a DoneEvent,
signaling a successful sync, that subsequent StartEvents
are not longer permitted to stop the miner.

This prevents a security vulnerability where forced syncs via
fake high blocks would stall mining operation.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: use 'canStop' state to fix downloader event handling

- Break downloader event handling into event
separating Done and Failed events. We need to
treat these cases differently since a DoneEvent
should prevent the miner from being stopped on
subsequent downloader Start events.

- Use canStop state to handle the one-off
case when a downloader first succeeds.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: improve comment wording

Signed-off-by: meows <b5c6@protonmail.com>

* miner: start mining on downloader events iff not already mining

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor miner update logic w/r/t downloader events

This makes mining pause/start logic regarding downloader
events more explicit. Instead of eternally handling downloader
events after the first done event, the subscription is closed
when downloader events are no longer actionable.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix handling downloader events on subcription closed

Signed-off-by: meows <b5c6@protonmail.com>

* miner: (lint:gosimple) use range over chan instead of for/select

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor update loop to remove race condition

The go routine handling the downloader events handling
vars in parallel with the parent routine, causing a
race condition.

This change, though ugly, remove the condition while
still allowing the downloader event subscription to be
closed when the miner has no further use for it (ie DoneEvent).

* miner: alternate fix for miner-flaw

Co-authored-by: meows <b5c6@protonmail.com>

* accounts/keystore: fix flaky test (#21703)

* accounts/keystore: add timeout to test to prevent failure on travis

The TestWalletNotifications test sporadically fails on travis.
This is because we shutdown the event collection before all events are received.
Adding a small timeout (10 milliseconds) allows the collector to be scheduled
and to consume all pending events before we shut it down.

* accounts/keystore: added newlines back in

* accounts/keystore: properly fix the walletNotifications test

* params: update CHTs (#21706)

* miner: set etherbase even if mining isn't possible at the moment (#21707)

* p2p/discover: implement v5.1 wire protocol (#21647)

This change implements the Discovery v5.1 wire protocol and
also adds an interactive test suite for this protocol.

* params: go-ethereum v1.9.23 stable

* params: begin v1.9.24 release cycle

* core/vm: marshall returnData as hexstring in trace logs (#21715)

* core/vm: marshall returnData as hexstring in trace logs

* core/vm: marshall returnData as hexstring in trace logs

* console: don't exit on ctrl-c, only on ctrl-d (#21660)

* add interrupt counter

* remove interrupt counter, allow ctrl-C to clear ONLY, ctrl-D will terminate console, stop node

* format

* add instructions to exit

* fix tests

* miner: fixed race condition in tests (#21664)

* core: track and improve tx indexing/unindexing (#21331)

* core: add background indexer to waitgroup

* core: make indexer stopable

* core/rawdb: add unit tests

* core/rawdb: fix lint

* core/rawdb: fix tests

* core/rawdb: fix linter

* eth/api: fix potential nil deref in AccountRange (#21710)

* Fix potential nil pointer error when neither block number nor hash is specified to accountRange

* Update error description

* les: remove clientPeerSet and serverSet (#21566)

* les: move NodeStateMachine from clientPool to LesServer

* les: new header broadcaster

* les: peerCommons.headInfo always contains last announced head

* les: remove clientPeerSet and serverSet

* les: fixed panic

* les: fixed --nodiscover option

* les: disconnect all peers at ns.Stop()

* les: added comments and fixed signed broadcasts

* les: removed unused parameter, fixed tests

* core: fix blockchain insert report time interval calculation (#21723)

* accounts/usbwallet: fix ledger version check (#21733)

The version check logic did not take into account the second digit (i.e. the '4' in v1.4.0) - this one line patch corrects this.

* all: implement EIP-2929 (gas cost increases for state access opcodes) + yolo-v2 (#21509)

* core/vm, core/state: implement EIP-2929 + YOLOv2

* core/state, core/vm: fix some review concerns

* core/state, core/vm: address review concerns

* core/vm: address review concerns

* core/vm: better documentation

* core/vm: unify sload cost as fully dynamic

* core/vm: fix typo

* core/vm/runtime: fix compilation flaw

* core/vm/runtime: fix renaming-err leftovers

* core/vm: renaming

* params/config: use correct yolov2 chainid for config

* core, params: use a proper new genesis for yolov2

* core/state/tests: golinter nitpicks

* cmd/devp2p/internal/ethtest: update test chain (#21742)

The old one was wrong in two ways: the first block in chain.rlp was the
genesis block, and the genesis difficulty was below minimum difficulty.

This also contains some other fixes to the test.

* utils, params: add yolov2 bootnode

* params: update yolov2 bootnode with elastic ip

* cmd/geth: fix dir path in geth attach for yolov2 network (#21749)

* accounts/abi/bind: restore error functionality (#21743)

* accounts/abi/bind: restore error functionality

* Update accounts/abi/bind/base.go

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* core/state: maintain one more diff layer (#21730)

* core/state: maintain one more diff layer

* core/state: address comment

* core/state: disable snapshot iteration if it's not fully constructed (#21682)

* core/state/snapshot: add diskRoot function

* core/state/snapshot: disable iteration if the snapshot is generating

* core/state/snapshot: simplify the function

* core/state: panic for undefined layer

* core: improve snapshot journal recovery (#21594)

* core/state/snapshot: introduce snapshot journal version

* core: update the disk layer in an atomic way

* core: persist the disk layer generator periodically

* core/state/snapshot: improve logging

* core/state/snapshot: forcibly ensure the legacy snapshot is matched

* core/state/snapshot: add debug logs

* core, tests: fix tests and special recovery case

* core: polish

* core: add more blockchain tests for snapshot recovery

* core/state: fix comment

* core: add recovery flag for snapshot

* core: add restart after start-after-crash tests

* core/rawdb: fix imports

* core: fix tests

* core: remove log

* core/state/snapshot: fix snapshot

* core: avoid callbacks in SetHead

* core: fix setHead cornercase where the threshold root has state

* core: small docs for the test cases

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* les, p2p/simulations/adapters: fix issues found while simulating les  (#21761)

This adds a few tiny fixes for les and the p2p simulation framework:

LES Parts

- Keep the LES-SERVER connection even it's non-synced

  We had this idea to reject the connections in LES protocol if the les-server itself is
  not synced. However, in LES protocol we will also receive the connection from another
  les-server. In this case even the local node is not synced yet, we should keep the tcp
  connection for other protocols(e.g. eth protocol).

- Don't count \"invalid message\" for non-existing GetBlockHeadersMsg request

  In the eth syncing mechanism (full sync, fast sync, light sync), it will try to fetch
  some non-existent blocks or headers(to ensure we indeed download all the missing chain).
  In this case, it's possible that the les-server will receive the request for
  non-existent headers. So don't count it as the \"invalid message\" for scheduling
  dropping.

- Copy the announce object in the closure

  Before the les-server pushes the latest headers to all connected clients, it will create
  a closure and queue it in the underlying request scheduler. In some scenarios it's
  problematic. E.g, in private networks, the block can be mined very fast. So before the
  first closure is executed, we may already update the latest_announce object. So actually
  the \"announce\" object we want to send is replaced.

  The downsize is the client will receive two announces with the same td and then drop the
  server.

P2P Simulation Framework

- Don't double register the protocol services in p2p-simulation \"Start\".

  The protocols upon the devp2p are registered in the \"New node stage\". So don't reigster
  them again when starting a node in the p2p simulation framework

- Add one more new config field \"ExternalSigner\", in order to use clef service in the
  framework.

* common: remove ToHex and ToHexArray (#21610)

ToHex was deprecated a couple years ago. The last remaining use
was in ToHexArray, which itself only had a single call site.

This just moves ToHexArray near its only remaining call site and
implements it using hexutil.Encode. This changes the default behaviour
of ToHexArray and with it the behaviour of eth_getProof. Previously we
encoded an empty slice as 0, now the empty slice is encoded as 0x.

* core/state/snapshot: fix journal recovery from generating old journal (#21775)

* core/state/snapshot: print warning if failed to resolve journal

* core/state/snapshot: fix snapshot recovery

When we meet the snapshot journal consisted with:
- disk layer generator with new-format
- diff layer journal with old-format

The base layer should be returned without error.
The broken diff layer can be reconstructed later
but we definitely don't want to reconstruct the
huge diff layer.

* core: add tests

* cmd/devp2p, internal/utesting: implement TAP output (#21760)

TAP is a text format for test results. Parsers for it are available in many languages,
making it easy to consume. I want TAP output from our protocol tests because the
Hive wrapper around them needs to know about the test names and their individual
results and logs. It would also be possible to just write this info as JSON, but I don't
want to invent a new format.

This also improves the normal console output for tests (when running without --tap).
It now prints -- RUN lines before any output from the test, and indents the log output
by one space.

* cmd/devp2p/internal/ethtest: add correct chain files and improve test output (#21782)

This PR replaces the old test genesis.json and chain.rlp files in the testdata
directory for the eth protocol test suite, and also adds documentation for
running the eth test suite locally.

It also improves the test output text and adds more timeouts.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/types, rlp: optimize derivesha (#21728)

This PR contains a minor optimization in derivesha, by exposing the RLP
int-encoding and making use of it to write integers directly to a
buffer (an RLP integer is known to never require more than 9 bytes
total). rlp.AppendUint64 might be useful in other places too.

The code assumes, just as before, that the hasher (a trie) will copy the
key internally, which it does when doing keybytesToHex(key).

Co-authored-by: Felix Lange <fjl@twurst.com>

* build: stop verbose output to keep travis from overflowing

* consensus/ethash: fix the percentage progress report

* core/state/snapshot: update generator marker in sync with flushes

* trie, tests/fuzzers: implement a stacktrie fuzzer + stacktrie fixes (#21799)

* trie: fix error in stacktrie not committing small roots

* fuzzers: make trie-fuzzer use correct returnvalues

* trie: improved tests

* tests/fuzzers: fuzzer for stacktrie vs regular trie

* test/fuzzers: make stacktrie fuzzer use 32-byte keys

* trie: fix error in stacktrie with small nodes

* trie: add (skipped) testcase for stacktrie

* tests/fuzzers: address review comments for stacktrie fuzzer

* trie: fix docs in stacktrie

* travis: drop Go 1.13 builders as it's not supported any more

* build: stop building for Ubuntu Eoan, not supported any more

* p2p/simulations/adapters/exec: fix some issues (#21801)

- Remove the ws:// prefix from the status endpoint since
  the ws:// is already included in the stack.WSEndpoint().
- Don't register the services again in the node start.
  Registration is already done in the initialization stage.
- Expose admin namespace via websocket.
  This namespace is necessary for connecting the peers via websocket.
- Offer logging relevant options for exec adapter.
  It's really painful to mix all log output in the single console. So
  this PR offers two additional options for exec adapter in this case
  testers can config the log output(e.g. file output) and log level
  for each p2p node.

* scripts: create oss-fuzz script in go-ethereum (#21808)

* fuzzers: removed fuzzbuzz configuration (#21813)

We decided to move our fuzzing efforts to oss-fuzz since fuzzbuzz is still early access.

* build: add -dlgo flag in ci.go (#21824)

This new flag downloads a known version of Go and builds with it. This
is meant for environments where we can't easily upgrade the installed Go
version.

* .travis.yml: remove install step for PR test builders

We added this step originally to avoid re-building everything
for every test. go test has become much smarter in recent go
releases, so we no longer need to install anything here.

* consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>

* build: fix regressions with the -dlgo change (#21831)

This fixes cross-build and mobile framework failures.
It also disables the mac test builder because it was failing
all the time in hard to understand ways and we can't afford
it anymore under Travis CI's new pricing.

* .travis.yml: move test builders after install builders (#21833)

* params: release Geth v1.9.24 with Go 1.15.5 (#21842)

* params: begin v1.9.25 release cycle

* crypto/bn256: improve bn256 fuzzer (#21815)

* crypto/cloudflare: fix nil deref in random G1/G2 reading

* crypto/bn256: improve fuzzer

* crypto/bn256: fix some flaws in fuzzer

* crypto/bn256: better comments for u, P and Order (#21836)

* tests/fuzzers: improve the fuzzers (#21829)

* tests/fuzzers, common/bitutil: make fuzzers use correct returnvalues + remove output

* tests/fuzzers/stacktrie: fix duplicate-key insertion in stacktrie (false positive)

* tests/fuzzers/stacktrie: fix compilation error

* tests/fuzzers: linter nits

* core/vm, protocol_params: implement eip-2565 modexp repricing (#21607)

* core/vm, protocol_params: implement eip-2565 modexp repricing

* core/vm: fix review concerns

* core, all: split vm.Context into BlockContext and TxContext (#21672)

* all: core: split vm.Config into BlockConfig and TxConfig

* core: core/vm: reset EVM between tx in block instead of creating new

* core/vm: added docs

* accounts/abi: template: set events Raw field in Parse methods (#21807)

* common: fix documentation of Address.SetBytes (#21814)

* crypto/bn256: refine comments according to #19577, #21595, and #21836 (#21847)

* consensus/ethash: fix usage of *reflect.SliceHeader (#21372)

* consensus/ethash: only use *reflect.SliceHeader, not reflect.SliceHeader. See comment here: https://github.com/golang/go/issues/40397\#issuecomment-663748689

* consensus/ethash: pr feedback from @mdempsky, makes a copy of dest such that is not mutated

* consensus/ethash: remove noop assign

* consensus/ethash: apply same fix to another location

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: remove retesteth

* crypto/secp256k1: add checking z sign in affineFromJacobian (#18419)

The z == 0 check is hit whenever we Add two points with the same x1/x2
coordinate. crypto/elliptic uses the same check in their affineFromJacobian
function. This change does not affect block processing or tx signature verification
in any way, because it does not use the Add or Double methods.

* cmd/geth: improve les test on windows (#21860)

* all: disable recording preimage of trie keys (#21402)

* cmd, core, eth, light, trie: disable recording preimage by default

* core, eth: fix unit tests

* core: fix import

* all: change to nopreimage

* cmd, core, eth, trie: use cache.preimages flag

* cmd: enable preimages for archive node

* cmd/utils, trie: simplify preimage tracking a bit

* core: fix linter

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* metrics: fix the panic for reading empty cpu stats (#21864)

* node: support expressive origin rules in ws.origins (#21481)

* Only compare hostnames in ws.origins

Also using a helper function for ToLower consolidates all preparation steps in one function for more maintainable consistency.

Spaces => tabs

Remove a semicolon

Add space at start of comment

Remove parens around conditional

Handle case wehre parsed hostname is empty

When passing a single word like \"localhost\" the parsed hostname is an empty string. Handle this and the error-parsing case together as default, and the nonempty hostname case in the conditional.

Refactor with new originIsAllowed functions

Adds originIsAllowed() & ruleAllowsOrigin(); removes prepOriginForComparison

Remove blank line

Added tests for simple allowed-orign rule

which does not specify a protocol or port, just a hostname

Fix copy-paste: `:=` => `=`

Remove parens around conditional

Remove autoadded whitespace on blank lines

Compare scheme, hostname, and port with rule

if the rule specifies those portions.

Remove one autoadded trailing whitespace

Better handle case where only origin host is given

e.g. \"localhost\"

Remove parens around conditional

Refactor: attemptWebsocketConnectionFromOrigin DRY

Include return type on helper function

Provide srv obj in helper fn

Provide srv to helper fn

Remove stray underscore

Remove blank line

parent 93e666b4c1e7e49b8406dc83ed93f4a02ea49ac1
author wbt <wbt@users.noreply.github.com> 1598559718 -0400
committer Martin Holst Swende <martin@swende.se> 1605602257 +0100
gpgsig -----BEGIN PGP SIGNATURE-----

 iQFFBAABCAAvFiEEypmrtbNuJK1doP1AaDtDjAWl3fAFAl+zi9ARHG1hcnRpbkBz
 d2VuZGUuc2UACgkQaDtDjAWl3fDRiwgAoMtzU8dwRV7Q9xkCwWEx9Wz2f3n6jUr2
 VWBycDKGKwRkPPOER3oc9kzjGU/P1tFlK07PjfnAKZ9KWzxpDcJZwYM3xCBurG7A
 16y4YsQnzgPNONv3xIkdi3RZtDBIiPFFEmdZFFvZ/jKexfI6JIYPngCAoqdTIFb9
 On/aPvvVWQn1ExfmarsvvJ7kUDUG77tZipuacEH5FfFsfelBWOEYPe+I9ToUHskv
 +qO6rOkV1Ojk8eBc6o0R1PnApwCAlEhJs7aM/SEOg4B4ZJJneiFuEXBIG9+0yS2I
 NOicuDPLGucOB5nBsfIKI3USPeE+3jxdT8go2lN5Nrhm6MimoILDsQ==
 =sgUp
 -----END PGP SIGNATURE-----

Refactor: drop err var for more concise test lines

Add several tests for new WebSocket origin checks

Remove autoadded whitespace on blank lines

Restore TestWebsocketOrigins originally-named test

and rename the others to be helpers rather than full tests

Remove autoadded whitespace on blank line

Temporarily comment out new test sets

Uncomment test around origin rule with scheme

Remove tests without scheme on browser origin

per https://github.com/ethereum/go-ethereum/pull/21481/files#r479371498

Uncomment tests with port; remove some blank lines

Handle when browser does not specify scheme/port

Uncomment test for including scheme & port in rule

Add IP tests

* node: more tests + table-driven, ws origin changes

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie, rpc, cmd/geth: fix tests on 32-bit and windows + minor rpc fixes (#21871)

* trie: fix tests to work on 32-bit systems

* les: make test work on 32-bit platform

* cmd/geth: fix windows-issues on tests

* trie: improve balance

* cmd/geth: make account tests less verbose + less mem intense

* rpc: make debug-level log output less verbose

* cmd/geth: lint

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input (#21872)

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input

* Update crypto/bn256/bn256_fuzz.go

Co-authored-by: ligi <ligi@ligi.de>

Co-authored-by: ligi <ligi@ligi.de>

* p2p: avoid spinning loop on out-of-handles (#21878)

* p2p: avoid busy-loop on temporary errors

* p2p: address review concerns

* les/utils: protect against WeightedRandomSelect overflow (#21839)

Also fixes a bug in les/flowcontrol that caused the overflow.

* github: Add new style of issue-templates

closes #20024

* tests/fuzzers/bls1381: add bls fuzzer (#21796)

* added bls fuzzer

* crypto/bls12381: revert bls-changes, fixup fuzzer tests

* fuzzers: split bls fuzzing into 8 different units

* fuzzers/bls: remove (now stale) corpus

* crypto/bls12381: added blsfuzz corpus

* fuzzers/bls12381: fix the bls corpus

* fuzzers: fix oss-fuzz script

* tests/fuzzers: fixups on bls corpus

* test/fuzzers: remove leftover corpus

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/faucet: improve handling of facebook post url (#21838)

Resolves #21532

Co-authored-by: roger <dengjun@huobi.com>

* les: fix GetProofsV2 bug (#21896)

* github: Remove vulnerability.md (#21894)

This type is automatically offered by github after changing to the new style and a security.md being present

* cmd/devp2p/internal/ethtest: add 'large announcement' tests (#21792)

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: refactored stuff a bit

* cmd/devp2p/internal/ethtest: added TestMaliciousStatus/Handshake

* cmd/devp2p/internal/ethtest: fixed rebasing issue

* happy linter, happy life

* cmd/devp2p/internal/ethtest: used readAndServe

* stuff

* cmd/devp2p/internal/ethtest: fixed test cases

* core/types: fixed typo (#21897)

* all: simplify nested complexity and if blocks ending with a return statement (#21854)

Changes:

    Simplify nested complexity
    If an if blocks ends with a return statement then remove the else nesting.

Most of the changes has also been reported in golint https://goreportcard.com/report/github.com/ethereum/go-ethereum#golint

* graphql: always return 400 if errors are present in the response (#21882)

* Make sure to return 400 when errors are present in the response

* graphql: use less memory in chainconfig for tests

Co-authored-by: Martin Holst Swende <martin@swende.se>

* all: remove redundant conversions and import names (#21903)

* p2p/discover: fix deadlock in discv5 message dispatch (#21858)

This fixes a deadlock that could occur when a response packet arrived
after a call had already received enough responses and was about to
signal completion to the dispatch loop.

Co-authored-by: Felix Lange <fjl@twurst.com>

* crypto: signing builds with signify/minisign (#21798)

* internal/build: implement signify's signing func
* Add signify to the ci utility
* fix output file format
* Add unit test for signify
* holiman's + travis' feedback
* internal/build: verify signify's output
* crypto: move signify to common dir
* use go-minisign to verify binaries
* more holiman feedback
* crypto, ci: support minisign output
* only accept one-line trusted comments
* configurable untrusted comments
* code cleanup in tests
* revert to use ed25519 from the stdlib
* bug: fix for empty untrusted comments
* write timestamp as comment if trusted comment isn't present
* rename line checker to commentHasManyLines
* crypto: added signify fuzzer (#6)
* crypto: added signify fuzzer
* stuff
* crypto: updated signify fuzzer to fuzz comments
* crypto: repro signify crashes
* rebased fuzzer on build-signify branch
* hide fuzzer behind gofuzz build flag
* extract key data inside a single function
* don't treat \r as a newline
* travis: fix signing command line
* do not use an external binary in tests
* crypto: move signify to crypto/signify
* travis: fix formatting issue
* ci: fix linter build after package move

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* accounts, signer: fix Ledger Live account derivation path (clef) (#21757)

* signer/core/api: fix derivation of ledger live accounts

For ledger hardware wallets, change account iteration as follows:

- ledger legacy: m/44'/60'/0'/X; for 0<=X<5
- ledger live: m/44'/60'/0'/0/X; for 0<=X<5

- ledger legacy: m/44'/60'/0'/X; for 0<=X<10
- ledger live: m/44'/60'/X'/0/0; for 0<=X<10

Non-ledger derivation is unchanged and remains as:
- non-ledger: m/44'/60'/0'/0/X; for 0<=X<10

* signer/core/api: derive ten default paths for all hardware wallets, plus ten legacy and ten live paths for ledger wallets

* signer/core/api: as .../0'/0/0 already included by default paths, do not include it again with ledger live paths

* accounts, signer: implement path iterators for hd wallets

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/keystore: add missing function doc for SignText (#21914)

Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>

* cmd/geth: make tests run quicker + use less memory and disk (#21919)

* cmd/devp2p/internal/ethtest: add transaction tests (#21857)

* p2p/nodestate: fix deadlock during shutdown of les server (#21927)

This PR fixes a deadlock reported here: #21925

The cause is that many operations may be pending, but if the close happens, only one of them gets awoken and exits, the others remain waiting for a signal that never comes.

* les: fix nodiscover option (#21906)

* params: update CHTs (#21941)

* eth: fix error in tracing if reexec is set (#21830)

* eth: fix error in tracing if reexec is set

* eth: change pointer embedding to value-embedding

* go.mod: update github.com/golang/snappy(#21934)

This updates the snappy library depency to include a fix for
a Go 1.16 incompatibility issue.

* cmd/devp2p: add node filter for snap + fix arg error (#21950)

* core/vm/runtime: remove duplicated line (#21956)

This line is duplicated, though it doesn't cause any issues.

* core: improve contextual information on core errors (#21869)

A lot of times when we hit 'core' errors, example: invalid tx, the information provided is
insufficient. We miss several pieces of information: what account has nonce too high,
and what transaction in that block was offending?

This PR adds that information, using the new type of wrapped errors.
It also adds a testcase which (partly) verifies the output from the errors.

The first commit changes all usage of direct equality-checks on core errors, into
using errors.Is. The second commit adds contextual information. This wraps most
of the core errors with more information, and also wraps it one more time in
stateprocessor, to further provide tx index and tx hash, if such a tx is encoutered in
a block. The third commit uses the chainmaker to try to generate chains with such
errors in them, thus triggering the errors and checking that the generated string meets
expectations.

* cmd/geth: implement vulnerability check (#21859)

* cmd/geth: implement vulnerability check

* cmd/geth: use minisign to verify vulnerability feed

* cmd/geth: add the test too

* cmd/geth: more minisig/signify testing

* cmd/geth: support multiple pubfiles for signing

* cmd/geth: add @holiman minisig pubkey

* cmd/geth: polishes on vulnerability check

* cmd/geth: fix ineffassign linter nit

* cmd/geth: add CVE to version check struct

* cmd/geth/testdata: add missing testfile

* cmd/geth: add more keys to versionchecker

* cmd/geth: support file:// URLs in version check

* cmd/geth: improve key ID printing when signature check fails

Co-authored-by: Felix Lange <fjl@twurst.com>

* les: cosmetic rewrite of the arm64 float bug workaround (#21960)

* les: revert arm float bug workaround to check go 1.15

* add traces to reproduce outside travis

* simpler workaround

* crypto/secp256k1: add workaround for go mod vendor (#21735)

Go won't vendor C files if there are no Go files present in the directory.
Workaround is to add dummy Go files.

Fixes: #20232

* accounts/abi/bind: allow specifying signer on transactOpts (#21356)

This commit enables users to specify which signer they want to use while creating their transactOpts.
Previously all contract interactions used the homestead signer. Now a user can specify whether they
want to sign with homestead or EIP155 and specify the chainID which adds another layer of security.

Closes #16484

* common: improve printing of Hash and Address (#21834)

Both Hash and Address have a String method, which returns the value as
hex with 0x prefix. They also had a Format method which tried to print
the value using printf of []byte. The way Format worked was at odds with
String though, leading to a situation where fmt.Sprintf(\"%v\", hash)
returned the decimal notation and hash.String() returned a hex string.

This commit makes it consistent again. Both types now support the %v,
%s, %q format verbs for 0x-prefixed hex output. %x, %X creates
unprefixed hex output. %d is also supported and returns the decimal
notation \"[1 2 3...]\".

For Address, the case of hex characters in %v, %s, %q output is
determined using the EIP-55 checksum. Using %x, %X with Address
disables checksumming.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core,les: headerchain import in batches (#21471)

* core: add test for headerchain inserts

* core, light: write headerchains in batches

* core: change to one callback per batch of inserted headers + review concerns

* core: error-check on batch write

* core: unexport writeHeaders

* core: remove callback parameter in InsertHeaderChain

The semantics of InsertHeaderChain are now much simpler: it is now an
all-or-nothing operation. The new WriteStatus return value allows
callers to check for the canonicality of the insertion. This change
simplifies use of HeaderChain in package les, where the callback was
previously used to post chain events.

* core: skip some hashing when writing headers

* core: less hashing in header validation

* core: fix headerchain flaw regarding blacklisted hashes

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth: add test to verify regexps in version check (#21962)

* crypto/signify, build: fix archive signing with signify (#21977)

This fixes some issues in crypto/signify and makes release signing work.

The archive signing step in ci.go used getenvBase64, which decodes the key data.
This is incorrect here because crypto/signify already base64-decodes the key.

* p2p/enode: avoid crashing for invalid IP (#21981)

The database panicked for invalid IPs. This is usually no problem
because all code paths leading to node DB access verify the IP, but it's
dangerous because improper validation can turn this panic into a DoS
vulnerability. The quick fix here is to just turn database accesses
using invalid IP into a noop. This isn't great, but I'm planning to
remove the node DB for discv5 long-term, so it should be fine to have
this quick fix for half a year.

Fixes #21849

* les, light: remove untrusted header retrieval in ODR (#21907)

* les, light: remove untrusted header retrieval in ODR

* les: polish

* light: check the hash equality in odr

* core, trie: speed up some tests with quadratic processing flaw (#21987)

This commit fixes a flaw in two testcases, and brings down the exec-time from ~40s to ~8s for trie/TestIncompleteSync.

The checkConsistency was performed over and over again on the complete set of nodes, not just the recently added, turning it into a quadratic runtime.

* les: introduce forkID (#21974)

* les: introduce forkID

* les: address comment

* build: upgrade to Go 1.15.6 (#21986)

* params: go-ethereum v1.9.25 stable

* update README.md

* update Makefile

* add mining node as bootnode

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>
Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Giuseppe Bertone <bertone.giuseppe@gmail.com>
Co-authored-by: gary rong <garyrong0905@gmail.com>
Co-authored-by: timcooijmans <timcooijmans@gmail.com>
Co-authored-by: Felix Lange <fjl@twurst.com>
Co-authored-by: Shude Li <islishude@gmail.com>
Co-authored-by: ucwong <ucwong@126.com>
Co-authored-by: libotony <liboliqi@gmail.com>
Co-authored-by: Fuyang Deng <dengfuyang@outlook.com>
Co-authored-by: Hanjiang Yu <delacroix.yu@gmail.com>
Co-authored-by: Osoro Bironga <fanosoro@gmail.com>
Co-authored-by: Osoro Bironga <osoro@doctaroo.com>
Co-authored-by: Guillaume Ballet <gballet@gmail.com>
Co-authored-by: Dan Sosedoff <dan.sosedoff@gmail.com>
Co-authored-by: Felf√∂ldi Zsolt <zsfelfoldi@gmail.com>
Co-authored-by: Julian Koh <jk2698@cornell.edu>
Co-authored-by: Kirill Elagin <kirelagin@gmail.com>
Co-authored-by: Mason Fischer <mason@kissr.co>
Co-authored-by: Vinod Damle <vdamle@users.noreply.github.com>
Co-authored-by: sarath <sarath@melvault.com>
Co-authored-by: rene <41963722+renaynay@users.noreply.github.com>
Co-authored-by: Binacs <bin646891055@gmail.com>
Co-authored-by: aaronbuchwald <aaron.buchwald56@gmail.com>
Co-authored-by: mr_franklin <mr_franklin@126.com>
Co-authored-by: shigeyuki azuchi <azuchi@chaintope.com>
Co-authored-by: Raw Pong Ghmoa <58883403+q9f@users.noreply.github.com>
Co-authored-by: meows <b5c6@protonmail.com>
Co-authored-by: hwanjo <34005989+hwanjo@users.noreply.github.com>
Co-authored-by: Kristofer Peterson <svenski123@users.noreply.github.com>
Co-authored-by: James Prestwich <10149425+prestwich@users.noreply.github.com>
Co-authored-by: Slava Karpenko <slavikus@gmail.com>
Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
Co-authored-by: Nicolas Feignon <nfeignon@gmail.com>
Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>
Co-authored-by: Sad Pencil <sadpencil@outlook.com>
Co-authored-by: Preston Van Loon <preston@prysmaticlabs.com>
Co-authored-by: Abd ar-Rahman Hamidi <bakhtiyor.h@gmail.com>
Co-authored-by: wbt <wbt@users.noreply.github.com>
Co-authored-by: ligi <ligi@ligi.de>
Co-authored-by: LieutenantRoger <dijsky_2015@hotmail.com>
Co-authored-by: roger <dengjun@huobi.com>
Co-authored-by: Alex Prut <1648497+alexprut@users.noreply.github.com>
Co-authored-by: Antoine Toulme <atoulme@users.noreply.github.com>
Co-authored-by: Nishant Das <nishdas93@gmail.com>
Co-authored-by: Pascal Dierich <pascal@merkleplant.xyz>
Co-authored-by: Chris Ziogas <ziogas_chr@hotmail.com>
Co-authored-by: Steve Ruckdashel <steven.ruckdashel@optum.com>
Co-authored-by: Li, Cheng <lob4tt@gmail.com>")`
‚Ä¶

`[409b498](/nebulaai/nbai-node/commit/409b4989098656eb7964a0c37f90f21111e81c0f)`

```
* params: update CHTs for v1.9.19

* params: release Geth v1.9.19

* params: begin v1.9.20 release cycle

* cmd/geth/tests: try to fix spurious travis failure in les tests (#21410)

* cmd/geth/tests: try to fix spurious travis failure in les tests

* cmd/geth: les_test - remove extraneous option during boot

* metrics: make meter updates lock-free (#21446)

* core/state: fixed some comments (#21450)

* build: drop disco, enable groovy on Ubuntu PPAs

* cmd/evm: statet8n output folder + tx hashes on trace filenames (#21406)

* t8ntool: add output basedir

* t8ntool: add txhash to trace filename

* t8ntool: don't default to '.' basedir, allow absolute paths

* core: more detailed metering for reorgs (#21420)

* core: define and test chain rewind corner cases (#21409)

* core: define and test chain reparation cornercases

* core: write up a variety of set-head tests

* core, eth: unify chain rollbacks, handle all the cases

* core: make linter smile

* core: remove commented out legacy code

* core, eth/downloader: fix review comments

* core: revert a removed recovery mechanism

* travis, dockerfile, appveyor, build: bump to Go 1.15

* metrics: zero temp variable in  updateMeter (#21470)

* metrics: zero temp variable in  updateMeter

Previously the temp variable was not updated properly after summing it to count.
This meant we had astronomically high metrics, now we zero out the temp whenever we
sum it onto the snapshot count

* metrics: move temp variable to be aligned, unit tests

Moves the temp variable in MeterSnapshot to be 64-bit aligned because of the atomic bug.
Adds a unit test, that catches the previous bug.

* eth/downloader: fix rollback issue on short chains

* core, eth, les, trie: add a prefix to contract code (#21080)

* core: do less lookups when writing fast-sync block bodies (#21468)

* eth: utilize sync bloom for getNodeData (#21445)

* eth/downloader, eth/handler: utilize sync bloom for getNodeData

* trie: handle if bloom is nil

* trie, downloader: check bloom nilness externally

* core/state/snapshot: reduce disk layer depth during generation

* p2p/discover: avoid dropping unverified nodes when table is almost empty (#21396)

This change improves discovery behavior in small networks. Very small
networks would often fail to bootstrap because all member nodes were
dropping table content due to findnode failure. The check is now changed
to avoid dropping nodes on findnode failure when their bucket is almost
empty. It also relaxes the liveness check requirement for FINDNODE/v4
response nodes, returning unverified nodes as results when there aren't
any verified nodes yet.

The "findnode failed" log now reports whether the node was dropped
instead of the number of results. The value of the "results" was
always zero by definition.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/rawdb: only complain loudly if truncating many items

* graphql: add support for retrieving the chain id (#21451)

* params: update CHTs for v1.9.20 release

* params: release Geth v1.9.20

* params: begin v1.9.21 release cycle

* accounts/abi/bind/backends: Disallow AdjustTime for non-empty blocks (#21334)

* accounts/abi/bind/backends: Disallow timeshift for non-empty blocks

* accounts/abi/bind/backends: added tests for adjust time

* accounts/abi/bind/simulated: added comments, fixed test for AdjustTime

* accounts/abi/bind/backends: updated comment

* core/state, eth, trie: stabilize memory use, fix memory leak

* eth: updated comments (#21490)

* go.mod | goleveldb latest update (#21448)

* go.mod | goleveldb latest update

* go.mod update

* leveldb options

* go.mod: double check

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* eth/tracers: revert reason in call_tracer + error for failed internal calls (#21387)

* tests: add testdata of call tracer

* eth/tracers: return revert reason in call_tracer

* eth/tracers: regenerate assets

* eth/tracers: add error message even if no exec occurrs, fixes #21438

Co-authored-by: Martin Holst Swende <martin@swende.se>

* rpc: fix issue with null JSON-RPC messages (#21497)

* accounts/abi: fix a bug in getTypeSize method (#21501)

* accounts/abi: fix a bug in getTypeSize method

e.g. for "Tuple[2]" type, the element of the array is a tuple type and the size of the tuple may not be 32.

* accounts/abi: add unit test of getTypeSize method

* internal: fix personal.sign() (#21503)

* "Downloader queue stats" is now provided once per minute (#21455)

* "Downloader queue stats" is now a DEBUG information

I think this info is more a DEBUG related information then an INFO. If it must remains an INFO, maybe it can be slow down to one time every 5 minutes or so.

* Update queue.go

"Downloader queue stats" information is now provided once every minute instead of once every 10 seconds.

* go.mod : update goja dependency (#21432)

* eth/downloader: change intial download size (#21366)

This changes how the downloader works, a little bit. Previously, when block sync started,
we immediately started filling up to 8192 blocks. Usually this is fine, blocks are small
in the early numbers. The threshold then is lowered as we measure the size of the blocks
that are filled.

However, if the node is shut down and restarts syncing while we're in a heavy segment,
that might be bad. This PR introduces a more conservative initial threshold of 2K blocks
instead.

* core, eth, trie: prepare trie sync for path based operation

* eth: added trace_call to trace on top of arbitrary blocks (#21338)

* eth: Added TraceTransactionPending

* eth: Implement Trace_Call, remove traceTxPending

* eth: debug_call -> debug_traceCall, recompute tx environment if pruned

* eth: fix nil panic

* eth: improve block retrieving logic in tracers

* internal/web3ext: add debug_traceCall to console

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments (#21514)

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* whisper: remove whisper (#21487)

* whisper: remove whisper

* Update cmd/geth/config.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/geth: warn on enabling whisper + remove more whisper deps

* mobile: remove all whisper references

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/usbwallet, signer/core: show accounts from ledger legacy derivation paths (#21517)

* accounts/usbwallet, signer/core: un-hide accounts from ledger legacy derivation paths

* Update accounts/usbwallet/wallet.go

* Update signer/core/api.go

* Update signer/core/api.go

* build: remove wnode from the list of packages binaries (#21526)

* .github: remove whisper from CODEOWNERS (#21527)

* params: update CHTs for v1.9.21 release

* params: release Geth v1.9.21

* params: begin v1.9.22 release cycle

* eth/downloader: only roll back light sync if not fully validating

* accounts/abi/bind/backends: reverted some stylistic changes (#21535)

* cmd, eth: offer maxprice flag for overwritting price cap (#21531)

* cmd, eth: offer maxprice flag for overwritting price cap

* eth: rename default price cap

* core/vm: fix benchmark overflow + prep for precompile repricings (#21530)

* core/vm/testdata: add gascost expectations to testcases

* core/vm: verify expected gas in tests for precompiles

* core/vm: fix overflow flaw in gas/s calculation

* go.mod: remove golang.org/x/sync (#21541)

* ethclient: add BlockNumber method (#21500)

This adds a new client method BlockNumber to fetch the most recent
block number of the chain.

* cmd/geth: print warning when whisper config is present in toml (#21544)

* cmd/geth: print warning when whisper config is present in toml

* Update cmd/geth/config.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* miner: use channels instead of atomics in update loop (#21536)

This PR changes several different things:

- Adds test cases for the miner loop
- Stops the worker if it wasn't already stopped in worker.Close()
- Uses channels instead of atomics in the miner.update() loop

Co-authored-by: Felix Lange <fjl@twurst.com>

* miner: fix regression, add test for starting while download (#21547)

Fixes a regression introduced in #21536

* p2p/discover: fix typo in comments (#21554)

* Dockerfile: unexpose port 8547 as GraphQL was merged into HTTP endpoint (#21556)

* p2p/nodestate: ensure correct callback order (#21436)

This PR adds an extra guarantee to NodeStateMachine: it ensures that all
immediate effects of a certain change are processed before any subsequent
effects of any of the immediate effects on the same node. In the original
version, if a cascaded change caused a subscription callback to be called
multiple times for the same node then these calls might have happened in a
wrong chronological order.

For example:

- a subscription to flag0 changes flag1 and flag2
- a subscription to flag1 changes flag3
- a subscription to flag1, flag2 and flag3 was called in the following order:

   [flag1] -> [flag1, flag3]
   [] -> [flag1]
   [flag1, flag3] -> [flag1, flag2, flag3]

This happened because the tree of changes was traversed in a "depth-first
order". Now it is traversed in a "breadth-first order"; each node has a
FIFO queue for pending callbacks and each triggered subscription callback
is added to the end of the list. The already existing guarantees are
retained; no SetState or SetField returns until the callback queue of the
node is empty again. Just like before, it is the responsibility of the
state machine design to ensure that infinite state loops are not possible.
Multiple changes affecting the same node can still happen simultaneously;
in this case the changes can be interleaved in the FIFO of the node but the
correct order is still guaranteed.

A new unit test is also added to verify callback order in the above scenario.

* js/tracers: make calltracer report value in selfdestructs  (#21549)

* rlp: add SplitUint64 (#21563)

This can be useful when working with raw RLP data.

* les, les/lespay/server: refactor client pool (#21236)

* les, les/lespay/server: refactor client pool

* les: use ns.Operation and sub calls where needed

* les: fixed tests

* les: removed active/inactive logic from peerSet

* les: removed active/inactive peer logic

* les: fixed linter warnings

* les: fixed more linter errors and added missing metrics

* les: addressed comments

* cmd/geth: fixed TestPriorityClient

* les: simplified clientPool state machine

* les/lespay/server: do not use goroutine for balance callbacks

* internal/web3ext: fix addBalance required parameters

* les: removed freeCapacity, always connect at minCapacity initially

* les: only allow capacity change with priority status

Co-authored-by: rjl493456442 <garyrong0905@gmail.com>

* eth/tracers: regenerate assets from #21549 (#21564)

* COYPING: restore the full text text of GPL (#21568)

When the license was added to the repository, its text was changed (some
sections at the end removed) and, worse, the authors of go-ethereum
tried to claim copyright on the license text.

The correct way to apply GPL to a project is to copy it verbatim.
This change reverts the text of the GPL to the original.

* core/rawdb: single point of maintenance for writing and deleting tx lookup indexes (#21480)

* ethclient: fix BlockNumber (#21565)

It didn't actually work because it called a method that doesn't
exist. This fixes it also adds a test.

Co-authored-by: Felix Lange <fjl@twurst.com>

* params: allow setting Petersburg block before chain head (#21473)

* Allow setting PetersburgBlock before chainhead

if it is at the same block as ConstantinopleBlock

* Add a negative test

* les/lespay/server: bump database version (#21571)

* tests/fuzzers/abi: add fuzzer for fuzzing package accounts/abi (#21217)

* tests/fuzzers/abi: added abi fuzzer

* accounts/abi: fixed issues found by fuzzing

* tests/fuzzers/abi: update fuzzers, added repro test

* tests/fuzzers/abi: renamed abi_fuzzer to abifuzzer

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: updated abi fuzzer

* accounts/abi: minor style fix

* go.mod: added go-fuzz dependency

* tests/fuzzers/abi: updated abi fuzzer

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: make linter happy

* tests/fuzzers/abi: comment out false positives

* cmd/utils: use preconfigured testnet flags instead of networkid (#21561)

* cmd/utils: use preconfigured testnet flags instead of networkid

* cmd/utils: shorter description

Co-authored-by: Martin Holst Swende <martin@swende.se>

* Update flags.go

Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: added counters to the geth inspect report (#21495)

* database: added counters

* Improved stats for ancient db

* Small improvement

* Better message and added percentage while counting receipts

* Fast counting for receipts

* added info message

* Show both receips itemscount  from ancient db and counted receipts

* Fixed default case

* Removed counter for receipts in ancient store

* Removed counting of receipts present in leveldb

* eth/downloader: dynamically move pivot even during chain sync

* core: fix a typo in comment (#21439)

* accounts/abi: improve documentation and names (#21540)

* accounts: abi/bid/backends; cleaned doc errors, camelCase refactors and anonymous variable assignments

* acounts/abi/bind: doc errors, anonymous parameter assignments

* accounts/abi: doc edits, camelCase refactors

* accounts/abi/bind: review fix

* reverted name changes

* name revert

Co-authored-by: Osoro Bironga <osoro@doctaroo.com>

* mobile: better api for java users (#21580)

* (mobile): Adds string representations for types

* mobile: better interfaces add stringer to types

Co-authored-by: sarath <sarath@melvault.com>

* p2p: move rlpx into separate package (#21464)

This change moves the RLPx protocol implementation into a separate package,
p2p/rlpx. The new package can be used to establish RLPx connections for
protocol testing purposes.

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/clef, cmd/geth: use SplitAndTrim from cmd/utils (#21579)

* trie: fix gaped range proof test case (#21484)

* trie: support empty range proof (#21199)

* internal/ethapi: add optional parameter blockNrOrHash to estimateGas (#21545)

This allows users to estimate gas on top of arbitrary blocks as well as pending and latest.
Tracing on pending is useful for most users as it takes into account the current txpool while
tracing on latest might be useful for users that have little to know knowledge of the current
transactions in the network.

If blockNrOrHash is not specified, estimateGas defaults to pending

* trie: extend range proof (#21250)

* trie: support non-existent right proof

* trie: improve test

* trie: minor linter fix

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* internal/ethapi: fix nil deref + fix estimateGas console bindings (#21601)

* tried to fix

* fix for js api

* fix for nil pointer ex

* rev space

* rev space

* input call formatter

* cmd/devp2p: add eth protocol test suite (#21598)

This change adds a test framework for the "eth" protocol and some basic
tests. The tests can be run using the './devp2p rlpx eth-test' command.

* cmd/devp2p/internal/ethtest: update version in handshake (#21603)

* cmd/devp2p/internal/ethtest: lower protocol version to 64 (#21604)

* params: update CHTs for Geth v1.9.22

* params: release Geth v1.9.22

* params: begin v1.9.23 release cycle

* accounts/abi: ABI explicit difference between Unpack and UnpackIntoInterface (#21091)

* accounts/abi: refactored abi.Unpack

* accounts/abi/bind: fixed error

* accounts/abi/bind: modified template

* accounts/abi/bind: added ToStruct for conversion

* accounts/abi: reenabled tests

* accounts/abi: fixed tests

* accounts/abi: fixed tests for packing/unpacking

* accounts/abi: fixed tests

* accounts/abi: added more logic to ToStruct

* accounts/abi/bind: fixed template

* accounts/abi/bind: fixed ToStruct conversion

* accounts/abi/: removed unused code

* accounts/abi: updated template

* accounts/abi: refactored unused code

* contracts/checkpointoracle: updated contracts to sol ^0.6.0

* accounts/abi: refactored reflection logic

* accounts/abi: less code duplication in Unpack*

* accounts/abi: fixed rebasing bug

* fix a few typos in comments

* rebase on master

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* mobile: added constructor for big int (#21597)

* mobile: added constructor for big int

* mobile: tiny nitpick

* core/vm, params: make 2200 in line with spec (#21605)

* core: free pointer from slice after popping element from price heap (#21572)

* Fix potential memory leak in price heap

* core: nil free pointer slice (alternative version)

Co-authored-by: Martin Holst Swende <martin@swende.se>

* internal/web3ext: improve eth_getBlockByNumber and eth_getBlockByHash console api (#21608)

* light: fix wrong description in a comment (#21573)

* p2p/enode: remove unused code (#21612)

* build: keep geth-sources.jar build result for JavaDoc (#21596)

* ci: tooltips for javadoc for mobile app

* f space

* cmd/bootnode,internal/debug: fix some comments (#21623)

* trie: use stacktrie for Derivesha operation (#21407)

core/types: use stacktrie for derivesha

trie: add stacktrie file

trie: fix linter

core/types: use stacktrie for derivesha

rebased: adapt stacktrie to the newer version of DeriveSha

Co-authored-by: Martin Holst Swende <martin@swende.se>

More linter fixes

review feedback: no key offset for nodes converted to hashes

trie: use EncodeRLP for full nodes

core/types: insert txs in order in derivesha

trie: tests for derivesha with stacktrie

trie: make stacktrie use pooled hashers

trie: make stacktrie reuse tmp slice space

trie: minor polishes on stacktrie

trie/stacktrie: less rlp dancing

core/types: explain the contorsions in DeriveSha

ci: fix goimport errors

trie: clear mem on subtrie hashing

squashme: linter fix

stracktrie: use pooling, less allocs (#3)

trie: in-place hex prefix, reduce allocs and add rawNode.EncodeRLP

Reintroduce the `[]node` method, add the missing `EncodeRLP` implementation for `rawNode` and calculate the hex prefix in place.

Co-authored-by: Martin Holst Swende <martin@swende.se>

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts, signer: implement gnosis safe support (#21593)

* accounts, signer: implement gnosis safe support

* common/math: add type for marshalling big to dec

* accounts, signer: properly sign gnosis requests

* signer, clef: implement account_signGnosisTx

* signer: fix auditlog print, change rpc-name (signGnosisTx to signGnosisSafeTx)

* signer: pass validation-messages/warnings to the UI for gnonsis-safe txs

* signer/core: minor change to validationmessages of typed data

* trie: polishes to trie committer (#21351)

* trie: update tests to check commit integrity

* trie: polish committer

* trie: fix typo

* trie: remove hasvalue notion

According to the benchmarks, type assertion between the pointer and
interface is extremely fast.

BenchmarkIntmethod-12           1000000000               1.91 ns/op
BenchmarkInterface-12           1000000000               2.13 ns/op
BenchmarkTypeSwitch-12          1000000000               1.81 ns/op
BenchmarkTypeAssertion-12       2000000000               1.78 ns/op

So the overhead for asserting whether the shortnode has "valuenode"
child is super tiny. No necessary to have another field.

* trie: linter nitpicks

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie: add Commit-sequence tests for stacktrie commit (#21643)

* core/state/snapshot: stop generator if it hits missing trie nodes (#21649)

* core/state/snapshot: exit Geth if generator hits missing trie nodes

* core/state/snapshot: error instead of hard die on generator fault

* core/state/snapshot: don't enable logging on the tests

* cmd/faucet: enable DNS discovery for known networks (#21636)

* params: update goerli testnet bootnodes (#21659)

* params: update pegasys besu bootnode

* params: update goerli initiative bootnodes

* core/bloombits: faster generator (#21625)

* core/bloombits: add benchmark

* core/bloombits: optimize inserts

* core/types: optimize bloom filters (#21624)

* core/types: tests for bloom

* core/types: refactored bloom filter for receipts, added tests

core/types: replaced old bloom implementation

core/types: change interface of bloom add+test

* core/types: refactor bloom

* core/types: minor tweak on LogsBloom

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/devp2p/internal/ethtest: improve eth test suite (#21615)

This fixes issues with the protocol handshake and status exchange
and adds support for responding to GetBlockHeaders requests.

* node: relax websocket connection header check (#21646)

This makes it accept the "upgrade,keep-alive" header value, which
apparently is a thing.

* signer/core: don't mismatch reject and no accounts (#21677)

* signer/core: don't mismatch reject and zero accounts, fixes #21674

* signer/core: docs

* p2p/discover: remove use of shared hash instance for key derivation (#21673)

For some reason, using the shared hash causes a cryptographic incompatibility
when using Go 1.15. I noticed this during the development of Discovery v5.1
when I added test vector verification.

The go library commit that broke this is golang/go@97240d5, but the
way we used HKDF is slightly dodgy anyway and it's not a regression.

* core/vm: dedup config check in markdown logger (#21655)

* core/vm: dedup config check

* review feedback: reuse buffer

* eth/downloader: fix data race around the ancientlimit (#21681)

* eth/downloader: fix data race around the ancientlimit

* eth/downloader: initialize the ancientlimit as 0

* eth/downloader: cache parent hash instead of recomputing (#21678)

* core: fix txpool off-by-one error (#21683)

* trie: polish commit function (#21692)

* trie: polish commit function

* trie: fix typo

* accouts, consensus, core: fix some comments (#21617)

* console: fix admin.sleepBlocks (#21629)

* all: replace RWMutex with Mutex in places where RLock is not used (#21622)

* consensus/clique: unexport calcDifficulty and improve comment (#21619)

* trie: fix flaw in stacktrie pool reuse (#21699)

* internal/web3ext: improve some web3 apis (#21639)

* imporve some web3-ext apis

* Update web3ext.go

Co-authored-by: Felix Lange <fjl@twurst.com>

* eth, p2p: use truncated names  (#21698)

* peer: return localAddr instead of name to prevent spam

We currently use the name (which can be freely set by the peer) in several log messages.
This enables malicious actors to write spam into your geth log.
This commit returns the localAddr instead of the freely settable name.

* p2p: reduce usage of peer.Name in warn messages

* eth, p2p: use truncated names

* Update peer.go

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth, cmd/utils: fixed flags name (#21700)

* miner: don't interrupt mining after successful sync (#21701)

* miner: exit loop when downloader Done or Failed

Following the logic of the comment at the method,
this fixes a regression introduced at 7cf56d6f064869cb62b1673f9ee437020c595391
, which would allow external parties to DoS with
blocks, preventing mining progress.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove ineff assign (lint)

Signed-off-by: meows <b5c6@protonmail.com>

* miner: update test re downloader events

Signed-off-by: meows <b5c6@protonmail.com>

* Revert "miner: remove ineff assign (lint)"

This reverts commit eaefcd34ab4862ebc936fb8a07578aa2744bc058.

* Revert "miner: exit loop when downloader Done or Failed"

This reverts commit 23abd34265aa246c38fc390bb72572ad6ae9fe3b.

* miner: add test showing imprecise TestMiner

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix waitForMiningState precision

This helper function would return an affirmation
on the first positive match on a desired bool.

This was imprecise; it return false positives
by not waiting initially for an 'updated' value.

This fix causes TestMiner_2 to fail, which is
expected.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: remove TestMiner_2 demonstrating broken test

This test demonstrated the imprecision of the test
helper function waitForMiningState. This function
has been fixed with 6d365c2851, and this test test
may now be removed.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix test regarding downloader event/mining expectations

See comment for logic.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: add test describing expectations for downloader/mining events

We expect that once the downloader emits a DoneEvent,
signaling a successful sync, that subsequent StartEvents
are not longer permitted to stop the miner.

This prevents a security vulnerability where forced syncs via
fake high blocks would stall mining operation.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: use 'canStop' state to fix downloader event handling

- Break downloader event handling into event
separating Done and Failed events. We need to
treat these cases differently since a DoneEvent
should prevent the miner from being stopped on
subsequent downloader Start events.

- Use canStop state to handle the one-off
case when a downloader first succeeds.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: improve comment wording

Signed-off-by: meows <b5c6@protonmail.com>

* miner: start mining on downloader events iff not already mining

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor miner update logic w/r/t downloader events

This makes mining pause/start logic regarding downloader
events more explicit. Instead of eternally handling downloader
events after the first done event, the subscription is closed
when downloader events are no longer actionable.

Signed-off-by: meows <b5c6@protonmail.com>

* miner: fix handling downloader events on subcription closed

Signed-off-by: meows <b5c6@protonmail.com>

* miner: (lint:gosimple) use range over chan instead of for/select

Signed-off-by: meows <b5c6@protonmail.com>

* miner: refactor update loop to remove race condition

The go routine handling the downloader events handling
vars in parallel with the parent routine, causing a
race condition.

This change, though ugly, remove the condition while
still allowing the downloader event subscription to be
closed when the miner has no further use for it (ie DoneEvent).

* miner: alternate fix for miner-flaw

Co-authored-by: meows <b5c6@protonmail.com>

* accounts/keystore: fix flaky test (#21703)

* accounts/keystore: add timeout to test to prevent failure on travis

The TestWalletNotifications test sporadically fails on travis.
This is because we shutdown the event collection before all events are received.
Adding a small timeout (10 milliseconds) allows the collector to be scheduled
and to consume all pending events before we shut it down.

* accounts/keystore: added newlines back in

* accounts/keystore: properly fix the walletNotifications test

* params: update CHTs (#21706)

* miner: set etherbase even if mining isn't possible at the moment (#21707)

* p2p/discover: implement v5.1 wire protocol (#21647)

This change implements the Discovery v5.1 wire protocol and
also adds an interactive test suite for this protocol.

* params: go-ethereum v1.9.23 stable

* params: begin v1.9.24 release cycle

* core/vm: marshall returnData as hexstring in trace logs (#21715)

* core/vm: marshall returnData as hexstring in trace logs

* core/vm: marshall returnData as hexstring in trace logs

* console: don't exit on ctrl-c, only on ctrl-d (#21660)

* add interrupt counter

* remove interrupt counter, allow ctrl-C to clear ONLY, ctrl-D will terminate console, stop node

* format

* add instructions to exit

* fix tests

* miner: fixed race condition in tests (#21664)

* core: track and improve tx indexing/unindexing (#21331)

* core: add background indexer to waitgroup

* core: make indexer stopable

* core/rawdb: add unit tests

* core/rawdb: fix lint

* core/rawdb: fix tests

* core/rawdb: fix linter

* eth/api: fix potential nil deref in AccountRange (#21710)

* Fix potential nil pointer error when neither block number nor hash is specified to accountRange

* Update error description

* les: remove clientPeerSet and serverSet (#21566)

* les: move NodeStateMachine from clientPool to LesServer

* les: new header broadcaster

* les: peerCommons.headInfo always contains last announced head

* les: remove clientPeerSet and serverSet

* les: fixed panic

* les: fixed --nodiscover option

* les: disconnect all peers at ns.Stop()

* les: added comments and fixed signed broadcasts

* les: removed unused parameter, fixed tests

* core: fix blockchain insert report time interval calculation (#21723)

* accounts/usbwallet: fix ledger version check (#21733)

The version check logic did not take into account the second digit (i.e. the '4' in v1.4.0) - this one line patch corrects this.

* all: implement EIP-2929 (gas cost increases for state access opcodes) + yolo-v2 (#21509)

* core/vm, core/state: implement EIP-2929 + YOLOv2

* core/state, core/vm: fix some review concerns

* core/state, core/vm: address review concerns

* core/vm: address review concerns

* core/vm: better documentation

* core/vm: unify sload cost as fully dynamic

* core/vm: fix typo

* core/vm/runtime: fix compilation flaw

* core/vm/runtime: fix renaming-err leftovers

* core/vm: renaming

* params/config: use correct yolov2 chainid for config

* core, params: use a proper new genesis for yolov2

* core/state/tests: golinter nitpicks

* cmd/devp2p/internal/ethtest: update test chain (#21742)

The old one was wrong in two ways: the first block in chain.rlp was the
genesis block, and the genesis difficulty was below minimum difficulty.

This also contains some other fixes to the test.

* utils, params: add yolov2 bootnode

* params: update yolov2 bootnode with elastic ip

* cmd/geth: fix dir path in geth attach for yolov2 network (#21749)

* accounts/abi/bind: restore error functionality (#21743)

* accounts/abi/bind: restore error functionality

* Update accounts/abi/bind/base.go

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

Co-authored-by: Guillaume Ballet <gballet@gmail.com>

* core/state: maintain one more diff layer (#21730)

* core/state: maintain one more diff layer

* core/state: address comment

* core/state: disable snapshot iteration if it's not fully constructed (#21682)

* core/state/snapshot: add diskRoot function

* core/state/snapshot: disable iteration if the snapshot is generating

* core/state/snapshot: simplify the function

* core/state: panic for undefined layer

* core: improve snapshot journal recovery (#21594)

* core/state/snapshot: introduce snapshot journal version

* core: update the disk layer in an atomic way

* core: persist the disk layer generator periodically

* core/state/snapshot: improve logging

* core/state/snapshot: forcibly ensure the legacy snapshot is matched

* core/state/snapshot: add debug logs

* core, tests: fix tests and special recovery case

* core: polish

* core: add more blockchain tests for snapshot recovery

* core/state: fix comment

* core: add recovery flag for snapshot

* core: add restart after start-after-crash tests

* core/rawdb: fix imports

* core: fix tests

* core: remove log

* core/state/snapshot: fix snapshot

* core: avoid callbacks in SetHead

* core: fix setHead cornercase where the threshold root has state

* core: small docs for the test cases

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* les, p2p/simulations/adapters: fix issues found while simulating les  (#21761)

This adds a few tiny fixes for les and the p2p simulation framework:

LES Parts

- Keep the LES-SERVER connection even it's non-synced

  We had this idea to reject the connections in LES protocol if the les-server itself is
  not synced. However, in LES protocol we will also receive the connection from another
  les-server. In this case even the local node is not synced yet, we should keep the tcp
  connection for other protocols(e.g. eth protocol).

- Don't count "invalid message" for non-existing GetBlockHeadersMsg request

  In the eth syncing mechanism (full sync, fast sync, light sync), it will try to fetch
  some non-existent blocks or headers(to ensure we indeed download all the missing chain).
  In this case, it's possible that the les-server will receive the request for
  non-existent headers. So don't count it as the "invalid message" for scheduling
  dropping.

- Copy the announce object in the closure

  Before the les-server pushes the latest headers to all connected clients, it will create
  a closure and queue it in the underlying request scheduler. In some scenarios it's
  problematic. E.g, in private networks, the block can be mined very fast. So before the
  first closure is executed, we may already update the latest_announce object. So actually
  the "announce" object we want to send is replaced.

  The downsize is the client will receive two announces with the same td and then drop the
  server.

P2P Simulation Framework

- Don't double register the protocol services in p2p-simulation "Start".

  The protocols upon the devp2p are registered in the "New node stage". So don't reigster
  them again when starting a node in the p2p simulation framework

- Add one more new config field "ExternalSigner", in order to use clef service in the
  framework.

* common: remove ToHex and ToHexArray (#21610)

ToHex was deprecated a couple years ago. The last remaining use
was in ToHexArray, which itself only had a single call site.

This just moves ToHexArray near its only remaining call site and
implements it using hexutil.Encode. This changes the default behaviour
of ToHexArray and with it the behaviour of eth_getProof. Previously we
encoded an empty slice as 0, now the empty slice is encoded as 0x.

* core/state/snapshot: fix journal recovery from generating old journal (#21775)

* core/state/snapshot: print warning if failed to resolve journal

* core/state/snapshot: fix snapshot recovery

When we meet the snapshot journal consisted with:
- disk layer generator with new-format
- diff layer journal with old-format

The base layer should be returned without error.
The broken diff layer can be reconstructed later
but we definitely don't want to reconstruct the
huge diff layer.

* core: add tests

* cmd/devp2p, internal/utesting: implement TAP output (#21760)

TAP is a text format for test results. Parsers for it are available in many languages,
making it easy to consume. I want TAP output from our protocol tests because the
Hive wrapper around them needs to know about the test names and their individual
results and logs. It would also be possible to just write this info as JSON, but I don't
want to invent a new format.

This also improves the normal console output for tests (when running without --tap).
It now prints -- RUN lines before any output from the test, and indents the log output
by one space.

* cmd/devp2p/internal/ethtest: add correct chain files and improve test output (#21782)

This PR replaces the old test genesis.json and chain.rlp files in the testdata
directory for the eth protocol test suite, and also adds documentation for
running the eth test suite locally.

It also improves the test output text and adds more timeouts.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core/types, rlp: optimize derivesha (#21728)

This PR contains a minor optimization in derivesha, by exposing the RLP
int-encoding and making use of it to write integers directly to a
buffer (an RLP integer is known to never require more than 9 bytes
total). rlp.AppendUint64 might be useful in other places too.

The code assumes, just as before, that the hasher (a trie) will copy the
key internally, which it does when doing keybytesToHex(key).

Co-authored-by: Felix Lange <fjl@twurst.com>

* build: stop verbose output to keep travis from overflowing

* consensus/ethash: fix the percentage progress report

* core/state/snapshot: update generator marker in sync with flushes

* trie, tests/fuzzers: implement a stacktrie fuzzer + stacktrie fixes (#21799)

* trie: fix error in stacktrie not committing small roots

* fuzzers: make trie-fuzzer use correct returnvalues

* trie: improved tests

* tests/fuzzers: fuzzer for stacktrie vs regular trie

* test/fuzzers: make stacktrie fuzzer use 32-byte keys

* trie: fix error in stacktrie with small nodes

* trie: add (skipped) testcase for stacktrie

* tests/fuzzers: address review comments for stacktrie fuzzer

* trie: fix docs in stacktrie

* travis: drop Go 1.13 builders as it's not supported any more

* build: stop building for Ubuntu Eoan, not supported any more

* p2p/simulations/adapters/exec: fix some issues (#21801)

- Remove the ws:// prefix from the status endpoint since
  the ws:// is already included in the stack.WSEndpoint().
- Don't register the services again in the node start.
  Registration is already done in the initialization stage.
- Expose admin namespace via websocket.
  This namespace is necessary for connecting the peers via websocket.
- Offer logging relevant options for exec adapter.
  It's really painful to mix all log output in the single console. So
  this PR offers two additional options for exec adapter in this case
  testers can config the log output(e.g. file output) and log level
  for each p2p node.

* scripts: create oss-fuzz script in go-ethereum (#21808)

* fuzzers: removed fuzzbuzz configuration (#21813)

We decided to move our fuzzing efforts to oss-fuzz since fuzzbuzz is still early access.

* build: add -dlgo flag in ci.go (#21824)

This new flag downloads a known version of Go and builds with it. This
is meant for environments where we can't easily upgrade the installed Go
version.

* .travis.yml: remove install step for PR test builders

We added this step originally to avoid re-building everything
for every test. go test has become much smarter in recent go
releases, so we no longer need to install anything here.

* consensus/ethash: use 64bit indexes for the DAG generation (#21793)

* Bit boundary fix for the DAG generation routine

* Fix unnecessary conversion warnings

Co-authored-by: Sergey Pavlov <spavlov@gmail.com>

* build: fix regressions with the -dlgo change (#21831)

This fixes cross-build and mobile framework failures.
It also disables the mac test builder because it was failing
all the time in hard to understand ways and we can't afford
it anymore under Travis CI's new pricing.

* .travis.yml: move test builders after install builders (#21833)

* params: release Geth v1.9.24 with Go 1.15.5 (#21842)

* params: begin v1.9.25 release cycle

* crypto/bn256: improve bn256 fuzzer (#21815)

* crypto/cloudflare: fix nil deref in random G1/G2 reading

* crypto/bn256: improve fuzzer

* crypto/bn256: fix some flaws in fuzzer

* crypto/bn256: better comments for u, P and Order (#21836)

* tests/fuzzers: improve the fuzzers (#21829)

* tests/fuzzers, common/bitutil: make fuzzers use correct returnvalues + remove output

* tests/fuzzers/stacktrie: fix duplicate-key insertion in stacktrie (false positive)

* tests/fuzzers/stacktrie: fix compilation error

* tests/fuzzers: linter nits

* core/vm, protocol_params: implement eip-2565 modexp repricing (#21607)

* core/vm, protocol_params: implement eip-2565 modexp repricing

* core/vm: fix review concerns

* core, all: split vm.Context into BlockContext and TxContext (#21672)

* all: core: split vm.Config into BlockConfig and TxConfig

* core: core/vm: reset EVM between tx in block instead of creating new

* core/vm: added docs

* accounts/abi: template: set events Raw field in Parse methods (#21807)

* common: fix documentation of Address.SetBytes (#21814)

* crypto/bn256: refine comments according to #19577, #21595, and #21836 (#21847)

* consensus/ethash: fix usage of *reflect.SliceHeader (#21372)

* consensus/ethash: only use *reflect.SliceHeader, not reflect.SliceHeader. See comment here: https://github.com/golang/go/issues/40397\#issuecomment-663748689

* consensus/ethash: pr feedback from @mdempsky, makes a copy of dest such that is not mutated

* consensus/ethash: remove noop assign

* consensus/ethash: apply same fix to another location

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>

* cmd/geth: remove retesteth

* crypto/secp256k1: add checking z sign in affineFromJacobian (#18419)

The z == 0 check is hit whenever we Add two points with the same x1/x2
coordinate. crypto/elliptic uses the same check in their affineFromJacobian
function. This change does not affect block processing or tx signature verification
in any way, because it does not use the Add or Double methods.

* cmd/geth: improve les test on windows (#21860)

* all: disable recording preimage of trie keys (#21402)

* cmd, core, eth, light, trie: disable recording preimage by default

* core, eth: fix unit tests

* core: fix import

* all: change to nopreimage

* cmd, core, eth, trie: use cache.preimages flag

* cmd: enable preimages for archive node

* cmd/utils, trie: simplify preimage tracking a bit

* core: fix linter

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>

* metrics: fix the panic for reading empty cpu stats (#21864)

* node: support expressive origin rules in ws.origins (#21481)

* Only compare hostnames in ws.origins

Also using a helper function for ToLower consolidates all preparation steps in one function for more maintainable consistency.

Spaces => tabs

Remove a semicolon

Add space at start of comment

Remove parens around conditional

Handle case wehre parsed hostname is empty

When passing a single word like "localhost" the parsed hostname is an empty string. Handle this and the error-parsing case together as default, and the nonempty hostname case in the conditional.

Refactor with new originIsAllowed functions

Adds originIsAllowed() & ruleAllowsOrigin(); removes prepOriginForComparison

Remove blank line

Added tests for simple allowed-orign rule

which does not specify a protocol or port, just a hostname

Fix copy-paste: `:=` => `=`

Remove parens around conditional

Remove autoadded whitespace on blank lines

Compare scheme, hostname, and port with rule

if the rule specifies those portions.

Remove one autoadded trailing whitespace

Better handle case where only origin host is given

e.g. "localhost"

Remove parens around conditional

Refactor: attemptWebsocketConnectionFromOrigin DRY

Include return type on helper function

Provide srv obj in helper fn

Provide srv to helper fn

Remove stray underscore

Remove blank line

parent 93e666b4c1e7e49b8406dc83ed93f4a02ea49ac1
author wbt <wbt@users.noreply.github.com> 1598559718 -0400
committer Martin Holst Swende <martin@swende.se> 1605602257 +0100
gpgsig -----BEGIN PGP SIGNATURE-----

 iQFFBAABCAAvFiEEypmrtbNuJK1doP1AaDtDjAWl3fAFAl+zi9ARHG1hcnRpbkBz
 d2VuZGUuc2UACgkQaDtDjAWl3fDRiwgAoMtzU8dwRV7Q9xkCwWEx9Wz2f3n6jUr2
 VWBycDKGKwRkPPOER3oc9kzjGU/P1tFlK07PjfnAKZ9KWzxpDcJZwYM3xCBurG7A
 16y4YsQnzgPNONv3xIkdi3RZtDBIiPFFEmdZFFvZ/jKexfI6JIYPngCAoqdTIFb9
 On/aPvvVWQn1ExfmarsvvJ7kUDUG77tZipuacEH5FfFsfelBWOEYPe+I9ToUHskv
 +qO6rOkV1Ojk8eBc6o0R1PnApwCAlEhJs7aM/SEOg4B4ZJJneiFuEXBIG9+0yS2I
 NOicuDPLGucOB5nBsfIKI3USPeE+3jxdT8go2lN5Nrhm6MimoILDsQ==
 =sgUp
 -----END PGP SIGNATURE-----

Refactor: drop err var for more concise test lines

Add several tests for new WebSocket origin checks

Remove autoadded whitespace on blank lines

Restore TestWebsocketOrigins originally-named test

and rename the others to be helpers rather than full tests

Remove autoadded whitespace on blank line

Temporarily comment out new test sets

Uncomment test around origin rule with scheme

Remove tests without scheme on browser origin

per https://github.com/ethereum/go-ethereum/pull/21481/files#r479371498

Uncomment tests with port; remove some blank lines

Handle when browser does not specify scheme/port

Uncomment test for including scheme & port in rule

Add IP tests

* node: more tests + table-driven, ws origin changes

Co-authored-by: Martin Holst Swende <martin@swende.se>

* trie, rpc, cmd/geth: fix tests on 32-bit and windows + minor rpc fixes (#21871)

* trie: fix tests to work on 32-bit systems

* les: make test work on 32-bit platform

* cmd/geth: fix windows-issues on tests

* trie: improve balance

* cmd/geth: make account tests less verbose + less mem intense

* rpc: make debug-level log output less verbose

* cmd/geth: lint

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input (#21872)

* crypto/bn256: fix bn256Mul fuzzer to not hang on large input

* Update crypto/bn256/bn256_fuzz.go

Co-authored-by: ligi <ligi@ligi.de>

Co-authored-by: ligi <ligi@ligi.de>

* p2p: avoid spinning loop on out-of-handles (#21878)

* p2p: avoid busy-loop on temporary errors

* p2p: address review concerns

* les/utils: protect against WeightedRandomSelect overflow (#21839)

Also fixes a bug in les/flowcontrol that caused the overflow.

* github: Add new style of issue-templates

closes #20024

* tests/fuzzers/bls1381: add bls fuzzer (#21796)

* added bls fuzzer

* crypto/bls12381: revert bls-changes, fixup fuzzer tests

* fuzzers: split bls fuzzing into 8 different units

* fuzzers/bls: remove (now stale) corpus

* crypto/bls12381: added blsfuzz corpus

* fuzzers/bls12381: fix the bls corpus

* fuzzers: fix oss-fuzz script

* tests/fuzzers: fixups on bls corpus

* test/fuzzers: remove leftover corpus

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* cmd/faucet: improve handling of facebook post url (#21838)

Resolves #21532

Co-authored-by: roger <dengjun@huobi.com>

* les: fix GetProofsV2 bug (#21896)

* github: Remove vulnerability.md (#21894)

This type is automatically offered by github after changing to the new style and a security.md being present

* cmd/devp2p/internal/ethtest: add 'large announcement' tests (#21792)

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: added large announcement tests

* cmd/devp2p/internal/ethtest: refactored stuff a bit

* cmd/devp2p/internal/ethtest: added TestMaliciousStatus/Handshake

* cmd/devp2p/internal/ethtest: fixed rebasing issue

* happy linter, happy life

* cmd/devp2p/internal/ethtest: used readAndServe

* stuff

* cmd/devp2p/internal/ethtest: fixed test cases

* core/types: fixed typo (#21897)

* all: simplify nested complexity and if blocks ending with a return statement (#21854)

Changes:

    Simplify nested complexity
    If an if blocks ends with a return statement then remove the else nesting.

Most of the changes has also been reported in golint https://goreportcard.com/report/github.com/ethereum/go-ethereum#golint

* graphql: always return 400 if errors are present in the response (#21882)

* Make sure to return 400 when errors are present in the response

* graphql: use less memory in chainconfig for tests

Co-authored-by: Martin Holst Swende <martin@swende.se>

* all: remove redundant conversions and import names (#21903)

* p2p/discover: fix deadlock in discv5 message dispatch (#21858)

This fixes a deadlock that could occur when a response packet arrived
after a call had already received enough responses and was about to
signal completion to the dispatch loop.

Co-authored-by: Felix Lange <fjl@twurst.com>

* crypto: signing builds with signify/minisign (#21798)

* internal/build: implement signify's signing func
* Add signify to the ci utility
* fix output file format
* Add unit test for signify
* holiman's + travis' feedback
* internal/build: verify signify's output
* crypto: move signify to common dir
* use go-minisign to verify binaries
* more holiman feedback
* crypto, ci: support minisign output
* only accept one-line trusted comments
* configurable untrusted comments
* code cleanup in tests
* revert to use ed25519 from the stdlib
* bug: fix for empty untrusted comments
* write timestamp as comment if trusted comment isn't present
* rename line checker to commentHasManyLines
* crypto: added signify fuzzer (#6)
* crypto: added signify fuzzer
* stuff
* crypto: updated signify fuzzer to fuzz comments
* crypto: repro signify crashes
* rebased fuzzer on build-signify branch
* hide fuzzer behind gofuzz build flag
* extract key data inside a single function
* don't treat \r as a newline
* travis: fix signing command line
* do not use an external binary in tests
* crypto: move signify to crypto/signify
* travis: fix formatting issue
* ci: fix linter build after package move

Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>

* accounts, signer: fix Ledger Live account derivation path (clef) (#21757)

* signer/core/api: fix derivation of ledger live accounts

For ledger hardware wallets, change account iteration as follows:

- ledger legacy: m/44'/60'/0'/X; for 0<=X<5
- ledger live: m/44'/60'/0'/0/X; for 0<=X<5

- ledger legacy: m/44'/60'/0'/X; for 0<=X<10
- ledger live: m/44'/60'/X'/0/0; for 0<=X<10

Non-ledger derivation is unchanged and remains as:
- non-ledger: m/44'/60'/0'/0/X; for 0<=X<10

* signer/core/api: derive ten default paths for all hardware wallets, plus ten legacy and ten live paths for ledger wallets

* signer/core/api: as .../0'/0/0 already included by default paths, do not include it again with ledger live paths

* accounts, signer: implement path iterators for hd wallets

Co-authored-by: Martin Holst Swende <martin@swende.se>

* accounts/keystore: add missing function doc for SignText (#21914)

Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>

* cmd/geth: make tests run quicker + use less memory and disk (#21919)

* cmd/devp2p/internal/ethtest: add transaction tests (#21857)

* p2p/nodestate: fix deadlock during shutdown of les server (#21927)

This PR fixes a deadlock reported here: #21925

The cause is that many operations may be pending, but if the close happens, only one of them gets awoken and exits, the others remain waiting for a signal that never comes.

* les: fix nodiscover option (#21906)

* params: update CHTs (#21941)

* eth: fix error in tracing if reexec is set (#21830)

* eth: fix error in tracing if reexec is set

* eth: change pointer embedding to value-embedding

* go.mod: update github.com/golang/snappy(#21934)

This updates the snappy library depency to include a fix for
a Go 1.16 incompatibility issue.

* cmd/devp2p: add node filter for snap + fix arg error (#21950)

* core/vm/runtime: remove duplicated line (#21956)

This line is duplicated, though it doesn't cause any issues.

* core: improve contextual information on core errors (#21869)

A lot of times when we hit 'core' errors, example: invalid tx, the information provided is
insufficient. We miss several pieces of information: what account has nonce too high,
and what transaction in that block was offending?

This PR adds that information, using the new type of wrapped errors.
It also adds a testcase which (partly) verifies the output from the errors.

The first commit changes all usage of direct equality-checks on core errors, into
using errors.Is. The second commit adds contextual information. This wraps most
of the core errors with more information, and also wraps it one more time in
stateprocessor, to further provide tx index and tx hash, if such a tx is encoutered in
a block. The third commit uses the chainmaker to try to generate chains with such
errors in them, thus triggering the errors and checking that the generated string meets
expectations.

* cmd/geth: implement vulnerability check (#21859)

* cmd/geth: implement vulnerability check

* cmd/geth: use minisign to verify vulnerability feed

* cmd/geth: add the test too

* cmd/geth: more minisig/signify testing

* cmd/geth: support multiple pubfiles for signing

* cmd/geth: add @holiman minisig pubkey

* cmd/geth: polishes on vulnerability check

* cmd/geth: fix ineffassign linter nit

* cmd/geth: add CVE to version check struct

* cmd/geth/testdata: add missing testfile

* cmd/geth: add more keys to versionchecker

* cmd/geth: support file:// URLs in version check

* cmd/geth: improve key ID printing when signature check fails

Co-authored-by: Felix Lange <fjl@twurst.com>

* les: cosmetic rewrite of the arm64 float bug workaround (#21960)

* les: revert arm float bug workaround to check go 1.15

* add traces to reproduce outside travis

* simpler workaround

* crypto/secp256k1: add workaround for go mod vendor (#21735)

Go won't vendor C files if there are no Go files present in the directory.
Workaround is to add dummy Go files.

Fixes: #20232

* accounts/abi/bind: allow specifying signer on transactOpts (#21356)

This commit enables users to specify which signer they want to use while creating their transactOpts.
Previously all contract interactions used the homestead signer. Now a user can specify whether they
want to sign with homestead or EIP155 and specify the chainID which adds another layer of security.

Closes #16484

* common: improve printing of Hash and Address (#21834)

Both Hash and Address have a String method, which returns the value as
hex with 0x prefix. They also had a Format method which tried to print
the value using printf of []byte. The way Format worked was at odds with
String though, leading to a situation where fmt.Sprintf("%v", hash)
returned the decimal notation and hash.String() returned a hex string.

This commit makes it consistent again. Both types now support the %v,
%s, %q format verbs for 0x-prefixed hex output. %x, %X creates
unprefixed hex output. %d is also supported and returns the decimal
notation "[1 2 3...]".

For Address, the case of hex characters in %v, %s, %q output is
determined using the EIP-55 checksum. Using %x, %X with Address
disables checksumming.

Co-authored-by: Felix Lange <fjl@twurst.com>

* core,les: headerchain import in batches (#21471)

* core: add test for headerchain inserts

* core, light: write headerchains in batches

* core: change to one callback per batch of inserted headers + review concerns

* core: error-check on batch write

* core: unexport writeHeaders

* core: remove callback parameter in InsertHeaderChain

The semantics of InsertHeaderChain are now much simpler: it is now an
all-or-nothing operation. The new WriteStatus return value allows
callers to check for the canonicality of the insertion. This change
simplifies use of HeaderChain in package les, where the callback was
previously used to post chain events.

* core: skip some hashing when writing headers

* core: less hashing in header validation

* core: fix headerchain flaw regarding blacklisted hashes

Co-authored-by: Felix Lange <fjl@twurst.com>

* cmd/geth: add test to verify regexps in version check (#21962)

* crypto/signify, build: fix archive signing with signify (#21977)

This fixes some issues in crypto/signify and makes release signing work.

The archive signing step in ci.go used getenvBase64, which decodes the key data.
This is incorrect here because crypto/signify already base64-decodes the key.

* p2p/enode: avoid crashing for invalid IP (#21981)

The database panicked for invalid IPs. This is usually no problem
because all code paths leading to node DB access verify the IP, but it's
dangerous because improper validation can turn this panic into a DoS
vulnerability. The quick fix here is to just turn database accesses
using invalid IP into a noop. This isn't great, but I'm planning to
remove the node DB for discv5 long-term, so it should be fine to have
this quick fix for half a year.

Fixes #21849

* les, light: remove untrusted header retrieval in ODR (#21907)

* les, light: remove untrusted header retrieval in ODR

* les: polish

* light: check the hash equality in odr

* core, trie: speed up some tests with quadratic processing flaw (#21987)

This commit fixes a flaw in two testcases, and brings down the exec-time from ~40s to ~8s for trie/TestIncompleteSync.

The checkConsistency was performed over and over again on the complete set of nodes, not just the recently added, turning it into a quadratic runtime.

* les: introduce forkID (#21974)

* les: introduce forkID

* les: address comment

* build: upgrade to Go 1.15.6 (#21986)

* params: go-ethereum v1.9.25 stable

* update README.md

* update Makefile

* add mining node as bootnode

Co-authored-by: P√©ter Szil√°gyi <peterke@gmail.com>
Co-authored-by: Martin Holst Swende <martin@swende.se>
Co-authored-by: Marius van der Wijden <m.vanderwijden@live.de>
Co-authored-by: Giuseppe Bertone <bertone.giuseppe@gmail.com>
Co-authored-by: gary rong <garyrong0905@gmail.com>
Co-authored-by: timcooijmans <timcooijmans@gmail.com>
Co-authored-by: Felix Lange <fjl@twurst.com>
Co-authored-by: Shude Li <islishude@gmail.com>
Co-authored-by: ucwong <ucwong@126.com>
Co-authored-by: libotony <liboliqi@gmail.com>
Co-authored-by: Fuyang Deng <dengfuyang@outlook.com>
Co-authored-by: Hanjiang Yu <delacroix.yu@gmail.com>
Co-authored-by: Osoro Bironga <fanosoro@gmail.com>
Co-authored-by: Osoro Bironga <osoro@doctaroo.com>
Co-authored-by: Guillaume Ballet <gballet@gmail.com>
Co-authored-by: Dan Sosedoff <dan.sosedoff@gmail.com>
Co-authored-by: Felf√∂ldi Zsolt <zsfelfoldi@gmail.com>
Co-authored-by: Julian Koh <jk2698@cornell.edu>
Co-authored-by: Kirill Elagin <kirelagin@gmail.com>
Co-authored-by: Mason Fischer <mason@kissr.co>
Co-authored-by: Vinod Damle <vdamle@users.noreply.github.com>
Co-authored-by: sarath <sarath@melvault.com>
Co-authored-by: rene <41963722+renaynay@users.noreply.github.com>
Co-authored-by: Binacs <bin646891055@gmail.com>
Co-authored-by: aaronbuchwald <aaron.buchwald56@gmail.com>
Co-authored-by: mr_franklin <mr_franklin@126.com>
Co-authored-by: shigeyuki azuchi <azuchi@chaintope.com>
Co-authored-by: Raw Pong Ghmoa <58883403+q9f@users.noreply.github.com>
Co-authored-by: meows <b5c6@protonmail.com>
Co-authored-by: hwanjo <34005989+hwanjo@users.noreply.github.com>
Co-authored-by: Kristofer Peterson <svenski123@users.noreply.github.com>
Co-authored-by: James Prestwich <10149425+prestwich@users.noreply.github.com>
Co-authored-by: Slava Karpenko <slavikus@gmail.com>
Co-authored-by: Sergey Pavlov <spavlov@gmail.com>
Co-authored-by: Nicolas Feignon <nfeignon@gmail.com>
Co-authored-by: Pascal Dierich <pascal@pascaldierich.com>
Co-authored-by: Sad Pencil <sadpencil@outlook.com>
Co-authored-by: Preston Van Loon <preston@prysmaticlabs.com>
Co-authored-by: Abd ar-Rahman Hamidi <bakhtiyor.h@gmail.com>
Co-authored-by: wbt <wbt@users.noreply.github.com>
Co-authored-by: ligi <ligi@ligi.de>
Co-authored-by: LieutenantRoger <dijsky_2015@hotmail.com>
Co-authored-by: roger <dengjun@huobi.com>
Co-authored-by: Alex Prut <1648497+alexprut@users.noreply.github.com>
Co-authored-by: Antoine Toulme <atoulme@users.noreply.github.com>
Co-authored-by: Nishant Das <nishdas93@gmail.com>
Co-authored-by: Pascal Dierich <pascal@merkleplant.xyz>
Co-authored-by: Chris Ziogas <ziogas_chr@hotmail.com>
Co-authored-by: Steve Ruckdashel <steven.ruckdashel@optum.com>
Co-authored-by: Li, Cheng <lob4tt@gmail.com>
```

[![@quorumbot](https://avatars.githubusercontent.com/u/46820074?s=40&v=4)](/quorumbot)
[quorumbot](/quorumbot)
mentioned this pull request
[Jun 21, 2021](#ref-pullrequest-926255593)

[[Upgrade] Go-Ethereum release v1.9.24
Consensys/quorum#1219](/Consensys/quorum/pull/1219)
 Merged

9 tasks

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=40&v=4)](/karalabe)
[karalabe](/karalabe)
mentioned this pull request
[Oct 12, 2021](#ref-issue-1023496294)

[The dag generated by ‚Äòmakedag‚Äô is incorrect
#23716](/ethereum/go-ethereum/issues/23716)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fpull%2F21793)

Reviewers

[![@MariusVanDerWijden](https://avatars.githubusercontent.com/u/16664698?s=40&v=4)](/MariusVanDerWijden) [MariusVanDerWijden](/MariusVanDerWijden)

MariusVanDerWijden left review comments

[![@holiman](https://avatars.githubusercontent.com/u/142290?s=40&v=4)](/holiman) [holiman](/holiman)

holiman approved these changes

[![@karalabe](https://avatars.githubusercontent.com/u/129561?s=40&v=4)](/karalabe) [karalabe](/karalabe)

 Awaiting requested review from karalabe

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

 [**1.9.24**](/ethereum/go-ethereum/milestone/110 "1.9.24")

Development

Successfully merging this pull request may close these issues.

8 participants

[![@slavikus](https://avatars.githubusercontent.com/u/143051?s=52&v=4)](/slavikus) [![@karalabe](https://avatars.githubusercontent.com/u/129561?s=52&v=4)](/karalabe) [![@q9f](https://avatars.githubusercontent.com/u/58883403?s=52&v=4)](/q9f) [![@holiman](https://avatars.githubusercontent.com/u/142290?s=52&v=4)](/holiman) [![@adria0](https://avatars.githubusercontent.com/u/5526331?s=52&v=4)](/adria0) [![@niklasad1](https://avatars.githubusercontent.com/u/14157425?s=52&v=4)](/niklasad1) [![@MariusVanDerWijden](https://avatars.githubusercontent.com/u/16664698?s=52&v=4)](/MariusVanDerWijden) [![@shrikus](https://avatars.githubusercontent.com/u/11415087?s=52&v=4)](/shrikus)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_db443a86_20250119_140037.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ethereum%2Fgo-ethereum)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ethereum](/ethereum)
/
**[go-ethereum](/ethereum/go-ethereum)**
Public

* [Notifications](/login?return_to=%2Fethereum%2Fgo-ethereum) You must be signed in to change notification settings
* [Fork
  20.4k](/login?return_to=%2Fethereum%2Fgo-ethereum)
* [Star
   48.2k](/login?return_to=%2Fethereum%2Fgo-ethereum)

Go implementation of the Ethereum protocol

[geth.ethereum.org](https://geth.ethereum.org "https://geth.ethereum.org")

### License

LGPL-3.0, GPL-3.0 licenses found

### Licenses found

[LGPL-3.0
COPYING.LESSER](/ethereum/go-ethereum/blob/master/./COPYING.LESSER) [GPL-3.0
COPYING](/ethereum/go-ethereum/blob/master/./COPYING)

[48.2k
stars](/ethereum/go-ethereum/stargazers) [20.4k
forks](/ethereum/go-ethereum/forks) [Branches](/ethereum/go-ethereum/branches) [Tags](/ethereum/go-ethereum/tags) [Activity](/ethereum/go-ethereum/activity)
 [Star](/login?return_to=%2Fethereum%2Fgo-ethereum)

 [Notifications](/login?return_to=%2Fethereum%2Fgo-ethereum) You must be signed in to change notification settings

* [Code](/ethereum/go-ethereum)
* [Issues
  192](/ethereum/go-ethereum/issues)
* [Pull requests
  101](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects
  0](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

Additional navigation options

* [Code](/ethereum/go-ethereum)
* [Issues](/ethereum/go-ethereum/issues)
* [Pull requests](/ethereum/go-ethereum/pulls)
* [Actions](/ethereum/go-ethereum/actions)
* [Projects](/ethereum/go-ethereum/projects)
* [Wiki](/ethereum/go-ethereum/wiki)
* [Security](/ethereum/go-ethereum/security)
* [Insights](/ethereum/go-ethereum/pulse)

# ethereum/go-ethereum

   ¬†master[Branches](/ethereum/go-ethereum/branches)[Tags](/ethereum/go-ethereum/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit¬†History[15,644 Commits](/ethereum/go-ethereum/commits/master/) | | |
| [.github](/ethereum/go-ethereum/tree/master/.github ".github") | | [.github](/ethereum/go-ethereum/tree/master/.github ".github") |  |  |
| [accounts](/ethereum/go-ethereum/tree/master/accounts "accounts") | | [accounts](/ethereum/go-ethereum/tree/master/accounts "accounts") |  |  |
| [beacon](/ethereum/go-ethereum/tree/master/beacon "beacon") | | [beacon](/ethereum/go-ethereum/tree/master/beacon "beacon") |  |  |
| [build](/ethereum/go-ethereum/tree/master/build "build") | | [build](/ethereum/go-ethereum/tree/master/build "build") |  |  |
| [cmd](/ethereum/go-ethereum/tree/master/cmd "cmd") | | [cmd](/ethereum/go-ethereum/tree/master/cmd "cmd") |  |  |
| [common](/ethereum/go-ethereum/tree/master/common "common") | | [common](/ethereum/go-ethereum/tree/master/common "common") |  |  |
| [consensus](/ethereum/go-ethereum/tree/master/consensus "consensus") | | [consensus](/ethereum/go-ethereum/tree/master/consensus "consensus") |  |  |
| [console](/ethereum/go-ethereum/tree/master/console "console") | | [console](/ethereum/go-ethereum/tree/master/console "console") |  |  |
| [core](/ethereum/go-ethereum/tree/master/core "core") | | [core](/ethereum/go-ethereum/tree/master/core "core") |  |  |
| [crypto](/ethereum/go-ethereum/tree/master/crypto "crypto") | | [crypto](/ethereum/go-ethereum/tree/master/crypto "crypto") |  |  |
| [docs](/ethereum/go-ethereum/tree/master/docs "docs") | | [docs](/ethereum/go-ethereum/tree/master/docs "docs") |  |  |
| [eth](/ethereum/go-ethereum/tree/master/eth "eth") | | [eth](/ethereum/go-ethereum/tree/master/eth "eth") |  |  |
| [ethclient](/ethereum/go-ethereum/tree/master/ethclient "ethclient") | | [ethclient](/ethereum/go-ethereum/tree/master/ethclient "ethclient") |  |  |
| [ethdb](/ethereum/go-ethereum/tree/master/ethdb "ethdb") | | [ethdb](/ethereum/go-ethereum/tree/master/ethdb "ethdb") |  |  |
| [ethstats](/ethereum/go-ethereum/tree/master/ethstats "ethstats") | | [ethstats](/ethereum/go-ethereum/tree/master/ethstats "ethstats") |  |  |
| [event](/ethereum/go-ethereum/tree/master/event "event") | | [event](/ethereum/go-ethereum/tree/master/event "event") |  |  |
| [graphql](/ethereum/go-ethereum/tree/master/graphql "graphql") | | [graphql](/ethereum/go-ethereum/tree/master/graphql "graphql") |  |  |
| [internal](/ethereum/go-ethereum/tree/master/internal "internal") | | [internal](/ethereum/go-ethereum/tree/master/internal "internal") |  |  |
| [log](/ethereum/go-ethereum/tree/master/log "log") | | [log](/ethereum/go-ethereum/tree/master/log "log") |  |  |
| [metrics](/ethereum/go-ethereum/tree/master/metrics "metrics") | | [metrics](/ethereum/go-ethereum/tree/master/metrics "metrics") |  |  |
| [miner](/ethereum/go-ethereum/tree/master/miner "miner") | | [miner](/ethereum/go-ethereum/tree/master/miner "miner") |  |  |
| [node](/ethereum/go-ethereum/tree/master/node "node") | | [node](/ethereum/go-ethereum/tree/master/node "node") |  |  |
| [p2p](/ethereum/go-ethereum/tree/master/p2p "p2p") | | [p2p](/ethereum/go-ethereum/tree/master/p2p "p2p") |  |  |
| [params](/ethereum/go-ethereum/tree/master/params "params") | | [params](/ethereum/go-ethereum/tree/master/params "params") |  |  |
| [rlp](/ethereum/go-ethereum/tree/master/rlp "rlp") | | [rlp](/ethereum/go-ethereum/tree/master/rlp "rlp") |  |  |
| [rpc](/ethereum/go-ethereum/tree/master/rpc "rpc") | | [rpc](/ethereum/go-ethereum/tree/master/rpc "rpc") |  |  |
| [signer](/ethereum/go-ethereum/tree/master/signer "signer") | | [signer](/ethereum/go-ethereum/tree/master/signer "signer") |  |  |
| [tests](/ethereum/go-ethereum/tree/master/tests "tests") | | [tests](/ethereum/go-ethereum/tree/master/tests "tests") |  |  |
| [trie](/ethereum/go-ethereum/tree/master/trie "trie") | | [trie](/ethereum/go-ethereum/tree/master/trie "trie") |  |  |
| [triedb](/ethereum/go-ethereum/tree/master/triedb "triedb") | | [triedb](/ethereum/go-ethereum/tree/master/triedb "triedb") |  |  |
| [version](/ethereum/go-ethereum/tree/master/version "version") | | [version](/ethereum/go-ethereum/tree/master/version "version") |  |  |
| [.dockerignore](/ethereum/go-ethereum/blob/master/.dockerignore ".dockerignore") | | [.dockerignore](/ethereum/go-ethereum/blob/master/.dockerignore ".dockerignore") |  |  |
| [.gitattributes](/ethereum/go-ethereum/blob/master/.gitattributes ".gitattributes") | | [.gitattributes](/ethereum/go-ethereum/blob/master/.gitattributes ".gitattributes") |  |  |
| [.gitignore](/ethereum/go-ethereum/blob/master/.gitignore ".gitignore") | | [.gitignore](/ethereum/go-ethereum/blob/master/.gitignore ".gitignore") |  |  |
| [.gitmodules](/ethereum/go-ethereum/blob/master/.gitmodules ".gitmodules") | | [.gitmodules](/ethereum/go-ethereum/blob/master/.gitmodules ".gitmodules") |  |  |
| [.golangci.yml](/ethereum/go-ethereum/blob/master/.golangci.yml ".golangci.yml") | | [.golangci.yml](/ethereum/go-ethereum/blob/master/.golangci.yml ".golangci.yml") |  |  |
| [.mailmap](/ethereum/go-ethereum/blob/master/.mailmap ".mailmap") | | [.mailmap](/ethereum/go-ethereum/blob/master/.mailmap ".mailmap") |  |  |
| [.travis.yml](/ethereum/go-ethereum/blob/master/.travis.yml ".travis.yml") | | [.travis.yml](/ethereum/go-ethereum/blob/master/.travis.yml ".travis.yml") |  |  |
| [AUTHORS](/ethereum/go-ethereum/blob/master/AUTHORS "AUTHORS") | | [AUTHORS](/ethereum/go-ethereum/blob/master/AUTHORS "AUTHORS") |  |  |
| [COPYING](/ethereum/go-ethereum/blob/master/COPYING "COPYING") | | [COPYING](/ethereum/go-ethereum/blob/master/COPYING "COPYING") |  |  |
| [COPYING.LESSER](/ethereum/go-ethereum/blob/master/COPYING.LESSER "COPYING.LESSER") | | [COPYING.LESSER](/ethereum/go-ethereum/blob/master/COPYING.LESSER "COPYING.LESSER") |  |  |
| [Dockerfile](/ethereum/go-ethereum/blob/master/Dockerfile "Dockerfile") | | [Dockerfile](/ethereum/go-ethereum/blob/master/Dockerfile "Dockerfile") |  |  |
| [Dockerfile.alltools](/ethereum/go-ethereum/blob/master/Dockerfile.alltools "Dockerfile.alltools") | | [Dockerfile.alltools](/ethereum/go-ethereum/blob/master/Dockerfile.alltools "Dockerfile.alltools") |  |  |
| [Makefile](/ethereum/go-ethereum/blob/master/Makefile "Makefile") | | [Makefile](/ethereum/go-ethereum/blob/master/Makefile "Makefile") |  |  |
| [README.md](/ethereum/go-ethereum/blob/master/README.md "README.md") | | [README.md](/ethereum/go-ethereum/blob/master/README.md "README.md") |  |  |
| [SECURITY.md](/ethereum/go-ethereum/blob/master/SECURITY.md "SECURITY.md") | | [SECURITY.md](/ethereum/go-ethereum/blob/master/SECURITY.md "SECURITY.md") |  |  |
| [appveyor.yml](/ethereum/go-ethereum/blob/master/appveyor.yml "appveyor.yml") | | [appveyor.yml](/ethereum/go-ethereum/blob/master/appveyor.yml "appveyor.yml") |  |  |
| [circle.yml](/ethereum/go-ethereum/blob/master/circle.yml "circle.yml") | | [circle.yml](/ethereum/go-ethereum/blob/master/circle.yml "circle.yml") |  |  |
| [go.mod](/ethereum/go-ethereum/blob/master/go.mod "go.mod") | | [go.mod](/ethereum/go-ethereum/blob/master/go.mod "go.mod") |  |  |
| [go.sum](/ethereum/go-ethereum/blob/master/go.sum "go.sum") | | [go.sum](/ethereum/go-ethereum/blob/master/go.sum "go.sum") |  |  |
| [interfaces.go](/ethereum/go-ethereum/blob/master/interfaces.go "interfaces.go") | | [interfaces.go](/ethereum/go-ethereum/blob/master/interfaces.go "interfaces.go") |  |  |
| [oss-fuzz.sh](/ethereum/go-ethereum/blob/master/oss-fuzz.sh "oss-fuzz.sh") | | [oss-fuzz.sh](/ethereum/go-ethereum/blob/master/oss-fuzz.sh "oss-fuzz.sh") |  |  |
| View all files | | |

## Repository files navigation

* README
* LGPL-3.0 license
* GPL-3.0 license
* Security
## Go Ethereum

Golang execution layer implementation of the Ethereum protocol.

[![API Reference](https://camo.githubusercontent.com/2063f3f9554951409bbfe24df02fdb42654b032b1f13062829c198b58f836335/68747470733a2f2f706b672e676f2e6465762f62616467652f6769746875622e636f6d2f657468657265756d2f676f2d657468657265756d)](https://pkg.go.dev/github.com/ethereum/go-ethereum?tab=doc)
[![Go Report Card](https://camo.githubusercontent.com/548ff1aa3150077dfc6edf04f27a6e191433c70acd013fe916fa2d17b7665d1e/68747470733a2f2f676f7265706f7274636172642e636f6d2f62616467652f6769746875622e636f6d2f657468657265756d2f676f2d657468657265756d)](https://goreportcard.com/report/github.com/ethereum/go-ethereum)
[![Travis](https://camo.githubusercontent.com/db03d3908fbf7668dc05968e7fced545c284c9bc7ec2c47947f1686ca7d0c974/68747470733a2f2f6170702e7472617669732d63692e636f6d2f657468657265756d2f676f2d657468657265756d2e7376673f6272616e63683d6d6173746572)](https://app.travis-ci.com/github/ethereum/go-ethereum)
[![Discord](https://camo.githubusercontent.com/f5d766cf99ace674024b36ce539f688b75b427ac2be322c29fbadcd864e1a86d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f646973636f72642d6a6f696e253230636861742d626c75652e737667)](https://discord.gg/nthXNEv)

Automated builds are available for stable releases and the unstable master branch. Binary
archives are published at <https://geth.ethereum.org/downloads/>.

## Building the source

For prerequisites and detailed build instructions please read the [Installation Instructions](https://geth.ethereum.org/docs/getting-started/installing-geth).

Building `geth` requires both a Go (version 1.22 or later) and a C compiler. You can install
them using your favourite package manager. Once the dependencies are installed, run

```
make geth
```

or, to build the full suite of utilities:

```
make all
```

## Executables

The go-ethereum project comes with several wrappers/executables found in the `cmd`
directory.

| Command | Description |
| --- | --- |
| **`geth`** | Our main Ethereum CLI client. It is the entry point into the Ethereum network (main-, test- or private net), capable of running as a full node (default), archive node (retaining all historical state) or a light node (retrieving data live). It can be used by other processes as a gateway into the Ethereum network via JSON RPC endpoints exposed on top of HTTP, WebSocket and/or IPC transports. `geth --help` and the [CLI page](https://geth.ethereum.org/docs/fundamentals/command-line-options) for command line options. |
| `clef` | Stand-alone signing tool, which can be used as a backend signer for `geth`. |
| `devp2p` | Utilities to interact with nodes on the networking layer, without running a full blockchain. |
| `abigen` | Source code generator to convert Ethereum contract definitions into easy-to-use, compile-time type-safe Go packages. It operates on plain [Ethereum contract ABIs](https://docs.soliditylang.org/en/develop/abi-spec.html) with expanded functionality if the contract bytecode is also available. However, it also accepts Solidity source files, making development much more streamlined. Please see our [Native DApps](https://geth.ethereum.org/docs/developers/dapp-developer/native-bindings) page for details. |
| `evm` | Developer utility version of the EVM (Ethereum Virtual Machine) that is capable of running bytecode snippets within a configurable environment and execution mode. Its purpose is to allow isolated, fine-grained debugging of EVM opcodes (e.g. `evm --code 60ff60ff --debug run`). |
| `rlpdump` | Developer utility tool to convert binary RLP ([Recursive Length Prefix](https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp)) dumps (data encoding used by the Ethereum protocol both network as well as consensus wise) to user-friendlier hierarchical representation (e.g. `rlpdump --hex CE0183FFFFFFC4C304050583616263`). |

## Running `geth`

Going through all the possible command line flags is out of scope here (please consult our
[CLI Wiki page](https://geth.ethereum.org/docs/fundamentals/command-line-options)),
but we've enumerated a few common parameter combos to get you up to speed quickly
on how you can run your own `geth` instance.

### Hardware Requirements

Minimum:

* CPU with 4+ cores
* 8GB RAM
* 1TB free storage space to sync the Mainnet
* 8 MBit/sec download Internet service

Recommended:

* Fast CPU with 8+ cores
* 16GB+ RAM
* High-performance SSD with at least 1TB of free space
* 25+ MBit/sec download Internet service

### Full node on the main Ethereum network

By far the most common scenario is people wanting to simply interact with the Ethereum
network: create accounts; transfer funds; deploy and interact with contracts. For this
particular use case, the user doesn't care about years-old historical data, so we can
sync quickly to the current state of the network. To do so:

```
$ geth console
```

This command will:

* Start `geth` in snap sync mode (default, can be changed with the `--syncmode` flag),
  causing it to download more data in exchange for avoiding processing the entire history
  of the Ethereum network, which is very CPU intensive.
* Start the built-in interactive [JavaScript console](https://geth.ethereum.org/docs/interacting-with-geth/javascript-console),
  (via the trailing `console` subcommand) through which you can interact using [`web3` methods](https://github.com/ChainSafe/web3.js/blob/0.20.7/DOCUMENTATION.md)
  (note: the `web3` version bundled within `geth` is very old, and not up to date with official docs),
  as well as `geth`'s own [management APIs](https://geth.ethereum.org/docs/interacting-with-geth/rpc).
  This tool is optional and if you leave it out you can always attach it to an already running
  `geth` instance with `geth attach`.

### A Full node on the Holesky test network

Transitioning towards developers, if you'd like to play around with creating Ethereum
contracts, you almost certainly would like to do that without any real money involved until
you get the hang of the entire system. In other words, instead of attaching to the main
network, you want to join the **test** network with your node, which is fully equivalent to
the main network, but with play-Ether only.

```
$ geth --holesky console
```

The `console` subcommand has the same meaning as above and is equally
useful on the testnet too.

Specifying the `--holesky` flag, however, will reconfigure your `geth` instance a bit:

* Instead of connecting to the main Ethereum network, the client will connect to the Holesky
  test network, which uses different P2P bootnodes, different network IDs and genesis
  states.
* Instead of using the default data directory (`~/.ethereum` on Linux for example), `geth`
  will nest itself one level deeper into a `holesky` subfolder (`~/.ethereum/holesky` on
  Linux). Note, on OSX and Linux this also means that attaching to a running testnet node
  requires the use of a custom endpoint since `geth attach` will try to attach to a
  production node endpoint by default, e.g.,
  `geth attach <datadir>/holesky/geth.ipc`. Windows users are not affected by
  this.

*Note: Although some internal protective measures prevent transactions from
crossing over between the main network and test network, you should always
use separate accounts for play and real money. Unless you manually move
accounts, `geth` will by default correctly separate the two networks and will not make any
accounts available between them.*

### Configuration

As an alternative to passing the numerous flags to the `geth` binary, you can also pass a
configuration file via:

```
$ geth --config /path/to/your_config.toml
```

To get an idea of how the file should look like you can use the `dumpconfig` subcommand to
export your existing configuration:

```
$ geth --your-favourite-flags dumpconfig
```

#### Docker quick start

One of the quickest ways to get Ethereum up and running on your machine is by using
Docker:

```
docker run -d --name ethereum-node -v /Users/alice/ethereum:/root \
           -p 8545:8545 -p 30303:30303 \
           ethereum/client-go
```

This will start `geth` in snap-sync mode with a DB memory allowance of 1GB, as the
above command does. It will also create a persistent volume in your home directory for
saving your blockchain as well as map the default ports. There is also an `alpine` tag
available for a slim version of the image.

Do not forget `--http.addr 0.0.0.0`, if you want to access RPC from other containers
and/or hosts. By default, `geth` binds to the local interface and RPC endpoints are not
accessible from the outside.

### Programmatically interfacing `geth` nodes

As a developer, sooner rather than later you'll want to start interacting with `geth` and the
Ethereum network via your own programs and not manually through the console. To aid
this, `geth` has built-in support for a JSON-RPC based APIs ([standard APIs](https://ethereum.github.io/execution-apis/api-documentation/)
and [`geth` specific APIs](https://geth.ethereum.org/docs/interacting-with-geth/rpc)).
These can be exposed via HTTP, WebSockets and IPC (UNIX sockets on UNIX based
platforms, and named pipes on Windows).

The IPC interface is enabled by default and exposes all the APIs supported by `geth`,
whereas the HTTP and WS interfaces need to manually be enabled and only expose a
subset of APIs due to security reasons. These can be turned on/off and configured as
you'd expect.

HTTP based JSON-RPC API options:

* `--http` Enable the HTTP-RPC server
* `--http.addr` HTTP-RPC server listening interface (default: `localhost`)
* `--http.port` HTTP-RPC server listening port (default: `8545`)
* `--http.api` API's offered over the HTTP-RPC interface (default: `eth,net,web3`)
* `--http.corsdomain` Comma separated list of domains from which to accept cross origin requests (browser enforced)
* `--ws` Enable the WS-RPC server
* `--ws.addr` WS-RPC server listening interface (default: `localhost`)
* `--ws.port` WS-RPC server listening port (default: `8546`)
* `--ws.api` API's offered over the WS-RPC interface (default: `eth,net,web3`)
* `--ws.origins` Origins from which to accept WebSocket requests
* `--ipcdisable` Disable the IPC-RPC server
* `--ipcpath` Filename for IPC socket/pipe within the datadir (explicit paths escape it)

You'll need to use your own programming environments' capabilities (libraries, tools, etc) to
connect via HTTP, WS or IPC to a `geth` node configured with the above flags and you'll
need to speak [JSON-RPC](https://www.jsonrpc.org/specification) on all transports. You
can reuse the same connection for multiple requests!

**Note: Please understand the security implications of opening up an HTTP/WS based
transport before doing so! Hackers on the internet are actively trying to subvert
Ethereum nodes with exposed APIs! Further, all browser tabs can access locally
running web servers, so malicious web pages could try to subvert locally available
APIs!**

### Operating a private network

Maintaining your own private network is more involved as a lot of configurations taken for
granted in the official networks need to be manually set up.

Unfortunately since [the Merge](https://ethereum.org/en/roadmap/merge/) it is no longer possible
to easily set up a network of geth nodes without also setting up a corresponding beacon chain.

There are three different solutions depending on your use case:

* If you are looking for a simple way to test smart contracts from go in your CI, you can use the [Simulated Backend](https://geth.ethereum.org/docs/developers/dapp-developer/native-bindings#blockchain-simulator).
* If you want a convenient single node environment for testing, you can use our [Dev Mode](https://geth.ethereum.org/docs/developers/dapp-developer/dev-mode).
* If you are looking for a multiple node test network, you can set one up quite easily with [Kurtosis](https://geth.ethereum.org/docs/fundamentals/kurtosis).

## Contribution

Thank you for considering helping out with the source code! We welcome contributions
from anyone on the internet, and are grateful for even the smallest of fixes!

If you'd like to contribute to go-ethereum, please fork, fix, commit and send a pull request
for the maintainers to review and merge into the main code base. If you wish to submit
more complex changes though, please check up with the core devs first on [our Discord Server](https://discord.gg/invite/nthXNEv)
to ensure those changes are in line with the general philosophy of the project and/or get
some early feedback which can make both your efforts much lighter as well as our review
and merge procedures quick and simple.

Please make sure your contributions adhere to our coding guidelines:

* Code must adhere to the official Go [formatting](https://golang.org/doc/effective_go.html#formatting)
  guidelines (i.e. uses [gofmt](https://golang.org/cmd/gofmt/)).
* Code must be documented adhering to the official Go [commentary](https://golang.org/doc/effective_go.html#commentary)
  guidelines.
* Pull requests need to be based on and opened against the `master` branch.
* Commit messages should be prefixed with the package(s) they modify.
  + E.g. "eth, rpc: make trace configs optional"

Please see the [Developers' Guide](https://geth.ethereum.org/docs/developers/geth-developer/dev-guide)
for more details on configuring your environment, managing project dependencies, and
testing procedures.

### Contributing to geth.ethereum.org

For contributions to the [go-ethereum website](https://geth.ethereum.org), please checkout and raise pull requests against the `website` branch.
For more detailed instructions please see the `website` branch [README](https://github.com/ethereum/go-ethereum/tree/website#readme) or the
[contributing](https://geth.ethereum.org/docs/developers/geth-developer/contributing) page of the website.

## License

The go-ethereum library (i.e. all code outside of the `cmd` directory) is licensed under the
[GNU Lesser General Public License v3.0](https://www.gnu.org/licenses/lgpl-3.0.en.html),
also included in our repository in the `COPYING.LESSER` file.

The go-ethereum binaries (i.e. all code inside of the `cmd` directory) are licensed under the
[GNU General Public License v3.0](https://www.gnu.org/licenses/gpl-3.0.en.html), also
included in our repository in the `COPYING` file.

## About

Go implementation of the Ethereum protocol

[geth.ethereum.org](https://geth.ethereum.org "https://geth.ethereum.org")

### Topics

[go](/topics/go "Topic: go")
[ethereum](/topics/ethereum "Topic: ethereum")
[blockchain](/topics/blockchain "Topic: blockchain")
[p2p](/topics/p2p "Topic: p2p")
[geth](/topics/geth "Topic: geth")

### Resources

[Readme](#readme-ov-file)
### License

LGPL-3.0, GPL-3.0 licenses found

### Licenses found

[LGPL-3.0
COPYING.LESSER](/ethereum/go-ethereum/blob/master/./COPYING.LESSER) [GPL-3.0
COPYING](/ethereum/go-ethereum/blob/master/./COPYING)
### Security policy

[Security policy](#security-ov-file)

[Activity](/ethereum/go-ethereum/activity)
[Custom properties](/ethereum/go-ethereum/custom-properties)
### Stars

[**48.2k**
stars](/ethereum/go-ethereum/stargazers)
### Watchers

[**2.2k**
watching](/ethereum/go-ethereum/watchers)
### Forks

[**20.4k**
forks](/ethereum/go-ethereum/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum&report=ethereum+%28user%29)

## [Releases 203](/ethereum/go-ethereum/releases)

[Gei Hinnom (v1.14.12)
Latest

Nov 19, 2024](/ethereum/go-ethereum/releases/tag/v1.14.12)
[+ 202 releases](/ethereum/go-ethereum/releases)

## [Used by 23.3k](/ethereum/go-ethereum/network/dependents)

[* ![@eshuaiii](https://avatars.githubusercontent.com/u/63947753?s=64&v=4)
* ![@linxinqwq](https://avatars.githubusercontent.com/u/142725096?s=64&v=4)
* ![@DSC-IITI](https://avatars.githubusercontent.com/u/73945536?s=64&v=4)
* ![@junhaolim](https://avatars.githubusercontent.com/u/195392376?s=64&v=4)
* ![@MyriadFlow](https://avatars.githubusercontent.com/u/102209219?s=64&v=4)
* ![@koriebruh](https://avatars.githubusercontent.com/u/177237985?s=64&v=4)
* ![@KiiChain](https://avatars.githubusercontent.com/u/139797706?s=64&v=4)

+ 23,332](/ethereum/go-ethereum/network/dependents)

## [Contributors 1,111](/ethereum/go-ethereum/graphs/contributors)

* [![@obscuren](https://avatars.githubusercontent.com/u/6264126?s=64&v=4)](https://github.com/obscuren)
* [![@karalabe](https://avatars.githubusercontent.com/u/129561?s=64&v=4)](https://github.com/karalabe)
* [![@fjl](https://avatars.githubusercontent.com/u/6915?s=64&v=4)](https://github.com/fjl)
* [![@holiman](https://avatars.githubusercontent.com/u/142290?s=64&v=4)](https://github.com/holiman)
* [![@tgerring](https://avatars.githubusercontent.com/u/731472?s=64&v=4)](https://github.com/tgerring)
* [![@rjl493456442](https://avatars.githubusercontent.com/u/5959481?s=64&v=4)](https://github.com/rjl493456442)
* [![@zelig](https://avatars.githubusercontent.com/u/769725?s=64&v=4)](https://github.com/zelig)
* [![@MariusVanDerWijden](https://avatars.githubusercontent.com/u/16664698?s=64&v=4)](https://github.com/MariusVanDerWijden)
* [![@gballet](https://avatars.githubusercontent.com/u/3272758?s=64&v=4)](https://github.com/gballet)
* [![@CJentzsch](https://avatars.githubusercontent.com/u/8452011?s=64&v=4)](https://github.com/CJentzsch)
* [![@s1na](https://avatars.githubusercontent.com/u/1591639?s=64&v=4)](https://github.com/s1na)
* [![@debris](https://avatars.githubusercontent.com/u/2613714?s=64&v=4)](https://github.com/debris)
* [![@zsfelfoldi](https://avatars.githubusercontent.com/u/9884311?s=64&v=4)](https://github.com/zsfelfoldi)
* [![@lightclient](https://avatars.githubusercontent.com/u/14004106?s=64&v=4)](https://github.com/lightclient)

[+ 1,097 contributors](/ethereum/go-ethereum/graphs/contributors)

## Languages

* [Go
  89.4%](/ethereum/go-ethereum/search?l=go)
* [C
  5.2%](/ethereum/go-ethereum/search?l=c)
* [JavaScript
  3.4%](/ethereum/go-ethereum/search?l=javascript)
* [Assembly
  0.5%](/ethereum/go-ethereum/search?l=assembly)
* [Shell
  0.2%](/ethereum/go-ethereum/search?l=shell)
* [Java
  0.2%](/ethereum/go-ethereum/search?l=java)
* Other
  1.1%

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


