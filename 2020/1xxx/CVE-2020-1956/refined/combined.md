=== Content from lists.apache.org_761f306e_20250119_121740.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from lists.apache.org_95c3ca39_20250119_121740.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from lists.apache.org_98723695_20250119_121740.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from community.sonarsource.com_dad2faf7_20250119_121740.html ===


[Sonar Community](/)

# [[Tech Story] Apache Kylin 3.0.1 Command Injection Vulnerability](/t/tech-story-apache-kylin-3-0-1-command-injection-vulnerability/25706)

[Clean Code](/c/clean-code/announce/20)

[Sonar Updates](/c/clean-code/announce/20)

[security](https://community.sonarsource.com/tag/security),
[java](https://community.sonarsource.com/tag/java)

[Johannes.Dahse](https://community.sonarsource.com/u/Johannes.Dahse)
(Johannes Dahse)

June 2, 2020, 6:42pm

1

Apache Kylin is an open source, distributed Analytical Data Warehouse for Big Data written in Java. It was originally developed by eBay and is used by global enterprises such as Cisco, Baidu and Xiaomi to analyze extremely large datasets. After a SQL injection ([CVE-2020-1937](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1937)) was announced in Apache Kylin on 23 Feb 2020, our team @ RIPS Technologies (who is now [joining forces with SonarSource](https://blog.sonarsource.com/sonarsource-acquires-rips-technologies)) decided to evaluate what our static analysis engine could find in this project. This is how we discovered another, even more severe vulnerability ([CVE-2020-1956](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1956)) in the Kylin code base that allows malicious users to execute arbitrary OS commands and to take over the host system. In this tech story we will analyze the root cause of such vulnerabilities and how to prevent these in your Java applications.

# Impact

The vulnerability was introduced in March 2018 with Apache Kylin version 2.3.0. It affects all releases up to version 2.6.5 and 3.0.1. An authenticated user with MANAGEMENT or ADMIN permissions on any project can inject arbitrary system commands during Cube migration via the Kylin web interface. The attacker’s system commands are then executed on the targeted web server and allow to fully compromise the system and its data. Apache rates the severity of this vulnerability as [important](https://kylin.apache.org/docs/security.html).

# Technical Analysis

Apache Kylin handles large data sets in Cubes. The vulnerability hides in the Cube migration feature which is located in the `migrateCube()` method of the `CubeService` class code. A Cube migration is initiated via REST API endpoint in the `CubeController` (*/kylin/api/cubes/{cube}/**{project}**/migrate*). The CubeController handles the migrate POST request and passes a project name from the URL to the `CubeService`.

**/server-base/src/main/java/org/apache/kylin/rest/controller/CubeController.java**

```
@RequestMapping(value="/{cube}/{project}/migrate", method={ RequestMethod.POST })
…
public void migrateCube(@PathVariable String cube, @PathVariable String project) {
         …
         cubeService.migrateCube(cubeInstance, project);

```

In the CubeService, the project name from the URL is concatenated unsanitized into a system command string. This allows authenticated attackers to malform the API request and to inject malicious commands into the project name which are then executed on the system.

**/server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java**

```
public void migrateCube(CubeInstance cube, String projectName) {
…
       String srcCfgUri = config.getAutoMigrateCubeSrcConfig();
       String dstCfgUri = config.getAutoMigrateCubeDestConfig();
       …
       String stringBuilder = ("%s/bin/kylin.sh org.apache.kylin.tool.CubeMigrationCLI %s %s %s %s %s %s true true");
       String cmd = String.format(Locale.ROOT, stringBuilder,
               KylinConfig.getKylinHome(),
               srcCfgUri,
               dstCfgUri,
               cube.getName(),
               projectName,
               config.isAutoMigrateCubeCopyAcl(),
               config.isAutoMigrateCubePurge());
       …
       exec.execute(cmd, patternedLogger);

```

For example, the attacker can invoke a separate system command by injecting backtick characters into the project name:

*<http://target/kylin/api/cubes/kylin_streaming_cube/>**`sleep+10`**/migrate*

When looking at the `stringBuilder` above we can see that additional data is concatenated into the system command. In the first lines, a source and destination URI for a config file (`srcCfgUri` and `dstCfgUri`) is retrieved and then appended to the *kylin.sh* command. These configuration settings can be permanently modified by using the Cube Designer as shown in the Figure below. When system commands are injected into the configuration settings by a malicious user, these are executed during Cube migration as well.

[![kylin_set_config](https://europe1.discourse-cdn.com/sonarsource/uploads/sonarcommunity/optimized/2X/5/5420987d2afe84642b3c4a47ca77d97836878ab0_2_690x478.png)
kylin\_set\_config949×658 52.1 KB](https://europe1.discourse-cdn.com/sonarsource/uploads/sonarcommunity/original/2X/5/5420987d2afe84642b3c4a47ca77d97836878ab0.png "kylin_set_config")

# Patch

In order to mitigate this vulnerability, all inputs have to be validated which can be modified by a malicious user and are used in a security-sensitive operation, such as a system command.

The [initial patch](https://github.com/apache/kylin/commit/9cc3793ab2f2f0053c467a9b3f38cb7791cd436a) of the Apache Kylin team based on a *denylist* approach. It removes malicious characters that could be used for exploitation in input parameters. However, it is difficult to define all malicious characters for all different kinds of OS environments. A special character is easily missed and hence this approach is error prone and should be avoided whenever possible. For example, the Windows operating system allows a newline character `\n` to separate two system commands which would bypass this denylist.

**Error-prone patch - denylist**

```
public static final String COMMAND_DENY_LIST = "[ &`>|{}()$;\\-#~!+*”\\\\]+";

public static String checkParameter(String commandParameter) {
        String repaired = commandParameter.replaceAll(COMMAND_DENY_LIST, "");
        if (repaired.length() != commandParameter.length()) {
            logger.info("Detected illegal character in command.");
        }
        return repaired;
}

```

An [alternative patch](https://github.com/apache/kylin/commit/335d61b62517006d7e7b55638bb6fd305dffbea1) has been implemented which uses an *allowlist* approach. Here, a fixed set of allowed characters is defined. Ideally, this list should contain only alpha-numerical characters but in the case of Kylin project names additional characters are required.

**Corrected patch - allowlist**

```
public static final String COMMAND_ALLOW_LIST = "[^\\w%,@/:=?.\"\\[\\]]";

public static String checkParameter(String commandParameter) {
        String repaired = commandParameter.replaceAll(COMMAND_ALLOW_LIST, "");
        if (repaired.length() != commandParameter.length()) {
            logger.info("Detected illegal character in command.");
        }
        return repaired;
}

```

One important thing to keep in mind is that the parameters are now sanitized against breaking out of the current command and invoking new commands. But the original command *kylin.sh* is still executed with these user-controlled parameters. Thus the developer needs to ensure that the shell script *kylin.sh* itself does not perform security-sensitive operations with these parameters. For example, the allowlist allows the character sequence `../` which could be used for a path traversal attack when the project name is used in a file path.

The patch was implemented in Apache Kylin 3.0.2 and 2.6.6 and all users are encouraged to upgrade. Alternatively, Kylin administrators can set the configuration *kylin.tool.auto-migrate-cube.enabled* to *false* in order to disable Cube migrations and to prevent exploitation.

# Timeline

|  |  |
| --- | --- |
| Date | What |
| 08.03.2020 | Reported vulnerability to Apache Security Team |
| 09.03.2020 | Apache Security Team passed report on to Kylin Team |
| 29.03.2020 | Asked for status update |
| 01.04.2020 | Apache Kylin Team drafts initial patch |
| 16.04.2020 | Apache Kylin Team improves patch |
| 22.04.2020 | Apache Kylin Team starts release process |
| 20.05.2020 | Apache Kylin Team releases patch version |

# Summary

In this tech story we analyzed a security vulnerability in Apache Kylin that allows malicious, authenticated users to compromise the underlying system by abusing features of the Kylin web application. We looked at the root cause of this code vulnerability which can be easily introduced in any code base and evaluated different ways how to patch such an issue. With the help of static code analysis, these types of injection flaws can be automatically found early in the development lifecycle. The security vulnerability was reported to the vendor who quickly released a [fixed version](http://kylin.apache.org/download/) to protect its users. We would like to thank the Apache Security and Apache Kylin Team for the professional collaboration on fixing this issue in a timely manner.

10 Likes

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](https://www.sonarsource.com/legal/website-terms-of-use/)
* [Privacy Policy](https://www.sonarsource.com/company/privacy/)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled

[The new SonarQube free tier is here! Sign up to scan your private projects for free.](https://www.sonarsource.com/products/sonarcloud/signup-free/)



=== Content from lists.apache.org_8463d903_20250119_121741.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from lists.apache.org_eca71165_20250119_121741.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from www.openwall.com_67d82aed_20250119_121739.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2020/07/13/1) [[next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CANfpUcv3P9nza4UAJSHGScvrft53c8APzOaD=6sf0zrD4tiNMA@mail.gmail.com>
Date: Tue, 14 Jul 2020 11:31:04 +0800
From: ShaoFeng Shi <shaofengshi@...che.org>
To: oss-security@...ts.openwall.com
Subject: [SECURITY][CVE-2020-13925] Apache Kylin command injection vulnerability

Versions Affected: 2.3.0, 2.3.1, 2.3.2, 2.4.0, 2.4.1, 2.5.0, 2.5.1, 2.5.2,
2.6.0, 2.6.1, 2.6.2, 2.6.3, 2.6.4, 2.6.5, 2.6.6, 3.0.0-alpha, 3.0.0-alpha2,
3.0.0-beta, 3.0.0, 3.0.1 3.0.2

Description:

Similar to CVE-2020-1956, Kylin has one more restful API which concatenates
the API inputs into OS commands and then executes them on the server; while
the reported API misses necessary input validation, which causes the
hackers to have the possibility to execute OS command remotely.

Mitigation:
Users of all previous versions after 2.3 should upgrade to 3.1.0.

Credit:
We would like to thank Clancey <clanceyz@...tonmail.com> for reporting
this issue.

Best regards,

Shaofeng Shi 史少锋
Apache Kylin PMC
Email: shaofengshi@...che.org

Apache Kylin FAQ: <https://kylin.apache.org/docs/gettingstarted/faq.html>
Join Kylin user mail group: user-subscribe@...in.apache.org
Join Kylin dev mail group: dev-subscribe@...in.apache.org

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lists.apache.org_416ab6c2_20250119_121741.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.


