=== Content from www.sonarsource.com_aceef39b_20250119_131404.html ===
NEW![Sonar has entered a definitive agreement to acquire Tidelift! Read the press release.](/company/press-releases/sonar-to-acquire-tidelift/) [![](data:image/svg+xml;charset=utf-8...)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)](/ "Home")

* Solutions

  Use Cases

  [AI-assisted & quality-assured codeEnsure code generated by AI assistants is of the highest quality](/solutions/ai/)[DevOps transformationHarness the full potential of DevOps by reducing roll backs and improving quality of releases](/solutions/devops-transformation/)[Code coverageEnsure code quality and security by facilitating faster debugging through clear visibility of coverage gaps.](/solutions/code-coverage/) [Reduce & manage technical debtMaximize innovation by proactively managing technical debt](/solutions/reduce-technical-debt/)[Secure by designIntegrate code security in compliance with NIST Secure Software Development Framework](/solutions/secure-by-design-code/)[All Use CasesRead more about Sonar Use cases with blog articles, technical articles and developer guides](/solutions/use-cases/)

  Clean Code

  [What is clean codeA detailed definition of Clean Code](/solutions/clean-code/)[Power of clean codeBusiness success built on Clean Code](/solutions/power-of-clean-code/)[Security starts with Clean CodeStatic Application Security Testing with Sonar](/solutions/security/)[Clean as You CodeOur unique approach to Clean Code](/solutions/our-unique-approach/)

  Something For Everyone

  [For DevelopersFind and fix issues as you code](/solutions/for-developers/)[For DevOpsBuild your apps on Clean Code foundations](/solutions/infrastructure-as-code/)[For EnterpriseClean Code delivery from development to production](/solutions/for-enterprise/)[For the Public SectorClean Code for the public sector](/solutions/public-sector/)
* Products

  Industry Leading Products

  [![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/aa3b1f02-f1b0-448f-a3f2-a1bd32923a08/SQ_Logo_Cloud_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarCloudCloud-based static analysis tool for your CI/CD workflows](/products/sonarcloud/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/bdac1871-464e-4051-88db-7df20c3bfffa/SQ_Logo_Server_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarQubeSelf-managed static analysis tool for continuous codebase inspection](/products/sonarqube/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/49f23af2-a29b-4d0f-95d7-ffd361f375e1/SQ_Logo_IDE_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarLintFree IDE extension that provides on-the-fly analysis and coding guidance](/products/sonarlint/)

  Languages and Frameworks

  [Java](/knowledge/languages/java/)[JavaScript](/knowledge/languages/js/)[TypeScript](/knowledge/languages/ts/)[Python](/knowledge/languages/python/)[C#](/knowledge/languages/csharp/)[C++](/knowledge/languages/cpp/)[C](/knowledge/languages/c/)[PHP](/knowledge/languages/php/)[Kotlin](/knowledge/languages/kotlin/)[See All](/lp/knowledge/languages/)
* Resources

  Learn About Clean Code

  [BlogStay connected with our latest development news and articles](/blog/)[Events hubLet's meet up online or in person - browse our conferences and webinars, or watch previous talks](/resources/events/)[Customer StoriesCheck out Sonar implementation success stories](/resources/customer-stories/)[White PapersFind in-depth articles on clean code](/resources/white-papers/)[LearnDeveloper learning hub - covering essential topics](/learn/)[Solution BriefsOur library of solution briefs](/resources/solution-briefs/)

  Go In Depth

  [SonarQube Server DocumentationFind more information on the technical details of SonarQube Server](https://docs.sonarsource.com/sonarqube/latest/)[SonarQube Cloud DocumentationFind more information on the technical details of SonarQube Cloud](https://docs.sonarsource.com/sonarcloud/)[SonarQube for IDE DocumentationFind more information on the technical details of SonarQube IDE](https://docs.sonarsource.com/sonarlint/)[Explore SonarpediaExplore our publicly available multi-language rules database](https://rules.sonarsource.com/)[LanguagesSee our multi-language coverage](/knowledge/languages/)
* Company

  Deliver Better Software

  [About UsSonar’s industry leading solution enables developers to write clean code and remediate existing code organically](/company/about/)[CareersJoin our growing team](/company/careers/)[Commitment to open sourceOur commitment to transparency, security, and continuous improvement](/solutions/commitment-to-open-source/)[CommunityGet latest updates, suggest features, and share your knowledge](https://community.sonarsource.com/)[PartnersSonar partners with the best resellers to bring Clean Code closer to you](/company/partners/)[Contact usHave questions? Get in touch](/company/contact/)

  Media

  [NewsroomNews announcements, media coverage, and more](/company/newsroom/)[CoverageFind articles about Sonar in the news](/company/coverage/)[Press ReleasesThe latest Sonar updates](/company/press-releases/)[CustomersAn overview of customers using Sonar by industry](/company/customers/)[Press KitExecutive headshots, quick stats, customer logos, and more](/company/press-kit/)
[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)
Search modal toggle button[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)Mobile menu toggle button

Blog post

# Hack the Stack with LocalStack: Code Vulnerabilities Explained

![](data:image/svg+xml;charset=utf-8...)![Dennis Brinkrolf photo]()![Dennis Brinkrolf photo](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/4e33a3d4-6781-4fe3-aaa3-0ec178d00386/d118d723-bccb-4102-9d5c-ccf1a2a99e5f_dennis_brinkrolf.png?w=400&h=400&auto=format&fit=crop)

Dennis Brinkrolf

Security Researcher

March 2, 2021

Date

* [Security](/blog/tag/security/)
![](data:image/svg+xml;charset=utf-8...)![Our vulnerability researchers found critical code vulnerabilities in a popular Python application that can be exploited remotely, even when the application instance is hosted locally.](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/1062b67f-394d-45a0-8383-ef7f2ba0b7ed/cover-55a7eab2-82af-4c50-a1d9-39e948c78128_local_stack_python.png?w=1200&h=600&auto=format&fit=crop)![Our vulnerability researchers found critical code vulnerabilities in a popular Python application that can be exploited remotely, even when the application instance is hosted locally.](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/1062b67f-394d-45a0-8383-ef7f2ba0b7ed/cover-55a7eab2-82af-4c50-a1d9-39e948c78128_local_stack_python.png?w=1200&h=600&auto=format&fit=crop)

LocalStack is a popular open source application that provides an easy-to-use test framework for cloud applications. It enables you to host a fully functional AWS cloud setup in your local network for developing and testing cloud and serverless apps. According to GitHub, it is one of the most popular open source Python applications.

During our security research into modern applications, we discovered critical code vulnerabilities in the latest LocalStack version. We reported all issues responsibly to the affected vendor. However, after the vendor assessed the risk it left the vulnerabilities we reported unpatched due to a limited attack scenario. In this blog post we analyze the attack scenario, the technical root cause of the code vulnerabilities, and how attackers are able to exploit these vulnerabilities.

## Impact

We detected the following vulnerabilities in the latest LocalStack version 0.12.6:

* [S5334](https://rules.sonarsource.com/python/type/Vulnerability/RSPEC-2076 "S5334"): OS Command Injection (CVE-2021-32090)
* [S5144](https://rules.sonarsource.com/python/type/Vulnerability/RSPEC-5144 "S5144"): Server-Side Request Forgery (SSRF)
* [S5131](https://rules.sonarsource.com/python/type/Vulnerability/RSPEC-5131 "S5131"): Cross-Site Scripting (XSS) (CVE-2021-32091)
* [S2631](https://rules.sonarsource.com/python/type/Vulnerability/RSPEC-2631 "S2631"): Denial of Service via regular expressions (ReDoS)

A LocalStack instance typically runs in an internal network setup. As shown in this blog post, attackers who are not in this same network are still capable of attacking such application setups remotely. By combining different vulnerabilities, an attacker can completely compromise the local instance and execute arbitrary system commands.

Our video illustrates such an attack and shows how quickly and easily a server can be compromised.

Demo

## Technical Analysis

In this technical analysis, we first explain how applications that run locally are attacked. Then, we discuss two vulnerabilities that we found in the LocalStack code. The two vulnerabilities can be combined by an attacker to compromise and take over a LocalStack instance.

### Remote Attacks on Local Instances

When using LocalStack, we noticed that it does not use any authentication. Probably that is because the LocalStack software is run locally or in a Docker environment, as recommended by the vendor, and is therefore not directly exposed to remote attackers. However, it is a common fallacy that this type of application cannot be attacked at all. Web interfaces of network routers are a popular example of local applications that have been attacked in the real-world by criminals (*Drive-by-Pharming*).

One way for a remote attacker to interact with LocalStack running locally is through a target user’s browser. Typically, the browser of the developer who uses LocalStack is also connected to the internet to, for example, read documentation pages. When this victim visits (or is lured to) a malicious/infected website controlled by an attacker, it is possible to trigger cross-site HTTP requests to the victim’s local network via JavaScript code (*Cross-Site Request Forgery* - CSRF).

![](data:image/svg+xml;charset=utf-8...)![A LocalStack instance in a local network is attacked from an infected website remotely.]()![A LocalStack instance in a local network is attacked from an infected website remotely.](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/d936195d-8621-470a-b4c9-36121e7abc8a/body-8eb9253e-b34b-481e-9aec-afe7da26afc1_local_stack_info1.png?w=1200&h=600&auto=format&fit=crop)

This way, an attacker can send arbitrary requests from a website to a LocalStack instance but cannot read the respective responses. This is prevented by the *cross-origin resource sharing* (CORS) mechanism in the browser. However, merely sending requests to the vulnerable application - even without being able to read the responses - is sufficient to carry out a successful attack via CSFR. The attacker blindly sends the attack payload and hopes that the vulnerable application is reached.

Moreover, LocalStack explicitly allows the execution of cross-origin requests through any page by setting special HTTP headers in the response. This means that the attacker can detect and attack a LocalStack instance through the XHR response and does not actually operate blindly.

```
access-control-allow-origin: *
access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH
access-control-allow-headers: authorization,content-type,content-md5,cache-control,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent,x-amz-target,x-amz-acl,x-amz-version-id,x-localstack-target,x-amz-tagging
access-control-expose-headers: x-amz-version-id
```

Note that modern browsers have recently further restricted cross-origin requests to reduce the potential of CSRF attacks. However, we also found a Cross-Site Scripting (XSS) vulnerability in LocalStack which allows an attacker to bypass these protections.

### Adding a MITM Backdoor

In LocalStack, different APIs are run in local isolated processes that each have their own port. All user requests are forwarded to the respective API via a central *edge router*. For this router it is possible to configure a proxy via the LocalStack settings.

As described previously, an attacker can send arbitrary HTTP requests to LocalStack via CSRF and thereby modify the LocalStack configuration. The CSRF attack’s payload can reconfigure the edge router and add a proxy to it that points to an attacker-controlled IP as proxy host. This way, the user requests are no longer processed *locally*but are now forwarded to the attacker’s IP address. Let’s have a look at the corresponding source code.

**localstack/services/edge.py**

```
88    def do_forward_request(api, port, method, path, data, headers):
89        if config.FORWARD_EDGE_INMEM:
90            result = do_forward_request_inmem(api, port, method, path, data, headers)
91        else:
92            result = do_forward_request_network(port, method, path, data, headers)
93        if hasattr(result, 'status_code') and result.status_code >= 400 and method == 'OPTIONS':
94            # fall back to successful response for OPTIONS requests
95            return 200
96        return result
```

The function `do_forward_request()` is executed every time a request is sent to the edge router of LocalStack. In line 89 it is checked if the config entry `FORWARD_EDGE_INMEM` is set. In this case, the request is processed locally, otherwise the request is forwarded to the network. Because an attacker can set `FORWARD_EDGE_INMEM` to *False* via a CSRF attack, we reach line 92 every time. Consequently, all requests to the edge router are processed by the function `do_foward_request_network()`. Also, the HTTP responses of the respective requests are printed without sanitization.

**localstack/services/edge.py**

```
112    def do_forward_request_network(port, method, path, data, headers):
113        connect_host = '%s:%s' % (config.HOSTNAME, port)
114        url = '%s://%s%s' % (get_service_protocol(), connect_host, path)
115        function = getattr(requests, method.lower())
116        response = function(url, data=data, headers=headers, verify=False, stream=True)
117        return response
```

In line 113, the `HOSTNAME` that is used for the forwarded request is read from the configuration. Since an attacker can configure the `HOSTNAME`via CSRF attack, this host is now an attacker-controlled IP. In the following lines the request is constructed and in line 116 the request is executed which leads to a (persistent) SSRF vulnerability.

An interesting point about this feature is that the server copies the entire HTTP request from the client and forwards it to the server. This also means that the HTTP headers of the client are sent to the attacker-controlled server, including the Authorization header. This header is used for authentication in the AWS Cloud which can lead to session hijacking and stealing sensitive data from the test cloud.

As an attacker we can now go even one step further. As mentioned above, the HTTP response of the SSRF request is printed unsanitized in LocalStack. In other words, the attacker can send an XSS payload as a response via his controlled server which leads to a (persistent) Cross-Site Scripting vulnerability in LocalStack. With this, the attacker has installed a persistent man-in-the-middle proxy in LocalStack that controls every HTTP request and response of the LocalStack instance. This enables abuse of further features and to trigger other code vulnerabilities.

### Command Injection Vulnerability (CVE-2021-32090)

One possible way to go further is to exploit vulnerabilities in the LocalStack dashboard. When it is active, an attacker can permanently infiltrate the system and compromise the developer’s machine via a Command Injection vulnerability. Let’s have a look at the affected code lines.

**localstack/dashboard/infra.py**

```
85    @app.route('/lambda/<functionName>/code', methods=['POST'])
86    def get_lambda_code(functionName):
...
98        result = infra.get_lambda_code(func_name=functionName, env=env)
```

In line 85 the route is defined that calls the `get_lambda_code()` function in line 86. Here, the parameter `functionName` is passed to the `get_lambda_code()` function via the path of the route. Then, in line 98, this function is executed with the user controlled input.

**localstack/dashboard/infra.py**

```
258    def get_lambda_code(func_name, retries=1, cache_time=None, env=None):
...
264        out = cmd_lambda('get-function --function-name %s' % func_name, env, cache_time)
```

In line 264, the user-controlled input `func_name` is concatenated into a system command using a format string. Without any sanitization it is passed to the `cmd_lambda()` function. When we follow the user controlled input via further functions, we end up in the `run()` function. This *data flow analysis* is exactly what our security analyzers automate for you ([open issue on SonarQube Cloud](https://sonarcloud.io/project/issues?id=SonarSourceResearch_localstack&open=AXXIAYcqSjg9uZPLRNpy&resolved=false&sonarsourceSecurity=command-injection&types=VULNERABILITY "open issue on SonarQube Cloud")).

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/a9b2c609-0e0a-4596-ae44-d7cf9c65938d/body-38d284ff-0ecd-404f-b1fa-c56332cf72b4_localstack_on_sonarcloud.png?w=1073&h=529&auto=format&fit=crop)

**localstack/utils/bootstrap.py**

```
596    def run(cmd, print_error=True, stderr=subprocess.STDOUT, env_vars=None, inherit_cwd=False, inherit_env=True):
...
613        output = subprocess.check_output(cmd, shell=True, stderr=stderr, env=env_dict, cwd=cwd)
```

In line 613, the shell command is finally executed via `subprocess.check_output()`. Here, the `cmd` parameter contains the user-controlled input that ends up unsanitized in a system command. This leads to a Command Injection vulnerability since the attacker can terminate the original command and execute his own. For example, after a Command Injection, the final `cmd` parameter in line 613 can look like the following to create a new file on the system:

```
cmd =  { test `which aws` || . .venv/bin/activate; }; aws lambda get-function --function-name test;touch sonarsource.txt
```
## Summary

In this blog post we analyzed two code vulnerabilities found in the latest **LocalStack (0.12.6)**, a widely used Python application. We outlined how local applications can be attacked remotely, and how the combination of these vulnerabilities can lead to a complete takeover of a LocalStack.

We reported these vulnerabilities to the vendor in October 2020. After reaching out a couple of more times, we received notice in January that these threats are not considered a key concern since LocalStack is executed on a local machine. While we agree that real-world attacks against local instances are less likely than against directly exposed applications, we believe that developers should be aware of these risks in order to protect their setups and to write secure code for their own applications.

#### SHARE

[twitter](https://twitter.com/share?text=undefined)[facebook](https://www.facebook.com/sharer/sharer.php?u=undefined)[linkedin](https://www.linkedin.com/sharing/share-offsite/?url=undefined)mail[Go to SonarSource homepage![](data:image/svg+xml;charset=utf-8...)![sonar logo ]()![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=160&h=40&auto=format&fit=crop)](/)

* **Sonar Solutions**
  + [SAST](/solutions/security/)
  + [What is clean code](/solutions/clean-code/)
  + [Power of clean code](/solutions/power-of-clean-code/)
  + [Clean as you code](/solutions/our-unique-approach/)
  + [AI-assisted & quality-assured code](/solutions/ai/)
  + [DevOps transformation](/solutions/devops-transformation/)
  + [Outsourcing software development](/solutions/reduce-outsourcing-software-development-risk/)
  + [Reduce & manage technical debt](/solutions/reduce-technical-debt/)
  + [Secure by design](/solutions/secure-by-design-code/)
  + [Code coverage](/solutions/code-coverage/)
  + [Code review](/solutions/code-review/)
  + [For developers](/solutions/for-developers/)
  + [For enterprise](/solutions/for-enterprise/)
  + [Infrastructure as code](/solutions/infrastructure-as-code/)
  + [Public sector](/solutions/public-sector/)
* **Products**
  + [SonarQube for IDE](/products/sonarlint/)
  + [SonarQube Server](/products/sonarqube/)
  + [SonarQube Cloud](/products/sonarcloud/)**Pricing**
  + [Start for free](/open-source-editions/)
  + [Explore pricing](/plans-and-pricing/)
* **Company**
  + [About](/company/about/)
  + [Careers](/company/careers/)
  + [Commitment to open source](/solutions/commitment-to-open-source/)
  + [Customers](/company/customers/)
  + [Partners](/company/partners/)
  + [Contact us](/company/contact/)
  + [Accessibility](/accessibility/)
  + [NEW! Brand identity](/brand-identity/)**Media**
  + [Coverage](/company/coverage/)
  + [Press releases](/company/press-releases/)
* **Resources**
  + [Events hub](/resources/events/)
  + [Customer stories](/resources/customer-stories/)
  + [White papers](/resources/white-papers/)
  + [Learn](/learn/guide/)
  + [Community](https://community.sonarsource.com/)
  + [Support](/support/)
* **Knowledge**
  + [Explore Sonarpedia](https://rules.sonarsource.com/)
  + [Blog](/blog/)
  + [Languages](/knowledge/languages/)
  + [SonarQube Server Documentation](https://docs.sonarsource.com/sonarqube/latest/)
  + [SonarQube Cloud Documentation](https://docs.sonarsource.com/sonarcloud/)
  + [SonarQube for IDE Documentation](https://docs.sonarsource.com/sonarlint/)

* [Legal documentation](/legal/)
* [Trust center](/trust-center/)

* [Follow SonarSource on Twitter](https://twitter.com/sonarsource)
* [Follow SonarSource on Linkedin](https://www.linkedin.com/company/sonarsource/)

© 2008-2025 SonarSource SA. All rights reserved. SONAR, SONARSOURCE, SONARQUBE, and CLEAN AS YOU CODE are trademarks of SonarSource SA.



=== Content from civicrm.org_81438bcf_20250119_112018.html ===

[Skip to main content](#main-content)
## User account menu

* [Log in](/user/login)

Toggle navigation

[![Home](/sites/civicrm.org/files/CiviCRM-logo-2019-F2-200px.png)](/ "Home")

## Top Navigation

* [Explore CiviCRM](https://civicrm.com)
* [Engage](https://civicrm.org/get-involved)
  + [Get Involved](/get-involved)
  + [Read the Blog](/blog)
  + [All Events](/events)
  + [Subscribe to Newsletters](/civicrm/mailing/subscribe?reset=1)
  + [Support CiviCRM](/support-us)
  + [Make It Happen](/make-it-happen)
  + [Make a One-Time Gift](https://civicrm.org/civicrm/contribute/transact?reset=1&id=47)
  + [CiviCRM Jobs](/jobs)
  + [Report a Bug](https://civicrm.org/bug-reporting)
  + [Report a Security Issue](/security)
  + [Find an Expert](/partners-contributors)
* [Find Support](/help)
  + [Read the Documentation](https://docs.civicrm.org/)
  + [Chat with the Community](https://chat.civicrm.org)
  + [Ask a Question](https://civicrm.stackexchange.com)
  + [Read the Release Notes](https://civicrm.org/blog/tags/release)
  + [Explore the Issue Queue](/issue-queue)
  + [Security Announcements](https://civicrm.org/advisory)
  + [Find an Expert](/civicrm/experts)
* [Extend](/extensions)
* [Download](/download)

## Top Navigation

* [Explore CiviCRM](https://civicrm.com)
* [Engage](https://civicrm.org/get-involved)
* [Find Support](/help)
* [Extend](/extensions)
* [Download](/download)

1. [Home](/)
2. [Security Advisories](/advisory)

# CIVI-SA-2020-11: CSRF on CKEditor Configuration Form

Published
2020-08-19 09:00

Written by
[dev-team](/users/dev-team "View user profile.")

CiviCRM did not provide sufficient protection on the CKEditor configuration form, which could allow a malicious third-party to trick a CiviCRM administrator into changing the configuration.

Note: This form had another vulnerability in the same version. The risk from two overlapping vulnerabilities may be greater than the risk of each individually.

Security Risk
Critical

Vulnerability
Cross Site Request Forgery

Affected Versions

CiviCRM version 5.28.0 and earlier

Fixed Versions

CiviCRM version 5.28.1 and 5.27.5 ESR

Publication Date
2020-08-19 - 12:00

Solutions

Upgrade to the latest version of CiviCRM or use a different editor other than CKEdtior included with Core

Credits

Dennis Brinkrolf of RIPS Technologies and Cure53 and Mozilla Open Source Support (MOSS) for reporting the issue

Seamus Lee and Coleman Watts for fixing the issue

References

MOSS CIV-01-016

securirty/core#74

## WORK WITH A TRUSTED EXPERT TO SETUP YOUR CIVICRM

Make your next CiviCRM implementation a Success.
[Find an Expert](/civicrm/experts)
![](/sites/civicrm.org/themes/civi8/images/logo-civi-approved.png)

## Primary menu

* [Explore](https://civicrm.com)
  + [Try a Demo](https://civicrm.com/demo)
  + [Testing Sandboxes](/testing-sandboxes)
  + [Case Studies](https://civicrm.com/case-studies)
  + [Extend](/extensions)
  + [Download](/download)
* [Features](/features)
  + [Contact Management](https://civicrm.com/features/contact-management/)
  + [Contributions](https://civicrm.com/features/contribution-pages/)
  + [Events](https://civicrm.com/features/events/)
  + [Memberships](https://civicrm.com/features/membership-management/)
  + [Email Marketing](https://civicrm.com/features/mailings/)
  + [Reports](https://civicrm.com/features/detailed-reporting/)
  + [Configurable & Customizable](https://civicrm.com/features/powerful-utilities/)
  + [Case Management](https://civicrm.com/features/case-management/)
  + [Peer-to-Peer Fundraisers](https://civicrm.com/features/peer-to-peer-fundraising/)
* [Engage](/get-involved)
  + [Get Involved](/get-involved)
  + [Read the Blog](/blog)
  + [All Events](/civicrm-events)
  + [Subscribe to Newsletters](/update-my-mailing-preference)
  + [Support CiviCRM](/support-us)
  + [Make It Happen](/make-it-happen)
  + [Make a One-Time Gift](https://civicrm.org/civicrm/contribute/transact?reset=1&id=47)
  + [CiviCRM Jobs](/jobs)
  + [Report a Bug](/bug-reporting)
  + [Report a Security Issue](/security)
  + [Find an Expert](/experts)
* [Find Support](/help)
  + [Read the Documentation](https://docs.civicrm.org/)
  + [Chat with the Community](https://chat.civicrm.org)
  + [Ask a Question](https://civicrm.stackexchange.com)
  + [Read the Release Notes](https://civicrm.org/blog/tags/release)
  + [Explore the Issue Queue](/issue-queue)
  + [Security Announcements](/advisory)
  + [Find an Expert](/experts)
* [About](/about)
  + [License](/about/license)
  + [Roadmap](/about/roadmap)
  + [Trademark](/trademark)
  + [Community Council](/community-council)
  + [Privacy Policy](/about/privacy-policy)
  + [Code of Conduct](/code-of-conduct)

## Languages

* [English](/advisory/civi-sa-2020-11-csrf-ckeditor-configuration-form)
* [Catalan](/ca/node/10373)
* [Nederlands](/nl/node/10373)
* [Français](/fr/node/10373)
* [Magyar](/hu/node/10373)
* [Italiano](/it/node/10373)
* [Deutsch](/de/node/10373)
* [Polski](/pl/node/10373)
* [Español](/es/node/10373)

We are in the process of translating the civicrm.org website. Translations may not be available in all languages. [Read more and participate](https://lab.civicrm.org/marketing/civicrm-website/-/wikis/website-translation).

© 2005 - 2025, CIVICRM LLC. All rights reserved.

[D10]



=== Content from blog.sonarsource.com_4ee16350_20250119_112017.html ===
NEW![Sonar has entered a definitive agreement to acquire Tidelift! Read the press release.](/company/press-releases/sonar-to-acquire-tidelift/) [![](data:image/svg+xml;charset=utf-8...)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)](/ "Home")

* Solutions

  Use Cases

  [AI-assisted & quality-assured codeEnsure code generated by AI assistants is of the highest quality](/solutions/ai/)[DevOps transformationHarness the full potential of DevOps by reducing roll backs and improving quality of releases](/solutions/devops-transformation/)[Code coverageEnsure code quality and security by facilitating faster debugging through clear visibility of coverage gaps.](/solutions/code-coverage/) [Reduce & manage technical debtMaximize innovation by proactively managing technical debt](/solutions/reduce-technical-debt/)[Secure by designIntegrate code security in compliance with NIST Secure Software Development Framework](/solutions/secure-by-design-code/)[All Use CasesRead more about Sonar Use cases with blog articles, technical articles and developer guides](/solutions/use-cases/)

  Clean Code

  [What is clean codeA detailed definition of Clean Code](/solutions/clean-code/)[Power of clean codeBusiness success built on Clean Code](/solutions/power-of-clean-code/)[Security starts with Clean CodeStatic Application Security Testing with Sonar](/solutions/security/)[Clean as You CodeOur unique approach to Clean Code](/solutions/our-unique-approach/)

  Something For Everyone

  [For DevelopersFind and fix issues as you code](/solutions/for-developers/)[For DevOpsBuild your apps on Clean Code foundations](/solutions/infrastructure-as-code/)[For EnterpriseClean Code delivery from development to production](/solutions/for-enterprise/)[For the Public SectorClean Code for the public sector](/solutions/public-sector/)
* Products

  Industry Leading Products

  [![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/aa3b1f02-f1b0-448f-a3f2-a1bd32923a08/SQ_Logo_Cloud_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarCloudCloud-based static analysis tool for your CI/CD workflows](/products/sonarcloud/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/bdac1871-464e-4051-88db-7df20c3bfffa/SQ_Logo_Server_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarQubeSelf-managed static analysis tool for continuous codebase inspection](/products/sonarqube/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/49f23af2-a29b-4d0f-95d7-ffd361f375e1/SQ_Logo_IDE_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarLintFree IDE extension that provides on-the-fly analysis and coding guidance](/products/sonarlint/)

  Languages and Frameworks

  [Java](/knowledge/languages/java/)[JavaScript](/knowledge/languages/js/)[TypeScript](/knowledge/languages/ts/)[Python](/knowledge/languages/python/)[C#](/knowledge/languages/csharp/)[C++](/knowledge/languages/cpp/)[C](/knowledge/languages/c/)[PHP](/knowledge/languages/php/)[Kotlin](/knowledge/languages/kotlin/)[See All](/lp/knowledge/languages/)
* Resources

  Learn About Clean Code

  [BlogStay connected with our latest development news and articles](/blog/)[Events hubLet's meet up online or in person - browse our conferences and webinars, or watch previous talks](/resources/events/)[Customer StoriesCheck out Sonar implementation success stories](/resources/customer-stories/)[White PapersFind in-depth articles on clean code](/resources/white-papers/)[LearnDeveloper learning hub - covering essential topics](/learn/)[Solution BriefsOur library of solution briefs](/resources/solution-briefs/)

  Go In Depth

  [SonarQube Server DocumentationFind more information on the technical details of SonarQube Server](https://docs.sonarsource.com/sonarqube/latest/)[SonarQube Cloud DocumentationFind more information on the technical details of SonarQube Cloud](https://docs.sonarsource.com/sonarcloud/)[SonarQube for IDE DocumentationFind more information on the technical details of SonarQube IDE](https://docs.sonarsource.com/sonarlint/)[Explore SonarpediaExplore our publicly available multi-language rules database](https://rules.sonarsource.com/)[LanguagesSee our multi-language coverage](/knowledge/languages/)
* Company

  Deliver Better Software

  [About UsSonar’s industry leading solution enables developers to write clean code and remediate existing code organically](/company/about/)[CareersJoin our growing team](/company/careers/)[Commitment to open sourceOur commitment to transparency, security, and continuous improvement](/solutions/commitment-to-open-source/)[CommunityGet latest updates, suggest features, and share your knowledge](https://community.sonarsource.com/)[PartnersSonar partners with the best resellers to bring Clean Code closer to you](/company/partners/)[Contact usHave questions? Get in touch](/company/contact/)

  Media

  [NewsroomNews announcements, media coverage, and more](/company/newsroom/)[CoverageFind articles about Sonar in the news](/company/coverage/)[Press ReleasesThe latest Sonar updates](/company/press-releases/)[CustomersAn overview of customers using Sonar by industry](/company/customers/)[Press KitExecutive headshots, quick stats, customer logos, and more](/company/press-kit/)
[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)
Search modal toggle button[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)Mobile menu toggle button

Blog post

# CiviCRM 5.22.0 - Code Execution Vulnerability Chain Explained

![](data:image/svg+xml;charset=utf-8...)![Dennis Brinkrolf photo]()![Dennis Brinkrolf photo](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/4e33a3d4-6781-4fe3-aaa3-0ec178d00386/d118d723-bccb-4102-9d5c-ccf1a2a99e5f_dennis_brinkrolf.png?w=400&h=400&auto=format&fit=crop)

Dennis Brinkrolf

Security Researcher

June 21, 2021

8 min read

* [Security](/blog/tag/security/)
![](data:image/svg+xml;charset=utf-8...)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/87785a8e-6ea7-439d-8a9b-b6dbe41e64dc/CiviCMS.jpeg?w=1200&h=600&auto=format&fit=crop)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/87785a8e-6ea7-439d-8a9b-b6dbe41e64dc/CiviCMS.jpeg?w=1200&h=600&auto=format&fit=crop)

During our vulnerability research on the largest CMS systems we came across CiviCRM last year. It’s an open source CRM plugin for the most popular CMS systems like Wordpress, Joomla, Drupal, and Backdrop. CiviCRM is specifically designed for the needs of non-profit, non-governmental, and advocacy groups, and serves as an association management system. According to CiviCRM, it has been used by more than 11,000 organizations, processed more than 116 million donations, and managed 189 million contacts which makes it an attractive target for cyber criminals.

In our analysis we discovered several critical code vulnerabilities in CiviCRM version 5.22.0. A combination of these vulnerabilities allowed remote attackers to execute arbitrary system commands on any CiviCRM instance running on WordPress and to fully compromise the server and its data. In this blog post we analyze the technical root cause of two different security issues and demonstrate how attackers could exploit these. We reported all issues responsibly to the affected vendor who released multiple security patches to protect all users against attacks.

## Impact

During the analysis of CiviCRM 5.22.0, we found a CSRF vulnerability (CVE-2020-36389) that led to a Stored XSS vulnerability. Both vulnerabilities were fixed in CiviCRM version 5.28.1 and 5.27.5 ESR. Additionally, we discovered a Phar Deserialization vulnerability leading to PHP code execution (CVE-2020-36388). The issue was fixed in CiviCRM version 5.24.3 and 5.21.3.

A combination of all vulnerabilities could allow a remote attacker to execute arbitrary system commands on any CiviCRM instance. As a result, the underlying CMS such as WordPress is compromised too. In order to successfully execute the attack, an authenticated administrator is lured to a malicious page that embeds a form that automatically sends a request to the website, including the administrator's cookies, which allows gaining Remote Code Execution capabilities.

For demonstration purposes we’ve created a short video that shows how quick and easy a server is compromised.

## Technical Details

In the following, we look at the root cause of two vulnerabilities in the source code of CiviCRM. First we introduce the stored XSS that can be exploited via CSRF. In the next step, we analyse the root cause of a Phar Deserialization vulnerability.

### The Attacker’s Entry Point (CVE-2020-36389)

The administration interface of CiviCRM uses the CKEditor, a rich text editor that enables direct editing and writing of configuration files. Here, a `run()` method is used (see code below) that is called each time the editor is accessed. In line 56, the filename of the current config that will be saved is received via `$_REQUEST['present']`. In line 63, the `save()` method is called with attacker-controlled POST parameters. No CSRF tokens are verified, which results in a CSRF vulnerability (CVE-2020-36389). You can find more details about how CSRF attacks work in our [LocalStack blog post](https://www.sonarsource.com/blog/hack-the-stack-with-localstack/ "LocalStack blog post").

**civicrm/CRM/Admin/Page/CKEditorConfig.php**

```
<?php
// ...
public function run() {
    $this->preset = CRM_Utils_Array::value( 'preset', $_REQUEST, 'default' );
    //...
    elseif ( ! empty( $_POST['config'] ) ) {
        $this->save( $_POST );
    }
```

The `save()` method constructs a config file from the POST parameters passed and saves the resulting config into a JavaScript file. This allows an attacker to write JavaScript files on the target host via CSRF.

Let’s have a look at how the content of this file is created. In line 110 in the code below, a default file header is prepended to the configuration file and in lines 113 - 129 the content of the configuration file is composed. Thereby each POST parameter name is processed that starts with `config_`  in line 115. The name and value of the POST parameters are concatenated in line 126 and added to the `$config` in line 127. In line 130, the `saveConfigFile()` method is called with the attacker-controlled variable (`$config`) and partially controlled file name (`$this->present`).

**civicrm/CRM/Admin/Page/CKEditorConfig.php**

```
<?php
// ...
public function save( $params ) {
    $config = self::fileHeader()
    // Standardize line-endings
        . preg_replace( '~\R~u', "\n", $params['config'] );
    // Use all params starting with config_
    foreach ( $params as $key => $val ) {
        if ( strpos( $key, 'config_' ) === 0 && strlen( $val ) ) {
            $val = json_encode( $val, JSON_UNESCAPED_SLASHES );
            $pos = strrpos( $config, '};' );
            $key = preg_replace( '/^config_/', 'config.', $key );
            $setting = "\n\t{$key} = {$val};\n";
            $config  = substr_replace( $config, $setting, $pos, 0 );
        }
    }
    self::saveConfigFile( $this->preset, $config );
}
```

An attacker can skip lines 115 - 129 by sending a single POST field consisting of the key `config` with an arbitrary value, since the key does not start with `config_`. This allows the attacker to insert any content after the file header. It is important to note that the file header itself consists of a multi-line comment and thus does not cause JavaScript syntax errors which could terminate the execution of the JavaScript.

Let’s have a look at the name of the file to which this content is written. In line 238 of the following code the filename of the configuration file is composed and in line 239 the content of the file is written. The partial attacker-controlled file name has the following format:

*crm-ckeditor-****$preset****.js*

The only attacker controlled information in this filename is `$preset`**.** A path traversal attack is not feasible since a folder `crm-ckeditor-` would have to be located above the current directory. Also, the filename would always have the `.js` extension which is another limitation.

**civicrm/CRM/Admin/Page/CKEditorConfig.php**

```
<?php
// ...
public static function saveConfigFile( $preset, $contents ) {
    $file = Civi::paths()->getPath( self::CONFIG_FILEPATH . $preset . '.js' );
    file_put_contents( $file, $contents );
}
```

At first glance, this vulnerability does not seem particularly critical. But from an attacker's point of view, any possibility, no matter how small, is sufficient to carry out an attack. In total, the attacker needs two CSRF requests, where the first CSRF request creates an XSS payload within a config file. The second CSRF request permanently loads the previously dropped XSS config file by overwriting the CKEditor default config.

Using the first CSRF request, the attacker creates a configuration file named `crm-ckeditor-xss.js`. In order to execute the JavaScript code without syntax errors the attacker skips lines 115 - 129 of the `save()` method as already mentioned above.

In the CKEditor config it is allowed to include another custom configuration file via the customConfig directive. The JavaScript code of the included configuration file is executed directly (CIVI-SA-2020-12). Therefore, the second CSRF request overwrites the default CKEditor configuration and includes the previously created `crm-ckeditor-xss.js` via a directive which includes the XSS payload. Combining both CSRF requests causes a stored XSS in the entire backend every time the CKEditor is invoked.

### Code Execution via Phar Deserialization (CVE-2020-36388)

In this step we explain how an attacker can take further steps to compromise a CiviCRM instance. Through the stored XSS, the attacker is now able to execute JavaScript in the browser of the administrator, which can perform arbitrary actions within the web application.

However, an administrator does not always have the access privileges to features that allow to control the server, it depends on the configuration of the CMS and the server. Therefore in most cases, attackers try to extend their capabilities, e.g. to execute code on the server. In the following, we introduce another vulnerability that can be used by an attacker to escalate their privileges.

We found this code vulnerability in the Badge component (see code below). In line 22 the user controlled variable `$img` from line 21 is passed to the `getImageProperties()`method without any further checks.

**civicrm/CRM/Badge/Page/AJAX.php**

```
<?php
// ...
public static function getImageProp() {
    $img = $_GET['img'];
    list($w, $h) = CRM_Badge_BAO_Badge::getImageProperties($img);
}
```

In line 399 (see code below) the user controlled variable `$img` is passed directly to the PHP internal function `getimagesize()`, which is vulnerable to [Phar Deserialization](https://www.sonarsource.com/blog/new-php-exploitation-technique/ "Phar Deserialization"). Because an attacker can control the entire string, the attacker is able to deserialize objects via the `phar://` wrapper.

**civicrm/CRM/Badge/BAO/Badge.php**

```
<?php
// ...
public static function getImageProperties($img, $imgRes = 300, $w = NULL, $h = NULL) {
    $imgsize = getimagesize($img);
}
```

In order to exploit the Phar Deserialization vulnerability as an attacker, an image must be uploaded to the file system that contains Phar metadata. Then the `getImageProp()`method can be called via an Ajax request, whereby the `img` parameter points to the path of the previously uploaded image. We found gadgets in the CiviCRM core that allowed us to execute code. This is a strong primitive for an attacker since some CMS systems do not contain any known gadgets. However the vulnerability can only be exploited as an administrator, which is possible via the stored XSS described above.

All in all, the Phar Deserialization leads to code execution in WordPress, other CMS systems like Joomla prevent deserialization of Phar metadata. But from an attacker's point of view, it would be possible to find a universal approach via the stored XSS that would compromise any underlying CMS.

## Patches

**CVE-2020-36389 (CSRF on CKEditor Configuration Form):**

This security issue is a classic CSRF vulnerability that can be prevented by adding cryptographically secure tokens that are validated for every sensitive request.

**CVE-2020-36388 (PHP Code Execution via Phar Deserialization):**

A potential solution is to use a custom Phar wrapper which prevents the untrusted deserialization of Phar metadata. A well-known project for this would be the custom Phar wrapper of [Typo3](https://github.com/TYPO3/phar-stream-wrapper "Typo3"). Moreover, with PHP 8.0 the automatic deserialization from the Phar metadata was [disabled](https://wiki.php.net/rfc/phar_stop_autoloading_metadata "disabled"). In general, it is advised to always check which user can perform which action within a web application. It is also important to pay attention to third-party features.

## Timeline

| **Date** | **Action** |
| --- | --- |
| 2020-02-18 | We report all issues to vendor |
| 2020-02-22 | Vendor confirmed the issues |
| 2020-04-15 | Vendor released patch for Phar Deserialization in version 5.24.3 and 5.21.3 |
| 2020-08-19 | Vendor released patch for CSRF and XSS in version 5.28.1 and 5.27.5 ESR |

## Summary

In this blog post we analyzed two code vulnerabilities found in CiviCRM (5.22.0), a widely used open source solution for customer relationship management written in PHP. The combination of these two vulnerabilities can lead to a complete takeover of a CiviCRM instance. We’ve evaluated the root causes in the PHP code base and described how to fix them. We reported these vulnerabilities to the vendor who confirmed and fixed the vulnerabilities quickly. We would like to thank the CiviCRM team who quickly released multiple patches after our report. If you are hosting a CiviCRM instance and have not yet updated your installation, we highly recommend to do so now.

## Related Blog Posts

* [WordPress 5.1 CSRF to Remote Code Execution](https://www.sonarsource.com/blog/wordpress-csrf-to-rce/ "WordPress 5.1 CSRF to Remote Code Execution")
* [Code Vulnerabilities in NSA Application Revealed](https://www.sonarsource.com/blog/code-vulnerabilities-in-nsa-application-revealed/ "Code Vulnerabilities in NSA Application Revealed")
* [WooCommerce 3.6.4 - CSRF Bypass to Stored XSS](https://www.sonarsource.com/blog/woocommerce-csrf-to-stored-xss/ "WooCommerce 3.6.4 - CSRF Bypass to Stored XSS")
* [Hack the Stack with LocalStack: Code Vulnerabilities Explained](https://www.sonarsource.com/blog/hack-the-stack-with-localstack/ "Hack the Stack with LocalStack: Code Vulnerabilities Explained")
#### SHARE

[twitter](https://twitter.com/share?text=undefined)[facebook](https://www.facebook.com/sharer/sharer.php?u=undefined)[linkedin](https://www.linkedin.com/sharing/share-offsite/?url=undefined)mail[Go to SonarSource homepage![](data:image/svg+xml;charset=utf-8...)![sonar logo ]()![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=160&h=40&auto=format&fit=crop)](/)

* **Sonar Solutions**
  + [SAST](/solutions/security/)
  + [What is clean code](/solutions/clean-code/)
  + [Power of clean code](/solutions/power-of-clean-code/)
  + [Clean as you code](/solutions/our-unique-approach/)
  + [AI-assisted & quality-assured code](/solutions/ai/)
  + [DevOps transformation](/solutions/devops-transformation/)
  + [Outsourcing software development](/solutions/reduce-outsourcing-software-development-risk/)
  + [Reduce & manage technical debt](/solutions/reduce-technical-debt/)
  + [Secure by design](/solutions/secure-by-design-code/)
  + [Code coverage](/solutions/code-coverage/)
  + [Code review](/solutions/code-review/)
  + [For developers](/solutions/for-developers/)
  + [For enterprise](/solutions/for-enterprise/)
  + [Infrastructure as code](/solutions/infrastructure-as-code/)
  + [Public sector](/solutions/public-sector/)
* **Products**
  + [SonarQube for IDE](/products/sonarlint/)
  + [SonarQube Server](/products/sonarqube/)
  + [SonarQube Cloud](/products/sonarcloud/)**Pricing**
  + [Start for free](/open-source-editions/)
  + [Explore pricing](/plans-and-pricing/)
* **Company**
  + [About](/company/about/)
  + [Careers](/company/careers/)
  + [Commitment to open source](/solutions/commitment-to-open-source/)
  + [Customers](/company/customers/)
  + [Partners](/company/partners/)
  + [Contact us](/company/contact/)
  + [Accessibility](/accessibility/)
  + [NEW! Brand identity](/brand-identity/)**Media**
  + [Coverage](/company/coverage/)
  + [Press releases](/company/press-releases/)
* **Resources**
  + [Events hub](/resources/events/)
  + [Customer stories](/resources/customer-stories/)
  + [White papers](/resources/white-papers/)
  + [Learn](/learn/guide/)
  + [Community](https://community.sonarsource.com/)
  + [Support](/support/)
* **Knowledge**
  + [Explore Sonarpedia](https://rules.sonarsource.com/)
  + [Blog](/blog/)
  + [Languages](/knowledge/languages/)
  + [SonarQube Server Documentation](https://docs.sonarsource.com/sonarqube/latest/)
  + [SonarQube Cloud Documentation](https://docs.sonarsource.com/sonarcloud/)
  + [SonarQube for IDE Documentation](https://docs.sonarsource.com/sonarlint/)

* [Legal documentation](/legal/)
* [Trust center](/trust-center/)

* [Follow SonarSource on Twitter](https://twitter.com/sonarsource)
* [Follow SonarSource on Linkedin](https://www.linkedin.com/company/sonarsource/)

© 2008-2025 SonarSource SA. All rights reserved. SONAR, SONARSOURCE, SONARQUBE, and CLEAN AS YOU CODE are trademarks of SonarSource SA.


