=== Content from nostarttls.secvuln.info_91862ea4_20250119_130203.html ===

![logo](images/nostarttls.svg)
# NO STARTTLS

## Why TLS is better without STARTTLS A Security Analysis of STARTTLS in the Email Context

by Damian Poddebniak¹, Fabian Ising¹, Hanno Böck², and Sebastian Schinzel¹

¹ Münster University of Applied Sciences ² Independent Researcher

*Full paper [published
at USENIX Security 21](https://www.usenix.org/conference/usenixsecurity21/presentation/poddebniak)*

## Introduction

Connections between email clients and servers provide two ways to be protected with TLS: While implicit TLS
encrypts the connection from the start and runs on a separate port, STARTTLS
provides a mechanism to upgrade existing unencrypted connections to TLS.

Sometimes STARTTLS is seen as an opportunistic encryption mode that provides TLS protection
only when available. This is trivially vulnerable to downgrade attacks. However, modern email clients
usually have the expectation that STARTTLS is enforced, and when enabled, no unencrypted communication
is possible.

Upgrading connections via STARTTLS is fragile and vulnerable to a number of security
vulnerabilities and attacks. We found more than 40 vulnerabilities in STARTTLS implementations. We
conclude that these vulnerabilities are so common that we recommend
avoiding using STARTTLS when possible.

![Steps of an email submission and access. From left to right: Author (Email Client), Provider, Provider, Recipient (Email Client).](images/email.svg)

## Attacks

We assume a Meddler-in-the-Middle (MitM) attacker who can modify connections established between an
email client and the email server of a provider.

### Stealing Login Credentials with SMTP and IMAP via Command Injection

In 2011 Postfix developer Wietse Venema [described a bug
in STARTTLS implementations](http://www.postfix.org/CVE-2011-0411.html) that allowed
injecting plaintext commands that a server interprets as if they were part of the
encrypted connection. This works by sending additional commands with the STARTTLS command to the
server in the same TCP segment.

We found that despite being known since 2011, this vulnerability is still very common. We found
15 vulnerable implementations, and in scans, 2% of all mail servers showed this vulnerability.

This command injection can be used to steal credentials with the SMTP and IMAP protocols.

Our attack requires a Meddler in the Middle (MitM) attacker that can modify network traffic and has
login credentials for their own account on the same server. The attacker can inject commands
that authenticate them and then start sending (SMTP) or storing (IMAP) an email.
The login credentials sent by the victim will be stored in the email that the attacker
can access.

The command injection can also be used for a cross-protocol attack to serve HTTPS content with
the mail server's certificate. Detailed descriptions of these attacks can be found in our paper.

### Mailbox content forgery via Response Injection

We discovered an attack similar to the command injection in email client applications.
We call this a response injection.
This bug affected many popular mail clients, including Apple Mail, Mozilla Thunderbird, Claws Mail, and
Mutt.

By injecting additional content to the server message in response to the STARTTLS command before the TLS
handshake,
we can inject server commands that the client will process as if they were part of the encrypted connection.
This
can be used to forge mailbox content.

### IMAP connection downgrade via PREAUTH and credential-stealing with REFERRAL

In the IMAP protocol, a server can signal the client in the first message that it is already authenticated
via
the PREAUTH command. The protocol forbids using the STARTTLS command in an authenticated state. Therefore, if
a client application accepts PREAUTH, it cannot enforce STARTTLS.

A Meddler in the Middle attacker can use this to prevent STARTTLS from upgrading the connection and force
a client to an unencrypted connection.

This vulnerability was originally [found in
Trojitá in 2014](http://jkt.flaska.net/blog/Trojita_0_4_1__a_security_update_for_CVE_2014_2567.html). We discovered that multiple other
email client applications were vulnerable to the same bug.

This bug is especially severe in combination with the IMAP features [Login Referrals](https://datatracker.ietf.org/doc/html/rfc2221) and [Mailbox Referrals](https://datatracker.ietf.org/doc/html/rfc2193).
These commands allow a server to instruct a client to log into another IMAP server. By using PREAUTH to
prevent an encrypted connection, an attacker can use referrals to force a client to send credentials to an
attacker-controlled server.
Fortunately, the referral features are not supported by many clients.
We found only one client - Alpine - vulnerable to this combination of PREAUTH and referrals.

### Additional Attacks

We found additional attacks, whose security impact may vary for implementations.
Please see our paper to learn more about these attacks.

## Conclusion

All vulnerabilities described here rely on the transition of an insecure connection to a
secure connection.
Implicit TLS does not have such a transition and is therefore not vulnerable to any of these attacks.
We therefore consider implicit TLS a more secure option than STARTTLS.

We also point out that STARTTLS always introduces at least one extra connection
round trip. So implicit TLS generally provides better performance.

## Impact

The demonstrated attacks require an active attacker and may be recognized when
used against an email client that tries to enforce the transition to TLS.
We have informed all popular email client and server vendors and most issues are already
fixed.
We think that the demonstrated attacks would be difficult to execute on a large scale, and we
primarily expect them to be used in targeted attacks.
As a general recommendation, you should always update your software and (to also profit from faster
connections)
reconfigure your email client to use implicit TLS only (see below).

## Recommendations

### For Email Client Users

If possible, we recommend that users check and configure their email clients to use SMTP, POP3 and IMAP with
implicit TLS on dedicated ports, i.e., SMTP/Submission on port 465, POP3 on port 995, and IMAP on port 993.
This is in line with already existing recommendations in
[RFC 8314](https://datatracker.ietf.org/doc/html/rfc8314#section-3) and was already recommended
by [security professionals](https://www.agwa.name/blog/post/starttls_considered_harmful) before.

Some mail service providers, notably Microsoft and Apple, do not support implicit TLS for SMTP/Submission.
We recommend that users ask their mail service providers to offer the more secure implicit TLS option.

### For Application Developers

Both email server and client applications should offer implicit TLS by default.
In the long term, software developers may decide to not support STARTTLS at all and thus simplify both
their code and configuration dialogs and files.

We recommend auditing all applications supporting STARTTLS - both on the server and the client side -
for the bugs discovered.
Most importantly, applications need to ensure that no unencrypted content gets processed as part of an
encrypted connection.
IMAP applications must make sure that they do not allow PREAUTH in combination with STARTTLS.
We provide the [EAST toolkit](https://github.com/fhms-its/EAST), which allows testing
applications.

### For Mail Server Administrators

Make sure your server supports implicit TLS for all supported protocols.
If possible, consider disabling STARTTLS for IMAP, POP3 and SMTP submission.

If you really need to support STARTTLS, we recommend testing your server with our tool for the command
injection vulnerability for all supported protocols.
If your server software is vulnerable, you should ask your vendor for a security update.

## FAQ

### Isn't STARTTLS insecure anyway?

STARTTLS is used in two "modes", "opportunistic", and "enforced".
Email clients must authenticate themselves with a username and password before submitting a new email or
accessing existing emails.
For these connections, the transition to TLS via STARTTLS **must** be strictly enforced because a
downgrade would reveal the username and password and give an attacker full access to the email account.

### How can I test if my software is vulnerable?

We provide the [EAST toolkit](https://github.com/fhms-its/EAST) that allows testing email clients
and servers.

**Testing an email server** for the command injection is relatively easy with our [Command Injection Tester](https://github.com/Email-Analysis-Toolkit/command-injection-tester).
[testssl.sh](https://github.com/drwetter/testssl.sh) (dev version) and
[TLS-Attacker](https://github.com/tls-attacker/TLS-Attacker/tree/starttls)/[TLS-Scanner](https://github.com/tls-attacker/TLS-Scanner/tree/starttls) (starttls branch) also check for the command injection.

**Testing an email client** is more complex, and we refer to EAST's [Fake Mail Server](https://github.com/Email-Analysis-Toolkit/fake-mail-server) component.

### Are other protocols with support for STARTTLS or similar mechanisms affected?

We expect to see similar vulnerabilities in other protocols using STARTTLS, e.g., XMPP, FTP, IRC, or LDAP.
Thus, our recommendation to avoid STARTTLS and use implicit TLS when possible applies to those protocols as
well.
We encourage security researchers to look for such vulnerabilities in other protocols.

Some protocols only support STARTTLS and provide no implicit TLS mechanism.
We recommend that standards bodies define implicit TLS modes for these protocols and that future protocols
do this by default and avoid STARTTLS completely.

### What about communication between email servers (MTA to MTA)?

Traditionally, STARTTLS between email servers only protects against passive attacks and is vulnerable to
active attacks such as STARTTLS stripping.
Thus STARTTLS vulnerabilities do not give an advantage to the attacker.

However, efforts like [MTA-STS](https://datatracker.ietf.org/doc/html/rfc8461) and [DANE](https://datatracker.ietf.org/doc/html/rfc7671) provide authentication mechanisms for MTA
to MTA connections.
Therefore, server software should be investigated for STARTTLS vulnerabilities as well.
Particularly relevant are the buffering bugs, which can happen both for the sending (response injection) and
receiving (command injection) side of a mail server.
We have found and reported some vulnerabilities in server software during our research.

Currently, there is no standardized way to use implicit TLS for MTA to MTA connections.
Therefore, it is not possible to avoid STARTTLS without changes to the protocol specification.

### How important is this?

[It's not the most important thing you should worry about today.](https://www.ipcc.ch/assessment-report/ar6/)

### How can I contact you?

You can reach us via mail or twitter:

* Damian Poddebniak, [@duesee@norden.social](https://norden.social/%40duesee), poddebniak@fh-muenster.de
* Fabian Ising, [@Murgi](https://twitter.com/Murgi), F.Ising@fh-muenster.de
* [Hanno Böck](https://hboeck.de/), [@hanno@mastodon.social](https://mastodon.social/%40hanno), hanno@hboeck.de
* Sebastian Schinzel, [@seecurity](https://twitter.com/seecurity), schinzel@fh-muenster.de

## Reported Vulnerabilities

The following is a list of all STARTTLS-related vulnerabilities we found during our research.
None of the issues would be present if implicit TLS had been used exclusively.
Due to different kinds of reports, not all issues are publicly documented.
All issues were reported more than 90 days ago.

### Email Clients

As an end user, make sure to use the newest version of your email software.
The following list serves as a quick check if your client is still affected.

#### Response Injection (Buffering)

| Product | Protocol | Status | Links |
| --- | --- | --- | --- |
| Apple Mail (macOS) | SMTP/POP3/IMAP | Fixed in macOS High Sierra 10.13.6/Big Sur 11.4 | [CVE-2020-9941](https://nvd.nist.gov/vuln/detail/CVE-2020-9941), [CVE-2021-30696](https://nvd.nist.gov/vuln/detail/CVE-2021-30696) |
| Apple Mail (iOS/iPadOS) | SMTP/POP3/IMAP | Fixed in iOS/iPadOS 14.0 | [CVE-2020-9941](https://nvd.nist.gov/vuln/detail/CVE-2020-9941) |
| Mozilla Thunderbird | IMAP | Fixed in 78.7.0 | [CVE-2020-15685](https://nvd.nist.gov/vuln/detail/CVE-2020-15685), [Vendor advisory](https://www.mozilla.org/en-US/security/advisories/mfsa2021-05/), [Bug report](https://bugzilla.mozilla.org/show_bug.cgi?id=1622640) |
| Claws Mail | SMTP/POP3/IMAP | Fixed in 3.17.6 for SMTP/POP3, See libEtPan for IMAP | [CVE-2020-15917](https://nvd.nist.gov/vuln/detail/CVE-2020-15917) |
| Mutt | IMAP/SMTP/POP3 | Fixed in 1.14.4 | [CVE-2020-14954](https://nvd.nist.gov/vuln/detail/CVE-2020-14954) |
| NeoMutt | IMAP/SMPT/POP3 | Fixed in 2020-06-19 | [Commit/Patch](https://github.com/neomutt/neomutt/commit/fb013ec666759cb8a9e294347c7b4c1f597639cc), see also [CVE-2020-14954](https://nvd.nist.gov/vuln/detail/CVE-2020-14954) |
| Evolution | SMTP/POP3 | Fixed in 3.36.4 (evolution-data-server) | [CVE-2020-14928](https://nvd.nist.gov/vuln/detail/CVE-2020-14928) |
| LibEtPan (Mail Framework for C Language) | IMAP/SMTP/POP3 | Fixed in repository, unreleased | [CVE-2020-15953](https://nvd.nist.gov/vuln/detail/CVE-2020-15953) |
| Exim (MTA sending) | SMTP | Unfixed (reported privately) | [CVE-2021-38371](https://nvd.nist.gov/vuln/detail/CVE-2021-38371) |
| Gmail (iOS/iPadOS) | SMTP/IMAP | Unfixed (reported privately) | - |
| Mail.ru, MyMail | SMTP | Unfixed (reported privately, report closed as not applicable) | - |
| Yandex | SMTP/IMAP | Unfixed (reported privately) | - |
| PHP (stream\_socket\_enable\_crypto) | SMTP/POP3/IMAP | Unfixed | [Bug report (private)](https://bugs.php.net/bug.php?id=80008) |

#### Negotiation and Tampering bugs

| Product | Description | Protocol | Status | Links |
| --- | --- | --- | --- | --- |
| Gmail (Android) | Leak of emails | IMAP | Fixed (retested in 2021.07.11.387440246) | - |
| Gmail (Go) | Leak of emails | IMAP | Fixed (retested in 2020.10.15.341102866) | - |
| Samsung Email | Leak of emails | IMAP | Fixed (untested) | - |
| Alpine | Untagged responses accepted before STARTTLS | IMAP | fixed in 2.25 | [CVE-2021-38370](https://nvd.nist.gov/vuln/detail/CVE-2021-38370), [Release notes](https://alpineapp.email/alpine/release/alpine-2.25.html) |
| Trojitá Trojita | Untagged responses accepted before STARTTLS | IMAP | Unknown | [Bug report](https://bugs.kde.org/show_bug.cgi?id=432353) |
| Mozilla Thunderbird | Server responses prior to STARTTLS processed | IMAP | Fixed in 78.12 | [CVE-2021-29969](https://nvd.nist.gov/vuln/detail/CVE-2021-29969), [Vendor advisory](https://www.mozilla.org/en-US/security/advisories/mfsa2021-30/) |
| KMail | STARTTLS ignored when "Server requires authentication" not checked | SMTP | Unfixed | [Bug report](https://bugs.kde.org/show_bug.cgi?id=423423) |
| Sylpheed | STARTTLS stripping | IMAP | Unknown | [Bug report](https://sylpheed.sraoss.jp/redmine/issues/322) |
| OfflineIMAP | STARTTLS stripping | IMAP | Unknown | [Bug report](https://github.com/OfflineIMAP/offlineimap/issues/669) |
| GMX / Web.de Mail Collector | STARTTLS stripping | POP3/IMAP | Fixed | - |
| Mail.ru, MyMail, Email app for Gmail | STARTTLS Stripping | SMTP | Unfixed (report closed as not applicable) | - |

#### Avoiding Encryption via IMAP PREAUTH

| Product | Status | Links |
| --- | --- | --- |
| Apple Mail (iOS/iPadOS) | Fixed in iOS 15.1 | - |
| Mozilla Thunderbird | Fixed in 68.9.0 | [CVE-2020-12398](https://nvd.nist.gov/vuln/detail/CVE-2020-12398) |
| Alpine | Fixed in 2.23 | [CVE-2020-14929](https://nvd.nist.gov/vuln/detail/CVE-2020-14929), [Commit](https://repo.or.cz/alpine.git/commit/000edd9036b6aea5e6a06900ecd6c58faec665ab) |
| Mutt | Fixed in 1.14.3 | [CVE-2020-14093](https://nvd.nist.gov/vuln/detail/CVE-2020-14093) |
| NeoMutt | Fixed in Release 2020-06-19 | [Commit/Patch](https://github.com/neomutt/neomutt/commit/9909cde1f332d2f641c6aec0eb92adf0a150c7e5), see also [CVE-2020-14093](https://nvd.nist.gov/vuln/detail/CVE-2020-14093) |
| GMX / Web.de Mail Collector | Fixed | - |

#### Certificate Validation

| Product | Protocol | Description | Status | Links |
| --- | --- | --- | --- | --- |
| OfflineIMAP | IMAP | Accepts untrusted certificates | Unknown | [Bug report](https://github.com/OfflineIMAP/offlineimap/issues/669) |
| GMX / Web.de Mail Collector | POP3/IMAP | Accepts untrusted certificates | Still allows self-signed | - |
| Yandex | SMTP/IMAP | Accepts untrusted certificates | Unknown (report closed as not eligible) | - |
| Mail.ru, MyMail | SMTP | Accepts untrusted certificates (SMTP, IMAP) | Unknown (report closed as duplicate) | - |
| Outlook (Android & iOS) | SMTP/IMAP | Certificate hostname not checked (SMTP, IMAP) | Unknown (report closed as low/medium severity) | - |
| Geary | SMTP/IMAP | Accepting an untrusted certificate creates a permanent trust exception for all certificates | Fixed in 3.36.3 | [CVE-2020-24661](https://nvd.nist.gov/vuln/detail/CVE-2020-24661) |
| Trojitá Trojita | SMTP | Accepts untrusted certificates | Fixed in repository (77ddd5d4) (no official releases) | [CVE-2020-15047](https://nvd.nist.gov/vuln/detail/CVE-2020-15047) |
| Ruby Net::SMTP | SMTP | Only checks hostname, ignores certificate signature | Fixed in 2.7.2 | [Bug report](https://hackerone.com/reports/980249) |

#### Crashes

| Product | Protocol | Description | Status | Links |
| --- | --- | --- | --- | --- |
| Alpine | IMAP | Crash when LIST or LSUB send before STARTTLS | Fixed in 2.25 | [CVE-2021-46853](https://nvd.nist.gov/vuln/detail/CVE-2021-46853), [Release notes](https://alpineapp.email/alpine/release/alpine-2.25.html) |
| Balsa | IMAP | Nullptr dereference when TLS required and PREAUTH send | Fixed in 2.5.10 | [CVE-2020-16118](https://nvd.nist.gov/vuln/detail/CVE-2020-16118) |
| Balsa | IMAP | Stack overflow due to repeated BAD answer to CAPABILITY command | Fixed in 2.6.3 | [Bug Report](https://gitlab.gnome.org/GNOME/balsa/-/issues/48) |
| Balsa | IMAP | Crash on untagged EXPUNGE response | Fixed in 2.6.3 | [Bug Report](https://gitlab.gnome.org/GNOME/balsa/-/issues/54) |
| Evolution | IMAP | Invalid free when no auth mechanisms in greeting | Fixed in >3.35.91 | [CVE-2020-16117](https://nvd.nist.gov/vuln/detail/CVE-2020-16117) |

#### Miscellaneous

| Product | Protocol | Description | Status | Links |
| --- | --- | --- | --- | --- |
| KMail | POP3 | Setup wizard in POP3 defaults to unencrypted connections | Unfixed | [Bug Report](https://bugs.kde.org/show_bug.cgi?id=423426) |
| KMail | POP3 | Config shows "encrypted", but it isn't | Unfixed | [CVE-2020-15954](https://nvd.nist.gov/vuln/detail/CVE-2020-15954) |
| KMail | SMTP/IMAP | Dialog loop "forces" the user to accept invalid certificates | Unfixed | [Bug Report](https://bugs.kde.org/show_bug.cgi?id=423424) |
| Mozilla Thunderbird | POP3 | Infinite loop when POP3 server replies with -ERR to STLS command | Unknown | [Bug Report](https://bugzilla.mozilla.org/show_bug.cgi?id=1641882) |
| Trojitá Trojita | SMTP/IMAP | Hard to choose implicit TLS due to typo (German) | Fixed | [Bug Report](https://bugs.kde.org/show_bug.cgi?id=416942) |
| Trojitá Trojita | SMTP | SMTP defaults to plaintext on port 587 | Unknown | [Bug Report](https://bugs.kde.org/show_bug.cgi?id=432354) |

### Email Servers

We found 320.000 vulnerable email servers in an Internet-wide scan and conducted a coordinated disclosure
involving different CERTs.
It is impracticable to inform and keep track of the update process of all mail service providers on the
Internet, and thus we identified and prioritized popular mail service
providers.
We only list these in the following table.

Server issues are generally more severe than client issues.
Unfortunately, no client configuration prevents server issues from being exploited, not even the usage of
implicit TLS.
Thus, you must ensure that your server (or your mail service provider) is not affected by STARTTLS issues.

You can use our [command\_injection\_tester tool](https://github.com/Email-Analysis-Toolkit/command-injection-tester) to verify that your server is not affected by the
most severe issue.

#### Command Injection (Buffering)

| Product | Protocol | Status | Links |
| --- | --- | --- | --- |
| Nemesis (used by GMX / Web.de, provider) | POP3/IMAP | Fixed (reported privately) | - |
| Interia.pl (provider) | SMTP/POP3/IMAP | Fixed (reported privately) | - |
| Yahoo (only MTA-to-MTA, provider) | SMTP | Unfixed (reported privately) | - |
| Yandex (provider) | SMTP/POP3/IMAP | Unfixed (reported privately) | - |
| s/qmail | SMTP | Fixed in 4.0.09 | [CVE-2020-15955](https://nvd.nist.gov/vuln/detail/CVE-2020-15955) |
| Coremail | SMTP/POP3/IMAP | Unfixed (reported via CERT) | - |
| Citadel | SMTP/POP3/IMAP | Unfixed | [CVE-2020-29547](https://nvd.nist.gov/vuln/detail/CVE-2020-29547), [Bug report](https://uncensored.citadel.org/dotgoto?room=Citadel%20Security) |
| Gordano GMS | POP3/IMAP | Unfixed | [CVE-2021-37844](https://nvd.nist.gov/vuln/detail/CVE-2021-37844) |
| recvmail | SMTP | Fixed in 3.1.2 (reported privately) | - |
| SmarterMail | POP3 | Fixed in Build 7537 | [CVE-2020-29548](https://nvd.nist.gov/vuln/detail/CVE-2020-29548) |
| Burp Collaborator | SMTP | Fixed in 2020.9.2 | [Bug report](https://hackerone.com/reports/953219), [Vendor release notes](https://portswigger.net/burp/releases/professional-community-2020-9-2) |
| Dovecot | SMTP | Fixed in 2.3.14.1 and 2.3.15 | [CVE-2021-33515](https://nvd.nist.gov/vuln/detail/CVE-2021-33515) |
| Mercury/32 | SMTP/POP3/IMAP | Fixed in 4.90 | [CVE-2021-33487](https://nvd.nist.gov/vuln/detail/CVE-2021-33487) |
| QMail Toaster (1.4.1) | SMTP | Project discontinued | - |
| Courier | POP3 | Fixed in 1.1.5 (reported privately), known since 2013 | [Discussion from 2013](https://sourceforge.net/p/courier/mailman/courier-imap/thread/525D3389.4080507%40csi.uned.es/), [CVE-2021-38084](https://nvd.nist.gov/vuln/detail/CVE-2021-38084), [Fix](https://sourceforge.net/p/courier/mailman/message/37329216/) |
| PHP (stream\_socket\_enable\_crypto) | SMTP/POP3/IMAP | Unfixed | [Bug report (private)](https://bugs.php.net/bug.php?id=80008) |

#### Session Fixation

| Product | Protocol | Status | Links |
| --- | --- | --- | --- |
| Citadel | POP3/IMAP | Reported via forum, unfixed | [Forum with report](https://uncensored.citadel.org/dotgoto?room=Citadel%20Security), [CVE-2021-37845](https://nvd.nist.gov/vuln/detail/CVE-2021-37845) |
| IPswitch iMail | POP3/IMAP | Fixed in iMail 12.5.8 | [CVE-2021-37846](https://nvd.nist.gov/vuln/detail/CVE-2021-37846), [Changelog](https://docs.ipswitch.com/_Messaging/IMailServer/v12.5.8/ReleaseNotes/index.htm#link2) |

#### Miscellaneous Issues

| Product | Protocol | Description | Status | Links |
| --- | --- | --- | --- | --- |
| Nemesis (used by GMX / Web.de, provider) | SMTP | Advertises authentication before STARTTLS even though it is disabled | Fixed (reported via Bugbounty) | - |

### Media reports

[Golem.de: Sicherheitsrisiko STARTTLS](https://www.golem.de/news/verschluesselung-sicherheitsrisiko-starttls-2108-158714.html)

[The Hacker News: Dozens of STARTTLS Related Flaws Found Affecting Popular Email Clients](https://thehackernews.com/2021/08/dozens-of-starttls-related-flaws-found.html)

[The Record: STARTTLS implementations in email clients & servers plagued by 40+ vulnerabilities](https://therecord.media/starttls-implementations-in-email-clients-servers-plagued-by-40-vulnerabilities/)

[SecurityLab.ru: Десятки уязвимостей в протоколе STARTTLS затрагивают популярные почтовые клиенты](https://www.securitylab.ru/news/523448.php)

[LWN: STARTTLS considered harmful](https://lwn.net/Articles/866481/)

[Bulletproof TLS Newsletter: Vulnerabilities show fragility of STARTTLS](https://www.feistyduck.com/bulletproof-tls-newsletter/issue_80_vulnerabilities_show_fragility_of_starttls)

[APNIC blog: Vulnerabilities show why STARTTLS should be avoided if possible](https://blog.apnic.net/2021/11/18/vulnerabilities-show-why-starttls-should-be-avoided-if-possible/)

### Presentations

[USENIX Security '21 - Why TLS is better without STARTTLS](https://www.youtube.com/watch?v=cJhJdMC_PGI)

[Driving IT Conference 2021: STARTTLS endangers your E-Mail passwords](https://videos.ida.dk/media/STARTTLS%2Bendangers%2Byour%2BE-Mail%2Bpasswords%2Bv%2BHanno%2BB%C3%B6ck/1_8t4x51z0/235923713)

### Followup research

After we published our research some people found similar bugs in other software and other
protocols using STARTTLS.

[StartTLS in LDAP](https://fy.blackhats.net.au/blog/html/2021/08/12/starttls_in_ldap.html)

[nbdkit: Reset structured replies on STARTTLS (CVE-2021-3716)](https://listman.redhat.com/archives/libguestfs/2021-August/msg00077.html)

[fetchmail: STARTTLS session encryption bypassing (CVE-2021-39272)](https://www.fetchmail.info/fetchmail-SA-2021-02.txt)

[curl 7.79.0 fixes two STARTTLS vulnerabilities](https://daniel.haxx.se/blog/2021/09/15/curl-7-79-0-secure-local-cookies/)

[CVE-2021-38542: Apache James vulnerable to STARTTLS command injection (IMAP and POP3)](https://lists.apache.org/thread/j8p5n4g431hwy78qro6mwchbogq1zpck)

[CVE-2021-32066: A StartTLS stripping vulnerability in Net::IMAP](https://www.ruby-lang.org/en/news/2021/07/07/starttls-stripping-in-net-imap/)

The website design was "stolen" from the DROWN website and slightly adapted;
it was created by [Sarah Madden](http://sarahmadden.com/).
The logo was created by [foxitalic](https://twitter.com/foxitalic).
Logo, design, and content of this website are under a
[CC0](https://creativecommons.org/publicdomain/zero/1.0/) license.
| [Imprint](/imprint)

First published: 2021-08-09, last changes: 2024-01-24



=== Content from www.fehcom.de_1fc95641_20250119_130204.html ===


s/qmail - Next generation secure email transport

[![FEHCom](/buttons/logoopti.png)](/index.html)
[Consulting](/cons/cons_en.html)
[djbware](/ipnet/djbware.html)
[Publications](/pub/pub_en.html)
≡

[Scope and History](##scope)

[Installation](##installation)

[Documentation](##documentation)

[Defects](##defects)

## s/qmail

**s/qmail** (pronounced *skew-mail*) is a
*Mail Transfer Agent* (MTA) based on [Qmail](http://cr.yp.to/qmail.html)
suited for high-speed and confidential email transport
over IPv4 and IPv6 networks.

**s/qmail** preserves the Qmail [ecosystem](http://www.aqmail.org/qmail_mirror/top.html) (my mirror)
and ought to be a drop-in replacement for most sites.

**s/qmail**'s mascot is the *phoenix* (SQRP).

![Phoenix](/buttons/phoenix.png)
### Scope and History

While Qmail provides the framework for a distributed MTA,
my own developments for Qmail (e.g.
[SMTP Authentication](/qmail/smtpauth.html),
[Spamcontrol](/qmail/spamcontrol.html))
are considered necessary protocol extensions.
**s/qmail** is a complete *refactoring* of the source code
according to current demands for 64-bit systems and including IPv6 capabilities.

#### The new start: s/qmail 3.x

After now more then 20 years of Qmail's superior and uncompromised email delivery (since Qmail 1.01 launch in April 1997),
**s/qmail** posses most of the 'future' [Qmail features](https://cr.yp.to/qmail/future.html)
Dan Bernstein was heading for (see also: [Qmail TODO](/sqmail/TODO)).

* **s/qmail** is available in Dan Bernstein's
  [/package](https://cr.yp.to/slashpackage.html) format,
  usually invoked by [Daemontools](https://cr.yp.to/daemontools.html).
* **s/qmail** provides **TLS** support based on the
  [ucspi-ssl](/ipnet/ucspi-ssl.html) package.
* SMTP Authentication, Anti-Spam, and Anti-Virus features are supported out-of-the-box.
* Recipient and **MAV** capabilities in addition with powerful filters
  for SMTP envelope addresses.
* Scalable and reliable mail delivery is guaranteed by means of *QMQ*.
* Native *IPv6* support for all communication modules.

The **s/qmail** 'universe' is illustrated here:

![](/images/sqmail_Big_Picture2.png)
Figure: The s/qmail 'Big Picture'
(available as [PDF](/images/sqmail_Big_Picture2.pdf))

#### A new foundation: s/qmail 4.x & fehQlibs

Now, **s/qmail** 4.x is available based on my [fehQlibs](/ipnet/qlibs.html)
providing a common foundation for all my *djbware*. Apart from a complete refactoring
of the *s/qmail* modules, DNS BIND'ish remnants have been removed and replaced by
the modern *fehQlibs* DNS stub resolver which was on DJB's [todo](https://cr.yp.to/qmail/future.html) list.

#### Communication and security features

* **s/qmail** uses *D. J. Bernstein*'s 'C' coding principles entirely.
* Full IPv6 compliance: Allow specific IPv6 bindings to any IPv6 address (even LLU)
  for all servers and clients ([qmail-smtpd](/sqmail/sqmail/man/qmail-smtpd.html),
  [qmail-qmqtpd](/sqmail/man/qmail-qmtpd.html);
  [qmail-remote](/sqmail/man/qmail-remote.html),
  [qmail-smtpam](/sqmail/man/qmail-smtpam.html),
  [qmail-qmqpc](/sqmail/man/qmail-qmqpc.html)).
* Unlike the original version, [qmail-remote](/sqmail/man/qmail-remote.html)
  works *multi-tenant*, thus supporting different domains and senders
  with particular sending attributes (e.g. IP addresses, authentication, certificates)
  as well as providing particular bounce delivery, together with QMTP and QMTPS
  client capabilities.
* Distributed queueing: n:1, 1:n n:m
  with qualified authentication and authorization (enhanced 'QMQ').
* TLS enabling of most servers and particular clients for SMTP and QMTP as well as POP3.
* ![](/buttons/TLS-13small.png) Together with [ucspi-ssl (0.12.x)](/ipnet/ucspi-ssl.html) **s/qmail**
  is TLS 1.3 [[RFC 8446](https://tools.ietf.org/html/rfc8446)]
  capable, provided OpenSSL/LibreSSL is installed and the respective ucspissl.a
  lib is build on top of it.
* ![](/buttons/libressl.png) LibreSSL (up to 3.7) and OpenSSL (1.1/3.0) are already considered
  within [ucspi-ssl](/ipnet/ucspi-ssl.html).
* **s/qmail** allows 'opportunistic' as well as mandatory TLS encryption together with
  easy X.509 certificate pinning.
* [qmail-remote](/sqmail/man/qmail-remote.html) is
   [TLSA/DANE](https://tools.ietf.org/rfc/rfc6698.txt)  and
  finally [RFC 1870](https://tools.ietf.org/rfc/rfc1870.txt) enabled.
* Compliance with John Levine's [RFC 7505](https://tools.ietf.org/rfc/rfc7505.txt).
* ![](/buttons/spflogo.png)
  SPF capabilities have been added for [qmail-smtpd](/sqmail/man/qmail-smtpd.html)
  using [Jana Saout's](http://www.saout.de/misc/spf/)
  development (used by permission); of course with full IPv6 support.
* Reversely, [SRS](https://en.wikipedia.org/wiki/Sender_Rewriting_Scheme)
  is natively supported with the modules [srsforward](/sqmail/man/srsforward.html)
  and [srsreverse](/sqmail/man/srsreverse.html) used in a
  [dot-qmail](/sqmail/man/dot-qmail.html) file.
* ![](/buttons/fearfulface.png)
  SMPTUTF8 [[RFC 6532](https://tools.ietf.org/html/rfc6532)]
  together with *International Domain Names*
  (aka [E-mail Address Internationalisation - EAI](https://www.ietfjournal.org/e-mail-address-internationalisation-eai/) )
  is now supported by **s/qmail** provided the libidn2 is available.
* Conformance with the recent [RFC 8314](https://tools.ietf.org/html/rfc8314)
  ('Cleartext Considered Obsolete: Use of Transport Layer Security (TLS) for Email Submission and Access')
  even if former RFCs violated those principles.
* RFC 8314 'Implicit TLS' configurable for [qmail-remote](/sqmail/sqmail/man/qmail-remote.html)
  and [qmail-smtpam](/sqmail/man/qmail-smtpam.html).
* [qmail-smtpd](/sqmail/man/qmail-smtpd.html) is now immune against
  [ESMTP pipelining command injection](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15955)
  and finally against [Guninski's large **alloc**](https://nvd.nist.gov/vuln/detail/CVE-2005-1513) bug (report).
* ![](/buttons/postgrey2.png) *Greylisting* can be achieved using [qmail-postgrey](/sqmail/man/qmail-postgrey.html).
* ![](/buttons/DKIM.png) *DKIM* signing with [qmail-dksign](/sqmail/man/qmail-dksign.html)
  and verification with [qmail-dkverify](/sqmail/man/qmail-dkverify.html) for RSA or Ed25519 signatures,
  thus supporting [RFC 6376](https://tools.ietf.org/html/rfc6376) and
  [RFC 8463](https://tools.ietf.org/html/rfc8463).
* ![](/buttons/Hybrid_30px.png) Hybrid *DKIM* signing and verification with both RSA SHA-256 and
  Ed25519 private and public keys are working now.

#### Protocol extension: QMTPS

The *Quick Mail Transport Protocol* [QMTP](https://cr.yp.to/proto/qmtp.txt)
is an invention of Dan Bernstein and is a simple but fast host-to-host transparent email transport
protocol, with very little protocol overhead. It has been adopted by
[Postfix](http://mirror.serversupportforum.de/postfix/index.html) as well.
Also a  [Net-QMTP](http://search.cpan.org/~jraftery/Net-QMTP-0.06/QMTP.pm)
Perl module is available.

**s/qmail** provides additionally the TLS-secured protocol QMTPS
to couple several **s/qmail** instances and distributed queues among different nodes.

IANA has now assigned port 6209 for
[QMTPS](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=6209).

**s/qmail**'s implementation of QMTPS supports together with
[sslserver](/ipnet/ucspi-ssl/man/sslserver.1.html)
X.509 client certificates enables [qmail-qmtpd](/sqmail/man/qmail-qmtpd.html)
to relay email based on valid certificates used by
[qmail-remote](/sqmail/man/qmail-remote.html).

#### Distributed Queueing

Based on SMTP but rather preferably QMTP(S) or QMQP, **s/qmail** can be instructed
to work in a distributed queue environment, typically given in case of a Cloud service.
Authentication among the nodes and encryption on the links can be guaranteed using
QMTPS. This feature is called enhanced '*Qmail Multiple Queues*' (QMQ).

![](/images/sqmail_distqueue.png)
Figure: The s/qmail 'channels' and distributed queueing

Its light-weight design allows to deploy **s/qmail** nodes rapidly in a
Cloud based service domain.

#### Included packages

The basic **s/qmail** installation includes the following
packages (adapted mostly from Dan Bernstein):

* A versatile, CRAM enabled [checkpassword](https://cr.yp.to/checkpwd.html)
  compatible authentication PAM called [qmail-authuser](/sqmail/man/qmail-authuser.html).
* The [fastforward](http://cr.yp.to/fastforward.html) package
  is part of **s/qmail**.
* Including the [qmailanalog](http://cr.yp.to/qmailanalog.html)
  package suited for **s/qmail** together with [tai64nfrac](/sqmail/man/tai64nfrac.html).
* Additional [qmail-mrtg](/sqmail/man/qmail-mrtg.html) frontend evaluating TAI64N timestamps in **s/qmail**'s logs
  (and replacing my previous version of **qmail-mrtg**)
  for *Tobias Oetiker's* [MRTG](http://oss.oetiker.ch/mrtg/index.en.html).

  A working sample can be found [for this site](https://www.fehcom.net/qmail.html).
* If you miss something like **qmail-queuefix** or [qmHandle](http://qmhandle.sourceforge.net/) here it is:
  [qmail-qmaint](/sqmail/man/qmail-qmaint.html).

#### Supported Qmail packages

**s/qmail** provides full support for the following vanilla [Qmail](http://cr.yp.to/qmail.html)
add-ons unaltered:

* *Inter7*'s [vpopmail](http://www.inter7.com/vpopmail-virtualized-email/)
* *Bruce Guenter*'s  [VMailMgr](http://untroubled.org/vmailmgr/)
* *Dan Bernstein*'s [ezmlm](https://cr.yp.to/ezmlm.html)
* *Fred Lindberg*'s and *Bruce Guenter*'s [ezmlm-idx](http://untroubled.org/ezmlm/)
* [procmail](http://www.procmail.org)
* *Andreas Aardal Hanssen*'s [IMAP server BINC](http://sourceforge.net/projects/bincimap/)
  now available in version 2.0  [here](../binc/binc.html)!
* *Timo Sirainen*'s [Dovecot](http://www.dovecot.org) (LDA)

Note 1: For those packages TLS encryption and
IPv6 capabilities for any *data-in-flight* is possible with **s/qmail**.

Note 2: **s/qmail** Recipients extension is capable to understand
**ezmlm**'s [VERP addresses](https://cr.yp.to/proto/verp.txt).

Note 3: Authentication and recipient verification for *virtual users* is provided
out-of-the-box for [vpopmail](http://www.inter7.com/vpopmail-virtualized-email/)
and  [VMailMgr](http://untroubled.org/vmailmgr/) as well.

Note 4: Dovecot can be used as *Identity Provider* proxy even for
[qmail-smtpd](/sqmail/man/qmail-smtpd.html) by means of the enhanced
[qmail-authuser](/sqmail/man/qmail-authuser.html) calling
 [doveadm](https://wiki2.dovecot.org/Tools/Doveadm/Auth) to test
a specific socket connection.

My **s/qmail** extensions will work natively with Qmail:

* [Newanalyse 2.x](/qmail/newanalyse.html) is tailored for **s/qmail**
* [QMVC](/qmail/qmvc.html) -- is working but the latetest release
  (in particular recognizing IPv6 addresses) is under way.

### Dependencies and installation of s/qmail

The installation of **s/qmail** tries to conform to existing Qmail
systems as well as to provide a pre-configured and working MTA
together with an easy update scheme:

* Easy installation and maintenance by means of *slashpackage*.
* Compliance with 64-bit architecture and current 'C' standards.
* Drop-in replacement for Qmail (same interface; same API),
  same user accounts; same module names.
* Ready-to-use integration into
  [daemontools](https://cr.yp.to/daemontools.html).
* [systemd](https://github.com/systemd/systemd) support
   [is provided](/sqmail/sqmaildoc_03.html##systemd) as well.

<https://xkcd.com/1654/>

![](/images/xkcd_1654++.png)

#### Dependencies

For installation, **s/qmail** requires a development environment and additionally
the [OpenSSL](https://www.openssl.org) development libraries (in particular on Linux) starting with version 1.1.1
or a compatile LibreSSL implementation.

In particular, the following packages are recommended:

* Mandatory: [fehQlibs](/ipnet/qlibs.html):
  The common foundation.
* Mandatory: [ucspi-ssl](/ipnet/ucspi-ssl.html):
  Additional TLS libraries.
* Optional: [ucspi-tcp6](/ipnet/ucspi-tcp6.html):
  cdb generation, module **rblsmtpd**.
* Optional: [daemontools](https://cr.yp.to/daemontools.html):
  providing *supervise* and TAI64N timestamps by **multilog**.
* Attention: In order to include EIA/UTF8 support, you need to
  install the libidn2 together with the header file <idn2.h>.

#### Quick installation of s/qmail

**s/qmail** uses D.J.B's slashpackage convention for installing while trying
to keep the standard Qmail installation essentially unaltered:

* [Daemontools](https://cr.yp.to/daemontools.html) is
  installed and /service is working.
* [ucspi-ssl](/ipnet/ucspi-ssl.html) is installed in default location.
* [ucspi-tcp6](/ipnet/ucspi-tcp6.html) is installed.
* Untar the **s/qmail** tar file under '/package'
* Move to /package/mail/sqmail/sqmail-V.R.F and* do an initial: **package/install**.

Note: The **package/install** step respects your current Qmail settings.

#### Upgrade to s/qmail from qmail (+ perhaps Spamcontrol)

**s/qmail** will preserve your current **qmail** installation entirely
under the following circumstances:

* Install **ucspi-ssl-XX** and **ucspi-tcp6-XX** under /package.
* Untar **s/qmail** under /package and change to the install directory.
* Check and adjust the following conf-XX files (see below) to your
  existing **qmail** installation:

  conf-break, conf-cc, conf-ld, conf-home, and
  conf-split (the rest may stay unaltered).
* Execute:

1. **package/ucspissl**
2. **package/compile**
3. **package/legacy**
4. **package/man**

* Verify your setting:

+ ./compile/**qmail-showctl**
+ ./compile/**ipmeprint** (you see the additional IPv6 addresses)

* You need to take care about the new IPv6 addresses and your SSL environment+settings,
  change your run scripts and adjust control files.

#### Configuration

**s/qmail** allows to split the main program (and it configuration files) and
the queue at different locations of the file system. Thus you have now:

* conf-home -- home dir of s/qmail [/var/qmail]
* conf-queue -- high level location of the queue - may be different from conf-home
  [/var/qmail (/queue will be appended automatically)]

The (other) basic **s/qmail** configuration is done by means of conf-XX
files (in alphabetic order):

* conf-break -- the character for VERP addresses [-]
* conf-cc -- compiler (no change required)
* conf-delivery -- qmail-start default-delivery
* conf-groups\*) -- s/qmail groups
* conf-idn2 -- customization path for IDN2 libraries
* conf-ids\*) -- Unix ids for s/qmail
* conf-instances -- QMQ instances to be raised
* conf-ld -- loader options to be adjusted (for i386; AMD64 default, OmniOS needs particular setting)
* conf-log -- target dir of s/qmail logs [/var/log]
* conf-man -- target dir of man pages, usually automatically recognized
* conf-patrn -- s/qmail paternalism [002]
* conf-qmq -- QMQ environment settings
* conf-spawn -- silent concurrency limit [120]
* conf-split -- depth of s/qmail dirs [23]
* conf-svcdir -- supervise's directory [/service]
* conf-ucspissl -- path to UCSPI-SSL dirs
* conf-users\*) -- user names

\*) These files are coupled and need to be adjusted as one entity!

<https://xkcd.com/1770/>

![](https://imgs.xkcd.com/comics/ui_change.png)

The basic **s/qmail** configuration is done by means of conf-XX
#### Step-by-step installation

For an individual step-by-step installation the following commands can be executed:

1. **package/dir** -- sets up the directories
2. **package/ids** -- sets up the s/qmail users
3. **package/ucspissl** -- hooks up the required sources and libs with package ucspi-ssl
4. **package/compile** -- compiles the sources
5. **package/upgrade** -- potentially does the upgrade
6. **package/legacy** -- installs the binaries in the qmail directory
7. **package/man** -- installes the man pages
8. **package/control** -- populates the mininmal required control files for running
9. **package/sslenv** -- sets up the SSL/TLS environments together with X.509 certs
   and key files (from ucspi-ssl)
10. **package/service** -- sets up the run script for daemontools' /service
    and additionally the logging
11. **package/scripts** setup optional, undocumented and unmaintained scripts
12. **package/run** -- touches qmail/alias/ files, sets default-delivery,
    and enables s/qmail's sendmail module

### Documentation

<https://xkcd.com/1513/>

![](https://imgs.xkcd.com/comics/code_quality.png)

A concise documentation for **s/qmail** is close to be final:

* A [**'s/qmail** Big Picture'](/images/sqmail_Big_Picture.pdf) is available
  providing the default settings (*run* scripts) for most services.
* You may want to check the [README](README.md) and brief <INSTALL>
  documentation first.
* The 'official' **s/qmail** [documentation](/sqmail/sqmaildoc.html)
  is (however) still in progress.
* The set of man-pages coming along with **s/qmail** have been converted
  into HTML and are accessible [here](/sqmail/sqmailman.html).
* The standard [LWQ documentation](http://www.lifewithqmail.org/)
  for Qmail is mostly still valid; except for the installation
  procedure of **s/qmail** (and its extensions of course).

### s/qmail current release and download

Once you've checked the **s/qmail** requirements and complied
to those, you are ready to go for download and installation.

#### Download

The current release(s) of **s/qmail** can be downloaded here:

| Version & Download | Description | fehQlibs | Verification |
| --- | --- | --- | --- |
| [sqmail-4.3.20](sqmail-4.3.20.tgz) | The sixth 4.3 release is aiming for *stability*, *compatibility*, *convenience* and *compliance*.  Stability: Significant reduction of *Syscalls* for **qmail-remote**, **qmail-dksign** and **qmail-dkverify**.  Compatibility: Improved **qmail-authuser** (BincIMAP) and **qmail-vmailuser**.  Convenience: The queue can be detached from the binary and configuration files. It also complies with modern 'C' compilers (GCC 14.2 and Clang 18.1; now with correct function signatures for 'token822').  Compliance: Arch, Debian, FreeBSD, OmniOS, OpenBSD, and OpenSuSE supporting their FSH layout.  This version provides a fix for the very rare situation for DKIM signing messages with invalid 'From:' header. Improved compatibility with GCC 14.2 and POSIX-strict 'echo' implementations. Caveate: The **qmail-ldapam** is still not yet there (in usable form).  Includes now experimental support for John Levine's [RFC 7505](https://tools.ietf.org/html/rfc7505) and small fixes for **qmail-qstat** and **qmail-dkverify** and now also for [srsforward](/sqmail/man/srsforward.html). [fehQlibs-25/26](/ipnet/qlibs.html) | MD5: 6035c3b5be31742761a71d29a17d1338  Build: 20250116173953 | |
| [sqmail-4.2.29a](sqmail-4.2.29a.tgz) | The tenth 4.2 release allows now the usage of DKIM RSA and Ed25519 keys in parallel for signing and verification. While it uses refactored ALT-NT's *libdkim* C++ modules, it is deeply incorporated into **s/qmail** and provides multi-tenant signing. Ed25519 signatures are supported given the recent OpenSSL as well LibreSSL versions.  Its RECIPIENTS mechanism is enhanced to semi-automatically consider [qmail-newu](/sqmail/man/qmail-newu.html)'s cdb, which is now available as assign.cdb.  Backported fixes for [20230922#1/4.3.01], [20230920#1/4.3.01], and [20230823#1/4.3.00] included. Includes fix for the potential [qmail-smtpd](/sqmail/man/qmail-smtpd.html) AUTH misbehavior and upddates the **mkdkimkey.sh** script. Includes small fix for misspelled prototype in smtpdlog.h. Additional fix included for control/domainips which erroneously adds a '\0' to the helohost greeting. Backported improved TLSA (TA) evaluation for [qmail-remote](/sqmail/man/qmail-remote.html) from **s/qmail 4.3**. Improved robustness of DKIM signing considering erroneous keys and an unclean DKIM stage area. Included backported fixes for EHLO X-\* announcements, assign.cdb evaluation by the Recipients extension, and a correct treatment of file ids in case of wrong DKIM keys. | [fehQlibs-22/23](/ipnet/qlibs.html) (a must for SPF!) | MD5: dcef0e6d9b1faadb3e913f0ed75b7188  Build: 20240226150615 |
| [sqmail-4.1.18e](sqmail-4.1.18e.tgz) | The eleventh 4.1 release providing *Greylisting*  capabilities by means of [qmail-postgrey](/sqmail/man/qmail-postgrey.html). This version is a backport from s/qmail-4.2. Additional trimming for [qmail-remote](/sqmail/man/qmail-remote.html)'s *cafile* and *ciphers* handling.  [qmail-remote](/sqmail/man/qmail-remote.html) is enhanced to support TLSA lookups and (PKIX-EE) automatic X.509 cert validation and (now with an additional CNAME lookup and finally) supporting [RFC 1870](https://tools.ietf.org/html/rfc1870) SIZE announcements for the remote MTA while correctly provide the parameters in the MAIL FROM command. [qmail-remote](/sqmail/man/qmail-remote.html) is now enhanced to comply with [RFC 8314](https://tools.ietf.org/html/rfc8314) for 'implicit TLS' MTAs. Added module [qmail-qmaint](/sqmail/man/qmail-qmaint.html) to check the queue sanity and to remove mails from here. TLSA evaluation is now complete and working seamlessly after further adjustments coping with various DNS server settings. Malfunctioning OpenSSL X509\_pubkey\_digest() calculation replaced.  Backported fixes for [20230922#1/4.3.01], [20230920#1/4.3.01], and [20230823#1/4.3.00] included. | [fehQlibs-20/ fehQlibs-21](/ipnet/qlibs.html) | MD5 c6a802a93d7854e2e8b305912e0f8063  Build: 20230924113858 |
| [sqmail-4.0.10a](sqmail-4.0.10a.tgz) | The eighth 4.0 release now demanding **fehQlibs** while supporting natively SPF together now with SRS ([srsforward](/sqmail/man/srsforward.html) and [srsreverse](/sqmail/man/srsreverse.html)). SMTPUTF8 can now be enabled for [qmail-smtpd](/sqmail/man/qmail-smtpd.html) by means of the environment variable 'UTF8'. Based on [fehQlibs-15](/ipnet/qlibs.html) even some outstanding old CVE's are now fixed completely. This release \*is\* the last one in the 4.0 cycle. | [fehQlibs-15](/ipnet/qlibs.html) | MD5: a266b85355b48b58a2656273cf4af67d  Build: 20230311180733 |
| [sqmail-3.3.25](sqmail-3.3.25.tgz) | The fourteenth 3.3 (and backported from 3.4) release including *A. Oppermann*'s EXTTODO extension together with (optional) SMTPUTF8/EAI/IDN2 support while featuring the new [qmail-vmailuser](/sqmail/man/qmail-vmailuser.html) and the enhanced [qmail-authuser](/sqmail/man/qmail-authuser.html) PAM; providing better compatibility with current versions of OpenSSL 1.1 and finally fixing problems with **qmail-remote** and some eventual SPF-related problems in **qmail-smtpd**. | None. | MD5: 1182e3860f49a09595e61117ab3a8250  Build: 20200729153744 |
| [sqmail-3.2.19](sqmail-3.2.19.tgz) | The sixth (official) 'SPF' release; covering [OpenBSD](https://www.openbsd.org) (6.0) and [Debian 9 (Stretch)](https://www.debian.org/distrib/) while providing additional Recipient PAMs for  [VMailMgr](http://untroubled.org/vmailmgr/) and [vpopmail](http://www.inter7.com/vpopmail-virtualized-email/) (together with [ucspi-ssl-0.99)](/ipnet/ucspi-ssl.html). | None. | MD5: 8a4fd942c1a1271619b0696d934c401a  Build: 220170408184513 || [sqmail-3.1.9](sqmail-3.1.9.tgz) | This is the fourth update. This 'π5+' release enhances the [qmail-authuser](/sqmail/man/qmail-authuser.html) capabilities for *virtual domain* handlers. | None. | MD5: cb4da2ca52a05fda6668850c1d41359f  Build: 20160724111506 |
| [sqmail-3.0.2](sqmail-3.0.2.tgz) | The third fully integrated release; don't use it/just for reference. | None. | MD5: 4045d0a85fe4857fcf9c118fcfa13d1f |

The code of the current release can be viewed
in a [doxygen](/sqmail/doxygen/index.html) archive.

#### Addendum

Two patches are currently available for s/qmail 4.1 and 4.2 which are
incorporated into the last builds, but also can be applied to previous builds:

1. <mkdkimkey.sh> version 0.48 script. You need to redfine the HOME variable.
2. Fix for EXIST clause evaluating SPF records: <spfdnsip.c.patch> -
   prevents wrong SPF results for this case (only).
3. Fix for BADMIMETYPE evaluation: <qmail-smtpd.c.patch> -
   for convenience ony; otherwise simply use BADMIMETYPE=" " instead.

#### Additional packages

I also recommend to use

* [Newanalyse 2.x](/qmail/newanalyse.html)![](/buttons/new.png)
  which allows long-haul logging and easy finding of delivered mails from the logs.
* [Tobias Oetiker's **MRTG**](http://oss.oetiker.ch/mrtg/) to visualize
  **s/qmail**'s logs together with [qmail-mrtg](/sqmail/man/qmail-mrtg.html).

### Release Management & Defects

Naming conventions:

* Error: Implementation does not conform to reqs, e.g. something is missing.
* Bug: Coding mistake in source file(s).
* Flaw: Wrong/missing description in man-file or any attached documentation.
* RfC: Request for Change: Feature request.

Open defects:

| Reference | Type | Description | State |
| --- | --- | --- | --- |
| [20170630#1] | Rfc | Add flexible uid configuration. | Confirmed, pending |
| [20200509#1] | Rfc | Add **qmail-ldapam** for authentication. | Confirmed; an external package is required swallowing the code from s/qmail-4.3 (work in progress) |
| [20200715#1] | Rfc | VERP address should be automatically accepted by **qmail-smtpd**'s recipient extension | Rejected; better to include those with an additional entry here. |
| [20220324#1] | Rfc | The RECIPIENTS mechanism does not support *qmail-users*'s cdb Done; starting with version 4.2 the cdb generated by **qmail-newu** will be consulted for valid recipients semi-automatically; however, the resulting cdb is renamed assign.cdb. | |

<https://xkcd.com/1700/>

![](https://imgs.xkcd.com/comics/new_bug.png)

Mitre CVEs:

1. [CVE-2020-15955] [StartTLS command injection](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15955) (closed in 4.0.08)
2. [CVE-2005-1513] [Integer overflow on 64 bit platforms](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1513) (closed in 4.0.08)

Closed defects (version 4 only):

* [20250115#1/4.3.20] [srsforward](/sqmail/man/srsforward.html) had an off-by-one error not forwarding mails (introduced in 4.3.11).
* [20241216#1/4.3.18] [qmail-dkim](/sqmail/man/qmail-dkim.html) segfaults while trying to 'sign' mails with invalid 'From:' header.

  A [patch](/sqmail/qmail-dkim.patch) is available for all **s/qmail** versions with DKIM support.
* [20240711#1/4.3.14] [qmail-dkverify](/sqmail/man/qmail-dkverify.html) may crash in case of odly broken DKIM header: d=CRLF.
* [20240801#1/4.3.12] [qmail-smtpd](/sqmail/man/qmail-smtpd.html)'s recipients extension truncates ukey upon receipt, leading to declined mails .
* [20240118#1/4.3.04] [qmail-remote](/sqmail/man/qmail-remote.html) may falsely recognize a MTA's ESMTP EHELO message with X-\* extension.

* [20231110#1/4.2.29] [qmail-dksign](/sqmail/man/qmail-dksign.html) deferres mail, in case the sign-key is not available.
* [20231203#1/4.2.29] [qmail-smtpd](/sqmail/man/qmail-smtpd.html) may crash while logging SPF bounces.
* [20230931#1/4.3.02] [qmail-smtpd](/sqmail/man/qmail-smtpd.html) may segfault in case of invalid AUTH method
  input. Backported to **s/qmail-4.2.27**.
* [20230922#1/4.3.01] [spfquery](/sqmail/man/spfquery.html)'s returns wrong results for the SPF EXIST
  clause due a to wrong DNS lookup.
* [20230920#1/4.3.01] [qmail-remote](/sqmail/man/qmail-remote.html)'s announces SIZE=0 if invoked
  from a pipe and not from a file interface; ie. if called from an umbrella script. Workaround: SIZE announcement
  disabled for SMTP, *deferral* message given for QMTP delivery. Need to change API in
  [qmail-rspawn](/sqmail/man/qmail-rspawn.html) in the forthcoming release.
* [20230823#1/4.3.00] [qmail-smtpd](/sqmail/man/qmail-smtpd.html)'s *badmimetype* does not work setting the
  environment variable to "BADMINETYPE=''". Rather use "BADMINETYPE='!'" (workaround).

* [20231109#1/4.2.29] [qmail-dksign](/sqmail/man/qmail-dksign.html) does not evaluate DKIM in lowercase only.
* [20231003#1/4.2.27b] While using control/domainips with a tailored 'helohost'
  [qmail-remote](/sqmail/man/qmail-remote.html) adds a '\0' to the naked hostname given here in violation of RFC 2821.

  Workaround: Simply add some welcome text to the hostname.
* [20231003#1/4.2.27a] [qmail-smtpd](/sqmail/man/qmail-smtpd.html) returns incomplete Auth failure message.
* [20230718#1/4.2.25] [qmail-dkim](/sqmail/man/qmail-dkim.html) considers DKIM verification as
  'failed/key revoked' if in the DNS TXT records 'k=' (key type) is missing.
* [20230503#1/4.2.24] [qmail-smtpd](/sqmail/man/qmail-smptd.html) does not correctly evaluate 'SPF PTR:' settings (ie. for yahoo.com).
* [20230316#1/4.2.23] [qmail-remote](/sqmail/man/qmail-remote.html) does not fall-back to none-StartTLS connections (fix backported to 4.1).
* [20230303#1/4.2.22] [qmail-remote](/sqmail/man/qmail-remote.html) abends connecting to a MTA that does not provide a SMTP dialogue (fix backported to 4.1 and 4.0).

* [20221223#2/4.1.18] [qmail-local](/sqmail/man/qmail-local.html) does not detect mail loops in some cases (if address includes a dash).
* [20221223#1/4.1.18] [fastforward](/sqmail/man/fastforward.html) does not inject the mail, if the alias is given in the cdb.
* [20221220#1/4.1.18] [qmail-remote](/sqmail/man/qmail-remote.html) verification failure for X.509 certs according to tlsdestinations settings.
* [20222213#1/4.1.18] [qmail-smtpd](/sqmail/man/qmail-smptd.html) given its SPF evaluation does not understand the 'exists' pattern.
* [20220315#1/4.1.16] [qmail-remote](/sqmail/man/qmail-remote.html) fails to bind IPv4 address in case it is given in *localip*.
* [20220329#1/4.1.16] [qmail-remote](/sqmail/man/qmail-remote.html) erratic logging of 'greylisting'.
* [20220225#1/4.1.14] [qmail-remote](/sqmail/man/qmail-remote.html) shows up wrong 'Greylisting' infomation in log.
* [20211218#1/4.1.13] [qmail-remote](/sqmail/man/qmail-remote.html) conforms to RFC 6698 PKIX-EE certificate verification for TLSA.
* [20211021#1/4.1.12] [qmail-remote](/sqmail/man/qmail-remote.html) TLSA checking working again correctly.
* [20210824#1/4.1.11] Fixed [qmail-smtpam](/sqmail/man/qmail-smtpam.html) segfaults on call.
* [20210818#1/4.1.11] [qmail-vmailuser](/sqmail/man/qmail-vmailuser.html) is unable to validate **vpopmail**'s Mailboxes.
* [20210801#1/4.1.10] Fixed wrong SIZE evaluation for QMTP sending within [qmail-remote](/sqmail/man/qmail-remote.html).
* [20210622#1/4.1.09] Fixed wrong SIZE and UTF8 announcement for [qmail-remote](/sqmail/man/qmail-remote.html)
  together with an incomplete TLSA record checking.
* [Flaw:20210212#1/4.1.08] Removed hardcoded domain name 'spf.pobox.com' in SPF default expansion.
* [20120312#1/4.1.08] Using both [qmail-smtpd](/sqmail/man/qmail-smtpd.html)'s
  badmailfrom and badrcptto may interfere and reject mails erroneously.
* [Flaw:20201112#1/4.1.08] [qmail-remote](/sqmail/man/qmail-remote.html)'s smtproutes allows now binding to specific local IP address.
* [Flaw:20210213#1/4.1.08] [qmail-remote](/sqmail/man/qmail-remote.html)'s smtproutes are not authenticating.
* [20201123#1/4.1.08] Binding problem to IPv4 addresses for [qmail-remote](/sqmail/man/qmail-remote.html) resolved.

* [20200724#1/4.0.10] Compatibility with GCC 10 is finally provided now.
* [20200724#1/4.0.08] Fixes for [qmail-smtpd](/sqmail/man/qmail-smtpd.html)
  to cope with CVE-2011-0411 (ESMTP pipelining command injection).
* [20200713#1/4.0.08] Fixes for [qmail-vmailuser](/sqmail/man/qmail-vmailuser.html)
  not respecting **vpopmail**'s home directory.
* [20200509#1/4.0.08] Fixes for [qmail-smtpd](/sqmail/man/qmail-smtpd.html)
  to cope with CVE 2005-1513 (Guninski alloc bug report) and solved via
  [fehQlibs-15](/ipnet/qlibs.html).
* [20200514#1/4.0.07] Fixes for [qmail-smtpd](/sqmail/man/qmail-smtpd.html)
  considering other DNS TXT as none-existing SPF records (and potentially rejecting connections).
* [20200423#1/4.0.06] [qmail-smtpd](/sqmail/man/qmail-smtpd.html)
  may segfault while evalutating SPF records from Google.
* [20200410#1/4.0.05] [qmail-remote](/sqmail/man/qmail-remote.html) and
  [qmail-smtpam](/sqmail/man/qmail-smtpam.html) is not SMTP-UTF8 enabled by
  default (and now without compiler flag).
* [20200408#1/4.0.05] [qmail-remote](/sqmail/man/qmail-remote.html) has wrong mangling
  of RCPT TO: addresses in case of a CNAME.
* [20200303#1/4.0.04] [qmail-smtpd](/sqmail/man/qmail-smtpd.html) may segfault for mails with
  more than one RCPT TO:.
* [20200227#1/4.0.02] Added SRS capabilities with the modules [srsforward](/sqmail/man/srsforward.html)
  and [srsreverse](/sqmail/man/srsreverse.html).
* [20190116#1/4.0.00] [qmail-remote](/sqmail/man/qmail-remote.html) fails to authenticate to some servers fixed.

Note: The given release number following the defect number tells,
in which version of **s/qmail** this change was applied. The given date, when the defect was reported.

#### Release plan

**s/qmail** will be maintained and my release plan includes the following
topics:

* Version 3.0 is the first complete release (*done*).
* Version 3.1 will be used for additional enhancements (*done*).
* Version 3.2 includes SPF capabilities and
  [LibreSSL](https://www.libressl.org) as well
  [OpenSSL 1.1](https://www.openssl.org) hooks have been added within
  [ucspi-ssl 0.99](/ipnet/ucspi-ssl.html) (*done*).
* Version 3.3 is scheduled for performance enhancements (EXTTODO; *done*).
* Version 3.4 is forseen for integrating DJBDNSCurve6
  [fehQlibs](/ipnet/qlibs.html) and adding SRS capabilities (*done as 4.0*).
* Version 3.5 ... let's see: TLSA support? ... and probably DKIM as well.
* Version 4.0 uses [fehQlibs](/ipnet/qlibs.html) and thus its DNS stub resolver routines (*done*).
* Version 4.1 shall provide a DKIM API (*posponed to furthcoming version*) and perhaps TLSA support (*done*).
* Version 4.2 supports DKIM (both sending and receiving - *done*)
* Version 4.3 will include a versatile LDAP PAM for authentication aimes for SCC.
* Version 4.4 will include a versatile LDAP PAM for authentication and a working QMQ setup.
* Version 4.5 is supposed to allow SMTP pipeling for
  [qmail-rspawn](/sqmail/man/qmail-rspawn.html) (desperately missing).
* Version 5.0 UUID identifier for files in the queue?

#### Tickets, Change Requests, communication

An **EZMLM** mailing list working together with **s/qmail**
keeps you updated with current developments, bug fixes, and
features discussed. This list also can be used to file

* *Defects* (bug reports) and
* *Change Requests* (enhancements).

To inscribe use:
s/qmail mailing list

I can't guarantee a certain response level; but
reasonable issues will be answered.

---

* [[FEHCom]](/index.html)
* [[Impressum]](/impressum.html)
* [[News]](/news.html)
* [[top]](#top)



=== Content from xkcd.com_a5a5ed6f_20250119_142837.html ===


* [Archive](/archive)
* [What If?](https://what-if.xkcd.com)
* [About](/about)
* [Feed](/atom.xml)•[Email](/newsletter/)
* [TW](https://twitter.com/xkcd/)•[FB](https://www.facebook.com/TheXKCD/)•[IG](https://www.instagram.com/xkcd/)
* [-Books-](/books/)
* [What If? 2](/what-if-2/)
* [WI?](/what-if/)•[TE](/thing-explainer/)•[HT](/how-to/)

[![xkcd.com logo](/s/0b7742.png)](/)
A webcomic of romance,
 sarcasm, math, and language.

[Special 10th anniversary edition of WHAT IF?](https://xkcd.com/what-if/)—revised and annotated with brand-new illustrations and answers to important questions you never thought to ask—out now. Order it [here](https://bit.ly/WhatIf10th)!

New Bug

* [|<](/1/)
* [< Prev](/1699/)
* [Random](//c.xkcd.com/random/comic/)
* [Next >](/1701/)
* [>|](/)

![New Bug](//imgs.xkcd.com/comics/new_bug.png "There's also a unicode-handling bug in the URL request library, and we're storing the passwords unsalted ... so if we salt them with emoji, we can close three issues at once!")

* [|<](/1/)
* [< Prev](/1699/)
* [Random](//c.xkcd.com/random/comic/)
* [Next >](/1701/)
* [>|](/)

Permanent link to this comic: [https://xkcd.com/1700/](https://xkcd.com/1700)

Image URL (for hotlinking/embedding): <https://imgs.xkcd.com/comics/new_bug.png>

![Selected Comics](//imgs.xkcd.com/s/a899e84.jpg)

[![Earth temperature timeline](//imgs.xkcd.com/s/temperature.png)](//xkcd.com/1732/)

[RSS Feed](/rss.xml) - [Atom Feed](/atom.xml) - [Email](/newsletter/)

Comics I enjoy:

[Three Word Phrase](http://threewordphrase.com/),
[SMBC](https://www.smbc-comics.com/),
[Dinosaur Comics](https://www.qwantz.com),
[Oglaf](https://oglaf.com/) (nsfw),
[A Softer World](https://www.asofterworld.com),
[Buttersafe](https://buttersafe.com/),
[Perry Bible Fellowship](https://pbfcomics.com/),
[Questionable Content](https://questionablecontent.net/),
[Buttercup Festival](http://www.buttercupfestival.com/),
[Homestuck](https://www.homestuck.com/),
[Junior Scientist Power Hour](https://www.jspowerhour.com/)

Other things:

[Tips on technology and government](https://medium.com/civic-tech-thoughts-from-joshdata/so-you-want-to-reform-democracy-7f3b1ef10597),

[Climate FAQ](https://www.nytimes.com/interactive/2017/climate/what-is-climate-change.html),
[Katharine Hayhoe](https://twitter.com/KHayhoe)

xkcd.com is best viewed with Netscape Navigator 4.0 or below on a Pentium 3±1 emulated in Javascript on an Apple IIGS
at a screen resolution of 1024x1. Please enable your ad blockers, disable high-heat drying, and remove your device
from Airplane Mode and set it to Boat Mode. For security reasons, please leave caps lock on while browsing.

This work is licensed under a
[Creative Commons Attribution-NonCommercial 2.5 License](https://creativecommons.org/licenses/by-nc/2.5/).

This means you're free to copy and share these comics (but not to sell them). [More details](/license.html).


