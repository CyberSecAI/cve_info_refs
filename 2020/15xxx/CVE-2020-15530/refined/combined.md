=== Content from daniels-it-blog.blogspot.com_4b509a10_20250119_122100.html ===

[Skip to main content](#main)

Search

### Search This Blog

# [Another IT Security Blog](http://daniels-it-blog.blogspot.com/)

IT Security, Hacking and More

Share

* Get link
* Facebook
* X
* Pinterest
* Email
* Other Apps

[July 02, 2020](http://daniels-it-blog.blogspot.com/2020/07/steam-arbitrary-code-execution-part-2.html "permanent link")

### Steam - Escalation of Privileges

**Product:** Steam Client Software**Version:** 2.10.91.91**Tested on:** Windows 10 Pro 2004 x64**Vendor informed:** Yes**PoC:** This blog post**CVE:** CVE-2020-15530
**Brief Description:** A local attacker can use the steam client updater/installer to execute malicious executables in an elevated context via the installation process. This also results in persistence via a hijacked service executable which will run as NT AUTHORITY\SYSTEM.
**Vulnerability Description:** If valve´s steam client is installed the installation path can be deleted by normal users.
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0STecxFl9XczUVcqwLC2XB1MqaIJP6NhsLSrwr1QnG-8K2C_b1t8qywi1Q4nMx03gLu_Y1ou8Ocd4rg50c1QgIciMFI7xG4npnOhAzHMGWaBgjyWM_RXUgJTFDJyW4OPrYhyphenhyphen7iMnJ8ck/w625-h319/2020-07-02+13_42_45-Windows+PowerShell.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0STecxFl9XczUVcqwLC2XB1MqaIJP6NhsLSrwr1QnG-8K2C_b1t8qywi1Q4nMx03gLu_Y1ou8Ocd4rg50c1QgIciMFI7xG4npnOhAzHMGWaBgjyWM_RXUgJTFDJyW4OPrYhyphenhyphen7iMnJ8ck/s961/2020-07-02%2B13_42_45-Windows%2BPowerShell.png)

A local attacker can simply delete this folder to force users into a new installation of steam (there is no repair option or similar)
The steam-setup installer needs be executed in an elevated context
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhClD8e6l-d2NkIRKhH63Kh43OhDMm6jbr-hv6tDxeRYlJxOT4WUeBrd87u1XHWRcKoMj9zj0QbkOrV5gweWKmiNEeOmAaYsp3J7oKVcr82fejVxiDpctbIZGXY8wDkJSiI6jILfR3bqiM/w400-h293/2020-07-02+14_15_04-Window.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhClD8e6l-d2NkIRKhH63Kh43OhDMm6jbr-hv6tDxeRYlJxOT4WUeBrd87u1XHWRcKoMj9zj0QbkOrV5gweWKmiNEeOmAaYsp3J7oKVcr82fejVxiDpctbIZGXY8wDkJSiI6jILfR3bqiM/s456/2020-07-02%2B14_15_04-Window.png)

By default the installer will create the folder "C:\Program Files (x86)\Steam" with two sub folders and two files during the installation. The installer also modifies the ACL of this folder so users are able to read, write and delete files as shown above:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhu6L4krhfhK0eM2Nyj1utP69h2SYc3oVPVS4BaDSZjH9qnJ6Uq-hTwfXgWJtoPRJjUgJYuk4AG3od3wKsUqinFKw7YIapdypkAgu8lDfwERrUWHbVj-XSBH8rPVVORXNa0zi_RITLunPA/w500-h323/2020-07-02+14_21_50-Window.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhu6L4krhfhK0eM2Nyj1utP69h2SYc3oVPVS4BaDSZjH9qnJ6Uq-hTwfXgWJtoPRJjUgJYuk4AG3od3wKsUqinFKw7YIapdypkAgu8lDfwERrUWHbVj-XSBH8rPVVORXNa0zi_RITLunPA/s973/2020-07-02%2B14_21_50-Window.png)

When we look at the "bin" folder we see a "SteamService.exe" file.
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyFdUeDWWcJOMIa01FcMp0BlUE1prz1lHYKb4MFmKjFUz3YEu_Mc7n1uVrWby7dzmrpAjMlkd7_47gavOjhZVnVA2MoEGpv-bkezk6wGgIH4M4ml1PhipnL8wJwW9SO4wQKu30-ZNVLto/w500-h151/2020-07-02+14_23_59-bin.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyFdUeDWWcJOMIa01FcMp0BlUE1prz1lHYKb4MFmKjFUz3YEu_Mc7n1uVrWby7dzmrpAjMlkd7_47gavOjhZVnVA2MoEGpv-bkezk6wGgIH4M4ml1PhipnL8wJwW9SO4wQKu30-ZNVLto/s688/2020-07-02%2B14_23_59-bin.png)

We will also find this file under "C:\Program Files (x86)\Common Files\Steam" which is not under users control

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgtXi38-vbigGqFgH45Aw5xi9F5S_7jqrFGv8WeLXwYYee7f7SVkxjBfWSY_WoI41lAlFuNRpqRT1EzWqleaqfLmme7J7p19CnTzD7fzWz75FxTaWLzRSiwyIoETYRrQP4VExRyegoU1XI/w500-h154/2020-07-02+14_26_53-Steam.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgtXi38-vbigGqFgH45Aw5xi9F5S_7jqrFGv8WeLXwYYee7f7SVkxjBfWSY_WoI41lAlFuNRpqRT1EzWqleaqfLmme7J7p19CnTzD7fzWz75FxTaWLzRSiwyIoETYRrQP4VExRyegoU1XI/s853/2020-07-02%2B14_26_53-Steam.png)
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhm9FCZxxngAi8jio2b78hki8Vplhm1IENAh3aXXl5jzMDBY6QukE3NdcmBQ6Wbt-7oVWbdqB1YydyPDON1-JMXDlI_8n3NQ1EMtw6EW39Nfaxm4SdQJMtiUwfgrZuutr8kqeQOxcIpKYM/w500-h239/2020-07-02+14_28_36-Windows+PowerShell.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhm9FCZxxngAi8jio2b78hki8Vplhm1IENAh3aXXl5jzMDBY6QukE3NdcmBQ6Wbt-7oVWbdqB1YydyPDON1-JMXDlI_8n3NQ1EMtw6EW39Nfaxm4SdQJMtiUwfgrZuutr8kqeQOxcIpKYM/s899/2020-07-02%2B14_28_36-Windows%2BPowerShell.png)

As the name "Steam**Service**" already suggests this file is used by the "Steam Client Service"
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi8RuiroogmwE_1hwcLKKY9990XT2fxIUYrLTGl7EzTvOhVU2BX1VAordcs5bYUdetdbG8Lpi6Yblly4QRxagWAd93yVT86fFQbahH1jJ9oRttI8WdXdZCCkTh8w6j0ckTO5SQ37e4eh3Q/w433-h500/2020-07-02+14_31_34-Steam+Client+Service+Properties+%2528Local+Computer%2529.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi8RuiroogmwE_1hwcLKKY9990XT2fxIUYrLTGl7EzTvOhVU2BX1VAordcs5bYUdetdbG8Lpi6Yblly4QRxagWAd93yVT86fFQbahH1jJ9oRttI8WdXdZCCkTh8w6j0ckTO5SQ37e4eh3Q/s466/2020-07-02%2B14_31_34-Steam%2BClient%2BService%2BProperties%2B%2528Local%2BComputer%2529.png)

This is service only runs when it is needed and is stopped by default. "Steam Client Service" is also executed as "NT AUTHORITY\SYSTEM" ...
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj85ChKKm071fY9bu9LF_Cj7GahEzIbgbPsq9wxCQ5XH0NWF1KCkK_OiX_N9yJ_eRhmppSfplyF_QF3_YfbrpfurDA7MD2SwfwnLyKgoBhSXbyfqWq0Hzgwr98jg4w0Gs_q8jIuAVbyEEY/w400-h380/2020-07-02+14_34_35-Services.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj85ChKKm071fY9bu9LF_Cj7GahEzIbgbPsq9wxCQ5XH0NWF1KCkK_OiX_N9yJ_eRhmppSfplyF_QF3_YfbrpfurDA7MD2SwfwnLyKgoBhSXbyfqWq0Hzgwr98jg4w0Gs_q8jIuAVbyEEY/s557/2020-07-02%2B14_34_35-Services.png)

... and can be controlled (start|stop) by regular users:
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_yZbhJ3umm19sxgFBMiydrHKLlEyYenJymmoG4w6Fl4roZCBFSPt3RGZ46rdr2jvHxWAT1XFH_RrUmT9lsytsdzZzbD_BOx89hKrAEsw4oZSncVm93zPq2RI4UNhlRRYPig0htReyRA4/w500-h141/2020-07-02+14_36_52-Windows+PowerShell.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_yZbhJ3umm19sxgFBMiydrHKLlEyYenJymmoG4w6Fl4roZCBFSPt3RGZ46rdr2jvHxWAT1XFH_RrUmT9lsytsdzZzbD_BOx89hKrAEsw4oZSncVm93zPq2RI4UNhlRRYPig0htReyRA4/s592/2020-07-02%2B14_36_52-Windows%2BPowerShell.png)

But how can I replace the non writable "SteamService.exe" with a malicious one?
After analyzing the installer I discovered that the installer will install steam in the following way (I left some steps to keep it simple):

1. "C:\Program Files (x86)\Steam" including the two sub folders and files mentioned above will be created
2. A shortcut for the user will be created on the desktop and start menu
3. "SteamService.exe" will be copied from "C:\Program Files (x86)\Steam\bin" to "C:\Program Files (x86)\Common Files\Steam"
4. "C:\Program Files (x86)\Steam\steam.exe" will be launched elevated

To successfully exploit the installer we need to get between step no. 2 and step no. 3 to replace "C:\Program Files (x86)\Common Files\Steam\SteamService.exe" with a malicious one. After the replacement the file should be copied to "C:\Program Files (x86)\Common Files\Steam" and executed as "NT AUTHORITY\SYSTEM" when the service starts.
This maybe sounds difficult but is in fact pretty easy ;) In step no. 2 we see that a shortcut for the user will be created **before** "SteamService.exe" will be copied. It would be nice if we can tell the installer to wait until the file is replaced and then continue with the installation. This can be done by using opportunistic locks (oplocks). I use the tool "SetOpLock" by James Forshaw [GitHub](https://github.com/googleprojectzero/symboliclink-testing-tools/tree/master/SetOpLock) to set oplocks. When we put all the pieces together we get an attack like this:
The user installs steam (doesn´t matter if the previous installation was deleted/damaged by the attacker before or simply because the user wants to play some games). So the user downloads the installer and runs it after the download. Of course the user has to accept the UAC prompt because otherwise steam will not be installed.
[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgD97Gt3tZnxLKL7cndaBnar6rkizW_Pyx0sbvS_6ZvLIWMWZW-uBp-va_FCiIxqccVoXIqoG1zINMjIYln46cW4uY1pCiJiipDXrTzDYO71KWIbWxqoU1J5bKlZtmpXoep6pj8yonHWx0/w500-h366/2020-07-02+14_15_04-Window.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgD97Gt3tZnxLKL7cndaBnar6rkizW_Pyx0sbvS_6ZvLIWMWZW-uBp-va_FCiIxqccVoXIqoG1zINMjIYln46cW4uY1pCiJiipDXrTzDYO71KWIbWxqoU1J5bKlZtmpXoep6pj8yonHWx0/s456/2020-07-02%2B14_15_04-Window.png)
In the background the attacker (usually it is just a script, exe file, office macro etc.) waits for the setup process to be started. Once the setup runs, which can be easily determined by checking running processes, the attacker creates the shortcut "steam.lnk" in the start menu folder "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Steam". If the folder does not exists (because steam is installed for the first time) the attacker simply uses a loop to check if the file was created; once it is created the oplock will be set:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGhpT5eAaAsHI9Zob0stBbvLLQhQZ49OCYYvBHID4eYGEh5mPELKkDp7SoNjfWhWF9DM-oXK7svp3oWMTaIj7OcPlwnA8-LEMGyW5-vj3FJd9MZyEBjHFUxrYw3b2J5s43qTqipBp5uOw/w625-h55/2020-07-02+15_02_24-Windows+PowerShell.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGhpT5eAaAsHI9Zob0stBbvLLQhQZ49OCYYvBHID4eYGEh5mPELKkDp7SoNjfWhWF9DM-oXK7svp3oWMTaIj7OcPlwnA8-LEMGyW5-vj3FJd9MZyEBjHFUxrYw3b2J5s43qTqipBp5uOw/s988/2020-07-02%2B15_02_24-Windows%2BPowerShell.png)

The oplock will be triggered shortly and the uninstaller will stop/pause/wait. The attacker has now time to replace "C:\Program Files (x86)\Steam\bin\SteamService.exe" with an evil version:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4q93Y8vWhRSwjMTqJrOmyozdTuRzIFcdcSh8qAG2qMckHqSf6NYmR4Hl5B0AdKbxdEeEcC1er3Vu1AaHb3LTpYvB8gt-ZFLY-Jr41UXv9FPxt9j5nwGu5rJkRrut_BMhHKMNdwnXDo0I/w625-h380/2020-07-02+16_01_13-Window.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4q93Y8vWhRSwjMTqJrOmyozdTuRzIFcdcSh8qAG2qMckHqSf6NYmR4Hl5B0AdKbxdEeEcC1er3Vu1AaHb3LTpYvB8gt-ZFLY-Jr41UXv9FPxt9j5nwGu5rJkRrut_BMhHKMNdwnXDo0I/s1272/2020-07-02%2B16_01_13-Window.png)

When the oplock is released "SteamService.exe" will be executed elevated:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-QMTnSamFWaBQYsq08rxDT7GhkKBg2UYgz3rfyZ8J0Ii6G4Pnjk9Y5Vw-Ym2-Xi3r1Ic6xUdtmNkFxtagShhZ8vL0hecp4xEliDpGVSqrl_J2oGqyia6b3dUBNL3voc4bUkBJaxQvrqg/w625-h463/2020-07-02+16_03_39-Process+Monitor+-+Sysinternals_+www.sysinternals.com.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-QMTnSamFWaBQYsq08rxDT7GhkKBg2UYgz3rfyZ8J0Ii6G4Pnjk9Y5Vw-Ym2-Xi3r1Ic6xUdtmNkFxtagShhZ8vL0hecp4xEliDpGVSqrl_J2oGqyia6b3dUBNL3voc4bUkBJaxQvrqg/s768/2020-07-02%2B16_03_39-Process%2BMonitor%2B-%2BSysinternals_%2Bwww.sysinternals.com.png)

At this point we have our evil version of "SteamService.exe" launched elevated! But looking at "C:\Program Files (x86)\Common Files\Steam" shows that "SteamService.exe" was not copied automatically:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi8aCVtPjhPG4ER0b2EBIIWgT576Icc_2bpyUV2GmJFtjEBMEPvqCJQ0jUW7erLMQFRry9dbAZMnMpq6U-PdtnpTs4uqOfkWybF76mk_DY2t7vwCBa9k2Gulj4wcQ5NX6V8o_tyYTB4tKA/w625-h256/2020-07-02+16_28_12-Steam.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi8aCVtPjhPG4ER0b2EBIIWgT576Icc_2bpyUV2GmJFtjEBMEPvqCJQ0jUW7erLMQFRry9dbAZMnMpq6U-PdtnpTs4uqOfkWybF76mk_DY2t7vwCBa9k2Gulj4wcQ5NX6V8o_tyYTB4tKA/s684/2020-07-02%2B16_28_12-Steam.png)
So the evil version of "SteamService.exe" was executed elevated, but the service will not run our executable when started (because there is no executable with the name "SteamService.exe")... But "SteamService.exe" was executed elevated and therefore an attacker only needs to copy the file to "C:\Program Files (x86)\Common Files\Steam" and start the service. Because the attacker now has elevated access rights the file can be written to "C:\Program Files (x86)\Common Files\Steam" which is not allowed for normal users. When the attacker now starts the service (or the service is started by steam) the malicious version of "SteamService.exe" will be executed as "NT AUTHORITY\SYSTEM"

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhlK4aHtVkrb0ZsZDoDUcfgomwdwV46l3KUJ0tcyyoInnzE6t0wewNFcfKNoVK6V7LJpcmAYrOy_eDJMUivYc0epV9JNg1D14C2P756CkOvUpvSqCaJSqAJuHOwWQXSuwvAHYFfXMQ8EZo/w538-h625/2020-07-02+16_36_02-Event+Properties.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhlK4aHtVkrb0ZsZDoDUcfgomwdwV46l3KUJ0tcyyoInnzE6t0wewNFcfKNoVK6V7LJpcmAYrOy_eDJMUivYc0epV9JNg1D14C2P756CkOvUpvSqCaJSqAJuHOwWQXSuwvAHYFfXMQ8EZo/s572/2020-07-02%2B16_36_02-Event%2BProperties.png)

This service will be started every time the user starts steam. Also steam adds an autostart entry during the installation that will start steam at every user login resulting in executing the malicious "SteamService.exe" as "NT AUTHORITY\SYSTEM" at every user login.
**Personal Note:** This bug can be mitigated by setting correct ACL on the bin folder. However it is also a good example how users can escalate their privileges starting at the user level over high integrity and finally resulting in code execution as system. I am also pretty sure that somebody discovered this before me and is using it for some evil sh\*t.

Share

* Get link
* Facebook
* X
* Pinterest
* Email
* Other Apps

### Popular Posts

[![Image](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhOxu8ebE1R6863Whvsj3YgoAO8YGHDoRHt38_d4FyZ4VPhEJGSESmvLzf8UisJ2ojENVJaEytbQYtx6DFZ-KK8pfjvxS92cKISOL6iCK4GJdjwUAP7W0hyphenhyphen7WJ61Md-CMKWJ2DQ7VIGM80/w625-h368/2020-07-02+18_39_31-Window.png)](http://daniels-it-blog.blogspot.com/2020/07/gog-galaxy-escalation-of-privileges.html)

[July 02, 2020](http://daniels-it-blog.blogspot.com/2020/07/gog-galaxy-escalation-of-privileges.html "permanent link")

### [GOG Galaxy - Escalation of Privileges incl. Code Execution](http://daniels-it-blog.blogspot.com/2020/07/gog-galaxy-escalation-of-privileges.html)

Share

* Get link
* Facebook
* X
* Pinterest
* Email
* Other Apps

[Powered by Blogger](https://www.blogger.com)

Theme images by [enot-poloskun](http://www.istockphoto.com/portfolio/enot-poloskun?platform=blogger)

[![My photo](//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgeK_SG7N7IIvgs2eb-q-Pc3uN8LN78oNxZfiQPKL-1UMy130NvDDcqkSP30jV1cJZrW-uDPcglrt4RM_sfX9rEzO-909OEtkljjuGpnJLMzvAO9kVfUbLsvJDA0dS8/s113/anonymous.jpg)](https://www.blogger.com/profile/12332761312556315624)
[Daniel Gebert](https://www.blogger.com/profile/12332761312556315624)

[Visit profile](https://www.blogger.com/profile/12332761312556315624)

### Archive

* [2020
  11](http://daniels-it-blog.blogspot.com/2020/)

  + [August
    1](http://daniels-it-blog.blogspot.com/2020/08/)
  + [July
    6](http://daniels-it-blog.blogspot.com/2020/07/)

    - [UAC bypass via dll hijacking and mock directories](http://daniels-it-blog.blogspot.com/2020/07/uac-bypass-via-dll-hijacking-and-mock.html)
    - [IOBit Malware Fighter - Arbitrary Code Execution a...](http://daniels-it-blog.blogspot.com/2020/07/iobit-malware-fighter-arbitrary-code.html)
    - [Arbitrary File Delete via wsreset.exe // Bypass Ad...](http://daniels-it-blog.blogspot.com/2020/07/arbitrary-file-delete-via-wsresetexe.html)
    - [Software in the middle - Abusing legitimate Softwa...](http://daniels-it-blog.blogspot.com/2020/07/software-in-middle-abusing-legitimate.html)
    - [GOG Galaxy - Escalation of Privileges incl. Code E...](http://daniels-it-blog.blogspot.com/2020/07/gog-galaxy-escalation-of-privileges.html)
    - [Steam - Escalation of Privileges](http://daniels-it-blog.blogspot.com/2020/07/steam-arbitrary-code-execution-part-2.html)
  + [June
    3](http://daniels-it-blog.blogspot.com/2020/06/)
  + [May
    1](http://daniels-it-blog.blogspot.com/2020/05/)

### [Report Abuse](https://www.blogger.com/go/report-abuse)


