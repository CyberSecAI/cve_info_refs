=== Content from github.com_aee887f3_20250119_120208.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-ios%2Fcommit%2F4309f5c9bd2c15cdfd39ac173665fad3f2598b54)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-ios%2Fcommit%2F4309f5c9bd2c15cdfd39ac173665fad3f2598b54)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mozilla-mobile%2Fguardian-vpn-ios)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-mobile](/mozilla-mobile)
/
**[guardian-vpn-ios](/mozilla-mobile/guardian-vpn-ios)**
Public

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-ios) You must be signed in to change notification settings
* [Fork
  16](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-ios)
* [Star
   52](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-ios)

* [Code](/mozilla-mobile/guardian-vpn-ios)
* [Issues
  13](/mozilla-mobile/guardian-vpn-ios/issues)
* [Pull requests
  2](/mozilla-mobile/guardian-vpn-ios/pulls)
* [Actions](/mozilla-mobile/guardian-vpn-ios/actions)
* [Security](/mozilla-mobile/guardian-vpn-ios/security)
* [Insights](/mozilla-mobile/guardian-vpn-ios/pulse)

Additional navigation options

* [Code](/mozilla-mobile/guardian-vpn-ios)
* [Issues](/mozilla-mobile/guardian-vpn-ios/issues)
* [Pull requests](/mozilla-mobile/guardian-vpn-ios/pulls)
* [Actions](/mozilla-mobile/guardian-vpn-ios/actions)
* [Security](/mozilla-mobile/guardian-vpn-ios/security)
* [Insights](/mozilla-mobile/guardian-vpn-ios/pulse)

## Commit

[Permalink](/mozilla-mobile/guardian-vpn-ios/commit/4309f5c9bd2c15cdfd39ac173665fad3f2598b54)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

PGAND-410 Resolve oauth session fixation on iOS ([#272](https://github.com/mozilla-mobile/guardian-vpn-ios/pull/272))

[Browse files](/mozilla-mobile/guardian-vpn-ios/tree/4309f5c9bd2c15cdfd39ac173665fad3f2598b54)
Browse the repository at this point in the history

```
* update login flow with PKCE

* fix MockGuardianAPI
```

* Loading branch information

[![@CelesteTang](https://avatars.githubusercontent.com/u/24841965?s=40&v=4)](/CelesteTang)

[CelesteTang](/mozilla-mobile/guardian-vpn-ios/commits?author=CelesteTang "View all commits by CelesteTang")
authored
Sep 24, 2020

1 parent
[ee7e380](/mozilla-mobile/guardian-vpn-ios/commit/ee7e38059de5f8dad6bd2b5c9fc93d1e626a6caa)

commit 4309f5c

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**166 additions**
and
**98 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* FirefoxPrivateNetworkVPN.xcodeproj

  + FirefoxPrivateNetworkVPN.xcodeproj/project.pbxproj
    [project.pbxproj](#diff-72461ea675028ce07414525c5f88f77a2c4e08782ab1070b1dcad2a36a997230)
* FirefoxPrivateNetworkVPN

  + FirefoxPrivateNetworkVPN/AppDelegate.swift
    [AppDelegate.swift](#diff-0460f08f0b50a3fffac0d474d2f163db8bad824a17a442fe77dd362b09467385)
  + Networking

    - FirefoxPrivateNetworkVPN/Networking/GuardianAPI.swift
      [GuardianAPI.swift](#diff-630b2ce92c6c87cdedbcd2b6ab2d0a18cd00e6d6d3445dd0de2ddd6451b5fdbb)
    - FirefoxPrivateNetworkVPN/Networking/GuardianURLRequest.swift
      [GuardianURLRequest.swift](#diff-6bf568fbbb5e2c3a7fea79b03df9b8cf5b34938f073cbe249affea292d14f901)
    - FirefoxPrivateNetworkVPN/Networking/GuardianURLRequestPath.swift
      [GuardianURLRequestPath.swift](#diff-a385a739edce79f1402f659c14b851b6538d7fc599a990f1c9f5f7316991bbc8)
  + Project Files

    - FirefoxPrivateNetworkVPN/Project Files/Bridging-Header.h
      [Bridging-Header.h](#diff-734aa5a6b32d29e30d17144aa90102ec7044dd93e6acf4711dcf0e860f5dfd2d)
    - FirefoxPrivateNetworkVPN/Project Files/Info.plist
      [Info.plist](#diff-96c9ee10caf23d8b8a389b1cdbb9c21a1ef899c09df628a219fadc0f52f3ce7e)
  + Protocols

    - FirefoxPrivateNetworkVPN/Protocols/NetworkRequesting.swift
      [NetworkRequesting.swift](#diff-3b712e92dcc48eaf42df7aca3427fea36b81513f225d5d9a9d8cf23b1a643de3)
  + Utilities

    - FirefoxPrivateNetworkVPN/Utilities/PKCECodeGenerator.swift
      [PKCECodeGenerator.swift](#diff-2004d6af649fd822c6bf0c67a7dd6c63441376bfa71db39b09369905a51a7df3)
  + ViewControllers

    - FirefoxPrivateNetworkVPN/ViewControllers/LoginViewController.swift
      [LoginViewController.swift](#diff-eb806dd8466c92e2f1368320b035c47d967ac76eac4d5c37dced0000a1ea4aac)
* FirefoxPrivateNetworkVPNTests/Mocks

  + FirefoxPrivateNetworkVPNTests/Mocks/MockGuardianAPI.swift
    [MockGuardianAPI.swift](#diff-345825169fd327a8bb61abc0b44ed9712b08e5eb5b0fdab339de99075e545747)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[FirefoxPrivateNetworkVPN.xcodeproj/project.pbxproj](#diff-72461ea675028ce07414525c5f88f77a2c4e08782ab1070b1dcad2a36a997230 "FirefoxPrivateNetworkVPN.xcodeproj/project.pbxproj")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN.xcodeproj/project.pbxproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -244,6 +244,8 @@ |
|  |  | D54700E82491D90C00FA40A2 /\* NotificationViewController.swift in Sources \*/ = {isa = PBXBuildFile; fileRef = D54700E72491D90C00FA40A2 /\* NotificationViewController.swift \*/; }; |
|  |  | D54700EB2491D90C00FA40A2 /\* MainInterface.storyboard in Resources \*/ = {isa = PBXBuildFile; fileRef = D54700E92491D90C00FA40A2 /\* MainInterface.storyboard \*/; }; |
|  |  | D54700EF2491D90C00FA40A2 /\* NotificationContentExtension.appex in Embed App Extensions \*/ = {isa = PBXBuildFile; fileRef = D54700E12491D90C00FA40A2 /\* NotificationContentExtension.appex \*/; settings = {ATTRIBUTES = (RemoveHeadersOnCopy, ); }; }; |
|  |  | D54D31DD2519F33500D6ED57 /\* PKCECodeGenerator.swift in Sources \*/ = {isa = PBXBuildFile; fileRef = D54D31DC2519F33500D6ED57 /\* PKCECodeGenerator.swift \*/; }; |
|  |  | D54D31DE2519F33500D6ED57 /\* PKCECodeGenerator.swift in Sources \*/ = {isa = PBXBuildFile; fileRef = D54D31DC2519F33500D6ED57 /\* PKCECodeGenerator.swift \*/; }; |
|  |  | D5D349B3249A73FB00DD9F50 /\* error\_noSignal.png in Resources \*/ = {isa = PBXBuildFile; fileRef = D5D349B1249A73FA00DD9F50 /\* error\_noSignal.png \*/; }; |
|  |  | D5D349B4249A73FB00DD9F50 /\* error\_unstable.png in Resources \*/ = {isa = PBXBuildFile; fileRef = D5D349B2249A73FA00DD9F50 /\* error\_unstable.png \*/; }; |
|  |  | D5D349B6249B703F00DD9F50 /\* AppExtensionUserDefaults.swift in Sources \*/ = {isa = PBXBuildFile; fileRef = D5D349B5249B703F00DD9F50 /\* AppExtensionUserDefaults.swift \*/; }; |
| Expand Down  Expand Up | | @@ -593,6 +595,7 @@ |
|  |  | D54700E72491D90C00FA40A2 /\* NotificationViewController.swift \*/ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = NotificationViewController.swift; sourceTree = "<group>"; }; |
|  |  | D54700EA2491D90C00FA40A2 /\* Base \*/ = {isa = PBXFileReference; lastKnownFileType = file.storyboard; name = Base; path = Base.lproj/MainInterface.storyboard; sourceTree = "<group>"; }; |
|  |  | D54700EC2491D90C00FA40A2 /\* Info.plist \*/ = {isa = PBXFileReference; lastKnownFileType = text.plist.xml; path = Info.plist; sourceTree = "<group>"; }; |
|  |  | D54D31DC2519F33500D6ED57 /\* PKCECodeGenerator.swift \*/ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = PKCECodeGenerator.swift; sourceTree = "<group>"; }; |
|  |  | D5D349B1249A73FA00DD9F50 /\* error\_noSignal.png \*/ = {isa = PBXFileReference; lastKnownFileType = image.png; path = error\_noSignal.png; sourceTree = "<group>"; }; |
|  |  | D5D349B2249A73FA00DD9F50 /\* error\_unstable.png \*/ = {isa = PBXFileReference; lastKnownFileType = image.png; path = error\_unstable.png; sourceTree = "<group>"; }; |
|  |  | D5D349B5249B703F00DD9F50 /\* AppExtensionUserDefaults.swift \*/ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = AppExtensionUserDefaults.swift; sourceTree = "<group>"; }; |
| Expand Down  Expand Up | | @@ -1134,6 +1137,7 @@ |
|  |  | F4056031239E9F31000A93CC /\* KeychainStored.swift \*/, |
|  |  | F43DFC0A234D0B5C003EA64A /\* TunnelConfigurationBuilder.swift \*/, |
|  |  | F4108050242CDAB300973421 /\* NetworkingUtilities.swift \*/, |
|  |  | D54D31DC2519F33500D6ED57 /\* PKCECodeGenerator.swift \*/, |
|  |  | ); |
|  |  | path = Utilities; |
|  |  | sourceTree = "<group>"; |
| Expand Down  Expand Up | | @@ -2256,6 +2260,7 @@ |
|  |  | F4E908D32371CAAD00EB9FE6 /\* NavigationCoordinating.swift in Sources \*/, |
|  |  | F4E909092371CAAD00EB9FE6 /\* AccountInformationCell.swift in Sources \*/, |
|  |  | F42DE7C82395A64A000B79C3 /\* CarouselViewController.swift in Sources \*/, |
|  |  | D54D31DD2519F33500D6ED57 /\* PKCECodeGenerator.swift in Sources \*/, |
|  |  | F45D1D1023873B8A0084B5DE /\* CarouselPageViewController.swift in Sources \*/, |
|  |  | F4A7FA24237C5C960034AF6C /\* Account.swift in Sources \*/, |
|  |  | F4E908D52371CAAD00EB9FE6 /\* TunnelManaging.swift in Sources \*/, |
| Expand Down  Expand Up | | @@ -2404,6 +2409,7 @@ |
|  |  | D541182F24C8358500628DF6 /\* NavigationCoordinating.swift in Sources \*/, |
|  |  | D541183024C8358500628DF6 /\* AccountInformationCell.swift in Sources \*/, |
|  |  | D541183124C8358500628DF6 /\* CarouselViewController.swift in Sources \*/, |
|  |  | D54D31DE2519F33500D6ED57 /\* PKCECodeGenerator.swift in Sources \*/, |
|  |  | D541183224C8358500628DF6 /\* CarouselPageViewController.swift in Sources \*/, |
|  |  | D541183324C8358500628DF6 /\* Account.swift in Sources \*/, |
|  |  | D541183424C8358500628DF6 /\* TunnelManaging.swift in Sources \*/, |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[FirefoxPrivateNetworkVPN/AppDelegate.swift](#diff-0460f08f0b50a3fffac0d474d2f163db8bad824a17a442fe77dd362b09467385 "FirefoxPrivateNetworkVPN/AppDelegate.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/AppDelegate.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -65,6 +65,16 @@ class AppDelegate: UIResponder, UIApplicationDelegate { |
|  |  | UIDevice.current.userInterfaceIdiom == .pad ? .all : [.portrait, .portraitUpsideDown] |
|  |  | } |
|  |  |  |
|  |  | func application(\_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey: Any] = [:]) -> Bool { |
|  |  | if let sourceApplication = options[.sourceApplication] as? String, |
|  |  | sourceApplication == "com.apple.SafariViewService" { |
|  |  | NotificationCenter.default.post(name: .callbackURLNotification, object: nil, |
|  |  | userInfo: ["callbackURL": url]) |
|  |  | return true |
|  |  | } |
|  |  | return false |
|  |  | } |
|  |  |  |
|  |  | func applicationDidEnterBackground(\_ application: UIApplication) { |
|  |  | dependencyManager?.connectionHealthMonitor.stop() |
|  |  | dependencyManager?.heartbeatMonitor.stop() |
| Expand Down | |  |

30 changes: 15 additions & 15 deletions

30
[FirefoxPrivateNetworkVPN/Networking/GuardianAPI.swift](#diff-630b2ce92c6c87cdedbcd2b6ab2d0a18cd00e6d6d3445dd0de2ddd6451b5fdbb "FirefoxPrivateNetworkVPN/Networking/GuardianAPI.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Networking/GuardianAPI.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,15 +20,6 @@ class GuardianAPI: NetworkRequesting { |
|  |  | } |
|  |  |  |
|  |  | // MARK: - |
|  |  | func initiateUserLogin(completion: @escaping (Result<LoginCheckpointModel, GuardianAPIError>) -> Void) { |
|  |  | let urlRequest = GuardianURLRequest.urlRequest(request: .login, type: .POST) |
|  |  | networkLayer.fire(urlRequest: urlRequest) { result in |
|  |  | DispatchQueue.main.async { |
|  |  | completion(result.decode(to: LoginCheckpointModel.self)) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func accountInfo(token: String, completion: @escaping (Result<User, GuardianAPIError>) -> Void) { |
|  |  | let urlRequest = GuardianURLRequest.urlRequest(request: .account, type: .GET, httpHeaderParams: headers(with: token)) |
|  |  | networkLayer.fire(urlRequest: urlRequest) { result in |
| Expand All | | @@ -38,8 +29,14 @@ class GuardianAPI: NetworkRequesting { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func verify(urlString: String, completion: @escaping (Result<VerifyResponse, GuardianAPIError>) -> Void) { |
|  |  | let urlRequest = GuardianURLRequest.urlRequest(with: urlString, type: .GET) |
|  |  | func verify(code: String, codeVerifier: String, completion: @escaping (Result<VerifyResponse, GuardianAPIError>) -> Void) { |
|  |  | let body: [String: Any] = ["code": code, "code\_verifier": codeVerifier] |
|  |  | guard let data = try? JSONSerialization.data(withJSONObject: body) else { |
|  |  | completion(.failure(.couldNotEncodeData)) |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | let urlRequest = GuardianURLRequest.urlRequest(request: .verify, type: .POST, httpHeaderParams: headers(), body: data) |
|  |  | networkLayer.fire(urlRequest: urlRequest) { result in |
|  |  | DispatchQueue.main.async { |
|  |  | completion(result.decode(to: VerifyResponse.self)) |
| Expand Down  Expand Up | | @@ -106,9 +103,12 @@ class GuardianAPI: NetworkRequesting { |
|  |  | } |
|  |  |  |
|  |  | // MARK: - Utils |
|  |  | private func headers(with token: String) -> [String: String] { |
|  |  | return ["Authorization": "Bearer \(token)", |
|  |  | "Content-Type": "application/json", |
|  |  | "User-Agent": userAgentInfo] |
|  |  | private func headers(with token: String = "") -> [String: String] { |
|  |  | var headers = ["Content-Type": "application/json", |
|  |  | "User-Agent": userAgentInfo] |
|  |  | if !token.isEmpty { |
|  |  | headers["Authorization"] = "Bearer \(token)" |
|  |  | } |
|  |  | return headers |
|  |  | } |
|  |  | } |

35 changes: 23 additions & 12 deletions

35
[FirefoxPrivateNetworkVPN/Networking/GuardianURLRequest.swift](#diff-6bf568fbbb5e2c3a7fea79b03df9b8cf5b34938f073cbe249affea292d14f901 "FirefoxPrivateNetworkVPN/Networking/GuardianURLRequest.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Networking/GuardianURLRequest.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,18 +31,13 @@ struct GuardianURLRequest { |
|  |  | return urlRequest(with: urlString, type: type, queryParameters: queryParameters, httpHeaderParams: httpHeaderParams, body: body) |
|  |  | } |
|  |  |  |
|  |  | static func urlRequest(with urlString: String, |
|  |  | type: HttpMethod, |
|  |  | queryParameters: [String: String]? = nil, |
|  |  | httpHeaderParams: [String: String]? = nil, |
|  |  | body: Data? = nil) -> URLRequest { |
|  |  | var urlComponent = URLComponents(string: urlString)! |
|  |  | if let queryParameters = queryParameters { |
|  |  | let queryItems = queryParameters.map { URLQueryItem(name: $0.key, value: $0.value) } |
|  |  | urlComponent.queryItems = queryItems |
|  |  | } |
|  |  |  |
|  |  | var urlRequest = URLRequest(url: urlComponent.url!) |
|  |  | static private func urlRequest(with urlString: String, |
|  |  | type: HttpMethod, |
|  |  | queryParameters: [String: String]? = nil, |
|  |  | httpHeaderParams: [String: String]? = nil, |
|  |  | body: Data? = nil) -> URLRequest { |
|  |  | let url = generateURL(urlString: urlString, queryParameters: queryParameters) |
|  |  | var urlRequest = URLRequest(url: url!) |
|  |  | if let httpHeaderParams = httpHeaderParams { |
|  |  | httpHeaderParams.forEach { |
|  |  | urlRequest.setValue($0.value, forHTTPHeaderField: $0.key) |
| Expand All | | @@ -57,4 +52,20 @@ struct GuardianURLRequest { |
|  |  |  |
|  |  | return urlRequest |
|  |  | } |
|  |  |  |
|  |  | static private func generateURL(urlString: String, queryParameters: [String: String]?) -> URL? { |
|  |  | var urlComponent = URLComponents(string: urlString)! |
|  |  | if let queryParameters = queryParameters { |
|  |  | let queryItems = queryParameters.map { URLQueryItem(name: $0.key, value: $0.value) } |
|  |  | urlComponent.queryItems = queryItems |
|  |  | } |
|  |  |  |
|  |  | return urlComponent.url |
|  |  | } |
|  |  |  |
|  |  | static func pkceLoginURL(codeChallenge: String) -> URL { |
|  |  | let urlString = "\(GuardianURLRequest.baseURL)\(GuardianURLRequestPath.login.endpoint)" |
|  |  | let queryParameters = ["code\_challenge": codeChallenge, "code\_challenge\_method": "S256"] |
|  |  | return generateURL(urlString: urlString, queryParameters: queryParameters)! |
|  |  | } |
|  |  | } |

9 changes: 5 additions & 4 deletions

9
[FirefoxPrivateNetworkVPN/Networking/GuardianURLRequestPath.swift](#diff-a385a739edce79f1402f659c14b851b6538d7fc599a990f1c9f5f7316991bbc8 "FirefoxPrivateNetworkVPN/Networking/GuardianURLRequestPath.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Networking/GuardianURLRequestPath.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ |
|  |  |  |
|  |  | enum GuardianURLRequestPath { |
|  |  | case login |
|  |  | case verify(String) |
|  |  | case verify |
|  |  | case retrieveServers |
|  |  | case account |
|  |  | case addDevice |
| Expand All | | @@ -20,11 +20,12 @@ enum GuardianURLRequestPath { |
|  |  |  |
|  |  | var endpoint: String { |
|  |  | let prefix = "api/v1/vpn/" |
|  |  | let v2Prefix = "api/v2/vpn/" |
|  |  | switch self { |
|  |  | case .login: |
|  |  | return prefix + "login" |
|  |  | case .verify(let token): |
|  |  | return prefix + "login/verify/" + token |
|  |  | return v2Prefix + "login/ios" |
|  |  | case .verify: |
|  |  | return v2Prefix + "login/verify" |
|  |  | case .retrieveServers: |
|  |  | return prefix + "servers" |
|  |  | case .account: |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[FirefoxPrivateNetworkVPN/Project Files/Bridging-Header.h](#diff-734aa5a6b32d29e30d17144aa90102ec7044dd93e6acf4711dcf0e860f5dfd2d "FirefoxPrivateNetworkVPN/Project Files/Bridging-Header.h")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Project%20Files/Bridging-Header.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,5 +18,6 @@ |
|  |  | #include "ringlogger.h" |
|  |  | #include "key.h" |
|  |  | #import "SimplePing.h" |
|  |  | #import "CommonCrypto/CommonCrypto.h" |
|  |  |  |
|  |  | #endif /\* Guardian\_Bridging\_Header\_h \*/ |

13 changes: 13 additions & 0 deletions

13
[FirefoxPrivateNetworkVPN/Project Files/Info.plist](#diff-96c9ee10caf23d8b8a389b1cdbb9c21a1ef899c09df628a219fadc0f52f3ce7e "FirefoxPrivateNetworkVPN/Project Files/Info.plist")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Project%20Files/Info.plist)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -70,6 +70,19 @@ |
|  |  | <string>APPL</string> |
|  |  | <key>CFBundleShortVersionString</key> |
|  |  | <string>$(MARKETING\_VERSION)</string> |
|  |  | <key>CFBundleURLTypes</key> |
|  |  | <array> |
|  |  | <dict> |
|  |  | <key>CFBundleTypeRole</key> |
|  |  | <string>Editor</string> |
|  |  | <key>CFBundleURLName</key> |
|  |  | <string>org.mozilla.ios.FirefoxVPN</string> |
|  |  | <key>CFBundleURLSchemes</key> |
|  |  | <array> |
|  |  | <string>mozilla-vpn</string> |
|  |  | </array> |
|  |  | </dict> |
|  |  | </array> |
|  |  | <key>CFBundleVersion</key> |
|  |  | <string>$(CURRENT\_PROJECT\_VERSION)</string> |
|  |  | <key>ITSAppUsesNonExemptEncryption</key> |
| Expand Down | |  |

3 changes: 1 addition & 2 deletions

3
[FirefoxPrivateNetworkVPN/Protocols/NetworkRequesting.swift](#diff-3b712e92dcc48eaf42df7aca3427fea36b81513f225d5d9a9d8cf23b1a643de3 "FirefoxPrivateNetworkVPN/Protocols/NetworkRequesting.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Protocols/NetworkRequesting.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,9 +12,8 @@ |
|  |  | import Foundation |
|  |  |  |
|  |  | protocol NetworkRequesting { |
|  |  | func initiateUserLogin(completion: @escaping (Result<LoginCheckpointModel, GuardianAPIError>) -> Void) |
|  |  | func accountInfo(token: String, completion: @escaping (Result<User, GuardianAPIError>) -> Void) |
|  |  | func verify(urlString: String, completion: @escaping (Result<VerifyResponse, GuardianAPIError>) -> Void) |
|  |  | func verify(code: String, codeVerifier: String, completion: @escaping (Result<VerifyResponse, GuardianAPIError>) -> Void) |
|  |  | func availableServers(with token: String, completion: @escaping (Result<[VPNCountry], GuardianAPIError>) -> Void) |
|  |  | func addDevice(with token: String, body: [String: Any], completion: @escaping (Result<Device, GuardianAPIError>) -> Void) |
|  |  | func removeDevice(with token: String, deviceKey: String, completion: @escaping (Result<Void, GuardianAPIError>) -> Void) |
| Expand Down | |  |

42 changes: 42 additions & 0 deletions

42
[FirefoxPrivateNetworkVPN/Utilities/PKCECodeGenerator.swift](#diff-2004d6af649fd822c6bf0c67a7dd6c63441376bfa71db39b09369905a51a7df3 "FirefoxPrivateNetworkVPN/Utilities/PKCECodeGenerator.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/Utilities/PKCECodeGenerator.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,42 @@ |
|  |  | // |
|  |  | // PKCECodeGenerator |
|  |  | // FirefoxPrivateNetworkVPN |
|  |  | // |
|  |  | // This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | // License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | // file, You can obtain one at https://mozilla.org/MPL/2.0/. |
|  |  | // |
|  |  | // Copyright © 2020 Mozilla Corporation. |
|  |  | // |
|  |  |  |
|  |  | import Foundation |
|  |  |  |
|  |  | struct PKCECodeGenerator { |
|  |  | static var generateCode: (codeChallenge: String, codeVerifier: String) { |
|  |  | let codeVerifier = generateCodeVerifier() |
|  |  | let codeChallenge = base64UrlEncode(sha256(string: codeVerifier)) |
|  |  | return (codeChallenge, codeVerifier) |
|  |  | } |
|  |  |  |
|  |  | private static func generateCodeVerifier() -> String { |
|  |  | var buffer = [UInt8](repeating: 0, count: 32) |
|  |  | \_ = SecRandomCopyBytes(kSecRandomDefault, buffer.count, &buffer) |
|  |  | return base64UrlEncode(Data(buffer)) |
|  |  | } |
|  |  |  |
|  |  | private static func base64UrlEncode(\_ data: Data?) -> String { |
|  |  | guard let data = data else { return "" } |
|  |  | return data.base64EncodedString() |
|  |  | .replacingOccurrences(of: "+", with: "-") |
|  |  | .replacingOccurrences(of: "/", with: "\_") |
|  |  | } |
|  |  |  |
|  |  | private static func sha256(string: String) -> Data? { |
|  |  | guard let data = string.data(using: .utf8) else { return nil } |
|  |  | var hash = [UInt8](repeating: 0, count: Int(CC\_SHA256\_DIGEST\_LENGTH)) |
|  |  | data.withUnsafeBytes { |
|  |  | \_ = CC\_SHA256($0.baseAddress, CC\_LONG(data.count), &hash) |
|  |  | } |
|  |  | return Data(hash) |
|  |  | } |
|  |  | } |

105 changes: 49 additions & 56 deletions

105
[FirefoxPrivateNetworkVPN/ViewControllers/LoginViewController.swift](#diff-eb806dd8466c92e2f1368320b035c47d967ac76eac4d5c37dced0000a1ea4aac "FirefoxPrivateNetworkVPN/ViewControllers/LoginViewController.swift")

Show comments

[View file](/mozilla-mobile/guardian-vpn-ios/blob/4309f5c9bd2c15cdfd39ac173665fad3f2598b54/FirefoxPrivateNetworkVPN/ViewControllers/LoginViewController.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,88 +12,81 @@ |
|  |  | import UIKit |
|  |  | import SafariServices |
|  |  |  |
|  |  | extension Notification.Name { |
|  |  | static let callbackURLNotification = Notification.Name("callbackURL") |
|  |  | } |
|  |  |  |
|  |  | class LoginViewController: UIViewController, Navigating { |
|  |  | static var navigableItem: NavigableItem = .login |
|  |  |  |
|  |  | private let guardianAPI = DependencyManager.shared.guardianAPI |
|  |  | private var safariViewController: SFSafariViewController? |
|  |  | private var verificationURL: URL? |
|  |  | private var verifyTimer: Timer? |
|  |  | private var isVerifying = false |
|  |  | private let accountManager = DependencyManager.shared.accountManager |
|  |  | private let PKCECode: (String, String) = PKCECodeGenerator.generateCode |
|  |  |  |
|  |  | init() { |
|  |  | super.init(nibName: nil, bundle: nil) |
|  |  | guardianAPI.initiateUserLogin { [weak self] result in |
|  |  | switch result { |
|  |  | case .success(let checkpointModel): |
|  |  | guard let loginURL = checkpointModel.loginUrl else { return } |
|  |  | self?.verificationURL = checkpointModel.verificationUrl |
|  |  | let safariViewController = SFSafariViewController(url: loginURL) |
|  |  | DispatchQueue.main.async { |
|  |  | self?.addChild(safariViewController) |
|  |  | self?.view.addSubview(safariViewController.view) |
|  |  | safariViewController.view.frame = self?.view.bounds ?? CGRect.zero |
|  |  | safariViewController.view.autoresizingMask = [.flexibleWidth, .flexibleHeight] |
|  |  | safariViewController.didMove(toParent: self) |
|  |  | } |
|  |  | safariViewController.delegate = self |
|  |  | self?.safariViewController = safariViewController |
|  |  | case .failure(let error): |
|  |  | let loginError = error.getLoginError() |
|  |  | let context: NavigableContext = loginError == .maxDevicesReached ? .maxDevicesReached : .error(loginError) |
|  |  | self?.navigate(to: .landing, context: context) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | deinit { |
|  |  | verifyTimer?.invalidate() |
|  |  | } |
|  |  |  |
|  |  | required init?(coder: NSCoder) { |
|  |  | fatalError("init(coder:) has not been implemented") |
|  |  | } |
|  |  |  |
|  |  | @objc private func verify() { |
|  |  | guard let verificationURL = verificationURL else { return } |
|  |  | if isVerifying { return } |
|  |  | isVerifying = true |
|  |  | override func viewDidLoad() { |
|  |  | super.viewDidLoad() |
|  |  |  |
|  |  | guardianAPI.verify(urlString: verificationURL.absoluteString) { [weak self] result in |
|  |  | guard let self = self else { return } |
|  |  | let safariViewController = SFSafariViewController(url: GuardianURLRequest.pkceLoginURL(codeChallenge: PKCECode.0)) |
|  |  | addChild(safariViewController) |
|  |  | view.addSubview(safariViewController.view) |
|  |  | safariViewController.view.frame = self.view.bounds |
|  |  | safariViewController.view.autoresizingMask = [.flexibleWidth, .flexibleHeight] |
|  |  | safariViewController.didMove(toParent: self) |
|  |  | safariViewController.delegate = self |
|  |  | self.safariViewController = safariViewController |
|  |  |  |
|  |  | NotificationCenter.default.addObserver(self, selector: #selector(handleCallback), name: .callbackURLNotification, object: nil) |
|  |  | } |
|  |  |  |
|  |  | @objc private func handleCallback(notification: Notification) { |
|  |  | guard let url = notification.userInfo?["callbackURL"] as? URL, |
|  |  | let queryItems = URLComponents(string: url.absoluteString)?.queryItems, |
|  |  | let code = queryItems.first(where: { $0.name == "code" })?.value else { |
|  |  | navigate(to: .landing) |
|  |  | return |
|  |  | } |
|  |  | verify(code: code) |
|  |  | } |
|  |  |  |
|  |  | private func verify(code: String) { |
|  |  | guardianAPI.verify(code: code, codeVerifier: PKCECode.1) { [weak self] result in |
|  |  | guard let self = self else { return } |
|  |  | switch result { |
|  |  | case .success(let verification): |
|  |  | DependencyManager.shared.accountManager.login(with: verification) { loginResult in |
|  |  | self.isVerifying = false |
|  |  | self.verifyTimer?.invalidate() |
|  |  | switch loginResult { |
|  |  | case .success: |
|  |  | self.navigate(to: .home) |
|  |  | case .failure(let error): |
|  |  | Logger.global?.log(message: "Authentication Error: \(error)") |
|  |  | let context: NavigableContext = error == .maxDevicesReached ? .maxDevicesReached : .error(error) |
|  |  | self.navigate(to: .landing, context: context) |
|  |  | } |
|  |  | } |
|  |  | case .failure: |
|  |  | self.isVerifying = false |
|  |  | return |
|  |  | self.login(verification: verification) |
|  |  | case .failure(let error): |
|  |  | self.navigate(to: .landing, context: .error(error)) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // MARK: - SFSafariViewControllerDelegate |
|  |  | extension LoginViewController: SFSafariViewControllerDelegate { |
|  |  | func safariViewController(\_ controller: SFSafariViewController, didCompleteInitialLoad didLoadSuccessfully: Bool) { |
|  |  | if didLoadSuccessfully && verifyTimer == nil { |
|  |  | verifyTimer = Timer.scheduledTimer(timeInterval: 3, target: self, selector: #selector(verify), userInfo: nil, repeats: true) |
|  |  | private func login(verification: VerifyResponse) { |
|  |  | accountManager.login(with: verification) { [weak self] loginResult in |
|  |  | guard let self = self else { return } |
|  |  | switch loginResult { |
|  |  | case .success: |
|  |  | self.navigate(to: .home) |
|  |  | case .failure(let error): |
|  |  | Logger.global?.log(message: "Authentication Error: \(error)") |
|  |  | let context: NavigableContext = error == .maxDevicesReached ? .maxDevicesReached : .error(error) |
|  |  | self.navigate(to: .landing, context: context) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // MARK: - SFSafariViewControllerDelegate |
|  |  | extension LoginViewController: SFSafariViewControllerDelegate { |
|  |  | func safariViewControllerDidFinish(\_ controller: SFSafariViewController) { |
|  |  | self.verifyTimer?.invalidate() |
|  |  | navigate(to: .landing) |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4309f5c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-ios%2Fcommit%2F4309f5c9bd2c15cdfd39ac173665fad3f2598b54) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_6a5c2d97_20250119_120211.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-services%2Fguardian-vpn-windows-deprecated%2Fcommit%2Fac6f562973a83f6758cd7ab7aa313e863047d41b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-services%2Fguardian-vpn-windows-deprecated%2Fcommit%2Fac6f562973a83f6758cd7ab7aa313e863047d41b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mozilla-services%2Fguardian-vpn-windows-deprecated)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-services](/mozilla-services)
/
**[guardian-vpn-windows-deprecated](/mozilla-services/guardian-vpn-windows-deprecated)**
Public

* [Notifications](/login?return_to=%2Fmozilla-services%2Fguardian-vpn-windows-deprecated) You must be signed in to change notification settings
* [Fork
  23](/login?return_to=%2Fmozilla-services%2Fguardian-vpn-windows-deprecated)
* [Star
   41](/login?return_to=%2Fmozilla-services%2Fguardian-vpn-windows-deprecated)

* [Code](/mozilla-services/guardian-vpn-windows-deprecated)
* [Issues
  10](/mozilla-services/guardian-vpn-windows-deprecated/issues)
* [Pull requests
  10](/mozilla-services/guardian-vpn-windows-deprecated/pulls)
* [Actions](/mozilla-services/guardian-vpn-windows-deprecated/actions)
* [Security](/mozilla-services/guardian-vpn-windows-deprecated/security)
* [Insights](/mozilla-services/guardian-vpn-windows-deprecated/pulse)

Additional navigation options

* [Code](/mozilla-services/guardian-vpn-windows-deprecated)
* [Issues](/mozilla-services/guardian-vpn-windows-deprecated/issues)
* [Pull requests](/mozilla-services/guardian-vpn-windows-deprecated/pulls)
* [Actions](/mozilla-services/guardian-vpn-windows-deprecated/actions)
* [Security](/mozilla-services/guardian-vpn-windows-deprecated/security)
* [Insights](/mozilla-services/guardian-vpn-windows-deprecated/pulse)

## Commit

[Permalink](/mozilla-services/guardian-vpn-windows-deprecated/commit/ac6f562973a83f6758cd7ab7aa313e863047d41b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

New non-polling authentication flow.

[Browse files](/mozilla-services/guardian-vpn-windows-deprecated/tree/ac6f562973a83f6758cd7ab7aa313e863047d41b)
Browse the repository at this point in the history

```
- Fixes intermittent hanging during auth
- Implements PKCE
```

* Loading branch information

[![@flippedcoder](https://avatars.githubusercontent.com/u/47196133?s=40&v=4)](/flippedcoder) [![@rlr](https://avatars.githubusercontent.com/u/36629?s=40&v=4)](/rlr)

[flippedcoder](/mozilla-services/guardian-vpn-windows-deprecated/commits?author=flippedcoder "View all commits by flippedcoder")
authored and
[rlr](/mozilla-services/guardian-vpn-windows-deprecated/commits?author=rlr "View all commits by rlr")
committed
Oct 23, 2020

1 parent
[4c8499d](/mozilla-services/guardian-vpn-windows-deprecated/commit/4c8499df8fca00b660a419c353c35717fe910c45)

commit ac6f562

 Show file tree

 Hide file tree

Showing
**19 changed files**
with
**228 additions**
and
**214 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* installer

  + installer/MozillaVPN.wxs
    [MozillaVPN.wxs](#diff-321645c9c54e6db908570ade4200b7b1e0887479ddd82034a197dec67e1a1acb)
* ui/src

  + ui/src/Firefox Private Network.csproj
    [Firefox Private Network.csproj](#diff-9adb2ea57f505d75b000790509666a20e65b2252d4d1b54789b4f831a34ff7d0)
  + FxA

    - ui/src/FxA/Account.cs
      [Account.cs](#diff-25358a4ae6d047ade904b49a50ecfae0068b1eb79bbc410daf4fd40c4096068f)
    - ui/src/FxA/Devices.cs
      [Devices.cs](#diff-4f40d69aa957f94ec4d77ddf009100b9d2398a6389bf571b1e367cb96cd7ac33)
    - ui/src/FxA/Login.cs
      [Login.cs](#diff-c9840e3056985af196625b977f4cbed6b77832951604558783bd7ab761d694c1)
    - ui/src/FxA/LoginSessionManager.cs
      [LoginSessionManager.cs](#diff-e338d167a8b4dac53455e31ecfbda84b885e8ffc3884a5b059b2edd0158aff14)
    - ServerList

      * ui/src/FxA/ServerList/ServerList.cs
        [ServerList.cs](#diff-26f1bf89a1314ea90f529b653588f7eb0828d1aa80a1c20af01d74686c238902)
  + JSONStructures/Login

    - ui/src/JSONStructures/Login/FxALoginURLs.cs
      [FxALoginURLs.cs](#diff-595540118b198ae66a72f8e65be75e4cb7e05cdb6b0829727c974c837a8c5171)
  + ui/src/Main.cs
    [Main.cs](#diff-cdbcf4c234d2ab110a1cb1398e1a0a90245254d3a05325913bba32a1938fbd46)
  + ui/src/Manager.cs
    [Manager.cs](#diff-8f519b0af9f51df7e00dab3060c9df78c4345e52ca903c3d47627dcc27cb0e93)
  + ui/src/ProductConstants.cs
    [ProductConstants.cs](#diff-5d560c079b772e52a3f6acfd46c94ac8f3e2a410c41342de74346e551db07cd3)
  + UI

    - Components/Card/Hero

      * ui/src/UI/Components/Card/Hero/HeroSubtext.xaml
        [HeroSubtext.xaml](#diff-97e7d0087f0bfa88fdce3253e36964b77d0b855e0b7aadfc53ff1782531cb0c4)
    - Resources/Localization/Translations

      * ui/src/UI/Resources/Localization/Translations/en-us.ftl
        [en-us.ftl](#diff-e7ab2ebdc74aa7eeb26107c38693dce17b587245a5e3f4dec76cf786903d1127)
    - Views/Settings

      * ui/src/UI/Views/Settings/SettingsView.xaml
        [SettingsView.xaml](#diff-c3bd02f5174cbdd298793d7f6d12e3a273685cf341aad4ca2645dc4e35d6a084)
  + ViewModels

    - ui/src/ViewModels/MainWindowViewModel.cs
      [MainWindowViewModel.cs](#diff-523d96af54df3c9b09ed1a3459ff773372f48ac8f11d600da24fa37959a70b07)
  + WCF

    - ui/src/WCF/IService.cs
      [IService.cs](#diff-e0bebf9f2c79005690fe96be7b72880d70238ded38914901ce7502ee03e9e279)
    - ui/src/WCF/Service.cs
      [Service.cs](#diff-647dc515a6ebd711725e6df9cf5a0702c9c8244273e49d43f790813abee436c4)
  + ui/src/app.manifest
    [app.manifest](#diff-3d6686e495b25012f763fb24f91131d707a536bc8a0aee8f7c10066826031d34)
  + ui/src/packages.config
    [packages.config](#diff-adc4180317b68d309524df6f92c58c8259556077d7c5b8171711b426f62e3285)

## There are no files selected for viewing

14 changes: 13 additions & 1 deletion

14
[installer/MozillaVPN.wxs](#diff-321645c9c54e6db908570ade4200b7b1e0887479ddd82034a197dec67e1a1acb "installer/MozillaVPN.wxs")

Show comments

[View file](/mozilla-services/guardian-vpn-windows-deprecated/blob/ac6f562973a83f6758cd7ab7aa313e863047d41b/installer/MozillaVPN.wxs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -86,6 +86,18 @@ |
|  |  | <File Source="../ui/bin/$(var.Platform)/Release/Resources/Graphics/icon\_70x70.png" /> |
|  |  | <File Source="../ui/bin/$(var.Platform)/Release/Resources/Graphics/icon\_150x150.png" /> |
|  |  |  |
|  |  | <!-- Custom URL protocol for handling the PKCE auth flow --> |
|  |  | <RegistryKey Root="HKCR" Key="mozilla-vpn"> |
|  |  | <RegistryValue Type="string" Name="URL Protocol" Value="mozilla-vpn"/> |
|  |  | <RegistryValue Type="string" Value="URL:mozilla-vpn Protocol"/> |
|  |  | <RegistryKey Key="DefaultIcon"> |
|  |  | <RegistryValue Type="string" Value="MozillaVPN.exe" /> |
|  |  | </RegistryKey> |
|  |  | <RegistryKey Key="shell\open\command"> |
|  |  | <RegistryValue Type="string" Value="&quot;C:\Program Files\Mozilla\Mozilla VPN\MozillaVPN.exe&quot; &quot;%1&quot;" /> |
|  |  | </RegistryKey> |
|  |  | </RegistryKey> |
|  |  |  |
|  |  | <!-- Broker Service --> |
|  |  | <ServiceInstall |
|  |  | Type="ownProcess" |
| Expand All | | @@ -112,7 +124,7 @@ |
|  |  | </Component> |
|  |  | </ComponentGroup> |
|  |  |  |
|  |  | <!-- |
|  |  | <!-- |
|  |  | Merge modules |
|  |  | --> |
|  |  | <DirectoryRef Id="MozillaVPNFolder"> |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[ui/src/Firefox Private Network.csproj](#diff-9adb2ea57f505d75b000790509666a20e65b2252d4d1b54789b4f831a34ff7d0 "ui/src/Firefox Private Network.csproj")

Show comments

[View file](/mozilla-services/guardian-vpn-windows-deprecated/blob/ac6f562973a83f6758cd7ab7aa313e863047d41b/ui/src/Firefox%20Private%20Network.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -225,6 +225,12 @@ |
|  |  | <EmbedInteropTypes>False</EmbedInteropTypes> |
|  |  | <Private>True</Private> |
|  |  | </Reference> |
|  |  | <Reference Include="Microsoft.IdentityModel.Logging, Version=6.7.1.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL"> |
|  |  | <HintPath>..\packages\Microsoft.IdentityModel.Logging.6.7.1\lib\net461\Microsoft.IdentityModel.Logging.dll</HintPath> |
|  |  | </Reference> |
|  |  | <Reference Include="Microsoft.IdentityModel.Tokens, Version=6.7.1.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL"> |
|  |  | <HintPath>..\packages\Microsoft.IdentityModel.Tokens.6.7.1\lib\net461\Microsoft.IdentityModel.Tokens.dll</HintPath> |
|  |  | </Reference> |
|  |  | <Reference Include="Microsoft.WindowsAPICodePack, Version=1.1.0.0, Culture=neutral, processorArchitecture=MSIL"> |
|  |  | <HintPath>..\packages\Microsoft.WindowsAPICodePack-Core.1.1.0.2\lib\Microsoft.WindowsAPICodePack.dll</HintPath> |
|  |  | </Reference> |
| Expand Down | |  |

15 changes: 10 additions & 5 deletions

15
[ui/src/FxA/Account.cs](#diff-25358a4ae6d047ade904b49a50ecfae0068b1eb79bbc410daf4fd40c4096068f "ui/src/FxA/Account.cs")

Show comments

[View file](/mozilla-services/guardian-vpn-windows-deprecated/blob/ac6f562973a83f6758cd7ab7aa313e863047d41b/ui/src/FxA/Account.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,6 +50,11 @@ public Account() |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets the API version for making non-PKCE auth requests and handling responses. |
|  |  | /// </summary> |
|  |  | public static string OriginalApiVersion { get; set; } = "/api/v1"; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets the config structure associated with this account. |
|  |  | /// </summary> |
| Expand All | | @@ -73,7 +78,7 @@ public Account() |
|  |  | public bool ProcessLogin(string fxaJson) |
|  |  | { |
|  |  | // Initialize a new login session configuration |
|  |  | Manager.Account.Config = new FxA.Config(fxaJson); |
|  |  | Manager.Account.Config = new Config(fxaJson); |
|  |  |  |
|  |  | // Sets a value that a user has just logged in |
|  |  | Manager.MainWindowViewModel.NewUserSignIn = true; |
| Expand All | | @@ -87,14 +92,14 @@ public bool ProcessLogin(string fxaJson) |
|  |  | Manager.Account.Config.WriteFxAUserToFile(ProductConstants.FxAUserFile); |
|  |  |  |
|  |  | // Set the account login state to logged in |
|  |  | Manager.Account.LoginState = FxA.LoginState.LoggedIn; |
|  |  | Manager.Account.LoginState = LoginState.LoggedIn; |
|  |  |  |
|  |  | // Initialize cache for avatar image |
|  |  | Manager.Account.Avatar.InitializeCache(avatarUrl: Config.FxALogin.User.Avatar); |
|  |  |  |
|  |  | // Added a new account device through the FxA API, using the newly generated keypair |
|  |  | var devices = new FxA.Devices(); |
|  |  | var deviceName = string.Format("{0} ({1} {2})", System.Environment.MachineName, System.Environment.OSVersion.Platform, System.Environment.OSVersion.Version); |
|  |  | var devices = new Devices(); |
|  |  | var deviceName = string.Format("{0} ({1} {2})", Environment.MachineName, Environment.OSVersion.Platform, Environment.OSVersion.Version); |
|  |  | var deviceAddResponse = devices.AddDevice(deviceName, keys.Public); |
|  |  |  |
|  |  | // Upon successful addition of a new device, save the device interface to the WireGuard configuration file and IP addresses to settings file |
| Expand Down  Expand Up | | @@ -159,7 +164,7 @@ public void Logout(bool removeDevice = false) |
|  |  | /// <returns>FxA user JSON object.</returns> |
|  |  | public JSONStructures.User GetAccountDetails() |
|  |  | { |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, "/vpn/account", RestSharp.Method.GET); |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, $"{ProductConstants.BaseUrl}{OriginalApiVersion}/vpn/account", RestSharp.Method.GET); |
|  |  |  |
|  |  | // Execute the request |
|  |  | var response = api.SendRequest(); |
| Expand Down | |  |

5 changes: 3 additions & 2 deletions

5
[ui/src/FxA/Devices.cs](#diff-4f40d69aa957f94ec4d77ddf009100b9d2398a6389bf571b1e367cb96cd7ac33 "ui/src/FxA/Devices.cs")

Show comments

[View file](/mozilla-services/guardian-vpn-windows-deprecated/blob/ac6f562973a83f6758cd7ab7aa313e863047d41b/ui/src/FxA/Devices.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,6 +4,7 @@ |
|  |  |  |
|  |  | using System; |
|  |  | using System.Collections.Generic; |
|  |  | using System.IO; |
|  |  | using System.Threading.Tasks; |
|  |  | using Newtonsoft.Json; |
|  |  |  |
| Expand All | | @@ -22,7 +23,7 @@ internal class Devices |
|  |  | /// <returns>Returns the user's device if successful, otherwise null.</returns> |
|  |  | public JSONStructures.Device AddDevice(string deviceName, string publicKey) |
|  |  | { |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, "/vpn/device", RestSharp.Method.POST); |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, $"{ProductConstants.BaseUrl}{Account.OriginalApiVersion}/vpn/device", RestSharp.Method.POST); |
|  |  | api.AddPostBody(new Dictionary<string, string> { { "name", deviceName }, { "pubkey", publicKey } }); |
|  |  |  |
|  |  | // Execute the request |
| Expand Down  Expand Up | | @@ -71,7 +72,7 @@ public bool RemoveDevice(string publicKey, bool safeRemove = false, bool silent |
|  |  |  |
|  |  | // Url encoding the device public key |
|  |  | var sanitizedDevicePublicKey = System.Web.HttpUtility.UrlEncode(publicKey); |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, "/vpn/device/" + sanitizedDevicePublicKey, RestSharp.Method.DELETE); |
|  |  | var api = new ApiRequest(Manager.Account.Config.FxALogin.Token, $"{ProductConstants.BaseUrl}{Account.OriginalApiVersion}/vpn/device/" + sanitizedDevicePublicKey, RestSharp.Method.DELETE); |
|  |  |  |
|  |  | // Execute the request` |
|  |  | var response = api.SendRequest(); |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 1 comment on commit `ac6f562`

[![@firefoxci-taskcluster](https://avatars.githubusercontent.com/in/44394?s=80&v=4)](/apps/firefoxci-taskcluster)

Copy link

### @firefoxci-taskcluster **[firefoxci-taskcluster](/apps/firefoxci-taskcluster) bot** commented on `[ac6f562](/mozilla-services/guardian-vpn-windows-deprecated/commit/ac6f562973a83f6758cd7ab7aa313e863047d41b)` [Nov 4, 2020](#commitcomment-43880204)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Uh oh! Looks like an error! Details

Taskcluster-GitHub attempted to create a task for this event with the following scopes:

```
[
  "assume:repo:github.com/mozilla-services/guardian-vpn-windows:tag:v1.2",
  "queue:route:checks",
  "queue:scheduler-id:taskcluster-github"
]

```

The expansion of these scopes is not sufficient to create the task, leading to the following:

Client ID static/taskcluster/github does not have sufficient scopes and is missing the following scopes:

```
{
  "AllOf": [
    "assume:repo:github.com/mozilla-services/guardian-vpn-windows:branch:v1.2",
    "queue:scheduler-id:mpd001-level-3",
    {
      "AnyOf": [
        "queue:create-task:highest:mpd001-3/decision",
        "queue:create-task:very-high:mpd001-3/decision",
        "queue:create-task:high:mpd001-3/decision",
        "queue:create-task:medium:mpd001-3/decision",
        "queue:create-task:low:mpd001-3/decision",
        "queue:create-task:very-low:mpd001-3/decision",
        "queue:create-task:lowest:mpd001-3/decision"
      ]
    }
  ]
}

```

This request requires the client to satisfy the following scope expression:

```
{
  "AllOf": [
    "assume:repo:github.com/mozilla-services/guardian-vpn-windows:branch:v1.2",
    "queue:route:checks",
    "queue:scheduler-id:mpd001-level-3",
    {
      "AnyOf": [
        "queue:create-task:highest:mpd001-3/decision",
        "queue:create-task:very-high:mpd001-3/decision",
        "queue:create-task:high:mpd001-3/decision",
        "queue:create-task:medium:mpd001-3/decision",
        "queue:create-task:low:mpd001-3/decision",
        "queue:create-task:very-low:mpd001-3/decision",
        "queue:create-task:lowest:mpd001-3/decision"
      ]
    }
  ]
}

```

---

* method: createTask
* errorCode: InsufficientScopes
* statusCode: 403
* time: 2020-11-04T20:00:32.169Z

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-services%2Fguardian-vpn-windows-deprecated%2Fcommit%2Fac6f562973a83f6758cd7ab7aa313e863047d41b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.mozilla.org_58c8d310_20250119_120212.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2020-48

## OAuth session fixation vulnerability in Mozilla VPN

Announced
November 4, 2020
Impact
moderate
Products
Mozilla VPN Android 1.1.0, Mozilla VPN Windows, Mozilla VPN iOS 1.0.7
Fixed in

* Mozilla VPN Android 1.1.0 (1360)
* Mozilla VPN iOS 1.0.7 (929)
* Mozilla VPN Windows 1.2.2

*An OAuth session fixation vulnerability existed in the VPN login flow. This issue was mitigated server-side and this additional fix is aimed at eliminating residual risk for Windows, Android, and iOS clients.*

#### [#CVE-2020-15679: OAuth Session Fixation on VPN login](#CVE-2020-15679)

Reporter
Cure53
Impact
moderate
##### Description

An OAuth session fixation vulnerability existed in the VPN login flow, where an attacker could craft a custom login URL, convince a VPN user to login via that URL, and obtain authenticated access as that user. This issue is limited to cases where attacker and victim are sharing the same source IP and could allow the ability to view session states and disconnect VPN sessions.

##### References

* [Windows commit](https://github.com/mozilla-services/guardian-vpn-windows/commit/ac6f562973a83f6758cd7ab7aa313e863047d41b)
* [Android commit](https://github.com/mozilla-mobile/guardian-vpn-android/commit/981c840276ef3aee98cf5d42993d484ee99b28d9)
* [iOS commit](https://github.com/mozilla-mobile/guardian-vpn-ios/commit/4309f5c9bd2c15cdfd39ac173665fad3f2598b54)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from github.com_08b6ad82_20250119_120206.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-android%2Fcommit%2F981c840276ef3aee98cf5d42993d484ee99b28d9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-android%2Fcommit%2F981c840276ef3aee98cf5d42993d484ee99b28d9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mozilla-mobile%2Fguardian-vpn-android)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Mar 9, 2022. It is now read-only.

[mozilla-mobile](/mozilla-mobile)
/
**[guardian-vpn-android](/mozilla-mobile/guardian-vpn-android)**
Public archive

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-android) You must be signed in to change notification settings
* [Fork
  21](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-android)
* [Star
   53](/login?return_to=%2Fmozilla-mobile%2Fguardian-vpn-android)

* [Code](/mozilla-mobile/guardian-vpn-android)
* [Issues
  0](/mozilla-mobile/guardian-vpn-android/issues)
* [Pull requests
  0](/mozilla-mobile/guardian-vpn-android/pulls)
* [Actions](/mozilla-mobile/guardian-vpn-android/actions)
* [Projects
  0](/mozilla-mobile/guardian-vpn-android/projects)
* [Security](/mozilla-mobile/guardian-vpn-android/security)
* [Insights](/mozilla-mobile/guardian-vpn-android/pulse)

Additional navigation options

* [Code](/mozilla-mobile/guardian-vpn-android)
* [Issues](/mozilla-mobile/guardian-vpn-android/issues)
* [Pull requests](/mozilla-mobile/guardian-vpn-android/pulls)
* [Actions](/mozilla-mobile/guardian-vpn-android/actions)
* [Projects](/mozilla-mobile/guardian-vpn-android/projects)
* [Security](/mozilla-mobile/guardian-vpn-android/security)
* [Insights](/mozilla-mobile/guardian-vpn-android/pulse)

## Commit

[Permalink](/mozilla-mobile/guardian-vpn-android/commit/981c840276ef3aee98cf5d42993d484ee99b28d9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

New non-polling authentication flow.

[Browse files](/mozilla-mobile/guardian-vpn-android/tree/981c840276ef3aee98cf5d42993d484ee99b28d9)
Browse the repository at this point in the history

```
- Fixes intermittent hanging during auth
- Implements PKCE
```

* Loading branch information

[![@severinrudie](https://avatars.githubusercontent.com/u/13170306?s=40&v=4)](/severinrudie)

[severinrudie](/mozilla-mobile/guardian-vpn-android/commits?author=severinrudie "View all commits by severinrudie")
authored and
Kami
committed
Oct 6, 2020

1 parent
[40c281d](/mozilla-mobile/guardian-vpn-android/commit/40c281dd1c0a8176d10a7ca839a2a31475b16c2a)

commit 981c840

 Show file tree

 Hide file tree

Showing
**39 changed files**
with
**985 additions**
and
**518 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + app/build.gradle
    [build.gradle](#diff-51a0b488f963eb0be6c6599bf5df497313877cf5bdff3950807373912ac1cdc9)
  + src

    - androidTest/java/org/mozilla/firefox/vpn

      * app/src/androidTest/java/org/mozilla/firefox/vpn/PkceRegressionTest.kt
        [PkceRegressionTest.kt](#diff-49d232501e2ceb27f4c540ee1a52f09b6e6189328123af3193ccef3e51c502b9)
    - main

      * app/src/main/AndroidManifest.xml
        [AndroidManifest.xml](#diff-7fa6aef292187a049f7a4d6060d8df3ba212d838789c78940bd363344b1c38cd)
      * java/org/mozilla/firefox/vpn

        + app/src/main/java/org/mozilla/firefox/vpn/GuardianApp.kt
          [GuardianApp.kt](#diff-c8caa9e86e57fd6a027ba14705c5770b381210ee30abf9eb8b09248a802948ba)
        + app/src/main/java/org/mozilla/firefox/vpn/GuardianComponent.kt
          [GuardianComponent.kt](#diff-c08158fedb04375bd5c87544904cc8c3c2bbf10fd81accd25be5aa3fdbdb7915)
        + app/src/main/java/org/mozilla/firefox/vpn/IntentReceiverActivity.kt
          [IntentReceiverActivity.kt](#diff-48ed4a995f1162069e5d9afc4f3c03dbb6899ca54474f7236f9e8f3e2cdd9e5c)
        + app/src/main/java/org/mozilla/firefox/vpn/MockedGuardianComponent.kt
          [MockedGuardianComponent.kt](#diff-7da38387b14511265d3a127e5d0b829362848957b6df39d8b27256ee643deebe)
        + crypto

          - app/src/main/java/org/mozilla/firefox/vpn/crypto/AuthCodeHelper.kt
            [AuthCodeHelper.kt](#diff-63e0f2d5ad90a557c79c159d6ca6c1925d696deeb81cfafc25bce178d8ad6af1)
        + ext

          - app/src/main/java/org/mozilla/firefox/vpn/ext/LiveEvent.kt
            [LiveEvent.kt](#diff-06f054a1e109d9f314c832549ce48843c16fea60785bde76465f146482aa0076)
          - app/src/main/java/org/mozilla/firefox/vpn/ext/Uri.kt
            [Uri.kt](#diff-9a659542518af7b35d918474889d5d44bad1e8c9580ca38ae8f323a9d41b8494)
        + main/settings/domain

          - app/src/main/java/org/mozilla/firefox/vpn/main/settings/domain/SignOutUseCase.kt
            [SignOutUseCase.kt](#diff-36f2efee08df3c768c2883000591eacc68fb56a3dbb588c5bb4d76b10bac3910)
        + onboarding

          - app/src/main/java/org/mozilla/firefox/vpn/onboarding/OnboardingActivity.kt
            [OnboardingActivity.kt](#diff-0d011b9a12f1e0cd46e5272236cfd526e92de573fa8ea5415372a5fde7479882)
          - app/src/main/java/org/mozilla/firefox/vpn/onboarding/OnboardingComponent.kt
            [OnboardingComponent.kt](#diff-568cd46b9d1c1158bf0a84c43d58a076ebb807676b51963bb951c70c79b1ec28)
          - app/src/main/java/org/mozilla/firefox/vpn/onboarding/OnboardingViewModel.kt
            [OnboardingViewModel.kt](#diff-fc3842b744612f1d9c8968a1ac23e158e836189eb62ba4539a8d8fa1ebff5f2b)
          - domain

            * app/src/main/java/org/mozilla/firefox/vpn/onboarding/domain/ClearPendingLoginInfoUseCase.kt
              [ClearPendingLoginInfoUseCase.kt](#diff-726b671719dafe80fd355f146704cb67de4f8e896c192265ac8ad0e4ac00b842)
            * app/src/main/java/org/mozilla/firefox/vpn/onboarding/domain/GetPendingLoginInfoUseCase.kt
              [GetPendingLoginInfoUseCase.kt](#diff-c45b4212ea668a9651d1cf7b8a3efaa8fab1389810f5a40f74b8357c9b8a0e02)
            * app/src/main/java/org/mozilla/firefox/vpn/onboarding/domain/SetPendingLoginInfoUseCase.kt
              [SetPendingLoginInfoUseCase.kt](#diff-48bde5ba55bc1f7a25323f12d84cccbee4083c38562e2a18df9267d4d582973e)
        + report

          - app/src/main/java/org/mozilla/firefox/vpn/report/Report.kt
            [Report.kt](#diff-33519fed0e468f78cbc63649866d74748f81935e20e9c1781193e6cf6f1f30e3)
        + service

          - app/src/main/java/org/mozilla/firefox/vpn/service/GuardianService.kt
            [GuardianService.kt](#diff-e26ceab8be17af93eda95ce77754bc746a6e5a2c77f5ca6c8e9e1b949b1029c3)
          - app/src/main/java/org/mozilla/firefox/vpn/service/MockGuardianService.kt
            [MockGuardianService.kt](#diff-dfb978dd0f1a35d5795f51c93c04bce50ae6181d38925e5fd626888140900d71)
        + user

          - data

            * app/src/main/java/org/mozilla/firefox/vpn/user/data/ReferralManager.kt
              [ReferralManager.kt](#diff-5dbbb7accff83a25ac024538c57a7f8ec0d4a32755e9a72e014e1d1c50ea7386)
            * app/src/main/java/org/mozilla/firefox/vpn/user/data/SessionManager.kt
              [SessionManager.kt](#diff-822e6303521e43d5530690dec15808f5f598c4b255a4bb32027123aa6f9122c9)
            * app/src/main/java/org/mozilla/firefox/vpn/user/data/UserRepository.kt
              [UserRepository.kt](#diff-78973c48470a914fa33e05f494ac02a2ad749e941e0a646f53347a1a3cc8812e)
          - domain

            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/CreateUserUseCase.kt
              [CreateUserUseCase.kt](#diff-134aa67f83f2a142d60de69cb962893504b921f05f54490ef38fc02a07a6a56b)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/GetAuthCodeUseCase.kt
              [GetAuthCodeUseCase.kt](#diff-eb72ae7b43c7d802f314a98028c7bc9f130edeb29a206031f60621f36a4f35b3)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/GetLoginInfoUseCase.kt
              [GetLoginInfoUseCase.kt](#diff-33e485917d70f8df2744d3dd8be12a524b8b0987e0d949019a199790ecefc117)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/GetTokenUseCase.kt
              [GetTokenUseCase.kt](#diff-9da2a5d31bf37dd9bded7882f09c6dcf00c894170aa686c362c82db5021f2ffd)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/LogoutUseCase.kt
              [LogoutUseCase.kt](#diff-7c2a9533ad09577f07572e4496da4521d647f35ce9f16192aa43b4ecd7e43b0a)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/SaveAuthTokenUseCase.kt
              [SaveAuthTokenUseCase.kt](#diff-8299542372acd878e504062a6acca51ce48101c10f555f6496d2fca6863c56db)
            * app/src/main/java/org/mozilla/firefox/vpn/user/domain/VerifyLoginUseCase.kt
              [VerifyLoginUseCase.kt](#diff-1d95e073c30edb19ddd10bb98f5542a0700e53c4d6aff0cdec5fdbd80d68d344)
        + util

          - app/src/main/java/org/mozilla/firefox/vpn/util/CustomTabUtil.kt
            [CustomTabUtil.kt](#diff-639c697686fa2d609c612d9544144121de3ec4a558e7d56a75e18a32ac6e9df1)
          - app/src/main/java/org/mozilla/firefox/vpn/util/ResourceUtil.kt
            [ResourceUtil.kt](#diff-40865734747dd63c1e9f2a2144cc382f88b7e88d18b2bd796b03a35d282d45d5)
          - app/src/main/java/org/mozilla/firefox/vpn/util/Result.kt
            [Result.kt](#diff-9549547688b0b906662acb15d20609c9dc08f94dee7a788b3db0749da309e41b)
    - test/java/org/mozilla/firefox/vpn

      * app/src/test/java/org/mozilla/firefox/vpn/IntentReceiverActivityTest.kt
        [IntentReceiverActivityTest.kt](#diff-822d52d38623da7d8acc7bba0884fcee183376b67044b70fa9dbdbaab031aea6)
      * app/src/test/java/org/mozilla/firefox/vpn/TestConstants.kt
        [TestConstants.kt](#diff-0d2aae3c3533fbb220cf5915f213af16b93d3874861841321d621740cdbfaf51)
      * app/src/test/java/org/mozilla/firefox/vpn/TestGuardianApp.kt
        [TestGuardianApp.kt](#diff-6e57536e12c1e7b5afe319c4cb22b1d946f63900ce824eb46173bb2f276acd39)
      * crypto

        + app/src/test/java/org/mozilla/firefox/vpn/crypto/AuthCodeHelperTest.kt
          [AuthCodeHelperTest.kt](#diff-93efbaa6ec2a35aa60d73590cce083ac1743ef6a80f0903676f972f8e0b73de5)
      * servers/domain

        + app/src/test/java/org/mozilla/firefox/vpn/servers/domain/SetSelectedServerUseCaseTest.kt
          [SetSelectedServerUseCaseTest.kt](#diff-71180daace08db17113a350071852270af79596e9f309d718fbed4fdd40bcc6b)
      * service

        + app/src/test/java/org/mozilla/firefox/vpn/service/LoginQueryBuilderTest.kt
          [LoginQueryBuilderTest.kt](#diff-cfbe119352f669b0aa4794184213e1f8d29ca12e5be26af6684002539e650618)

## There are no files selected for viewing

13 changes: 12 additions & 1 deletion

13
[app/build.gradle](#diff-51a0b488f963eb0be6c6599bf5df497313877cf5bdff3950807373912ac1cdc9 "app/build.gradle")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/build.gradle)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -64,6 +64,12 @@ android { |
|  |  | viewBinding { |
|  |  | enabled = true |
|  |  | } |
|  |  |  |
|  |  | testOptions { |
|  |  | unitTests { |
|  |  | includeAndroidResources = true |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | configurations { |
| Expand Down  Expand Up | | @@ -102,13 +108,18 @@ dependencies { |
|  |  | ktlint 'com.pinterest:ktlint:0.35.0' |
|  |  |  |
|  |  | testImplementation 'junit:junit:4.12' |
|  |  | testImplementation 'org.robolectric:robolectric:3.4.2' |
|  |  | testImplementation 'org.robolectric:robolectric:4.4' |
|  |  | testImplementation 'androidx.test:core:1.3.0' |
|  |  | testImplementation 'androidx.test.ext:junit:1.1.1' |
|  |  |  |
|  |  | testImplementation 'androidx.arch.core:core-testing:2.1.0' |
|  |  | testImplementation 'com.google.truth:truth:1.0.1' |
|  |  | testImplementation 'io.mockk:mockk:1.9' |
|  |  | testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-test:1.3.7' |
|  |  | androidTestImplementation 'androidx.test:runner:1.2.0' |
|  |  | androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0' |
|  |  | androidTestImplementation 'androidx.test.espresso:espresso-intents:3.2.0' |
|  |  | androidTestImplementation "androidx.test.uiautomator:uiautomator:2.2.0" |
|  |  | androidTestImplementation 'androidx.test.ext:junit:1.1.1' |
|  |  | } |
|  |  |  |
| Expand Down | |  |

78 changes: 78 additions & 0 deletions

78
[app/src/androidTest/java/org/mozilla/firefox/vpn/PkceRegressionTest.kt](#diff-49d232501e2ceb27f4c540ee1a52f09b6e6189328123af3193ccef3e51c502b9 "app/src/androidTest/java/org/mozilla/firefox/vpn/PkceRegressionTest.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/androidTest/java/org/mozilla/firefox/vpn/PkceRegressionTest.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,78 @@ |
|  |  | /\* This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | \* License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | \* file, You can obtain one at https://mozilla.org/MPL/2.0/. \*/ |
|  |  |  |
|  |  | package org.mozilla.firefox.vpn |
|  |  |  |
|  |  | import android.content.Intent |
|  |  | import android.net.Uri |
|  |  | import androidx.test.espresso.Espresso.onView |
|  |  | import androidx.test.espresso.assertion.ViewAssertions.matches |
|  |  | import androidx.test.espresso.matcher.ViewMatchers.isDisplayed |
|  |  | import androidx.test.espresso.matcher.ViewMatchers.withId |
|  |  | import androidx.test.ext.junit.runners.AndroidJUnit4 |
|  |  | import androidx.test.filters.FlakyTest |
|  |  | import androidx.test.filters.LargeTest |
|  |  | import androidx.test.rule.ActivityTestRule |
|  |  | import kotlinx.coroutines.CompletableDeferred |
|  |  | import kotlinx.coroutines.delay |
|  |  | import kotlinx.coroutines.runBlocking |
|  |  | import kotlinx.coroutines.withTimeout |
|  |  | import org.junit.Assert.assertNotNull |
|  |  | import org.junit.Rule |
|  |  | import org.junit.Test |
|  |  | import org.junit.runner.RunWith |
|  |  | import org.mozilla.firefox.vpn.splash.SplashActivity |
|  |  |  |
|  |  | @LargeTest |
|  |  | @RunWith(AndroidJUnit4::class) |
|  |  | class PkceRegressionTest { |
|  |  |  |
|  |  | @Rule |
|  |  | @JvmField |
|  |  | val splashActivityTestRule = ActivityTestRule(SplashActivity::class.java) |
|  |  |  |
|  |  | @Rule |
|  |  | @JvmField |
|  |  | val intentReceiverActivityTestRule = ActivityTestRule(IntentReceiverActivity::class.java) |
|  |  |  |
|  |  | @Test |
|  |  | @FlakyTest |
|  |  | /\*\* |
|  |  | \* Flaky for two reasons. 1) this needs to touch the network, 2) Espresso tests are just flaky. |
|  |  | \*/ |
|  |  | fun pkce\_regression\_test() { |
|  |  | // Simulate response from user logging in at: |
|  |  | // "https://stage-vpn.guardian.nonprod.cloudops.mozgcp.net/api/v2/vpn/login/android?code\_challenge=fx-O4\_N\_sfGrXxLgDkByfVNgZUPCI1s5PqWp8k1fG8M=&code\_challenge\_method=S256" |
|  |  | val authCode = "d60b4de6f4a8a6e2228e82b328729d9cc1666b96a1f7a5202fdc563c925bb7a3ea3f4efa1ef3c37d" |
|  |  | val intentUri = Uri.parse( |
|  |  | "https://stage-vpn.guardian.nonprod.cloudops.mozgcp.net" + |
|  |  | "/vpn/client/login/success?" + |
|  |  | "code=$authCode" + |
|  |  | "#Intent;category=android.intent.category.BROWSABLE;" + |
|  |  | "launchFlags=0x14000000;" + |
|  |  | "component=org.mozilla.firefox.vpn.debug/org.mozilla.firefox.vpn.IntentReceiverActivity;" + |
|  |  | "i.org.chromium.chrome.browser.referrer\_id=18;" + |
|  |  | "S.com.android.browser.application\_id=com.android.chrome;end" |
|  |  | ) |
|  |  | val intent = Intent("android.intent.action.VIEW", intentUri) |
|  |  |  |
|  |  | val receivedCode = CompletableDeferred<AuthCode>() |
|  |  | IntentReceiverActivity.setAuthCodeReceivedDeferred(receivedCode) |
|  |  |  |
|  |  | // IntentReceiverActivity launched with the above auth code |
|  |  | intentReceiverActivityTestRule.launchActivity(intent) |
|  |  |  |
|  |  | // assert an auth code was received |
|  |  | runBlocking { |
|  |  | withTimeout(5\_000) { |
|  |  | assertNotNull(receivedCode.await()) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | runBlocking { delay(1\_000) } |
|  |  |  |
|  |  | // assert onboarding screen still shown, login did not proceed |
|  |  | onView(withId(R.id.auth\_btn)).check(matches(isDisplayed())) |
|  |  | } |
|  |  | } |

14 changes: 14 additions & 0 deletions

14
[app/src/main/AndroidManifest.xml](#diff-7fa6aef292187a049f7a4d6060d8df3ba212d838789c78940bd363344b1c38cd "app/src/main/AndroidManifest.xml")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/AndroidManifest.xml)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,6 +50,20 @@ |
|  |  | android:screenOrientation="portrait" |
|  |  | tools:ignore="LockedOrientationActivity" /> |
|  |  |  |
|  |  | <activity android:name="org.mozilla.firefox.vpn.IntentReceiverActivity" |
|  |  | android:screenOrientation="portrait" |
|  |  | tools:ignore="LockedOrientationActivity"> |
|  |  | <intent-filter> |
|  |  | <action android:name="android.intent.action.VIEW" /> |
|  |  | <category android:name="android.intent.category.DEFAULT" /> |
|  |  | <category android:name="android.intent.category.BROWSABLE" /> |
|  |  | <data |
|  |  | android:scheme="mozilla-vpn" |
|  |  | android:host="login" |
|  |  | android:path="/success" /> |
|  |  | </intent-filter> |
|  |  | </activity> |
|  |  |  |
|  |  | <service |
|  |  | android:name="org.mozilla.firefox.vpn.main.vpn.GuardianVpnService" |
|  |  | android:permission="android.permission.BIND\_VPN\_SERVICE"> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/src/main/java/org/mozilla/firefox/vpn/GuardianApp.kt](#diff-c8caa9e86e57fd6a027ba14705c5770b381210ee30abf9eb8b09248a802948ba "app/src/main/java/org/mozilla/firefox/vpn/GuardianApp.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/GuardianApp.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,7 +8,7 @@ import org.mozilla.firefox.vpn.report.ReportUtil |
|  |  | import org.mozilla.firefox.vpn.service.MockGuardianService |
|  |  | import org.mozilla.firefox.vpn.util.NotificationUtil |
|  |  |  |
|  |  | class GuardianApp : Application() { |
|  |  | open class GuardianApp : Application() { |
|  |  |  |
|  |  | val coreComponent: CoreComponent by lazy { |
|  |  | CoreComponentImpl(this) |
| Expand Down | |  |

5 changes: 1 addition & 4 deletions

5
[app/src/main/java/org/mozilla/firefox/vpn/GuardianComponent.kt](#diff-c08158fedb04375bd5c87544904cc8c3c2bbf10fd81accd25be5aa3fdbdb7915 "app/src/main/java/org/mozilla/firefox/vpn/GuardianComponent.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/GuardianComponent.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,6 @@ import org.mozilla.firefox.vpn.servers.domain.SelectedServerProvider |
|  |  | import org.mozilla.firefox.vpn.service.GuardianService |
|  |  | import org.mozilla.firefox.vpn.service.newInstance |
|  |  | import org.mozilla.firefox.vpn.update.UpdateManager |
|  |  | import org.mozilla.firefox.vpn.user.data.ReferralManager |
|  |  | import org.mozilla.firefox.vpn.user.data.SessionManager |
|  |  | import org.mozilla.firefox.vpn.user.data.UserRepository |
|  |  |  |
| Expand All | | @@ -33,12 +32,10 @@ class GuardianComponentImpl( |
|  |  |  |
|  |  | private val sessionManager = SessionManager(prefs) |
|  |  |  |
|  |  | private val referralManager = ReferralManager(coreComponent.app.applicationContext, prefs) |
|  |  |  |
|  |  | var service = GuardianService.newInstance(sessionManager) |
|  |  |  |
|  |  | override val userRepo: UserRepository by lazy { |
|  |  | UserRepository(service, sessionManager, referralManager) |
|  |  | UserRepository(service, sessionManager) |
|  |  | } |
|  |  |  |
|  |  | override val deviceRepo: DeviceRepository by lazy { |
| Expand Down | |  |

49 changes: 49 additions & 0 deletions

49
[app/src/main/java/org/mozilla/firefox/vpn/IntentReceiverActivity.kt](#diff-48ed4a995f1162069e5d9afc4f3c03dbb6899ca54474f7236f9e8f3e2cdd9e5c "app/src/main/java/org/mozilla/firefox/vpn/IntentReceiverActivity.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/IntentReceiverActivity.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,49 @@ |
|  |  | /\* This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | \* License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | \* file, You can obtain one at http://mozilla.org/MPL/2.0/. \*/ |
|  |  |  |
|  |  | package org.mozilla.firefox.vpn |
|  |  |  |
|  |  | import android.content.Intent |
|  |  | import android.os.Bundle |
|  |  | import androidx.appcompat.app.AppCompatActivity |
|  |  | import kotlinx.coroutines.CompletableDeferred |
|  |  | import org.mozilla.firefox.vpn.ext.toCode |
|  |  | import org.mozilla.firefox.vpn.user.domain.AuthToken |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Code that is included in the `verify` request that is used to retrieve an [AuthToken]. |
|  |  | \*/ |
|  |  | typealias AuthCode = String |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Abstraction that handles incoming [Intent]s for use elsewhere in the app. After |
|  |  | \* processing an [Intent], this activity will finish itself. |
|  |  | \*/ |
|  |  | open class IntentReceiverActivity : AppCompatActivity() { |
|  |  |  |
|  |  | companion object { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Set a [CompletableDeferred] that will be completed with an [AuthCode] the next |
|  |  | \* time one is received. Note that this is not guaranteed to ever complete. |
|  |  | \* |
|  |  | \* This is static because the alternative was a similarly bad practice: weaving |
|  |  | \* the reference through many layers of Android framework code. |
|  |  | \*/ |
|  |  | fun setAuthCodeReceivedDeferred(authCodeReceived: CompletableDeferred<AuthCode>) { |
|  |  | \_authCodeReceived = authCodeReceived |
|  |  | } |
|  |  | private var \_authCodeReceived: CompletableDeferred<AuthCode> = CompletableDeferred() |
|  |  | } |
|  |  |  |
|  |  | override fun onCreate(savedInstanceState: Bundle?) { |
|  |  | super.onCreate(savedInstanceState) |
|  |  |  |
|  |  | intent?.data?.toCode()?.let { authCode -> |
|  |  | \_authCodeReceived.complete(authCode) |
|  |  | } |
|  |  |  |
|  |  | finish() |
|  |  | } |
|  |  | } |

5 changes: 1 addition & 4 deletions

5
[app/src/main/java/org/mozilla/firefox/vpn/MockedGuardianComponent.kt](#diff-7da38387b14511265d3a127e5d0b829362848957b6df39d8b27256ee643deebe "app/src/main/java/org/mozilla/firefox/vpn/MockedGuardianComponent.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/MockedGuardianComponent.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,7 +10,6 @@ import org.mozilla.firefox.vpn.servers.data.ServerRepository |
|  |  | import org.mozilla.firefox.vpn.servers.domain.SelectedServerProvider |
|  |  | import org.mozilla.firefox.vpn.service.MockGuardianService |
|  |  | import org.mozilla.firefox.vpn.update.UpdateManager |
|  |  | import org.mozilla.firefox.vpn.user.data.ReferralManager |
|  |  | import org.mozilla.firefox.vpn.user.data.SessionManager |
|  |  | import org.mozilla.firefox.vpn.user.data.UserRepository |
|  |  |  |
| Expand All | | @@ -20,12 +19,10 @@ class MockedGuardianComponent( |
|  |  |  |
|  |  | private val sessionManager = SessionManager(prefs) |
|  |  |  |
|  |  | private val referralManager = ReferralManager(coreComponent.app.applicationContext, prefs) |
|  |  |  |
|  |  | var service = MockGuardianService() |
|  |  |  |
|  |  | override val userRepo: UserRepository by lazy { |
|  |  | UserRepository(service, sessionManager, referralManager) |
|  |  | UserRepository(service, sessionManager) |
|  |  | } |
|  |  |  |
|  |  | override val deviceRepo: DeviceRepository by lazy { |
| Expand Down | |  |

57 changes: 57 additions & 0 deletions

57
[app/src/main/java/org/mozilla/firefox/vpn/crypto/AuthCodeHelper.kt](#diff-63e0f2d5ad90a557c79c159d6ca6c1925d696deeb81cfafc25bce178d8ad6af1 "app/src/main/java/org/mozilla/firefox/vpn/crypto/AuthCodeHelper.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/crypto/AuthCodeHelper.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,57 @@ |
|  |  | /\* This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | \* License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | \* file, You can obtain one at http://mozilla.org/MPL/2.0/. \*/ |
|  |  |  |
|  |  | package org.mozilla.firefox.vpn.crypto |
|  |  |  |
|  |  | import android.util.Base64 |
|  |  | import java.security.MessageDigest |
|  |  | import java.security.SecureRandom |
|  |  | import kotlin.random.Random |
|  |  | import kotlin.random.asKotlinRandom |
|  |  |  |
|  |  | /\*\* |
|  |  | \* PKCE code verifier. |
|  |  | \*/ |
|  |  | typealias CodeVerifier = String |
|  |  | /\*\* |
|  |  | \* PKCE code challenge. |
|  |  | \*/ |
|  |  | typealias CodeChallenge = String |
|  |  |  |
|  |  | private const val CHALLENGE\_FLAGS = Base64.URL\_SAFE or Base64.NO\_WRAP |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Contains utility functions for generating secure codes. |
|  |  | \*/ |
|  |  | object AuthCodeHelper { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns a cryptographically random key. Sent during token request as part of PKCE. |
|  |  | \*/ |
|  |  | fun generateCodeVerifier(random: Random = SecureRandom().asKotlinRandom()): CodeVerifier { |
|  |  | val allowedChars = ('A'..'Z') + ('a'..'z') + ('0'..'9') + listOf('-', '\_', '.', '~') |
|  |  |  |
|  |  | val size = (43..128).random(random) |
|  |  |  |
|  |  | val sb = StringBuilder() |
|  |  | for (i in 1..size) { |
|  |  | sb.append(allowedChars.random(random)) |
|  |  | } |
|  |  | return sb.toString() |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns a SHA-256 encoded hash based on [verifier]. Used to retrieve a token as |
|  |  | \* part of PKCE. |
|  |  | \*/ |
|  |  | @Synchronized // MessageDigest is not thread-safe |
|  |  | fun generateCodeChallenge(verifier: CodeVerifier): CodeChallenge { |
|  |  | val bytes = verifier.toByteArray(Charsets.US\_ASCII) |
|  |  | val messageDigest = MessageDigest.getInstance("SHA-256") |
|  |  | messageDigest.update(bytes, 0, bytes.size) |
|  |  | val digest = messageDigest.digest() |
|  |  |  |
|  |  | return Base64.encodeToString(digest, CHALLENGE\_FLAGS) |
|  |  | } |
|  |  | } |

47 changes: 47 additions & 0 deletions

47
[app/src/main/java/org/mozilla/firefox/vpn/ext/LiveEvent.kt](#diff-06f054a1e109d9f314c832549ce48843c16fea60785bde76465f146482aa0076 "app/src/main/java/org/mozilla/firefox/vpn/ext/LiveEvent.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/ext/LiveEvent.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,47 @@ |
|  |  | /\* This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | \* License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | \* file, You can obtain one at http://mozilla.org/MPL/2.0/. \*/ |
|  |  |  |
|  |  | package org.mozilla.firefox.vpn.ext |
|  |  |  |
|  |  | import com.hadilq.liveevent.LiveEvent |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Adds an event on to the [LiveEvent]. This makes usage more idiomatic by letting |
|  |  | \* [LiveEvent]s be called as functions. |
|  |  | \* |
|  |  | \* EXAMPLE |
|  |  | \* |
|  |  | \* With this extension: |
|  |  | \* ``` |
|  |  | \* promptLogin(info.loginUrl) |
|  |  | \* ``` |
|  |  | \* |
|  |  | \* Without this extension: |
|  |  | \* ``` |
|  |  | \* promptLogin.value = info.loginUrl |
|  |  | \* ``` |
|  |  | \*/ |
|  |  | operator fun <T> LiveEvent<T>.invoke(value: T) { |
|  |  | this.value = value |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Adds an event on to the [LiveEvent]. This makes usage more idiomatic by letting |
|  |  | \* [LiveEvent]s be called as functions. |
|  |  | \* |
|  |  | \* EXAMPLE |
|  |  | \* |
|  |  | \* With this extension: |
|  |  | \* ``` |
|  |  | \* promptLogin() |
|  |  | \* ``` |
|  |  | \* |
|  |  | \* Without this extension: |
|  |  | \* ``` |
|  |  | \* promptLogin.value = Unit |
|  |  | \* ``` |
|  |  | \*/ |
|  |  | operator fun LiveEvent<Unit>.invoke() { |
|  |  | this.value = Unit |
|  |  | } |

26 changes: 26 additions & 0 deletions

26
[app/src/main/java/org/mozilla/firefox/vpn/ext/Uri.kt](#diff-9a659542518af7b35d918474889d5d44bad1e8c9580ca38ae8f323a9d41b8494 "app/src/main/java/org/mozilla/firefox/vpn/ext/Uri.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/ext/Uri.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,26 @@ |
|  |  | /\* This Source Code Form is subject to the terms of the Mozilla Public |
|  |  | \* License, v. 2.0. If a copy of the MPL was not distributed with this |
|  |  | \* file, You can obtain one at http://mozilla.org/MPL/2.0/. \*/ |
|  |  |  |
|  |  | package org.mozilla.firefox.vpn.ext |
|  |  |  |
|  |  | import android.net.Uri |
|  |  | import org.mozilla.firefox.vpn.AuthCode |
|  |  |  |
|  |  | private const val CODE\_QUERY\_PARAM = "code" |
|  |  |  |
|  |  | private val ALLOWED\_CODE\_CHARS = (('0'..'9') + ('a'..'f')).toSet() |
|  |  |  |
|  |  | fun Uri.toCode(): AuthCode? { |
|  |  | val code = getQueryParameter(CODE\_QUERY\_PARAM) |
|  |  |  |
|  |  | return if ( |
|  |  | code == null || |
|  |  | code.length != 80 || |
|  |  | code.any { char -> !ALLOWED\_CODE\_CHARS.contains(char) } |
|  |  | ) { |
|  |  | null |
|  |  | } else { |
|  |  | code |
|  |  | } |
|  |  | } |

2 changes: 1 addition & 1 deletion

2
[app/src/main/java/org/mozilla/firefox/vpn/main/settings/domain/SignOutUseCase.kt](#diff-36f2efee08df3c768c2883000591eacc68fb56a3dbb588c5bb4d76b10bac3910 "app/src/main/java/org/mozilla/firefox/vpn/main/settings/domain/SignOutUseCase.kt")

Show comments

[View file](/mozilla-mobile/guardian-vpn-android/blob/981c840276ef3aee98cf5d42993d484ee99b28d9/app/src/main/java/org/mozilla/firefox/vpn/main/settings/domain/SignOutUseCase.kt)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,7 +27,7 @@ class SignOutUseCase( |
|  |  | CoroutineScope(coroutineContext + NonCancellable).launch { |
|  |  | deviceRepository.getDevice()?.let { |
|  |  | deviceRepository.unregisterDevice(it.device.pubKey) |
|  |  | userRepository.removeUserInfo() |
|  |  | userRepository.invalidateSession() |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `981c840`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fguardian-vpn-android%2Fcommit%2F981c840276ef3aee98cf5d42993d484ee99b28d9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


