=== Content from phabricator.wikimedia.org_c3310eab_20250119_114055.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT229731)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T229731
# Global blocks: if an IP is within two ranges and one is locally disabled, GlobalBlock won't listen to the other one (CVE-2020-10534)Closed, Resolved[Public](/policy/explain/PHID-TASK-6kkfawqpt4qmfn3wjx7n/view/)Actions

* [Edit Task](/maniphest/task/edit/229731/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/229731/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Protect as security issue](/wmf/escalate-task/229731/)
* [Award Token](/token/give/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
* [Flag For Later](/flag/edit/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)

Assigned To

|  | [Urbanecm](/p/Urbanecm/) |
| --- | --- |

Authored By

|  | [MarcoAurelio](/p/MarcoAurelio/) |
| --- | --- |
| Aug 3 2019, 5:45 PM2019-08-03 17:45:55 (UTC+0) |

Tags

* [GlobalBlocking](/tag/globalblocking/) [(Backlog)](/project/board/315/)
* [Stewards-and-global-tools](/tag/stewards-and-global-tools/) [(High priority)](/project/board/1596/)
* [User-Urbanecm](/tag/user-urbanecm/) [(Blocked on others)](/project/board/2098/)
* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [user-sbassett](/tag/user-sbassett/) [(Done)](/project/board/3979/)
* [Patch-For-Review](/tag/patch-for-review/)
* [MW-1.35-notes (1.35.0-wmf.24; 2020-03-17)](/project/view/4475/)
Referenced Files

|  | [F31655302: 01-T229731.patch](/F31655302) |
| --- | --- |
| Mar 2 2020, 1:11 PM2020-03-02 13:11:14 (UTC+0) |

|  | [F31545151: T229731.patch](/F31545151) |
| --- | --- |
| Feb 2 2020, 5:46 PM2020-02-02 17:46:48 (UTC+0) |

|  | [F30937800: T229731.patch](/F30937800) |
| --- | --- |
| Oct 31 2019, 3:26 PM2019-10-31 15:26:06 (UTC+0) |

|  | [F30937796: T229731.patch](/F30937796) |
| --- | --- |
| Oct 31 2019, 3:24 PM2019-10-31 15:24:31 (UTC+0) |

|  | [F29949899: T229731.patch](/F29949899) |
| --- | --- |
| Aug 3 2019, 10:27 PM2019-08-03 22:27:21 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Catrope](/p/Catrope/) |
| --- | --- |

|  | [DannyS712](/p/DannyS712/) |
| --- | --- |

|  | [• Jcross](/p/Jcross/) |
| --- | --- |

|  | [Jdforrester-WMF](/p/Jdforrester-WMF/) |
| --- | --- |

|  | [jrbs](/p/jrbs/) |
| --- | --- |

|  | [kolbert](/p/kolbert/) |
| --- | --- |

[View All 12 Subscribers](/subscriptions/list/PHID-TASK-6kkfawqpt4qmfn3wjx7n/)
# Description

I've noticed that 82.102.16.0/20 is globally blocked by [@kolbert](/p/kolbert/) on Aug. 2.

82.102.24.251 is within that range but managed to edit on eswiki today: [https://es.wikipedia.org/wiki/Especial:Contribuciones/82.102.24.251](https://es.wikipedia.org/wiki/Especial%3AContribuciones/82.102.24.251).

82.102.26.202 is also within the range but has also managed to edit: [https://es.wikipedia.org/wiki/Especial:Contribuciones/82.102.26.202](https://es.wikipedia.org/wiki/Especial%3AContribuciones/82.102.26.202)

Given that the range is globally blocked no one should've been allowed to edit.

Please investigate whether this is affecting this specific global block, or just some or all of them (which would be quite catastrophic).

Thank you.

**Updated status**

After checking [https://es.wikipedia.org/wiki/Especial:Lista\_de\_bloqueos\_globales?ip=82.102.24.251](https://es.wikipedia.org/wiki/Especial%3ALista_de_bloqueos_globales?ip=82.102.24.251) we see:

* 82.102.0.0/19 is globally blocked, but the global block is locally disabled.
* However 82.102.16.0/20 is globally blocked but *not* locally disabled.
* Given that 82.102.24.251 is both in the /19 and the /20 it looks like GlobalBlock just ignores the /20 global block and lets the entire /19 range edit, making the /20 global block useless.
# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions](https://gerrit.wikimedia.org/r/c/579429) | [mediawiki/extensions/GlobalBlocking](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking) | [REL1\_31](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking/%2B/REL1_31) | +71 -23 |
|  | [SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions](https://gerrit.wikimedia.org/r/c/579428) | [mediawiki/extensions/GlobalBlocking](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking) | [REL1\_33](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking/%2B/REL1_33) | +71 -23 |
|  | [Use IPUtils instead of deprecated IP class](https://gerrit.wikimedia.org/r/c/579431) | [mediawiki/extensions/GlobalBlocking](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking/%2B/master) | +4 -4 |
|  | [SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions](https://gerrit.wikimedia.org/r/c/579427) | [mediawiki/extensions/GlobalBlocking](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking) | [REL1\_34](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking/%2B/REL1_34) | +72 -24 |
|  | [SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions](https://gerrit.wikimedia.org/r/c/578566) | [mediawiki/extensions/GlobalBlocking](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalBlocking/%2B/master) | +70 -22 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T229731)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T240392 [Release MediaWiki 1.31.7/1.33.3/1.34.1](/T240392) |
|  |  | Resolved |  | [sbassett](/p/sbassett/) | T240400 [Write and send supplementary release announcement for extensions and skins with security patches (MediaWiki 1.31.7/1.33.3/1.34.1)](/T240400) |
|  |  | Resolved |  | [Urbanecm](/p/Urbanecm/) | T229731 [Global blocks: if an IP is within two ranges and one is locally disabled, GlobalBlock won't listen to the other one (CVE-2020-10534)](/T229731) |

Mentioned In [T233872: 1.35.0-wmf.24 deployment blockers](/T233872)
[T240400: Write and send supplementary release announcement for extensions and skins with security patches (MediaWiki 1.31.7/1.33.3/1.34.1)](/T240400)
[T240393: Tracking bug for MediaWiki 1.31.7/1.33.3/1.34.1](/T240393)
[T200734: Misleading block messages when an IP is affected by two range blocks](/T200734) Mentioned Here [T233759: Update mediawiki/mediawiki-codesniffer for php7.3 support in release branches](/T233759)
[T240400: Write and send supplementary release announcement for extensions and skins with security patches (MediaWiki 1.31.7/1.33.3/1.34.1)](/T240400)
[T240393: Tracking bug for MediaWiki 1.31.7/1.33.3/1.34.1](/T240393)
### Event Timeline

There are a very large number of changes, so older changes are hidden. [Show Older Changes](/transactions/showolder/PHID-TASK-6kkfawqpt4qmfn3wjx7n/?after=5389710&quoteTargetID=UQ0_1&quoteRef=T229731)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3238779/)[Aug 3 2019, 5:45 PM2019-08-03 17:45:56 (UTC+0)](#5389716)[MarcoAurelio](/p/MarcoAurelio/) added projects: [GlobalBlocking](/tag/globalblocking/), [Stewards-and-global-tools](/tag/stewards-and-global-tools/).[Aug 3 2019, 5:46 PM2019-08-03 17:46:25 (UTC+0)](#5389717)[kolbert](/p/kolbert/) removed a subscriber: [• Jon\_Kolbert](/p/Jon_Kolbert/).[Aug 3 2019, 5:52 PM2019-08-03 17:52:31 (UTC+0)](#5389737)[kolbert](/p/kolbert/) subscribed.[MarcoAurelio](/p/MarcoAurelio/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-khsacbfukhozmdd/)[Aug 3 2019, 5:57 PM2019-08-03 17:57:24 (UTC+0)](#5389739)[jrbs](/p/jrbs/) subscribed.[Aug 3 2019, 6:23 PM2019-08-03 18:23:04 (UTC+0)](#5389747)

[Urbanecm](/p/Urbanecm/) subscribed.[Aug 3 2019, 6:27 PM2019-08-03 18:27:11 (UTC+0)](#5389749)Comment Actions

It looks this was an API-based edit.

```
[urbanecm@mwlog1001 /srv/mw-log]$ grep 82.102.26.202 api.log
[snip]
2019-08-03 15:43:08 [XUWrjApAAEsAAJ55r7kAAACH] mw1280 eswiki 1.34.0-wmf.16 api INFO: API POST 82.102.26.202 82.102.26.202 T=833ms action=edit format=json title=Rosal%C3%ADa%20Vila section=0 text=%7B%7BFicha%20de%20artista%20musical%0A%7Cnombre%20%20%20%20%20%20%20%20%20%20%20%20%3D%20Rosal%C3%ADa%0A%7Cimagen%20%20%20%20%20%20%20%20%20%20%20%20%3D%20Rosalia%202019-portrait.jpg%0A%7Csubt%C3%ADtulo%20%20%20%20%20%20%20%20%20%3D%20Rosal%C3%ADa%20en%20los%20%5B%5BPremios%20Goya%5D%5D%20de%202019.%0A%7Ctama%C3%B1o%20%20%20%20%20%20%20%20%20%20%20%20%3D%20250px%0A%7Cfondo%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20solista%0A%7Cnombre%20real%20%20%20%20%20%20%20%3D%20Rosal%C3%ADa%20V[...] summary=Eliminaci%C3%B3n%20de%20carga%20ideol%C3%B3gica. basetimestamp=2019-07-31T18:50:43Z starttimestamp=2019-07-31T18:50:43Z token=[redacted]
[snip]
```
[MarcoAurelio](/p/MarcoAurelio/) added a comment.Edited · [Aug 3 2019, 6:42 PM2019-08-03 18:42:30 (UTC+0)](#5389766)Comment Actions

I've been discussing with [@Urbanecm](/p/Urbanecm/) on IRC with this.

~~My guess is that this might be some sort of caching issue. 82.102.16.0/20 was globally blocked as part of a batch of global blocks which were all issued using a Toolforge tool. Maybe the database, given that those were issued at high speed, failed to load them properly or something like that?~~

Edit: this is not the reason. See updated description for details.

[MarcoAurelio](/p/MarcoAurelio/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ekaonbgkz4fwkik/)[Aug 3 2019, 6:51 PM2019-08-03 18:51:53 (UTC+0)](#5389773)Comment ActionsNOTE: Updated task details.[MarcoAurelio](/p/MarcoAurelio/) renamed this task from GlobalBlocks not working to Global blocks: if an IP is within two ranges and one is locally disabled, GlobalBlock won't listen to the other one.[Aug 3 2019, 6:55 PM2019-08-03 18:55:59 (UTC+0)](#5389799)

[Urbanecm](/p/Urbanecm/) added a comment.[Aug 3 2019, 9:00 PM2019-08-03 21:00:02 (UTC+0)](#5389836)Comment Actions

Do I understand GlobalBlocking::getGlobalBlockingBlock()'s $block = $dbr->selectRow( 'globalblocks', self::selectFields(), $conds, \_\_METHOD\_\_ ); correctly? I feel it means "select the first block in the database", which would usually mean the oldest one. Maybe we should add a method like DatabaseBlock::chooseMostSpecificBlock() to GlobalBlocking::getGlobalBlockingBlock() and select the most specific block. That would solve this issue, since the smaller block would be used, instead of the /19 one.

[Urbanecm](/p/Urbanecm/) claimed this task.[Aug 3 2019, 10:27 PM2019-08-03 22:27:21 (UTC+0)](#5389868)[Urbanecm](/p/Urbanecm/) triaged this task as Low priority.[Urbanecm](/p/Urbanecm/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Urbanecm](/p/Urbanecm/) added a subscriber: [Catrope](/p/Catrope/).Comment Actions

This should fix it. The patch basically makes sure the block displayed on Special:Contributions and the block used displayed in "You are blocked" message is a) the same b) the most specific block. It should work the same way like local blocks after applying this patch.

T229731.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/c6c5o24cia533ilshucb/PHID-FILE-wbfgrfyuhmazyzq4lwha/T229731.patch)

[@Catrope](/p/Catrope/), could you review?

Restricted Application added a project: [User-Urbanecm](/tag/user-urbanecm/).  · [View Herald Transcript](/herald/transcript/3238863/)[Aug 3 2019, 10:27 PM2019-08-03 22:27:23 (UTC+0)](#5389873)[Urbanecm](/p/Urbanecm/) moved this task from [Backlog / Other](/project/board/30/) to [Patch pending review](/project/board/30/) on the [acl\*security](/tag/acl_security/) board.[Aug 3 2019, 10:33 PM2019-08-03 22:33:25 (UTC+0)](#5389875)[Urbanecm](/p/Urbanecm/) moved this task from [Backlog](/project/board/2098/) to [Waiting on review](/project/board/2098/) on the [User-Urbanecm](/tag/user-urbanecm/) board.

[Reedy](/p/Reedy/) subscribed.[Aug 5 2019, 9:32 AM2019-08-05 09:32:02 (UTC+0)](#5391604)Comment Actions
> In [T229731#5389836](/T229731#5389836), [@Urbanecm](/p/Urbanecm/) wrote:
>
> Do I understand GlobalBlocking::getGlobalBlockingBlock()'s $block = $dbr->selectRow( 'globalblocks', self::selectFields(), $conds, \_\_METHOD\_\_ ); correctly? I feel it means "select the first block in the database", which would usually mean the oldest one. Maybe we should add a method like DatabaseBlock::chooseMostSpecificBlock() to GlobalBlocking::getGlobalBlockingBlock() and select the most specific block. That would solve this issue, since the smaller block would be used, instead of the /19 one.

selectRow will indeed only return one row. Whether it's the oldest is indeterminate when a sort order isn't provided

[MarcoAurelio](/p/MarcoAurelio/) moved this task from [Untriaged](/project/board/1596/) to [High priority](/project/board/1596/) on the [Stewards-and-global-tools](/tag/stewards-and-global-tools/) board.[Oct 1 2019, 8:34 PM2019-10-01 20:34:50 (UTC+0)](#5539164)

[Urbanecm](/p/Urbanecm/) added a comment.[Oct 31 2019, 3:24 PM2019-10-31 15:24:31 (UTC+0)](#5623751)Comment Actions

T229731.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/cgolhybjmbg75yu6hzyc/PHID-FILE-3wf3qkb3vhy6cqyy47sm/T229731.patch)

Rebased. Anyone to review?

[Urbanecm](/p/Urbanecm/) added a comment.[Oct 31 2019, 3:26 PM2019-10-31 15:26:06 (UTC+0)](#5623764)Comment Actions

T229731.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/caulaji2vfcm7mohutma/PHID-FILE-5rtwmiidg4a3ibzdajvl/T229731.patch)

Second attempt...

[Urbanecm](/p/Urbanecm/) added a comment.[Jan 4 2020, 5:35 PM2020-01-04 17:35:40 (UTC+0)](#5775400)Comment Actions

...?

[Urbanecm](/p/Urbanecm/) added a comment.[Jan 15 2020, 5:14 PM2020-01-15 17:14:08 (UTC+0)](#5806161)Comment Actions

...?

[sbassett](/p/sbassett/) added a project: [Security-Team](/tag/security-team/).[Jan 16 2020, 7:54 PM2020-01-16 19:54:39 (UTC+0)](#5810698)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [In Progress](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[• Jcross](/p/Jcross/) subscribed.[Jan 16 2020, 8:04 PM2020-01-16 20:04:12 (UTC+0)](#5810774)Comment Actions

Hi [@Urbanecm](/p/Urbanecm/)

Regretfully, this ticket was outside of the team workflow thus your requests for review were not seen or acted upon by the Security Team in a timely fashion. We apologize for the confusion, as we are working hard to improve and evolve our processes. For future reference, tagging [Security](/tag/security/) is not considered a request for service from the Security Team and [following our SOP](https://www.mediawiki.org/wiki/Security/SOP/Requests_For_Service) will ensure our prompt attention to your needs. Thank you - and again, we apologize for the confusion. We are adding our [Security-Team](/tag/security-team/) tag and will take a look during our next clinic meeting.

Cheers

[Urbanecm](/p/Urbanecm/) added a comment.[Feb 2 2020, 5:46 PM2020-02-02 17:46:48 (UTC+0)](#5843495)Comment Actions

T229731.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/sddo3vnh3xj2bo2kfnxp/PHID-FILE-mvehmu5rcyk74x6jdzap/T229731.patch)

Third time's the charm.

[Urbanecm](/p/Urbanecm/) added a comment.[Feb 2 2020, 5:49 PM2020-02-02 17:49:26 (UTC+0)](#5843496)Comment Actions

[@Jcross](/p/Jcross/) Thanks for the explanation - was there any update with this patch?

[Urbanecm](/p/Urbanecm/) mentioned this in [T200734: Misleading block messages when an IP is affected by two range blocks](/T200734).[Feb 2 2020, 9:58 PM2020-02-02 21:58:47 (UTC+0)](#5843710)[• chasemp](/p/chasemp/) added a project: [Security](/tag/security/).[Feb 10 2020, 11:00 PM2020-02-10 23:00:01 (UTC+0)](#5869957) · [sbassett](/p/sbassett/) subscribed.[Feb 14 2020, 5:52 PM2020-02-14 17:52:11 (UTC+0)](#5885461)Comment Actions

[@Urbanecm](/p/Urbanecm/) - Sorry for the delay on this. We should hopefully be able to get it reviewed and deployed sometime next week.

[• chasemp](/p/chasemp/) removed a project: [acl\*security](/tag/acl_security/).[Feb 20 2020, 8:08 PM2020-02-20 20:08:17 (UTC+0)](#5902796) · [sbassett](/p/sbassett/) added a comment.[Feb 21 2020, 10:01 PM2020-02-21 22:01:14 (UTC+0)](#5908440)Comment Actions

[@Urbanecm](/p/Urbanecm/) - I've reviewed the patch and can +1 for now as it seems sane, though I didn't get to test it as completely as I'd like. I'm thinking it can probably go out during [this coming Monday's sec deployment window](https://wikitech.wikimedia.org/wiki/Deployments#deploycal-item-20200224T2200). Would you be around to help test?

[Urbanecm](/p/Urbanecm/) added a comment.[Feb 22 2020, 2:09 PM2020-02-22 14:09:23 (UTC+0)](#5909410)Comment Actions
> In [T229731#5908440](/T229731#5908440), [@sbassett](/p/sbassett/) wrote:
>
> [@Urbanecm](/p/Urbanecm/) - I've reviewed the patch and can +1 for now as it seems sane, though I didn't get to test it as completely as I'd like. I'm thinking it can probably go out during [this coming Monday's sec deployment window](https://wikitech.wikimedia.org/wiki/Deployments#deploycal-item-20200224T2200). Would you be around to help test?

Unfortunately, I'm not a steward and I cannot place global blocks. To fully test, we'd need some ranges with IPs I'm able to access globally blocked. Maybe [@MarcoAurelio](/p/MarcoAurelio/) could help us place the blocks? Or, we can also wait for the end of [SE2020](https://meta.wikimedia.org/wiki/Stewards/Elections_2020) :-).

[MarcoAurelio](/p/MarcoAurelio/) added a comment.[Feb 22 2020, 6:05 PM2020-02-22 18:05:59 (UTC+0)](#5909683)Comment Actions
> In [T229731#5909410](/T229731#5909410), [@Urbanecm](/p/Urbanecm/) wrote:
>
> Unfortunately, I'm not a steward and I cannot place global blocks. To fully test, we'd need some ranges with IPs I'm able to access globally blocked. Maybe [@MarcoAurelio](/p/MarcoAurelio/) could help us place the blocks? Or, we can also wait for the end of [SE2020](https://meta.wikimedia.org/wiki/Stewards/Elections_2020) :-).

It depends on the urgency. I could probably coordinate with both of you to attempt to place some global blocks and see if this works or you can wait until SE is over and do it yourself (and therefore save my fees :-P ). As you wish :-)

[Urbanecm](/p/Urbanecm/) added a comment.[Feb 23 2020, 11:59 AM2020-02-23 11:59:11 (UTC+0)](#5910210)Comment Actions

Given this waited in the queue for months, a week shouldn't hurt us much. [@sbassett](/p/sbassett/) Would Mar 2 sec window be okay with you?

[sbassett](/p/sbassett/) added a comment.[Feb 24 2020, 9:50 PM2020-02-24 21:50:33 (UTC+0)](#5913887)Comment Actions
> In [T229731#5910210](/T229731#5910210), [@Urbanecm](/p/Urbanecm/) wrote:
>
> Given this waited in the queue for months, a week shouldn't hurt us much. [@sbassett](/p/sbassett/) Would Mar 2 sec window be okay with you?

[@Urbanecm](/p/Urbanecm/) [@MarcoAurelio](/p/MarcoAurelio/) -

Should be fine. I know the weekly security deployment window (UTC 22:00–00:00) isn't very Euro-friendly - would you prefer to try to add this to the European SWAT on March 2nd? I'm happy to help test/deploy at either time.

[sbassett](/p/sbassett/) added a comment.[Feb 28 2020, 8:20 PM2020-02-28 20:20:49 (UTC+0)](#5927870)Comment Actions
> In [T229731#5913887](/T229731#5913887), [@sbassett](/p/sbassett/) wrote:
>
> Should be fine. I know the weekly security deployment window (UTC 22:00–00:00) isn't very Euro-friendly - would you prefer to try to add this to the European SWAT on March 2nd? I'm happy to help test/deploy at either time.

[@Urbanecm](/p/Urbanecm/) [@MarcoAurelio](/p/MarcoAurelio/) - does the above work for Monday, March 2nd?

[sbassett](/p/sbassett/) added a project: [user-sbassett](/tag/user-sbassett/).[Feb 28 2020, 8:21 PM2020-02-28 20:21:03 (UTC+0)](#5927871)[sbassett](/p/sbassett/) moved this task from [Backlog](/project/board/3979/) to [In Progress](/project/board/3979/) on the [user-sbassett](/tag/user-sbassett/) board.

[Urbanecm](/p/Urbanecm/) added a comment.[Feb 28 2020, 9:04 PM2020-02-28 21:04:09 (UTC+0)](#5928045)Comment Actions

EU SWAT would be better, but I can make it if needed.

[sbassett](/p/sbassett/) added a comment.[Feb 28 2020, 9:30 PM2020-02-28 21:30:50 (UTC+0)](#5928176)Comment Actions

[@Urbanecm](/p/Urbanecm/) - do we need to get this on [the deployment schedule](https://wikitech.wikimedia.org/wiki/Deployments#deploycal-item-20200302T1200) or no?

[@MarcoAurelio](/p/MarcoAurelio/) - does 12:00–13:00 UTC March 2nd work for you?

[MarcoAurelio](/p/MarcoAurelio/) added a comment.[Feb 29 2020, 10:44 AM2020-02-29 10:44:10 (UTC+0)](#5928877)Comment Actions
> In [T229731#5928176](/T229731#5928176), [@sbassett](/p/sbassett/) wrote:
>
> [@MarcoAurelio](/p/MarcoAurelio/) - does 12:00–13:00 UTC March 2nd work for you?

I can't make any promises. However [@Urbanecm](/p/Urbanecm/) is now a steward and can access the production global blocking interface to test if needed.

[Urbanecm](/p/Urbanecm/) added a comment.[Mar 2 2020, 1:11 PM2020-03-02 13:11:14 (UTC+0)](#5932483)Comment Actions

01-T229731.patch5 KB[Download](https://phab.wmfusercontent.org/file/download/7hwzpa3iov7mybg4iigx/PHID-FILE-73heameu7j4rqxbdkmcp/01-T229731.patch)

recent changes made me do one other rebase...

```
13:58 <Urbanecm> !log Deploy security fix for T229731
```

This is now live, and per my test.wikipedia testing, it works.

[Urbanecm](/p/Urbanecm/) moved this task from [Waiting on review](/project/board/2098/) to [Blocked on others](/project/board/2098/) on the [User-Urbanecm](/tag/user-urbanecm/) board.[Mar 2 2020, 1:14 PM2020-03-02 13:14:35 (UTC+0)](#5932485)[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/3979/) to [Waiting](/project/board/3979/) on the [user-sbassett](/tag/user-sbassett/) board.[Mar 2 2020, 6:06 PM2020-03-02 18:06:42 (UTC+0)](#5933844)[sbassett](/p/sbassett/) added a parent task: [T240393: Tracking bug for MediaWiki 1.31.7/1.33.3/1.34.1](/T240393).[sbassett](/p/sbassett/) mentioned this in [T240393: Tracking bug for MediaWiki 1.31.7/1.33.3/1.34.1](/T240393).[Mar 2 2020, 6:09 PM2020-03-02 18:09:01 (UTC+0)](#5933865)Comment Actions

[@Urbanecm](/p/Urbanecm/) - Thanks for patching and deploying this! I've added this to the tracking bug for the next security release: [T240393](/T240393). So let's keep this task private and hold off on the backports/CVE for a bit.

[Trijnstel](/p/Trijnstel/) subscribed.[Mar 3 2020, 10:24 PM2020-03-03 22:24:58 (UTC+0)](#5939212)

[Reedy](/p/Reedy/) added a comment.[Mar 10 2020, 1:51 PM2020-03-10 13:51:55 (UTC+0)](#5956124)Comment Actions
> In [T229731#5933865](/T229731#5933865), [@sbassett](/p/sbassett/) wrote:
>
> [@Urbanecm](/p/Urbanecm/) - Thanks for patching and deploying this! I've added this to the tracking bug for the next security release: [T240393](/T240393). So let's keep this task private and hold off on the backports/CVE for a bit.

Noting GlobalBlocking is not bundled, and it's not a core patch...

[Reedy](/p/Reedy/) edited parent tasks, added: [T240400: Write and send supplementary release announcement for extensions and skins with security patches (MediaWiki 1.31.7/1.33.3/1.34.1)](/T240400); removed: [T240393: Tracking bug for MediaWiki 1.31.7/1.33.3/1.34.1](/T240393).[Mar 10 2020, 2:13 PM2020-03-10 14:13:12 (UTC+0)](#5956183)[Reedy](/p/Reedy/) mentioned this in [T240400: Write and send supplementary release announcement for extensions and skins with security patches (MediaWiki 1.31.7/1.33.3/1.34.1)](/T240400).[sbassett](/p/sbassett/) added a comment.[Mar 10 2020, 2:16 PM2020-03-10 14:16:51 (UTC+0)](#5956225)Comment Actions
> In [T229731#5956124](/T229731#5956124), [@Reedy](/p/Reedy/) wrote:
>
> Noting GlobalBlocking is not bundled, and it's not a core patch...

Ah, yes. So... I guess if this patch seems stable in prod, we can make this task public and start the backports.

[Reedy](/p/Reedy/) added a comment.[Mar 10 2020, 2:31 PM2020-03-10 14:31:15 (UTC+0)](#5956307)Comment Actions
> In [T229731#5956225](/T229731#5956225), [@sbassett](/p/sbassett/) wrote:
> > In [T229731#5956124](/T229731#5956124), [@Reedy](/p/Reedy/) wrote:
> >
> > Noting GlobalBlocking is not bundled, and it's not a core patch...
>
> Ah, yes. So... I guess if this patch seems stable in prod, we can make this task public and start the backports.

Yeah, WFM. If we get the patch into master now ish, it can go out with the train in a few hours

We still want a CVE for this one though, right?

[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Mar 10 2020, 5:33 PM2020-03-10 17:33:35 (UTC+0)](#5957145)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-365k7hevtpgspvv/)" to "Public (No Login Required)".[gerritbot](/p/gerritbot/) added a comment.[Mar 10 2020, 5:34 PM2020-03-10 17:34:05 (UTC+0)](#5957148)Comment Actions

Change 578566 had a related patch set uploaded (by SBassett; owner: Urbanecm):

[mediawiki/extensions/GlobalBlocking@master] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/578566>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Mar 10 2020, 5:34 PM2020-03-10 17:34:06 (UTC+0)](#5957149)[DannyS712](/p/DannyS712/) subscribed.[Mar 10 2020, 6:58 PM2020-03-10 18:58:25 (UTC+0)](#5957583)[gerritbot](/p/gerritbot/) added a comment.[Mar 10 2020, 10:17 PM2020-03-10 22:17:45 (UTC+0)](#5958438)Comment Actions

Change 578566 **merged** by SBassett:

[mediawiki/extensions/GlobalBlocking@master] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/578566>

[ReleaseTaggerBot](/p/ReleaseTaggerBot/) added a project: [MW-1.35-notes (1.35.0-wmf.24; 2020-03-17)](/project/view/4475/).[Mar 10 2020, 11:00 PM2020-03-10 23:00:33 (UTC+0)](#5958609)[sbassett](/p/sbassett/) added a comment.Edited · [Mar 12 2020, 8:49 PM2020-03-12 20:49:13 (UTC+0)](#5965728)Comment Actions

I've submitted the CVE request for this issue - I'll update this task and [T240400](/T240400) once I have the ID. Gerrit couldn't seem to handle simple picks for the backports to 1.31, 1.33 and 1.34, so those will likely involve a bit more work, if they're even feasible.

[Reedy](/p/Reedy/) added a comment.[Mar 12 2020, 10:23 PM2020-03-12 22:23:59 (UTC+0)](#5966145)Comment Actions
> In [T229731#5965728](/T229731#5965728), [@sbassett](/p/sbassett/) wrote:
>
> I've submitted the CVE request for this issue - I'll update this task and [T240400](/T240400) once I have the ID. Gerrit couldn't seem to handle simple picks for the backports to 1.31, 1.33 and 1.34, so those will likely involve a bit more work, if they're even feasible.

Basically if there's any conflicts, gerrit says no. jgit sucks

[gerritbot](/p/gerritbot/) added a comment.[Mar 12 2020, 11:02 PM2020-03-12 23:02:49 (UTC+0)](#5966220)Comment Actions

Change 579427 had a related patch set uploaded (by Reedy; owner: Urbanecm):

[mediawiki/extensions/GlobalBlocking@REL1\_34] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579427>

[gerritbot](/p/gerritbot/) added a comment.[Mar 12 2020, 11:05 PM2020-03-12 23:05:25 (UTC+0)](#5966226)Comment Actions

Change 579428 had a related patch set uploaded (by Reedy; owner: Urbanecm):

[mediawiki/extensions/GlobalBlocking@REL1\_33] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579428>

[gerritbot](/p/gerritbot/) added a comment.[Mar 12 2020, 11:06 PM2020-03-12 23:06:18 (UTC+0)](#5966227)Comment Actions

Change 579429 had a related patch set uploaded (by Reedy; owner: Urbanecm):

[mediawiki/extensions/GlobalBlocking@REL1\_31] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579429>

[gerritbot](/p/gerritbot/) added a comment.[Mar 12 2020, 11:09 PM2020-03-12 23:09:26 (UTC+0)](#5966239)Comment Actions

Change 579431 had a related patch set uploaded (by DannyS712; owner: DannyS712):

[mediawiki/extensions/GlobalBlocking@master] Use IPUtils instead of deprecated IP class

<https://gerrit.wikimedia.org/r/579431>

[gerritbot](/p/gerritbot/) added a comment.[Mar 13 2020, 1:31 AM2020-03-13 01:31:07 (UTC+0)](#5966453)Comment Actions

Change 579427 **merged** by jenkins-bot:

[mediawiki/extensions/GlobalBlocking@REL1\_34] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579427>

[gerritbot](/p/gerritbot/) added a comment.[Mar 13 2020, 1:41 AM2020-03-13 01:41:04 (UTC+0)](#5966474)Comment Actions

Change 579431 **merged** by jenkins-bot:

[mediawiki/extensions/GlobalBlocking@master] Use IPUtils instead of deprecated IP class

<https://gerrit.wikimedia.org/r/579431>

[sbassett](/p/sbassett/) renamed this task from Global blocks: if an IP is within two ranges and one is locally disabled, GlobalBlock won't listen to the other one to Global blocks: if an IP is within two ranges and one is locally disabled, GlobalBlock won't listen to the other one (CVE-2020-10534).Edited · [Mar 13 2020, 7:49 PM2020-03-13 19:49:53 (UTC+0)](#5968376)[sbassett](/p/sbassett/) added a subscriber: [Jdforrester-WMF](/p/Jdforrester-WMF/).Comment Actions

[CVE here](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10534). Thanks, [@Reedy](/p/Reedy/), [@DannyS712](/p/DannyS712/), [@Jdforrester-WMF](/p/Jdforrester-WMF/) for getting the backports done!

[sbassett](/p/sbassett/) closed this task as Resolved.[Mar 13 2020, 7:52 PM2020-03-13 19:52:09 (UTC+0)](#5968379)[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) moved this task from [Waiting](/project/board/3979/) to [Done](/project/board/3979/) on the [user-sbassett](/tag/user-sbassett/) board.

[DannyS712](/p/DannyS712/) added a comment.[Mar 13 2020, 8:34 PM2020-03-13 20:34:42 (UTC+0)](#5968478)Comment Actions
> In [T229731#5968376](/T229731#5968376), [@sbassett](/p/sbassett/) wrote:
>
> [CVE here](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10534). Thanks, [@Reedy](/p/Reedy/), [@DannyS712](/p/DannyS712/), [@Jdforrester-WMF](/p/Jdforrester-WMF/) for getting the backports done!

Not all the backports are merged yet - should this still be open?

[gerritbot](/p/gerritbot/) added a comment.[Mar 13 2020, 8:41 PM2020-03-13 20:41:29 (UTC+0)](#5968479)Comment Actions

Change 579428 **merged** by jenkins-bot:

[mediawiki/extensions/GlobalBlocking@REL1\_33] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579428>

[sbassett](/p/sbassett/) reopened this task as Open.[Mar 13 2020, 8:41 PM2020-03-13 20:41:34 (UTC+0)](#5968480)Comment Actions
> In [T229731#5968478](/T229731#5968478), [@DannyS712](/p/DannyS712/) wrote:
>
> Not all the backports are merged yet - should this still be open?

I just +2'd 1.33, so that should merge soon. Looking at the issue for 1.31, it's complaining about an actual phpcs file, nothing related to GlobalBlocking, from what I can tell. In that case, we can likely just manually submit and file a bug regarding the phpcs issue in quibble, yes?

[Reedy](/p/Reedy/) added a comment.Edited · [Mar 13 2020, 8:46 PM2020-03-13 20:46:01 (UTC+0)](#5968487)Comment Actions
> In [T229731#5968480](/T229731#5968480), [@sbassett](/p/sbassett/) wrote:
> > In [T229731#5968478](/T229731#5968478), [@DannyS712](/p/DannyS712/) wrote:
> >
> > Not all the backports are merged yet - should this still be open?
>
> I just +2'd 1.33, so that should merge soon. Looking at the issue for 1.31, it's complaining about an actual phpcs file, nothing related to GlobalBlocking, from what I can tell. In that case, we can likely just manually submit and file a bug regarding the phpcs issue in quibble, yes?

It's basically an instance of [T233759: Update mediawiki/mediawiki-codesniffer for php7.3 support in release branches](/T233759) (or rather, would be fixed by it)

[hashar](/p/hashar/) mentioned this in [T233872: 1.35.0-wmf.24 deployment blockers](/T233872).[Mar 17 2020, 3:13 PM2020-03-17 15:13:54 (UTC+0)](#5975663)[gerritbot](/p/gerritbot/) added a comment.[Mar 24 2020, 5:41 PM2020-03-24 17:41:19 (UTC+0)](#5995756)Comment Actions

Change 579429 **merged** by Reedy:

[mediawiki/extensions/GlobalBlocking@REL1\_31] SECURITY: Apply most specific global block and make sure applied block matches block showed on Special:Contributions

<https://gerrit.wikimedia.org/r/579429>

[Reedy](/p/Reedy/) closed this task as Resolved.[Mar 24 2020, 5:41 PM2020-03-24 17:41:32 (UTC+0)](#5995757)[Log In to Comment](/login/?next=)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_c92ae373_20250119_114053.html ===



