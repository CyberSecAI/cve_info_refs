=== Content from www.jenkins.io_3fd5eac4_20250119_124000.html ===


[Jenkins Security Home](/security/)

**For Administrators**

* [Overview](/security/for-administrators/)
* [Security Advisories](/security/advisories/)
* [Security Issues](/security/issues/)
* [Advisory Schedule](/security/scheduling/)
* [Vulnerabilities in Plugins](/security/plugins/)
* [How We Fix Security Issues](/security/fixing/)

**For Reporters**

* [Reporting Vulnerabilities](/security/reporting/)
* [Jenkins CNA](/security/cna/)

**For Maintainers**

* [Overview](/security/for-maintainers/)
* [Vulnerabilities in Plugins](/security/plugins/)

**Jenkins Security Team**

* [About](/security/team/)
* [Contributions](/security/improvements/)

# Jenkins Security Advisory 2020-11-04

This advisory announces vulnerabilities in the following Jenkins deliverables:

* [Active Directory
  Plugin](https://plugins.jenkins.io/active-directory)
* Static Analysis Utilities
  Plugin
* [Ansible
  Plugin](https://plugins.jenkins.io/ansible)
* [AppSpider
  Plugin](https://plugins.jenkins.io/jenkinsci-appspider-plugin)
* [AWS Global Configuration
  Plugin](https://plugins.jenkins.io/aws-global-configuration)
* [Azure Key Vault
  Plugin](https://plugins.jenkins.io/azure-keyvault)
* FindBugs
  Plugin
* [Kubernetes
  Plugin](https://plugins.jenkins.io/kubernetes)
* [Mail Commander Plugin for Jenkins-ci
  Plugin](https://plugins.jenkins.io/mailcommander)
* [Mercurial
  Plugin](https://plugins.jenkins.io/mercurial)
* [SQLPlus Script Runner
  Plugin](https://plugins.jenkins.io/sqlplus-script-runner)
* [Subversion
  Plugin](https://plugins.jenkins.io/subversion)
* [Visualworks Store
  Plugin](https://plugins.jenkins.io/visualworks-store)
* [VMware Lab Manager Slaves
  Plugin](https://plugins.jenkins.io/labmanager)

## Descriptions

### Login allowed with hardcoded password by Active Directory Plugin

**SECURITY-2117
/
CVE-2020-2299**

**Severity (CVSS):**
[Critical](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**Affected plugin:
[`active-directory`](https://plugins.jenkins.io/active-directory)**

**Description:**

Active Directory Plugin implements two separate modes: Integration with ADSI on Windows, and an OS agnostic LDAP-based mode.

The LDAP-based mode in Active Directory Plugin 2.19 and earlier shares code between user lookup and user authentication and distinguishes these behaviors through the use of a magic constant used in place of a real password.
This allows attackers to log in as any user if the magic constant is used as the password in Active Directory Plugin 2.19 and earlier.

Active Directory Plugin 2.20 no longer uses a magic constant to distinguish between user lookup and user authentication.

### Login allowed with empty password by Active Directory Plugin

**SECURITY-2099
/
CVE-2020-2300**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

**Affected plugin:
[`active-directory`](https://plugins.jenkins.io/active-directory)**

**Description:**

Active Directory Plugin implements two separate modes: Integration with ADSI on Windows, and an OS agnostic LDAP-based mode.

The Windows/ADSI mode does not specifically prohibit use of empty passwords in Active Directory Plugin 2.19 and earlier.
If the Active Directory server allows the unauthenticated bind operation, this allows attackers to log in to Jenkins as any user by providing an empty password.

Active Directory Plugin 2.20 prohibits the use of an empty password to log in.

### Authentication cache in Active Directory Plugin allows logging in with any password

**SECURITY-2123
/
CVE-2020-2301**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H)

**Affected plugin:
[`active-directory`](https://plugins.jenkins.io/active-directory)**

**Description:**

Active Directory Plugin implements two separate modes: Integration with ADSI on Windows, and an OS agnostic LDAP-based mode.
Optionally, to reduce lookup time, a cache can be configured to remember user lookups and user authentications.

In Active Directory Plugin 2.19 and earlier, when run in Windows/ADSI mode, the provided password was not used when looking up an applicable cache entry.
This allows attackers to log in as any user using any password while a successful authentication of that user is still in the cache.

As a workaround for this issue, the cache can be disabled.

Active Directory Plugin 2.20 includes the provided password in cache entry lookup.

Additionally, the Java system property `hudson.plugins.active_directory.CacheUtil.noCacheAuth` can be set to `true` to no longer cache user authentications.

### Missing permission check in Active Directory Plugin allows accessing domain health check page

**SECURITY-1999
/
CVE-2020-2302**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`active-directory`](https://plugins.jenkins.io/active-directory)**

**Description:**

Active Directory Plugin 2.19 and earlier does not perform a permission check in an HTTP endpoint.

This allows attackers with Overall/Read permission to access the domain health check diagnostic page.

Active Directory Plugin 2.20 requires Overall/Administer permission to access the domain health check diagnostic page.

### CSRF vulnerability in Active Directory Plugin

**SECURITY-2126
/
CVE-2020-2303**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N)

**Affected plugin:
[`active-directory`](https://plugins.jenkins.io/active-directory)**

**Description:**

Active Directory Plugin 2.19 and earlier does not require POST requests for multiple HTTP endpoints implementing connection and authentication tests, resulting in cross-site request forgery (CSRF) vulnerabilities.

This vulnerability allows attackers to perform connection tests, connecting to attacker-specified or previously configured Active Directory servers using attacker-specified credentials.

Active Directory Plugin 2.20 requires POST requests for the affected HTTP endpoints.

### XXE vulnerability in Subversion Plugin

**SECURITY-2145
/
CVE-2020-2304**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)

**Affected plugin:
[`subversion`](https://plugins.jenkins.io/subversion)**

**Description:**

Subversion Plugin 2.13.1 and earlier does not configure its XML parser to prevent XML external entity (XXE) attacks.

This allows attackers able to control an agent process to have Jenkins parse a crafted changelog file that uses external entities for extraction of secrets from the Jenkins controller or server-side request forgery.

Subversion Plugin 2.13.2 disables external entity resolution for its XML parser.

### XXE vulnerability in Mercurial Plugin

**SECURITY-2115
/
CVE-2020-2305**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)

**Affected plugin:
[`mercurial`](https://plugins.jenkins.io/mercurial)**

**Description:**

Mercurial Plugin 2.11 and earlier does not configure its XML changelog parser to prevent XML external entity (XXE) attacks.

This allows attackers able to control an agent process to have Jenkins parse a crafted changelog file that uses external entities for extraction of secrets from the Jenkins controller or server-side request forgery.

Mercurial Plugin 2.12 disables external entity resolution for its XML parser.

### Missing permission check in Mercurial Plugin

**SECURITY-2104
/
CVE-2020-2306**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`mercurial`](https://plugins.jenkins.io/mercurial)**

**Description:**

Mercurial Plugin 2.11 and earlier does not perform a permission check in an HTTP endpoint.

This allows attackers with Overall/Read permission to obtain a list of names of configured Mercurial installations.

Mercurial Plugin 2.12 performs permission checks when listing configured Mercurial installations.

### Jenkins controller environment variables accessible in Kubernetes Plugin

**SECURITY-1646
/
CVE-2020-2307**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`kubernetes`](https://plugins.jenkins.io/kubernetes)**

**Description:**

Kubernetes Plugin 1.27.3 and earlier includes a feature to replace placeholders in pod template and container template fields with environment variable values.

This feature allows low-privilege users to access possibly sensitive Jenkins controller environment variables.

Kubernetes Plugin 1.27.4 disables this feature.

|  | The Java system property `org.csanchez.jenkins.plugins.kubernetes.PodTemplateUtils.SUBSTITUTE_ENV` can be set to `true` to restore this feature. Administrators are advised that future releases of Kubernetes Plugin will remove this feature entirely. |
| --- | --- |

### Missing permission check in Kubernetes Plugin allows listing pod templates

**SECURITY-2102
/
CVE-2020-2308**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`kubernetes`](https://plugins.jenkins.io/kubernetes)**

**Description:**

Kubernetes Plugin 1.27.3 and earlier does not perform a permission check in an HTTP endpoint.

This allows attackers with Overall/Read permission to list global pod template names.

Kubernetes Plugin 1.27.4 requires Overall/Administer permission to list global pod template names.

### Missing permission check in Kubernetes Plugin allows enumerating credentials IDs

**SECURITY-2103
/
CVE-2020-2309**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`kubernetes`](https://plugins.jenkins.io/kubernetes)**

**Description:**

Kubernetes Plugin 1.27.3 and earlier does not perform a permission check in an HTTP endpoint.

This allows attackers with Overall/Read permission to enumerate credentials IDs of credentials stored in Jenkins.
Those can be used as part of an attack to capture the credentials using another vulnerability.

An enumeration of credentials IDs in Kubernetes Plugin 1.27.4 requires the appropriate permissions.

### Missing permission checks in Ansible Plugin allow enumerating credentials IDs

**SECURITY-1943
/
CVE-2020-2310**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`ansible`](https://plugins.jenkins.io/ansible)**

**Description:**

Ansible Plugin 1.0 and earlier does not perform permission checks in methods implementing form validation.

This allows attackers with Overall/Read permission to enumerate credentials IDs of credentials stored in Jenkins.
Those can be used as part of an attack to capture the credentials using another vulnerability.

An enumeration of credentials IDs in Ansible Plugin 1.1 requires the appropriate permissions.

### Missing permission check in AWS Global Configuration Plugin allows replacing plugin configuration

**SECURITY-2101
/
CVE-2020-2311**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

**Affected plugin:
[`aws-global-configuration`](https://plugins.jenkins.io/aws-global-configuration)**

**Description:**

AWS Global Configuration Plugin 1.5 and earlier does not perform a permission check in an HTTP endpoint processing form submissions.

This allows attackers with Overall/Read permission to replace the global AWS configuration.

AWS Global Configuration Plugin 1.6 properly performs permission checks when processing configuration form submissions.

### Password written to the build log by SQLPlus Script Runner Plugin

**SECURITY-2129
/
CVE-2020-2312**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`sqlplus-script-runner`](https://plugins.jenkins.io/sqlplus-script-runner)**

**Description:**

SQLPlus Script Runner Plugin 2.0.12 and earlier prints the `sqlplus` command invocation to the build log.

This log message does not redact a password provided as part of a command line argument.
This password can be viewed by users with Item/Read permission.

SQLPlus Script Runner Plugin 2.0.13 no longer prints the password in the build log.

### Missing permission checks in Azure Key Vault Plugin allow enumerating credentials IDs

**SECURITY-2110
/
CVE-2020-2313**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`azure-keyvault`](https://plugins.jenkins.io/azure-keyvault)**

**Description:**

Azure Key Vault Plugin 2.0 and earlier does not perform permission checks in several HTTP endpoints.

This allows attackers with Overall/Read permission to enumerate credentials IDs of credentials stored in Jenkins.
Those can be used as part of an attack to capture the credentials using another vulnerability.

An enumeration of credentials IDs in Azure Key Vault Plugin 2.1 requires the appropriate permissions.

### Password stored in plain text by AppSpider Plugin

**SECURITY-2058
/
CVE-2020-2314**

**Severity (CVSS):**
[Low](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`jenkinsci-appspider-plugin`](https://plugins.jenkins.io/jenkinsci-appspider-plugin)**

**Description:**

AppSpider Plugin 1.0.12 and earlier stores a password unencrypted in its global configuration file `com.rapid7.jenkinspider.PostBuildScan.xml` on the Jenkins controller as part of its configuration.

This password can be viewed by users with access to the Jenkins controller file system.

AppSpider Plugin 1.0.13 stores a password encrypted once its configuration is saved again.

### XXE vulnerability in Visualworks Store Plugin

**SECURITY-1900
/
CVE-2020-2315**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)

**Affected plugin:
[`visualworks-store`](https://plugins.jenkins.io/visualworks-store)**

**Description:**

Visualworks Store Plugin 1.1.3 and earlier does not configure its XML parser to prevent XML external entity (XXE) attacks.

This allows attackers with the ability to control the output of a script that run Visualworks with StoreCI, or able to control an agent process, to have Jenkins parse a crafted file that uses external entities for extraction of secrets from the Jenkins controller or server-side request forgery.

Visualworks Store Plugin 1.1.4 disables external entity resolution for its XML parser.

### Stored XSS vulnerability in Static Analysis Utilities Plugin

**SECURITY-1907
/
CVE-2020-2316**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H)

**Affected plugin:
[`analysis-core`](https://plugins.jenkins.io/analysis-core)**

**Description:**

Static Analysis Utilities Plugin 1.96 and earlier does not escape the annotation message in tooltips.

This results in a stored cross-site scripting (XSS) vulnerability exploitable by attackers with Job/Configure permission.

As of publication of this advisory, there is no fix.

### Stored XSS vulnerability in FindBugs Plugin

**SECURITY-1918
/
CVE-2020-2317**

**Severity (CVSS):**
[High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H)

**Affected plugin:
[`findbugs`](https://plugins.jenkins.io/findbugs)**

**Description:**

FindBugs Plugin 5.0.0 and earlier does not escape the annotation message in tooltips.

This results in a stored cross-site scripting (XSS) vulnerability exploitable by attackers able to provide report files to FindBugs Plugin’s post build step.

As of publication of this advisory, there is no fix.

### Passwords stored in plain text by Mail Commander Plugin for Jenkins-ci Plugin

**SECURITY-2085
/
CVE-2020-2318**

**Severity (CVSS):**
[Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`mailcommander`](https://plugins.jenkins.io/mailcommander)**

**Description:**

Mail Commander Plugin for Jenkins-ci Plugin 1.0.0 and earlier stores passwords unencrypted in job `config.xml` files on the Jenkins controller as part of its configuration.

These passwords can be viewed by users with Item/Extended Read permission or access to the Jenkins controller file system.

As of publication of this advisory, there is no fix.

### Password stored in plain text by VMware Lab Manager Slaves Plugin

**SECURITY-2084
/
CVE-2020-2319**

**Severity (CVSS):**
[Low](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**Affected plugin:
[`labmanager`](https://plugins.jenkins.io/labmanager)**

**Description:**

VMware Lab Manager Slaves Plugin 0.2.8 and earlier stores a password unencrypted in the global `config.xml` file on the Jenkins controller as part of its configuration.

This password can be viewed by users with access to the Jenkins controller file system.

As of publication of this advisory, there is no fix.

## Severity

* SECURITY-1646:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-1900:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)
* SECURITY-1907:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H)
* SECURITY-1918:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H)
* SECURITY-1943:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-1999:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2058:
  [Low](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2084:
  [Low](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2085:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2099:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)
* SECURITY-2101:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)
* SECURITY-2102:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2103:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2104:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2110:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2115:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)
* SECURITY-2117:
  [Critical](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
* SECURITY-2123:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H)
* SECURITY-2126:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N)
* SECURITY-2129:
  [Medium](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)
* SECURITY-2145:
  [High](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N)

## Affected Versions

* **Active Directory
  Plugin**
  up to and including
  2.19
* **Static Analysis Utilities
  Plugin**
  up to and including
  1.96
* **Ansible
  Plugin**
  up to and including
  1.0
* **AppSpider
  Plugin**
  up to and including
  1.0.12
* **AWS Global Configuration
  Plugin**
  up to and including
  1.5
* **Azure Key Vault
  Plugin**
  up to and including
  2.0
* **FindBugs
  Plugin**
  up to and including
  5.0.0
* **Kubernetes
  Plugin**
  up to and including
  1.27.3
* **Mail Commander Plugin for Jenkins-ci
  Plugin**
  up to and including
  1.0.0
* **Mercurial
  Plugin**
  up to and including
  2.11
* **SQLPlus Script Runner
  Plugin**
  up to and including
  2.0.12
* **Subversion
  Plugin**
  up to and including
  2.13.1
* **Visualworks Store
  Plugin**
  up to and including
  1.1.3
* **VMware Lab Manager Slaves
  Plugin**
  up to and including
  0.2.8

## Fix

* **Active Directory
  Plugin**
  should be updated to version
  2.20
* **Ansible
  Plugin**
  should be updated to version
  1.1
* **AppSpider
  Plugin**
  should be updated to version
  1.0.13
* **AWS Global Configuration
  Plugin**
  should be updated to version
  1.6
* **Azure Key Vault
  Plugin**
  should be updated to version
  2.1
* **Kubernetes
  Plugin**
  should be updated to version
  1.27.4
* **Mercurial
  Plugin**
  should be updated to version
  2.12
* **SQLPlus Script Runner
  Plugin**
  should be updated to version
  2.0.13
* **Subversion
  Plugin**
  should be updated to version
  2.13.2
* **Visualworks Store
  Plugin**
  should be updated to version
  1.1.4

These versions include fixes to the vulnerabilities described above. All prior versions are considered to be affected by these vulnerabilities unless otherwise indicated.

As of publication of this advisory, no fixes are available for the following plugins:

* Static Analysis Utilities
  Plugin
* FindBugs
  Plugin
* Mail Commander Plugin for Jenkins-ci
  Plugin
* VMware Lab Manager Slaves
  Plugin

[Learn why we announce these issues.](/security/plugins/#unresolved)

## Credit

The Jenkins project would like to thank the reporters for discovering and
[reporting](/security/#reporting-vulnerabilities)
these vulnerabilities:

* **Chris Maggiulli, Build and Integrations Engineer, Excelsior College**
  for
  SECURITY-2129
* **Daniel Beck, CloudBees, Inc.**
  for
  SECURITY-2117, SECURITY-2145
* **Jeff Thompson, CloudBees, Inc.**
  for
  SECURITY-1900
* **Long Nguyen, Viettel Cyber Security**
  for
  SECURITY-2058, SECURITY-2084, SECURITY-2085
* **Matt Sicker, CloudBees, Inc.**
  for
  SECURITY-1999
* **Vic Chappill, Lee Jones, and Matthew Maylin, Siemens**
  for
  SECURITY-2099
* **Wadeck Follonier, CloudBees, Inc.**
  for
  SECURITY-1907, SECURITY-1918, SECURITY-1943



=== Content from plugins.jenkins.io_2a565a14_20250119_141326.html ===

# Kubernetes

How to install

* [Documentation](/kubernetes/)
* [Releases](/kubernetes/releases/)
* [Issues](/kubernetes/issues/)
* [Dependencies](/kubernetes/dependencies/)
* [Health Score](/kubernetes/healthscore/)

# Kubernetes plugin for Jenkins

[![kubernetes version](https://camo.githubusercontent.com/85afa1b2842e394198054fa2e6048ba5a807ac67adbffd41eabaeef661706e97/68747470733a2f2f696d672e736869656c64732e696f2f6a656e6b696e732f706c7567696e2f762f6b756265726e657465732e7376673f6c6162656c3d6b756265726e65746573)](https://plugins.jenkins.io/kubernetes) [![kubernetes installs](https://camo.githubusercontent.com/09cea8bd749d1a13e8474fb385cf209eb852a9d98cd30460a6af4a4c75a6d8dd/68747470733a2f2f696d672e736869656c64732e696f2f6a656e6b696e732f706c7567696e2f692f6b756265726e657465732e737667)](https://plugins.jenkins.io/kubernetes) [![kubernetes license](https://camo.githubusercontent.com/096973f2dcd020a8be4ef00701e1b05974ce5a4fa9617b10ff94c3fbfb03c091/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6963656e73652f6a656e6b696e7363692f6b756265726e657465732d706c7567696e)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/LICENSE) [![Language grade: Java](https://camo.githubusercontent.com/11df75f1e3d7f5fa1ea57bb82c1020a003587646504d068c3f05231b16ec2dc9/68747470733a2f2f696d672e736869656c64732e696f2f6c67746d2f67726164652f6a6176612f672f6a656e6b696e7363692f6b756265726e657465732d706c7567696e2e7376673f6c6f676f3d6c67746d266c6f676f57696474683d3138)](https://lgtm.com/projects/g/jenkinsci/kubernetes-plugin/context%3Ajava)

Jenkins plugin to run dynamic agents in a Kubernetes cluster.

Based on the [Scaling Docker with Kubernetes](http://www.infoq.com/articles/scaling-docker-with-kubernetes) article, automates the scaling of Jenkins agents running in Kubernetes.

The plugin creates a Kubernetes Pod for each agent started, and stops it after each build.

Agents are launched as inbound agents, so it is expected that the container connects automatically to the Jenkins controller. For that some environment variables are automatically injected:

* `JENKINS_URL` : Jenkins web interface url
* `JENKINS_SECRET` : the secret key for authentication
* `JENKINS_AGENT_NAME` : the name of the Jenkins agent
* `JENKINS_NAME` : the name of the Jenkins agent (Deprecated. Only here for backwards compatibility)

Tested with [`jenkins/inbound-agent`](https://hub.docker.com/r/jenkins/inbound-agent), see the [Docker image source code](https://github.com/jenkinsci/docker-agent).

It is not required to run the Jenkins controller inside Kubernetes.

# 📜 Table of Contents

* [Generic setup](#plugin-content-generic-setup)
* [Usage](#plugin-content-usage)
* [Configuration reference](#plugin-content-configuration-reference)
* [Inheritance](#plugin-content-inheritance)
* [Declarative Pipeline](#plugin-content-declarative-pipeline)
* [Misc.](#plugin-content-misc.)
* [Running on OpenShift](#plugin-content-running-on-openshift)
* [Features controlled using system properties](#plugin-content-features-controlled-using-system-properties)
* [Windows support](#plugin-content-windows-support)
* [Constraints](#plugin-content-constraints)
* [Configuration on minikube](#plugin-content-configuration-on-minikube)
* [Configuration on Google Container Engine](#plugin-content-configuration-on-google-container-engine)
* [Troubleshooting 🔨](#plugin-content-troubleshooting)
* [Building and Testing](#plugin-content-building-and-testing)
* [Docker image](#plugin-content-docker-image)
* [Running in Kubernetes](#plugin-content-running-in-kubernetes)
* [Related Projects](#plugin-content-related-projects)

# Generic Setup

## Prerequisites

* A running Kubernetes cluster 1.14 or later. For OpenShift users, this means OpenShift Container Platform 4.x.
* A Jenkins instance installed
* The Jenkins Kubernetes plugin installed
* A ServiceAccount with sufficient privileges ([example](https://github.com/jenkinsci/kubernetes-plugin/blob/master/src/main/kubernetes/service-account.yml))

## Configuration

Fill in the Kubernetes plugin configuration. In order to do that, you will open the Jenkins UI and navigate to **Manage Jenkins -> Manage Nodes and Clouds -> Configure Clouds -> Add a new cloud -> Kubernetes** and enter the *Kubernetes URL* and *Jenkins URL* appropriately, unless Jenkins is running in Kubernetes in which case the defaults work.

Supported credentials include:

* Username/password
* Secret File (kubeconfig file)
* Secret text (Token-based authentication) (OpenShift)
* Google Service Account from private key (GKE authentication)
* X.509 Client Certificate

If you check **WebSocket** then agents will connect over HTTP(S) rather than the Jenkins service TCP port. This is unnecessary when the Jenkins controller runs in the same Kubernetes cluster, but can greatly simplify setup when agents are in an external cluster and the Jenkins controller is not directly accessible (for example, it is behind a reverse proxy or a ingress resource). See [JEP-222](https://jenkins.io/jep/222) for more.

To test this connection is successful you can use the **Test Connection** button to ensure there is adequate communication from Jenkins to the Kubernetes cluster, as seen below

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/cloud-configuration.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/cloud-configuration.png)

### Garbage collection (beta)

In some exceptional cases, agent pods can be left behind, with no declared Jenkins agent in the controller. They will try to reconnect over and over, until something deletes them.

The plugin provides a garbage collection mechanism to clean up these pods. As it has been introduced recently, and generates extra load on the Kubernetes API server, it is disabled by default.

Feel free to enable it and provide feedback about this functionality.

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/garbage-collection.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/garbage-collection.png)

## Static pod templates

In addition to that, in the **Kubernetes Pod Template** section, we need to configure the image that will be used to spin up the agent pod. The Jenkins agent runs by default in a container named `jnlp` (historical name, kept for backward compatibility).

You may use it, use a different agent container name and/or provide your own container image.

To avoid drift between the Jenkins controller and your agent, we recommend *not* to include the agent JAR in your image, but instead use the *Inject Jenkins agent in agent container* checkbox.

The provided container image must have a JRE installed that is compatible with the Java version required by the Jenkins controller.

In the ‘Kubernetes Pod Template’ section you need to specify the following (the rest of the configuration is up to you): Kubernetes Pod Template Name - can be any and will be shown as a prefix for unique generated agent’ names, which will be run automatically during builds Docker image - the docker image name that will be used as a reference to spin up a new Jenkins agent, as seen below

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/pod-template-configuration.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/pod-template-configuration.png)

> **Note:** If your Jenkins controller is outside the cluster and uses a self-signed HTTPS certificate, you will need some [additional configuration](#plugin-content-using-websockets-with-a-jenkins-master-with-self-signed-https-certificate).

### Restricting what jobs can use your configured cloud

Clouds can be configured to only allow certain jobs to use them.

To enable this, in your cloud's advanced configuration check the `Restrict pipeline support to authorized folders` box. For a job to then use this cloud configuration you will need to add it in the jobs folder's configuration.

# Usage

## Overview

The Kubernetes plugin allocates Jenkins agents in Kubernetes pods.

Within these pods, there is always one special container that is running the Jenkins agent.

Its name defaults to `jnlp`, but you can override the name with one of your choosing in pod template configuration.

Other containers can run arbitrary processes of your choosing, and it is possible to run commands dynamically in any container in the agent pod using the `container` step (pipeline only).

## Using a label

Pod templates defined using the user interface declare a label. When a freestyle job or a pipeline job using `node('some-label')` uses a label declared by a pod template, the Kubernetes Cloud allocates a new pod to run the Jenkins agent.

It should be noted that the main reason to use the global pod template definition is to migrate a huge corpus of existing projects (including freestyle) to run on Kubernetes without changing job definitions. New users setting up new Kubernetes builds should use the `podTemplate` step as shown in the example snippets [here](https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples).

## Using the pipeline step

The `podTemplate` step defines an ephemeral pod template. It is created while the pipeline execution is within the `podTemplate` block. It is immediately deleted afterwards. Such pod templates are not intended to be shared with other builds or projects in the Jenkins instance.

The following idiom creates a pod template with a generated unique label (available as `POD_LABEL`) and runs commands inside it.

```
podTemplate {
    node(POD_LABEL) {
        // pipeline steps...
    }
}
```

Commands will be executed by default in the designated agent container, where the Jenkins agent is running.

This will run in the agent container:

```
podTemplate {
    node(POD_LABEL) {
        stage('Run shell') {
            sh 'echo hello world'
        }
    }
}
```

Find more examples in the [examples dir](https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples).

The default agent image used can be customized by adding it to the template

```
containerTemplate(name: 'jnlp', image: 'jenkins/inbound-agent', args: '${computer.jnlpmac} ${computer.name}'),
```

or with the yaml syntax. Pretty much any field from the [pod model](https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/) can be specified through the yaml syntax.

```
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: jnlp
    image: 'jenkins/inbound-agent'
    args: ['\$(JENKINS_SECRET)', '\$(JENKINS_NAME)']
```

### Multiple containers support

Multiple containers can be defined for the agent pod, with shared resources, like mounts. Ports in each container can be accessed as in any Kubernetes pod, by using `localhost`.

One container must run the Jenkins agent. If unspecified, a container named `jnlp` will be created with the inbound-agent image. The Jenkins agent requires a JRE to run, so you can avoid the extra container by providing a name using the `agentContainer`. To get the Jenkins agent injected, you will also need to set `agentInjection` to `true`, and leave the command and argument fields empty for this container. The container specified by `agentContainer` will be the one where shell steps (or any other step running remote commands on the agent) will run on.

To execute commands in another container part of the pod (different from the one running the Jenkins agent), you can use the `container` step.

## **Note**

## Due to implementation constraints, there can be issues when executing commands in different containers if they run using different uids. It is recommended to use the same uid across the different containers part of the same pod to avoid any issue.

```
podTemplate(
  agentContainer: 'maven',
  agentInjection: true,
  containers: [
    containerTemplate(name: 'maven', image: 'maven:3.9.9-eclipse-temurin-17'),
    containerTemplate(name: 'golang', image: 'golang:1.16.5', command: 'sleep', args: '99d')
  ]) {

    node(POD_LABEL) {
        stage('Get a Maven project') {
            git 'https://github.com/jenkinsci/kubernetes-plugin.git'
            container('maven') {
                stage('Build a Maven project') {
                    sh 'mvn -B -ntp clean install'
                }
            }
        }

        stage('Get a Golang project') {
            git url: 'https://github.com/hashicorp/terraform.git', branch: 'main'
            container('golang') {
                stage('Build a Go project') {
                    sh '''
                    mkdir -p /go/src/github.com/hashicorp
                    ln -s `pwd` /go/src/github.com/hashicorp/terraform
                    cd /go/src/github.com/hashicorp/terraform && make
                    '''
                }
            }
        }

    }
}
```

or

```
podTemplate(
  agentContainer: 'maven',
  agentInjection: true,
  yaml: '''
    apiVersion: v1
    kind: Pod
    spec:
      containers:
      - name: maven
        image: maven:3.9.9-eclipse-temurin-17
      - name: golang
        image: golang:1.16.5
        command:
        - sleep
        args:
        - 99d
''') {
  node(POD_LABEL) {
    stage('Get a Maven project') {
      git 'https://github.com/jenkinsci/kubernetes-plugin.git'
      container('maven') {
        stage('Build a Maven project') {
          sh 'mvn -B -ntp clean install'
        }
      }
    }

    stage('Get a Golang project') {
      git url: 'https://github.com/hashicorp/terraform-provider-google.git', branch: 'main'
      container('golang') {
        stage('Build a Go project') {
          sh '''
            mkdir -p /go/src/github.com/hashicorp
            ln -s `pwd` /go/src/github.com/hashicorp/terraform
            cd /go/src/github.com/hashicorp/terraform && make
          '''
        }
      }
    }
  }
}
```

#### `POD_CONTAINER` variable

The variable `POD_CONTAINER` contains the name of the container in the current context. It is defined only within a `container` block.

```
podTemplate(containers: […]) {
  node(POD_LABEL) {
    stage('Run shell') {
      container('mycontainer') {
        sh "echo hello from $POD_CONTAINER" // displays 'hello from mycontainer'
      }
    }
  }
}
```

### Retrying after infrastructure outages

You can use the `retry` step to automatically try the whole build stage again with a fresh pod in case of fatal infrastructure problems. (For example: cluster backup & restore; node pool used for agents drained and upgraded.)

```
podTemplate(…) {
  retry(count: 2, conditions: [kubernetesAgent(), nonresumable()]) {
    node(POD_LABEL) {
      sh 'your-build-process'
    }
  }
}
```

will rerun the whole `node` block (using the same pod definition) in case the first attempt fails for a qualifying reason traceable to loss of the pod (*not* routine problems such as compilation errors or `OutOfMemoryError`).

For Declarative Pipeline, just add the `retries` option, as shown below.

# Configuration reference

## Pod template

Pod templates are used to create agents. They can be either configured via the user interface, or in a pipeline, using the `podTemplate` step. Either way it provides access to the following fields:

* **cloud** The name of the cloud as defined in Jenkins settings. Defaults to `kubernetes`
* **name** The name of the pod. This is only used for inheritance.
* **namespace** The namespace of the pod.
* **label** The node label. This is how the pod template can be referred to when asking for an agent through the `node` step. In a pipeline, it is recommended to omit this field and rely on the generated label that can be referred to using the `POD_LABEL` variable defined within the `podTemplate` block.
* **yaml** [yaml representation of the Pod](https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/), to allow setting any values not supported as fields
* **yamlMergeStrategy** `merge()` or `override()`. Controls whether the yaml definition overrides or is merged with the yaml definition inherited from pod templates declared with `inheritFrom`. Defaults to `override()` (for backward compatibility reasons).
* **containers** The container templates part of the pod *(see below for details)*.
* **serviceAccount** The service account of the pod.
* **nodeSelector** The node selector of the pod.
* **nodeUsageMode** Either `NORMAL` or `EXCLUSIVE`, this controls whether Jenkins only schedules jobs with label expressions matching or use the node as much as possible.
* **volumes** Volumes that are defined for the pod and are mounted by **ALL** containers.
  + `configMapVolume` : a read only volume that is mounted from a ConfigMap.
  + `dynamicPVC()` : a persistent volume claim managed dynamically. It is deleted at the same time as the pod.
  + `emptyDirVolume` (default): an empty dir allocated on the host machine
  + `hostPathVolume()` : a host path volume
  + `nfsVolume()` : a nfs volume
  + `persistentVolumeClaim()` : an existing persistent volume claim by name.
  + `secretVolume` : a read only volume that is mounted from a Kubernetes secret.
* **envVars** Environment variables that are applied to **ALL** containers.
  + **envVar** An environment variable whose value is defined inline.
  + **secretEnvVar** An environment variable whose value is derived from a Kubernetes secret.
* **imagePullSecrets** List of pull secret names, to [pull images from a private Docker registry](https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/).
* **annotations** Annotations to apply to the pod.
* **inheritFrom** List of one or more pod templates to inherit from *(more details below)*.
* **slaveConnectTimeout** Timeout in seconds for an agent to be online *(more details below)*.
* **podRetention** Controls the behavior of keeping agent pods. Can be 'never()', 'onFailure()', 'always()', or 'default()' - if empty will default to deleting the pod after `activeDeadlineSeconds` has passed.
* **activeDeadlineSeconds** If `podRetention` is set to `never()` or `onFailure()`, the pod is deleted after this deadline is passed.
* **idleMinutes** Allows the pod to remain active for reuse until the configured number of minutes has passed since the last step was executed on it.
* **showRawYaml** Enable or disable the output of the raw pod manifest. Defaults to `true`
* **runAsUser** The user ID to run all containers in the pod as.
* **runAsGroup** The group ID to run all containers in the pod as.
* **hostNetwork** Use the hosts network.
* **workspaceVolume** The type of volume to use for the workspace.
  + `dynamicPVC()` : a persistent volume claim managed dynamically. It is deleted at the same time as the pod.
  + `emptyDirWorkspaceVolume` (default): an empty dir allocated on the host machine
  + `hostPathWorkspaceVolume()` : a host path volume
  + `nfsWorkspaceVolume()` : a nfs volume
  + `persistentVolumeClaimWorkspaceVolume()` : an existing persistent volume claim by name.

## Container template

Container templates are part of pod. They can be configured via the user interface or in a pipeline and allow you to set the following fields:

* **name** The name of the container.
* **image** The image of the container.
* **envVars** Environment variables that are applied to the container **(supplementing and overriding env vars that are set on pod level)**.
  + **envVar** An environment variable whose value is defined inline.
  + **secretEnvVar** An environment variable whose value is derived from a Kubernetes secret.
* **command** The command the container will execute. Will overwrite the Docker entrypoint. A typical value is `sleep`.
* **args** The arguments passed to the command. A typical value is `99999999`.
* **ttyEnabled** Flag to mark that tty should be enabled.
* **livenessProbe** Parameters to be added to a exec liveness probe in the container (does not support httpGet liveness probes)
* **ports** Expose ports on the container.
* **alwaysPullImage** The container will pull the image upon starting.
* **runAsUser** The user ID to run the container as.
* **runAsGroup** The group ID to run the container as.

#### Specifying a different default agent connection timeout

By default, the agent connection timeout is set to 1000 seconds. It can be customized using a system property. Please refer to the section below.

#### Using yaml to define Pod Templates

In order to support any possible value in Kubernetes `Pod` object, we can pass a yaml snippet that will be used as a base for the template. If any other properties are set outside the YAML, they will take precedence.

```
podTemplate(yaml: '''
    apiVersion: v1
    kind: Pod
    metadata:
      labels:
        some-label: some-label-value
    spec:
      containers:
      - name: busybox
        image: busybox
        command:
        - sleep
        args:
        - 99d
    ''') {
    node(POD_LABEL) {
      container('busybox') {
        echo POD_CONTAINER // displays 'busybox'
        sh 'hostname'
      }
    }
}
```

You can use [`readFile`](https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/#readfile-read-file-from-workspace) or [`readTrusted`](https://jenkins.io/doc/pipeline/steps/coding-webhook/#readtrusted-read-trusted-file-from-scm) steps to load the yaml from a file. Also note that in declarative pipelines the `yamlFile` can be used (see this [example](https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/declarative_from_yaml_file)).

##### Example

`pod.yaml`

```
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven
    image: maven:3.9.9-eclipse-temurin-17
    command:
    - sleep
    args:
    - 99d
  - name: golang
    image: golang:1.16.5
    command:
    - sleep
    args:
    - 99d
```

`Jenkinsfile`

```
podTemplate(yaml: readTrusted('pod.yaml')) {
  node(POD_LABEL) {
    // ...
  }
}
```

### Liveness Probe Usage

```
containerTemplate(name: 'busybox', image: 'busybox', command: 'sleep', args: '99d',
                  livenessProbe: containerLivenessProbe(execArgs: 'some --command', initialDelaySeconds: 30, timeoutSeconds: 1, failureThreshold: 3, periodSeconds: 10, successThreshold: 1)
)
```

See [Defining a liveness command](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#defining-a-liveness-command) for more details.

# Inheritance

## Overview

A pod template may or may not inherit from an existing template.

Depending on fields, the inheritance behaviour can vary. For simple values (strings), the child template will override the parent template. However for complex values (lists, maps), the child template will merge with the parent template.

* **yaml** is merged according to the value of `yamlMergeStrategy` specified in the child pod template.
* **Service account** and **Node selector** when are overridden completely substitute any possible value found on the 'parent'.
* **Container templates** that are added to the podTemplate, that has a matching containerTemplate (a container template with the same name) in the 'parent' template, will inherit the configuration of the parent containerTemplate. If no matching container template is found, the template is added as is.
* **Volume** inheritance works exactly as **Container templates**.
* **Image Pull Secrets** are combined (all secrets defined both on 'parent' and 'current' template are used).

In the example below, we will inherit from a pod template we created previously, and will just override the version of `maven` so that it uses Java 21 instead:

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/mypod-1-general.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/mypod-1-general.png) [![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/mypod-2-golang.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/mypod-2-golang.png) [![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/images/mypod-3-maven.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/images/mypod-3-maven.png)

```
podTemplate(inheritFrom: 'mypod', containers: [
    containerTemplate(name: 'maven', image: 'maven:3.9.9-eclipse-temurin-21')
  ]) {
  node(POD_LABEL) {
    …
  }
}
```

Or in declarative pipeline

```
pipeline {
  agent {
    kubernetes {
      inheritFrom 'mypod'
      yaml '''
      spec:
        containers:
        - name: maven
          image: maven:3.9.9-eclipse-temurin-21
'''
      …
    }
  }
  stages {
    …
  }
}
```

Note that we only need to specify the things that are different. So, `command` and `arguments` are not specified, as they are inherited. Also, the `golang` container will be added as defined in the 'parent' template.

## Multiple Pod template inheritance

Field `inheritFrom` may refer a single pod template or multiple separated by space. In the later case each template will be processed in the order they appear in the list *(later items overriding earlier ones)*. In any case if the referenced template is not found it will be ignored.

## Nesting Pod templates

Field `inheritFrom` provides an easy way to compose pod templates that have been pre-configured. In many cases it would be useful to define and compose pod templates directly in the pipeline using groovy. This is made possible via nesting. You can nest multiple pod templates together in order to compose a single one.

The example below composes two different pod templates in order to create one with maven and docker capabilities.

```
podTemplate(containers: [containerTemplate(image: 'docker', name: 'docker', command: 'sleep', args: '99d')]) {
    podTemplate(containers: [containerTemplate(image: 'maven', name: 'maven', command: 'sleep', args: '99d')]) {
      node(POD_LABEL) { // gets a pod with both docker and maven
        …
      }
    }
}
```

This feature is extra useful, pipeline library developers as it allows you to wrap pod templates into functions and let users nest those functions according to their needs.

For example one could create functions for their podTemplates and import them for use. Say here's our file `src/com/foo/utils/PodTemplates.groovy`:

```
package com.foo.utils

public void dockerTemplate(body) {
  podTemplate(
        containers: [containerTemplate(name: 'docker', image: 'docker', command: 'sleep', args: '99d')],
        volumes: [hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')]) {
    body.call()
}
}

public void mavenTemplate(body) {
  podTemplate(
        containers: [containerTemplate(name: 'maven', image: 'maven', command: 'sleep', args: '99d')],
        volumes: [secretVolume(secretName: 'maven-settings', mountPath: '/root/.m2'),
                  persistentVolumeClaim(claimName: 'maven-local-repo', mountPath: '/root/.m2repo')]) {
    body.call()
}
}

return this
```

Then consumers of the library could just express the need for a maven pod with docker capabilities by combining the two, however once again, you will need to express the specific container you wish to execute commands in. You can **NOT** omit the `node` statement.

Note that `POD_LABEL` will be the innermost generated label to get a node which has all the outer pods available on the node, as shown in this example:

```
import com.foo.utils.PodTemplates

podTemplates = new PodTemplates()

podTemplates.dockerTemplate {
  podTemplates.mavenTemplate {
    node(POD_LABEL) {
      container('docker') {
        sh "echo hello from $POD_CONTAINER" // displays 'hello from docker'
      }
      container('maven') {
        sh "echo hello from $POD_CONTAINER" // displays 'hello from maven'
      }
     }
  }
}
```

In scripted pipelines, there are cases where this implicit inheritance via nested declaration is not wanted or another explicit inheritance is preferred. In this case, use `inheritFrom ''` to remove any inheritance, or `inheritFrom 'otherParent'` to override it.

# Declarative Pipeline

Declarative agents can be defined from yaml

```
pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        metadata:
          labels:
            some-label: some-label-value
        spec:
          containers:
          - name: maven
            image: maven:3.9.9-eclipse-temurin-17
            command:
            - cat
            tty: true
          - name: busybox
            image: busybox
            command:
            - cat
            tty: true
        '''
      retries 2
    }
  }
  stages {
    stage('Run maven') {
      steps {
        container('maven') {
          sh 'mvn -version'
        }
        container('busybox') {
          sh '/bin/busybox'
        }
      }
    }
  }
}
```

or using `yamlFile` to keep the pod template in a separate `KubernetesPod.yaml` file

```
pipeline {
  agent {
    kubernetes {
      yamlFile 'KubernetesPod.yaml'
      retries 2
    }
  }
  stages {
    …
  }
}
```

Note that it was previously possible to define `containerTemplate` but that has been deprecated in favor of the yaml format.

```
pipeline {
  agent {
    kubernetes {
      //cloud 'kubernetes'
      containerTemplate {
        name 'maven'
        image 'maven:3.9.9-eclipse-temurin-17'
        command 'sleep'
        args '99d'
      }
    }
  }
  stages {
    …
  }
}
```

Run steps within a container by default. Steps will be nested within an implicit `container(name) {...}` block instead of being executed in the agent container.

```
pipeline {
  agent {
    kubernetes {
      defaultContainer 'maven'
      yamlFile 'KubernetesPod.yaml'
    }
  }

  stages {
    stage('Run maven') {
      steps {
        sh 'mvn -version'
      }
    }
  }
}
```

Run the Pipeline or individual stage within a custom workspace - not required unless explicitly stated.

```
pipeline {
  agent {
    kubernetes {
      customWorkspace 'some/other/path'
      defaultContainer 'maven'
      yamlFile 'KubernetesPod.yaml'
    }
  }

  stages {
    stage('Run maven') {
      steps {
        sh 'mvn -version'
        sh "echo Workspace dir is ${pwd()}"
      }
    }
  }
}
```

## Default inheritance

Unlike scripted k8s template, declarative templates do not inherit from parent template. Since the agents declared at stage level can override a global agent, implicit inheritance was leading to confusion.

You need to explicitly declare the inheritance if necessary using the field `inheritFrom`.

In the following example, `nested-pod` will only contain the `maven` container.

```
pipeline {
  agent {
    kubernetes {
      yaml '''
        spec:
        containers:
        - name: golang
            image: golang:1.16.5
            command:
            - sleep
            args:
            - 99d
        '''
    }
  }
  stages {
    stage('Run maven') {
        agent {
            kubernetes {
                yaml '''
                    spec:
                    containers:
                    - name: maven
                      image: maven:3.9.9-eclipse-temurin-17
                      command:
                      - sleep
                      args:
                      - 99d
                    '''
            }
        }
      steps {
        …
      }
    }
  }
}

```

# Misc.

## Accessing container logs from the pipeline

If you use the `containerTemplate` to run some service in the background (e.g. a database for your integration tests), you might want to access its log from the pipeline. This can be done with the `containerLog` step, which prints the log of the requested container to the build log.

#### Required Parameters

* **name** the name of the container to get logs from, as defined in `podTemplate`. Parameter name can be omitted in simple usage:

```
containerLog 'mongodb'
```

#### Optional Parameters

* **returnLog** return the log instead of printing it to the build log (default: `false`)
* **tailingLines** only return the last n lines of the log (optional)
* **sinceSeconds** only return the last n seconds of the log (optional)
* **limitBytes** limit output to n bytes (from the beginning of the log, not exact).

Also see the online help and [examples/containerLog.groovy](https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/containerLog.groovy).

# Features controlled using system properties

Please read [Features controlled by system properties](https://www.jenkins.io/doc/book/managing/system-properties/) page to know how to set up system properties within Jenkins.

* `KUBERNETES_JENKINS_URL` : Jenkins URL to be used by agents. This is meant to be used for OEM integration.
* `io.jenkins.plugins.kubernetes.disableNoDelayProvisioning` (since 1.19.1) Whether to disable the no-delay provisioning strategy the plugin uses (defaults to `false`).
* `io.jenkins.plugins.kubernetes.NoDelayProvisionerStrategy.disableCloudShuffle` Whether to disable the shuffling of clouds. When true clouds will be searched in order they are defined (defaults to `false`).
* `jenkins.host.address` : (for unit tests) controls the host agents should use to contact Jenkins
* `org.csanchez.jenkins.plugins.kubernetes.PodTemplate.connectionTimeout` : The time in seconds to wait before considering the pod scheduling has failed (defaults to `1000`)
* `org.csanchez.jenkins.plugins.kubernetes.pipeline.ContainerExecDecorator.stdinBufferSize` : stdin buffer size in bytes for commands sent to Kubernetes exec api. A low value will cause slowness in commands executed. A higher value will consume more memory (defaults to `16*1024`)
* `org.csanchez.jenkins.plugins.kubernetes.pipeline.ContainerExecDecorator.websocketConnectionTimeout` : Time to wait for the websocket used by `container` step to connect (defaults to `30`)

# Running on OpenShift

## Random UID problem

OpenShift runs containers using a *random* UID that is overriding what is specified in Docker images. For this reason, you may end up with the following warning in your build

```
[WARNING] HOME is set to / in the agent container. You may encounter troubles when using tools or ssh client. This usually happens if the uid doesnt have any entry in /etc/passwd. Please add a user to your Dockerfile or set the HOME environment variable to a valid directory in the pod template definition.

```

At the moment the jenkinsci agent image is not built for OpenShift and will issue this warning.

This issue can be circumvented in various ways:

* build a docker image for OpenShift in order to behave when running using an arbitrary uid.
* override HOME environment variable in the pod spec to use `/home/jenkins` and mount a volume to `/home/jenkins` to ensure the user running the container can write to it

See this [example](https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/openshift-home-yaml.groovy) configuration.

## Running with OpenShift 3

OpenShift 3 is based on an older version of Kubernetes, which is not anymore directly supported since Kubernetes plugin version 1.26.0.

To get agents working for Openshift 3, add this `Node Selector` to your Pod Templates:

```
beta.kubernetes.io/os=linux

```

# Windows support

You can run pods on Windows if your cluster has Windows nodes. See the [example](https://github.com/jenkinsci/kubernetes-plugin/blob/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples/windows.groovy).

# Configuration on minikube

Create and start [minikube](https://github.com/kubernetes/minikube)

The client certificate needs to be converted to PKCS, will need a password

```
openssl pkcs12 -export -out ~/.minikube/minikube.pfx -inkey ~/.minikube/apiserver.key -in ~/.minikube/apiserver.crt -certfile ~/.minikube/ca.crt -passout pass:secret

```

Validate that the certificates work

```
curl --cacert ~/.minikube/ca.crt --cert ~/.minikube/minikube.pfx:secret --cert-type P12 https://$(minikube ip):8443

```

Add a Jenkins credential of type certificate, upload it from `~/.minikube/minikube.pfx`, password `secret`

Fill *Kubernetes server certificate key* with the contents of `~/.minikube/ca.crt`

# Configuration on Google Container Engine

Create a cluster

```
gcloud container clusters create jenkins --num-nodes 1 --machine-type g1-small

```

and note the admin password and server certificate.

Or use Google Developer Console to create a Container Engine cluster, then run

```
gcloud container clusters get-credentials jenkins
kubectl config view --raw

```

the last command will output kubernetes cluster configuration including API server URL, admin password and root certificate

# Troubleshooting

First watch if the Jenkins agent pods are started. Make sure you are in the correct cluster and namespace.

```
kubectl get -a pods --watch

```

If they are in a different state than `Running`, use `describe` to get the events

```
kubectl describe pods/my-jenkins-agent

```

If they are `Running`, use `logs` to get the log output

```
kubectl logs -f pods/my-jenkins-agent jnlp

```

If pods are not started or for any other error, check the logs on the controller side.

For more detail, configure a new [Jenkins log recorder](https://wiki.jenkins-ci.org/display/JENKINS/Logging) for `org.csanchez.jenkins.plugins.kubernetes` at `ALL` level.

To inspect the json messages sent back and forth to the Kubernetes API server you can configure a new [Jenkins log recorder](https://wiki.jenkins-ci.org/display/JENKINS/Logging) for `okhttp3` at `DEBUG` level.

## Deleting pods in bad state

```
kubectl get pods -o name --selector=jenkins=slave --all-namespaces  | xargs -I {} kubectl delete {}

```

## Pipeline `sh` step hangs when multiple containers are used

To debug this you need to set `-Dorg.jenkinsci.plugins.durabletask.BourneShellScript.LAUNCH_DIAGNOSTICS=true` system property and then restart the pipeline. Most likely in the console log you will see the following:

```
sh: can't create /home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-log.txt: Permission denied
sh: can't create /home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-result.txt.tmp: Permission denied
mv: can't rename '/home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-result.txt.tmp': No such file or directory
touch: /home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-log.txt: Permission denied
touch: /home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-log.txt: Permission denied
touch: /home/jenkins/agent/workspace/thejob@tmp/durable-e0b7cd27/jenkins-log.txt: Permission denied
```

Usually this happens when UID of the user in agent container differs from the one in another container(s). All containers you use should have the same UID of the user, also this can be achieved by setting `securityContext`:

```
apiVersion: v1
kind: Pod
spec:
  securityContext:
    runAsUser: 1000 # default UID of jenkins user in agent image
  containers:
  - name: maven
    image: maven:3.9.9-eclipse-temurin-17
    command:
    - cat
    tty: true
```

## Using WebSockets with a Jenkins controller with self-signed HTTPS certificate

Using WebSockets is the easiest and recommended way to establish the connection between agents and a Jenkins controller running outside the cluster. However, if your Jenkins controller has HTTPS configured with self-signed certificate, you'll need to make sure the agent container trusts the CA. To do that, you can extend the `jenkins/inbound-agent` image and add your certificate as follows:

```
FROM jenkins/inbound-agent

USER root

ADD cert.pem /tmp/cert.pem

RUN keytool -noprompt -storepass changeit -cacerts \
  -import -file /tmp/cert.pem -alias jenkinsMaster && \
  rm -f /tmp/cert.pem

USER jenkins
```

Then, use it as the agent container for the pod template as usual. No command or args need to be specified.

> **Notes:**
>
> * Support for using WebSockets with JDK 11 was added in the Remoting v4.11, so make sure your base image is new enough. See [here](https://issues.jenkins.io/browse/JENKINS-61212) for more information.
> * When using the WebSocket mode, the `-disableHttpsCertValidation` on the `jenkins/inbound-agent` becomes unavailable, as well as `-cert`, and that's why you have to extend the docker image.

## [WARNING] label option is deprecated

```
[WARNING] label option is deprecated. To use a static pod template, use the 'inheritFrom' option.

```

You need to change from something like:

```
agent {
	kubernetes {
		label 'somelabel'
	}
}

```

To something like:

```
agent {
	kubernetes {
		inheritFrom 'somelabel'
	}
}

```

# Building and Testing

Integration tests will use the currently configured context auto-detected from kube config file or service account.

## Manual Testing

Run `mvn clean install` and copy `target/kubernetes.hpi` to Jenkins plugins folder.

## Running Kubernetes Integration Tests

Set up your `$KUBECONFIG` however you like, for example

```
kind create cluster
```

then

```
kubectl krew install tunnel # as needed; install Krew first
kubectl tunnel expose jenkins 8000:8000 8001:8001 &
mvn test -Djenkins.host.address=jenkins.default -Dport=8000 -DslaveAgentPort=8001 -Dtest=KubernetesPipelineTest#runInPod
```

Alternately, you can run everything like in CI:

```
export KIND_PRELOAD=true # optionally
./kind.sh -Dtest=KubernetesPipelineTest#runInPod
```

You can also run interactively after setting up the tunnel:

```
mvn hpi:run -Djenkins.host.address=jenkins.default -Dport=8000 -Djenkins.model.Jenkins.slaveAgentPort=8001
```

# Docker image

Docker image for Jenkins, with plugin installed. Based on the [official image](https://hub.docker.com/r/jenkins/jenkins/).

## Running the Docker image

```
docker run --rm --name jenkins -p 8080:8080 -p 50000:50000 -v /var/jenkins_home csanchez/jenkins-kubernetes
```

# Running in Kubernetes

The example configuration will create a stateful set running Jenkins with persistent volume and using a service account to authenticate to Kubernetes API.

## Running locally with minikube

A local testing cluster with one node can be created with [minikube](https://github.com/kubernetes/minikube)

```
minikube start
```

You may need to set the correct permissions for host mounted volumes

```
minikube ssh
sudo chown 1000:1000 /tmp/hostpath-provisioner/pvc-*
```

Then create the Jenkins namespace, controller and Service with

```
kubectl create namespace kubernetes-plugin
kubectl config set-context $(kubectl config current-context) --namespace=kubernetes-plugin
kubectl create -f src/main/kubernetes/service-account.yml
kubectl create -f src/main/kubernetes/jenkins.yml
```

Get the url to connect to with

```
minikube service jenkins --namespace kubernetes-plugin --url
```

## Running in Google Container Engine GKE

Assuming you created a Kubernetes cluster named `jenkins` this is how to run both Jenkins and agents there.

Creating all the elements and setting the default namespace

```
kubectl create namespace kubernetes-plugin
kubectl config set-context $(kubectl config current-context) --namespace=kubernetes-plugin
kubectl create -f src/main/kubernetes/service-account.yml
kubectl create -f src/main/kubernetes/jenkins.yml
```

Connect to the ip of the network load balancer created by Kubernetes, port 80. Get the ip (in this case `104.197.19.100`) with `kubectl describe services/jenkins` (it may take a bit to populate)

```
$ kubectl describe services/jenkins
Name:           jenkins
Namespace:      default
Labels:         <none>
Selector:       name=jenkins
Type:           LoadBalancer
IP:         10.175.244.232
LoadBalancer Ingress:   104.197.19.100
Port:           http    80/TCP
NodePort:       http    30080/TCP
Endpoints:      10.172.1.5:8080
Port:           agent   50000/TCP
NodePort:       agent   32081/TCP
Endpoints:      10.172.1.5:50000
Session Affinity:   None
No events.

```

Until Kubernetes 1.4 removes the SNATing of source ips, seems that CSRF (enabled by default in Jenkins 2) needs to be configured to avoid `WARNING: No valid crumb was included in request` errors. This can be done checking *Enable proxy compatibility* under Manage Jenkins -> Configure Global Security

Configure Jenkins, adding the `Kubernetes` cloud under configuration, setting Kubernetes URL to the container engine cluster endpoint or simply `https://kubernetes.default.svc.cluster.local`. Under credentials, click `Add` and select `Kubernetes Service Account`, or alternatively use the Kubernetes API username and password. Select 'Certificate' as credentials type if the kubernetes cluster is configured to use client certificates for authentication.

Using `Kubernetes Service Account` will cause the plugin to use the default token mounted inside the Jenkins pod. See [Configure Service Accounts for Pods](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) for more information.

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/credentials.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/credentials.png)

You may want to set `Jenkins URL` to the internal service IP, `http://10.175.244.232` in this case, to connect through the internal network.

Set `Container Cap` to a reasonable number for tests, i.e. 3.

Add an image with

* Docker image: `jenkins/inbound-agent`
* Jenkins agent root directory: `/home/jenkins/agent`

[![image](https://cdn.jsdelivr.net/gh/jenkinsci/kubernetes-plugin@master/configuration.png)](https://github.com/jenkinsci/kubernetes-plugin/blob/master/configuration.png)

Now it is ready to be used.

Tearing it down

```
kubectl delete namespace/kubernetes-plugin
```

## Customizing the deployment

### Modify CPUs and memory request/limits (Kubernetes Resource API)

Modify file `./src/main/kubernetes/jenkins.yml` with desired limits

```
resources:
  limits:
    cpu: 1
    memory: 1Gi
  requests:
    cpu: 0.5
    memory: 500Mi
```

Note: the JVM will use the memory `requests` as the heap limit (-Xmx)

## Building

```
docker build -t csanchez/jenkins-kubernetes .
```

# Related Projects

* [Kubernetes Pipeline plugin](https://github.com/jenkinsci/kubernetes-pipeline-plugin): pipeline extension to provide native support for using Kubernetes pods, secrets and volumes to perform builds
* [kubernetes-credentials](https://github.com/jenkinsci/kubernetes-credentials-plugin): Credentials provider that reads Kubernetes secrets

##### Version: 4306.vc91e951ea\_eb\_d

Released: about a month agoRequires Jenkins 2.426.3ID: kubernetes
##### Installed on 13.2% of controllers

[View detailed version information](https://old.stats.jenkins.io/pluginversions/kubernetes.html)
##### Links

[GitHub](https://github.com/jenkinsci/kubernetes-plugin)[Open issues (Jira)](https://issues.jenkins.io/issues/?jql=resolution%20is%20EMPTY%20and%20component%3D20639)[Report an issue (Jira)](https://www.jenkins.io/participate/report-issue/redirect/#20639/kubernetes)[Pipeline Step Reference](https://www.jenkins.io/doc/pipeline/steps/kubernetes)[Extension Points](https://www.jenkins.io/doc/developer/extensions/kubernetes)[Javadoc](https://javadoc.jenkins.io/plugin/kubernetes)
##### Labels

[Agent Management](/ui/search/?labels=agent)[Cloud Providers](/ui/search/?labels=cloud)[Cluster Management](/ui/search/?labels=cluster)[kubernetes](/ui/search/?labels=kubernetes)
##### Maintainers

[Carlos Sanchez](/ui/search/?query=csanchez)[Vincent Latombe](/ui/search/?query=vlatombe)[Jesse Glick](/ui/search/?query=jglick)[Marky Jackson](/ui/search/?query=jequals5)[Adrien Lecharpentier](/ui/search/?query=alecharp)[Antonio Muñiz](/ui/search/?query=amuniz)[Antoine Neveux](/ui/search/?query=aneveux)[Baptiste Mathus](/ui/search/?query=batmat)[Carroll Chiou](/ui/search/?query=carroll)[Jérôme Pochat](/ui/search/?query=jpochat)[mike cirioli](/ui/search/?query=mikecirioli)[Olivier Lamy](/ui/search/?query=olamy)[Raul Arabaolaza](/ui/search/?query=rarabaolaza)[rsandell](/ui/search/?query=rsandell)[James Nord](/ui/search/?query=teilo)[Thierry Wasylczenko](/ui/search/?query=twasyl)[Francisco Fernández](/ui/search/?query=fcojfernandez)[Pedro Bueno](/ui/search/?query=pbuenoyerbes)[Kenneth Rogers](/ui/search/?query=kerogers)[A. Jard](/ui/search/?query=ajard)
##### Help us improve this page!

To propose a change submit a pull request to [the plugin page](https://github.com/jenkinsci/kubernetes-plugin) on GitHub.
##### Previous Security Warnings

* ###### [Lack of masking of secrets in build log](https://jenkins.io/security/advisory/2018-06-04/#SECURITY-883)

  + Affects version 1.7.0 and earlier
* ###### [CSRF vulnerability and missing permission checks allowed capturing credentials](https://jenkins.io/security/advisory/2018-07-30/#SECURITY-1016)

  + Affects version 1.10.1 and earlier
* ###### [Jenkins controller environment variables accessible](https://www.jenkins.io/security/advisory/2020-11-04/#SECURITY-1646)

  + Affects version 1.27.3 and earlier
* ###### [Missing permission check allows listing pod templates](https://www.jenkins.io/security/advisory/2020-11-04/#SECURITY-2102)

  + Affects version 1.27.3 and earlier
* ###### [Missing permission check allows enumerating credentials IDs](https://www.jenkins.io/security/advisory/2020-11-04/#SECURITY-2103)

  + Affects version 1.27.3 and earlier
* ###### [Improper masking of credentials](https://www.jenkins.io/security/advisory/2023-04-12/#SECURITY-3075)

  + Affects version 3909.v1f2c633e8590 and earlier
![tracker](https://jenkins-matomo.do.g4v.dev/piwik.php?idsite=1&rec=1&url=https://plugins.jenkins.io//kubernetes/)


