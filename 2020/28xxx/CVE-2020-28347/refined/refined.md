```
{
  "vulnerability": {
    "root_cause": "The vulnerability is a command injection within the `sync_wifi_specified` Lua script, where a user-controlled `slave_mac` parameter is incorporated into a JSON string and then passed to `system()` call via `fork_call` function without proper sanitization.",
    "weaknesses": [
      "Command Injection",
      "Insufficient Input Validation"
    ],
    "impact": "Arbitrary command execution as root, allowing complete control of the router.",
    "attack_vectors": "Network-adjacent (LAN) attacker can send specially crafted UDP packets to port 20002, bypassing authentication.",
    "required_capabilities": "Attacker must be on the same LAN as the vulnerable TP-Link router and be able to send UDP packets to it."
  },
  "technical_details": {
   "vulnerable_function": "*onemesh_slave_key_offer* which calls the lua script via *lua_onemesh_call*",
    "vulnerable_code": [
      "```lua\n  179 [-]: GETTABLE  R10 R0 K0    ; R10 := R0[\"mac\"]\n  180 [-]: SETTABLE  R9 K51 R10   ; R9[\"target_id\"] := R10\n  181 [-]: GETUPVAL  R10 U2       ; R10 := U2\n  182 [-]: GETTABLE  R10 R10 K40  ; R10 := R10[\"encode\"]\n  183 [-]: MOVE      R11 R9       ; R11 := R9\n  184 [-]: CALL      R10 2 2      ; R10 := R10(R11)\n  185 [-]: GETUPVAL  R11 U0       ; R11 := U0\n  186 [-]: GETTABLE  R11 R11 K52  ; R11 := R11[\"printf\"]\n  187 [-]: LOADK     R12 K53      ; R12 := \"ubus call sync sync_wifi '\\\"\"\n  188 [-]: MOVE      R13 R10      ; R13 := R10\n  189 [-]: LOADK     R14 K54      ; R14 := \"' &\"\n  190 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)\n  191 [-]: CALL      R11 2 1      ;  := R11(R12)\n  192 [-]: GETUPVAL  R11 U4       ; R11 := U4\n  193 [-]: GETTABLE  R11 R11 K55  ; R11 := R11[\"fork_call\"]\n  194 [-]: LOADK     R12 K53      ; R12 := \"ubus call sync sync_wifi '\\\"\"\n  195 [-]: MOVE      R13 R10      ; R13 := R10\n  196 [-]: LOADK     R14 K54      ; R14 := \"' &\"\n  197 [-]: CONCAT    R12 R12 R14  ; R12 := concat(R12 to R14)\n  198 [-]: CALL      R11 2 1      ;  := R11(R12)\n  199 [-]: LOADBOOL  R11 1 0      ; R11 := true\n  200 [-]: RETURN    R11 2        ; return R11\n  201 [-]: RETURN    R0 1         ; return\n```",
     "```c\n  print_debug(\"tdpOneMesh.c:3363\",\"Sync wifi for specified mac %s start.....\",slaveMac);\n  memset(systemCmd,0,0x200);\n  snprintf(systemCmd,0x1ff,\n    \"lua -e 'require(\\\"luci.controller.admin.onemesh\\\"). \\\n    sync_wifi_specified({mac=\\\"%s\\\"})'\",slaveMac);\n  print_debug(\"tdpOneMesh.c:3368\",\"systemCmd: %s\",systemCmd);\n  system(systemCmd);\n  print_debug(\"tdpOneMesh.c:3370\",\"Sync wifi for specified mac %s end.....\",slaveMac);\n```"
     ],
    "exploitation_strategy": "The exploit involves sending multiple crafted UDP packets to the router. Each packet contains a command injection payload in the `slave_mac` field, which is used to append a single character to a file on the router's filesystem. After the desired command has been constructed character by character, a final packet is sent to execute the command by calling it with 'sh z'",
    "packet_structure": {
        "version": "Fixed to 1",
        "type": "0xf0 for onemesh service",
        "opcode": "6",
        "len": "packet length",
        "flags": "1",
        "unknown": "unspecified",
        "sn": "serial number, can be any value",
        "checksum": "calculated using a custom algorithm",
        "payload": "Encrypted JSON payload"
    },
     "payload_structure": {
        "method": "slave_key_offer",
        "data": {
          "group_id": "arbitrary value",
          "ip": "arbitrary value",
          "slave_mac": "command injection payload",
          "slave_private_account": "arbitrary value",
          "slave_private_password": "arbitrary value",
          "want_to_join": "false",
          "model": "arbitrary value",
          "product_type": "arbitrary value",
          "operation_mode": "arbitrary value"
        }
     },
    "encryption": "AES-CBC with a static key `TPONEMESH_Kf!xn?gj6pMAt-wBNV_TDP` and IV `1234567890abcdef1234567890abcdef` using a 128 bit key"
  }
}
```