=== Content from github.com_1c5c0a8c_20250119_112632.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fe7fd8e4c90be490e4293ec91804d00ec01af5ca6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fe7fd8e4c90be490e4293ec91804d00ec01af5ca6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Checkmk%2Fcheckmk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Checkmk](/Checkmk)
/
**[checkmk](/Checkmk/checkmk)**
Public

* [Notifications](/login?return_to=%2FCheckmk%2Fcheckmk) You must be signed in to change notification settings
* [Fork
  474](/login?return_to=%2FCheckmk%2Fcheckmk)
* [Star
   1.6k](/login?return_to=%2FCheckmk%2Fcheckmk)

* [Code](/Checkmk/checkmk)
* [Pull requests
  35](/Checkmk/checkmk/pulls)
* [Actions](/Checkmk/checkmk/actions)
* [Security](/Checkmk/checkmk/security)
* [Insights](/Checkmk/checkmk/pulse)

Additional navigation options

* [Code](/Checkmk/checkmk)
* [Pull requests](/Checkmk/checkmk/pulls)
* [Actions](/Checkmk/checkmk/actions)
* [Security](/Checkmk/checkmk/security)
* [Insights](/Checkmk/checkmk/pulse)

## Commit

[Permalink](/Checkmk/checkmk/commit/e7fd8e4c90be490e4293ec91804d00ec01af5ca6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent non http/https links from being unescaped

[Browse files](/Checkmk/checkmk/tree/e7fd8e4c90be490e4293ec91804d00ec01af5ca6)
Browse the repository at this point in the history

```
Our permissive HTML escaping is preserving some HTML tags, which includes basic
link tags (a tag with href and optional target attributes). Previous versions
were not inspecting the value of href, which made it possible to add links with
e.g. a "javascript:" protocol. This opened some XSS attack vectors.

After this change it is only possible to link to http and https protocols. All
other links will not be unescaped.

Change-Id: I6e029ecc52f3dd3fc1f213c7f809332e3e49b3ee
```

* Loading branch information

[![@LarsMichelsen](https://avatars.githubusercontent.com/u/2719629?s=40&v=4)](/LarsMichelsen)

[LarsMichelsen](/Checkmk/checkmk/commits?author=LarsMichelsen "View all commits by LarsMichelsen")
committed
Oct 21, 2020

1 parent
[c00f450](/Checkmk/checkmk/commit/c00f450f884d8a229b7d8ab3f0452ed802a1ae04)

commit e7fd8e4

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**14 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cmk/gui

  + cmk/gui/escaping.py
    [escaping.py](#diff-8d362ba63391c20a009c301fa49524a1340d9d768157aa8e15269d289552b4df)
* tests/unit/cmk/gui

  + tests/unit/cmk/gui/test\_htmllib\_Escaper.py
    [test\_htmllib\_Escaper.py](#diff-8f995cd2dc3d59f03f30691d09bf29d6d3b1d3a6020d79ef36119a7ee48251e3)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[cmk/gui/escaping.py](#diff-8d362ba63391c20a009c301fa49524a1340d9d768157aa8e15269d289552b4df "cmk/gui/escaping.py")

Show comments

[View file](/Checkmk/checkmk/blob/e7fd8e4c90be490e4293ec91804d00ec01af5ca6/cmk/gui/escaping.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,6 +7,7 @@ |
|  |  | from html import escape as html\_escape |
|  |  | import re |
|  |  | from typing import Union |
|  |  | from urllib.parse import urlparse |
|  |  |  |
|  |  | from six import ensure\_str |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,6 +114,11 @@ def escape\_text(text: EscapableEntity) -> str: |
|  |  | text = \_UNESCAPER\_TEXT.sub(r'<\1\2>', text) |
|  |  | for a\_href in \_A\_HREF.finditer(text): |
|  |  | href = a\_href.group(1) |
|  |  |  |
|  |  | parsed = urlparse(href) |
|  |  | if parsed.scheme != "" and parsed.scheme not in ["http", "https"]: |
|  |  | continue # Do not unescape links containing disallowed URLs |
|  |  |  |
|  |  | target = a\_href.group(2) |
|  |  |  |
|  |  | if target: |
| Expand Down | |  |

10 changes: 8 additions & 2 deletions

10
[tests/unit/cmk/gui/test\_htmllib\_Escaper.py](#diff-8f995cd2dc3d59f03f30691d09bf29d6d3b1d3a6020d79ef36119a7ee48251e3 "tests/unit/cmk/gui/test_htmllib_Escaper.py")

Show comments

[View file](/Checkmk/checkmk/blob/e7fd8e4c90be490e4293ec91804d00ec01af5ca6/tests/unit/cmk/gui/test_htmllib_Escaper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -72,8 +72,14 @@ def test\_unescape\_attribute(inp, out): |
|  |  | "<a href=\"xyz\">abc</a>&lt;script&gt;alert(1)&lt;/script&gt;<a href=\"xyz\">abc</a>", |
|  |  | ), |
|  |  | ("&nbsp;", None), |
|  |  | # At the moment also javascript URLs are accepted. This will be refused in the next step |
|  |  | ("<a href=\"javascript:alert(1)\">abc</a>", None), |
|  |  | # Only http/https are allowed as schemes |
|  |  | ("<a href=\"http://checkmk.com/\">abc</a>", None), |
|  |  | ("<a href=\"https://checkmk.com/\">abc</a>", None), |
|  |  | ("<a href=\"HTTP://CHECKMK.COM/\">abc</a>", None), |
|  |  | ("<a href=\"ftp://checkmk.com/\">abc</a>", |
|  |  | "&lt;a href=&quot;ftp://checkmk.com/&quot;&gt;abc</a>"), |
|  |  | ("<a href=\"javascript:alert(1)\">abc</a>", |
|  |  | "&lt;a href=&quot;javascript:alert(1)&quot;&gt;abc</a>"), |
|  |  | ]) |
|  |  | def test\_escape\_text(inp, out): |
|  |  | if out is None: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e7fd8e4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fe7fd8e4c90be490e4293ec91804d00ec01af5ca6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_44974a33_20250119_112631.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fc00f450f884d8a229b7d8ab3f0452ed802a1ae04)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fc00f450f884d8a229b7d8ab3f0452ed802a1ae04)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Checkmk%2Fcheckmk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Checkmk](/Checkmk)
/
**[checkmk](/Checkmk/checkmk)**
Public

* [Notifications](/login?return_to=%2FCheckmk%2Fcheckmk) You must be signed in to change notification settings
* [Fork
  474](/login?return_to=%2FCheckmk%2Fcheckmk)
* [Star
   1.6k](/login?return_to=%2FCheckmk%2Fcheckmk)

* [Code](/Checkmk/checkmk)
* [Pull requests
  35](/Checkmk/checkmk/pulls)
* [Actions](/Checkmk/checkmk/actions)
* [Security](/Checkmk/checkmk/security)
* [Insights](/Checkmk/checkmk/pulse)

Additional navigation options

* [Code](/Checkmk/checkmk)
* [Pull requests](/Checkmk/checkmk/pulls)
* [Actions](/Checkmk/checkmk/actions)
* [Security](/Checkmk/checkmk/security)
* [Insights](/Checkmk/checkmk/pulse)

## Commit

[Permalink](/Checkmk/checkmk/commit/c00f450f884d8a229b7d8ab3f0452ed802a1ae04)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Rewrite matching a href unescape regex to separate attributes

[Browse files](/Checkmk/checkmk/tree/c00f450f884d8a229b7d8ab3f0452ed802a1ae04)
Browse the repository at this point in the history

```
The goal of this commit is to separate the values of the href and target
attributes in dedicated match groups. We also exclude the quotes from the
match groups to simplify the code.

Change-Id: I1e64946a1a426d81284b3173db43135ee0d1debc
```

* Loading branch information

[![@LarsMichelsen](https://avatars.githubusercontent.com/u/2719629?s=40&v=4)](/LarsMichelsen)

[LarsMichelsen](/Checkmk/checkmk/commits?author=LarsMichelsen "View all commits by LarsMichelsen")
committed
Oct 21, 2020

1 parent
[1c2e8c2](/Checkmk/checkmk/commit/1c2e8c2f6e49a2a99612f497f41acfc35ee395a6)

commit c00f450

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**18 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cmk/gui

  + cmk/gui/escaping.py
    [escaping.py](#diff-8d362ba63391c20a009c301fa49524a1340d9d768157aa8e15269d289552b4df)
* tests/unit/cmk/gui

  + tests/unit/cmk/gui/test\_htmllib\_Escaper.py
    [test\_htmllib\_Escaper.py](#diff-8f995cd2dc3d59f03f30691d09bf29d6d3b1d3a6020d79ef36119a7ee48251e3)

## There are no files selected for viewing

17 changes: 13 additions & 4 deletions

17
[cmk/gui/escaping.py](#diff-8d362ba63391c20a009c301fa49524a1340d9d768157aa8e15269d289552b4df "cmk/gui/escaping.py")

Show comments

[View file](/Checkmk/checkmk/blob/c00f450f884d8a229b7d8ab3f0452ed802a1ae04/cmk/gui/escaping.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -30,8 +30,9 @@ |
|  |  |  |
|  |  | \_UNESCAPER\_TEXT = re.compile( |
|  |  | r'&lt;(/?)(h1|h2|b|tt|i|u|br(?: /)?|nobr(?: /)?|pre|a|sup|p|li|ul|ol)&gt;') |
|  |  | \_QUOTE = re.compile(r"(?:&quot;|&#x27;)") |
|  |  | \_A\_HREF = re.compile(r'&lt;a href=((?:&quot;|&#x27;).\*?(?:&quot;|&#x27;))&gt;') |
|  |  | \_A\_HREF = re.compile( |
|  |  | r'&lt;a href=(?:(?:&quot;|&#x27;)(.\*?)(?:&quot;|&#x27;))(?: target=(?:(?:&quot;|&#x27;)(.\*?)(?:&quot;|&#x27;)))?&gt;' |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | # TODO: Cleanup the accepted types! |
| Expand Down  Expand Up | | @@ -111,8 +112,16 @@ def escape\_text(text: EscapableEntity) -> str: |
|  |  | text = escape\_attribute(text) |
|  |  | text = \_UNESCAPER\_TEXT.sub(r'<\1\2>', text) |
|  |  | for a\_href in \_A\_HREF.finditer(text): |
|  |  | text = text.replace(a\_href.group(0), u"<a href=%s>" % \_QUOTE.sub(u"\"", a\_href.group(1))) |
|  |  | return text.replace(u"&amp;nbsp;", u"&nbsp;") |
|  |  | href = a\_href.group(1) |
|  |  | target = a\_href.group(2) |
|  |  |  |
|  |  | if target: |
|  |  | unescaped\_tag = "<a href=\"%s\" target=\"%s\">" % (href, target) |
|  |  | else: |
|  |  | unescaped\_tag = "<a href=\"%s\">" % href |
|  |  |  |
|  |  | text = text.replace(a\_href.group(0), unescaped\_tag) |
|  |  | return text.replace("&amp;nbsp;", u"&nbsp;") |
|  |  |  |
|  |  |  |
|  |  | def strip\_scripts(ht: str) -> str: |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[tests/unit/cmk/gui/test\_htmllib\_Escaper.py](#diff-8f995cd2dc3d59f03f30691d09bf29d6d3b1d3a6020d79ef36119a7ee48251e3 "tests/unit/cmk/gui/test_htmllib_Escaper.py")

Show comments

[View file](/Checkmk/checkmk/blob/c00f450f884d8a229b7d8ab3f0452ed802a1ae04/tests/unit/cmk/gui/test_htmllib_Escaper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,6 +56,9 @@ def test\_unescape\_attribute(inp, out): |
|  |  | ("<ol></ol>", None), |
|  |  | ("<a href=\"xyz\">abc</a>", None), |
|  |  | ("<a href=\"xyz\" target=\"123\">abc</a>", None), |
|  |  | # Links with target 1st and href 2nd will not be unescaped |
|  |  | ("<a target=\"123\" href=\"xyz\">abc</a>", |
|  |  | "&lt;a target=&quot;123&quot; href=&quot;xyz&quot;&gt;abc</a>"), |
|  |  | ("blah<a href=\"link0\">aaa</a>blah<a href=\"link1\" target=\"ttt\">bbb</a>", None), |
|  |  | ("\"I am not a link\" target=\"still not a link\"", |
|  |  | "&quot;I am not a link&quot; target=&quot;still not a link&quot;"), |
| Expand All | | @@ -69,6 +72,8 @@ def test\_unescape\_attribute(inp, out): |
|  |  | "<a href=\"xyz\">abc</a>&lt;script&gt;alert(1)&lt;/script&gt;<a href=\"xyz\">abc</a>", |
|  |  | ), |
|  |  | ("&nbsp;", None), |
|  |  | # At the moment also javascript URLs are accepted. This will be refused in the next step |
|  |  | ("<a href=\"javascript:alert(1)\">abc</a>", None), |
|  |  | ]) |
|  |  | def test\_escape\_text(inp, out): |
|  |  | if out is None: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c00f450`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCheckmk%2Fcheckmk%2Fcommit%2Fc00f450f884d8a229b7d8ab3f0452ed802a1ae04) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from emacsninja.com_37ef9ed4_20250119_112630.html ===


* [Index](/index.html)
* [Archive](/posts/index.html)
* [Feed](/feed.atom) ([Emacs](/emacs.atom) [Scheme](/scheme.atom))
* [About](/about.html)
* [Colophon](/colophon.html)
* [Imprint](/imprint.html)
* [Legal](/legal.html)

# CVE-2020-28919: Stored XSS in Checkmk 1.6.0p18

19/12/2021

I’ve discovered a trivial stored XSS vulnerability in Checkmk 1.6.0p18
during an on-site penetration test and disclosed it responsibly to the
tribe29 GmbH. The vendor promptly confirmed the issue, fixed it and
announced an advisory. I’ve applied for a CVE, but didn’t get around
explaining the vulnerability in detail, therefore I’m publishing this
blog post to complete the process.

## Summary

* CVSS Score: 5.4 (Medium)
* CVSS: CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N
* Affected versions: 1.6.0p18 and earlier
* Fixed version: 1.6.0p19, 2.0.0i1
* Vendor advisory: [Werk #11501](https://checkmk.com/werk/11501)
* Affected component: [cmk/gui/htmllib.py:Escaper](https://github.com/tribe29/checkmk/blob/v1.6.0p18/cmk/gui/htmllib.py#L120-L166)
* Bug fix: [87ceb966](https://github.com/tribe29/checkmk/commit/87ceb966b1ae46947b696232af84a4f9f0ab74e1), [e7fd8e4c](https://github.com/tribe29/checkmk/commit/e7fd8e4c90be490e4293ec91804d00ec01af5ca6)

## Impact

The vulnerability requires an authenticated attacker with permission
to configure and share a custom view. Given these prerequisites, they
can inject arbitrary JavaScript into the view title by inserting a
HTML link with a JavaScript URL. If the attacker manages to trick a
user into clicking that link, the JavaScript URL is executed within
the user’s browser context.

There is a CSP policy in place, but it does not mitigate inline
JavaScript code in event handlers, links or script tags. An attacker
could therefore obtain confidential user data or perform UI
redressing.

The vulnerable code has been identified in versions below 1.6.0p18,
such as 1.6.0 and older. It is unclear in which version the
vulnerability has been introduced, therefore it’s recommended to
update to 1.6.0p19/2.0.0i1 or newer.

## Detailed description

The Checkmk GUI code uses a WordPress-style approach to handle HTML:
User input is encoded using HTML entities, then selectively decoded
with a regular expression looking for simple tags. As a special case,
the <a> tag gets its href attribute unescaped as well to
enable hyperlinks. The attribute is not checked for its protocol,
thereby allowing URLs such as javascript:alert(1).

```

class Escaper(object):
    def __init__(self):
        super(Escaper, self).__init__()
        self._unescaper_text = re.compile(
            r'&lt;(/?)(h1|h2|b|tt|i|u|br(?: /)?|nobr(?: /)?|pre|a|sup|p|li|ul|ol)&gt;')
        self._quote = re.compile(r"(?:&quot;|&#x27;)")
        self._a_href = re.compile(r'&lt;a href=((?:&quot;|&#x27;).*?(?:&quot;|&#x27;))&gt;')

    [...]
    def escape_text(self, text):
        if isinstance(text, HTML):
            return "%s" % text  # This is HTML code which must not be escaped

        text = self.escape_attribute(text)
        text = self._unescaper_text.sub(r'<\1\2>', text)
        for a_href in self._a_href.finditer(text):
            text = text.replace(a_href.group(0),
                                "<a href=%s>" % self._quote.sub("\"", a_href.group(1)))
        return text.replace("&amp;nbsp;", "&nbsp;")

```

The above code is used for HTML generation. To exploit it, I started
looking for a HTML form and found that when editing a custom view, no
user input validation is performed on the view title (as opposed to
the view name).

```

def page_edit_visual(what,
                     all_visuals,
                     custom_field_handler=None,
                     create_handler=None,
                     load_handler=None,
                     info_handler=None,
                     sub_pages=None):
    [...]
    html.header(title)
    html.begin_context_buttons()
    back_url = html.get_url_input("back", "edit_%s.py" % what)
    html.context_button(_("Back"), back_url, "back")
    [...]
    vs_general = Dictionary(
        title=_("General Properties"),
        render='form',
        optional_keys=None,
        elements=[
            single_infos_spec(single_infos),
            ('name',
             TextAscii(
                 title=_('Unique ID'),
                 help=_("The ID will be used in URLs that point to a view, e.g. "
                        "<tt>view.py?view_name=<b>myview</b></tt>. It will also be used "
                        "internally for identifying a view. You can create several views "
                        "with the same title but only one per view name. If you create a "
                        "view that has the same view name as a builtin view, then your "
                        "view will override that (shadowing it)."),
                 regex='^[a-zA-Z0-9_]+$',
                 regex_error=_(
                     'The name of the view may only contain letters, digits and underscores.'),
                 size=50,
                 allow_empty=False)),
            ('title', TextUnicode(title=_('Title') + '<sup>*</sup>', size=50, allow_empty=False)),
            [...]
        ],
    )
    [...]

```

## Fix

Checkmk 1.6.0p19 and 2.0.0i1 parses the URL and validates its scheme
against an allowlist before unescaping. JavaScript URLs are therefore
left unescaped and not made clickable:

```

def escape_text(self, text):
    if isinstance(text, HTML):
        return "%s" % text  # This is HTML code which must not be escaped

    text = self.escape_attribute(text)
    text = self._unescaper_text.sub(r'<\1\2>', text)
    for a_href in self._a_href.finditer(text):
        href = a_href.group(1)

        parsed = urlparse.urlparse(href)
        if parsed.scheme != "" and parsed.scheme not in ["http", "https"]:
            continue  # Do not unescape links containing disallowed URLs

        target = a_href.group(2)

        if target:
            unescaped_tag = "<a href=\"%s\" target=\"%s\">" % (href, target)
        else:
            unescaped_tag = "<a href=\"%s\">" % href

        text = text.replace(a_href.group(0), unescaped_tag)
    return text.replace("&amp;nbsp;", "&nbsp;")

```

## Timeline

* 2020-10-11: Initial contact with vendor
* 2020-10-12 - 2020-10-14: Further clarification with vendor
* 2020-10-20: Vendor advisory [Werk #11501](https://checkmk.com/werk/11501) has been released
* 2020-10-26: Vendor notified me about a patch for Checkmk 1.6.0p19
* 2020-11-17: Applied for CVE
* 2020-11-18: Received CVE-2020-28919
* 2021-12-19: Released blog post
* 2022-01-15: NVD published

---



=== Content from checkmk.com_a5d4d85f_20250119_131844.html ===


[back to website](/)

# Werk #11501: Fix possible XSS using titles of views

| Component | User interface |
| --- | --- |
| Title | Fix possible XSS using titles of views |
| Date | Oct 20, 2020 |
| Level | Trivial Change |
| Class | Security Fix |
| Compatibility | Compatible - no manual interaction needed |
| Checkmk versions & editions | | 2.0.0i1 | Checkmk Raw (CRE), Checkmk Enterprise (CEE), Checkmk MSP (CME) | | --- | --- | | 1.6.0p19 | Checkmk Raw (CRE), Checkmk Enterprise (CEE), Checkmk MSP (CME) | |

Authenticated users that are allowed to configure and share custom views
could inject arbitrary JS code to all users which are permitted to view this
view.

[To the list of all Werks](https://checkmk.com/werks)

The Checkmk logo (formerly known as Check\_MK) is a trademark of Checkmk GmbH. ©2024 Checkmk GmbH. All rights reserved.

Update cookie preferences



=== Content from checkmk.com_0bd2f10f_20250119_112625.html ===


[back to website](/)

# Werk #11501: Fix possible XSS using titles of views

| Component | User interface |
| --- | --- |
| Title | Fix possible XSS using titles of views |
| Date | Oct 20, 2020 |
| Level | Trivial Change |
| Class | Security Fix |
| Compatibility | Compatible - no manual interaction needed |
| Checkmk versions & editions | | 2.0.0i1 | Checkmk Raw (CRE), Checkmk Enterprise (CEE), Checkmk MSP (CME) | | --- | --- | | 1.6.0p19 | Checkmk Raw (CRE), Checkmk Enterprise (CEE), Checkmk MSP (CME) | |

Authenticated users that are allowed to configure and share custom views
could inject arbitrary JS code to all users which are permitted to view this
view.

[To the list of all Werks](https://checkmk.com/werks)

The Checkmk logo (formerly known as Check\_MK) is a trademark of Checkmk GmbH. ©2024 Checkmk GmbH. All rights reserved.

Update cookie preferences


