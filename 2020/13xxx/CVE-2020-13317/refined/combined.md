=== Content from gitlab.com_ea8472b4_20250119_110933.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2020](/gitlab-org/cves/-/tree/master/2020)
* [**CVE-2020-13317.json**](/gitlab-org/cves/-/blob/master/2020/CVE-2020-13317.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2020/CVE-2020-13317.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2020/CVE-2020-13317.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Sep 12, 2020

  [e3ab7f4d](/gitlab-org/cves/-/commit/e3ab7f4d3f062346520652372276d42b2cabe932)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/e3ab7f4d3f062346520652372276d42b2cabe932)
  繚
  e3ab7f4d

  [ GitLab Bot ](/gitlab-bot) authored Sep 12, 2020

  e3ab7f4d

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/e3ab7f4d3f062346520652372276d42b2cabe932)
  [ GitLab Bot ](/gitlab-bot) authored Sep 12, 2020

Loading



=== Content from gitlab.com_dafabee3_20250119_110935.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Insufficient Type Check on GraphQL leading to Maintainer delete repository

**[HackerOne report #858671](https://hackerone.com/reports/858671)** by `ledz1996` on 2020-04-24:

### Summary

As you have know, Maintainer cannot delete/archive repository. But via GraphQL, they can do as there exists an insufficient check on GraphQL API

***app/graphql/mutations/snippets/destroy.rb***

```
  def resolve(id:)
        snippet = authorized_find!(id: id)

        response = ::Snippets::DestroyService.new(current_user, snippet).execute
```

The function `authorized_find` lead to `object_from_id!`

***app/graphql/mutations/snippets/base.rb***

```
  def find_object(id:)
        GitlabSchema.object_from_id(id)
      end

      def authorized_resource?(snippet)
        Ability.allowed?(context[:current_user], ability_for(snippet), snippet)
      end

      def ability_for(snippet)
        "#{ability_name}_#{snippet.to_ability_name}".to_sym
      end
```

Here there is no check for whether the Object returned from `find_object` is a Snippet. I could specify any object which the user have permission of

 `"#{ability_name}_#{snippet.to_ability_name}".to_sym` to.

For example: A DiffNote that is created by a Maintainer in the Project as the function.

If I have such a ID:

```
mutation test{
  destroySnippet(input: {id: "gid://gitlab/DiffNote/116"}){
    errors
  }
}
```

It refer to an DiffNote with id `116`

Perfectly, a Maintainer have an `admin_note` and `admin_snippet` on a DiffNote (!!!)

In the mutation Destroy the call to  `::Snippets::DestroyService.new(current_user, snippet)` but the Object of `snippet` is actually a `DiffNote`

***app/services/snippets/destroy\_service.rb***

```
  def attempt_destroy!
      result = Repositories::DestroyService.new(snippet.repository).execute

      raise DestroyError if result[:status] == :error

      snippet.destroy!
    end
```

and in

***app/models/diff\_note.rb***

```
  def repository
    noteable.respond_to?(:repository) ? noteable.repository : project.repository
  end
```

It return the `project.repository` which in turn the Project that the `DestroyService` gonna delete

### Steps to reproduce

1. Create 2 User: User A, User B
2. User A create a project set User B as Maintainer.

   [unauthen1.PNG](https://h1.sec.gitlab.net/a/2d70dc07-e486-4fcc-a26a-ba505881e55c/unauthen1.PNG)
3. User B create 2 branch with the same file but different content

   [unauthen2.PNG](https://h1.sec.gitlab.net/a/feb84362-279d-4a82-ac7b-fc170652d67c/unauthen2.PNG)

   [unauthen3.PNG](https://h1.sec.gitlab.net/a/bc23447d-7b0b-4421-a8a0-01208b8e1274/unauthen3.PNG)
4. Create a merge request for those 2 Branch

   [unauthen4.PNG](https://h1.sec.gitlab.net/a/48cdf91a-e2ce-42a4-a4df-f59c528cdf59/unauthen4.PNG)
5. Create a diff note for the file by clicking at the comment on a line of the file then Submit it

   [unauthen5.PNG](https://h1.sec.gitlab.net/a/b39388b9-d62c-4461-bf7d-2f98dc33def0/unauthen5.PNG)
6. To know the ID of diff note, delete this one, the ID will show up in burp then you will know the ID of the next one

   [unauthen6.PNG](https://h1.sec.gitlab.net/a/6525aacf-dd16-4b27-8c38-e058f12bcc77/unauthen6.PNG)
7. Use the `/-/graphiql-explorer` to execute the following the query

```
mutation test{
  destroySnippet(input: {id: "gid://gitlab/DiffNote/118"}){
    errors
  }
}
```

[unauthen7.PNG](https://h1.sec.gitlab.net/a/4321b09e-c7e8-41f7-9ce5-424c3ec46693/unauthen7.PNG)

8. Enjoy no repository

[unauthen8.PNG](https://h1.sec.gitlab.net/a/3eff281c-a529-4f49-85ab-375306c09432/unauthen8.PNG)

9. If you click on `Create empty repository` It will actually make the Project 404 but It still show up on the User's project feed

[unauthen10.PNG](https://h1.sec.gitlab.net/a/871eaad0-292c-43ed-91e8-913701bd09b2/unauthen10.PNG)

[unauthen9.PNG](https://h1.sec.gitlab.net/a/143f6c77-0f47-4a53-8ef9-09bbf807c8ba/unauthen9.PNG)

### Impact

Unauthorized deleting of repository/project by maintainers

### Output of checks

This bug happens on GitLab.com

## Impact

Unauthorized deleting of repository/project by maintainers

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [unauthen2.PNG](https://h1.sec.gitlab.net/a/feb84362-279d-4a82-ac7b-fc170652d67c/unauthen2.PNG)
* [unauthen1.PNG](https://h1.sec.gitlab.net/a/2d70dc07-e486-4fcc-a26a-ba505881e55c/unauthen1.PNG)
* [unauthen3.PNG](https://h1.sec.gitlab.net/a/bc23447d-7b0b-4421-a8a0-01208b8e1274/unauthen3.PNG)
* [unauthen4.PNG](https://h1.sec.gitlab.net/a/48cdf91a-e2ce-42a4-a4df-f59c528cdf59/unauthen4.PNG)
* [unauthen5.PNG](https://h1.sec.gitlab.net/a/b39388b9-d62c-4461-bf7d-2f98dc33def0/unauthen5.PNG)
* [unauthen6.PNG](https://h1.sec.gitlab.net/a/6525aacf-dd16-4b27-8c38-e058f12bcc77/unauthen6.PNG)
* [unauthen7.PNG](https://h1.sec.gitlab.net/a/4321b09e-c7e8-41f7-9ce5-424c3ec46693/unauthen7.PNG)
* [unauthen8.PNG](https://h1.sec.gitlab.net/a/3eff281c-a529-4f49-85ab-375306c09432/unauthen8.PNG)
* [unauthen10.PNG](https://h1.sec.gitlab.net/a/871eaad0-292c-43ed-91e8-913701bd09b2/unauthen10.PNG)
* [unauthen9.PNG](https://h1.sec.gitlab.net/a/143f6c77-0f47-4a53-8ef9-09bbf807c8ba/unauthen9.PNG)

Edited Jul 17, 2020 by [Brett Walker](/digitalmoksha)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


