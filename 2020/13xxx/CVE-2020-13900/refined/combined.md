=== Content from github.com_83bf6730_20250119_122251.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fblob%2Fv0.10.0%2Fsdp.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fblob%2Fv0.10.0%2Fsdp.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=meetecho%2Fjanus-gateway)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[meetecho](/meetecho)
/
**[janus-gateway](/meetecho/janus-gateway)**
Public

* [Notifications](/login?return_to=%2Fmeetecho%2Fjanus-gateway) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)
* [Star
   8.4k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)

* [Code](/meetecho/janus-gateway/tree/v0.10.0)
* [Issues
  15](/meetecho/janus-gateway/issues)
* [Pull requests
  14](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

Additional navigation options

* [Code](/meetecho/janus-gateway/tree/v0.10.0)
* [Issues](/meetecho/janus-gateway/issues)
* [Pull requests](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

## Files

 v0.10.0
## Breadcrumbs

1. [janus-gateway](/meetecho/janus-gateway/tree/v0.10.0)
/
# sdp.c

Copy path Blame  Blame
## Latest commit

## History

[History](/meetecho/janus-gateway/commits/v0.10.0/sdp.c)1531 lines (1512 loc) · 61.8 KB v0.10.0
## Breadcrumbs

1. [janus-gateway](/meetecho/janus-gateway/tree/v0.10.0)
/
# sdp.c

Top
## File metadata and controls

* Code
* Blame

1531 lines (1512 loc) · 61.8 KB[Raw](https://github.com/meetecho/janus-gateway/raw/refs/tags/v0.10.0/sdp.c)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\*! \file sdp.c \* \author Lorenzo Miniero <lorenzo@meetecho.com> \* \copyright GNU General Public License v3 \* \brief SDP processing \* \details Implementation of an SDP \* parser/merger/generator in the server. Each SDP coming from peers is \* stripped/anonymized before it is passed to the plugins: all \* DTLS/ICE/transport related information is removed, only leaving the \* relevant information in place. SDP coming from plugins is stripped/anonymized \* as well, and merged with the proper DTLS/ICE/transport information before \* it is sent to the peers. The actual SDP processing (parsing SDP strings, \* representation of SDP as an internal format, and so on) is done via \* the tools provided in sdp-utils.h. \* \* \ingroup protocols \* \ref protocols \*/
#include <netdb.h>
#include <gio/gio.h>
#include "janus.h"#include "ice.h"#include "sdp.h"#include "utils.h"#include "ip-utils.h"#include "debug.h"#include "events.h"
/\* Pre-parse SDP: is this SDP valid? how many audio/video lines? any features to take into account? \*/janus\_sdp \*janus\_sdp\_preparse(void \*ice\_handle, const char \*jsep\_sdp, char \*error\_str, size\_t errlen, int \*audio, int \*video, int \*data) { if(!ice\_handle || !jsep\_sdp || !audio || !video || !data) { JANUS\_LOG(LOG\_ERR, " Can't preparse, invalid arguments\n"); return NULL; } janus\_ice\_handle \*handle = (janus\_ice\_handle \*)ice\_handle; janus\_sdp \*parsed\_sdp = janus\_sdp\_parse(jsep\_sdp, error\_str, errlen); if(!parsed\_sdp) { JANUS\_LOG(LOG\_ERR, " Error parsing SDP? %s\n", error\_str ? error\_str : "(unknown reason)"); /\* Invalid SDP \*/ return NULL; } /\* Look for m-lines \*/ GList \*temp = parsed\_sdp->m\_lines; while(temp) { janus\_sdp\_mline \*m = (janus\_sdp\_mline \*)temp->data; if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { \*audio = \*audio + 1; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { \*video = \*video + 1; } /\* Preparse the mid as well \*/ GList \*tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name) { if(!strcasecmp(a->name, "mid")) { /\* Found mid attribute \*/ if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Audio mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return NULL; } if(handle->audio\_mid == NULL) handle->audio\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->audio\_mid; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Video mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return NULL; } if(handle->video\_mid == NULL) handle->video\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->video\_mid; } } } tempA = tempA->next; } temp = temp->next; }#ifdef HAVE\_SCTP \*data = (strstr(jsep\_sdp, "DTLS/SCTP") && !strstr(jsep\_sdp, " 0 DTLS/SCTP") && !strstr(jsep\_sdp, " 0 UDP/DTLS/SCTP")) ? 1 : 0; /\* FIXME This is a really hacky way of checking... \*/#else \*data = 0;#endif
 return parsed\_sdp;}
/\* Parse SDP \*/int janus\_sdp\_process(void \*ice\_handle, janus\_sdp \*remote\_sdp, gboolean update) { if(!ice\_handle || !remote\_sdp) return -1; janus\_ice\_handle \*handle = (janus\_ice\_handle \*)ice\_handle; janus\_ice\_stream \*stream = handle->stream; if(!stream) return -1; gchar \*ruser = NULL, \*rpass = NULL, \*rhashing = NULL, \*rfingerprint = NULL; int audio = 0, video = 0;#ifdef HAVE\_SCTP int data = 0;#endif gboolean rtx = FALSE; /\* Ok, let's start with global attributes \*/ GList \*temp = remote\_sdp->attributes; while(temp) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)temp->data; if(a && a->name) { if(!strcasecmp(a->name, "fingerprint")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Fingerprint (global) : %s\n", handle->handle\_id, a->value); if(strcasestr(a->value, "sha-256 ") == a->value) { rhashing = g\_strdup("sha-256"); rfingerprint = g\_strdup(a->value + strlen("sha-256 ")); } else if(strcasestr(a->value, "sha-1 ") == a->value) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-1 instead of sha-256), but that's ok\n", handle->handle\_id); rhashing = g\_strdup("sha-1"); rfingerprint = g\_strdup(a->value + strlen("sha-1 ")); } else { /\* FIXME We should handle this somehow anyway... OpenSSL supports them all \*/ JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-256/sha-1), \*NOT\* cool\n", handle->handle\_id); } } else if(!strcasecmp(a->name, "ice-ufrag")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE ufrag (global): %s\n", handle->handle\_id, a->value); ruser = g\_strdup(a->value); } else if(!strcasecmp(a->name, "ice-pwd")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE pwd (global): %s\n", handle->handle\_id, a->value); rpass = g\_strdup(a->value); } } temp = temp->next; } /\* Now go on with m-line and their attributes \*/ int mlines = 0; temp = remote\_sdp->m\_lines; while(temp) { mlines++; janus\_sdp\_mline \*m = (janus\_sdp\_mline \*)temp->data; if(m->type == JANUS\_SDP\_AUDIO) { if(handle->rtp\_profile == NULL && m->proto != NULL) handle->rtp\_profile = g\_strdup(m->proto); audio++; if(audio > 1) { temp = temp->next; continue; } if(m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing audio candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO); stream->audio\_ssrc = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ if(stream->audio\_rtcp\_ctx == NULL) { stream->audio\_rtcp\_ctx = g\_malloc0(sizeof(rtcp\_context)); stream->audio\_rtcp\_ctx->tb = 48000; /\* May change later \*/ } } switch(m->direction) { case JANUS\_SDP\_INACTIVE: case JANUS\_SDP\_INVALID: stream->audio\_send = FALSE; stream->audio\_recv = FALSE; break; case JANUS\_SDP\_SENDONLY: /\* A sendonly peer means recvonly for Janus \*/ stream->audio\_send = FALSE; stream->audio\_recv = TRUE; break; case JANUS\_SDP\_RECVONLY: /\* A recvonly peer means sendonly for Janus \*/ stream->audio\_send = TRUE; stream->audio\_recv = FALSE; break; case JANUS\_SDP\_SENDRECV: case JANUS\_SDP\_DEFAULT: default: stream->audio\_send = TRUE; stream->audio\_recv = TRUE; break; } if(m->ptypes != NULL) { g\_list\_free(stream->audio\_payload\_types); stream->audio\_payload\_types = g\_list\_copy(m->ptypes); } } else { /\* Audio rejected? \*/ janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO); JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio rejected by peer...\n", handle->handle\_id); } } else if(m->type == JANUS\_SDP\_VIDEO) { if(handle->rtp\_profile == NULL && m->proto != NULL) handle->rtp\_profile = g\_strdup(m->proto); video++; if(video > 1) { temp = temp->next; continue; } if(m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing video candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO); stream->video\_ssrc = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ if(stream->video\_rtcp\_ctx[0] == NULL) { stream->video\_rtcp\_ctx[0] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[0]->tb = 90000; /\* May change later \*/ } } switch(m->direction) { case JANUS\_SDP\_INACTIVE: case JANUS\_SDP\_INVALID: stream->video\_send = FALSE; stream->video\_recv = FALSE; break; case JANUS\_SDP\_SENDONLY: /\* A sendonly peer means recvonly for Janus \*/ stream->video\_send = FALSE; stream->video\_recv = TRUE; break; case JANUS\_SDP\_RECVONLY: /\* A recvonly peer means sendonly for Janus \*/ stream->video\_send = TRUE; stream->video\_recv = FALSE; break; case JANUS\_SDP\_SENDRECV: case JANUS\_SDP\_DEFAULT: default: stream->video\_send = TRUE; stream->video\_recv = TRUE; break; } if(m->ptypes != NULL) { g\_list\_free(stream->video\_payload\_types); stream->video\_payload\_types = g\_list\_copy(m->ptypes); } } else { /\* Video rejected? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video rejected by peer...\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO); }#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION) { /\* Is this SCTP for DataChannels? \*/ if(!strcasecmp(m->proto, "DTLS/SCTP") || !strcasecmp(m->proto, "UDP/DTLS/SCTP")) { data++; if(data > 1) { temp = temp->next; continue; } if(m->port > 0) { /\* Yep \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing SCTP candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); } if(!strcasecmp(m->proto, "UDP/DTLS/SCTP")) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } else { janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } } else { /\* Data channels rejected? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data channels rejected by peer...\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } } else { /\* Unsupported data channels format. \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data channels format %s unsupported, skipping\n", handle->handle\_id, m->proto); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); }#endif } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Skipping disabled/unsupported media line...\n", handle->handle\_id); } if(stream == NULL) { temp = temp->next; continue; } /\* Look for mid, ICE credentials and fingerprint first: check media attributes \*/ GList \*tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "mid")) { /\* Found mid attribute \*/ if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Audio mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return -2; } if(handle->audio\_mid == NULL) handle->audio\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->audio\_mid; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Video mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return -2; } if(handle->video\_mid == NULL) handle->video\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->video\_mid;#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data Channel mid: %s\n", handle->handle\_id, a->value); if(handle->data\_mid == NULL) handle->data\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->data\_mid;#endif } } else if(!strcasecmp(a->name, "fingerprint")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Fingerprint (local) : %s\n", handle->handle\_id, a->value); if(strcasestr(a->value, "sha-256 ") == a->value) { g\_free(rhashing); /\* FIXME We're overwriting the global one, if any \*/ rhashing = g\_strdup("sha-256"); g\_free(rfingerprint); /\* FIXME We're overwriting the global one, if any \*/ rfingerprint = g\_strdup(a->value + strlen("sha-256 ")); } else if(strcasestr(a->value, "sha-1 ") == a->value) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-1 instead of sha-256), but that's ok\n", handle->handle\_id); g\_free(rhashing); /\* FIXME We're overwriting the global one, if any \*/ rhashing = g\_strdup("sha-1"); g\_free(rfingerprint); /\* FIXME We're overwriting the global one, if any \*/ rfingerprint = g\_strdup(a->value + strlen("sha-1 ")); } else { /\* FIXME We should handle this somehow anyway... OpenSSL supports them all \*/ JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-256), \*NOT\* cool\n", handle->handle\_id); } } else if(!strcasecmp(a->name, "setup")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] DTLS setup (local): %s\n", handle->handle\_id, a->value); if(!update) { if(!strcasecmp(a->value, "actpass") || !strcasecmp(a->value, "passive")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting connect state (DTLS client)\n", handle->handle\_id); stream->dtls\_role = JANUS\_DTLS\_ROLE\_CLIENT; } else if(!strcasecmp(a->value, "active")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting accept state (DTLS server)\n", handle->handle\_id); stream->dtls\_role = JANUS\_DTLS\_ROLE\_SERVER; } if(stream->component && stream->component->dtls) stream->component->dtls->dtls\_role = stream->dtls\_role; } /\* TODO Handle holdconn... \*/ } else if(!strcasecmp(a->name, "ice-ufrag")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE ufrag (local): %s\n", handle->handle\_id, a->value); g\_free(ruser); /\* FIXME We're overwriting the global one, if any \*/ ruser = g\_strdup(a->value); } else if(!strcasecmp(a->name, "ice-pwd")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE pwd (local): %s\n", handle->handle\_id, a->value); g\_free(rpass); /\* FIXME We're overwriting the global one, if any \*/ rpass = g\_strdup(a->value); } } tempA = tempA->next; } if(mlines == 1) { if(!ruser || !rpass || (janus\_is\_webrtc\_encryption\_enabled() && (!rfingerprint || !rhashing))) { /\* Missing mandatory information, failure... \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] SDP missing mandatory information\n", handle->handle\_id); JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] %p, %p, %p, %p\n", handle->handle\_id, ruser, rpass, rfingerprint, rhashing); if(ruser) g\_free(ruser); ruser = NULL; if(rpass) g\_free(rpass); rpass = NULL; if(rhashing) g\_free(rhashing); rhashing = NULL; if(rfingerprint) g\_free(rfingerprint); rfingerprint = NULL; return -2; } /\* If we received the ICE credentials for the first time, enforce them \*/ if(ruser && !stream->ruser && rpass && !stream->rpass) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting remote credentials...\n", handle->handle\_id); if(!nice\_agent\_set\_remote\_credentials(handle->agent, handle->stream\_id, ruser, rpass)) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to set remote credentials!\n", handle->handle\_id); } } else /\* If this is a renegotiation, check if this is an ICE restart \*/ if((ruser && stream->ruser && strcmp(ruser, stream->ruser)) || (rpass && stream->rpass && strcmp(rpass, stream->rpass))) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] ICE restart detected\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_ALL\_TRICKLES); janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_ICE\_RESTART); } /\* Store fingerprint and hashing \*/ if(janus\_is\_webrtc\_encryption\_enabled()) { g\_free(stream->remote\_hashing); stream->remote\_hashing = g\_strdup(rhashing); g\_free(stream->remote\_fingerprint); stream->remote\_fingerprint = g\_strdup(rfingerprint); } /\* Store the ICE username and password for this stream \*/ g\_free(stream->ruser); stream->ruser = g\_strdup(ruser); g\_free(stream->rpass); stream->rpass = g\_strdup(rpass); } /\* Is simulcasting enabled, using rid? (we need to check this before parsing SSRCs) \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && !strcasecmp(a->name, "rid") && a->value) { /\* This attribute is used for simulcasting \*/ char rid[16]; if(sscanf(a->value, "%15s send", rid) != 1) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse rid attribute...\n", handle->handle\_id); } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsed rid: %s\n", handle->handle\_id, rid); if(stream->rid[0] == NULL) { stream->rid[0] = g\_strdup(rid); } else if(stream->rid[1] == NULL) { stream->rid[1] = g\_strdup(rid); } else if(stream->rid[2] == NULL) { stream->rid[2] = g\_strdup(rid); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Too many RTP Stream IDs, ignoring '%s'...\n", handle->handle\_id, rid); } } } else if(a->name && !strcasecmp(a->name, "simulcast") && a->value) { /\* Firefox and Chrome signal simulcast support differently \*/ stream->legacy\_rid = strstr(a->value, "rid=") ? TRUE : FALSE; } tempA = tempA->next; } /\* Let's start figuring out the SSRCs, and any grouping that may be there \*/ stream->audio\_ssrc\_peer\_new = 0; stream->video\_ssrc\_peer\_new[0] = 0; stream->video\_ssrc\_peer\_new[1] = 0; stream->video\_ssrc\_peer\_new[2] = 0; stream->video\_ssrc\_peer\_rtx\_new[0] = 0; stream->video\_ssrc\_peer\_rtx\_new[1] = 0; stream->video\_ssrc\_peer\_rtx\_new[2] = 0; /\* Any SSRC SIM group? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc-group") && strstr(a->value, "SIM")) { int res = janus\_sdp\_parse\_ssrc\_group(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC SIM group attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Any SSRC FID group? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc-group") && strstr(a->value, "FID")) { int res = janus\_sdp\_parse\_ssrc\_group(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC FID group attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Any SSRC in general? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc")) { int res = janus\_sdp\_parse\_ssrc(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Now look for candidates and other info \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name) { if(!strcasecmp(a->name, "candidate")) { if(m->type == JANUS\_SDP\_AUDIO && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is an audio candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id); } else if(m->type == JANUS\_SDP\_VIDEO && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is a video candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id);#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is a SCTP candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id);#endif } else { int res = janus\_sdp\_parse\_candidate(stream, (const char \*)a->value, 0); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse candidate... (%d)\n", handle->handle\_id, res); } } } else if(!strcasecmp(a->name, "rtcp-fb")) { if(a->value && strstr(a->value, "nack") && stream->component) { if(m->type == JANUS\_SDP\_AUDIO) { /\* Enable NACKs for audio \*/ stream->component->do\_audio\_nacks = TRUE; } else if(m->type == JANUS\_SDP\_VIDEO) { /\* Enable NACKs for video \*/ stream->component->do\_video\_nacks = TRUE; } } } else if(!strcasecmp(a->name, "fmtp")) { if(a->value && strstr(a->value, "apt=")) { /\* RFC4588 rtx payload type mapping \*/ int ptype = -1, rtx\_ptype = -1; if(sscanf(a->value, "%d apt=%d", &rtx\_ptype, &ptype) != 2) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse fmtp/apt attribute...\n", handle->handle\_id); } else { rtx = TRUE; janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_RFC4588\_RTX); if(stream->rtx\_payload\_types == NULL) stream->rtx\_payload\_types = g\_hash\_table\_new(NULL, NULL); g\_hash\_table\_insert(stream->rtx\_payload\_types, GINT\_TO\_POINTER(ptype), GINT\_TO\_POINTER(rtx\_ptype)); } } } else if(!strcasecmp(a->name, "rtpmap")) { if(a->value) { int ptype = atoi(a->value); if(ptype > -1) { char \*cr = strchr(a->value, '/'); if(cr != NULL) { cr++; uint32\_t clock\_rate = 0; if(janus\_string\_to\_uint32(cr, &clock\_rate) == 0) { if(stream->clock\_rates == NULL) stream->clock\_rates = g\_hash\_table\_new(NULL, NULL); g\_hash\_table\_insert(stream->clock\_rates, GINT\_TO\_POINTER(ptype), GUINT\_TO\_POINTER(clock\_rate)); } } } } }#ifdef HAVE\_SCTP else if(!strcasecmp(a->name, "sctpmap")) { /\* We don't really care \*/ JANUS\_LOG(LOG\_VERB, "Got a sctpmap attribute: %s\n", a->value); }#endif } tempA = tempA->next; } /\* Any change in SSRCs we should be aware of? \*/ if(m->type == JANUS\_SDP\_AUDIO) { if(stream->audio\_ssrc\_peer\_new > 0) { if(stream->audio\_ssrc\_peer > 0 && stream->audio\_ssrc\_peer != stream->audio\_ssrc\_peer\_new) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Audio SSRC changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, stream->audio\_ssrc\_peer, stream->audio\_ssrc\_peer\_new); /\* FIXME Reset the RTCP context \*/ janus\_ice\_component \*component = stream->component; janus\_mutex\_lock(&component->mutex); if(stream->audio\_rtcp\_ctx) { memset(stream->audio\_rtcp\_ctx, 0, sizeof(\*stream->audio\_rtcp\_ctx)); stream->audio\_rtcp\_ctx->tb = 48000; /\* May change later \*/ } if(component->last\_seqs\_audio) janus\_seq\_list\_free(&component->last\_seqs\_audio); janus\_mutex\_unlock(&component->mutex); } stream->audio\_ssrc\_peer = stream->audio\_ssrc\_peer\_new; stream->audio\_ssrc\_peer\_new = 0; } } else if(m->type == JANUS\_SDP\_VIDEO) { int vindex = 0; for(vindex=0; vindex<3; vindex++) { if(stream->video\_ssrc\_peer\_new[vindex] > 0) { if(stream->video\_ssrc\_peer[vindex] > 0 && stream->video\_ssrc\_peer[vindex] != stream->video\_ssrc\_peer\_new[vindex]) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Video SSRC (#%d) changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, vindex, stream->video\_ssrc\_peer[vindex], stream->video\_ssrc\_peer\_new[vindex]); /\* FIXME Reset the RTCP context \*/ janus\_ice\_component \*component = stream->component; if(component != NULL) { janus\_mutex\_lock(&component->mutex); if(stream->video\_rtcp\_ctx[vindex]) { memset(stream->video\_rtcp\_ctx[vindex], 0, sizeof(\*stream->video\_rtcp\_ctx[vindex])); stream->video\_rtcp\_ctx[vindex]->tb = 90000; } if(component->last\_seqs\_video[vindex]) janus\_seq\_list\_free(&component->last\_seqs\_video[vindex]); janus\_mutex\_unlock(&component->mutex); } } stream->video\_ssrc\_peer[vindex] = stream->video\_ssrc\_peer\_new[vindex]; stream->video\_ssrc\_peer\_new[vindex] = 0; } /\* Do the same with the related rtx SSRC, if any \*/ if(stream->video\_ssrc\_peer\_rtx\_new[vindex] > 0) { if(stream->video\_ssrc\_peer\_rtx[vindex] > 0 && stream->video\_ssrc\_peer\_rtx[vindex] != stream->video\_ssrc\_peer\_rtx\_new[vindex]) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Video SSRC (#%d rtx) changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, vindex, stream->video\_ssrc\_peer\_rtx[vindex], stream->video\_ssrc\_peer\_rtx\_new[vindex]); } stream->video\_ssrc\_peer\_rtx[vindex] = stream->video\_ssrc\_peer\_rtx\_new[vindex]; stream->video\_ssrc\_peer\_rtx\_new[vindex] = 0; if(stream->video\_ssrc\_rtx == 0) stream->video\_ssrc\_rtx = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ } } if(stream->video\_ssrc\_peer[1] && stream->video\_rtcp\_ctx[1] == NULL) { stream->video\_rtcp\_ctx[1] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[1]->tb = 90000; } if(stream->video\_ssrc\_peer[2] && stream->video\_rtcp\_ctx[2] == NULL) { stream->video\_rtcp\_ctx[2] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[2]->tb = 90000; } } temp = temp->next; } /\* Disable RFC4588 if the peer didn't negotiate it \*/ if(!rtx) { janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_RFC4588\_RTX); stream->video\_ssrc\_rtx = 0; } /\* Cleanup \*/ g\_free(ruser); g\_free(rpass); g\_free(rhashing); g\_free(rfingerprint);
 return 0; /\* FIXME Handle errors better \*/}
typedef struct janus\_sdp\_mdns\_candidate { janus\_ice\_handle \*handle; char \*candidate, \*local; GCancellable \*cancellable;} janus\_sdp\_mdns\_candidate;static void janus\_sdp\_mdns\_resolved(GObject \*source\_object, GAsyncResult \*res, gpointer user\_data) { /\* This callback is invoked when the address is resolved \*/ janus\_sdp\_mdns\_candidate \*mc = (janus\_sdp\_mdns\_candidate \*)user\_data; GResolver \*resolver = g\_resolver\_get\_default(); GError \*error = NULL; GList \*list = g\_resolver\_lookup\_by\_name\_finish(resolver, res, &error); if(mc == NULL) { g\_resolver\_free\_addresses(list); g\_object\_unref(resolver); return; } char \*resolved = NULL; if(error != NULL || list == NULL || list->data == NULL) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Error resolving mDNS address (%s): %s\n", mc->handle->handle\_id, mc->local, error ? error->message : "no results"); } else { resolved = g\_inet\_address\_to\_string((GInetAddress \*)list->data); JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] mDNS address (%s) resolved: %s\n", mc->handle->handle\_id, mc->local, resolved); } g\_resolver\_free\_addresses(list); g\_object\_unref(resolver); if(resolved != NULL && mc->handle->stream && mc->handle->app\_handle && !g\_atomic\_int\_get(&mc->handle->app\_handle->stopped) && !g\_atomic\_int\_get(&mc->handle->destroyed)) { /\* Replace the .local address with the resolved one in the candidate string \*/ mc->candidate = janus\_string\_replace(mc->candidate, mc->local, resolved); /\* Parse the candidate again \*/ janus\_mutex\_lock(&mc->handle->mutex); (void)janus\_sdp\_parse\_candidate(mc->handle->stream, mc->candidate, 1); janus\_mutex\_unlock(&mc->handle->mutex); } g\_free(resolved); /\* Get rid of the helper struct \*/ janus\_refcount\_decrease(&mc->handle->ref); g\_free(mc->candidate); g\_free(mc->local); g\_free(mc);}
int janus\_sdp\_parse\_candidate(void \*ice\_stream, const char \*candidate, int trickle) { if(ice\_stream == NULL || candidate == NULL) return -1; janus\_ice\_stream \*stream = (janus\_ice\_stream \*)ice\_stream; janus\_ice\_handle \*handle = stream->handle; if(handle == NULL) return -2; janus\_ice\_component \*component = NULL; if(strlen(candidate) == 0 || strstr(candidate, "end-of-candidates")) { /\* FIXME Should we do something with this? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] end-of-candidates received\n", handle->handle\_id); return 0; } if(strstr(candidate, "candidate:") == candidate) { /\* Skipping the 'candidate:' prefix Firefox puts in trickle candidates \*/ candidate += strlen("candidate:"); } char rfoundation[33], rtransport[4], rip[50], rtype[6], rrelip[40]; guint32 rcomponent, rpriority, rport, rrelport; int res = sscanf(candidate, "%32s %30u %3s %30u %49s %30u typ %5s %\*s %39s %\*s %30u", rfoundation, &rcomponent, rtransport, &rpriority, rip, &rport, rtype, rrelip, &rrelport); if(res < 7) { /\* Failed to parse this address, can it be IPv6? \*/ if(!janus\_ice\_is\_ipv6\_enabled()) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Received IPv6 candidate, but IPv6 support is disabled...\n", handle->handle\_id); return res; } } if(res >= 7) { if(strstr(rip, ".local")) { /\* The IP is actually an mDNS address, try to resolve it \* https://tools.ietf.org/html/draft-ietf-rtcweb-mdns-ice-candidates-04 \*/ if(!janus\_ice\_is\_mdns\_enabled()) { /\* ...unless mDNS resolution is disabled, in which case ignore this candidate \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] mDNS candidate ignored\n", handle->handle\_id); return 0; } /\* We'll resolve this address asynchronously, in order not to keep this thread busy \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Resolving mDNS address (%s) asynchronously\n", handle->handle\_id, rip); janus\_sdp\_mdns\_candidate \*mc = g\_malloc(sizeof(janus\_sdp\_mdns\_candidate)); janus\_refcount\_increase(&handle->ref); mc->handle = handle; mc->candidate = g\_strdup(candidate); mc->local = g\_strdup(rip); mc->cancellable = NULL; GResolver \*resolver = g\_resolver\_get\_default(); g\_resolver\_lookup\_by\_name\_async(resolver, rip, NULL, (GAsyncReadyCallback)janus\_sdp\_mdns\_resolved, mc); return 0; } /\* Add remote candidate \*/ component = stream->component; if(component == NULL || rcomponent > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] -- Skipping component %d in stream %d (rtcp-muxing)\n", handle->handle\_id, rcomponent, stream->stream\_id); } else { //~ if(trickle) { //~ if(component->dtls != NULL) { //~ /\* This component is already ready, ignore this further candidate \*/ //~ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] -- Ignoring this candidate, the component is already ready\n", handle->handle\_id); //~ return 0; //~ } //~ } component->component\_id = rcomponent; component->stream\_id = stream->stream\_id; NiceCandidate \*c = NULL; if(!strcasecmp(rtype, "host")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:host %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_HOST);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_HOST);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "srflx")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:srflx %s:%d --> %s:%d \n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "prflx")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:prflx %s:%d --> %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "relay")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:relay %s:%d --> %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* We only support UDP/TCP/TLS... \*/ if(strcasecmp(rtransport, "udp") && strcasecmp(rtransport, "tcp") && strcasecmp(rtransport, "tls")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } else { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_RELAYED); } } else { /\* FIXME What now? \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Unknown remote candidate type:%s for component:%d stream:%d!\n", handle->handle\_id, rtype, rcomponent, stream->stream\_id); } if(c != NULL) { c->component\_id = rcomponent; c->stream\_id = stream->stream\_id;#ifndef HAVE\_LIBNICE\_TCP c->transport = NICE\_CANDIDATE\_TRANSPORT\_UDP;#else if(!strcasecmp(rtransport, "udp")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Transport: UDP\n", handle->handle\_id); c->transport = NICE\_CANDIDATE\_TRANSPORT\_UDP; } else { /\* Check the type (https://tools.ietf.org/html/rfc6544#section-4.5) \*/ const char \*type = NULL; int ctype = 0; if(strstr(candidate, "tcptype active")) { type = "active"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_ACTIVE; } else if(strstr(candidate, "tcptype passive")) { type = "passive"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_PASSIVE; } else if(strstr(candidate, "tcptype so")) { type = "so"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_SO; } else { /\* TODO: We should actually stop here... \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Missing tcptype info for the TCP candidate!\n", handle->handle\_id); } JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Transport: TCP (%s)\n", handle->handle\_id, type); c->transport = ctype; }#endif g\_strlcpy(c->foundation, rfoundation, NICE\_CANDIDATE\_MAX\_FOUNDATION); c->priority = rpriority; gboolean added = nice\_address\_set\_from\_string(&c->addr, rip); if(!added) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Invalid address '%s', skipping %s candidate (%s)\n", handle->handle\_id, rip, rtype, candidate); nice\_candidate\_free(c); return 0; } nice\_address\_set\_port(&c->addr, rport); if(c->type == NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE || c->type == NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE) { added = nice\_address\_set\_from\_string(&c->base\_addr, rrelip); if(added) nice\_address\_set\_port(&c->base\_addr, rrelport); } else if(c->type == NICE\_CANDIDATE\_TYPE\_RELAYED) { /\* FIXME Do we really need the base address for TURN? \*/ added = nice\_address\_set\_from\_string(&c->base\_addr, rrelip); if(added) nice\_address\_set\_port(&c->base\_addr, rrelport); } if(!added) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Invalid base address '%s', skipping %s candidate (%s)\n", handle->handle\_id, rrelip, rtype, candidate); nice\_candidate\_free(c); return 0; } component->candidates = g\_slist\_append(component->candidates, c); JANUS\_LOG(LOG\_HUGE, "[%"SCNu64"] Candidate added to the list! (%u elements for %d/%d)\n", handle->handle\_id, g\_slist\_length(component->candidates), stream->stream\_id, component->component\_id); /\* Save for the summary, in case we need it \*/ component->remote\_candidates = g\_slist\_append(component->remote\_candidates, g\_strdup(candidate)); /\* Notify event handlers \*/ if(janus\_events\_is\_enabled()) { janus\_session \*session = (janus\_session \*)handle->session; json\_t \*info = json\_object(); json\_object\_set\_new(info, "remote-candidate", json\_string(candidate)); json\_object\_set\_new(info, "stream\_id", json\_integer(stream->stream\_id)); json\_object\_set\_new(info, "component\_id", json\_integer(component->component\_id)); janus\_events\_notify\_handlers(JANUS\_EVENT\_TYPE\_WEBRTC, JANUS\_EVENT\_SUBTYPE\_WEBRTC\_RCAND, session->session\_id, handle->handle\_id, handle->opaque\_id, info); } /\* See if we need to process this \*/ if(trickle) { if(janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_START)) { /\* This is a trickle candidate and ICE has started, we should process it right away \*/ if(!component->process\_started) { /\* Actually, ICE has JUST started for this component, take care of the candidates we've added so far \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE already started for this component, setting candidates we have up to now\n", handle->handle\_id); janus\_ice\_setup\_remote\_candidates(handle, component->stream\_id, component->component\_id); } else { /\* Queue the candidate, we'll process it in the loop \*/ janus\_ice\_add\_remote\_candidate(handle, c); } } else { /\* ICE hasn't started yet: to make sure we're not stuck, also check if we stopped processing the SDP \*/ if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_PROCESSING\_OFFER)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_START); /\* This is a trickle candidate and ICE has started, we should process it right away \*/ if(!component->process\_started) { /\* Actually, ICE has JUST started for this component, take care of the candidates we've added so far \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] SDP processed but ICE not started yet for this component, setting candidates we have up to now\n", handle->handle\_id); janus\_ice\_setup\_remote\_candidates(handle, component->stream\_id, component->component\_id); } else { /\* Queue the candidate, we'll process it in the loop \*/ janus\_ice\_add\_remote\_candidate(handle, c); } } else { /\* Still processing the offer/answer: queue the trickle candidate for now, we'll process it later \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Queueing trickle candidate, status is not START yet\n", handle->handle\_id); } } } } } } else { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse candidate (res=%d)...\n", handle->handle\_id, res); return res; } return 0;}
int janus\_sdp\_parse\_ssrc\_group(void \*ice\_stream, const char \*group\_attr, int video) { if(ice\_stream == NULL || group\_attr == NULL) return -1; janus\_ice\_stream \*stream = (janus\_ice\_stream \*)ice\_stream; janus\_ice\_handle \*handle = stream->handle; if(handle == NULL) return -2; if(!video) return -3; if(stream->rid[0] != NULL) { /\* Simulcasting is rid-based, don't parse SSRCs for now \*/ return 0; } gboolean fid = strstr(group\_attr, "FID") != NULL; gboolean sim = strstr(group\_attr, "SIM") != NULL; guint64 ssrc = 0; guint32 first\_ssrc = 0; gchar \*\*list = g\_strsplit(group\_attr, " ", -1); gchar \*index = list[0]; if(index != NULL) { int i=0; while(index != NULL) { if(i > 0 && strlen(index) > 0) { ssrc = g\_ascii\_strtoull(index, NULL, 0); switch(i) { case 1: first\_ssrc = ssrc; if(stream->video\_ssrc\_peer\_new[0] == ssrc || stream->video\_ssrc\_peer\_new[1] == ssrc || stream->video\_ssrc\_peer\_new[2] == ssrc) { JANUS\_LOG(LOG\_HUGE, "[%"SCNu64"] Already parsed this SSRC: %"SCNu64" (%s group)\n", handle->handle\_id, ssrc, (fid ? "FID" : (sim ? "SIM" : "??"))); } else { if(stream->video\_ssrc\_peer\_new[0] == 0) { stream->video\_ssrc\_peer\_new[0] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC: %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[0]); } else { /\* We already have a video SSRC: check if rid is involved, and we'll keep track of this for simulcasting \*/ if(stream->rid[0]) { if(stream->video\_ssrc\_peer\_new[1] == 0) { stream->video\_ssrc\_peer\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[1]); } else if(stream->video\_ssrc\_peer\_new[2] == 0) { stream->video\_ssrc\_peer\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with video SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } } } } break; case 2: if(fid) { if(stream->video\_ssrc\_peer\_new[0] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[0] == 0) { stream->video\_ssrc\_peer\_rtx\_new[0] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[0]); } else if(stream->video\_ssrc\_peer\_new[1] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[1] == 0) { stream->video\_ssrc\_peer\_rtx\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1 rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[1]); } else if(stream->video\_ssrc\_peer\_new[2] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[2] == 0) { stream->video\_ssrc\_peer\_rtx\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2 rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with rtx SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } } else if(sim) { stream->video\_ssrc\_peer\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[1]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } break; case 3: if(fid) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Found one too many retransmission SSRC (rtx): %"SCNu64"\n", handle->handle\_id, ssrc); } else if(sim) { stream->video\_ssrc\_peer\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } break; default: JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with video SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); break; }[View remainder of file in raw view](https://github.com/meetecho/janus-gateway/raw/refs/tags/v0.10.0/sdp.c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8b7ac850_20250119_140109.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-vqrr-qhj8-882q)

**CVE-2020-13901**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-vqrr-qhj8-882q)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2020-13901](/advisories/GHSA-vqrr-qhj8-882q)

## An issue was discovered in janus-gateway (aka Janus...

High severity

Unreviewed

Published
May 24, 2022
to the GitHub Advisory Database
•
Updated Jan 29, 2023

## Package

No package listed—
[Suggest a package](/advisories/GHSA-vqrr-qhj8-882q/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

An issue was discovered in janus-gateway (aka Janus WebRTC Server) through 0.10.0. janus\_sdp\_merge in sdp.c has a stack-based buffer overflow.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2020-13901>
* [meetecho/janus-gateway#2214](https://github.com/meetecho/janus-gateway/pull/2214)
* <https://github.com/meetecho/janus-gateway/blob/v0.10.0/sdp.c#L1248>
* <https://github.com/merrychap/CVEs/tree/master/CVE-2020-13901>
* <https://github.com/merrychap/poc_exploits/tree/master/janus-webrtc/CVE-2020-13901>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2020-13901)
Jun 10, 2020

Published to the GitHub Advisory Database
May 24, 2022

Last updated
Jan 29, 2023

### Severity

High

### [EPSS score](https://www.first.org/epss/user-guide)

0.729%
 (81st percentile)

### Weaknesses

[CWE-787](/advisories?query=cwe%3A787)

### CVE ID

CVE-2020-13901

### GHSA ID

GHSA-vqrr-qhj8-882q

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-vqrr-qhj8-882q/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_072cccc1_20250119_122249.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fblob%2Fv0.10.0%2Fsdp.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fblob%2Fv0.10.0%2Fsdp.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=meetecho%2Fjanus-gateway)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[meetecho](/meetecho)
/
**[janus-gateway](/meetecho/janus-gateway)**
Public

* [Notifications](/login?return_to=%2Fmeetecho%2Fjanus-gateway) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)
* [Star
   8.4k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)

* [Code](/meetecho/janus-gateway/tree/v0.10.0)
* [Issues
  15](/meetecho/janus-gateway/issues)
* [Pull requests
  14](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

Additional navigation options

* [Code](/meetecho/janus-gateway/tree/v0.10.0)
* [Issues](/meetecho/janus-gateway/issues)
* [Pull requests](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

## Files

 v0.10.0
## Breadcrumbs

1. [janus-gateway](/meetecho/janus-gateway/tree/v0.10.0)
/
# sdp.c

Copy path Blame  Blame
## Latest commit

## History

[History](/meetecho/janus-gateway/commits/v0.10.0/sdp.c)1531 lines (1512 loc) · 61.8 KB v0.10.0
## Breadcrumbs

1. [janus-gateway](/meetecho/janus-gateway/tree/v0.10.0)
/
# sdp.c

Top
## File metadata and controls

* Code
* Blame

1531 lines (1512 loc) · 61.8 KB[Raw](https://github.com/meetecho/janus-gateway/raw/refs/tags/v0.10.0/sdp.c)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\*! \file sdp.c \* \author Lorenzo Miniero <lorenzo@meetecho.com> \* \copyright GNU General Public License v3 \* \brief SDP processing \* \details Implementation of an SDP \* parser/merger/generator in the server. Each SDP coming from peers is \* stripped/anonymized before it is passed to the plugins: all \* DTLS/ICE/transport related information is removed, only leaving the \* relevant information in place. SDP coming from plugins is stripped/anonymized \* as well, and merged with the proper DTLS/ICE/transport information before \* it is sent to the peers. The actual SDP processing (parsing SDP strings, \* representation of SDP as an internal format, and so on) is done via \* the tools provided in sdp-utils.h. \* \* \ingroup protocols \* \ref protocols \*/
#include <netdb.h>
#include <gio/gio.h>
#include "janus.h"#include "ice.h"#include "sdp.h"#include "utils.h"#include "ip-utils.h"#include "debug.h"#include "events.h"
/\* Pre-parse SDP: is this SDP valid? how many audio/video lines? any features to take into account? \*/janus\_sdp \*janus\_sdp\_preparse(void \*ice\_handle, const char \*jsep\_sdp, char \*error\_str, size\_t errlen, int \*audio, int \*video, int \*data) { if(!ice\_handle || !jsep\_sdp || !audio || !video || !data) { JANUS\_LOG(LOG\_ERR, " Can't preparse, invalid arguments\n"); return NULL; } janus\_ice\_handle \*handle = (janus\_ice\_handle \*)ice\_handle; janus\_sdp \*parsed\_sdp = janus\_sdp\_parse(jsep\_sdp, error\_str, errlen); if(!parsed\_sdp) { JANUS\_LOG(LOG\_ERR, " Error parsing SDP? %s\n", error\_str ? error\_str : "(unknown reason)"); /\* Invalid SDP \*/ return NULL; } /\* Look for m-lines \*/ GList \*temp = parsed\_sdp->m\_lines; while(temp) { janus\_sdp\_mline \*m = (janus\_sdp\_mline \*)temp->data; if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { \*audio = \*audio + 1; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { \*video = \*video + 1; } /\* Preparse the mid as well \*/ GList \*tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name) { if(!strcasecmp(a->name, "mid")) { /\* Found mid attribute \*/ if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Audio mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return NULL; } if(handle->audio\_mid == NULL) handle->audio\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->audio\_mid; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Video mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return NULL; } if(handle->video\_mid == NULL) handle->video\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->video\_mid; } } } tempA = tempA->next; } temp = temp->next; }#ifdef HAVE\_SCTP \*data = (strstr(jsep\_sdp, "DTLS/SCTP") && !strstr(jsep\_sdp, " 0 DTLS/SCTP") && !strstr(jsep\_sdp, " 0 UDP/DTLS/SCTP")) ? 1 : 0; /\* FIXME This is a really hacky way of checking... \*/#else \*data = 0;#endif
 return parsed\_sdp;}
/\* Parse SDP \*/int janus\_sdp\_process(void \*ice\_handle, janus\_sdp \*remote\_sdp, gboolean update) { if(!ice\_handle || !remote\_sdp) return -1; janus\_ice\_handle \*handle = (janus\_ice\_handle \*)ice\_handle; janus\_ice\_stream \*stream = handle->stream; if(!stream) return -1; gchar \*ruser = NULL, \*rpass = NULL, \*rhashing = NULL, \*rfingerprint = NULL; int audio = 0, video = 0;#ifdef HAVE\_SCTP int data = 0;#endif gboolean rtx = FALSE; /\* Ok, let's start with global attributes \*/ GList \*temp = remote\_sdp->attributes; while(temp) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)temp->data; if(a && a->name) { if(!strcasecmp(a->name, "fingerprint")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Fingerprint (global) : %s\n", handle->handle\_id, a->value); if(strcasestr(a->value, "sha-256 ") == a->value) { rhashing = g\_strdup("sha-256"); rfingerprint = g\_strdup(a->value + strlen("sha-256 ")); } else if(strcasestr(a->value, "sha-1 ") == a->value) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-1 instead of sha-256), but that's ok\n", handle->handle\_id); rhashing = g\_strdup("sha-1"); rfingerprint = g\_strdup(a->value + strlen("sha-1 ")); } else { /\* FIXME We should handle this somehow anyway... OpenSSL supports them all \*/ JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-256/sha-1), \*NOT\* cool\n", handle->handle\_id); } } else if(!strcasecmp(a->name, "ice-ufrag")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE ufrag (global): %s\n", handle->handle\_id, a->value); ruser = g\_strdup(a->value); } else if(!strcasecmp(a->name, "ice-pwd")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE pwd (global): %s\n", handle->handle\_id, a->value); rpass = g\_strdup(a->value); } } temp = temp->next; } /\* Now go on with m-line and their attributes \*/ int mlines = 0; temp = remote\_sdp->m\_lines; while(temp) { mlines++; janus\_sdp\_mline \*m = (janus\_sdp\_mline \*)temp->data; if(m->type == JANUS\_SDP\_AUDIO) { if(handle->rtp\_profile == NULL && m->proto != NULL) handle->rtp\_profile = g\_strdup(m->proto); audio++; if(audio > 1) { temp = temp->next; continue; } if(m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing audio candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO); stream->audio\_ssrc = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ if(stream->audio\_rtcp\_ctx == NULL) { stream->audio\_rtcp\_ctx = g\_malloc0(sizeof(rtcp\_context)); stream->audio\_rtcp\_ctx->tb = 48000; /\* May change later \*/ } } switch(m->direction) { case JANUS\_SDP\_INACTIVE: case JANUS\_SDP\_INVALID: stream->audio\_send = FALSE; stream->audio\_recv = FALSE; break; case JANUS\_SDP\_SENDONLY: /\* A sendonly peer means recvonly for Janus \*/ stream->audio\_send = FALSE; stream->audio\_recv = TRUE; break; case JANUS\_SDP\_RECVONLY: /\* A recvonly peer means sendonly for Janus \*/ stream->audio\_send = TRUE; stream->audio\_recv = FALSE; break; case JANUS\_SDP\_SENDRECV: case JANUS\_SDP\_DEFAULT: default: stream->audio\_send = TRUE; stream->audio\_recv = TRUE; break; } if(m->ptypes != NULL) { g\_list\_free(stream->audio\_payload\_types); stream->audio\_payload\_types = g\_list\_copy(m->ptypes); } } else { /\* Audio rejected? \*/ janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_AUDIO); JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio rejected by peer...\n", handle->handle\_id); } } else if(m->type == JANUS\_SDP\_VIDEO) { if(handle->rtp\_profile == NULL && m->proto != NULL) handle->rtp\_profile = g\_strdup(m->proto); video++; if(video > 1) { temp = temp->next; continue; } if(m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing video candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO); stream->video\_ssrc = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ if(stream->video\_rtcp\_ctx[0] == NULL) { stream->video\_rtcp\_ctx[0] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[0]->tb = 90000; /\* May change later \*/ } } switch(m->direction) { case JANUS\_SDP\_INACTIVE: case JANUS\_SDP\_INVALID: stream->video\_send = FALSE; stream->video\_recv = FALSE; break; case JANUS\_SDP\_SENDONLY: /\* A sendonly peer means recvonly for Janus \*/ stream->video\_send = FALSE; stream->video\_recv = TRUE; break; case JANUS\_SDP\_RECVONLY: /\* A recvonly peer means sendonly for Janus \*/ stream->video\_send = TRUE; stream->video\_recv = FALSE; break; case JANUS\_SDP\_SENDRECV: case JANUS\_SDP\_DEFAULT: default: stream->video\_send = TRUE; stream->video\_recv = TRUE; break; } if(m->ptypes != NULL) { g\_list\_free(stream->video\_payload\_types); stream->video\_payload\_types = g\_list\_copy(m->ptypes); } } else { /\* Video rejected? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video rejected by peer...\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_HAS\_VIDEO); }#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION) { /\* Is this SCTP for DataChannels? \*/ if(!strcasecmp(m->proto, "DTLS/SCTP") || !strcasecmp(m->proto, "UDP/DTLS/SCTP")) { data++; if(data > 1) { temp = temp->next; continue; } if(m->port > 0) { /\* Yep \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsing SCTP candidates (stream=%d)...\n", handle->handle\_id, stream->stream\_id); if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); } if(!strcasecmp(m->proto, "UDP/DTLS/SCTP")) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } else { janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } } else { /\* Data channels rejected? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data channels rejected by peer...\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); } } else { /\* Unsupported data channels format. \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data channels format %s unsupported, skipping\n", handle->handle\_id, m->proto); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_DATA\_CHANNELS); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_NEW\_DATACHAN\_SDP); }#endif } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Skipping disabled/unsupported media line...\n", handle->handle\_id); } if(stream == NULL) { temp = temp->next; continue; } /\* Look for mid, ICE credentials and fingerprint first: check media attributes \*/ GList \*tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "mid")) { /\* Found mid attribute \*/ if(m->type == JANUS\_SDP\_AUDIO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Audio mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Audio mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return -2; } if(handle->audio\_mid == NULL) handle->audio\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->audio\_mid; } else if(m->type == JANUS\_SDP\_VIDEO && m->port > 0) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Video mid: %s\n", handle->handle\_id, a->value); if(strlen(a->value) > 16) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Video mid too large: (%zu > 16)\n", handle->handle\_id, strlen(a->value)); return -2; } if(handle->video\_mid == NULL) handle->video\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->video\_mid;#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Data Channel mid: %s\n", handle->handle\_id, a->value); if(handle->data\_mid == NULL) handle->data\_mid = g\_strdup(a->value); if(handle->stream\_mid == NULL) handle->stream\_mid = handle->data\_mid;#endif } } else if(!strcasecmp(a->name, "fingerprint")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Fingerprint (local) : %s\n", handle->handle\_id, a->value); if(strcasestr(a->value, "sha-256 ") == a->value) { g\_free(rhashing); /\* FIXME We're overwriting the global one, if any \*/ rhashing = g\_strdup("sha-256"); g\_free(rfingerprint); /\* FIXME We're overwriting the global one, if any \*/ rfingerprint = g\_strdup(a->value + strlen("sha-256 ")); } else if(strcasestr(a->value, "sha-1 ") == a->value) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-1 instead of sha-256), but that's ok\n", handle->handle\_id); g\_free(rhashing); /\* FIXME We're overwriting the global one, if any \*/ rhashing = g\_strdup("sha-1"); g\_free(rfingerprint); /\* FIXME We're overwriting the global one, if any \*/ rfingerprint = g\_strdup(a->value + strlen("sha-1 ")); } else { /\* FIXME We should handle this somehow anyway... OpenSSL supports them all \*/ JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Hashing algorithm not the one we expected (sha-256), \*NOT\* cool\n", handle->handle\_id); } } else if(!strcasecmp(a->name, "setup")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] DTLS setup (local): %s\n", handle->handle\_id, a->value); if(!update) { if(!strcasecmp(a->value, "actpass") || !strcasecmp(a->value, "passive")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting connect state (DTLS client)\n", handle->handle\_id); stream->dtls\_role = JANUS\_DTLS\_ROLE\_CLIENT; } else if(!strcasecmp(a->value, "active")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting accept state (DTLS server)\n", handle->handle\_id); stream->dtls\_role = JANUS\_DTLS\_ROLE\_SERVER; } if(stream->component && stream->component->dtls) stream->component->dtls->dtls\_role = stream->dtls\_role; } /\* TODO Handle holdconn... \*/ } else if(!strcasecmp(a->name, "ice-ufrag")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE ufrag (local): %s\n", handle->handle\_id, a->value); g\_free(ruser); /\* FIXME We're overwriting the global one, if any \*/ ruser = g\_strdup(a->value); } else if(!strcasecmp(a->name, "ice-pwd")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE pwd (local): %s\n", handle->handle\_id, a->value); g\_free(rpass); /\* FIXME We're overwriting the global one, if any \*/ rpass = g\_strdup(a->value); } } tempA = tempA->next; } if(mlines == 1) { if(!ruser || !rpass || (janus\_is\_webrtc\_encryption\_enabled() && (!rfingerprint || !rhashing))) { /\* Missing mandatory information, failure... \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] SDP missing mandatory information\n", handle->handle\_id); JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] %p, %p, %p, %p\n", handle->handle\_id, ruser, rpass, rfingerprint, rhashing); if(ruser) g\_free(ruser); ruser = NULL; if(rpass) g\_free(rpass); rpass = NULL; if(rhashing) g\_free(rhashing); rhashing = NULL; if(rfingerprint) g\_free(rfingerprint); rfingerprint = NULL; return -2; } /\* If we received the ICE credentials for the first time, enforce them \*/ if(ruser && !stream->ruser && rpass && !stream->rpass) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Setting remote credentials...\n", handle->handle\_id); if(!nice\_agent\_set\_remote\_credentials(handle->agent, handle->stream\_id, ruser, rpass)) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to set remote credentials!\n", handle->handle\_id); } } else /\* If this is a renegotiation, check if this is an ICE restart \*/ if((ruser && stream->ruser && strcmp(ruser, stream->ruser)) || (rpass && stream->rpass && strcmp(rpass, stream->rpass))) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] ICE restart detected\n", handle->handle\_id); janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_ALL\_TRICKLES); janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_ICE\_RESTART); } /\* Store fingerprint and hashing \*/ if(janus\_is\_webrtc\_encryption\_enabled()) { g\_free(stream->remote\_hashing); stream->remote\_hashing = g\_strdup(rhashing); g\_free(stream->remote\_fingerprint); stream->remote\_fingerprint = g\_strdup(rfingerprint); } /\* Store the ICE username and password for this stream \*/ g\_free(stream->ruser); stream->ruser = g\_strdup(ruser); g\_free(stream->rpass); stream->rpass = g\_strdup(rpass); } /\* Is simulcasting enabled, using rid? (we need to check this before parsing SSRCs) \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && !strcasecmp(a->name, "rid") && a->value) { /\* This attribute is used for simulcasting \*/ char rid[16]; if(sscanf(a->value, "%15s send", rid) != 1) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse rid attribute...\n", handle->handle\_id); } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Parsed rid: %s\n", handle->handle\_id, rid); if(stream->rid[0] == NULL) { stream->rid[0] = g\_strdup(rid); } else if(stream->rid[1] == NULL) { stream->rid[1] = g\_strdup(rid); } else if(stream->rid[2] == NULL) { stream->rid[2] = g\_strdup(rid); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Too many RTP Stream IDs, ignoring '%s'...\n", handle->handle\_id, rid); } } } else if(a->name && !strcasecmp(a->name, "simulcast") && a->value) { /\* Firefox and Chrome signal simulcast support differently \*/ stream->legacy\_rid = strstr(a->value, "rid=") ? TRUE : FALSE; } tempA = tempA->next; } /\* Let's start figuring out the SSRCs, and any grouping that may be there \*/ stream->audio\_ssrc\_peer\_new = 0; stream->video\_ssrc\_peer\_new[0] = 0; stream->video\_ssrc\_peer\_new[1] = 0; stream->video\_ssrc\_peer\_new[2] = 0; stream->video\_ssrc\_peer\_rtx\_new[0] = 0; stream->video\_ssrc\_peer\_rtx\_new[1] = 0; stream->video\_ssrc\_peer\_rtx\_new[2] = 0; /\* Any SSRC SIM group? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc-group") && strstr(a->value, "SIM")) { int res = janus\_sdp\_parse\_ssrc\_group(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC SIM group attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Any SSRC FID group? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc-group") && strstr(a->value, "FID")) { int res = janus\_sdp\_parse\_ssrc\_group(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC FID group attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Any SSRC in general? \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name && a->value) { if(!strcasecmp(a->name, "ssrc")) { int res = janus\_sdp\_parse\_ssrc(stream, (const char \*)a->value, m->type == JANUS\_SDP\_VIDEO); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse SSRC attribute... (%d)\n", handle->handle\_id, res); } } } tempA = tempA->next; } /\* Now look for candidates and other info \*/ tempA = m->attributes; while(tempA) { janus\_sdp\_attribute \*a = (janus\_sdp\_attribute \*)tempA->data; if(a->name) { if(!strcasecmp(a->name, "candidate")) { if(m->type == JANUS\_SDP\_AUDIO && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is an audio candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id); } else if(m->type == JANUS\_SDP\_VIDEO && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is a video candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id);#ifdef HAVE\_SCTP } else if(m->type == JANUS\_SDP\_APPLICATION && mlines > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] This is a SCTP candidate but we're bundling on another stream, ignoring...\n", handle->handle\_id);#endif } else { int res = janus\_sdp\_parse\_candidate(stream, (const char \*)a->value, 0); if(res != 0) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse candidate... (%d)\n", handle->handle\_id, res); } } } else if(!strcasecmp(a->name, "rtcp-fb")) { if(a->value && strstr(a->value, "nack") && stream->component) { if(m->type == JANUS\_SDP\_AUDIO) { /\* Enable NACKs for audio \*/ stream->component->do\_audio\_nacks = TRUE; } else if(m->type == JANUS\_SDP\_VIDEO) { /\* Enable NACKs for video \*/ stream->component->do\_video\_nacks = TRUE; } } } else if(!strcasecmp(a->name, "fmtp")) { if(a->value && strstr(a->value, "apt=")) { /\* RFC4588 rtx payload type mapping \*/ int ptype = -1, rtx\_ptype = -1; if(sscanf(a->value, "%d apt=%d", &rtx\_ptype, &ptype) != 2) { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse fmtp/apt attribute...\n", handle->handle\_id); } else { rtx = TRUE; janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_RFC4588\_RTX); if(stream->rtx\_payload\_types == NULL) stream->rtx\_payload\_types = g\_hash\_table\_new(NULL, NULL); g\_hash\_table\_insert(stream->rtx\_payload\_types, GINT\_TO\_POINTER(ptype), GINT\_TO\_POINTER(rtx\_ptype)); } } } else if(!strcasecmp(a->name, "rtpmap")) { if(a->value) { int ptype = atoi(a->value); if(ptype > -1) { char \*cr = strchr(a->value, '/'); if(cr != NULL) { cr++; uint32\_t clock\_rate = 0; if(janus\_string\_to\_uint32(cr, &clock\_rate) == 0) { if(stream->clock\_rates == NULL) stream->clock\_rates = g\_hash\_table\_new(NULL, NULL); g\_hash\_table\_insert(stream->clock\_rates, GINT\_TO\_POINTER(ptype), GUINT\_TO\_POINTER(clock\_rate)); } } } } }#ifdef HAVE\_SCTP else if(!strcasecmp(a->name, "sctpmap")) { /\* We don't really care \*/ JANUS\_LOG(LOG\_VERB, "Got a sctpmap attribute: %s\n", a->value); }#endif } tempA = tempA->next; } /\* Any change in SSRCs we should be aware of? \*/ if(m->type == JANUS\_SDP\_AUDIO) { if(stream->audio\_ssrc\_peer\_new > 0) { if(stream->audio\_ssrc\_peer > 0 && stream->audio\_ssrc\_peer != stream->audio\_ssrc\_peer\_new) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Audio SSRC changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, stream->audio\_ssrc\_peer, stream->audio\_ssrc\_peer\_new); /\* FIXME Reset the RTCP context \*/ janus\_ice\_component \*component = stream->component; janus\_mutex\_lock(&component->mutex); if(stream->audio\_rtcp\_ctx) { memset(stream->audio\_rtcp\_ctx, 0, sizeof(\*stream->audio\_rtcp\_ctx)); stream->audio\_rtcp\_ctx->tb = 48000; /\* May change later \*/ } if(component->last\_seqs\_audio) janus\_seq\_list\_free(&component->last\_seqs\_audio); janus\_mutex\_unlock(&component->mutex); } stream->audio\_ssrc\_peer = stream->audio\_ssrc\_peer\_new; stream->audio\_ssrc\_peer\_new = 0; } } else if(m->type == JANUS\_SDP\_VIDEO) { int vindex = 0; for(vindex=0; vindex<3; vindex++) { if(stream->video\_ssrc\_peer\_new[vindex] > 0) { if(stream->video\_ssrc\_peer[vindex] > 0 && stream->video\_ssrc\_peer[vindex] != stream->video\_ssrc\_peer\_new[vindex]) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Video SSRC (#%d) changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, vindex, stream->video\_ssrc\_peer[vindex], stream->video\_ssrc\_peer\_new[vindex]); /\* FIXME Reset the RTCP context \*/ janus\_ice\_component \*component = stream->component; if(component != NULL) { janus\_mutex\_lock(&component->mutex); if(stream->video\_rtcp\_ctx[vindex]) { memset(stream->video\_rtcp\_ctx[vindex], 0, sizeof(\*stream->video\_rtcp\_ctx[vindex])); stream->video\_rtcp\_ctx[vindex]->tb = 90000; } if(component->last\_seqs\_video[vindex]) janus\_seq\_list\_free(&component->last\_seqs\_video[vindex]); janus\_mutex\_unlock(&component->mutex); } } stream->video\_ssrc\_peer[vindex] = stream->video\_ssrc\_peer\_new[vindex]; stream->video\_ssrc\_peer\_new[vindex] = 0; } /\* Do the same with the related rtx SSRC, if any \*/ if(stream->video\_ssrc\_peer\_rtx\_new[vindex] > 0) { if(stream->video\_ssrc\_peer\_rtx[vindex] > 0 && stream->video\_ssrc\_peer\_rtx[vindex] != stream->video\_ssrc\_peer\_rtx\_new[vindex]) { JANUS\_LOG(LOG\_INFO, "[%"SCNu64"] Video SSRC (#%d rtx) changed: %"SCNu32" --> %"SCNu32"\n", handle->handle\_id, vindex, stream->video\_ssrc\_peer\_rtx[vindex], stream->video\_ssrc\_peer\_rtx\_new[vindex]); } stream->video\_ssrc\_peer\_rtx[vindex] = stream->video\_ssrc\_peer\_rtx\_new[vindex]; stream->video\_ssrc\_peer\_rtx\_new[vindex] = 0; if(stream->video\_ssrc\_rtx == 0) stream->video\_ssrc\_rtx = janus\_random\_uint32(); /\* FIXME Should we look for conflicts? \*/ } } if(stream->video\_ssrc\_peer[1] && stream->video\_rtcp\_ctx[1] == NULL) { stream->video\_rtcp\_ctx[1] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[1]->tb = 90000; } if(stream->video\_ssrc\_peer[2] && stream->video\_rtcp\_ctx[2] == NULL) { stream->video\_rtcp\_ctx[2] = g\_malloc0(sizeof(rtcp\_context)); stream->video\_rtcp\_ctx[2]->tb = 90000; } } temp = temp->next; } /\* Disable RFC4588 if the peer didn't negotiate it \*/ if(!rtx) { janus\_flags\_clear(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_RFC4588\_RTX); stream->video\_ssrc\_rtx = 0; } /\* Cleanup \*/ g\_free(ruser); g\_free(rpass); g\_free(rhashing); g\_free(rfingerprint);
 return 0; /\* FIXME Handle errors better \*/}
typedef struct janus\_sdp\_mdns\_candidate { janus\_ice\_handle \*handle; char \*candidate, \*local; GCancellable \*cancellable;} janus\_sdp\_mdns\_candidate;static void janus\_sdp\_mdns\_resolved(GObject \*source\_object, GAsyncResult \*res, gpointer user\_data) { /\* This callback is invoked when the address is resolved \*/ janus\_sdp\_mdns\_candidate \*mc = (janus\_sdp\_mdns\_candidate \*)user\_data; GResolver \*resolver = g\_resolver\_get\_default(); GError \*error = NULL; GList \*list = g\_resolver\_lookup\_by\_name\_finish(resolver, res, &error); if(mc == NULL) { g\_resolver\_free\_addresses(list); g\_object\_unref(resolver); return; } char \*resolved = NULL; if(error != NULL || list == NULL || list->data == NULL) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Error resolving mDNS address (%s): %s\n", mc->handle->handle\_id, mc->local, error ? error->message : "no results"); } else { resolved = g\_inet\_address\_to\_string((GInetAddress \*)list->data); JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] mDNS address (%s) resolved: %s\n", mc->handle->handle\_id, mc->local, resolved); } g\_resolver\_free\_addresses(list); g\_object\_unref(resolver); if(resolved != NULL && mc->handle->stream && mc->handle->app\_handle && !g\_atomic\_int\_get(&mc->handle->app\_handle->stopped) && !g\_atomic\_int\_get(&mc->handle->destroyed)) { /\* Replace the .local address with the resolved one in the candidate string \*/ mc->candidate = janus\_string\_replace(mc->candidate, mc->local, resolved); /\* Parse the candidate again \*/ janus\_mutex\_lock(&mc->handle->mutex); (void)janus\_sdp\_parse\_candidate(mc->handle->stream, mc->candidate, 1); janus\_mutex\_unlock(&mc->handle->mutex); } g\_free(resolved); /\* Get rid of the helper struct \*/ janus\_refcount\_decrease(&mc->handle->ref); g\_free(mc->candidate); g\_free(mc->local); g\_free(mc);}
int janus\_sdp\_parse\_candidate(void \*ice\_stream, const char \*candidate, int trickle) { if(ice\_stream == NULL || candidate == NULL) return -1; janus\_ice\_stream \*stream = (janus\_ice\_stream \*)ice\_stream; janus\_ice\_handle \*handle = stream->handle; if(handle == NULL) return -2; janus\_ice\_component \*component = NULL; if(strlen(candidate) == 0 || strstr(candidate, "end-of-candidates")) { /\* FIXME Should we do something with this? \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] end-of-candidates received\n", handle->handle\_id); return 0; } if(strstr(candidate, "candidate:") == candidate) { /\* Skipping the 'candidate:' prefix Firefox puts in trickle candidates \*/ candidate += strlen("candidate:"); } char rfoundation[33], rtransport[4], rip[50], rtype[6], rrelip[40]; guint32 rcomponent, rpriority, rport, rrelport; int res = sscanf(candidate, "%32s %30u %3s %30u %49s %30u typ %5s %\*s %39s %\*s %30u", rfoundation, &rcomponent, rtransport, &rpriority, rip, &rport, rtype, rrelip, &rrelport); if(res < 7) { /\* Failed to parse this address, can it be IPv6? \*/ if(!janus\_ice\_is\_ipv6\_enabled()) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Received IPv6 candidate, but IPv6 support is disabled...\n", handle->handle\_id); return res; } } if(res >= 7) { if(strstr(rip, ".local")) { /\* The IP is actually an mDNS address, try to resolve it \* https://tools.ietf.org/html/draft-ietf-rtcweb-mdns-ice-candidates-04 \*/ if(!janus\_ice\_is\_mdns\_enabled()) { /\* ...unless mDNS resolution is disabled, in which case ignore this candidate \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] mDNS candidate ignored\n", handle->handle\_id); return 0; } /\* We'll resolve this address asynchronously, in order not to keep this thread busy \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Resolving mDNS address (%s) asynchronously\n", handle->handle\_id, rip); janus\_sdp\_mdns\_candidate \*mc = g\_malloc(sizeof(janus\_sdp\_mdns\_candidate)); janus\_refcount\_increase(&handle->ref); mc->handle = handle; mc->candidate = g\_strdup(candidate); mc->local = g\_strdup(rip); mc->cancellable = NULL; GResolver \*resolver = g\_resolver\_get\_default(); g\_resolver\_lookup\_by\_name\_async(resolver, rip, NULL, (GAsyncReadyCallback)janus\_sdp\_mdns\_resolved, mc); return 0; } /\* Add remote candidate \*/ component = stream->component; if(component == NULL || rcomponent > 1) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] -- Skipping component %d in stream %d (rtcp-muxing)\n", handle->handle\_id, rcomponent, stream->stream\_id); } else { //~ if(trickle) { //~ if(component->dtls != NULL) { //~ /\* This component is already ready, ignore this further candidate \*/ //~ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] -- Ignoring this candidate, the component is already ready\n", handle->handle\_id); //~ return 0; //~ } //~ } component->component\_id = rcomponent; component->stream\_id = stream->stream\_id; NiceCandidate \*c = NULL; if(!strcasecmp(rtype, "host")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:host %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_HOST);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_HOST);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "srflx")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:srflx %s:%d --> %s:%d \n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "prflx")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:prflx %s:%d --> %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* Unless this is libnice >= 0.1.8, we only support UDP... \*/ if(!strcasecmp(rtransport, "udp")) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE);#ifdef HAVE\_LIBNICE\_TCP } else if(!strcasecmp(rtransport, "tcp") && janus\_ice\_is\_ice\_tcp\_enabled()) { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE);#endif } else { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } } else if(!strcasecmp(rtype, "relay")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Adding remote candidate component:%d stream:%d type:relay %s:%d --> %s:%d\n", handle->handle\_id, rcomponent, stream->stream\_id, rrelip, rrelport, rip, rport); /\* We only support UDP/TCP/TLS... \*/ if(strcasecmp(rtransport, "udp") && strcasecmp(rtransport, "tcp") && strcasecmp(rtransport, "tls")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Skipping unsupported transport '%s' for media\n", handle->handle\_id, rtransport); } else { c = nice\_candidate\_new(NICE\_CANDIDATE\_TYPE\_RELAYED); } } else { /\* FIXME What now? \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Unknown remote candidate type:%s for component:%d stream:%d!\n", handle->handle\_id, rtype, rcomponent, stream->stream\_id); } if(c != NULL) { c->component\_id = rcomponent; c->stream\_id = stream->stream\_id;#ifndef HAVE\_LIBNICE\_TCP c->transport = NICE\_CANDIDATE\_TRANSPORT\_UDP;#else if(!strcasecmp(rtransport, "udp")) { JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Transport: UDP\n", handle->handle\_id); c->transport = NICE\_CANDIDATE\_TRANSPORT\_UDP; } else { /\* Check the type (https://tools.ietf.org/html/rfc6544#section-4.5) \*/ const char \*type = NULL; int ctype = 0; if(strstr(candidate, "tcptype active")) { type = "active"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_ACTIVE; } else if(strstr(candidate, "tcptype passive")) { type = "passive"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_PASSIVE; } else if(strstr(candidate, "tcptype so")) { type = "so"; ctype = NICE\_CANDIDATE\_TRANSPORT\_TCP\_SO; } else { /\* TODO: We should actually stop here... \*/ JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Missing tcptype info for the TCP candidate!\n", handle->handle\_id); } JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Transport: TCP (%s)\n", handle->handle\_id, type); c->transport = ctype; }#endif g\_strlcpy(c->foundation, rfoundation, NICE\_CANDIDATE\_MAX\_FOUNDATION); c->priority = rpriority; gboolean added = nice\_address\_set\_from\_string(&c->addr, rip); if(!added) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Invalid address '%s', skipping %s candidate (%s)\n", handle->handle\_id, rip, rtype, candidate); nice\_candidate\_free(c); return 0; } nice\_address\_set\_port(&c->addr, rport); if(c->type == NICE\_CANDIDATE\_TYPE\_SERVER\_REFLEXIVE || c->type == NICE\_CANDIDATE\_TYPE\_PEER\_REFLEXIVE) { added = nice\_address\_set\_from\_string(&c->base\_addr, rrelip); if(added) nice\_address\_set\_port(&c->base\_addr, rrelport); } else if(c->type == NICE\_CANDIDATE\_TYPE\_RELAYED) { /\* FIXME Do we really need the base address for TURN? \*/ added = nice\_address\_set\_from\_string(&c->base\_addr, rrelip); if(added) nice\_address\_set\_port(&c->base\_addr, rrelport); } if(!added) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Invalid base address '%s', skipping %s candidate (%s)\n", handle->handle\_id, rrelip, rtype, candidate); nice\_candidate\_free(c); return 0; } component->candidates = g\_slist\_append(component->candidates, c); JANUS\_LOG(LOG\_HUGE, "[%"SCNu64"] Candidate added to the list! (%u elements for %d/%d)\n", handle->handle\_id, g\_slist\_length(component->candidates), stream->stream\_id, component->component\_id); /\* Save for the summary, in case we need it \*/ component->remote\_candidates = g\_slist\_append(component->remote\_candidates, g\_strdup(candidate)); /\* Notify event handlers \*/ if(janus\_events\_is\_enabled()) { janus\_session \*session = (janus\_session \*)handle->session; json\_t \*info = json\_object(); json\_object\_set\_new(info, "remote-candidate", json\_string(candidate)); json\_object\_set\_new(info, "stream\_id", json\_integer(stream->stream\_id)); json\_object\_set\_new(info, "component\_id", json\_integer(component->component\_id)); janus\_events\_notify\_handlers(JANUS\_EVENT\_TYPE\_WEBRTC, JANUS\_EVENT\_SUBTYPE\_WEBRTC\_RCAND, session->session\_id, handle->handle\_id, handle->opaque\_id, info); } /\* See if we need to process this \*/ if(trickle) { if(janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_START)) { /\* This is a trickle candidate and ICE has started, we should process it right away \*/ if(!component->process\_started) { /\* Actually, ICE has JUST started for this component, take care of the candidates we've added so far \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] ICE already started for this component, setting candidates we have up to now\n", handle->handle\_id); janus\_ice\_setup\_remote\_candidates(handle, component->stream\_id, component->component\_id); } else { /\* Queue the candidate, we'll process it in the loop \*/ janus\_ice\_add\_remote\_candidate(handle, c); } } else { /\* ICE hasn't started yet: to make sure we're not stuck, also check if we stopped processing the SDP \*/ if(!janus\_flags\_is\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_PROCESSING\_OFFER)) { janus\_flags\_set(&handle->webrtc\_flags, JANUS\_ICE\_HANDLE\_WEBRTC\_START); /\* This is a trickle candidate and ICE has started, we should process it right away \*/ if(!component->process\_started) { /\* Actually, ICE has JUST started for this component, take care of the candidates we've added so far \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] SDP processed but ICE not started yet for this component, setting candidates we have up to now\n", handle->handle\_id); janus\_ice\_setup\_remote\_candidates(handle, component->stream\_id, component->component\_id); } else { /\* Queue the candidate, we'll process it in the loop \*/ janus\_ice\_add\_remote\_candidate(handle, c); } } else { /\* Still processing the offer/answer: queue the trickle candidate for now, we'll process it later \*/ JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Queueing trickle candidate, status is not START yet\n", handle->handle\_id); } } } } } } else { JANUS\_LOG(LOG\_ERR, "[%"SCNu64"] Failed to parse candidate (res=%d)...\n", handle->handle\_id, res); return res; } return 0;}
int janus\_sdp\_parse\_ssrc\_group(void \*ice\_stream, const char \*group\_attr, int video) { if(ice\_stream == NULL || group\_attr == NULL) return -1; janus\_ice\_stream \*stream = (janus\_ice\_stream \*)ice\_stream; janus\_ice\_handle \*handle = stream->handle; if(handle == NULL) return -2; if(!video) return -3; if(stream->rid[0] != NULL) { /\* Simulcasting is rid-based, don't parse SSRCs for now \*/ return 0; } gboolean fid = strstr(group\_attr, "FID") != NULL; gboolean sim = strstr(group\_attr, "SIM") != NULL; guint64 ssrc = 0; guint32 first\_ssrc = 0; gchar \*\*list = g\_strsplit(group\_attr, " ", -1); gchar \*index = list[0]; if(index != NULL) { int i=0; while(index != NULL) { if(i > 0 && strlen(index) > 0) { ssrc = g\_ascii\_strtoull(index, NULL, 0); switch(i) { case 1: first\_ssrc = ssrc; if(stream->video\_ssrc\_peer\_new[0] == ssrc || stream->video\_ssrc\_peer\_new[1] == ssrc || stream->video\_ssrc\_peer\_new[2] == ssrc) { JANUS\_LOG(LOG\_HUGE, "[%"SCNu64"] Already parsed this SSRC: %"SCNu64" (%s group)\n", handle->handle\_id, ssrc, (fid ? "FID" : (sim ? "SIM" : "??"))); } else { if(stream->video\_ssrc\_peer\_new[0] == 0) { stream->video\_ssrc\_peer\_new[0] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC: %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[0]); } else { /\* We already have a video SSRC: check if rid is involved, and we'll keep track of this for simulcasting \*/ if(stream->rid[0]) { if(stream->video\_ssrc\_peer\_new[1] == 0) { stream->video\_ssrc\_peer\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[1]); } else if(stream->video\_ssrc\_peer\_new[2] == 0) { stream->video\_ssrc\_peer\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with video SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } } } } break; case 2: if(fid) { if(stream->video\_ssrc\_peer\_new[0] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[0] == 0) { stream->video\_ssrc\_peer\_rtx\_new[0] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[0]); } else if(stream->video\_ssrc\_peer\_new[1] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[1] == 0) { stream->video\_ssrc\_peer\_rtx\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1 rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[1]); } else if(stream->video\_ssrc\_peer\_new[2] == first\_ssrc && stream->video\_ssrc\_peer\_rtx\_new[2] == 0) { stream->video\_ssrc\_peer\_rtx\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2 rtx): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_rtx\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with rtx SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } } else if(sim) { stream->video\_ssrc\_peer\_new[1] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-1): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[1]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } break; case 3: if(fid) { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Found one too many retransmission SSRC (rtx): %"SCNu64"\n", handle->handle\_id, ssrc); } else if(sim) { stream->video\_ssrc\_peer\_new[2] = ssrc; JANUS\_LOG(LOG\_VERB, "[%"SCNu64"] Peer video SSRC (sim-2): %"SCNu32"\n", handle->handle\_id, stream->video\_ssrc\_peer\_new[2]); } else { JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); } break; default: JANUS\_LOG(LOG\_WARN, "[%"SCNu64"] Don't know what to do with video SSRC: %"SCNu64"\n", handle->handle\_id, ssrc); break; }[View remainder of file in raw view](https://github.com/meetecho/janus-gateway/raw/refs/tags/v0.10.0/sdp.c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b9da649e_20250119_140109.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-x6c3-mvjq-f4mg)

**CVE-2020-13899**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-x6c3-mvjq-f4mg)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2020-13899](/advisories/GHSA-x6c3-mvjq-f4mg)

## An issue was discovered in janus-gateway (aka Janus...

Moderate severity

Unreviewed

Published
May 24, 2022
to the GitHub Advisory Database
•
Updated Jan 29, 2023

## Package

No package listed—
[Suggest a package](/advisories/GHSA-x6c3-mvjq-f4mg/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

An issue was discovered in janus-gateway (aka Janus WebRTC Server) through 0.10.0. janus\_process\_incoming\_request in janus.c discloses information from uninitialized stack memory.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2020-13899>
* [meetecho/janus-gateway#2214](https://github.com/meetecho/janus-gateway/pull/2214)
* <https://github.com/meetecho/janus-gateway/blob/v0.10.0/janus.c#L1326>
* <https://github.com/merrychap/CVEs/tree/master/CVE-2020-13899>
* <https://github.com/merrychap/poc_exploits/tree/master/janus-webrtc/CVE-2020-13899>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2020-13899)
Jun 10, 2020

Published to the GitHub Advisory Database
May 24, 2022

Last updated
Jan 29, 2023

### Severity

Moderate

### [EPSS score](https://www.first.org/epss/user-guide)

0.509%
 (77th percentile)

### Weaknesses

[CWE-909](/advisories?query=cwe%3A909)

### CVE ID

CVE-2020-13899

### GHSA ID

GHSA-x6c3-mvjq-f4mg

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-x6c3-mvjq-f4mg/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ac1630f4_20250119_122252.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fpull%2F2214)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fpull%2F2214)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=meetecho%2Fjanus-gateway)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[meetecho](/meetecho)
/
**[janus-gateway](/meetecho/janus-gateway)**
Public

* [Notifications](/login?return_to=%2Fmeetecho%2Fjanus-gateway) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)
* [Star
   8.4k](/login?return_to=%2Fmeetecho%2Fjanus-gateway)

* [Code](/meetecho/janus-gateway)
* [Issues
  15](/meetecho/janus-gateway/issues)
* [Pull requests
  14](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

Additional navigation options

* [Code](/meetecho/janus-gateway)
* [Issues](/meetecho/janus-gateway/issues)
* [Pull requests](/meetecho/janus-gateway/pulls)
* [Actions](/meetecho/janus-gateway/actions)
* [Security](/meetecho/janus-gateway/security)
* [Insights](/meetecho/janus-gateway/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmeetecho%2Fjanus-gateway%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmeetecho%2Fjanus-gateway%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Security fixes in SDP code #2214

 Merged

[lminiero](/lminiero)
merged 4 commits into
[master](/meetecho/janus-gateway/tree/master "meetecho/janus-gateway:master")
from
[sec-fixes](/meetecho/janus-gateway/tree/sec-fixes "meetecho/janus-gateway:sec-fixes")

Jun 9, 2020

 Merged

# [Security fixes in SDP code](#top) #2214

[lminiero](/lminiero)
merged 4 commits into
[master](/meetecho/janus-gateway/tree/master "meetecho/janus-gateway:master")
from
[sec-fixes](/meetecho/janus-gateway/tree/sec-fixes "meetecho/janus-gateway:sec-fixes")

Jun 9, 2020

[Conversation
0](/meetecho/janus-gateway/pull/2214)
[Commits
4](/meetecho/janus-gateway/pull/2214/commits)
[Checks
0](/meetecho/janus-gateway/pull/2214/checks)
[Files changed](/meetecho/janus-gateway/pull/2214/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![lminiero](https://avatars.githubusercontent.com/u/3684796?s=60&v=4)](/lminiero)

Copy link

Member

### @lminiero **[lminiero](/lminiero)** commented [Jun 9, 2020](#issue-635318880) • edited Loading

We've been notified about a series of security issues related to SDP (see relevant CVE IDs below, vulnerabilities discovered by Mikhail Evdokimov at Digital Security dsec.ru). Specifically, each commit in this PR solves a different issue that could happen:

1. a NULL pointer dereference when parsing some SDP attributes (see [CVE-2020-13898](https://github.com/advisories/GHSA-35h6-3hm3-w4f8 "CVE-2020-13898"));
2. a stack memory leak (and a "regular" one) when pre-parsing an SDP (see [CVE-2020-13899](https://github.com/advisories/GHSA-x6c3-mvjq-f4mg "CVE-2020-13899"));
3. a different NULL pointer dereference when pre-parsing an SDP (see [CVE-2020-13900](https://github.com/advisories/GHSA-6743-fx46-j8w6 "CVE-2020-13900"));
4. a buffer overflow when merging SDPs (see [CVE-2020-13901](https://github.com/advisories/GHSA-vqrr-qhj8-882q "CVE-2020-13901")).

I plan to merge this almost immediately, as I can't replicate the issues anymore.

Sorry, something went wrong.

All reactions

 [lminiero](/lminiero)
added 4 commits
[June 9, 2020 11:42](#commits-pushed-2ed485d)

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)

`[Fixed NULL pointer dereference in sdp.c](/meetecho/janus-gateway/pull/2214/commits/2ed485d04630b9ee9de7c96517135654b7f32120 "Fixed NULL pointer dereference in sdp.c")`

`[2ed485d](/meetecho/janus-gateway/pull/2214/commits/2ed485d04630b9ee9de7c96517135654b7f32120)`

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)

`[Fixed stack memory leak in janus.c (and regular memory leak in sdp.c)](/meetecho/janus-gateway/pull/2214/commits/f46f27fb129fd1b3744830b4fc6e75ab78794636 "Fixed stack memory leak in janus.c (and regular memory leak in sdp.c)")`

`[f46f27f](/meetecho/janus-gateway/pull/2214/commits/f46f27fb129fd1b3744830b4fc6e75ab78794636)`

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)

`[Fixed NULL pointer dereference in sdp.c (preparse mid)](/meetecho/janus-gateway/pull/2214/commits/5f33d5e1073207f7275a726b7bb4cd7dbb08d13a "Fixed NULL pointer dereference in sdp.c (preparse mid)")`

`[5f33d5e](/meetecho/janus-gateway/pull/2214/commits/5f33d5e1073207f7275a726b7bb4cd7dbb08d13a)`

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)

`[Fixed buffer overflow when merging SDPs in sdp.c](/meetecho/janus-gateway/pull/2214/commits/90cc2ada775c4d4d8f6ae66f96b4ec7588e4bc86 "Fixed buffer overflow when merging SDPs in sdp.c")`

`[90cc2ad](/meetecho/janus-gateway/pull/2214/commits/90cc2ada775c4d4d8f6ae66f96b4ec7588e4bc86)`

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)
[lminiero](/lminiero)
merged commit [`5b15ded`](/meetecho/janus-gateway/commit/5b15ded4c3542ccef097da5088d01d977652fe9d)
into
master

[Jun 9, 2020](https://github.com/meetecho/janus-gateway/pull/2214#event-3424276728)

 [![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=40&v=4)](/lminiero)
[lminiero](/lminiero)
deleted the
sec-fixes

branch
[June 9, 2020 10:51](#event-3424276977)

[![@vincentfretin](https://avatars.githubusercontent.com/u/112249?s=40&v=4)](/vincentfretin)
[vincentfretin](/vincentfretin)
mentioned this pull request
[Aug 29, 2020](#ref-issue-627438503)

[Plugin no longer loads with latest libnice and janus-gateway
mozilla/janus-plugin-sfu#58](/mozilla/janus-plugin-sfu/issues/58)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmeetecho%2Fjanus-gateway%2Fpull%2F2214)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

1 participant

[![@lminiero](https://avatars.githubusercontent.com/u/3684796?s=52&v=4)](/lminiero)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_75c49bbe_20250119_140110.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-6743-fx46-j8w6)

**CVE-2020-13900**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-6743-fx46-j8w6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2020-13900](/advisories/GHSA-6743-fx46-j8w6)

## An issue was discovered in janus-gateway (aka Janus...

Moderate severity

Unreviewed

Published
May 24, 2022
to the GitHub Advisory Database
•
Updated Jan 29, 2023

## Package

No package listed—
[Suggest a package](/advisories/GHSA-6743-fx46-j8w6/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

An issue was discovered in janus-gateway (aka Janus WebRTC Server) through 0.10.0. janus\_sdp\_preparse in sdp.c has a NULL pointer dereference.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2020-13900>
* [meetecho/janus-gateway#2214](https://github.com/meetecho/janus-gateway/pull/2214)
* <https://github.com/meetecho/janus-gateway/blob/v0.10.0/sdp.c#L64>
* <https://github.com/meetecho/janus-gateway/blob/v0.10.0/sdp.c#L74>
* <https://github.com/merrychap/CVEs/tree/master/CVE-2020-13900>
* <https://github.com/merrychap/poc_exploits/tree/master/janus-webrtc/CVE-2020-13900>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2020-13900)
Jun 10, 2020

Published to the GitHub Advisory Database
May 24, 2022

Last updated
Jan 29, 2023

### Severity

Moderate

### [EPSS score](https://www.first.org/epss/user-guide)

0.474%
 (76th percentile)

### Weaknesses

[CWE-476](/advisories?query=cwe%3A476)

### CVE ID

CVE-2020-13900

### GHSA ID

GHSA-6743-fx46-j8w6

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-6743-fx46-j8w6/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


